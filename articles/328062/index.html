<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Services on Go in Badoo: how we write and support them</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing a network service on Go is very simple: there are a lot of tools in the standard library, and if something is missing, then Github has a lot o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Services on Go in Badoo: how we write and support them</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/2aa/ba3/da5/2aaba3da502e454b99ddf9f3d57072a0.png"></p><br><p>  Writing a network service on Go is very simple: there are a lot of tools in the standard library, and if something is missing, then Github has a lot of fancy libraries to meet most needs. </p><br><p>  But what if you need to write about ten different services working in the same infrastructure? </p><br><p>  If each demon will use all the fresh various "smoothies" technologies, it will turn out to be a "zoo", which is difficult and expensive to maintain, not to mention adding new functionality to them. </p><br><p>  In Badoo, we have over 30 self-written demons written in different languages, and about 10 of them are on Go.  All these daemons run on about 300 servers.  How we came to this, without getting a ‚Äúzoo‚Äù as a result, as the monitoring administrators manage to sleep peacefully, without restricting anyone to a smoothie, while developers, QA and releasers live together and have not quarreled so far - read under the cut. </p><a name="habracut"></a><br><p>  In Badoo Go, it first appeared around 2014, when we were faced with the task of quickly writing a demon that was looking for intersections between user coordinates.  Then the latest version of Go was 1.3, and therefore we struggled for a long time with GC-pauses, which was even <a href="https://www.youtube.com/watch%3Fv%3DpOgAnWfNjms">reported</a> on at the Go-metap in our office. </p><br><p>  Since then, we have more and more demons written in Go.  Basically, this is what would have been written in C before, but sometimes it is something that does not fit so well on PHP (for example, our <a href="https://tech.badoo.com/ru/presentation/359/kak-200-strok-na-go/">asynchronous proxy</a> or <a href="https://tech.badoo.com/ru/presentation/129/badoo-v-oblakax-reshenie-dlya-zapuska-cli-skriptov-v-oblake/">our ‚Äúcloud‚Äù resource scheduler</a> ). </p><br><p>  All requests from client applications are served by PHP, which goes to our various self-written and non-self-written services.  Simplified it looks like this: </p><br><p><img src="https://habrastorage.org/web/8dd/aea/0e0/8ddaea0e064d4bf99b3a800b91d6928b.png"></p><br><p>  Although there are some exceptions to this rule, the following is generally true for all of our demons on Go: </p><br><ol><li>  They do not "stick out" on the Internet. </li><li>  The main ‚Äúuser‚Äù of the daemon is a PHP code. </li></ol><br><p>  All of our demons, regardless of the language of their writing, look the same "from the outside" in terms of protocol, logs, statistics, deployment and so on.  This makes life easier for admins, release engineers, QA and PHP developers. </p><br><p>  Therefore, on the one hand, many approaches that we use for demons on Go were dictated by already existing approaches to writing demons in C / C ++, and on the other hand, much of this article is valid not only for Go, but also for any of our demons. . </p><br><p>  Below, I will describe how our basic infrastructure parts are arranged and how they are reflected in the Go code. </p><br><h3 id="protokol">  Protocol </h3><br><p>  When it comes to client-server communication, the question arises about the protocol.  We are based on <a href="https://developers.google.com/protocol-buffers/">Google Protobuf</a> .  Our protocol is similar to the simplified version of gRPC, so we were repeatedly asked questions from the category ‚Äúwhy did we need to reinvent the wheel?‚Äù.  Most likely, today we would really use gRPC, but at that time (2008) it did not exist yet, and now there is no point in changing one for the other. </p><br><p>  Protobuf wraps only the message body into a binary representation and does not preserve its type.  Therefore, each time a client requests a server, the server must understand what kind of protobuf message it is and what method needs to be executed.  To do this, before the protobuf message, we add a message type identifier and message length.  The identifier makes it clear which GPB-message came in, and the length allows you to immediately allocate a buffer of the desired size. </p><br><p>  As a result, one call in terms of the protocol looks like this: </p><br><ul><li>  4 bytes - the length of the message N (the number in the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">network byte order</a> ); </li><li>  4 bytes - the message type identifier (also); </li><li>  N bytes - the message body. </li></ul><br><p> In order for both the client and server to have the same information about message identifiers, we also store them in a proto-file in the form of enums with the special names <code>request_msgid</code> and <code>response_msgid</code> .  For example: </p><br><pre> <code class="hljs ruby">enum request_msgid { REQUEST_RUN = <span class="hljs-number"><span class="hljs-number">1</span></span>; REQUEST_STATS = <span class="hljs-number"><span class="hljs-number">2</span></span>; } /<span class="hljs-regexp"><span class="hljs-regexp">/      request    response,   enum response_msgid { RESPONSE_GENERIC = 1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ,  response      ,        RESPONSE_RUN = 2; RESPONSE_STATS = 3; } message request_run { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ... } message response_run { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ... } message request_stats { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ... } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ...</span></span></code> </pre> <br><p>  Our entire library, which we call gpbrpc, is responsible for this protocol part.  It can be roughly divided into two parts: </p><br><ul><li>  one part is the <strong>code generator</strong> , which, on the basis of <code>request_msgid</code> and <code>response_msgid</code> generates maps of correspondences id =&gt; message, templates of handler methods, maps of their calls with type conversion, and some other necessary code; </li><li>  The second part <strong>deals with the analysis of</strong> all these data that came through the network, and the call to their corresponding handler methods. </li></ul><br><p>  The code generator from the first part is implemented as a <a href="https://developers.google.com/protocol-buffers/docs/reference/other">plug-in</a> to Google Protobuf. </p><br><p>  This is how the automatically generated handler looks for the above proto-file: </p><br><pre> <code class="hljs haskell">// ,   ,   proto- <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GpbrpcInterface</span></span></span><span class="hljs-class"> interface { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestT</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResultT</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestT</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResultT</span></span></span><span class="hljs-class"> } func (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GpbrpcType</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestT</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class">{}) gpbrpc.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResultT</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> := </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GpbrpcInterface</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMsgid</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessageId</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMsgid_REQUEST_RUN</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> := </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.(*</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMsgid_REQUEST_STATS</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> := </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.(*</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) } } //       - /* func ($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receiver</span></span></span><span class="hljs-class">$) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestT</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proto</span></span></span><span class="hljs-class">$.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestRun</span></span></span><span class="hljs-class">) gpbrpc.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResultT</span></span></span><span class="hljs-class"> { // ... } func ($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receiver</span></span></span><span class="hljs-class">$) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rctx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gpbrpc</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestT</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proto</span></span></span><span class="hljs-class">$.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestStats</span></span></span><span class="hljs-class">) gpbrpc.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResultT</span></span></span><span class="hljs-class"> { // ... } */</span></span></code> </pre> <br><h3 id="gogoprotobuf">  gogo / protobuf </h3><br><p>  In the Protobuf documentation, Google recommends using <a href="https://github.com/golang/protobuf">this</a> library for Go.  But, unfortunately, it generates a bad GC-code.  Example from <a href="https://godoc.org/github.com/golang/protobuf/proto">documentation</a> : </p><br><pre> <code class="hljs go">message Test { required <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> label = <span class="hljs-number"><span class="hljs-number">1</span></span>; optional <span class="hljs-keyword"><span class="hljs-keyword">int32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=<span class="hljs-number"><span class="hljs-number">77</span></span>]; }</code> </pre> <br><p>  turns into </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Test struct { Label *string `protobuf:"bytes,1,req,name=label" <span class="hljs-type"><span class="hljs-type">json</span></span>:"label,omitempty"` <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> *int32 `protobuf:"varint,2,opt,name=type,def=77" <span class="hljs-type"><span class="hljs-type">json</span></span>:"type,omitempty"` }</code> </pre> <br><p>  Each field structure has become a pointer.  This is necessary for <code>optional</code> fields: they need to distinguish between the case of the absence of a field and the case when the field contains a zero value. </p><br><p>  Even if you do not need it, the library does not allow you to control the presence of pointers in the generated code.  But not everything is so bad: it has fork <a href="https://github.com/gogo/protobuf">gogoprotobuf</a> , in which it is supported.  To do this, you must specify the appropriate options in the proto-file: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Test { <span class="hljs-attribute"><span class="hljs-attribute">required</span></span> string label = <span class="hljs-number"><span class="hljs-number">1</span></span> [(gogoproto.nullable) = <span class="hljs-literal"><span class="hljs-literal">false</span></span>]; <span class="hljs-attribute"><span class="hljs-attribute">optional</span></span> int32 type = <span class="hljs-number"><span class="hljs-number">2</span></span> [(gogoproto.nullable) = <span class="hljs-literal"><span class="hljs-literal">false</span></span>]; }</code> </pre> <br><p>  Getting rid of pointers was especially important for Go to version 1.5, when the GC pauses were much longer.  But even now it can give a <a href="https://github.com/alecthomas/go_serialization_benchmarks">significant increase</a> (sometimes several times) to the performance of loaded services. </p><br><p>  In addition to <code>nullable</code> , the library allows you to add a large number of other generation options that affect both the performance and the convenience of the resulting code.  For example, a <code>gostring</code> saves the current structure with values ‚Äã‚Äãin the Go syntax, which can be convenient for debugging or writing tests. </p><br><p>  A suitable set of options depends on the specific situation.  We almost always use at least <code>nullable</code> , <code>sizer_all, unsafe_marshaler_all</code> , <code>unsafe_unmarshaler_all</code> .  By the way, the options that have the option with the <code>_all</code> suffix can be applied directly to the entire file, without duplicating them on each field: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">option</span></span> (gogoproto.sizer_all) = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Test { <span class="hljs-attribute"><span class="hljs-attribute">required</span></span> string label = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">optional</span></span> int32 type = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><h3 id="json">  Json </h3><br><p>  In Google Protobuf, almost everything is fine, but since this is a binary protocol, it is difficult to debug it. </p><br><p>  If you need to find problems at the level of interaction between a ready-made client and server, then you can, for example, use the <a href="https://github.com/mkevac/gpbs-dissector">gpbs-dissector</a> for <a href="https://www.wireshark.org/">Wireshark</a> .  But this is not suitable in the case of the development of new functionality, for which there is still no client or server. </p><br><p>  In fact, to write a test request to the service, you need a client who can wrap it in a binary message.  Writing such a test client for each daemon is not very difficult, but inconvenient and routine.  Therefore, our gpbrpc can handle the JSON-like presentation of the protocol on a different port other than the gpb interface.  All binding for this is generated automatically (similarly, as described above for protobuf). </p><br><p>  As a result, in the console, you can write a request in text form and immediately get an answer.  This is useful for debugging. </p><br><pre> <code class="hljs pgsql">pmurzakov@shell1.mlan:~&gt; echo <span class="hljs-string"><span class="hljs-string">'run {"url":"https://graph.facebook.com/?id=http%3A%2F%2Fhabrahabr.ru","task_hash":"a"}'</span></span> | netcat xtc1.mlan <span class="hljs-number"><span class="hljs-number">9531</span></span> run { "task_hash": "a", "task_status": <span class="hljs-number"><span class="hljs-number">2</span></span>, "response": { "http_status": <span class="hljs-number"><span class="hljs-number">200</span></span>, "body": "{\"og_object\":{\"id\":\"<span class="hljs-number"><span class="hljs-number">627594553918401</span></span>\",\"description\":\" ‚Äì      ,     .  ,  ,      ‚Äì       IT-  .\",\"title\":\"    / \",\"<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>\":{\"comment_count\":0,\"share_count\":2456},\"id\":\"http:\\/\\/habrahabr.ru\"}", "response_time_ms": <span class="hljs-number"><span class="hljs-number">179</span></span> } }</code> </pre> <br><p>  If the answer is voluminous, and from it you need to select some part or simply need to somehow convert it, you can use the console utility <a href="https://stedolan.github.io/jq/">jq</a> . </p><br><h3 id="konfigi">  Configs </h3><br><p>  Generally to configs usually have two basic requirements: </p><br><ul><li>  readability; </li><li>  opportunity to describe the structure. </li></ul><br><p>  In order not to introduce new entities for this, we used the fact that there is already: protobuf - structure, readability - its JSON representation. </p><br><p>  We already have all the binding for protobuf and parser generators of its JSON representation for debug (see previous section).  It remains only to add a proto-file for the config and ‚Äúfeed‚Äù it to this parser. </p><br><p>  In fact, everything is a bit more complicated: since it is important for us to standardize as many different demons as possible, there is a part in the config that is the same for all demons.  It is described by a generic protobuf message.  The final config is a collection of the standardized part and what is specific for a particular daemon. </p><br><p>  This approach fits well on <a href="https://golang.org/doc/effective_go.html">embedding</a> : </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FullConfig</span></span></span><span class="hljs-class"> struct { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">badoo</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ServiceConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yourdaemon</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Config</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br><p>  An example for clarity.  A common part: </p><br><pre> <code class="hljs cpp">message service_config { message <span class="hljs-keyword"><span class="hljs-keyword">daemon_config_t</span></span> { message <span class="hljs-keyword"><span class="hljs-keyword">listen_t</span></span> { required <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> proto = <span class="hljs-number"><span class="hljs-number">1</span></span>; required <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> address = <span class="hljs-number"><span class="hljs-number">2</span></span>; optional <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> pinba_enabled = <span class="hljs-number"><span class="hljs-number">4</span></span>; } repeated <span class="hljs-keyword"><span class="hljs-keyword">listen_t</span></span> listen = <span class="hljs-number"><span class="hljs-number">1</span></span>; required <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> service_name = <span class="hljs-number"><span class="hljs-number">2</span></span>; required <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> service_instance_name = <span class="hljs-number"><span class="hljs-number">3</span></span>; optional <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> daemonize = <span class="hljs-number"><span class="hljs-number">4</span></span>; optional <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pid_file = <span class="hljs-number"><span class="hljs-number">5</span></span>; optional <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> log_file = <span class="hljs-number"><span class="hljs-number">6</span></span>; optional <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> http_pprof_addr = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-comment"><span class="hljs-comment">// net/http/pprof + expvar address optional string pinba_address = 8; // ... } }</span></span></code> </pre> <br><p>  Part for a specific demon: </p><br><pre> <code class="hljs swift">message config { <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 workers_count = <span class="hljs-number"><span class="hljs-number">1</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">4000</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 max_queue_length = <span class="hljs-number"><span class="hljs-number">2</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">50000</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 max_idle_conns_per_host = <span class="hljs-number"><span class="hljs-number">4</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 connect_timeout_ms = <span class="hljs-number"><span class="hljs-number">5</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">2000</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 request_timeout_ms = <span class="hljs-number"><span class="hljs-number">7</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">10000</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">optional</span></span> uint32 keep_alive_ms = <span class="hljs-number"><span class="hljs-number">8</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = <span class="hljs-number"><span class="hljs-number">30000</span></span>]; }</code> </pre> <br><p>  As a result, JSON-config looks like this: </p><br><pre> <code class="hljs ruby">{ <span class="hljs-string"><span class="hljs-string">"daemon_config"</span></span>: { <span class="hljs-string"><span class="hljs-string">"listen"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"proto"</span></span>: <span class="hljs-string"><span class="hljs-string">"xtc-gpb"</span></span>, <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0:9530"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"proto"</span></span>: <span class="hljs-string"><span class="hljs-string">"xtc-gpb/json"</span></span>, <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0:9531"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"proto"</span></span>: <span class="hljs-string"><span class="hljs-string">"service-stats-gpb"</span></span>, <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0:9532"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"proto"</span></span>: <span class="hljs-string"><span class="hljs-string">"service-stats-gpb/json"</span></span>, <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0:9533"</span></span> }, ], <span class="hljs-string"><span class="hljs-string">"service_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"xtc"</span></span>, <span class="hljs-string"><span class="hljs-string">"service_instance_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.mlan"</span></span>, <span class="hljs-string"><span class="hljs-string">"daemonize"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"pinba_address"</span></span>: <span class="hljs-string"><span class="hljs-string">"pinbaxtc1.mlan:30002"</span></span>, <span class="hljs-string"><span class="hljs-string">"http_pprof_addr"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0:9534"</span></span>, <span class="hljs-string"><span class="hljs-string">"pid_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"/local/xtc/run/xtc.pid"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"/local/xtc/logs/xtc.log"</span></span>, }, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      <span class="hljs-string"><span class="hljs-string">"workers_count"</span></span>: <span class="hljs-number"><span class="hljs-number">4000</span></span>, <span class="hljs-string"><span class="hljs-string">"max_queue_length"</span></span>: <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-string"><span class="hljs-string">"max_idle_conns_per_host"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">"connect_timeout_ms"</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-string"><span class="hljs-string">"handshake_timeout_ms"</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-string"><span class="hljs-string">"request_timeout_ms"</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-string"><span class="hljs-string">"keep_alive_ms"</span></span>: <span class="hljs-number"><span class="hljs-number">30000</span></span>, }</code> </pre> <br><p>  In <code>listen</code> , all ports that the daemon will listen to are listed.  The first two elements with the <code>xtc-gpb</code> and <code>xtc-gpb/json</code> types are for the ports of the very <code>gpbrpc</code> and its JSON representation, which I wrote about above.  And with <code>service-stats-gpb</code> and <code>service-stats-gpb/json</code> we collect statistics, which will be discussed later. </p><br><h3 id="statistika">  Statistics </h3><br><p>  When collecting statistics (as is the case with the standardized part of the config), it is important for each daemon to write at least the basic metrics: the number of requests served, CPU and memory consumption, network traffic, etc. This typical statistics is collected from the <code>service-stats-gpb</code> port <code>service-stats-gpb</code> , it is the same for all demons. </p><br><p>  Requesting statistics, in fact, is no different from the usual request to the daemon, so we use all the same approaches: the statistics are described in terms of gpbrpc, as well as the usual requests.  Handlers of this ‚Äústandardized‚Äù statistics are already in our framework, so they do not need to be written every time for the next daemon. </p><br><p>  By analogy with configs, except for the same statistics for all daemons, each daemon can give more specifically for it. </p><br><p>  Once a minute, the PHP client-collector of statistics connects to the daemon, requests values ‚Äã‚Äãand stores them in a time-series-storage.  Based on this data, we build the following graphs: </p><br><p> <a href=""><img src="https://habrastorage.org/web/55b/96f/16d/55b96f16df3a4929b5a97b384bf61140.png"></a> </p><br><p>  The values ‚Äã‚Äãfor the first five graphs are collected automatically from all daemons, while the others represent values ‚Äã‚Äãspecific to a particular daemon. </p><br><p>  We have assumed that statistics does not happen much, and we try to get the maximum amount of data, so that it will be easier to deal with the problems and changes in them.  Therefore, in the config you can see the parameter <code>pinba_address</code> , this is the address of the <a href="http://pinba.org/">Pinba</a> server, to which the daemon also sends statistics. </p><br><p>  From Pinba, we build graphs for the response time distribution: </p><br><p><img src="https://habrastorage.org/web/f5e/267/b9b/f5e267b9b7e14098a2940ff43bf54f45.png"></p><br><h3 id="debag-i-profilirovanie">  Debag and profiling </h3><br><p>  Also in the config you can see the parameter <code>http_pprof_addr</code> .  This is the <a href="http/pprof/">net / http / pprof port</a> ‚Äî a tool built into Go that makes it easy to profile code.  Many articles have been written about him (for example, <a href="https://habrahabr.ru/company/badoo/blog/324682/">this</a> and <a href="https://blog.golang.org/profiling-go-programs">this</a> ), so I will not dwell on the details of his work. </p><br><p>  We leave pprof even in production assemblies of demons.  It does not give almost any overhead projector until it is used, but adds flexibility: at any time you can connect and understand what is happening and what exactly the resources are spent on. </p><br><p>  In addition, we use <a href="https://golang.org/pkg/expvar/">expvar</a> , it allows one line of code to make available the values ‚Äã‚Äãof any daemon variables via HTTP in JSON format: </p><br><pre> <code class="hljs swift">expvar.<span class="hljs-type"><span class="hljs-type">Publish</span></span>(<span class="hljs-string"><span class="hljs-string">"varname"</span></span>, expvar.<span class="hljs-type"><span class="hljs-type">Func</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> interface{} { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> somevariable }))</code> </pre> <br><p>  By default, the <code>expvar</code> HTTP handler <code>expvar</code> added to <code>DefaultServeMux</code> and is available at <a href="http://yourhost/debug/vars">http: // yourhost / debug / vars</a> .  The package when connected has a side effect.  It automatically publishes with all parameters the command line with which the binary was launched, as well as the result of <code>runtime.ReadMemStats()</code> . </p><br><p>  <em>Caution!</em>  <em>ReadMemStats () can now result in a stop-the-world for a long time, if a lot of memory is allocated.</em>  <em>My colleague <a href="https://habrahabr.ru/users/mkevac/">Marco Kevac</a> created a <a href="https://github.com/golang/go/issues/13613">ticket</a> on this topic, and in version 1.9 this should be fixed.</em> </p><br><p>  In addition to the standard values, all our demons also publish a lot of debugging information, the most important is: </p><br><ul><li>  config with which the daemon is running; </li><li>  the values ‚Äã‚Äãof all statistics counters about which I wrote above; </li><li>  data on how the binary was collected. </li></ul><br><p>  With the first two points, I think everything is clear.  The latter gives information about the Go version, under which the demon was collected, the git commit hash, the build time, and other useful information about the build. </p><br><p>  Example: </p><br><p><img src="https://habrastorage.org/web/41d/380/3f9/41d3803f906d40bbbbcc4a3a016c97a1.png"></p><br><p>  We do this by generating a version.go file in which all this information is recorded.  But a similar effect can be achieved with <a href="http://stackoverflow.com/questions/11354518/golang-application-auto-build-versioning">ldflags -X</a> . </p><br><h3 id="logi">  Logs </h3><br><p>  As a logger, we use <a href="https://github.com/sirupsen/logrus">logrus</a> with our custom formatter.  Log files using Rsyslog and <a href="https://www.elastic.co/products/logstash">Logstash</a> are collected in <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> and subsequently displayed in a Kibana <a href="https://www.elastic.co/products/kibana">dashboard</a> (ELK). </p><br><p>  About why we chose these solutions, and about other details of the assembly of logs, we have already written <a href="https://habrahabr.ru/company/badoo/blog/280606/">in this article</a> , so I will not repeat. </p><br><h3 id="vorkflou-testy-i-prochee">  Workflow, tests and more </h3><br><p>  All work is done in JIRA.  Each ticket is a separate branch.  For each branch of the tickets TeamCity collects a binary.  We use GNU Make to build, since, apart from compiling directly, we need to generate version.go and code for gpbrpc from proto-files, as well as perform a number of tasks. </p><br><p>  We use Go 1.5 Vendor Experiment to be able to put the dependency code in the vendor directory.  But, unfortunately, for now we are doing this by simply adding all the dependency files to our repository.  The plans have the use of any utility for vendoring.  It looks like perspective <a href="https://github.com/golang/dep">dep</a> , it remains only to wait for its stabilization. </p><br><p>  After the ticket passes the review, the guys from the QA-team take it.  They write functional tests on new features of the daemon and check the regression.  Tests are written in PHP, because in most cases it is he who is the client of the daemon in production.  Thus, we guarantee that if something works in tests, it will work on production. </p><br><p>  As for the Go tests, they are optional and are written as needed.  But we are working on it and we plan to write more tests on Go (see postscript). </p><br><p>  From tickets checked by QA and ready for release, TeamCity builds a build branch.  When it is ready for display, the developer enters a special interface and finishes it.  At the same time, the build branch is migrated to the master, and in the JIRA-project of administrators a ticket for a display is created. </p><br><p><img src="https://habrastorage.org/web/d39/4df/27b/d394df27bfdf4a5eb2c26c09db5b29b1.png"></p><br><h3 id="shablon-demona">  Daemon pattern </h3><br><p>  Writing a new daemon in our conditions is simple, but nevertheless it requires some template actions: you need to create a directory structure, make a proto-file for the client-server protocol, configure and proto-file to it, write the server start code based on gpbrpc and so on .  In order not to bother with this every time, we created a repository with a template daemon, in which there is a small bash script that makes a new full-fledged daemon based on this template. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  As a result, we received the fact that, even when a new code has not yet written a single line of code, it is already ready for our infrastructure: </p><br><ul><li>  configured in the same way; </li><li>  writes statistics and logs; </li><li>  communicates in the same productive (protobuf) and easily readable (JSON) protocol, as well as other demons (including those written in other languages); </li><li>  equally maintained and monitored. </li></ul><br><p>  This allows us not to waste developer resources and at the same time receive predictable and easily supported services. </p><br><p>  That's all.  How do you write demons on Go?  Welcome to the comments! </p><br><p>  PS Taking this opportunity, I want to say that we are looking for talents. </p><br><p>  Much has already been written on Go, but more needs to be written, since we want to develop this area.  And we are looking for an intelligent person who can help us with this. </p><br><p>  If you are a Go-developer and know some C / C ++, write <a href="https://habrahabr.ru/users/mkevac/" class="user_link">mkevac</a> in a personal or email: m.kevac@corp.badoo.com (we look after a colleague in his team). </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328062/">https://habr.com/ru/post/328062/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328052/index.html">Boxing and unboxing - which is faster?</a></li>
<li><a href="../328054/index.html">2038: only 21 years left</a></li>
<li><a href="../328056/index.html">Accelerating the restoration of backups in PostgreSQL</a></li>
<li><a href="../328058/index.html">We speed up the restoration of backups in Postgres. Part Two (because shortening the time is not enough)</a></li>
<li><a href="../328060/index.html">New version of HPE Recovery Management Central 4.0 is available for download.</a></li>
<li><a href="../328064/index.html">3D modeling and animation: a guide for beginners</a></li>
<li><a href="../328066/index.html">Internet of things - marketing or a real threat</a></li>
<li><a href="../328068/index.html">Ensuring data and service availability: RPO, RTO performance and SLA planning</a></li>
<li><a href="../328070/index.html">Creating custom IP auto-configuration patterns for 3CX V15 phones</a></li>
<li><a href="../328072/index.html">‚Äú55% of our users do not use the web version at all‚Äù - Tinkoff.ru about mobile development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>