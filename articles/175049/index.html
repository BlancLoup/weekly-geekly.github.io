<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We optimize, optimize and optimize again</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, I occasionally have to use a profiler, since server performance requirements are documented and cannot fall below a certain level. In additio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We optimize, optimize and optimize again</h1><div class="post__text post__text-html js-mediator-article">  On duty, I occasionally have to use a profiler, since server performance requirements are documented and cannot fall below a certain level.  In addition to some obvious architectural changes and solutions, there are often repeated places from module to module, from one project to another, which create additional load on the virtual machine, which I want to share. <br>  It just so happened that the code for working with Date most often came across the eyes because we start with it: <br><br><h5>  Date </h5><br>  Not one dozen times I had the opportunity to observe how, during the processing of a single request from a user, a new date object is created in several different places.  Most often the goal is the same - to get the current time.  In the simplest case, it looks like this: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date start, Date end)</span></span></span><span class="hljs-function"> </span></span>{ Date now = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start.before(now) &amp;&amp; end.after(now); }</code> </pre> <br>  It would seem - quite obvious and correct decision.  In principle, yes, except for two things: <br><ul><li>  To use Date today in java is, perhaps, a moveton, given the fact that almost all the methods in it are already Deprecated. </li><li>  It makes no sense to create a new date object, if it is entirely possible to get along with the long primitive: </li></ul><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date start, Date end)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> now = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start.getTime() &lt; now &amp;&amp; now &lt; end.getTIme(); }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Simpledateformat </h5><br>  Very often in web projects there is a task to translate a string into a date or vice versa a date into a string.  The task is quite typical and most often looks like this: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"EEE, d MMM yyyy HH:mm:ss Z"</span></span>).parse(dateString);</code> </pre><br>  This is a correct and quick solution, but if the server has to parse a string for each user request in each of the hundreds of threads, this can significantly affect the server performance due to the rather heavyweight constructor SimpleDateFormat, and in addition to the formatter itself, many other objects are created Easy Calendar (&gt; 400 bytes in size). <br><br>  The situation could have been easily resolved by making SimpleDateFormat a static field, but it is not thread safe.  And in a competitive environment, you can easily catch NumberFormatException. <br><br>  The second thought is to use synchronization.  But this is still a rather dubious thing.  In case of a big competition between threads, we can not only not improve performance, but also worsen. <br><br>  But there are solutions and at least 2 of them: <br><ul><li>  Good old <a href="http://docs.oracle.com/javase/6/docs/api/java/lang/ThreadLocal.html">ThreadLocal</a> - we create SimpleDateFormat for each stream 1 time and reuse for each subsequent request.  This approach will help speed up the date parsing 2-4 times by avoiding the creation of SimpleDateFormat objects for each request. </li><li>  <a href="http://joda-time.sourceforge.net/">Joda</a> and its thread-safe analogue of SimpleDateFormat is <a href="http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html">DateTimeFormat</a> .  Although iodine as a whole is slower than the default Java Date API in the parsing of dates, they go on par.  A few tests can be found <a href="http://java-performance.info/joda-time-performance/">here</a> . </li></ul><br><a name="habracut"></a><br><h5>  Random </h5><br>  In my projects, there is often a task to return a random entity to the user.  Usually this kind of code looks like this: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> items.get(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().nextInt(items.size()));</code> </pre><br>  Great, easy, fast.  But, if there are a lot of calls to the method, it means the constant creation of new objects Random.  What can be easily avoided: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> items.get(rand.nextInt(items.size()));</code> </pre><br>  It would seem that here it is - the perfect solution, but even here it is not so simple.  Although Random is thread-safe, it can be slow in multi-threaded environments.  But <s>Sun</s> Oracle has already taken care of this: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> items.get(ThreadLocalRandom.current().nextInt(items.size()));</code> </pre><br>  As stated in the documentation - this is the most optimal solution for our problem.  <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ThreadLocalRandom.html">ThreadLocalRandom is</a> much more efficient than Random in a multithreaded environment.  Unfortunately, this class is only available starting from the 7th version (after the <a href="http://bugs.sun.com/bugdatabase/view_bug.do%3Fbug_id%3D7051516">bug fixes</a> , hello <a href="https://habrahabr.ru/users/theshade/" class="user_link">TheShade</a> ).  In fact, this solution is the same as with SimpleDateFormat, only with its own personal class. <br><br><h5>  Not null </h5><br>  Many developers avoid null values, write something like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Item </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Item item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Item(); <span class="hljs-comment"><span class="hljs-comment">//some logic if (something) { fillItem(item); } return item; }</span></span></code> </pre><br>  As a result, even if something never becomes true, a huge number of objects will still be created (provided that the method is called frequently). <br><br><h5>  Regexp </h5><br>  If you are writing a web application, almost certainly you use regular expressions.  Typical code: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Item </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String ip)</span></span></span><span class="hljs-function"> </span></span>{ Pattern pattern = Pattern.compile(<span class="hljs-string"><span class="hljs-string">"xxx"</span></span>); Matcher matcher = pattern.matcher(ip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matcher.matches(); }</code> </pre><br>  As in the first case, as soon as a new IP address arrived, we must do the validation.  Again for every challenge - packs of new objects.  In this particular case, the code can be slightly optimized: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Pattern pattern = Pattern.compile(<span class="hljs-string"><span class="hljs-string">"xxx"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Item </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String ip)</span></span></span><span class="hljs-function"> </span></span>{ Matcher matcher = pattern.matcher(ip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matcher.matches(); }</code> </pre><br>  Ideally, it would also be to endure the creation of a matcher outside the method, but unfortunately it is not thread-safe and you have to constantly create it.  As for single-threaded environment, there is a solution: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Pattern pattern = Pattern.compile(<span class="hljs-string"><span class="hljs-string">"xxx"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Matcher matcher = pattern.matcher(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Item </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String ip)</span></span></span><span class="hljs-function"> </span></span>{ matcher.reset(ip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matcher.matches(); }</code> </pre><br>  Which is perfect for ... right, ThreadLocal'a. <br><br><h5>  Truncate date </h5><br>  Another fairly frequent task is cutting the date by hours, days, weeks.  There are many ways to do this, from Apachev's DateUtils, to your own bikes: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Date </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">truncateToHours</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date date)</span></span></span><span class="hljs-function"> </span></span>{ Calendar calendar = Calendar.getInstance(TimeZone.getTimeZone(<span class="hljs-string"><span class="hljs-string">"UTC"</span></span>)); calendar.setTime(date); calendar.set(Calendar.HOUR_OF_DAY, <span class="hljs-number"><span class="hljs-number">0</span></span>); calendar.set(Calendar.MINUTE, <span class="hljs-number"><span class="hljs-number">0</span></span>); calendar.set(Calendar.SECOND, <span class="hljs-number"><span class="hljs-number">0</span></span>); calendar.set(Calendar.MILLISECOND, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> calendar.getTime(); }</code> </pre><br>  For example, quite recently, analyzing the code of the <a href="http://developer.yahoo.com/hadoop/tutorial/module4.html">map of the</a> phase of the Hadup, I came across such 2 lines of code that consumed 60% of the CPU: <br><br><pre> <code class="java hljs">key.setDeliveredDateContent(truncateToHours(byPeriodKey.getContentTimestamp())); key.setDeliveredDateAd(truncateToHours(byPeriodKey.getAdTimestamp()));</code> </pre><br>  For me, this was a big surprise, but the profiler is not lying.  Fortunately, the map method turned out to be thread-safe, and the creation of the calendar object was brought out of the truncateToHours () method.  That increased the speed of the map method 2 times. <br><br><h5>  HashCodeBuilder </h5><br>  I don‚Äôt know why, but some developers use Apache auxiliary classes to generate the hashcode () and equals () methods.  For example: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ EqualsBuilder equalsBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EqualsBuilder(); equalsBuilder.append(id, otherKey.getId()); ... } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HashCodeBuilder hashCodeBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashCodeBuilder(); hashCodeBuilder.append(id); ... }</code> </pre><br><br>  This, of course, is not bad if you use these methods several times during the life of the application.  But if they are invoked constantly, for example, for each key during the <a href="http://developer.yahoo.com/hadoop/tutorial/module4.html">Sort phase</a> hadoop Joba, then this may well affect the speed of execution. <br><br><h5>  Conclusion </h5><br>  Why am I not? I do not in any case urge to run and shovel the code in order to save on the creation of a pair of objects, this is information for reflection, it is quite likely that for some it will be very useful.  Thank you for reading. </div><p>Source: <a href="https://habr.com/ru/post/175049/">https://habr.com/ru/post/175049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175037/index.html">Using Photon Cloud in Unity3D</a></li>
<li><a href="../175039/index.html">Don Jones "Creating a unified IT monitoring system in your environment." Chapter 5. Turning problems into solutions</a></li>
<li><a href="../175041/index.html">CDNvideo - 3 years!</a></li>
<li><a href="../175045/index.html">50 awesome jQuery plugins</a></li>
<li><a href="../175047/index.html">Solving the problem of finding the angles of installation of a video camera over the road using different methods in Wolfram Mathematica. Part 1</a></li>
<li><a href="../175051/index.html">Use dynamic to quickly create xml</a></li>
<li><a href="../175053/index.html">Manage images and other binary content of your web project</a></li>
<li><a href="../175055/index.html">As we did SaaS: the practice of building a cloud product on the example of EZ-Login. Part 1. On analytics</a></li>
<li><a href="../175057/index.html">Humble Bundle with Android Games</a></li>
<li><a href="../175061/index.html">Mathematical proof in 140 characters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>