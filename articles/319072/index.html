<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring the virtual machine SPICE console in OpenStack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be of interest to administrators of the OpenStack cloud platform. It will be a question of displaying the console of virtual machine...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring the virtual machine SPICE console in OpenStack</h1><div class="post__text post__text-html js-mediator-article">  This article will be of interest to administrators of the OpenStack cloud platform.  It will be a question of displaying the console of virtual machines in the dashboard.  The fact is that by default, OpenStack uses the noVNC console, which works at a reasonable speed within the local network, but is poorly suited for working with virtual machines running in a remote data center.  In this case, the responsiveness of the console, to put it mildly, depresses. <br><br>  This article will discuss how to set up a much faster <a href="https://www.spice-space.org/">SPICE console</a> in your OpenStek installation. <br><a name="habracut"></a><br>  In OpenStek, there are two protocols of the virtual machine's graphic console - VNC and SPICE.  Out of the box is the web implementation of the VNC client - noVNC. <br><br>  About SPICE know much less people.  Generally, SPICE is a remote access protocol that supports a lot of useful things, such as streaming video, audio, copy-paste, USB overhead, and more.  However, in the OpenStack dashboard, the <a href="https://www.spice-space.org/spice-html5.html">SPICE-HTML5</a> web client is used, which does not support all these functions, but it displays the virtual machine console very efficiently and quickly, that is, it does exactly what you need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/9de/56a/0df/9de56a0df7024b9086d1ecc71cdfe0dd.png"><br><br>  In the official documentation ( <a href="http://docs.openstack.org/admin-guide/compute-remote-console-access.html">link1</a> , <a href="http://docs.openstack.org/security-guide/compute/how-to-select-virtual-consoles.html">link2</a> ) Openstek has quite a bit of information on configuring the SPICE console.  In addition, it says that "VNC must be explicitly disabled to get access to the SPICE console".  This is not entirely true, rather, the point is that with the VNC console turned on, you cannot use the SPICE console from the dashboard (but still you can use the API, I mean ‚Äúnova get-spice-console‚Äù using python-novaclient) .  In addition, the SPICE-console will be available only for new virtual machines, old before the hard reboot, resize or migration will still use only VNC. <br><br>  So, in this article I used two versions of OpenStek from Mirantis: Kilo (Mirantis OpenStack 7.0) and Mitaka (Mirantis OpenStack 9.0).  As with all enterprise distributions, a configuration with three controller nodes and HTTPS on the frontend is used.  The qemu-kvm hypervisor, Ubuntu 14.04 OS, everywhere, deployed the cloud through Fuel. <br><br>  The configuration blocks and controller-nodes and computers.  On the controller nodes do the following. <br><br>  We put the spice-html5 package itself: <br><br><pre><code class="bash hljs">apt-get install spice-html5</code> </pre> <br>  Enter the following values ‚Äã‚Äãinto the Nova config: <br><br>  <b>/etc/nova/nova.conf</b> <br><pre> <code class="bash hljs">[DEFAULT] ssl_only = True cert = <span class="hljs-string"><span class="hljs-string">'/path/to/SSL/cert'</span></span> key = <span class="hljs-string"><span class="hljs-string">'/path/to/SSL/key'</span></span> web=/usr/share/spice-html5 [spice] spicehtml5proxy_host = :: html5proxy_base_url = https://&lt;FRONTEND_FQDN&gt;:6082/spice_auto.html enabled = True keymap = en-us</code> </pre> <br>  where &lt;FRONTEND_FQDN&gt; is the FQDN of your Horizon dashboard.  Obviously, the certificate and the key above must match the FRONTEND_FQDN, otherwise the modern browser will not allow the SPICE widget to work.  If your Horizon does not use HTTPS, then SSL settings can be omitted. <br><br>  For simultaneous operation of noVNC and SPICE, you need to do this trick: <br><br><pre> <code class="bash hljs">cp -r /usr/share/novnc/* /usr/share/spice-html5/</code> </pre> <br>  To work through HTTPS, you need to use Secure Websockets, for this you have to correct the file /usr/share/spice-html5/spice_auto.html.  In this part of the code you need to fix ‚Äúws: //‚Äù to ‚Äúwss: //‚Äù <br><br>  <b>/usr/share/spice-html5/spice_auto.html</b> <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host, port, password, scheme = <span class="hljs-string"><span class="hljs-string">"wss://"</span></span>, uri;</code> </pre> <br>  Again, for simultaneous operation of noVNC and SPICE, you need to correct the upstart-scripts /etc/init/nova-novncproxy.conf and /etc/init/nova-spicehtml5proxy.conf.  In both scripts you need to comment out one line: <br><br>  <b>/etc/init/nova-spicehtml5proxy.conf</b> <br><pre> <code class="bash hljs">script [ -r /etc/default/nova-consoleproxy ] &amp;&amp; . /etc/default/nova-consoleproxy || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-comment"><span class="hljs-comment">#[ "${NOVA_CONSOLE_PROXY_TYPE}" = "spicehtml5" ] || exit 0</span></span></code> </pre> <br>  <b>/etc/init/nova-novncproxy.conf</b> <br><pre> <code class="bash hljs">script [ -r /etc/default/nova-consoleproxy ] &amp;&amp; . /etc/default/nova-consoleproxy || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-comment"><span class="hljs-comment">#[ "${NOVA_CONSOLE_PROXY_TYPE}" = "novnc" ] || exit 0</span></span></code> </pre> <br>  Actually, this allows you to remove the console type check from the / etc / default / nova-consoleproxy file. <br><br>  Now you need to fix the Haproxy configs: <br><br>  <b>/etc/haproxy/conf.d/170-nova-novncproxy.cfg</b> <br><pre> <code class="bash hljs">listen nova-novncproxy <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> &lt;PUBLIC_VIP&gt;:6080 ssl crt /var/lib/astute/haproxy/public_haproxy.pem no-sslv3 no-tls-tickets ciphers AES128+EECDH:AES128+EDH:AES256+EECDH:AES256+EDH balance <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> option httplog option http-buffer-request timeout http-request 10s server controller1 192.168.57.6:6080 ssl verify none check server controller2 192.168.57.3:6080 ssl verify none check server controller3 192.168.57.7:6080 ssl verify none check</code> </pre> <br>  <b>/etc/haproxy/conf.d/171-nova-spiceproxy.cfg</b> <br><pre> <code class="bash hljs">listen nova-novncproxy <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> &lt;PUBLIC_VIP&gt;:6082 ssl crt /var/lib/astute/haproxy/public_haproxy.pem no-sslv3 no-tls-tickets ciphers AES128+EECDH:AES128+EDH:AES256+EECDH:AES256+EDH balance <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> option httplog timeout tunnel 3600s server controller1 192.168.57.6:6082 ssl verify none check server controller2 192.168.57.3:6082 ssl verify none check server controller3 192.168.57.7:6082 ssl verify none check</code> </pre> <br>  where PUBLIC_VIP is the IP address where the FRONTEND_FQDN is hanging. <br><br>  Finally, we restart the services on the controller nodes: <br><br><pre> <code class="bash hljs">service nova-spicehtml5proxy restart service apache2 restart crm resource restart p_haproxy</code> </pre> <br>  here p_haproxy is the Pacemaker resource for Haproxy, through which numerous OpenStek services run. <br><br>  On each compute node, you need to make changes to the Nova config: <br>  <b>/etc/nova/nova.conf</b> <br><br><pre> <code class="bash hljs">[spice] spicehtml5proxy_host = :: html5proxy_base_url = https://&lt;FRONTEND_FQDN&gt;:6082/spice_auto.html enabled = True agent_enabled = True server_listen = :: server_proxyclient_address = COMPUTE_MGMT_IP keymap = en-us</code> </pre> <br>  here COMPUTE_MGMT_IP is the address of the management interface of this compute node (in Mirantis OpenStack there is a division into the public and management networks). <br><br>  After that, you need to restart the nova-compute service: <br><br><pre> <code class="bash hljs">service nova-compute restart</code> </pre> <br>  Now one important point.  I already wrote above that we do not turn off the VNC, because  in this case, the existing virtuals will lose the console in the dashboard.  However, if we deploy a cloud from scratch, then it makes sense to completely turn off VNC.  To do this, in the Nova config on all nodes, set: <br><br><pre> <code class="bash hljs">[DEFAULT] vnc_enabled = False novnc_enabled = False</code> </pre> <br>  But anyway, if we activate VNC and SPICE together in the cloud, in which the virtual machines are already spinning, then after all the above actions, nothing will change outwardly for already running virtual machines or for new ones - the noVNC console will still open.  If you look in the Horizon settings, the type of console used is controlled by the following setting: <br><br>  <b>/etc/openstack-dashboard/local_settings.py</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Set Console type: # valid options would be "AUTO", "VNC" or "SPICE" # CONSOLE_TYPE = "AUTO"</span></span></code> </pre> <br>  By default, the AUTO value, that is, the console type is automatically selected.  But what does this mean?  The point is in one file, where the priority of consoles is set: <br><br>  <b>/usr/share/openstack-dashboard/openstack_dashboard/dashboards/project/instances/console.py</b> <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>CONSOLES = SortedDict([(<span class="hljs-string"><span class="hljs-string">'VNC'</span></span>, api.nova.server_vnc_console), (<span class="hljs-string"><span class="hljs-string">'SPICE'</span></span>, api.nova.server_spice_console), (<span class="hljs-string"><span class="hljs-string">'RDP'</span></span>, api.nova.server_rdp_console), (<span class="hljs-string"><span class="hljs-string">'SERIAL'</span></span>, api.nova.server_serial_console)]) ...</code> </pre> <br>  As you can see, the VNC console has priority, if there is one.  If not, then the SPICE console will be searched.  It makes sense to change the first two points in some places, then the existing virtual machines will still work with a slow VNC, and new ones with a new fast SPICE.  Just what you need! <br><br>  Subjectively, we can say that the SPICE console is very fast.  In the mode without graphics, there are no brakes at all, in the graphic mode everything also works quickly, and compared to the VNC protocol, it‚Äôs just heaven and earth!  So I recommend it to everyone! <br><br>  At this point, the setting can be considered complete, but in the end I will show how, in fact, both of these consoles look in the XML-config libvirt: <br><br><pre> <code class="bash hljs"> &lt;graphics <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'vnc'</span></span> port=<span class="hljs-string"><span class="hljs-string">'5900'</span></span> autoport=<span class="hljs-string"><span class="hljs-string">'yes'</span></span> listen=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span> keymap=<span class="hljs-string"><span class="hljs-string">'en-us'</span></span>&gt; &lt;listen <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'address'</span></span> address=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>/&gt; &lt;/graphics&gt; &lt;graphics <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'spice'</span></span> port=<span class="hljs-string"><span class="hljs-string">'5901'</span></span> autoport=<span class="hljs-string"><span class="hljs-string">'yes'</span></span> listen=<span class="hljs-string"><span class="hljs-string">'::'</span></span> keymap=<span class="hljs-string"><span class="hljs-string">'en-us'</span></span>&gt; &lt;listen <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'address'</span></span> address=<span class="hljs-string"><span class="hljs-string">'::'</span></span>/&gt; &lt;/graphics&gt;</code> </pre> <br>  Obviously, if you have network access to the virtual machine compute node, you can use any other VNC / SPICE client instead of the web interface, simply by connecting to the port in the configuration above (in this case, 5900 for VNC and 5901 for SPICE) . </div><p>Source: <a href="https://habr.com/ru/post/319072/">https://habr.com/ru/post/319072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319056/index.html">FuseTools - a unique tool for prototyping and development</a></li>
<li><a href="../319058/index.html">IBM Expands Serverless OpenWhisk Platform</a></li>
<li><a href="../319060/index.html">Saltan Spectroscope: laplacians for fan</a></li>
<li><a href="../319062/index.html">Microsoft MVP Global Summit 2016, margin notes</a></li>
<li><a href="../319066/index.html">Google earned so much that it was not necessary to think about money. Until now</a></li>
<li><a href="../319074/index.html">Analysis of the report of Baruch Sadogursky with JPoint 2015</a></li>
<li><a href="../319076/index.html">Create an honest Forex</a></li>
<li><a href="../319078/index.html">Step by Step Guide: Building JDK9 from Source on Windows 10</a></li>
<li><a href="../319080/index.html">Basics of computer networks. Subject number 6. VLAN, Trunk, and VTP and DTP protocols</a></li>
<li><a href="../319082/index.html">Dual Wan and the features of the implementation of NetWatch in MikroTik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>