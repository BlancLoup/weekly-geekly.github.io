<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving the work of artificial intelligence in Nemesida WAF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we described how the artificial intelligence Nemesida WAF helps with absolute accuracy to detect attacks on web applications ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving the work of artificial intelligence in Nemesida WAF</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/e7/75/59e775120eb32190002675.png"><br><br>  In the <a href="https://habrahabr.ru/company/pentestit/blog/340704/">previous article,</a> we described how the artificial intelligence Nemesida WAF helps with absolute accuracy to detect attacks on web applications with a minimum number of false positives.  In this article, the new mechanism of work of Nemesida AI will be considered, which allows to increase the accuracy of detecting attacks by 2 times compared to the signature method, and also to reduce the number of false positives to 0.01%. <br><a name="habracut"></a><br><h2>  Theory: An Approach to Improving Recognition Accuracy </h2><br>  The work of WAF in the signature analysis mode (including in the ‚Äúchain of rules‚Äù mode) is accompanied by a large number of false positives (False Positive), and the result of creating a table of legitimate queries or rules for excluding blocking will increase the possibility of such a WAF bypass.  Even with a minimal list of legitimate queries, the likelihood of circumvention is extremely high.  Topical WAF workarounds include: <br><br> <code>-   (/*!%55NiOn*/ /*!%53eLEct*/); <br> -   (/?id=1/**/union/*&amp;id=*/select/*&amp;id=*/pwd/*&amp;id=*/from/*&amp;id=*/users); <br> -   (-1 UnIoN SeleCT pAssWord fROM USers); <br> -    (union%20%64istinctRO%57%20select).</code> <br> <br>  The introduction of artificial intelligence in Nemesida WAF solved both problems.  Now to improve the learning mechanism of Nemesida AI, we use the following strategy: <br>  1. fixing the level of false positives on the value of 0.01%; <br>  2. increase to the maximum detection level for a given level of false positives. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, the parameters of the classifier are selected taking into account the fulfillment of each of the conditions, and the result of solving the problem of forming training samples of two classes based on the vector space model (legitimate traffic and attacks) directly affects the quality of the classifier. <br><img src="https://habrastorage.org/webt/cx/vv/f2/cxvvf2s-9ljkpqybh_zrb37w_dy.png"><br><br>  The training sample of illegitimate traffic is based on the existing database of attack signatures obtained using the manual and semi-automatic testing mode of web applications, and legitimate traffic based on requests coming to the protected web application and recognized by the signature analyzer as legitimate.  This approach allows you to adapt the Nemesida AI training system for a specific web application, reducing the number of false positives to a minimum.  The volume of the legitimate traffic sample that is formed depends on the amount of free RAM of the server on which Nemesida WAF operates.  The recommended parameter is 120.000 requests with 10 GB of free RAM for training models. <br><img src="https://habrastorage.org/webt/gp/xo/rv/gpxorvmhlbvbdcxznwuuldvfnf0.png"><br><br><blockquote>  The AdaBoost algorithm (abbr. From adaptive boosting) is a machine learning algorithm proposed by Yoav Freund and Robert Schapire.  It is a meta-algorithm; in the process of learning it builds a composition from basic learning algorithms to improve their efficiency.  AdaBoost is an adaptive boosting algorithm in the sense that each successive classifier is built according to objects that are poorly classified by previous classifiers.  In our case, the basic algorithm is decisive trees.  AdaBoost causes a weak classifier in a loop.  After each call, the distribution of weights is updated, which correspond to the importance of each of the objects in the training set for classification.  At each iteration, the weights of each wrongly classified object increase, thus the new classifier ‚Äúfocuses its attention‚Äù on these objects. <br><br>  TF-IDF (from TF - term frequency, IDF - inverse document frequency) - a statistical measure used to assess the importance of a word in the context of a document that is part of a document collection or corpus.  The weight of a word is proportional to the number of words used in the document, and inversely proportional to the frequency of words in other documents in the collection.  The TF-IDF measure is often used in problems of text analysis and information retrieval, for example, as one of the criteria for the relevance of a document to a search query, when calculating the measure of document proximity for clustering. </blockquote><br>  During the iterative replenishment of the training sample for the class of illegitimate traffic, the following pattern was revealed: with an increase in the number of attacks in the database, the accuracy of their detection also increases, while an excessive increase in the number of attacks in the database can lead to a significant increase in false positives.  Given the large number of experiments performed, a base has been formed by now, containing 189,316 different requests with different signs of an attack on web applications.  Thus, to date, it has been possible to achieve the required level of false positives (0.01%), increasing the accuracy of detecting new (not recognized by the signature method) attacks. <br><br><h2>  Practice: testing and generation of training data sets </h2><br>  To determine illegitimate requests, the existing attack signature database is used, supplemented by manual and semi-automatic testing of web applications.  As a test, WebApp uses popular CMS, as well as systems that knowingly contain vulnerabilities (for example, DVWA). <br><img src="https://habrastorage.org/webt/mm/ra/e8/mmrae8-yhjoenr7ltabhcgmxgga.png"><br><br>  The first is generated legitimate traffic that does not contain malicious requests, signs of attack or exploitation of vulnerabilities.  This allows you to select a legitimate model of user behavior. <br><br><div class="spoiler">  <b class="spoiler_title">An example of a legitimate query that does not contain SQL injection operation vectors:</b> <div class="spoiler_text"> <code>GET /vulnerabilities/sqli/?id=1&amp;Submit=Submit HTTP/1.1 <br> Host: waf.office.pentestit.ru <br> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:57.0) Gecko/20100101 Firefox/57.0 <br> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 <br> Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3 <br> Accept-Encoding: gzip, deflate <br> Referer: http://waf.office.pentestit.ru/vulnerabilities/sqli/ <br> Cookie: PHPSESSID=e91108c6l9jcqv9ob813kore73; security=low <br> Connection: close <br> Upgrade-Insecure-Requests: 1 <br> <img src="https://habrastorage.org/webt/4i/ax/zn/4iaxznftgeeqkfnt6d5ftwv4i-q.png"> <br></code> <br></div></div><br><br>  The second stage is testing for penetration of a web application using both specialized tools and ‚Äúmanual‚Äù analysis to identify and exploit vulnerabilities. <br><br><div class="spoiler">  <b class="spoiler_title">An example of a query that exploits a SQLi vulnerability:</b> <div class="spoiler_text"> <code>POST /vulnerabilities/sqli/ HTTP/1.1 <br> Host: waf.office.pentestit.ru <br> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:57.0) Gecko/20100101 Firefox/57.0 <br> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 <br> Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3 <br> Accept-Encoding: gzip, deflate <br> Referer: http://waf.office.pentestit.ru/vulnerabilities/sqli/ <br> Content-Type: application/x-www-form-urlencoded <br> Content-Length: 49 <br> Cookie: PHPSESSID=e91108c6l9jcqv9ob813kore73; security=medium; _ym_uid=1512232172282659138; _ym_isad=2; _ym_visorc_45042173=w; _ym_visorc_25686548=w; _ym_visorc_36267400=w <br> Connection: close <br> Upgrade-Insecure-Requests: 1 <br> <br> id=3 and 0 union select @@version,2&amp;Submit=Submit <br></code> </div></div><br><br><div class="spoiler">  <b class="spoiler_title">As a result of the query, the DBMS version will be displayed:</b> <div class="spoiler_text"> <code>First name: 10.1.26-MariaDB-0+deb9u1 <br></code> <br></div></div><br><br>  These requests are marked as illegitimate and enter the Nemesida WAF artificial intelligence processing system.  Vulnerable parameters are tested by many types of requests (payloads), which are both vectors of exploitation and attacks, which make it possible to identify vulnerabilities. <br><br><div class="spoiler">  <b class="spoiler_title">An example query containing the 'sleep' or 'benchmark' functions:</b> <div class="spoiler_text"> <code>SLEEP(5)# <br> SLEEP(5)-- <br> SLEEP(5)=" <br> SLEEP(5)=' <br> or SLEEP(5) <br> or SLEEP(5)# <br> or SLEEP(5)-- <br> or SLEEP(5)=" <br> or SLEEP(5)=' <br> waitfor delay '00:00:05' <br> waitfor delay '00:00:05'-- <br> waitfor delay '00:00:05'# <br> benchmark(50000000,MD5(1)) <br> benchmark(50000000,MD5(1))-- <br> benchmark(50000000,MD5(1))# <br> or benchmark(50000000,MD5(1)) <br> or benchmark(50000000,MD5(1))-- <br> or benchmark(50000000,MD5(1))# <br></code> </div></div><br><br>  Web application testing technique using OWASP ZAP (fuzzing): <br><img src="https://habrastorage.org/webt/n7/dy/ob/n7dyobpczs_elnbqp7gundvmmym.png"><br><br>  After several iterations of the first and second stages, the existing training model is tested to reduce the number of false positives.  The more illegitimate requests are processed, the more accurate the detection of anomalies, including file content, after which the base of the collected anomalies in the form of an attack model as the basis for training for a specific web application is automatically uploaded to the server from Nemesida WAF: <br><img src="https://habrastorage.org/webt/qn/-7/wd/qn-7wdtbit9ens37uolqylmscjq.png"><br><br><h3>  Conclusion </h3><br>  The improved mechanism of learning artificial intelligence in Nemesida WAF allows 2 times more accurately detect attacks on a web application, while reducing to almost zero the number of false positives.  In addition, Nemesida WAF contains a Virtualpatch system and a built-in vulnerability scanner, which, in case of detection of vulnerabilities in the protected web application, quickly install their own patch for the vulnerable component. <br><br>  Nemesida WAF is a powerful tool to protect the site from attacks, and to experience this in practice, request a ready-made virtual machine with the pre-installed <a href="https://waf.pentestit.ru/">Nemesida WAF</a> test version or activate cloud protection for 2 weeks for free. </div><p>Source: <a href="https://habr.com/ru/post/344104/">https://habr.com/ru/post/344104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344090/index.html">How to build a community. Translation of the book "Social Architecture": Chapter 1. Toolkit</a></li>
<li><a href="../344092/index.html">Product Design Digest, November 2017</a></li>
<li><a href="../344094/index.html">What I learned after 1000 code review</a></li>
<li><a href="../344098/index.html">Four releases of 1.0 from CNCF and major announcements about Kubernetes with KubeCon 2017</a></li>
<li><a href="../344100/index.html">Designed for data centers: a new generation of Dell EMC PowerEdge servers and converged systems</a></li>
<li><a href="../344106/index.html">How Facebook acquired Instagram and why it led to the discovery of the source code React.js</a></li>
<li><a href="../344108/index.html">Two-sided locale in conversion from string to fractional</a></li>
<li><a href="../344110/index.html">Learning difficulties: how to make friends with technology?</a></li>
<li><a href="../344112/index.html">Bitcoin - clay feet</a></li>
<li><a href="../344114/index.html">4 common design mistakes that are easy to fix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>