<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Directional Bluetooth Beacon (iBeacon) and Full Mobile Fax</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inversion is a great thing! Invent something one thing, and then take it and turn it inside out, you will get an equally interesting result. At first ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Directional Bluetooth Beacon (iBeacon) and Full Mobile Fax</h1><div class="post__text post__text-html js-mediator-article"><p>  Inversion is a great thing!  Invent something one thing, and then take it and turn it inside out, you will get an equally interesting result.  At first I did this with one thing, and only then I saw that in TRIZ (the theory of solving inventive problems) there is such a technique ‚Äúinversion or inverse analogy‚Äù.  Live and learn. </p><br><p>  But this is all theory, and practice puts everything in its place ... </p><a name="habracut"></a><br><p>  Bluetooth Low Energy beacons or iBeacon are no longer something out of the ordinary.  They can be found at train stations, airports, museums and shopping centers.  As a radio engineer, I participated in the design of lighthouses and, in particular, antennas for them.  The point is, at first interesting, then it becomes boring.  There is nothing to stand out, you will not invent anything particularly new.  And then it dawned on me! </p><br><p>  I took my direction finder ( <a href="https://habrahabr.ru/post/323638/">one</a> and <a href="https://habrahabr.ru/post/339586/">two</a> <a href="https://habrahabr.ru/post/323638/">times</a> ) and looked at it from the back.  And what if to make it a beacon?  Here we need to remind the reader that this direction finder consists of two antennas: one with a smooth radiation pattern, the other with a rapidly changing one. </p><br><p><img src="https://habrastorage.org/files/48c/21f/b56/48c21fb565c84f8aac16c2bcc9634c53.PNG" alt="image"></p><br><p>  This is a cut of the radiation pattern.  In 3D, it looks like this: </p><br><p><img src="https://habrastorage.org/webt/cs/n1/2j/csn12jgjxrslm3hvdfhlqwefogy.png"></p><br><p>  The direction finder "induces focus" on the difference in the levels of these two antennas.  If you are interested in detail, you can look at <a href="https://github.com/xnzr">Github</a> . </p><br><p>  Here are small code snippets with the logic of the direction finder: </p><br><p>  We get levels from both antennas.  The resulting levels are required to average, and then calculate the difference.  In fact, this is not a difference of signals, but their attitude.  But if measured in <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D1%2586%25D0%25B8%25D0%25B1%25D0%25B5%25D0%25BB">decibels</a> , there will be a difference. </p><br><div class="spoiler">  <b class="spoiler_title">Write levels to buffer</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WFPacket data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.apName.equals(ssid) &amp;&amp; data.mac.equals(mac)) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = data.antIdx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> &lt;= idx &amp;&amp; idx &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { mLevels.get(idx).addLast(data.power); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (mLevels.get(idx).size() &gt; avgCount) { mLevels.get(idx).removeFirst(); } needRecalc = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; print(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"LevelCalculator.HandleInfo() Bad rcvIdx: "</span></span> + data.antIdx); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needRecalc; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Averaging and calculating the difference</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAvg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needRecalc) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; idx &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; idx++) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>d; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Double x : mLevels.get(idx)) { sum += x; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = mLevels.get(idx).size(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count != <span class="hljs-number"><span class="hljs-number">0</span></span>) { sum /= count; } avgLevels[idx] = sum; } avgDiff = Math.pow(<span class="hljs-number"><span class="hljs-number">10.0</span></span>, (avgLevels[<span class="hljs-number"><span class="hljs-number">1</span></span>] - avgLevels[<span class="hljs-number"><span class="hljs-number">0</span></span>]) * <span class="hljs-number"><span class="hljs-number">0.1</span></span> + <span class="hljs-number"><span class="hljs-number">2.5</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    needRecalc = false; } return avgDiff; }</span></span></code> </pre> </div></div><br><p>  Handling the "difference".  If the levels on both antennas differ "strongly", then we are directed to the source with some accuracy (plus or minus bast).  What is this "strongly" at the moment determined <del>  scientific method </del>  experimentally. </p><br><div class="spoiler">  <b class="spoiler_title">private void updateLevelDiff (double levelDiff)</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateLevelDiff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> levelDiff)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> deltaTime = System.currentTimeMillis() - lastUpdateTime; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> progress = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Math.floor(<span class="hljs-number"><span class="hljs-number">100.0</span></span> * levelDiff); <span class="hljs-comment"><span class="hljs-comment">//       //   if (deltaTime &gt; TIME_PERIOD) { //        if (progress &lt; mThreshold) { //      ,         addBearing(); numUpdates++; } lastUpdateTime = System.currentTimeMillis(); } //   GUI }</span></span></code> </pre> </div></div><br><p>  And now we INVERT! </p><br><p>  Let an iBeacon beacon with one number be radiated to one antenna and another with another.  Then, on a mobile device, you can measure the levels of both beacons and determine from the difference how close it is to the focus of the beacon antennas.  It turns out the positioning in the direction of arrival of the wave. </p><br><p>  The standard Bluetooth version 5 even announced a similar method of high-precision positioning - Angle of Departure.  They have not yet reached the exact description of this method, they promise in the next versions. </p><br><p>  In the refined form, the work can be illustrated with rollers: <a href="https://www.youtube.com/watch%3Fv%3DWCq2EsmzXyw">once</a> and <a href="https://www.youtube.com/watch%3Fv%3DVJg6Bk3pwn0">twice</a> . </p><br><p>  The application sets the threshold for the difference in levels, by which it is determined that the mobile device is in an imaginary cone with an axis coinciding with the normal to the plane of the antenna. </p><br><p><img src="https://habrastorage.org/webt/zo/wd/91/zowd91vptiz0eh-a02-t3kiww8i.png"></p><br><p>  The lighthouse itself looks like this: </p><br><p><img src="https://habrastorage.org/webt/9r/rd/jy/9rrdjycryxbwpcla5yrujlfuvyk.jpeg"></p><br><p>  But the renders of the viscera: </p><br><p><img src="https://habrastorage.org/webt/lw/t1/1r/lwt11rzphp3vqcquw8txdocuuem.jpeg"></p><br><p>  Handsome, is not it?  Inside the antenna, as in the direction finder WiFi, and Bluetooth SoC nRF51822.  But all was in vain ... </p><br><p>  Further, the story goes to the facs, which is that it works on the Nexus 5 smartphone and finding another gadget that works at least that way was not very easy.  No, they are, Samsung Galaxy S7, Lenovo Phab 2 Pro, and the list ends for now.  More "good" gadgets found from friends and acquaintances failed.  From the "bad" can be noted Samsung S4 mini. </p><br><p>  Of course, the lighthouse was tested.  It emits packets on two antennas in turn with a minimum interval.  A small interval is needed so that the measurements relate to points in time that are slightly separated from each other.  Otherwise it will not be possible to relate them to each other. </p><br><p>  A <a href="https://yadi.sk/i/bn39NVGh3PzyJM">log</a> was recorded from a Bluetooth sniffer using the wonderful WireShark.  Log analysis shows that everything is emitted correctly, time intervals and levels are normal.  The oscilloscope also showed nothing unrecorded at the exit of the lighthouse. </p><br><p>  However, on a large number of gadgets it works poorly.  The problem is measurement loss.  In the <a href="">Android application</a> was built diagnostics of receiving pairs of packages.  Quality score was made percentage of paired packages.  So, the indicator from 80 to 100 was observed only on some gadgets.  On the rest of the tested sample of mobile devices, the indicator was from 20 to 60. In motion, the level ratio was not measured accurately.  There was an attempt to compensate for this by increasing the radiation frequency of the packets, but this did not work.  Something inside the Android interferes with normal measurements. </p><br><p>  Sources of this outrage are available on <a href="https://github.com/airtago">Github</a> . </p><br><p>  There is little hope that the situation on iOS can be better.  At least more homogeneous on the range of mobile devices. </p><br><p>  There is also hope that there will be a specialist who will understand what the problem is and prompt a solution. </p><br><p>  And now I am very sorry that this idea does not work. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343136/">https://habr.com/ru/post/343136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343124/index.html">To learn to think as a programmer, you must learn to think like a non-programmer.</a></li>
<li><a href="../343126/index.html">Children - ice cream, information system - backup</a></li>
<li><a href="../343128/index.html">Full DKIM, DMARC and SPF syntax</a></li>
<li><a href="../343130/index.html">Black Friday 2017 - VDS in Moscow and Amsterdam</a></li>
<li><a href="../343132/index.html">Script for adding service packs to a Windows image</a></li>
<li><a href="../343138/index.html">Flussonic Watcher for an Internet provider</a></li>
<li><a href="../343140/index.html">SAS: we analyzed data and trained models long before it became fashionable</a></li>
<li><a href="../343142/index.html">[Poll] Your most illegal / unethical project</a></li>
<li><a href="../343144/index.html">Hik or Hack? (NOT) IoT security with the example of Hikvision IP camera</a></li>
<li><a href="../343146/index.html">Machine intelligence is looking for answers to the riddles of the universe. How - we will tell at the open seminar AI @ MIPT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>