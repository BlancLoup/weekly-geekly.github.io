<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx on steroids - expanding functionality with LUA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To ensure the operation of all our external products, we use the popular nginx. It is fast and reliable. There are almost no problems with it. Our pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx on steroids - expanding functionality with LUA</h1><div class="post__text post__text-html js-mediator-article">  To ensure the operation of all our external products, we use the popular nginx.  It is fast and reliable.  There are almost no problems with it.  Our products are also constantly evolving, new services are emerging, new functionality is being added, and old ones are expanding.  The audience and the load is only growing.  Now we want to talk about how we accelerated development, increased the performance quite well and simplified the addition of this new functionality to our services, while maintaining the availability and resiliency of the affected applications.  It will be about the concept of ‚Äúnginx as web application‚Äù. <br>  Namely, about <a href="http://wiki.nginx.org/3rdPartyModules">third-party</a> modules (mainly LUA), allowing you to do completely magical things quickly and reliably. <br><img src="https://habrastorage.org/getpro/habr/post_images/b3a/751/640/b3a75164032962969a175544dbc922f4.jpg" alt="image"><br><a name="habracut"></a><br><br><h5>  Problems and solution </h5><br>  The main idea is quite simple.  Take the following factors: <br>  - the complexity of the application logic, <br>  - the number of application components, <br>  - the size of the audience. <br>  From a certain point it becomes quite difficult to keep the application responsive and fast, sometimes even workable.  The product becomes multi-component, geographically distributed.  And more and more people use it.  At the same time, there are business requirements for responsiveness and resiliency, which must first be respected. <br>  There are several ways to solve this problem.  Everything can be broken and altered to other technologies.  Of course, this option works, but we didn‚Äôt like it very much and we decided to redo it gradually.  The basis was the <a href="http://openresty.org/">openresty</a> build (nginx + LUA).  Why lua.  Without the help of cgi, fastcgi and other cgi, right in the nginx configuration file you can script powerful, beautiful and fast functionality.  Everything works asynchronously.  And not only with clients, but also with backends.  At the same time, it does not interfere with the event loop of the web server, without callbacks, fully using the existing nginx functionality. <br><br>  Currently the following backends are available: <br>  - Redis <br>  - memcache <br>  - MySQL <br>  - PostgreSQL <br>  In addition, you can connect more modules for use, such as <a href="https://github.com/wingify/lua-resty-rabbitmqstomp">RabbitMQ</a> and <a href="https://github.com/FRiCKLE/ngx_zeromq">ZeroMQ</a> . <br>  It works pretty fast.  Anyway, faster than php-fpm)) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The logical question is, why not rewrite everything at all in C?  Writing to LUA is much easier and faster.  And we are immediately spared from the problems associated with asynchrony and the nginx event loop. <br><br><h5>  Examples  Ideas </h5><br>  We, as usual, will not give the full code, only the main parts.  These all things were made in php before. <br><br>  1. This part was invented and made by our colleague <a href="https://habrahabr.ru/users/aotd/" class="user_link">AotD</a> .  There is a repository of pictures.  They should be shown to users, and it is desirable to perform some operations, for example, resize.  Pictures we store in ceph, this is an analogue of Amazon S3.  For image processing used ImageMagick.  There is a cache directory on the resizer; the processed images are added to it. <br>  Parsing the user's request, defining the image, the resolution he needs and going to ceph, then processing and displaying it on the fly. <br>  serve_image.lua <br><pre><code class="lua hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"config"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return_not_found</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg)</span></span></span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = ngx.HTTP_NOT_FOUND <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.header[<span class="hljs-string"><span class="hljs-string">"X-Message"</span></span>] = msg <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> name, size, ext = ngx.var.name, ngx.var.size, ngx.var.ext <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> size <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> size == <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> return_not_found() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> image_scales[size] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> return_not_found(<span class="hljs-string"><span class="hljs-string">'Unexpected image scale'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> cache_dir = static_storage_path .. <span class="hljs-string"><span class="hljs-string">'/'</span></span> .. ngx.var.first .. <span class="hljs-string"><span class="hljs-string">'/'</span></span> .. ngx.var.second .. <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> original_fname = cache_dir .. name .. ext <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> dest_fname = cache_dir .. name .. size .. ext <span class="hljs-comment"><span class="hljs-comment">-- make sure the file exists local file = io.open(original_fname) if not file then -- download file contents from ceph ngx.req.read_body() local data = ngx.location.capture("/ceph_loader", {vars = { name = name .. ext }}) if data.status == ngx.HTTP_OK and data.body:len()&gt;0 then os.execute( "mkdir -p " .. cache_dir ) local original = io.open(original_fname, "w") original:write(data.body) original:close() else return_not_found('Original returned ' .. data.status) end end local magick = require("imagick") magick.thumb(original_fname, image_scales[size], dest_fname) ngx.exec("@after_resize")</span></span></code> </pre> <br><br>  We connect imagic.lua <a href="https://github.com/leafo/magick">binding</a> .  Must be available <a href="http://luajit.org/">LuaJIT</a> . <br><br>  nginx_partial_resizer.conf.template <br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment"># Old images location ~ ^/(small|small_wide|medium|big|mobile|scaled|original|iphone_(preview|retina_preview|big|retina_big|small|retina_small))_ { rewrite /([^/]+)$ /__CEPH_BUCKET__/$1 break; proxy_pass __UPSTREAM__; } # Try get image from ceph, then from local cache, then from scaled by lua original # If image test.png is original, when user wants test_30x30.png: # 1) Try get it from ceph, if not exists # 2) Try get it from /cache/t/es/test_30x30.ong, if not exists # 3) Resize original test.png and put it in /cache/t/es/test_30x30.ong location ~ ^/(?&lt;name&gt;(?&lt;first&gt;.)(?&lt;second&gt;..)[^_]+)((?&lt;size&gt;_[^.]+)|)(?&lt;ext&gt;\.[a-zA-Z]*)$ { proxy_intercept_errors on; rewrite /([^/]+)$ /__CEPH_BUCKET__/$1 break; proxy_pass __UPSTREAM__; error_page 404 403 = @local; } # Helper failover location for upper command cause you can't write # try_files __UPSTREAM__ /cache/$uri @resizer =404; location @local { try_files /cache/$first/$second/$name$size$ext @resize; } # If scaled file not found in local cache resize it with lua magic! location @resize { # lua_code_cache off; content_by_lua_file "__APP_DIR__/lua/serve_image.lua"; } # serve scaled file, invoked in @resizer serve_image.lua location @after_resize { try_files /cache/$first/$second/$name$size$ext =404; } # used in @resizer serve_image.lua to download original image # $name contains original image file name location =/ceph_loader { internal; rewrite ^(.+)$ /__CEPH_BUCKET__/$name break; proxy_set_header Cache-Control no-cache; proxy_set_header If-Modified-Since ""; proxy_set_header If-None-Match ""; proxy_pass __UPSTREAM__; } location =/favicon.ico { return 404; } location =/robots.txt {}</span></span></code> </pre><br><br>  2. Firewall for API.  Validation of the request, customer identification, control of rps and a barrier for those who do not need us. <br>  Firewall.lua <br><pre> <code class="lua hljs">module(..., <span class="hljs-built_in"><span class="hljs-built_in">package</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">seeall</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ban</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, element)</span></span></span></span> CStorage.banPermanent:set(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> .. <span class="hljs-string"><span class="hljs-string">'__'</span></span> .. element, <span class="hljs-number"><span class="hljs-number">1</span></span>); ngx.location.capture(<span class="hljs-string"><span class="hljs-string">'/postgres_ban'</span></span>, { [<span class="hljs-string"><span class="hljs-string">'vars'</span></span>] = { [<span class="hljs-string"><span class="hljs-string">'type'</span></span>] = <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, [<span class="hljs-string"><span class="hljs-string">'value'</span></span>] = element} }); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkBanned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiKey)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- init search criteria local searchCriteria = {}; searchCriteria['key'] = apiKey; if ngx.var.remote_addr then searchCriteria['ip'] = ngx.var.remote_addr; end; -- search in ban lists for type, item in pairs(searchCriteria) do local storageKey = type .. '__' .. item; if CStorage.banPermanent:get(storageKey) then ngx.exit(444); elseif CStorage.banTmp:get(storageKey) then -- calculate rps and check is our client still bad boy 8-) local rps = CStorage.RPS:incr(storageKey, 1); if not(rps) then CStorage.RPS:set(storageKey, 1, 1); rps=1; end; if rps then if rps &gt; config.app_params['ban_params']['rps_for_ip_to_permanent_ban'] then CStorage.RPS:delete(storageKey); ban(type, item); ngx.exit(444); elseif config.app_params['ban_params']['rps_for_ip_to_tmp_ban'] &gt; 0 and rps == config.app_params['ban_params']['rps_for_ip_to_tmp_ban'] then local attemptsCount = CStorage.banTmp:incr(storageKey, 1) - 1; if attemptsCount &gt; config.app_params['ban_params']['tmp_ban']['max_attempt_to_exceed_rps'] then -- permanent ban CStorage.banTmp:delete(storageKey); ban(type, item); end; end; end; ngx.exit(444); end; end; end; local function checkTemporaryBlocked(apiKey) local blockedData = CStorage.tmpBlockedDemoKeys:get(apiKey); if blockedData then --storage.tmpBlockedDemoKeys:incr(apiKey, 1); -- think about it. return CApiException.throw('tmpDemoBlocked'); end; end; local function checkRPS(apiKey) local rps = nil; -- check rps for IP and ban it if it's needed if ngx.var.remote_addr then local ip = 'ip__' .. tostring(ngx.var.remote_addr); rps = CStorage.RPS:incr(ip, 1); if not(rps) then CStorage.RPS:set(ip, 1, 1); rps = 1; end; if rps &gt; config.app_params['ban_params']['rps_for_ip_to_permanent_ban'] then ban('ip', tostring(ngx.var.remote_addr)); ngx.exit(444); elseif config.app_params['ban_params']['rps_for_ip_to_tmp_ban'] &gt; 0 and rps &gt; config.app_params['ban_params']['rps_for_ip_to_tmp_ban'] then CStorage.banTmp:set(ip, 1, config.app_params['ban_params']['tmp_ban']['time']); ngx.exit(444); end; end; local apiKey_key_storage = 'key_' .. apiKey['key']; -- check rps for key rps = CStorage.RPS:incr(apiKey_key_storage, 1); if not(rps) then CStorage.RPS:set(apiKey_key_storage, 1, 1); rps = 1; end; if apiKey['max_rps'] and rps &gt; tonumber(apiKey['max_rps']) then if apiKey['mode'] == 'demo' then CApiKey.blockTemporary(apiKey['key']); return CApiException.throw('tmpDemoBlocked'); else CApiKey.block(apiKey['key']); return CApiException.throw('blocked'); end; end; -- similar check requests per period (RPP) for key if apiKey['max_request_count_per_period'] and apiKey['period_length'] then local rpp = CStorage.RPP:incr(apiKey_key_storage, 1); if not(rpp) then CStorage.RPP:set(apiKey_key_storage, 1, tonumber(apiKey['period_length'])); rpp = 1; end; if rpp &gt; tonumber(apiKey['max_request_count_per_period']) then if apiKey['mode'] == 'demo' then CApiKey.blockTemporary(apiKey['key']); return CApiException.throw('tmpDemoBlocked'); else CApiKey.block(apiKey['key']); return CApiException.throw('blocked'); end; end; end; end; function run() local apiKey = ngx.ctx.REQUEST['key']; if not(apiKey) then return CApiException.throw('unauthorized'); end; apiKey = tostring(apiKey) -- check permanent and temporary banned checkBanned(apiKey); -- check api key apiKey = CApiKey.getData(apiKey); if not(apiKey) then return CApiException.throw('forbidden'); end; apiKey = JSON:decode(apiKey); if not(apiKey['is_active']) then return CApiException.throw('blocked'); end; apiKey['key'] = tostring(apiKey['key']); -- check is key in tmp blocked list if apiKey['mode'] == 'demo' then checkTemporaryBlocked(apiKey['key']); end; -- check requests count per second and per period checkRPS(apiKey); -- set apiKey's json to global parameter; in index.lua we send it through nginx to php application ngx.ctx.GLOBAL['api_key'] = JSON:encode(apiKey); end;</span></span></code> </pre><br><br>  Validator.lua <br><pre> <code class="lua hljs">module(..., <span class="hljs-built_in"><span class="hljs-built_in">package</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">seeall</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkApiVersion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> apiVersion = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (ngx.ctx.REQUEST[<span class="hljs-string"><span class="hljs-string">'version'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> nginx_request = <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(ngx.var.uri); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> version = nginx_request:<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(version:<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(version:<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> apiVersion = version; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CApiException.throw(<span class="hljs-string"><span class="hljs-string">'versionIsRequired'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> apiVersion = ngx.ctx.REQUEST[<span class="hljs-string"><span class="hljs-string">'version'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> isSupported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, version <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.app_params[<span class="hljs-string"><span class="hljs-string">'supported_api_version'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> apiVersion == version <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> isSupported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (isSupported) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CApiException.throw(<span class="hljs-string"><span class="hljs-string">'unsupportedVersion'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ngx.ctx.GLOBAL[<span class="hljs-string"><span class="hljs-string">'api_version'</span></span>] = apiVersion; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (ngx.ctx.REQUEST[<span class="hljs-string"><span class="hljs-string">'key'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CApiException.throw(<span class="hljs-string"><span class="hljs-string">'unauthorized'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> checkApiVersion(); checkKey(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Apikey.lua <br><pre> <code class="lua hljs">module ( ..., <span class="hljs-built_in"><span class="hljs-built_in">package</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">seeall</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>(ngx.ctx.GLOBAL[<span class="hljs-string"><span class="hljs-string">'CApiKey'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.ctx.GLOBAL[<span class="hljs-string"><span class="hljs-string">'CApiKey'</span></span>] = {}; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> CStorage.apiKey:flush_all(); CStorage.apiKey:flush_expired(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> dbError = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> dbData = ngx.location.capture(<span class="hljs-string"><span class="hljs-string">'/postgres_get_keys'</span></span>); dbData = dbData.body; dbData, dbError = rdsParser.parse(dbData); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dbData ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> rows = dbData.resultset <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> rows <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ipairs</span></span>(rows) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> cacheKeyData = {}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> col, val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(row) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> val ~= rdsParser.null <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cacheKeyData[col] = val; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cacheKeyData[col] = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> CStorage.apiKey:set(<span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(cacheKeyData[<span class="hljs-string"><span class="hljs-string">'key'</span></span>]),JSON:encode(cacheKeyData)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkNotEmpty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>(ngx.ctx.GLOBAL[<span class="hljs-string"><span class="hljs-string">'CApiKey'</span></span>][<span class="hljs-string"><span class="hljs-string">'loaded'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> cnt = CHelper.tablelength(CStorage.apiKey:get_keys(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cnt == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">load</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ngx.ctx.GLOBAL[<span class="hljs-string"><span class="hljs-string">'CApiKey'</span></span>][<span class="hljs-string"><span class="hljs-string">'loaded'</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key)</span></span></span></span> checkNotEmpty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CStorage.apiKey:get(key); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key)</span></span></span></span> key = getData(key); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> key = JSON:decode(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key[<span class="hljs-string"><span class="hljs-string">'is_active'</span></span>] ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> key[<span class="hljs-string"><span class="hljs-string">'is_active'</span></span>] == <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> result = <span class="hljs-string"><span class="hljs-string">'allowed'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> result = <span class="hljs-string"><span class="hljs-string">'blocked'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> result = <span class="hljs-string"><span class="hljs-string">'forbidden'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blockTemporary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiKey)</span></span></span></span> apiKey = <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(apiKey); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> isset = getData(apiKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isset <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CStorage.tmpBlockedDemoKeys:set(apiKey, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.app_params[<span class="hljs-string"><span class="hljs-string">'ban_params'</span></span>][<span class="hljs-string"><span class="hljs-string">'time_demo_apikey_block_tmp'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">block</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiKey)</span></span></span></span> apiKey = <span class="hljs-built_in"><span class="hljs-built_in">tostring</span></span>(apiKey); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> keyData = getData(apiKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> keyData <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.location.capture(<span class="hljs-string"><span class="hljs-string">'/redis_get'</span></span>, { [<span class="hljs-string"><span class="hljs-string">'vars'</span></span>] = { [<span class="hljs-string"><span class="hljs-string">'key'</span></span>] = apiKey } }); keyData[<span class="hljs-string"><span class="hljs-string">'is_active'</span></span>] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; CStorage.apiKey:set(apiKey,JSON:encode(cacheKeyData)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Storages.lua <br><pre> <code class="lua hljs">module ( ..., <span class="hljs-built_in"><span class="hljs-built_in">package</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">seeall</span></span> ) apiKey = ngx.shared.apiKey; RPS = ngx.shared.RPS; RPP = ngx.shared.RPP; banPermanent = ngx.shared.banPermanent; banTmp = ngx.shared.banTmp; tmpBlockedDemoKeys = ngx.shared.tmpBlockedDemoKeys;</code> </pre><br><br>  3. Additional services, such as inter-component communication using the AMQP protocol.  An example is <a href="https://github.com/wingify/lua-resty-rabbitmqstomp">here</a> . <br><br>  4. As I <a href="http://habrahabr.ru/company/nordavind/blog/196518/">wrote</a> .  Self-diagnostics module of the application with the ability to "intelligently" manage routes for passing the request through the backend.  Still in development. <br><br>  5. Adapters for APIs.  In some cases, it is necessary to correct, supplement or expand existing methods.  To not rewrite everything, <a href="http://tech.3scale.net/2013/01/09/augment-your-api-without-touching-it/">LUA will help</a> .  For example, json &lt;-&gt; xml conversion on the fly. <br><br>  6 ...  many more ideas. <br><br>  Benchmarks alone will not.  Products are too complicated and RPS after Bench is highly dependent on many factors.  However, for our products, we achieved a 20-fold increase in performance for the affected functionality, and in some cases everything became faster up to ~ 200 times. <br><br><h5>  Advantages and disadvantages </h5><br>  Tangible benefits.  Everything that used to be 5 megabytes of code on php turns into a 100kb file on lua. <br>  - development speed, <br>  - the speed of the application, <br>  - reliability <br>  - asynchronous work with clients and backends, without breaking the nginx event loop, <br>  - LUA sugar feel good!  Korutin, shared dictionary for all nginx forks, sabrekvesta, a lot of binding. <br><br>  Imperceptible cons. <br>  - it is necessary to do everything carefully and remember about asynchrony and nginx event loop. <br>  - the frontend works so fast that it may not like the backend.  There is a direct connection between them, without interlayers.  For example, I am sure that 10,000 queries per second LUA on the frontend will be easily chewed.  But if at the same time it wants to go to the base, there may be problems. <br>  - it is quite difficult to debug if something goes wrong. <br><br>  By the way, while this article is being written, right at this moment our programmer <a href="http://www.highload.ru/2013/abstracts/934.html">talks</a> about all this in detail on highload. <br><br>  We are pleased to answer questions in the comments. <br><br>  Finally, <a href="https://github.com/mindreframer/nginx-lua-stuff">here you can find a</a> small selection of information on the topic. </div><p>Source: <a href="https://habr.com/ru/post/199504/">https://habr.com/ru/post/199504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199496/index.html">RMI means C ++ and boost.preprocessor</a></li>
<li><a href="../199498/index.html">Easy localization of the name of the Windows Phone application</a></li>
<li><a href="../1995/index.html">Google begins to combine search for news and blogs.</a></li>
<li><a href="../199500/index.html">Something went wrong</a></li>
<li><a href="../199502/index.html">RESTful Api using Zend framework 2</a></li>
<li><a href="../199506/index.html">Motorola Ara - a project to create modular smartphones</a></li>
<li><a href="../199508/index.html">IEEE 802.11s Wi-Fi Mesh for the smallest part one</a></li>
<li><a href="../19951/index.html">TheBat 4 is out!</a></li>
<li><a href="../199510/index.html">Drupal.org updated to Drupal 7</a></li>
<li><a href="../199512/index.html">Bender: ideological fighter for minimal CSS / Javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>