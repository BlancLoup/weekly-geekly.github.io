<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Server clustering of markers on the map. From theory to practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr. The story begins with the fact that we decided to make a geo service with the possibility of placing labels on the map by the users themselve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Server clustering of markers on the map. From theory to practice</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr.  The story begins with the fact that we decided to make a geo service with the possibility of placing labels on the map by the users themselves. <br>  And when they decided to pour 1 million markers into the database, they realized that even if you only need to request markers within a certain radius, everything works very slowly and clustering on the client is also not an option :) <br><br>  And somewhere under this forest is manhattan. <br><img src="https://habrastorage.org/files/58f/c76/9ba/58fc769bac174b31a75cf30ad36f08c0.png"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Clustering is a very interesting task, there is a client one, there is a server one and all large map services support it.  There are many types of clustering, but in my search I chose Grid clustering.  Yandex employees told about it in several of their reports at conferences.  It is used in Yandex maps for clustering markers. <div class="spoiler">  <b class="spoiler_title">Yandex clustering</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/92b/65a/021/92b65a02155c4a7c924950104b339f77.png"></div></div><br><br><h2>  Some theory </h2><br>  Grid clustering is based on the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F_%25D0%259C%25D0%25B5%25D1%2580%25D0%25BA%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25B0">Mercator projection</a> , in short it is the projection of the spherical surface of the globe onto a rectangular plane.  This is just all atlases, maps, etc.  As the name implies in this clustering, we cover the map with a grid and calculate the number of markers in each cell of this grid. <br><br>  Terms: <br><br>  <b>A tile (tile)</b> is in fact simply dividing a map into squares for a specific zoom.  At the first level, our map will consist of 1 square (tile) at level 0, at level 1 of 4 squares (tiles), at the second level at 16 at the third at 64, and so on.  In fact, it is 4 to the degree level. <br><img src="https://habrastorage.org/files/368/af1/e94/368af1e9408d4c8483ada398418b48d0.jpg"><br><br>  <b>Quadkey</b> is a unique identifier of a tile at any level.  At the first level, we number tiles 0,1,2,3 from right to left, from top to bottom.  Then at the next level for each tile from the top level we do the same number, but already adding the quadkey parent, i.e.  00,01,02,03,10,11,12,13 etc.  It becomes more clear from the picture: <br><img src="https://habrastorage.org/files/f58/923/9e6/f589239e68c04a4984c95b530d875d1a.jpg"><br>  Finally, we got a number in 4-hour numbering system.  Now we have each tile has a unique identifier at any zoom level.  From the zoom, latitude and longitude, you can get the quadkey tile itself;  Any point can be converted to a quadkey of the corresponding zoom level.  This is how quadkey will look like for specific coordinates: <br>  longitude -79.377807617187500 <br>  latitude 43.653785705566406 <br>  quadkey 13940830302567 (base4: 03022313122033033011213) <br><br>  Description of this approach in the English language from Microsoft: <br>  <a href="https://msdn.microsoft.com/en-us/library/bb259689.aspx">Bing Maps Tile System</a> <br>  In this article, the implementation of all these transformations is written in C #, I quickly rewrote it in PHP: <br><div class="spoiler">  <b class="spoiler_title">TileSystem.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TileSystem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EarthRadius = <span class="hljs-number"><span class="hljs-number">6378137</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MinLatitude = <span class="hljs-number"><span class="hljs-number">-90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MaxLatitude = <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MinLongitude = <span class="hljs-number"><span class="hljs-number">-180</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MaxLongitude = <span class="hljs-number"><span class="hljs-number">180</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MaxZoom = <span class="hljs-number"><span class="hljs-number">23</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $n, $minValue, $maxValue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> min( max( $n, $minValue), $maxValue); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> &lt;&lt; $levelOfDetail; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GroundResolution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $latitude, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $latitude = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $latitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MinLatitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MaxLatitude); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cos( $latitude * pi() / <span class="hljs-number"><span class="hljs-number">180</span></span>) * <span class="hljs-number"><span class="hljs-number">2</span></span> * pi() * <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::EarthRadius / <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::mapSize( $levelOfDetail); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $latitude, $levelOfDetail, $screenDpi)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::groundResolution( $latitude, $levelOfDetail) * $screenDpi / <span class="hljs-number"><span class="hljs-number">0.0254</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">latToPixelY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $latitude, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $latitude = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $latitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MinLatitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MaxLatitude); $sinLatitude = sin( $latitude * pi() / <span class="hljs-number"><span class="hljs-number">180</span></span>); $y = <span class="hljs-number"><span class="hljs-number">0.5</span></span> - log((<span class="hljs-number"><span class="hljs-number">1</span></span> + $sinLatitude) / (<span class="hljs-number"><span class="hljs-number">1</span></span> - $sinLatitude)) / (<span class="hljs-number"><span class="hljs-number">4</span></span> * pi()); $mapSize = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::mapSize( $levelOfDetail); $pixelY = (int) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $y * $mapSize + <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $mapSize - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $pixelY; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">longToPixelX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $longitude, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $longitude = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $longitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MinLongitude, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MaxLongitude); $x = ($longitude + <span class="hljs-number"><span class="hljs-number">180</span></span>) / <span class="hljs-number"><span class="hljs-number">360</span></span>; $mapSize = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::mapSize( $levelOfDetail); $pixelX = (int) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $x * $mapSize + <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $mapSize - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $pixelX; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelXToLong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelX, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $mapSize = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::mapSize( $levelOfDetail); $x = ( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $pixelX, <span class="hljs-number"><span class="hljs-number">0</span></span>, $mapSize - <span class="hljs-number"><span class="hljs-number">1</span></span>) / $mapSize) - <span class="hljs-number"><span class="hljs-number">0.5</span></span>; $longitude = <span class="hljs-number"><span class="hljs-number">360</span></span> * $x; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $longitude; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelYToLat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelY, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $mapSize = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::mapSize( $levelOfDetail); $y = <span class="hljs-number"><span class="hljs-number">0.5</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::clip( $pixelY, <span class="hljs-number"><span class="hljs-number">0</span></span>, $mapSize - <span class="hljs-number"><span class="hljs-number">1</span></span>) / $mapSize); $latitude = <span class="hljs-number"><span class="hljs-number">90</span></span> - <span class="hljs-number"><span class="hljs-number">360</span></span> * atan( exp(-$y * <span class="hljs-number"><span class="hljs-number">2</span></span> * pi())) / pi(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $latitude; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelYToTileY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $pixelY / <span class="hljs-number"><span class="hljs-number">256</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelXToTileX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelX)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $pixelX / <span class="hljs-number"><span class="hljs-number">256</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tileXYToPixelXY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $tileX, $tileY, &amp;$pixelX, &amp;$pixelY)</span></span></span><span class="hljs-function"> </span></span>{ $pixelX = $tileX * <span class="hljs-number"><span class="hljs-number">256</span></span>; $pixelY = $tileY * <span class="hljs-number"><span class="hljs-number">256</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tileXYToQuadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $tileX, $tileY, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($levelOfDetail == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"0"</span></span>; $quadKey = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = $levelOfDetail; $i &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; $i--) { $digit = <span class="hljs-number"><span class="hljs-number">0</span></span>; $mask = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ($i - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($tileX &amp; $mask) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { $digit++; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($tileY &amp; $mask) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { $digit++; $digit++; } $quadKey .= $digit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $quadKey; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">latLongToQuadKeyDec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $lat, $long, $zoom)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::quadKey4ToDec( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::latLongToQuadKey( $lat, $long, $zoom)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">latLongToQuadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $lat, $long, $zoom)</span></span></span><span class="hljs-function"> </span></span>{ $pixelX = \foci\utils\TileSystem::longToPixelX( $long, $zoom); $pixelY = \foci\utils\TileSystem::latToPixelY( $lat, $zoom); $tileX = \foci\utils\TileSystem::pixelXToTileX( $pixelX); $tileY = \foci\utils\TileSystem::pixelYToTileY( $pixelY); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> \foci\utils\TileSystem::tileXYToQuadKey( $tileX, $tileY, $zoom); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelXYToQuadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelX, $pixelY, $zoom)</span></span></span><span class="hljs-function"> </span></span>{ $tileX = \foci\utils\TileSystem::pixelXToTileX( $pixelX); $tileY = \foci\utils\TileSystem::pixelYToTileY( $pixelY); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> \foci\utils\TileSystem::tileXYToQuadKey( $tileX, $tileY, $zoom); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelXYToQuadKeyDec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $pixelX, $pixelY, $zoom)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base_convert( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::pixelXYToQuadKey( $pixelX, $pixelY, $zoom), <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quadKeyToTileXY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $quadKey, &amp;$tileX, &amp;$tileY, &amp;$levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ $tileX = $tileY = <span class="hljs-number"><span class="hljs-number">0</span></span>; $levelOfDetail = strlen( $quadKey); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( $i = $levelOfDetail; $i &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; $i--) { $mask = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ($i - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>( $quadKey[$levelOfDetail - $i]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>: $tileX |= $mask; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'2'</span></span>: $tileY |= $mask; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'3'</span></span>: $tileX |= $mask; $tileY |= $mask; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>:; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tileXYToQuadKeyDec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $tileX, $tileY, $levelOfDetail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base_convert( <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::tileXYToQuadKey( $tileX, $tileY, $levelOfDetail), <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quadKey4ToDec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $quadkey)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base_convert( $quadkey, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); } }</code> </pre> </div></div><br><br><h2>  Go to practice </h2><br><h3>  Area of ‚Äã‚Äãvisibility </h3><br>  Here it is necessary to take into account an important point, you do not need to request all the clusters on the map on a specific zoom, but you need to receive only those that are within the scope of the client (in our case, this is android and web). <br><br>  Options for obtaining clusters in scope: <br><ul><li>  <b>Smart client.</b>  The client himself determines which zoom he needs and which clusters will enter his area of ‚Äã‚Äãvisibility and requests them all at once, for example, when initializing the view or only requesting those that are in scope when moving around the map </li><li>  <b>Lazy customer.</b>  The client simply sends its scope to the server and displays what will be sent by the server. </li></ul><br>  We chose a <b>lazy client</b> .  Why? <br><ul><li>  Client logic is very simple.  After all, the client works as a view, which got it and displays it. </li><li>  This simplicity is convenient if, as we have several clients on different platforms.  No need to duplicate the cunning logic of determining foci in scope.  All logic is concentrated in one place - on the server. </li><li>  As shown, it takes a little time to implement. </li></ul><br>  What will be the logic of the server? <br><ul><li>  The coordinates of the corners of the rectangular field of view (for example, the upper left corner, the lower right corner) come to the server. </li><li>  The server, knowing the dimensions of this rectangular area, determines the size of the tile that is included in it (both in width and in height) </li><li>  Further, the server knowing the size of the tile can determine the zoom, so it is not necessary to transmit it along with the coordinates. </li><li>  Then you need to consider that this zoom should be increased, for a more convenient display. </li><li>  And the last server will determine the quadkey-and within the scope, will make a selection of clusters and give it to the client. </li></ul><br><h3>  Storage </h3><br>  To store quadkey-s, we need to choose a zoom level, take 23, it will be quite enough.  DB will use MySQL.  The marker storage table will have the following structure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`marker`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`latitude`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>(<span class="hljs-number"><span class="hljs-number">19</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`longitude`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>(<span class="hljs-number"><span class="hljs-number">19</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`quadkey`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`quadkey `</span></span> (<span class="hljs-string"><span class="hljs-string">`quadkey `</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  The quadkey index allows us to easily sample the number of markers in a tile (cluster). <br><br>  To store quadkey in MySQL, you can use bigint (20), just translate from a 4-h system into a decimal system and into a database and application we work with a 10-h quadkey. <br><br><h3>  Cluster acquisition code </h3><br>  The code for getting clusters will look something like this: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClusters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $quad_key, $zoom)</span></span></span><span class="hljs-function"> </span></span>{ $q1 = $quad_key . str_repeat(<span class="hljs-string"><span class="hljs-string">"0"</span></span>, TileSystem::MaxZoom - $zoom); $q2 = $quad_key . str_repeat(<span class="hljs-string"><span class="hljs-string">"3"</span></span>, TileSystem::MaxZoom - $zoom); $mask = $q1; $mask_plus = <span class="hljs-number"><span class="hljs-number">1</span></span>; $mask = $quad_key . str_repeat(<span class="hljs-string"><span class="hljs-string">"3"</span></span>, $mask_plus); $mask = $mask . str_repeat(<span class="hljs-string"><span class="hljs-string">"0"</span></span>, TileSystem::MaxZoom - $zoom - $mask_plus); $q1 = TileSystem::quadKey4ToDec( $q1); $q2 = TileSystem::quadKey4ToDec( $q2); $mask = TileSystem::quadKey4ToDec( $mask); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt; findBetweenQuadKeys( $q1, $q2, $mask); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBetweenQuadKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $quad_key_l, $quad_key_r, $mask)</span></span></span><span class="hljs-function"> </span></span>{ $entities = []; $sql = <span class="hljs-string"><span class="hljs-string">"SELECT `quadkey`, MIN(id) AS id, COUNT(id) AS count, AVG(longitude) AS longitude, AVG(latitude) AS latitude "</span></span>; $sql .= <span class="hljs-string"><span class="hljs-string">"FROM `marker ` "</span></span>; $sql .= <span class="hljs-string"><span class="hljs-string">"WHERE `quadkey` BETWEEN $quad_key_l AND $quad_key_r "</span></span>; $sql .= <span class="hljs-string"><span class="hljs-string">"AND `is_deleted`= '0' "</span></span>; $sql .= <span class="hljs-string"><span class="hljs-string">"GROUP BY (`quadkey` &amp; $mask) "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( $stmt = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_connection-&gt;query( $sql)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( $stmt <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) $entities[] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_createEntityFromRow( $row); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $entities; }</code> </pre><br>  The $ mask variable allows us to group the quadkey-c with a specific zoom.  The variables $ quad_key_l and $ quad_key_r allow you to count quadkey-and all markers for a given parent, ie if $ quad_key_l = 03022313122033033000000 and $ quad_key_r = 03022313122033033033333 we will find in the database all markers for 030223131220330330. <br>  This is what the resulting sql query will look like: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`quadkey`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(longitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> longitude, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(latitude) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> latitude <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> marker <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> quadkey <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">15499682906112</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">15499683168255</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (quadkey &amp; <span class="hljs-number"><span class="hljs-number">15499683151872</span></span>); <span class="hljs-comment"><span class="hljs-comment">--   4-  -- WHERE quadkey between "03201203031012000000000" and "03201203031012333333333" -- GROUP BY (quadkey &amp; "03201203031012330000000")</span></span></code> </pre><br><br><h3>  What happened </h3><br>  Unfortunately, screenshots with clusters based on 1 million markers did not survive (although it was something), but there is a current small base, and this is how it looks: <br>  web <br><img src="https://habrastorage.org/files/5d6/5f1/83a/5d65f183a3d54be8b5f7f012a4c8a74d.png"><br>  Android <br><img src="https://habrastorage.org/files/75f/e10/881/75fe1088174a4008980c0ca9e7aec664.jpg"><br><br>  The coordinates of the clusters are in the place of the largest cluster of markers in the tile and not in its center, and all thanks to a simple averaging of the coordinates in the sql query. <br><br><h2>  results </h2><br>  A service using this clustering is running and running.  The approach itself is very convenient for further scaling. <br>  To avoid the constant recalculation of the number of markers in the cluster, cachesting caching is simply added. <br>  If we consider this topic further, then tiles are actively used by map services for drawing maps.  Something similar is also used in game development, etc. <br><br><h2>  Sources </h2><br>  <a href="https://www.mapbox.com/guides/how-web-maps-work">www.mapbox.com/guides/how-web-maps-work</a> <br>  <a href="https://msdn.microsoft.com/en-us/library/bb259689.aspx">msdn.microsoft.com/en-us/library/bb259689.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/268621/">https://habr.com/ru/post/268621/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268611/index.html">The digest of interesting materials for the mobile # 124 developer (October 5-11)</a></li>
<li><a href="../268613/index.html">Using hardlinks (hardlink) for Synology DSM incremental backup</a></li>
<li><a href="../268615/index.html">Programming with YII2: get down to work</a></li>
<li><a href="../268617/index.html">Create a REST service on Rust. Part 4: go to the REST API</a></li>
<li><a href="../268619/index.html">Ode to a good vendor: choose a platform for launching a VoIP SaaS project</a></li>
<li><a href="../268623/index.html">Email Privacy Notice: Not a Good Idea</a></li>
<li><a href="../268625/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ180 (October 5 - 11, 2015)</a></li>
<li><a href="../268627/index.html">CQRS Types</a></li>
<li><a href="../268629/index.html">Social network aggregator uniava.com</a></li>
<li><a href="../268631/index.html">PostgreSQL features not found in MySQL, and vice versa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>