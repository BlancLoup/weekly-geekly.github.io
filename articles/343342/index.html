<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yet another kaspersky crackme</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This time, LK has released six kryakmi, two of which were written in human language C. Let's start the analysis. Link , archive , sample from the arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yet another kaspersky crackme</h1><div class="post__text post__text-html js-mediator-article">  This time, LK has released six kryakmi, two of which were written in <s>human language</s> C. Let's start the analysis.  <a href="https://events.kaspersky.com/crackme/tasks">Link</a> , <a href="https://events.kaspersky.com/crackme/tasks">archive</a> , <a href="https://filebin.ca/3l0Xv6SrFmSl">sample from the article</a> . <a name="habracut"></a><br><br>  <b>SHADOW</b> <br>  In the description of the task is written: <br><blockquote>  ‚ÄúOllydbg will not save you, researchers!  The game will be played in the dark corners of the operating system kernel.  Do you have the courage to know the hidden places of virtual reality?  Shadow is waiting for you, find him! ‚Äù </blockquote>  The hint is clear.  We make a couple of runs with our sample analyzers: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4-/yq/er/4-yqerw4ry4l2-oixzvzc8pcsak.png"><br></div></div><br>  Oke, everything is clean.  We look at the import: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ce/bq/ux/cebquxqdnyvk6fmobbrxtcwek6w.png"><br></div></div><br>  At this stage, without digging up dysasm listing (it is small, see offset 00402310), you can understand the logic of the application: <br><br><ol><li>  Driver is loading (CreateService) </li><li>  Some parameters are passed to it (DeviceIoControl) </li><li>  Driver is doing something </li><li>  ??? </li></ol><br>  Obviously, we need to hook the driver.  We load the r3 archetype debugger ‚ÄúOlya‚Äù, set a bryak on CreateServiceA, DeviceIoControl and click F9 (there is no anti-debugging).  The breakpoint on CreateServiceA is immediately triggered, the stack looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xe/5p/yq/xe5pyqc5refrljbt8thzalstozw.png"><br></div></div><br>  We notice the path to our driver, copy it somewhere.  Klatsay F9, catch another stop at the same function: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/yb/bl/p_/ybblp_zl-fav6arsdgvb_lcifxu.png"><br></div></div><br>  It may seem to you that this is the same driver, but take a closer look: the names are a little different.  We will keep it too.  Klatsay F9, in front of us there is a console with a request to enter some data: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ty/qo/sx/tyqosxijzg5b2epqrwyjixjvb0g.png"><br></div></div><br>  Enter random send.  Immediately triggered on DeviceIoControl: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j9/7u/df/j97udfvra9m1usg7nzeq_6t7i2m.png"><br></div></div><br>  Here we can contemplate our bundle of meyl: the series, which is transmitted by the third and fifth parameters, respectively.  The fourth and sixth argument is the size of the buffers (including zero).  We trace in the debugger to ret, then before one.  As a result, we will see the following picture: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hx/et/nd/hxetndw__ygt3hbjev6jreuqxku.png"><br></div></div><br>  In other words, if DeviceIoControl returned a non-zero value, the crack is resolved.  Well, let's move on to learning the first driver.  DriverEntry: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jz/kg/2t/jzkg2typfi3advykllgxa4djqjo.png"><br></div></div><br>  DeviceIoControl Handler: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rj/ca/n0/rjcan00xsc6k4jd8vjr5qaeqzb4.png"><br></div></div><br>  Cherished Validate: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sx/ua/le/sxualejtfl6a_j9gheivwk9vyck.png"><br></div></div><br>  To reverse this feature is not difficult.  However, let us remember that we have a second driver, about which we do not yet know anything.  Its driverentry: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gk/5w/i0/gk5wi06unv4s5ocux0mckuvkz34.png"><br></div></div><br>  An interesting movie!  It looks like a real driver filter.  We look at the handler: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/my/t3/cu/myt3cu4ntgcslgk3mtxxlvdp_em.png"><br></div></div><br>  What we see here: <br><br><ol><li>  The ValidateStr function is responsible for the additional validation of our primary data: only the characters A..Z + a..z + 0..9 + '.'  + '@'.  I would have torn off my hands to the person who added such a check - personally, my meil does not pass it, it contains the symbol '-' </li><li>  The ModifyMail function changes our file as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hb/g3/np/hbg3npkzwqnvkt8yabimfsrw0em.png"><br></div></div></li><li>  IofCallDriver transfers control to the main driver with already changed data </li></ol><br>  Thus, taking into account all the checks, you can jot down something like this: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> char mail[257]; char hashes[32][33]; void main() { for (;;) { printf_s(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Enter your name (1 chars min and 256 chars max, only A..Z + a..z + '.' + '@'):\n"</span></span></span><span class="hljs-meta">); fgets(mail, 257, stdin); int ln = strlen(mail) - 1; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (mail[ln] == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\n'</span></span></span><span class="hljs-meta">) mail[ln] = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\x00'</span></span></span><span class="hljs-meta">; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ln++; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ln </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 1) continue; for (int i = 0; i &lt; ln; i++) { if ((mail[i] &lt; '0' || mail[i] &gt; '9') &amp;&amp; mail[i] != '.' &amp;&amp; mail[i] != '@') { if (i &amp; 1) mail[i] &amp;= 0xDF; else mail[i] |= 0x20; } } //change chars case GetMD5(mail, ln, mail); for (int i = 0; i &lt; 32; i++) { if (mail[i] &lt; '0' || mail[i] &gt; '9') { mail[i] &amp;= 0xDF; GetMD5(mail, 32, hashes[i]); mail[i] |= 0x20; } else GetMD5(mail, 32, hashes[i]); } for (int i = 0; i &lt; 32; i++) mail[i] = hashes[i][i]; printf("%s\n", mail); } }</span></span></span></span></code> </pre> <br></div></div><br>  The GetMD5 function is the most standard one taken <a href="http://www.sources.ru/builder/faq/118.html">from here</a> .  Compile, run: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ur/ij/1a/urij1amuggj2vv4wnwby7jjhj7e.png"><br></div></div><br>  Solved.  I say goodbye to this. </div><p>Source: <a href="https://habr.com/ru/post/343342/">https://habr.com/ru/post/343342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343332/index.html">Hamster Marketplace Token: what tasks it solves and why it is one of a kind</a></li>
<li><a href="../343334/index.html">How to frontend developer set up a database</a></li>
<li><a href="../343336/index.html">How to teach a neural network to invent the names of Russian settlements</a></li>
<li><a href="../343338/index.html">27 free services for creating visual content without a designer</a></li>
<li><a href="../343340/index.html">7 Short Rules for Conquering the Global Market</a></li>
<li><a href="../343344/index.html">LLVM source guide</a></li>
<li><a href="../343346/index.html">Distribution video. Ambush: nginx or php?</a></li>
<li><a href="../343348/index.html">3 Unusual Linux Networking Cases</a></li>
<li><a href="../343350/index.html">‚ÄúDo you want to be a system architect? There is only light and purity ... "</a></li>
<li><a href="../343352/index.html">How we did a huge amount of communication for a rather big security structure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>