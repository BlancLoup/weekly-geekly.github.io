<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Racoon vs. OpenSWAN: Configuring IPSEC VPN HOST-TO-SITE Tunnel with Cisco and L2TP over IPSEC for Windows, iOS and Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good deeds, dear Habravchane! 

 In this article, I would like to captivate you with a story about my adventures in search of reliable and secure IPSe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Racoon vs. OpenSWAN: Configuring IPSEC VPN HOST-TO-SITE Tunnel with Cisco and L2TP over IPSEC for Windows, iOS and Android</h1><div class="post__text post__text-html js-mediator-article">  Good deeds, dear Habravchane! <br><br>  In this article, I would like to captivate you with a story about my adventures in search of reliable and secure IPSec connections, where you will find many amazing discoveries and disappointments, riddles and answers, stories of faithful service and treacherous betrayals.  So, my dear reader, get ready, start the story. <br><br>  <i>To the reader who needs urgent help, and not stories about my misfortunes that led to the writing of this topic, I recommend scrolling to the title <a href="https://habr.com/ru/post/177223/">‚ÄúActually Subject‚Äù</a></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Somewhere about six months ago I needed to raise a server for payment terminals with connection to the payment system via IPSec.  My choice fell on Debian Squeeze and KAME ipsec-tools, in common racoon.  Oh, and I do not know why my soul became attached to this application.  At first, after superficially studying the IPSec theory, I took up the practice: <br><br><pre><code class="bash hljs">apt-get install racoon</code> </pre> <br><a name="habracut"></a>  Rakun successfully downloaded, installed, pulling along a bunch of packages and happily informed me that he was here. <br><br>  On the other side, his beloved CISCO was waiting, who, however, consistently supported a couple of dozen secure connections, but was looking forward to our hero knocking her, calling PreShared Key and embracing her in the arms of her reliable IPSec channel. <br><br>  But before that, it was necessary to go through a difficult test, because the strict but fair father of the CISCO, a sysadmin on the other side, did not give access to his ward without successfully passing the test.  The conditions of passage were as follows: <br><br><pre> <code class="bash hljs">IKE 3DES HASH SHA-1 Diffie Hellman Grupo 2 Life Time 86400 seconds Authentication by Preshared Key IPSec 3DES Integrity : ESP/SHA1 Mode: Tunel Perfect Forward Secrecy (Active) Lifetime 3600 seconds xxxx - IP   ,     yyyy - IP Cisco zzzz - IP    Cisco</code> </pre><br><br>  To help lovers, it took about a couple of days to create a more or less working config.  Finally, love prevailed.  One of the problems was reworking configs from the existing site-to-site, I had to strain my brain a little and remember that one host is the same network, only with a subnet mask of 255.255.255.255, that is, / 32. <br><br>  But the happiness was not long.  There was a task to connect client hosts via L2TP over IPSec, and here Rakun could not cope.  First, it took an ipsec-tools reassembly operation so that it could support the wildcard (*) for the preshared key, since the IP addresses of the client machines are unknown.  This disgrace looked like this: <br><br><pre> <code class="cpp hljs">diff -ur a/ipsec-tools<span class="hljs-number"><span class="hljs-number">-0.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/src/racoon/localconf.cb/ipsec-tools<span class="hljs-number"><span class="hljs-number">-0.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/src/racoon/localconf.c --- a/ipsec-tools<span class="hljs-number"><span class="hljs-number">-0.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/src/racoon/localconf.c <span class="hljs-number"><span class="hljs-number">2006</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">09.000000000</span></span> <span class="hljs-number"><span class="hljs-number">-0500</span></span> +++ b/ipsec-tools<span class="hljs-number"><span class="hljs-number">-0.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/src/racoon/localconf.c <span class="hljs-number"><span class="hljs-number">2010</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">18.000000000</span></span> <span class="hljs-number"><span class="hljs-number">-0500</span></span> &lt;at&gt; &lt;at&gt; <span class="hljs-number"><span class="hljs-number">-211</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">211</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> &lt;at&gt; &lt;at&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*p == <span class="hljs-string"><span class="hljs-string">'\0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* no 2nd parameter */</span></span> p--; - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(buf, str, len) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; buf[len] == <span class="hljs-string"><span class="hljs-string">'\0'</span></span>) { + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(buf, <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || + (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(buf, str, len) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; buf[len] == <span class="hljs-string"><span class="hljs-string">'\0'</span></span>)) { p++; keylen = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br><br>  Banal dependency resolution during assembly required another week of painstaking mana smoking, because it could not go further ./configure.  In the end, I came across an article by BenV, which meaningfully said: <a href="http://notes.benv.junerules.com/ipsec-tools-and-slackware64/">And you trust your security to these clowns</a> .  Without attaching great importance to these words, because the article decided my problem, I successfully assembled, connected and made Raccoon work now in the Road Warrior configuration. <br><br><a name="l2tp"></a><br><h4>  L2TP settings </h4><br>  There were no problems with L2TP: <br><br>  Installed xl2tp and ppp <br><pre> <code class="bash hljs">apt-get install xl2tp ppp</code> </pre><br><br>  Configured according to a variety of how-to: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/xl2tpd/xl2tpd.conf [global] ipsec saref = yes force userspace = yes [lns default] local ip = 10.1.2.1 ip range = 10.1.2.10-10.1.2.254 #     refuse pap = yes require authentication = yes ppp debug = yes length bit = yes pppoptfile = /etc/ppp/options # /etc/ppp/options: ms-dns 10.1.2.1 ms-dns 8.8.8.8 require-mschap-v2 asyncmap 0 auth crtscts lock hide-password modem debug name l2tpd defaultroute proxyarp lcp-echo-interval 10 lcp-echo-failure 100 #/etc/ppp/chap-secrets: # Secrets for authentication using CHAP # client server secret IP addresses username * userpass * #      .     IP addresses   ,      .      alvelig   10.1.2.7 alvelig * alvelig 10.1.2.7</span></span></code> </pre><br><br>  But with ipsec-tools I had to tinker.  I will give the working config of the rakun: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/racoon/racoon.conf: path include "/etc/racoon"; path pre_shared_key "/etc/racoon/psk.txt"; #   PreShared Keys  (.  ) path certificate "/etc/racoon/certs"; #  IKE  Road Warrior remote anonymous { exchange_mode aggressive,main; passive on; proposal_check obey; support_proxy on; nat_traversal on; ike_frag on; dpd_delay 20; proposal { encryption_algorithm aes; hash_algorithm sha1; authentication_method pre_shared_key; dh_group modp1024; } proposal { encryption_algorithm 3des; hash_algorithm sha1; authentication_method pre_shared_key; dh_group modp1024; } } # IPSEC  Road Warrior  CISCO sainfo anonymous { pfs_group 2; lifetime time 3600 sec; encryption_algorithm 3des; authentication_algorithm hmac_sha1; compression_algorithm deflate ; } # IKE  CISCO remote yyyy { exchange_mode main, aggressive; my_identifier address; lifetime time 86400 sec; nat_traversal on; dpd_delay 20; proposal { encryption_algorithm 3des; hash_algorithm sha1; authentication_method pre_shared_key; dh_group 2; } }</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/racoon/psk.txt: # PSK  Cisco 200.68.5.131 CiscoPSK # PSK    NAT * RoadWarrior</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/ipsec-tools.conf #!/usr/sbin/setkey -f # # Flush SAD and SPD flush; spdflush; # Create policies for racoon spdadd xxxx/32 zzzz/32 any -P out ipsec esp/tunnel/xxxx-yyyy/require; spdadd zzzz/32 xxxx/32 any -P in ipsec esp/tunnel/yyyy-xxxx/require; ########################## ## XL2TP ## ########################## spdadd 0.0.0.0/0[0] 0.0.0.0/0[1701] udp -P in ipsec esp/transport//require; spdadd 0.0.0.0/0[1701] 0.0.0.0/0[0] udp -P out ipsec esp/transport//require;</span></span></code> </pre><br><br>  But after a week of successful work, the tunnel was suddenly inactive, and the only tool that helped was restart racoon or reboot. <br><br>  The project was a pilot, a cloud of other things, and, in general, on crutches and patches stretched a couple of months. <br><br>  Finally, I got around to sorting out the issue thoroughly, and in the hope of bug-fixes and other elusive things, I collected a fresh version of ipsec-tools 0.8.1.  And immediately after the start, racoon informed me about a serious illness - the segmentation fault. <br><br>  I could not bear such a blow.  The night did not sleep: I thought how could it be so ... <br><br>  Waking up in the morning, I drank tea, ate a sandwich and sat down at the computer.  Suddenly the thought flashed in my head: OpenSWAN!  Ah yes, let's try! <br><br><a name="Subj"></a><br><h4>  Actually a subject </h4><br><br><pre> <code class="bash hljs">apt-get install openswan</code> </pre><br><br>  Aptitude cursed that OpenSWAN is not friendly with racoon, and we‚Äôll have to say goodbye to our former friend.  Well, it was not, I thought, and confirmed the installation of OpenSWAN. <br><br>  After a lot of anguish, setting up racoon setting up OpenSWAN turned out to be easier (or maybe I already had some experience): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/ipsec.conf config setup #      nat_traversal=yes #    NAT conn cisco #    forceencaps=yes dpddelay=30 # Dead peer detection - 30  -   keep-alive  dpdtimeout=120 # dpd  120 ,       dpdaction=restart_by_peer #      # IKE alg 3DES - HASH sha1 - DH group 2 (1024) ike=3des-sha1-modp1024 # IKE lifetime 86400 seconds (24 hours) ikelifetime=86400s # IKE auth method Pre-Shared Key (PSK secret) authby=secret # IPSEC params #        OpenSWAN # phase2=esp # by default # phase2=3des-sha1 # by default the same as IKE # IPSec type tunnel type=tunnel #  -  # IPSEC (key) lifetime salifetime=3600s # Perfect Forward Secrecy PFS group the same as IKE (1024) pfs=yes #  Perfect Forward Secrecy #left side (myside) left=xxxx # OpenSWAN side #      ,       IPSec,  netmask xxxx/32 leftsubnet=xxxx/32 #net subnet on left side to assign to right side leftnexthop=yyyy # CISCO side #right security gateway (CISCO side) right=yyyy #CISCO side rightsubnet=zzzz/32 #net on right side rightnexthop=xxxx # OpenSWAN side auto=start # Road Warrior conn L2TP authby=secret pfs=no auto=add keyingtries=3 rekey=no ikelifetime=8h keylife=1h type=transport left=xxxx leftprotoport=17/%any #    1701,  iOS  .   %any ,  :   iPad       ! right=%any rightprotoport=17/%any compress=no dpddelay=30 dpdtimeout=120 dpdaction=clear # dpdaction=clear   , .. ipsec   #     ,  ,   " peer", #      ,     </span></span></code> </pre><br><br>  L2TP settings did not even have to change: it all worked right away.  <a href="https://habr.com/ru/post/177223/">L2TP settings</a> . <br><pre> <code class="bash hljs">ipsec setup start ping zzzz 64 bytes from zzzz: icmp_req=1 ttl=254 time=7.53 ms 64 bytes from zzzz: icmp_req=2 ttl=254 time=6.59 ms 64 bytes from zzzz: icmp_req=3 ttl=254 time=6.41 ms 64 bytes from zzzz: icmp_req=4 ttl=254 time=6.77 ms</code> </pre><br><br>  And it took me about half an hour against one and a half weeks of torment with racoon. <br><br><h4>  Conclusion </h4><br>  Unfortunately, as is often the case, capricious Tsisk often quarreled and severed relations with Rakun, but with OpenSWAN (I wonder what gender this application is? Female, then this explains a lot) for the third week steadily and without conflicts and scandals. <br><br><h4>  P.S </h4><br>  If VPN connections with clients are connected, but the hosts within the network are not accessible to each other, then you are missing: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /proc/sys/net/ipv4/ip_forward</code> </pre>  Or watch your iptables <br><br>  <a href="http://habrahabr.ru/post/155929/">Here you can get settings for iOS and Windows clients.</a> <br><br>  I would be grateful for the comments, why racoon dropped out in segfault and lost connection after a week of stable work. <br><br>  Special thanks to the UFO for the invite. <br><br>  <b>Update:</b> <br><br>  After 2 months, it still fell, the infection ... <br>  Found on the Openswan forums that dpdaction = restart_by_peer is strongly recommended.  Corrected in configs. <br><br>  <b>Update 2:</b> <br><br>  As the admin admitted to me on the side of the tsiska, the fall was caused by communication problems on their side. <br>  But this is not easier for me, because the tunnel had to go up. <br>  Found in another how-that forceencaps = yes can help in such cases.  Added to config. <br><br>  <b>Update 3:</b> <br><br>  Added by: <br>  # / etc / ppp / options: <br>  defaultroute <br><br>  see comments </div><p>Source: <a href="https://habr.com/ru/post/177223/">https://habr.com/ru/post/177223/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177209/index.html">High-capacity 3600mAh HLI-820XL Battery for Nokia Lumia 820</a></li>
<li><a href="../177215/index.html">Collecting advanced upstream statistics using nginx-sla</a></li>
<li><a href="../177217/index.html">Knowledge Base. Part 2. Freebase: making requests to the Google Knowledge Graph</a></li>
<li><a href="../177219/index.html">ASP.NET MVC and unobtrusive validation with Backbone.js</a></li>
<li><a href="../177221/index.html">MS SQL: generating pseudo-random data using newID (). Opportunities and pitfalls</a></li>
<li><a href="../177225/index.html">Time management on a personal example: 10 theses</a></li>
<li><a href="../177227/index.html">CRUD application on Ext JS and Ruby on Rails in 7 minutes</a></li>
<li><a href="../177229/index.html">An agreement on the development of the site, design, software. Version 1.1</a></li>
<li><a href="../177233/index.html">Conference ‚ÄúStrike! 2013 ". Small report</a></li>
<li><a href="../177235/index.html">Computer application development projects. Special features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>