<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to win a click into Ya. Direct and AdWords for 600 thousand rubles a month</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past six months, we have managed to win the ‚Äúclickthrough‚Äù of our contextual advertising with a budget of 1 million rubles a month. 

 The ke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to win a click into Ya. Direct and AdWords for 600 thousand rubles a month</h1><div class="post__text post__text-html js-mediator-article">  Over the past six months, we have managed to win the ‚Äúclickthrough‚Äù of our contextual advertising with a budget of 1 million rubles a month. <br><br>  The key to defeating the fraud was the per-minute monitoring of traffic with notifications of abnormal changes and disabling problematic API announcements, and a series of reports that reflect the situation in real time. <br><br><img src="https://habrastorage.org/webt/ss/cg/tk/sscgtkndx4m1wahkipwk1ozgxwk.png"><br>  <font color="#7c8792">Figure 1. Visitor number chart by keywords for</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <font color="#3e6c9a">How to find out that you are being attacked?</font> </h2><br>  <b>One of the first signs of ‚Äúskipping‚Äù advertising will be an increase in the percentage of funds returned for fraud in Direct and AdWords.</b> <br><blockquote>  ‚ÄúIn Yandex Direct, the fraud expenses are automatically returned to the balance of the advertising campaign.  The number of clicks eliminated by the fraud protection system is displayed in the ‚Äúdaily statistics‚Äù reports, ‚Äúgeneral statistics‚Äù in the ‚Äúinvalid clicks for the entire selected period.‚Äù </blockquote>  - <a href="https://yandex.ru/support/direct/technologies-and-services/antifraud.html">Help Ya. Direct "invalid clicks</a> . <a href="https://yandex.ru/support/direct/technologies-and-services/antifraud.html">"</a> <br><br>  In AdWords, you can turn on the "invalid clicks" level on the "columns" tab: <br><br><img src="https://habrastorage.org/webt/kf/0y/sp/kf0ysp3nbfkov-ypcrfcc1sbmgw.png"><br>  <font color="#7c8792">Figure 2. AdWords configured ‚Äúinvalid click‚Äù columns</font> <br><br>  In our case, with an average level of ‚Äú <a href="https://yandex.ru/support/direct/technologies-and-services/antifraud.html">invalid clicks</a> ‚Äù in Yandex.Direct ‚âà 10%, Yandex suddenly began to return 40% of the advertising budget, and after a month it altogether 54%. <br><a name="habracut"></a><br>  <b>The next sign of fraud is unreasonable growth in the number of transitions and strong changes in behavioral indicators for a number of ad groups.</b> <br><br>  We noticed that in a number of keywords for which there were never more than 200 visitors per day, suddenly there were bursts of up to 3,000 visitors.  In fact, the budget, in the days of such activities, could go on one advertising campaign, if it was not stopped in time. <br><br><img src="https://habrastorage.org/webt/dy/dj/37/dydj375imemm0ytnqa6ttkesya8.png"><br>  <font color="#7c8792">Figure 3. Unjustified traffic growth for a specific ad group in Direct</font> <br><br><h2>  <font color="#3e6c9a">Yandex and Google do not protect against fraud</font> </h2><br>  It is enough to read the <a href="https://yandex.ru/blog/direct/14427">discussion of the fraud level in contextual advertising</a> in the official Direct Club to make sure that many advertisers lose money due to fraud. <br><br>  Google officially recognizes the mistakes of its security system and provides advertisers with ‚ÄúRefund Claims‚Äù (refund of the spent budget).  According to statistics from the service ClickSease, Google Ads on average returns 12% of the advertising budget. <br><br><div class="spoiler">  <b class="spoiler_title">How to return part of the money for the "sklik" through AdWords</b> <div class="spoiler_text">  You must send a <a href="https://support.google.com/adwords/troubleshooter/2557048%3Frd%3D1">complaint to the "invalid clicks"</a> in Advords, after consideration of which you will be reimbursed ‚âà 12% of the money spent.  Also, the service ClickSease automatically sends similar requests to Google for a refund every 2 months. <br><br>  In our case, Google AdWords first recognized 18% of our traffic as ‚Äú <a href="https://support.google.com/adwords/answer/2549113%3Fctx%3Dtltp">invalid</a> ‚Äù and returned the money for them, and when we sent a refund claims complaint, Google reimbursed another 13% of the budget. <br></div></div><br>  Yandex, on the other hand, does not recognize the vulnerability of its own protection filters and complaints of obvious fraud cases. It sends a sample response that the problem lies with the advertiser and his website. <br><br>  In our case, the percentage of ‚Äúinvalid clicks‚Äù in the report by Ya. Direct has never risen above the cherished 50% in any of the advertising campaigns, even on the days of the most violent bursts, when 80% of the budget ‚Äúmerged‚Äù into the usually not very popular ad group without calls and applications. <br><br><img src="https://habrastorage.org/webt/6h/4u/ef/6h4uefov0nkyjh0n3wpuii9qb0q.png"><br>  <font color="#7c8792">Figure 4. The ‚ÄúInvalid Clicks‚Äù Level in One of the Campaigns in Direct</font> <br><br><h2>  <font color="#3e6c9a">What level of attack are we facing</font> </h2><br>  Fraudulent traffic went to four business lines in two cities.  When new advertising campaigns were launched or when they were launched for a long time, they were redistributed to them within a few hours. <br><br>  Click Fraud was not time bound, and the redistribution of the budget, for example, for the night, did not give any effect: we still received our own volume of traffic.  "Clicking" occurred equally actively both in YAN, and on Yandex search, and on Google‚Äôs GMS. <br><br>  On the site, bots simulated user behavior, navigated through sections of the site, selected text, naturally scrolled, and moved the cursor. <br><br><h2>  <font color="#3e6c9a">Are there any ready-made remedies?</font> </h2><br>  All click-protection services have only one direct fight tool - blocking suspicious IP addresses or placement sites in Ya.Direct and AdWords campaigns. <br><br>  If dynamic IPs are used against you, any anti-click fraud service will always be one step behind the fraudsters in blocking them by IP: the bot has already made a few clicks on your ad by the time the service blacklists the IP and stop advertising on it.  In addition, after the fraudulent software will not be able to see your advertisement, it will simply change the IP address, Hardware-ID and continue its actions. <br><br>  When attacking advertising in the CCM or YAN, various placements are usually used, and automatic protection systems cannot detect suspicious sites for blocking. <br><br>  Let's go back to blocking by IP - here we come to the most interesting part - if AdWords allows blocking up to 500 IP addresses, then <u>Yandex Direct can block only 25 unique IP addresses</u> for one advertising campaign!  Such a small black list of IP addresses is no longer relevant, since now you can safely purchase 500 IPv4 addresses for 10 thousand rubles and bypass this restriction. <br><br>  You can protect yourself from ‚Äúclipping‚Äù performed at a high level in just two ways: <br><br><ol><li>  learn not to show advertisements to fraudulent users or bots, for which you need to find certain "patterns" in their behavior and characteristics; <br></li><li>  temporarily stop specific ad groups and keywords that are being attacked. <br></li></ol><br><h2>  <font color="#3e6c9a">Cut off part of the audience to keep most of it.</font> </h2><br>  If you learn not to show ads click on bots or fraudulent users, then they will not be able to harm. <br><br>  You can always track similar behaviors and patterns, for example, that fraud usually runs on Windows 7 from 5:00 to 9:00 in Moscow, and set a rate adjustment of -100% for a similar audience in all advertising campaigns attacked.  The functionality of <a href="https://support.google.com/google-ads/answer/2732132%3Fhl%3Dru">bid adjustments in AdWords is</a> quite extensive, which cannot be said about <a href="https://yandex.ru/support/direct/impressions/bids-adjustment.html">Yandex Direct adjustments</a> . <br><br><h3>  We are looking for patterns in frode through protection services </h3><br>  In order to have an idea of ‚Äã‚Äãhow exactly we are attacked, and to manually trace patterns in the fraudulent traffic, we have connected the Russian service from fraud <a href="https://clickfrog.ru/">ClickFrog</a> .  The product is a well-known, popular among CPA and so on. <br><br>  ClickFrog quickly proved complete incapacity: <br><br><ol><li>  allocated no more than 40 suspicious IP addresses per day, with traffic from Yandex.Direct of 3,000 thousand hops per day, and, even recognized by Yandex, 1,300 left-click clicks per day; <br></li><li>  The main tool for protecting the service is blocking by IP address, the command about which is sent to Ya.Direct by API. However, as soon as the black list of 25 IP addresses is filled, you must manually delete the last few IP addresses in each advertising campaign and wait for the next list to be filled, and so in a circle. <br></li></ol><br>  Then we installed the code of the American service <a href="https://www.clickcease.com/">ClickSease</a> , aimed at AdWords, and not yet working with Direct.  The service, by the way, has, in contrast to ClickFrog, a free test period of 2 weeks. <br><br>  ClickSease was more useful: he began to catch 300-400 unique fraudulent IP per day.  For each blocked IP service gives statistics: <br><br><ul><li>  internet provider; </li><li>  platform from which the transition was made; </li><li>  operating system; </li><li> unique device ID; </li><li>  the time of the first and last transition; </li><li>  region. </li></ul><br>  From the ClickSease report, we were able to identify patterns in frade: <br><ul><li>  in 81% of cases, the device simulates a mobile OS: Android or iOS; </li><li>  in 59% of cases, geolocation of an IP address does not apply to Moscow, with a ford aimed at Moscow. </li></ul><br><h3>  We are looking for patterns in Frode manually </h3><br>  However, even such obvious patterns were not enough to reduce the harm from fraud, and I didn‚Äôt want to disable advertising on mobile.  Services are usually able to only give ideas on identifying similar patterns in the frode, and then it is necessary to detect fraud in the Metric (in the case of an attack on Direct) and select it in separate Yandex Audience segment for subsequent analysis and blocking. <br><br><img src="https://habrastorage.org/webt/p3/op/ya/p3opya9dpzuhirhhz0_wfdeywf8.png"><br>  <font color="#7c8792">Figure 5. An example of analyzing traffic by age group in the Metric to find fraud patterns</font> <br><br>  Traffic slices to help fraud patterns: <br><ul><li>  audience dynamics by age groups; </li><li>  the dynamics of the long-term interests of users; </li><li>  device dynamics and OS. </li></ul><br>  <b>In the case of AdWords, the countermeasure is clear:</b> <br><br><ol><li>  determine the audience segment "infected" fraud; </li><li>  set rate adjustment -100% for the selected segment; </li><li>  we track changes in indicators: conversion, time on the site, depth of viewing, bounce rate. </li></ol><br>  <b>In Yandex Direct, combat mechanics are more complex and are divided into two options:</b> <br><br>  a) you managed to find an obvious fraud pattern related to gender, age or mobility: <br><br><ol><li>  set the rate adjustment -50% or -100% for the selected segment; </li><li>  we trace change of key indicators. </li></ol><br>  b) no obvious patterns were found: <br><br><ol><li>  We allocate frod traffic to a separate segment of <a href="https://audience.yandex.ru/">Yandex.</a> Audience (for example, you knew for sure that from October 1 to October 20 there could not be 5,000 clicks on an ad group, which always had no more than 30 visits per day) </li><li>  we create a segment of users similar to our fraud through the <a href="https://yandex.ru/support/audience/segments/look-alike.html">Yandex look-alike</a> ; </li><li>  set up a rate adjustment of -100% for a manually created audience segment; </li><li>  We carefully test the reduction in advertising rates for the segments created by Yandex. </li></ol><br><h2>  <font color="#3e6c9a">Build charts that show fraud</font> </h2><br>  <b>Frode always gives rise to obvious pockets and spikes</b> , whether it is abstruse software with imitation of the behavior of a real user or a group of freelancers performing a technical task. <br><br><img src="https://habrastorage.org/webt/go/o2/al/goo2alj10gtzlycltq5rje0hoji.png"><br>  <font color="#7c8792">Figure 6. Visitor Number Chart by Decker Order</font> <br><br>  Frode occurs unevenly for several reasons: <br><ul><li>  in order to make the attack ‚Äúsmoothed out‚Äù you need to possess confidential information and know who, when and how many transitions you make in your advertisement; </li><li>  the software acts in spurts, and on the minute, 10 minute, and sometimes on the hourly chart, its actions will be evident; </li><li>  even if ‚Äúschoolchildren‚Äù are working against you from the bulletin boards, then they also act on a specific task with an algorithm, and the anomalies generated by them will be easily traced. </li></ul><br>  If you learn to quickly find and eliminate foci, you can significantly reduce the harm from fraud.  In our case, the obvious sign was the anomalous increase in the number of clicks on contextual advertising in specific 10 minutes or one minute for some keywords. <br><br>  <a href="https://datastudio.google.com/">Google Data Studio is</a> best suited for visualization, as it is only Analytics that is able to correctly collect data divided into 1 and 10 minutes, and Metric gives incorrect results when building reports on the panels. <br><br><div class="spoiler">  <b class="spoiler_title">How to build charts in 10 minutes, not in an hour, in Google Data Studio</b> <div class="spoiler_text">  By default, in Analytics or Data Studio it is impossible to build graphs by the minute or 10 minutes, but this can be done as follows in the Date Studio: <br><br>  Step 1. Open the edit fields <br><br><img src="https://habrastorage.org/webt/sy/y2/1v/syy21vr-evstitegmwu-ivqreh8.png"><br><br>  Step 2. Create copies of the following fields: Year, Month of the year, Day of the month, Hour, Minute, and call them, for example, Year (day), Month of the year (day) and so on.  Also in the copied fields it is necessary to change the Type from the time and date format to ‚Äúnumber‚Äù as shown in the figure. <br><br><img src="https://habrastorage.org/webt/zj/3a/a6/zj3aa66qqh0eq42cyc-ajbujxzm.png"><br>  <font color="#7c8792">Step 2. Change the type of the copied field from ‚Äúdate‚Äù to ‚Äúnumber‚Äù</font> <br><br>  Step 3. Create a new field in which we write the following formula: Year (number) * 10,000,000 + Month of the year (number) * 100,000 + Day of the month (date) * 1000 + Hour (number) * 10 + FLOOR (Minute (date) / ten) <br><br><img src="https://habrastorage.org/webt/ud/mm/8o/udmm8oej5cb9ysefk3zpmka2rvs.png"><br>  <font color="#7c8792">Step 3. Create a calculated field "Time for 10 minutes"</font> <br><br>  Step 4. Save the created field, then go back to the list of all the fields and find our new field ‚ÄúTime for 10 minutes (window)‚Äù.  You need to change its type from ‚ÄúNumber‚Äù to ‚ÄúDate and time‚Äù as shown in the figure, and then assign the type ‚ÄúNumber‚Äù back to this field. <br><br><img src="https://habrastorage.org/webt/7f/bi/hh/7fbihh4hc4yss02cqsfra1ljfta.png"><br>  <font color="#7c8792">Step 4. Create a calculated field "Time for 10 minutes"</font> <br><br>  Step 5. Create a ‚ÄúCombined Chart‚Äù and set our new field ‚ÄúTime to 10 minutes‚Äù as a parameter, as shown in the figure.  Is done. <br><br><img src="https://habrastorage.org/webt/rq/o5/hy/rqo5hybxbnptkakzlyrs4rclzqu.png"><br>  <font color="#7c8792">Step 5. Create a ‚Äúcombined chart‚Äù</font> <br></div></div><br><br><h2>  <font color="#3e6c9a">Set up notifications for fraud sites</font> </h2><br>  In order not to keep track of all fraud cases manually, I made a report in Google Spreadsheets, which updates the data every minute and notifies you that fraud starts. <br><br>  Google Spreadsheets support the <a href="https://developers.google.com/analytics/devguides/reporting/core/v3/">Core Reporting API</a> , which can be accessed through the Script Editor in Spreadsheets. <br><br>  Step 1. Go to the script editor to access Analytics <br><br><img src="https://habrastorage.org/webt/fe/6t/r-/fe6tr-kjvklwxovqwutpmuvbvcc.png"><br>  <font color="#7c8792">Figure 7. Script editor for accessing the Analytics Core Reporting API via Google Tables</font> <br><br>  Step 2. We register the API request to Analytics in order to obtain data on the necessary indicators (for example, the number of users who have switched on paid advertising in each minute of the day, as in our case). <br><br><div class="spoiler">  <b class="spoiler_title">Google Script code to request any data from Analytics to Google Spreadsheets</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runDemo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstProfile = getFirstProfile(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = getReportDataForProfile(firstProfile); outputToSpreadsheet(results); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(error) { Browser.msgBox(error.message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFirstProfile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> accounts = Analytics.Management.Accounts.list(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (accounts.getItems()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstAccountId = accounts.getItems()[<span class="hljs-number"><span class="hljs-number">0</span></span>].getId(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> webProperties = Analytics.Management.Webproperties.list(firstAccountId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webProperties.getItems()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstWebPropertyId = webProperties.getItems()[<span class="hljs-number"><span class="hljs-number">0</span></span>].getId(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profiles = Analytics.Management.Profiles.list(firstAccountId, firstWebPropertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (profiles.getItems()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstProfile = profiles.getItems()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstProfile; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'No views (profiles) found.'</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'No webproperties found.'</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'No accounts found.'</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReportDataForProfile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">firstProfile</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profileId = firstProfile.getId(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableId = <span class="hljs-string"><span class="hljs-string">'ga:'</span></span> + profileId; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startDate = <span class="hljs-string"><span class="hljs-string">"today"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// getLastNdays(14)  2 weeks (a fortnight) ago. var endDate = "today"; //getLastNdays(0)  Today. var optArgs = { 'dimensions': 'ga:date,ga:hour,ga:minute,ga:sourceMedium', // Comma separated list of dimensions. 'sort': 'ga:date,ga:hour,ga:minute', // Sort by sessions descending, then keyword. //'segment': 'dynamic::ga:isMobile==Yes', // Process only mobile traffic. 'filters': 'ga:sourceMedium==yandex / cpc', 'start-index': '1', 'max-results': '10000' // Display the first 250 results. }; // Make a request to the API. var results = Analytics.Data.Ga.get( tableId, // Table id (format ga:xxxxxx). startDate, // Start-date (format yyyy-MM-dd). endDate, // End-date (format yyyy-MM-dd). 'ga:users', // Comma seperated list of metrics. optArgs); if (results.getRows()) { return results; } else { throw new Error('No views (profiles) found'); } } function getLastNdays(nDaysAgo) { var today = new Date(); var before = new Date(); before.setDate(today.getDate() - nDaysAgo); return Utilities.formatDate(before, 'GMT', 'yyyy-MM-dd'); } function outputToSpreadsheet(results) { var sheets = SpreadsheetApp.getActiveSpreadsheet(); var sheet = sheets.getSheetByName("coeff1"); var range = sheet.getRange('A:E'); range.clear(); // Print the headers. var headerNames = []; for (var i = 0, header; header = results.getColumnHeaders()[i]; ++i) { headerNames.push(header.getName()); } sheet.getRange(1, 1, 1, headerNames.length) .setValues([headerNames]); // Print the rows of data. sheet.getRange(2, 1, results.getRows().length, headerNames.length) .setValues(results.getRows()); }</span></span></code> </pre> <br></div></div><br><br>  Step 3. Set the trigger to update the data every minute: <br><br><img src="https://habrastorage.org/webt/bu/-f/lq/bu-flq0ftubu0wa1lcqxw1uilz0.png"><br>  <font color="#7c8792">Figure 8. We request fresh data every minute to respond quickly to fraud.</font> <br><br>  Step 4. We create a pivot table from a sheet that is updated with the necessary data once a minute, and we analyze these indicators to set up triggers for email notifications or to disable ad groups using the Ya.Direct or AdWords API. <br><br><img src="https://habrastorage.org/webt/ha/ba/-g/haba-goptrqk9xjgxrge_wjqqjs.png" alt="image">  <font color="#7c8792">Figure 9. An example of setting up formulas for anomaly notifications</font> <br><br><div class="spoiler">  <b class="spoiler_title">Sample my Google Script code for email notifications</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myFunction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = SpreadsheetApp.getActiveSpreadsheet(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sheet = ss.getSheetByName(<span class="hljs-string"><span class="hljs-string">"notification"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = sheet.getRange(<span class="hljs-string"><span class="hljs-string">"D2:E4"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// The row and column here are relative to the range // getCell(1,1) in this code returns the cell at B2, B2 var cell = range.getCell(1, 2); Logger.log(cell.getValue()); if (cell.getValue() !== "no") { MailApp.sendEmail("your_email@yandex.ru", "Fraud notification "+cell.getValue(), "Check me "+range.getCell(1, 1).getValue()); } else { } var cell2 = range.getCell(2, 2); Logger.log(cell2.getValue()); if (cell2.getValue() !== "no") { MailApp.sendEmail("your_email@yandex.ru", "Fraud notification "+cell2.getValue(), "Check me "+range.getCell(2, 1).getValue()); } else { } var cell3 = range.getCell(3, 2); Logger.log(cell3.getValue()); if (cell3.getValue() !== "no") { MailApp.sendEmail("your_email@yandex.ru", "Fraud notification "+cell3.getValue(), "Check me "+range.getCell(3, 1).getValue()); } else { } }</span></span></code> </pre> <br></div></div><br><h2>  <font color="#3e6c9a">Results: how to win the click</font> </h2><br>  Counter-click fraud can be divided into three groups: <br><br>  a) Proactive action: <br><ul><li>  shutdown of "polluted sites"; </li><li>  Disabling ad serving for an audience with signs that are fraudy for you, for example, for people on tablets from St. Petersburg (more advanced parameters for blocking can be used through AdWords lists and Metrics segments); </li><li>  adjusting bids for audience segments that are similar to fraud segments (‚Äúlook-alike‚Äù segments are created in I. Audiences and Google Lists); </li><li>  fraud blocking by IP network masks (available only in AdWords). </li></ul><br>  b) Preventive actions: <br><ul><li>  Send complaints about the return of the budget in AdWords and Direct; </li><li>  an investigation of "who ordered the attack on you"; </li><li>  grouping suspicious and frequently attacked ad groups into a single advertising campaign; </li><li>  "Traps" for the simplest bots, namely the hidden buttons on the site, which are visible only to the bot and when clicked, it falls into the list. </li></ul><br>  c) Post factum actions: <br><ul><li>  blocking by IP addresses; </li><li>  quick disconnection of click points: keywords, ad groups, advertising campaigns, audience segments. </li></ul><br><img src="https://habrastorage.org/webt/lh/kt/qu/lhktquoljkgpshxr78ig6mspa4q.png" alt="image"><br>  <font color="#7c8792">Figure 10. Protection against click fraud</font> <br><br>  <b>Useful links:</b> <b><br></b> <br><ul><li>  Core Reporting API <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/">library</a> ; </li><li>  <a href="https://ga-dev-tools.appspot.com/query-explorer/">Query Explorer</a> for easy testing API commands; </li><li>  <a href="https://xakep.ru/2015/01/08/google-apps-script/">We write scripts to automate the work with Google applications</a> ; </li><li>  <a href="https://zapier.com/learn/google-sheets/google-apps-script-tutorial/">Automate Google Sheets</a> ; </li><li>  <a href="https://support.google.com/analytics/answer/7347597%3Fhl%3Den">Analytics Intelligence</a> , to ask the Analytics bot: - ‚ÄúBut have there been any anomalies in the paid traffic over the last year?‚Äù And get a clear answer. </li></ul><br><div class="spoiler">  <b class="spoiler_title">How to find out who ordered the attack on your ad</b> <div class="spoiler_text">  Any adequate competitor will minimize their damage when attacking others: <br><br><ol><li>  firstly, the attacker will try not to show his ad in the directions in which the attack is taking place at the moment, so as not to merge his CTR and increase his cost per click; <br></li><li>  secondly, an unscrupulous competitor will select such keywords for an attack, on which he can stop displaying his ads without much harm to himself. <br></li></ol><br>  In our case, the competitor also began to click fraud in 4 directions in two cities, so it was not difficult to calculate it. <br><br>  To make it easier to analyze competitors with whom you intersect, you can watch all the included ads of competitors for each keyword in the Yandex.Direct area: <br><br><img src="https://habrastorage.org/webt/w2/_t/4p/w2_t4p4zpj0imyxdogo7saha0sg.png"><br>  <font color="#7c8792">Figure 9. All competitor ads by keyword</font> <br></div></div><br><br>  <b>Those who are also faced with the click-through of contextual advertising - write in the comments, we will try to help each other!</b> </div><p>Source: <a href="https://habr.com/ru/post/423335/">https://habr.com/ru/post/423335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423317/index.html">Why a Scala man?</a></li>
<li><a href="../423319/index.html">Integration code Vivaldi. Tell our developers</a></li>
<li><a href="../423321/index.html">Protect repositories on github against malicious commits</a></li>
<li><a href="../423323/index.html">‚ÄúYou have to be lazy to become a good tester‚Äù</a></li>
<li><a href="../423329/index.html">Preparing for a big five company interview</a></li>
<li><a href="../423337/index.html">How to make friends with PHPstorm, xDebug and remote branches collected through Docker? Too easy‚Ä¶</a></li>
<li><a href="../423339/index.html">Is there life under Windows 98, part one - about iron</a></li>
<li><a href="../423341/index.html">Under public pressure, Sony acknowledged that she did not own the works of Bach</a></li>
<li><a href="../423343/index.html">Cultural values ‚Äã‚Äãmade of plastic begin to fall apart</a></li>
<li><a href="../423345/index.html">Noose of fear</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>