<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>InterSystems Database Mirroring. Creating and testing mirrors. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, the configuration of the mirror was considered - the high availability technology of the InterSystems Database Mirroring DBMS Ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>InterSystems Database Mirroring. Creating and testing mirrors. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the previous part, the <a href="http://habrahabr.ru/company/intersystems/blog/147932/">configuration of the</a> mirror was considered - the high availability technology of the InterSystems Database Mirroring DBMS Cach√©. <br>  In this article scenarios of breaks (refusals) and the reaction of the mirror to them will be considered. <br><br>  Breaks can be both planned and unplanned. <br>  Scheduled - this is when we need to stop the server to update the operating system, database version, version of the application system and we control the process. <br><br>  Examples of scheduled breaks: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  reboot the OS, for example, to install updates; </li><li>  reboot the DBMS; </li><li>  hardware update server. </li></ul><br>  Unscheduled - when something happens that makes it impossible for the server to work with the clients of the information system, and without our knowledge.  The reason for this may be: <br><br><ul><li>  DBMS hang; </li><li>  operating system crash; </li><li>  emergency (Reset, Power Off); </li><li>  failure of server hardware; </li><li>  failure of network equipment; </li><li>  <s>war, epidemic, blizzard, space black holes.</s> </li></ul><br><a name="habracut"></a><br><h5>  Failover </h5><br>  Automatic overcoming of a failure for a Cach√© mirror occurs only in case of a failure / interruption on the Primary-server, and in such article such cases will be considered.  Of course, there may be scenarios when a problem occurs on the Backup server, but in this case the IP continues to work, and there is no physical mirroring until the administrator manually restores the Backup server.  Another scenario is possible when both servers failed at once - but in this case, a break in the IS is inevitable, and its settlement is performed ‚Äúmanually‚Äù. <br><br>  Basic scenario for automatic failover: <br><br><ol><li>  The Primary-server serves the clients of the IC that work with one of the mirrored databases, and the Backup-server is ‚Äúready‚Äù (stand by); </li><li>  A failure occurs on the Primary server; </li><li>  The backup server makes sure that the Primary server is down, automatically becomes the Primary server and continues to serve the clients of the information system; </li><li>  The former Primary-server is restored (for example, by the administrator), becomes a new Backup-server and enters the ‚Äústand by‚Äù mode for the new Primary-server. </li></ol><br>  What can go wrong? <br>  Let us imagine a situation when the network interface on the Primary-server fails, but not for long, but it is enough that the Backup-server has already managed to ‚Äúdecide‚Äù to become the Primary-server.  The result is a split brain situation. <br><br><h5>  Split brain </h5><br>  <a href="http://en.wikipedia.org/wiki/Split-brain_(computing)">Split brain</a> - <a href="http://en.wikipedia.org/wiki/Split-brain_(computing)">brain</a> <s>cancer is a</s> state of complete desynchronization of cluster servers, when both servers are working and each of them considers that it is Primary at the moment. <br>  Such a situation may arise, for example, if the Backup-server ‚Äúmistakenly‚Äù decided that the Primary-server is in ‚ÄúDown‚Äù, as a result, two Primary-servers appear at once in the cluster, which try to simultaneously serve the users' requests - a cluster collapse. <br>  For users of IP, this situation is expressed in an indefinite interruption of work, which is restored by the administrator ‚Äúmanually‚Äù. <br>  The fastest way to restore such a situation is to re-create the cluster by restoring data from a backup or from <a href="">an asynchronous ‚Äúmirror‚Äù</a> . <br><br><h5>  AgentContactRequiredForFailover </h5><br>  The decisive factor for the behavior of a Cach√© mirror during a failure / interruption is the value of the AgentContactRequiredForFailover = yes / no parameter. <br><br><h6>  AgentContactRequiredForFailover = yes </h6><br>  In the case of AgentContactRequiredForFailover (ACRF) = yes (by default), with failover, the ISC Agent on both servers must be in contact at the time of the interruption.  Such a situation is possible for cases of unscheduled Cache failure, planned Cache reload, planned OS reboot.  Therefore, in this mode, for all other cases, automatic failover will not occur! <br><br><h6>  AgentContactRequiredForFailover = no </h6><br>  This mode of mirroring allows for failover even without online contact between server agents.  This mode may be needed to cover situations like Power Off primary server, network adapter failure, or the network itself between servers, etc., when there is no connection with the Primary server.  In this mode, the decision to automatically switch the Backup-server to the Primary-server state is determined by the user function in the ZMIRROR program located in the area (% SYS). <br><br><h5>  Test results </h5><br>  Of course, when building a failover solution, we expect automatic overcoming of failure for most situations, otherwise why all this.  Currently, the Cach√© mirror is able to automatically process almost all possible scenarios. <br>  We tested how the mirror behaves for several typical scenarios at different ACRF values. <br>  The latest version of Cach√© 2012.2 RC has been tested.  Yes - means automatic failure override for this scenario. <br><table><tbody><tr><th>  <b>N</b> </th><th>  <b>Scenarios</b> </th><th>  <b>ACRF = Yes</b> </th><th>  <b>ACRF = No</b> </th></tr><tr><td>  one </td><td>  Planned or emergency reboot, stop Cach√© DBMS on Primary </td><td>  <font color="green">Yes</font> </td><td>  <font color="green">Yes</font> </td></tr><tr><td>  2 </td><td>  OS scheduled reboot </td><td>  <font color="green">Yes</font> </td><td>  <font color="green">Yes</font> </td></tr><tr><td>  3 </td><td>  Emergency stop OS, Reset, Power Off </td><td>  <font color="red">Not</font> </td><td>  <font color="green">Yes</font> </td></tr><tr><td>  four </td><td>  Disable network interface on Primary </td><td>  <font color="red">Not</font> </td><td>  <font color="green">Yes</font> </td></tr><tr><td>  five </td><td>  Power Off at the same time Primary and Backup, and then download first Primary </td><td>  <font color="green">Yes</font> </td><td>  <font color="green">Yes</font> </td></tr><tr><td>  6 </td><td>  Power Off at the same time Primary and Backup, and then downloading first Backup </td><td>  <font color="red">Not</font> </td><td>  <font color="red">Not</font> </td></tr></tbody></table><br>  As a result of testing, it turned out that an unpleasant scenario is the disconnection of the network interface (No. 4).  Therefore, it is recommended to install a backup network channel between the mirror servers <br>  Server configuration example: <br><img src="https://habrastorage.org/getpro/habr/post_images/82a/eb5/ece/82aeb5ece4238c242d5e63ae79f3ccd8.png" alt="image"><br>  In case of simultaneous failure of both servers - scenarios 5-6 (long interruption in power supply, for example), it is important to observe the commissioning sequence - the Primary-server should be activated first.  Otherwise, the Backup-server becomes Primary, and after the start of the former Primary-server there are two of them - as a result of the split brain. <br><br>  As can be seen from the table, the Cach√© synchronous mirror with ACRF = yes (the default value) provides only those abnormal situations when the network between the cluster servers is ‚Äúalive‚Äù. <br>  For other situations, there is the ACRF = no mode, where the administrator, at his own risk and risk, writes the ZMIRROR user program for determining the failure of the Primary-server. <br><br><h5>  ZMIRROR </h5><br>  It is theoretically possible to build such a hardware and software system for the final installation of the mirror, when for any scenario it is possible to unambiguously and programmatically determine the state of the Primary server. <br>  If this situation occurs on your server, it is advisable to set the mode to ACRF = no.  Then in the case of a break, and when there is no connection with the Primary-server ISC Agent, the system calls the $$ IsOtherNodeDown ^ ZMIRROR () function.  The function returns 1 or 0. In the event that there is no function or the function returns 0, the automatic failover process is terminated. <br>  The task of the programmer when writing a custom implementation of the $$ IsOtherNodeDown ^ ZMIRROR () function is to reliably verify that the Primary server is really out of order and return 1 in this case. <br><br><div class="spoiler">  <b class="spoiler_title">Sample ZMIRROR custom function</b> <div class="spoiler_text">  <font color="#ff0000">ZMIRROR</font> <font color="#ff0000"><br></font>  <font color="#008000">;</font>  <font color="#008000">USE AT YOUR OWN RISK.</font> <font color="#008000"><br></font>  <font color="#0000ff">q</font> <font color="#0000ff"><br><br></font>  <font color="#ff0000">IsOtherNodeDown</font> <font color="#000000">()</font> <font color="#0000ff">public</font> <font color="#0000ff"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"------------&gt; IsOtherNodeDown ()"</font> <font color="#000000">)</font> <font color="#000000"><br><br></font>  <font color="#0000ff">try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">s</font> <font color="#000000">ip =</font> <font color="#008000">"192.168.169.186";</font>  <font color="#008000">address of another node failover</font> <font color="#008000"><br><br></font>  <font color="#0000ff">s</font> <font color="#000000">PingSuccessful =</font> <font color="#0000ff">$ system</font> <font color="#008080">.INetInfo</font> <font color="#000000">.</font>  <font color="#0000ff">CheckAddressExist</font> <font color="#000000">(ip)</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"IP adress"</font> <font color="#000000">_ip_</font> <font color="#008000">"is"</font> <font color="#000000">_</font> <font color="#000000"><br></font>  <font color="#0000ff">$ s</font> <font color="#000000">(PingSuccessful:</font> <font color="#008000">"available"</font> <font color="#000000">, 1:</font> <font color="#008000">"unavailable"</font> <font color="#000000">) _</font> <font color="#008000">"."</font>  <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'PingSuccessful</font> <font color="#0000ff">s</font> <font color="#000000">returnValue = 1</font> <font color="#0000ff">q</font> <font color="#008000">;</font>  <font color="#008000">no ping</font> <font color="#008000"><br><br></font>  <font color="#0000ff">s</font> <font color="#000000">url =</font> <font color="#008000">" <a href="">"</a></font> <font color="#000000">_ip_</font> <font color="#008000">": 57772 / csp / sys / UtilHome.csp"</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">stat =</font> <font color="#0000ff">$$</font> <font color="#ff0000">GetStatus</font> <font color="#000000">(url)</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">, url_</font> <font color="#008000">"is"</font> <font color="#000000">_stat_</font> <font color="#008000">"."</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">stat [</font> <font color="#008000">"Error"</font> <font color="#0000ff">s</font> <font color="#000000">returnValue = 1</font> <font color="#0000ff">q</font> <font color="#008000">;</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">returnValue = 0</font> <font color="#000000"><br><br></font>  <font color="#800080">}</font> <font color="#0000ff">catch</font> <font color="#000000">(e)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Library.Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">, e.</font> <font color="#0000ff">DisplayString</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">returnValue = 0</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"Returning"</font> <font color="#000000">_returnValue_</font> <font color="#008000">"..."</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"&lt;------------ IsOtherNodeDown ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">returnValue</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#ff0000">CheckBecomePrimaryOK</font> <font color="#000000">()</font> <font color="#0000ff">public</font> <font color="#0000ff"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"------------&gt; CheckBecomePrimaryOK ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">s</font> <font color="#000000">stat =</font> <font color="#0000ff">$$</font> <font color="#ff0000">MemberDescription</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">returnValue = 1</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"This instance is"</font> <font color="#000000">_stat)</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"Returning"</font> <font color="#000000">_returnValue_</font> <font color="#008000">"..."</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">catch</font> <font color="#000000">(e)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Library.Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">, e.</font> <font color="#0000ff">DisplayString</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">returnValue = 0</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"&lt;------------ CheckBecomePrimaryOK ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">returnValue</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#ff0000">NotifyBecomePrimary</font> <font color="#000000">()</font> <font color="#0000ff">public</font> <font color="#0000ff"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"------------&gt; NotifyBecomePrimary ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"This instance is"</font> <font color="#000000">_</font> <font color="#0000ff">$$</font> <font color="#ff0000">MemberDescription</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">catch</font> <font color="#000000">(e)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Library.Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">, e.</font> <font color="#0000ff">DisplayString</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"&lt;------------ NotifyBecomePrimary ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#ff0000">NotifyBecomePrimaryFailed</font> <font color="#000000">()</font> <font color="#0000ff">public</font> <font color="#0000ff"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"------------&gt; NotifyBecomePrimaryFailed ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"This instance is"</font> <font color="#000000">_</font> <font color="#0000ff">$$</font> <font color="#ff0000">MemberDescription</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">catch</font> <font color="#000000">(e)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Library.Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">, e.</font> <font color="#0000ff">DisplayString</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">d</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Device</font> <font color="#000000">).</font>  <font color="#0000ff">Broadcast</font> <font color="#000000">(</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"&lt;------------ NotifyBecomePrimaryFailed ()"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#ff0000">MemberDescription</font> <font color="#000000">()</font> <font color="#008000">;</font>  <font color="#008000">get mirror member status</font> <font color="#008000"><br></font>  <font color="#0000ff">q $ s</font> <font color="#000000">(</font> <font color="#0000ff">$ system</font> <font color="#008080">.Mirror</font> <font color="#000000">.</font> <font color="#0000ff">IsMember</font> <font color="#000000">():</font> <font color="#0000ff">$ s</font> <font color="#000000">(</font> <font color="#0000ff">$ system</font> <font color="#008080">.Mirror</font> <font color="#000000">.</font> <font color="#0000ff">IsBackup</font> <font color="#000000">():</font> <font color="#008000">"a backup"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#0000ff">$ system</font> <font color="#008080">.Mirror</font> <font color="#000000">.</font>  <font color="#0000ff">IsPrimary</font> <font color="#000000">():</font> <font color="#008000">"a primary"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#0000ff">$ system</font> <font color="#008080">.Mirror</font> <font color="#000000">.</font>  <font color="#0000ff">IsAsyncMember</font> <font color="#000000">():</font> <font color="#008000">"an async"</font> <font color="#000000">,</font> <font color="#000000"><br></font>  <font color="#000000">1:</font> <font color="#008000">"an unknown"</font> <font color="#000000">) _</font> <font color="#008000">"member of"</font> <font color="#000000">_</font> <font color="#0000ff">$ system</font> <font color="#008080">.Mirror</font> <font color="#000000">.</font>  <font color="#0000ff">MirrorName</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#000000">1:</font> <font color="#008000">"not a member"</font> <font color="#000000">)</font> <font color="#000000"><br><br></font>  <font color="#ff0000">GetStatus</font> <font color="#000000">(url)</font> <font color="#000000"><br></font>  <font color="#008000">; url - address http: // localhost: 57772 / csp / sys / UtilHome.csp</font> <font color="#008000"><br></font>  <font color="#0000ff">S $ ZT</font> <font color="#000000">=</font> <font color="#008000">"HttpError"</font> <font color="#008000"><br></font>  <font color="#0000ff">N</font> <font color="#000000">A, status, err, httprequest, Port, content,% objlasterror</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">httprequest =</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% Net.HttpRequest</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">S</font> <font color="#000000">A =</font> <font color="#0000ff">$ P</font> <font color="#000000">(</font> <font color="#0000ff">$ p</font> <font color="#000000">(url,</font> <font color="#008000">": //"</font> <font color="#000000">, 2),</font> <font color="#008000">"/"</font> <font color="#000000">, 1)</font> <font color="#0000ff">I</font> <font color="#000000">A =</font> <font color="#008000">""</font> <font color="#0000ff">Q</font> <font color="#008000">"Error! URL"</font> <font color="#008000"><br></font>  <font color="#0000ff">I</font> <font color="#000000">A [</font> <font color="#008000">":"</font> <font color="#0000ff">S</font> <font color="#000000">Port =</font> <font color="#0000ff">$ P</font> <font color="#000000">(A,</font> <font color="#008000">":"</font> <font color="#000000">, 2), A =</font> <font color="#0000ff">$ P</font> <font color="#000000">(A,</font> <font color="#008000">":"</font> <font color="#000000">, 1)</font> <font color="#0000ff">Set</font> <font color="#000000">httprequest.</font>  <font color="#0000ff">Port</font> <font color="#000000">= Port</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">httprequest.</font>  <font color="#0000ff">Server</font> <font color="#000000">= A</font> <font color="#000000"><br></font>  <font color="#0000ff">S</font> <font color="#000000">A =</font> <font color="#008000">"/"</font> <font color="#000000">_</font> <font color="#0000ff">$ P</font> <font color="#000000">(</font> <font color="#0000ff">$ p</font> <font color="#000000">(url,</font> <font color="#008000">": //"</font> <font color="#000000">, 2),</font> <font color="#008000">"/"</font> <font color="#000000">, 2.991)</font> <font color="#000000"><br></font>  <font color="#0000ff">Set</font> <font color="#000000">httprequest.</font>  <font color="#0000ff">Timeout</font> <font color="#000000">= 3</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#000000">httprequest.</font>  <font color="#0000ff">Get</font> <font color="#000000">(A)</font> <font color="#000000"><br></font>  <font color="#0000ff">S</font> <font color="#000000">status = httprequest.</font>  <font color="#0000ff">HttpResponse</font> <font color="#000000">.</font>  <font color="#0000ff">StatusLine</font> <font color="#0000ff"><br></font>  <font color="#0000ff">Do</font> <font color="#000000">httprequest.</font>  <font color="#0000ff">% Close</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">i</font> <font color="#000000">status =</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#0000ff">$ g</font> <font color="#000000">(% objlasterror) '=</font> <font color="#008000">""</font> <font color="#0000ff">g</font> <font color="#ff0000">HttpError</font> <font color="#ff0000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">status</font> <font color="#000000"><br></font>  <font color="#ff0000">HttpError</font> <font color="#0000ff">I $ ZE</font> <font color="#000000">[</font> <font color="#008000">"&lt;INVALID OREF&gt;"</font> <font color="#0000ff">Q</font> <font color="#008000">"Error! Server No Access?"</font> <font color="#000000">_</font> <font color="#0000ff">$ ZE</font> <font color="#0000ff"><br></font>  <font color="#0000ff">do</font> <font color="#ff0000">DecomposeStatus</font> <font color="#000000">^% apiOBJ (% objlasterror, .err)</font> <font color="#000000"><br></font>  <font color="#0000ff">Q</font> <font color="#008000">"Error"</font> <font color="#000000">_</font> <font color="#0000ff">$ G</font> <font color="#000000">(err (err))</font> </div></div><br><br>  <b>Disclaimer!</b>  <b>Using this code in no way guarantees an automatic failover in your production configuration for the ACRF = No mode.</b>  <b>For real use of this mode, thorough failover testing is required for each configuration separately!</b> <b><br></b> <br><h5>  Mirror Tuning Tips </h5><br>  A few recommendations from InterSystems Database Mirroring operating experience <br><br>  <i>‚ÄúYou cannot‚Äú manually ‚Äùclean the primary-server log if the backup server is turned off‚Äù</i> <br>  Indeed, if you do this, and the backup server did not have time to pick up the necessary logs, you can create a backup server again. <br><br>  <i>‚ÄúIt‚Äôs impossible to keep the backup server off for a long time while the primary server is running‚Äù</i> <br>  In this case, the disk space of the primary server may run out due to an overflow of unsynchronized logs. <br><br>  <i>‚ÄúTime on servers must be synchronized‚Äù</i> <br>  This is a simple condition, but it must be met.  Otherwise, when out of sync, for example, for a few hours, the backup server gets ‚Äúconfused‚Äù with the relevance of the logs.  As a result, we make the backup server again. <br><br>  <i>‚ÄúThe network between the servers must be unloaded‚Äù</i> <br>  The network is constantly sending the log from the Primary-server to the backup.  If the network between the servers is still busy, or the channel is not enough for data transfer, as a result, the Primary-server will start to ‚Äúslow down‚Äù, which will not have time to transfer data entered by users of the IC. <br><br>  <i>‚ÄúSystem configuration settings, mappings, roles and user settings must be synchronized manually‚Äù</i> <br>  Global, class and package mapping settings as well as all settings of roles, users and system configuration for Primary and Backup servers must also be maintained in a synchronized state.  Mirror synchronizes only the databases selected for mirroring.  Therefore, the administrator of the mirror needs to have identical configuration, mappings and user security policies and maintain this state for Primary and Backup servers. <br><br><h5>  Performance specifications </h5><br>  The average time for automatic failover for Agent Contact Required for Failover = yes is 10-20 seconds.  A pause of 10-20 seconds is the time when the application will continue to work with the new server.  In this case, the connection will be reconnected (if there was a direct connection to the server) or simply the continuation of work, if the work was carried out via an ECP connection. <br>  In the case of ACRF = no, the pause averages 35-40 seconds.  At the same time, ECP clients will lose the connection, since  default timeout for ECP = 30 sec.  For systems that use ECP and a mirror with ACRF = no on ECP client servers, in the SYSTEM ^% ZSTART program, it is advisable to write a code that increases the ECP timeout: <br><br>  <font color="#0000ff">do $ system</font> <font color="#008080">.ECP</font> <font color="#000000">.</font>  <font color="#0000ff">SetProperty</font> <font color="#000000">(</font> <font color="#008000">"ECPRecoveryTimout"</font> <font color="#000000">, 90)</font> <br><br><h5>  The bottom line or ‚Äúwe need it‚Äù? </h5><br>  Answering this question, I say ‚ÄúYes.‚Äù  Even if you use what comes out of the box - namely, the ACRF = yes mode, you can perform planned work on updating the OS, Cach√©, Hardware, and so on.  without stopping the operation of the information system, as well as automatically overcoming the failures of the Cach√© DBMS.  The remaining scenarios can be covered with already known means using hardware failover clusters and uninterruptible power systems in the required number of nines. </div><p>Source: <a href="https://habr.com/ru/post/149248/">https://habr.com/ru/post/149248/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149241/index.html">1C server 8.2 + MsSql 2008 + BackUp</a></li>
<li><a href="../149242/index.html">Google Play tightens requirements</a></li>
<li><a href="../149243/index.html">Authorization on sites through Z-Payment (OAuth 2.0)</a></li>
<li><a href="../149244/index.html">Client-server communication in Unity3d</a></li>
<li><a href="../149247/index.html">Developer, do not be afraid of the new iPhone</a></li>
<li><a href="../149249/index.html">How and why sites are blocked</a></li>
<li><a href="../149251/index.html">SilkRoad's monthly turnover reaches $ 2 million</a></li>
<li><a href="../149253/index.html">Introducing NetBiscuits at Ciklum Speakers' Corner in Dnepropetrovsk</a></li>
<li><a href="../149254/index.html">REG.BAR: everything is easier than it seems</a></li>
<li><a href="../149255/index.html">Runetology (159): founder of the eLama contextual advertising service Alexey Dovzhikov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>