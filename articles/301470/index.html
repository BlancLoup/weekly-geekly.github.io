<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Push notifications on Android in InterSystems Ensemble on the example of traffic police fines</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In many mobile applications that allow you to recognize fines and pay them, it is possible to receive information about new fines. For this, it is con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Push notifications on Android in InterSystems Ensemble on the example of traffic police fines</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0fc/660/b23/0fc660b2301344c1837060f7b3a74d8b.png"><br><br>  In many mobile applications that allow you to recognize fines and pay them, it is possible to receive information about new fines.  For this, it is convenient to use sending push notifications to client devices. <br><br>  Our <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.blackmushroom.shtrafi">application</a> for paying fines was no exception.  The server part is implemented on the Ensemble platform, in which, from version 2015.1, built-in support for push-notifications appeared at the right time. <br><a name="habracut"></a><br><h3>  First, a little theory </h3><br>  Push notifications are one of the ways to disseminate information when data comes from a provider to a user based on the parameters set. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, for mobile devices, the notification process looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e55/7b2/43b/e557b243bd0754e81086158a94a13a46.png"></div><br><br>  To notify users of mobile applications, we use notification delivery services from which devices receive data.  And just so you can not send a notification.  The user must be subscribed to a push notification channel or to notifications from a specific application. <br><br>  The following entities are available for working with push notifications in Ensemble: <br><br>  ¬ª <a href="">EnsLib.PushNotifications.GCM.Operation</a> is a business operation for sending push notifications to Google Cloud Messaging Services (GCM) server.  The operation also allows you to send one message to the application on several devices at once. <br><br>  ¬ª <a href="">EnsLib.PushNotifications.APNS.Operation</a> is a business operation that sends a notification to the Apple Push Notifications server.  To send messages to each implemented application, you will need a separate SSL certificate. <br><br>  ¬ª <a href="">EnsLib.PushNotifications.IdentityManager</a> - Ensemble business process.  Allows you to send messages to the user without thinking about the number and types of its devices.  In essence, Identity Manager contains a table that associates all its devices with a single user ID.  The Identity Manager's business process receives messages from other product components and forwards them to the router, which in turn sends all GCM messages to the GCM operation and each APNS message to the APNS operation configured with the corresponding SSL certificate. <br><br>  ¬ª <a href="">EnsLib.PushNotifications.AppService</a> - a business service that allows you to send push-messages generated outside the product.  In fact, the message itself can be generated somewhere inside Ensemble regardless of the product, while the service allows you to send these messages from Ensemble.  All of these classes are described in detail in the Ensemble " <a href="">Configuring and Using Ensemble Push Notifications</a> " documentation. <br><br><h3>  Now how we have implemented the notification process </h3><br>  In our case, messages are generated by a specially developed business process inside the product, so the service was not useful to us.  Also at this stage, we only have an Android application, so we have not used the APNS operation either.  In fact, we used the lowest level method of sending directly through the GCM operation.  Later, when implementing the iOS version of the application, it will be convenient to implement work with notifications through the Identity Manager, so that you do not have to analyze the type and number of devices.  But now we will tell more about GCM. <br><br>  To send notifications, you need to implement a process within the product and connect the desired business transaction.  At the moment we have two separate processes for sending Push-notifications, each with its own logic: notifications for new fines, notifications about the termination of the discount on the fine.  About each type will tell a little more. <br><br>  First, about the general data scheme and settings required for the operation of all notifications. <br><br><ul><li>  Create an empty SSL configuration for the operation to work, add it to the configuration of the business transaction (only for GCM!). <br></li><li>  Add an operation of the EnsLib.PushNotifications.GCM.Operation class to the products, adjust its parameters: <br></li></ul><br>  NotificationProtocol: HTTP <br>  PushServer: <a href="http://android.googleapis.com/gcm/send">http://android.googleapis.com/gcm/send</a> <br><br>  The operation settings in the end look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71e/e9d/971/71ee9d97100b7fceb5abc275d58220fd.png"></div><br>  We need to save the client ID, devices (identifiers and types), a list of documents (driver's licenses and vehicle registration certificates).  All this information is obtained in requests from the client when subscribing to notifications.  So, we need classes: <br><br>  Client - for storing clients, App - for storing devices, Doc - for storing document data: <br><br><pre><code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">Class</span></span> penalties.<span class="hljs-type"><span class="hljs-type">Data</span></span>.<span class="hljs-type"><span class="hljs-type">Doc</span></span> <span class="hljs-type"><span class="hljs-type">Extends</span></span> %<span class="hljs-type"><span class="hljs-type">Persistent</span></span> { ///  (  ) <span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">; ///  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> value </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Class</span></span></span><span class="hljs-class"> penalties.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">App</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Extends</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Persistent</span></span></span><span class="hljs-class"> { ///  (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GCM</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">APNS</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">; ///  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MAXLEN</span></span></span><span class="hljs-class"> = 2048); } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Class</span></span></span><span class="hljs-class"> penalties.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Extends</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Persistent</span></span></span><span class="hljs-class"> { ///     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Google</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Play</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Services</span></span></span><span class="hljs-class">,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Email</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> %</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">; ///   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppList</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">penalties</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">App</span></span></span><span class="hljs-class">; /// ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Property</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Docs</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">penalties</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Doc</span></span></span><span class="hljs-class">; }</span></span></code> </pre> <br>  To send notifications about new fines, we need to understand which penalties to send to the client, and which he has already seen, when entering the application.  To do this, we have a NotificationFlow class in which we note that the client has already received information about the fine. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> penalties.Data.NotificationFlow Extends %Persistent { ///  (   email) Property Client <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; ///  Property Penalty <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; ///   Property Sent <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Boolean</span></span>; }</code> </pre> <br>  For convenience of perception below, when mentioning classes, we omit the package names.  According to the content of the classes, it is clear what the process for new fines will look like: we pass through the list of documents for each client, make a request for fines at the GIS GMP (State Information System on State and Municipal Payments), check the received fines for presence in NotificationFlow, if found - we delete from the list, as a result we form a list of fines, about which we need to notify the client, go over the list of client devices and send push notification to each of them. <br><br>  Upper level: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/362/625/a8e/362625a8e5e6043ba92f4b528549d716.png"></div><br>  where clientkey is a context property, the default value of which is the identifier of the first-ordered client of the subscription stored in the Client class. <br><br>  The subprocess looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/465/001/4534650015e3bf411b89454ed0288404.png"></div><br>  Let's look inside the foreach blocks: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/60e/3ca/b38/60e3cab384a761c31a2453d4ac5d4ff6.png"></div><br>  After this foreach block we have a ready-made request EnsLib.PushNotifications.NotificationRequest, in which it remains to add the text of the message.  This is done in the foreach block by Docs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/2c9/046/77e2c90462ec0c6c28a2fb13431c71f3.png"></div><br>  And a small piece of code that fills the request data: <br><br><pre> <code class="hljs vbscript">ClassMethod getPenaltyforNotify(client As penalties.Data.Client, penaltyResponse As penalties.Operations.<span class="hljs-built_in"><span class="hljs-built_in">Response</span></span>.getPenaltiesResponse, notificationRequest As EnsLib.PushNotifications.NotificationRequest) { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> json=<span class="hljs-string"><span class="hljs-string">""</span></span>,count=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> key=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> value=penaltyResponse.penalties.GetNext(.key) quit:key=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> find=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> res=##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%ResultSet).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>(<span class="hljs-string"><span class="hljs-string">"%DynamicQuery:SQL"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> exec=<span class="hljs-string"><span class="hljs-string">"SELECT * FROM penalties_Data.NotificationFlow WHERE (Penalty = ?) AND (Client = ?)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> status=res.Prepare(exec) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> status=res.<span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(value.billNumber,client.Email) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $$$ISERR(status) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> res.%Close() kill res continue <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> res.<span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res.Data(<span class="hljs-string"><span class="hljs-string">"Sent"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> find=<span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> res.%Close() kill res <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> find {<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> penaltyResponse.penalties.RemoveAt(key), penaltyResponse.penalties.GetPrevious(.key)} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> count=count+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.SetAt(<span class="hljs-string"><span class="hljs-string">"single"</span></span>,<span class="hljs-string"><span class="hljs-string">"pushType"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> prop=<span class="hljs-string"><span class="hljs-string">"billNumber"</span></span>,<span class="hljs-string"><span class="hljs-string">"billDate"</span></span>,<span class="hljs-string"><span class="hljs-string">"validUntil"</span></span>,<span class="hljs-string"><span class="hljs-string">"amount"</span></span>,<span class="hljs-string"><span class="hljs-string">"addInfo"</span></span>,<span class="hljs-string"><span class="hljs-string">"driverLicence"</span></span>,<span class="hljs-string"><span class="hljs-string">"regCert"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> json=$<span class="hljs-keyword"><span class="hljs-keyword">property</span></span>(value,prop) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> json=$tr(json,<span class="hljs-string"><span class="hljs-string">""""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> json=<span class="hljs-string"><span class="hljs-string">""</span></span> continue <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.SetAt(json,prop) } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> json=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> notObj=##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(penalties.Data.NotificationFlow).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> notObj.Client=client.Email <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> notObj.Penalty=value.billNumber <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> notObj.Sent=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notObj.%Save() } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> count&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> keyn=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.GetNext(.keyn) quit:keyn=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.RemoveAt(keyn) } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.SetAt(<span class="hljs-string"><span class="hljs-string">"multiple"</span></span>,<span class="hljs-string"><span class="hljs-string">"pushType"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> notificationRequest.Data.SetAt(count,<span class="hljs-string"><span class="hljs-string">"penaltiesCount"</span></span>) } }</code> </pre> <br>  The process on discounts for payment of fines is implemented a little differently.  At the top level: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/298/109/17d/29810917df3d5c906375e4cfee3fddc8.png"></div><br>  The selection of fines at a discount is performed by the following code: <br><br><pre> <code class="hljs pgsql">ClassMethod getSaleforNotify() { //      kill ^mtempArray <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> res=##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%ResultSet).%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>("%DynamicQuery:SQL") //        <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> exec="SELECT * FROM penalties_Data.Penalty WHERE status!=2 AND addInfo LIKE '%%'" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> status=res.<span class="hljs-keyword"><span class="hljs-keyword">Prepare</span></span>(exec) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> status=res.<span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$ISERR</span></span></span><span class="bash">(status) </span><span class="hljs-keyword"><span class="bash"><span class="hljs-keyword">do</span></span></span><span class="bash"> res.%Close() </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">kill</span></span></span><span class="bash"> res quit </span><span class="hljs-keyword"><span class="bash"><span class="hljs-keyword">while</span></span></span><span class="bash"> res.</span><span class="hljs-function"><span class="hljs-title"><span class="bash"><span class="hljs-function"><span class="hljs-title">Next</span></span></span></span></span><span class="bash">() { </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> discDate=</span><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$piece</span></span></span><span class="bash">(res.Data(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"addInfo"</span></span></span><span class="bash">),</span><span class="hljs-string"><span class="bash"><span class="hljs-string">" 50%   : "</span></span></span><span class="bash">,2) </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> discDate=</span><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$extract</span></span></span><span class="bash">(discDate,1,10) </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> date=</span><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$zdh</span></span></span><span class="bash">(discDate,3) </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> dayscount=date-</span><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$p</span></span></span><span class="bash">(</span><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$h</span></span></span><span class="bash">,</span><span class="hljs-string"><span class="bash"><span class="hljs-string">","</span></span></span><span class="bash">) //   5,2,1  0  </span><span class="hljs-keyword"><span class="bash"><span class="hljs-keyword">if</span></span></span><span class="bash"> </span><span class="hljs-string"><span class="bash"><span class="hljs-string">'$lf($lb(5,2,1,0),dayscount) continue set doc=$s(res.Data("regCert")'</span></span></span><span class="bash">=</span><span class="hljs-string"><span class="bash"><span class="hljs-string">""</span></span></span><span class="bash">:</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"sts||"</span></span></span><span class="bash">_Res.Data(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"regCert"</span></span></span><span class="bash">),1:</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"vu||"</span></span></span><span class="bash">_Res.Data(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"driverLicence"</span></span></span><span class="bash">)) </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> clRes=</span><span class="hljs-comment"><span class="bash"><span class="hljs-comment">##class(%ResultSet).%New("%DynamicQuery:SQL") // ,    set clExec="SELECT * FROM penalties_Data.Client WHERE (Docs [ ?)" set clStatus=clRes.Prepare(clExec) set clStatus=clRes.Execute(doc) if $$</span></span></span></span>$ISERR(clStatus) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> clRes.%<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() kill clRes quit <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> clRes.Next() { //  ,      <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^mtempArray($job,clRes.Data("Email"),res.Data("billNumber"))=res.Data("billDate") } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> clRes.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> res.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() }</code> </pre> <br>  At the exit, we have a global breakdown of penalties for customers.  Now you have to go over this global one and send each client its fine, after making sure that it has not been paid elsewhere: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bf1/3d2/43b/bf13d243b769f10872da443a5ddd3562.png"></div><br>  We fall into a cycle of penalties: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/790/35a/bf5/79035abf5973d6d639e2dd58785abdf4.png"></div><br>  Actually, the difference between the processes is as follows: in the first case, we necessarily go over all our clients, in the second we select only clients who have fines of a certain type;  in the first case, for several penalties there is one notice with the total number (there are customers who manage to pick up a lot of fines during the day), in the second case there are separate discounts for each discount. <br>  In the process of debugging, we encountered a small feature of our messages, due to which we had to override certain system methods.  One of the parameters of our message, we pass the number of the fine, which in general form looks something like "12345678901234567890".  System classes of the operation of sending notifications convert such strings into numbers, and the GCM service, unfortunately, having received such a large number is perplexed and returns a ‚ÄúBad Request‚Äù. <br><br>  Therefore, we redefined the system class of the operation, call the ConvertArrayToJSON method in it, inside which we call ..Quote with the second parameter equal to 0, that is, do not convert strings consisting only of numbers into numbers, but leave them as strings: <br><br><pre> <code class="hljs smalltalk"><span class="hljs-type"><span class="hljs-type">Method</span></span> <span class="hljs-type"><span class="hljs-type">ConvertArrayToJSON</span></span>(<span class="hljs-type"><span class="hljs-type">ByRef</span></span> pArray) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> tOutput <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> tSubscript <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-type"><span class="hljs-type">For</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> tSubscript = <span class="hljs-string"><span class="hljs-string">$O</span></span>RDER(pArray(tSubscript)) <span class="hljs-type"><span class="hljs-type">Quit</span></span>:tSubscript=<span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span>:tOutput<span class="hljs-string"><span class="hljs-string">'="" tOutput = tOutput _ "," Set tOutput = tOutput _ ..Quote(tSubscript) _ ": " If $GET(pArray(tSubscript))'</span></span>=<span class="hljs-comment"><span class="hljs-comment">""</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> tValue = pArray(tSubscript) <span class="hljs-type"><span class="hljs-type">If</span></span> <span class="hljs-string"><span class="hljs-string">$L</span></span>ISTVALID(tValue) { <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> tIndex <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> // <span class="hljs-string"><span class="hljs-string">$L</span></span>IST .. aka an array // <span class="hljs-type"><span class="hljs-type">NOTE</span></span>: <span class="hljs-type"><span class="hljs-type">This</span></span> only handles an array of scalar values <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = tOutput _ <span class="hljs-comment"><span class="hljs-comment">"[ "</span></span> <span class="hljs-type"><span class="hljs-type">For</span></span> tIndex = <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$L</span></span>ISTLENGTH(tValue) { <span class="hljs-type"><span class="hljs-type">Set</span></span>:tIndex&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> tOutput = tOutput _ <span class="hljs-comment"><span class="hljs-comment">", "</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = tOutput _ ..<span class="hljs-type"><span class="hljs-type">Quote</span></span>(<span class="hljs-string"><span class="hljs-string">$L</span></span>ISTGET(tValue,tIndex),<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = tOutput _ <span class="hljs-comment"><span class="hljs-comment">" ]"</span></span> } <span class="hljs-type"><span class="hljs-type">Else</span></span> { // <span class="hljs-type"><span class="hljs-type">Simple</span></span> string <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = tOutput _ ..<span class="hljs-type"><span class="hljs-type">Quote</span></span>(tValue,<span class="hljs-number"><span class="hljs-number">1</span></span>) } } <span class="hljs-type"><span class="hljs-type">Else</span></span> { // <span class="hljs-type"><span class="hljs-type">Child</span></span> elements <span class="hljs-symbol"><span class="hljs-symbol">#dim</span></span> tTemp <span class="hljs-type"><span class="hljs-type">Kill</span></span> tTemp <span class="hljs-type"><span class="hljs-type">Merge</span></span> tTemp = pArray(tSubscript) <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = tOutput _ ..<span class="hljs-type"><span class="hljs-type">ConvertArrayToJSON</span></span>(.tTemp) } } <span class="hljs-type"><span class="hljs-type">Set</span></span> tOutput = <span class="hljs-comment"><span class="hljs-comment">"{"</span></span> _ tOutput _ <span class="hljs-comment"><span class="hljs-comment">"}"</span></span> <span class="hljs-type"><span class="hljs-type">Quit</span></span> tOutput }</code> </pre> <br>  No other problems in the implementation process were found.  Total, the main things that need to be done to send notifications: <br><br><ul><li>  add the desired operation <br></li><li>  build a process that fills in the following properties of the request: AppIdentifier - Server API Key, obtained when registering the service in GCM, Identifiers - a list of identifiers of the devices we are accessing, Service - the type of device that we are accessing (in our case, ‚ÄúGCM‚Äù) the request data itself (remember that the array is built on the key-value principle). <br></li></ul><br>  Actually, everything.  Due to the use of Ensemble ready-made components, the implementation of the process takes a couple of hours, including debugging and testing. <br><br>  At the exit, we have satisfied customers who timely learn about new fines and recall discounts on time. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f25/be0/d6a/f25be0d6ae7d4c17144748e184f8fdd0.png" width="300"></div><br>  See how it works in <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.blackmushroom.shtrafi%26hl%3Dru">Android</a> and <a href="https://itunes.apple.com/ru/app/bezstrafov-strafy-gibdd-onlajn/id1099486143%3Fmt%3D8">iOS</a> applications. </div><p>Source: <a href="https://habr.com/ru/post/301470/">https://habr.com/ru/post/301470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301458/index.html">Overview of 5 platforms for creating websites</a></li>
<li><a href="../301460/index.html">How to find the nearest cafe, sight, free taxi through the eyes of a programmer</a></li>
<li><a href="../301464/index.html">Simply AWeSome - Amazon Web Services in Brief</a></li>
<li><a href="../301466/index.html">How to keep track of news in the C ++ world</a></li>
<li><a href="../301468/index.html">GUI to the tacacs daemon - TacacsGUI</a></li>
<li><a href="../301472/index.html">Storage Federation or all enterprise storage federation</a></li>
<li><a href="../301474/index.html">Seminar "Oracle in the cloud" and a tour of one of the largest data centers in Russia NORD 4, May 26, Moscow</a></li>
<li><a href="../301476/index.html">Application of statistical criteria for solving detection problems in radio engineering</a></li>
<li><a href="../301478/index.html">PHP, static variables inside class methods and one bug history</a></li>
<li><a href="../301482/index.html">JQuery 3.0 Release Candidate Release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>