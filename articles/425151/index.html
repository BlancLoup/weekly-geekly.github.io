<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are listening to the telegraph chat with the help of our client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow I wanted the messages of one of the telegraph chat rooms to be stored on my disk (without starting a regular client). I will not disclose my m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are listening to the telegraph chat with the help of our client</h1><div class="post__text post__text-html js-mediator-article"><p>  Somehow I wanted the messages of one of the telegraph chat rooms to be stored on my disk (without starting a regular client).  I will not disclose my motives, but this opportunity seemed to me necessary and useful. </p><br><p>  For this, there are bots in the telegram.  On Habr√© there are several articles on bots, for example: " <a href="https://habr.com/post/264035/">Chat assistant to the site</a> ." </p><br><p>  The bot allows you to read and send messages, you do not need a phone to register a bot and there can be any number of bots.  But the name of the bot includes the word "bot", which may cause unnecessary questions to the chat host. </p><br><p>  But as they say, the right question is half the answer. </p><a name="habracut"></a><br><p>  It turns out that apart from the "API telegram bot" there is also the "API telegram client", i.e.  API to create your own clients. </p><br><p>  The client can also send and read messages, but only from a registered user (tied to the phone), which just suits me (I am already registered in the chat). </p><br><p>  The telegraph site has a list of APIs for different platforms: <a href="https://telegram.org/apps">https://telegram.org/apps#source-code</a> </p><br><p>  However, the easiest to use library was in python: <a href="https://github.com/LonamiWebs/Telethon">Pure Python 3 MTProto API Telegram client library</a> called <strong>"telethon"</strong> </p><br><p>  Only here is the problem.  I don't know python.  Well, there is a reason to meet. <br>  According to the teleton manual, its installation is very simple.  Just run the command at the command prompt: </p><br><pre><code class="bash hljs">pip3 install telethon</code> </pre> <br><p>  Pitfalls I encountered during the installation: </p><br><ul><li>  pip3 not installed (installer for python). </li></ul><br><p>  sudo apt-get -y install python3-pip </p><br><ul><li>  The library works only on python version&gt; 3.5.  So, you may have to update it. </li></ul><br><p>  Everything is established.  Scroll through the readme.txt further. </p><br><p>  The next item is the creation of a telegraph client ... How, already?  Well, yes, it's simple.  True, you first need to register yourself as the creator of the client. </p><br><p>  Go to the site telegraph: <a href="https://my.telegram.org/">https://my.telegram.org</a> <br>  We enter the phone and wait for the confirmation code on the telegraph's native client.  It is rather long (12 characters) and inconvenient for input. </p><br><p>  Go to the item " <a href="https://core.telegram.org/api">API</a> ".  We look for the "Telegram API" and go to the "Creating an application" ( <a href="https://my.telegram.org/apps">https://my.telegram.org/apps</a> ). </p><br><p>  Fill in the fields <strong>App title</strong> and <strong>Short name</strong> , click <strong>‚ÄúCreate application‚Äù</strong> and remember two variables: <strong>api_id</strong> and <strong>api_hash</strong> . </p><br><p>  It's time to make a client. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telethon <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TelegramClient, sync #  api_id  api_hash api_id = <span class="hljs-number"><span class="hljs-number">12345</span></span> api_hash = <span class="hljs-string"><span class="hljs-string">'0123456789abcdef0123456789abcdef'</span></span> client = TelegramClient(<span class="hljs-string"><span class="hljs-string">'session_name'</span></span>, api_id, api_hash) client.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>()</code> </pre> <br><p>  session_name - you can insert any name.  You will be asked to enter a phone number and send a confirmation code.  After that, the client will work without a phone request (until you change the session_name).  The <strong>session_name.session</strong> file will appear next to your program. </p><br><p>  If there are no errors, the client is ready.  Only here, displays nothing.  Let's try to get useful information. </p><br><p>  We learn a little about yourself: </p><br><pre> <code class="python hljs">print(client.get_me().stringify())</code> </pre> <br><p>  The result is given in the form: </p><br><pre> <code class="python hljs">User( photo=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, last_name=<span class="hljs-string"><span class="hljs-string">'Pupkin'</span></span>, first_name=<span class="hljs-string"><span class="hljs-string">'Vasya'</span></span>, id=<span class="hljs-number"><span class="hljs-number">123456789</span></span>, phone=<span class="hljs-string"><span class="hljs-string">'79041234567'</span></span>, .... - - ... )</code> </pre> <br><p>  We can send a message from yourself: </p><br><pre> <code class="python hljs">client.send_message(<span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'Hello! Talking to you from Telethon'</span></span>)</code> </pre> <br><p>  Can and picture </p><br><pre> <code class="python hljs">client.send_file(<span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/myself/Pictures/holidays.jpg'</span></span>)</code> </pre> <br><p>  As others see me: </p><br><pre> <code class="python hljs">client.download_profile_photo(<span class="hljs-string"><span class="hljs-string">'me'</span></span>)</code> </pre> <br><p>  We look at which chats we are subscribed to: </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span> all chats name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dialog <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client.iter_dialogs(): <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(dialog.<span class="hljs-built_in"><span class="hljs-built_in">title</span></span>)</code> </pre> <br><p>  read all chat messages "chat_name" (carefully, there can be a lot of messages) </p><br><pre> <code class="python hljs">messages = client.get_entity(<span class="hljs-string"><span class="hljs-string">'chat_name'</span></span>) print(messages)</code> </pre> <br><p>  view all chat users </p><br><pre> <code class="python hljs">participants = client.get_participants(<span class="hljs-string"><span class="hljs-string">'chat_name'</span></span>) print(participants)</code> </pre> <br><p>  Indulged? <br>  Now, in fact, we are doing something for which we all started this ... </p><br><p>  We need a program that monitors new messages in a particular channel. </p><br><p>  So that the client does not finish the work, after client.start () insert the line: </p><br><pre> <code class="python hljs">client.run_until_disconnected()</code> </pre> <br><p>  This construct (inserted before client.start ()) displays only new messages: </p><br><pre> <code class="hljs mel">@client.on(events.NewMessage(chats=(<span class="hljs-string"><span class="hljs-string">'chat_name'</span></span>))) async def normal_handler(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>): # <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.message) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'message'</span></span>])</code> </pre> <br><p>  Let's see. </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@client.on(events.NewMessage(chats=('chat_name')))</span></span></code> </pre> <br><p>  creates an event that triggers when a new message appears </p><br><pre> <code class="python hljs"> print(event.message)</code> </pre> <br><p>  displays a message like this: </p><br><pre> <code class="python hljs">Message(edit_date=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, views=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, reply_markup=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, fwd_from=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, id=<span class="hljs-number"><span class="hljs-number">187</span></span>, entities=[], post=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, mentioned=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, via_bot_id=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, media_unread=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, out=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, media=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, date=datetime.datetime(<span class="hljs-number"><span class="hljs-number">2018</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>, tzinfo=datetime.timezone.utc), to_id=PeerChannel(channel_id=<span class="hljs-number"><span class="hljs-number">123456789</span></span>), reply_to_msg_id=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, from_id=<span class="hljs-number"><span class="hljs-number">123456789</span></span>, silent=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, grouped_id=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, post_author=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, message=<span class="hljs-string"><span class="hljs-string">'hello telegram'</span></span>)</code> </pre> <br><p>  From all this, we need a field: "message = 'hello telegram'": </p><br><pre> <code class="python hljs"> print(event.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'message'</span></span>])</code> </pre> <br><p>  The message received, but from whom it is not clear, because  In the message only user ID.  To match the ID and username, download all chat users and put them into the dictionary (hash) in the form d [id] = "first_name last_name" </p><br><pre> <code class="hljs axapta">participants = <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.get_participants(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>) users={} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> partic in <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.iter_participants(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>): lastname=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> partic.last_name: lastname=partic.last_name users[partic.id]=partic.first_name+<span class="hljs-string"><span class="hljs-string">" "</span></span>+lastname</code> </pre> <br><p>  Now we can find out who sent the message: </p><br><pre> <code class="hljs cs">s_user_id=<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'from_id'</span></span>] user_id=<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(s_user_id) user=d.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_id)</code> </pre> <br><p>  In principle, you can get the username from the telegram directly, but if there are few users, it is easier with a dictionary. </p><br><p>  We pull out the date of sending from the message: </p><br><pre> <code class="python hljs">mess_date=event.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'date'</span></span>]</code> </pre> <br><p>  All, all the data we have.  It remains to write them to the file. <br>  To do this, first open the file for writing: </p><br><pre> <code class="python hljs">f=open(<span class="hljs-string"><span class="hljs-string">'messages_from_chat'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>)</code> </pre> <br><p>  And write the message: </p><br><pre> <code class="hljs perl">f.write(mess_date.strftime(<span class="hljs-string"><span class="hljs-string">"%d-%m-%Y %H:%M"</span></span>)+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) f.write(user+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) f.write(user_mess+<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>) f.flush()</code> </pre> <br><p>  That's all!  All I needed was a program.  The utility, of course, is damp, but it does its job. </p><br><p>  Python was not so difficult <strike>as it is painted</strike> , especially the description of various libraries on the Internet is full.  Write a couple more utilitok and getting used to it, you can use it as a scripting language instead of bash. </p><br><div class="spoiler">  <b class="spoiler_title">All utility text:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telethon <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TelegramClient, sync, events api_id = <span class="hljs-number"><span class="hljs-number">12345</span></span> api_hash = <span class="hljs-string"><span class="hljs-string">'0123456789abcdef0123456789abcdef'</span></span> client = TelegramClient(<span class="hljs-string"><span class="hljs-string">'session_name'</span></span>, api_id, api_hash) @client.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(events.NewMessage(chats=(<span class="hljs-string"><span class="hljs-string">'chat_name'</span></span>))) async def normal_handler(event): # print(event.message) user_mess=event.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'message'</span></span>] s_user_id=event.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'from_id'</span></span>] user_id=<span class="hljs-type"><span class="hljs-type">int</span></span>(s_user_id) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=d.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_id) mess_date=event.message.to_dict()[<span class="hljs-string"><span class="hljs-string">'date'</span></span>] f.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(mess_date.strftime("%d-%m-%Y %H:%M")+"\n") f.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>+"\n") f.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(user_mess+"\n\n") f.flush() client.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=<span class="hljs-string"><span class="hljs-string">'group_name'</span></span> participants = client.get_participants(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>) users={} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> partic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client.iter_participants(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>): lastname="" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> partic.last_name: lastname=partic.last_name users[partic.id]=partic.first_name+" "+lastname f=<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-string"><span class="hljs-string">'messages_from_chat'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>) client.run_until_disconnected() f.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>()</code> </pre> </div></div><br><p>  <a href="https://media.readthedocs.org/pdf/telethon/stable/telethon.pdf">Full description of the library</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/425151/">https://habr.com/ru/post/425151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425139/index.html">Pop stars under the lens of artificial intelligence</a></li>
<li><a href="../425141/index.html">‚ÄúFacing Guido what you tell him‚Äù or Python dialogs with Bobuk</a></li>
<li><a href="../425143/index.html">Higher School of Economics refuses to lecture in favor of online courses</a></li>
<li><a href="../425145/index.html">Such an exceptional go</a></li>
<li><a href="../425149/index.html">Between heaven and earth</a></li>
<li><a href="../425153/index.html">Three of the most popular misconceptions about emotions in Affective Computing</a></li>
<li><a href="../425155/index.html">Fascinating cryptography or research on reversible PHP encryption</a></li>
<li><a href="../425157/index.html">Meet the .Net community at CLRium # 4 + online. Where CoreCLR and C # are moving. All are invited</a></li>
<li><a href="../425159/index.html">OFFZONE 2018 welcomes recruits</a></li>
<li><a href="../425161/index.html">Browse Free 2D CAD Software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>