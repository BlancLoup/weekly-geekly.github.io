<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overclock the median in OLAP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is for those who faced a performance problem when calculating the median in the OLAP cube. 
 One of the main advantages of OLAP technology i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overclock the median in OLAP</h1><div class="post__text post__text-html js-mediator-article">  This post is for those who faced a performance problem when calculating the median in the OLAP cube. <br>  One of the main advantages of OLAP technology is the speed of obtaining results when accessing the database.  Calculations occur on the fly.  However, with the median, not everything is so simple. <br>  For reference: the median is a type of medium.  This is the value that is in the middle of a series of values ‚Äã‚Äãsorted in ascending order.  For example, for a series of values ‚Äã‚Äã{1, 2, 5, 6, 9} the median is 5. <br><br>  Consider the situation on the example of the OLAP server from Microsoft - SSAS 2008 (SQL Server Analysis Services). <br><a name="habracut"></a>  To calculate the median, SSAS suggests using the MDX function of Median.  With it, you can create a calculated measure (Calculated Member) and use it in calculations. <br><br>  We were faced with the task of designing an OLAP cube for analyzing data on job vacancies obtained from various sources.  The total number of vacancies was about 10 million.  We implemented the median to determine the average salary using the Median function.  No calculation "on the fly" when working with a cube did not work.  However, other aggregations, for example, the number of vacancies were considered quickly. <br>  The problem is that such aggregations as a quantity or sum are ‚Äúpre-aggregated‚Äù - when the cube is updated, they are calculated in advance, and when the data is requested, the server returns ready-made results.  In the case of a median, the server does not calculate its values ‚Äã‚Äãin advance, but calculates it each time the cube is accessed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider a sample report: <br><img src="https://habrastorage.org/storage2/991/757/43f/99175743fe0aed9b774b50d4e8e41234.png"><br><br>  For the specialty "Developer 1C" in 2011, 8,354 vacancies were found.  To calculate the salary median for this specialty, the server needs to perform the following operations: selecting all the values ‚Äã‚Äãrelated to this cell of the report, sorting them by the value of the salary, determining the value of the row of values ‚Äã‚Äã(tuple) in the middle.  And so for each cell.  Therefore, the execution time of the report greatly increases.  Most of the time it goes on sorting. <br><br><h4>  Decision </h4><br>  The values ‚Äã‚Äãfor calculating the median are selected from the fact table of the data warehouse, on the basis of which the OLAP cube was created.  What if we assume that the fact table will be sorted in advance by the value of the salary.  Then we do not need to sort the values ‚Äã‚Äãfor each cell.  You just need to determine for each cell the number of elements and calculate the number of the element that is in the middle of the row.  The value of this element will be the median. <br><br>  Code to create Calculate Member: <br><br><pre><code class="sql hljs">//    <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">measures</span></span>].[AdvCount] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>(NonEmpty([Advertisement].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>].members,[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AdvSet), <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> ; //     <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianReal] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">measures</span></span>].[AdvCount]<span class="hljs-number"><span class="hljs-number">-1</span></span>) * <span class="hljs-number"><span class="hljs-number">50</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianInt] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>([<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianReal]), <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianFrac] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianReal]- [<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianInt], <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; //  <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianLow] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (NonEmpty([Advertisement].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>].members,[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary]).Item([<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianInt]).Item(<span class="hljs-number"><span class="hljs-number">0</span></span>),[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary]), <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianHigh] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (NonEmpty([Advertisement].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>].members,[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary]).Item([<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianInt] + <span class="hljs-number"><span class="hljs-number">1</span></span>).Item(<span class="hljs-number"><span class="hljs-number">0</span></span>),[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary]), <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> CURRENTCUBE.[<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[Salary <span class="hljs-keyword"><span class="hljs-keyword">Median</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianLow] * [<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianFrac]) +([<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianHigh] * (<span class="hljs-number"><span class="hljs-number">1</span></span> - [<span class="hljs-keyword"><span class="hljs-keyword">Measures</span></span>].[MedianFrac])), FORMAT_STRING = <span class="hljs-string"><span class="hljs-string">"# ### ### ##0;-# ### ### ##0"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">VISIBLE</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> , ASSOCIATED_MEASURE_GROUP = <span class="hljs-string"><span class="hljs-string">'Advertisement'</span></span>;</code> </pre> <br><br>  This code takes into account the situation when the tuple contains an even number of elements.  In this case, the median is calculated as the arithmetic average of two values ‚Äã‚Äãlocated in the middle of the series.  If your task does not require absolute accuracy, then in this case you can assume the median is the left or right value.  To do this, you have to slightly change the above code, but this will further reduce the calculation time. <br><br>  Now how to sort out the fact table in advance.  Suppose you have a source fact table, in which data is accumulated over time.  Make a copy of this table and insert there the data from the source table sorted by the desired value. <br><br>  Sample SQL query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> CopyBasicTable <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> BasicTable <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ValueField</code> </pre><br><br>  This operation will need to be done every time before updating the OLAP cube.  Of course, in this method there is a serious minus - with a large amount of data, the operation time will be significant.  However, this method is quite suitable for relatively small volumes.  In a similar way, it is possible to calculate percentiles and quartiles. </div><p>Source: <a href="https://habr.com/ru/post/153869/">https://habr.com/ru/post/153869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153857/index.html">Creating icons for Mac OS X applications</a></li>
<li><a href="../153859/index.html">Why you need to think 1000 times before using noSQL</a></li>
<li><a href="../153861/index.html">Build a Nested Set Tree without Recursion</a></li>
<li><a href="../153865/index.html">Configuring OSPF on Cisco and HUAWEI Hardware</a></li>
<li><a href="../153867/index.html">Review code in the comments</a></li>
<li><a href="../153873/index.html">Writing a plugin to support cmake projects under vim</a></li>
<li><a href="../153875/index.html">Perl6 - Variable operations, anonymous blocks</a></li>
<li><a href="../153883/index.html">jQuery plugins for amazing web typography</a></li>
<li><a href="../153889/index.html">There is a reason to refresh Morse code. Japan launches talking satellite</a></li>
<li><a href="../153893/index.html">SMS alert for students from the VKontakte page</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>