<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing Row Level Security on MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! I happened to implement a business process that assumed row-level security ( Row Level Security ) on mysql and php. 



 Row Level Security o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing Row Level Security on MySQL</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr!  I happened to implement a business process that assumed row-level security ( <b>Row Level Security</b> ) on <b>mysql</b> and php. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5d/134/394/c5d1343945fffa30fe736bf4b977c560.png" alt="image"><br><br>  <i><b>Row Level Security</b> or row level security is a mechanism for restricting access to information to a database, which allows users to restrict access to individual rows in tables.</i> <br><a name="habracut"></a><br>  Since  most of the time I program in Oracle, I decided that it would be best to implement this in a database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have <b>MySQL 5.1.73</b> with triggers, view, stored functions and procedures on a regular virtual hosting. <br><br>  <b>Attached</b> table <b>auth_users</b> <br><br><div class="spoiler">  <b class="spoiler_title">CREATE TABLE `auth_users`</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`auth_users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`conn_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`login_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`conn_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`user_id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'    '</span></span>;</code> </pre> </div></div><br>  which is filled in when logging in to php <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> conn_id = CONNECTION_ID(), user_id = :user_id</code> </pre> <br>  and cleared at the completion of the php script <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user_logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   auth_users app()-&gt;db-&gt;query("DELETE FROM auth_users WHERE conn_id = CONNECTION_ID()"); } ... register_shutdown_function(array('Auth', 'user_logout'));</span></span></code> </pre><br>  Example data schema: <br><br><ul><li>  directory of organizations <br><br><div class="spoiler">  <b class="spoiler_title">CREATE TABLE `organizations`</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`organizations`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`type`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> organizations (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre> </div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> organizations; +<span class="hljs-comment"><span class="hljs-comment">----+-----------------------------------+------------+ | id | name | type | +----+-----------------------------------+------------+ | 1 |   |  | | 2 |   |  | +----+-----------------------------------+------------+ 2 rows in set (0.00 sec)</span></span></code> </pre> <br></li><li>  access setting: <br><br><ol><li>  Storekeeper number 1 user_id = 1, has access to view documents "Warehouse Moscow", to view and edit documents "Warehouse Novosibirsk" </li><li>  Storekeeper number 2 user_id = 2, has access to view documents "Warehouse Novosibirsk", to view and edit documents "Warehouse Moscow" </li><li>  Director user_id = 3, has access to view documents "Warehouse Novosibirsk" and "Warehouse Moscow" </li><li>  Accountant user_id = 4, has access to view and edit documents "Warehouse Novosibirsk" and "Warehouse Moscow" </li><li>  Manager number 1 user_id = 5, has access to view documents "Warehouse Moscow" </li><li>  Manager number 2 user_id = 6, has access to view documents "Warehouse Novosibirsk" </li></ol><br><div class="spoiler">  <b class="spoiler_title">CREATE TABLE `user_access`</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`user_access`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`warehouse_org_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`edit`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>), PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`user_access_ibfk_1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`warehouse_org_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`organizations`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> user_access (user_id, warehouse_org_id, edit) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre> </div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> user_access; +<span class="hljs-comment"><span class="hljs-comment">----+---------+------------------+------+ | id | user_id | warehouse_org_id | edit | +----+---------+------------------+------+ | 1 | 1 | 1 | NULL | | 2 | 1 | 2 | 1 | | 3 | 2 | 1 | 1 | | 4 | 2 | 2 | NULL | | 5 | 3 | 1 | NULL | | 6 | 3 | 2 | NULL | | 7 | 4 | 1 | 1 | | 8 | 4 | 2 | 1 | | 9 | 5 | 1 | NULL | | 10 | 6 | 2 | NULL | +----+---------+------------------+------+ 10 rows in set (0.00 sec)</span></span></code> </pre> <br></li><li>  the table of documents contains a field warehouse (by which we will delimit access) and other document attributes <br><br><div class="spoiler">  <b class="spoiler_title">CREATE TABLE `docs`</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`docs`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`warehouse_org_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`sum`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>), PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`docs_ibfk_1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`warehouse_org_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`organizations`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> docs (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, warehouse_org_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>);</code> </pre> </div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; +<span class="hljs-comment"><span class="hljs-comment">----+------------------+-------+ | id | warehouse_org_id | sum | +----+------------------+-------+ | 1 | 1 | 10000 | | 2 | 2 | 5000 | +----+------------------+-------+ 2 rows in set (0.00 sec)</span></span></code> </pre> </li></ul><br>  So, let's start configuring RLS: first, let's rename the target table <b>docs</b> -&gt; <b>t_docs</b> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">RENAME</span></span> t_docs;</code> </pre> <br>  and create the same editable VIEW <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, warehouse_org_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_docs <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span>;</code> </pre> <br>  Now all requests from client applications are not addressed directly to the table, but to VIEW <br><br>  <i><b>Important!</b></i>  <i>If the system has functions, procedures, queries that do not need to restrict access to the table, then it is necessary to register the table directly, i.e.</i>  <i>t_docs</i>  <i>For example, these may be procedures for calculating debts / balances throughout the system.</i> <br><br>  Now we will do a simple thing, we will limit the view in accordance with the access control. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, warehouse_org_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> user_access <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> user_access.user_id = auth_users.user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> auth_users.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.warehouse_org_id = user_access.warehouse_org_id ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span>;</code> </pre> <br>  Check out how it worked: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; Empty <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre> <br>  Nothing has returned.  Indeed, you need to log in.  Sign in Manager ‚Ññ1 user_id = 5 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> conn_id = CONNECTION_ID(), user_id = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; +<span class="hljs-comment"><span class="hljs-comment">----+------------------+-------+ | id | warehouse_org_id | sum | +----+------------------+-------+ | 1 | 1 | 10000 | +----+------------------+-------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br>  Sees only the documents "Warehouse Moscow".  Log in Director user_id = 3 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> conn_id = CONNECTION_ID(), user_id = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; +<span class="hljs-comment"><span class="hljs-comment">----+------------------+-------+ | id | warehouse_org_id | sum | +----+------------------+-------+ | 1 | 1 | 10000 | | 2 | 2 | 5000 | +----+------------------+-------+ 2 rows in set (0.00 sec)</span></span></code> </pre><br>  Sees the documents "Warehouse Moscow" and "Warehouse Novosibirsk"!  It seems everything works as it should.  Then go to a more difficult task - the restriction on editing.  Let's try to log in Manager number 1 user_id = 5 and edit the documents: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> conn_id = CONNECTION_ID(), user_id = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-number"><span class="hljs-number">20000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>; Query OK, 0 rows affected (0.00 sec) Rows matched: 0 Changed: 0 Warnings: 0</code> </pre> <br>  Only the lines that are visible were updated. <br><br>  But how do we achieve different rights to view and edit?  You can add another VIEW e_docs <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> e_docs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, warehouse_org_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> user_access <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> user_access.user_id = auth_users.user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> auth_users.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.warehouse_org_id = user_access.warehouse_org_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> user_access.edit = <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span>;</code> </pre> <br>  and let all DML commands run through this VIEW, but this will require rewriting all DML commands in the application and we will have 3 objects <br><br>  <b>t_docs</b> - source table <br>  <b>docs</b> - RLS table for viewing <br>  <b>e_docs</b> - RLS table for editing <br><br>  Let's try another option, more flexible. <br><br><ol><li>  Create a function <b>get_db_mode</b> to display the current mode - view / edit <br><br><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> get_db_mode() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'edit'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-string"><span class="hljs-string">'edit'</span></span>; ELSE RETURN '<span class="hljs-keyword"><span class="hljs-keyword">show</span></span><span class="hljs-string"><span class="hljs-string">'; END IF; END $ DELIMITER ;</span></span></code> </pre> <br></li><li>  Modify VIEW to display different lines in view / edit mode. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, warehouse_org_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t_docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> user_access <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> user_access.user_id = auth_users.user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> auth_users.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.warehouse_org_id = user_access.warehouse_org_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (get_db_mode() = <span class="hljs-string"><span class="hljs-string">'show'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> user_access.edit = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> get_db_mode() = <span class="hljs-string"><span class="hljs-string">'edit'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span>;</code> </pre> <br></li><li>  Now with DML in BEFORE the trigger we will set the <b>@db_mode</b> variable to <b>'edit'</b> , and in AFTER the trigger to <b>'show'</b> <br><br><div class="spoiler">  <b class="spoiler_title">CREATE TRIGGERS</b> <div class="spoiler_text"><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_bef_ins_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_bef_upd_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_bef_del_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_aft_ins_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'show'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_aft_upd_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'show'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">`docs_aft_del_trg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`t_docs`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @db_mode = <span class="hljs-string"><span class="hljs-string">'show'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ DELIMITER ;</code> </pre> </div></div></li></ol><br>  Voila, check how everything works: <br><br>  Log in Warehouse number 1 user_id = 1 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> auth_users <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> conn_id = CONNECTION_ID(), user_id = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> get_db_mode(); +<span class="hljs-comment"><span class="hljs-comment">---------------+ | get_db_mode() | +---------------+ | show | +---------------+ 1 row in set (0.00 sec) SELECT * FROM docs; +----+------------------+-------+ | id | warehouse_org_id | sum | +----+------------------+-------+ | 1 | 1 | 20000 | | 2 | 2 | 5000 | +----+------------------+-------+ 2 rows in set (0.00 sec) UPDATE docs SET sum = 105000 WHERE id = 2; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 SELECT get_db_mode(); +---------------+ | get_db_mode() | +---------------+ | show | +---------------+ 1 row in set (0.00 sec) SELECT * FROM docs; +----+------------------+--------+ | id | warehouse_org_id | sum | +----+------------------+--------+ | 1 | 1 | 20000 | | 2 | 2 | 105000 | +----+------------------+--------+ 2 rows in set (0.01 sec) UPDATE docs SET sum = 205000 WHERE id = 1; ERROR 1369 (HY000): CHECK OPTION failed '3006309-habr.docs'</span></span></code> </pre><br>  Great, we can view, edit does not.  But not everything is so smooth: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> get_db_mode(); +<span class="hljs-comment"><span class="hljs-comment">---------------+ | get_db_mode() | +---------------+ | edit | +---------------+ 1 row in set (0.00 sec)</span></span></code> </pre><br>  After the error, the AFTER trigger did not work and did not remove the edit mode.  Now having made SELECT we will see only those lines which we can edit. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs; +<span class="hljs-comment"><span class="hljs-comment">----+------------------+--------+ | id | warehouse_org_id | sum | +----+------------------+--------+ | 2 | 2 | 105000 | +----+------------------+--------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br>  One solution is try ... catch PDO in php and force SET @db_mode = 'show' on any error <br><br><div class="spoiler">  <b class="spoiler_title">Scripts for deleting test objects</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> organizations; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> user_access; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> t_docs; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> get_db_mode;</code> </pre> </div></div><br>  Now, all the access control logic is very easy to put in one VIEW.  According to the same scheme, it is easy to implement various access on INSERT / UPDATE / DELETE operations. </div><p>Source: <a href="https://habr.com/ru/post/310832/">https://habr.com/ru/post/310832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310820/index.html">How to use the Mongoose schema to generate graphQL types</a></li>
<li><a href="../310824/index.html">Principles of reactive programming using a simple RSS aggregator using ReactiveX for Python</a></li>
<li><a href="../310826/index.html">Unit testing in complex applications</a></li>
<li><a href="../310828/index.html">SMS sending using jSMPP methods UDH, SAR, Payload</a></li>
<li><a href="../310830/index.html">How to get the most out of code minification</a></li>
<li><a href="../310834/index.html">Protection of digital content: how to apply DMCA and not go on the path of litigation?</a></li>
<li><a href="../310836/index.html">Functional safety, Part 3 of 7. IEC 61508: Systematic randomness or random systematicity?</a></li>
<li><a href="../310838/index.html">As MegaFon and Nokia in Nizhny Novgorod, 5G networks demonstrated</a></li>
<li><a href="../310842/index.html">Intel tools for optimizing applications and the problem of flows in porous media</a></li>
<li><a href="../310844/index.html">Development extensions for firefox, or my first experience, on the example of a screenshot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>