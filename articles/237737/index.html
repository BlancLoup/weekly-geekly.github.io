<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why don't you need sshd in a Docker container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When people launch their first Docker container, they often ask: ‚ÄúHow do I get into the container?‚Äù And answer ‚Äúon the forehead‚Äù to this question, of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why don't you need sshd in a Docker container</h1><div class="post__text post__text-html js-mediator-article"><img src="http://habrastorage.org/files/127/596/984/12759698427a46649098eabe505675e7.png" align="right">  When people launch their first Docker container, they often ask: ‚ÄúHow do I get into the container?‚Äù And answer ‚Äúon the forehead‚Äù to this question, of course: ‚ÄúSo launch an SSH server in it and connect!‚Äù.  The purpose of this topic is to show that you really do not need sshd inside your container (well, of course, except when your container itself is intended to encapsulate an SSH server). <br><br>  Starting an SSH server is a tempting idea, as it gives quick and easy access "inside" the container.  Everyone knows how to use SSH-clients, we do it every day, we are familiar with access by passwords and by keys, port forwarding, and, in general, access via SSH is a well-known thing that will work for sure. <br><br>  But let's think again. <br><a name="habracut"></a><br>  Let's imagine that you are building a Docker image for Redis or a Java web service.  I would like to ask you some questions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Why do you need ssh?</b> <br>  Most likely you want to make backups, check logs, maybe restart processes, edit settings, debug something with gdb, strace or similar utilities.  So, this can be done without SSH. <br><br>  <b>How will you manage your keys and passwords?</b> <br>  There are not many options - either you sew them tightly into an image, or you can put them on an external volume.  Think about what you need to do to update keys or passwords.  If they are stitched, you will have to rebuild the image, redo it, restart the containers.  Not the end of the world, but somehow not elegant.  Significantly the best solution is to put the data on the external volume and control access to it.  This works, but it is important to check that the container does not have access to write to this volume.  After all, if the access is - the container can damage the data, and then you can not connect via SSH.  Worse, if one volume is used as a means of storing data for authentication in several containers, you will lose access to all of them at once.  But this is only if you use SSH access everywhere. <br><br>  <b>How will you manage security updates?</b> <br>  An SSH server is actually quite a reliable thing.  But all the same, this is a window to the outside world.  So we will need to install updates, monitor security.  Those.  in any innocuous container itself, we will now have an area potentially vulnerable to outside cracking and requiring attention.  We have created a problem for ourselves. <br><br>  <b>Is it enough to ‚Äújust add an SSH server‚Äù for everything to work?</b> <br>  Not.  Docker manages and oversees one process.  If you want to manage multiple processes inside a container, you need something like Monit or Supervisor.  They also need to be added to the container.  Thus, we transform the simple concept of ‚Äúone container for one task‚Äù into something complex that needs to be built, updated, managed and maintained. <br><br>  <b>You are responsible for creating a container image, but are you also responsible for managing container access policies?</b> <br>  In small companies, it does not matter - most likely you will perform both functions.  But when building a large infrastructure, most likely one person will create images, and completely different people will be involved in managing access rights.  It means that sticking an SSH server into a container is not the best way. <br><br><h4>  <b>But how can I ...</b> </h4><br><br><h5>  <b>Make backups?</b> </h5><br>  Your data should be stored on an external volume.  After that you can start another container with the option --volumes-from, which will have access to the same volume.  This new container will be specifically for performing data backup tasks.  Separate profit: in the case of updating / replacing backup tools and data recovery, you do not need to update all the containers, but only the one that is designed to perform these tasks. <br><br><h5>  <b>Check logs?</b> </h5><br>  Use an external volume!  Yes, the same decision again.  Well, what can you do if it fits?  If you write all the logs to a specific folder, and it is on the external volume, you can create a separate container (‚Äúlog inspector‚Äù) and do everything you need in it.  Again, if you need any special tools for analyzing the logs - you can install them in this separate container without littering the original one. <br><br><h5>  <b>Restart my service?</b> </h5><br>  Any properly designed service can be restarted using signals.  When you execute the <b><i>foo restart</i></b> command, it almost always sends a specific signal to the process.  You can send a signal using the <b><i>docker kill -s command</i></b> .  Some services do not respond to signals, but accept commands, for example, from a TCP socket or a UNIX socket.  You can connect to a TCP socket from the outside, and for a UNIX socket, again, use an external volume. <br><br>  <b>‚ÄúBut this is all difficult!‚Äù</b> - no, not really.  Let's imagine that your foo service creates a socket in <b><i>/var/run/foo.sock</i></b> and requires you to run <b><i>fooctl restart</i></b> for a proper restart.  Just start the service with <b><i>-v / var / run</i></b> (or add the <b><i>/ var / run</i></b> volume to the Dockerfile).  When you want to restart the service, run the same image, but with the <b><i>--volumes-from</i></b> key.  It will look something like this: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   CID=$(docker run -d -v /var/run fooservice) #       docker run --volumes-from $CID fooservice fooctl restart</span></span></code> </pre> <br><br><h5>  <b>Edit configuration?</b> </h5><br>  First, you should distinguish the operational configuration changes from the fundamental.  If you want to change something significant, which should affect all future containers launched on the basis of this image - the change must be sewn into the image itself.  Those.  in this case, you do not need an SSH server, you need to edit the image.  ‚ÄúBut what about operational changes?‚Äù You ask.  ‚ÄúAfter all, I may need to change the configuration in the course of my service, for example, add virtual hosts to the web server config?‚Äù.  In this case, you need to use ... wait, wait ... external volume!  The configuration should be on it.  You can even pick up a special container with the role of ‚Äúconfigs editor‚Äù, if you want, install your favorite editor there, plug-ins for it, anything.  And this all will not affect the base container. <br>  ‚ÄúBut I only make temporary edits, experiment with different values ‚Äã‚Äãand look at the result!‚Äù  Ok, for the answer to this question read the following section. <br><br><h5>  <b>Debug my service?</b> </h5><br>  And so we got to the case where you really need a real console access "inside" of your container.  You need to run gdb, strace somewhere, edit the configuration, etc.  And in this case you need <b><i>nsenter</i></b> . <br><br><h4>  <b>What is nsenter</b> </h4><br>  <b><i>nsenter</i></b> is a small utility that allows you to get inside namespaces ( <a href="http://blog.dotcloud.com/under-the-hood-linux-kernels-on-dotcloud-part">namespaces</a> ).  Strictly speaking, it can both enter already existing namespaces and launch processes in new namespaces.  "What kind of namespace are we talking about?"  This is an important concept associated with Docker containers, allowing them to be independent of each other and of the parent operating system.  If you don‚Äôt go into details: with <b><i>nsenter</i></b> you can get console access to an existing container, even if there is no SSH server inside it. <br><br><h5>  <b>Where to get nsenter?</b> </h5><br>  From GitHub: <a href="https://github.com/jpetazzo/nsenter">jpetazzo / nsenter</a> .  Can run <br><pre> <code class="bash hljs">docker run -v /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin:/target jpetazzo/nsenter</code> </pre><br><br>  This will install the <b><i>nsenter</i></b> in <b><i>/ usr / local / bin</i></b> and you can immediately use it.  In addition, in some distributions <b><i>nsenter is</i></b> already embedded. <br><br><h5>  <b>How to use it?</b> </h5><br>  First, find out the PID of the container you want to get inside: <br><pre> <code class="bash hljs">PID=$(docker inspect --format {{.State.Pid}} &lt;container_name_or_ID&gt;)</code> </pre><br><br>  Now go to the container: <br><pre> <code class="bash hljs">nsenter --target <span class="hljs-variable"><span class="hljs-variable">$PID</span></span> --mount --uts --ipc --net --pid</code> </pre><br><br>  You will get a console access "inside" the container.  If you want to immediately run a script or program, add them with an argument to <b><i>nsenter</i></b> .  It works a bit like <b><i>chroot</i></b> , with the only difference being with regards to containers, and not just directories. <br><br><h5>  How about remote access? </h5><br><br>  If you need remote access to the docker, you have at least two ways to do this: <br><ul><li>  SSH to the host machine, and then use <b><i>nsenter</i></b> </li><li>  SSH on a host machine with a special key that makes it possible to run a certain command (in our case, <b><i>nsenter</i></b> ) </li></ul><br><br>  The first way is quite simple, but it requires root rights on the host machine (which is not very good from the security point).  The second way involves the use of the special feature " <b><i>command</i></b> " SSH authorization keys.  You must have seen the ‚Äúclassic‚Äù <b><i>authorized_keys</i></b> like this: <br><br><pre> <code class="bash hljs">ssh-rsa AAAAB3N‚Ä¶QOID== jpetazzo@tarrasque</code> </pre><br>  (Of course, the real key is much longer.) That‚Äôs where you can specify a specific command.  If you want to allow a certain user to check the amount of free RAM on your machine using SSH access, but do not want to give him full access to the console, you can write the following to <i><b>authorized_keys</b></i> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"free"</span></span> ssh-rsa AAAAB3N‚Ä¶QOID== jpetazzo@tarrasque</code> </pre><br><br>  Now, when the user connects using this key, the free command will be immediately launched.  And nothing else can be started.  (Technically, you might want to add <b><i>no-port-forwarding</i></b> , see the details in the manpage for <b><i>authorized_keys</i></b> ).  The idea of ‚Äã‚Äãthis mechanism in the separation of powers and responsibilities.  Alice creates container images, but does not have access to production servers.  Betty has the right to remote access for debugging.  Charlotte - only to view the logs.  Etc. <br><br><h4>  <b>findings</b> </h4><br>  Is it really that awful to launch an SSH server in each Docker container directly?  Let's be honest - this is not a disaster.  Moreover, it may even be the only option when you do not have access to the host system, but you certainly need access to the container itself.  But, as we saw from the article, there are many ways to do without an SSH server in the container, having access to all the necessary functionality and at the same time getting a very more elegant system architecture.  Yes, in the docker, you can do both.  But before turning your Docker-container into such a ‚Äúmini-VPS‚Äù, make sure that this is really necessary. </div><p>Source: <a href="https://habr.com/ru/post/237737/">https://habr.com/ru/post/237737/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237725/index.html">Localization of applications for the Chinese market</a></li>
<li><a href="../237727/index.html">Resuscitate Ubuntu servers on Hetzner or some useful commands</a></li>
<li><a href="../237729/index.html">Progress of an abstract project in a vacuum: a random process model</a></li>
<li><a href="../237731/index.html">The Security Council today decided not to discuss Russia's disconnection from the Internet</a></li>
<li><a href="../237733/index.html">Javascript transducers. Part two</a></li>
<li><a href="../237739/index.html">California will allow unmanned vehicles to drive through busy streets</a></li>
<li><a href="../237741/index.html">New book ‚ÄúZero to One‚Äù released - Peter Thiel‚Äôs view on the startup world</a></li>
<li><a href="../237743/index.html">Bundle Transformer: Summer Updates</a></li>
<li><a href="../237745/index.html">Modern spam filters and end-to-end encryption</a></li>
<li><a href="../237747/index.html">Huawei has introduced an inexpensive smartphone Honor 4 Play</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>