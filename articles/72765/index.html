<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using V8 Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using V8 Part 3 

 Part 3. Multithreading, extensions and code design 

 Part 2 is here: habrahabr.ru/blogs/development/72592 

 Part 1 is here: habra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using V8 Part 3</h1><div class="post__text post__text-html js-mediator-article">  Using V8 Part 3 <br><br>  Part 3. Multithreading, extensions and code design <br><br>  Part 2 is here: <a href="http://habrahabr.ru/blogs/development/72592/">habrahabr.ru/blogs/development/72592</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Part 1 is here: <a href="http://habrahabr.ru/blogs/development/72474/">habrahabr.ru/blogs/development/72474</a> <br><br><a name="habracut"></a><br><br>  - <b>Multithreading</b> <br><br>  Multithreading is implemented in V8 simply: it is not.  At all.  Only one thread can use V8 at some point in time, and ‚Äúusing‚Äù means not necessarily compiling or running javascript, but everything else ‚Äî creating templates, placing objects on a V8 stack, etc. <br><br>  Let's try to sweeten this barrel of tar with a couple of spoons of honey. <br><br>  This architectural solution is not, of course, a consequence of the underdevelopment of programmers from Google.  The main purpose of the V8 is a client application - the Chrome browser, which runs a separate process on each individual tab.  The same scheme should follow the server application.  Our server product uses so-called.  "Work" processes that are named pipe join the main process and receive messages for processing.  This allows you to fully load multi-core systems and use the actual Windows process manager to switch tasks. <br><br>  From time to time in the V8 discussion groups there are people who want "real" multi-site.  And they are ready to edit the source code of Google long and hard.  Usually, the result of these discussions is the following conclusion: it is very difficult and only by Google developers to turn the current V8 code into multi-threaded.  You can learn more, for example, here (English and you must be a member of the Google v8-users group): <a href="http://groups.google.ru/group/v8-users/browse_thread/thread/44621a6efef0104f">groups.google.com/group/v8-users/browse_thread/thread/44621a6efef0104f</a> <br><br>  However, one thread V8 can dispose of smarter.  For the sole ‚Äúcapture‚Äù of the V8, you can use the usual critical section of Windows, but it is better to use the tool of the V8 itself: the Locker class.  The designer of this class is trying to ‚Äúcapture‚Äù the V8 (while awaiting its release), and the destructor ‚Äúreleases‚Äù the V8.  Thus, code using V8 and working safely in a multi-application will look something like this: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">{ <br> v8::Locker locker; <br> <font color="#008000">//  V8</font> <br> <font color="#008000">// ...</font> <br> } <br> <font color="#008000">// V8  ""</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The problem is that very often from javascript code we will call our C ++ code.  For example, our dblite class from part 2 of this article works with a database.  Obviously, during its operation, the V8 is idle in general, for nothing - because our C ++ code most of the time does not interact with the V8, but deals with input / output. <br><br>  So, the good news is that the V8 provides the Unlocker class, which allows you to ‚Äúrelease‚Äù the V8 for a while.  The Unlocker class in the constructor ‚Äúreleases‚Äù the V8, and in the destructor it ‚Äúcaptures‚Äù again (as opposed to the Locker class).  The beauty is that Locker can be invested in each other and Unlocker knows and will work it out correctly, that is, it will release the V8 regardless of the depth of the Locker. <br><br>  This can be illustrated by correcting our example from part 2 of an article with the dblite class.  Let's rewrite the Open function taking into account new knowledge: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Handle&lt;Value&gt; Open( <font color="#0000ff">const</font> Arguments&amp; args) <br> { <br> <font color="#0000ff">if</font> (args.Length() &lt; 1) <font color="#0000ff">return</font> Undefined(); <font color="#008000">//  ? !</font> <br> dblite* db = unwrap_dblite(args.This()); <font color="#008000">//    dblite</font> <br> <font color="#0000ff">string</font> sql = to_string(args[0]); <font color="#008000">//    C++,  to_string      </font> <br> <font color="#0000ff">bool</font> r; <br> { <br> Unlocker unlocker; <font color="#008000">//  V8        </font> <br> r = db-&gt;open(sql.data()); <font color="#008000">//  C++    </font> <br> } <font color="#008000">//  unlocker " " V8</font> <br> <font color="#0000ff">return</font> Boolean::New(r); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now, Open () ‚Äútakes‚Äù V8 only for the time it interacts with V8, and all I / O can be done in another thread. <br><br>  A small lyrical digression.  During the exploration of Unlocker features, I came across a bug, as a result of which a simple program using V8 lost 100 MB per second.  To its credit, Guglovtsev must be said that the problem was solved very quickly.  Currently in the trunk branch, this error has already been fixed and the issue is closed.  Details here (English): <a href="http://code.google.com/p/v8/issues/detail%3Fid%3D444">code.google.com/p/v8/issues/detail?id=444</a> <br><br>  V8 is able in a primitive way to switch between threads that are trying to capture the sole access to V8 through Locker.  There is a call to Locker :: StartPreemption ().  Perhaps this solution at some point will be more convenient than others. <br><br>  - <b>Extensions and code design</b> <br><br>  Critics of the V8 blame him (besides monotransferability) and in a too ‚Äúspreading‚Äù binding code.  Indeed, the designs are a bit cumbersome, and Google provided the matter at the mercy of the programmers themselves.  The situation is further aggravated by the need to declare a large number of callback functions of the same type; if you make them ordinary functions in the global scope, then a jumble is also provided. <br><br>  The simplest solution for V8 classes wrapping C ++ classes might look like this: we declare a special C ++ class - a wrapper.  Callback functions make it static methods.  The object template must be stored in a single copy, so we also make it static.  By analogy with the V8, we start the New function.  It might look something like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> ScriptDatabase <br> { <br> <br> <font color="#008000">//    JavaScript  dblite</font> <br> <br> <font color="#008000">// </font> <br> <font color="#0000ff">static</font> Handle&lt;Value&gt; Open( <font color="#0000ff">const</font> Arguments&amp; args); <br> <font color="#0000ff">static</font> Handle&lt;Value&gt; Execute( <font color="#0000ff">const</font> Arguments&amp; args); <br> <font color="#0000ff">static</font> Handle&lt;Value&gt; Select( <font color="#0000ff">const</font> Arguments&amp; args); <br> ... <br> <br> <font color="#008000">// </font> <br> <font color="#0000ff">static</font> Handle&lt;Value&gt; ErrorCode(Local&lt; <font color="#2B91AF">String</font> &gt; name, <font color="#0000ff">const</font> AccessorInfo&amp; info); <br> ... <br> <br> <font color="#008000">//   js- obj      C++ ScriptDatabase</font> <br> <font color="#0000ff">static</font> dblite* Unwrap(Handle&lt;Object&gt; obj); <br> <br> <font color="#008000">//      </font> <br> <font color="#0000ff">static</font> Persistent&lt;Object&gt; New( <font color="#0000ff">const</font> <font color="#0000ff">char</font> * db_name = 0); <br> <br> <font color="#008000">//   ,  </font> <br> <font color="#0000ff">static</font> Handle&lt;Value&gt; Create( <font color="#0000ff">const</font> Arguments&amp; args); <br> <br> }; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As for the templates, there is, of course, a lot of room for creativity.  And of course there are already some solutions.  You can see, for example, the cproxyv8 project: <a href="http://code.google.com/p/cproxyv8/">code.google.com/p/cproxyv8</a> <br>  This is how code can come up using cproxyv8: <a href="http://code.google.com/p/cproxyv8/wiki/Usage">code.google.com/p/cproxyv8/wiki/Usage</a> <br><br>  There are other projects that simplify the use of V8.  For example, v8-juice: <a href="http://code.google.com/p/v8-juice/">code.google.com/p/v8-juice</a> <br>  v8-juice offers an API for loading the functionality of an arbitrary DLL into javascript (http://code.google.com/p/v8-juice/wiki/Plugins), as well as a convenient way to convert V8 type to C ++ type (http: // code .google.com / p / v8-juice / wiki / ConvertingTypes).  And something else. <br><br>  I must warn you that these are third-party projects and you will use them at your own risk.  In my decision, I only managed the code from Google, because I had not yet stumbled upon these extensions when I started.  Perhaps now I would use something ... <br><br></div><p>Source: <a href="https://habr.com/ru/post/72765/">https://habr.com/ru/post/72765/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72756/index.html">The robotics revolution begins!</a></li>
<li><a href="../72757/index.html">Abstract classes and interfaces in Python</a></li>
<li><a href="../72761/index.html">Fujitsu's first lifebook netbook</a></li>
<li><a href="../72762/index.html">How to scare the user?</a></li>
<li><a href="../72764/index.html">interesting bug in IE7 (or feature)</a></li>
<li><a href="../72767/index.html">Patterns & Practices Summary: SharePoint Guidance</a></li>
<li><a href="../72768/index.html">Obder.ru - Accounting for the payment of meals and any common expenses</a></li>
<li><a href="../72769/index.html">Every man to his own taste</a></li>
<li><a href="../72773/index.html">Empty text nodes in Internet Explorer</a></li>
<li><a href="../72774/index.html">The first photos of the Android-smartphone HTC Dragon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>