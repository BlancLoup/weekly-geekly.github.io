<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load testing with locust. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The final article about the tool for load testing Locust. Today I will share the observations that have accumulated in the process. As always, the vid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load testing with locust. Part 3</h1><div class="post__text post__text-html js-mediator-article">  The final article about the tool for load testing Locust.  Today I will share the observations that have accumulated in the process.  As always, the video is attached. <br><br>  Part 1 - <a href="https://habr.com/company/infopulse/blog/430502/">Testing with Locust</a> <br>  Part 2 - <a href="https://habr.com/company/infopulse/blog/430810/">Advanced Scenarios</a> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/kTszeHar0tc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><h2>  Authorization </h2><br>  When writing my first tests with Locust, I was faced with the need to log in on one resource, having received an authorization token, which I would later use in load testing.  Then the question immediately arose - how to do it, because the tool is sharpened to send all requests to one resource, which we specify in the console when the test is run.  There are several solutions to the problem: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  disabling authorization on the tested resource - if there is such a possibility </li><li>  generate a token in advance and attach it to the test code before launch - the weakest option that requires manual labor at each launch, but has the right to exist in some rare cases </li><li>  send a request using the requests library and get the token from the answer - good, the syntax is the same </li></ul><br>  I chose the third option.  Below I propose a converted example from the first article with different possibilities of obtaining a token.  As the authorization server will google.com and, so <br>  as there is no token, I will get the simplest values <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> locust <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HttpLocust, TaskSet, task <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserBehavior</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TaskSet)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> response = requests.post(<span class="hljs-string"><span class="hljs-string">"http://mysite.sample.com/login"</span></span>, {<span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"ellen_key"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"education"</span></span>}) <span class="hljs-comment"><span class="hljs-comment"># get "token" from response header self.client.headers.update({'Authorization': response.headers.get('Date')}) # get "token" from response cookies self.client.cookies.set('Authorization', response.cookies.get('NID')) # get "token" from response body self.client.headers.update({'Authorization': str(response.content.decode().find('google'))})</span></span></code> </pre> <br>  As you can see from the example, before starting work, the user sends a request to a third-party server and processes the response, placing the data in headers or cookies. <br><br><h2>  Headers </h2><br>  When working with request headers, there are several important points to consider. <br>  For each separate request, you can specify your own set of headers as follows <br><br><pre> <code class="python hljs">self.client.post(url=<span class="hljs-string"><span class="hljs-string">'/posts'</span></span>, data=<span class="hljs-string"><span class="hljs-string">'hello world'</span></span>, headers={<span class="hljs-string"><span class="hljs-string">'hello'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>})</code> </pre> <br>  When executing this example, the hello header will be added to the already existing client session headers, but only in this query - it won't be in all the following ones.  To make the title permanent, you can add it to the session: <br><br><pre> <code class="python hljs">self.client.headers.update({<span class="hljs-string"><span class="hljs-string">'aaa'</span></span>: <span class="hljs-string"><span class="hljs-string">'bbb'</span></span>})</code> </pre> <br>  Another interesting observation is that if we specify in the request a header that is already in the session, it will be overwritten, but only to this request.  So you can not be afraid to accidentally wipe something important. <br><br>  But there are exceptions.  If we need to send a <b>multipart</b> form, the request will automatically form a <b>Content-Type</b> header, in which the form data separator will be specified.  If we forcefully rewrite the header with the help of the <b>headers</b> argument, then the request will fail, since the form cannot be correctly processed. <br><br>  It is also worth noting that all headers are required strings.  If you try to specify a number, for example <b>{'aaa': 123}</b> , the request will not be sent and the code will throw an <b>InvalidHeader</b> exception <br><br><h2>  Distributed testing </h2><br>  For distributed testing, locust provides several CLI arguments: <i>--master</i> and <i>--slave</i> , for clearly defining roles.  At the same time the machine with the master will not simulate the load, but only collect statistics and coordinate the work.  Let's try to start our test server and several sessions in distributed mode by executing commands in different consoles: <br><br><pre> <code class="bash hljs">json-server --watch sample_server/db.json locust -f locust_files\locust_file.py --master --host=http://localhost:3000 locust -f locust_files\locust_file.py --slave --master-host=localhost locust -f locust_files\locust_file.py --slave --master-host=localhost</code> </pre> <br><br>  Open the locust in the browser ( <a href="http://localhost:8089/">localhost: 8089</a> ), you can note that in the upper right corner we have the number of machines that will carry out the load <br><br><img src="https://habrastorage.org/webt/2m/8y/vn/2m8yvn-aqndmeva7w-impc9qdds.png"><br><br><h2>  Testing without UI </h2><br>  When all the tests are written and debugged, it would be nice to include them in the regression automated testing and simply check the results periodically.  With the following command, you can run the locust test without UI: <br><br><pre> <code class="bash hljs">locust -f locust_files\locust_file.py --host=http://localhost:3000 --no-web -c 10 -r 2 --run-time 1m --csv=test_result</code> </pre> <br>  Where <br><br><ul><li>  <i>--no-web</i> argument to run tests without UI </li><li>  <i>-c 10</i> - the maximum number of users </li><li>  <i>-r 2</i> - user growth per second </li><li>  <i>--run-time 1m</i> - test run time (1 minute) </li><li>  <i>--csv = test_result</i> - after running the test, 2 csv files with results will be created in the current folder, their names begin with test_result </li></ul><br><h2>  Final facts, observations and conclusions </h2><br>  Distributed testing can be combined with regression testing - in order to ensure that all the nodes for the load have started, you can add the argument <i>--expect-slaves = 2</i> on the master, in which case the test will start only when at least 2 nodes are started. <br><br>  I faced a situation a couple of times - the tested resource works only on HTTPS, while the certificate was generated by the customer and the operating system marks it as suspicious.  For the tests to work successfully, you can add an argument to all requests that ignores the security check, for example: <br><br><pre> <code class="python hljs">self.client.get(<span class="hljs-string"><span class="hljs-string">"/posts"</span></span>, verify=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre> <br>  Since I can not always be sure in which environment the tests will be run, I always specify this argument. <br><br>  That's all what I wanted to share.  For myself, I discovered a simple and convenient tool with great testing capabilities and variations in creating requests and processing server responses.  Thank you for reading to the end. </div><p>Source: <a href="https://habr.com/ru/post/433304/">https://habr.com/ru/post/433304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433294/index.html">A few simple teamwork recommendations.</a></li>
<li><a href="../433296/index.html">Financial management in an IT company</a></li>
<li><a href="../433298/index.html">Network Digest: 17 expert materials on Wi-Fi and 5G</a></li>
<li><a href="../433300/index.html">Creating a home media center. Prologue</a></li>
<li><a href="../433302/index.html">First Rust Steps</a></li>
<li><a href="../433306/index.html">Visual studio 2019</a></li>
<li><a href="../433308/index.html">Transferring PBX configuration to 3CX PBX Express service</a></li>
<li><a href="../433316/index.html">Design Digest: onboarding, feedback, search for ideas and decision making</a></li>
<li><a href="../433318/index.html">garbage.collect ()</a></li>
<li><a href="../433320/index.html">Grid Layout as the basis of modern layouts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>