<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a simple web page parser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. My name is Serezha. I want to talk about how I wrote the simplest web spider. 

 Since this is a non-commercial project created solely on my en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a simple web page parser</h1><div class="post__text post__text-html js-mediator-article">  Hello.  My name is Serezha.  I want to talk about how I wrote the simplest web spider. <br><img src="https://habrastorage.org/getpro/habr/post_images/764/284/4f1/7642844f10ac5d7e682085314a45edd2.jpg" alt="image"><br>  Since this is a non-commercial project created solely on my enthusiasm, I was guided by the following when working: <br><br>  <strong>1.</strong> Minimum of necessary functions (web scanning, saving necessary in DB, simple UI for access) <br>  <strong>2.</strong> 0 financial costs: <br>  - I use a netbook as a server, which I bought acer aspare ONE KAV60 in my time to study, quite budget even at the time of purchase (2008), now its 1600 MHz atom processor is not enough even for normal operation in MS OFFICE <br>  - Internet - wired home.  The benefit of IP has not changed for half a year, I did not have to order static <br>  <strong>3.</strong> Minimum time costs.  The project was done after work and giving. <br><a name="habracut"></a><br>  As software used: <br><br><ul><li>  OS XUBUNTU </li><li>  NgINX server </li><li>  nodeJS </li><li>  MySQL DBMS </li><li>  For UI: jQuery, bootstrap3 </li></ul><br>  There is a popular entertainment resource in runet (let's call it Picaba - I don‚Äôt give a link, so that it‚Äôs not considered advertising).  It is an entertainment post posted by users and comments.  The moderators of the resource are tough (in my opinion, sometimes even a chur) follow the content of comments.  As a result of their work, you often see the following instead of a comment: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/2c6/346/818/2c6346818ddd4619923d3ef572f64b9c.jpg" alt="image"><br><br>  Our robot will, at certain intervals, scan the resource in search of new comments that will be added to the database, so that you can always see what the moderator did not like. <br><br>  We will need the following modules: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsdom = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"jsdom"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mysql = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mysql'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CronJob = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cron'</span></span>).CronJob;</code> </pre> <br>  Our robot will be based on 2 functions: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// * * *     function get_links(){ jsdom.env('http://pikabu.ru',function(err, window){ if (err) return false; var page = window.document.getElementsByClassName('to-comments') for (var i=0; i&lt;page.length; i+=2) get_comments(page[i].getAttribute('href')); }) }</span></span></code> </pre> <br>  With this function we request the main page of the resource and look for elements with the class ".to-comments".  They contain links to pages with comments.  As these elements go together, we need only every second. <br><br>  In this function, the <a href="https://github.com/tmpvar/jsdom">jsdom</a> module helps us a <a href="https://github.com/tmpvar/jsdom">lot</a> .  It converts html code to a DOM tree, in which we can easily find the desired item. <br><br>  As we can see, this function calls get_comments (). <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_comments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">)</span></span>{ jsdom.env(link,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, window</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comment = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document.getElementsByClassName(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;comment.length; i++){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = comment[i].getAttribute(<span class="hljs-string"><span class="hljs-string">'data-id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> author = comment[i].getElementsByClassName(<span class="hljs-string"><span class="hljs-string">'post_author'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].textContent; <span class="hljs-comment"><span class="hljs-comment">//    var block = comment[i].getElementsByClassName('comment_text')[0].getElementsByTagName('span'); if (block.length &gt; 0 &amp;&amp; block[0].textContent.substr(0,11)==''){ console.log(block[0].baseURI+'#comment_'+id); continue} var com = comment[i].getElementsByClassName('comment_text')[0].outerHTML.replace(/"/g, '"').replace(/\n|\t/g, '').replace('previews_gif_comm', 'big_size_comm_an'); var query = 'INSERT IGNORE comments (id, user, comment) VALUES ('+id+', "'+author+'", "'+com+'")'; DBconnection.query(query, function(err, rows, fields) { if (err) throw err; }); } console.log(new Date()+' DATA ADDED...'); }); }</span></span></code> </pre> <br>  Here we also go over the tree, look for elements with the ‚Äúcomment‚Äù class, select the necessary elements from them: comment id, author, weed out deleted comments, remove special characters, slightly alter the code (remove thumbnails) and put all this in the database.  In the comments table, the id field is unique, so mySQL itself ensures that there are no duplicate comments. <br><br>  It remains for us to start a timer that awakens the robot every 5 minutes.  In node.JS, this can be implemented using the <a href="https://github.com/ncb000gt/node-cron">croneJob</a> module, an analogue of the crone scheduler in linux. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> job = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CronJob(<span class="hljs-string"><span class="hljs-string">'*/5 * * * *'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ get_links(); }); job.start();</code> </pre> <br>  That's all for now.  Our spider learned to climb a resource and save comments.  If you want, I can write an article about the web interface to this robot or about the chrome plugin for this robot. </div><p>Source: <a href="https://habr.com/ru/post/309428/">https://habr.com/ru/post/309428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309416/index.html">New security features Android 7</a></li>
<li><a href="../309420/index.html">Gentleman's set of R packages for automating business tasks</a></li>
<li><a href="../309422/index.html">React patterns</a></li>
<li><a href="../309424/index.html">Dear startups, stop math tasks to understand if I can program</a></li>
<li><a href="../309426/index.html">The role of content in website promotion and customer acquisition</a></li>
<li><a href="../309430/index.html">30 lightweight javascript plugins and libraries</a></li>
<li><a href="../309432/index.html">Partner Workshop "1C" - Open Sunday</a></li>
<li><a href="../309434/index.html">Agile negotiations</a></li>
<li><a href="../309436/index.html">Did not put favicon on the site - get double traffic from Chrome</a></li>
<li><a href="../309438/index.html">Panoramic overview: How to evaluate employee performance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>