<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Customize your room Service Bus for Windows Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is quite often necessary to link together several disparate systems, or to ensure their synchronization. Of course, cases are different and unique,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Customize your room Service Bus for Windows Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5e8/d46/08d/5e8d4608d75f40fe8c733a9bbfcd63e2.png"><br><br>  It is quite often necessary to link together several disparate systems, or to ensure their synchronization.  Of course, cases are different and unique, however, writing your own solution is usually quite expensive, both in time and in resources. <br><br>  Among the major companies, perhaps, you can select cloud solutions from Amazon (SQS) and Microsoft (Service Bus).  However, despite the rapid development of the Public Cloud, such solutions are not always applicable, what is called On-Premises.  In other words, there is a need for such solutions, but on their own closed areas.  In this regard, Microsoft made a sensible step by making the Service Bus available in the Private Cloud, or on at least one machine with installed Windows 7 and higher.  In the version of Service Bus 1.0, management via PowerShell was available, and with release 1.1 it was possible to integrate into the Azure Pack console. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will try to describe the process of setting up the Service Bus for Windows Server in as much detail as possible, in pictures.  Since it is better to see the whole process once, than several times to read in parts in different sources. <br><br>  <b>Caution traffic!</b>  Under the cut a lot of pictures. <br><a name="habracut"></a><br>  So, <a href="http://azure.microsoft.com/ru-ru/services/service-bus/">Azure Service Bus</a> is a cloud-based universal messaging system. <br><br>  In order to understand what functionality it has, let's recall a few patterns from the category of <i>Messaging</i> . <br>  One of the best books on this topic, in my subjective opinion, is <a href="http://www.amazon.com/o/asin/0321200683/ref%3Dnosim/enterpriseint-20">Enterprise Integration Patterns: Designing, Building, and Deploying Messaging Solutions</a> (translation: <a href="http://www.ozon.ru/context/detail/id/3083192/">Enterprise Application</a> <a href="http://www.amazon.com/o/asin/0321200683/ref%3Dnosim/enterpriseint-20">Integration Patterns) aligns the</a> following patterns: <br><br>  Point-to-Point Channel <br><br>  <i>A point-to-point channel</i> ensures that each individual message will be consumed by only one recipient.  A channel can have many recipients at the same time processing messages, but only one of them can successfully receive a particular message.  If several recipients try to consume a message at the same time, the channel itself will ensure that this operation succeeds only one of them.  Coordinate the actions of the recipient is not necessary. <br><br>  If the <i>point-to-point channel has</i> only one recipient, the message will be consumed only once.  If the channel is tapped by multiple recipients, they become <i>competing consumers</i> ( <i>Competing Consumers</i> ), and the channel guarantees that the message will be received by only one of them.  This scheme of message consumption and processing is perfectly scalable, since the workload per channel can be distributed among several consumers running within several applications on several computers. <br><br>  If the message is to be received not by one, but by all recipients who listen to the channel, use <i>the ‚Äúpublish-subscribe‚Äù channel</i> . <br><br><img src="https://habrastorage.org/files/b73/16a/727/b7316a7275634243b9a4d4df34101f25.png"><br><br>  Publish-Subscribe Channel <br><br>  The publish-subscribe channel functions as follows: it has one input channel, which is divided into several output channels, one for each subscriber.  When a message is published on a channel, the publish-subscribe channel delivers a copy of the message to each of the output channels.  There is only one subscriber at each output of the channel who is allowed to consume the message only once.  Due to this, each subscriber will receive a message only once, after which the consumed copies of the message will disappear from the corresponding output channels. <br><br><img src="https://habrastorage.org/files/7dc/132/1c1/7dc1321c1ea749f4bfe780517955856d.png"><br><br>  Invalid Message Channel <br><br>  Messages that have an incorrect format or that do not contain the fields required for this channel cannot be processed correctly, however, formally, they are delivered.  In this case, the recipient can move these messages to <i>the invalid message channel</i> for the subsequent diagnosis of the problem. <br><br>  In the absence of tools to work with invalid messages: <br><br><img src="https://habrastorage.org/files/81c/f5f/01e/81cf5f01e0464cf2bb26f77dedef3388.png"><br><br>  In the case of a <i>channel of invalid messages</i> : <br><br><img src="https://habrastorage.org/files/109/ec9/d12/109ec9d122e44cb5a67e91e1565bf0ae.png"><br><br>  Many messaging systems implement a similar concept called <i>the undelivered message channel</i> .  Unlike <i>the invalid message channel</i> , which contains messages that were successfully delivered and received but not processed, <i>the dead message channel</i> is for messages that could not be delivered by the messaging system. <br><br>  Dead Letter Channel <br><br>  Once the messaging system determines that it cannot deliver the message, it must decide what to do with it.  The message can either be deleted or redirected to the <i>channel of undelivered messages</i> . <br><br><img src="https://habrastorage.org/files/f09/7ec/4df/f097ec4dfcaa4da6b396ac57e827d805.png"><br><br>  Guaranteed Delivery <br><br>  Under the guaranteed delivery they understand the ability to send a message to the recipient in asynchronous mode with a guarantee of either only successful receipt or correct notification of the impossibility of delivery. <br><br><img src="https://habrastorage.org/files/40a/96e/b64/40a96eb64aa34c279b51e11ed2cedf77.png"><br><br>  Message Bus <br><br>  The message bus is a combination of a canonical data model, a standard set of commands, and a messaging infrastructure that allows different systems to communicate with each other through a common set of interfaces. <br><br><img src="https://habrastorage.org/files/f7c/288/02b/f7c28802b91c4d328c179427b6cd3537.png"><br><br>  All patterns listed above are implemented in Azure Service Bus: <br><br><ul><li>  <a href="http://azure.microsoft.com/ru-ru/documentation/articles/service-bus-dotnet-how-to-use-queues/">Queue</a> </li><li>  <a href="http://azure.microsoft.com/ru-ru/documentation/articles/service-bus-dotnet-how-to-use-topics-subscriptions/">Sections (Topic)</a> </li><li>  <a href="http://tomkerkhove.ghost.io/2015/01/07/automatically-dead-letter-expired-messages-in-azure-service-bus-how-it-works/">Dead-letter queue</a> </li></ul><br><br>  Now we understand what it is about.  The logical question is ‚Äúcan I have the same thing, but <s>under</s> my <s>desk</s> on my territory?‚Äù <br><br><img src="https://habrastorage.org/files/daf/dd2/223/dafdd2223fe74261924395c9988b7a91.jpg"><br><br>  Yes, you can, and absolutely free.  In order to start a Service Bus, you only need Windows 7+ and MS SQL Server 2012 Express +. <br>  If you want to manage the Service Bus through the easy-to-use Azure Pack GUI, you'll need Windows Server 2012+. <br><br>  <a href="https://msdn.microsoft.com/ru-ru/library/dn441412.aspx">Service Bus for Windows Server 1.1</a> can be downloaded through <a href="http://www.microsoft.com/web/downloads/platform.aspx">the Microsoft Web Platform Installer</a> . <br><br>  Download <a href="http://www.microsoft.com/ru-ru/server-cloud/products/windows-azure-pack/explore.aspx">Azure Pack</a> <a href="https://technet.microsoft.com/ru-ru/library/dn296435.aspx%3FCR_CC%3D200142594%26f%3D255%26MSPPError%3D-2147217396">from here</a> (Install Windows Azure Pack: Portal and API Express), or for a <a href="http://go.microsoft.com/%3Flinkid%3D9832690">direct link</a> . <br><br>  <b>How it works?</b> <br><br>  Service Bus in its work uses the database to store the infrastructure data and message containers (messages are evenly distributed between them).  The database server and service bus <b>can be</b> located on different machines. <br><br>  You can use Azure Pack to manage the Service Bus through the web interface.  Azure Pack <b>can</b> be on another machine, but for work it also needs a database, where it will store user data, etc. <br><br>  In my example, I will deploy three virtual machines that will hang on the Internet: <br><ul><li>  On the <b>first one</b> I‚Äôll deploy the database where the Service Bus will store the messages. </li><li>  On the <b>second</b> service bus. </li><li>  On the <b>third</b> Azure Pack and DB for it. </li></ul><br>  All the same can be deployed on the <b>same</b> machine. <br><br>  I will create the virtual machines in Microsoft Azure using the updated management portal. <br><br>  Before you start reading about the Service Bus and Azure Pack settings, I strongly recommend that you familiarize yourself with the terminology on official resources. <br><br>  <b>Configuring a virtual machine with a database</b> <br><br><div class="spoiler">  <b class="spoiler_title">Configuring a virtual machine with a database</b> <div class="spoiler_text">  Specify the host name and admin account information. <br><br><img src="https://habrastorage.org/files/be2/1a5/543/be21a5543eb94d2e8ba840bcb20c1da5.png"><br><br>  Set time and automatic updates <br><br><img src="https://habrastorage.org/files/a9f/005/37c/a9f00537cb644df1a44bddc03798763f.png"><br><br>  Create a virtual network: hello-habr-db <br><br><img src="https://habrastorage.org/files/d16/6c5/99f/d166c599f7a947508171847b4280e5fb.png"><br><br>  Reserve the external IP address: hello-habr-db <br><br><img src="https://habrastorage.org/files/c13/026/eb9/c13026eb9d23474fbf1fed35e2cde205.png"><br><br>  Open the ports for the database to work <br><br><img src="https://habrastorage.org/files/585/274/a57/585274a5711a440e8ad6c9c17a4d8a3c.png"><br><br>  We indicate the geographical location closer to Russia <br><br><img src="https://habrastorage.org/files/d2a/57e/37a/d2a57e37a7b240e8a8bc4e026cdc70e7.png"><br><br>  Let's wait for a while, while Azure creates a virtual machine.  After which we will receive detailed information about her. <br><br><img src="https://habrastorage.org/files/a40/c70/295/a40c702951ae4f07a7515ab4ac22cf0d.png"><br><br>  Now you can install the necessary software: <br><br>  1) Microsoft SQL Server 2014 Express <b>English (!)</b> (Which, by the way, already provides 10 GB) <br>  2) Management Studio 2014 <br><br>  Before you do this, follow these steps: <br><br>  1) Install the .NET Framework 3.5 <br><br><img src="https://habrastorage.org/files/3fa/d60/c9c/3fad60c9c6024760924331d3d8c60fbb.png"><br><br>  2) Turn off the firewall ( <s>do not repeat it yourself</s> for completeness of the experiment) <br><br><img src="https://habrastorage.org/files/bcc/d4a/d1b/bccd4ad1b5824c0cad1ae8d44e965aeb.png"><br><br>  When installing MS SQL Server, you need to select a <b>mixed authentication mode</b> (this is important) <br><br><img src="https://habrastorage.org/files/873/939/c27/873939c27b1c48e680210bdf44322309.png"><br><br>  After installation we will configure MS SQL Server to work on externally. <br><br><img src="https://habrastorage.org/files/b1f/5db/ef4/b1f5dbef4a2642a597301e278863443c.png"><br><br><img src="https://habrastorage.org/files/178/fee/eec/178feeeec06c405ea149079f415dbfc7.png"><br><br>  This virtual machine is ready.  Do not forget to reload. <br></div></div><br><br>  <b>Configuring a Virtual Machine with Service Bus for Windows Server</b> <br><br><div class="spoiler">  <b class="spoiler_title">Configuring a Virtual Machine with Service Bus for Windows Server</b> <div class="spoiler_text">  Specify the host name and admin account information. <br><br><img src="https://habrastorage.org/files/948/7bc/c12/9487bcc1288247c691aad2cd6ed5c044.png"><br><br>  Create a virtual network: hello-habr- <b>s</b> b <br><br><img src="https://habrastorage.org/files/b71/65a/492/b7165a4928bc40cdaccc7c9000abb5a3.png"><br><br>  Reserve an external IP address: hello-habr- <b>s</b> b <br><br><img src="https://habrastorage.org/files/edf/1b6/fb7/edf1b6fb7325458289b31838dd39adc3.png"><br><br>  Create another Storage account (although this is not critical): hellohabr <b>s</b> b <br><br><img src="https://habrastorage.org/files/754/d4b/aa4/754d4baa48014534bc1568076d6b7d18.png"><br><br>  Open an impressive list of ports for the operation of the Service Bus, and to access it Azure Pack <br><br><img src="https://habrastorage.org/files/550/25b/ccd/55025bccd4594a4bbcfeefb3bb7c1449.png"><br><br>  Get a virtual machine <br><br><img src="https://habrastorage.org/files/f1e/519/61d/f1e51961d54f4468b35a22bf3a568268.png"><br><br>  Turn off the firewall ( <s>do not repeat this on your own</s> for the sake of completeness) <br><br><img src="https://habrastorage.org/files/bcc/d4a/d1b/bccd4ad1b5824c0cad1ae8d44e965aeb.png"><br><br>  Let's start the Microsoft web platform installer and through the search we will find the Service Bus 1.1 <br><br><img src="https://habrastorage.org/files/bde/3e2/599/bde3e2599c4f46efa5547e1b94c23cde.png"><br><br>  Select two items and click install. <br><br><img src="https://habrastorage.org/files/42e/c14/946/42ec14946050423e83c422ffc9894b30.png"><br><br>  Next, we generate a certificate of access to Service Bus for Windows Server (from a client on another machine on the Internet) using the makecert.exe utility via the command line.  In Windows 8.1, it usually lies in the directory: <br>  C: \ Program Files (x86) \ Microsoft SDKs \ Windows \ v7.1A \ Bin <br><br><pre><code class="bash hljs">makecert.exe -r -pe -n <span class="hljs-string"><span class="hljs-string">"CN=hello-habr-sb.cloudapp.net, CN=hello-habr-sb"</span></span> -e 11/11/2022 -eku 1.3.6.1.5.5.7.3.2 -ss My -sr <span class="hljs-string"><span class="hljs-string">"LocalMachine"</span></span> -sky Exchange -a sha256 -sy 24 -len 2048 <span class="hljs-string"><span class="hljs-string">"hello-habr-sb.cloudapp.net.cer"</span></span></code> </pre> <br>  Get the file <i>hello-habr-sb.cloudapp.net.cer</i> .  Install it in Certificates - Local Computer (Trusted Root CA) on the <b>server</b> and <b>clients</b> to the Service Bus. <br><br><img src="https://habrastorage.org/files/b24/70c/0b2/b2470c0b2c094112a8caa09e14073fea.png"><br><br><img src="https://habrastorage.org/files/0e3/dea/9f7/0e3dea9f72254109923eef9abbe3a717.png"><br><br>  Great, now everything is ready to configure the Service Bus.  Run the <i>Service Bus Configuration</i> . <br><br>  We are interested in Custom Settings <br><br><img src="https://habrastorage.org/files/fbb/543/8fa/fbb5438faa8c4d87aefae35b766ce199.png"><br><br>  We indicate the DNS name of our virtual machine with the database: <i>hello-habr-db.cloudapp.net</i> .  Check the connection. <br><br><img src="https://habrastorage.org/files/63e/814/81b/63e81481bd3d406584bbba46439ae46a.png"><br><br>  Set the number of containers for processing messages and enter the password <br><br><img src="https://habrastorage.org/files/a28/703/f60/a28703f605a2416e8a90b2e5885ac716.png"><br><br>  As a certificate, select the previously generated hello-habr-sb.cloudapp.net.cer <br><br><img src="https://habrastorage.org/files/485/1b5/284/4851b52846b14ff99676ab6e42a0101c.png"><br><br>  Change ports from 9000 to 10,000 <br><br><img src="https://habrastorage.org/files/fb1/29f/2c7/fb129f2c78f54b2f8a3cfefdc81f668e.png"><br><br><img src="https://habrastorage.org/files/871/fec/d9b/871fecd9bdeb4d469dd263e8aa27c031.png"><br><br>  Check the box that we want to manage this farm through the Azure Pack portal.  We specify passwords for portals admin- and tenant- <br><br><img src="https://habrastorage.org/files/d92/2ac/8f9/d922ac8f9e1e4f888486f6c0672e9fc0.png"><br><br>  If all actions were done correctly, then we will be told that everything is fine <br><br><img src="https://habrastorage.org/files/272/826/6ac/2728266acf1e467e9feb82108f57e6ac.png"><br><br>  Now we need to change the DNS name of the Service Bus Farm (SBFarm) (this is necessary so that the client can be accessed from another machine on the Internet).  This can be done using <i>Service Bus PowerShell</i> (with administrator rights).  Run the sequence of commands: <br><br><pre> <code class="bash hljs">Get-SBFarm Stop-SBFarm ‚ÄìVerbose Set-SBFarm -FarmDns <span class="hljs-string"><span class="hljs-string">'hello-habr-sb.cloudapp.net'</span></span> Update-SBHost ‚ÄìVerbose Start-SBFarm ‚ÄìVerbose</code> </pre><br>  ( <i>Start-SBFarm</i> takes a very long time, this is normal) <br><br>  For the subsequent operability check via the .NET client, assign the SAS key for the previously created ServiceBusDefaultNamespace: <br><br><pre> <code class="bash hljs">New-SBAuthorizationRule -NamespaceName ServiceBusDefaultNamespace -Name MainRule -Rights Manage, Send, Listen</code> </pre><br>  In response, we get: <br><br><pre> <code class="bash hljs">KeyName : MainRule PrimaryKey : ylF6GWmH6rlZg1ekQMQrLQnht4kwVFWHAfyB8HkrZvM= SecondaryKey : ZYBpdiCYgZNfwOC37x6DEDLxhv+qan6CJZT0vG3GvTk= Rights : {Manage, Send, Listen} CreatedTime : 3/22/2015 12:53:23 AM ModifiedTime : 3/22/2015 12:53:23 AM ConnectionString : Endpoint=sb://hello-habr-sb.cloudapp.net/ServiceBusDefaultNamespace; StsEndpoint=https://hello-habr-sb.cloudapp.net:10355/ServiceBusDefaultNamespace; RuntimePort=10354; ManagementPort=10355; SharedAccessKeyName=MainRule; SharedAccessKey=ylF6GWmH6rlZg1ekQMQrLQnht4kwVFWHAfyB8HkrZvM=</code> </pre><br>  Last action on this machine: add an entry to the <i>hosts file</i> <br>  (C: \ Windows \ System32 \ drivers \ etc) <br><br><pre> <code class="bash hljs">127.0.0.1 hello-habr-sb.cloudapp.net</code> </pre><br>  Ok, move on to setting up the Azure Pack on a third machine. <br></div></div><br><br>  <b>Configure a virtual machine with an Azure Pack</b> <br><br><div class="spoiler">  <b class="spoiler_title">Configure a virtual machine with an Azure Pack</b> <div class="spoiler_text">  Specify the host name and admin account information. <br><br><img src="https://habrastorage.org/files/10f/c65/480/10fc654802574e2b8e068cd7ba27ae53.png"><br><br>  Create a virtual network: hello-habr- <b>wap</b> <br><br><img src="https://habrastorage.org/files/ea3/fb2/02f/ea3fb202fc3f4fb6a9f4988c6c1b778c.png"><br><br>  Reserve an external IP address: hello-habr- <b>wap</b> <br><br><img src="https://habrastorage.org/files/9bf/b52/d03/9bfb52d03ae24062b1dce6824a61a79a.png"><br><br>  Let's create another Storage account (although this is not critical): hellohabr <b>wap</b> <br><br><img src="https://habrastorage.org/files/e70/a60/4f7/e70a604f756d4f84a34eb7fa4943719b.png"><br><br>  Open the ports to access the Azure Pack management portals <br><br><img src="https://habrastorage.org/files/9c6/4c8/b65/9c64c8b65ae741f78cc526f28c18b6a3.png"><br><br>  Get a virtual machine <br><br><img src="https://habrastorage.org/files/27c/751/2b2/27c7512b2425458a83752fe543f6547f.png"><br><br>  Azure Pack also stores its data in the database, and in order to separate its logic from the logic of the Service Bus, we will raise another database server, but on this machine.  For this we need again: <br><br>  1) Microsoft SQL Server 2014 Express <b>English (!)</b> <br>  2) Management Studio 2014 <br><br>  Before you start the installation, perform the following steps: <br><br>  1) Install the .NET Framework 3.5 <br><br><img src="https://habrastorage.org/files/3fa/d60/c9c/3fad60c9c6024760924331d3d8c60fbb.png"><br><br>  2) Turn off the firewall ( <s>do not repeat it yourself</s> for completeness of the experiment) <br><br><img src="https://habrastorage.org/files/bcc/d4a/d1b/bccd4ad1b5824c0cad1ae8d44e965aeb.png"><br><br>  When installing MS SQL Server, you need to select a <b>mixed authentication mode</b> (this is important) <br><br><img src="https://habrastorage.org/files/f3b/8ad/58f/f3b8ad58f6894368846d35ad53320173.png"><br><br>  After that, you need to raise IIS for Azure Pack management portals <br><br><img src="https://habrastorage.org/files/ee8/e60/a40/ee8e60a4020b41c0ac62c619e53ab75c.png"><br><br>  I will also install several components related to IIS management and security. <br><br><img src="https://habrastorage.org/files/b5a/eaf/84a/b5aeaf84a1094bc09c6dc8b90bb5b85f.png"><br><br><img src="https://habrastorage.org/files/c53/efe/d4c/c53efed4c7c14e949f14d605e7ce919a.png"><br><br><img src="https://habrastorage.org/files/b7d/3e3/b08/b7d3e3b089e44242b160c9c0f03589d1.png"><br><br><img src="https://habrastorage.org/files/af5/2a7/d15/af52a7d15cc94680b839d16ef1a1b860.png"><br><br><img src="https://habrastorage.org/files/9dc/ae3/378/9dcae3378c8c435c85cb84a825c455ce.png"><br><br>  Now we will install <a href="http://go.microsoft.com/%3Flinkid%3D9832690">Azure Pack</a> with default parameters. <br><br>  Immediately after installation, the configuration portal will open: <pre>  https: // localhost: 30101 / </pre><br>  Click continue. <br><br><img src="https://habrastorage.org/files/435/809/00c/43580900cca34ed5bfb84574fe0d20ef.png"><br><br>  We indicate the database in which the data will be stored Azure Pack <br><br><img src="https://habrastorage.org/files/185/662/cdc/185662cdca7343caa92c55a34e196657.png"><br><br>  If everything is fine with IIS and DB, we will be informed about the successful implementation <br><br><img src="https://habrastorage.org/files/12c/a4e/a09/12ca4ea0969140849824c140ca90b636.png"><br><br>  Now we need to generate a certificate of access to the Azure Pack sites (so that only those who have a certificate have access to the sites) using the familiar utilities <b>makecert.exe</b> and <b>pvk2pfx.exe</b> . <br>  <i>C: \ Program Files (x86) \ Microsoft SDKs \ Windows \ v7.1A \ Bin</i> <br><br>  For server: <br><br><pre> <code class="bash hljs">makecert -r -pe -n <span class="hljs-string"><span class="hljs-string">"CN=WAP Portals"</span></span> -ss CA -a sha1 -sky signature -cy authority -sv WAPPortals.pvk WAPPortals.cer makecert -pe -n <span class="hljs-string"><span class="hljs-string">"CN=hello-habr-wap.cloudapp.net"</span></span> -a sha1 -sky exchange -eku 1.3.6.1.5.5.7.3.1 -ic WAPPortals.cer -iv WAPPortals.pvk -sp <span class="hljs-string"><span class="hljs-string">"Microsoft RSA SChannel Cryptographic Provider"</span></span> -sy 12 -sv WAPLocalServer.pvk WAPLocalServer.cer pvk2pfx -pvk WAPLocalServer.pvk -spc WAPLocalServer.cer -pfx WAPLocalServer.pfx</code> </pre><br>  For client: <br><pre> <code class="bash hljs">makecert -pe -n <span class="hljs-string"><span class="hljs-string">"CN=WAPMainDeveloper"</span></span> -a sha1 -sky exchange -eku 1.3.6.1.5.5.7.3.2 -ic WAPPortals.cer -iv WAPPortals.pvk -sv WAPClient.pvk WAPClient.cer pvk2pfx -pvk WAPClient.pvk -spc WAPClient.cer -pfx WAPClient.pfx -po HelloHabr2015</code> </pre><br>  We import <i>WAPPortals.cer</i> into Certificates - Local Computer (Trusted Root CA) on the server. <br><br><img src="https://habrastorage.org/files/054/c19/370/054c19370c374e70a9f35dac90c0fc85.png"><br><br>  We import <i>WAPLocalServer.pfx</i> to IIS on the server. <br><br><img src="https://habrastorage.org/files/8f1/0a0/12d/8f10a012d38b46e2921caa487b8d92c7.png"><br><br>  In my case - I did not set the password. <br><br><img src="https://habrastorage.org/files/5bf/b46/0c4/5bfb460c412a418fb8da6aadd8715aff.png"><br><br>  Install <i>WAPClient.pfx</i> on the server and on the clients in Certificates - Local Computer and Current User (Personal). <br><br>  Add an entry to the <i>hosts file</i> <br>  (C: \ Windows \ System32 \ drivers \ etc) <br><br><pre> <code class="bash hljs">127.0.0.1 hello-habr-wap.cloudapp.net</code> </pre><br>  Now we can change the FQDN name for Azure Pack management sites (this is needed to access sites from the Internet) using PowerShell (with administrative rights) <br><br>  For <b>TenantSite</b> <br><br><pre> <code class="bash hljs">Import-Module -Name MgmtSvcConfig Set-MgmtSvcFqdn -Namespace <span class="hljs-string"><span class="hljs-string">"TenantSite"</span></span> -FullyQualifiedDomainName <span class="hljs-string"><span class="hljs-string">"hello-habr-wap.cloudapp.net"</span></span> -Port 30081 -Server <span class="hljs-string"><span class="hljs-string">"hello-habr-wap\SQLEXPRESS"</span></span> Set-MgmtSvcFqdn -Namespace <span class="hljs-string"><span class="hljs-string">"AuthSite"</span></span> -FullyQualifiedDomainName <span class="hljs-string"><span class="hljs-string">"hello-habr-wap.cloudapp.net"</span></span> -Port 30071 -Server <span class="hljs-string"><span class="hljs-string">"hello-habr-wap\SQLEXPRESS"</span></span> Set-MgmtSvcRelyingPartySettings -Target Tenant -MetadataEndpoint <span class="hljs-string"><span class="hljs-string">"https://hello-habr-wap.cloudapp.net:30071/FederationMetadata/2007-06/FederationMetadata.xml"</span></span> -ConnectionString <span class="hljs-string"><span class="hljs-string">"Data Source=hello-habr-wap\SQLEXPRESS;User ID=sa;Password=HelloHabr2015"</span></span> ‚ÄìDisableCertificateValidation Set-MgmtSvcIdentityProviderSettings -Target Membership -MetadataEndpoint <span class="hljs-string"><span class="hljs-string">"https://hello-habr-wap.cloudapp.net:30081/FederationMetadata/2007-06/FederationMetadata.xml"</span></span> -ConnectionString <span class="hljs-string"><span class="hljs-string">"Data Source=hello-habr-wap\SQLEXPRESS;User ID=sa;Password=HelloHabr2015"</span></span> ‚ÄìDisableCertificateValidation</code> </pre><br>  For <b>adminsite</b> <br><br><pre> <code class="bash hljs">Import-Module -Name MgmtSvcConfig Set-MgmtSvcFqdn -Namespace <span class="hljs-string"><span class="hljs-string">"AdminSite"</span></span> -FullyQualifiedDomainName <span class="hljs-string"><span class="hljs-string">"hello-habr-wap.cloudapp.net"</span></span> -Port 30091 -Server <span class="hljs-string"><span class="hljs-string">"hello-habr-wap\SQLEXPRESS"</span></span> Set-MgmtSvcFqdn -Namespace <span class="hljs-string"><span class="hljs-string">"WindowsAuthSite"</span></span> -FullyQualifiedDomainName <span class="hljs-string"><span class="hljs-string">"hello-habr-wap.cloudapp.net"</span></span> -Port 30072 -Server <span class="hljs-string"><span class="hljs-string">"hello-habr-wap\SQLEXPRESS"</span></span> Set-MgmtSvcRelyingPartySettings -Target Admin -MetadataEndpoint <span class="hljs-string"><span class="hljs-string">"https://hello-habr-wap.cloudapp.net:30072/FederationMetadata/2007-06/FederationMetadata.xml"</span></span> -ConnectionString <span class="hljs-string"><span class="hljs-string">"Data Source=hello-habr-wap\SQLEXPRESS;User ID=sa;Password=HelloHabr2015"</span></span> ‚ÄìDisableCertificateValidation Set-MgmtSvcIdentityProviderSettings -Target Windows -MetadataEndpoint <span class="hljs-string"><span class="hljs-string">"https://hello-habr-wap.cloudapp.net:30091/FederationMetadata/2007-06/FederationMetadata.xml"</span></span> -ConnectionString <span class="hljs-string"><span class="hljs-string">"Data Source=hello-habr-wap\SQLEXPRESS;User ID=sa;Password=HelloHabr2015"</span></span> ‚ÄìDisableCertificateValidation</code> </pre><br>  In the settings of Azure Pack sites in IIS, change the Bindings <br><br><img src="https://habrastorage.org/files/d6a/887/7c1/d6a8877c1828460c811c5895e1e93ca8.png"><br><br>  As a certificate, select <b>hello-habr-wap.cloudapp.net - WAP Portals</b> <br><br><img src="https://habrastorage.org/files/caa/8ed/743/caa8ed743ef7405eba05f9cdd188359b.png"><br><br><img src="https://habrastorage.org/files/18f/45f/be4/18f45fbe43d34a9a9686ace7349400b1.png"><br><br>  In the SSL settings for the site - install <b>Require SSL</b> <br><br><img src="https://habrastorage.org/files/1bf/22c/99a/1bf22c99a338444798d45b1b3581b635.png"><br><br><img src="https://habrastorage.org/files/f1a/8b8/c85/f1a8b8c85f48477c8f1760fc372c7317.png"><br><br>  Repeat this procedure for sites: <br><br>  - TenantSite <br>  - AuthSite <br>  - AdminSite <br>  - WindowsAuthSite <br><br>  To create user-friendly DNS names, you can use the methods described in the articles: <a href="http://blogs.msdn.com/b/asiatech/archive/2013/12/30/customizing-windows-azure-pack-portal-of-an-express-deployment.aspx">one</a> , <a href="http://blogs.technet.com/b/privatecloud/archive/2013/12/10/windows-azure-pack-reconfigure-portal-names-ports-and-use-trusted-certificates.aspx">two,</a> and <a href="http://www.hyper-v.nu/archives/mvaneijk/2013/10/windows-azure-pack-changing-the-default-urls/">three</a> . <br><br>  Great, we‚Äôve reached the finish line.  Now you need to configure access to the Service Bus, which is located on <i>hello-habr-sb.cloudapp.net</i> <br><br><img src="https://habrastorage.org/files/119/c9d/dfc/119c9ddfc48f478e9c38cd7a44d2a676.jpg"><br><br>  Head over to AdminSite: <br><pre>  https://hello-habr-wap.cloudapp.net number0091 </pre><br>  Connect to the virtual machine with Service Bus <br><br><img src="https://habrastorage.org/files/c83/75e/9a3/c8375e9a3e5e4d3381bb17988cc3715c.png"><br><br>  Create a Plan <br><br><img src="https://habrastorage.org/files/541/fb0/b65/541fb0b656134705ab7708542c234580.png"><br><br><img src="https://habrastorage.org/files/79f/04b/e7f/79f04be7fc3e486283424315503961eb.png"><br><br><img src="https://habrastorage.org/files/4e6/a7c/30f/4e6a7c30f1914aa0874ba9321f5b0a94.png"><br><br>  Finally, let's create a user. <br><br><img src="https://habrastorage.org/files/e7a/99e/e1d/e7a99ee1d5074989955ed5e68c7b3863.png"><br><br><img src="https://habrastorage.org/files/bf9/149/68d/bf914968da9d46f383ea608d1e0f0e7e.png"><br><br></div></div><br><br>  <b>Checking the service bus</b> <br><br><div class="spoiler">  <b class="spoiler_title">Checking the service bus</b> <div class="spoiler_text">  Let's go to TenantSite and enter the credentials of the created user. <br><pre>  https://hello-habr-wap.cloudapp.net lower0081/ </pre><br><img src="https://habrastorage.org/files/e08/9c1/d21/e089c1d21095497d817618f36fa362a6.png"><br><br>  Create Namespace <br><br><img src="https://habrastorage.org/files/686/015/424/686015424eb041bdacc5c238c517a5c6.png"><br><br>  Create Topic <br><br><img src="https://habrastorage.org/files/d31/7d7/370/d317d737041a44898ff45335985de4f6.png"><br><br><img src="https://habrastorage.org/files/080/5ad/564/0805ad5642164c6aa2c3f30a54485831.png"><br><br><img src="https://habrastorage.org/files/244/6c9/4d6/2446c94d672241fb91046dc1b9092f73.png"><br><br><img src="https://habrastorage.org/files/0a4/e38/728/0a4e3872846e485bb5f0a34aea2dba82.png"><br><br>  Create Subscription <br><br><img src="https://habrastorage.org/files/83a/d94/aea/83ad94aea6c54375b6b4926dbdfd3b44.png"><br><br><img src="https://habrastorage.org/files/67f/cdd/273/67fcdd273e3c4419bba1b6cd93c17631.png"><br><br><img src="https://habrastorage.org/files/296/afd/6f7/296afd6f7418480d8900c31d66073a2b.png"><br><br>  Create Shared Access Policies for Topic <br><br><img src="https://habrastorage.org/files/0a8/c36/e14/0a8c36e141da4647a64ec638565fd0fd.png"><br><br>  Get access keys <br><br><img src="https://habrastorage.org/files/30d/873/d4e/30d873d4e9a14e968306903537f1e5b9.png"><br><br>  Now everything is ready for verification. <br><br>  Create a simple console application.  I use Visual Studio 2013 for this. <br><br><img src="https://habrastorage.org/files/116/afb/13d/116afb13d3ce4361b73bcf4689c785e5.png"><br><br>  Add the necessary References using the NuGet Package Manager Console <br><br><pre> <code class="bash hljs">Install-Package ServiceBus.v1_1</code> </pre><br>  And write a small verification code <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus.Messaging; namespace TestHelloHabrServiceBus { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { static string ServerFQDN; static <span class="hljs-type"><span class="hljs-type">int</span></span> HttpPort = <span class="hljs-number"><span class="hljs-number">10355</span></span>; static <span class="hljs-type"><span class="hljs-type">int</span></span> TcpPort = <span class="hljs-number"><span class="hljs-number">10354</span></span>; static string ServiceNamespace = "HelloHabrNamespace"; static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { ServerFQDN = "hello-habr-sb.cloudapp.net"; ServiceBusConnectionStringBuilder connBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ServiceBusConnectionStringBuilder(); connBuilder.ManagementPort = HttpPort; connBuilder.RuntimePort = TcpPort; connBuilder.Endpoints.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UriBuilder() { Scheme = "sb", Host = ServerFQDN, <span class="hljs-type"><span class="hljs-type">Path</span></span> = ServiceNamespace }.Uri); connBuilder.StsEndpoints.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UriBuilder() { Scheme = "https", Host = ServerFQDN, Port = HttpPort, <span class="hljs-type"><span class="hljs-type">Path</span></span> = ServiceNamespace }.Uri); connBuilder.SharedAccessKeyName = "HelloHabrSAS"; connBuilder.SharedAccessKey = "CLoUUuoBgwzJ4502NWGNB4cUIn7IcBOpuB47q53K2So="; NamespaceManager namespaceManager = NamespaceManager.CreateFromConnectionString(connBuilder.ToString()); TopicClient topicClient = TopicClient.CreateFromConnectionString(connBuilder.ToString(), "HelloHabrTopic"); SubscriptionClient subscriptionClient = SubscriptionClient.CreateFromConnectionString( connBuilder.ToString(), "HelloHabrTopic", "HelloHabrSubscription", ReceiveMode.PeekLock); BrokeredMessage message = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BrokeredMessage("My Message"); //   try { topicClient.Send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BrokeredMessage("My Message")); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Console.WriteLine(ex.Message); } Console.WriteLine(" "); //   message = subscriptionClient.Receive(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Console.WriteLine("Body: " + message.GetBody&lt;string&gt;()); Console.WriteLine("MessageId: " + message.MessageId); message.Complete(); Console.WriteLine("The end of the message."); } Console.WriteLine("===================================="); Console.WriteLine("Program ends."); Console.ReadLine(); } } }</code> </pre><br>  Run and verify that messages are being sent and delivered. <br><br><img src="https://habrastorage.org/files/1c0/582/ed8/1c0582ed8d344781a4971ac7834570b6.png"><br><br></div></div><br><br>  I hope my experience in customizing these solutions will come in handy and will save you some time. </div><p>Source: <a href="https://habr.com/ru/post/254059/">https://habr.com/ru/post/254059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254045/index.html">Rock Sanitize - simple and flexible sanitizer</a></li>
<li><a href="../254047/index.html">Qbaka Vision - analysis of user behavior</a></li>
<li><a href="../254053/index.html">The console version of Cyberduck: working with cloud storage</a></li>
<li><a href="../254055/index.html">JumpStart Broadcast: Managing Mobile Corporate Devices</a></li>
<li><a href="../254057/index.html">Night programmer. April 4-5, Nizhny Novgorod. IoT hakaton Microsoft and Intel</a></li>
<li><a href="../254061/index.html">Android found dangerous vulnerability</a></li>
<li><a href="../254065/index.html">Tibbo AggreGate Concept - Platform for the Internet of Things</a></li>
<li><a href="../254067/index.html">Simulation model of the logistics center</a></li>
<li><a href="../254071/index.html">Space landscape</a></li>
<li><a href="../254073/index.html">Lectures Technopark. Semester 2 Database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>