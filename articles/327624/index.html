<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MeteorJS, Nginx, mongodb, iptables ... production</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Alexander Zelenin , and I  Web developer  sysadmin. 


 Unfortunately, all the information about the full-scale development of the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MeteorJS, Nginx, mongodb, iptables ... production</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello, my name is <a href="http://zelenin1.moikrug.ru/">Alexander Zelenin</a> , and I <del>  Web developer </del>  sysadmin. </p><br><p>  Unfortunately, all the information about the full-scale development of the application on MeteorJS is rather fragmented, and you have to manually solve a million tasks.  In this article I want to make out the most basic (but already sufficient for secure production in production) server configuration and the subsequent manual deployment process. </p><br><p>  We will deploy on Ubuntu 16, but in general the scheme is 99% the same for Debian 8. </p><a name="habracut"></a><br><p>  <em>In fact, I am not close to a sysadmin, so I will be very happy with the proposed revisions, but on the whole the scheme is quite working.</em> </p><br><p>  As the file system during the installation, choose XFS - Mong is good friends with it. </p><br><div class="spoiler">  <b class="spoiler_title">Cooking SSH</b> <div class="spoiler_text"><p>  If we have root access, the first thing to do is create a user. </p><br><pre><code class="bash hljs">adduser zav <span class="hljs-comment"><span class="hljs-comment">#   %username%  zav apt-get install sudo usermod -aG sudo zav #      sudo, #       -  vi /etc/ssh/sshd_config #       vi ‚Äî   nano  vi. #     ‚Äî apt-get install nano</span></span></code> </pre> <br><p>  We need to change the port to a random one of your choice - this will immediately protect against part of the attacks on the ssh server. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Port</span></span> <span class="hljs-number"><span class="hljs-number">355</span></span> <span class="hljs-comment"><span class="hljs-comment">#    Port 22 PermitRootLogin no #    </span></span></code> </pre> <br><p>  Reboot SSH </p><br><pre> <code class="bash hljs">/etc/init.d/ssh restart</code> </pre> <br><p>  Now we reconnect via SSH to a new port (355), to a new, newly created user. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Prepare the second disk and tmpfs (to place mongu in memory)</b> <div class="spoiler_text"><p>  I use 2 separate physical disks to minimize the chance of failure. <br>  You can place everything on 1 at your own risk, the scheme will not change. <br>  In this case, you can use the / secondary folder in the same way, but do not mount the disk in it. </p><br><pre> <code class="bash hljs">sudo cfdisk /dev/sdb <span class="hljs-comment"><span class="hljs-comment">#    (sdb)  . #   , 100% ,  sudo mkfs.xfs /dev/sdb1 #      sudo mkdir /secondary sudo vi /etc/fstab #  -   </span></span></code> </pre> <br><p>  Add to the end (if there is no second disk, we omit the first line) <br>  tmpfs - the file system will be located in RAM.  Those.  writing to the / data / inmemory partition will write to RAM, not to disk.  It should be understood that when you restart it is cleared.  size sets the size of this area.  Your task is to have enough of it to place a monga with all indices.  In my case, the RAM 128Gb, ‚Äã‚Äãrespectively, under the tmpfs allocated 32 gigabytes. </p><br><pre> <code class="hljs haskell">/dev/sdb1 /secondary xfs defaults <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> tmpfs /<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">/inmemory tmpfs size=25% 0 0</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">We put Mongu, set up a replica, prepare real-time backup</b> <div class="spoiler_text"><p>  The actual installation method can be viewed on the official website. <br>  In this example, there is installation of version 3.4 on Ubuntu 16. </p><br><p>  Install: </p><br><pre> <code class="bash hljs">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse"</span></span> | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list sudo apt-get update sudo apt-get install mongodb-org</code> </pre> <br><p>  Create folders, configs and set permissions: </p><br><pre> <code class="bash hljs">sudo mkdir /data sudo mkdir /data/db sudo mkdir /data/inmemory sudo mkdir /secondary/data sudo mkdir /secondary/data/db sudo vi /data/mongod-memory.conf</code> </pre> <br><p>  An approach in which the primary in memory can be dangerous, since  in case of a sudden power off, data that did not have time to go into replicas is lost.  In my case, the loss of 1-2 seconds is not terrible, because  The entire application is written with the possibility of recovery from any position.  Financial data is written with a parameter confirming that the data already exists on the replica (that is, on the disk). <br>  If your application to this is not ready - you can opt out of the memory section and do everything classically.  In general, it will be enough to remove the tmpfs mount and slightly modify the config, making it similar to mongod-sec-d1.conf </p><br><div class="spoiler">  <b class="spoiler_title">mongod-memory.conf - primary, in memory</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">processManagement: fork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> pidFilePath: "/data/inmemory/mongod.pid" <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath: "/data/inmemory" journal: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #   # ..            indexBuildRetry: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> wiredTiger: engineConfig: cacheSizeGB: <span class="hljs-number"><span class="hljs-number">8</span></span> #   . # ,  ,  ,     , # ..  ,      #   ,        systemLog: destination: "file" <span class="hljs-type"><span class="hljs-type">path</span></span>: "/var/log/mongodb/mongodb.log" #      . #     , #       #  ,     #    (,  ) logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> quiet: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> verbosity: <span class="hljs-number"><span class="hljs-number">0</span></span> logRotate: "reopen" timeStampFormat: "iso8601-local" net: bindIp: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> #        #  ,     ‚Äî    port: <span class="hljs-number"><span class="hljs-number">27000</span></span> # ,     , #           http: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #    http    JSONPEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> RESTInterfaceEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ssl: # ssl        mode: disabled <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: #       , #    ,    <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: "enabled" keyFile: "/data/mongod-keyfile" #        javascriptEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #   JS  . <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: oplogSizeMB: <span class="hljs-number"><span class="hljs-number">4096</span></span> #    oplog<span class="hljs-string"><span class="hljs-string">'. #         #          oplog'</span></span>a. #     #     ‚Äî     ? replSetName: "consulwar" enableMajorityReadConcern: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> # ,      #        . operationProfiling: slowOpThresholdMs: <span class="hljs-number"><span class="hljs-number">30</span></span> # ,     , #      #         mode: "slowOp"</code> </pre> </div></div><br><pre> <code class="bash hljs">sudo vi /data/mongod-sec-d1.conf</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">mongod-sec-d1.conf - secondary, disk 1</b> <div class="spoiler_text"><p>  For the most part, the config is repeated, the difference is only in a couple of places. <br>  But leave for convenience </p><br><pre> <code class="hljs pgsql">processManagement: fork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> pidFilePath: "/data/db/mongod.pid" <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath: "/data/db" journal: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #  ,     , #       indexBuildRetry: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> wiredTiger: engineConfig: cacheSizeGB: <span class="hljs-number"><span class="hljs-number">8</span></span> # ,    -  <span class="hljs-keyword"><span class="hljs-keyword">Primary</span></span> , # secondary   ,     systemLog: destination: "file" <span class="hljs-type"><span class="hljs-type">path</span></span>: "/var/log/mongodb/mongodb.log" logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> quiet: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> verbosity: <span class="hljs-number"><span class="hljs-number">0</span></span> logRotate: "reopen" timeStampFormat: "iso8601-local" net: bindIp: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port: <span class="hljs-number"><span class="hljs-number">27001</span></span> http: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> JSONPEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> RESTInterfaceEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ssl: mode: disabled <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: "enabled" keyFile: "/data/mongod-keyfile" javascriptEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: oplogSizeMB: <span class="hljs-number"><span class="hljs-number">4096</span></span> replSetName: "consulwar" enableMajorityReadConcern: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> operationProfiling: slowOpThresholdMs: <span class="hljs-number"><span class="hljs-number">30</span></span> mode: "slowOp"</code> </pre> </div></div><br><pre> <code class="bash hljs">sudo vi /data/mongod-sec-d2.conf</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">mongod-sec-d2.conf - secondary, disk 2</b> <div class="spoiler_text"><p>  The difference is, in fact, only on the way to the database and depending on the port used. </p><br><pre> <code class="hljs pgsql">processManagement: fork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> pidFilePath: "/secondary/data/db/mongod.pid" <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath: "/secondary/data/db" journal: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> indexBuildRetry: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> wiredTiger: engineConfig: cacheSizeGB: <span class="hljs-number"><span class="hljs-number">8</span></span> systemLog: destination: "file" <span class="hljs-type"><span class="hljs-type">path</span></span>: "/var/log/mongodb/mongodb.log" logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> quiet: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> verbosity: <span class="hljs-number"><span class="hljs-number">0</span></span> logRotate: "reopen" timeStampFormat: "iso8601-local" net: bindIp: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port: <span class="hljs-number"><span class="hljs-number">27002</span></span> http: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> JSONPEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> RESTInterfaceEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ssl: mode: disabled <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: "enabled" keyFile: "/data/mongod-keyfile" javascriptEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: oplogSizeMB: <span class="hljs-number"><span class="hljs-number">4096</span></span> replSetName: "consulwar" enableMajorityReadConcern: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> operationProfiling: slowOpThresholdMs: <span class="hljs-number"><span class="hljs-number">30</span></span> mode: "slowOp"</code> </pre> </div></div><br><p>  Add the key for the correct operation of the replica, set the rights to folders </p><br><pre> <code class="bash hljs">sudo openssl rand -base64 741 &gt; ~/mongod-keyfile sudo mv mongod-keyfile /data/mongod-keyfile sudo chmod 600 /data/mongod-keyfile sudo chown mongodb:mongodb -R /data sudo chown mongodb:mongodb -R /secondary/data</code> </pre> <br><p>  Create startup scripts </p><br><pre> <code class="bash hljs">sudo apt-get install numactl sudo mv /lib/systemd/system/mongod.service /lib/systemd/system/mongod@.service sudo vi /lib/systemd/system/mongod@.service</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">mongod @ .service</b> <div class="spoiler_text"><p>  @ in the name of the service means that we can run it with parameters. <br>  This script sets all the necessary OS settings for working with Monga - conveniently. </p><br><pre> <code class="hljs pgsql">[Unit] Description= Mongo <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> %i <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=network.target [Service] <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=forking ExecStartPre=/bin/sh -c <span class="hljs-string"><span class="hljs-string">'/bin/echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span></span> ExecStartPre=/bin/sh -c <span class="hljs-string"><span class="hljs-string">'/bin/echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=mongodb <span class="hljs-keyword"><span class="hljs-keyword">Group</span></span>=mongodb PermissionsStartOnly=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ExecStart=/usr/bin/numactl <span class="hljs-comment"><span class="hljs-comment">--interleave=all /usr/bin/mongod --config /data/mongod-%i.conf LimitFSIZE=infinity LimitCPU=infinity LimitAS=infinity LimitNOFILE=64000 LimitNPROC=64000 TasksMax=infinity TasksAccounting=false [Install] WantedBy=multi-user.target</span></span></code> </pre> </div></div><br><p>  We tell the database to start at system startup, and also run instances right now. <br>  Our parameter is set after @, for example, memory will indicate to use when starting /data/mongod-memory.conf </p><br><pre> <code class="bash hljs">sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mongod@memory sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mongod@sec-d1 sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mongod@sec-d2 sudo service start mongod@memory sudo service start mongod@sec-d1 sudo service start mongod@sec-d2</code> </pre> <br><p>  Connect to Mong, initialize replica, install users </p><br><pre> <code class="bash hljs">mongo localhost:27000/admin</code> </pre> <br><p>  Perform in console monga </p><br><pre> <code class="javascript hljs">rs.initiate({ <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"consulwar"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   version: 1, protocolVersion: 1, writeConcernMajorityJournalDefault: false, //      //      configsvr: false, // ,        // ( ‚Äî   ) members: [ { _id: 0, // id       host: 'localhost:27000', //       arbiterOnly: false, //       buildIndexes: true, // ,     hidden: false, //  , ..      priority: 100, //    Primary ‚Äî  ,   slaveDelay: 0, //  .    . votes: 1 //      Primary }, { _id: 1, host: 'localhost:27001', arbiterOnly: false, buildIndexes: true, hidden: false, priority: 99, //   slaveDelay: 0, votes: 1 }, { _id: 2, host: 'localhost:27002', arbiterOnly: false, buildIndexes: true, hidden: false, priority: 98, slaveDelay: 0, votes: 1 } ], settings: { chainingAllowed : true, //      ,      electionTimeoutMillis : 5000, //    , //      . ~7 . //       1  //    500,  catchUpTimeoutMillis : 2000 } }); //   ,     root' db.createUser({user: 'zav', pwd: '7Am9859dcb82jJh', roles: ['root']}); //  - ctrl+c, ctrl+c</span></span></code> </pre> <br><p>  Connect under our user </p><br><pre> <code class="bash hljs">mongo localhost:27000/admin -u zav -p <span class="hljs-string"><span class="hljs-string">'7Am9859dcb82jJh'</span></span> --authenticationDatabase admin</code> </pre> <br><p>  Add a user to work with the application </p><br><pre> <code class="javascript hljs">use consulwar <span class="hljs-comment"><span class="hljs-comment">//  consulwar      db.createUser({ user: 'consulwar', pwd: '37q4Re7m432dtDq', roles: [{ //        . //    ,     .. role: "readWrite", db: "consulwar" }, { //    oplog',      role: 'read', db: 'local' }] });</span></span></code> </pre> <br><p>  Now a rather important and difficult question - real-time replication for backup.  It will not be considered as a whole, due to the need to configure a number of other equipment, which I would like to avoid in this article. </p><br><div class="spoiler">  <b class="spoiler_title">Configuring realtime backup</b> <div class="spoiler_text"><p>  We will replicate to an external server (otherwise, what's the point of backup? :-)). <br>  The external server should have Mong installed in a similar way. <br>  Approximate config: </p><br><div class="spoiler">  <b class="spoiler_title">mongod-backup.conf</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">processManagement: fork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> pidFilePath: "/data/db/mongod.pid" <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath: "/data/db" journal: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> indexBuildRetry: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #    wiredTiger: engineConfig: cacheSizeGB: <span class="hljs-number"><span class="hljs-number">0</span></span> #   systemLog: destination: "file" <span class="hljs-type"><span class="hljs-type">path</span></span>: "/var/log/mongodb/mongodb.log" logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> quiet: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> verbosity: <span class="hljs-number"><span class="hljs-number">0</span></span> logRotate: "reopen" timeStampFormat: "iso8601-local" net: bindIp: <span class="hljs-number"><span class="hljs-number">222.222</span></span><span class="hljs-number"><span class="hljs-number">.222</span></span><span class="hljs-number"><span class="hljs-number">.222</span></span> #       port: <span class="hljs-number"><span class="hljs-number">27000</span></span> http: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> #    http,   JSONPEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> RESTInterfaceEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ssl: mode: disabled <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: "enabled" keyFile: "/data/mongod-keyfile" # mongod-keyfile     javascriptEnabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>: oplogSizeMB: <span class="hljs-number"><span class="hljs-number">0</span></span> replSetName: "consulwar" enableMajorityReadConcern: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> operationProfiling: mode: "off" #      </code> </pre> </div></div><br><p>  In the backup server firewall, we allow connection to port 27000 ONLY from the server application / database IP. <br>  The same thing - on the application / database server in bindIp we specify to look also into the external interface (ip external server), and in iptables we allow access to ports 27000-27002 ONLY from the ip of the north backup. </p><br><p>  At initialization / reinitialization of the replica we add </p><br><pre> <code class="hljs ruby">{ <span class="hljs-symbol"><span class="hljs-symbol">_id:</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">host:</span></span> <span class="hljs-string"><span class="hljs-string">'222.222.222.222:27000'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,     <span class="hljs-symbol"><span class="hljs-symbol">arbiterOnly:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">buildIndexes:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-symbol"><span class="hljs-symbol">hidden:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> !      <span class="hljs-symbol"><span class="hljs-symbol">priority:</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-symbol"><span class="hljs-symbol">slaveDelay:</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,       <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-symbol"><span class="hljs-symbol">votes:</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/     }</span></span></code> </pre> <br><p>  Done!  Now the data will flow in real-time also in the external backup, which is very cool. <br>  In case of a complete crash of the application, we can initialize the replica in the same way, and it will be restored from backup. <br>  Believe me, it is much faster than mongodump / mongorestore (according to personal estimates, 25-100 times). </p></div></div></div></div><br><div class="spoiler">  <b class="spoiler_title">Nodejs, npm, app user, meteor build</b> <div class="spoiler_text"><p>  Install the node, put the module n, put them version of the node 4.8.1 (the last version officially supported by the meteor). <br>  We set pm2, since  they will run the processes. </p><br><pre> <code class="bash hljs">sudo apt-get install nodejs sudo apt-get install npm sudo npm install -gn sudo n 4.8.1 sudo npm install pm2@latest -g</code> </pre> <br><p>  We add the user from under which everything will be started and who will be responsible for deployment </p><br><pre> <code class="bash hljs">sudo adduser consulwar</code> </pre> <br><p>  We go for this user </p><br><pre> <code class="bash hljs">su consulwar mkdir app mkdir app/current</code> </pre> <br><p>  On the local machine, go to the directory with our meteor project. <br>  We create the folder for builds, we collect the project in this folder. </p><br><pre> <code class="bash hljs">mkdir ../build meteor build ../build/ --architecture os.linux.x86_64</code> </pre> <br><p>  We receive the received archive on our server, for example, on sftp.  We go under our user for the application. <br>  We load in the folder ~ / app. <br>  We go on ssh for our user (consulwar for me). </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> app mkdir 20170429 <span class="hljs-comment"><span class="hljs-comment">#      tar -xvzf consulwar-master.tar.gz -C 20170429 ln -s 20170429/bundle ~/app/current #  ,    (cd current/programs/server &amp;&amp; npm install) vi pm2.config.js #     pm2</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">pm2.config.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settings = { ... }; <span class="hljs-comment"><span class="hljs-comment">//     settings.json   var instances = 10; //   ?    N-1 //  N ‚Äî   var apps = []; for (var i = 0; i &lt; instances; i++) { apps.push({ "script": "/home/consulwar/app/current/bundle/main.js", //    "exec_mode": "fork", // ..    Nginx,   "name": "consulwar", //      "env": { "ROOT_URL": "http://consulwar.ru/", //   "HTTP_FORWARDED_COUNT": 1, //      //    IP    "PORT": 3000 + i, //    3000 (3000, 3001, 3002...) "MONGO_URL": "mongodb://consulwar:37q4Re7m432dtDq@localhost:27000,localhost:27001,localhost:27002/consulwar?replicaSet=consulwar&amp;readPreference=primary&amp;authSource=consulwar", "MONGO_OPLOG_URL": "mongodb://consulwar:37q4Re7m432dtDq@localhost:27000,clocalhost:27001,localhost:27002/local?replicaSet=consulwar&amp;authSource=consulwar", "METEOR_SETTINGS": settings } }); } module.exports = { apps : apps }</span></span></code> </pre> </div></div><br><p>  And run </p><br><pre> <code class="bash hljs">pm2 startup pm2.js <span class="hljs-comment"><span class="hljs-comment">#  ,        ... #   pm2 start pm2.js pm2 status # ,   .      pm2 logs</span></span></code> </pre> <br><p>  Done, the application is deployed and should already be available at the server ip / address with the port, for example <a href="http://consulwar.ru:3000/">http://consulwar.ru.03000</a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Nginx balancing</b> <div class="spoiler_text"><pre> <code class="bash hljs">sudo apt-get install software-properties-common sudo add-apt-repository ppa:nginx/stable sudo apt-get install nginx sudo vi /etc/nginx/nginx.conf</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel">user www-data; # -   nginx worker_processes <span class="hljs-number"><span class="hljs-number">6</span></span>; #    worker_rlimit_nofile <span class="hljs-number"><span class="hljs-number">65535</span></span>; error_log /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> warn; pid /var/run/nginx.pid; events { worker_connections <span class="hljs-number"><span class="hljs-number">4000</span></span>; # -    #       <span class="hljs-number"><span class="hljs-number">6</span></span> * <span class="hljs-number"><span class="hljs-number">4000</span></span> = <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span>  #    } http { map $http_upgrade $connection_upgrade { #    - <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> upgrade; <span class="hljs-string"><span class="hljs-string">''</span></span> close; } include /etc/nginx/mime.types; default_type application/octet-stream; log_format main <span class="hljs-string"><span class="hljs-string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span> <span class="hljs-string"><span class="hljs-string">'$status $body_bytes_sent "$http_referer" '</span></span> <span class="hljs-string"><span class="hljs-string">'"$http_user_agent" "$http_x_forwarded_for"'</span></span>; access_log /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/access.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> main; server_tokens off; sendfile on; #    tcp_nopush on; tcp_nodelay on; keepalive_timeout <span class="hljs-number"><span class="hljs-number">65</span></span>; gzip on; #  gzip gzip_comp_level <span class="hljs-number"><span class="hljs-number">6</span></span>; gzip_vary on; gzip_proxied any; gzip_buffers <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>k; gzip_types <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>/plain <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>/css application/json application/x-javascript <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>/xml application/xml application/xml+rss <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>/javascript application/javascript; gzip_static on; #     .gz  . , main.js.gz     main.js gzip_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; gzip_disable <span class="hljs-string"><span class="hljs-string">"MSIE [1-6]\.(?!.*SV1)"</span></span> proxy_connect_timeout <span class="hljs-number"><span class="hljs-number">60</span></span>; proxy_read_timeout <span class="hljs-number"><span class="hljs-number">620</span></span>; proxy_send_timeout <span class="hljs-number"><span class="hljs-number">320</span></span>; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; upstream backends { #ip_hash; # ,                least_conn; #  ,       #     #    <span class="hljs-number"><span class="hljs-number">10</span></span>,   <span class="hljs-number"><span class="hljs-number">10</span></span>  server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3001</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3002</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3003</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3004</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3005</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3006</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3007</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3008</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3009</span></span> weight=<span class="hljs-number"><span class="hljs-number">5</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>; # ,        server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3100</span></span> backup; } #    ssl .      ssl_certificate /etc/letsencrypt/live/consulwar.ru/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/consulwar.ru/privkey.pem; ssl_dhparam /etc/ssl/certs/dhparam.pem; ssl_stapling on; ssl_protocols TLSv1 TLSv1<span class="hljs-number"><span class="hljs-number">.1</span></span> TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_prefer_server_ciphers on; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!EXP:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA'</span></span>; server { server_name consulwar.ru; #   <span class="hljs-number"><span class="hljs-number">80</span></span>  <span class="hljs-number"><span class="hljs-number">443</span></span>  listen <span class="hljs-number"><span class="hljs-number">80</span></span>; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; #         location / { proxy_pass http:<span class="hljs-comment"><span class="hljs-comment">//backends; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; proxy_set_header X-Forwarded-For $remote_addr; } #     nginx location ~* \.(jpg|jpeg|gif|ico|png)$ { root /home/consulwar/app/current/programs/web.browser/app; } #  css  js   ,    location ~* "^/[a-z0-9]{40}\.(css|js)$" { root /home/consulwar/app/current/programs/web.browser; } location ~ "^/packages" { root /home/consulwar/app/current/programs/web.browser; } #  ,        , #    . location /nginx_status { stub_status on; access_log off; allow 127.0.0.1; deny all; } #   SSL  location ~ "^/.well-known" { root /home/consulwar/app/current/programs/web.browser/app/.well-known; } } include /etc/nginx/conf.d/*.conf; client_max_body_size 128m; }</span></span></code> </pre> </div></div><br><p>  Restart nginx </p><br><pre> <code class="bash hljs">sudo service nginx restart</code> </pre> <br><p>  We get SSL from Let's Enctypt. <br>  Of course, the domain should already be associated with this IP address. </p><br><pre> <code class="bash hljs">sudo apt-get install letsencrypt sudo letsencrypt certonly -a webroot --webroot-path=/home/consulwar/app/current/programs/web.browser/app -d consulwar.ru sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048 <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre> <br><p>  Out!  SSL Works </p></div></div><br><div class="spoiler">  <b class="spoiler_title">iptables</b> <div class="spoiler_text"><pre> <code class="bash hljs">sudo vi /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-up.d/00-iptables</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">00-iptables</b> <div class="spoiler_text"><pre> <code class="hljs dos">#!/bin/sh iptables-<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> &lt; /etc/firewall.conf ip6tables-<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> &lt; /etc/firewall6.conf</code> </pre> </div></div><br><pre> <code class="bash hljs">sudo chmod +x /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-up.d/00-iptables apt-get install xtables-addons-dkms sudo vi /etc/firewall.conf</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">firewall.conf</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">*<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> ACCEPT [<span class="hljs-number"><span class="hljs-number">193038</span></span>:<span class="hljs-number"><span class="hljs-number">64086301</span></span>] :FORWARD <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] :OUTPUT ACCEPT [<span class="hljs-number"><span class="hljs-number">194475</span></span>:<span class="hljs-number"><span class="hljs-number">60580083</span></span>] -A <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> -i lo -j ACCEPT #    -A <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> -m state <span class="hljs-comment"><span class="hljs-comment">--state RELATED,ESTABLISHED -p all -j ACCEPT #    #  SSH -A INPUT -m state --state NEW -p tcp -m multiport --dport 355 -j ACCEPT #   Nginx -A INPUT -m state --state NEW -p tcp -m multiport --dport 80,443 -j ACCEPT #    ,    ,    -A INPUT -p tcp -m tcp -j TARPIT #    -A INPUT -p udp -j DROP COMMIT</span></span></code> </pre> </div></div><br><pre> <code class="bash hljs">sudo vi /etc/firewall6.conf <span class="hljs-comment"><span class="hljs-comment">#     ,    sudo iptables-restore &lt; /etc/firewall.conf</span></span></code> </pre> <br><p>  itables are configured and excess ports are closed. </p></div></div><br><p>  DONE! </p><br><p>  If you like the approach / format - lay out the configuration of the mail system, infrastructure monitoring, CI via Bamboo and a number of other things we use. </p><br><p>  It is likely that I missed something (but in general, this is how it should work) - ask, I will add. <br>  I hope that someone will now take less time than me :-) </p><br><p>  PS: We have a <a href="https://moikrug.ru/vacancies/1000033368">vacancy for a front-end developer</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327624/">https://habr.com/ru/post/327624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327614/index.html">Explanation of Neural Turing Machines</a></li>
<li><a href="../327616/index.html">Extrasensory ability in design, which I have lost</a></li>
<li><a href="../327618/index.html">Recovering files after a Trojan cryptographer</a></li>
<li><a href="../327620/index.html">What awaits us in ReactOS version 0.4.5?</a></li>
<li><a href="../327622/index.html">Retail Sales Model</a></li>
<li><a href="../327628/index.html">Automated generation of circuit components from PDF files for Altium Designer</a></li>
<li><a href="../327630/index.html">Tmux Cheat Sheet (Terminal Multiplexer)</a></li>
<li><a href="../327636/index.html">Introduction to cryptography and encryption, part two. Lecture in Yandex</a></li>
<li><a href="../327638/index.html">Nodejs MVC framework or regular bike</a></li>
<li><a href="../327640/index.html">Introducing CockroachDB and creating a failover cluster with it on Ubuntu 16.04</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>