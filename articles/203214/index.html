<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate Update and Delete Operations for the Entity Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The ORM Entity Framework has an Achilles heel. It consists in the fact that of CRUD operations, only Create and Read are performed optimally. For Upda...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate Update and Delete Operations for the Entity Framework</h1><div class="post__text post__text-html js-mediator-article">  The ORM Entity Framework has an Achilles heel.  It consists in the fact that of CRUD operations, only Create and Read are performed optimally.  For Update and Delete in the version out of the box, we must first read the entire record from the database and only then can we update it.  And yes, in order to delete a record, we must also read it first. <br><br>  Those.  unhappy programmer should write something like <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShopEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ctx.Users) { ctx.Users.Remove(u); } ctx.SaveChanges(); }</code> </pre> <br><br>  But with the release of the package EntityFramework.Extended, the situation changes radically. <br><a name="habracut"></a><br>  So, install the package from the repository with the command ‚ÄúInstall-Package EntityFramework.Extended‚Äù.  Next we include the namespace ‚ÄúEntityFramework.Extensions‚Äù. <br>  And the magic begins. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now the removal looks like this. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShopEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itemsDeleted = ctx.Users.Delete(u =&gt; u.Orders.Count &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">//,      //,     ctx.SaveChanges(),    Console.WriteLine("{0} users were deleted", itemsDeleted); }</span></span></code> </pre><br><br>  By the way, it will not be superfluous to see what flew to the server. <br>  It was such a request <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> j0 <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [A1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Orders] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] = [Extent2].[UserID]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Project1].[C1] &gt; <span class="hljs-number"><span class="hljs-number">10</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> j1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (j0.[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] = j1.[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span></code> </pre><br><br>  As we see, this is an honest (albeit clumsy) request for group deletion with a condition. <br><br>  Similarly with the update records.  You no longer need to read data from the database before updating.  At the same time, we can use existing data in records, and are not limited to constants only. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShopEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itemsUpdated = ctx.Users.Where(u =&gt; u.Orders.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>).Update(u =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { BonusCount = u.BonusCount + <span class="hljs-number"><span class="hljs-number">1</span></span> }); <span class="hljs-comment"><span class="hljs-comment">//,      //,     ctx.SaveChanges(),    Console.WriteLine("{0} users were updated", itemsUpdated); }</span></span></code> </pre><br><br>  We look at the SQL query in the profiler. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> [BonusCount] = [BonusCount] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> j0 <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [A1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Orders] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] = [Extent2].[UserID]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Project1].[C1] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> j1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (j0.[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] = j1.[<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span></code> </pre><br><br>  These are the two main functions due to which it is worth installing this extension pack. <br>  But there is more sugar.  The creator of the package offers us to save the sample requests, then to carry them out for one approach.  To do this, we will mark the data as Future () before materialization and then, if any of the objects materialize, the rest will be materialized automatically. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShopEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> alexUsers = ctx.Users.Where(u =&gt; u.Name == <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>).Future(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usersWithOrders = ctx.Users.Where(c =&gt; c.Orders.Any()).Future(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> alexUsers) <span class="hljs-comment"><span class="hljs-comment">//          round-trip  . { Console.WriteLine("{0} {1}", item.ID, item.Name); } foreach (var item in usersWithOrders) //   SQL { Console.WriteLine("{0} {1}", item.ID, item.Name); } }</span></span></code> </pre><br><br>  But this was a SQL query <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Query #1 SELECT [Extent1].[ID] AS [ID], [Extent1].[Name] AS [Name], [Extent1].[IsTop10] AS [IsTop10], [Extent1].[BonusCount] AS [BonusCount] FROM [dbo].[Users] AS [Extent1] WHERE (N'Alex' = [Extent1].[Name]) AND ([Extent1].[Name] IS NOT NULL); -- Query #2 SELECT [Extent1].[ID] AS [ID], [Extent1].[Name] AS [Name], [Extent1].[IsTop10] AS [IsTop10], [Extent1].[BonusCount] AS [BonusCount] FROM [dbo].[Users] AS [Extent1] WHERE EXISTS (SELECT 1 AS [C1] FROM [dbo].[Orders] AS [Extent2] WHERE [Extent1].[ID] = [Extent2].[UserID] ); go</span></span></code> </pre><br><br>  In addition to the Future extension, FutureCount, FutureFirstOrDefault, FutureValue are also available. <br><br>  But that's not all.  Imagine that you have a module that handles frequent requests for rarely changeable data.  For example, user authorization.  Want to cache results?  You are welcome.  As can be seen from the code, the cache is not limited to the context, but remains relevant even after its re-creation. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShopEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> alexUsers = ctx.Users.Where(u =&gt; u.Name == <span class="hljs-string"><span class="hljs-string">"Alex"</span></span>).FromCache(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> alexUsers) <span class="hljs-comment"><span class="hljs-comment">//i == 0    , i == 1      { Console.WriteLine("{0} {1}", item.ID, item.Name); } } }</span></span></code> </pre><br><br>  The FromCache method has an overload to specify the exact cache time. <br><br>  Thus, the installation and use of EntityFramework.Extended allows not only to eliminate childhood diseases of EntityFramework, but also to accelerate it in places of high load without going to the lower level of stored procedures. </div><p>Source: <a href="https://habr.com/ru/post/203214/">https://habr.com/ru/post/203214/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203198/index.html">The book "Java. New generation of development "</a></li>
<li><a href="../203200/index.html">Data Modeling in Cassandra 2.0 in CQL3</a></li>
<li><a href="../203202/index.html">Installing jubber server prosody 0.9.7 in the OS family of Windows</a></li>
<li><a href="../203204/index.html">Samsung will pay Apple $ 290 million</a></li>
<li><a href="../203212/index.html">Create a map of the whole world based on OpenStreetMap data</a></li>
<li><a href="../203216/index.html">The implementation of online video advertising</a></li>
<li><a href="../203220/index.html">WebSphere Application Server Liberty Profile</a></li>
<li><a href="../203222/index.html">Sony Add-on SDK Update</a></li>
<li><a href="../203226/index.html">Nimbus Clipper - Android version</a></li>
<li><a href="../203228/index.html">Reverse engineering at the interview: how we hire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>