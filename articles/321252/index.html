<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tarantool: Good, Bad, Angry</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have heard of the Tarantool NoSQL database, they know that it can store data in memory, processes it very quickly and has high performance. Taran...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tarantool: Good, Bad, Angry</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/385/6cc/089/3856cc089151495db493dc8c642e1493.jpg" alt="image" align="left">  Many have heard of the <b>Tarantool</b> NoSQL database, they know that it can store data in memory, processes it very quickly and has high performance.  Tarantula was written by serious guys who serve services with hundreds of thousands of requests per second. <br><br>  The system seems complicated.  Despite Russian roots, initially there was not even documentation in Russian.  What can help this powerful tool for ordinary guys - programmers and novice developers?  The rest can immediately see the <a href="http://ugly.begetan.me/">result.</a> <br><br>  Let's try to write a simple entertaining service that can withstand a large load.  And no SQL! <br><a name="habracut"></a><br><h3>  Our goal </h3><br>  To fuel interest in the learning process, take a simple and interesting example of using Tarantula in web development.  We will launch the site, which displays a pair-wise vote for some pictures.  We will not upload photos of college students, like Mark Zuckerberg, but we will arrange a vote on the choice of a sticker for the <b>Telegram</b> messenger.  Our algorithm by voting will choose the top of the best stickers, but in reality our task is to find the main monster of the collection - Mr. The Ugly.  Now that there is motivation, it's time to do the boring things. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Installation </h3><br>  To crow somewhere god sent a piece of cheese.  We also got a modest virtual server with one processor core and 1 GB RAM - the younger offspring from a well-bred German family.  The operating system is Debian, so we can install Tarantula from the official repository: <a href="https://tarantool.org/download.html">tarantool.org/download.html</a> <br><br>  The manual says Copy and Paste, which we do with great enthusiasm: <br><br><pre><code class="hljs pgsql">curl http://download.tarantool.org/tarantool/<span class="hljs-number"><span class="hljs-number">1.7</span></span>/gpgkey | sudo apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>=`lsb_release -c -s` # install https download transport <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> APT sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y install apt-transport-https # append two lines <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> a list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> source repositories sudo rm -f /etc/apt/sources.list.d<span class="hljs-comment"><span class="hljs-comment">/*tarantool*.list sudo tee /etc/apt/sources.list.d/tarantool_1_7.list &lt;&lt;- EOF deb http://download.tarantool.org/tarantool/1.7/debian/ $release main deb-src http://download.tarantool.org/tarantool/1.7/debian/ $release main EOF # install sudo apt-get update sudo apt-get -y install tarantool</span></span></code> </pre> <br>  A little surprise from the developers: the i386 architecture is not supported in the official repository, although the package hosting service regularly provides all the files except the main one.  Make sure you install the packages on the AMD64 system to avoid trouble. <br><br><h3>  Beginning of work </h3><br>  After installation, we have a process <b>tarantool</b> , launched with a test configuration example.lua, like this: <br><br><pre> <code class="bash hljs">ps xauf | grep taran root 2735 0.0 0.2 13972 2132 pts/0 S+ 22:05 0:00 \_ grep taran taranto+ 568 0.0 0.8 812304 8632 ? Ssl 17:03 0:03 tarantool example.lua &lt;running&gt;</code> </pre><br>  To work with Tarantool, the <b>Lua</b> scripting language is used, in which server control commands are written, stored procedures and triggers are described.  You can load ready-made software modules or write your own. <br><br>  Run the tarantoolctl utility, print the first program and make sure that everything works. <br><br><pre> <code class="hljs pgsql">tarantoolctl <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-string"><span class="hljs-string">'3301'</span></span> connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> localhost:<span class="hljs-number"><span class="hljs-number">3301</span></span> localhost:<span class="hljs-number"><span class="hljs-number">3301</span></span>&gt; print (<span class="hljs-string"><span class="hljs-string">'The good!'</span></span>) <span class="hljs-comment"><span class="hljs-comment">--- ... localhost:3301&gt;</span></span></code> </pre> <br>  Now we are in the test configuration that comes with the distribution.  According to the <b>Debian</b> ideology, the settings are in the <i>/etc/tarantool/instances.available/*</i> directory, and the program's configuration is launched using a symbolic link in the <i>/etc/tarantool/instances.enabled/*</i> directory.  Copy the sample file under the new name and create our project. <br><br>  Our project is called <i>the good, the bad and the ugly</i> , in abbreviated <b>form</b> - <b>gbu</b> .  Use the abbreviation of the full name of the project to the first letters, and your colleagues will always treat your work with respect and awe! <br><br>  Now fix gbu.cfg a little and start the service.  Let me remind you that the configuration uses the syntax of the Lua language, in which comments begin with two hyphens. <br><br><pre> <code class="lua hljs">box.cfg { <span class="hljs-comment"><span class="hljs-comment">--          listen = 3311; --       slab_alloc_arena = 0.2; --      } local function bootstrap() local space = box.schema.create_space('example') space:create_index('primary') --     -- box.schema.user.grant('guest', 'read,write,execute', 'universe') --    box.schema.user.create('good', { password = 'secret' }) box.schema.user.grant('good', 'read,write,execute', 'universe') end --         box.once('example-2.0', bootstrap)</span></span></code> </pre><br>  We start the new instance with the tarantoolctl start gbu command and make sure that everything works as it should: <br><br><pre> <code class="hljs pgsql">tarantoolctl <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> "good:secret@0:3311" connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">3311</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">3311</span></span>&gt;</code> </pre><br>  We are in business! <br><br><h3>  Database </h3><br><ul><li>  Records in Tarantool are stored in spaces (space), this is such an analogue of a table in a relational SQL database.  They can be done as long as necessary - up to 65 thousand </li><li>  Inside the space are tuples, which are similar to both the row in the SQL table and the JSON array of data.  The maximum size of the tuple is up to 1 MB with the default settings.  This parameter can be changed. </li><li>  In order for the database to be useful, it is necessary to create indexes, just like in SQL.  Thanks to them, instead of going through the complete list of all the elements, the search is performed using a faster algorithm.  Sorting is also available.  The choice of index depends on the type of data. </li></ul><br>  <b>HASH index</b> : the value must be unique, and can be arbitrary.  This is how well-known Key / Value-storages are organized, also known as Map.  A good example is the MD5 hash checksum. <br><br>  <b>TREE-index</b> : the value may be non-unique, but must be ‚Äúdense‚Äù to organize a sorted list.  It turns out an array (Array), which may have missing elements.  A good example is the order number, which is incremented by one. <br><br>  If you need a unique value, then you can use HASH or TREE, while HASH will be faster on sparse data.  If you need a non-unique field by which sorting will be done, then only the TREE index can be used. <br><br>  There are also RTREE indices for searching on a two-dimensional plane and BITSET for working with bit data, but we will not need them.  Read more about this in the <a href="https://tarantool.org/ru/doc/book/box/data_model.html">documentation</a> . <br><br>  Picture from Eugene Shadrin's article <a href="http://highload.guide/blog/learning-tarantool.html">Mastering the Tarantula</a> .  By the way, a good guide for the initial dating. <br><br><img src="https://habrastorage.org/files/487/d24/228/487d242280d5463f97c27231ab529696.png" alt="Tarantool data model"><br><br><h3>  Project Data Model </h3><br>  In the data model of our application, we will create a space <b>stikers</b> to store information about files.  Please note that the numbering of the fields starts from 1, since the syntax of the Lua language is used.  The tuple includes the following fields: <br><br><ol><li>  unsigned id - unique sticker number </li><li>  integer rating - sticker rating </li><li>  string pack - the name of the sticker pack </li><li>  string name - the name of the sticker file </li><li>  (string) path - URL of the sticker </li><li>  (number) up - the number of votes per sticker </li><li>  (number) down - the number of votes against the sticker. </li></ol><br>  In the <b>packs</b> space, we will store a list of sticker packs: <br><br><ol><li>  string pack - the name of the sticker pack </li><li>  integer rating - sticker pack rating </li><li>  (string) path - link to the description page </li></ol><br>  In the <b>secrets</b> space we will store a token to encrypt the link to the image in order to implement the simplest anti-cheat protection: <br><br><ol><li>  string token - random token for a sticker </li><li>  integer time - token creation time (useful for deleting old ones) </li><li>  (integer) id - unique sticker number (space key stickers) </li><li>  (string) url - URL of the sticker </li></ol><br>  In the <b>sessions</b> space we will record visitors and collect statistics: <br><br><ol><li>  string uuid - unique character identifier of the visitor </li><li>  integer uuid_time - session creation time (useful for deleting old ones) </li><li>  (number) user_votes - how many times the visitor voted </li><li>  (string) ip - IP address of the visitor </li><li>  (string) agent - the type of the visitor's browser </li></ol><br>  In <b>server</b> space, we will simply collect site statistics: <br><br><ol><li>  Integer id - just key </li><li>  (number) visitors - the number of unique users </li><li>  (number) votes - the total number of votes </li><li>  (number) clicks - the total number of clicks in the vote </li></ol><br>  Note that in order to assign an index, you must explicitly specify the field type.  This type should be selected from the list of <a href="https://tarantool.org/doc/book/box/data_model.html">possible options for the</a> Tarantula. <br><br>  The remaining fields can be of any type that the built-in Lua interpreter supports.  This dualism of data types is a feature of the Tarantula and is mentioned in the <a href="https://tarantool.org/doc/book/box/data_model.html">documentation</a> .  For convenience, we specified the Lua data type in parentheses when describing the model. <br><br>  An important part in modeling is the compilation of indices.  Tarantula‚Äôs big advantage is that it can make complex composite indexes.  Due to this, we can write fast analytical queries based on various fields of the tuple without reducing the system performance.  Add a primary index of type TREE for the id field to provide a random selection of the item for voting.  The second index is of type TREE across the Raiting field, in order to display a rating, of course!  Add a composite index on the fields Pack + Emoj type HASH, which must be unique.  It can be used to analyze the popularity of sets of stickers. <br><br>  We will place the database creation code in our gbu.lua file, in the initialization procedure <br><br><div class="spoiler">  <b class="spoiler_title">function bootstrap ()</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bootstrap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> box.schema.user.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'good'</span></span>, { password = <span class="hljs-string"><span class="hljs-string">'secret'</span></span> }) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'good'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>) <span class="hljs-comment"><span class="hljs-comment">----------------------------------- --   local stickers = box.schema.create_space('stickers') --    stickers:create_index('primary', { type = 'TREE', parts = {1, 'unsigned'} }) --    stickers:create_index('secondary', { type = 'TREE', unique = false, parts = {2, 'integer'} }) --     stickers:create_index('ternary', { type ='HASH', parts = {3, 'string', 4, 'string'} }) ----------------------------------- --  - local packs = box.schema.create_space('packs') --   - packs:create_index('primary', { type = 'HASH', parts = {1, 'string'} }) --     packs:create_index('secondary', { type = 'TREE', unique = false, parts = {2, 'integer'} }) ----------------------------------- --    local secret = box.schema.create_space('secret') --     secret:create_index('primary', { type = 'HASH', parts = {1, 'string'} }) --      secret:create_index('secondary', { type = 'TREE', unique = false, parts = {2, 'integer'} }) ----------------------------------- --    local sessions = box.schema.create_space('sessions') --     sessions:create_index('primary', { type = 'HASH', parts = {1, 'string'} }) --      sessions:create_index('secondary', { type = 'TREE', unique = false, parts = {2, 'integer'} }) ----------------------------------- --    local server = box.schema.create_space('server') --   server:create_index('primary', { type = 'TREE', parts = {1, 'unsigned'} }) --   server:insert{1, 0, 0, 0} end</span></span></code> </pre><br></div></div><br>  Before restarting the server with the settings, try creating a scheme with commands in the console.  If something goes wrong, you can remove the entire space with the command: <code>box.space.stickers:drop()</code> <br>  or a separate index: <code>box.space.stickers.index.ternary:drop()</code> <br><br>  Feel free to use the TAB key prompt.  For convenience of working in the console, we write the names of the created elements of the scheme with a small letter.  Commands for working in the console become intuitive after a brief introduction to the documentation. <br>  Clear space: <code>box.space.stickers:truncate()</code> <br>  Delete space: <code>box.space.stickers:drop()</code> <br><br>  Everything happens instantly, as it should be for the In-memory Database! <br><br><h3>  Component installation </h3><br><img src="https://habrastorage.org/files/3fe/0a1/d32/3fe0a1d32e6641fdb7630d2d9df1f932.jpg" alt="Strong statement" align="right"><br>  <i>A good modern programming language should have static strong typing, Homoiconicity is a property that allows you to manipulate code as data, support for the PLO, FFI to C libraries, support for generics, competitive programming, Functions as first-class citizens, lambdas.</i> <br><br>  None of this in PHP, of course, no!  Therefore, we will write the code of the example on it. <br><br>  First, we put the proven tools - <b>Nginx</b> web server and PHP interpreter - <b>php-fpm</b> : <a href="https://wiki.debian.org/ru/nginx/nginx%2Bphp-fpm">wiki.debian.org/ru/nginx/nginx+php-fpm</a> <br><br>  Add the query rewrite rule to the root configuration path of nginx: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span>/ /index.php?q=<span class="hljs-variable"><span class="hljs-variable">$uri</span></span>&amp;<span class="hljs-variable"><span class="hljs-variable">$args</span></span>; }</code> </pre> <br>  Thus, we can get beautiful links of the form / good from the <code>$_REQUEST['q']</code> array in the PHP script, and implement the routing of HTTP requests. <br><br>  We also have a locale to execute CGI requests: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* \.php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/var/run/php5-fpm.sock; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  The command <code>expires -1;</code>  we disable the caching of requests, it is not needed for the voting pages and the output of the Top Charts.  The rest of the locale cache data for 24 hours or 30 days from the upstream HTTP settings.  Probably, everyone has their own collection of Nginx options. <br><br>  Now you need to put the module to work with the Tarantula: <br><br><pre> <code class="bash hljs">sudo apt-get install php5-cli php5-dev php-pear pecl channel-discover tarantool.github.io/tarantool-php/pecl pecl install Tarantool-PHP/Tarantool-beta</code> </pre> <br>  We read what is written in the output of the installer.  In my case there was a message: <br><br><pre> <code class="bash hljs">Build process completed successfully Installing <span class="hljs-string"><span class="hljs-string">'/usr/lib/php5/20131226/tarantool.so'</span></span> install ok: channel://tarantool.github.io/tarantool-php/pecl/Tarantool-0.0.13 configuration option <span class="hljs-string"><span class="hljs-string">"php_ini"</span></span> is not <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to php.ini location You should add <span class="hljs-string"><span class="hljs-string">"extension=tarantool.so"</span></span> to php.ini</code> </pre> <br>  Add the specified line to the configuration file in the <i>/etc/php5/fpm/php.ini</i> file and <i>/etc/php5/cli/php.ini</i> .  Unfortunately, when you start PHP, we get an error!  In order not to suffer with debugging of the web server, we added a new library to the cli configuration, so you can check the functionality from the command line. <br><br><pre> <code class="bash hljs">php -v PHP Warning: PHP Startup: Unable to load dynamic library <span class="hljs-string"><span class="hljs-string">'/usr/lib/php5/20131226/tarantool.so'</span></span> - /usr/lib/php5/20131226/tarantool.so: undefined symbol: tarantool_schema_destroy <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Unknown on line 0 PHP 5.6.29-0+deb8u1 (cli) (built: Dec 13 2016 16:02:08)</code> </pre> <br>  At the time of this writing, the module in the PEAR repository contained an error, so the only thing left is the Jedi way ‚Äî building the driver from the source codes. <br><br><pre> <code class="bash hljs">pecl uninstall Tarantool-PHP/Tarantool-beta <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/tarantool/tarantool-php.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tarantool-php phpize ./configure make make install</code> </pre> <br><h3>  Data loading </h3><br>  Let's create the first file and call it <b>test.php</b> , in it we will check the operation of our database. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $tarantool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tarantool(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">3311</span></span>, <span class="hljs-string"><span class="hljs-string">'good'</span></span>, <span class="hljs-string"><span class="hljs-string">'secret'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $tarantool-&gt;ping(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Exception: "</span></span>, $e-&gt;getMessage(), <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br>  Run the <code>php config.php</code> from the command line and check how it worked.  If configured incorrectly, we get an error message.  Check out! <br><br>  Now you can write a parser that will collect data from the site we need.  We will explore <a href="https://tlgrm.ru/stickers">tlgrm.ru/stickers</a> .  First, load the table <b>pack</b> , in which we have a census of sticker packs.  This is what the insert command looks like on the tarantool command line: <br><br><pre> <code class="lua hljs">box.space.packs:upsert({<span class="hljs-string"><span class="hljs-string">'key1'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}, {{<span class="hljs-string"><span class="hljs-string">'='</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}})</code> </pre> <br>  This command adds the new key ‚Äúkey1‚Äù (in field 1) and the value 0 (in field 2).  If a record exists, it is updated for the same record (= sign) in field 2 with value 0. As we remember, in field 2 we have a rating, which we initially use at 0. The <b>upsert command is</b> convenient to use for running the parser multiple times during debugging to do not delete the entered data each time.  The PHP version of the command will look like this: <br><br><pre> <code class="php hljs">$tarantool-&gt;upsert(<span class="hljs-string"><span class="hljs-string">'packs'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ($pack,<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"field"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"op"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"arg"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) ));</code> </pre><br>  Ah-ah!  In PHP, the numbering of fields with 0, and in Lua c 1. Therefore, <code>"field" =&gt; 1</code> from the PHP array corresponds to the <code>{'=',2,0}</code> entry in Lua.  Wherever the arrays start from zero, the current connectors work the same way.  This behavior has been changed since version 1.6.  Reading examples on the Internet, pay attention to the version of the Tarantula!  This article is written according to version 1.7, and about version 1.5, developers are asked not to remember at all. <br><br>  We make the record for the sticker using the built-in <b>auto_increment</b> procedure, which automatically increases the primary index.  Tarantula team: <br><br><pre> <code class="lua hljs">box.space.stickers:auto_increment({<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">'pack2'</span></span>,<span class="hljs-string"><span class="hljs-string">'sticker2'</span></span>})</code> </pre> <br>  PHP: <br><br><pre> <code class="php hljs">$tarantool-&gt;call(<span class="hljs-string"><span class="hljs-string">'box.space.stickers:auto_increment'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,$pack, $i . <span class="hljs-string"><span class="hljs-string">'.png'</span></span>, $url, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ));</code> </pre> <br>  So, the script is written.  Run it - vzhuh, and magic!  Now we have a database with 16,000 entries! <br><br><h3>  We write the program </h3><br>  To begin with we will make the simplest query router, as is usually done in PHP: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># Get routes from request $route = isset($_REQUEST['q']) ? $_REQUEST['q'] : '/'; $vote_plus = isset($_REQUEST['vote_plus']) ? $_REQUEST['vote_plus'] : ''; $vote_minus = isset($_REQUEST['vote_minus']) ? $_REQUEST['vote_minus'] : ''; switch ($route) { case '/good': action_good(); break; case '/bad': action_bad(); break; case '/ugly': action_ugly(); break; case '/about': action_about(); break; default: if (!empty($vote_plus) &amp;&amp; !empty($vote_minus)) { sleep (1); do_post($vote_plus, $vote_minus); } action_main(); }</span></span></code> </pre> <br>  Note the presence of two variables, <b>$ vote_plus</b> and <b>$ vote_minus</b> , which will be transmitted in a POST request when voting for one or another picture.  The fact is that, knowing the name and path of the file is very easy to wind the voting bots, but we do not need it.  Therefore, we will generate a pair of unique tokens for the voting page, one for each image.  After the vote, the token will be deleted, making it impossible to reuse the vote. <br><br>  Since in PHP before the release of version 7.0 the situation with crypto-secure functions is sad, I will help the rich capabilities of Tarantula to work with cryptography. <br><br>  To begin with, in the action_main function, we initiate a random number generator with a crypto-safe (i.e. truly random) seed: <br><br><pre> <code class="php hljs"> $r = $tarantool-&gt;evaluate( <span class="hljs-string"><span class="hljs-string">"digest = require('digest') return (digest.urandom(4))"</span></span> ); $seed = unpack(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, $r[<span class="hljs-number"><span class="hljs-number">0</span></span>])[<span class="hljs-number"><span class="hljs-number">1</span></span>]; srand($seed);</code> </pre> <br>  The <b>$ tarantool-&gt; evaluate ()</b> function is used directly to start the Lua code without messing with the creation of a stored procedure.  Then we call the <b>create_random_vote ()</b> function <b>twice</b> , which will select a random element in space and create a URL for the image and tokens. <br><br><div class="spoiler">  <b class="spoiler_title">function create_random_vote ()</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_random_vote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment"># Get random sticker id global $tarantool; $tuple = $tarantool-&gt;call("box.space.stickers.index.primary:random", array(rand())); $id = $tuple[0][0]; $url = $tuple[0][4]; # Create random sticker token $token = $tarantool-&gt;evaluate( "digest = require('digest') return ( digest.md5_hex(digest.urandom(32)))" )[0]; $time = time(); # Set secure token to protect post action ################################################################## # # box.space.secret:insert({key', 0, 456, 'bla-bla'}) # ################################################################## $tarantool-&gt;insert('secret', array ($token, $time, $id, $url)); return array ( $url, $token ); }</span></span></code> </pre> <br></div></div><br>  Two more functions were used here: <b>$ tarantool-&gt; call ()</b> for calling embedded procedures and <b>$ tarantol-&gt; insert ()</b> for inserting a new record. <br><br>  Here is an example of a voting update procedure that updates the rating of a record: <br><br><div class="spoiler">  <b class="spoiler_title">function update_votes ($ id, $ plus, $ minus)</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_votes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id, $plus, $minus)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $tarantool; <span class="hljs-comment"><span class="hljs-comment">########################################################### # # box.space.stickers:update(1, {{'+', 6, 1}, {'+', 7, -1}}) # ########################################################### $tarantool-&gt;update("stickers", $id, array ( array( "field" =&gt; 5, "op" =&gt; "+", "arg" =&gt; $plus ), array( "field" =&gt; 6, "op" =&gt; "+", "arg" =&gt; $minus ) ) ); }</span></span></code> </pre> <br></div></div><br>  For a complete list of Tarantool class methods, see the <a href="https://github.com/tarantool/tarantool-php">tarantool-php</a> documentation. <br><br>  Note the " <code>op" =&gt; "="</code> parameter, which means that the field is replaced in an existing tuple.  There is also a parameter +, - and some other operations.  They perform a very important task.  Usually, to replace a value in the database, we first read some field, then change it.  To maintain data consistency, you have to block access to the table and use transactions.  In Tarantula, due to its architecture, the <b>update</b> and <b>upsert</b> commands work atomically inside the server process without locking the database.  It allows you to build damn fast systems! <br><br>  The code of the index.php file at the time of this writing is under the spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment"># Init database $tarantool = new Tarantool('localhost', 3301, 'good', 'bad'); try { $tarantool-&gt;ping(); } catch (Exception $e) { echo "Exception: ", $e-&gt;getMessage(), "\n"; } const MIN_VOTES = 20; // Number of votes to show the ugly const UPDATE_PLUS = 1; // Increment for positive update const UPDATE_MINUS = -1; // Increment for negative update const NO_UPDATE = 0; const COOKIE = 'uuid'; // Cookie name const HIDDEN = '/img/Question.svg';// Picture for hidden element # Get routes from request $route = isset($_REQUEST['q']) ? $_REQUEST['q'] : '/'; $vote_plus = isset($_REQUEST['vote_plus']) ? $_REQUEST['vote_plus'] : ''; $vote_minus = isset($_REQUEST['vote_minus']) ? $_REQUEST['vote_minus'] : ''; # Get cookie from request or create new value $cookie = isset($_COOKIE[COOKIE]) ? $_COOKIE[COOKIE] : update_user(''); switch ($route) { case '/good': action_good(); break; case '/bad': action_bad(); break; case '/ugly': action_ugly($cookie); break; case '/about': action_about(); break; default: # This is post request: if (!empty($vote_plus) &amp;&amp; !empty($vote_minus)) { sleep (1); $cookie = update_user($cookie); do_post($vote_plus, $vote_minus); } setcookie(COOKIE, $cookie, time() + (86400 * 30), "/"); action_main(); } exit(); function action_main() { global $tarantool; # Get crypto safe random seed from Tarantool LUA module # https://tarantool.org/doc/reference/reference_lua/digest.html $r = $tarantool-&gt;evaluate( "digest = require('digest') return (digest.urandom(4))" ); $seed = unpack('L', $r[0])[1]; srand($seed); list ($left_url, $left_token_plus) = create_random_vote(); list ($right_url, $right_token_plus) = create_random_vote(); $left_token_minus = $right_token_plus; $right_token_minus = $left_token_plus; update_stats(UPDATE_PLUS, NO_UPDATE); $title = '    Telegram'; include_once('main.html'); } function action_good() { $title = '   Telegram'; $top = get_top(10,Tarantool::ITERATOR_LE); $active_good ='class="active"'; $active_bad =''; include_once('top.html'); } function action_bad () { $title = '   Telegram'; $active_bad ='class="active"'; $active_good =''; $top = get_top(10,Tarantool::ITERATOR_GE); # Hide the ugly $top[0][4] = HIDDEN; include_once('top.html'); } function action_ugly($user) { $title = '  Telegram'; $top = get_top(1,Tarantool::ITERATOR_GE); $votes = get_session($user); # Hide the ugly until getting enough votes if ($votes &lt; MIN_VOTES) { $ugly_message = " " . MIN_VOTES . "    &lt;br&gt;"; $ugly_message .= " " . (MIN_VOTES - $votes) . " "; $ugly_img = HIDDEN; } else { $ugly_img = $top[0][4]; } include_once('ugly.html'); } function action_about() { $title = '  ?'; list($stickers, $shows, $votes, $visitors) = get_server_stats(); include_once('about.html'); } function do_post($vote_plus, $vote_minus) { global $tarantool; $tuple_plus = $tarantool-&gt;select("secret", $vote_plus); $tuple_minus = $tarantool-&gt;select("secret", $vote_minus); $id_plus = $tuple_plus[0][2]; $id_minus = $tuple_minus[0][2]; # Clean up used tokens if (!empty($vote_plus) &amp;&amp; !empty($vote_minus)) { $tarantool-&gt;delete("secret", $vote_plus); $tarantool-&gt;delete("secret", $vote_minus); } # Get actual tuple data if (!empty($id_plus) &amp;&amp; !empty($id_minus)) { $raiting = +1; update_rating($id_plus, $raiting); $raiting = -1; update_rating($id_minus, $raiting); update_votes($id_plus, UPDATE_PLUS, NO_UPDATE); update_votes($id_minus, NO_UPDATE, UPDATE_MINUS); update_stats(NO_UPDATE, UPDATE_PLUS); } } function create_random_vote() { # Get random sticker id global $tarantool; $tuple = $tarantool-&gt;call("box.space.stickers.index.primary:random", array(rand())); $id = $tuple[0][0]; $url = $tuple[0][4]; # Create random sticker token $token = $tarantool-&gt;evaluate( "digest = require('digest') return ( digest.md5_hex(digest.urandom(32)))" )[0]; $time = time(); # Set secure token to protect post action ################################################################## # # box.space.secret:insert({key', 0, 456, 'bla-bla'}) # ################################################################## $tarantool-&gt;insert('secret', array ($token, $time, $id, $url)); return array ( $url, $token ); } function update_rating($id, $update) { global $tarantool; ################################################# # # box.space.stickers:update(7856, {{'+', 2, 10}}) # ################################################# $tarantool-&gt;update("stickers", $id, array ( array( "field" =&gt; 1, "op" =&gt; "+", "arg" =&gt; $update ) )); } function update_votes($id, $plus, $minus) { global $tarantool; ########################################################### # # box.space.stickers:update(1, {{'+', 6, 1}, {'+', 7, -1}}) # ########################################################### $tarantool-&gt;update("stickers", $id, array ( array( "field" =&gt; 5, "op" =&gt; "+", "arg" =&gt; $plus ), array( "field" =&gt; 6, "op" =&gt; "+", "arg" =&gt; $minus ) ) ); } function update_user($cookie) { global $tarantool; # Create uuid if first time user if (empty($cookie)) { ################################## # # uuid = require('uuid') # uuid() # ################################## $uuid = $tarantool-&gt;evaluate( "uuid = require('uuid') return (uuid.str())" )[0]; } else { $uuid = $cookie; } $time = time(); $ip = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : ''; $agent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : ''; # Create session or update user stat inside ########################################################### # # box.space.sessions:upsert({'111222333', 123456, 0, 'ip', 'agent'}, # {{'=', 2, 1}, {'+', 3, 1}, {'=', 4, 'ip'}, {'=', 5, 'agent'}}) # ########################################################### # Please check https://github.com/tarantool/tarantool-php/issues/111 $tarantool-&gt;upsert("sessions", array($uuid, $time, 0, $ip, $agent), array ( array( "field" =&gt; 1 "op" =&gt; "=", "arg" =&gt; $time ), array( "field" =&gt; 2 "op" =&gt; "+", "arg" =&gt; 1 ), array( "field" =&gt; 3 "op" =&gt; "=", "arg" =&gt; $ip ), array( "field" =&gt; 4, "op" =&gt; "=", "arg" =&gt; $agent ) ) ); return($uuid); } function update_stats($vote, $click) { global $tarantool; ######################################################## # # box.space.server:update(1, {{'+', 3, 1}, {'+', 4, 1}}) # ######################################################## $tarantool-&gt;update("server",1, array ( array( "field" =&gt; 2, "op" =&gt; "+", "arg" =&gt; $vote ), array( "field" =&gt; 3, "op" =&gt; "+", "arg" =&gt; $click ) ) ); } function get_session($sid) { global $tarantool; ########################################## # # box.space.sessions:select('id') # ######################################### if (strlen($sid) &gt; 16) { return $tarantool-&gt;select("sessions", $sid)[0][2]; } else { return 0; } } function get_top($limit, $iterator) { global $tarantool; ###################################################################################### # # box.space.stickers.index.secondary:select({primary}, {iterator = box.index.GE, offset=0, limit=10}) # ###################################################################################### $result = $tarantool-&gt;select("stickers", null, 'secondary', $limit, 0, $iterator); return $result; } function get_server_stats() { global $tarantool; $time = time() - 30*86400; // one month before $stickers = $tarantool-&gt;call('box.space.stickers:count')[0][0]; $tuple = $tarantool-&gt;select('server',1); $shows = $tuple[0][2]; $votes = $tuple[0][3]; $visitors = $tarantool-&gt;call('box.space.sessions.index.secondary:count', array($time, array('iterator' =&gt; Tarantool::ITERATOR_GE)) )[0][0]; # $shows, $votes, $visitors) = get_server_stats(); return array($stickers, $shows, $votes, $visitors); } ?&gt;</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It remains to make HTML-templates that will display data with pictures for voting on the site and rating pages. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sample code for voting pictures</font></font></b> <div class="spoiler_text"><pre> <code class="hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"voting container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"voting-zone"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sticker"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"voteFormLeft"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"idForm"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pic1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"left_url"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $left_url?&gt;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vote left"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vote_plus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $left_token_plus?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vote_minus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $left_token_minus?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sticker"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"voteFormRight"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"idForm"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pic2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"right_url"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $right_url?&gt;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vote right"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vote_plus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $right_token_plus?&gt;"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vote_minus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $right_token_minus?&gt;"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Has anyone managed to meet in the life of a designer-maker who would perfectly format the HTML code? </font></font><br><br><img src="https://habrastorage.org/files/cdc/c21/059/cdcc210593fe444ba803ae152f86156a.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the above code, it is not difficult to guess that we gave out the same pair of tokens for the left and right pictures, just changed the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vote_plus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vote_minus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">(Usually, such phrases as the author emphasizes his intellectual superiority over readers). </font><font style="vertical-align: inherit;">Thus, no matter what user clicks on the picture, it will get a plus, and its competitor will get a minus. </font><font style="vertical-align: inherit;">The loser each time gets more and more minuses and falls lower and lower to hell. </font><font style="vertical-align: inherit;">There he and the road HA - HA - HA!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The reader, who got to the end of the article, suffered the author's trolling and boiled more than once from his stupidity, he deserves a well-deserved reward. </font><font style="vertical-align: inherit;">What could be more interesting than a real working example that you can poke and poke? </font><font style="vertical-align: inherit;">Come and vote for Telegram stickers on </font></font><a href="http://ugly.begetan.me/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ugly.begetan.me</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to find out which of them is the ugliest. </font><font style="vertical-align: inherit;">Dig a mouse on our Russian fileload, compiled from NGNIX, PHP-FPM and Tarantool. </font><font style="vertical-align: inherit;">And do not forget to show the link to your girlfriend, because you need a lot of votes to get a statistically reliable picture of the vote.</font></font></div><p>Source: <a href="https://habr.com/ru/post/321252/">https://habr.com/ru/post/321252/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321242/index.html">Why I do not like synthetic tests</a></li>
<li><a href="../321244/index.html">Work with Flexbox in gifs</a></li>
<li><a href="../321246/index.html">How to create a Viber bot using PHP</a></li>
<li><a href="../321248/index.html">How IT professionals work. Nikolai Grigoriev, architect of mobile games and applications</a></li>
<li><a href="../321250/index.html">We write the easiest and fastest input type file</a></li>
<li><a href="../321254/index.html">Pass to the ground - how Apple Pay and Samsung Pay were launched in Yandex.Money</a></li>
<li><a href="../321256/index.html">The logic of consciousness. Part 11. Natural coding of visual and sound information</a></li>
<li><a href="../321258/index.html">ReactOS at FOSDEM 2017</a></li>
<li><a href="../321260/index.html">Procedural level generation for MERC in Unity</a></li>
<li><a href="../321262/index.html">Logging with rsyslog, file names in tags, multi-line messages and fault tolerance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>