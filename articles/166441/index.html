<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We program AGC (auto volume control) on VB.Net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is intended for beginners audiophiles who want to understand how the automatic volume control works (aka AGC and AGC ). Immediately I warn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We program AGC (auto volume control) on VB.Net</h1><div class="post__text post__text-html js-mediator-article">  The article is intended for beginners audiophiles who want to understand how the automatic volume control works (aka <abbr title="Automatic gain control">AGC</abbr> and <abbr title="Automatic Gain Controller or Automatic Level Control">AGC</abbr> ).  Immediately I warn you that it will not go about how to get sound from a microphone or set the recording level of a sound card.  Input data will be taken from the file, and even raw.  If after this there remains a desire to make a parody of a long-invented bicycle with our own hands and experience the pioneering delight of discovery, then let's go! <a name="habracut"></a><br><br><h1>  Theory </h1><h2>  General principles </h2><br>  The task, in fact, is quite simple: measure the current volume level, calculate the required gain and multiply the current value of the input signal by it.  The one that follows with a frequency of 44.1 kHz or the like.  For convenience of calculations, we take the maximum possible signal value per unit.  If we want to always amplify to the maximum amplitude, then the calculation of the gain reduces to <b>k = 1 / v</b> , where <b>v</b> is the current volume level, and <b>k</b> is the gain.  This is clear, but how to calculate <b>v</b> ?  Let's see how the finished AGC does it.  Here is its block diagram: <br><br><img src="https://habrastorage.org/storage2/cd0/a7d/a56/cd0a7da56901db0f75825a30a8af585e.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first three blocks are involved in calculating the current volume level. <div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  Some blocks are drawn as ‚Äúblack boxes‚Äù, because the device of their hardware analogs is unknown to me.  For example, a diode bridge as a rectifier is not suitable, if only because it does not allow connecting the ground of the input directly to the ground of the circuit.  But for us it is not important, because our AGC is software.  We continue. </div></div>  Valid values ‚Äã‚Äãof <b>v</b> we have from 0 to 1, right?  Not.  We will divide it into it, but we cannot divide it by 0!  Therefore, it is necessary to introduce some kind of maximum gain factor <b>kmax</b> , for example, 100, which will act in minutes of silence.  That is, the admissible values ‚Äã‚Äãof <b>v</b> we will have from <b>1 / kmax</b> to 1. From 0.01 to 1, that is. <br><br>  Now we recall that the input values ‚Äã‚Äãrange from -1 to 1. We do not need negative values ‚Äã‚Äãfor <b>v</b> , therefore we turn them into positive values ‚Äã‚Äãusing a rectifier.  If the output of the rectifier is a value less than 0.01, then fix it to 0.01.  This deals with the limiter. <br><br>  Now the fun part.  The input signal varies over a wide frequency range.  After the rectifier and the limiter, this range has expanded even more.  And we need to AGC worked smoothly, allowing sharp jumps <b>k</b> only in moments when the input suddenly turned out to be a loud sound.  In other cases, we do not need high oscillation frequencies <b>k</b> .  We will get rid of them.  "What?  Zaryrn in the ranks of Fourier?  Oh, yooooo! ‚Äù- the young reader is indignant.  Do not panic!  A simpler way is suitable for our purpose.  If our AGC were hardware, we would use a smoothing capacitor.  A mathematical embodiment of a capacitor is an exponential decay.  Here is how it works.  Denote the value at the output of the limiter by the letter <b>u</b> .  We also need the previous value of <b>v</b> .  If <b>u&gt; v</b> , then we jump: <b>v = u</b> ;  otherwise, quietly pull <b>v</b> to <b>u</b> : <b>v = v - b * (v - u)</b> .  That is exactly what <b>b</b> determines and how quietly we pull up.  It is only slightly greater than zero, so with each step we will reduce <b>v</b> by a tiny amount.  You can calculate <b>b</b> before the AGC begins to work like this: <b>b = 1 - 10 ^ (-1 / (sr * rt))</b> , where <b>sr</b> is the sampling rate of the input signal (44100 Hz or the like), <b>rt</b> is the approximate response time (adjustable parameter, default 10 seconds).  In other words, if after a loud sound there is <b>rt</b> seconds of silence, then <b>v</b> during this time will pull up to <b>u</b> so that the difference between them will decrease by 10 times.  So we got an asymmetric low pass filter (AFNCH).  Asymmetric because it responds instantly to an increase in <b>u</b> , and responds to a decrease in a slow encroachment.  A reaction time of 10 seconds means that the filter suppresses frequencies above 0.1 Hz and skips the rest.  This, of course, is a <i>very rough</i> statement; in fact, there is no clear boundary for filtering.  Nevertheless, the frequency of 0.1 Hz is far beyond the limit of the audible range, that is, the rectifier clicks almost will not penetrate the filter and annoy the standard listener.  But only when there are no jumps. <br><br><h2>  Clipping </h2><br>  Now let's take a closer look at what happens during jumps.  Usually they last several samples in a row.  All this time, the asymmetric ‚Äúvalve‚Äù of the filter is open, and the gain is dramatically adjusted to the unusual volume.  As a result, the values ‚Äã‚Äãof these several samples abut the "ceiling" and distort the shape of the sound wave.  In English, this is called clipping, and the ear is perceived as a hoarse.  Here‚Äôs what it looks like in a sound editor: <br><br><img src="https://habrastorage.org/storage2/ba9/848/6f8/ba98486f8ce47b88b84d554873f6a7a6.png"><br><br><h2>  Anticlipping </h2><br>  Can we somehow deal with clipping?  Yes.  And it will help us in this that our AGC will work not in real time, but on previously recorded data.  Having found a jump, we will easily go back in time and correct the gain for several previous samples.  How far should you go back?  Before the first transition of the input signal value through 0. In the picture this moment is shown by a white arrow.  Why is he the most suitable?  Yes, because the amplifier will multiply 0 by <b>k</b> , the product does not change from changing the places of the multipliers, and multiplying by 0 gives 0. That is, a sharp drop in <b>k will</b> smooth out naturally, and the listener will feel that our AGC was peering into the future (although in fact it changed the past) and at the time of going through 0, I knew in advance that a jump would follow.  As it looks in the sound editor - we will see by launching the program.  It's time to move on to practice! <br><br><h1>  Practice </h1>  We will build under Windows on VB.Net, so the first thing we need is Visual Studio.  I used Visual Basic 2010 Express.  Who likes other development tools, those who know the theory, easily remake the program to your liking. <br><br><h2>  Data format </h2><br>  The second thing we need is input.  Raw, in the format of 16 bit <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F">PCM</a> .  A file of this format is a sequence of unsigned 16-bit signed integers.  Numbers are written in the <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">style of</a> Intel: first the low byte, followed by the most significant one (and the order of the bits in the bytes themselves is not inverted).  Each such number stores the value of the input signal.  32767 corresponds to 1, -32767 is -1, well, 0 it is 0. And -32768?  Let it be -1 too - small error.  Here is one way to get this file: <ol><li>  Create a Windows PCM wav file in the sound editor, 16 bit per sample, <u>mono</u> , uncompressed.  You also need to disable saving any additional information that is not directly related to the sound (if our sound editor has such an option). </li><li>  Cut the first 0x2C bytes from the file.  This is a headline.  Make sure that there are an even number of bytes, we have 2 bytes per sample. </li><li>  Change the file extension to pcm. </li></ol><br>  Or you can wipe the header with zeros - the AGC will think it is silence.  Or slightly complicate the program so that it stupidly copied the first 0x2C bytes from the input file to the output.  Then it will be possible to feed wav to it itself, without converting it into pcm.  But we will leave this for a bright future, and now we have the following input data: <br><br><img src="https://habrastorage.org/storage2/4c8/6e0/da8/4c86e0da86a1ea81a02728b05b98ae43.png"><br><br>  This is a human speech, in which one word is specifically marked by a loud act of censorship.  This word is ‚ÄúX‚Äù and not ‚ÄúHabr‚Äù at all. <br><br><h2>  Buffering </h2><br>  And the third thing we need is some way to store a small piece of data for anticlipping.  One second is enough with a margin, because in most real audio signals the transition through 0 occurs many times per second.  For such purposes there is a ready-made class CircleArchive.  Its copies work on the principle of a tape recorder with a ring tape: you can shove as much data as you like at the input, and when overflowed, the old data is overwritten by new ones.  Here is the source: <br><div class="spoiler">  <b class="spoiler_title">CircleArchive.vb</b> <div class="spoiler_text"><pre><code class="hljs sql">Public Class CircleArchive Private InternalCapacity As Integer Private InternalArray() As Object Private InternalLength As Integer Private InternalStart As Integer Public Sub New(ByVal setCap As UShort) If (setCap = 0) Then InternalCapacity = UShort.MaxValue + 1 Else InternalCapacity = setCap <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> InternalStart = <span class="hljs-number"><span class="hljs-number">0</span></span> InternalLength = <span class="hljs-number"><span class="hljs-number">0</span></span> InternalArray = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(InternalCapacity - <span class="hljs-number"><span class="hljs-number">1</span></span>) {} <span class="hljs-string"><span class="hljs-string">'need to specify maxindex, not size as the parameter End Sub Public Sub AddObject(ByVal ObjectToAdd As Object) Dim NewIndex As Integer If IsFull Then '</span></span>overwrite the oldest InternalArray(InternalStart) = ObjectToAdd InternalStart = (InternalStart + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> NewIndex = (InternalStart + InternalLength) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(NewIndex) = ObjectToAdd InternalLength += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetObjectFIFO(ByVal <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> Dim r <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> Dim TrueIndex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) AndAlso (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; InternalLength)) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> TrueIndex = (InternalStart + <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity r = InternalArray(TrueIndex) ElseIf (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got negative value: "</span></span> &amp; Index.ToString) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got "</span></span> &amp; Index.ToString &amp; <span class="hljs-string"><span class="hljs-string">" when "</span></span> &amp; InternalLength.ToString &amp; <span class="hljs-string"><span class="hljs-string">" item(s) stored"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetObject(ByVal <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-string"><span class="hljs-string">'just an alias for GetObjectFIFO Return GetObjectFIFO(Index) End Function Public Function GetObjectLIFO(ByVal Index As Integer) As Object Dim r As Object = Nothing Dim TrueIndex As Integer If ((Index &gt;= 0) AndAlso (Index &lt; InternalLength)) Then TrueIndex = InternalLength - 1 - Index '</span></span>invert TrueIndex = (InternalStart + TrueIndex) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity r = InternalArray(TrueIndex) ElseIf (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got negative value: "</span></span> &amp; Index.ToString) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got "</span></span> &amp; Index.ToString &amp; <span class="hljs-string"><span class="hljs-string">" when "</span></span> &amp; InternalLength.ToString &amp; <span class="hljs-string"><span class="hljs-string">" item(s) stored"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Clear</span></span>() Dim i <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> Dim TrueIndex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> (InternalLength - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">'nullify existing items TrueIndex = (InternalStart + i) Mod InternalCapacity InternalArray(TrueIndex) = Nothing Next InternalLength = 0 End Sub '</span></span><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub QuickClear() <span class="hljs-string"><span class="hljs-string">' InternalLength = 0 '</span></span><span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ReadOnly Property <span class="hljs-keyword"><span class="hljs-keyword">Capacity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> InternalCapacity <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Property <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ReadOnly Property <span class="hljs-keyword"><span class="hljs-keyword">Length</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> InternalLength <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Property <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ReadOnly Property IsFull <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> (InternalLength = InternalCapacity) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Property <span class="hljs-string"><span class="hljs-string">'additional features Public Sub RemoveObjects(ByVal Index As Integer, ByVal Count As Integer) Dim r As Object = Nothing Dim TrueIndexSrc As Integer Dim TrueIndexDst As Integer Dim TrueCount As Integer Dim i As Integer If ((Index &lt; 0) OrElse (Index &gt;= InternalLength)) Then Exit Sub End If If (Count &lt;= 0) Then Exit Sub End If If (Count &lt; (InternalLength - Index)) Then TrueCount = Count Else TrueCount = InternalLength - Index End If If (TrueCount = InternalLength) Then '</span></span>need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">Clear</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-string"><span class="hljs-string">'need to delete part of the items For i = Index To (Index + TrueCount - 1) TrueIndexSrc = (InternalStart + i) Mod InternalCapacity InternalArray(TrueIndexSrc) = Nothing Next '</span></span>nullification <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'the beginning has been deleted InternalStart = (InternalStart + TrueCount) Mod InternalCapacity '</span></span>just <span class="hljs-keyword"><span class="hljs-keyword">move</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span> ElseIf ((<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> + TrueCount) &lt; InternalLength) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'need array shift '</span></span>decide what direction it will be faster <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> shift <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ((InternalLength - <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> - TrueCount) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'shift the end For i = (Index + TrueCount) To (InternalLength - 1) TrueIndexSrc = (InternalStart + i) Mod InternalCapacity TrueIndexDst = (InternalStart + i - TrueCount) Mod InternalCapacity InternalArray(TrueIndexDst) = InternalArray(TrueIndexSrc) InternalArray(TrueIndexSrc) = Nothing Next Else '</span></span>shift the <span class="hljs-keyword"><span class="hljs-keyword">beginning</span></span> i = <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> (i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) TrueIndexSrc = (InternalStart + i) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity TrueIndexDst = (InternalStart + i + TrueCount) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(TrueIndexDst) = InternalArray(TrueIndexSrc) InternalArray(TrueIndexSrc) = <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> i -= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> InternalStart = (InternalStart + TrueCount) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity <span class="hljs-string"><span class="hljs-string">'move the start position End If '</span></span><span class="hljs-built_in"><span class="hljs-built_in">array</span></span> shift direction <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'the third case is the end has been deleted: we don'</span></span>t need neither <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">movement</span></span> nor <span class="hljs-built_in"><span class="hljs-built_in">array</span></span> shift InternalLength -= TrueCount <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'(not) TrueCount = InternalLength End Sub '</span></span>RemoveObjects <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub RemoveFirst(ByVal <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>) RemoveObjects(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub RemoveLast(ByVal <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>) RemoveObjects((InternalLength - <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub InsertObject(ByVal ObjectToInsert <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>, ByVal InsBefore <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>) Dim TrueIndexSrc <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> Dim TrueIndexDst <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> Dim i <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> Dim FirstElementBuf <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ((InsBefore &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) AndAlso (InsBefore &lt; InternalLength)) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (InsBefore = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> IsFull) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'no need array shift, just move the start position 1 step backward InternalStart = (InternalStart + InternalCapacity - 1) Mod InternalCapacity InternalArray(InternalStart) = ObjectToInsert '</span></span><span class="hljs-keyword"><span class="hljs-keyword">and</span></span> increase <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> InternalLength += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'Not IsFull Else '</span></span>need <span class="hljs-built_in"><span class="hljs-built_in">array</span></span> shift <span class="hljs-string"><span class="hljs-string">'decide what direction it will be faster to shift If (InsBefore &gt; (InternalLength \ 2)) Then '</span></span>shift the <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> i = InternalLength - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> (i &gt;= InsBefore) TrueIndexSrc = (InternalStart + i) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity TrueIndexDst = (InternalStart + i + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(TrueIndexDst) = InternalArray(TrueIndexSrc) i -= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> TrueIndexDst = (InternalStart + InsBefore) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(TrueIndexDst) = ObjectToInsert <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> IsFull <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'the oldest was overwritten, need to move the start position 1 step forward InternalStart = (InternalStart + 1) Mod InternalCapacity Else InternalLength += 1 End If '</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>) IsFull <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-string"><span class="hljs-string">'shift the beginning FirstElementBuf = InternalArray(InternalStart) For i = 1 To (InsBefore - 1) TrueIndexSrc = (InternalStart + i) Mod InternalCapacity TrueIndexDst = (InternalStart + i - 1) Mod InternalCapacity InternalArray(TrueIndexDst) = InternalArray(TrueIndexSrc) Next TrueIndexDst = (InternalStart + InsBefore - 1) Mod InternalCapacity InternalArray(TrueIndexDst) = ObjectToInsert If (Not IsFull) Then '</span></span><span class="hljs-keyword"><span class="hljs-keyword">move</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span> InternalStart = (InternalStart + InternalCapacity - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(InternalStart) = FirstElementBuf InternalLength += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'Not IsFull End If '</span></span><span class="hljs-built_in"><span class="hljs-built_in">array</span></span> shift direction <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'(not) InsBefore = 0 ElseIf (InsBefore &lt; 0) Then Throw New IndexOutOfRangeException("got negative value: " &amp; InsBefore.ToString) Else Throw New IndexOutOfRangeException("got " &amp; InsBefore.ToString &amp; " when " &amp; InternalLength.ToString &amp; " item(s) stored") End If End Sub '</span></span>InsertObject <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Sub ReplaceObject(ByVal <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>, ByVal NewObject <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>) Dim TrueIndex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) AndAlso (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; InternalLength)) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> TrueIndex = (InternalStart + <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Mod</span></span> InternalCapacity InternalArray(TrueIndex) = NewObject ElseIf (<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got negative value: "</span></span> &amp; Index.ToString) <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> Throw <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> IndexOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"got "</span></span> &amp; Index.ToString &amp; <span class="hljs-string"><span class="hljs-string">" when "</span></span> &amp; InternalLength.ToString &amp; <span class="hljs-string"><span class="hljs-string">" item(s) stored"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-string"><span class="hljs-string">'ReplaceObject End Class</span></span></code> </pre> </div></div><br><h2>  To battle! </h2><br>  We start the Visual Studio, in a hurry we create the Windows Form Application, we pile into the window a bunch of controls. <br><img src="https://habrastorage.org/storage2/7e9/258/816/7e9258816e4d58acab7ecd47c5cdc09f.png"><br>  Even Target Volume had time to add.  This is the amplitude to which we will increase.  Valid positive values ‚Äã‚Äãare up to and including 1.  Now we add the CircleArchive class to the project and selflessly write the code. <br><div class="spoiler">  <b class="spoiler_title">Form1.vb</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> Form1 Private Structure AGCBufferElement <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> InputPCMVal <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Short <span class="hljs-string"><span class="hljs-string">' ,    Public OutputPCMVal As Short '</span></span> ,      <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure Private Sub ButtonAGC_Click(sender <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>, e <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventArgs) Handles ButtonAGC.Click Dim InputFileName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> String = My.Application.<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>.DirectoryPath &amp; "\Input.pcm" Dim OutputFileName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> String = My.Application.<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>.DirectoryPath &amp; "\Output.pcm" Dim InputFileStream <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO.FileStream = <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> Dim OutputFileStream <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO.FileStream = <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span> Dim NSamples <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> Long <span class="hljs-string"><span class="hljs-string">'    Dim SampleIndex As Long Dim OneSecBufIndex As Integer '</span></span>       anticlipping Dim kmax <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> = <span class="hljs-type"><span class="hljs-type">Decimal</span></span>.ToDouble(NumericUpDownMaxGain.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>) Dim TargetVolume <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> = <span class="hljs-type"><span class="hljs-type">Decimal</span></span>.ToDouble(NumericUpDownTargetVol.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>) <span class="hljs-string"><span class="hljs-string">'     Dim vmin As Double '</span></span>  Dim AGCLeap <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Boolean</span></span> <span class="hljs-string"><span class="hljs-string">'  Dim k As Double '</span></span>  Dim b <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> <span class="hljs-string"><span class="hljs-string">'  Dim CurrBuf As AGCBufferElement '</span></span>  PCM Dim PrevBuf <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> AGCBufferElement Dim u <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> <span class="hljs-string"><span class="hljs-string">'  Dim v As Double '</span></span> ,        Dim OneSecBuf <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> CircleArchive <span class="hljs-string"><span class="hljs-string">'       anticlipping Dim NegHalfwave As Boolean '</span></span>     <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">'  Try If (My.Computer.FileSystem.FileExists(InputFileName)) Then InputFileStream = New System.IO.FileStream(InputFileName, IO.FileMode.Open) OutputFileStream = New System.IO.FileStream(OutputFileName, IO.FileMode.Create) End If Catch ex As Exception End Try If ((InputFileStream IsNot Nothing) AndAlso (OutputFileStream IsNot Nothing)) Then '</span></span> vmin = TargetVolume / kmax b = <span class="hljs-number"><span class="hljs-number">1.0</span></span> - Math.Pow(<span class="hljs-number"><span class="hljs-number">10.0</span></span>, (<span class="hljs-number"><span class="hljs-number">-1.0</span></span> / <span class="hljs-type"><span class="hljs-type">Decimal</span></span>.ToDouble(<span class="hljs-type"><span class="hljs-type">Decimal</span></span>.Multiply(NumericUpDownSampleRate.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>, NumericUpDownFalloffTime.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>)))) v = vmin OneSecBuf = <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> CircleArchive(CUShort(NumericUpDownSampleRate.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>)) InputFileStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span> NSamples = InputFileStream.Length \ <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">'2 bytes per sample '</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> SampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> (NSamples - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">'  PCM   CurrBuf.InputPCMVal = CShort(InputFileStream.ReadByte) '</span></span>LSB first (Intel manner) CurrBuf.InputPCMVal = CurrBuf.InputPCMVal <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> (CShort(InputFileStream.ReadByte) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-string"><span class="hljs-string">'MSB last (Intel manner) If (CurrBuf.InputPCMVal = Short.MinValue) Then CurrBuf.InputPCMVal += 1 '</span></span>     <span class="hljs-number"><span class="hljs-number">-32767</span></span> .. <span class="hljs-number"><span class="hljs-number">32767</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'  Double    If (CurrBuf.InputPCMVal &lt; 0) Then u = -CurrBuf.InputPCMVal / Short.MaxValue Else u = CurrBuf.InputPCMVal / Short.MaxValue End If '</span></span>   <span class="hljs-string"><span class="hljs-string">' If (u &lt; vmin) Then u = vmin End If '</span></span>   <span class="hljs-string"><span class="hljs-string">'  AGCLeap = (u &gt; v) If AGCLeap Then v = u End If '</span></span>   ,      k = TargetVolume / v <span class="hljs-string"><span class="hljs-string">'   '</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (AGCLeap AndAlso CheckBoxAnticlipping.Checked) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">' anticlipping:            0 NegHalfwave = (CurrBuf.InputPCMVal &lt; 0) '</span></span>     ? OneSecBufIndex = OneSecBuf.Length - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> (OneSecBufIndex &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) PrevBuf = CType(OneSecBuf.GetObjectFIFO(OneSecBufIndex), AGCBufferElement) <span class="hljs-string"><span class="hljs-string">'   0 If (PrevBuf.InputPCMVal = 0) Then Exit While ElseIf (NegHalfwave Xor (PrevBuf.InputPCMVal &lt; 0)) Then Exit While End If '</span></span>     ,    <span class="hljs-number"><span class="hljs-number">0</span></span>   PrevBuf.OutputPCMVal = PrevBuf.InputPCMVal * k <span class="hljs-string"><span class="hljs-string">'    PCM        (   ,  k  ) OneSecBuf.ReplaceObject(OneSecBufIndex, PrevBuf) '</span></span>  OneSecBufIndex -= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">' ,  ,    End While '</span></span>   OneSecBuf <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">' anticlipping CurrBuf.OutputPCMVal = CurrBuf.InputPCMVal * k '</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> OneSecBuf.IsFull <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'             ,    PrevBuf = CType(OneSecBuf.GetObjectFIFO(0), AGCBufferElement) Try '</span></span>   OutputFileStream.WriteByte(CByte(PrevBuf.OutputPCMVal <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> Byte.MaxValue)) <span class="hljs-string"><span class="hljs-string">'LSB first (Intel manner) OutputFileStream.WriteByte(CByte((PrevBuf.OutputPCMVal &gt;&gt; 8) And Byte.MaxValue)) '</span></span>MSB last (Intel manner) Catch ex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Try <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-string"><span class="hljs-string">'OneSecBuf.IsFull OneSecBuf.AddObject(CurrBuf) '</span></span>     OneSecBuf <span class="hljs-string"><span class="hljs-string">' ,      If (Not AGCLeap) Then v = v - b * (v - u) '</span></span>  v      <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> Next <span class="hljs-string"><span class="hljs-string">'     '</span></span> OneSecBuf <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> OneSecBufIndex = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> (OneSecBuf.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>) PrevBuf = CType(OneSecBuf.GetObjectFIFO(OneSecBufIndex), AGCBufferElement) Try OutputFileStream.WriteByte(CByte(PrevBuf.OutputPCMVal <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> Byte.MaxValue)) <span class="hljs-string"><span class="hljs-string">'LSB first (Intel manner) OutputFileStream.WriteByte(CByte((PrevBuf.OutputPCMVal &gt;&gt; 8) And Byte.MaxValue)) '</span></span>MSB last (Intel manner) Catch ex <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Try Next <span class="hljs-string"><span class="hljs-string">'   OneSecBuf End If '</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (OutputFileStream IsNot <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> OutputFileStream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (InputFileStream IsNot <span class="hljs-keyword"><span class="hljs-keyword">Nothing</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> InputFileStream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> MsgBox("The end.") <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Sub <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span></code> </pre></div></div><br>  As can be seen from the code, the program will take the file Input.pcm, lying next to its exe (put it there if you have not had time yet) and create Output.pcm there with the result of the work.  We start.  We set Falloff Time 10 seconds (this is the reaction time), Max Gain 20, Target Volume 0.95 (to see anticlipping in all its glory).  Do not forget about the sampling frequency, because it is not stored in the file with raw data.  Turn on Anticlipping and press the button.  It turned out Output.pcm?  Of course yes!  Convert it back to wav, returning the title to the place, listen.  We load in the sound editor and we see: <br><br><img src="https://habrastorage.org/storage2/5fe/e98/2f7/5fee982f798c29de1c8646737becd198.png"><br><br>  You can see how the AGC gradually comes to life after a deafening squeak, carefully returning the gain to the previous level.  In this process, the reaction time we set is of primary importance.  Now look at the fragment, which was recently an example of clipping. <br><br><img src="https://habrastorage.org/storage2/d5c/678/4ff/d5c6784ff3051f33975303ae814cf390.png"><br><br>  This is exactly the place where the censor begins.  By the way, finally a little more about anticlipping ... <br><br><h1>  Instead of conclusion </h1>  Our anticlipping algorithm is far from optimal.  The usual leap, I remind you, lasts several samples in a row.  Processing each of them, we again and again go back in time and recalculate a significant amount of data, wasting processor time.  Instead, you should only go back when the jump is over, before proceeding to a decay.  And to guess that for this we need to add to the code, we will not be difficult. </div><p>Source: <a href="https://habr.com/ru/post/166441/">https://habr.com/ru/post/166441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166427/index.html">Triac power controller with microcontroller control</a></li>
<li><a href="../166429/index.html">Competition for students and supervisors: "Microsoft UniApps Challenge"</a></li>
<li><a href="../166433/index.html">Creating a pivot table of attendance of several sites using Yandex.Metrics</a></li>
<li><a href="../166435/index.html">What nobody told you about z-index</a></li>
<li><a href="../166439/index.html">Usability Hint: The scroll bar on the comment page should display the actual position in the text.</a></li>
<li><a href="../166443/index.html">An app that overtakes Instagram</a></li>
<li><a href="../166451/index.html">International Web Camp will come to Russia as part of Windows Azure Summit</a></li>
<li><a href="../166453/index.html">SeoPult Max - by leader pattern</a></li>
<li><a href="../166457/index.html">Internet in numbers: world statistics for 2012</a></li>
<li><a href="../166459/index.html">Students are expelled for using a web vulnerability scanner</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>