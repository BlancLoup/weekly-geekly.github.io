<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modeling PHP flight on the wings of Erlang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article outlines the thoughts and fantasies on the topic "how to combine Erlang and PHP to make universal happiness happen", and not a descriptio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modeling PHP flight on the wings of Erlang</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage/074d55cb/60ab54be/a663de18/f66763d3.png">  <i>This article outlines the thoughts and fantasies on the topic "how to combine Erlang and PHP to make universal happiness happen", and not a description of the finished technology or product.</i>  <i>However, we intend to implement it, most likely, in the form of an open-source project, unless, of course, the respected habra audience dissuade :) Actually, one of the main tasks of this article is to understand how interesting the idea is and potentially useful to the wider PHP community .</i>  <i>By the way, some of the problems discussed in the article are also valid for other popular scripting languages ‚Äã‚Äã(I mean Ruby and Python here), so the proposed solution may also be relevant for them.</i> <br><a name="habracut"></a><br><h1>  Prehistory </h1>  Due to certain objective and subjective circumstances, PHP is used as a language for server programming in <a title="Megaplan site" href="http://megaplan.ru/">Megaplan</a> .  Over time, we began to embarrass and annoy some of the limitations of PHP, we began to miss some of the "advanced" features, such as: multithreading, delayed launch, message queues, etc.  In addition, we are limited to using our own custom solutions for each problem, since Megaplan is not only a SaaS application, but also comes in the form of a cross-platform boxed version for three OS types: server Windows, Linux and FreeBSD.  Adding the next custom component (even if there was a cross-platform solution) significantly complicates the installation and support of the boxes.  Even the lack of a normal standard crond in Windows is annoying. <br><br>  In general, there is a need to "pump up" PHP.  There is, of course, an alternative radical solution - to move to Java, but for us this is not an option - too much of the worst code has already been written in several years.  Besides, I'm not sure that you can elegantly solve the problem of a large-scale comet on JVM.  And PHP is too early to write off - it is still the most popular language for web development (at least in Russia), programmers are easier to find than for other languages. <br><br>  On the basis of a ripe need and the fact that at a certain moment I caught sight of and very much liked Erlang, the idea of ‚Äã‚Äãsolving problems matured - to build an Erlang virtual machine into our standard environment and compensate for the shortcomings of PHP with the unique capabilities of this functional language. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, I‚Äôll talk about what tasks with the help of ‚Äúclean‚Äù PHP are made with difficulty and what features we lack, and then I will describe the proposed solution.  So‚Ä¶ <br><br><h1>  Problems </h1>  In this article, I assume that long-running processes in PHP are an exceptionally unreliable crutch, under which you need to substitute another crutch so that it somehow lives.  It does not inspire optimism even the fact that in PHP 5.3 there appeared a <a title="PHP documentation link" href="http://php.net/manual/en/features.gc.php">normal garbage collector</a> .  <a title="article on Habr√© about phpDaemon" href="http://habrahabr.ru/blogs/php/79377/">PhpDaemon does</a> not convince, which many people like, but is tied to libevent, therefore it will not work under Windows.  Currently, there is no normal native and, most importantly, reliable way to "demonize" PHP programs.  And even if you try to go to work with <a title="habrasslink" href="http://habrahabr.ru/blogs/php/103875/">FastCGI</a> , you still need a controller, who will restart the process regularly.  In short, in my opinion, the only PHP production mode is the classic FastCGI (or apache + prefork + mod_php under unix-like systems). <br><br>  Almost all the restrictions that will be discussed are associated with this circumstance. <br><br><h2>  Background launch </h2><br>  I think many developers who wrote in PHP a little more than ‚ÄúHello World!‚Äù Faced the problem of delayed launch, for example, with the simplest task of sending email in response to some user action.  In PHP, there are 2 solutions for such a task (both ugly): <br><ul><li>  or try to send a letter directly online immediately in the same script and risk running into the inactivity and unavailability of the postal service, </li><li>  or write down somewhere a task to send and once a minute, pull a script on cron, which the tasks will rake. </li></ul>  Familiar?  You will probably argue that there are other ways, for example, such a perversion: to form a new process using pcntl.  But here I will answer that this is at least not cross-platform, and generally looks like a hack.  And you want to have a beautiful and reliable solution. <br><br><h2>  Comet </h2><br>  All the newfangled tasty things like long-polling, websockets, etc., of course, can be done in pure PHP, but this is only at the cost of a whole long-standing php process for each connection.  On any serious amount of clients of resources you will not save enough on such luxury. <br><blockquote>  <i><font color="grey">I hear someone in the far ranks give a hint about mod_php (worker) mod_pp with a couple of.</font></i>  <i><font color="grey">Guys, do not use thread-safe php in production, this is wrong.</font></i>  <i><font color="grey">Moreover, on really serious loads, even this will not save.</font></i> </blockquote>  And we really want to have a common event space between the client and the server.  Well, imagine this fairy tale: the server initiates an event: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span>
    Event::publish( <span class="hljs-string"><span class="hljs-string">'common.users.onlinecountchanged'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'count'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) );
<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>
</code></pre><br>
                 :<br>
<br>
<pre><code class="javascript hljs">Event.subscribe( <span class="hljs-string"><span class="hljs-string">'common.users.onlinecountchanged'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{
    $(<span class="hljs-string"><span class="hljs-string">'#onlinecount'</span></span>).html(data.count);
} );
</code></pre><br>
 ,    web-jabber-,    .<br>
<br>
<h2>  cron</h2><br>
Cron-    PHP-,    cron'   :<br>
<ul>
<li>   .</li>
<li>     PHP- , ,     -   .</li>
</ul>               .       ,   ,     ,      ¬´    cron'   ‚Äî    -    ¬ª,              ,     ,        PHP-.<br>
<br>
       ,<br>
<ul>
<li>       PHP-,</li>
<li>      ,</li>
<li>   PHP  ,     ,</li>
<li>   cron,      ,     PHP-.</li>
</ul><br>
<h2>  (message queue)</h2><br>
  ‚Äî      .  ,     ,    ,     . ,            ¬´ ¬ª    .<br>
<br>
      , , <a title=" abrdev" href="http://abrdev.com/%3Fp%3D1153">     </a>.<br>
<br>
<h1></h1>   ,           PHP    ,    ,     <a title="  Erlang" href="http://www.erlang.org/">Erlang</a>.<br>
<br>
 Erlang?<br>
<ul>
<li>Erlang   ,      .      .        .</li>
<li>       GPL- ,      .</li>
<li>               ‚Äî      Comet'.</li>
<li> Erlang'             AMQP ‚Äî <a title="  RabbitMQ" href="http://www.rabbitmq.com/">RabbitMQ</a>.</li>
<li> ,       ,     .</li>
</ul>,    <a title="  " href="http://kkovacs.eu/running-yaws-with-drupal-wordpress-zend-framework">  ,    PHP-  CMS  YAWS</a> (<a title=" " href="http://kkovacs.eu/running-yaws-with-drupal-wordpress-zend-framework">YAWS</a> ‚Äî  -,   Erlang')         PHP  Erlang',     ‚Äî    , ,  , ! :)<br>
<br>
<h2></h2><br>
      ,      .<br>
<img src="https://habrastorage.org/storage/392eac2e/815aea21/61a0d5a2/d44aa2bc.png"><br>
 :<br>
<ul>
<li>Nginx     ,       ¬´Nginx ‚Äî  ,      ?!¬ª. ,  ,   ,  ,     Erlang'    ,  .       .</li>
<li>Mochiweb      .    -,   Erlang',  ‚Äî     .</li>
<li>    FastCGI,        PHP-, , , ¬´¬ª    AMQP     (,    ),    ‚Äî     ,     .</li>
</ul>      ,        .<br>
<br>
<h2>   ‚Äî RabbitMQ</h2><br>
  ‚Äî    ,     .  ¬´ ¬ª            ,            .<br>
<br>
      <a href="http://www.amqp.org/">AMQP</a>.   <a href="http://habrahabr.ru/search/page1/%3Fq%3Damqp"> </a>     ,     .    ,   : <a title="AMQP -" href="http://habrahabr.ru/blogs/webdev/62502/"></a>  <a title="RabbitMQ:   AMQP" href="http://habrahabr.ru/blogs/erlang/64192/"></a>.   ,    PHP: <a title="  MQ (Messages queue)      " href="http://habrahabr.ru/blogs/hi/44907/"></a>, <a title="AMQP    PHP" href="http://habrahabr.ru/blogs/personal/70757/"></a>  <a title="PHP-AMQP    ?" href="http://habrahabr.ru/blogs/webdev/73904/"></a>.<br>
<br>
<h3>   (pub-sub)</h3><br>
  RabbitMQ     pub-sub .  ,     PHP  ,       -  .    PHP          (   <a title="" href="http://www.php.net/manual/en/book.amqp.php">PECL AMQP</a>):<br>
<br>
<pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span>
<span class="hljs-comment"><span class="hljs-comment">//   RabbitMQ</span></span>
    $cnn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AMQPConnection();
    $cnn-&gt;connect();
<span class="hljs-comment"><span class="hljs-comment">//  ,     </span></span>
    $ex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AMQPExchange( $cnn );
    $ex-&gt;declare( <span class="hljs-string"><span class="hljs-string">'event-exchange'</span></span>, AMQP_EX_TYPE_TOPIC );
<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    $ex-&gt;publish( <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-string"><span class="hljs-string">'some.object.event'</span></span> );
<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>
</code></pre><br>
 ,     -    Erlang',     <code>some.object.event</code>     REST: <code>http://example.com/example-action</code>.    Erlang,      ,      (     -PHP,   ):<br>
<br>
<pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    </span></span>
    amqp_declare_exchange( <span class="hljs-string"><span class="hljs-string">'event-exchange'</span></span>, AMQP_EX_TYPE_TOPIC );
    amqp_declare_queue( <span class="hljs-string"><span class="hljs-string">'external-app-queue'</span></span> );
<span class="hljs-comment"><span class="hljs-comment">//         </span></span>
    amqp_bind( <span class="hljs-string"><span class="hljs-string">'external-app-queue'</span></span>, <span class="hljs-string"><span class="hljs-string">'event-exchange'</span></span>, <span class="hljs-string"><span class="hljs-string">'some.object.*'</span></span> );
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
    amqp_subscribe( <span class="hljs-string"><span class="hljs-string">'external-app-queue'</span></span> );
<span class="hljs-comment"><span class="hljs-comment">// ,       </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span> )
    {
        $msg = receive_message();
        file_get_contents( <span class="hljs-string"><span class="hljs-string">"http://example.com/example-action?msg=$msg"</span></span> );
    }
</code></pre><br>
 ,  PHP-     <code>event-exchange</code>   <code>some.object.event</code>,  ,   <code>external-app-queue</code>     ,    <code>some.object.event</code>,      .  , ,     Erlang-,    ,        callback'    (   ‚Äî  REST-  HTTP).<br>
<blockquote><i><font color="grey">     ,     :)</font></i></blockquote><br>
<h2> FastCGI</h2><br>
    FastCGI-  Erlang'?  -   .    ,   php-fpm  Windows, ,  ,    , ,   .          -  PHP,  LAMP.<br>
<br>
, ,    ,   .<br>
<br>
<h2>-  Comet</h2><br>
-  Erlang'      ‚Äî           (long-polling)       ‚Äî         Erlang'  .     ,   comet         -,    <a title="Comet ‚Äî  " href="http://habrahabr.ru/blogs/webdev/104945/">  </a>.<br>
<br>
Comet         ,   ,    Erlang--    -,  long-polling   ,   http-        push-  .    :<br>
<ol>
<li>Javascript-     ,     .</li>
<li>Erlang-,      RabbitMQ  ,                .        ,        ,      .</li>
<li>PHP-     RabbitMQ,      comet-,     .</li>
<li>      ,    .      push-.</li>
<li>   callback push-        .</li>
<li>Push-     (  long-polling).</li>
</ol><br>
<h2> </h2><br>
     , , ,   ,          :      ,             .     :<br>
<ul>
<li>   HTTP-REST API.          .</li>
<li> PHP- (    Erlang'),  ¬´¬ª     AMQP     .</li>
</ul><br>
<h2>Cron</h2><br>
             Erlang.            ,    .   ,     ,          .   Erlang' ,  ,   ,        (. ),    .    ,        AMQP,   REST API     .<br>
<br>
   ,    cron', , ,    ( ,   -    ),      ,       PHP  (,     ), ,    ,    PHP-.<br>
<br>
<h1> </h1><blockquote><i><font color="grey">       ,      :)</font></i></blockquote>,   ,     :<br>
<ul>
<li>    <b></b>    -  PHP.</li>
<li>     PHP    .</li>
<li>    -  real-time .</li>
<li>  Erlang'.</li>
</ul> ,    :)<br>
<br>
<strong> ? Welcome!</strong></div><p>Source: <a href="https://habr.com/ru/post/119839/">https://habr.com/ru/post/119839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119832/index.html">I twist, twirl, I want to charge</a></li>
<li><a href="../119833/index.html">How to overcome Facebook EdgeRank and get into the news feed</a></li>
<li><a href="../119834/index.html">FFmpeg audio / video file converter</a></li>
<li><a href="../119837/index.html">Competition for developers with a prize pool of $ 100,000 and the first affiliate conference for participants in the Evernote Gallery</a></li>
<li><a href="../119838/index.html">14-year-old caught "hacker" is now working on Microsoft</a></li>
<li><a href="../119840/index.html">Completed HTML5 Games Contest</a></li>
<li><a href="../119841/index.html">Five ways to call a function</a></li>
<li><a href="../119842/index.html">HTC Flyer review. Flight to Ukraine</a></li>
<li><a href="../119843/index.html">Another attack on Sony</a></li>
<li><a href="../119845/index.html">iPhone 5 and new display</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>