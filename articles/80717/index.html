<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simultaneous use of two providers on cisco routers (continued)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Simultaneous use of two providers 

 If in the first case everything is clear and unambiguous, then in the case of simultaneous use of two providers, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simultaneous use of two providers on cisco routers (continued)</h1><div class="post__text post__text-html js-mediator-article">  <b>Simultaneous use of two providers</b> <br><br>  If in the <a href="http://habrahabr.ru/blogs/cisconetworks/80555/">first case</a> everything is clear and unambiguous, then in the case of simultaneous use of two providers, problems arise. <br>  To begin with: we need both providers to check for ‚Äúliveliness‚Äù and switch all threads to one in case someone ‚Äúfalls‚Äù.  This is done completely analogous to the ISP1 check in the chapter on Reservations.  With the only difference that both routes by default have the same administrative distance. <br><br><pre>   ip route 0.0.0.0 0.0.0.0 Gate (ISP1) track 11
   ip route 0.0.0.0 0.0.0.0 Gate (ISP2) track 22
</pre><br><a name="habracut"></a><br>  NATa rules do not change.  The same route-map in dynamic and static broadcasts.  But how to determine which package to send through which provider?  It is possible to forcibly scatter incoming packets from g0 / 0 with another route-map. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> !  We prepare access lists with ‚Äúinteresting‚Äù traffic.  Everyone knows what is
 !  "Interesting" traffic?  :)
 ip access-list extended ACLISP1
   permit {traffic to ISP1}
 !
 ip access-list extended ACLISP2
   permit {traffic to ISP2}
 !
 route-map STRELKA 10
   match ip address ACLISP1
   set ip next-hop {GateISP1}
 route-map STRELKA 20
   match ip address ACLISP2
   set ip next-hop {GateISP2}
 !
 int g0 / 0
   ip policy route-map STRELKA
</pre><br>  The truth is that in this case the packet that got into ACLISP1 will always go to the first provider, regardless of whether the provider is alive or not.  To avoid this, it is possible in this route-map to apply a check on the track. <br><br><pre>   set ip next-hop verify-reachability {GateISPX} {sequence #} track {track #}
</pre><br>  sequence # is a number from 1 to 65535. If there are many such possible next-hop, then they will be ordered by that number. <br><br>  Let me remind you that if the package does not explicitly fall into the route-map, it will use the usual routing table. <br><br>  Well, now let's try to deal with two very complex issues: how will the packets go if you do not explicitly use traffic separation using the route-map on the internal interface.  And how to make so that the packet that came outside to the address of the Srv server (ISP1) went back through the same interface through which it came.  These are really hard questions.  And there is no beautiful solution for them, so in my practice I try to avoid such topologies. <br>  However, life can make, so we will understand. <br><br>  Let the packet come from outside to interface f0 / 0 to the address Srv (ISP1).  Thanks to the static broadcast, the destination address will be changed to Srv (LAN) and the packet will go further to the server.  A Srv (LAN) and Srv (ISP1) correspondence entry appears on the router in the NAT cache of the broadcasts.  The server will answer, the answer will come back to the router and ... a question will arise: what route should the packet be sent to the Internet?  In the cache of broadcasts there is an explicit record of what address to put instead of Srv (LAN) - Srv (ISP1).  But there is not a hint through which interface to send a packet.  To correct this ambiguity, it is necessary, according to some criterion, to separate traffic coming from different interfaces.  This can be achieved, but the way, in my opinion, is not very elegant: it is necessary to use the substitution of real addresses of clients for different pools of internal addresses.  It is only necessary to choose the size of this pool according to the load on the server - one address for each addressing, since  For external NATa (outside NAT) on routers, you cannot make a PAT (Port Address Translation), only the translation of the address to the address.  Then it is always known from which interface the request came.  As a criterion for server address translation, you can add such access lists to existing route maps. <br><br><pre> ip access-list extended FORISPX
   permit ip host Srv (LAN) OUTPOOLX
</pre><br>  Thus we get: <br><br><pre> !  we set pools for each of interfaces
 ip nat pool OUTPOOL1 {start-ip-1} {end-ip-1}
 ip nat pool OUTPOOL2 {start-ip-2} {end-ip-2}
 !
 !  we set criteria for outside NAT
 ip access-list extended OUTNAT1
   permit ip any host Srv (ISP1)
 ip access-list extended OUTNAT2
   permit ip any host Srv (ISP2)
 !
 !  broadcast customer source addresses
 ip nat outside source list OUTNAT1 pool OUTPOOL1
 ip nat outside source list OUTNAT2 pool OUTPOOL2
 !
 !  add route-map
 route-map ISP1 permit 10
   match interface f0 / 0
   match ip address FORISP1
 !
 route-map ISP2 permit 10
   match interface f0 / 1
   match ip address FORISP2
</pre><br>  This solution, though not beautiful, but still completely solves the problem without affecting the server (it can often not be affected: for example, if it is not an application, but a VPN server).  There is only one loss here: the server never knows with whom it actually communicates, which means it is impossible to collect adequate statistics, etc. <br><br>  If we use the capabilities of servers, then several solutions that do not require external NATa come to mind. <br>  The first is to actually make 2 partner servers, with different addresses and connected to each other for replication with one more link.  Each server is broadcast to its address, but in the event of a drop in one of the channels it switches to a partner address. <br>  Not the easiest and cheapest solution. <br><br>  Second: set 2 addresses on the same server.  If they are from the same subnet, then there will be no problems with routing.  Each of the local server addresses is strictly broadcast only by one of the providers, since  physically, the server is one and we still will not get any benefit from the load.  To explicitly specify the output interface, use the route-map STRELKA.  There may be a problem with the server itself: it often happens that when the server responds, it uses only the primary address of the interface, regardless of what address the request came to. <br>  A typical example: VPN server.  If the cisco router acts as a VPN server, it always responds to the primary interface address. <br><br>  _________________ <br><h5>  UPD on 23:45 01/14/2010 </h5><br><br>  I received a letter from a reader from Lithuania, where he referred to an interesting article.  Perhaps it will complement the server part of the task: <br>  <a href="http://www.nil.com/ipcorner/SOHO_Servers/">Here on the site NILA</a> .  The author is Ivan Pepelnyak, one of the early CCIEs, a very deep specialist (his blog <a href="http://blog.ioshints.info/">‚ÄúiOS hints and tricks‚Äù</a> <br><br>  In short: on the Windows server you can create loopback interfaces (2 pieces) and sorsy the packages from the services from these addresses.  And broadcast them to different external.  In addition, it is necessary to register return routes on the loopback network on the routers.  Then the source address problem will be solved. <br>  __________________ <br><br>  If addresses from different subnets, the default gateway is still the same.  So, everything will be routed through only one interface and the task will not be completely solved. <br><br>  PS Today I finally assembled a stand and checked everything again, thanks to your interest!  So use, my dear :) <br><br>  Sergey Fedorov, CCIE Security # 22974 </div><p>Source: <a href="https://habr.com/ru/post/80717/">https://habr.com/ru/post/80717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80704/index.html">First steps with QML</a></li>
<li><a href="../80705/index.html">AsciiCamera</a></li>
<li><a href="../80706/index.html">We charge mobile phones with brute force</a></li>
<li><a href="../80713/index.html">Nokia 5800 has finally added kinetic scrolling!</a></li>
<li><a href="../80716/index.html">Visual Studio 2005/2008 PasteBin via C #</a></li>
<li><a href="../80718/index.html">In April of this year, iPhone 4G will appear; rumor has it that there will be support for fourth-generation cellular networks</a></li>
<li><a href="../80720/index.html">In the first week, only 20 thousand copies of Google Nexus One were sold.</a></li>
<li><a href="../80721/index.html">Cheat sheet to decipher the names of video files</a></li>
<li><a href="../80722/index.html">Russian national Internet film award "George"</a></li>
<li><a href="../80724/index.html">How many active mailboxes do you have?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>