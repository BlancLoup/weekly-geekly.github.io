<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Greedy Dwarf: As I wrote market analytics in Lineage 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here comes the autumn-winter season. Outside the window, the rains and the desire to spend time outdoors are less and less. And here comes a message t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Greedy Dwarf: As I wrote market analytics in Lineage 2</h1><div class="post__text post__text-html js-mediator-article"><p>  Here comes the autumn-winter season.  Outside the window, the rains and the desire to spend time outdoors are less and less.  And here comes a message to me from a friend " <em>And let's play in <strong>Lineage 2</strong></em> ?".  And again, I succumbed to nostalgia, agreed.  We chose a fresh server at our site and created characters. </p><br><img src="https://habrastorage.org/webt/gd/jh/t1/gdjht1oa4v3ooibwdzyoxptvenc.jpeg"><br><p><br>  Unlike World of Warcraft in Lineage 2 is a completely different game currency mining system.  It is necessary to hunt monsters all day long in order to gain profit.  It was even a discovery for me that for some people RMT (Real money trading) is something of a job.  Also, the game has an economy that players form.  In other words, you can make money on buy-sell or buy cheap resources, from them to do things and sell at a premium.  Since for us the game remains something like a rest, this is the way to get game currency was chosen by us. </p><br><p>  To buy and sell items a player must be online (screenshot above).  Accordingly, someone wants to quickly sell (cheaper) and someone quickly buy (more expensive).  And what if the difference to sell is to buy positive?  Just this example will be considered in the article as a result. </p><br><p>  However, prices in the market are quite unstable and often change.  Therefore, it is possible to buy something ‚Äúcheap‚Äù and then sell it even cheaper to sell it with negative profit.  This is what we are trying to avoid.  In general, it was decided to write <em>a market analytics system</em> and deal with a couple of interesting technologies for me. </p><br><p>  <strong>Spoiler</strong> : <br>  The article will use the following technologies. <br>  Docker, DigitalOcean, NodeJs, Ktor, Prometheus, Grafana, Telegram bot notification </p><a name="habracut"></a><br><h1>  First was Data </h1><br><p>  In order to analyze something, we first need to get something.  It was considered 2 options for obtaining information. </p><br><p>  <u>Sniffing</u> - write an application that will listen to traffic and analyze it.  The disadvantages of this approach are very simple.  You need to be constantly online and watch the market and even according to the server‚Äôs policy they can be banned.  However, I would like minimal actions from the user and it is desirable to automate everything as much as possible. </p><br><p>  <u>Parsing</u> - there is a site that just specializes in sniffing for this game - l2on.net.  Just what we need!  We give the role of the raw data collector to this service.  It remains only to get the data and start experimenting with them. <br></p><br><img src="https://habrastorage.org/webt/xt/wc/1k/xtwc1kiirfrvwnv_epcueloqk0m.png"><br><p></p><br><p>  Based on the query string, we understand that we need to transfer the resource id to get information on it.  However, if we automate this, it is also necessary to transfer the id of the game server.  After rummaging a minute in the source code of the page the following was found: <br></p><br><img src="https://habrastorage.org/webt/_j/zd/em/_jzdemfcobutgb4cgyh9s5w7gcy.png"><br><p><br>  We try ... Great!  We get a list of purchase and sale prices. <br>  Now you need to think with what we will parse the site. </p><br><p>  The choice fell on <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a> for NodeJs. <br>  On its basis, the first module of the subsystem was created - <strong>Scrapper</strong> .  Its main task is to go to the site, open, parse and return data in the form of JSON.  We take a sample of the last N elements, we consider the average, minimum and maximum price.  (Looking ahead, I‚Äôll say that you need to modify the percentile for editing noise if a player puts too high a price to sell or a low one to buy) We get an answer according to the form: <br></p><br><img src="https://habrastorage.org/webt/um/v0/qh/umv0qhmk3b1zlorvoauwx9-warq.png"><br><p><br>  Now we can move to the next part - <em>data storage</em> . </p><br><p>  Suppose we have 2-3 consumers of our data and we want to give them an array.  We also want to avoid frequent requests for l2on not to be added to the blacklist.  So we need to create a second module that will act as an intermediary between l2on and our agents. </p><br><p>  The survey method was chosen simple.  Every 5 minutes, the module must request all items from the set list and provide output for the data both for one resource and output for analytics. </p><br><p>  For this system, I wanted to try <a href="https://github.com/ktorio/ktor">Ktor</a> - server solution on Kotlin. <br>  I did not use the database, and decided to store the latest data in Singleton.  Yes, the solution is not the most elegant, but it‚Äôs a quick fix, and we‚Äôll always have time to optimize. </p><br><p>  This is how the second module of the system appeared - <strong>Harvester</strong> . <br>  Harvester provides for the user two endpoint'a / item / {id} and / metrics <br>  If everything is clear with the first, then the latter returns data in the format for the next system - <strong>Prometheus</strong> </p><br><img src="https://habrastorage.org/webt/sw/kw/cd/swkwcdgzed4wpz8id7sdnp7ceqy.png"><br><img src="https://habrastorage.org/webt/hi/jf/h8/hijfh82bupsk2kdksroqxf_ppsy.png"><br><h1>  Data Storage for Analytics </h1><br><p>  Intermediate was selected <a href="https://prometheus.io/">Prometheus</a> - Open Source database for analytics which works through the Pull approach.  In other words, during the configuration, you need to specify in the yaml file the set of data providers and the polling frequency.  In our case, this is the same / metrics endpoint. </p><br><p>  We try to run Prometheus (by default it is port 9090) and if we see in Target something similar to: <br></p><br><img src="https://habrastorage.org/webt/vq/1f/_9/vq1f_9rh_3fy5h6na8gogngdtww.png"><br><p><br>  So we are going the right way.  This means that every 30 seconds Prometheus goes to Harvester and picks up the latest status on all products of interest to us. </p><br><h1>  Data display </h1><br><p>  The next stage is a beautiful display of graphs. </p><br><p>  <a href="https://grafana.com/">Grafana</a> was chosen for rendering, which is also Open Source. <br>  Pros Grafana and Prometheus - they are available in the form of Docker containers, which require a minimum of user actions. </p><br><p>  When you first launch Grafana (standard port 3000), it will ask you to specify an available database.  Select Prometheus as the base and prescribe the address.  If everything goes well, we will see: <br></p><br><img src="https://habrastorage.org/webt/cf/h_/cn/cfh_cnonbcdyolueoyqustssjac.png"><br><p><br>  The next step is to draw the graphics. </p><br><p>  Example of a request for drawing a sales schedule: <br></p><br><img src="https://habrastorage.org/webt/vc/m5/3r/vcm53ri4w_zrynpcp7fezm7dw3a.png"><br><p><br>  Thus, at any time we see the average price for buying and selling, as well as price dynamics. <br></p><br><img src="https://habrastorage.org/webt/be/hf/_w/behf_wpfl8f_mfvqjv6upqe1yxi.png"><br><p><br>  However, there are times when the minimum sale price is higher than the maximum purchase price.  This means that we can get easy money in the form of "buy sell."  Telegram was selected for the notification channel.  Create a bot and add its token to Grafana (yes, yes, it supports notifications) <br></p><br><img src="https://habrastorage.org/webt/3c/zc/cb/3czccb4qcvsney3oszcuk5kctaq.png"><br><p><br>  Simply set the condition under which we will receive this notice. <br></p><br><img src="https://habrastorage.org/webt/rg/xw/d5/rgxwd5zjonbwwdf3vnbryywbxdu.png"><br><p><br>  As we see from the schedule, such situations occur in the market. <br></p><br><img src="https://habrastorage.org/webt/di/mp/ql/dimpqln0oq39ou9jn2qnbxwu4vq.jpeg"><br><p></p><br><h1>  Cloud </h1><br><p>  We pack each subsystem into a Docker container and load into DigitalOcean or other services of your choice.  But this does not prevent us from running the whole system without a dedicated IP.  Now the minimum container for DO costs $ 5 per month. </p><br><p>  We start Scrapper first <br>  docker run -d -p 6661: 6661 - name scrapper l2 / scrapper: latest </p><br><p>  Behind him Harvester <br>  docker run -d -p 6662: 6662 -v / root / harvester: / res --link scrapper: scrapper l2harvester: latest <br>  The folder / harvester should contain an ids.txt file with the format </p><br><p>  id1 name1 <br>  id2 name2 </p><br><h1>  Conclusion </h1><br><p>  Ultimately, the system looks like this: </p><br><img src="https://habrastorage.org/webt/yc/mc/ab/ycmcabimfltt1nakqxjfwfgmu3i.png"><br><p>  It is planned in the future to add an agent to update google docs, and count the cost of crafting on the fly. </p><br><p> I do not know whether this development will bring any benefit, but for me personally it was a good experience to refresh my knowledge in the applied field.  My main specificity is mobile apps.  Development of the server side is an additional skill and curiosity. </p><br><p>  As an addition, I attach links to get acquainted with the code: <br>  <a href="https://github.com/vacxe/l2_scrapper">Scrapper</a> <br>  <a href="https://github.com/vacxe/l2_harvester">Harvester</a> <br>  (Containers can be assembled by teams <br>  docker build -t scrapper. <br>  docker build -t harvester.) </p><br><p>  I very much hope that this article inspired someone to nostalgic feelings, or gave inspiration for some new idea.  Thank you for reading the article to the end! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/429244/">https://habr.com/ru/post/429244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429234/index.html">Creating a game "Like coins" on Godot Engine. Part 1</a></li>
<li><a href="../429236/index.html">How many Data Scientists do you need to twist the light bulb (or which team will force the data to work on the business)</a></li>
<li><a href="../429238/index.html">Once again about Tier levels</a></li>
<li><a href="../429240/index.html">How I tried to fix the search on the cards for drivers</a></li>
<li><a href="../429242/index.html">‚ÄúDo not be shy. Try it! Interviews about life, compilers and compiler life with Alexandre Mutel from Unity</a></li>
<li><a href="../429246/index.html">Summer Internship at Mars IS: An Inside Look</a></li>
<li><a href="../429248/index.html">Tips polyglot: how to learn any language without tears and curses</a></li>
<li><a href="../429250/index.html">One hundred digital accounting recipes</a></li>
<li><a href="../429252/index.html">Static analysis of mobile applications</a></li>
<li><a href="../429254/index.html">On the question of Bezier curves and speed Arduino, part two</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>