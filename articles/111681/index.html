<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing XMPP Publish / Subscribe via Twisted</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! In this article, I will talk about how to make a basic publish / subscribe implementation using XMPP using Twisted and the Wokkel library. X...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing XMPP Publish / Subscribe via Twisted</h1><div class="post__text post__text-html js-mediator-article">  Good day!  In this article, I will talk about how to make a basic <a href="http://en.wikipedia.org/wiki/Publish/subscribe">publish / subscribe</a> implementation using XMPP using <a href="http://twistedmatrix.com/">Twisted</a> and the <a href="http://wokkel.ik.nu/">Wokkel</a> library.  XMPP supports pub / sub thanks to the <a href="http://xmpp.org/extensions/xep-0060.html">XEP-0060</a> extension.  Using pub / sub, you can solve the task of notifying all participants about the event and many others.  It is reliably known that Apple uses a Wokkel-based pub / sub inside its notification server, but more on that later. <br><a name="habracut"></a><br><br><h4>  Why do I need publish / subscribe? </h4><br>  When developing a project, the following task arose: to build a client-server architecture in which clients perform an action on data stored on the server.  The data is publicly available and it is necessary for the client to perform actions on the newest version of the data.  I will explain a little how the system should work.  The client subscribes to the service.  When subscribing to a service, the client receives all data stored on the server.  The client sends data to the server.  The server saves the sent data and sends it to all subscribers.  If the subscriber finds that the integrity of the data is compromised, it requests the server to send data, etc. <br><br><h4>  Instruments </h4><br>  The solution was found in the form of using XMPP and its extension XEP-0060.  XMPP was chosen because of its popularity and rich features.  In turn, Twisted was chosen as one of the most powerful network frameworks in python.  In twisted.words there is some basic support for the xmpp protocol, but unfortunately, there is no support for the pub / sub extension.  Wokkel was taken as a library that adds pub / sub support to Twisted.  Wokkel supports not only pub / sub, but also ( <a href="http://xmpp.org/extensions/xep-0030.html">service discovery</a> ) and a couple of other useful extensions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Example </h4><br>  Let's try to write a small example showing how to work with the Wokkel library.  We will have a service and customers subscribed to updates from the service.  Every 5 seconds, the client generates a message and sends it to the server.  The server sends the message to all subscribed participants.  Let's get started <br><br>  First you need to create an object of class XMPPClient, which is a service (in Twisted terminology).  He is responsible for logging in to Jabber server and managing the connection.  An object of the PubSubClient or PubSubService class will provide us with the ability to interact at the pub / sub protocol level.  Call setHandlerParent so that the protocol and service can communicate with each other.  We start the service.  The protocol starts listening to the stream for messages related to pub / sub, when receiving the above messages, calls the appropriate handlers.  The next step is to look at the implementation of the Service class. <br><br><blockquote>  <font color="#ff7700">def</font> main <font>(</font> <font>)</font> : <br>  log.  <font>startLogging</font> <font>(</font> <font color="#dc143c">sys</font> . <font>stdout</font> <font>)</font> <br>  options, args = parse_args <font>(</font> <font>)</font> <br>  jid, resource, password = args <br>  service = options.  <font>service</font> <br>  fulljid = jabber.  <font>jid</font> .  <font>internJID</font> <font>(</font> jid + <font color="#483d8b">'/'</font> + resource <font>)</font> <br>  transport = XMPPClient <font>(</font> fulljid, password <font>)</font> <br>  transport.  <font>logTraffic</font> = <font color="#008000">True</font> <br>  protocol = Client <font>(</font> jabber. <font>jid</font> . <font>internJID</font> <font>(</font> service <font>)</font> <font>)</font> <font color="#ff7700">if</font> service <font color="#ff7700">else</font> Service <font>(</font> <font>)</font> <br>  protocol.  <font>setHandlerParent</font> <font>(</font> transport <font>)</font> <br>  transport.  <font>startService</font> <font>(</font> <font>)</font> <br>  reactor.  <font>run</font> <font>(</font> <font>)</font> </blockquote><br><br>  In our case, the pub / sub service task is simple: take a message from the subscriber and send it to all other subscribers.  The client begins interacting with the service by sending a subscription request.  As soon as the service recognizes that the subscribe request has arrived, it calls the subscribe method.  In this method, we need to create a subscription associated with the client and return it to the callback.  We will not implement access models and believe that everyone can subscribe.  When the subscriber sends us some data, the publish method will be called.  In the sendData method, we send the incoming data to everyone who subscribes to our service.  We now turn to the consideration of the client. <br><br><blockquote>  <font color="#ff7700">class</font> Service <font>(</font> PubSubService <font>)</font> : <br>  <font color="#ff7700">def</font> <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  PubSubService.  <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <br>  <font color="#008000">self</font> ._subscriptions = <font>{</font> <font>}</font> <br><br>  <font color="#ff7700">def</font> publish <font>(</font> <font color="#008000">self</font> , requestor, service, nodeIdentifier, items <font>)</font> : <br>  <font color="#008000">self</font> .  <font>sendData</font> <font>(</font> items <font>)</font> <br>  <font color="#ff7700">return</font> defer.  <font>succeed</font> <font>(</font> <font color="#008000">None</font> <font>)</font> <br><br>  <font color="#ff7700">def</font> subscribe <font>(</font> <font color="#008000">self</font> , requestor, service, nodeIdentifier, subscriber <font>)</font> : <br>  <font color="#ff7700">if</font> subscriber <font color="#ff7700">in</font> <font color="#008000">self</font> ._subscriptions: <br>  info = <font color="#008000">self</font> ._subscriptions <font>[</font> subscriber <font>]</font> <br>  <font color="#ff7700">else</font> : <br>  info = Subscription <font>(</font> NODE_NAME, subscriber, <font color="#483d8b">'subscribed'</font> <font>)</font> <br>  <font color="#008000">self</font> ._subscriptions <font>[</font> subscriber <font>]</font> = info <br>  <font color="#ff7700">return</font> defer.  <font>succeed</font> <font>(</font> info <font>)</font> <br><br>  <font color="#ff7700">def</font> sendData <font>(</font> <font color="#008000">self</font> , items <font>)</font> : <br>  sendList = <font>[</font> <font>]</font> <br>  <font color="#ff7700">for</font> subscription <font color="#ff7700">in</font> <font color="#008000">self</font> ._subscriptions.  <font>values</font> <font>(</font> <font>)</font> : <br>  sendList.  <font>append</font> <font>(</font> <font>[</font> subscription. <font>subscriber</font> , <font color="#008000">None</font> , items <font>]</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>notifyPublish</font> <font>(</font> <font color="#008000">self</font> . <font>parent</font> . <font>jid</font> , NODE_NAME, sendList <font>)</font> </blockquote><br><br>  When creating a client, we give him the address of the service to which he will subscribe.  When the service (XMPPClient) logged into the server jabber and the connection was established, the connectionInitialized method is called on all protocols attached to the service (XMPPClient).  We will make sure that immediately after the connection is established, we subscribe to the service we need.  After the subscription is successfully completed, we start an event that will occur every 4 seconds and will generate and send a message to the service.  Transmitted data must be in a properly formatted XML.  Actually that's all. <br><br><blockquote>  <font color="#ff7700">class</font> Client <font>(</font> PubSubClient <font>)</font> : <br>  <font color="#ff7700">def</font> <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> , service <font>)</font> : <br>  PubSubClient.  <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <br>  <font color="#008000">self</font> .__ service = service <br><br>  <font color="#ff7700">def</font> connectionInitialized <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  PubSubClient.  <font>connectionInitialized</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <br>  d = <font color="#008000">self</font> .  <font>subscribe</font> <font>(</font> <font color="#008000">self</font> .__ service, NODE_NAME, <font color="#008000">self</font> . <font>parent</font> . <font>jid</font> <font>)</font> <br>  d.  <font>addCallback</font> <font>(</font> <font color="#ff7700">lambda</font> success: task. <font>LoopingCall</font> <font>(</font> sendGeneratedData, <font color="#008000">self</font> <font>)</font> <font>)</font> <br>  d.  <font>addCallback</font> <font>(</font> <font color="#ff7700">lambda</font> lc: lc. <font>start</font> <font>(</font> <font color="#ff4500">5</font> , now = <font color="#008000">True</font> <font>)</font> <font>)</font> <br><br>  <font color="#ff7700">def</font> itemsReceived <font>(</font> <font color="#008000">self</font> , event <font>)</font> : <br>  <font color="#ff7700">for</font> item <font color="#ff7700">in</font> event.  <font>items</font> : <br>  log.  <font>msg</font> <font>(</font> item. <font>getAttribute</font> <font>(</font> <font color="#483d8b">'sender'</font> <font>)</font> + <font color="#483d8b">'sends'</font> + <br>  item.  <font>getAttribute</font> <font>(</font> <font color="#483d8b">'message'</font> <font>)</font> + <font color="#483d8b">'at'</font> + item.  <font>getAttribute</font> <font>(</font> <font color="#483d8b">'time'</font> <font>)</font> <font>)</font> <br><br>  <font color="#ff7700">def</font> sendData <font>(</font> <font color="#008000">self</font> , items <font>)</font> : <br>  <font color="#008000">self</font> .  <font>publish</font> <font>(</font> <font color="#008000">self</font> .__ service, NODE_NAME, items <font>)</font> </blockquote><br><blockquote>  <font color="#ff7700">def</font> sendGeneratedData <font>(</font> protocol <font>)</font> : <br>  element = Element <font>(</font> <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">'item'</font> <font>)</font> <font>)</font> <br>  element.  <font>attributes</font> <font>[</font> <font color="#483d8b">'sender'</font> <font>]</font> = protocol.  <font>parent</font> .  <font>jid</font> .  <font>full</font> <font>(</font> <font>)</font> <br>  element.  <font>attributes</font> <font>[</font> <font color="#483d8b">'time'</font> <font>]</font> = time.  <font>strftime</font> <font>(</font> <font color="#483d8b">"% H:% M:% S"</font> , time. <font>localtime</font> <font>(</font> <font>)</font> <font>)</font> <br>  element.  <font>attributes</font> <font>[</font> <font color="#483d8b">'message'</font> <font>]</font> = <font color="#483d8b">'Hello!'</font> <br>  protocol.  <font>sendData</font> <font>(</font> <font>[</font> element <font>]</font> <font>)</font> </blockquote><br><br>  View source code <a href="https://github.com/f0y/wokkel_habrahabr_article">here.</a> <br>  To check the work, you need: <br>  Start server: <i>pubsub.py test@example.com server password</i> <br>  Start two clients: <i>pubsub.py --service test@example.com/server test@example.com client1 password</i> <br>  <i>pubsub.py --service test@example.com/server test@example.com client2 password</i> <br><br><h4>  What does Apple have to do with it? </h4><br>  What we have just done is an example showing one of the hundreds of pub / sub possibilities.  If you look at the specification, you can see that our example corresponds to the Leaf node type, with the configuration persistItems = False deliveryPayloads = True and an open access model, without support for affiliations, discovery, the possibility of creating other nodes, etc.  Imagine how difficult it is to implement the entire pub / sub specification or even the necessary part.  But <a href="http://ralphm.net/blog/">Ralph Meijer</a> , the author of wokkel, simplified our task and wrote <a href="http://idavoll.ik.nu/">Idavoll</a> .  Idavoll is an add-on over Wokkel.  It almost completely supports XEP-0060 and has the ability to communicate over http.  Idavoll is used by Apple as a notification server.  This fact can be checked <a href="http://www.apple.com/opensource/">here.</a> <br><br><h4>  Conclusion </h4><br>  To study Twisted, I recommend the official documentation and <a href="http://krondo.com/%3Fpage_id%3D1327">krondo.com/?page_id=1327</a> <br>  Unfortunately, there is very little information on Wokkel, but not on Idavoll at all, so only the generated documentation remains. <br>  Good luck in learning! </div><p>Source: <a href="https://habr.com/ru/post/111681/">https://habr.com/ru/post/111681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111675/index.html">Construction of the suffix tree: Ukkonen algorithm</a></li>
<li><a href="../111676/index.html">loop_dance - quick deployment background scheduler</a></li>
<li><a href="../111678/index.html">System automatically generate settings for the DNS server Bind</a></li>
<li><a href="../111679/index.html">Development of a touch keyboard for their devices</a></li>
<li><a href="../111680/index.html">Wrapper for calling functions at their address</a></li>
<li><a href="../111682/index.html">Problems using SVG buttons in browsers</a></li>
<li><a href="../111683/index.html">Just two years left before the information age begins.</a></li>
<li><a href="../111684/index.html">Import Content type along with CCK fields</a></li>
<li><a href="../111686/index.html">Javascript and canvas in the game "Life" by John Conway</a></li>
<li><a href="../111687/index.html">Demystifying Juniper's rib-groups</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>