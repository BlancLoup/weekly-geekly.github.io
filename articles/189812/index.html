<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.JS and uploading a directory from 1C to the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently closed another project. Essence: the creation of a new version of the online catalog. The old version of the site, for a number of reasons, d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.JS and uploading a directory from 1C to the site</h1><div class="post__text post__text-html js-mediator-article">  Recently closed another project.  Essence: the creation of a new version of the online catalog.  The old version of the site, for a number of reasons, did not suit the client.  A feature of the project was its nomenclature base.  The volume of the catalog nomenclature was ~ 26000 positions scattered on a tree of 513 nodes + product characteristics.  Almost every nomenclature position had a 1-2K text description. <br><br>  File upload directory in <a href="http://v8.1c.ru/edi/edi_stnd/90/92.htm">ComerceML 2</a> format for the old site weighed 104 MB.  It was formed on the side of 1C for 10 minutes and after being transferred to the hosting, I parsed on the site side for an hour and a half (!) With a 100% CPU load. <br><a name="habracut"></a><br><h4>  Way out </h4><br>  As an alternative to the XML format, they decided to upload to JSON.  The idea was to try to parse JSON with something that has a native parser implementation, namely node.js with its JSON.parse (). <br><br>  Our 1C-nick, having dealt with the new format for it, achieved in several iterations that the 1C unloading formed valid JSON.  The formation time of the discharge was reduced from 10 to 3.5 minutes.  The same data that in the XML format occupied 104 megabytes fit in 58 megabytes of JSON.  But it was expected, the surprise was another ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To test the time for parsing the upload, I sketched a test code: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Node.js var fs = require('fs'); function parser(filename, callback){ fs.readFile(filename, { encoding:'utf8' }, function(err, dataFromFile){ var parsedData; if(err){ callback(err); } else { try { console.time('parse data'); //  -  ... parsedData = JSON.parse(dataFromFile.toString().trim()); // &lt;-   . console.timeEnd('parse data'); // ...    " ". callback(null, parsedData ); } catch (e){ callback(e) } } }); } parser('../import/import.json', function(err, data){ if(err){ throw (err); } console.log('groups', data.groups.length); console.log('items', data.items.length); console.log('properties', data.properties.length); });</span></span></code> </pre> <br>  Having run it on my machine (CPU 3.3GHz), I did not even have time to get up to go for tea.  The result and the speed with which it was displayed in the console, made me assume that there was a bug in the code and it did not work correctly ... <br><blockquote>  &gt; node parse.js <br><br>  <b>parse data: 718ms</b> <br>  groups 513 <br>  items 26098 <br>  properties 149 <br></blockquote><br>  But it was not a bug.  The data was indeed parsed and placed in memory in  seconds.  The number of elements in the collections completely coincided with the stated amount in 1C.  It only remained to find the missing jaw under the table and write a service with a full data processing cycle. <br><br><h4>  General architecture of the unloading service </h4><br>  In general, uploading to the site works according to the standard scheme: <br><ul><li>  formation of unloading from 1C and its packaging by the archiver; </li><li>  upload generated files via FTP; </li><li>  Calling the HTTP unload handler </li></ul><br><br>  The unloading handler service is implemented according to the following scheme: <br><ol><li>  unpack the archive; </li><li>  parse JSON; </li><li>  report the HTTP response that everything is fine or an error has occurred; </li><li>  if everything is good, set the employment flag and fill the data into the database until the victorious end; </li><li>  die clearing the memory. </li><li>  ... </li><li>  Revive new process - for this is responsible <a href="http://habrahabr.ru/post/73506/">Monit</a> . </li></ol><br><br>  On the production ( <a href="https://www.digitalocean.com/pricing">DigitalOcean, tariff for $ 10</a> ), from the moment of the call and to point 3, the service works out in general in 3-4 seconds, after which the repeated call of the service will return the busy flag while the base is flooded.  The whole processing cycle of the upload with data entry in the database is 80 - 90 seconds.  CPU load at the time of parsing looks like a single peak up to 70% with a base of 10 - 30%. <br><br>  Eventually: <br><ul><li>  the formation time of the discharge was reduced from 10 to 3.5 minutes; </li><li>  uploading volume decreased from 104 to 58 megabytes (1.5 megabytes after archiving); </li><li>  the total processing time of the upload on the server side was reduced from one and a half hours to one and a half minutes; </li><li>  ??????? </li><li>  PROFIT </li></ul><br><br><h4>  PS A remedy for headache when debugging. </h4><br>  For all its speed, JSON.parse () is very inconvenient for debugging.  If there is an error in the JSON structure, you get almost zero debug information.  While your 1C specialist masters JSON, the <a href="https://github.com/zaach/jsonlint">JSON Lint</a> module is very <a href="https://github.com/zaach/jsonlint">helpful</a> .  It can be used as a separate utility or as a library.  Unlike the regular parser, it tells the exception object the line number of the JSON file where the misunderstanding occurred, that when parsing the jambs in a file of tens of megabytes, it makes life easier.  The price for this convenience is speed.  It will drop 5-7 times compared to the native JSON.parse (). <br><br>  The same test code with JSON Lint will look like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Node.js var fs = require('fs'), jsonlint = require("jsonlint"); //      function parser(filename, callback){ fs.readFile(filename, { encoding:'utf8' }, function(err, dataFromFile){ var parsedData; if(err){ callback(err); } else { try { console.time('parse data'); //  -  ... /*  Jsonlint            JSON. *    5-7    JSON.parse(). */ parsedData = jsonlint.parse(dataFromFile); //   ,     . console.timeEnd('parse data'); // ...    " ". callback(null, parsedData ); } catch (e){ callback(e) } } }); } parser('../import/import.json', function(err, data){ if(err){ throw (err); } console.log('groups', data.groups.length); console.log('items', data.items.length); console.log('properties', data.properties.length); });</span></span></code> </pre><br><br>  In conclusion, I would like to traditionally wish this material to be useful to someone else as well as to be useful to us. </div><p>Source: <a href="https://habr.com/ru/post/189812/">https://habr.com/ru/post/189812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189798/index.html">Hadoop Tutorial. Writing your grep</a></li>
<li><a href="../189802/index.html">Unreal LED, or load management from Unreal Tournament</a></li>
<li><a href="../189804/index.html">Recognition and conversion of subtitles from VOB to SRT format</a></li>
<li><a href="../189806/index.html">Entity Framework Code First - field indexing and full text search</a></li>
<li><a href="../189808/index.html">jqGrid for Raudus</a></li>
<li><a href="../189814/index.html">The Story of The Pirate Bay</a></li>
<li><a href="../189816/index.html">Communication devices without power supplies</a></li>
<li><a href="../189818/index.html">How does the process of photographing from the inside (according to Nokia)</a></li>
<li><a href="../189820/index.html">Yii 1.1.14</a></li>
<li><a href="../189824/index.html">The sixth "Festival 404" will be held October 12-13, 2013 in Samara</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>