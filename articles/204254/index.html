<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gnuplot vs. 2MASS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article focuses on the benefits of low-level computing using the example of the atlas of stellar objects 2MASS . 
 2MASS is ~ 471 million objects...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gnuplot vs. 2MASS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/636/d67/db8/636d67db8ecfa3b069b9f9736f959a75.png" alt="image"><br>  This article focuses on the benefits of low-level computing using the example of the atlas of stellar objects <a href="http://www.ipac.caltech.edu/2mass/overview/access.html">2MASS</a> . <br>  2MASS is ~ 471 million objects for which coordinates are given, as well as accompanying information, a total of 60 attributes. <br>  Physically - this is 50GB of source gzipnutyh text files. <br>  Is it possible to work with such a base without resorting to "heavy artillery"? <br>  Let's try. <br><a name="habracut"></a><br><h4>  <b>Prelude</b> </h4><br>  This work was carried out in 2009 and was part of the efforts of <a href="http://www.dataeast.ru/">DataEast</a> to create its own geo-DBMS. <br>  The goal was to debug, profile and make benchmark query processor. <br>  As a query language, the dialect <a href="http://en.wikipedia.org/wiki/D_(data_language_specification)">Turorial D</a> was chosen, or rather its part relating to relational algebra.  The dialect was adapted to the requirements of real life, in particular, added the ability to work with cursors. <br><br>  However, this is just a context and the purpose of this post is not a story about past victories that ‚Äúmelted away like tears in the rain‚Äù, but a demonstration of the technique of maximum transfer of calculations directly to the DBMS cursor. <br>  Of course, this technique can also be applied by means of PL / SQL using stored procedures and / or using aggregates. <br><br><h4>  <b>Introduction</b> </h4><br>  It makes no sense to dwell on the process of preparing the data, let's just say that it took 8 hours and 26 minutes to fill the data and 1 hour and 17 minutes to spatial indexing. <br>  Complete with the initial data there is a verification request. <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(pts_key::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_pts_key, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(pxcntr::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_pxcntr, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(scan_key::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_scan_key, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_scan, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(ext_key::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_ext_key, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(coadd_key::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_coadd_key, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(coadd::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_coadd, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(mp_flg) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_mp_flg, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(gal_contam) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_gal_contam, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(use_src) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_use_src, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(dup_src) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_dup_src, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(nopt_mchs) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_nopt_mchs, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(phi_opt::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_phi_opt, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(dist_edge_ew::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_dist_edge_ew, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(dist_edge_ns::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_dist_edge_ns, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(err_ang::<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sum_err_ang <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> twomass_psc;</code> </pre>  In our case, this query will look like <pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> chew { <span class="hljs-string"><span class="hljs-string">"rows"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_pts_key"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_pxcntr"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_scan_key"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_scan"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_ext_key"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_coadd_key"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_coadd"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_mp_flg"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_gal_contam"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_use_src"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_dup_src "</span></span>INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_nopt_mchs"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_phi_opt"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_dist_edge_ew"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_dist_edge_ns"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_err_ang"</span></span> INTEGER } hook <span class="hljs-string"><span class="hljs-string">"init"</span></span> { <span class="hljs-string"><span class="hljs-string">"rows"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"sum_pts_key"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; ... <span class="hljs-string"><span class="hljs-string">"sum_err_ang"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"row"</span></span> { <span class="hljs-string"><span class="hljs-string">"rows"</span></span> := <span class="hljs-string"><span class="hljs-string">"rows"</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isnull(<span class="hljs-string"><span class="hljs-string">"pts_key/cntr"</span></span>)) then <span class="hljs-string"><span class="hljs-string">"sum_pts_key"</span></span> := <span class="hljs-string"><span class="hljs-string">"sum_pts_key"</span></span> + <span class="hljs-string"><span class="hljs-string">"pts_key/cntr"</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isnull(<span class="hljs-string"><span class="hljs-string">"err_ang"</span></span>)) then <span class="hljs-string"><span class="hljs-string">"sum_err_ang"</span></span> := <span class="hljs-string"><span class="hljs-string">"sum_err_ang"</span></span> + <span class="hljs-string"><span class="hljs-string">"err_ang"</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"finit"</span></span> { call __interrupt (); };</code> </pre>  The result of the execution is: <pre> <code class="xml hljs">INFO: start [04/Jun/2009:09:37:45:822] ----------------------------------------------------------------- rows sum_pts_key sum_pxcntr sum_scan_key sum_scan sum_ext_key sum_coadd_key sum_coadd sum_mp_flg sum_gal_contam sum_use_src sum_dup_src sum_nopt_mchs sum_phi_opt sum_dist_edge_ew sum_dist_edge_ns sum_err_ang ----------------------------------------------------------------- 470992970 306810325437475788 306815556538478936 16902776758555 32666066948 2048692118201 388758631396659 64617139213 16048 729878 464456155 79798372 369187043 64916239773 69388217174 2670725813652 29279563815 ----------------------------------------------------------------- INFO: stop [04/Jun/2009:12:35:59:571]</code> </pre>  Here, the <i>chew</i> operator is used to convert the original data stream (the entire table) to synthetic with certain fields that become local variables.  The <i>hook</i> statement is used (similar to SQL aggregates) for subscribing to events ‚Äî the start / stop of a stream and the receipt of a string.  When <i>__interrupt is</i> called <i>, the</i> current values ‚Äã‚Äãof local variables fall into the resultset. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The results coincide with the verification, so the data is prepared for work. <br>  Opening hours - 3 hours, about 10 minutes per column for continuous viewing.  This speed (on Intel Core2 P4-2.4 GHz, 2Gb, disk ST3400620AS) is typical for all further requests.  On the other hand, if we unpacked the source text files and processed them through GAWK, for example, it would take 50GB of 50 MB / s = 1000 seconds to read the data and the same amount to unpack, 35 minutes only to organize the stream.  It took an hour and a half to decompress and run all the data through wc. <br><br>  For those who want to see everything with their own eyes, there is a piece of the sky with a defect plate: <br><img src="https://habrastorage.org/getpro/habr/post_images/f32/0b0/bf2/f320b0bf235230395c6fcffc2774fcb4.png" alt="image"><br>  Some people take him for the battle orders of the imperial fleet. <br><br><h4>  <b>Data mining</b> </h4><br>  <b>Simple statistics.</b>  Max, Min, Avg - let's play with the column ‚Äújm‚Äù (Default J-band magnitude). <br><pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> chew { <span class="hljs-string"><span class="hljs-string">"nrows"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"sum_j_m"</span></span> RATIONAL, <span class="hljs-string"><span class="hljs-string">"avg_j_m"</span></span> RATIONAL, <span class="hljs-string"><span class="hljs-string">"max_j_m"</span></span> RATIONAL, <span class="hljs-string"><span class="hljs-string">"min_j_m"</span></span> RATIONAL } hook <span class="hljs-string"><span class="hljs-string">"init"</span></span> { <span class="hljs-string"><span class="hljs-string">"nrows"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"sum_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"avg_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"max_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">-1e66</span></span>; <span class="hljs-string"><span class="hljs-string">"min_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">1e66</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"row"</span></span> { nrows := nrows + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isnull(<span class="hljs-string"><span class="hljs-string">"j_m"</span></span>)) then <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-string"><span class="hljs-string">"sum_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"sum_j_m"</span></span> + <span class="hljs-string"><span class="hljs-string">"j_m"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"max_j_m"</span></span>&lt;<span class="hljs-string"><span class="hljs-string">"j_m"</span></span>) then <span class="hljs-string"><span class="hljs-string">"max_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"j_m"</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"min_j_m"</span></span>&gt;<span class="hljs-string"><span class="hljs-string">"j_m"</span></span>) then <span class="hljs-string"><span class="hljs-string">"min_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"j_m"</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"finit"</span></span> { <span class="hljs-string"><span class="hljs-string">"avg_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"sum_j_m"</span></span> / <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span>; call __interrupt (); };</code> </pre><br>  Result: <pre> <code class="xml hljs">INFO: start [04/Jun/2009:15:00:54:821] -------------------------------------------------------------------- nrows nulls_j_m num_j_m sum_j_m avg_j_m max_j_m min_j_m -------------------------------------------------------------------- 470992970 19 470992951 7.15875e+009 15.1993 25.86 -2.989 -------------------------------------------------------------------- INFO: stop [04/Jun/2009:15:18:47:743]</code> </pre><br>  Dispersion: <br><pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> chew { <span class="hljs-string"><span class="hljs-string">"nrows"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> INTEGER, <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> RATIONAL } hook <span class="hljs-string"><span class="hljs-string">"init"</span></span> { <span class="hljs-string"><span class="hljs-string">"nrows"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; var tmp rational; var tavg rational; tavg := <span class="hljs-number"><span class="hljs-number">15.1993</span></span>; -- previously calculated } hook <span class="hljs-string"><span class="hljs-string">"row"</span></span> { nrows := nrows + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isnull(<span class="hljs-string"><span class="hljs-string">"j_m"</span></span>)) then <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"nulls_j_m"</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; tmp := <span class="hljs-string"><span class="hljs-string">"j_m"</span></span> - tavg; tmp := tmp * tmp; <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> + tmp; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"finit"</span></span> { <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> := <span class="hljs-string"><span class="hljs-string">"disp_j_m"</span></span> / <span class="hljs-string"><span class="hljs-string">"num_j_m"</span></span>; call __interrupt (); };</code> </pre><br>  <b>Result</b> : <pre> <code class="xml hljs">INFO: start [04/Jun/2009:15:48:27:274] -------------------------------------------------------------------- nrows nulls_j_m num_j_m disp_j_m -------------------------------------------------------------------- 470992970 19 470992951 1.98223 -------------------------------------------------------------------- INFO: stop [04/Jun/2009:16:05:01:946</code> </pre><br>  <b>Bar chart:</b> <pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> chew { <span class="hljs-string"><span class="hljs-string">"j_m_cell"</span></span> rational, <span class="hljs-string"><span class="hljs-string">"num"</span></span> INTEGER } hook <span class="hljs-string"><span class="hljs-string">"init"</span></span> { var tmp integer; var tmp2 integer; var tmax rational; tmax := <span class="hljs-number"><span class="hljs-number">26.</span></span>; -- previously calculated var tmin rational; tmin := <span class="hljs-number"><span class="hljs-number">-5.</span></span>; -- previously calculated var ncells integer; ncells := <span class="hljs-number"><span class="hljs-number">500</span></span>; var tcell rational; tcell := (tmax - tmin)/ncells; var htptr integer; htptr := hti_alloc (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hti_set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(htptr, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } hook <span class="hljs-string"><span class="hljs-string">"row"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isnull(<span class="hljs-string"><span class="hljs-string">"j_m"</span></span>)) then tmp := (<span class="hljs-string"><span class="hljs-string">"j_m"</span></span> - tmin)/tcell; tmp2 := hti_get (htptr, tmp); tmp2 := tmp2 + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hti_set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(htptr, tmp, tmp2)</span></span></span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"finit"</span></span> { tmp := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tmp &lt; ncells; begin; <span class="hljs-string"><span class="hljs-string">"j_m_cell"</span></span> := tmin + tcell * tmp + tcell * <span class="hljs-number"><span class="hljs-number">0.5</span></span>; <span class="hljs-string"><span class="hljs-string">"num"</span></span> := hti_get (htptr, tmp); tmp := tmp + <span class="hljs-number"><span class="hljs-number">1</span></span>; call __interrupt (); end; end <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hti_free</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(htptr)</span></span></span></span>; };</code> </pre>  Histogram cells are accumulated using a hash table due to the absence of arrays in the language.  In this case, the result will be a printout of the cells of the histogram, which is convenient to look through <a href="http://www.gnuplot.info/">gnuplot</a> . In the picture below, printouts are also added in columns ‚Äúkm‚Äù (Default Ks-band magnitude) and ‚Äúhm‚Äù (Default H-band magnitude). <br><br><img src="http://habrastorage.org/storage3/08d/07f/dc2/08d07fdc28fed09b73041bada29998b4.jpg" alt="image"><br>  <b>3D</b> <br>  Well, the ‚Äúkm‚Äù and ‚Äúhm‚Äù on the histogram look very similar, but what about the joint distribution? <br><pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> chew { <span class="hljs-string"><span class="hljs-string">"cell"</span></span> rational, <span class="hljs-string"><span class="hljs-string">"num"</span></span> INTEGER } hook <span class="hljs-string"><span class="hljs-string">"init"</span></span> { var tmp integer; var tmp2 integer; var tmp4 integer; var tmax rational; tmax := <span class="hljs-number"><span class="hljs-number">25</span></span>; var tmin rational; tmin := <span class="hljs-number"><span class="hljs-number">-5.</span></span>; var ncells integer; ncells := <span class="hljs-number"><span class="hljs-number">512</span></span>; var tcell rational; tcell := (tmax - tmin)/ncells; var <span class="hljs-string"><span class="hljs-string">"hnd"</span></span> integer; hnd:= img_create ( ncells, ncells, tmin, tmin, tmax, tmax, <span class="hljs-number"><span class="hljs-number">1</span></span>); var cl integer; cl := img_alloc_color (hnd, <span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); } hook <span class="hljs-string"><span class="hljs-string">"row"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isnull(<span class="hljs-string"><span class="hljs-string">"h_m"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isnull(<span class="hljs-string"><span class="hljs-string">"k_m"</span></span>))) then tmp := img_get_point (hnd, <span class="hljs-string"><span class="hljs-string">"h_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"k_m"</span></span>); tmp := tmp + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">img_draw_point</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hnd, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"h_m"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"k_m"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, tmp)</span></span></span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; } hook <span class="hljs-string"><span class="hljs-string">"finit"</span></span> { tmp := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tmp &lt; ncells; begin; tmp2 := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tmp2 &lt; ncells; begin; tmp4 := img_get_point (hnd, tmin + tcell * tmp, tmin + tcell * tmp2); <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((tmin + tmp * tcell)+</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' '</span></span></span></span><span class="hljs-function"><span class="hljs-params">+ (tmin + tmp2* tcell)+</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' '</span></span></span></span><span class="hljs-function"><span class="hljs-params">+tmp4+</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'\n'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tmp4 &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> then tmp4 := cl; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> tmp4 := <span class="hljs-number"><span class="hljs-number">0</span></span>; end <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">img_draw_point</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hnd, tmin + tcell * tmp, tmin + tcell * tmp2, cl)</span></span></span></span>; tmp2 := tmp2 + <span class="hljs-number"><span class="hljs-number">1</span></span>; end; end <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>; tmp := tmp + <span class="hljs-number"><span class="hljs-number">1</span></span>; end; end <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">img_saveas</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hnd, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'stat4.gif'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">call </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">img_destroy</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hnd)</span></span></span></span>; };</code> </pre>  In this example, to store a two-dimensional histogram, the image of the image obtained by means of the <a href="http://www.boutell.com/gd/">GD</a> plug-in was used, and the logarithms of hits in the cells are viewed again using <b>gnuplot</b> mode in <b>pm3d</b> mode. <br><img src="http://habrastorage.org/storage3/1b2/c64/697/1b2c64697b449565b5013ecd211ce4fc.png" alt="image"><br>  Similar picture for the distribution of ‚Äúj_m‚Äú - ‚Äúk_m‚Äú against ‚Äúh_m‚Äú - ‚Äúk_m‚Äú: <br><img src="http://habrastorage.org/storage3/f4e/64c/043/f4e64c043a0594c9602a4c412df34055.png" alt="image"><br>  The construction of these histograms takes ~ 35 min - 12 min per column. <br>  But what if we need to build such a distribution over a specific spatial area?  Can we do it in seconds?  Of course: <br>  <b>Sampling with spatial constraints</b> . <br><pre> <code class="cpp hljs">select <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> <span class="hljs-function"><span class="hljs-function">where </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp_overlap</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Point"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, [rational:xmin], [rational:ymin], [rational:xmax], [rational:ymax])</span></span></span><span class="hljs-function"> chew </span></span>{ <span class="hljs-string"><span class="hljs-string">"m_cell"</span></span> rational, <span class="hljs-string"><span class="hljs-string">"num"</span></span> INTEGER } ‚Ä¶ -- below is the same text</code> </pre><br>  Adding sp_overlap changed the source identifier flow from the table to the spatial index. <br><img src="http://habrastorage.org/storage3/a8d/83c/bee/a8d83cbeeea23580ae3e69823f078650.png" alt="image"><br>  In the lower left corners of the cells are the extents of the samples. <br><br>  What about <b>attribute restrictions</b> ? <br>  It is as easy as limiting in space. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">"PSC"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ‚Äúj_snr‚Äù &lt; <span class="hljs-number"><span class="hljs-number">10.</span></span> <span class="hljs-comment"><span class="hljs-comment">-- or you may combine your restrictions adding -- and sp_overlap ("Point", ‚Ä¶ ) chew { "m_cell" rational, "num" INTEGER } ‚Ä¶ -- below is the same text</span></span></code> </pre>  And here is the result. <br><img src="http://habrastorage.org/storage3/982/888/753/9828887532bc2043057c110b0df32f03.png" alt="image"><br><br><h4>  <b>Total</b> </h4><br>  What gives us the transfer of calculations to the cursor? <br><ul><li>  <b>speed</b> , processing the read data on the spot, we are free to serialize, send over the network, receive, deserialize ... </li><li>  <b>saved resources</b> , for example, half a billion lines, being sent over the network, will permanently occupy a fair share of its bandwidth </li></ul><br>  And how do we face such a technique? <br><ul><li>  You have to do everything yourself, and this is a potential source of errors. </li><li>  Algorithms in which really a lot of calculations are not very convenient to perform on a common server. </li><li>  Not all calculations can be done in the stream. </li></ul><br>  This is all true, but the author does not argue that it is always necessary to do this, this is just one of many tools for working with data, albeit convenient, especially for the research part of the work, for example, when it is necessary to quickly check and modify hypotheses. </div><p>Source: <a href="https://habr.com/ru/post/204254/">https://habr.com/ru/post/204254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204242/index.html">Openfire + Miranda + Asterisk + Active Directory + pinch php, bash, C # or how to call from Miranda using regular phones</a></li>
<li><a href="../204244/index.html">How software companies die, or How to grow programmers correctly</a></li>
<li><a href="../204248/index.html">Highlighting code on android. My experience</a></li>
<li><a href="../204250/index.html">Service robot Tod. First steps with ROS</a></li>
<li><a href="../204252/index.html">10 months of free clouds on DigitalOcean</a></li>
<li><a href="../204258/index.html">Generating functions back and forth</a></li>
<li><a href="../204260/index.html">SSAO on OpenGL ES 3.0</a></li>
<li><a href="../204262/index.html">Real development experience at Meteor</a></li>
<li><a href="../204264/index.html">STM32 + Visual Studio</a></li>
<li><a href="../204266/index.html">Methods of anonymity online. Part 4. Tor & VPN. Whonix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>