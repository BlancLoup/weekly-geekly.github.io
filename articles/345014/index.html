<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to manage sections in Oracle DB and not go crazy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have already talked about why database partitioning is very important for the performance of a DLP system and how we implemented it in PostgreSQL. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to manage sections in Oracle DB and not go crazy</h1><div class="post__text post__text-html js-mediator-article">  We have already <a href="https://habrahabr.ru/company/solarsecurity/blog/324242/">talked</a> about why database partitioning is very important for the performance of a DLP system and how we implemented it in PostgreSQL.  This article is about Oracle. <br><br>  The specificity of using DBMS in DLP solutions is that the amount of data grows very quickly.  They cannot be kept in the operational archive, and long-term storage is a need for a company of at least 50 employees.  At the same time, the operational archive is filled so quickly that it is necessary to send information to the long-term archive once every 2 weeks or more.  Using only built-in tools of the DBMS requires knowledge and experience.  This is the main difficulty, and it, in general, is obvious "on the shore." <br><br>  In addition, problems arise that are not immediately obvious.  How to return from the long-term archive a partition with the data of an older version of the application and attach to a more recent one?  What if they have different data storage formats?  What to do if the connection of the section was interrupted, and it ‚Äúhung‚Äù between the long-term and operational archive? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/q2/zn/kp/q2znkp_0vp28frm6wfidbtyktic.jpeg"><br><a name="habracut"></a><br>  In general, resolving these issues boils down to two main technical tasks: automating the management of sections in the Oracle DBMS (disconnecting and connecting) and the system ‚Äúrolling back‚Äù sections if something went wrong during connection. <br><br><h3>  What is wrong with the built-in mechanisms of Oracle DB <br></h3><br>  The Partitioning option helps to remove data to the tape and return it from the long-term archive; with its help, you can divide the table into parts according to some principle, for example, by a range of dates.  In addition to manageability and availability, this separation also improves performance.  Each period is stored in a separate tablespace, which allows using the transportable tablespace technology to quickly enough move tablespaces between different reporting and archive databases with different versions and platforms.  But the problem is that standard mechanisms are not always enough: they only allow you to create basic structures without taking into account the specifics of the application.  And then the administrator is forced to create around them a bunch of management tools.  Yes, and the process of disconnect-connect-transfer requires the skills of database administration.  Therefore, the minimum task is to automate this process, to make it available to application administrators. <br><br>  We have developed a set of scripts with which you can manage partitioned tables, receive any information about them, etc.  You do not need knowledge of teams, experience with the database.  The administrator of the application simply runs the script or selects the desired action in the interface, indicates the desired partition, and everything happens by itself. <br><br><h3>  (Not) Version Compatibility <br></h3><br>  So, we have automated disabling sections and sending them to the long-term archive.  But there is a problem with the long-term archive: sometimes it needs to be returned. <br><br>  Suppose the administrator transferred several sections to it in the old version.  A year later, a new version was released, in which new fields were added to the tables, new indices, and a number of sections went into the long-term archive.  And then the security man investigates a certain incident, and he needs to raise the data two years ago, i.e.  raise a section of several versions back and somehow connect it to the database. <br><br>  The structure of the tables of the new version is sometimes different from the historical one.  A number of checks and changes are needed for the archive section.  Verification always begins with a comparison of the current version of Solar Dozor and the version of the DBMS, and the connected partition.  If there are differences, procedures are launched, correcting metadata, the necessary fields are added, indexes, keys, the consistency of the connected data is checked, etc., the redundant is removed. <br><br>  Additional complexity brings the use of text indexes for searching in Solar Dozor.  There are some bugs related to EXCHANGE PARTITION for text indexes created in different versions of the DBMS or when using the transportable tablespace (up to version 12 of the metadata corruption version).  Patches are not always for the right version or platform.  Recreating indexes upon connection is not a quick and rather resource-intensive procedure.  I had to ‚Äúwork‚Äù the workarounds in the procedures for connecting the partition.  The DR $ structure of the text index tables of the connected partition is ‚Äúaligned‚Äù with the current one, the table field ctxsys.dr $ index will be updated. <br><br>  There is also protection against various errors of administrators.  For example, at the application level, any actions with the partition that is currently being poured and having the ‚Äúcurrent‚Äù status are prohibited. <br><br><h3>  "Houston, we have a problem" <br></h3><br>  In the course of implementing these mechanisms, we are faced with another problem that is unexpectedly often encountered by customers.  In the process of shutting down something can go wrong, even to a banal power outage, so that the connection section can be interrupted at any time.  As a result, we obtain a base that is in the "intermediate" state. <br>  Oracle has DDL and DML.  DML implements a mechanism for ensuring transactional integrity, which rolls back the results if the transaction fails.  There is no such mechanism in DDL, and any actions with a section are one way ends. <br><br>  We have developed a mechanism that checks the execution of all steps to disconnect-connect partitions and corrects problems that arise.  In case of problems, the mechanism restarts operations with the partition from the moment when something went wrong.  Disconnected-connection errors are logged, and this allows you to know at any time what problems and when they arose. <br><br>  How does it work to turn off partitions?  A sequence of commands is created - foreign keys are disabled, a table is created that is identical in the structure of the partition to be disconnected, necessary indexes and primary keys are created for it, the exchange partition command, the inclusion of foreign keys.  Each command is logged into the service table as it is executed, a cancel operation is recorded for it (disable constraint - enable constraint, create table ‚Äìdrop table, etc.), the time when the operation was performed, the status of the operation.  If something goes wrong, after the procedure is restarted, a check is performed at which step the shutdown stops, and either the next command is executed or the rollback occurs ‚Äî the recorded undo operations are performed in the reverse order. <br><table border="1"><tbody><tr><td width="65">  <b>ID</b> <br></td><td width="260">  <b>STATEMENT</b> <br></td><td width="180">  <b>Undo</b> <br></td><td width="90">  <b>STATUS</b> <br></td></tr><tr><td align="right" width="38">  4411 <br></td><td width="288">  CREATE TABLE ADDRESS2_P10001 TABLESPACE DOZOR1_INDEXES AS SELECT * FROM ADDRESS2 WHERE 1 = 2 <br></td><td width="272">  DROP TABLE ADDRESS2_P10001 <br></td><td width="56">  Ok <br></td></tr><tr><td align="right" width="38">  4412 <br></td><td width="288">  CREATE INDEX IX_ADDRESS2_MESSAGE_P10001 ON ADDRESS2_P10001 (MESSAGE) TABLESPACE DOZOR1_INDEXES <br></td><td width="272">  NULL; <br></td><td width="56">  Ok <br></td></tr><tr><td align="right" width="38">  4413 <br></td><td width="288">  CREATE UNIQUE INDEX IX_ADDRESS2_UNIQ2_P10001 ON ADDRESS2_P10001 (ADDR_TYPE, VALUE, MESSAGE) TABLESPACE DOZOR1_INDEXES <br></td><td width="272">  NULL; <br></td><td width="56">  Ok <br></td></tr><tr><td align="right" width="38">  4414 <br></td><td width="288">  ALTER TABLE ADDRESS2 EXCHANGE PARTITION p10001 WITH TABLE ADDRESS2_P10001 INCLUDING INDEXES WITHOUT VALIDATION <br></td><td width="272">  ALTER TABLE ADDRESS2 EXCHANGE PARTITION p10001 WITH TABLE ADDRESS2_P10001 INCLUDING INDEXES WITHOUT VALIDATION <br></td><td width="56">  Ok <br></td></tr></tbody></table><br>  As a result, we obtain either the initial state of the database or the successful completion of the shutdown procedure. </div><p>Source: <a href="https://habr.com/ru/post/345014/">https://habr.com/ru/post/345014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345000/index.html">R and Information Security. How to eliminate the contradiction of interests and run R on Linux in offline mode</a></li>
<li><a href="../345002/index.html">Naive Spellchecking, or search for the nearest words from the dictionary by Levenshtein's metric on Scala</a></li>
<li><a href="../345006/index.html">Technology good</a></li>
<li><a href="../345010/index.html">Oh, I have a delay. Part 2</a></li>
<li><a href="../345012/index.html">Task with an asterisk: how we recoded the FIAS in KLADR</a></li>
<li><a href="../345016/index.html">Polymer, fight for performance</a></li>
<li><a href="../345018/index.html">Tutorial on the Unreal Engine. Part 7: Sound</a></li>
<li><a href="../345020/index.html">How I hacked 40 sites in 7 minutes (transfer)</a></li>
<li><a href="../345022/index.html">Collect and Filter Logon Events with Log Parser</a></li>
<li><a href="../345024/index.html">How to read a large file using PHP (without crashing a server)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>