<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Downloading music collection vk.com</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrahabr! 

 I decided to somehow download my music collection from vkontakte (which is almost 1000 songs). I did not want to contact vk.api, so ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Downloading music collection vk.com</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habrahabr! <br><br>  I decided to somehow download my music collection from vkontakte (which is almost 1000 songs).  I did not want to contact vk.api, so I decided to use the python + <a href="http://docs.python-requests.org/">request</a> library.  What came out of it - under the cut! <br><a name="habracut"></a><br>  First, let's see what our browser does when we turn to our audio page on VKontakte.  Open the developer tools (I used Chrome, F12) and go to <a href="http://vk.com/audio">vk.com/audio</a> .  We can see all the requests that the browser makes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8b/675/2ba/b8b6752ba2dc6f74ef43703daa057b4d.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The meaning of the actions of the browser is as follows: <br><br>  The first line is the GET request, which we send to the server when we first enter the page.  In response, the server gives us the html page code. <br>  Then the browser begins to load all the necessary resources: css, js and images. <br>  Towards the end of the list we see a non-standard line: this is a POST request with the name audio.  Most likely, this request sends javascript to get a list of audio recordings. <br>  In the response, the server returns to us a line like: <br><br><pre><code class="xml hljs">11055<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!</span></span></span><span class="hljs-tag">&gt;</span></span>audio.css,audio.js<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!</span></span></span><span class="hljs-tag">&gt;</span></span>6362<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!</span></span></span><span class="hljs-tag">&gt;</span></span>{"all":[ ['17738938','173762121', 'http://cs1276.userapi.com/u1040081/audio/c0e97293c5e2.mp3','300','5:00', 'Louis Prima','Sing, Sing, Sing (With A Swing)','369754','0','0','','0','1'], ['17738938','173368012', 'http://cs4372.userapi.com/u9237008/audio/5f51ceac6ca1.mp3','326','5:26', 'Look at my horse','My horse is amazing','10324035','0','0','','0','1'], ...</code> </pre> <br><br>  Bingo!  This is exactly what we need.  In response, the server returns us a JSON list of all our compositions and for each of them passes the following parameters: <br><ul><li>  0 - my id </li><li>  1 - composition id </li><li>  2 - link to the song </li><li>  3 - bitrate? </li><li>  4 - duration </li><li>  5 - author </li><li>  6 - the name of the composition </li><li>  7 - size in bytes? </li><li>  The remaining parameters are not clear. </li></ul><br><br><h2>  We get a list of audio recordings </h2><br><br>  How do we get the desired list?  Let's see what headers the browser sends in our request: <br><br><pre> <code class="hljs markdown">Request Headers: Accept:<span class="hljs-emphasis"><span class="hljs-emphasis">*/*</span></span> Accept-Charset:windows-1251,utf-8;q=0.7,<span class="hljs-emphasis"><span class="hljs-emphasis">*;q=0.3 Accept-Encoding:gzip,deflate,sdch Accept-Language:ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4 Connection:keep-alive Content-Length:45 Content-Type:application/x-www-form-urlencoded Cookie:remixlang=0; remixseenads=2; audio_vol=100; remixdt=0;remixsid=*</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>*; remixflash=11.4.31 Host:vk.com Origin:http://vk.com Referer:http://vk.com/audio User-Agent:Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4 X-Requested-With:XMLHttpRequest Form: Dataview URL encoded act:load<span class="hljs-emphasis"><span class="hljs-emphasis">_audios_</span></span>silent al:1 gid:0 id:17738938</code> </pre><br><br>  Let's try to simulate our query: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAudio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> response = r.post(url = <span class="hljs-string"><span class="hljs-string">"http://vk.com/audio"</span></span>, data = { <span class="hljs-string"><span class="hljs-string">"act"</span></span>:<span class="hljs-string"><span class="hljs-string">"load_audios_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"gid"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"17738938"</span></span> } ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> response.content getAudio()</code> </pre><br><br>  The function request.post creates a POST request to the url.  It can pass several parameters.  Here are the main ones: <br><ul><li>  headers - dictionary of the leaders we want to send to the server </li><li>  data - a dictionary of data to be transmitted in the request </li></ul><br><br>  The function will display <br><pre> <code class="hljs erlang-repl">&lt;!--<span class="hljs-number"><span class="hljs-number">11055</span></span>&lt;!&gt;audio.css,audio.js&lt;!&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>&lt;!&gt;<span class="hljs-number"><span class="hljs-number">6362</span></span>&lt;!&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>&lt;!&gt;<span class="hljs-number"><span class="hljs-number">230</span></span>b860567731c4875</code> </pre> <br><br>  The result is predictable - after all, we did not indicate that we are an authorized user.  For this you need to pass the server cookies.  Let's fix our query a bit: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAudio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> response = r.post( <span class="hljs-string"><span class="hljs-string">"http://vk.com/audio"</span></span>, data = { <span class="hljs-string"><span class="hljs-string">'act'</span></span>:<span class="hljs-string"><span class="hljs-string">"load_audios_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"gid"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"17738938"</span></span> }, headers = { <span class="hljs-string"><span class="hljs-string">"Cookie"</span></span>:<span class="hljs-string"><span class="hljs-string">"remixlang=0; remixseenads=2; remixdt=0; remixsid=**************; audio_vol=96; remixflash=11.4.31"</span></span> } ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> response.content[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>] getAudio()</code> </pre><br><br>  Now we get what we need. <br><br>  Good.  The list we received.  Now you need to otparsit and download each song separately.  I decided not to bother, and just used regular expressions: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#-*-coding:cp1251-*- import requests as r import re import random as ran import os import urllib as ur #    : ALLOW_SYMBOLS = " qwertyuiopasdfghjklzxcvbnm.,-()" COOKIE = "" #   cookies,    . def getAllowName(string): """    ,      ALLOW_SYMBOLS""" s='' for x in string.lower(): if x in ALLOW_SYMBOLS: s += x return s def getRandomElement(arr, delete = False): """    arr.  delete = True,      .""" index = ran.randrange(0, len(arr), 1) value = arr[index] if delete: arr.remove(value) return value def getAudio(): """     .         """ response = r.post( "http://vk.com/audio", data = { 'act':"load_audios_silent", "al":"1", "gid":"0", "id":"17738938" }, headers = { "Cookie":COOKIE } ) i=0 pat = re.compile(r"\[.+?\]") #    [.*] return pat.findall(response.content) #    already_added = [] #   id ,   . pat = re.compile(r"\'(.+?)\'") #     '.*' def OneDownload(x): """   ,   ( ['...', '...', '...', ...])   """ global already_added try: elements = pat.findall(x) #   id, url, author, name = (elements[1], elements[2], elements[5], elements[6]) #  - id, url, author, name except: return if id not in already_added: #     already_added.append(id) #    file_path = "audio/"+getAllowName(author+" - "+name)+".mp3" # ,       with open(file_path, "w"): #      pass ur.urlretrieve(url, file_path) #   print name, "downloaded" def getFirstNSongs(first=0, last = None): """,    ,         """ if not os.path.exists(os.path.join(os.getcwd(), 'audio')): #   audio   os.mkdir('audio') songs = getAudio() #   #  ,     first  last: if last!=None: songs = songs[first:last+1] else: songs = songs[first:] for x in songs: #    OneDownload(x) #  getFirstNSongs(last = 10)</span></span></code> </pre><br><br>  The main function here is OneDownload ().  In fact, it is she who downloads the songs.  This is done using the standard function urllib.urlretrieve (url, file_path, ...).  This function downloads the data that the server returns when accessing the url and writes to the file that is in the file_path path. <br><br>  Everything is good, everything is downloaded, but slowly! <br><br>  We can try to parallelize our algorithm.  Functions that I would like to perform in parallel is OneDownload.  Create a parallelization decorator: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_inside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*a, **k)</span></span></span><span class="hljs-function">:</span></span> thr = threading.Thread(target = f, args = a, kwargs = k) thr.start() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _inside</code> </pre><br><br>  A decorator in Python is a function that takes a function as an argument and performs some action. <br>  This decorator simply starts the received function in a separate thread. <br><br>  Add a global variable - the number of threads.  It will not be possible to directly change this variable from Threads, therefore we add functions <br><br>  increment, and getting: <br><br><pre> <code class="python hljs">alive_threads = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#  global alive_threads alive_threads+=x return alive_threads def get(): #  global alive_threads return alive_threads</span></span></code> </pre><br><br>  Now we make changes to the code.  Here is the final version of the program: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#-*-coding:cp1251-*- import requests as r import re import threading import time import random as ran import os import urllib as ur THREADS_COUNT = 10 ALLOW_SYMBOLS = " qwertyuiopasdfghjklzxcvbnm.,-()" COOKIE = "" #  cookies def getAllowName(string): s='' print string.lower() for x in string.lower(): if x in ALLOW_SYMBOLS: s += x return s def getRandomElement(arr, delete = False): index = ran.randrange(0, len(arr), 1) value = arr[index] if delete: arr.remove(value) return value alive_threads = 0 def inc(x): global alive_threads alive_threads+=x return alive_threads def get(): global alive_threads return alive_threads def Thread(f): def _inside(*a, **k): thr = threading.Thread(target = f, args = a, kwargs = k) thr.start() return _inside def getAudio(): response = r.post( "http://vk.com/audio", data = { 'act':"load_audios_silent", "al":"1", "gid":"0", "id":"17738938" }, headers = { "Cookie":COOKIE } ) i=0 pat = re.compile(r"\[.+?\]") return pat.findall(response.content) already_added = [] #   id ,   . pat = re.compile(r"\'(.+?)\'") #     '.*' count = 0 @Thread def OneDownload(x): global already_added inc(1) #    -    try: elements = pat.findall(x) id, url, author, name = (elements[1], elements[2], elements[5], elements[6]) except: return if id not in already_added: already_added.append(id) file_path = "audio/"+getAllowName(author+" - "+name)+".mp3" with open(file_path, "w"): pass ur.urlretrieve(url, file_path) inc(-1) #  -  def getFirstNSongs(a=0, N = None): if not os.path.exists(os.path.join(os.getcwd(), 'audio')): os.mkdir('audio') songs = getAudio() if N!=None: songs = songs[a:N] else: songs = songs[a:] previous = 0 #        cc=10 while (len(songs)&gt;0 and len(songs)!=previous) or (len(songs) == previous and cc&gt;0): #   ,          10  if previous != len(songs): previous = len(songs) #,    .   -  cc=10 #  - 10 else: cc-=1 #  ,     1.  -     10      print " ", len(songs), " ", alive_threads while alive_threads&lt;THREADS_COUNT: #     x = getRandomElement(songs, delete = True) #  ,    try: OneDownload(x) #  except: songs.append(x) #   -  . while alive_threads&gt;=THREADS_COUNT: time.sleep(10) #      -  10 . getFirstNSongs(N=3) #, ,  3 </span></span></code> </pre><br><br>  Now everything works. <br><br>  Sources and compiled version can be downloaded from this link: <br><br>  <a href="http://yadi.sk/d/FTJptw4d0euxg">VKmusic</a> <br><br>  <b>#UPD</b> <br>  In the compiled version there was a bug, the music swayed only from my page.  Corrected version: <br>  <a href="http://yadi.sk/d/4tX3bu3f0eucX">VKMusic</a> </div><p>Source: <a href="https://habr.com/ru/post/157925/">https://habr.com/ru/post/157925/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157913/index.html">New wireless chip provides 2 Gigabit per second connectivity</a></li>
<li><a href="../157915/index.html">Open source robots play football</a></li>
<li><a href="../157917/index.html">How to "open" the chip and what's inside?</a></li>
<li><a href="../157919/index.html">Time management and all-all-all in YouTrack 4.1</a></li>
<li><a href="../157921/index.html">How not to write large servers</a></li>
<li><a href="../157927/index.html">Acer Iconia Tab A211 Tablet Review</a></li>
<li><a href="../157929/index.html">Why Coming Soon Page Mobile Application and How to Use It?</a></li>
<li><a href="../157933/index.html">Talmud formulas in Google SpreadSheet</a></li>
<li><a href="../157935/index.html">Study: how do googles use Google+?</a></li>
<li><a href="../157937/index.html">Twitter password leak</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>