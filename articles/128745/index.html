<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OOP Packet Performance in Perl</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As is well known in Perl is not very convenient support for object-oriented programming. If you want to program with classes, then a lot has to be don...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OOP Packet Performance in Perl</h1><div class="post__text post__text-html js-mediator-article">  As is well known in Perl is not very convenient support for object-oriented programming.  If you want to program with classes, then a lot has to be done manually.  However, Perl has very rich extensibility, so over time, many libraries (packages) provide support for classes, methods, and properties with syntax of varying degrees of convenience.  But as it turned out, these packages lose in performance compared with the manual implementation of OOP constructs.  Those.  on the one hand, they are pleasant to use, and on the other, they make the code slower.  I always wanted to know how slower the code becomes, and which of these packages should be used and which ones should not.  So I decided to do a little research. <br><br><a name="habracut"></a><br><h5>  Overview of OOP Packages </h5><br>  First, let's take a quick look at the available OOP packages for Perl. <br><br><h6>  Just perl </h6><br>  Without any packages, you can create a class in Perl like this: <br><pre><code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> Dog; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($class, %self) = @_; <span class="hljs-keyword"><span class="hljs-keyword">bless</span></span> \%self, $class; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> \%self; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_noise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;{name}, <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  Then this class can be used as follows: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Dog; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $dog = Dog-&gt;new(<span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"Snoopy"</span></span>); $dog-&gt;make_noise();</code> </pre><br><h6>  Moose </h6><br>  <a href="">Moose</a> ideas from Perl6 lay in the basics of <a href="">Moose</a> .  Using it to create classes much easier.  The previous example, rewritten using Moose, will look much better: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> Dog; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Moose; has <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> (<span class="hljs-string"><span class="hljs-string">is =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ro'</span></span>, <span class="hljs-string"><span class="hljs-string">isa =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Str'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_noise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;name(), <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } __PACKAGE_<span class="hljs-number"><span class="hljs-number">_</span></span>-&gt;meta-&gt;make_immutable;</code> </pre><br>  As you can see, it is no longer necessary to explicitly create the <b>new</b> method, and properties are now described much easier and more naturally.  But all is not smooth.  We have to manually unpack the <b>$ self</b> parameter in each class method.  In general, the methods remained simply Perl procedures.  I wish they looked more like normal methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Method :: Signatures </h6><br>  And then this wonderful package comes to our aid: <a href="">Method :: Signatures</a> .  I advise you to read the documentation on it - there are many pleasant surprises. <br><br>  With it, our code gets even better: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> Dog; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Moose; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Method::Signatures; has <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> (<span class="hljs-string"><span class="hljs-string">is =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ro'</span></span>, <span class="hljs-string"><span class="hljs-string">isa =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Str'</span></span>); method make_noise() { <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;name(), <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } __PACKAGE_<span class="hljs-number"><span class="hljs-number">_</span></span>-&gt;meta-&gt;make_immutable;</code> </pre><br><h6>  MooseX :: Declare </h6><br>  The inquisitive minds of Perl's adepts did not stop there, but went much further and wrote <a href="">MooseX :: Declare</a> .  A truly wonderful package, if it were not for one drawback (about which later).  Now we can achieve complete nirvana in the description of our <b>Dog</b> class: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> MooseX::Declare; class Dog { has <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> (<span class="hljs-string"><span class="hljs-string">is =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ro'</span></span>, <span class="hljs-string"><span class="hljs-string">isa =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Str'</span></span>); method make_noise() { <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;name(), <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } }</code> </pre><br><h5>  OOP packet performance </h5><br>  Perl allows you to achieve almost complete naturalness in the description of classes.  But do not rejoice.  It turns out this naturalness leads to a loss of performance.  To find out how, compare such characteristics as: <br><ul><li>  Creating a class object. </li><li>  Method call </li><li>  Access to the property. </li></ul><br>  And so begin.  <a href="">Benchmark</a> package will be used for testing.  In the test results, the notation is as follows: <br><ul><li>  vanilla is pure Perl with no additional packages. </li><li>  moose - with Moose package, </li><li>  moose_sig - with Moose and Method :: Signatures, </li><li>  moosex - with the MooseX package. </li></ul><br><h6>  Object creation </h6><br><pre>               Rate moose_sig moose moosex vanilla
 moose_sig 104102 / s - -0% -0% -74%
 moose 104383 / s 0% - -0% -74%
 moosex 104592 / s 0% 0% - -74%
 vanilla 401924 / s 286% 285% 284% -
</pre><br>  As you can see, creating objects using all OOP packages is almost 4 times slower than on pure Perl.  But there is one good news: the operation of creating an object using Moose and MooseX :: Declare takes place in the same time.  Therefore, if you use one of these packages, then preference must be given to MooseX :: Declare. <br><br><h6>  Method call </h6><br>  Let's move on to the next item, the method call.  Here the picture is not so remarkable: <br><br><pre>               Rate moosex moose moose_sig vanilla
 moosex 8596 / s - -94% -94% -95%
 moose 148055 / s 1622% - -0% -17%
 moose_sig 148516 / s 1628% 0% - -17%
 vanilla 178254 / s 1974% 20% 20% -
</pre><br>  MooseX loses Moose (with or without Signatures) 16 times!  This is of course a big surprise.  If you search the Internet, you may find that the reason for such a big difference in performance is the MooseX :: Method :: Signatures package.  Therefore, until the situation improves for the better, MooseX, as it is, cannot be used. <br><br>  However, the good news is that Moose + Method :: Signatures is only 20% slower than pure Perl.  Therefore, you can safely use these packages without any significant loss of performance. <br><br><h6>  Property access </h6><br>  We turn to the last item of the tests, access to the property of the object: <br><br><pre>                Rate moosex moose_sig moose vanilla
 moosex 1503608 / s - -1% -1% -17%
 moose_sig 1517928 / s 1% - -0% -16%
 moose 1517928 / s 1% 0% - -16%
 vanilla 1815063 / s 21% 20% 20% -
</pre><br>  Again, losing all packages compared to pure Perl is only 20%.  As you can see, here MooseX was not worse than other packages.  If only not for MooseX :: Method :: Signatures ... <br><br><h5>  Fix moosex </h5><br>  I'd like to use MooseX, but he is very prickly.  Let's try to correct it so that it is at least a little bit better when calling methods. <br><br>  The first thing that comes to mind is to use Method :: Signatures with MooseX :: Declare.  Rewrite the <b>Dog</b> code as follows: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> MooseX::Declare; class Dog { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Method::Signatures; has <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> (<span class="hljs-string"><span class="hljs-string">is =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ro'</span></span>, <span class="hljs-string"><span class="hljs-string">isa =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Str'</span></span>); method make_noise() { <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;name(), <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } }</code> </pre><br>  This approach works, but leads to an ugly warning: <br><br><pre> Subroutine Dog :: method redefined at /opt/local/lib/perl5/site_perl/5.14.1/darwin-thread-multi-2level/Devel/Declare/MethodInstaller/Simple.pm line 17.
 Prototype mismatch: sub Dog :: method: none vs (&amp;) at /opt/local/lib/perl5/site_perl/5.14.1/darwin-thread-multi-2level/Devel/Declare/MethodInstaller/Simple.pm line 17.
</pre><br><br>  The fact is that <b>method</b> is a simple Perl function that is defined by both MooseX :: Method :: Signatures and Method :: Signatures.  But it is determined with different prototypes, whence there is a warning.  Unfortunately, I did not find how to remove this warning.  So I had to come up with another solution. <br><br><h6>  Method :: Signatures :: Simple </h6><br>  What could be easier!  <a href="">Method :: Signatures :: Simple</a> is a simplified version of Method :: Signatures that has one good feature.  You can set your own name for the <b>method</b> function in it, thus avoiding a conflict with MooseX :: Method :: Signatures. <br><br>  Using this package, the <b>Dog</b> will look like this: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> MooseX::Declare; class Dog { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Method::Signatures::Simple <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'def'</span></span>; has <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> (<span class="hljs-string"><span class="hljs-string">is =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ro'</span></span>, <span class="hljs-string"><span class="hljs-string">isa =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Str'</span></span>); def make_noise() { <span class="hljs-keyword"><span class="hljs-keyword">say</span></span> $self-&gt;name(), <span class="hljs-string"><span class="hljs-string">" says: ruff-ruff!"</span></span>; } }</code> </pre><br>  The difference is that instead of <b>method,</b> we now write <b>def</b> (as in Python). <br><br>  Let's see if the performance of our code has improved (moosex_sig): <br><br><pre>                Rate moosex moosex_sig moose_sig moose vanilla
 moosex 8651 / s - -94% -94% -94% -95%
 moosex_sig 146152 / s 1589% - -1% -3% -18%
 moose_sig 148025 / s 1611% 1% - -2% -17%
 moose 150866 / s 1644% 3% 2% - -16%
 vanilla 179200 / s 1971% 23% 21% 19% -
</pre><br>  Our expectations were met.  MooseX :: Declare + Method :: Signature :: Simple gives the same performance as Moose + Method :: Signatures. <br><br><h5>  Conclusion </h5><br>  Despite all the riches of choice, there is only one alternative.  Today, the best recommendation from my point of view for using OOP in Perl is the combination of the MooseX :: Declare and Method :: Signatures :: Simple packages.  It allows you to describe classes in a natural way and has a not very large, one might even say, quite reasonable price in terms of performance. <br><br>  Addendum: source code for tests is available on github: <a href="https://github.com/alexeiz/oopbench">github.com/alexeiz/oopbench</a> </div><p>Source: <a href="https://habr.com/ru/post/128745/">https://habr.com/ru/post/128745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128737/index.html">The problem of 3D particles in After Effects</a></li>
<li><a href="../128740/index.html">The peculiarity of working with smart points in Qt</a></li>
<li><a href="../128741/index.html">Hiding, obfuscating and crypting the client side of web applications</a></li>
<li><a href="../128742/index.html">VPN over L2TP: error 678 - one small registry key</a></li>
<li><a href="../128744/index.html">Gamers in Fold.it solved a scientific problem</a></li>
<li><a href="../128746/index.html">Page layout rel = "next | prev"</a></li>
<li><a href="../128747/index.html">Programming Windows Phone 7. Lecture 2. Orientation</a></li>
<li><a href="../128749/index.html">HP Touchpad Review: Tablet or Toy?</a></li>
<li><a href="../128750/index.html">Google+ user directories</a></li>
<li><a href="../128751/index.html">CUDA in Adobe Premiere CS5: Is the use of a budget video card justified?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>