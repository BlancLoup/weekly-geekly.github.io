<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video sequence in drawable</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the post about Apple's approach to encoding video to JPEG, I decided to talk about my similar ‚Äúbike‚Äù under Android. 

 In our mobile project, we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video sequence in drawable</h1><div class="post__text post__text-html js-mediator-article">  After the <a href="http://habrahabr.ru/post/151637">post</a> about Apple's approach to encoding video to JPEG, I decided to talk about my similar ‚Äúbike‚Äù under Android. <br><br>  In our mobile project, we decided to make thumbnails of weapons not videos, but videos.  It was meant that the artists would draw beautiful animations, maybe even in 3D, but something didn‚Äôt work out and we were given the simplest looped 1-1.5 second videos in the resolution of 256x256.  In the iOS version, they built in remarkably, but in Android I had to make war with the MediaPlayer and SurfaceView, but all the same, there were some ‚Äúclumsiness‚Äù - the contents of SurfaceView did not move after the parent View, there was a noticeable pause during playback, etc. <br><br>  A reasonable solution would be to break the animation into frames and arrange it in xml for AnimationDrawable, but for 15 types of weapons this would mean a trashcan of 5000+ frames of 10-15 kb each.  Therefore, its own implementation of AnimationDrawable, working with the sprite sheet and a relatively fast method of converting video into such a format, was made. <br><a name="habracut"></a><br><h3>  Sprite sheet </h3><br>  Map sprites without further ado decided to do horizontal, without a description file.  This is not ideal practical, but for 1-2 second animations is not critical. <br>  The original video is divided into sprites via ffmpeg: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>ffmpeg -i gun.avi -f image2 gun-%02d.png</code> <br> <br>  If more than 32 frames are obtained, then the -r 25 or -r 20 parameter is added to reduce fps.  The limit of 32 frames is taken from the maximum reasonable image size horizontally at 8192 pixels.  This can be bypassed by a more complex arrangement of sprites, but for a sequence of 1-1.5 seconds, this is enough. <br><br>  It turns out such a scattering of files: <br><br><img src="https://habrastorage.org/storage2/a7d/6f8/234/a7d6f8234fa6539b363ac63ecdd8188f.png"><br><br>  I use <a href="http://zwopple.com/zwoptex/">Zwoptex</a> to build a sprite sheet, but any similar tool, or even a self-written script, will do. <br><br><img src="https://habrastorage.org/storage2/13e/de4/6ec/13ede46ec08ab348c8519dc25d76dc8f.png"><br><br>  In the example with the gun turned out png file size 257kb and a resolution of 8192x256.  After trimming to 7424x256 and processing through the <a href="http://tinypng.org/">TinyPNG</a> site <a href="http://tinypng.org/">,</a> it was reduced to 101kb without loss of quality.  If desired, you can also save it in JPG with a small loss of quality and reduce to 50-70kb.  For comparison, the original video in .MP4 with high quality takes the same 100kb.  For more complex animations, PNGs can turn out to be 2-3 times larger than the original video, which is actually not critical either. <br><br><img src="https://habrastorage.org/storage2/62a/7da/844/62a7da8449b13e866094aa4092e9105d.png"><br><br><h3>  Own AnimationDrawable </h3><br>  In the original version of the bet was made that <a href="http://developer.android.com/reference/android/graphics/Bitmap.html">Bitmap.createBitmap</a> does not create a new image, but a subset of the existing one in accordance with the description: <br><br>  Returns an immutable bitmap from the source bitmap. <br><br>  The designer loads the image, splits it into frames and adds them to the AnimationDrawable.  In our case, animations are stored in assets to gain access by name, but the code is very easily adapted to work with R.drawable. * <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AssetAnimationDrawable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnimationDrawable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AssetAnimationDrawable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String asset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frames, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fps)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ BitmapFactory.Options options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapFactory.Options(); options.inPreferredConfig = Config.RGB_565; <span class="hljs-comment"><span class="hljs-comment">// AG: use 16-bit mode without alpha for animations this.bitmap = BitmapFactory.decodeStream(context.getResources() .getAssets().open(asset), null, options); int width = bitmap.getWidth() / frames; int height = bitmap.getHeight(); int duration = 1000 / fps; // AG: note the little gap cause of integer division. // ie duration would be 33 for 30fps, meaning 990ms for 30 frames. for (int i = 0; i &lt; frames; i++) { Bitmap frame = Bitmap.createBitmap(bitmap, i * width, 0, width, height); addFrame(new BitmapDrawable(frame), duration); } } }</span></span></code> </pre><br><br>  The class is used, as usual AnimationDrawable: <br><br><pre> <code class="java hljs"> AnimationDrawable animation = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssetAnimationDrawable(getContext(), <span class="hljs-string"><span class="hljs-string">"movies/gun.jpg"</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); animation.setOneShot(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); previewImage.setImageDrawable(animation); animation.start();</code> </pre><br><br>  Unfortunately, experiments have shown that it is not a immutable link to the original that is created, but a new image for each frame, because this solution turned out to be quite resource intensive, although it works fine for many situations. <br><br>  The next option is already much more complicated and is inherited directly from Drawable.  In the constructor, the sprite sheet is loaded into a member of the class, and in the draw method, the current frame is drawn.  The class also implements the Runnable interface by analogy with the original AnimationDrawable for animation. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ canvas.drawBitmap(m_bitmap, m_frameRect, copyBounds(), m_bitmapPaint); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> tick = SystemClock.uptimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tick - m_lastUpdate &gt;= m_duration) { m_frame = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (m_frame + (tick - m_lastUpdate) / m_duration) % m_frames; m_lastUpdate = tick; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> time shift for incomplete frames m_frameRect = new Rect(m_frame * m_width, 0, (m_frame + 1) * m_width, m_height); invalidateSelf(); } scheduleSelf(this, tick + m_duration); } public void start() { run(); } public void stop() { unscheduleSelf(this); } public void recycle() { stop(); if (m_bitmap != null &amp;&amp; !m_bitmap.isRecycled()) m_bitmap.recycle(); }</span></span></code> </pre><br><br>  In the run () method, the current frame is calculated and the task is queued.  The accuracy of the above code will not be perfect, because the fractional frame time is not taken into account (for example, when tick - m_lastUpdate is 1ms less than the duration), but in our problem it was not relevant, and those who want can modify the class on their own. <br>  Full paste2 code: <a href="http://paste2.org/p/2240487">paste2.org/p/2240487</a> <br><br>  I want to draw attention to the recycle () method, which clears m_bitmap.  In most cases, it is not needed, but we can quickly click through purchases in the store, because of which several AssetAnimationDrawables are created and the memory may run out, so when creating a new animation, we clear the old resources. <br><br><h3>  Advantages and disadvantages </h3><br>  Of course, the approach is far from ideal and is not suitable for large animations or significantly different frames, but for our task it came up perfectly, without a noticeable increase in the project and visual bugs. <br><br>  Minuses: <br><ul><li>  inheriting from Drawable we lose some AnimationDrawable features like setOneShot </li><li>  image 8192x256x32bpp takes up 8MB of memory </li><li>  it is necessary to store somewhere the number of frames and fps for each animation </li><li>  own code for standard solutions worsens the readability of the program and complicates its support </li><li>  compressing the sprites with jpg we get the worst quality, at the same size as the original video.  Squeezing in png we get the same quality, at 1-3 times the size </li></ul><br><br>  Pros: <br><ul><li>  no bugs with SurfaceView, MediaPlayer, braking when loading </li><li>  in the RGB_565 mode, the picture 8192x256 takes 4MB of memory, and if needed, you can put options.inSampleSize = 2 or more in the constructor to reduce the size and memory (at a value of 2, 0.5MB of memory and a resolution of 4096x128 are obtained) </li><li>  You can scale the sprite sheet in your favorite editor to any size.  the main rule is that the width remains a multiple of frames </li><li>  You can adjust the playback speed through fps without any problems without changing the finished files </li><li>  it is quite possible to play the animation with transparency in the modes ARGB_8888 or ARGB_4444 </li><li>  at any time you can stop the animation and free up resources </li></ul><br><br><h3>  PS </h3><br>  If it will be interesting to someone, I can separately tell you about the experience of integrating small videos in the GUI into MonoTouch for an iOS project.  Documentation on Mono is relatively small, and there are enough pitfalls there. </div><p>Source: <a href="https://habr.com/ru/post/151791/">https://habr.com/ru/post/151791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151785/index.html">Sony has introduced an updated PlayStation 3</a></li>
<li><a href="../151786/index.html">Errors found in Visual C ++ 2012 libraries</a></li>
<li><a href="../151787/index.html">Service for creating layouts of rooms and interiors</a></li>
<li><a href="../151789/index.html">Working with AdMob in Russia will become easier from October 1, 2012</a></li>
<li><a href="../151790/index.html">Ten ways to make millions in your career</a></li>
<li><a href="../151793/index.html">Why Russia is a country of the fourth world in social networks</a></li>
<li><a href="../151795/index.html">We give files efficiently using PHP</a></li>
<li><a href="../151796/index.html">Technology Day and Express School for Students in St. Petersburg: September 28 and 29!</a></li>
<li><a href="../151798/index.html">.NET Subbotnik in Dnepropetrovsk - the best speakers from the Dnieper and Kiev</a></li>
<li><a href="../151799/index.html">KMZ OJSC resumed production of photo lenses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>