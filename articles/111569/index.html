<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write HTTP proxy server with plugins</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one time, the topic surfaced that in one of the online games there appeared such a rather annoying thing as a captcha . By itself, distracting from...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write HTTP proxy server with plugins</h1><div class="post__text post__text-html js-mediator-article"><img src="http://img718.imageshack.us/img718/4941/imagejdl.jpg" alt="image">  At <a href="http://travian.ru/">one</a> time, the topic surfaced that in <a href="http://travian.ru/">one of the online games</a> there appeared such a rather annoying thing as a <a href="http://ru.wikipedia.org/wiki/CAPTCHA">captcha</a> .  By itself, distracting from the game to enter captcha can turn out not very good consequences, especially if you enter it not the first time, and enemies can annoy.  But not in this salt.  Especially bad thing for those who use local bots.  Those small ones stumble over the captcha, and for this game the game instantly penalizes them with the loss of units and resources.  Unpleasant thing to say. <br><br>  So, the task: <br>  It would be desirable, that it was not necessary to enter captcha.  Even if you play yourself, even if the bot plays for you, if you sleep. <br>  Additional condition: 40 hours of time (for panic on the ship). <br>  Desirable condition: the installation file under Windows. <br>  Another desirable condition: the result should take no more than a megabyte. <br><a name="habracut"></a><br><br>  I will say right away that I am not a gamer, and even on the contrary, I am some opponent of online games, and in order to introduce additional entropy into this industry, I decided to take up this business.  The case, perhaps, could bring some profit in the wake of the appearance of captcha and panic associated with it, but did not bring it for certain reasons. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So what to do? <br><br><h5>  Attempt 1 </h5><br>  Write a system tool that intercepts HTTP requests and responses from all installed programs, and filters those responses to which you would need to enter a captcha, entering it yourself.  Two Belarusian programmers pored over the program for about half a year, changing the platform from C to C #, and then to Java, and putting up with the fact that they might need OpenSSL installed on the machine.  The task every time overgrown with unnecessary details.  Well, in general, it did not work out. <br><br><h5>  Attempt 2: Himself, all myself </h5><br><br>  It is quite clear that there are not so many methods, and the choice is only between SOCKS proxy and HTTP proxy.  After a while, it became clear that SOCKS proxies were supported by far from all user applications, and the choice became unequivocal. <br><br><h6>  Platform selection </h6><br>  The choice was not difficult, especially considering the attempt 1. C and C # were quickly swept away, given the complete lack of experience.  The following rich platforms were identified: <br><br>  <b>Java</b> It is difficult to assume that to install such a small utility, users would want to install a JVM, weighing scary to say how many tens of megabytes.  Java has fallen off. <br><br>  <b>Python</b> As you know, it works everywhere and everything is included (batteries included).  It weighs 7MB.  By modern standards, of course, a bit, but still wanted more compact.  The question remains how to install this installer in the installer of my utility.  I do not know how this is done in Python applications, perhaps much easier, but I once did the installer in the installer and no longer want it. <br><br>  <b>Ruby</b> At the time of the beginning of my searches there was no one-step installer for Windows.  Completely.  Now there is, it implies the installation of MinGW, MSYS and other things, when installing a user that might scare.  Weight 7Mb. <br>  About the installer in the installer, the question remains. <br><br>  <b>Lua</b> A very old and popular language among scripters of C ++ games.  Sluggish community, scattered libraries.  The weight of a <a href="http://www.murga-projects.com/murgaLua/">custom</a> VM <a href="http://www.murga-projects.com/murgaLua/">assembly</a> in the right libraries is only 800Kb.  The installer is not provided, there is a set of exe files, which as a parameter is passed to the lua script to run it.  What you need is also compiled under Win, MacOS, Linux, each of them in versions 32 and 64 separately.  That is necessary. <br><br>  So, I took up the study of <a href="http://www.lua.org/">Lua</a> (the New Year wish came true, I learned a new programming language). <br>  The language has wonderful properties, such as: <br>  - sandboxing (in ruby ‚Äã‚Äãthere was only a <a href="https://github.com/whymirror/sandbox">patch</a> for version 1.8.5): it allows you to run third-party code, limiting its environment; <br>  - coroutines (such as ruby ‚Äã‚Äãfibers of 1.9): allows you to make very lightweight cooperative multitasking; <br>  - very simple (more precisely, simple - there is only an associative array) data structure, which, as it turned out, is enough for most data processing tasks; <br>  ... much more, so hard in one post. <br><br>  The easiest thing was to make such a system in the form of a HTTP proxy server filtering requests and responses, which was decided to do (well, not good). <br><br>  The idea is simple: hang the TCP server, listen to what the client asks, parse the HTTP headers, search for the HOST, remove the HTTP header ‚ÄúProxy-Connection‚Äù, send a request to the intended recipient, receive a response, direct the client, etc. <br><br>  The server's response needs to be filtered, and this can be done if the server does not use HTTPS, and it fortunately does not use it.  It turned out to be quite simple, it turned out to be enough to write a shortened to 190 lines of Lua analog <a href="http://mechanize.rubyforge.org/">mechanize for Ruby</a> , which does with the headers and body of the request that no matter what head, allowing you to write whatever you want filters for HTTP requests. <br><br>  Well, in this case, we had to get rid of the harmful <a href="http://www.google.com/recaptcha">reCAPTCHA</a> , for which we only needed to determine: <br>  - whether the page trabiana slit the original request (and whether the requested HTML page): <br> <code>string.find(request.uri(), 'travian') and mimetype and string.find(mimetype, 'text/html') <br></code> <br>  - whether the result page contained a captcha instead of ‚Äúuseful‚Äù game data: <br> <code>local captcha, captcha_key = string.match(response.body(), '&lt;iframe src="(http://api.recaptcha.net/noscript??(k=[%a%d_]+&amp;lang=en))') <br></code> <br><br>  How to solve the captcha itself (with the help of not too modern and high-performing Hindus, but extremely cheap living Hindus) is a bit beyond the scope of our purely technical subject, therefore somewhere else. <br><br>  As a result, the captcha image was downloaded, sent to the Indians (2 times just in case), the responses received in 5-10 seconds were compared, and if they were the same, the result was sent to the HTTP POST request, to which the victim issues a page, happily reporting that we, it turns out, a man, and a bunch of "useful" game data.  We are showing this page to an unsuspecting client who could notice only a pause.  In the pessimistic case of a mismatch, the picture was sent to the Hindus again, and so on until the moment when at least two identical solutions could be obtained, the rest were sent to the support service for a refund (practically no freebies for the Indians). <br><br>  So, here it is, the solution is. <br><br>  However, something happened that no one could have imagined.  For some reason, users also needed access to other sites, is unthinkable!  Among them were even sites accessed via HTTPS, and with this it was necessary to do something without regular switching proxies on / off. <br>  And it was also necessary that several requests be received simultaneously.  It was unpleasant that google analytics sometimes makes a request lasting a minute, leaving a single-threaded proxy on standby. <br><br>  Well, for this there were as many as three different libraries for creating an asynchronous TCP server.  That is, we wait for the incoming connection, get a piece of data, transfer control to the dispatcher, see if there are still incoming connections or open connections for which there is data (select / kpoll / epoll), transfer control in turn. <br><br>  Alas and oh, since all such connections occur on a local machine, all this happens almost instantly.  And slow connections are outgoing.  Podkovyryat existing libraries ( <a href="http://keplerproject.github.com/copas/">copas</a> , <a href="">asok</a> ), which are designed to multiplex incoming connections, was more difficult than writing your own.  And I wrote a short one (272 lines) of <a href="">mine</a> .  In addition to the fact that all incoming and outgoing connections work asynchronously, you can add any more korutinas (correct me, people with specialized education) to the pool that works in the general cycle. <br><br>  Well, everything began to work in parallel, and in terms of speed, it only lags behind how it works without a proxy. <br><br>  How great was my surprise when I received from the server a page with (including) headers: <br>  Content-Encoding: gzip <br>  Transfer-Encoding: chunked <br>  and actually full cracks as a response body. <br><br>  The first thought was to disable Accept-Encoding in the request so that the server did not try to pack the data, and to remake HTTP 1.1 into HTTP 1.0 so that it would not send ‚Äúchunks‚Äù.  But I thought about falling speed and increasing traffic, and took pity on users. <br>  It turned out like this: <br> <code>if headers(pipe, target)['Transfer-Encoding'] == 'chunked' then <br> target.body = dechunk(target.body) <br> end <br> <br> function dechunk(chunkie) <br> local chunk_size <br> local chunk <br> local chunks = {} <br> chunkie, chunk_size = readline(chunkie) <br> <br> while chunk_size and tonumber(chunk_size, 16) &gt; 0 do <br> chunkie, chunk = readbytes(chunkie, tonumber(chunk_size, 16)) <br> <br> table.insert(chunks, chunk) <br> chunkie, chunk_size = readline(chunkie) <br> if not chunk_size or chunk_size == '' then -- sometimes there's a crlf, sometimes not <br> chunkie, chunk_size = readline(chunkie) <br> end <br> end <br> <br> return table.concat(chunks) <br> end <br></code> <br><br>  Gone to read materiel.  Thank God for these items of documentation decently. <br>  We glue the "chunks", we get a gzip file (sometimes deflate, but I have not met yet).  Unpacking (thanks to David Manura for the <a href="https://github.com/davidm/lua-compress-deflatelua">library</a> ). <br>  Unpacking came out even easier: <br> <code>if headers(pipe, target)['Content-Encoding'] == 'gzip' and #target.body &gt; 0 then <br> local decoded = {} <br> gzip.gunzip {input=target.body, output=function(byte) table.insert(decoded, string.char(byte)) end} <br> target.body = table.concat(decoded) <br> end <br></code> <br><br>  Left a little <br>  - make HTTPS tunneling for HTTPS sites (thank God, OpenSSL does not need to be bundled, just transfer the data transparently back and forth): <br> <code>if request.method() == 'CONNECT' then <br> local sent_to_server, err = client.send("HTTP/1.0 200 Connection established\r\nProxy-agent: BotHQ-Agent/1.2\r\n\r\n") <br> print('https transparent connection') <br> https(client, server) <br> return <br> end <br> <br> local function https(client, server) <br> close_callback = function() <br> client.close() <br> server.close() <br> end <br> <br> client.receive_subscribe(function(data) <br> server.send(data) <br> end, close_callback) <br> <br> server.receive_subscribe(function(data) <br> client.send(data) <br> end, close_callback) <br> end <br></code> <br><br>  - put in the installer: <br>  In general, adventures with the launch of <a href="http://7zsfx.info/">7zip sfx</a> on <a href="https://heroku.com/">Heroku</a> are a separate post.  The joy of victory overshadows any difficult moments of development. <br><br>  Well, I do not know about you, but it was interesting and exciting for me to do this.  I do not regret the time spent. <br><br>  Eventually: <br>  The proxy server itself is on line 71 <a href="">here</a> . <br>  Asynchronous library TCP-server-client for 272 lines <a href="">here</a> . <br>  A kind of HTTP client for 190 lines. <br>  Filter for solving captcha for 150 lines <a href="">here</a> . <br>  An installation file smaller than a megabyte. <br><br>  I am sure that there are many useful applications for such a thing, ranging from not-so-good ones, such as spamies with an ‚Äúautomatic‚Äù captcha solution, to useful ones when it is necessary to filter user traffic flexibly with a script.  Let me give you a simple script that does not allow users connected through a proxy to connect to vk.com: <br> <code>module(..., package.seeall) <br> function filter(request, response) <br> response.set_body('') <br> end <br> <br> function pre(request, response) <br> return string.find(request.uri(), 'vk.com') <br> end <br></code> <br><br>  With the upcoming release of lua 5.2, the restriction on calling metamethods from corutin will be removed, and libraries can be made more beautiful, for example, the http.set_body methods and much more will go. </div><p>Source: <a href="https://habr.com/ru/post/111569/">https://habr.com/ru/post/111569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111561/index.html">Replenishment of Webmoney wallet from Beeline SIM card balance</a></li>
<li><a href="../111563/index.html">Everything you need to know about the semicolon</a></li>
<li><a href="../111564/index.html">GECK or World Village Creation Kit</a></li>
<li><a href="../111565/index.html">Symfony Code'n'Coffee Minsk (Belarus) Jan 2011 (Extraordinary!)</a></li>
<li><a href="../111567/index.html">LG introduced the ‚Äúschool board of the future‚Äù - Touch TV</a></li>
<li><a href="../111571/index.html">Laziness - the mechanism</a></li>
<li><a href="../111572/index.html">We are testing a new template</a></li>
<li><a href="../111573/index.html">Expansion for Safari "Music from Contact"</a></li>
<li><a href="../111574/index.html">Implementing the ‚Äúdropbox‚Äù service using the Blobstore API (Part 1)</a></li>
<li><a href="../111576/index.html">Thoughts on the interface: What is more important - functionality or interface?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>