<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Privilege escalation in a Windows environment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Information Security Management Practice: pentest 
 User privilege escalation to Windows domain administrator level 

 Introduction 
 A good informati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Privilege escalation in a Windows environment</h1><div class="post__text post__text-html js-mediator-article"><h2>  Information Security Management Practice: pentest </h2><br>  <b>User privilege escalation to Windows domain administrator level</b> <br><br><h4>  Introduction </h4><br>  A good information security management system (ISMS) requires regular evaluation of its effectiveness.  There are different methods of such assessments, one of the varieties of which is the so-called.  ‚ÄúPenetration test‚Äù or pentest - an authorized simulation of a hacker attack on an information system in order to detect vulnerabilities in its protection before a real attacker detects them.  Any hacking tools, exploits, methods, etc. available in real life can be used. <br><br>  This article contains a description of one of these anti-hacker practices, aimed at raising the powers of an ordinary user of the Microsoft Windows domain to the domain administrator level.  The article was based on a report on the results of the test implemented in practice.  For confidentiality reasons, all information allowing to identify the venue (domain names and hosts, accounts, etc.) is deleted or changed.  The article shows the basic techniques, for a better understanding, I cited the theoretical foundations and vulnerabilities used for specific versions of operating systems, as well as general recommendations for protection.  And although most of these versions of Windows at the time of publication will be considered obsolete, the article may be useful to novice system administrators to better understand the methods of protecting credentials in the Windows environment. <br><a name="habracut"></a><br><h4>  Description of the test object </h4><br>  The object of testing is fairly standard - the information system of a small (less than 200 employees) company specializing in software development.  The company's internal network is also typical: switched Gigabit Ethernet, Microsoft Windows domain (we will call it CORP.LOCAL).  Internal hosts are divided into IP subnets on the basis of their functional affiliation (such as: development team, quality engineers, human resources, accounting, marketing, top management, facilities, etc.); all segmentation is done on the L3 switch .  There is also a park of internal servers allocated to a separate IP subnet, containing: two Windows Server 2008 domain controllers with integrated DNS, an internal mail server running Exchange, a file server, a terminal server, and some other auxiliary servers running Windows and Linux.  Separately, it is worth noting a test lab with a fleet of machines running different versions of Microsoft Windows (both desktop and server) and designed to test the software being developed.  Access to the test lab hosts have all employees.  The basic version of the desktop OS is Windows 7. On desktops and servers, poorly configured anti-virus software from different manufacturers is installed (from Symantec, Kaspersky and Trend Micro, why it is badly configured - more on this later). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Intruder Model </h4><br>  The intruder is an internal employee who has an unprivileged user account in the domain, a desktop computer, physical access to test computers (may have a corporate laptop), but does not have local administrator privileges on any of them.  Also, the account of the offender does not have the ability to change the settings of antivirus software.  The purpose of the offender is to gain access, equivalent to administrator access, to a domain controller and / or file server. <br><br>  As we see, both the model of the violator and the description of the company are quite typical. <br><br><h3>  Attack implementation </h3><br><h4>  Step 0. Gather information about the internal network </h4><br>  So, we act on behalf of the offender.  In this step, we need to collect information about: <br><br><ul><li>  internal addressing and subnetting </li><li>  names and IP addresses of hosts, first of all we are interested in the list of servers </li><li>  using the NetBIOS protocol. </li></ul><br>  First, using the ipconfig utility, we obtain the IP addresses of the DNS servers: 192.168.12.1 and 192.168.12.2.  Since  DNS is integrated with Active Directory, this gives us reason to believe that we know the IP addresses of domain controllers.  Next, using the nslookup utility in interactive mode, we try to get a list of all the hosts in the corp.local zone: <br><br>  <i>&gt; ls ‚Äìd corp.local&gt; file</i> <br><br>  In fact, this command initiates a full transfer of the DNS zone, saving it to file.  Many administrators forget to set restrictions on the transfer zone for the internal network, which makes it easier for a potential attacker to gather information about the company's infrastructure, see [12] for more details. <br><br>  <b>Result.</b>  Success.  The unsecured zone transfer gave us a complete list of internal host names, including servers, and their IP addresses.  Using nbtstat, telnet utilities, as well as any of the common vulnerability scanners, an intruder can gather information about the platform, the services running, the OS version on the hosts of interest. <br><br><h4>  Step 1. Obtaining local administrator privileges </h4><br>  <b>Theory.</b>  To obtain the password of the local administrator, an attack is made on the value of the hash function stored in the system registry.  Despite the fact that mathematically the hash function is irreversible, the password can be calculated by directly iterating through its values ‚Äã‚Äãalong with a dictionary attack.  Windows has historically used two algorithms for computing the password hash function: the outdated LM algorithm and the newer NT algorithm (sometimes also called NTLM).  The LM hash function is vulnerable due to its low computational complexity, which makes it possible to iterate over its values ‚Äã‚Äãeven on a weak computer.  The presence in the registry of the system at the same time LM- and NT-password hashes guarantee an attacker to break it in a reasonable time.  The LM hash value at default settings is stored in the Windows XP / 2003 OS registry, which makes these systems especially attractive for a hacker.  The NT hash function is computationally more complex, however, the enumeration of its values ‚Äã‚Äãis greatly simplified by the fact that for it there are available tables of pre-calculated values ‚Äã‚Äã(so-called Rainbow tables) - they reduce the calculation of the value of the hash function to the search for the desired hash among pre-calculated values. <br><br>  <b>The object of attack.</b>  Password hashes in the SAM database (registry).  In our case, these are all the machines to which we have physical access.  First of all, this is our working desktop, in the second - the hosts to perform the tests. <br><br>  <b>Implementation.</b>  With machines that are physically accessible, we perform the following operation: boot from external media (using Windows Pre-installation Environment CD or Linux Live CD), mount the NTFS system partition and copy the HKLM \ SYSTEM and HKLM \ SAM registry branches (% WINDIR files % \ System32 \ Config \ System and% WINDIR% \ System32 \ Config \ Sam respectively).  Particular attention is paid to machines running Windows XP \ Windows 2003, which is likely to find LM-hash.  To dump passwords from copied registry files, we use the tools [1], [2] (all links at the end of the article).  Result: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="image"><br><br>  The last line contains the required NT hash of the local administrator.  On the hosts from the test lab (let's call these hosts LAB1 and LAB2) we find a non-zero LM hash: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="image"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="image"><br><br>  So, we have received NT- and LM-hashes.  But how to recover from them the password?  To do this, use the same tools [1], [2] as well as on-line hash reverse services [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="image"><br><br>  Note: the real password consisted of the name of the company with a small modifier and quickly broke down under a dictionary attack). <br><br>  <b>Result.</b>  Success.  Passwords (let them be ‚ÄúPa $$ word1‚Äù and ‚ÄúPa $$ word2‚Äù) are obtained to the local administrator account from our desktop and two test computers.  But will they help get domain administrator rights?  About this further. <br><br><h4>  Step 2. Obtain domain administrator credentials </h4><br>  <b>Theory.</b>  In most cases, it is enough to get the NT hash value of the domain administrator password.  This is due to the fact that when checking a user using the NTLM protocol, the authenticated system presents only the NT-hash to the authenticator, and the password check does not occur.  NT hash can be obtained from the so-called.  storage LSA by referring to the so-called.  Logon-session administrator (Logon-session - a special data area created by the Winlogon process, which stores the user name, login domain and the value of the NT password hash, all together it is called LSA-secret).  This NT hash is used by the NTLMSSP process for NTLM authentication.  Logon-session is saved all the time while the account is logged into the system.  Also NT-hash can be intercepted from the administrator's NTLM authentication session.  In addition, an administrator password can be obtained from the Domain Cached Credentials (DCC) cache.  DCC is a local cache that is filled when a user successfully enters a domain.  The purpose of the DCC cache is to be able to authenticate the user when the domain controller is unavailable. <br><br>  <b>Objects of attack:</b> <br><br><ul><li>  DCC hashes (registry HKLM \ Security). </li><li>  Logon-session of the domain administrator (LSA-secret). </li><li>  Interception NTLM-session (not considered because of the greater practical complexity). </li></ul><br>  <b>Practice.</b>  Many Windows administrators use a domain administrator account to perform various kinds of operations on users' computers.  However, its data is in the DCC cache.  Therefore, we first try to get the password from the DCC cache.  We go to our workstation, save the registry branch HKLM \ Security and import it into [1].  Since  we have the local administrator password, you no longer need to boot the machine from external media to save the registry: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="image"><br><br>  In the cache are the password data of three accounts.  The last account (*** user) does not interest us, the second account does not have the required privileges, but the user shadmin looks like the desired administrator.  Unfortunately, the MS-CACHE2 algorithm has a large computational complexity and brute force attack on it is ineffective.  The MS-CACHEv2 function contains a ‚Äúcomputational secret‚Äù - salt (the account name is used as ‚Äúsalt‚Äù), which makes it protected from attacks against Rainbow tables.  However, in the future, tables of hash values ‚Äã‚Äãfor standard accounts - ‚ÄúAdministrator‚Äù, ‚ÄúAdministrator‚Äù, etc. may appear.  For the sake of interest, we send the found ‚Äúcache hash‚Äù to the cloud service [8] - [11] (on the results and effectiveness of such services at the end of the article).  While the ‚Äúcloud is thinking‚Äù we are trying to find other DCCs.  We analyze the list of hosts obtained in step 0, check for which servers we can log in as local administrator using the passwords obtained in step 1. Since the local administrator is blocked on the domain controller and the mail server is usually better protected, you need to experiment with secondary servers.  In our case, in the list of servers a server was found with the inconspicuous name Upd.  Logging in with the password ‚ÄúPa $$ word2‚Äù found in step 1 is successful.  We discover that on the host Upd: <br><br><ol><li>  Antivirus software is not installed. </li><li>  It runs Apache, which is the management server for the corporate antivirus (this means that there is also an account password used for remote installation of the antivirus software and theoretically it can be pulled out from there). </li><li>  The host is not auditing failed login attempts. </li><li>  OS version - Windows 2008 R2. </li></ol><br>  By dumping the HKLM \ Security registry, we get the DCC hash of the CORP.LOCAL \ Administrator account (and several others): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="image"><br><br>  Theoretically, you can try to find the password to the Administrator through the cloud service.  However, as I mentioned above, the brute force attack on MS-CACHEv2 is useless (although, perhaps, in a couple of years the situation will change).  Leave DCC alone and proceed to search for Logon sessions.  Checking which users are logged in on the Upd host: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="image"><br><br>  We see that on the Upd machine there are two inactive sessions - the administrator and the already familiar user Shadmin, which means that we can get the NT hashes of their passwords by stealing the LSA-secret.  This is the key point in determining the success of the entire attack.  To steal a hash, use the Lslsass [3] exploit.  To perform it, you need local administrator rights (or rather, debugging rights to processes), which we already have.  We get the list of LSA secrets (in the format "domain \ account: LM-hash: NT-hash :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  Bold lines contain the required password hashes.  Also note the italicized hash in the sixth line.  Somewhere we have already seen it, right? <br><br>  <b>Result.</b>  Success.  We have on hand NT-hash of the domain administrator account password.  But what is the use of a hash if it is impossible to recover the original password in a reasonable time?  About this in the next step. <br><br><h4>  Step 3. We are deceiving the NTLM authentication session. </h4><br>  <b>Theory.</b>  Windows never uses a pure password for authentication, an authenticated system always presents a hash.  Hence the idea: replacing the user name, the login domain and the NT hash in the Logon session of the logged-in user with the corresponding values ‚Äã‚Äãof the domain administrator, we can authenticate using the NTLM protocol before the remote system as the domain administrator.  This attack [7] is possible only with NTLM authentication.  Despite the widespread use of the Kerberos protocol, NTLM is the only possible way to authenticate a client, when accessing a network balloon, not by its symbolic name, but by its IP address [13]. <br><br>  <b>The object of attack.</b>  Logon session local administrator. <br><br>  <b>Practice.</b>  There are several exploits available that allow you to implement an attack on the Windows Server 2008 x86 and x64 platform.  The main exploit is the Windows Credentials Editor [4].  To launch an attack, we go to the host LAB2 using the ‚ÄúAdministrator‚Äù \ ‚ÄùPa $$ word2‚Äù credentials.  Using [4], we substitute the account name, login domain and NT hash data in the Logon session with the corresponding Shadmin values ‚Äã‚Äãwe obtained in the previous step: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="image"><br><br>  The name of the domain administrator account and its NT hash is passed to the wce command as an argument from the command line.  Result - the hash was successfully changed.  I note that the user's membership in the group and the access token do not change during an attack: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="image"><br><br>  We are still the local Administrator, the green host name in the screenshot above is LAB2.  However, with NTLM authentication, the remote system will be shown the domain name CORP. LOCAL, the username Shadmin and the hash of the password Shadmin.  Here is a dump of one network packet containing an NTLM security blob session: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="image"><br><br>  Smeared with a green domain name (CORP. LOCAL) and host name (LAB2)), the account Shadmin is presented.  Now we are trying to connect to the root partition of the system volume on the domain controller using the net use command using the IP address of the domain controller: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="image"><br><br>  Successfully.  To check access, I created a text file in the root (find it in the screenshot).  Having created a batch file on the disk of the domain controller with the sequence of commands we need, we can, using [5], perform the necessary operation on the domain controller (for example, add a user to the domain administrators group).  The operation will be performed with the rights of the Shadmin account.  To illustrate, we create a simple command file on a remote host that adds a local user: <br><br>  <i>net user TstUsr Pa $$ word / add</i> <br><br>  Remotely run it from host LAB2: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="image"><br><br>  It will be executed on the remote system 192.168.13.125 with the privileges of the user of our current session - shadmin (i.e., the domain administrator).  Checking: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="image"><br><br>  The second output of the net user command shows the new user.  Despite the impossibility of launching applications that require interactive user interaction (for example, MMC snap-ins) in this way, you can perform a wide range of actions using scripts. <br><br>  <b>Result.</b>  Success.  Got access to the file system and the domain controller shell. <br><br><h4>  Summary </h4><br>  In short, the attack chain looked like this: Gathering information about the network structure -&gt; Getting the local administrator password -&gt; Using this password to log in to one of the secondary servers -&gt; Theft of unattended domain administrator credentials -&gt; Modifying your Logon session and elevation of privileges to the desired level. <br><br>  The success of the attack contributed to: <br><br><ol><li>  Weak DNS zone protection from transfer to untrusted hosts. </li><li>  Weak password policy.  On most domain computers, the local administrator account used the same password, vulnerable to a dictionary attack. </li><li>  Absence or weak configuration of antivirus software on critical hosts. </li><li>  Weak password hash protection - two inactive administrator Logon sessions on the Upd host, presence of LM hashes in the SAM database. </li><li>  Poor audit policy. </li></ol><br><br>  Based on this, general protection recommendations can be derived: <br><br>  0. Carefully hide the internal structure of the network from possible intruders.  So, users should not be able to get the full contents of the DNS zone file.  Untrusted users (this may be, for example, interns, employees who have not had a trial period, etc.) it makes sense to transfer them to a separate subnet, using NAT to spoof addresses (including, for example, modifying DNS responses). <br><br>  1. Proper local administrator password assignment policy.  The local administrator password must be different on hosts that have different degrees of security from unauthorized access.  Compromising the local administrator password on any of the domain hosts should minimize the possibility of an attacker using this password. <br><br>  2. Storage of LM hash in SAM should be prohibited by security policies. <br><br>  3. It is not necessary to use the name of the company or its domain as part of the administrator's password. This will make it more difficult for an attacker to attack a dictionary.  But even using a complex password, do not forget to regularly and regularly test its hash for resilience using online services. <br><br>  4. It is not recommended to perform routine operations on domain computers under a domain administrator account.  This will protect the account from intercepting Logon-session data and from hitting the password hash in the DCC-cache. <br><br>  5. Make it a rule not to leave unattended a domain administrator's Logon session.  Best practice: finished work - log out. <br><br>  6. LSA spoofing utilities are quite small.  It makes sense to track their evolution and to check their successful detection by corporate antivirus software. <br><br>  7. A user, even having local administrator rights, should not be able to change the settings of the corporate antivirus.  Shutting down the antivirus service on domain workstations should trigger a domain administrator (in this sense, Symantec Endpoint Protection performed quite well during the test). <br><br><h4>  Appendix 1. Behavior of antivirus software </h4><br>  Three types of antivirus software were used on the company's computers: KAV, which was current at the time of the Symantec Endpoint Protection test, and an outdated product from Trend Micro.  In most cases, the tools used during the attack were defined as Hack Tool / Rootkit / Trojan.  KAV without warning deleted them, and SEP (even turned off) issued a warning and moved to quarantine without giving the opportunity to start.  However, the presence of local administrator rights allows you to disable KAV, and the protection of SEP was circumvented by manually setting the exception path to check, again using the local administrator account.  The Trend Micro antivirus installed on some hosts did not launch exploits in any way. <br><br><h4>  Addition 2. Efficiency of using online hash check services </h4><br>  To check the strength of password hashes, there are many online services.  They allow you to work with the most common hashes - LM, NTLM, MD4, MD5, WPA, with hashes that use salt, etc.  To check the hash, brute force is used using the computational power of modern GPUs, dictionary searching, hybrid attacks, etc.  Once opened, the hash can fill up the base and be used in the future.  The service can be free to check a short (less than 8 characters) password or take a small reward.  During the test, I used four such services, links are provided at the end of the article.  I sent several hashes found in step 2 and after 15 months I received a notification from the On-line Hash Crack service [9] about successful recovery of one of them) <br><br><h4>  Links </h4><br>  <b>Tools used</b> <br><br>  [1] <a href="http://www.oxid.it/">Cain &amp; Abel</a> - a password recovery tool for Microsoft Operating Systems.  It can be encrypted, it can be encrypted, it will be possible to record it, it will help you to learn how to use it. protocols. <br>  [2] L0pht Crack. <br>  [3] Lslsass exploit.  Dumps active logon session password hashes from the lsass process. <br>  [4] <a href="https://www.ampliasecurity.com/services.html">Windows Credentials Editor</a> post-exploit.  Tool to change logon-credentials. <br>  [5] PsExec from PS Tools <br><br>  <b>Detailed descriptions of vulnerabilities</b> <br><br>  [6] Series of articles "Effectively obtaining password hashes in Windows" on the site <a href="http://www.securitylab.ru/">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, <a href="https://www.coresecurity.com/corelabs-research/publications/pass-hash-toolkit-windows">describing an attack</a> on a remote system by providing it with a compromised hash. <br><br>  <b>Cloud services hacking hashes</b> <br>  [8] Question-defense.com (seems to be no longer operational at the time of publication () <br>  [9] <a href="http://www.onlinehashcrack.com/">www.onlinehashcrack.com</a> <br>  [10] <a href="http://www.cloudcracker.com/">www.cloudcracker.com</a> <br>  [11] <a href="https://www.hashkiller.co.uk/ntlm-decrypter.aspx">On-line hash killer</a> <br><br>  <b>Additional materials</b> <br><br>  [12] <a href="https://www.atraining.ru/dns-security-windows-server-2012-r2/">Security and DNS Tuning in Windows Server</a> <br>  [13] <a href="https://support.microsoft.com/en-us/help/322979/kerberos-is-not-used-when-you-connect-to-smb-shares-by-using-ip-addres">Kerberos is not used when you connect by using IP address</a> </div><p>Source: <a href="https://habr.com/ru/post/423937/">https://habr.com/ru/post/423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423925/index.html">Open webinar ‚ÄúStrange recursive template‚Äù</a></li>
<li><a href="../423927/index.html">10 promising search engines to improve SEO</a></li>
<li><a href="../423931/index.html">How to bypass SMS-identification when connecting to public Wi-Fi networks?</a></li>
<li><a href="../423933/index.html">Microsoft Office Security: Embedded Objects</a></li>
<li><a href="../423935/index.html">Answers from the Embox stand to popular questions from the IT-festival TechTrain</a></li>
<li><a href="../423939/index.html">Dynamic programming or "Divide and Conquer"</a></li>
<li><a href="../423941/index.html">Reports from iOS mitap Redmadrobot</a></li>
<li><a href="../423943/index.html">Optimization of prices in offline retail</a></li>
<li><a href="../423945/index.html">The Supreme Court clarified the procedure for dealing with reposts and likes</a></li>
<li><a href="../423947/index.html">Our personal data is worth nothing.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>