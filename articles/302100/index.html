<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Apple pain and certificates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meet Bob, a seasoned ios developer, Alice is a no less tester. It was in the evening it was on Friday. Bob prefixed the bug, it seems to be tested on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Apple pain and certificates</h1><div class="post__text post__text-html js-mediator-article">  Meet Bob, a seasoned ios developer, Alice is a no less tester.  It was in the evening it was on Friday.  Bob prefixed the bug, it seems to be tested on his devices.  Then Bob starts the commands already honed to automatism: <br><br><pre><code class="bash hljs">git checkout develop git merge bug_fix_<span class="hljs-comment"><span class="hljs-comment">#999 git checkout master &amp;&amp; git merge develop --no-ff .... git push ....</span></span></code> </pre> <br><br>  On the push on the server, jenkins / teamcity / travis is triggered, which starts the build.  At the same time, our Bob writes to Alice that he will soon go home, and wants the app to leave today in the app store for April in order to win an extra couple of days, since it‚Äôs the weekend, if the application passes Alisa‚Äôs manual testing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Bob‚Äôs application is pretty ordinary: a couple of hundred compiled class files, another ten or so cocoapods of dependencies and a handful of storyboards ‚Äî Bob appreciates his time and the time of his colleagues, so he doesn‚Äôt write UI in code.  Bob knows that his application from a clean start on the server is collected in 4 minutes to develop a version that goes to test Alice, and as much or slightly more for the production version.  Bob also knows that he needs about 10 minutes to wait until the end of the complete assembly and then inform Alice that she can start testing.  Bob is a responsible person, so after 10 minutes after pushing, he checks the build status, because he knows that the server is a separate parallel world with its own rules, laws, and oddities. <br><br>  Friday evening, Bob is only 10 minutes away from the long-awaited weekend, after which he passes the baton to Alice.  Bob drives a <a href="https://bobcompany.ci/dashboard/">bobcompany.ci/dashboard</a> into a safari, where he sees a red light bulb in front of his application, Bob‚Äôs eyes faded, there was no limit to disappointment.  Bob presses on <i>show more</i> , where he gets an error: <br><br><pre> <code class="bash hljs">Code Sign error: No codesigning identities found: No codesigning identities (ie certificate and private key pairs) that match the provisioning profile specified <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> your build settings (‚Äúcom.company.bob‚Äù) were found.</code> </pre><br><br>  Here Bob's nerves completely pass: <br><br><img src="https://habrastorage.org/files/9e5/1e3/107/9e51e31077294c2bb0de3052b6a269ea.gif"><br><br><a name="habracut"></a><br><br>  <i>* Briefly about the error, it manifests itself when we try to sign an application with a non-existent certificate, a non-existent means either it is not installed on the machine, or it is outdated and the mobileprovision is installed on a more recent version of the certificate of the same account for the same bundle.</i> <br><br>  And the most annoying is that this error is only for the <i>production</i> version of the build, which runs the second after the develop version, and, first, xcode compiles dependencies (cocoapods) and only after that checks the signature validity, that is, only when the main application builds.  Therefore, the error appears in about the second half of the build process, which is why the first 6-7 minutes are spent empty, which makes Bob even more upset. <br><br>  Our developer Bob is not the first time faced with this problem, because he works in a large company, where several teams of ios developers, where the normal practice for the development is to use one Apple account for several people.  Yes, Bob knows about the Xcode plugin <a href="https://github.com/neonichu/FixCode">https://github.com/neonichu/FixCode</a> , but you don‚Äôt have to force him to install it forcibly, the developers are gentle creatures, not everyone likes being forced to do something against their will, Bob himself such. <br><br>  Bob got so sick of it all that he had already forgotten that he was going home 10 minutes ago, instead Bob orders pizza, uncovers a macbook that he has already packed, pours coffee, asks admins to give access to the server, connects there via ssh and starts to figure out what exactly is the problem and how can it be solved. <br><br>  OK.  First of all, Bob checks which certificates are in general on the machine: <br><br><pre> <code class="bash hljs">security find-identity -v login.keychain</code> </pre><br><br>  What gives <br><br><pre> <code class="bash hljs"> 1) 40948A3CA3527F580B9ECB2131DE6B1938FB3D7C <span class="hljs-string"><span class="hljs-string">"iPhone Developer: Mike ... (KSDA3C3QF2)"</span></span> 2) 0279CB81AEAD8CE015282DD1FA76CE520A815C4D <span class="hljs-string"><span class="hljs-string">"iPhone Developer: Bob .. (4WT74HLM2M)"</span></span> 3) 79A2544B1A63C3F9D3DA3FFAB199FEAADB7EC306 <span class="hljs-string"><span class="hljs-string">"iPhone Developer: Alica ... (VJ53F2J4EK)"</span></span> .... 24 valid identities found</code> </pre><br><br>  So, at least in keychain, which is used according to the default on the server, there are 24 certificates.  Bob knows that each mobileprovision file is created for any one particular certificate.  You need to find out on which certificate mobileprovision created the file for which the build fell and understand what happened to the certificate.  It is generally necessary to understand how the mobileprovision file is associated with the certificate.  Bob knows that the develop version of the application is assembled, so the server definitely has this certificate and now you need to understand how it relates to the mobileprovision file.  To do this, Bob needs to find the mobileprovision file and certificate information in order to start looking for some matches between them. <br><br>  We are looking for a mobileprovision file by its bundle (if your bundle is a wildcard, then you can search for any other signs): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Library/MobileDevice/Provisioning Profiles find . -name <span class="hljs-string"><span class="hljs-string">"*.mobileprovision"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> grep -H -n -a {} -e <span class="hljs-string"><span class="hljs-string">"com\.company\.bob"</span></span> \;</code> </pre><br><br>  Great, we found our file: <br><br><pre> <code class="bash hljs">./f98a06f3-21c2-4de0-975f-5df74197c731.mobileprovision:30: &lt;string&gt;4HUHB9J47M.com.company.bob&lt;/string&gt;</code> </pre><br><br>  The file has the prefix 4HUHB9J47M for the bundle.  From the previously obtained list of certificates, nothing matches this value.  Therefore, Bob has to go to developer.apple.com and look for what account created this mobileprovision file.  At random he finds out that this is Mike's certificate: <br><br><pre> <code class="bash hljs">2) 40948A3CA3527F580B9ECB2131DE6B1938FB3D7C <span class="hljs-string"><span class="hljs-string">"iPhone Developer: Mike .. (KSDA3C3QF2)"</span></span></code> </pre><br><br>  Great, now we have something to work with.  Bob is not a cryptanalyst or a security surveyor, but he is a good googler, so he easily found a way to get the necessary information from the certificate. <br><br>  Pull the data into the .pem file: <br><br><pre> <code class="bash hljs">security find-certificate -p -c <span class="hljs-string"><span class="hljs-string">"iPhone Developer: Mike .. (KSDA3C3QF2)"</span></span> &gt; cert.pem</code> </pre><br><br>  In the file we get the following: <br><br><pre> <code class="bash hljs">-----BEGIN CERTIFICATE----- MIIFnjCCBIagAwIBAgIIN8GwnYhLQ/kwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js ZHdpZGUgRGV2ZWxvcGVyIFJlbGF0aW9uczFEMEIGA1UEAww7QXBwbGUgV29ybGR3 aWRlIERldmVsb3BlciBSZWxhdGlvbnMgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkw ... .... ..... lD+ocFo6+mab/Ph6mTJOZkZu+hnqhzbTD9Q9dXKWkeXAwTqaESNfnhnuOdfCX3vu YAz0Hb46G9fkLa5lHjVydbtms685C+uz9Ss4GNRfji1cz5KyblAQAAsqQBUiCwnb z34= -----END CERTIFICATE-----</code> </pre><br><br>  As it turned out, from this file you can read the certificate information, try to get the most interesting for us: <br><br><pre> <code class="bash hljs">openssl x509 -noout -fingerprint -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cert.pem</code> </pre><br><br>  Gives us: <br><br><pre> <code class="bash hljs">SHA1 Fingerprint=40:94:8A:3C:A3:52:7F:58:0B:9E:CB:21:31:DE:6B:19:38:FB:3D:7C</code> </pre><br><br>  If we remove the colon, we get 40948A3CA3527F580B9ECB2131DE6B1938FB3D7C, this is just Mike's sha1 certificate, which we can see in the UI in Keychain: <br><br><img src="https://habrastorage.org/files/191/b19/b14/191b19b140d2430199ad5b2453f6ac7e.png"><br><br>  We can also get the certificate validity period if we need to write a validator of expired certificates: <br><br><pre> <code class="bash hljs">openssl x509 -noout -startdate -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cert.pem // Feb 27 07:13:41 2016 GMT openssl x509 -noout -enddate -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cert.pem // Feb 26 07:13:41 2017 GMT</code> </pre><br><br>  We see the same in keychain: <br><br><img src="https://habrastorage.org/files/694/66f/cce/69466fcceb254db89482811ab6c9ad5a.png"><br><br>  In general, the certificate is clear.  ‚ÄúHow can it be tied to our mobileprovision file?‚Äù The curious Bob thinks.  Let's first take a closer look at the mobileprovision file: <br><br><img src="https://habrastorage.org/files/f1b/832/aee/f1b832aee72f4a4a8b44ab460c4b76f1.jpg"><br><br><pre> <code class="bash hljs">security cms -D -i f98a06f3-21c2-4de0-975f-5df74197c731.mobileprovision</code> </pre><br><br>  The output gives us interesting information for the <i>data</i> field, namely: <br><br><pre> <code class="bash hljs">&lt;data&gt; MIIFnjCCBIagAwIBAgIIN8GwnYhLQ/kwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js ZHdpZGUgRGV2ZWxvcGVyIFJlbGF0aW9uczFEMEIGA1 ... ... YAz0Hb46G9fkLa5lHjVydbtms685C+uz9Ss4GNRfji1cz5KyblAQAAsqQBUiCwnb z34= &lt;/data&gt;</code> </pre><br><br>  Somewhere this Bob has already seen, similar to the content of the previously received .pem file: <br><br><pre> <code class="bash hljs">-----BEGIN CERTIFICATE----- MIIFnjCCBIagAwIBAgIIN8GwnYhLQ/kwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js ZHdpZGUgRGV2ZWxvcGVyIFJlbGF0aW9uczFEMEIGA1UEAww7QXBwbGUgV29ybGR3 aWRlIERldmVsb3BlciBSZWxhdGlvbnMgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkw ... .... ..... lD+ocFo6+mab/Ph6mTJOZkZu+hnqhzbTD9Q9dXKWkeXAwTqaESNfnhnuOdfCX3vu YAz0Hb46G9fkLa5lHjVydbtms685C+uz9Ss4GNRfji1cz5KyblAQAAsqQBUiCwnb z34= -----END CERTIFICATE-----</code> </pre><br><br><img src="https://habrastorage.org/files/019/b5b/90d/019b5b90d0d54b61ac680581887470cf.gif"><br><br>  Then Bob understood, here it is the mobileprovision file hook on the certificate. <br><br>  So, we need to take our mobileprovision file, pull out the value for the <i>data</i> field, then run through all valid certificates and compare with the data from their .pem submission.  Bob immediately added a small script that he passed to his colleagues from the backend so that they would run it before each build of ios projects.  The script runs quite simply: <br><br><pre> <code class="bash hljs">ruby cert_checker.rb f98a06f3-21c2-4de0-975f-5df74197c731.mobileprovision</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">ruby script</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'active_support/core_ext/hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ARGV.empty? xmlString = <span class="hljs-string"><span class="hljs-string">`security cms -D -i </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{ARGV.first}</span></span></span><span class="hljs-string">`</span></span> data = Hash.from_xml(xmlString) <span class="hljs-comment"><span class="hljs-comment">#   data  mobileprovision provision_cert_data = data['plist']['dict']['array'].map { |e| e['data'] }.compact.first #          .pem  certs = `security find-identity -v login.keychain | grep -o "\\".*\\""`.split("\n").map { |e| e[1..-2] } pems = certs.map { |e| `security find-certificate -p -c "#{e}"`.split("\n")[1..-2].join('') } dict = Hash[pems.zip(certs)] #  mobileprovision data  .pem  ,  ,     mobileprovision, #   ,       if dict.keys.keep_if { |e| e == provision_cert_data }.empty? puts "Have no certificate for file #{ARGV.first}" else puts "Your mobileprovision issued for #{dict[provision_cert_data]}" end</span></span></code> </pre><br></div></div><br><br>  Now developers can quickly get feedback from the server if there is something wrong with the certificates.  And in general, do not run the assembly until the problem is solved. </div><p>Source: <a href="https://habr.com/ru/post/302100/">https://habr.com/ru/post/302100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302088/index.html">Should startups focus on profits?</a></li>
<li><a href="../302090/index.html">Planned changes: what were the career realities of IT in a week?</a></li>
<li><a href="../302092/index.html">HTTP / 2.0 - IETF trash: bad protocol, bad policy</a></li>
<li><a href="../302094/index.html">Digest KolibriOS # 12</a></li>
<li><a href="../302096/index.html">Gchat was the messenger of the future, but Google didn't get it.</a></li>
<li><a href="../302104/index.html">PHP Digest number 86 - interesting news, materials and tools (May 15 - 29, 2016)</a></li>
<li><a href="../302106/index.html">ConstraintLayout 101 and the new layout editor in Android Studio</a></li>
<li><a href="../302110/index.html">The digest of fresh materials from the world of the frontend for the last week No. 213 (May 23 - 29, 2016)</a></li>
<li><a href="../302112/index.html">That kills developer productivity</a></li>
<li><a href="../302116/index.html">Plone Licensing FAQ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>