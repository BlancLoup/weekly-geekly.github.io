<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learn OpenGL. Lesson 4.1 - Depth Test</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depth buffer 
 In the lesson on coordinate systems , we rendered a three-dimensional container using the depth buffer, which prevented the erroneous d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learn OpenGL. Lesson 4.1 - Depth Test</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/c9e/9b2/a3b/c9e9b2a3baf749ab8e2b385c6d93d966.png" alt="Ogl3" align="left" width="300"><br><h1>  Depth buffer </h1><br>  In the lesson on <a href="https://habrahabr.ru/post/324968/">coordinate systems</a> , we rendered a three-dimensional container using the depth buffer, which prevented the erroneous derivation of faces behind the others.  In this lesson, we take a closer look at the depth buffer (or z-buffer) and the values ‚Äã‚Äãstored in it, as well as find out exactly how the test passes if the fragment is behind the others. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text">  Part 1. Start <br><br><ol><li>  <a href="https://habrahabr.ru/post/310790/">Opengl</a> </li><li>  <a href="https://habrahabr.ru/post/311198/">Creating a window</a> </li><li>  <a href="https://habrahabr.ru/post/311234/">Hello window</a> </li><li>  <a href="https://habrahabr.ru/post/311808/">Hello triangle</a> </li><li>  <a href="https://habrahabr.ru/post/313380/">Shaders</a> </li><li>  <a href="https://habrahabr.ru/post/315294/">Textures</a> </li><li>  <a href="https://habrahabr.ru/post/319144/">Transformations</a> </li><li>  <a href="https://habrahabr.ru/post/324968/">Coordinate systems</a> </li><li>  <a href="https://habrahabr.ru/post/327604/">Camera</a> </li></ol><br>  Part 2. Basic lighting <br><br><ol><li>  <a href="https://habrahabr.ru/post/329592/">Colors</a> </li><li>  <a href="https://habrahabr.ru/post/333932/">Lighting Basics</a> </li><li>  <a href="https://habrahabr.ru/post/336166/">Materials</a> </li><li>  <a href="https://habrahabr.ru/post/337550/">Texture Cards</a> </li><li>  <a href="https://habrahabr.ru/post/337642/">Sources of light</a> </li><li>  <a href="https://habrahabr.ru/post/338254/">Multiple light sources</a> </li></ol><br>  Part 3. Loading 3D Models 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  <a href="https://habrahabr.ru/post/338436/">Assimp library</a> </li><li>  <a href="https://habrahabr.ru/post/338436/">Mesh mesh class</a> </li><li>  <a href="https://habrahabr.ru/post/338998/">Model class</a> </li></ol><br>  Part 4. OpenGL advanced features <br><br><ol><li>  <a href="https://habrahabr.ru/post/342610/">Depth test</a> </li><li>  <a href="https://habrahabr.ru/post/344238/">Stencil test</a> </li><li>  <a href="https://habrahabr.ru/post/343096/">Mixing colors</a> </li><li>  <a href="https://habrahabr.ru/post/346964/">Face clipping</a> </li><li>  <a href="https://habrahabr.ru/post/347354/">Cadre buffer</a> </li></ol></div></div><br>  The depth buffer as well as the color buffer (which stores the colors of all the fragments ‚Äî the visible image) stores certain information for each fragment and usually has the same dimensions as the color buffer.  The depth buffer is created automatically by the OS window system and stores the values ‚Äã‚Äãas 16, 24, or 32 bit floating point numbers.  In most systems, a default buffer is created with an accuracy of 24 bits. <br><br>  When the depth test is enabled, OpenGL checks the depth of each fragment being processed against the data stored in the buffer.  When passing the test, the buffer contents will be updated with the value of the depth of the fragment being processed, if the test fails, the stored value will remain the same and the fragment will be discarded. <br><br>  The depth test is performed in screen space after the fragment shader is executed (and after the stencil test, which will be discussed in the next lesson).  The screen coordinates are directly related to the viewport parameters specified by the <i>glViewport</i> function, and are available via the built-in GLSL variable <i>gl_FragCoord</i> in the fragment shader code.  The x and y components of this variable are the coordinates of the fragment in the viewport (the lower left corner of the window has coordinates (0, 0)).  <i>Gl_FragCoord</i> also has a third component, which actually contains the fragment depth value.  This z-component is used to compare values ‚Äã‚Äãfrom the depth buffer. <br><blockquote>  Modern GPUs almost all use a trick called the early depth test.  This technique allows you to perform a depth test before performing a fragment shader.  If it becomes known to us that this fragment cannot be seen in any way (blocked by other objects), then we can discard it before the shading stage. <br>  Fragment shaders are quite computationally heavy, so you should avoid executing them where it is meaningless.  This technique has only one limitation: the fragment shader should not change the value of the fragment depth.  This is obvious, because OpenGL in this case will not be able to determine in advance the value of the depth of the fragment being processed. </blockquote><br>  By default, the depth test is disabled.  Turn it on: <br><br><pre><code class="cpp hljs">glEnable(GL_DEPTH_TEST);</code> </pre> <br>  Now, with the depth test turned on, OpenGL will automatically save the depth values ‚Äã‚Äãfor all the passed test fragments and discard those not passed. <br><br>  Turning on the depth test also requires clearing the buffer from the old values ‚Äã‚Äãin each frame.  A new <i>GL_DEPTH_BUFFER_BIT</i> flag is added to the familiar <i>glClear</i> function <i>.</i> <br><br><pre> <code class="cpp hljs">glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</code> </pre> <br>  In certain situations, you may need to perform a depth test for the processed fragments with their dropping according to the test results, but without updating the contents of the buffer itself.  Those.  assigning a read-only mode to the buffer.  Writing to the buffer is disabled by setting the depth mask to <i>GL_FALSE</i> : <br><br><pre> <code class="cpp hljs">glDepthMask(GL_FALSE);</code> </pre> <br>  I note that this only makes sense when the depth test is on. <br><br><h3>  Depth test function </h3><br>  OpenGL allows you to override the comparison operator used in the depth test, which gives us a subtle control over which fragments should be processed, which ones to drop and in which cases the depth buffer will be updated.  The operator is set by calling the function <i>glDepthFunc</i> : <br><br><pre> <code class="cpp hljs">glDepthFunc(GL_LESS);</code> </pre> <br>  The function accepts the ID of the comparison operator from this list: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9g/ak/ry/9gakrythf061yy5r-jd-bp7txxq.png"></div><br>  The default is <i>GL_LESS</i> , which means dropping all fragments that have a depth greater than or equal to the depth value stored in the buffer. <br><br>  Let's experiment with how different comparison operators affect the output of our application.  We use a new project that sets the stage with two textured cubes standing on the floor and not using lighting.  The source code is <a href="https://learnopengl.com/code_viewer_gh.php%3Fcode%3Dsrc/4.advanced_opengl/1.1.depth_testing/depth_testing.cpp">here</a> .  First, <i>let's</i> change the operator to <i>GL_ALWAYS</i> : <br><br><pre> <code class="cpp hljs">glEnable(GL_DEPTH_TEST); glDepthFunc(GL_ALWAYS);</code> </pre> <br>  This setting is equivalent to turning off the depth test, which ultimately simply displays fragments that were later processed on top of those that were processed earlier, even if they should have been in the foreground.  And since we draw the floor last, its fragments and overlapped all previously derived cube fragments: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/82/w3/lj/82w3lj13bltvus4wuaqdfc4oir0.png"></div><br>  Returning the <i>GL_LESS</i> statement <i>back,</i> we get the correct scene: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ig/4i/mn/ig4imnvb_euajpihhsb4jvuc01s.png"></div><br><h3>  The issue of depth accuracy </h3><br>  The values ‚Äã‚Äãin the depth buffer are limited by the interval [0.0, 1.0] and the z-components of all objects of the scene are checked against them from the observer's point of view.  In this case, the z-component of the object in the species space can take any value in the interval [zNear, zFar], which determines the near and far boundary of the projection pyramid ( <i>projection frustum</i> ).  To eliminate this inconsistency, we need a way to convert the values ‚Äã‚Äãof z-components in the species space to the interval [0.0, 1.0].  The first, naive method is a simple linear transformation: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>F</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi></mrow></msub></mrow><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>z</mi><mo>&amp;#x2212;</mo><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>z</mi><mi>F</mi><mi>a</mi><mi>r</mi><mo>&amp;#x2212;</mo><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="38.867ex" height="2.66ex" viewBox="0 -780.1 16734.3 1145.2" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-46" x="0" y="0"></use><g transform="translate(643,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="523" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-70" x="990" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-74" x="1493" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-68" x="1855" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-3D" x="2740" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-66" x="4046" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="4597" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="5048" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-63" x="5578" y="0"></use><g transform="translate(6011,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2212" x="690" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="1691" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-4E" x="2159" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="3048" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="3514" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="4044" y="0"></use></g><g transform="translate(10507,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-46" x="468" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="1218" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="1747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2212" x="2421" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="3421" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-4E" x="3890" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="4778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="5245" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="5774" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow class="MJX-TeXAtom-ORD"><msub><mrow class="MJX-TeXAtom-ORD"><mi>F</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi></mrow></msub></mrow><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>z</mi><mo>‚àí</mo><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>z</mi><mi>F</mi><mi>a</mi><mi>r</mi><mo>‚àí</mo><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> {{F} _ {depth}} = \ frac {z-zNear} {zFar-zNear} </script></p>  where zNear and zFar are the values ‚Äã‚Äãof the near and far parameters that we used when constructing the projection matrix defining the visibility pyramid (see <a href="https://habrahabr.ru/post/324968/">coordinate systems</a> ).  This relationship takes as a parameter the value of z lying inside the visibility pyramid and converts it to the interval [0.0, 1.0].  The relationship between the z value and the resulting depth value can be seen in the graph: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gv/xn/pg/gvxnpgq6tixaxnuubskyk0kkywm.png"></div><br><blockquote>  Note that all the dependencies considered give a value that tends to 0.0 for close objects and tends to 1.0 for objects lying near the far clipping plane. </blockquote><br>  However, in practice, the linear depth buffer is practically not used.  To achieve a high-quality projection result, a relationship proportional to 1 / z is used.  The result of using such a relationship is a high accuracy of depth values ‚Äã‚Äãfor small z and a much lower accuracy for large z.  Consider the meaning of this behavior: is the accuracy of the depth values ‚Äã‚Äãfor objects removed by thousands of conventional units from the observer as with the detailed objects right in front of the observer important to us?  The use of linear transformation does not take into account this question. <br><br>  Since the nonlinear transformation is proportional to the 1 / z value, then for z values ‚Äã‚Äãin the interval [1.0, 2.0] we get depth values ‚Äã‚Äãin the interval [1.0, 0.5], which already covers half of the float accuracy, providing tremendous accuracy for small z.  Values ‚Äã‚Äãof z from the interval [50.0, 100.0] will be provided for only 2% of the available float accuracy - but this is exactly what we need.  So, the new dependence, including taking into account both the parameters zNear and zFar of the projection matrix: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>F</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi></mrow></msub></mrow><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>z</mi><mo>&amp;#x2212;</mo><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>z</mi><mi>F</mi><mi>a</mi><mi>r</mi><mo>&amp;#x2212;</mo><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mspace width=&quot;thinmathspace&quot; /><mo stretchy=&quot;false&quot;>(</mo><mn>2</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="54.235ex" height="2.78ex" viewBox="0 -832 23351.1 1197.1" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-46" x="0" y="0"></use><g transform="translate(643,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="523" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-70" x="990" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-74" x="1493" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-68" x="1855" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-3D" x="2740" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-66" x="4046" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="4597" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="5048" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-63" x="5578" y="0"></use><g transform="translate(6011,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2F" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2212" x="1691" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-31" x="2692" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2F" x="3192" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="3693" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-4E" x="4161" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="5050" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="5516" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="6046" y="0"></use></g><g transform="translate(12509,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2F" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-46" x="1469" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="2219" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="2748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2212" x="3422" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-31" x="4422" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-2F" x="4923" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-7A" x="5423" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-4E" x="5892" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-65" x="6780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-61" x="7247" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMATHI-72" x="7776" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-28" x="22071" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-32" x="22461" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342610/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgw39jpH41mPgbAZGXSR1yhhiB-JQ#MJMAIN-29" x="22961" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow class="MJX-TeXAtom-ORD"><msub><mrow class="MJX-TeXAtom-ORD"><mi>F</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi></mrow></msub></mrow><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>z</mi><mo>‚àí</mo><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>z</mi><mi>F</mi><mi>a</mi><mi>r</mi><mo>‚àí</mo><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>z</mi><mi>N</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mspace width="thinmathspace"></mspace><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> {{F} _ {depth}} = \ frac {1 / z-1 / zNear} {1 / zFar-1 / zNear} \, \, \, \, \, \, \, \, (2) </script></p>  Do not worry if it is not clear to you what exactly this expression implies.  The main thing is to remember that the values ‚Äã‚Äãstored in the depth buffer are non-linear in the screen space (in the species space, before applying the projection matrix, they are linear).  A value of 0.5 in the buffer does not mean that the object is located in the middle of the visibility pyramid.  In fact, the point to which this depth corresponds is rather close to the near cut-off plane.  The graph below shows the considered dependence of the non-linear depth value on the initial value of the z-component: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/o4/gk/cg/o4gkcgnfb9oluig_v4ivu9g_694.png"></div><br>  As you can see, the depth values ‚Äã‚Äãvary greatly for small input z, giving us increased accuracy in the region near the near cut-off plane.  The expression itself of transforming the values ‚Äã‚Äãof z (from the observer's point of view) is embedded in the structure of the projection matrix.  Thus, when we translate the coordinates of the vertices from the species space into the clipping space (clips space) and further into the screen space, we apply a non-linear transformation of the values ‚Äã‚Äãof z.  If you want to understand the details of the mechanics of the projection matrix, I recommend this <a href="http://www.songho.ca/opengl/gl_projectionmatrix.html">wonderful article</a> . <br><br>  The effect of nonlinearity is easy to notice when trying to visualize the depth buffer. <br><br>  A visual representation of the depth buffer values. <br><br>  So, in the vertex shader we have access to the value of the fragment depth through the z-component of the built-in variable <i>gl_FragCoord</i> .  If we output this value as a color value, then we will be able to visualize the contents of the current depth buffer: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ FragColor = vec4(vec3(gl_FragCoord.z), <span class="hljs-number"><span class="hljs-number">1.0</span></span>); }</code> </pre> <br>  If you try to start the application, then, most likely, everything will be filled with white color, giving the impression that all objects have a depth of 1.0 - the maximum possible value.  Why do we not see the darker areas, where the depth approaches zero? <br><br>  From the previous section, we remember that in the screen space, the depth buffer values ‚Äã‚Äãare non-linear, i.e.  for small z, the accuracy is high, and for large z it is small.  The depth value very quickly increases with the distance in the scene, because almost all the vertices quickly reach depths close to 1.0.  If we carefully move closer to one of the objects, we will eventually be able to distinguish the darkening of their near parts with a decrease in the value of z: <br><br>  This clearly shows the non-linear nature of the depth values.  For nearby objects, the depth value changes much faster than with distant ones.  The slightest movement of the camera changes colors from almost black to pure white. <br><br>  We, however, have the ability to convert nonlinear fragment depth values ‚Äã‚Äãback to linearly distributed ones.  To do this, we need to literally reverse the projection process, but only for depth values.  The first step is to convert the depth values ‚Äã‚Äãback from the interval [0.0, 1.0] to the interval [-1.0, 1.0] corresponding to the normalized device coordinates ( <i>NDC, normalized device coordinates</i> ) of the clipping space.  Then we derive the expression inverse to the nonlinear expression <b>(2)</b> and apply it to the obtained depth value.  The result will be a linear depth value.  It sounds quite usable, how do you think? <br><br>  So, first, let's translate the depth value into NDC: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> z = depth * <span class="hljs-number"><span class="hljs-number">2.0</span></span> - <span class="hljs-number"><span class="hljs-number">1.0</span></span>;</code> </pre> <br>  Further, we transform the obtained value of z into a linear one using the inverse <b>(2)</b> dependence: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> linearDepth = (<span class="hljs-number"><span class="hljs-number">2.0</span></span> * zNear * zFar) / (zFar + zNear - z * (zFar - zNear));</code> </pre><br>  Recall that this expression was obtained for projection matrices using expression (2) for nonlinear transformation of depth values, also limiting them to the interval [zNear, zFar].  I reiterate a link to <a href="http://www.songho.ca/opengl/gl_projectionmatrix.html">an article</a> full of mathematical details of the internal structure of the projection matrix.  Also from the article one can understand where the above expression comes from. <br><br>  The full text of the fragment shader that converts nonlinear depth values ‚Äã‚Äãin the screen space to linear ones: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#version 330 core out vec4 FragColor; float zNear = 0.1; float zFar = 100.0; float LinearizeDepth(float depth) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    NDC float z = depth * 2.0 - 1.0; return (2.0 * zNear * zFar) / (zFar + zNear - z * (zFar - zNear)); } void main() { //   zFar    float depth = LinearizeDepth(gl_FragCoord.z) / zFar; FragColor = vec4(vec3(depth), 1.0); }</span></span></span></span></code> </pre> <br>  Since the linearized depth values ‚Äã‚Äãare between the borders of zNear and zFar, most of the values ‚Äã‚Äãwill be greater than 1.0 and will be displayed as a pure white color.  Dividing the linear depth value by the value of zFar in the code of the main function, we approximate it to the interval [0.0, 1.0].  This will allow us to observe a smooth increase in the brightness of the objects of the scene with their approach to the far plane of the pyramid of the projection, which is much clearer. <br><br>  By launching the application at this time, you can be sure of the linear nature of the change in depth values ‚Äã‚Äãwith distance.  Try to wander around the scene in order to observe the changes: <br>  The scene is almost completely filled with black color, since the depth values ‚Äã‚Äãvary linearly from zNear = 0.1 to zFar = 100.0, which, in this case, is quite far away.  And since we are close to the near plane of the pyramid of the projection, the depth values ‚Äã‚Äãand, accordingly, the brightness are very small. <br><br><h2>  Depth Buffer Limited Precision Artifacts </h2><br>  A visual artifact is quite common, appearing in cases where two planes or two triangles are superimposed on each other so closely that the accuracy of the depth buffer is not enough for an unambiguous resolution of the order of location of these objects.  As a result of this ambiguity, the fragments of these objects constantly seem to change the order of arrangement, creating visual noise and patterns.  The phenomenon is called <i>z-fighting</i> , because it looks as if the displayed figures are fighting for the possibility of overlapping another. <br><br>  In the scene used, there are enough places where z-fighting is noticeable: the containers are specifically located at the same height as the floor, ensuring that the floor and the bottom of the container are in the same plane.  This also means that the depth values ‚Äã‚Äãfor both planes are equal, which makes it impossible to use the depth buffer to resolve the order of these planes. <br><br>  If you stick the camera in one of the containers, that effect will appear in all its glory.  You can see how fragments of the floor plane constantly slip through the bottom of the box, creating an annoying ragged pattern: Z-fighting is a common problem when using the depth buffer and, typically, is more noticeable for remote objects (since at a distance the accuracy of the buffer decreases).  We cannot completely avoid this phenomenon, but there are several approaches in the developer‚Äôs arsenal to reduce or completely get rid of z-fighting in a particular scene. <br><br><h4>  Coping methods </h4><br>  The first and perhaps most important piece of advice would <b>never be to place objects too close to each other, with the risk of overlapping triangles</b> .  By adding a small, invisible to the user, the offset between the objects, you will ensure your freedom from z-fighting.  In our case with a plane and containers, it would be enough just to shift the containers in the direction of the positive semiaxis Y. A sufficiently small offset would be invisible, but sufficient to get rid of the artifact.  However, this method requires manual scene modification and thorough testing to ensure that there are no z-fighting manifestations in the scene. <br><br>  Another approach is to <b>define the near cut plane as far as possible</b> .  As noted above, considerable accuracy is provided near the zNear plane.  Therefore, if we move the near plane away from the observer, we will provide with greater accuracy the entire volume of the pyramid of visibility.  However, it is worth remembering that excessive displacement of the near plane can lead to a noticeable truncation of objects in the vicinity.  So this approach requires a certain amount of trial and adjustment in order to successfully select the value of zNear. <br><br>  The third method simply suggests <b>using the depth buffer format with greater precision</b> , for which you will have to pay a fraction of the performance.  In most cases, 24-bit precision buffers are used, but modern video cards also allow 32-bit precision for the depth buffer.  Additional accuracy will reduce the effect of z-fighting, but it will cost you speed. <br><br>  These three techniques for getting rid of z-fighting are the most common and easy to implement.  There are other ways that are more laborious, but still do not guarantee complete relief from the problem.  Indeed, z-fighting is a typical problem, but with careful use of these techniques, you probably won't have to deal with the manifestations of this artifact at all. <br><br>  <b>PS</b> : one of the commentators of the original article gives a hint about two methods of eliminating z-fighting from 100%: using the stencil buffer when rendering in several approaches;  and using the SGIX_reference_plain extension. </div><p>Source: <a href="https://habr.com/ru/post/342610/">https://habr.com/ru/post/342610/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342600/index.html">How to get more than 3500 stars on GitHub in a week and why?</a></li>
<li><a href="../342602/index.html">Base stations: how it all began</a></li>
<li><a href="../342604/index.html">Pygest # 18. Releases, articles, interesting projects, packages and libraries from the world of Python [November 5, 2017 - November 15, 2017]</a></li>
<li><a href="../342606/index.html">Automation of a warehouse in Bosch Rexroth: software, hardware, integration</a></li>
<li><a href="../342608/index.html">Tips for yourself in youth (design version)</a></li>
<li><a href="../342614/index.html">MEGA Accelerator Finalists: Five New Ideas for Shopping Malls</a></li>
<li><a href="../342616/index.html">Let's argue about Dart and Flutter at the meeting of the Russian-speaking community Dart in St. Petersburg</a></li>
<li><a href="../342618/index.html">Computer vision, cloud development and competition</a></li>
<li><a href="../342620/index.html">Hello Logify, or monitor errors on installed applications</a></li>
<li><a href="../342624/index.html">About PVS-Studio on the eve of the open conference of the ISP RAS. V.P. Ivannikova</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>