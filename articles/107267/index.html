<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multihome IPv4 on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content: how to make the computer respond on the Internet to all its IP-addresses on all its interfaces, each of which has a default gateway. Applies ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multihome IPv4 on Linux</h1><div class="post__text post__text-html js-mediator-article">  Content: how to make the computer respond on the Internet to all its IP-addresses on all its interfaces, each of which has a default gateway.  Applies to servers and desktops. <br><br>  Keywords: policy routing, source based routing <br><br>  Lyrics: There are enough articles about policy routing in Linux.  But they most often deal with common, more subtle and complex cases.  I will analyze the trivial scenario of the following form: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/5e6/b09/738/5e6b0973886b4ab689b8acea335ca0da.png"><br><br>  Our computer (server) has three interfaces.  On each interface, the gateway gave him IP (static or dhcp, it doesn't matter) and said ‚Äúall traffic went to me‚Äù. <br><br>  If we leave this configuration as it is, then the principle of "who was the last one to get up, and the default gateway" will be used.  In the picture above, if the bottom interface (241) rises last, all traffic will be sent to it.  If a request to the first interface (188) comes to our server, then the answer to it will still go down.  If the router / provider has at least minimal protection against forgery of addresses, then the answer is simply dropped as invalid (from the point of view of 241.241.241.1 it was sent a packet from src 188.188.188.188 from the network 241.241.241.0/24, which, obviously, must). <br><br>  In other words, in the normal version only one interface will work.  To make the situation worse, if the addresses are received via dhcp, then the lease update on other interfaces can overwrite the default gateway, which means that the interface that worked, will stop working, and another interface will start to work.  Successful stable operation of your server, so to speak. <br><br><h1>  Decision </h1><a name="habracut"></a><br>  The overall solution is policy routing.  Quite a voluminous and interesting thing that allows you to make all kinds of miracles.  Of these miracles, we (in the framework of this article) will leave only one thing: ‚Äúsend traffic to each router from its‚Äú interface ‚Äù.  That is the classic source-based routing in the most primitive form. <br><br>  Overview of the solution from the height of bird flight: <br><br>  We set three routing options for the traffic: ‚Äúeverything in eth0‚Äù, ‚Äúeverything in eth1‚Äù, ‚Äúeverything in eth2‚Äù, further formulate the rules: send traffic from the IP of the first interface through the first option, traffic from the second IP through the second option, the third IP - through the third. <br><br>  As a result, we get the following construction: <br><table><tbody><tr><td>  source: 188.188.188.188 </td><td>  to eth0-route table </td><td>  default via 188.188.1 </td><td>  via eth0 </td></tr><tr><td>  source: 75.75.75.75 </td><td>  to eth1-route table </td><td>  default via 75.75.75.1 </td><td>  via eth1 </td></tr><tr><td>  source: 241.241.241.241 </td><td>  to eth2-route table </td><td>  default via 241.241.241.1 </td><td>  via eth2 </td></tr></tbody></table><br><br>  Summary: <br><ol><li>  Configure the iproute2 utility using the config (all of a sudden, it has a config!) - give the names to three routing tables </li><li>  Configure routes in three routing tables - more precisely, set default scales </li><li>  Specify the rules by which traffic will be distributed across the three route tables </li></ol><br><br><h1>  Steps more </h1><br>  The ip utility (its official name is iproute2) has a special command - ip rule to manage policy routing.  And adding routes (ip route add) can take an argument with the name of the table.  The kernel does not know anything about the names of the tables, but iproute2 requires the use of the name from its config - <code>/etc/iproute2/rt_tables</code> (which matches names to abstract numbers that the kernel understands).  Values ‚Äã‚Äãof ‚Äú0‚Äù and values ‚Äã‚Äãbelow 255 (254, 253) are occupied, the rest can be used. <br><br><h3>  Iroute2 setup </h3><br>  We will call our routing tables eth0-route, eth1-route, eth2-route.  Take the random symbolic numbers - 100, 101, 102. <br><pre> echo 100 eth0-route &gt;&gt; / etc / iproute2 / rt_tables
 echo 101 eth1-route &gt;&gt; / etc / iproute2 / rt_tables
 echo 102 eth2-route &gt;&gt; / etc / iproute2 / rt_tables
</pre><br><br><h3>  Configuring routes in three routing tables </h3><br>  For each table we will set the default route (it is possible and not the default - the fantasy is in your hands).  These rules will not break anything on the server and you can do them live.  Until we say to use these tables, these are just Baitics in memory and they do not affect the routing operation (that is, we will not suddenly stay without connection in the middle of the process). <br><pre> ip route add default via 188.188.188.1 dev eth0 table eth0-route
 ip route add default via 75.75.75.1 dev eth1 table eth1-route
 ip route add default via 241.241.241.1 dev eth2 table eth2-route
</pre><br><br>  Now the intimate moment: carefully read the written.  After enabling the rules, a typo in the table can leave the server without connectivity. <br><br><h3>  Enable policy routing </h3><br><pre> ip rule add from 188.188.188.188 lookup eth0-route
 ip rule add from 75.75.75.75 lookup eth1-route
 ip rule add from 241.241.241.241 lookup eth2-route
</pre><br><br>  Everything.  From this point on, the server will begin to respond to all three addresses.  Good news: policy routing has a higher priority than the default route dhcp, so the lease update will not break the routing. <br>  Unpleasant news: if you renew your rent, you will be given another address, then it will stop working.  This can be corrected either by making a rule with a mask ( <code>from 241.241.241.0/24</code> ), or by nailing the address with nails in the dhcp-server config (in general, servers are not allowed to issue dynamic addresses via DHCP ...) <br><br><h1>  Cast in configs </h1><br>  (debian / ubuntu) <br>  A great place for these rules is in / etc / network / interfaces.  For the desired interface, we write: <br><pre> iface eth0 inet static
    address 188.188.188.188
    netmask 255.255.255.0
    broadcast: 188.188.188.255
    post-up ip route add default via 188.188.188.1 dev eth0 table eth0-route
    post-up ip rule add from 188.188.188.188 lookup eth0-route
</pre><br><br><h1>  Notes </h1><br>  Routing note: source routing generally opens a vulnerability in the system (a packet with a fake source is sent to you, and you pass it on, as if it should be), but this visibility level is directly connected.  In addition, if you are limited to only your address in the rules, then Linux will not miss this, plus you need to have routing enabled.  On a regular server, such a configuration is completely safe and fairly reliable. <br><br>  Note on load-balancing: By registering all three addresses in the A-record DNS zones, you get a free round-robin on all three interfaces without bonding and poetess.  Since they will be processed by the same server and the same application, this will allow even stateful sessions to be balanced. </div><p>Source: <a href="https://habr.com/ru/post/107267/">https://habr.com/ru/post/107267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107259/index.html">Css-ballun without graphics</a></li>
<li><a href="../107261/index.html">A little about the virtues of NetBeans + php</a></li>
<li><a href="../107262/index.html">Unit Test Evolution</a></li>
<li><a href="../107265/index.html">Epic 4G turned into a gaming console</a></li>
<li><a href="../107266/index.html">YouTube co-founder Chad Hurley leaves CEO</a></li>
<li><a href="../107268/index.html">3D Console Renderer</a></li>
<li><a href="../107269/index.html">October 31 - open webinar. The problem of graph isomorphism and functional programming</a></li>
<li><a href="../107270/index.html">Three years ago‚Ä¶</a></li>
<li><a href="../107272/index.html">Using macros in MASM using the example of creating a window</a></li>
<li><a href="../107277/index.html">How I watch TV shows in console / bash scripting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>