<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[Translation] How Graal Works - JIT JVM Compiler in Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the translation of the article " Understanding How Graal Works - a Java JIT Compiler Written in Java ". 
 Introd...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[Translation] How Graal Works - JIT JVM Compiler in Java</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I present to your attention the translation of the article " <a href="https://chrisseaton.com/truffleruby/jokerconf17/">Understanding How Graal Works - a Java JIT Compiler Written in Java</a> ". </p><br><h2 id="vvedenie">  Introduction </h2><br><p>  One of the reasons why I became a researcher of programming languages ‚Äã‚Äãis that, in a large community of people connected with computer technologies, almost all use programming languages, and many are interested in how they work.  When I first encountered programming as a child and became acquainted with a programming language, the first thing I wanted to know was how it works, and the very first thing I wanted to do was create my own language. </p><br><p>  In this presentation, I will show some of the mechanisms of the language used by all of you - Java.  A special feature is that I will use a project called <em>Graal</em> , which implements the concept of <em>Java in Java</em> . </p><a name="habracut"></a><br><p>  Graal is only one of the components in the work of Java - it is <em>just-in-time</em> compiler.  This is the part of the JVM that converts Java bytecode to machine code during program operation, and is one of the factors ensuring high platform performance.  It also seems to me that most people consider one of the most complex and hazy parts of the JVM, which is beyond their comprehension.  To change this opinion is the purpose of this talk. </p><br><p>  If you know what a JVM is;  in general, you understand what the terms <em>bytecode</em> and <em>machine code</em> mean;  and are able to read code written in Java, then I hope this will be enough to understand the stated material. </p><br><p>  I will begin by discussing why we might want a new JIT compiler for JVM written in Java, and then I‚Äôll show that there is nothing extraordinary in this, as you might think by breaking the task down into compiler build, use, and demonstration that its code is the same as in any other application. </p><br><p>  I‚Äôll touch on the theory quite a bit, and then show how it is applied during the whole compilation process from bytecode to machine code.  I will also show some details, and in the end we will talk about the benefits of this feature besides implementing <em>Java in Java</em> for its own sake. </p><br><p>  I will use screenshots of the code in Eclipse, instead of running them during the presentation, to avoid the inevitable problems of live coding. </p><br><h2 id="chto-takoe-jit-kompilyator">  What is a JIT compiler? </h2><br><p>  I am sure that many of you know what a JIT compiler is, but nevertheless I will touch upon the basics so that no one is sitting here afraid to ask this main question. </p><br><p> When you run the <code>javac</code> or <em>compile-on-save</em> command in the IDE, your Java program is compiled from Java code into JVM bytecode, which is a binary representation of the program.  It is more compact and simple than Java source code.  However, the usual processor of your laptop or server cannot simply execute JVM bytecode. </p><br><p>  The JVM interprets this bytecode for your program to work.  Interpreters are usually much slower than machine code run on a processor.  For this reason, while the program is running, the JVM can start another compiler that converts your bytecode to machine code, which the processor is already able to execute. </p><br><p>  This compiler, usually much more sophisticated than <code>javac</code> , performs complex optimizations to produce high-quality machine code as a result. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  Why write a JIT compiler in Java? </h2><br><p>  Today, a JVM implementation called <em>OpenJDK</em> includes two main JIT compilers.  The client compiler, known as <em>C1</em> , is designed to run faster, but it also produces less optimized code.  The server compiler, known as <em>opto</em> or <em>C2</em> , takes a little more time to work, but produces more optimized code. </p><br><p>  The idea was that the client compiler was better suited for desktop applications, where long pauses of the JIT compiler are undesirable, and the server compiler for long-running server applications in which it is possible to spend more time on compilation. </p><br><p>  Today, they can be combined so that the code is first compiled with C1, and then, if it continues to be intensively executed and it makes sense to spend additional time, - C2.  This is called <em>tiered compilation</em> . </p><br><p>  Let's look at the C2 server compiler, which performs more optimizations. </p><br><p>  We can clone OpenJDK from a mirror on <em>GitHub</em> , or just open a project tree on the site. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  The C2 code is in <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="C2 source code"></p><br><p>  First of all, it is worth noting that C2 is written in <em>C ++</em> .  Of course, this is not something bad, but there are certain disadvantages.  C ++ is an insecure language.  This means that errors in C ++ can crash the VM.  It is possible that the reason for this is the age of the code, but C2 code in C ++ has become very difficult to maintain and develop. </p><br><p>  One of the key figures behind the C2 compiler, Cliff Click, said that he would never write VM again in C ++, and we heard the <em>Twitter</em> JVM team express the opinion that C2 had become stagnant and needed to be replaced due to difficulties of further development. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Cliff Click Presentation"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="What doesn‚Äôt Cliff Click"></p><br><p>  <a href="https://www.youtube.com/watch%3Fv%3DHqw57GJSrac">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  So, going back to the question, what is there in Java that can help solve these problems?  The same thing that gives writing a program in Java instead of C ++.  This is probably security (exceptions instead of crashes, no real memory leaks or dangling pointers), good tools (debuggers, profilers, and tools like <em>VisualVM</em> ), good support for IDE, etc. </p><br><p>  You might think: <em>How can I write something like a JIT compiler in Java?</em>  and that this is only possible in a low-level system programming language, such as C ++.  In this talk, I hope to convince you that this is not the case at all!  Essentially, the JIT compiler should simply accept the JVM bytecode and output the machine code ‚Äî you give it a <code>byte[]</code> at the input, and you also want to get back the <code>byte[]</code> .  It takes a lot of complicated work to do this, but it doesn‚Äôt affect the system level, and therefore does not require a <em>system</em> language such as C or C ++. </p><br><h2 id="nastroyka-graal">  Setting Graal </h2><br><p>  The first thing we need is Java 9. The Graal interface used called <em>JVMCI</em> was added to Java as part of the <em>JEP 243 Java-Level JVM Compiler Interface</em> and the first version that includes it is Java 9. I use <em>9 + 181</em> .  In case of any particular requirements there are ports (backports) for Java 8. </p><br><pre> <code class="hljs pgsql">$ export JAVA_HOME=`pwd`/jdk9 $ export <span class="hljs-type"><span class="hljs-type">PATH</span></span>=$JAVA_HOME/bin:$<span class="hljs-type"><span class="hljs-type">PATH</span></span> $ java -<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> java <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> "9" Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  The next thing we need is an assembly system called <code>mx</code> .  It is a bit like <em>Maven</em> or <em>Gradle</em> , but, most likely, you would not choose it for your application.  It implements some functionality to support some complex use cases, but we will only use it for simple builds. </p><br><p>  You can clone <code>mx</code> with github.  I am using commit <code>#7353064</code> .  Now just add the executable file to the path. </p><br><pre> <code class="hljs bash">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/graalvm/mx.git $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> mx; git checkout 7353064 $ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=`<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Now we need to slope Graal himself.  I am using a distribution called <em>GraalVM</em> version <em>0.28.2</em> . </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/graalvm</span></span><span class="hljs-regexp"><span class="hljs-regexp">/graal.git --branch vm-enterprise-0.28.2</span></span></code> </pre> <br><p>  This repository contains other projects that are not interesting to us now, so we simply move to the <em>compiler</em> subproject, which is the Graal JIT compiler, and build it using <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  I‚Äôll use the <em>Eclipse IDE</em> to work with Graal code.  I am using Eclipse 4.7.1.  <code>mx</code> can generate Eclipse project files for us. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  To open the <em>graal</em> directory as a <em>workspace,</em> you need to run <em>File, Import ..., General, Existing projects</em> and select the <em>graal</em> directory <em>again</em> .  If you didn't run Eclipse in Java 9, then you might also need to attach the JDK sources. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal in eclipse"></p><br><p>  Good.  Now that everything is ready, let's see how it works.  We will use this very simple code. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  First we compile this <code>javac</code> code, and then run the JVM.  First, I will show the work of the standard C2 JIT compiler.  To do this, we specify several flags: <code>-XX:+PrintCompilation</code> , which is necessary for the JVM to write the log when compiling the method, and <code>-XX:CompileOnly=Demo::workload</code> , so that only this method is compiled.  If we do not do this, too much information will be displayed, and the JVM will be smarter than we need and optimize the code we want to see. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  I will not explain it in detail, but I will say only that this is a log output, which shows that the <code>workload</code> method <code>workload</code> been compiled. </p><br><p>  Now, as a JIT compiler for our Java 9 JVM, we use the newly compiled Graal.  For this you need to add a few more flags. </p><br><p>  <code>--module-path=...</code> and <code>--upgrade-module-path=...</code> add Graal to the <em>module path</em> .  Recall that the <em>module path</em> appeared in Java 9 as part of the <em>Jigsaw</em> module system, and for our purposes we can consider it by analogy with the <em>classpath</em> . </p><br><p>  We need the <code>-XX:+UnlockExperimentalVMOptions</code> because the JVMCI (interface used by Graal) in this version is an experimental feature. </p><br><p>  The <code>-XX:+EnableJVMCI</code> needed to say that we want to use JVMCI, and <code>-XX:+UseJVMCICompiler</code> - to enable and install a new JIT compiler. </p><br><p>  In order not to complicate the example, and instead of using C1 in conjunction with JVMCI, to have only the JVMCI compiler, we specify the <code>-XX:-TieredCompilation</code> , which disables stepwise compilation. </p><br><p>  As before, we specify the <code>-XX:+PrintCompilation</code> and <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  As in the previous example, we see that one method was compiled.  But, this time, for compilation, we used the newly compiled Graal.  For now, just take my word for it. </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ java </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--module-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--upgrade-module-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+UnlockExperimentalVMOptions </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+EnableJVMCI </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+UseJVMCICompiler </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:-TieredCompilation </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+PrintCompilation </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:CompileOnly=Demo::workload </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">Demo ... 583 25 Demo::workload (4 bytes) ...</span></span></code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  JVM compiler interface </h2><br><p>  Do not you think that we have done something quite unusual?  We have an installed JVM, and we replaced the JIT compiler with the newly compiled new one without changing anything in the JVM itself.  This feature is provided by a new JVM interface called JVMCI, the <em>JVM compiler interface</em> , which I mentioned above was <em>JEP 243</em> and was included in Java 9. </p><br><p>  The idea is similar to some other existing JVM technologies. </p><br><p>  Perhaps you have already come across additional processing of source code in <code>javac</code> using the <em>Java annotation processing API</em> .  This mechanism makes it possible to identify the annotations and the model of the source code in which they are used, and to create new files based on them. </p><br><p>  Also, you may have used additional bytecode processing in the JVM using <em>Java agents</em> .  This mechanism allows you to modify Java bytecode by intercepting it when loading. </p><br><p>  The idea of ‚Äã‚ÄãJVMCI is similar.  It allows you to connect your own Java JIT compiler written in Java. </p><br><p>  Now I want to say a few words about how I will show the code during this presentation.  First, to understand the idea, I will show some simplified identifiers and logic in the form of text on slides, and then I will switch to Eclipse screenshots and show real code, which may be a little more complicated, but the main idea will remain the same.  The main part of this speech is intended to show that you can really work with a real project code, and therefore I don‚Äôt want to hide it, although it may be somewhat complicated. </p><br><p>  From this point on, I will begin to dispel the opinion that you might have, that the JIT compiler is very difficult. </p><br><p>  What does the JIT compiler take as input?  It accepts the bytecode of the method to be compiled.  A baytkod, as the name suggests, is just an array of bytes. </p><br><p>  What does the JIT compiler produce as a result?  It gives the machine code of the method.  Machine code is also just an array of bytes. </p><br><p>  As a result, the interface that needs to be implemented when writing a new JIT compiler to embed it in the JVM will look something like this. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Therefore, if you could not imagine how Java can do something as low-level as JIT compilation into machine code, now it is clear that this is not such a low-level work.  True?  This is just a function from <code>byte[]</code> to <code>byte[]</code> . </p><br><p>  In fact, everything is somewhat more complicated.  Only bytecode is not enough - we also need some more information, such as the number of local variables, the required stack size, and the information collected by the interpreter profiler to understand how the code is executed after the fact.  Therefore, we present the input in the form of a <code>CompilationRequest</code> , which tells us about the <code>JavaMethod</code> that needs to be compiled and provides all the necessary information. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Also, the interface does not require the return of the compiled code.  Instead, to install the machine code in the JVM, another API is used. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Now, to write a new JIT compiler for the JVM, you just need to implement this interface.  We get information about the method that needs to be compiled, and must compile it into machine code and call <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Let's switch to Eclipse IDE with Graal and look at some real interfaces and classes.  As mentioned earlier, they will be somewhat more complicated, but not by much. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="compileMethod"></p><br><p>  Now I want to show that we can make changes to Graal, and immediately use them in Java 9. I will add a new log message, which will be displayed when the method is compiled using Graal.  Add it to the implemented interface method, which is called by the JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Compilation"></p><br><p>  For now, disable the compilation logging that exists in HotSpot.  Now we can see our message from a modified version of the compiler. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  If you try to do it yourself, you will notice that it does not even need to run our build system - <code>mx build</code> .  Enough for Eclipse, <em>compile on save</em> .  And certainly we don‚Äôt need to rebuild the JVM itself.  We simply embed the modified compiler into the existing JVM. </p><br><h2 id="graf-graal">  Graph graal </h2><br><p>  Well, we know that Graal converts one <code>byte[]</code> into another <code>byte[]</code> .  Now let's talk about the theory and data structures that it uses, because  they are a bit unusual even for a compiler. </p><br><p>  In essence, the compiler handles the processing of your program.  To do this, the program must be represented in the form of a data structure.  One option is bytecode and similar instruction lists, but they are not very expressive. </p><br><p>  Instead, Graal uses a graph to represent your program.  If we take a simple addition operator that adds two local variables, then the graph will include one node to load each variable, one node for the sum, and two edges, which show that the result of loading local variables is input to the addition operator. </p><br><p>  This is sometimes called the <em>program dependency graph</em> . </p><br><p>  Having an expression of the form <code>x + y</code> we get the nodes for the local variables <code>x</code> and <code>y</code> , and the node of their sums. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Data flow graph"></p><br><p>  The blue edges on this graph indicate the direction of data flow from reading local variables to summation. </p><br><p>  Also, we can use edges to reflect the order of program execution.  If, instead of reading local variables, we call methods, then we need to remember the order of the call, and we cannot rearrange them in places (without knowing the code inside).  For this there are additional edges that define this order.  They are shown in red. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Control flow graph"></p><br><p>  So, the Graal graph, in fact, is two graphs combined in one.  Nodes are the same, but some edges show the direction of data flow, while others show the transfer of control between them. </p><br><p>  To see the Graal graph, you can use a tool called <em>IdealGraphVisualiser</em> or <em>IGV</em> .  The launch is performed using the <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  After that, run the JVM with the <code>-Dgraal.Dump</code> flag. </p><br><p>  A simple data stream can be seen by writing an uncomplicated expression. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="IGV arithmetic mean"></p><br><p>  You can see how the parameters <code>0</code> ( <code>P(0</code> ) and <code>1</code> ( <code>P(1)</code> ) are fed to the input of the addition operation, which, together with the constant <code>2</code> ( <code>C(2)</code> ) is fed to the input of the division operation. After this value is returned. </p><br><p>  In order to look at a more complex data flow and control, we introduce a loop. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="IGV arithmetic mean with a cycle"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Detailed IGV arithmetic mean with a cycle"></p><br><p>  In this case, we have nodes at the beginning and end of the loop, reading the elements of the array, and reading the length of the array.  As before, the blue lines show the direction of data flow, and the red lines indicate the flow of control. </p><br><p>  Now you can see why this data structure is sometimes called a <em>sea ‚Äã‚Äãof ‚Äã‚Äãnodes</em> or a <em>soup of nodes</em> . </p><br><p>  I want to say that C2 uses a very similar data structure, and, in fact, it was C2 that popularized the idea of ‚Äã‚Äãthe compiler of the <em>sea ‚Äã‚Äãof ‚Äã‚Äãnodes</em> , so this is not an innovation of Graal. </p><br><p>  I will not show the process of building this graph until the next part of the speech, but when Graal gets the program in this format, optimization and compilation is performed by modifying this data structure.  And this is one of the reasons why writing a JIT compiler in Java makes sense. Java ‚Äî - ,   ‚Äî   ,     . </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">      </h2><br><p>        ,      . </p><br><h3 id="poluchenie-baytkoda">   </h3><br><p>    .       . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  ,      . </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">      </h3><br><p> <em></em> ,       JVM,     Graal.  ,  , <em> </em> ‚Äî    Java, ,   ,           . </p><br><p>    ,  Graal   Java,         Eclipse.  ,       ,      . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Call Search AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Parser"></p><br><p> ,     ,        <code>IADD</code> ( <code>96</code> ,       ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>   ,    , ..       .       JVM,        ,  ,    .         , ,   ,    , ,    ,    ,     . </p><br><p>     Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">    </h3><br><p>    Graal          .            <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p> ,        .    ,                . </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt=" incl  "></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt=" "></p><br><p>  ,    ,     <code>ByteBuffer</code> ‚Äî    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               ‚Äî       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="  "></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs ruby">$ cd openjdk/hotspot/src/share/tools/hsdis $ curl -O <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/ftp.heanet.ie/mirrors</span></span><span class="hljs-regexp"><span class="hljs-regexp">/gnu/binutils</span></span><span class="hljs-regexp"><span class="hljs-regexp">/binutils-2.24.tar.gz $ tar -xzf binutils-2.24.tar.gz $ make BINUTILS=binutils-2.24 ARCH=amd64 CFLAGS=-Wno-error $ cp build/macosx</span></span>-amd64/hsdis-amd64.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ java </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--module-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--upgrade-module-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+UnlockExperimentalVMOptions </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+EnableJVMCI </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+UseJVMCICompiler </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:-TieredCompilation </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+PrintCompilation </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+UnlockDiagnosticVMOptions </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:+PrintAssembly </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-XX:CompileOnly=Demo::workload </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">Demo</span></span></code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="  AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[26, 27, 96, -84]</span></span> ‚Üí <span class="hljs-selector-attr"><span class="hljs-selector-attr">[15, 31, 68, 0, 0, 43, -14, -117, -58, -123, 5, ...]</span></span></code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym  NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Global value numbering"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt=" global value numbering"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt=",     global value numbered"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt=" "></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="  "></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="  "></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt=" Metropolis"></p><br><p> <a href="http://cr.openjdk.java.net//~jrose/metropolis/Metropolis-Proposal.html">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs pgsql">$ javac Hello.java $ graalvm<span class="hljs-number"><span class="hljs-number">-0.28</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/bin/native-image Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (<span class="hljs-keyword"><span class="hljs-keyword">inline</span></span>): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [total]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms $ ls -lh hello -rwxr-xr-x <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello $ file ./hello ./hellojava: Mach-O <span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">bit</span></span> executable x86_64 $ <span class="hljs-type"><span class="hljs-type">time</span></span> ./hello Hello! <span class="hljs-type"><span class="hljs-type">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.010</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://github.com/graalvm/truffleruby">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  findings </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Since JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://chrisseaton.com/truffleruby">More information about TruffleRuby</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/low-overhead-polling">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/tenthings">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/structs">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/jokerconf17/">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/flip-flops/">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/deoptimizing/">Deoptimizing Ruby</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/cext/">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/small-data-structures/">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/pushing-pixels/">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/set_trace_func/">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/how-method-dispatch-works-in-jruby-truffle/">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://chrisseaton.com/truffleruby/announcement/">A Truffle/Graal High Performance Backend for JRuby</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/419637/">https://habr.com/ru/post/419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419623/index.html">"She": how we come up with images of artificial intelligence</a></li>
<li><a href="../419625/index.html">My favorite PHP7 features overview</a></li>
<li><a href="../419627/index.html">We are looking for speakers at Moscow Data Science Major</a></li>
<li><a href="../419633/index.html">Now all the main lists of root certificates trust Let's Encrypt</a></li>
<li><a href="../419635/index.html">Release of the stable version Dart 2.0 and Dart Web Platform</a></li>
<li><a href="../419643/index.html">Minsk EPAM Software Engineering Conference: Make it Real</a></li>
<li><a href="../419647/index.html">Seminar ‚ÄúBlack Friday in e-commerce. Secrets of Survival ", August 16, Moscow</a></li>
<li><a href="../419649/index.html">About cats, or what CAT we have chosen for synchro podcasts</a></li>
<li><a href="../419651/index.html">Neither GA nor NM. How we made our own clickstream</a></li>
<li><a href="../419653/index.html">How to search for users on GitHub without React + RxJS 6 + Recompose</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>