<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We comprehend C deeper using assembler. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the third article we will continue to deal with the conditions. Last time, we never looked at optimized if-else versions. 

 Perhaps, because of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We comprehend C deeper using assembler. Part 3</h1><div class="post__text post__text-html js-mediator-article">  In the third article we will continue to deal with the conditions.  Last time, we never looked at optimized if-else versions. <br><a name="habracut"></a><br>  Perhaps, because of this, some fair questions arose, for example, why the compiler is here: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">scanf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i"</span></span>, &amp;x); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) {     c = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     c = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c;</code> </pre> <br>  Generated code with two transitions, but not with one. <br><br>  Indeed, we here and wrote a little strange code, because, obviously, it was possible to write it like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">scanf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i"</span></span>, &amp;x); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) {    c = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c;</code> </pre><br>  You should ask the programmer why he needs an else, and not the compiler.  But if we look at the optimized version of the first version, we see that the compiler is not so stupid: <br><br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function">, 12 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dword</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptr</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function"> + 8], 10 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function">, 8 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lea</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function">, [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function"> + 16] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scanf</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function">, 16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> </span></span>;   eax cmp dword ptr [esp + <span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">4</span></span> ;     <span class="hljs-number"><span class="hljs-number">4</span></span> setl al ;   ,   al  <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> eax, <span class="hljs-number"><span class="hljs-number">2</span></span> ;    <span class="hljs-number"><span class="hljs-number">2</span></span> add esp, <span class="hljs-number"><span class="hljs-number">12</span></span> ret .L.str: .asciz <span class="hljs-string"><span class="hljs-string">"%i"</span></span></code> </pre><br>  Immediately it is worth noting that there are no transitions at all.  And the way that clang dealt with our condition, we have already seen.  For the second option, exactly the same optimized code will be generated. <br><br>  Now let's remember this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">scanf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i"</span></span>, &amp;a); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a++ &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || a++ &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) { a++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { a+=<span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a; }</code> </pre><br>  Was it a bit scary last time?  The optimized version may slightly reduce the amount of code and the number of labels (I‚Äôll skip scanf): <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[esp + 8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx + 1]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[esp + 8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">js</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.LBB0_2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx + 2]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, 5 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[esp + 8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jl</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.LBB0_3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.LBB0_2</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">inc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.LBB0_3</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br>  Up to the mark. LBB0_2, the code corresponds to the condition itself.  Please note that in the optimized version the logic: ‚Äúthe second operand‚Äú or ‚Äùwill not be calculated, if the first is true‚Äù is not violated.  Well still, she was broken ... <br><br>  However, there is a significant difference from the non-optimized version.  Let's go through the code so that everyone understands what is happening: <br><br>  The first line in ecx gets the value of the variable "a". <br>  The second line in eax gets a + 1 <br>  Next comes the comparison with zero, so that the js instruction goes to the label with the number 2 if the number was negative. <br>  In the fourth line in the variable "a" gets a + 1 from eax. <br><br>  In the non-optimized version, we took the value of the variable again and put it in eax, but now we take the old value, it is still in ecx.  Next we do a + 2 and save to eax. <br><br>  And we compare the number to increment from 5, so that the instruction jl, go to the third label, if the value is less, thus not falling into the condition. <br><br>  You should have a fair question: ‚ÄúSo that clang will produce two different results for an optimized and non-optimized version of the program?‚Äù <br><br>  No, the thing is that care in else happens with less than 5, not less or equal.  The compiler took into account the dubious result, when the variable would be equal to 5, and built the condition.  As a result, I saved on additional memory access. <br><br>  In the optimized version: <br>  5&gt; = 5 =&gt; 5 + 3 <br>  In non-optimized <br>  7&gt; 5 =&gt; 7 + 1 <br><br>  Otherwise, in the optimized version, you can simply add 4 to the result and throw it into eax.  These are the wonders. <br><br>  Why do I compare a non-optimized version of gcc with an optimized clang?  Well, gcc does the same thing, just not very pretty.  And in clang, the code looks consistent and compact. <br><br>  It is necessary to mention that the compiler in VS2015 on full optimization left only one label: <br><br><pre> <code class="hljs mel"> mov eax, DWORD PTR _a$[ebp] ;a ‚Üí eax add esp, <span class="hljs-number"><span class="hljs-number">8</span></span> mov ecx, eax inc eax test ecx, ecx js SHORT $LN4@main ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) mov ecx, eax inc eax cmp ecx, <span class="hljs-number"><span class="hljs-number">5</span></span> jg SHORT $LN4@main ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a&gt;<span class="hljs-number"><span class="hljs-number">5</span></span>) add eax, <span class="hljs-number"><span class="hljs-number">2</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> a+=<span class="hljs-number"><span class="hljs-number">2</span></span> ... $LN4@main: ... inc eax ;a++ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ...</code> </pre><br>  In between, a code that does not belong to ours, so I just removed it.  As you can see, the conditions are designed to skip the else, so there is only one label.  But it is worth adding the code after else, and there will also be two labels.  In this case, the code will resemble a non-optimized version by the fact that we first assign one value, but if the condition is met, the value will be overwritten. <br><br><h2>  switch </h2><br>  Well, what about the switch statement?  How the battery of if-s will differ from this ‚Äúbeautiful‚Äù operator.  Let's find out by the example of the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = getchar(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'q'</span></span>) { a = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'w'</span></span>) { a = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'e'</span></span>) { a = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { a = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a;</code> </pre><br>  and its alternative: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = getchar(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(c) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'q'</span></span>: a = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'w'</span></span>: a = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'e'</span></span>: a = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: a = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a;</code> </pre><br>  We will not consider in detail the non-optimized version.  I think everyone understands that the differences, if any, will be minimal.  But it‚Äôs funny what exactly the switch generates more code as a result (gcc 7.2): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">movsx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">BYTE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-13]</span></span> ;            <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 113 <span class="hljs-selector-tag"><span class="hljs-selector-tag">je</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 119 <span class="hljs-selector-tag"><span class="hljs-selector-tag">je</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 101 <span class="hljs-selector-tag"><span class="hljs-selector-tag">je</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L8</span></span></code> </pre><br>  In the case of if, you should already represent the code: comparison - action - transition.  And here you see that actions are postponed for later. <br><br>  In the optimized version of gcc for switch, it will generate shorter code, and there will be no difference at all in the clang.  Therefore, let's consider only the switch in gcc.  But first think, how could you remove the switch in this code altogether? <br><br>  So, if invented, then open the spoiler and look: <br><br><div class="spoiler">  <b class="spoiler_title">asm code</b> <div class="spoiler_text"><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stdin</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_getc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[eax-101]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dl</span></span>, 18 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ja</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movzx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">dl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CSWTCH</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0+edx*4]</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L1</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CSWTCH</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 2 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 0 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 4 <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> 1</code> </pre><br>  The idea is very simple: match the symbol code and the final number in "a".  This can be achieved by subtracting the smallest character code from the switch from the result, in our case it is 'e' or 101. <br><br>  Then we put in eax 4, because in the else we will have just that. <br>  Next, we compare the contents of edx and 18 (only take the low byte from this register, like al, only for edx is dl).  And if the value is greater than (ja), then go to the label .L1.  If the question was: ‚Äúwhy 18?‚Äù, Then run 'w' - 101. <br><br>  Now, if the result is between 0 and 18, then the formula works: mov eax, DWORD PTR CSWTCH.3 [0 + edx * 4], which means simply taking the result, based on the number in edx, offset 4 separates one number from another in memory (4 bytes). <br></div></div><br>  For 0 ('e') the result will be 2, <br>  For 12 ('q') the result will be 0, <br>  For 18 ('w') the result will be 1, <br>  In other cases there will be 4. <br><br>  We have a badly torn example from life, hardly, so someone, in general, used the switch.  What if some action goes?  You might be surprised, but in general nothing changes.  Consider this example: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;math.h&gt; int main(void) { start:    char c = getchar();       switch (c)    {    case 'T':    case 't': printf("Talk\n"); break;    case 'W':    case 'w': printf("%f\n", sin(0)); break;    case 'Q':    case 'q': return 0;    default:        printf("wrong command\n");    }    goto start;   }</span></span></span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">asm code</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.LC0</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.string</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">Talk</span></span>" <span class="hljs-selector-class"><span class="hljs-selector-class">.LC2</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.string</span></span> "%<span class="hljs-selector-tag"><span class="hljs-selector-tag">f</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span>" <span class="hljs-selector-class"><span class="hljs-selector-class">.LC3</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.string</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">wrong</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">command</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span>: ... <span class="hljs-selector-class"><span class="hljs-selector-class">.L2</span></span>: ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">start</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stdin</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> _<span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_getc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 81 <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span>, 38 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ja</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movzx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[DWORD PTR .L5[0+eax*4]</span></span>] <span class="hljs-selector-class"><span class="hljs-selector-class">.L5</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L9</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L6</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L7</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L9</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L6</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.long</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L7</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L7</span></span>: ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">sin</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OFFSET</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FLAT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:.LC2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L2</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L6</span></span>: ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Talk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OFFSET</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FLAT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:.LC0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">puts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L2</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L9</span></span>: ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span> 0; <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">DWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">leave</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx-4]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L3</span></span>: ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OFFSET</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FLAT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:.LC3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">puts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 16 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.L2</span></span></code> </pre></div></div><br>  There is a lot of code, so concentrate on the essentials.  Now, instead of moving the number in eax, a transition is made to a specific label.  But the idea itself does not change. <br><br><h2>  Conclusion </h2><br>  It seems that we have dealt with the conditions completely.  If someone had doubts about the switch, then you can now not be afraid of him.  In the next article, we will look at cycles. <br><br>  <a href="https://habrahabr.ru/post/345460/">Previous article</a> </div><p>Source: <a href="https://habr.com/ru/post/347132/">https://habr.com/ru/post/347132/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347120/index.html">Own pix2code with blackjack, but without neurons</a></li>
<li><a href="../347124/index.html">How dtraceasm works in JMH</a></li>
<li><a href="../347126/index.html">Reactive forms (reactive forms) Angular 5 (2+). Part 2</a></li>
<li><a href="../347128/index.html">JUndo - undo library for Java</a></li>
<li><a href="../347130/index.html">7 types of office loafers - part one</a></li>
<li><a href="../347134/index.html">16 Tons. How I saved a dying WordPress site with very superficial knowledge of this CMS</a></li>
<li><a href="../347138/index.html">Making games in Python 3 and Pygame: Part 1</a></li>
<li><a href="../347140/index.html">How to cook AR on android</a></li>
<li><a href="../347144/index.html">CoffeeMiner: hacking WiFi to embed a crypto miner in HTML pages</a></li>
<li><a href="../347146/index.html">Query Profiler in Phoenix. And a little bit about how stacktrace works in Elixir / Erlang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>