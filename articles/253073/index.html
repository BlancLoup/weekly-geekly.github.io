<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protection from listening to conversations - we build secure SIP telephony with our own hands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 
 This time I want to talk about VoIP call encryption technologies, what kind of protection different approaches provide and how to organize...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protection from listening to conversations - we build secure SIP telephony with our own hands</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/48b/b28/97f/48bb2897f8c9430cb0b49d3571d05134.png" alt="image" align="left" width="300"><br>  Hi, Habr! <br>  This time I want to talk about VoIP call encryption technologies, what kind of protection different approaches provide and how to organize the most secure voice communication with technological guarantees of security. <br>  In the article I will try to explain the features of such technologies as SIP \ TLS, SRTP and ZRTP.  And I will demonstrate specific usage patterns on the example of our <a href="https://ppbbxx.com/">ppbbxx.com</a> service <a href="https://ppbbxx.com/">.</a> <br><br><a name="habracut"></a><br><br><h2>  Some theory </h2><br>  Any VoIP call consists of 2 main components: the exchange of signal information and the transfer between users of media streams with voice and / or video. <br>  At the first stage, in the process of exchanging signal information, clients directly or through the server agree among themselves on the parameters of the call being established.  If the connection is established using the server, on the basis of the signaling information, the server authorizes the client, establishes who and to whom it calls, performs routing and switching.  Thanks to the signaling protocol data, the clients and the server agree on the encryption method used by the media codecs, exchange ip addresses and port numbers where media and so on are expected to be received.  It happens on such protocols as SIP, XMPP and other. <br>  Directly "conversation", that is, the exchange of voice data between clients, usually occurs via RTP.  The data inside is transmitted in the form agreed by the clients and the server at the ‚Äúsignaling‚Äù stage.  Voice exchange is possible both directly between clients and through a server - an intermediary.  In the second case, the server can help clients with the passage of NAT and in the choice of codecs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So what is an encrypted VoIP call?  Then we will talk about the SIP protocol as the most popular. <br>  As we have already found out, the call consists of signal and media parts, each of which can be encrypted separately using special protocol methods.  SIP \ TLS is used to encrypt signaling information, ZRTP and SRTP protocols are used to encrypt voice. <br><br>  <b>SIP \ TLS</b> - roughly speaking, the equivalent of HTTPS for regular SIP.  The protocol allows the client to verify that it is communicating with the correct server, provided that the client trusts the certificate provided by the server.  Read more <a href="https://ru.wikipedia.org/wiki/TLS">on Wikipedia.</a> <br><br>  <b>SRTP</b> and <b>ZRTP</b> are two different ways to encrypt RTP streams.  The fundamental difference between them is that the key exchange for SRTP occurs in the signaling (at the first signaling stage of the call setup).  And for ZRTP directly at the beginning of the exchange of RTP packets (in the second, ‚Äúmedia‚Äù part) using a <a href="https://ru.wikipedia.org/wiki/ZRTP">special protocol</a> based on the Diffie-Hellman cryptography method. <br>  It is important that for SRTP a mandatory condition for the encryption of a call is the simultaneous use of SIP \ TLS + SRTP, otherwise the attacker would have no difficulty in obtaining the keys (which will be transferred via unencrypted SIP) and listen to the conversation.  While this is not important for ZRTP, the RTP stream will be securely encrypted regardless of whether the alarm is encrypted or not.  Moreover, the protocol can detect the presence of ‚Äúman in the middle‚Äù (including service servers!) Between directly talking clients.  This allows you to be sure that you cannot listen to the conversation, at least from the point of view of listening to the network / data transmission medium. <br><br>  Connection scheme of SIP clients with different encryption settings: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/2b7/efe/130/2b7efe13081f4d84baef403e02233f4e.png" alt="Call pattern ppbbxx.com"></div><br><br>  We can distinguish the following schemes for installing an encrypted call: <br><br><ol><li>  Both users use SIP \ TLS and SRTP.  In this case, the key exchange for media encryption occurs via a secure signaling protocol.  It assumes the trust to the server involved in establishing the connection.  Outsiders cannot access any signaling information or voice data.  The disadvantage is that the user is not notified at the protocol (client) level and is not convinced that the second user also uses an encrypted connection to the server. <br><br></li><li>  Both users use ZRTP, while voice passes through the server.  In this case, the server is defined by the ZRTP protocol as Trusted MitM (man in the middle).  Key exchange takes place according to an algorithm based on the Diffie-Hellman method (which guarantees the impossibility of wiretapping) using the RTP protocol.  If this uses a secure SIP \ TLS - outsiders also can not access any signaling information or the "voice".  As in the first variant, trust in the switching server is assumed, but unlike it, reliable voice encryption <u>does not</u> require the mandatory use of secure SIP \ TLS.  Also, unlike the first option, each user sees that the conversation is encrypted to the server on both sides, and also that both are connected to the same (trusted) server. <br><br></li><li>  Both users use ZRTP, but media is installed directly between clients.  Since the key exchange takes place directly between clients, even the server that performed the switch cannot listen to the conversation.  In this case, both clients display information that a secure direct session has been established.  You can verify this by checking SAS (short authorization lines) - they will be the same.  If you want to hide signaling information from outsiders, you should use SIP \ TLS.  This is the safest option, but in this case the server will not be able to perform many functions that in other situations are performed on it, for example, recording the conversation directly, re-encoding the voice for clients with different audio codec settings, and so on. <br><br></li><li>  One user uses the first method described above, and the other - the second.  In this case, the trust to the server is also required.  The signaling information is encrypted using SIP \ TLS.  For a user with ZRTP, the protocol will report that an encrypted connection is established before the server (End at MitM).  Whether encryption is used on the other hand at the protocol level will not be possible. </li></ol><br><br>  On it we will finish with the theory and we will pass to practice!  We will set up our own SIP server, create SIP users, install SIP clients and learn how to make encrypted calls using the free <a href="https://habrahabr.ru/company/ppbbxx/blog/252665/">cloud telephony service ppbbxx.com</a> <br><br><h2>  Server Tuning </h2><br><img src="https://habrastorage.org/files/bd6/ea1/e6f/bd6ea1e6f45b45aca7076ad7d8fd3029.png" alt="setup ppbbxx.com domains" align="left"><br>  First you need to create your own server.  To do this, go to the website of the <a href="https://ppbbxx.com/">ppbbxx.com</a> service, go through a simple registration and enter the settings interface. <br><br>  First of all, we will go to the section " <i>Internal network -&gt; Domains</i> " and create our own domain in order not to be limited in the choice of SIP user names.  You can park your domain or create a personal subdomain in one of the service areas. <br>  Next, in the section " <i>Internal network -&gt; Sip Users</i> ", create SIP users and configure some parameters of their clients.  SIP user names can be arbitrary, but since it is more convenient to type numbers on software and hardware phones, we will enter identifiers like 1000@mydomain.ppbbxx.com and the like.  I started 1000, 1001, 1002, 1003. After creating the SIP identifier, you need to remember to click the "Save" button.  If there are no under-filled forms in the settings interface, the system will not swear and will show the change log with the status ‚ÄúDone‚Äù. <br><br>  Next you need to configure the used codecs and encryption methods.  To do this, click the gear icon to the left of the SIP identifier.  I plan to use the SIP client (CSipSimple) on the smartphone and I want to use the ZRTP encryption method, so in the " <i>basic</i> " settings tab I select the G729 and SILK codecs, and in the " <i>protection</i> " tab the ZRTP method. <br><br><img src="https://habrastorage.org/files/3b9/4ec/639/3b94ec63938f491fa351a4682a6415a0.png" alt="ppbbxx.com user SIP settings" align="left"><br>  You can choose other options.  It is only important to note that the settings for the SIP account in the service interface <b>must match the</b> settings in the SIP client.  This is necessary to ensure correct communication between clients with different codec and encryption settings.  Just do not forget to save the created configuration. <br><br>  In general, for setting up the simplest configuration, this is sufficient.  You can configure SIP clients and make calls between them by dialing their numbers 1000, 1001, 1002, 1003. If you wish, you can add a common SIP gateway for calls to the telephone network and set up the appropriate call routing.  But, in this case, this is already a slightly different scheme of using the service, which requires rather a different kind of security measures than encrypting traffic to the gateway. <br><br><h2>  Let's move on to setting up SIP clients </h2><br>  As I said, I plan to use CSipSimple on Android smartphones.  First of all, you need to install the client using the standard Play Market, or download it on <a href="https://code.google.com/p/csipsimple/">the manufacturer‚Äôs website</a> , which, by the way, opens the source code of its client, which in some cases may be of almost sacred significance.  You need to install the client itself and additional codecs.  I have ‚ÄúCSipSimple‚Äù, ‚ÄúCodec Pack for CSipSimple‚Äù and ‚ÄúG729 codec for CSipSimple‚Äù installed.  The latter is paid and it is not necessary to use it, free SILK and OPUS provide decent quality calls over 3G networks. <br><br>  Launch CSipSimple and go to the configuration interface.  We select the master "Basic" and set up using data from the web interface.  It should turn out like this: <br><img src="https://habrastorage.org/files/358/287/3e0/3582873e012848758dd3dda81faea7a4.png" alt="image" align="left"><img src="https://habrastorage.org/files/95c/9b9/952/95c9b995214a473bb3a50e97d409709f.png" alt="image" align="left"><br>  Next, in the general settings of CSipSimple in the section " <i>Media -&gt; Audio</i> Codecs" you need to select your preferred codecs.  For calls over 3G, I recommend using SILK, OPUS, iLBC, G729.  Since the settings in the server interface and in the client interface <b>should match</b> , and on the server I chose SILK and G729, I tick the CSipSimple audio codecs in the list of checkboxes just opposite these codecs, and remove the rest. <br>  In the client section " <i>Network -&gt; Secure Protocol</i> " you need to select the desired encryption settings.  I only include ZRTP.  I leave the rest off.  If you wish, you can use SIP \ TLS - you need to consider that the server expects TLS connections on port 443.  This is done specifically for too smart mobile operators blocking standard VoIP ports. <br>  It is also necessary to take into account that SRTP and ZRTP are not always compatible and it is highly desirable to choose only one of them in the client. <br><br><h2>  Making calls using ZRTP </h2><br>  After all the settings are made, we will make several calls in order to demonstrate the work of CSipSimple in calls between users with different security settings. <br><br>  Immediately after the execution of the instruction, the SIP call of the user 1001 to the user 1000 will look like this. <br><img src="https://habrastorage.org/files/fab/7ec/6ad/fab7ec6adb3a4cc4baf42ce5cf8f1fbe.png" align="right"><img src="https://habrastorage.org/files/094/cd3/f1b/094cd3f1b036456090e55f879b44eb9c.png" align="right">  CSipSimple shows that a MitM server is participating in the call, to which both clients are connected.  The EC25 parameter means that the Diffie-Hellman protocol is used on elliptic curves with the 256-bit parameter.  AES-256 is a symmetric encryption algorithm that is applied.  ZRTP status - Verifyed means that the SAS check string has been verified by the user. <br clear="all"><br><br><img src="https://habrastorage.org/files/e75/ce8/2f8/e75ce82f81ae46ae8496fd42003bdfd2.png" align="right"><img src="https://habrastorage.org/files/e7c/910/9a6/e7c9109a66ed4a5093f1c94052b81de1.png" align="right">  Change the media transfer mode in the ppbbxx settings for both clients.  Setting direct media = yes allows you to transmit voice directly.  In this case, the parties see the same SAS lines, the Twofish-256 symmetric encryption algorithm is used.  Using ZRTP in this mode requires much more compatibility from the client and is less reliable from the point of view of establishing a connection, since the server does not participate in data transfer.  Be sure to use the same audio codecs on all clients and the correct operation of NAT. <br clear="all"><br><br><img src="https://habrastorage.org/files/1be/dcf/517/1bedcf51799c48c3b5cd955ded39cea7.png" align="right"><img src="https://habrastorage.org/files/ee4/697/c98/ee4697c987604f7c93f2a9f911fee379.png" align="right">  If the SIP user 1001 does not have encryption installed, while 1000 uses ZRTP, then the second client will show that the encrypted voice transfer only takes place to the server (End at MitM). <br clear="all"><h3>  We summarize </h3><br>  Communication is completely protected from listening, you can organize.  This is not difficult to do.  The most appropriate way to do this is using the SIP IP telephony protocol and the ZRTP media encryption method.  The <a href="https://ppbbxx.com/">ppbbxx.com</a> service allows <a href="https://ppbbxx.com/">you</a> to put into practice various schemes for listening-protected communications, including without the ability to decrypt negotiations on the switch.  CSIPSimple SIP client is an open project and has a sufficient set of functions to use it as a secure client. </div><p>Source: <a href="https://habr.com/ru/post/253073/">https://habr.com/ru/post/253073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253051/index.html">Creating objects inherited from null on Node.js</a></li>
<li><a href="../253053/index.html">Computer graphics, online course</a></li>
<li><a href="../253063/index.html">Our experience using AWS at launch</a></li>
<li><a href="../253067/index.html">Phase AC load control with FLProg</a></li>
<li><a href="../253069/index.html">Old school, hardcore, AY-3-8912. "Iron" chiptune with sequential input</a></li>
<li><a href="../253075/index.html">Goodbye MongoDB Hello PostgreSQL</a></li>
<li><a href="../253077/index.html">Metaperators X and Z in Perl 6</a></li>
<li><a href="../253079/index.html">Create a fully automatic farm.</a></li>
<li><a href="../253081/index.html">5 functions of the Console object that you did not know about</a></li>
<li><a href="../253083/index.html">Use our programs fun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>