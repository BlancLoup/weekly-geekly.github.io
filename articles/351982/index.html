<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Matthias Noback on Ideal Architecture - Layers, Ports, and Adapters (Part 2 - Layers)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2017, Matthias Noback (by A year with Symfony ) published a cycle of three articles in which he described his views on the ideal corporate applicat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Matthias Noback on Ideal Architecture - Layers, Ports, and Adapters (Part 2 - Layers)</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>In 2017, Matthias Noback (by <a href="https://leanpub.com/a-year-with-symfony">A year with Symfony</a> ) published a cycle of three articles in which he described his views on the ideal corporate application architecture that had been formed over many years of practice. The first part is introductory and does not represent much interest (you can read the <a href="https://matthiasnoback.nl/2017/07/layers-ports-and-adapters-part-1-introduction/">original</a> ) .</em>  <em>The second translation is this article.</em>  <em>Translation of the third will be available soon.</em> </p><br><p>  For me, one of the mandatory requirements for a ‚Äúclean‚Äù architecture is the intelligent separation of application code into <em>layers</em> .  The layer itself does nothing, the whole point is in how it is used and what restrictions are imposed on the components that belong to it.  Let's philosophize a little before considering the final practical techniques. </p><a name="habracut"></a><br><h2 id="zachem-nuzhny-sloi">  Why layers are needed </h2><br><ul><li>  Layers help to hide / protect what is under them.  You can perceive the layer as a filtering barrier: the data transmitted through it must be validated before proceeding to the next.  They should be brought to a format that will allow other layers to work correctly with them.  The layer also determines which data and functions from the deeper layer can be used in the outer. </li><li>  Layers clearly delineate responsibility, and therefore the location of classes in your code.  If you achieve strict agreements within your team, about which layers are used in your application and what each of them will answer, then it will always be easy to find the right class or decide where to add a new one, just knowing its purpose. </li><li>  Through the use of layers, you can freely change the priority and order of stages of application development.  You can develop a project sequentially, starting from the core of business logic, applying layer upon layer to it.  Or you can invert the process and start by developing a user interaction layer.  This item is quite important for us, because thanks to it you can develop most of the application before deciding on the used ORM, database, framework, etc. </li><li>  A large number of old software contains code that is not divided into layers, which can be called "spaghetti" code: you can call and use whatever you want, any methods and structures in any part of the project.  Using a system of layers (in the right way) you can achieve a high level of <em>separation of concerns</em> .  If you document these rules and monitor their compliance with the code review, then you will greatly reduce the rate at which your project rolls to the rank. <del>  gavnokod </del>  "technical debt" </li><li><p>  You, of course, write tests.  The competent designed system of layers, incredibly simplifies testing.  Different types of tests are suitable for code from different layers.  The purpose of each test becomes more obvious.  The test suite as a whole becomes more stable and faster. </p><br><p>  However, we have a panic from Twitter: <br><img src="https://habrastorage.org/webt/ks/zl/hy/kszlhy6tupgdethsfdk-p_feejc.png"><br>  <em>OOP version of the spaghetti code is a climbing code, with an overabundance of layers.</em> </p><br></li></ul><br><p>  Personally, I have never met code-lasagna, but I have seen a lot of pods.  The truth happened that I wrote code in which I made serious architectural errors and incorrectly divided the application into layers, which brought some problems.  In this article, I describe, in my opinion, the best set of layers, most of which are described in the book Vaughn Vernon "Implementing Domain-Driven Design" (link below).  Please note that the layers do not have a tight binding to DDD, although they make it possible to create pure domain models, if desired by the developer. </p><br><h2 id="struktura-direktoriy-i-neymspeysov">  Directory and Namespaces Structure </h2><br><p> Inside <code>src/</code> I have directories for each context ( <a href="https://martinfowler.com/bliki/BoundedContext.html">Bounded Context</a> ), for example, which I highlight in my application.  Each of them also serves as the root namespace for the classes belonging to it. </p><br><p>  Within each context, I create directories for each of the layers: </p><br><ul><li>  Domain </li><li>  Application </li><li>  Infrastructure </li></ul><br><pre> <code class="hljs pgsql">src/ {BoundedContext}/ <span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>/ Model/ Application/ Infrastructure/</code> </pre> <br><p>  I will briefly describe each of them. </p><br><h2 id="sloy-1---domenmodelyadro">  Layer 1 - Domain (model / core) </h2><br><p>  Domain layer contains classes for known DDD types / patterns: </p><br><ul><li>  Entities </li><li>  Value objects </li><li>  Domain events </li><li>  Repositories </li><li>  Domain services </li><li>  Factories </li><li>  ... </li></ul><br><p>  Inside the Domain folder, I create a Model subfolder, inside it ‚Äî directories for each of the aggregates (Aggregate root).  The folder with the unit contains all the related items (value objects, domain events, repository interfaces, etc.) </p><br><p>  Please note that the code from the domain layer does not come into contact with the real world.  And if it were not for the tests, then no one could refer to his objects directly (this is done through the upper layers).  Tests for the domain model should be extremely modular.  Since the domain layer does not interact directly with the file system, network, database, etc., we get stable, independent, clean and fast tests. </p><br><h2 id="sloy-2---obyortka-dlya-domena-prikladnoy-sloy">  Layer 2 - (domain wrapper): Application layer </h2><br><p>  The application layer contains classes of <em>commands</em> and their <em>handlers</em> .  A command is an indication of something that needs to be executed. This is a normal DTO (Data Transfer Object) containing only primitive values.  There should always be a command handler that knows how to execute a particular command.  Usually the command handler (also called the <em>application service</em> ) is responsible for all the necessary interactions ‚Äî it uses the data from the command to create (or retrieve from the base) an aggregate, performs some operations on it, can save the aggregate after that. </p><br><p>  The code for this layer can also be covered by the unit tests, but at this stage you can start writing and accepting.  Here is a good article on this topic <a href="http://stakeholderwhisperer.com/posts/2014/10/introducing-modelling-by-example">Modeling by Example</a> from Konstantin Kudryashov. </p><br><h2 id="sloy-3obertka-dlya-prikladnogo---infrastruktura">  Layer 3 (application wrapper) - Infrastructure </h2><br><p>  The code written in the previous layer is also not called by anyone except tests.  And only after adding the infrastructure layer, the application becomes really usable. </p><br><p>  The infrastructure layer contains the code necessary for the application to interact with the real world ‚Äî users and external services.  For example, a layer may contain code for: </p><br><ul><li>  Works with HTTP </li><li>  Communication with the database </li><li>  Emailing </li><li>  Sending a push </li><li>  Getting time </li><li>  Random Number Generation </li><li>  Etc </li></ul><br><p>  The code of this layer should be covered with integration tests (in the terminology of <a href="http://www.natpryce.com/articles/000772.html">Freeman and Pryce</a> ).  Here you are testing everything for real - a real base, a real vendor code, real external services.  This makes it possible to verify the performance of those things that are not under your control but are used in your application. </p><br><h2 id="freymvorki-i-biblioteki">  Libraries and Libraries </h2><br><p>  All frameworks and libraries interacting with the outside world (file system, network or base) must be called in the infrastructure layer.  Of course, the domain code and application layer often needs the functionality of the ORM, HTTP client, etc.  But he should use it only through more abstract dependencies.  As required by the <em>rule of dependencies</em> . </p><br><h2 id="pravilo-zavisimostey">  Dependency rule </h2><br><p>  The dependency rule (formulated by Robert C. Martin in <a href="https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a> ) states that at each application layer you should depend only on the code of the current or deeper layer.  This means that the domain code depends only on itself, the application layer code depends on its code or domain, and the code of the infrastructure layer may depend on everything.  Following this rule, it is impossible to make a dependence on the code from the infrastructural domain layer. </p><br><p>  But blindly follow any rule, not understanding what its true meaning is - this is a rather stupid idea.  So why should you use the dependency rule?  By following this rule, you ensure that the clean code of the layers of the application and domain layers will not be tied to a ‚Äúdirty‚Äù, unstable and unpredictable infrastructure code.  Also, by applying the dependency rule, you can replace anything in the infrastructure layer without touching or changing the code of the more spongy layers, which gives us rich opportunities for rotation and portability of components. </p><br><p>  This way of reducing the connectivity of modules is known for a long time as <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">Dependency Inversion Principle</a> - the letter "D" in SOLID formulated by Robert Martin: "The code should depend on abstractions, not on implementations."  The practical implementation in most oop languages ‚Äã‚Äãis to select a public interface for all things that you can depend on (the interface will be an abstraction) and create a class that implements this interface.  This class will contain details that do not matter for the interface, hence this class will be the implementation, which is referred to in the inversion principle. </p><br><h2 id="arhitektura-otsrochka-tehnologicheskih-resheniy">  Architecture: delaying technology solutions </h2><br><p>  Using the proposed set of layers along with the dependency rule, you can get a lot of buns during development: </p><br><ul><li>  You can experiment a lot before making such important decisions as, for example, the ‚Äúused DBMS‚Äù.  You can also safely use different databases for different cases as part of working with the same model. </li><li>  You can postpone the decision on the framework used.  This will not allow you to become a ‚Äúsymfony application‚Äù or ‚ÄúLaravel project‚Äù at the very beginning of development. </li><li>  The frameworks and libraries will be placed at a safe distance from the model code.  This will be of great help when updating major versions of these frameworks and libraries.  It will also allow minimizing code changes and labor costs if you ever want to use, for example, Symfony 3 instead of Zend Framework 1. </li></ul><br><p>  All this looks extremely tempting: I like the possibility of a problem-free replacement of application components + I like to make important architectural decisions not before starting the project (based on my past experience and guesses), but when real cases of using different parts of the application begin to clear up, and I have the ability to choose the appropriate solutions based on existing needs. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  As mentioned earlier, this version of the application bundle gets along well with any framework, as its place is clearly defined in the infrastructure layer. </p><br><p>  Some believe that in my version of "too many layers."  I do not understand how 3 layers can be considered too large, but if this confuses you, you can remove the applied one.  You will lose the ability to write acceptance tests (they will become something like system tests - slower and more fragile) and you will not be able to test the same functionality called for example from the web interface and the console command without duplicating the code.  In any case, you will greatly improve the architecture of your project due to the separation of business logic and infrastructure. </p><br><p>  It remains to consider the infrastructure layer in more detail.  So we smoothly move on to the topic of hexagonal architecture (ports and adapters).  But all this, in the next part. </p><br><h3 id="dalneyshee-chtenie">  Further reading </h3><br><ul><li>  <a href="http://www.growing-object-oriented-software.com/">Growing Object-Oriented Software</a> by Steve Freeman and Nat Pryce </li><li>  <a href="https://8thlight.com/blog/uncle-bob/2011/09/30/Screaming-Architecture.html">Screaming Architecture</a> by Robert C. Martin </li><li>  <a href="https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a> by Robert C. Martin </li><li>  <a href="https://vaughnvernon.co/%3Fpage_id%3D168">Implementing Domain-Driven Design</a> , chapter 4: "Architecture" and chapter 9: "Modules", by Vaughn Vernon </li></ul><br><p>  You can also familiarize yourself with <a href="https://github.com/sensiolabs-de/deptrac">Deptrac</a> , a tool that helps you follow the rules for using layers and dependencies. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351982/">https://habr.com/ru/post/351982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351972/index.html">UWP Game: Advanced Splash Screen</a></li>
<li><a href="../351974/index.html">Testing and continuous integration for Ansible roles with Molecule and Jenkins</a></li>
<li><a href="../351976/index.html">FastReport.Mono. Part 1: Run the Web demo report</a></li>
<li><a href="../351978/index.html">Unity posted the original C # code on Github</a></li>
<li><a href="../351980/index.html">FastReport.Mono. Part 2: Web Report in Docker Container</a></li>
<li><a href="../351984/index.html">PHP Digest 127 (March 1 - 25, 2018)</a></li>
<li><a href="../351986/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ307 (March 19 - 25, 2018)</a></li>
<li><a href="../351988/index.html">Uninvented story about performance, reflection and java.lang.Boolean</a></li>
<li><a href="../351990/index.html">Windows Server 2019: Linux and Kubernetes support</a></li>
<li><a href="../351992/index.html">Visualization on the distribution map of votes in Moscow in the presidential elections of 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>