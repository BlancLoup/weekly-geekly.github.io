<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New architecture of Android applications - we try in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. At the last Google I / O, we were finally presented with Google‚Äôs official vision of the architecture of Android applications, as well as libra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New architecture of Android applications - we try in practice</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello.  At the last Google I / O, we were finally presented with Google‚Äôs <a href="https://developer.android.com/topic/libraries/architecture/guide.html">official vision</a> of the architecture of Android applications, as well as libraries for its implementation. <del>  Less than ten years. </del>  Of course, I immediately wanted to try what is offered there. </p><a name="habracut"></a><br><p>  <em>Beware: libraries are in alpha version, therefore we can expect changes breaking compatibility.</em> </p><br><h6 id="lifecycle">  Lifecycle </h6><br><p>  The main idea of ‚Äã‚Äãthe new architecture is the maximum removal of logic from activations and fragments.  The company claims that we must consider these components as belonging to the system and not belonging to the developer‚Äôs area of ‚Äã‚Äãresponsibility.  The idea itself is not new, MVP / MVVP is already actively used at present.  However, interconnection with the life cycles of components has always remained on the conscience of developers. </p><br><p>  Now it is not.  We are presented with the new <a href="https://developer.android.com/reference/android/arch/lifecycle/package-summary.html">android.arch.lifecycle</a> package, which contains the <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html">Lifecycle</a> , <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleActivity.html">LifecycleActivity,</a> and <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleFragment.html">LifecycleFragment</a> classes.  In the near future, it is assumed that all components of the system that live in a certain life cycle will provide Lifecycle through the implementation of the <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html">LifecycleOwner</a> interface: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleOwner</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Lifecycle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLifecycle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Since the package cannot be mixed with the stable version in the alpha version and its API, the LifecycleActivity and LifecycleFragment classes have been added.  After the package is transferred to a stable state, LifecycleOwner will be implemented in Fragment and AppCompatActivity, and LifecycleActivity and LifecycleFragment will be removed. </p><br><p>  The lifecycle contains the current state of the component life cycle and allows <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleObserver.html">LifecycleObserver to</a> subscribe to life cycle transition events.  Good example: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyLocationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleObserver</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Lifecycle lifecycle;  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyLocationListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Lifecycle lifecycle, Callback callback)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lifecycle = lifecycle; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lifecycle.addObserver(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">// -   }  @OnLifecycleEvent(Lifecycle.Event.ON_START)  void start() {    if (enabled) {      //        }  }  public void enable() {    enabled = true;    if (lifecycle.getState().isAtLeast(STARTED)) {      //    , //        }  }  @OnLifecycleEvent(Lifecycle.Event.ON_STOP)  void stop() {    //      } }</span></span></code> </pre> <br><p>  Now we just need to create a MyLocationListener and forget about it: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyLocationListener locationListener; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); locationListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLocationListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getLifecycle(), location -&gt; { <span class="hljs-comment"><span class="hljs-comment">//  , ,    }); // -     Util.checkUserStatus(result -&gt; { if (result) { locationListener.enable(); } }); } }</span></span></code> </pre> <br><h6 id="livedata">  Livedata </h6><br><p>  <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html">LiveData</a> is an analogue of Observable in rxJava, but aware of the existence of the Lifecycle.  LiveData contains a value, each change of which comes to the browsers. </p><br><p>  Three main LiveData methods: </p><br><p>  setValue () - change the value and notify the browsers; <br>  onActive () - at least one active observer has appeared; <br>  onInactive () - no more active browsers. </p><br><p>  Therefore, if LiveData does not have active browsers, you can stop updating the data. </p><br><p>  An active observer is one whose Lifecycle is in the STARTED or RESUMED state.  If a new active observer joins LiveData, it immediately gets the current value. </p><br><p>  This allows you to store an instance of LiveData in a static variable and subscribe to it from UI components: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationLiveData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LiveData</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Location</span></span></span><span class="hljs-class">&gt; </span></span>{  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocationManager locationManager;  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SimpleLocationListener listener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleLocationListener() {    <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLocationChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Location location)</span></span></span><span class="hljs-function"> </span></span>{      setValue(location);    }  };  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LocationLiveData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{    locationManager = (LocationManager) context.getSystemService(        Context.LOCATION_SERVICE);  }  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{    locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, listener);  }  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onInactive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{    locationManager.removeUpdates(listener);  } }</code> </pre> <br><p>  Let's make the usual static variable: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LiveData&lt;Location&gt; locationLiveData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocationLiveData(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LiveData&lt;Location&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationLiveData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> locationLiveData; } }</code> </pre> <br><p>  And we will subscribe to a location change, for example, in two activations: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity1); getApplication().getLocationLiveData().observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, (location) -&gt; { <span class="hljs-comment"><span class="hljs-comment">// do something }) } } public class Activity2 extends LifecycleActivity { @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity2); getApplication().getLocationLiveData().observe(this, (location) -&gt; { // do something }) } }</span></span></code> </pre> <br><p>  Notice that the observe method takes the first parameter of LifecycleOwner, thereby associating each subscription with the lifecycle of a specific activity. </p><br><p>  As soon as the life cycle of the activation goes into the DESTROYED subscription is destroyed. </p><br><p>  The advantages of this approach are: there is no spaghetti from the code, there are no memory leaks and the handler will not be called for a dead activit. </p><br><h6 id="viewmodel">  Viewmodel </h6><br><p>  <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html">ViewModel</a> is a data store for a UI that can survive the destruction of a UI component, for example, a configuration change (yes, MVVM is now the officially recommended paradigm).  The newly created activation reconnects to the previously created model: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyActivityViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MutableLiveData&lt;String&gt; valueLiveData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutableLiveData&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LiveData&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValueLiveData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> valueLiveData; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleActivity</span></span></span><span class="hljs-class"> </span></span>{ MyActivityViewModel viewModel; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity); viewModel = ViewModelProviders.of(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).get(MyActivityViewModel.class); viewModel.getValueLiveData().observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, (value) -&gt; { <span class="hljs-comment"><span class="hljs-comment">//     }); } }</span></span></code> </pre> <br><p>  The parameter of the method determines the scope of the model instance.  That is, if the same value is passed in of, then the same instance of the class will return.  If there is no instance yet, it will be created. </p><br><p>  As a scope, you can pass not just a link to yourself, but something more cunning.  Currently, three approaches are recommended: </p><br><ol><li>  activates itself; </li><li>  the fragment transfers itself; </li><li>  The fragment transmits its activation. </li></ol><br><p>  The third method allows you to organize data transfer between fragments and their activation through a common ViewModel.  That is, it is no longer necessary to make any arguments for the fragments and special interfaces for the activation.  Nobody knows anything about each other. </p><br><p>  After the destruction of all components to which the model instance is attached, the onCleared event is triggered and the model is destroyed. </p><br><p>  <em>Important point: since the ViewModel generally does not know how many components the same model instance uses, we should not in any case keep a reference to the component inside the model.</em> </p><br><h6 id="room-persistence-library">  Room Persistence Library </h6><br><p>  Our happiness would be incomplete without the ability to save data locally after the application‚Äôs untimely death.  And here SQLite available out of the box is in a hurry.  However, the database API is rather inconvenient, mainly because it does not provide a way to check the code during compilation.  We learn about typos in SQL expressions when the application is executed and it‚Äôs good, if not from the client. </p><br><p>  But this remained in the past - Google presented us an <a href="https://developer.android.com/topic/libraries/architecture/room.html">ORM library</a> with static analysis of SQL expressions during compilation. </p><br><p>  We need to implement at least three components: <a href="https://developer.android.com/reference/android/arch/persistence/room/Entity.html">Entity</a> , <a href="https://developer.android.com/reference/android/arch/persistence/room/Dao.html">DAO,</a> and <a href="https://developer.android.com/reference/android/arch/persistence/room/Database.html">Database</a> . </p><br><p>  An entity is one entry in the table: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(tableName = ¬´users¬ª) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> userId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String userName; }</code> </pre> <br><p>  DAO (Data Access Object) - a class that encapsulates work with records of a specific type: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDAO</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span>(onConflict = REPLACE) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span>(onConflict = REPLACE) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User‚Ä¶ users)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Delete</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User‚Ä¶ users)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(¬´SELECT * FROM users¬ª) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LiveData&lt;List&lt;User&gt;&gt; getAllUsers(); <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(¬´SELECT * FROM users WHERE userId = :userId LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span>¬ª) <span class="hljs-function"><span class="hljs-function">LiveData&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(¬´SELECT userName FROM users WHERE userId = :userId LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span>¬ª) <span class="hljs-function"><span class="hljs-function">LiveData&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId)</span></span></span></span>; }</code> </pre> <br><p>  Note the DAO interface, not the class.  Its implementation is generated at compilation. </p><br><p>  The most amazing thing, in my opinion, is that the compilation falls if an expression is sent to <a href="https://habrahabr.ru/users/query/" class="user_link">Query</a> that refers to non-existing tables and fields. </p><br><p>  As an expression in <a href="https://habrahabr.ru/users/query/" class="user_link">Query,</a> you can pass, including table joins.  However, the Entity themselves cannot contain field-references to other tables, this is due to the fact that lazy (lazy) data loading when accessing them will start in the same stream and surely it will turn out to be a UI-stream.  Therefore, Google has decided to ban this practice completely. </p><br><p>  It is also important that as soon as any code changes an entry in the table, all LiveData, including this table, transmit the updated data to their observers.  That is, the database in our application is now "ultimate truth."  This approach allows you to finally get rid of the inconsistency of data in different parts of the application. </p><br><p>  Not only that, Google promises us that in the future, change tracking will be executed line by line, and not as it is now. </p><br><p>  Finally, we need to set the database itself: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Database</span></span>(entities = {User.class}, version = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppDatabase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomDatabase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> UserDAO </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDao</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  It also uses code generation, so we write the interface, not the class. </p><br><p>  Create a singleton base in the Application class or in the Dagger module: </p><br><pre> <code class="java hljs">AppDatabase database = Room.databaseBuilder(context, AppDatabase.class, <span class="hljs-string"><span class="hljs-string">"data"</span></span>).build();</code> </pre> <br><p>  We get DAO from it and you can work: </p><br><pre> <code class="java hljs">database.userDao().insertUser(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(‚Ä¶));</code> </pre> <br><p>  At the first access to the DAO methods, the automatic creation / re-creation of the tables is performed or the SQL scripts for updating the schema are executed, if specified.  Schema update scripts are specified using Migration objects: </p><br><pre> <code class="java hljs">AppDatabase database = Room.databaseBuilder(context, AppDatabase.class, <span class="hljs-string"><span class="hljs-string">"data"</span></span>) .addMigration(MIGRATION_1_2) .addMigration(MIGRATION_2_3) .build(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Migration MIGRATION_1_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">migrate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SupportSQLDatabase database)</span></span></span><span class="hljs-function"> </span></span>{ database.execSQL(‚Ä¶); } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Migration MIGRATION_2_3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) { ‚Ä¶ }</code> </pre> <br><p>  Plus, don't forget to specify the current version of the schema in the annotation from AppDatabase. </p><br><p>  Of course, the SQL schema update scripts should be just strings and should not rely on external constants, since after some time the table classes will change significantly, and old DB versions should still be updated without errors. </p><br><p>  At the end of the execution of all scripts, an automatic check is performed for the correspondence between the base and the Entity classes, and Exception is thrown if there is a mismatch. </p><br><p>  <em>Caution: If it was not possible to create a chain of transitions from the actual version to the last, the base is deleted and recreated.</em> </p><br><p>  In my opinion, the algorithm for updating the scheme has flaws.  If you have an outdated database on your device, it will be updated, everything is fine.  But if there is no database, and the required version is&gt; 1 and some Migration set is specified, the database will be created based on Entity and Migration will not be executed. <br>  We are kind of hinting that in Migration there can only be changes in the structure of tables, but not filling them with data.  This is regrettable.  I guess we can expect improvements to this algorithm. </p><br><h6 id="chistaya-arhitektura">  Pure architecture </h6><br><p>  All of the above entities are building blocks of the proposed new application architecture.  It should be noted, Google does not write clean architecture anywhere, this is a certain liberty on my part, but the idea is similar. <br><img src="https://habrastorage.org/web/a65/9f2/798/a659f27988da4839a75fff66aed56c22.png" alt="image"><br>  No entity knows anything about the entities above it. </p><br><p>  Model and Remote Data Source are responsible for storing data locally and querying them over the network, respectively.  Repository manages caching and combines individual entities in accordance with business tasks.  The Repository classes are just some kind of abstraction for developers, no special base class Repository exists.  Finally, the ViewModel integrates different Repository in a form suitable for a particular UI. </p><br><p>  Data between layers is transmitted via LiveData subscriptions. </p><br><h6 id="primer">  Example </h6><br><p>  I wrote a small demo application.  It shows the current weather in a number of cities.  For simplicity, the list of cities is set in advance.  The data provider is the <a href="http://openweathermap.org/">OpenWeatherMap</a> service. </p><br><p>  We have two fragments: with a list of cities (CityListFragment) and with the weather in the selected city (CityFragment).  Both fragments are in the MainActivity. </p><br><p>  Activations and fragments use the same MainActivityViewModel. </p><br><p>  MainActivityViewModel requests data from WeatherRepository. </p><br><p>  WeatherRepository returns old data from the database and immediately initiates a request for updated data over the network.  If the updated data is successfully received, it is saved to the database and updated by the user on the screen. </p><br><p>  To work correctly, you must register the API key in WeatherRepository.  The key can be taken free of charge after registering with the OpenWeatherMap. </p><br><p>  Repository on <a href="https://github.com/SergeyVinyar/AndroidNewArchitectureExample">github</a> . </p><br><p>  Innovations look very interesting, but the impulse to redo everything is still worth it.  Do not forget that this is only alpha. </p><br><p>  Comments and suggestions are welcome.  Hooray! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/329990/">https://habr.com/ru/post/329990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329980/index.html">"Confrontation" PHDays VII: Beginners are lucky or rob banks, break GSM</a></li>
<li><a href="../329982/index.html">Determining the number of a Telegram user using brute force in the address book</a></li>
<li><a href="../329984/index.html">Chronicles of Confrontation: how to hack the whole city in two days</a></li>
<li><a href="../329986/index.html">Unequal battle: CRM vs. Excel</a></li>
<li><a href="../329988/index.html">Yes, Python is slow, but I don't care</a></li>
<li><a href="../329992/index.html">Article translation: Best Practice for Creating Git Commit from OpenStack</a></li>
<li><a href="../329994/index.html">BI.ZONE Announces CTFzone Presidential Election</a></li>
<li><a href="../329996/index.html">Simple React Router v4 Tutorial</a></li>
<li><a href="../329998/index.html">Quest from EPAM: Five Tasks from .NET Interviews</a></li>
<li><a href="../330000/index.html">‚ÄúThe lifetime of a tab can be almost endless‚Äù: Timofey Chaptykov about JS development on VKontakte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>