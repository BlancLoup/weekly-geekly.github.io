<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Snapshots - "photo memory (disk;)"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is always strange to imagine a time when something was not there. It is difficult today to imagine how we lived without personal computers, without...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Snapshots - "photo memory (disk;)"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/c4/2c/c42ce73f8ab25cd010ba6d3aeaef7065.jpg" alt="image"><br><br>  It is always strange to imagine a time when something was not there.  It is difficult today to imagine how we lived without personal computers, without the Internet, without torrents, mp3, or without electric copiers, in common parlance "xeroxes".  Nevertheless, there have always been times when something familiar did not exist to us.  It was also the case with the notion of "data snapshot".  But first - what is a "snapshot"? <br><br>  " <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25BE%25D0%25BA_%25D1%2584%25D0%25B0%25D0%25B9%25D0%25BB%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B9_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D1%258B">Snapshot</a> " (literally - "photo", "snapshot", hereinafter, we will understand this word specifically, without specifying "data snapshot") is a snapshot of the state of data in the storage system, or program, fixed for a certain moment of time.  This may be the instantaneous state of the contents of a file, database, or file system (as a special case of a ‚Äúdatabase‚Äù). <br>  As applied to storage systems, this term <a href="http://blog.aboutnetapp.ru/archives/39">appeared along with the first NetApp storage systems</a> and was, at that time, the first and main feature of them. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Earlier, I already talked about the <a href="http://habrahabr.ru/company/netapp/blog/99832/">internal WAFL file structure</a> invented by NetApp founders for my product, and how it works.  Those interested in technical details will refer to the beautiful author's publication, which is now <a href="http://www.netwell.ru/docs/netapp/wp3002_wafl.pdf">translated into Russian</a> .  It is this, somewhat unusual, at first glance, according to the principles of operation, the file structure made it possible to implement the concept of snapshots - instant copies of the state of the data stored on the disks of such a system. <br><br>  As I already told in the <a href="http://habrahabr.ru/company/netapp/blog/99832/">article about WAFL</a> , the basic principle of its work is that once the data recorded on the disk, in the future, does not change.  Data (for example, a file) can be either recorded on WAFL (entirely) or erased (entirely).  If it is necessary to change its contents, these changes are "added" to the free space of disk space, after which the file content pointer is moved to blocks with recorded changes (the old content block is marked as free, or is not marked if more than one file references it) or it is used in snapshot).  Therefore, in order to preserve the current state of the data, with such an algorithm for the recording operation, all we need is to save the ‚Äúroot inode‚Äù at the given time. <br><br><img src="https://habrastorage.org/storage/habraeffect/6d/33/6d336e902413ec46b8a1374d540a509f.gif" alt="image"><br><br>  Inode, I remind you, this is a data block that defines the contents of the file.  It can refer either directly to specific blocks, or, for large files, to intermediate inodes, forming a "tree" from the "root", the only volume on the entire file system, the so-called "root" inode. <br>  Thus, having created a copy of exactly one block, the root inode of the given file system, we get, turning to it, instead of the current root, a ‚Äúpseudo-file system‚Äù that stores all data unchanged (read-only) at the time when we copied this inode.  After all, as you remember, once recorded data blocks of files are not changed in the future. <br><br><img src="https://habrastorage.org/storage/habraeffect/22/4f/224f25a5a3ebc5f5873748850342fae7.png" alt="image"><br><br>  How does this look in practice? <br>  To simplify the story, I will look at the NAS version of NetApp, although, as you know, the same way can work the same way <a href="http://habrahabr.ru/company/netapp/blog/105936/">as a SAN device</a> . <br><br>  Each volume on a NetApp storage system is a separate file system.  Up to 254 snapshots of its state can be created on each file system, as described above. <br>  All created snapshots are automatically accessible via the <i>/.snapshot</i> (or <i>/ ~ snapshot</i> ) directory in the volume root.  When we go there, we will see the names of the created snapshots (they can either have their own name, for example " <i>/ lets_fix_this_small_bug ... oh_shit! ..</i> ", being manually created, or, if created on a schedule, will be located in the subdirectories <i>hourly.0 (1, 2.3 ...)</i> , <i>daily.0 (1,2,3)</i> and so on. <br><br><img src="https://habrastorage.org/storage/habraeffect/32/27/3227799262492ca7e53ab4ec5274417e.jpg" alt="image"><br><br>  Entering such a folder, we will see the entire contents of our volume, with all the files in it, all the files will be readable, and all the content that was in them at the time of the snapshot will be read. <br><br><img src="https://habrastorage.org/storage/habraeffect/a0/26/a02692251530fbc1007c24aa90e24d83.gif" alt="image"><br><br>  And it even looks a bit strange, at first glance. <br>  Suppose you have a 1TB volume that holds a 750GB database file.  For this volume, you create snapshots every hour on a schedule.  When you <i>enter /.snapshot,</i> you will see the <i>/hourly.0, /hourly.1</i> , and so on subdirectories in it <i>,</i> each of which will contain a ‚Äú <i>750GB</i> file‚Äù.  In this case, on the actual volume, with a capacity of 1TB, on which these 24 (every hour) copies of the base of 750 gigabytes each are located, there will still be 200 gigabytes of free space. <br>  At the same time, we can copy any of these 24 ‚Äúfiles‚Äù to a backup copy on external storage, mount it as an independent read-only and use (read) this data, as if it were a real database, recover data from it, copying it to a place of "active", for example, in the case of "everything is broken, it is necessary to roll back an hour ago," and so on. <br><br>  Where is it all stored? <br>  The fact is that all these ‚Äúfiles‚Äù are simply links to the same blocks of unchanged data.  The disk space is occupied only by changes, between the snapshots taken.  Suppose that in 24 hours we replaced 50 gigabyte blocks in this database.  Then the occupied space on the disks, in the volume of 1TB, on which the 750GB base file resides, and the snapshots every hour, will be 1TB - 750GB file - 50GB of changes = 200GB free. <br>  If the changes in an hour between two <i>snapshots</i> ( <i>hourly.0</i> and <i>hourly.1</i> ) turned out to be 1% of the base volume, then hourly.1 will occupy 7.5GB of disk space, indicating by its inodes the blocks that have been changed compared to the previous snapshot.  All the other inodes will still refer to the old, unchanged blocks. <br><br>  What is convenient to use snapshots? <br>  I have already cited the simplest example.  Suppose we, or our users, "all broke."  This could be a database, or, let's say, an Excel file, in which, accidentally, the wrong data crashed, we managed to write it down, and then discovered it, and we must urgently restore it, "or they will kill us all."  But we know that an hour (two, three, a day, a week, a month ago, it all depends on the frequency and regularity of the snapshots) the file we need was intact. <br>  We (by the way, even the user himself can do this) simply go to the <i>/.snapshots</i> folder and pull out the file we need, by copying, the right time, hour, two, 24 hours, and so on back. <br>  Or, if we have a special SnapRestore license, with one command from the console, we ‚Äúroll back‚Äù the state of the volume to the right moment in time (which is convenient if you need to restore not a single single file, but the contents of the entire volume, in general). <br><br>  Thus, the snapshots are, for the user, a very real-time backup, available right there, on the same story.  By the way, in case of using Windows XP or 7, you will see the files in the snapshot in the ‚ÄúPrevious versions‚Äù panel of the file or folder properties, NetApp integrates into this Windows mechanism as a VSS-provider. <br><br><img src="https://habrastorage.org/storage/habraeffect/f2/bd/f2bd9a54755dad63a71bbdd53fec7da3.png" alt="image"><br><br>  Now consider a more complex option.  Suppose we exploit a large, responsible, mission-critical SQL database of an enterprise. <br>  Of course, every evening, this database is backed up to tape to create a backup. <br>  The base is large, and the backup is copied to tape for about an hour. <br>  ‚ÄúNothing foreshadowed trouble,‚Äù but once, in the middle of the working day, let's say at 3 o'clock in the afternoon, the base irreversibly deteriorates. <br><br>  What actions does a sysadmin take to restore the base? <br>  We read the backup as of the end of the last working day (it will be read, say, as much as it was written - an hour), and then we should ‚Äúroll‚Äù the redo-log on it, from the moment of the backup creation, in the evening, and until the time before the failure, that is, until 3 o'clock the next day.  This "roll forward" is often quite voluminous, and also takes some time, because operations in SQL do not occur instantaneously.  Suppose that after 30 minutes, after the end of the backup reading, the base is restored to working condition at the time before the failure, and we are ready to continue working.  Total - 1:30. <br><br>  In the case of using snapshots, the case will proceed as follows.  We also make a daily copy to tape to ensure storage safety, for example, in case of a complete failure of the storage system, but our storage is alive, only the data on it is damaged.  We know that an hour ago the base was alive and well.  We restore the database as of 2 pm, and since the snapshot is created and restored almost instantly, it takes not an hour, but only a few seconds, and redo-logs is rolled on it, but not from yesterday evening, as in the previous case, But in just one hour, from 2 o'clock, that is, the moment of creating a snapshot, before the time of the accident, at 3 o'clock in the afternoon.  It also takes not half an hour, but only a few minutes. <br>  Bottom line: after a <b>few minutes</b> , rather than an hour and a half, as usual, our base is again in working condition. <br><br>  The obvious advantages of using snapshots have led to the fact that, today, almost all manufacturers of storage systems offer this or that implementation of snapshots as ideas for their systems. <br>  However, as we remember, "not all <s>yogurts are</s> equally useful." <br><br>  What is the fundamental difference between ‚Äúreal snapshots‚Äù (the name of Snapshots (tm) for storage systems is a registered trademark of NetApp) from all other ‚Äúcounterfeit copies‚Äù.  ;) <br><br>  The principal difference that allows snapshots to be implemented as described above by me is the WAFL device, which, as I have already said, does not allow changing the already recorded data.  This model allows you to implement snapshots easily and simply.  But things are worse if the record structure is traditional.  At the same time, we will first have to allocate the reserved block space before using it, taking it away from the data beforehand, then, each time the block changes on the disk, copy its contents into a special reserved pool, then change its contents to its previous place, then change the metadata pointing to old content for snapshot. <br><br>  This technology is called Copy-on-Write (COW), and is widely used in storage systems of other manufacturers, in their implementation of snapshots. <br>  As you can see from the description above, even the presence of the included snapshot mechanism for a volume turns a single write operation for the storage system into three (reading the original content, writing the original content to a new location, writing the modified content to the old location). <br>  The result is not long in coming.  Using COW-snapshots dramatically affects the performance of the storage system using it.  This is in stark contrast to NetApp systems, in which the snapshots do not affect the performance at all, because no copying takes place when they are written, all data remain in place. <br>  ( <a href="http://partners.netapp.com/go/techontap/matl/spc1.html">demonstration of performance results on the SPC-1 test</a> ) <br><br><img src="https://habrastorage.org/storage/habraeffect/69/ce/69cea19aa172d17e02e311738ae259d7.jpg" alt="image"><br><br>  The consequence of such an unpleasant behavior when using COW-snapshots is the recommendation of vendors to reduce the use of such "wrong snapshots" to a minimum, or not to use them at all on primary-systems that place increased performance requirements. <br>  However, NetApp systems do not suffer from this problem and do not impose any restrictions on the use of snapshots. <br><br>  In addition, often (for the same reason), the total number of snapshots on such systems is limited to just a couple of dozen maximum, I note for contrast that on NetApp systems you can use up to 254 snapshots per volume, with the total number of volumes allowed by the system, equal to 500, reaches a theoretical maximum of 127 thousand. <br>  This allows, when using the classic ‚Äúrotation‚Äù of backups, to store in 254 snapshots backups of volume data up to and including a year. <br><br>  Also important is the ability to create "truly instant" copies of the data, regardless of the size of the "copied" data.  Although the base is 100MB, at least 100TB, the snapshot from it will always be created instantly.  For example, we can create a ‚Äúbackup copy‚Äù not ‚Äúin an hour‚Äù, but ‚Äúin a second‚Äù, and then, without loading our task with a real combat base, slowly copy the contents of such a snapshot to the backup storage. <br><br>  Practice shows that people who have tried the simplicity and ease of use of snapshots very soon simply cannot imagine life without them, considering this to be "taken for granted" by the possibility of any storage system.  Try it and you. <br>  Let me remind you that you can take a NetApp storage system for testing from any partner, a list of which can be viewed on the Russian page of the NetApp website. <br>  <a href="http://www.netapp.com/ru/how-to-buy/resellers/distributor-ru.html">www.netapp.com/ru/how-to-buy/resellers/distributor-ru.html</a> <br>  <a href="http://www.netapp.com/ru/how-to-buy/resellers/platinum-ru.html">www.netapp.com/ru/how-to-buy/resellers/platinum-ru.html</a> <br>  <a href="http://www.netapp.com/ru/how-to-buy/resellers/gold-ru.html">www.netapp.com/ru/how-to-buy/resellers/gold-ru.html</a> <br><br>  PS: On the traditional ‚Äúphoto to attract attention‚Äù in the title - the back of the controller of the youngest NetApp model - FAS2020.  The youngest, but nonetheless, with all the capabilities of NetApp repositories, including working with snapshots. <br>  In the photo, from left to right, there are two FC 4Gb / s ports, a serial console port, an out-of-band port of the microcontroller of remote administration, and two Gigabit Ethernet ports. <br><br>  PPS: You could also write this week about NetApp's 5th place in Fortune's list Best Places to Work, won Intel <i>very proudly</i> on <i>51st</i> place (out of a hundred), but it seemed to me that all these joys of PR department Habra are not very interesting, so I mention this "creeping line" at the very end.  Yes, <b>fifth</b> in the top 100 US employers, and fifteenth (above Google (30) and Apple (20), by the way) according to Glassdoor‚Äôs list, which assesses companies not ‚Äúoutside‚Äù, like Fortune, but from the inside, by anonymous votes of the workers themselves.  "A trifle, but nice." </div><p>Source: <a href="https://habr.com/ru/post/112367/">https://habr.com/ru/post/112367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112357/index.html">UVoiceMe - IP Telephony Gateway Integration Service</a></li>
<li><a href="../112359/index.html">Israeli court also confirmed the legality of the license Creative Commons and condemned its violators</a></li>
<li><a href="../112360/index.html">We draw a Bernstein polynomial for an arbitrary number of reference points.</a></li>
<li><a href="../112362/index.html">Google tightens methods to combat search spam</a></li>
<li><a href="../112363/index.html">In the next five years, Canadians will deploy a global network of satellite Internet access.</a></li>
<li><a href="../112369/index.html">Postfix 2.8.0 stable has been released</a></li>
<li><a href="../112370/index.html">Effective dating</a></li>
<li><a href="../112371/index.html">Syntext Serna Visual XML Editor</a></li>
<li><a href="../112372/index.html">Calendar.rf</a></li>
<li><a href="../112374/index.html">"Passive" electronic keys for cars - not very serious protection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>