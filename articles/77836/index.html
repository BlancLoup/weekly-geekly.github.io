<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cluster Hyper-V 2008 R2 on the knee</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to you, habracheloveki. 

 I think everyone is somehow aware of the recent release of Windows Server 2008 R2 with an upgraded Hyper-V implementa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cluster Hyper-V 2008 R2 on the knee</h1><div class="post__text post__text-html js-mediator-article">  Hello to you, habracheloveki. <br><br>  I think everyone is somehow aware of the recent release of Windows Server 2008 R2 with an upgraded Hyper-V implementation.  The main innovation, relative to the usual 2008 Hyper-V, is the support of Live Migration function for transferring virtual machines between the cluster nodes in real time.  Of course, in order to demonstrate this function, we need an external data storage and a cluster ... and the extra SAN in the storage room usually does not roll. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3a/561/4e7/b3a5614e7323e1306f145aac4f87b8e9.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will tell you how to implement a full-featured Hyper-V 2008 R2 cluster on the iron with handheld - three workstations, two of which support hardware virtualization.  Under the cut instructions for assembling a Hyper-V failover cluster, taking into account the nuances and features, as well as a video demonstration of the Live Migration technology. <br><br><a name="habracut"></a><br><h4>  Introduction </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/113/27d/dcd/11327ddcde6594a981a35e4b90017055.png" alt="image"><br><br>  A brief tour of the technology itself Live Migration.  Its main difference from Quick Migration is to transfer a virtual machine on the fly, without unloading memory onto a disk (this is illustrated by the previous picture).  In addition, according to Microsoft, the transfer of the machine is faster than a TCP session breaks up, so if users experience discomfort, then small. <br><br><h4>  The choice of hardware and software </h4><br>  Of course, I have no excess SAN for testing. <br>  All I have is two Aquarius workstations (C2D 6420, 4Gb DDR2, 80Gb HDD) and one station on Celeron-D. <br>  Of course, all processors should have 64bit support, since 2008 R2 exists only in 64-bit edition. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6a/617/694/e6a6176946bb8473a19786189103b37e.jpg" alt="image"><br><br>  To implement the cluster, I will take the free version of Hyper-V Server 2008 R2, which is a modified Windows Server 2008 R2 in kernel mode, with a default hypervisor enabled and a relatively convenient console menu for centralized management.  The choice is due to the fact that I do not want to spend the resources of the host machine to maintain any other roles other than the hypervisor. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54d/a30/269/54da302690fc4569aec75dccbc2cba76.jpg" alt="image"><br><br>  In the case of using this hypervisor, only virtual machines will be licensed, which we will use to rotate it.  I say this in case someone wants to implement this artisanal system in production. <br><br>  I will use the weakest of my workstations as storage, throwing a couple of 250GB hard drives into it and combining them into software RAID0 using the operating system.  To turn an improvised server into storage, I will use the cheapest possible option - <a href="http://ru.wikipedia.org/wiki/ISCSI">iSCSI</a> .  The same machine will act as a control for the Hyper-V cluster, and at the same time it will be the controller of our small domain. <br><br>  There are several implementations of iSCSI for Windows.  The two most common: <br><ol><li>  <b>Microsoft iSCSI Software Target</b> - comes only in a pair with Windows Storage Server 2008, when buying servers from OEM-partners of Microsoft.  Finding it in the public domain is not so easy, but if someone finds it, he can try.  True, it is put again, exclusively on the Storage Server, which is not very suitable for our needs. </li><li>  <b>StarWind iSCSI Software Target</b> is a product of StarWind company (having a completely unpopular <a href="http://habrahabr.ru/company/starwind/blog/">blog</a> on Habr√©) with support for the Russian language.  StarWind has a <a href="https://www.starwindsoftware.com/download-free-version">free version</a> , limited in storage to 2TB, and two competitive connections to the same target.  And we do not need to check more. </li></ol><br><br>  Our improvised storage will work under the control of a full-featured Windows Server 2008 R2, the version in this case does not matter, but it was found out by experience that managing a cluster from 32-bit systems can cause some problems.  Moreover, in 2008 R2 there is a fresh console Failover Clustering, and in other versions you will have to update the Remote Administration Tools.  Well, do not forget that the machine will also perform the functions of a domain controller. <br><br><h4>  Customization </h4><br><br><h5>  Stage one.  Preliminary </h5><br>  So, we have two clean and unconfigured Hyper-V Server 2008 R2, and one clean Windows Server 2008 R2. <br><br>  Before setting up a cluster, you must configure the network infrastructure to work correctly.  We set all servers local IP-addresses, having previously picked them up in a small switch (like the one on my photo).  We allow remote access to nodes, both through RDP, and through the MMC console. <br><br>  It is better to do this before the nodes are in the domain.  There were situations when the server cursed the impossibility of changing the firewall policies.  We lift the domain and we enter into it our future cluster nodes. <br><br>  Of course, turn on the <b>Failover Clustering Feature</b> . <br><br><h5>  Stage Two.  Storage. </h5><br><br>  Now you can go directly to the configuration of the repository.  To begin with, we divide our resulting stripe (RAID0) into two logical drives - one for the quorum (which is now called <a href="http://technet.microsoft.com/en-us/magazine/2008.07.failover.aspx%3Fpr%3Dblog">File Share Witness</a> ), and the second for storing our virtual machines.  I allocated about 15GB for the quorum, and left everything else for the data.  In a good way - a quorum is more than enough gigabytes, but you never know what. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e8/59d/d14/4e859dd14cbaeb5862752c8ed0f9d3cc.png" alt="image"><br><br>  Go to the installation of StarWind iSCSI Target.  To <a href="https://www.starwindsoftware.com/download-free-version">download from the</a> manufacturer‚Äôs <a href="https://www.starwindsoftware.com/download-free-version">website</a> , registration is required, which, in principle, does not oblige to anything.  After registration, the link to the direct download of the installer and the license key file falls to the email.  The installation consists of several clicks on the Next button, so that there is nothing essentially complex there.  After installation, you must pass ports <b>3260</b> and <b>3261</b> through Windows Firewall.  For the lazy, you can simply turn it off, since there are only three of our servers in our improvised network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/623/c6f/cf4/623c6fcf4d7a0d32fb928ad3e5ba8ca3.png" alt="image"><br><br>  We start the StarWind console and try to connect to the iSCSI server, which in our case is the computer with the mysterious address 127.0.0.1.  For authorization, you need a secret combination of default login and password, which in the basic version look like <b>root</b> and <b>starwind,</b> respectively.  Why not asked to set a password during the installation process, or did not hang up a hint in the interface - a mystery. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b37/9a9/cf5/b379a9cf571379016845aa381563e5de.png" alt="image"><br><br>  After connecting to the server, you need to slip him a file with a license, dropped by e-mail.  This is done in the Configuration tab of the StarWind server console.  Everything is intuitive and simple, except for the link to download the file itself in the upper right corner.  Only after registration, the program will allow us to create a target. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/509/b06/5a8/509b065a8d81e757da9e8fff8cb7db21.png" alt="image"><br><br>  In the process of creating a target, we create pre-marked img files that will play the role of our LUNs.  We place them on our partitions in accordance with the objectives, and do not forget to put a tick in charge of competitive iSCSI connections (i.e. clustering).  You can also set data caching, it will be useful in the case of using our slow hardware. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ca/44e/ab6/4ca44eab634a5326f06118a4d5322511.png" alt="image"><br><br>  As a result, you should get something like the following picture.  Two target - one with a quorum, the second under the data.  It's time to pick them up to the servers. <br><br><h5>  Stage Three.  We cling to the repository. </h5><br><br>  In servers of version 2008 R2, there is already a pre-installed iSCSI Initiator, which is responsible for connecting LUNs from our improvised storage, as local disks.  True, due to the lack of an adequate GUI on the console Hyper-V Server, you will have to call it via the command line or Powershell <b>using the iscsicpl</b> command. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc2/c7a/414/fc2c7a41437c3ce23f953360ba22d4b6.png" alt="image"><br><br>  In the field highlighted in yellow you need to enter the IP address of our repository, after which a pop-up window should appear with the targets placed on the server.  Of course, if the firewall was properly configured or disabled.  After the targets are connected to our server, it will be possible to mount them as disks. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe7/e91/97e/fe7e9197e39d2651f28cfaa77d98491d.png" alt="image"><br><br>  After clicking on Autoconfigure, two long paths to disks starting with \? \ Will appear in the empty window.  After that, you can safely go to Disk Management and set the letters to the disks.  By the way, after setting the letters on the first hypervisor, the second hypervisor picks up the drive names automatically. <br><br>  As a result, we got two hypervisors with two shared disks connected via iSCSI to our storage.  It's time to go directly to clustering. <br><br><h5>  Stage Four.  Clustering </h5><br><br>  When configuring a failover cluster on two existing hypervisors, the wizard itself chose file partitions for quorum and for data.  If I understood the algorithm correctly, iSCSI-connected disks were selected as shared resources, and the smallest one was chosen as the quorum.  Or maybe he chose them because I gave the label Quorum a smaller section ... =) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf0/3ef/dc8/bf03efdc80bfd80619a0ffba9a6a77d1.png" alt="image"><br><br>  After merging the two hypervisors into a cluster, using a wizard and such-and-such mother, the console of the failover cluster will look something like the image above.  It is worth noting that at the moment we have a fault-tolerant cluster in which only one node performs all the work, while the second one is idle at this time and waits until the first one dies.  But we do not need this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cd/2c1/477/2cd2c14774efab9a97fff201dd850141.png" alt="image"><br><br>  Here Cluster Shared Volumes will help us - a new tab in the cluster console, which appeared only in 2008 R2.  It is on this storage that virtual machines can be placed to provide fault tolerance.  Our task is to turn an ordinary cluster resource into a shared one using the magic button ‚ÄúAdd Storage‚Äù.  After the warning that this type of resource works only in versions 2008 R2 and above, our disk will appear in the shared resources tab.  The disk, in turn, will be mounted on <b>C: \ ClusterStorage \ Volume1</b> , so all shared data will be there.  Including virtual machines.  In order to avoid unnecessary glitches, in the settings of hypervisors on each node, I advise you to set default paths for disks and virtual machines, with placement on our shared disk. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0bb/cee/19e/0bbcee19eac6c7c535fc541cd8e3d2bf.png" alt="image"><br><br><h5>  Stage Five.  Virtual machines. </h5><br><br>  Now you can create virtual machines directly from the cluster management snap-in.  In the services tab, select Virtual Machines, select the node and create the machine.  We install the distribution from OS from somewhere, install and unmount it.  For Live Migration to work correctly, you need no dependencies on external resources at each node. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/zUztdkI-quQ%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhgQBHyaKF54ThYo6JNLCOCkW7V8Bg" frameborder="0" allowfullscreen=""></iframe><br><br>  The video shows the process of distilling memory from one node to another.  On the portable virtual machine was the same Windows Server 2008 R2, and the memory of the machine was 1024mb.  Immediately it is worth noting the very mediocre speed of migration, which is associated with the artisanal implementation of our storage and a network of 100 Mbps.  Later I will rebuild the cluster using a gigabit network and look at the performance gains. <br><br>  I hope the article will be useful for someone.  Experiment! </div><p>Source: <a href="https://habr.com/ru/post/77836/">https://habr.com/ru/post/77836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../77831/index.html">Atom feed for Habrahabra sandbox</a></li>
<li><a href="../77832/index.html">CMS for flash sites: FlashMoto CMS</a></li>
<li><a href="../77833/index.html">Kodak Zi8 Camcorder - First Impressions</a></li>
<li><a href="../77834/index.html">Running a virtual machine in VirtualBox without GUI</a></li>
<li><a href="../77835/index.html">How do we give our emails and passwords</a></li>
<li><a href="../77838/index.html">Malware presence detected in the GNOME-Look directory.</a></li>
<li><a href="../77839/index.html">Do you need TK site? (part 1)</a></li>
<li><a href="../77840/index.html">Official desire to introduce censorship in the network, apparently indestructible</a></li>
<li><a href="../77841/index.html">We write a simple console To-do manager in Ruby</a></li>
<li><a href="../77842/index.html">Dock demonstration SVG / SMIL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>