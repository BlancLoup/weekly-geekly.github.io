<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About Garbage Collector, Unity and weak links</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have in my project a certain IT interface and a factory type method 



 interface IT {} public IT CreateT(IA a, IB b, IC c, Type concreteType) { //...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About Garbage Collector, Unity and weak links</h1><div class="post__text post__text-html js-mediator-article"> I have in my project a certain <code>IT</code> interface and a factory type method <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IT</span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateT</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IA a, IB b, IC c, Type concreteType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,     concreteType,      . }</span></span></code> </pre><br><br>  Classes that implement <code>IT</code> have constructors with different signatures that accept some combination of objects of types <code>IA</code> , <code>IB</code> or <code>IC</code> , so as the number of <code>IT</code> implementations <code>IT</code> , their creation code started to smell more and more, and finally, it was decided to throw it away simple code with Unity, something like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateITInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IA a, Type targetType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (UnityContainer cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer()) { cont.RegisterInstance&lt;IA&gt;(a, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); cont.RegisterType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IT), targetType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cont.Resolve&lt;IT&gt;(); } }</code> </pre><br>  (for simplicity, I will leave only references to <code>IA</code> , so as not to clutter up the code. We need Unity here only to facilitate instantiation of objects and we don‚Äôt want to give it control over the lifetime of any objects, so <code>ExternallyControlledLifetimeManager</code> used) <br>  The code is written, tests are written, everything is green, everything works, roll out to production.  And then it began ... <br><a name="habracut"></a><br>  The calling code looked like this: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateIT</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); Type concreteType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CreateITInternal(a, concreteType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; ++i) { CreateIT(); } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">classes and interfaces</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IA</span></span> { }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IT</span></span> { }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">A</span></span> : <span class="hljs-title"><span class="hljs-title">IA</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">IT</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IA a</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br></div></div><br>  It seems to be okay, both debug and release work fine in Visual Studio.  But if you go and run the .exe file, it stably falls with this exception: <br><br><pre> <code class="dos hljs">Unhandled Exception: Microsoft.Practices.Unity.ResolutionFailedException: Resolution of the dependency failed, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = "WeakRefTest.IT", name = "(none)". Exception occurred while: while resolving. Exception is: InvalidOperationException - The current <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, WeakRefTest.IA, is an interface and cannot be constructed. Are you missing a <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mapping? ----------------------------------------------- <span class="hljs-built_in"><span class="hljs-built_in">At</span></span> the <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> of the exception, the container was: Resolving WeakRefTest.T,(none) (mapped from WeakRefTest.IT, (none)) Resolving parameter "a" of constructor WeakRefTest.T(WeakRefTest.IA a) Resolving WeakRefTest.IA,(none) ---&gt; System.InvalidOperationException: The current <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, WeakRefTest.IA, is an interface and cannot be constructed. Are you missing a <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mapping?</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Stack trace</b> <div class="spoiler_text"><pre> <code class="dos hljs"> <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.DynamicMethodConstructorStrategy.ThrowForAttemptingToConstructInterface(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> lambda_method(Closure , IBuilderContext ) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.DynamicBuildPlanGenerationContext.&lt;&gt;c__DisplayClass1.&lt;GetBuildMethod&gt;b__0(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.DynamicMethodBuildPlan.BuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.BuildPlanStrategy.PreBuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.StrategyChain.ExecuteBuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.BuilderContext.NewBuildUp(NamedTypeBuildKey newBuildKey) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.Unity.ObjectBuilder.NamedTypeDependencyResolverPolicy.Resolve(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> lambda_method(Closure , IBuilderContext ) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.DynamicBuildPlanGenerationContext.&lt;&gt;c__DisplayClass1.&lt;GetBuildMethod&gt;b__0(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.DynamicMethodBuildPlan.BuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.BuildPlanStrategy.PreBuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.ObjectBuilder2.StrategyChain.ExecuteBuildUp(IBuilderContext context) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.Unity.UnityContainer.DoBuildUp(<span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> t, Object existing, String name, IEnumerable`<span class="hljs-number"><span class="hljs-number">1</span></span> resolverOverrides) --- End of inner exception stack trace --- <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.Unity.UnityContainer.DoBuildUp(<span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> t, Object existing, String name, IEnumerable`<span class="hljs-number"><span class="hljs-number">1</span></span> resolverOverrides) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.Unity.UnityContainer.Resolve(<span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> t, String name, ResolverOverride[] resolverOverrides) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Microsoft.Practices.Unity.UnityContainerExtensions.Resolve[T](IUnityContainer container, ResolverOverride[] overrides) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> WeakRefTest.Program.CreateITInternal(IA a, <span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> targetType) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> WeakRefTest.Program.CreateIT() <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> WeakRefTest.Program.Main(String[] args)</code> </pre><br></div></div><br><br>  wat?  We literally two lines above added an object to the container ... <br><br>  Covering all sorts of logs showed that everything works, how it should work.  Objects are actually registered in the container, and everything falls far from the first iteration. <br><br>  A brief re-reading of the documentation gave the suspect: <code>ExternallyControlledLifetimeManager</code> , inside it keeps weak references to objects placed in the container, and <i>it is possible</i> if between placing an object of type <code>IA</code> in a container and a request for constructing an object of type <code>IT</code> it will be destroyed, then the design should fall just like that the exception.  But on the other hand, an object of type <code>IA</code> can only be removed if the weak link from our container is the only one, but in our case this is not the case!  There are strong references to this object in <code>CreateITInternal</code> and <code>CreateIT</code> on the stack, which should extend its life at least until exiting <code>CreateIT</code> .  Or not?  Checking: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateITInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IA a, Type targetType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (UnityContainer cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer()) { cont.RegisterInstance&lt;IA&gt;(a, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); cont.RegisterType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IT), targetType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); GC.Collect(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cont.Resolve&lt;IT&gt;(); } }</code> </pre><br><br>  Now falls on the first iteration.  Those.  the case is really garbage collection and weak links. <br><br>  A simpler example: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestWeakRef</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sa = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wa = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference&lt;A&gt;(sa); GC.Collect(); A sa2; wa.TryGetTarget(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> sa2); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0}"</span></span>, sa2 == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"null"</span></span> : <span class="hljs-string"><span class="hljs-string">"not null"</span></span>); Console.ReadLine(); }</code> </pre><br><br>  In Visual Studio, it returns "not null" when launched outside the studio, it returns "null." <br><br>  Apparently, the presence of strong links in the code does not prolong the lifetime of the object before these links go out of scope, and the real dereferencing of these links matters. <br><br>  Fix is ‚Äã‚Äãextremely simple: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateITInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IA a, Type targetType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (UnityContainer cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer()) { cont.RegisterInstance&lt;IA&gt;(a, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); cont.RegisterType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IT), targetType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternallyControlledLifetimeManager()); IT ret = cont.Resolve&lt;IT&gt;(); GC.KeepAlive(a); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } }</code> </pre><br><br>  So, using weak links, caution the garbage collector may be more aggressive than you expect. <br><br>  It's still not clear, though, why VS always works when it starts up. </div><p>Source: <a href="https://habr.com/ru/post/268155/">https://habr.com/ru/post/268155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268141/index.html">Non-constant constant expressions</a></li>
<li><a href="../268143/index.html">Android Studio 1.4 available</a></li>
<li><a href="../268145/index.html">Network system calls. Part 3</a></li>
<li><a href="../268151/index.html">Aero Framework - WPF new breath. Rise above MVVM</a></li>
<li><a href="../268153/index.html">Development and publication of asset in the Unity Asset Store</a></li>
<li><a href="../268159/index.html">40 key information technology concepts accessible and understandable</a></li>
<li><a href="../268161/index.html">How to write highly available code</a></li>
<li><a href="../268163/index.html">Studying PureData</a></li>
<li><a href="../268165/index.html">EMET 5.5 went into beta</a></li>
<li><a href="../268167/index.html">Seven Great Secrets Manager. Substitute number when outgoing from mobile. New AltegroCloud features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>