<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to get on the road to OS development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article serves one simple goal: to help a person who suddenly decided to develop his own operating system (in particular, the kernel) for the x86...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to get on the road to OS development</h1><div class="post__text post__text-html js-mediator-article">  This article serves one simple goal: to help a person who suddenly decided to develop his own operating system (in particular, the kernel) for the x86 architecture, reach the stage where he can just add his functionality without worrying about building, running and other poorly related to the development of the details.  On the Internet and in Habre in particular, there are already materials on this topic, but it is rather difficult to write at least the ‚ÄúHello world‚Äù core without opening dozens of tabs, which I will try to correct.  Code examples will be mostly in C, but many other languages ‚Äã‚Äãcan also be adapted for OSDev.  Long wished and just realized desire to develop the operating system from scratch - welcome under kat. <br><a name="habracut"></a><br><h1>  Theory </h1><br>  To understand what the role of the OS developer is, let's imagine what happens after pressing the PC power button. <br><br>  First, the BIOS starts up and prepares the vital equipment, then loads the boot disk containing the code for the first part of the bootloader into the MBR.  Only 446 bytes were allotted for the directly executable part, which is extremely insufficient, therefore few loaders really fit into these boundaries.  In this regard, the bootloader is usually divided into two parts, and the only thing that the first part of the bootloader does is read from the disk and start the second part.  The second part can already occupy at least the entire disk, and usually places the processor in protected mode, loads the core and modules into memory, and then transfers control to the core. <br><br>  The kernel fully prepares the hardware and starts the first user processes, providing them and their descendants with runtime support. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, the minimum kernel must be able to read programs from the disk, run them and continue to execute system calls.  Also highly desirable output to the monitor and protection mechanisms. <br><br><h1>  Tools </h1><br>  Theoretically, development can be conducted on any OS, but most of the tools are designed for UNIX-like systems, and at least collecting them on Windows will already be a pain.  Moreover, since WSL does not support kernel modules, mounting the disk image will not work, and you will have to configure communication between WSL and Windows.  At this stage, it becomes easier to install a Linux virtual machine.  The article will provide instructions for Linux and macOS. <br><br>  For the full development cycle, you will need a code editor, an assembly system, a debugger with remote debugging support, a bootloader, a virtual machine and, preferably, a separate real machine for testing. <br><br>  Bochs and QEMU are best suited to the place of the virtual machine, since they run quickly and provide the ability to debug the running kernel. <br><br>  The loader some <s>masochum</s> especially ideological developers write themselves, but if we are talking about developing the operating system itself, it will be very boring to write the loader, as well as unnecessary, because there are ready-made solutions.  Thanks to the Multiboot specification, you can write a kernel that will be loaded almost out of the box using, for example, GRUB or LILO. <br><br>  With the build, everything is not so simple: you need a cross-compiler for x86.  Why cross-compiler, if you build under the same architecture?  The fact is that the standard compiler generates code based on the same OS on which it is running, or so-called.  hosted code  Hosted code uses system calls, interacts with other processes, but is tied to the operating system.  Freestanding code exists by itself and requires only the equipment to run.  The OS kernel refers to freestanding, and the programs it runs run to hosted.  The cross compiler has enough corresponding flag, and the freestanding-code will be generated. <br><br><h1>  Training </h1><br><h2>  Assembly tools </h2><br>  This part is easiest to produce from the command line.  For convenience, you can create a separate directory for the assembly, which will be easy to delete after the assembly, as well as set several environment variables: <br><br><pre><code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> TARGET=i686-elf $ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PREFIX=&lt;  -&gt;</code> </pre> <br>  <code>$TARGET</code> is the system under which the resulting compiler will build.  Usually it is called like <code>i686-linux-gnu</code> , but here the result runs without the OS, so just the format of the executable file is indicated.  Why i686, not i386?  Just the architecture of 80386 has already, ahem, for many years, and since then much has changed;  in particular, caches, multi-core and multiprocessor systems, embedded FPUs, ‚Äúlarge‚Äù atomic instructions like <code>CMPXCHG</code> , so that collecting under i386 can be very slow in performance and a little to get in support of old computers. <br><br>  <code>$PREFIX</code> is where the tools will be installed.  Typically, paths like <code>/usr/i686-elf</code> , <code>/usr/local/i686-elf</code> and the like are used, but you can install it in an arbitrary folder.  This directory is also called sysroot, since it will be the root directory for the cross compiler and utilities.  More precisely, this is not a full path, but a prefix to the path;  thus, for installation in the root, $ PREFIX will be an empty string, and not <code>/</code> .  At GCC build time, you need to add <code>$PREFIX/bin</code> to your <code>PATH</code> . <br><br>  If then the OS needs to be built for a different architecture, it will be enough to set other environment variables and copy the commands. <br><br><h3>  Binutils </h3><br>  Download and unpack the latest version from official FTP.  Caution: minor versions have long gone over 10, as a result of which alphabetically sorting broke, to search for the current version, you can use sorting by last modified date.  At the time of this writing, the current version of Binutils is 2.29. <br><br>  Binutils does not support assembly in the directory with the source code, so we create a directory next to the unpacked code and go into it.  Next, the usual build from source: <br><br><pre> <code class="bash hljs">$ ../binutils-2.29/configure --target=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span> --prefix=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PREFIX</span></span></span><span class="hljs-string">"</span></span> --with-sysroot --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-nls --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-werror</code> </pre><br>  More information about the parameters: <br><br>  <code>--with-sysroot</code> - use sysroot; <br>  <code>--disable-nls</code> - disable native language support.  The OSDev community is not so large that any incomprehensible build error is necessarily found by a person who speaks the language of the person who had it; <br>  <code>--disable-werror</code> - the compiler generates warnings when building Binutils, and with -Werror it causes the assembly to stop. <br><br><pre> <code class="bash hljs">$ make $ make install</code> </pre><br><h3>  Gcc </h3><br>  We also load, unpack and create a directory for the assembly.  The assembly process is slightly different.  Need a library of GMP, MPFR and MPC.  They can be installed from the standard repositories of many package managers, or you can run the <code>contrib/download_prerequisites</code> script from the source code directory, which will download and use them when building.  Configuration is performed as follows: <br><br><pre> <code class="bash hljs">$ ../gcc-7.2.0/configure --target=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span> --prefix=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PREFIX</span></span></span><span class="hljs-string">"</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-nls --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-languages=c,c++ --without-headers</code> </pre><br>  <code>--disable-nls</code> is the same as for binutils; <br>  <code>--without-headers</code> - do not assume that the target system will have a standard library (this, in fact, differs the compiler we need from the standard one); <br>  <code>--enable-languages=c,c++</code> - build compilers for selected languages ‚Äã‚Äãonly.  Optionally, but significantly speeds up the assembly. <br><br>  In the absence of the target OS, the usual <code>make &amp;&amp; make install</code> will not work, since some GCC components are oriented towards a ready-made operating system, therefore we only assemble and install the necessary ones: <br><br><pre> <code class="bash hljs">$ make all-gcc all-target-libgcc $ make install-gcc install-target-libgcc</code> </pre><br>  libgcc is the library that contains the internal functions of the compiler.  The compiler may call them for some calculations, for example, for 64-bit division on a 32-bit platform. <br><br><h3>  Grub </h3><br>  On most Linux distributions, you can skip this section, since they already have the appropriate utilities for working with GRUB.  For others, the OS will need to download and build it.  You will also need a small objconv utility: <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vertis/objconv.git $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> objconv $ g++ -o objconv -O2 src/*.cpp</code> </pre><br>  At the time of the GRUB build, you will need to add the newly compiled objconv <br>  and cross-tools (i686-elf- *). <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../grub $ ./autogen.sh $ mkdir ../build-grub $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../build-grub $ ../grub-2.02/configure --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-werror TARGET_CC=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span>-gcc TARGET_OBJCOPY=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span>-objcopy TARGET_STRIP=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span>-strip TARGET_NM=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span>-nm TARGET_RANLIB=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span>-ranlib --target=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span> $ make $ make install</code> </pre><br><h3>  GDB (for macOS) </h3><br>  The standard version of GDB does not know about ELF files, so when using GDB, you will need to rebuild it with their support.  Download, unpack, build: <br><br><pre> <code class="bash hljs">$ mkdir build-gdb $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build-gdb $ ../gdb-8.0.1/configure --target=<span class="hljs-variable"><span class="hljs-variable">$TARGET</span></span> --prefix=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PREFIX</span></span></span><span class="hljs-string">"</span></span> $ make $ make install</code> </pre><br><h2>  Disk image </h2><br>  The process of creating such in different operating systems occurs in its own way, so here I will provide separate instructions. <br><br><div class="spoiler">  <b class="spoiler_title">For Linux (from the command line)</b> <div class="spoiler_text">  Create an empty file: <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=disk.img bs=1048576 count=&lt;  &gt;</code> </pre><br>  Create a partition table: <br><br><pre> <code class="bash hljs">$ fdisk disk.img Welcome to fdisk (util-linux 2.27.1). Changes will remain <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> memory only, until you decide to write them Be careful before using the write <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>. Device does not contain a recognized partition table. Created a new DOS disklabel with disk identifier 0x<span class="hljs-comment"><span class="hljs-comment">########. Command (m for help): n Partition type p primary (0 primary, 0 extended, 4 free) e extended (container for logical partitions) Select (default p): &lt;Enter&gt; Using default response p. Partition number (1-4, default 1): &lt;Enter&gt; First sector (2048-N, default 2048): &lt;Enter&gt; Last sector, +sectors or +size{K,M,G,T,P} (2048-N, default N): &lt;Enter&gt; Created a new partition 1 of type 'Linux' and of size N MiB. Command (m for help): t Selected partition 1 Partition type (type L to list all types): 0B Changed type of partition 'Linux' to 'W95 FAT32'. Command (m for help): a Selected partition 1 The bootable flag on partition 1 is enabled now. Command (m for help): w The partition table has been altered. Syncing disks.</span></span></code> </pre><br>  Create a file system: <br><br><pre> <code class="bash hljs">$ losetup disk.img --show -f -o 1048576 <span class="hljs-comment"><span class="hljs-comment">#  &lt;&gt; $ mkfs.fat -F 32 &lt;&gt; $ mount &lt;&gt; &lt; &gt;</span></span></code> </pre><br>  In the future it will be possible to mount by <br><br><pre> <code class="bash hljs">$ mount -o loop,offset=1048576 disk.img &lt; &gt;</code> </pre><br>  Install the bootloader (here GRUB): <br><pre> <code class="bash hljs">$ grub-install --modules=<span class="hljs-string"><span class="hljs-string">"part_msdos biosdisk fat multiboot configfile"</span></span> --root-directory=<span class="hljs-string"><span class="hljs-string">"&lt; &gt;"</span></span> ./disk.img $ sync</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">For macOS (from the command line)</b> <div class="spoiler_text">  Create an empty file: <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=disk.img bs=1048576 count=&lt;  &gt;</code> </pre><br>  Partition Table: <br><br><pre> <code class="bash hljs">$ fdisk -e disk.img Would you like to initialize the partition table? [y] y fdisk:*1&gt; edit 1 Partition id (<span class="hljs-string"><span class="hljs-string">'0'</span></span> to <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>) [0 - FF]: [0] (? <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>) 0B Do you wish to edit <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> CHS mode? [n] n Partition offset [0 - n]: [63] 2047 Partition size [1 - n]: [n] &lt;Enter&gt; fdisk:*1&gt; write fdisk: 1&gt; quit</code> </pre><br>  We separate the partition table and the only section: <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=disk.img of=mbr.img bs=512 count=2047 $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=disk.img of=fs.img bs=512 skip=2047</code> </pre><br>  We connect the partition as a disk: <br><br><pre> <code class="bash hljs">$ hdiutil attach -nomount fs.img <span class="hljs-comment"><span class="hljs-comment">#  &lt;&gt;</span></span></code> </pre><br>  Create a FS, here is FAT32: <br><br><pre> <code class="bash hljs">$ newfs_msdos -F 32 &lt;&gt;</code> </pre><br>  Disable: <br><br><pre> <code class="bash hljs">$ hdiutil detach &lt;&gt;</code> </pre><br>  ‚ÄúGlue‚Äù MBR and FS back: <br><br><pre> <code class="bash hljs">$ cat mbr.img fs.img &gt; disk.img</code> </pre><br>  Connect and remember the mount point (usually ‚Äú/ Volumes / NO NAME‚Äù): <br><br><pre> <code class="bash hljs">$ hdiutil attach disk.img</code> </pre><br>  Install the bootloader: <br><br><pre> <code class="bash hljs">$ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/grub-install --modules=<span class="hljs-string"><span class="hljs-string">"part_msdos biosdisk fat multiboot configfile"</span></span> --root-directory=<span class="hljs-string"><span class="hljs-string">"&lt; &gt;"</span></span> ./disk.img</code> </pre><br></div></div><br>  The disk image is then quietly connected with the built-in system tools.  You can, at your own discretion, create a directory hierarchy and customize the bootloader.  For example, for GRUB you can create such a grub.cfg in / boot / grub: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> menuentry <span class="hljs-string"><span class="hljs-string">"BetterThanLinux"</span></span> { multiboot ////.elf boot }</code> </pre><br><h2>  Setup of the assembly system </h2><br>  There are a lot of popular assembly systems in the world, so there will not be instructions for each one here, but I will describe the general points. <br><br>  Assembler files are assembled into ELF object formats (32 bits): <br><br><pre> <code class="bash hljs">$ nasm -f elf -o file.o file.s</code> </pre><br>  C-files are collected using the cross compiler with the -ffreestanding flag: <br><br><pre> <code class="bash hljs">$ i686-elf-gcc -c -ffreestanding -o file.o file.c</code> </pre><br>  We use the same cross-compiler for linking, but specify a bit more information: <br><br><pre> <code class="bash hljs">$ i686-elf-gcc -T linker.ld -o file.elf -ffreestanding -nostdlib file1.o file2.o -lgcc</code> </pre><br>  <code>-ffreestanding</code> - generate freestanding-code; <br>  <code>-nostdlib</code> - do not include the standard library, since its implementation is hosted code and will be completely useless; <br>  <code>-lgcc</code> - we connect the <code>-lgcc</code> described above.  Its connection is always after the remaining object files, otherwise the linker will complain about unresolved links; <br>  <code>-T</code> - since you need to place the Multiboot header somewhere, the usual ELF-file layout will not work.  It can be changed using the linker script, which sets this flag.  Here is a ready version of it: <br><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> ENTRY(_start) <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> SECTIONS { <span class="hljs-comment"><span class="hljs-comment">/*      1.     */</span></span> . = <span class="hljs-number"><span class="hljs-number">1</span></span>M; <span class="hljs-comment"><span class="hljs-comment">/*   Multiboot,    ,     */</span></span> .<span class="hljs-function"><span class="hljs-function">text </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BLOCK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ALIGN</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">)</span></span> { *(.multiboot) *(.text) } <span class="hljs-comment"><span class="hljs-comment">/*  ( ) */</span></span> .<span class="hljs-function"><span class="hljs-function">rodata </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BLOCK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ALIGN</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">)</span></span> { *(.rodata) } <span class="hljs-comment"><span class="hljs-comment">/*  (  , ) */</span></span> .<span class="hljs-function"><span class="hljs-function">data </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BLOCK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ALIGN</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">)</span></span> { *(.data) } <span class="hljs-comment"><span class="hljs-comment">/*   (    , ) */</span></span> .<span class="hljs-function"><span class="hljs-function">bss </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BLOCK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ALIGN</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">K</span></span></span><span class="hljs-function">)</span></span> { *(COMMON) *(.bss) } <span class="hljs-comment"><span class="hljs-comment">/*    ,    */</span></span> }</code> </pre><br><h1>  Minimum core </h1><br><h2>  Get control </h2><br>  We get control from the loader in a small assembler file: <br><br><pre> <code class="hljs sql">FLAGS equ 0 ;      MAGIC equ 0x1BADB002 ; 'magic number' lets bootloader find the header <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span> equ -(MAGIC + FLAGS) ; <span class="hljs-keyword"><span class="hljs-keyword">checksum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> above, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> prove we <span class="hljs-keyword"><span class="hljs-keyword">are</span></span> multiboot ;   section .multiboot align 4 dd MAGIC dd FLAGS dd <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">section</span></span> .bss align <span class="hljs-number"><span class="hljs-number">16</span></span> stack_bottom: resb <span class="hljs-number"><span class="hljs-number">16384</span></span> ; 16 KiB stack_top: section .text global _start:function (_start.end - _start) _start: mov esp, stack_top ;   push ebx ;      extern kernel_main <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> kernel_main cli ;  -   ,   (,       ) .hang: hlt ;  jmp .hang ;   ,   .end:</code> </pre><br><h2>  Proof of work </h2><br>  In order to somehow see that the code is actually executed, you can display something on the screen.  A full-fledged terminal driver is a big topic, but, briefly, at the address 0xB8000 there is a buffer for 2000 entries, each of which consists of attributes and a symbol.  White text on a black background corresponds to the attribute byte 0x0F.  Let's try to display something using a previously prepared line: <br><br><pre> <code class="hljs rust">#include &lt;stddef.h&gt; void kernel_main(void* multiboot_structure) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>[] = <span class="hljs-string"><span class="hljs-string">"H\x0F"</span></span><span class="hljs-string"><span class="hljs-string">"e\x0Fl\x0Fl\x0Fo\x0F \x0Fw\x0Fo\x0Fr\x0Fl\x0F"</span></span><span class="hljs-string"><span class="hljs-string">"d\x0F"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* buf = (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*) <span class="hljs-number"><span class="hljs-number">0xB8000</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(size_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; c = <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>[i]; i++) { buf[i] = <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>[i]; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br><h2>  Launch </h2><br>  We copy the kernel into the disk image along the desired path, and after that any virtual machine must successfully load it. <br><br><h2>  Debugging </h2><br>  You can set the <code>-s -S</code> flags for debugging in QEMU.  QEMU will wait for the debugger and turn on network debugging.  It is also worth noting that debugging will not work when using an accelerator, so the <code>--enable-kvm</code> flag will have to be removed if it is used. <br><br>  Bochs need to be built with <code>--enable-gdb-stub</code> , and in the config to include a line like gdbstub: <code>enabled=1, port=1234, text_base=0, data_base=0, bss_base=0</code> . <br>  In GDB, you can connect and start the machine in this way (kernel.elf is the kernel file): <br><br><pre> <code class="hljs css">(<span class="hljs-selector-tag"><span class="hljs-selector-tag">gdb</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">file</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.elf</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">gdb</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">target</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1234</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">gdb</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span></code> </pre><br>  Everything else works the same way as always - breakpoints, memory reading, etc. You can also enable the debugger in the kernel itself, which will allow debugging on a real machine.  You can write it yourself, but debugging errors in the debugger will bring a lot of joy.  GNU distributes almost complete debuggers that require only a few functions from the kernel.  For example, <a href="">for i386</a> .  However, while it is too early to do this, since there are still no necessary functions, such as installing an interrupt handler or receiving / sending data through the serial port. <br><br><h1>  Conclusion </h1><br>  At present, the following remains to the minimum working operating system: <br><br><ul><li>  <a href="http://wiki.osdev.org/Text_UI">Primitive debugging terminal</a> ; </li><li>  <a href="http://wiki.osdev.org/Global_Descriptor_Table">Global descriptor</a> and <a href="http://wiki.osdev.org/Interrupts">interrupt table</a> ; </li><li>  <a href="http://wiki.osdev.org/PCI">PCI driver</a> ; </li><li>  <a href="http://wiki.osdev.org/PCI_IDE_Controller">Driver for IDE-controller</a> (SATA-disks can work in IDE mode) and at least one FS; </li><li>  <a href="http://wiki.osdev.org/Paging">Page addressing</a> (unless a single-task OS without memory protection is planned, such as DOS); </li><li>  Run custom code; </li><li>  System calls; </li><li>  Standard Library; </li><li>  <a href="http://wiki.osdev.org/OS_Specific_Toolchain">Compiler for the created OS</a> . </li></ul><br><h1>  Useful resources </h1><br><ul><li>  <a href="http://wiki.osdev.org/">OSDev wiki</a> is a necessary theory; </li><li>  <a href="http://forum.osdev.org/">OSDev forum</a> - here (probably) will help in case of rare problems; </li><li>  <a href="https://littleosbook.github.io/">The little book about OS development</a> - a pretty good squeeze of information on the topic; </li><li>  <a href="http://www.jamesmolloy.co.uk/tutorial_html/">JamesM's kernel development tutorials</a> - a set of lessons on writing a kernel.  <a href="http://wiki.osdev.org/James_Molloy%2527s_Tutorial_Known_Bugs">Not without flaws</a> ; </li><li>  <a href="https://subscribe.ru/catalog/comp.soft.myosdev">We write our own operating system</a> - there is little theory, but you can see the finished implementation of some incomprehensible things. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/343690/">https://habr.com/ru/post/343690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343678/index.html">Is it true that the future of CPaaS is for ‚ÄúServerless‚Äù technologies?</a></li>
<li><a href="../343680/index.html">Secrets of React and Redux in the development of web applications</a></li>
<li><a href="../343682/index.html">Administering Juniper Switches with Ansible</a></li>
<li><a href="../343684/index.html">Regression tests for memory leaks, or how to write a memory profiler for .NET applications</a></li>
<li><a href="../343688/index.html">Implementation of the simplest investment strategy based on API MOEX (Moscow Exchange)</a></li>
<li><a href="../343692/index.html">Open the CrackMe winter contest: break-rover</a></li>
<li><a href="../343694/index.html">Arduino and segment LCD indicator</a></li>
<li><a href="../343696/index.html">Latent parasites</a></li>
<li><a href="../343700/index.html">Flying snowflakes</a></li>
<li><a href="../343702/index.html">tldr - alternative man with self-titled name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>