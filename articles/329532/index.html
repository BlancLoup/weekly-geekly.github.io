<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding the Conductor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now the Conductor library is gaining momentum, however there is not a lot of information on its use in the network, and only official sources are avai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding the Conductor</h1><div class="post__text post__text-html js-mediator-article"><p>  Now the <a href="https://github.com/bluelinelabs/Conductor">Conductor</a> library is gaining momentum, however there is not a lot of information on its use in the network, and only official sources are available from official sources.  This article is designed to give an introductory course on Conductor and remove some of the rakes from your path.  The article is designed for those who already have some experience in the development of Android. </p><br><p>  Conductor is positioned as a replacement for standard fragments.  The basic idea is to wrap the View and give access to the life cycle methods.  Conductor has its own life cycle, which is much simpler than the fragments, but it also has its own tricks (more on that later). </p><br><p>  The main advantages that Conductor gives are: </p><br><ul><li>  Code simplification </li><li>  Transactions are executed instantly </li><li>  Ability to build an application on a single Activity </li><li>  Does not limit the choice of application architecture </li><li>  Easily embedded animations </li><li>  No need to save states between configuration changes </li></ul><br><p>  Also in the box you will receive: </p><br><ul><li>  Work with backstage </li><li>  Standard active callbacks are easily available. </li><li>  Several standard animations </li><li>  Binding of the life cycle to RxJava </li><li>  Quick integration with ViewPager </li></ul><br><p>  Next, we'll analyze a few typical use cases that are found in almost all applications and try to understand the life cycle of the controller. </p><br><a name="habracut"></a><br><h2 id="chast-1">  Part 1 </h2><br><p>  We begin with a simple example, even smaller than on the official <a href="https://github.com/bluelinelabs/Conductor">website</a> .  Before reading the article, it is strongly recommended that you read the page is not large. </p><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: MainActivity.java public class MainActivity extends AppCompatActivity { private Router router; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); ViewGroup container = (ViewGroup) findViewById(R.id.controller_container); router = Conductor.attachRouter(this, container, savedInstanceState); if (!router.hasRootController()) { router.setRoot(RouterTransaction.with(new HomeController())); } } } //File: HomeController.java public class HomeController extends Controller { @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { return inflater.inflate(R.layout.controller_home, container, false); } }</span></span></code> </pre> <br><p>  At startup, we will get a screen on which the <code>controller_home</code> layout will be displayed.  Not too much, but let's see what is happening here. </p><br><p>  The controller code is extremely simple and creates a View.  But initialization is somewhat more complicated and even contains a condition.  When creating the activation, <code>Conductor::attachRouter</code> binds the router to our activation and to its life cycle.  Let's pay attention to the fact that in addition to the context and the container, we pass the still saved state - everything is correct, the router keeps all controllers in its stack and their state.  Therefore, if the activation was not created again, but was restored, then the installation of the root controller is not required, because  it was recreated from a saved state. </p><br><p>  Nothing prevents us from removing this check, but then each time we create an activation, we will create a new controller and we will lose all the saved data. </p><br><h2 id="chast-2">  Part 2 </h2><br><p>  Take a deeper look at how and where the states are saved in the Conductor. </p><br><p>  To do this, we have to complicate our example a little.  We will not waste time and at the same time we will do what everyone should do in his life - we will grow a tree.  Let it grow on tapu. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: HomeController.java public class HomeController extends Controller { private View tree; @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_home, container, false); tree = view.findViewById(R.id.tree); view.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { tree.setVisibility(View.VISIBLE); } }); return view; } @Override protected void onDestroyView(@NonNull View view) { super.onDestroyView(view); tree = null; } }</span></span></code> </pre> <br><p>  So far, nothing supernatural has happened, but note that we drop the link to the tree image in <code>onDestroyView</code> so that our view can be collected by the garbage collector when the controller is removed from the screen. </p><br><p>  Now let's see what happens if we want to look at the tree from the other side.  Let's change the screen orientation. </p><br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/d57/b71/df6/d57b71df692f976e53d81b0ea4f844c3.gif" alt="image"></p></div></div><br><p>  Unfortunately, the tree is gone.  What can we do so that our work is not in vain? <br>  The life cycle of controllers is tied to a fragment in the activation.  The fragment is created inside the function <code>Conductor::attachRouter</code> and all the calls to the life-cycle methods are tied to it and to the activation, within which initialization was performed.  The fragment has the property <code>setRetainInstance(true)</code> , which allows it, and therefore all controllers, to experience configuration changes.  So the only thing that is required of us is to save our state to a variable in the controller. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: HomeController.java public class HomeController extends Controller { private boolean isGrown = false; private View tree; @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_home, container, false); tree = view.findViewById(R.id.tree); view.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { isGrown = true; update(); } }); return view; } @Override protected void onAttach(@NonNull View view) { super.onAttach(view); update(); } private void update() { tree.setVisibility(isGrown ? View.VISIBLE : View.GONE); } @Override protected void onDestroyView(@NonNull View view) { super.onDestroyView(view); tree = null; } }</span></span></code> </pre> <br><p>  We added an <code>isGrown</code> variable that stores the state of our controller and a method that updates the state of the tree image.  Again - no difficulty. </p><br><p>  We look at the result. </p><br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/048/290/a16/048290a160bfd9d5b6a307ed83453fd5.gif" alt="image"></p></div></div><br><p>  When you change the configuration, the activation is destroyed, but the fragment is not destroyed.  But what if our activism is still destroyed by the system and not in the process of changing the configuration?  We‚Äôll put a checkmark in the <em>keep the</em> checkbox and <em>don‚Äôt</em> see what happens. </p><br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/af7/92f/366/af792f36636878553407b728957e9d18.gif" alt="image"></p></div></div><br><p>  No miracle happened and we lost all our data.  To solve this problem, the Conductor duplicates the <code>onSaveInstanceState</code> and <code>onRestoreInstanceState</code> .  Let's implement them and make sure that everything works. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: HomeController.java ... @Override protected void onSaveInstanceState(@NonNull Bundle outState) { super.onSaveInstanceState(outState); outState.putBoolean("isGrown", isGrown); } @Override protected void onRestoreInstanceState(@NonNull Bundle savedInstanceState) { super.onRestoreInstanceState(savedInstanceState); isGrown = savedInstanceState.getBoolean("isGrown"); }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/63d/1e1/65a/63d1e165a08377e265b88de081866688.gif" alt="image"></p></div></div><br><p>  Hooray!  Now that our tree is safe and sound, we can move on to something more complicated. </p><br><h2 id="chast-3">  Part 3 </h2><br><p>  Let's find out how many cones our tree can bring.  To do this, create a controller that takes as input the number of cones and displays them. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: ConeController.java public class ConeController extends Controller { private int conesCount = 0; private TextView textField; public ConeController(int conesCount) { this.conesCount = conesCount; } @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_cone, container, false); textField = (TextView) view.findViewById(R.id.textField); return view; } @Override protected void onAttach(@NonNull View view) { super.onAttach(view); textField.setText("Cones: " + conesCount); } @Override protected void onDestroyView(@NonNull View view) { super.onDestroyView(view); textField = null; } }</span></span></code> </pre> <br><p>  But this code will not compile.  And will swear at the absence of another designer - let's see why he is needed. </p><br><p>  As with the Fragments, there is a trick here.  If, in the case of fragments, a constructor without parameters is invoked through reflection, then a constructor with the Bundle parameter will be invoked here. </p><br><p>  If we just add a constructor, then.  if our controller is destroyed, Conductor will re-create it, and we will lose information about our cones.  To avoid this you need to write our data in <code>args</code> .  <code>Args</code> are saved by the conductor when the controller is destroyed. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: ConeController.java public ConeController(int conesCount) { this.conesCount = conesCount; getArgs().putInt("conesCount", conesCount); } public ConeController(@Nullable Bundle args) { super(args); conesCount = args.getInt("conesCount"); }</span></span></code> </pre> <br><p>  A more elegant option with <code>BundleBuilder</code> - you can see in the <a href="">examples</a> . </p><br><p>  It remains to add a call to our controller and store the number of cones. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: HomeController.java public class HomeController extends Controller { private boolean isGrown = false; private int conesCount = 42; private View tree; @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_home, container, false); tree = view.findViewById(R.id.tree); view.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { if (isGrown) { getRouter().pushController(RouterTransaction.with(new ConeController(conesCount))); } else { isGrown = true; update(); } } }); return view; } }</span></span></code> </pre> <br><p>  At the first tap, we grow a tree, while later we show the number of cones on it.  Finally, switching to another controller is done by simply calling <code>pushController</code> at the router, which adds our controller to the back-stack and displays it on the screen. </p><br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/9be/847/4a3/9be8474a3dd3313b753968089fe0458e.gif" alt="image"></p></div></div><br><p>  Everything is fine, but without restarting the application, we cannot go back - let's fix it. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: MainActivity.java @Override public void onBackPressed() { if (!router.handleBack()) { super.onBackPressed(); } }</span></span></code> </pre> <br><p>  This code will work without problems in our application.  However, let's take a closer look at the insides of <code>onBackPressed</code> . </p><br><p>  Suppose we do not want the application to be hidden by the last transition back.  The first thing I want to do is leave only the <code>router.handleBack()</code> call.  However, the fact is that when <code>handleBack</code> returns false, this does not mean that no work has been done - this means that the last controller was destroyed and the existence of the activation (or any other container containing the router) needs to be stopped.  It is worth paying attention to the fact that when you remove the root controller, its view is not removed from the scene.  This is left so that when we close our activites, we can observe a ‚Äúhigh-quality‚Äù closing animation. </p><br><p>  Hence the rule that always, if <code>handleBack</code> returned false, the owner of this router must be destroyed. </p><br><p>  This behavior can be changed by calling the <code>setPopsLastView</code> method with the <code>false</code> parameter. </p><br><h2 id="chast-4">  Part 4 </h2><br><p>  Now it is time to collect the fruits.  Often there is a task to transfer data back to the previous controller.  Let's try to collect a few cones from our tree. </p><br><p>  We could just pass the listener to our controller, but the Android ecosystem says its not.  What if the controller is destroyed?  We will not be able to just restore the link to our listener.  The easiest way to solve this problem is to use the <code>setTargetController</code> method <code>setTargetController</code> which allows you to remember a link to another controller and restore it itself when the controller is re-created. </p><br><p>  It will be good practice not to specify the type of controller directly, but to indicate only the interface that it should inherit. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: ConeController.java public class ConeController extends Controller { private int conesCount = 0; private TextView textField; public &lt;T extends Controller &amp; ConeListener&gt; ConeController(int conesCount, T listener) { this.conesCount = conesCount; getArgs().putInt("conesCount", conesCount); setTargetController(listener); } public ConeController(@Nullable Bundle args) { super(args); conesCount = args.getInt("conesCount"); } @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_cone, container, false); textField = (TextView) view.findViewById(R.id.textField); view.findViewById(R.id.collectConeButton) .setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { if (getTargetController() != null) { conesCount--; getArgs().putInt("conesCount", conesCount); update(); } } }); return view; } @Override protected void onAttach(@NonNull View view) { super.onAttach(view); update(); } @Override public boolean handleBack() { ((ConeListener) getTargetController()).conesLeft(conesCount); return super.handleBack(); } private void update() { textField.setText("Cones: " + conesCount); } @Override protected void onDestroyView(@NonNull View view) { super.onDestroyView(view); textField = null; } public interface ConeListener { void conesLeft(int count); } } //HomeController.java public class HomeController extends Controller implements ConeController.ConeListener { .... @NonNull @Override protected View onCreateView(@NonNull LayoutInflater inflater, @NonNull ViewGroup container) { View view = inflater.inflate(R.layout.controller_home, container, false); tree = view.findViewById(R.id.tree); view.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { if (isGrown) { getRouter().pushController(RouterTransaction.with(new ConeController(conesCount, HomeController.this))); } else { isGrown = true; update(); } } }); return view; } @Override public void conesLeft(int count) { conesCount = count; }</span></span></code> </pre> <br><p>  In the constructor, we passed a parameter that must be a successor to <code>Controller</code> and implement our listener's interface.  Remember it by calling the <code>setTargetController</code> method. </p><br><p>  When leaving the controller, we update the number of cones in the <code>HomeController</code> calling the <code>conesLeft(...)</code> . </p><br><p>  And the result! </p><br><div class="spoiler">  <b class="spoiler_title">Watch!</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/206/b44/bef/206b44bef6c37728dbd878e9bd9726fd.gif" alt="image"></p></div></div><br><h2 id="chast-5">  Part 5 </h2><br><p>  It remains to bring beauty.  With a slight movement of the hand, transition animations are added to appear and hide the controller.  The box has a basic set of animations - but you can also easily implement your own by redefining the <code>ControllerChangeHandler</code> or the classes inherited from it. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//File: MainActivity.java getRouter().pushController(RouterTransaction.with( new ConeController(conesCount, HomeController.this)) .popChangeHandler(new FadeChangeHandler()) .pushChangeHandler(new FadeChangeHandler()) );</span></span></code> </pre> <br><h2 id="chast-6">  Part 6 </h2><br><p>  There are several other life-cycle methods in the <code>Conductor</code> , other than those shown on the diagram in the official documentation, which can be useful when you want to implement some unusual behavior.  Let's take a look at them. </p><br><p>  <strong>onAttach</strong> - called when the controller is shown on the screen <br>  <strong>onDetach</strong> - called when removing the controller from the screen <br>  <strong>onDestroyView</strong> - called when destroying the view attached to the controller <br>  <strong>onCreateView</strong> - called when creating a view for the controller <br>  <strong>onDestroy</strong> - called before the controller is destroyed </p><br><p>  The methods described below also participate in the life cycle, but essentially duplicate the calls to the corresponding methods of the <code>View</code> and <code>Activity</code> classes: </p><br><p>  <strong>onSaveViewState</strong> <br>  <strong>onRestoreViewState</strong> <br>  <strong>onSaveInstanceState</strong> <br>  <strong>onRestoreInstanceState</strong> </p><br><p>  The following methods are invoked during the life cycle, but in fact cannot be assigned to it.  The order of their calls may depend on the transition animation.  And rely on anything other than animation processing in them is not worth it. <br>  <strong>onChangeStarted</strong> - called before the animation begins <br>  <strong>onChangeEnded</strong> - called upon completion of the animation </p><br><p>  When building the life cycle, everything turned out to be not as rosy as on the official <a href="">page</a> .  For controllers, two life cycles are typical.  One is its own cycle that works when switching between controllers and a second cycle that works when destroying and creating activit.  They are different and that is why the chart has grown a bit. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5cd/174/481/5cd174481a77ec2f77b32b7ae18bc312.png" alt="image"></p><br><p>  Paired methods are highlighted in color.  Actions highlighted by bold arrows are initiated by the user.  Also note that only constructors without a parameter or with a <code>Bundle</code> parameter can be automatically called.  Any other constructor can only be called by us manually. </p><br><p>  ‚Üí <a href="https://github.com/JuzTosS/ConductorTutorial">Tutorial code</a> <br>  ‚Üí <a href="https://github.com/bluelinelabs/Conductor">Conductor</a> <br>  ‚Üí <a href="https://distillery.com/blog/innovating-android-development-introduction-conductor/">Russian version</a> </p><br><p>  For assistance in the preparation of thanks to <a href="https://habrahabr.ru/users/jamestag/">Vladimir Farafonov</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/329532/">https://habr.com/ru/post/329532/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329520/index.html">You have the right to anonymity. Part 2. Legislation against anonymity</a></li>
<li><a href="../329522/index.html">What is the difference between Bitcoin and other cryptocurrencies?</a></li>
<li><a href="../329524/index.html">Friday discussion: Russian vs foreign IT - company. Why everyone wants to work at Google</a></li>
<li><a href="../329528/index.html">Development of a chess program</a></li>
<li><a href="../329530/index.html">What did you encounter when translating the project to Android Studio 3.0 Preview and Gradle 4.0-milestone-1</a></li>
<li><a href="../329536/index.html">The path to transducers in pure javascript</a></li>
<li><a href="../329538/index.html">Do-it-yourself phishing. Experience of the company "Aktiv", part two</a></li>
<li><a href="../329540/index.html">Open days before launching a new Java course</a></li>
<li><a href="../329542/index.html">Using statistics in PostgreSQL to optimize performance - Alexey Ermakov</a></li>
<li><a href="../329544/index.html">Start of big data project: 6 important issues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>