<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Angstrom. A bunch of difficulties in a simple wrapper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When is another bike needed? 
 Angstrom, of course, if you look at the function performed, the bike. How many ways to convert units? Lot. You can use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Angstrom. A bunch of difficulties in a simple wrapper</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/9b4/910/51b/9b491051bc454928a3e1a3f7e6eda0c6.png" width="500"><br><h2>  When is another bike needed? </h2><br>  Angstrom, of course, if you look at the function performed, the bike.  How many ways to convert units?  Lot.  You can use Google, you can one of the hundreds of applications for iOS or Android. <br><br>  But at the same time, not a single method solved one problem.  How do I get the result of the conversion when I watch the show?  Specifically, <a href="https://en.wikipedia.org/wiki/MythBusters">Mythbusters</a> .  They always talk there about feet and pounds.  How much it?  Is it a big apartment, 500 ft¬≤?  (not really, as it turned out) Is it a lot, 27 psi (yep, dofiga)?  And finally, tell them that the Fahrenheits are generally not clear to anyone! <br><br>  With conventional converters, you have to stop the video, find out what category it is, ‚Äúpsi‚Äù, then look for this very ‚Äúpounds per square inch‚Äù there, remember what number you need to enter, understand what to translate it into (to realize the scale of the problem).  I want to do it with the device that is at hand, preferably without the Internet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this problem can not be solved by any converter.  I tried, probably a hundred.  It is solved by Google, but this is also slow (I launched the browser, entered something in the line, did not understand Google, or understood not so ...). <br><br>  So does Angstrom bike?  It seems not. <br><br>  Now let's look at the difficulties that had to be solved during its development.  Technical difficulties, programmer. <br><a name="habracut"></a><br><h2>  Briefly about the design </h2><br>  A significant part of the complexity has grown out of the great design that Ilya Birman invented.  Without it, Angstrom would be called GeeKonv and would look something like this: <br><br><img src="https://habrastorage.org/files/0ba/0b8/93b/0ba0b893b6884041b7c9bec58627d427.png" width="200"><br>  Instead, it turned out the application, which is nice to watch, and which is convenient to use. <br><br><img src="https://habrastorage.org/files/ad8/e5e/62b/ad8e5e62b1f7401b8e0a5a5a6a8bc31e.png" width="200"><br>  A little about what issues had to be solved about the UI, you can read from Ilya <a href="http://ilyabirman.net/meanwhile/tags/angstrom/">in the section of the blog about Angstrom</a> , and I will continue about the technique. <br><br><h2>  Formula Calculation </h2><br>  Converting units is a difficult task.  Firstly, it is a lot of units and it is difficult not to be mistaken with all coefficients and transformations.  Secondly, some transformations are nontrivial.  If converting from feet to meters requires dividing by one coefficient and then multiplying by another, for example, to translate Fahrenheit to Celsius, you need to try a little more. <br><br>  Calculating formulas is not an easy task.  They need to somehow write, somehow parsit, somehow substitute variables, and so on.  Fortunately, in the process of research, I came across an article about the side property of <code>NSExpression</code> , which allows you to calculate some arithmetic expressions.  It works like this: <br><br><pre> <code class="hljs json">[[NSExpression expressionWithFormat:@<span class="hljs-string"><span class="hljs-string">"(23-7.5)*40.0/21.0+273.15"</span></span>] expressionValueWithObject:nil context:nil]</code> </pre> <br>  And it allows you to calculate something simple (as in the example), or, using the functions <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSExpression_Class/index.html">listed in the documentation</a> , a little more complicated. <br><br>  When working with calculations via <code>NSNumber</code> and <code>NSExpression</code> , you need to remember to determine the behavior of <code>NSNumber</code> in case of incorrect results.  Otherwise, the calculations will break.  This is done using this code: <br><br><pre> <code class="hljs json">[NSDecimalNumber setDefaultBehavior:,   NSDecimalNumberHandler]</code> </pre> <br>  I return the values ‚Äã‚Äãthere so that nothing breaks, and at the same time I get errors in the log. <br><br><pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CONDecimalNumberHandler</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSRoundingMode</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">roundingMode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSRoundBankers</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)scale { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNoScale</span></span>; } - (<span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNumber</span></span> *)exceptionDuringOperation:(SEL)operation error:(<span class="hljs-built_in"><span class="hljs-built_in">NSCalculationError</span></span>)error leftOperand:(<span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNumber</span></span> *)leftOperand rightOperand:(<span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNumber</span></span> *)rightOperand { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Error during parsing number: %@/%@ (%d)"</span></span>, leftOperand, rightOperand, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) error); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == <span class="hljs-built_in"><span class="hljs-built_in">NSCalculationOverflow</span></span> || error == <span class="hljs-built_in"><span class="hljs-built_in">NSCalculationUnderflow</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[<span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNumber</span></span> alloc] initWithString:<span class="hljs-string"><span class="hljs-string">@"0"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[<span class="hljs-built_in"><span class="hljs-built_in">NSDecimalNumber</span></span> alloc] initWithString:<span class="hljs-string"><span class="hljs-string">@"1"</span></span>]; } } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre> <br><h2>  Storage of tables with units </h2><br>  The lists of units themselves are also not easy to store.  After all, you need: <br><br><ul><li>  Understand the coefficients or formulas for each. </li><li>  Keep priorities so that you can choose the most correct unit for each case. </li><li>  For the same type of measurement system is stored units (SI or imperial, for example). </li><li>  Translations of unit names are made for each language and for all possible word forms (for Russian, for example, five word forms).  This includes the possible symbols for the unit, synonyms for the names (ar or weave or square decameter). </li><li>  Some units are combined into ‚Äúclusters‚Äù, for example, 1 meter is converted to feet, and 10 meters - in yards.  The second unit is selected from the cluster. </li><li>  Finally, the units themselves must be grouped into categories in order to display correctly in the menu, and take this information into account when formatting / translating units. </li></ul><br>  Initially, the units I store as text files (it is easier to edit them), separately - basic information, localization for each language separately.  Here is a file for speeds (free). <br><br><pre> <code class="hljs swift">knot kn,kt <span class="hljs-number"><span class="hljs-number">0.514444</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> impAdd #   <span class="hljs-number"><span class="hljs-number">11</span></span>  -      ‚Äî  <span class="hljs-number"><span class="hljs-number">295</span></span> /  <span class="hljs-number"><span class="hljs-number">1062</span></span> /. <span class="hljs-type"><span class="hljs-type">Mach</span></span> <span class="hljs-type"><span class="hljs-type">M</span></span> <span class="hljs-number"><span class="hljs-number">295.0464</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> other speed of light <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-number"><span class="hljs-number">299792458</span></span> <span class="hljs-number"><span class="hljs-number">0.11</span></span> siAdd meter per minute m/<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> siAdd2 centimeter per second cm/s <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> siAdd2 ^minutes per kilometer <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>/km <span class="hljs-type"><span class="hljs-type">FORMULAE</span></span>(<span class="hljs-number"><span class="hljs-number">16.666666667</span></span>/<span class="hljs-type"><span class="hljs-type">X</span></span>,<span class="hljs-number"><span class="hljs-number">16.666666667</span></span>/<span class="hljs-type"><span class="hljs-type">X</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span> other ^minutes per mile <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>/mi <span class="hljs-type"><span class="hljs-type">FORMULAE</span></span>(<span class="hljs-number"><span class="hljs-number">26.805555556</span></span>/<span class="hljs-type"><span class="hljs-type">X</span></span>,<span class="hljs-number"><span class="hljs-number">26.805555556</span></span>/<span class="hljs-type"><span class="hljs-type">X</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span> other</code> </pre> <br>  From them I get JSON-files that were originally used for work.  Unfortunately, this was not enough flexibility and speed.  Therefore, now all the data is packed into the SQLite database and read from there as necessary.  The base format repeats, more or less, the structure of the JSON file, which was this: <br><br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"fml"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"abbrs"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"m\/s"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"us"</span></span>: <span class="hljs-string"><span class="hljs-string">"si"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"meter per second"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pri"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">2000002</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cof"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"meter per second"</span></span> ] }, ... ]</code> </pre> <br>  In addition to the database with the main data, you still need a search tree.  Angstrom can work in two modes: <br><br><ul><li>  translation within the application, when there are three lines "number", "one times", "one two".  In this case, you need to find two units in rows, and then calculate the result.  Recognition goes, as usual.  We run along a tree with dips, in the nodes of which the letters live, and a list of units is attached to each of the nodes.  We ran to the desired node, got a list of units, displayed the options (or took the first one if only one is needed). </li><li>  line translation.  For example, we dictated something (on the clock, or using standard dictation), or copy-paste from another application.  In this case, the procedure is approximately as follows: <br><ul><li>  Break the string into words </li><li>  We clean out too much, prepare, make the first portion of magic (for example, we replace second, since the system recognizes this not as a ‚Äúsecond‚Äù, but as a ‚Äúsecond‚Äù, which is usually wrong). </li><li>  Parsim number.  Here the second portion of magic is applied.  The fact is that <code>NSNumberFormatter</code> can parse lines-like-numbers, for example, it can recognize as ‚Äúthirty-four‚Äù as ‚Äú34‚Äù.  This is a super feature, which is incredibly difficult to use correctly, since we have not just a number, but a string from which this number needs to be extracted.  You have to run through the words using ever expanding ranges to try to parse the largest possible number. </li><li>  The remaining words are trying to parse into units, either one or two.  There is the most magic here, since the user can speak as he wants, in any order.  We have to create a bunch of heuristics that correctly respond to certain marker words.  The basis here is still the same search for the unit tree as in the normal version. </li></ul></li></ul><br>  Both of these modes use the unit tree.  You could use standard text search, for example, from SQLite, but then you would have to mess around with tokenizers and settings, so I decided to just write my own.  The difficulty here and there is similar, but with mine I have more opportunities for optimization. <br><br>  Nodes in the search tree are stored in separate files.  Here are these (I took a very short one): <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"p"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-attr"><span class="hljs-attr">"u"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">""</span></span>:[[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">13</span></span>,<span class="hljs-number"><span class="hljs-number">631</span></span>]]},<span class="hljs-attr"><span class="hljs-attr">"s"</span></span>:{},<span class="hljs-attr"><span class="hljs-attr">"f"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>}</code> </pre> <br>  This allows you not to store it entirely in memory, loading as needed.  The tree is big, and it greatly speeds up the launch, work on older devices (Angstrom works fine on iPhone 4) and reduces the load on the memory. <br><br>  I packed the <code>DPLPacker',</code> which is written in my article about <a href="https://habrahabr.ru/post/278683/">iTrace</a> .  There are almost 7500 of them at the moment, and it would have been very bad without the packaging. <br><br>  All the information about the units in Angstrom is now about five megabytes, and the application file in the store is 13.2 megabytes.  Immediately obvious, the application - about the transfer of units :) <br><br><h2>  Optimization </h2><br>  Optimization is a question that does not always arise before application developers.  The speed of development of technology allows sometimes either just to score on it, or to do "something simple", and that's enough.  Angstrom also has to be used in quite extreme conditions, for example, on the Apple Watch, or on an old iPhone 4 (while iOS 7 is supported).  These devices have little memory and a relatively slow processor.  Therefore, it is necessary to optimize everything, and at the same time not to forget that in the future there may be 10 times more different units (now there are about 1050 of them). <br><br>  There are three main points to optimize: <br><br><ul><li>  Start application.  To debug the start, we use Instruments, and we throw out everything we can from the start.  All updates - start a couple of seconds after the start.  No downloads of units, except those on the screen, no heavy resources. </li><li>  Search unit.  For this, I did a search tree, and broke the information into separate files.  They entered a letter - they downloaded exactly the file about this letter, nothing more.  In the files themselves, the information is stored in a very compact form (aids, simple lists). </li><li>  Memory usage.  The techniques here are similar to the previous point, since the main consumer of memory is just the base unit.  SQLite, along with a search tree that is fragmented by files, solves the problem well. </li></ul><br>  Even before the development of Angstrom, I learned that it is very convenient when there is a task that is extremely limited in some resource.  For example, for the application to work on the Apple Watch, you need to optimize the speed, the first version of the watch is very, very slow, and parsing has a natural text, it takes significant time.  Also, in version 1.8, the parsing occurs in several languages ‚Äã‚Äãat once, so that you can dictate in Russian, even if the interface is in English (the dictation itself does not give any indication of what language is currently being used).  Optimization for such a "bad" device improves performance for the rest, more modern and faster. <br><br>  To make Today Extension (now it is turned off, as it is buggy and does not work well), the most severe optimization from memory was required.  I wanted him to parse a string from the clipboard (and not just show a couple of lines), this required a fully-fledged application.  The funny thing is that Apple is talking about the amount of memory available for this kind of expansion.  ‚ÄúNot enough,‚Äù they say.  How much is it enough?  ‚ÄúThe smaller the better!‚Äù No specific numbers.  Therefore, the optimization of memory - to the limit. <br><br>  This all brings the optimization requirements to an extremum.  We have to use all known techniques, invent new data structures (more precisely, use well-forgotten old ones), stick a stick at parallelism, look attentively at what Instruments shows, throw out algorithms from time to time that hinder more complex, but also more efficient. <br><br>  I even advise sometimes, if you are developing an application, take the most braking device that is, and run, drive on it.  I have a special for this and the iPhone 4, and the fifth-generation iPod Touch (there is the same hardware as the iPhone 4S).  The first one is almost irrelevant, but the second one will be relevant for another year and a half (everything stands on it, including the latest for today iOS 9). <br><br><h2>  Equipment.  Appearance </h2><br>  I already wrote a little about the appearance.  For example, you can read about the <a href="http://www.lonelybytes.com/blog-ru/2015/1/29/roundpixels">correct rounding of corners</a> in my blog, there is also about <a href="http://www.lonelybytes.com/blog-ru/2015/3/22/-ios-ui-automation">testing UI</a> .  But there are several points that I have not yet described. <br><br><h4>  Keyboard </h4><br>  The keyboard in Angstrom is always shown, except when it is not shown.  It moves (try to right to the right of the first screen), it disappears (connect an external keyboard or hide it on the ipad), and it can be different (iphone / ipad / ipad pro).  Our digital keyboard is also attached to it, which is narrow <br><br><img src="https://habrastorage.org/files/607/1b7/ff5/6071b7ff53ae456ea5f2ba46a101a802.png" width="200"><br>  It happens high <br><br><img src="https://habrastorage.org/files/a9d/0c4/15c/a9d0c415c36045ed87c4ae7c4622c244.png" width="200"><br>  It happens Aypadnaya <br><br><img src="https://habrastorage.org/files/0bd/150/e2c/0bd150e2c3df4728a6a78d5a1fafedc6.png" width="400"><br>  In version 1.8, she learned how to switch in order to be able to enter hexadecimal or Roman numerals.  Summing up, everything is difficult. <br><br>  I will tell you about two things.  How to move the keyboard, and how to make the bass (our digital) work in Accessibility. <br><br>  To move the keyboard, you need to understand the device windows in iOS.  Each application has its own window (UIWindow), but if modal dialogs or keyboards appear, the number of windows increases.  If you use something like <a href="http://revealapp.com/">Reveal</a> , then the hierarchy is visible very well: <br><br><img src="https://habrastorage.org/files/f3a/75c/46d/f3a75c46dd694de79d7750f8ea0f156e.png" width="400"><br>  In the picture (from far to near) layers: <br><br><ul><li>  Uiscreen </li><li>  main application window </li><li>  window in which the system sticks custom keyboard </li><li>  keyboard window </li></ul><br>  You can see right away (I love Reveal for that), what and how you need to move in order to work.  As a result, I move the main window as I want (I have complete control over it), I too can at least get my keyboard from the links and move: <br><br><pre> <code class="hljs objectivec">_keypadView.transform = <span class="hljs-built_in"><span class="hljs-built_in">CGAffineTransformMakeTranslation</span></span>(_keypadView.virtualFramePositionX, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  I can get the keyboard window by going through all the application windows, or simply by trying to get the last window if it looks like a keyboard: <br><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *windows = [<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> sharedApplication].windows; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-built_in"><span class="hljs-built_in">NSStringFromClass</span></span>([windows.lastObject <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]) contains:<span class="hljs-string"><span class="hljs-string">@"Keyboard"</span></span>]) { _keyboardWindow = windows.lastObject; }</code> </pre> <br>  Why I do not use enumeration of all windows in the application every time, caching value?  This is quite slow in iOS 9 (and earlier it was normal).  Therefore it is necessary to optimize (the code should work 60 frames per second, with interactive svaypah).  To speed up, I also check that the frame of the window has really changed and update it exclusively in the right situation.  And not the frame, but only the center, since the window sizes always remain the same, and changing the frame can lead to much more serious changes than just changing the position of the view. <br><br>  If you move the keyboard like me, then be prepared for glitches.  Glitches in each version of iOS are different, they appear in: <br><br><ul><li>  No keyboard in modal dialogs.  For example, if in Ebout Angstrem open the creation of a letter, there may be no keyboard (or maybe) in the dialogue.  It was in older versions of iOS, when the same keyboard was used for all windows.  They left alone, all the others left.  Need to return. </li><li>  Shifted elements.  In the same letter creation dialog, for example, a <code>UIMenuController</code> can move. </li><li>  In difficult cases of working with the keyboard (left, it seemed for the modal controller, returned) - the keyboard may disappear.  Apparently, the keyboard window itself is recreated from time to time and the old link is lost. </li></ul><br>  Also be prepared for the fact that the keyboard may disappear (or another one will appear).  For example, when purchasing an extended set of units, a system keyboard appears for entering a password.  After completion of the purchase procedure (no matter how it is completed), you need to return the keyboard back. <br><br>  In general, the recommendation is simple.  Do not touch the keyboard for no reason, let the system do it.  Otherwise plunge, as I plunge, there is a lot of rake. <br><br><h2>  Accessibility </h2><br>  I really wanted our kipad, even if not looking like a standard keyboard, to behave in a similar way.  At first I tried to find out how to play the sound of a pressed key.  Joyful, I learned about <code>UIInputViewAudioFeedback</code> , and about the <code>[[UIDevice currentDevice] playInputClick]</code> , which does exactly what you need. <br><br>  After that, I needed to support accessibility, that is, the work of the application, when it is used by users with disabilities.  For ordinary interface components, nothing is easier.  We set for component a few, and all. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isAccessibilityElement = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.accessibilityLabel = <span class="hljs-string"><span class="hljs-string">@" "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.accessibilityHint = <span class="hljs-string"><span class="hljs-string">@",    "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.accessibilityValue = <span class="hljs-string"><span class="hljs-string">@""</span></span>;</code> </pre> <br>  With kipad everything turned out to be more difficult.  I draw it entirely to make it easier to draw the background gradient, and in older versions to round the corners. <br><br>  In order to maintain both keyboard behavior (clicks) and everything else, we had to create transparent <code>UIButton,</code> buttons over the drawn keyboard <code>UIButton,</code> which values ‚Äã‚Äãare correctly written, and carefully monitor that they change when the keyboard is changed (in the latest version, Roman input and hexadecimal numbers). <br><br>  If the Accessibility topic is interesting to you, I can tell you more about it.  Or you can look at the relevant sessions with the WWDC, they are very good: <a href="https://developer.apple.com/videos/play/wwdc2015/201/">iOS Accessibility</a> and <a href="https://developer.apple.com/videos/play/wwdc2015/204/">Apple Watch Accessibility</a> <br><br>  Accessibility also helped me in testing, which I described <a href="http://www.lonelybytes.com/blog-ru/2015/3/22/-ios-ui-automation">in</a> more detail <a href="http://www.lonelybytes.com/blog-ru/2015/3/22/-ios-ui-automation">in my blog</a> . <br><br><h2>  Questions? </h2><br>  Maybe they are interested in some other features or implementation details?  Ask! <br></div><p>Source: <a href="https://habr.com/ru/post/278695/">https://habr.com/ru/post/278695/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278683/index.html">iTrace. How are the letters written?</a></li>
<li><a href="../278685/index.html">Overview of synchronization primitives - spinlock and secrets of the processor core</a></li>
<li><a href="../278689/index.html">iBeacon. Myths and Reality</a></li>
<li><a href="../278691/index.html">PowerShell Remoting - setup and remote management</a></li>
<li><a href="../278693/index.html">turn string into scriptblock</a></li>
<li><a href="../278697/index.html">libuniset2 is a library for creating ACS. It‚Äôs better to see once ... Part 6 (Final)</a></li>
<li><a href="../278699/index.html">QA: Conference. We tell about the reports</a></li>
<li><a href="../278701/index.html">Foreach - from the book PowerShell in depth</a></li>
<li><a href="../278705/index.html">AMD fixes microprocessor microcode vulnerability</a></li>
<li><a href="../278709/index.html">Conferences in 3CX Phone System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>