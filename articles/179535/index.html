<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Million PPS per second - connectedness and balancing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the last RIT ++ conference I was lucky to be the first speaker of a conference of such a scale and of such significance. In this article, I do not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Million PPS per second - connectedness and balancing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b96/cfb/f9a/b96cfbf9abf321fe1a78229cd6b02bd6.jpg" align="left"><br>  At the last RIT ++ conference <a href="http://ritconf.ru/2013/abstracts/467.html">I was lucky to</a> be the first speaker of a conference of such a scale and of such significance.  In this article, I do not just want to retell everything that I reported.  It was unusual for me to speak for such a large audience for the first time and I forgot to tell half, I was nervous a little.  It will be about creating from scratch your own fault-tolerant structure for web projects.  Few system administrators are given the opportunity to start a large project in production from scratch.  I was lucky. <br><br>  As I have already written, I could not tell everything that I planned from the stage, in this article I will fill these gaps, and for those who could not attend, it would be nice, the video from the conference was not given to everyone for free.  Yes, and I wanted to become a Habr user for a long time, only there was no time.  May holidays gave time and effort.  The article will be not so much technical with a bunch of configs and graphs - the article will be principled, all the gaps of minor technical issues can be filled in the comments. <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage2/056/775/67d/05677567deff76869545b86a3fa01226.jpg"><br><br>  <b>We set the task</b> : we need to organize a 99.9% fault-tolerant web project, which will not depend on a specific data center (DC), have double redundancy on switching to DC, have fault tolerance on balancing and very quickly enter and output a Real server.  If one of the DCs falls, the second one should receive all traffic without drops and retransmitters.  We will only talk about the front, about failures, balancing and a bit about the deployment of such a large number of servers.  All have their own specificity backend. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Connectivity reservation</b> <br><br>  The project, which I do is very critical to even minute failures.  If you sum up the RPS 400+ top Runet projects: Yandex, Mail, Rambler, Poster, Auto, etc., get our total RPS.  At some point it became clear that if you keep all the eggs in one basket (DC), you can fall very well and beautifully.  If you recall Chubais ‚Äôpuffs in Moscow, you can understand me.  We began to study the issue of separation of the server farm into several DCs.  The main question is not to scatter the server on several DCs that are not connected by the same trunk, but quickly and seamlessly for the client to switch traffic from one DC to another. <br><br><img src="https://habrastorage.org/storage2/925/514/a19/925514a190d84d098068d5b94dd67c88.jpg"><br><br>  At once I will make a reservation: the implementation chosen by us is possible only if we have our own AS with a minimum of / 23 mask, officially cut into RIPE into 2 networks of / 24.  Honestly, I do not know how it is at the moment, but earlier there were problems with transit announcements for the same TTK networks less than / 24.  We chose as routers in the Cisco ASR 1001 DC with the corresponding filling and the ability to work with EXIST-MAP, NON-EXIST-MAP.  Consider the example of 2 DC.  2 ASRs keep the tunnel just to know that the connectivity of both DCs is alive.  From one DC we announce one class C network, from the second DC - the second network.  As soon as we see from the second DC that the connectivity is broken, we start using NON-EXIST-MAP to announce the second network / 24 from the first DC.  It is advisable to carry the DC geographically - but it is on the budget and color. <br><br>  <b>Here an important point, to which we will return a little later</b> : on the balancing servers and on the Real servers the <b>IP addresses from both networks in both DCs should be constantly raised simultaneously</b> , this is important.  If all the DCs are correctly connected, the routes are guided, who answers the addresses of this or that network, so you need a tunnel between the routers so that the head is not carried away.  <b>I ask the OpenSource community not to kick with</b> my <b>feet</b> - I know how to implement this on quagga with prefix weights, but the project is large and there are corresponding requirements.  I am simply telling how this is implemented in our country. <br><br>  When testing route changes, we stumbled upon an unpleasant situation: <b>many have Juniper access</b> .  Let me explain why unpleasant.  By default, the route change is announced once every 3 minutes.  For us, it's a loss of hundreds of gigabytes of data.  We started experimenting with reducing the time of announcements - up to 20 seconds everything was fine: announcements rose from different ends of our huge motherland perfectly and faster, but after reducing this parameter we lost one of the DC.  As it turned out, Juniper, who served one of the uplinks for less than 20 seconds, is considered a flood and it is not possible to reduce it, these are features of the firmware.  Total: <b>21 seconds</b> - the best option. <br><br>  So.  Everything.  Failover for 2 DC we made, tested - it works.  The real time of switching routes in Russia - from 25 to 60 seconds - depending on the distance and transit.  At this stage, we have 2 bare DCs with routers.  Let's start putting the stuffing in both DCs. <br><br>  <b>Redundant switching inside DC</b> <br><br><img src="https://habrastorage.org/storage2/306/38f/19c/30638f19c157b6bbe970716eb3ccdcdb.jpg"><br><br>  Here I will be brief - switching inside the DC is made 2 to 2: 2 physical interfaces in Bond look at different switches in vlan, serving real IP addresses, 2 physical interfaces in Bond look at different switches in vlan, serving backend.  Bonding mode, we chose the simplest mode = 1 - to failure, we simply scattered the zero parts of the bonding on different switches.  In general, <b>the simpler, the more reliable</b> .  On each server participating in the front and back - 4 physical interfaces.  The picture shows only the front.  The switches are connected not only over 10G, but also with a backup power cable and are connected to different UPSs.  Mode = 1 does not require special configuration of switches, which simplifies the management of the entire infrastructure. <br><br>  <b>Balancing</b> <br><br><img src="https://habrastorage.org/storage2/f45/e50/23d/f45e5023d9c6c1278c3936ea1e2549d7.jpg"><br><br>  Actually there were no specific alternatives, IPVS was selected in DR (Direct Routing) mode.  As I said above, this balancing method is less expensive.  It deprives the charms of dumping connections in both directions, as in NAT, but requires less resources.  Notrack lovers will say - it is better not to do this if it is important for you to save 100% of the compounds.  IPVS is a regular at Centos and does not require special shamanism during installation.  The only nuance we encountered is that by default IPVS is ready to accept 4096 simultaneous connections - this is 12 bits. <br><br><img src="https://habrastorage.org/storage2/1a8/d4f/a6a/1a8d4fa6acdda35abd6a4b1e8f905570.jpg"><br><br>  In order for the balancer to be ready to accept a million connections, this parameter needs to be increased to 20 bits.  It was not possible to do this through options in the module management (modprobe.d) - ipvsadm also stubbornly repeated that it was ready to serve 4096 connections.  I had to run my pens in src and rebuild the module.  For a small project, this is not so important, but if you are servicing hundreds of thousands and above connections, this is critical. <br><br>  Balancing has many methods.  The easiest one - RR (Round Robin) - to send incoming connections ‚Äúin a circle‚Äù to the Real server.  But we chose the WLC type - weighted balancing with connection control.  If we synchronize the persistence parameter on the balancer with the keepalive parameter in nginx on Real servers, then we will get harmony in the connections.  Just if, for example, the persistence on the balancer is 90 seconds, and keepalive in nginx on Real - 120, then we will get the following situation: the balancer will give all client connections to another Real in 90 seconds, and the old Real will keep the client connections.  If we take into account that with 30 seconds keepalive for 10 thousand ESTABLISHED connections, we have about 120 thousand TIME_WAIT (this is perfectly normal, Igor Sysoev and I thought on the sidelines of the mail technoforum), then this is quite critical. <br><br>  Now, by the balancing technology itself, how it works: the IP address that we have is registered in the DNS for the domain we broadcast to the external physical interface of the balancer and to the aliases of the loopbacks of Real servers.  Below is an example of the configuration of sysctl Real servers - there it is necessary to cover the arp announcements and, optionally, source routing, in order for switching not to go crazy with IP duplication.  I will not describe the entire sysctl - it is specific enough for each project - I will show only the parameters that are mandatory for DR specificity. <br><br>  For balancers: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Fast port recycling (TIME_WAIT) net.ipv4.tcp_tw_recycle = 1 net.ipv4.tcp_tw_reuse = 1 # Local port range maximized net.ipv4.ip_local_port_range = 1024 65535 # Dont allow LB send icmp redirects on local route net.ipv4.conf.eth1.send_redirects = 0 net.ipv4.conf.eth0.send_redirects = 0 net.ipv4.conf.lo.send_redirects = 0 # Dont allow LB to accept icmp redirects on local route net.ipv4.conf.eth1.accept_redirects = 0 net.ipv4.conf.eth0.accept_redirects = 0 net.ipv4.conf.lo.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.all.send_redirects = 0 net.ipv4.conf.all.accept_redirects = 0 # Do not accept source routing net.ipv4.conf.default.accept_source_route = 0 # Ignore ARP net.ipv4.conf.eth0.arp_ignore = 1 net.ipv4.conf.eth1.arp_ignore = 1 net.ipv4.conf.all.arp_ignore = 1 net.ipv4.conf.default.arp_ignore = 1</span></span></code> </pre> <br><br>  For Real servers: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sysctl.conf net.ipv4.conf.bond0.arp_ignore = 1 net.ipv4.conf.all.arp_ignore = 1 net.ipv4.conf.default.arp_ignore = 1</span></span></code> </pre><br><br>  Routing for loopback alias with real IP on Real servers with mask 255.255.255.255 should be assigned to the IP of the router serving your network and announcing it to the outside, otherwise requests for balancing will come, but Real will not respond.  Some are wise with iproute2 and VIP tables, but this complicates the configuration. <br><br>  Now about failover balancing and Real.  Keepalived was chosen perfectly logical - the IPVS developers themselves recommend using it in conjunction with their product.  The nominal scheme - MASTER + SLAVE is suitable for 99% of projects, but this did not suit us, because at the moment there are 5 balancers in one DC, in the other 3. The average cost of the blade is 120-140 thousand, so we decided to save a little.  If you look closely at the keepalived configuration section, where groups are described, it becomes clear that if you specify different groups on 2 masters and describe both in the 1st slave, then 1 slave will work for 2 masters according to the scheme: 1 master fell out, The slave picked up its IP, but if the second one fell out, then the second IP is picked up on the same slave.  There is a minus, of course, when both masters take off, a double load will fall on the slave, but for the balancer it is not very critical, unlike Real. <br><br>  And one more little trick: in the keepalived config, the CHECK of Real servers is provided.  It can be a simple TCP, it can pull an HTTP page over the control of the 200th response, but there is a MISC_CHECK.  Stuck comfortable and functional.  If you put a small script on the Real server, no matter what is written on it, which according to your logic will calculate the current LA and generate the dynamic weight of the Real server for the balancers, then you will get a dynamic change in the Real's weight using the MISC_DYNAMIC parameter on the balancer. <br><br>  <b>Deploy</b> <br><br>  A little bit of delay.  Deploy is an automation of server deployment.  If you have 2-3-4 servers, of course you will not deploy automation, but if you have dozens or hundreds of them, then you definitely need it, especially if the servers are grouped by the same tasks. <br>  I have only 2 groups on the front - these are balancers and Real servers with nginx, which actually give the content to the user. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># file top.sls base: '*': - ssh - nginx - etc 'ccs*': - ccs 'lb*': - lbs</span></span></code> </pre><br><br>  There are many deployment systems - puppet, chief ..., but we chose salt (saltstack.org).  How it works: on the salt server in the configuration you create server groups and for each group paint the deployment plan - it includes system users and groups that are required for the services to function, configuration files that should be on all servers, installed software ... <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># file /srv/salt/etc/init.sls /etc/hosts: file: - managed - source: salt://files/hosts /etc/selinux/config: file: - managed - source: salt://files/selinux.config /etc/snmp/snmpd.conf: file: - managed - source: salt://files/snmpd.conf</span></span></code> </pre><br><br>  If the configuration files require data unique for each server, the salt contains a pillar template engine that can generate unique configs on the fly.  Before deploying the entire farm, I started from the deployment server, so that after the formation of the server farm is completed, I can be sure that the deployment is written correctly.  And so I advise you. <br><br>  This is only part of the report.  Be sure to choose the time and write a separate article on how to test web farms, ‚Äúsqueezing‚Äù the maximum from nginx without drops and retransmitters, the differences between synthetic and production tests. <br><br>  <b>Good luck in highload!</b> </div><p>Source: <a href="https://habr.com/ru/post/179535/">https://habr.com/ru/post/179535/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179523/index.html">DBMS Cach√©. Woodworking - SQL access to multidimensional data structures</a></li>
<li><a href="../179525/index.html">Solving the border-radius + overflow: hidden problem with canvas</a></li>
<li><a href="../179529/index.html">We write the simplest scripting programming language in C # (Part 1)</a></li>
<li><a href="../179531/index.html">How I chose Android for testing</a></li>
<li><a href="../179533/index.html">Improving 3d printing quality with cooling</a></li>
<li><a href="../179537/index.html">Sysadmin to 1C developer</a></li>
<li><a href="../179539/index.html">Game Boy Pocket: quick review + giblets</a></li>
<li><a href="../179541/index.html">Remove the starry sky with Emgu CV</a></li>
<li><a href="../179543/index.html">How to drop Windows with six lines of code</a></li>
<li><a href="../179547/index.html">How are you looking for freelance orders on exchanges?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>