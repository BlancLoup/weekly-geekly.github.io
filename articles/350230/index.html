<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We summarize the animation tables in iOS applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Users want to see changes. 
 Animated updating of lists has always been a challenge in iOS. What is unpleasant, it has always been a routine task. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We summarize the animation tables in iOS applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/sz/d6/q9/szd6q9fn8sdn4efqw6d2tv1yxq4.gif" alt="image" align="right"><br><h4>  Users want to see changes. </h4><br>  Animated updating of lists has always been a challenge in iOS.  What is unpleasant, it has always been a routine task. <br><br>  Applications of large companies such as Facebook, Twitter, Instagram, VK, use tables.  Moreover, almost every iOS application is written using UITableView or UICollectionView and users want to see what changes on their screens, for this reason reloadData is not suitable for updating the screen.  Having looked at several existing frameworks for this task, I was surprised at how much they generalize in themselves, besides calculating animations.  Some even when inserting one element in the beginning, happily reported the movements of all other elements. <br><br>  Having started to solve the problem of generalizing the construction and launch of animations, I still did not understand such a large number of pitfalls in the wilds of UIKit.  But first things first. <br><a name="habracut"></a><br><h3>  Calculation of changes </h3><br>  To try to animate a table, you first need to figure out what has changed in the two lists.  There are 4 types of cell changes: add, delete, update and move.  Adding and deleting calculations is quite simple; you can take two subtract lists.  If the element is not in the original list, but is in the new one, then it was added, and if it is in the original one, but not in the new one, then it was deleted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initialList: <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>&lt;Int&gt; = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultList: <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>&lt;Int&gt; = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> insertList = resultList.subtracting(initialList) <span class="hljs-comment"><span class="hljs-comment">// {4} let deleteList = initialList.subtracting(resultList) // {7, 2}</span></span></code> </pre> <br>  Updating a cell is a bit more complicated.  Comparison of cells is not enough to determine the update of the cell and you have to assign it to the user.  To do this, the <i>updateField</i> field is <i>started</i> , in which the user gives a sign of the cell relevance.  This could be a <i>Date</i> (Timestamp), some kind of integer or string hash (For example, a new text of a modified message).  In general, this is the sum of the fields that are drawn on the screen. <br>  The situation is similar with movement, but a bit different.  Theoretically, we can, comparing the fields, find out that one has moved relative to the other, but in practice the following happens: <br><br>  For example, there are two arrays, <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> a = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> b = [<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]</code> </pre><br>  Quickly glancing at the list, it is immediately obvious that ‚Äú4‚Äù changed its position and moved to the left, but in fact it could happen that ‚Äú1‚Äù, ‚Äú2‚Äù and ‚Äú3‚Äù moved to the right, and ‚Äú4‚Äù remained in place .  The result is the same, but the methods are completely different, and different, not only logically, but also visually, the animation for the user will be different.  However, it is impossible, having on hand only a way of comparing the elements, absolutely say what exactly has moved. <br>  But what if we introduce the statement that elements only move up?  Then it becomes clear <b>what</b> exactly has moved.  Therefore, it is possible to choose the priority direction for calculating movements.  For example, when writing an instant messenger, a particular chat is likely to move from the bottom up when a new message is added.  However, you can provide a function to indicate the movement of a cell.  Suppose in a model <i>view</i> there is a field <i>lastMessageDate</i> , which changes with a new message and, accordingly, the sort order of the view model is changed relative to the others. <br>  As a result, we calculated all 4 types of changes.  Things are easy - apply them. <br><br><h3>  Apply changes to a table </h3><br>  In order to start changes in the table, special mechanisms of changes are provided in the UITableView and UICollectionView, so we just use the standard functions. <br><br><pre> <code class="hljs sql">tableView.beginUpdates() self.currentList = newList tableView.reloadRows(animations.toUpdate, <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: .fade) tableView.insertRows(<span class="hljs-keyword"><span class="hljs-keyword">at</span></span>: animations.toInsert, <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: .fade) tableView.deleteRows(<span class="hljs-keyword"><span class="hljs-keyword">at</span></span>: animations.toDelete, <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: .fade) tableView.reloadRows(<span class="hljs-keyword"><span class="hljs-keyword">at</span></span>: animations.toUpdate, <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: .fade) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> animations.cells.toMove { tableView.moveRow(<span class="hljs-keyword"><span class="hljs-keyword">at</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>) } tableView.endUpdates()</code> </pre><br>  We start, check, everything is fine, everything works.  But only for the time being ... <br><br><img src="https://habrastorage.org/webt/ak/hr/ra/akhrraekokzpdkydeevvacw03ky.png" alt="image"><br><br>  When we try to update and relocate a cell, we fall with the error: <br><br>  The first thought that comes to mind is: ‚ÄúBut I'm not trying to delete a cell!‚Äù.  In fact, <i>move</i> and <i>update</i> is nothing more than <i>delete</i> + <i>insert</i> , and the table does not like such actions and throws an error (I was always surprised why not <i>try try-catch</i> ).  It is treated simply, we make updates in the next cycle. <br><br><pre> <code class="hljs erlang">tableView.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>Updates() // insertions, deletions, moves‚Ä¶ tableView.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>Updates() tableView.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>Updates() tableView.reloadRows(animations.cells.toDeferredUpdate, with: .fade) tableView.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>Updates()</code> </pre><br>  We now turn to one of the most difficult problems that had to be solved. <br>  Everything seems to work fine, but when the cell is updated, a strange ‚Äúblinking‚Äù is seen, and regardless of whether the animation style is .fade or .none, although this is not logical. <br>  It seems to be a trifle, but in the presence of a decent amount of updates in the table, it starts to disgustingly ‚Äúremarc‚Äù, which is something you don‚Äôt want.  To get around this, you have to synchronize the insert-delete-move and update animations.  That is, until the first <i>.endUpdates () is</i> finished, you cannot start a new <i>.beginUpdates ()</i> .  Because of this seemingly minor problem, I had to write a sync animation class that handles the whole thing.  The only drawback was that now the changes are not applied synchronously, but deferred, that is, they are put in a sequential queue. <br><br><div class="spoiler">  <b class="spoiler_title">Animation Synchronization Code with DispatchSemaphore</b> <div class="spoiler_text"><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">let</span></span> operation = BlockOperation() // 1.  .      ,          operation.addExecutionBlock { // 2.   .    ,       //          guard <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> currentList = DispatchQueue.main.sync(execute: getCurrentListBlock) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { // 3.    <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> animations = try animator.buildAnimations(from: currentList, to: newList) var didSetNewList = <span class="hljs-literal"><span class="hljs-literal">false</span></span> DispatchQueue.main.sync { // 4.   ,    mainPerform(self.semaphore, animations) } // 5.    _ = self.semaphore.wait() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !animations.cells.toDeferredUpdate.isEmpty { // 6.    ,    update  DispatchQueue.main.sync { deferredPerform(self.semaphore, animations.cells.toDeferredUpdate) } _ = self.semaphore.wait() } } catch { DispatchQueue.main.sync { onAnimationsError(error) } } } self.applyQueue.addOperation(operation)</code> </pre><br></div></div><br>  Inside <i>mainPerform</i> and <i>deferredPerform</i> the following happens: <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.performBatchUpdates({ // <span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>, delete, move... }, completion: { _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> semaphore.signal() })</code> </pre><br>  Finally, having completed the idea, I believed that I knew everything about anomalies, until I came across a strange bug that does not always recur, but on certain sets of changes, when you apply updates along with movements.  Even if the update and the move absolutely do not intersect at all, the table can throw a fatal exception, and I finally made sure that it could not be resolved, except for bringing the <i>reload</i> into the next cycle of animations.  ‚ÄúBut you can ask a cell from a table and forcibly update its data,‚Äù you say.  It is possible, but only in the case when the height of the cells is static, because it cannot simply be recalculated. <br><br>  There was another problem later.  With the AppStore, errors in the fall of the table began to arrive frequently.  Thanks to the logs, it was not difficult to identify the problem.  In the calculation function of the animation passed invalid lists of the form: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> a = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> b = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>]</code> </pre><br>  That is, the same elements were duplicated.  It is treated quite simply, the animator began to throw an error in the calculation (Note the listing above, there the calculation is wrapped in a <i>try-catch</i> block, just for this reason).  Determining inconsistency by comparing the number of elements in the source array (Array) and the set of elements (Set).  When adding an element to the Set, in which it already exists, it is replaced, and therefore the elements in the Set refuse less than in the array.  This check can be turned off, but it is not recommended to do this.  Believe me, in so many places it saved from an error, despite the developers' confidence in the correctness of the arguments passed. <br><br><h3>  Conclusion </h3><br>  Animated tables in iOS is not so easy.  Most of the complexity is added by the closed source code of UIKit, in which it is impossible to always understand in which cases it throws an error.  Apple's documentation on this issue is extremely scarce and says only about which indices of the list (old or new) it is necessary to transfer changes.  The way of working with sections of tables is no different from working with cells; therefore, examples are shown only on cells.  In the article, the code is simplified for easier comprehension and size reduction. <br><br>  The source code is on <a href="https://github.com/Nekitosss/TableAnimator">GitHub</a> , you can pick it up using <a href="https://cocoapods.org/pods/NPTableAnimator">cocoapods</a> or using the source code.  The code has been tested on many cases and currently lives in the production of some applications. <br>  Compatible with iOS 8+ and Swift 4 <br><br><h4>  Material used </h4><br>  <a href="https://developer.apple.com/documentation/uikit/uitableview/1614890-endupdates">Apple documentation on .endUpdates</a> <br>  <a href="https://developer.apple.com/documentation/uikit/uitableview/2887515-performbatchupdates">Applying changes in iOS 11</a> </div><p>Source: <a href="https://habr.com/ru/post/350230/">https://habr.com/ru/post/350230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350214/index.html">Security Week 6: ‚Äúenchanted letter‚Äù threatens apple-growers, with the world of Captcha - Monero, mining now in Word</a></li>
<li><a href="../350218/index.html">Russian storage systems from the company StoreQuant</a></li>
<li><a href="../350222/index.html">Getting command parameters from a human phrase</a></li>
<li><a href="../350224/index.html">Webpack 4 Legato released</a></li>
<li><a href="../350228/index.html">About threat modeling</a></li>
<li><a href="../350232/index.html">Oh, those modal windows or why I loved the render functions in VueJs</a></li>
<li><a href="../350234/index.html">SAML authorization bypass</a></li>
<li><a href="../350236/index.html">Installing the icecast2 server with SSL support for broadcasting over https protocol</a></li>
<li><a href="../350238/index.html">If you don't have a dog ...</a></li>
<li><a href="../350240/index.html">Nine questions about working with memory in V8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>