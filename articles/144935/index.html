<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mybuild - build system for modular applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A recent article about a new build system for Qt reminded me of a situation that was in our project several years ago - then we, too, were looking for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mybuild - build system for modular applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/6cf/c85/48c/6cfc8548c216d6230f41ee9708ccca4c.jpg" align="left">  A recent <a href="http://habrahabr.ru/post/144127/">article</a> about a new build system for Qt reminded me of a situation that was in our project several years ago - then we, too, were looking for a suitable build system.  The project is quite complex and it needs to have a flexible configuration system.  As a result, we are now using and developing our own build system, <a href="http://code.google.com/p/embox/wiki/Mybuild">Mybuild</a> . <br><br>  Who is interested to know what we have done, and what kind of project this is, which needed its own assembly system, welcome under cat. <a name="habracut"></a><br><br><h4>  about the project </h4><br><img src="https://habrastorage.org/storage2/2c4/cff/7dd/2c4cff7dd571148101c889b157e7bfba.png" align="left">  Our project is called <a href="http://code.google.com/p/embox/">Embox</a> .  It is a modular and configurable OS for embedded systems.  As you can see, configurability is inherent in the idea of ‚Äã‚Äãthe project, hence the desire to have a flexible build system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, the project was small (although it is not very large now), and we had enough samopnym makefiles, we also set all configuration options in them.  With the development of the project, ideas emerged about how to describe not just the source code for the assembly, but the modules, and even be able to set parameters for them, write dependencies, and so on. <br><br><h4>  Another build system </h4><br>  As often happens, the appetite comes with eating.  The functionality (and at the same time crutches with it) grew like a snowball, supporting the resulting assembly infrastructure became quite expensive, and simply uncomfortable, and at one point we decided to stop and look first at the ready-made solutions. <br><br>  Critique of Make and its derivatives can be found in the <a href="https://habrahabr.ru/users/mapron/" class="user_link">mapron</a> <a href="http://habrahabr.ru/post/144127/">article</a> , I already mentioned it at the beginning.  I will add that in our case, the Kbuild build system used in the Linux kernel was also considered.  Beg a little criticism of her. <br><ul><li>  Assembly and configuration files are separated.  Therefore, it is necessary to describe in several places (Makefile + Kconfig). </li><li>  Configuration parameters are specified by #define directives, which sometimes leads to "#ifdef nightmare" in the code. </li><li>  There are no namespaces for options. </li></ul><br>  Of course, there are advantages: <br><ul><li>  Kbuild supports specifying dependencies between options. </li><li>  There are several graphical (and pseudo-graphical) configuration tools. </li><li>  Stable development and community support. </li></ul><br>  Anyway, at that time it seemed to us that such a system was too complex for a relatively small project.  In addition, we already had some small developments, and therefore it was decided to formulate the requirements and try to implement our assembly system. <br><br>  So, we want to: <br><ul><li>  Application modules are described in a simple, intuitive language, preferably along with the available configuration options. </li><li>  The module description, if possible, contained all the necessary information for its further use, including user documentation, available unit tests, and so on. </li><li>  The build system didn't pull a lot of dependencies like a Python interpreter or a Java machine. </li></ul><br>  Since we started with ordinary makefiles, the resulting build system is written in pure GNU Make. <br><br><h4>  Little about implementation </h4><br>  Saying ‚Äúon pure GNU Make‚Äù, I was a little tricky.  If you ever tried to write something more complicated than the examples from the manual, then you probably also noticed the poverty of the built-in language.  Therefore, the first thing we started with was the fight against the wretchedness of the language.  In general, this topic deserves a separate article in the ‚ÄúAbnormal Programming‚Äù hub, here I will touch on only the main points (maybe someone will come in handy in their projects). <br><br><h5>  Improving Make syntax </h5><br>  The Make language is line-based, so when writing complex functions on several lines, a backslash is used.  Besides the fact that it is simply inconvenient, it prevents the use of comments inside a function, since Make only has one-line comments (starting with a lattice and valid to the end of the line). <br><br>  Having fixed this limitation, now we can write multi-line functions without backslashes, using comments inside functions and code indentation (tabs or spaces).  In addition, we have added to the language features such as lambda expressions, inline simple functions, and others.  Here's how you can now rewrite, for example, the function of turning the list: <br><table><tbody><tr><th><h6>  It was </h6></th><th><h6>  It became </h6></th></tr><tr><td><pre><code class="bash hljs">reverse = \ $(call fold,,<span class="hljs-variable"><span class="hljs-variable">$1</span></span>,__reverse_fold) <span class="hljs-comment"><span class="hljs-comment"># Called with the following args: # 1. An already reversed list part. # 2. Next element. __reverse_fold = \ $2 $1</span></span></code> </pre> </td><td><pre> <code class="bash hljs">define reverse <span class="hljs-comment"><span class="hljs-comment"># Start from the empty list. $(fold ,$1, # Prepend each new element ($2) to # the result of previous computations. $(lambda $2 $1)) endef</span></span></code> </pre></td></tr></tbody></table><h5>  Adding OOP </h5><br>  Now, when you can write more or less readable code, add another bun.  In Make, there is no typing; any data is represented as a string.  However, in any application there is a need to structure the data, so we have implemented a set of macros that allows us to define classes, as well as functions for creating objects, calling methods, etc.  For example, the following code when calling the function greet prints "Privet, Habrahabr". <br><pre> <code class="bash hljs">define class-Greeter $(field greeting, $(or $(value 1),Hello)) <span class="hljs-comment"><span class="hljs-comment"># Arg 1: who to greet. $(method sayHello, $(info $(get-field greeting), $1!)) endef define greet $(for greeter &lt;- $(new Greeter,Privet), $(invoke greeter-&gt;sayHello,Habrahabr) $(greeter))# &lt;- Return the instance. endef</span></span></code> </pre><br>  After these two improvements, development went much faster, allowing us to tackle the logic of the build system itself. <br><br><h4>  We think over syntax </h4><br>  First you need to decide on a language to describe the modules and configurations.  As a rule, internal or external DSL is used for the new language.  Internal DSL is a subset of some general purpose language, usually the one you plan to use for interpretation.  In the case of GNU Make and its clumsy language, this is not an option at all, and only an external DSL remains, that is, an independent language for describing the assembly. <br><br>  I will not beat around the bush and immediately say that the resulting language strongly resembles Java.  Personally, I like the Java syntax, although it is verbose, but in many respects simple and understandable.  As in Java, Mybuild DSL has packages and imports, and the module description is similar to the class description.  Files written in this language are called my-files (by their extension). <br><br><pre> <code class="hljs java"><span class="hljs-comment"><span class="hljs-comment">/* Our first example */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> HelloWorld { source <span class="hljs-string"><span class="hljs-string">"hello.c"</span></span> }</code> </pre><br><h4>  Building a language parser </h4><br>  Now you need to implement a parser for this language.  There are also many options, starting from a self-written parser, using, for example, the method of recursive descent or any library of combinators, and ending with various generators of parsers.  As a result of several experiments, we settled on the latter, as the most general and, therefore, convenient for development, especially at the stage of active development of the language.  We used GOLD Parser Builder (http://goldparser.org/) as a generator, it uses a simple grammar description language, has a built-in debugger, and most importantly, it has the ability to flexibly configure the generated parser (in our case it is also implemented on Make ). <br><br>  The result of the parser is a parse tree. <br><br><img src="http://habrastorage.org/storage2/044/e27/978/044e279784031e12fd939434b1032be3.png"><br><br><h4>  Build an object model </h4><br>  So, I want to extract as much information from my-files as possible, as well as to have easy access to it at all stages of the assembly.  It is clear that you need to have some kind of internal representation.  That is, now we need to turn the parse tree into a semantic model. <br><br>  At about the same stage, we simultaneously thought about the support of the language by an IDE.  In our case, this is Eclipse, since more than half of the developers in the project use this particular environment.  For the development of the plugin, we used the <a href="http://www.eclipse.org/Xtext/">Xtext</a> framework, which, according to the grammar, is able to generate a full-fledged editor with syntax highlighting, autocompletion and other pleasures of the modern IDE.  It is worth saying that Xtext itself is based on <a href="http://www.eclipse.org/modeling/emf/">EMF</a> , a well-known modeling framework.  This prompted the idea to use the EMF technology for the development of the assembly system itself. <br><br>  Thus, we get the EMF model that describes the structure of our DSL (we were kindly generated by Xtext).  Now we need to turn the model into Make classes.  This is <a href="http://www.eclipse.org/modeling/m2t/%3Fproject%3Dxpand">where the Xpand</a> project comes to the <a href="http://www.eclipse.org/modeling/m2t/%3Fproject%3Dxpand">rescue</a> (it is being developed by the same company as Xtext), which allows us to generate text from the model. <br><br>  The final step is to write a glue code that creates model objects for the necessary nodes in the parse tree. <br><br><img src="http://habrastorage.org/storage2/a1d/0fe/9f0/a1d0fe9f01b621959e88dacfcdff8ec5.png"><br><br><h4>  Back to requirements </h4><br><h5>  Dependencies </h5><br>  One of the first points in our requirements was the ability to define intermodular dependencies.  This is primarily necessary to simplify user configuration of the final application. <br><img src="http://habrastorage.org/storage2/522/227/6cf/5222276cf88bc800af4ed13264b50d96.png" align="right"><br>  In the my-file, the dependency designation is as follows. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">module</span></span> Foo { <span class="hljs-attribute"><span class="hljs-attribute">depends</span></span> Bar, Baz }</code> </pre><br>  Now that we have a complete graph of all the modules described in the project, the construction of the closure of the subgraph of the required modules is implemented quite simply. <br><br>  For ease of development, Mybuild can visualize the graph of modules using <a href="http://www.graphviz.org/">Graphviz</a> .  And as an example, here is the visualization of the module graph for one of the simple Embox configurations. <br> <a href=""><img src="http://habrastorage.org/storage2/f2c/63c/157/f2c63c1572de2390b8c12e7b714b7fba.png"></a> <br><br><h5>  Boot order at runtime </h5><br>  Having a complete understanding of the modules of the system and the dependencies between them, why not use this knowledge for anything besides the actual assembly of the project?  For example, on the basis of this information, you can determine the order of loading modules during system execution.  Indeed, as a rule, loading a module only makes sense after downloading all its dependencies. <br><br>  For this purpose, a specially generated C source code is included in the assembly, in which the nodes and edges of the dependency graph are statically set.  When compiling the modules themselves, it is possible to associate with the module a function of its initialization, which will be called by the manager by the loaders after all dependencies are resolved. <br><br><img src="http://habrastorage.org/storage2/2dc/c6d/202/2dcc6d2020f57282006a9b90e059cb84.png"><br><br><h5>  Build Parameters and Options </h5><br>  The next task we solved was specifying parameters for specific modules.  To describe a parameter, the <code>option</code> construct is used, and access to the parameter value can be obtained at compile time using a special macro. <br><table><tbody><tr><td><pre> <code class="hljs vbscript">module HelloWorld { source <span class="hljs-string"><span class="hljs-string">"hello.c"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> greeting = <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span> }</code> </pre></td><td><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, OPTION_STRING_GET(greeting)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre></td></tr></tbody></table>  And although so far this option is not very pleasant, now for the module you can set the required parameters, their default value and override these values ‚Äã‚Äãduring configuration. <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> Main { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> HelloWorld(greeting = "Hello, Habrahabr!") }</code> </pre><br><h5>  Processing linker scripts </h5><br>  The next problem, somewhat specific to the project, was that we wanted to process not only source codes (in C and assembly languages) and header files, but also other resources, in our case, for example, special linker scripts.  The makefile for preprocessing and including an additional linker script in the assembly in the previous version of the build system was the following (and such code needed to be written for each special linker script). <br><br><pre> <code class="bash hljs">$(IMAGE): $(<span class="hljs-variable"><span class="hljs-variable">$_heap_lds</span></span>) $(<span class="hljs-variable"><span class="hljs-variable">$_heap_lds</span></span>): $(<span class="hljs-variable"><span class="hljs-variable">$_SELFDIR</span></span>)/heap.lds.S $(AUTOCONF_DIR)/config.lds.h @$(MKDIR) $(@D) \ &amp;&amp; $(CPP) -P -undef $(CPPFLAGS) \ -imacros $(AUTOCONF_DIR)/config.lds.h \ -MMD -MT <span class="hljs-variable"><span class="hljs-variable">$@</span></span> -MF <span class="hljs-variable"><span class="hljs-variable">$@</span></span>.d -o <span class="hljs-variable"><span class="hljs-variable">$@</span></span> $&lt; -include $(<span class="hljs-variable"><span class="hljs-variable">$_heap_lds</span></span>).d</code> </pre><br>  Now it looks like this, and the build system decides for itself what to do with the heap.lds.S file: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">module</span></span> HeapAlloc { <span class="hljs-attribute"><span class="hljs-attribute">source</span></span> <span class="hljs-string"><span class="hljs-string">"heap.lds.S"</span></span> }</code> </pre><br><h5>  Processing other resources </h5><br>  In the previous example, the definition of the type of the file specified in source occurred by its extension (.lds.S).  Sometimes it is necessary to mark certain files so that they are processed in a special way.  For example, in our project, these are files whose contents should be available during execution. <br><br>  Here we used the annotation mechanism, borrowed again from Java.  The first thing we implemented with their help is the ability to mark a resource as requiring copying to the folder with the root file system, that is: <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">module</span></span> Httpd { @ InitFS source <span class="hljs-string"><span class="hljs-string">"index.html"</span></span> }</code> </pre><br>  Annotations can be set for any type of objects in our system, be it modules, their dependencies, source code files or parameters, as well as other annotations.  Thus, we hope that we have laid out in the language good opportunities for its expansion. <br><br><h5>  Inheritance and abstract modules </h5><br>  And finally, I will describe one very interesting, in my opinion, feature that we haven‚Äôt met in other similar projects, namely the ability to specify interfaces and their implementations. <br><br>  Since we have a highly configurable OS, we need a simple opportunity to change such system algorithms as, for example, a planning strategy.  Not a scheduling policy that is set for each process using the <code>SCHED_FIFO</code> or <code>SCHED_OTHER</code> , but the algorithm by which the scheduler controls all threads (possibly considering the policy).  For example, now the project has implemented three planning strategies.  For the simplest systems, you can use a primitive scheduler that does not take into account neither the priorities nor the other attributes of the stream.  And there is a strategy that uses priorities and takes into account how much time has already been played. <br><br>  It was a small lyrical digression.  So, there was a need for at least a simple inheritance, so that the system requirements could be described using interfaces, and its specific properties could be defined using their implementations.  Well, once there is a need, we decided it in this way: <br><pre> <code class="hljs java">@ DefaultImpl(TrivialSchedStrategy) <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> SchedStrategy { } <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> TrivialSchedStrategy extends SchedStrategy { source <span class="hljs-string"><span class="hljs-string">"trivial.c"</span></span>, <span class="hljs-string"><span class="hljs-string">"trivial.h"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> PriorityBasedSchedStrategy extends SchedStrategy { source <span class="hljs-string"><span class="hljs-string">"priority_based.c"</span></span>, <span class="hljs-string"><span class="hljs-string">"priority_based.h"</span></span> }</code> </pre><br>  As you can see, the annotation ( <code>@DefaultImpl</code> ) was not done here either, in this case, if there is no explicit indication of the module that implements <code>SchedStrategy</code> in the configuration, then the <code>TrivialSchedStrategy</code> module is used by default. <br><br><h4>  Conclusion </h4><br>  Of course, not all features of our system, for example, you can specify specific flags for the module for compilation, associate with it a set of unit tests, and so on.  But I am afraid that the article turned out to be overloaded, so anyone who is interested in learning more about Mybuild, perhaps with his hands, or even looking at the code, may find more information on the <a href="http://code.google.com/p/embox/wiki/Mybuild">project wiki</a> . <br><br>  Of course, much remains to be realized and polished.  At a minimum, we have not yet tried to unbind Mybuild from the parent Embox project, for some pieces there is not enough documentation and so on. <br><br><h5>  Links </h5><ul><li>  <a href="http://code.google.com/p/embox/">Embox Project</a> </li><li>  <a href="http://code.google.com/p/embox/wiki/Mybuild">Mybuild page</a> </li><li>  <a href="http://code.google.com/p/embox/wiki/InstallMybuildEclipsePlugin">Plugin for Eclipse</a> </li></ul><br>  <i>Thank you for reading to the end, I will be glad to answer your questions and suggestions in the comments.</i> </div><p>Source: <a href="https://habr.com/ru/post/144935/">https://habr.com/ru/post/144935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144930/index.html">1976 Apple I goes under the hammer</a></li>
<li><a href="../144931/index.html">Logitech has released a solar-powered wireless keyboard that is compatible with Apple devices.</a></li>
<li><a href="../144932/index.html">Guys, Pip-Boy is coming</a></li>
<li><a href="../144933/index.html">Herrmann Dominanz Instrument (HDI). Part II</a></li>
<li><a href="../144934/index.html">Lenovo IdeaPad S2109 on Android 4. 0</a></li>
<li><a href="../144936/index.html">Valid TK, very short</a></li>
<li><a href="../144938/index.html">Rename files downloaded from rutracker.org</a></li>
<li><a href="../144940/index.html">You will laugh, but Rostelecom-Siberia again reports about the increase in prices through the newspaper</a></li>
<li><a href="../144941/index.html">What is monitoring in IT or why admins began to sleep more?</a></li>
<li><a href="../144942/index.html">Liang-Knuth's algorithm in a real project, or as I did the iOS reader</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>