<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shamoon Returns: Saudi Oil Hunt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remember how in 2012 we dissected an interesting Shamoon malware operating in the Middle East? If you don‚Äôt remember, let me briefly remind you: it wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shamoon Returns: Saudi Oil Hunt</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/4ab/27e/e7f/4ab27ee7f0944f04b165ec9aa60dbc00.jpg" align="right">  Remember how in 2012 we dissected an interesting <a href="https://securelist.ru/%3Fs%3DShamoon">Shamoon malware</a> operating in the Middle East?  If you don‚Äôt remember, let me briefly remind you: it was a network worm that destroys the contents of the hard drives of infected machines.  The code is full of errors and, to put it mildly, non-optimal solutions, however, Shamoon recorded at his own expense more than 30 thousand cars owned by oil companies Saudi Aramco and RasGas, and then lay down on the bottom.  So, he returned, and not one. <br><a name="habracut"></a><br>  From November 2016 to January 2017, we observed three waves of attacks of the new version of the worm - Shamoon 2.0.  Habitat is the same: companies that are critical for the economy of Saudi Arabia.  The handwriting of the very same guys that blinded Shamoon four years ago is well recognizable, but they have mastered a couple of new tricks.  However, the attack scheme remained just as unpretentious: <br><br>  - Hackers extract their credentials from the administrator of the target network.  How exactly - we do not know, but we hope that with the help of classical social engineering, and not by means of more traditional physical measures for the region. <br>  - With the help of the extracted credentials, one of the servers of the local network is taken under control and subsequently used to control the worm (not always). <br>  - In Shamoon 2.0, the administrator credentials, the compromised server‚Äôs internal IP, and the date the data destruction procedure was activated are hardcoded. <br>  - The malware spreads across the attacked network as widely as possible.  Infected all cars that have access to the extracted credentials. <br>  - On day D, hour H and minute M comes P, that is, Shamoon 2.0 destroys the contents of hard drives in much the same way as its predecessor Shamoon did.  Previously, the files were filled with pieces of a JPG file with a burning American flag, now they use random trash or a photo of a drowned Syrian refugee boy.  Then the MBR is killed and the main partition of the first disk is overwritten. <br><br><img src="https://habrastorage.org/files/c3c/512/34e/c3c51234ebcf4b6e98da9e520a749d76.jpg" align="right">  As in the old Shamoon, in this version of the worm there is the possibility of receiving commands from the local server, although no external commands are required to trigger at a predetermined time.  Moreover, the sample caught by us in January of this year is completely deprived of the functions of communication with the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In short, all this is very reminiscent of Shamoon.  Nevertheless, the authors of the attack did not sit with folded arms for four years and now they are able to do something: <br><br>  - Shamoon 2.0 learned to work under 64-bit versions of Windows.  During infection, it determines the system capacity (by the crooked method ‚Äî comparing the value of the PROCESSOR_ARCHITECTURE variable with ‚ÄúAMD64‚Äù and ‚Äúamd64‚Äù instead of just using the IsWow64Process function) and installs the corresponding module. <br><br><img src="https://habrastorage.org/files/bb4/f70/cb8/bb4f70cb8d1449a4b6b22d714b8d6f7e.jpg" align="right">  - In Shamoon 2.0 appeared the early welded module!  True, he is still inactive.  The former Shamoon was interesting by the lack of a commercial component, which in our time is a rare case and gives out the custom character of the attack.  Now, apparently, the hacker group is preparing to transfer to cost accounting, without compensation for food.  In general, the guys revolve as they can. <br>  - In Shamoon 2.0, there are indications that the authors use Arabic and Yemeni system localization.  However, in itself, this does not allow direct accusation of Yemenis, given how easily such ‚Äúproofs‚Äù are faked. <br><br>  If you want shocking technical details and code examples, read the research report, it is published <a href="https://kas.pr/9s5A">here</a> . <br><br><h3>  Signs of the Simonov Tribe </h3><br>  Few expected the return of the good old Shamoon, but when we began to mark one attack after another, each time with new modifications of the malware, it became clear that the group behind it was back in business and we should expect further surprises.  Given the obfuscation and encryption of the code, it is necessary to catch potential new modifications on indirect grounds, and with due skill this approach works very well. <br><br>  This is done through the rules for YARA, which describe the indicators inherent in a certain family of malicious programs.  We knew about Shamoon that it uses additional modules that are stored in encrypted form.  The first Shamoon 2.0 samples captured used resources named PKCS7, PKCS12 and X509.  But the authors quickly corrected, and in the next versions the files received standard names: ICO, LANG and MENU. <br><br>  Nevertheless, the creators of the malware did not change some habits.  So, in Shamoon and Shamoon 2 there was a resource, named as "101".  The file itself is different each time, but the name is the same!  Our analysts twirled it like this and that and finally came up with how to identify it: <br><br>  - The file entropy level is above 7.8, which means that the data in it is encrypted or archived. <br>  - Size about 30 Kb.  We set the lower threshold of 20 KB. <br>  - The language of the file is not set, despite the fact that all other resources had the language Arabic (Yemen) or English United States. <br>  - There is no unencrypted PE file inside. <br><br>  Having tested these simple rules, analysts decided to add a few more criteria in order to reduce the level of possible false positives: <br><br>  - The file is not digitally signed. <br>  - The volume of all known Shamoon samples with the resource ‚Äú101‚Äù did not exceed 370 Kb, so we set a limit of 700 Kb. <br>  - The number of resources within the sample should not be too large - no more than 15. <br><br>  The result was the following rule for YARA: <br><pre><code class="hljs ruby">import <span class="hljs-string"><span class="hljs-string">"pe"</span></span> import <span class="hljs-string"><span class="hljs-string">"math"</span></span> rule susp_file_enumerator_with_encrypted_resource_101 { <span class="hljs-symbol"><span class="hljs-symbol">meta:</span></span> copyright = <span class="hljs-string"><span class="hljs-string">"Kaspersky Lab"</span></span> description = <span class="hljs-string"><span class="hljs-string">"Generic detection for samples that enumerate files with encrypted resource called 101"</span></span> hash = <span class="hljs-string"><span class="hljs-string">"2cd0a5f1e9bcce6807e57ec8477d222a"</span></span> hash = <span class="hljs-string"><span class="hljs-string">"c843046e54b755ec63ccb09d0a689674"</span></span> version = <span class="hljs-string"><span class="hljs-string">"1.4"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">strings:</span></span> $mz = <span class="hljs-string"><span class="hljs-string">"This program cannot be run in DOS mode."</span></span> $a1 = <span class="hljs-string"><span class="hljs-string">"FindFirstFile"</span></span> ascii wide nocase $a2 = <span class="hljs-string"><span class="hljs-string">"FindNextFile"</span></span> ascii wide nocase $a3 = <span class="hljs-string"><span class="hljs-string">"FindResource"</span></span> ascii wide nocase $a4 = <span class="hljs-string"><span class="hljs-string">"LoadResource"</span></span> ascii wide nocase <span class="hljs-symbol"><span class="hljs-symbol">condition:</span></span> uint16(<span class="hljs-number"><span class="hljs-number">0</span></span>) == <span class="hljs-number"><span class="hljs-number">0x5A4D</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> all of them <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> filesize &lt; <span class="hljs-number"><span class="hljs-number">700000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.number_of_sections &gt; <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.number_of_signatures == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.number_of_resources &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.number_of_resources &lt; <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> any i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>..pe.number_of_resources - <span class="hljs-number"><span class="hljs-number">1</span></span>): ( (math.entropy(pe.resources[i].offset, pe.resources[i].length) &gt; <span class="hljs-number"><span class="hljs-number">7.8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.resources[i].id == <span class="hljs-number"><span class="hljs-number">101</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.resources[i].length &gt; <span class="hljs-number"><span class="hljs-number">20000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pe.resources[i].language == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ($mz <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (pe.resources[i].offset..pe.resources[i].offset + pe.resources[i].length)) ) }</code> </pre> <br>  Why did I bring this rule here?  First, it is beautiful.  Well, to promote this <a href="http://virustotal.github.io/yara/">wonderful tool</a> for catching various suspicious software.  Such a piece of code allows you to successfully detect various modifications of Shamoon 2.0 with a slight level of false positives. <br><br>  And with the help of this very piece of simple code we found another, hitherto unknown, malware, which was dubbed StoneDrill. <br><br><h3>  His friend StoneDrill </h3><br>  As in the case of Shamoon, the creators of StoneDrill are actively interested in Saudi organizations.  In addition, a number of stylistic parallels can be traced between these two malicious programs.  We will talk more about the internal structure of StoneDrill at the next Kaspersky Lab antivirus analyst <a href="https://sas.kaspersky.com/">summit</a> , which will be held from 2 to 6 April on St. Martin. <br><br>  Although there are some similarities between StoneDrill and Shamoon, they are very different from each other.  StoneDrill's goal is also to destroy information, but it does not use a driver for direct disk access.  His data trowel module is embedded in the browser installed on the victim‚Äôs machine.  Moreover, if the browser is launched with rights that do not allow to wipe the disk directly, only the available files will be deleted. <br><br>  The authors of this malware have made serious efforts to complicate its detection and analysis - for example, it does not run in a virtual environment.  In addition, StoneDrill is made not by Yemenis, but by Iranians, according to the traces left in the code.  But to believe them is not necessary, such things are fake very easily.  Authors should have understood that their code will be thoroughly investigated. <br><br>  Another point - we believe that there is a connection between StoneDrill and the <a href="https://securelist.com/blog/software/74503/freezer-paper-around-free-meat/">NewsBeef</a> attack, which is also directed mainly against targets located in Saudi Arabia.  For StoneDrill, we have developed rules for decrypted modules - since the targeted attack tools are usually modified to match the target, these rules help us discover new variants of the malware used in the attack.  So, these rules also ‚Äúcatch‚Äù the samples that were used in NewsBeef. <br><br>  If you give free rein to your imagination and imagine that the same people are behind all this harmful zoo, NewsBeef and StoneDrill look like tools for long-term work against the Saudi economy, and Shamoon is ‚Äúheavy artillery‚Äù used for the most important goals.  However, according to our working version, StoneDrill and Shamoon are used by different groups pursuing similar interests. </div><p>Source: <a href="https://habr.com/ru/post/323578/">https://habr.com/ru/post/323578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323568/index.html">OpenVAS 9 release took place</a></li>
<li><a href="../323570/index.html">Speech AI with Python & Google API</a></li>
<li><a href="../323572/index.html">Using Neutrino to get started developing JavaScript quickly</a></li>
<li><a href="../323574/index.html">How to make a million logo if you are not a designer</a></li>
<li><a href="../323576/index.html">How to do more, tired less. Emacs pomidor</a></li>
<li><a href="../323580/index.html">25 practical examples of using iBeacon technology in retail</a></li>
<li><a href="../323582/index.html">Can bosses like change</a></li>
<li><a href="../323584/index.html">Logging in Yii 2.0 and PSR-3</a></li>
<li><a href="../323586/index.html">Blockchain 200 lines of code</a></li>
<li><a href="../323588/index.html">Create an isomorphic / universal application on Next.JS + Redux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>