<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create Your Sniffer / FireWall / Parental control / SpyWare / Client for computer Club. LSP technology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Create Your Sniffer / FireWall / Parental control / SpyWare / Client for computer Club. LSP technology 



 Provider). 

 Recently, a friend revealed ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create Your Sniffer / FireWall / Parental control / SpyWare / Client for computer Club. LSP technology</h1><div class="post__text post__text-html js-mediator-article"><h4>  Create Your Sniffer / FireWall / Parental control / SpyWare / Client for computer Club.  LSP technology <br></h4><br><br><img src="https://habrastorage.org/storage2/d5d/4ff/7fe/d5d4ff7fe5bc3a491085c66134c001c4.png"><br>  Provider). <br><br>  Recently, a friend revealed a desire that he needed for the E-Hall (library) a program that will control access to computers and automatically count what and how much. <br>  Since there was no money in the budget for 2012, the friend gave up.  But the idea of ‚Äã‚Äãaccess control is already lit.  Began to think how to do it. <br>  I was most worried about one question.  How to block HTTP traffic if the user pays only for renting a computer, and not for renting a computer with the Internet? <br>  On the Internet, I found an interesting article on LSP and now I present its translation with some changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Who cares please under the cat. <br><a name="habracut"></a><br><br><h5>  HTTP sniffer based on LSP (Layered Service Provider) <br></h5>  This article describes how to create the simplest sniffer to monitor HTTP traffic on Windows.  This program is based on open technology provided by Microsoft, its name is LSP (Layered Service Provider). <br>  This technology is used by various software.  These are mainly Antiviruses, Firewalls and traffic filtering programs. <br>  In order to create this software package, I used an example from the Microsoft Platform SDK (Program Files \ Microsoft Platform SDK \ Samples \ NetDS \ WinSock \ LSP \) and added an additional feature to filter HTTP traffic and collect the results into a separate repository. <br><br>  Concept <br>  Basic Scheme <br>  We begin <br>  Conclusions and Tips <br>  Useful links. <br><br><h5>  Concept. </h5><br><br>  The main idea of ‚Äã‚ÄãLSP is to create a provider that will be included in the chain of existing providers.  Something like the Hook principle in Windows. <br><br><img src="https://habrastorage.org/storage2/791/a33/038/791a3303856cdcc7ac27e44ea8cc1ab5.png"><br><br>  During the installation of the provider, you can specify a place in the provider chain.  And the chain will be rebuilt according to the new settings.  In our case, the provider is installed on top of the [TCP / IP] provider.  Be careful when installing on a real machine.  If the installation fails, it will add a lot of problems - the loss of the network, the Internet and the failure of some network applications. <br>  To get around debugging problems and creating an LSP provider, test it on a Virtual Machine. <br>  In the LSP provider, you must replace all the methods of the winsock library.  In general, the replacement logic is already enabled in the Platform SDK example, it only remains to add logic to intercept, block URLs, or save HTTP traffic. <br>  LSPs use both legal programs and SpyWare / AdWare. <br>  For example: <br>  <b>Legal programs:</b> <br><ul><li>  Sygate firewall </li><li>  Mcafee Personal Firewall </li><li>  E-safe </li><li>  Dr.Web Security Space 6 uses LSP as a Parental Control module. </li></ul><br><br>  <b>AdWare:</b> <br><ul><li>  Webhancer </li><li>  New.net </li><li>  NewDotNet </li></ul><br><br><img src="https://habrastorage.org/storage2/a27/a96/b97/a27a96b97b5183fcd89f980ac459a1e6.png"><br><h5>  LSP in action. </h5><br><br><h5>  Basic Scheme </h5><br><br>  This is the basic scheme of the software package. <br><br><img src="https://habrastorage.org/storage2/cfe/8db/d03/cfe8dbd03749e4070db54319d59dfef5.png"><br><br>  After installing the software package, many programs will use our provider (in general, our provider is a simple DLL file that is loaded into every application that uses the Winsock library).  But we only need to define HTTP traffic.  Below is the line of code (our provider) with a hard-coded port, which will be monitored (HTTP protocol uses port 80 by default). <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((namelen &gt;= <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(sockaddr_in)) &amp;&amp; (((sockaddr_in*)name)-&gt;sin_port == htons(HTTPPort))) { SocketContext-&gt;intercept = TRUE; }</code> </pre> <br><br>  You can improve this tool and make more elegant program logic for saving your settings, rather than hard-coded constants as in the example. <br>  In addition, we must define HTTP requests.  HTTP GET requests are defined by a simple comparison with the string ‚ÄúGET‚Äù.  POST requests can be defined in the same way. <br>  We also have a Service that collects all the information that is filtered - the service was created in order to prevent data corruption, it can happen if we monitor several applications, and not one.  All captured information from the browser will be transmitted to this service.  This service is a Socket server (listens on port 4004) so ‚Äã‚Äãthere should be no problems with the synchronization of data collection.  In this case, the data storage is just a text file, but you can easily replace it with a more convenient and stable option (for example, use a DBMS). <br><br><h5>  We begin </h5><br><br>  The test package contains the following projects. <br>  1.Project LSP (folder LSP) <br><br>  This project contains an overload of basic Winsock methods.  It is in this place that we have to add our changes.  In my case, this project contains an example from the Platform SDK, where I added the logic for defining the connection to port 80 and marked it as intercepted in the Connect method: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((namelen &gt;= <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(sockaddr_in)) &amp;&amp; (((sockaddr_in*)name)-&gt;sin_port == htons(HTTPPort))) { SocketContext-&gt;intercept = TRUE; }</code> </pre><br><br>  Thus, in future calls to the Send method, we find that this socket is used by the HTTP protocol.  We also established a connection with the Traffic Collecting Service in the Connect method.  In the SEND method, we implemented the logic to detect HTTP requests and redirect them to our service: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsHTTPRequest(lpBuffers-&gt;buf) &amp;&amp; SocketContext-&gt;intercept) { SetBlockingProvider(SocketContext-&gt;Provider); ret = SocketContext-&gt;Provider-&gt;NextProcTable.lpWSPSend( serviceConnection.GetSocket(), lpBuffers, dwBufferCount, lpNumberOfBytesSent, dwFlags, lpOverlapped, lpCompletionRoutine, lpThreadId, lpErrno ); SetBlockingProvider(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre><br>  I created a specialized class that holds one constant connection for each loaded DLL file. <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceConnectionKeeper</span></span></span><span class="hljs-class">;</span></span></code> </pre><br>  Its role is to keep the socket connected.  Thus, only one connection is established with the storage service. <br><br>  2. Common Project (Common folder) - this project contains all the utilities provided in the Platform SDK examples.  And also some GUID manipulations from our LSP provider were made. <br>  The Installer project (Installer folder) is the LSP installer.  We changed its main method - we removed the command line parsing and added a TCP provider search.  Now during the installation, we look for the TCP provider ID and rebuild the provider chain.  We put our provider on top of TCP. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsHTTPRequest(lpBuffers-&gt;buf) &amp;&amp; SocketContext-&gt;intercept) { SetBlockingProvider(SocketContext-&gt;Provider); ret = SocketContext-&gt;Provider-&gt;NextProcTable.lpWSPSend( serviceConnection.GetSocket(), lpBuffers, dwBufferCount, lpNumberOfBytesSent, dwFlags, lpOverlapped, lpCompletionRoutine, lpThreadId, lpErrno ); SetBlockingProvider(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre><br><br>  3. Service Project (Service folder) is a traffic collector.  It is a simple Windows service and methods for installing and uninstalling a service.  The MAIN function of our service also implements a socket server.  All service manipulation logic was kindly borrowed from MSDN.  The server accepts all incoming connections and starts a separate stream for each application.  The started stream accepts data separated by the sequential "\ r \ n \ r \ n" (essentially 2 empty lines) and stores them in the storage. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = recv(clientSocket, buffer, PACKSIZE, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { response += <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(buffer, result); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { position = response.find(messageTerminator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>::npos != position) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CollectorServer::Instance()-&gt;SaveData(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(response.begin(), response.begin() + position))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } response = response.substr(position + messageTerminator.size()); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>::npos != position); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (SOCKET_ERROR != result);</code> </pre><br>  In order to start working with this project you need to build the entire Visual studio project.  After that, put the NSI script in the build result folder and compile the Nsi script.  We get the installation setup.exe file <br>  During setup.exe installation, all necessary files will be unpacked into their working folders.  LSP.DLL will be placed in% SYSTEMROOT% \\ system32 \\ LSP.dll.  The service and installer of the provider will be placed in the Program Files folder.  Also, the uninstall shortcut will be placed on the desktop.  The history file will be in the root of C: //. <br><br><h5>  Conclusions and tips. </h5><br>  This article describes how to create your own provider and monitor all network traffic.  But this is not the only example for using this technology.  You can also easily implement logic for: <br>  Block HTTP requests and responses; <br>  Modify and delete traffic; <br>  Block connections (as does the firewall); <br>  Intercept SLL encrypted data (it is even possible to do MITM interception) (Man in the midle) <br>  In the development of the LSP there were a lot of rakes, so as not to regret that the Internet connection was lost and failed, it is better to use the Virtual Machine for tests.  It is much more convenient to roll back the VM image to the previous state than to use the Windows recovery system each time. <br>  Most anti-virus software also uses this technology, so you can find them in the chain of installed LSP providers in your OS.  Antiviruses can also be a problem for you when testing your LSP provider, because antiviruses also filter traffic. <br>  You can add logic to ignore your chosen applications.  So that our LSP-provider does nothing except data transfer if the application is on the ignored list. <br><br>  This tool was developed for 32-bit applications only.  But it can be easily ported to 64-bit applications.  You just have to rebuild the project to 64-bit and set the LspCatalog64Only flag during the installation of the provider. <br><br>  To see the changes in the Platform SDK example that were made to create this tool, you can compare the text with the original example. <br>  I also noted all the code blocks that were added with the comment // ADDED <br>  Also note that you must generate a new GUID for your LSP provider to avoid collisions with other LSP providers. <br><br><h5>  useful links </h5><br><br>  Unfortunately, there are not so many references, but they are still there. <br><br>  0. <a href="http-sniffer">Original article in English</a> <a href="http-sniffer"><br></a> <br><br>  1. <a href="http://www.microsoft.com/msj/0599/layeredservice/layeredservice.aspx">MSDN</a> and Platform SDK documentation. <br><br>  2. <a href="http://www.komodia.com/lsp-sub">There is also information on the developers LSP website</a> . <br><br>  The project itself is laid out <a href="">HERE</a> <br>  Also, the project is posted on <a href="https://github.com/SOLON7/HTTPSniffer">GITHAB</a> </div><p>Source: <a href="https://habr.com/ru/post/162401/">https://habr.com/ru/post/162401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162387/index.html">Infographics: HTML5 history</a></li>
<li><a href="../162389/index.html">Fragment animation in Android</a></li>
<li><a href="../162393/index.html">Yota smartphone with eInk second screen</a></li>
<li><a href="../162395/index.html">Search engine from the past</a></li>
<li><a href="../162397/index.html">Launch of the Managed Firewall service</a></li>
<li><a href="../162403/index.html">Review of fresh materials, October-December 2012</a></li>
<li><a href="../162405/index.html">Production order for printed circuit boards in a factory - step by step</a></li>
<li><a href="../162417/index.html">Simply writing tests is not TDD!</a></li>
<li><a href="../162421/index.html">The Investigative Committee of the Russian Federation kept the complaints of users in open form</a></li>
<li><a href="../162423/index.html">Virtual server with Ubuntu 11.04, Software RAID and its recovery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>