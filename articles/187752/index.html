<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>False sharing in a multi-threaded Java application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="JRE allows you to abstract from a specific platform, making writing cross-platform code much easier. Of course, the Write once, run anywhere does not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>False sharing in a multi-threaded Java application</h1><div class="post__text post__text-html js-mediator-article">  <abbr title="Java Runtime Environment">JRE</abbr> allows you to abstract from a specific platform, making writing cross-platform code much easier.  Of course, the <a href="http://en.wikipedia.org/wiki/Write_once,_run_anywhere">Write once, run anywhere</a> does not reach the ideal, but life makes it much easier. <br><br>  With the abundance of frameworks and the fullness of its own standard library, the idea that the program runs on a very specific hardware gradually fades into the background.  In most cases, this is justified, but sometimes life makes its own adjustments. <br><br>  The vast majority of modern processors have a cache for storing frequently used data.  Cache memory is divided into blocks (Cache line).  Mechanisms implementing <a href="http://en.wikipedia.org/wiki/Cache_coherence">Cache coherence</a> ensure cache synchronization between the processor cores (s) in a computer system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The term <a href="http://en.wikipedia.org/wiki/False_sharing">false sharing</a> means access to different objects in a program that share the same block of cache memory.  <b>False sharing</b> in a multi-threaded application, when variables are modified from different streams in one block, leads to a decrease in performance and an increase in the load on Cache coherence mechanisms.  Details on how this happens can be found in the <a href="http://habrahabr.ru/company/intel/blog/143446/">article</a> on this topic. <br><br><a name="habracut"></a><br><h3>  Tools </h3><br><ul><li>  <a href="http://elwood.su/%3Fp%3D459">hsdis plugun</a> for disassembling jit code. </li><li>  <a href="http://software.intel.com/en-us/intel-vtune-amplifier-xe">Intel¬Æ VTune ‚Ñ¢ Amplifier XE 2013</a> for profiling and CPU metering. </li></ul><br><h3>  Example </h3><br>  The multithreaded application, the threads, at each iteration, take the previous value from their common array cell, perform calculations and add the results back. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SArray</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    volatile jvm  private static volatile long globalArray[] = new long[512]; public static class MThread implements Runnable { private int aPos; private long iterations; public MThread(long iterations, int aPos) { this.aPos = aPos; this.iterations = iterations; } @Override public void run() { for(long l = 0; l &lt; iterations; ++l) { ++globalArray[aPos]; } System.out.printf("A:TID:%d, count: %d\n", Thread.currentThread().getId(), globalArray[aPos]); } } private static final int THREAD_COUNT = Runtime.getRuntime().availableProcessors(); private static final long ITERATIONS = 1870234052L; public static void main(String[] args) throws Throwable { Thread[] threads = new Thread[THREAD_COUNT]; long smillis = System.currentTimeMillis(); for(int i = 0; i &lt; THREAD_COUNT; ++i) { threads[i] = new Thread(new MThread(ITERATIONS, i)); } for(Thread t: threads) { t.start(); } for(Thread t: threads) { t.join(); } System.out.printf("Total iterations on %d threads: %d, took %d ms\n", THREAD_COUNT, ITERATIONS, System.currentTimeMillis() - smillis); } }</span></span></code> </pre> <br></div></div><br>  Check that jvm didn‚Äôt make any unnecessary optimizations: <br><pre> <code class="dos hljs">java -XX:+UnlockDiagnosticVMOptions -XX:CompileCommand=<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>,SArray$MThread::run -XX:PrintAssemblyOptions=intel -cp target\falseshare-<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-SNAPSHOT.jar SArray</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="dos hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350540: mov r11d,DWORD PTR [r13+<span class="hljs-number"><span class="hljs-number">0</span></span>xc] <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350544: mov r10d,DWORD PTR [r8+<span class="hljs-number"><span class="hljs-number">0</span></span>x70] ;*getfield aPos ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">15</span></span> (line <span class="hljs-number"><span class="hljs-number">18</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350548: mov r9d,DWORD PTR [r12+r10*<span class="hljs-number"><span class="hljs-number">8</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span>xc] ; implicit exception: dispatches to <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000023505dd <span class="hljs-number"><span class="hljs-number">0</span></span>x000000000235054d: cmp r11d,r9d <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350550: jae <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350599 ;*laload ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">19</span></span> (line <span class="hljs-number"><span class="hljs-number">18</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350552: shl r10,<span class="hljs-number"><span class="hljs-number">0</span></span>x3 ; &gt;&gt;&gt;&gt; ;     <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350556: inc QWORD PTR [r10+r11*<span class="hljs-number"><span class="hljs-number">8</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span>x10] ;*<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">27</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x000000000235055b: add rbx,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 ; OopMap{r8=Oop r13=Oop off=<span class="hljs-number"><span class="hljs-number">127</span></span>} ;*<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">27</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x000000000235055f: test DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0</span></span>xfffffffffddefa9b],eax # <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000000140000 ;*<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">27</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) ; {poll} <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350565: cmp rbx,QWORD PTR [r13+<span class="hljs-number"><span class="hljs-number">0</span></span>x10] <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350569: jl <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000002350540 ;*ifge</code> </pre></div></div><br>  If globalArray is not volatile, then jvm will not read from memory every time: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="dos hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e0592: add rbx,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 ;*ladd ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">25</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) ; &gt;&gt;&gt;&gt; ;   <span class="hljs-number"><span class="hljs-number">1</span></span>         <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e0596: add r8,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 ;*ladd ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">21</span></span> (line <span class="hljs-number"><span class="hljs-number">18</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e059a: mov QWORD PTR [r11+rcx*<span class="hljs-number"><span class="hljs-number">8</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span>x10],r8 ; OopMap{r11=Oop r13=Oop off=<span class="hljs-number"><span class="hljs-number">127</span></span>} ;*<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">27</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e059f: test DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0</span></span>xfffffffffe24fa5b],eax # <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000000430000 ;*<span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> ; - SArray$MThread::run@<span class="hljs-number"><span class="hljs-number">27</span></span> (line <span class="hljs-number"><span class="hljs-number">17</span></span>) ; {poll} <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e05a5: cmp rbx,r10 <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e05a8: jl <span class="hljs-number"><span class="hljs-number">0</span></span>x00000000021e0592 ;*ifge</code> </pre><br></div></div><br>  In real life, when the computational method is not trivial, such optimization may not happen. <br><blockquote>  In this case, volatile is used solely to confuse the optimizer.  A record of the volatile long [] array type means that the volatile semantics refers to a pointer to an array, and not to its elements. <br></blockquote><br>  Create a new project in VTune Amplifier: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/3fa/de5/202/3fade520256c4133f0b6c967fc2d6f34.png" alt="image"><br></div></div><br>  We create and run Generic Exploration analysis.  In summary we see: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/7c5/9b1/bd0/7c59b1bd0861de73322a39fe7160d71f.png" alt="image"><br></div></div><br>  CPI - 2.100, with normal for settlement tasks 1 and less.  Go to the view Hardware issues: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/dbc/e43/2d5/dbce432d59d864ebb32d2ed0e26e41a8.png" alt="image"><br></div></div><br>  There is Contested access, meaning that the data written by one stream is read by another thread and at the same time the threads run on different cores / CPUs. <br>  That is, the cells of the globalArray array fall into one cache line. <br><br>  In order to avoid this situation, we will space the cells in memory by the cache line value.  On the Intel i5, the cache line size is 64 bytes.  Change the line <br><pre> <code class="java hljs"> threads[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MThread(ITERATIONS, i));</code> </pre><br>  on <br><pre> <code class="java hljs"> threads[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MThread(ITERATIONS, (i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">8</span></span>));</code> </pre><br>  Why not i * 8?  Because in the case of arrays, the first element after the title of the object is the length (field length).  For element access operations, jvm can read this field to check the validity of the index. <br>  We launch the repeated analysis in Vtune: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/d13/2fd/485/d132fd4854f03538c6d0dfcc36080b6a.png" alt="image"><br></div></div><br>  CPI - 0.586, Contested access is gone, In proportion to CPI, the operating time has changed, from 13.7 to 4.5 seconds. <br>  Testing was conducted on a single-processor machine, in the case of a multiprocessor configuration, the overhead of synchronizing the cache memory will be even greater. <br><br>  Naturally, the same problem may arise when accessing the fields of objects.  But since the minimum size of the object (c one field) in the hostpot jvm is 16 bytes, the problem will be less common.  The way to avoid false sharing for objects using inheritance can be viewed in the <a href="http://openjdk.java.net/projects/code-tools/jmh/">jmh</a> source, in the BlackHole implementation.  As one of the options - not to create bulk objects for all threads, but to spread this process over time. <br><br>  Testing was conducted on a machine with an Intel Core i5 3.3 GHz processor, 64bit JDK 1.7.0_21, Intel Vtune Amplifier XE 2013 Update 11 (build 300544) Evaluation license, Windows 7 64bit. <br><br>  <b>Ps.</b>  Do not take the performance figures given in the article literally.  The results will depend to a large extent on external factors, for example, on how the OS, together with jvm, distributes the threads among the processor cores (s).  But if something is created high-performance, then such features of target platforms should be taken into account. <br></div><p>Source: <a href="https://habr.com/ru/post/187752/">https://habr.com/ru/post/187752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187742/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 17</a></li>
<li><a href="../187744/index.html">Monument to the Fallen Astronauts</a></li>
<li><a href="../187746/index.html">I, the pirate (chapter 6)</a></li>
<li><a href="../187748/index.html">Major mistakes when developing responsive design</a></li>
<li><a href="../187750/index.html">LinkMeUp. Issue 5. Guest from Norway</a></li>
<li><a href="../187754/index.html">The Payoneer app for iOS and Android is ready</a></li>
<li><a href="../187756/index.html">Intel App Innovation Contest 2013 Contest. Win $ 20,000!</a></li>
<li><a href="../187758/index.html">Flexible configuration with Guice</a></li>
<li><a href="../187760/index.html">What brings us musical piracy. Part 2, positive</a></li>
<li><a href="../187764/index.html">Google introduces Android 4.3 and the new Nexus 7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>