<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to stop being afraid and fall in love with end-to-end encryption</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 
 In the comments to our first post, the people demanded bread and circuses of the code and a ‚Äúsuccess story‚Äù . And if with the first one ev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to stop being afraid and fall in love with end-to-end encryption</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/440/125/281/4401252811174d2aa4e63e28a9408feb.jpg"></div><br>  Hi, Habr! <br>  In the comments to our first post, the people demanded <s>bread and circuses of the</s> code and a <a href="https://habrahabr.ru/company/virgilsecurity/blog/283458/">‚Äúsuccess story‚Äù</a> .  And if with the first one everything is more or less normal, then with the second something, somehow does not add up yet.  You know, people are all young, our successes are quite modest, we play well in basketball.  In a word, today we are just going to just a little bit and tell about the implementation of end-to-end encryption using our services.  And the ‚Äúsuccess story‚Äù?  What our years, will be still in our blog these most success stories. <br><a name="habracut"></a><br><h4>  Key management </h4><br>  One of the challenges in implementing end-to-end encryption is the secure transfer of encryption keys to the recipient. <br>  The most obvious way to solve a problem is public key cryptography.  Each user of the system has a key consisting of two parts: a private part (secret key), which is kept secret and is never transmitted over the network;  public part (public key), which should be accessible to all system participants.  The private key is usually used for signing and decryption, while using the public key, encryption and signature verification operations are performed. <br>  Based on the definition of the secret and public key, it follows that absolutely any participant in the system is able to encrypt the message using the public key, but only the owner of the secret key is able to decrypt the message. <br><br>  The first thing that should be taken into account when implementing a public key scheme is the possibility of replacing the public key by a third party.  An attacker who has the ability to modify traffic can intercept Alice's public key and change it to his own public key.  This leads to the fact that the user Bob, when he tries to send an encrypted message to Alice, actually encrypts it with an attacker key that can decrypt and read the secret data. <br>  One of the possible options to prevent such a situation is the ability to uniquely identify the key holder.  In this case, the substitution of the key will become apparent to Bob.  As an identifier, you can specify an e-mail address, phone number and other unique, but easily recognizable information.  It should be noted that the identifier specified when creating a new key must be verified and confirmed.  Otherwise, we risk getting a system in which every user can impersonate anyone. <br><br>  To verify the name, an identity validation service is required.  As a rule, such services will send a randomly generated code to the specified e-mail address or phone number as the name and wait for confirmation from the user. <br>  However, the use of the identity verification service only shifts the problem of trust from the communication channel to the service itself.  In fact, nothing prevents the owner of the service from creating a compromised key, allegedly belonging to a third party. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to completely get rid of the possibility of compromised keys, <b>key authentication is</b> required. <br>  Key authentication is a way to convince Bob that the key he considers to belong to Alice is in fact Alice‚Äôs.  There are several ways to solve the key authentication problem.  The most obvious among them is the key exchange during a face-to-face meeting or using a more reliable communication channel.  Despite the high reliability, this method is not always realizable in the real world.  Therefore, one of the following key authentication methods is used. <br>  The first way is to use trusted certificate authorities.  When a certain user (trusted center) of the system has unlimited trust and is able to act as a key witness.  No key in such a system is considered secure without the signature of a trusted authority. <br>  The second way is to use the web of trust.  At the same time, each user of the system is entitled to sign the key of any other user, thereby confirming that the key actually belongs to the specified owner.  The more certified signatures under the key, the more credible it is. <br><br>  Thus, the procedure for creating, storing and transferring keys has a number of pitfalls that are easy to get around using Virgil Security. <br><br><h4>  Virgil security </h4><br>  Virgil Security provides a set of free cryptographic services, the use of which helps to solve many problems related to security.  In particular, the problem of key management. <br>  Today Virgil Security is: <br><ol><li>  <b>The Virgil crypto library</b> is an open source shell over mbedTLS that allows all standard encryption and signature algorithms to be used.  And also adds hybrid encryption algorithms (ECIES).  Virgil crypto library allows you to change the algorithms in the future without rewriting existing data - the principle of crypto agility. </li><li>  <b>Virgil identity service</b> is an <b>identity</b> verification service with an open API that allows you to verify the validity of an e-mail address.  The service sends to the specified e-mail secret code that must be entered by the user to confirm the fact of possession of the address. </li><li>  <b>Virgil keys service</b> is a public key service that allows you to work with a reliable and accessible public key storage.  Each key in the repository is tied to a special data structure called VirgilCard.  VirgilCard necessarily includes: a unique identifier of the card ‚Äî id, a key holder‚Äôs identifier ‚Äî an e-mail address, a telephone number, etc., as well as the date the key was created.  With the help of Virgil keys service, you can quickly find the public keys of users of the system, as well as delete cards with compromised keys. </li><li>  <b>Virgil private keys service</b> is a service of secret keys responsible for downloading, downloading and deleting secret keys.  To access the private key, you must confirm possession of the Virgil card to which it is attached. </li></ol><br>  All of the above services have a wide selection of <a href="https://virgilsecurity.com/downloads">ready-made SDKs</a> and can be used to solve the widest range of information security tasks. <br><br><h4>  Virgil services and end-to-end encryption </h4><br>  Well, now it's time to get some cool.  We show how using Virgil Security to implement secure end-to-end encryption.  To do this, we implement the following scheme: <br><img src="https://habrastorage.org/files/0e0/dd3/932/0e0dd3932b424037870fc28daeccb751.jpg"><br>  Please note that the encryption uses <a href="https://en.wikipedia.org/wiki/Integrated_Encryption_Scheme">ECIES</a> scheme.  This means that the message is encrypted using the AES symmetric algorithm using an ephemeral symmetric key, which can only be recovered if you have the recipient's private key.  Encryption is performed using the recipient's public key. <br><br>  To work with Virgil Security services we need to get a secret token and a public / private key pair.  To do this, register on the site <a href="https://developer.virgilsecurity.com/account/signin">Virgil Security</a> .  After that, proceed to the implementation of e2ee. <br><br><ol><li>  Download and install VirgilSDK using NPM: <br><pre><code class="bash hljs">npm install virgil-sdk</code> </pre> <br></li><li>  Initializing the work with Virgil Security services: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> virgil = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VirgilSDK(<span class="hljs-string"><span class="hljs-string">"%ACCESS_TOKEN%"</span></span>);</code> </pre><br></li><li>  We generate a pair of keys: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyPair = virgil.crypto.generateKeyPair(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(keyPair.publicKey); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(keyPair.privateKey);</code> </pre><br><div class="spoiler">  <b class="spoiler_title">And we get the following result:</b> <div class="spoiler_text">  ----- BEGIN PUBLIC KEY ----- <br>  MFswFQYHKoZIzj0CAQYKKwYBBAGXVQEFAQNCAAQO8ohmBRyclmcfQ38Lwmvv4Cau <br>  jyX6vWn8kJrR0RRfFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA <br>  ----- END PUBLIC KEY ----- <br><br>  ----- BEGIN EC PRIVATE KEY ----- <br>  MHkCAQEEIFB + lOUvbb4WX + e3zLkAcYpvZR3qpQI8Ru / tcnciCMkIoAwGCisGAQQB <br>  l1UBBQGhRANCAAQO8ohmBRyclmcfQ38Lwmvv4CaujyX6vWn8kJrRRRfFQAAAAAA <br>  AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA <br>  ----- END EC PRIVATE KEY ----- <br></div></div><br></li><li>  We publish the public key.  This requires a validation token that confirms the identity of the key holder.  You can get a validation token in two ways: first, you can use the Virgil Identity service, which will check whether the key owner really has access to the email address and generates a validation token.  Or, you can use the application's private key and use it to generate the validation token yourself.  In this case, the developer avoids the need to trust a third-party identification service.  Let's use the received validation token and save the public key on the server: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">public_key</span></span>: keyPair.publicKey, <span class="hljs-attr"><span class="hljs-attr">private_key</span></span>: keyPair.privateKey, <span class="hljs-attr"><span class="hljs-attr">identity</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'member'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'Darth Vader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">validation_token</span></span>: <span class="hljs-string"><span class="hljs-string">'%VALIDATION_TOKEN%'</span></span> } }; virgil.cards.create(options).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">card</span></span></span><span class="hljs-function">)</span></span>{ myCard = card; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(card); });</code> </pre><br><div class="spoiler">  <b class="spoiler_title">As a result, the following key map will be created on the public key server:</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"3e5a5d8b-e0b9-4be6-aa6b-66e3374c05b3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"authorized_by"</span></span>:<span class="hljs-string"><span class="hljs-string">"com.virgilsecurity.twilio-ip-messaging-demo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>:<span class="hljs-string"><span class="hljs-string">"QiWtZjZyIQhqZK7+3nZmIEWFBU+qI64EzSuqBcY+E7ZtKPwd4ZyU6gdfU/VzbTn6dHtfahCzHasN..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"created_at"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-05-03T14:34:08+0000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"public_key"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"359abe31-3344-453a-a292-fd98a83e500a"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"public_key"</span></span>:<span class="hljs-string"><span class="hljs-string">"-----BEGIN PUBLIC KEY-----\nMFswFQYHKoZIzj0CAQYKKwYBBAGXVQEFAQNCAAQ..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"created_at"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-05-03T14:34:08+0000"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"identity"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"965ea277-ab78-442c-93fe-6bf1d70aeb4b"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"member"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-string"><span class="hljs-string">"Darth Vader"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"created_at"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-05-03T14:34:08+0000"</span></span> } }</code> </pre><br><br></div></div><br><br></li><li>  Create a channel through which encrypted messages will be transmitted.  This will not be as difficult as it seems.  Recently, we have become partners with the Twilio company, which, in particular, provides an API for implementing IP messenger.  An example of a ready-made IP messenger with built-in end-to-end encryption can be found <a href="https://github.com/VirgilSecurity/virgil-demo-twilio">here</a> . <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Create a Channel twilioClient.createChannel({ friendlyName: 'general' }).then(function(channel) { generalChannel = channel; });</span></span></code> </pre><br></li><li>  To send a secret message, we will find the public keys of the interlocutors and use it for encryption. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Receive the list of Channel's recipients Promise.all(generalChannel.getMembers().map(function(member) { // Search for the member's cards on Virgil Keys service return virgil.cards.search({ value: member.identity, type: 'member' }) .then(function(cards){ return { recipientId: cards[0].id, publicKey: cards[0].public_key.public_key }; }); }).then(function(recipients) { var message = $('#chat-input').val(); var encryptedMessage = virgil.crypto.encryptStringToBase64(message, recipients); generalChannel.sendMessage(encryptedMessage); console.log(encryptedMessage); });</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">The encrypted message looks like this:</b> <div class="spoiler_text"> <code>MIIDBQIBADCCAv4GCSqGSIb3DQEHA6CCAu8wggLrAgECMYICvDCCAVoCAQKgJgQkMDg3YjgwYmMtMzNjYi00MTI1LWI4YTgtYTE <br> 3OTEwM2Y3ZjRkMBUGByqGSM49AgEGCisGAQQBl1UBBQEEggEUMIIBEAIBADBbMBUGByqGSM49AgEGCisGAQQBl1UBBQEDQgAEcd <br> 8fhKqYlZxvcmmodg7Z3PNhE1LXLJqobouEcRfZaRMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAYBgcogYxxAgUCM <br> A0GCWCGSAFlAwQCAgUAMEEwDQYJYIZIAWUDBAICBQAEMEaJMAvX7S+52BpI5hYyFOc0noIc+qdFFrQanNAtNGBAX/Pxeg5yJ2iA <br> JijyZ8ut9zBRMB0GCWCGSAFlAwQBKgQQ81bklcNOyU/QTatCigSzoAQwHnAcbXk0daExIIS+sr6aIvVuF/o6j+1Rs5bvq2WVN41 <br> k/Oir5x7KZTSR7v3nx+fTMIIBWgIBAqAmBCRmNzM4YTUwNi1hMDYwLTQ1MDgtYTJkYS04NjY1NjZlYzg0ODMwFQYHKoZIzj0CAQ <br> YKKwYBBAGXVQEFAQSCARQwggEQAgEAMFswFQYHKoZIzj0CAQYKKwYBBAGXVQEFAQNCAARJ5C3hsYuI2Sf14k60Dz5Mv5yD/AsVA <br> zPfsmlreGTC2gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBgGByiBjHECBQIwDQYJYIZIAWUDBAICBQAwQTANBglg <br> hkgBZQMEAgIFAAQwhu7WM1rff9RYsQ+dmfX9Os3Irwm4cm5bIvUlcGXlCfmEsrjTyTg5MGjYLtxbYtL9MFEwHQYJYIZIAWUDBAE <br> qBBCfKdP/gZnkVwJvv4Hdf2eWBDC3czBjV/yPGeGTqBIilHSsrqwK7lVMTBuKR+mR3eNdh+yBIAcOk4rveSUbDuWagDIwJgYJKo <br> ZIhvcNAQcBMBkGCWCGSAFlAwQBLgQMfjkCvK3UgXdorcYUmtCHHuSm4yfBacMsniMADAeos7qN7OmNsFU1 <br></code> <br></div></div><br></li><li>  The recipient decrypts the message using the secret key: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Listen for new Messages sent to a Channel generalChannel.on('messageAdded', function(message) { // Decrypt the Message using card id and private key values. var decryptedMessage = virgil.crypto.decryptStringFromBase64( message.body, myCard.id, keyPair.privateKey ); console.log(message.author + ': ' + decryptedMessage); });</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">And see the following:</b> <div class="spoiler_text">  Darth Vader: Luke.  I am your father! <br></div></div><br></li></ol><br>  Simple enough.  You write just a few lines of code and get full end-to-end encryption with the ability to authenticate keys.  At the same time, Virgil Security services do not have access to users' private keys, which excludes the possibility of reading secret data. </div><p>Source: <a href="https://habr.com/ru/post/301772/">https://habr.com/ru/post/301772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301756/index.html">FreePBX and CallBack: see caller numbers</a></li>
<li><a href="../301760/index.html">Creating a blog on symfony 2.8 lts</a></li>
<li><a href="../301764/index.html">Learning from mistakes in the organization of quality control</a></li>
<li><a href="../301766/index.html">JPoint Student Day: why conference "student day"?</a></li>
<li><a href="../301768/index.html">Add dependencies to CDI. Part 2</a></li>
<li><a href="../301776/index.html">Caution - Bulldozer (build apk packages in Kivy)</a></li>
<li><a href="../301780/index.html">GoTech Meetup ‚ÄúData Analysis by Machine Learning Methods‚Äù</a></li>
<li><a href="../301786/index.html">Techniques to capture the user's attention - from a magician and a designer ethics specialist at Google</a></li>
<li><a href="../301790/index.html">Paul Graham: Chapter 2. Hackers and Artists (Habr edition)</a></li>
<li><a href="../301798/index.html">Distributed time tracking program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>