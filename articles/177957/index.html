<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sectioning and live snapshots of data in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Although the topic of partitioning has already been raised earlier , I want to return to it in order to tell about my experience in solving this probl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sectioning and live snapshots of data in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article">  Although the topic of partitioning has already been raised <a href="http://habrahabr.ru/post/74984/">earlier</a> , I want to return to it in order to tell about my experience in solving this problem, which arose due to the need for analytic processing of large amounts of data.  In addition to partitioning, I will consider the extremely simplified implementation of ‚Äúsnapshots‚Äù of aggregated queries that are automatically updated when the source data changes. <br><a name="habracut"></a><br>  One of the main requirements for the developed system was the use of free software, and therefore, the choice fell on PostgreSQL.  When I started working on the project, I knew PostgreSQL rather superficially, but I was quite familiar with the features of Oracle Database.  As it was a question of analytical processing, I wanted to have analogues of such Oracle options as <a href="http://docs.oracle.com/cd/A97630_01/server.920/a96520/parpart.htm">Partitioning</a> and <a href="http://docs.oracle.com/cd/A97630_01/server.920/a96520/mv.htm">Materialized Views</a> .  After getting acquainted with the capabilities of <a href="http://www.postgresql.org/docs/9.1/static/ddl-partitioning.html">PostgreSQL</a> , it became clear that this functionality, one way or another, would have to be written manually. <br><br>  Of course, it was not about any full implementation of Materialized Views, involving the <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28313/qrbasic.htm">rewriting of requests</a> .  For my needs, the possibility of creating automatically updated aggregated single-table samples was quite enough (support for joining tables is likely to be added in the near future).  For partitioning, I planned to use a multiple-described approach using <a href="http://www.postgresql.org/docs/9.0/static/ddl-inherit.html">inherited</a> tables, with data insertion controlled by a trigger.  I had the idea to use <a href="http://www.postgresql.org/docs/9.1/static/ddl-partitioning.html">Rules</a> to control the partitioning, but I refused it because, in my case, data insertion with single records prevailed. <br><br>  I began, of course, with tables for storing metadata: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">ps_tables.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> ps_table_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ps_table ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ps_table_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> ps_column_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ps_column ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ps_column_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, table_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, parent_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), type_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (type_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'nullable'</span></span>, <span class="hljs-string"><span class="hljs-string">'sum'</span></span>, <span class="hljs-string"><span class="hljs-string">'min'</span></span>, <span class="hljs-string"><span class="hljs-string">'max'</span></span>, <span class="hljs-string"><span class="hljs-string">'cnt'</span></span>)), <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> (table_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>), primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ps_range_partition ( table_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), type_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (type_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'day'</span></span>, <span class="hljs-string"><span class="hljs-string">'week'</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>)), start_value <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, end_value <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(table_id, start_value) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ps_snapshot ( snapshot_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), table_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), type_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (type_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'day'</span></span>, <span class="hljs-string"><span class="hljs-string">'week'</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>)), primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(snapshot_id) );</code> </pre> <br></div></div><br>  Everything is quite obvious here.  The only thing worth mentioning is the column types: <br><table border="1"><tbody><tr><td>  <b>Type of</b> <br></td><td>  <b>Description</b> <br></td></tr><tr><td>  <b>date</b> <br></td><td>  Column containing the calendar date used for data partitioning and aggregation (PostgreSQL date and timestamp types supported) <br></td></tr><tr><td>  <b>key</b> <br></td><td>  The key used in the group by phrase for data aggregation (all PostgreSQL integer types are supported) <br></td></tr><tr><td>  <b>nullable</b> <br></td><td>  The key used in data aggregation, possibly containing a null value <br></td></tr><tr><td>  <b>sum</b> <br></td><td>  Summation of values <br></td></tr><tr><td>  <b>min</b> <br></td><td>  Minimum value <br></td></tr><tr><td>  <b>max</b> <br></td><td>  Maximum value <br></td></tr><tr><td>  <b>cnt</b> <br></td><td>  Counting the number of non-null values <br></td></tr></tbody></table><br>  The basis of the entire solution was the function that performs the rebuilding of the functions of the triggers for the table containing the source data: <br><br><div class="spoiler">  <b class="spoiler_title">ps_trigger_regenerate (bigint)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_trigger_regenerate(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_sql <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_table_name varchar(50); l_date_column varchar(50); l_flag boolean; tabs record; columns record; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_table; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || l_table_name || '</span></span>_insert_trigger() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $<span class="hljs-string"><span class="hljs-string">'|| '</span></span>$ <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-string"><span class="hljs-string">'; for tabs in select a.snapshot_id as id, b.name as table_name, a.type_name as snapshot_type from ps_snapshot a, ps_table b where a.table_id = p_table and b.id = a.snapshot_id loop l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.table_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and not type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">least</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>, NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">greatest</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>, NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>cnt<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || tabs.snapshot_type || '''</span></span>), NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>nullable<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_sql := l_sql || '</span></span>; ' || 'if not FOUND then ' || '<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.table_name || '</span></span>(<span class="hljs-string"><span class="hljs-string">'; l_flag = FALSE; for columns in select name, type_name from ps_column where table_id = tabs.id loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; l_sql := l_sql || columns.name; end loop; l_sql := l_sql || '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'; l_flag = FALSE; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span>date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || tabs.snapshot_type || '''</span></span>), NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; elsif columns.type_name = '</span></span>cnt<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span><span class="hljs-string"><span class="hljs-string">'; elsif columns.type_name in ('</span></span>nullable<span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">') then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-string"><span class="hljs-string">'; else l_sql := l_sql || '</span></span>NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name; end if; end loop; l_sql := l_sql || '</span></span>); ' || '<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; '; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_date_column <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_column <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = p_table <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> type_name = <span class="hljs-string"><span class="hljs-string">'date'</span></span>; for tabs in <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> to_char(start_value, <span class="hljs-string"><span class="hljs-string">'YYYYMMDD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> start_value, to_char(end_value, <span class="hljs-string"><span class="hljs-string">'YYYYMMDD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> end_value, type_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_range_partition <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = p_table <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> start_value <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> l_sql := l_sql || <span class="hljs-string"><span class="hljs-string">'if NEW.'</span></span> || l_date_column || <span class="hljs-string"><span class="hljs-string">' &gt;= to_date('''</span></span> || tabs.start_value || <span class="hljs-string"><span class="hljs-string">''', ''YYYYMMDD'') and NEW.'</span></span> || l_date_column || <span class="hljs-string"><span class="hljs-string">' &lt; to_date('''</span></span> || tabs.end_value || <span class="hljs-string"><span class="hljs-string">''', ''YYYYMMDD'') then '</span></span> || <span class="hljs-string"><span class="hljs-string">'insert into '</span></span> || l_table_name || <span class="hljs-string"><span class="hljs-string">'_'</span></span> || tabs.start_value || <span class="hljs-string"><span class="hljs-string">' values (NEW.*); '</span></span> || <span class="hljs-string"><span class="hljs-string">'return null; '</span></span> || <span class="hljs-string"><span class="hljs-string">'end if; '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; l_sql := l_sql || 'return NEW; '|| '<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; '|| '$'||'$ language plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> l_sql; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || l_table_name || '</span></span>_raise_trigger() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $<span class="hljs-string"><span class="hljs-string">'|| '</span></span>$ <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>Can<span class="hljs-string"><span class="hljs-string">''''</span></span>t support % <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">aggregate</span></span><span class="hljs-string"><span class="hljs-string">''</span></span>, TG_OP;' || '<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; '|| '$'||'$ language plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> l_sql; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || l_table_name || '</span></span>_delete_trigger() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $<span class="hljs-string"><span class="hljs-string">'|| '</span></span>$ <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-string"><span class="hljs-string">'; for tabs in select a.snapshot_id as id, b.name as table_name, a.type_name as snapshot_type from ps_snapshot a, ps_table b where a.table_id = p_table and b.id = a.snapshot_id loop l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.table_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and type_name in ('</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>cnt<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> - OLD.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>cnt<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> OLD.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || tabs.snapshot_type || '''</span></span>), NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>nullable<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_sql := l_sql || '</span></span>; '; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; l_sql := l_sql || 'return null; '|| '<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; '|| '$'||'$ language plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> l_sql; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || l_table_name || '</span></span>_update_trigger() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $<span class="hljs-string"><span class="hljs-string">'|| '</span></span>$ <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-string"><span class="hljs-string">'; for tabs in select a.snapshot_id as id, b.name as table_name, a.type_name as snapshot_type from ps_snapshot a, ps_table b where a.table_id = p_table and b.id = a.snapshot_id loop l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.table_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and type_name in ('</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>cnt<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> - OLD.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> + NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>cnt<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> OLD.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_flag = FALSE; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">'; for columns in select name, parent_name, type_name from ps_column where table_id = tabs.id and type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || tabs.snapshot_type || '''</span></span>), NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>) <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span> <span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>nullable<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(NEW.<span class="hljs-string"><span class="hljs-string">' || columns.parent_name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_sql := l_sql || '</span></span>; '; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; l_sql := l_sql || 'return null; '|| '<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; '|| '$'||'$ language plpgsql'; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> l_sql; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql;</code> </pre><br></div></div><br>  Despite its awesome appearance, this feature is pretty simple.  Its task is to form (based on the available metadata) four functions used in the construction of triggers: <br><br><ul><li>  ps_TABLE_insert_trigger () - The function that controls the insertion of data </li><li>  ps_TABLE_update_trigger () - Data Update Control Function </li><li>  ps_TABLE_delete_trigger () - Function to manage data deletion </li><li>  ps_TABLE_raise_trigger () - The function prohibiting updating and deleting data </li></ul><br>  Here, instead of TABLE, the name of the table containing the source data is substituted.  A typical definition of the ps_TABLE_insert_trigger () function would be as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_data_insert_trigger() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> data_month <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sum_field = sum_field + NEW.sum_field , min_field = <span class="hljs-keyword"><span class="hljs-keyword">least</span></span>(min_field, NEW.min_field) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> date_field = date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>, NEW.date_field) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> key_field = NEW.key_field; if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> data_month(date_field, key_field, sum_field, min_field) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>, NEW.date_field), NEW.key_field, NEW.sum_field, NEW.min_field); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if NEW.date_field &gt;= to_date('20130101', 'YYYYMMDD') and NEW.date_field &lt; to_date('20130201', 'YYYYMMDD') then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> data_20130101 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (NEW.*); return null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; return NEW; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql;</code> </pre><br>  Actually, the function looks somewhat more complicated, since null values ‚Äã‚Äãare handled in a special way.  But, as an illustration, the above example is quite adequate.  The logic of this code is obvious: <br><br><ul><li>  When inserting data into the original table, we try to update the counters in the aggregated data_month view </li><li>  If this fails (record in data_month is not found), add a new record </li><li>  Next, we check the hit in the date range for each section (in the example one section), and if we succeed, insert the record into the appropriate section (since the section is inherited from the main table, you can safely use an asterisk) and return null to prevent the record from being inserted into the main table </li><li>  If none of the sections fit, return NEW, allowing insertion into the main table. </li></ul><br><br>  The last point leads to the fact that if the appropriate section is not found, the data is added to the main table.  In practice, it is quite convenient.  Even if we do not create a section in advance or receive data with an incorrect date, data insertion will succeed.  You can later analyze the contents of the main table by running the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span></code> </pre><br>  After that, create the missing sections (as it will be shown below, the data will be automatically transferred from the main table to the created section).  In such cases, the number of records that did not fall into their section, as a rule, is not large and the costs for data transfer are insignificant. <br><br>  Now it is necessary to make a harness.  Let's start with the function of creating a new section: <br><br><div class="spoiler">  <b class="spoiler_title">ps_add_range_partition (varchar, varchar, varchar, date)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_add_range_partition(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_column <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_type <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_start <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_sql <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_end date; l_start_str varchar(10); l_end_str varchar(10); l_table bigint; l_flag boolean; columns record; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> perform <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table a, ps_column b <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.id = b.table_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(a.name) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> b.type_name = <span class="hljs-string"><span class="hljs-string">'date'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(b.name) &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_column); if FOUND then raise EXCEPTION 'Conflict DATE columns'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; l_end := p_start + ('1 ' || p_type)::INTERVAL; perform 1 from ps_table a, ps_range_partition b where a.id = b.table_id and lower(a.name) = lower(p_table) and (( p_start &gt;= b.start_value and p_start &lt; b.end_value ) or ( b.start_value &gt;= p_start and b.start_value &lt; l_end )); if FOUND then raise EXCEPTION 'Range intervals intersects'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; perform 1 from ps_table where lower(name) = lower(p_table); if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table); perform 1 from ps_column where table_id = l_table and type_name = 'date' and lower(name) = lower(p_column); if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_column(table_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, type_name) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_table, <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_column), <span class="hljs-string"><span class="hljs-string">'date'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_range_partition(table_id, type_name, start_value, end_value) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_table, p_type, p_start, l_end); l_start_str = to_char(p_start, 'YYYYMMDD'); l_end_str = to_char(l_end, 'YYYYMMDD'); l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>(<span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (<span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_start_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_end_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>)), <span class="hljs-string"><span class="hljs-string">' || '</span></span>primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select f.name as name from ( select ps_array_to_set(a.conkey) as nn from pg_constraint a, pg_class b where b.oid = a.conrelid and a.contype = '</span></span>p<span class="hljs-string"><span class="hljs-string">' and b.relname = p_table ) c, ( select d.attname as name, d.attnum as nn from pg_attribute d, pg_class e where e.oid = d.attrelid and e.relname = p_table ) f where f.nn = c.nn order by f.nn loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; l_sql := l_sql || columns.name; end loop; l_sql := l_sql || '</span></span>)) inherits (<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>_date <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>(<span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; execute l_sql; perform ps_trigger_regenerate(l_table); execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_start_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_end_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>)<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_start_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">' || p_column || '</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">''' || l_end_str || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>YYYYMMDD<span class="hljs-string"><span class="hljs-string">''</span></span>)<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_insert_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; perform 1 from ps_snapshot a, ps_column b where b.table_id = a.snapshot_id and a.table_id = l_table and b.type_name in ('</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span><span class="hljs-string"><span class="hljs-string">'); if FOUND then l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; else l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_update_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_delete_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_update_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_delete_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; end if; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  Here, after checking the correctness of the input data, we add the necessary metadata, after which we create the inherited table.  Then, we re-create the trigger functions by calling ps_trigger_regenerate, then transfer the data that falls under the partitioning condition into the created section with a dynamic query and re-create the triggers themselves. <br><br>  Difficulties arose with two points. <br><br><ol><li>  I had to suffer a little with the addition of the month, day or year to the starting date (depending on the input parameter p_type: <br><br><pre> <code class="hljs ruby">l_end <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= p_start + (<span class="hljs-string"><span class="hljs-string">'1 '</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> p_type)<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:INTERVAL</span></span>;</code> </pre><br></li><li>  Since the primary key is not inherited, I had to compose a query to <a href="http://www.postgresql.org/docs/9.2/static/catalogs.html">System Catalogs</a> , to get a list of the primary key columns of the source table (I also found it inappropriate to store the primary key description in my metadata): <br><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> f.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_array_to_set(a.conkey) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_constraint a, pg_class b <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> b.oid = a.conrelid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.contype = <span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> b.relname = p_table ) c, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> d.attname <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, d.attnum <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_attribute d, pg_class e <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> e.oid = d.attrelid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> e.relname = p_table ) f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> f.nn = c.nn <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> f.nn</code> </pre><br></li></ol><br>  Also, it should be noted that before creating an index on the partitioning key (for the created partition), it would be worthwhile to first check whether it is the leading column of the primary key (so as not to create a duplicate index). <br><br>  The function of deleting a section is much simpler and does not need special comments: <br><br><div class="spoiler">  <b class="spoiler_title">ps_del_range_partition (varchar, date)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_del_range_partition(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_start <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_sql <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_start_str varchar(10); l_table bigint; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table); l_start_str = to_char(p_start, 'YYYYMMDD'); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_range_partition <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = l_table <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> start_value = p_start; perform ps_trigger_regenerate(l_table); l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str; execute l_sql; perform 1 from ( select 1 from ps_range_partition where table_id = l_table union all select 1 from ps_snapshot where table_id = l_table ) a; if not FOUND then execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_insert_trigger() <span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span><span class="hljs-string"><span class="hljs-string">'; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger() <span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span><span class="hljs-string"><span class="hljs-string">'; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_update_trigger() <span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span><span class="hljs-string"><span class="hljs-string">'; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_delete_trigger() <span class="hljs-keyword"><span class="hljs-keyword">cascade</span></span><span class="hljs-string"><span class="hljs-string">'; delete from ps_column where table_id = l_table; delete from ps_table where id = l_table; end if; perform 1 from ps_range_partition where table_id = l_table; if not FOUND then delete from ps_column where table_id = l_table and type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">'; end if; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_<span class="hljs-string"><span class="hljs-string">' || l_start_str; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  When deleting a section, data, naturally, is not lost, but transferred to the main table (triggers are deleted beforehand, because, as it turned out, the keyword only does not work in the insert statement). <br><br>  It remains to add the management functions of "live" data snapshots: <br><br><div class="spoiler">  <b class="spoiler_title">ps_add_snapshot_column (varchar, varchar, varchar, varchar)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_add_snapshot_column(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_snapshot <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_column <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_parent <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_type <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_table <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> perform <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot); if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_column(table_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, parent_name, type_name) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_table, <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_column), <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_parent), p_type); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ps_add_snapshot (varchar, varchar, varchar)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_add_snapshot(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_snapshot <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_type <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_sql <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_table bigint; l_snapshot bigint; l_flag boolean; columns record; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_snapshot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot); perform 1 from ps_column where table_id = l_snapshot and type_name in ('date', 'key'); if not FOUND then raise EXCEPTION 'Key columns not found'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; perform 1 from ps_column where table_id = l_snapshot and not type_name in ('date', 'key', 'nullable'); if not FOUND then raise EXCEPTION 'Aggregate columns not found'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; perform 1 from ps_table where lower(name) = lower(p_table); if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ps_snapshot(table_id, snapshot_id, type_name) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_table, l_snapshot, p_type); perform ps_trigger_regenerate(l_table); l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">' || p_snapshot || '</span></span> (<span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select name, type_name from ps_column where table_id = l_snapshot loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name || '</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span><span class="hljs-string"><span class="hljs-string">'; else l_sql := l_sql || columns.name || '</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span><span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_sql := l_sql || '</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select name from ps_column where table_id = l_snapshot and type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; l_sql := l_sql || columns.name; end loop; l_sql := l_sql || '</span></span>))<span class="hljs-string"><span class="hljs-string">'; execute l_sql; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_insert_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; perform 1 from ps_snapshot a, ps_column b where b.table_id = a.snapshot_id and a.table_id = l_table and b.type_name in ('</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span><span class="hljs-string"><span class="hljs-string">'); if FOUND then l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; else l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_update_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_delete_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; end if; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || p_snapshot || '</span></span>(<span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select name from ps_column where table_id = l_snapshot loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; l_sql := l_sql || columns.name; end loop; l_sql := l_sql || '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select parent_name as name, type_name from ps_column where table_id = l_snapshot loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span>date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || p_type || '''</span></span>), <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || columns.name; end if; if columns.type_name = '</span></span>nullable<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; if columns.type_name = '</span></span>cnt<span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; end loop; l_sql := l_sql || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'; l_flag := FALSE; for columns in select parent_name as name, type_name from ps_column where table_id = l_snapshot and type_name in ('</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">key</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span>nullable<span class="hljs-string"><span class="hljs-string">') loop if l_flag then l_sql := l_sql || '</span></span>, <span class="hljs-string"><span class="hljs-string">'; end if; l_flag := TRUE; if columns.type_name = '</span></span><span class="hljs-built_in"><span class="hljs-built_in">date</span></span><span class="hljs-string"><span class="hljs-string">' then l_sql := l_sql || '</span></span>date_trunc(<span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-string"><span class="hljs-string">''' || p_type || '''</span></span>), <span class="hljs-string"><span class="hljs-string">' || columns.name || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; else l_sql := l_sql || columns.name; end if; end loop; execute l_sql; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ps_del_snapshot (varchar)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ps_del_snapshot(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_snapshot <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_sql <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; p_table varchar(50); l_table bigint; l_snapshot bigint; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> a.table_id, c.name <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table, p_table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_snapshot a, ps_table b, ps_table c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> b.id = a.snapshot_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c.id = a.table_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(b.name) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_snapshot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_snapshot); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_snapshot <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> snapshot_id = l_snapshot; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_column <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = l_snapshot; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = l_snapshot; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop trigger if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_before_insert on '</span></span> || p_table; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop trigger if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_after_update on '</span></span> || p_table; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop trigger if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_after_delete on '</span></span> || p_table; perform 1 from ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_range_partition <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = l_table <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ps_snapshot <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_id = l_table ) a; if not FOUND then <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop function if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_insert_trigger() cascade'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop function if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_raise_trigger() cascade'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop function if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_update_trigger() cascade'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-string"><span class="hljs-string">'drop function if exists ps_'</span></span> || p_table || <span class="hljs-string"><span class="hljs-string">'_delete_trigger() cascade'</span></span>; else perform ps_trigger_regenerate(l_table); l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_before_insert <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_insert_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; perform 1 from ps_snapshot a, ps_column b where b.table_id = a.snapshot_id and a.table_id = l_table and b.type_name in ('</span></span><span class="hljs-keyword"><span class="hljs-keyword">min</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-keyword"><span class="hljs-keyword">max</span></span><span class="hljs-string"><span class="hljs-string">'); if FOUND then l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_raise_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; else l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_update <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_update_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_after_delete <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> ps_<span class="hljs-string"><span class="hljs-string">' || p_table || '</span></span>_delete_trigger()<span class="hljs-string"><span class="hljs-string">'; execute l_sql; end if; end if; execute '</span></span><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> <span class="hljs-string"><span class="hljs-string">' || p_snapshot; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  Here, too, there is nothing fundamentally new and the only thing I would like to note is that in the case of using the 'min' or 'max' aggregates, when creating triggers, the ps_TABLE_raise_trigger () function is used, prohibiting deletions and changes in the table which is built snapshot.  This was done because I could not come up with an adequate performance implementation of updating these aggregates when executing the update and delete statements in the source table. <br><br>  Let's see how it all works.  Create a test table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> test_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'test_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, event_time <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, customer_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br>  Now, to add a section, just run the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_range_partition(<span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_time'</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">'20130501'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYYMMDD'</span></span>))</code> </pre><br>  As a result, an inherited table test_20130501 will be created, into which all records for the month of May will automatically fall. <br><br>  To delete a section, you can run the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_del_range_partition(<span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(<span class="hljs-string"><span class="hljs-string">'20130501'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYYMMDD'</span></span>))</code> </pre><br><br>  Creating a snapshot is somewhat more complicated, since it is first necessary to determine the columns of interest to us: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot_column(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot_column(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_time'</span></span>, <span class="hljs-string"><span class="hljs-string">'date'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot_column(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'value_sum'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'sum'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot_column(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'value_cnt'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'cnt'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot_column(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'value_max'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'max'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_add_snapshot(<span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-string"><span class="hljs-string">'test_month'</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>)</code> </pre><br><br>  As a result, an automatically updated table will be created based on the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> customer_id, date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>, event_time), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> value_sum, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> value_cnt, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> value_max <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> customer_id, date_trunc(<span class="hljs-string"><span class="hljs-string">'month'</span></span>, event_time)</code> </pre><br>  You can remove the snapshot by running the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_del_snapshot(<span class="hljs-string"><span class="hljs-string">'test_month'</span></span>)</code> </pre><br>  On this, for today, everything.  Scripts can be picked up on <a href="https://github.com/GlukKazan/ps">github</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/177957/">https://habr.com/ru/post/177957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177939/index.html">VIZIO. Low cost laptop with Full HD IPS screen</a></li>
<li><a href="../177947/index.html">As we Cisco Phone with Asterisk SIP were friends</a></li>
<li><a href="../177949/index.html">Iceland's court ordered Visa to resume payments for Wikileaks</a></li>
<li><a href="../177953/index.html">Browser game server development ... as an academic discipline</a></li>
<li><a href="../177955/index.html">Startup Advise Wallet: a wallet of successful recommendations</a></li>
<li><a href="../177959/index.html">How I implemented A / B testing in PHP</a></li>
<li><a href="../177961/index.html">PROGOROD: (not only) virtual travels in real cities</a></li>
<li><a href="../177963/index.html">Viral advertising Russian software: mission failed?</a></li>
<li><a href="../177965/index.html">HP Pavilion g6 laptop video review</a></li>
<li><a href="../177967/index.html">Serious design serious sites. Part 1. Analytics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>