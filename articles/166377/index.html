<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of reverse engineering of one fluffy animal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On a quiet morning on the third of January, when Moscow was already dozing after the New Year holidays, the doorbell rang in our apartment. Mail has f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of reverse engineering of one fluffy animal</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/570/d35/f20/570d35f206e4bed3bf6af18cb0cbbefd.jpg"><br><br>  On a quiet morning on the third of January, when Moscow was already dozing after the New Year holidays, the doorbell rang in our apartment.  Mail has finally delivered a package with Christmas gifts ordered on Amazon.  Among other things, it contained a gift for the son, the electronic pet <a href="http://www.amazon.com/s/%3Ffield-keywords%3Dfurby">Furby</a> .  Buying it was, in general, impulsive.  The toy was in the bestsellers of the New Year season and was relatively inexpensive.  I did not understand the Furby varieties, but once upon a time I heard something positive about the toy. <br><br>  My little son, by virtue of his one-year-old age, was not very impressed with the gift, but I was sorry to allow me to throw a complicated electronic device on the floor and tear off this device, and everything went to removing the gift on the shelf until better times, but my mind fell on one inscription on colorful packaging ... <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The inscription said that for this toy in the AppStore, you can download an application with which you can feed a cyber howler, give him all sorts of commands, and also translate phrases he pronounced in his language Furbish into English.  The application was downloaded, the pet was fed with all sorts of edible and inedible objects, which he either swallowed with appetite or spat out, and the translator from furbish to English worked surprisingly accurately. <br><br>  Does audio recognition work in our time so reliably and even in a rather noisy environment?  Something is wrong here.  And how does the app transmit Furby commands?  IR disappears (earlier versions of Furby, as it turned out, had infrared to communicate with each other), Bluetooth, too.  Only audio remains.  This is interesting ... Now, if you could hack the communication protocol with this creature and be able to manage it from your computer ... Find some ‚ÄúEaster eggs‚Äù, hidden or service commands!  Or‚Ä¶ <br><br>  In general, as you understood, the father of the family made a present for himself on the New Year. <br><br>  *** <br><br>  To start, synced the iPhone with the computer and looked inside the application file (.ipa).  Among other trials, there were several dozens of short WAV files numbered in a special way.  All this was very much like ready-made audio teams.  The first file began with the number 350. After playing this file in Audacity Furby, he busily chewed something and gave out a joyful ‚ÄúMmm, yum!‚Äù.  ‚ÄúAha!‚Äù Thought Stirlitz. ‚ÄúNow that you are my stuff!‚Äù <br><br>  Commands in the application began with the 350th and ended the 900th, with large spaces in the numbering.  So potentially, Furby can perceive a much larger number of commands than there are in the hands of these ready-made WAV files.  We must look further. <br><br>  The appearance of the signal in Audacity suggested that some kind of frequency modulation was used, one signal being sent, a small pause, then a visual signal again.  The total duration is one and a half seconds.  Once the modulation frequency, it would be nice to look at the spectrum.  I looked at the chart - it clearly stood out five peaks at equal distances from each other in the region of 16-19KHz: <br><br><img src="https://habrastorage.org/storage2/cd0/fc9/c7b/cd0fc9c7b76bf17e2ef7dc345edcc423.png"><br><br>  The tower from Mordor is, of course, beautiful, but how to decipher it?  I rummaged in Audacity a bit more and discovered the audio display mode in the form of a spectrogram.  This picture was already much more beautiful than the first: <br><br><img src="https://habrastorage.org/storage2/1a7/ba4/79a/1a7ba479ab87094c29f17bec53e00536.jpg"><br><br>  Here two parcels with a pause in the middle are clearly visible, differing from each other in the order of the ‚Äúnotes‚Äù (base frequencies).  Moreover, the average frequency is a carrier, constantly alternating with the other four "notes". <br><br>  For convenience of decoding the sequence, I made a mask in the graphic editor, which I put on top of the spectrogram screenshot, assigned each note consecutive numbers from 0 to 3 and began to analyze successive teams (as we remember, iOS application developers helpfully numbered all WAV files).  At first it turned out that in neighboring teams, numbers sometimes ‚Äújump‚Äù, i.e.  do not go the way I would like if we increment the numbers sequentially.  After some analysis, it became clear that the ‚Äúnotes‚Äù should be numbered as in the figure below: <br><br><img src="https://habrastorage.org/storage2/b22/647/8b0/b226478b0ccd2665fa22dd5a957f67c4.jpg"><br><br>  Here, the parcel is decoded as <code>3233 3012 1032</code> (for convenience of perception, I divided the sequences into blocks of four digits; in the quaternary system, each such block is one byte). <br><br>  Further analysis of the commands, translation of their binary form and bitwise comparison revealed the following structure of the premise and commands in general: <br><br><ol><li>  The first byte ( <code>3233</code> in the example), being written in binary form, has the following structure: <code>11 1 01111</code> , where the upper two bits are always <code>11</code> , the next bit is <code>0</code> for the first message in the command and <code>1</code> for the second, and <code>01111</code> are themselves data (part of the command identifier); </li><li>  The second byte ( <code>3012</code> ) is a checksum depending on 6 bits of the command (where 1 bit is the ID of the package and 5 bits is the data itself); </li><li>  The third and final byte of the parcel is always <code>1032</code> . </li></ol><br><br>  What does it mean?  First, the command is divided into two packets of 5 bits of data each.  In total, we get a 10-bit number, i.e.  the potential number of commands that Furby can send or receive is 1024. However, it was not possible to calculate the checksum calculation method.  After analyzing the numbers of the teams, it turned out that I can find 7 of 32 checksums for the first package and 31 of 32 checksums for the second package based on the available WAV files.  In total, this gave 217 potential teams instead of the existing 76 (in the form of ready-made WAV files), which is also quite good. <br><br>  I wrote a script that generated a WAV file, similar to a ready one, according to the desired command number, and began to sort through the ranges of commands available to me.  As it turned out, undocumented teams really were - Furby reacted to them in different ways, sang songs, read rap, sneezed, imitated sleep and did other simple things. <br><br>  This spurred research appetite, but the algorithm for calculating the checksum for reverse engineering stubbornly resisted, which means most of the teams remained inaccessible to me. <br><br>  Once again, combing the Internet for any clues, I suddenly found a link to the official Furby app for Android (about which there was not a word on the box with the toy).  ‚ÄúAndroid ‚Üí Java ‚Üí bytecode ‚Üí source codes ‚Üí ... ‚Üí PROFIT!‚Äù.  Never before has Stirlitz been so close to a clue ... <br><br>  *** <br><br>  When I finally found the .apk file I needed on some dump, I climbed inside and did not see a single WAV file with commands, although in general the set of resources was similar to the one in the iOS application.  If there are no WAV files, does the application generate commands on the fly?  That's what I need!  Decompiling and viewing Java code gave some interesting clues, but as it turned out, all the interesting stuff, namely the generation and analysis of audio, is inside the native .so library, which has one method that I needed, namely <code>private static native byte[] GenerateComAirCommand(int paramInt);</code>  . <br><br>  How to reach the native method?  Pointing brain, Stirlitz decided to download the Android SDK.  As a result, a small project was assembled, which included the native library itself and a minimal binding that provides access to the function I need only.  At the very start, the application itself simply created WAV files for the minimum required set of WAV files, where the teams had the same missing upper and lower 5 bits for which I needed checksums.  After some smoking of Stack Overflow (I didn‚Äôt have any experience writing Android), the application started and generated on my virtual SD-card emulator a set of WAV files I needed, which I dragged via <code>adb pull</code> into a normal file system.  Analysis of these files gave me full coverage - all 64 checksums by which you can recreate any of the 1024 teams. <br><br>  During the analysis of Furby's reactions to the teams, another range of commands was found, to which Furby somehow reacted.  However, no atomic commands like ‚Äúopen eyes‚Äù, ‚Äúclose eyes‚Äù, ‚Äúears moved‚Äù were found.  Neither was the self-destruct or eula reading command found on furbish (this does not mean that there are no specialized commands, they can be activated, for example, by a special sequence or by another set of codes ‚Äî but it is hardly possible to find out ). <br><br>  *** <br><br>  However, I decided to go ahead and write a Furby response analyzer, as some commands, although not giving visible results, can trigger Furby's response in the form of response commands, which is also interesting.  As a result, a Perl script was written, analyzing the PCM data stream from the microphone, making it on the fly and deciphering these messages.  All this was written under Windows, where for Perl, unfortunately, there are no normal ways to record data from a microphone, so I had to make a Delphi console program that reads data from a microphone and outputs them continuously to STDOUT.  The data stream is redirected to the script where the analysis is already taking place.  Such is the Unix way for Windows. <br><br>  <b>‚ÄúStop, stop, stop,‚Äù the tired reader will say, ‚ÄúAnd what is all this for?‚Äù</b> <br><br>  It was interesting for me to see ‚Äúwhat‚Äôs inside‚Äù without physically breaking the toy (I didn‚Äôt buy it myself).  Along the way, I gained knowledge about the generation and analysis of sound in Perl, FFT, window functions, and work with Android, which is fascinating in itself. <br><br>  Perhaps this article will be useful to someone when implementing their own protocol, because there are all sorts of interesting <a href="https://squareup.com/">gadgets for the iPhone</a> that transmit data just through the audio jack. <br><br>  And finally, the ability to control Furby through a computer potentially opens the emotional method of notification of some events.  For example, when mail arrives from a specific addressee, you can ask Furby to dance something, when a commit comes to Git from a certain person, to purr, and from another, to make a sound less decent (of which Furby has it in stock).  The truth for this is still necessary to solve a couple of tasks of hardware.  First, prevent Furby from falling asleep after 10 minutes of inactivity (and physical braking is considered an activity - for this he has a position sensor in space) and power it not from batteries, but from a power supply or USB.  Maybe on Habr√© there are iron experts who will want to finally tame the animal? <br><br>  The code itself after some combing <a href="https://github.com/iafan/Hacksby">is laid out on GitHub</a> .  Wishes and finds in every way welcome.  Of course, all the information and software code presented is provided solely for educational purposes. <br><br>  Oo-tah-toh-toh.  Kah way-loh. </div><p>Source: <a href="https://habr.com/ru/post/166377/">https://habr.com/ru/post/166377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166363/index.html">A few words about productivity</a></li>
<li><a href="../166367/index.html">Features of using roles with authentication in Oracle since 10.2.0.5</a></li>
<li><a href="../166369/index.html">Living computer museum</a></li>
<li><a href="../166373/index.html">Sending temperature data from the TL-MR3020 router and the Raspberry Pi to People's Monitoring</a></li>
<li><a href="../166375/index.html">And again about ... LAMP and basic secure mini-hosting with your own hands</a></li>
<li><a href="../166383/index.html">Looking for the perfect commenting system</a></li>
<li><a href="../166385/index.html">ZFTool, command line for ZF2</a></li>
<li><a href="../166387/index.html">The use of ionistrov for regenerative braking in the subway</a></li>
<li><a href="../166389/index.html">4 UX principles that Microsoft forgot about in Windows 8</a></li>
<li><a href="../166391/index.html">Free send a message to any Facebook user</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>