<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik Router OS. "Fair" channel separation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the open spaces of Habr, I came across a couple of articles ‚ÄúMikrotik Router OS, a script for dynamic speed division‚Äù. And since I have been workin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik Router OS. "Fair" channel separation</h1><div class="post__text post__text-html js-mediator-article">  In the open spaces of Habr, I came across a couple of articles ‚ÄúMikrotik Router OS, a script for dynamic speed division‚Äù.  And since I have been working on this problem for more than a year, I decided to share my knowledge. <br><br>  First of all, this article is useful to those who have a desire to ‚Äúfairly share the Internet‚Äù among several clients of the network.  However, the solution is also suitable for dividing the communication channel of several offices or accessing individual resources, and for shaping. <br><a name="habracut"></a><br><br><h4>  Introduction </h4><br>  By ‚Äúfair‚Äù channel separation, I mean the utilization of all its bandwidth regardless of the number of consumers.  And consumers should receive the channel equally. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since I work from under windows, for convenience, I will use WinBox, which allows you to configure the router using visual snap-ins.  From my point of view, using WinBox is much more convenient than the command line.  in the presence of a set of rules, find the necessary much easier  And the speed of navigation increases significantly. <br><br>  Users of Linx and Unix systems should not be discouraged.  WinBox works fine under Vain.  In addition, MikroTik has a convenient <a href="http://wiki.mikrotik.com/wiki/Manual:Webfig">WebFig</a> web <a href="http://wiki.mikrotik.com/wiki/Manual:Webfig">configurator</a> . <br><br>  Further in the article I will provide text descriptions of my actions and explain them with graphics.  At the end of the article I will provide a link to the configuration file of the router, so that you can examine it, pour it into your router and check it.  For these purposes, I recommend using MiktoTik versions for x86 compatible systems and virtual machines. <br><br>  Also at the end of the article I will try to provide all useful links.  If you don‚Äôt find something, please let me know and I will try to complete the article. <br><br><h4>  Formulation of the problem </h4><br>  First I will describe some of the tasks that you can solve by studying this article. <br>  I will make two reservations in advance: <br>  1. All the tasks described should be performed with any number of load / output streams by each consumer. <br>  2. By channel, I mean both incoming and outgoing channels. <br><br>  Required: <br><br><ol><li>  It is fair to divide incoming and outgoing channels between users: <br><ul><li>  With the full utilization of the bandwidth of the channel by all consumers, the channel must be divided equally between them. </li><li>  With a free channel or a small utilization of the bandwidth of the channel by some consumers, other consumers should be provided with all the remaining bandwidth of the channel, but no more. </li></ul></li><li>  Flexibly separate incoming and outgoing channels between users: <br><ul><li>  It should be possible to limit the width of the incoming / outgoing channel of any user or to any external resource. </li><li>  It should be possible for the necessary services to provide the channel width / speed required for their normal operation. </li></ul></li><li>  Make quick loading of Web pages, regardless of the current recycling channel. </li></ol><br><h5>  A bit of clarification. </h5><br><h6>  Point one. </h6><br>  For example, the bandwidth of the incoming channel is 1000 kb / s. <br>  If, for example, Main_HomePC receives data from the Internet at a speed of 100 kb / s, then Second_HomePC should be able to receive data at a speed of up to 900 kb / s. <br>  When increasing the data transfer rate by the remote server for Main_HomePC to, say, 800 kb / s, the channel should be divided equally among consumers (i.e., 500 kb /). <br>  To solve this problem is the type of queue PCQ (but more on that below). <br><br><h6>  Point two. </h6><br>  If there are such consumers on the network who need access to the Internet, but you do not want them to ‚Äúbite off‚Äù a large piece of the channel, they should limit the speed, or make the channel between them and other consumers not evenly split. <br>  To solve this problem is the type of queue organization Queue Tree (the theory is already close). <br><br>  In this case, you can, for example, assign a higher priority to connections to certain servers.  For example, I so achieved excellent work of RDP connections, regardless of the channel load.  1C calipers were very pleased. <br><br><h6>  Point three. </h6><br>  Nevertheless, surfing is the most noticeable activity of a person using the Internet.  If the user is forced to wait a long time for the pages to open, then no queues and channel splitting will help him be satisfied.  Therefore, we will try to speed up the opening of pages, regardless of the user and the current channel load. <br><br>  So, we have come to the conclusion that you need to use Queue Tree queuing and the type of PCQ queue. <br>  Before solving the tasks, we turn to the theory. <br><br><h4>  Theory </h4><br>  I will try to get rid of copy-paste.  Therefore I will give references to the theory, and I will describe the most important briefly.  The full theory will be needed by those who want to understand what is happening in more detail.  If you want to set up a router using my example, you can refer to the very end of the article where you will find links to configuration files. <br><br>  First, familiarize yourself with how the <a href="http://wiki.mikrotik.com/wiki/Manual:Packet_Flow">traffic passes through the router</a> . <br>  It is enough to study the first diagram with your eyes and the principle will become clear. <br><br><h5>  HTB </h5><br>  About HTB can be <a href="http://wiki.mikrotik.com/wiki/HTB">read here</a> . <br><br>  In brief, HTB (Hierarchical Token Bucket) is a classic queuing method for processing various types of traffic. <br><br>  The method is based on three simple, but obligatory stages: <br><ol><li>  Isolation and marking of traffic of interest to us. </li><li>  Creating rules to apply to individual types of traffic of individual queues. </li><li>  Apply selected strategies (rules and advanced parameters) to interfaces. </li></ol><br>  Implemented by HTB only through Queue Tree. <br><br>  You can find out what makes this type of queue different from Simple Queue <a href="http://wiki.mikrotik.com/wiki/Manual:Queue">here</a> . <br><br>  Regarding the type of queues, PCQ was selected. <br>  The fact is that a queue for sending packets is applied to each interface of the router.  Packets are collected into a buffer, and then pulled out of it and sequentially sent to the physical network port.  The order in which packets are pulled out of the buffer is called a queue. <br>  Packets pulled out of the network interface buffer are classified by the router according to some features and placed in the so-called ‚Äúflows‚Äù of the packets.  Different types of queues classify packets in different ways and put them into streams using different principles. <br><br>  Initially, the PFIFO (packet first in first out) queue is used for all interfaces, the first to enter is the first to go out.  This queue does not allow at least some control over the order of sending packets.  All packets are placed by the router into one stream and therefore, with this type of queue, we cannot solve either task 1 or task 2 completely.  We can only limit the speed, but we can not balance the load.  Problem 3 is solved because  here we don't need balancing. <br><br>  We need to configure the router so that packets from different users fit into different streams.  Then it will not matter to us how many connections the user has made. <br><br>  The PCQ type of queue (Per Connection Queuing, queuing by connections) allows you to select streaming addresses and ports of the source and destination of packets by classifiers, which will allow you to apply rules to individual streams, and not to individual connections or packets.  This type of queue allows you to limit the speed of sampling packets from the buffer and put them in different streams (this is one of the options for allocating a fixed channel), and if Rate = 0 is established, all streams allocated by this queue will receive the same channel width (dynamic channel sharing; this is how Internet sharing between Wireless Users will work). <br><br>  More details can be <a href="http://wiki.mikrotik.com/wiki/Manual:Queue">found here</a> . <br><br><h5>  Mangle </h5><br>  The first stage is HTB. <br>  To apply the rules of the sequence of passing packets through the router, the packages must be labeled. <br>  When passing through the router, the package can be marked and then quickly found by marker. <br>  This is necessary in order to apply general rules to different packages, or different rules for similar packages. <br>  A lot of text here is unnecessary.  More details you can <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/Mangle">read here</a> . <br><br><h5>  Queue tree </h5><br>  The second stage of HTB is the creation of rules that allow different types of queues to be applied to different types of traffic. <br>  To write something here in your own words is quite difficult, but I refused to copy-paste.  Therefore, we either read the theory or watch the practice.  It may be easier to see the implementation first. <br>  <a href="http://wiki.mikrotik.com/wiki/Manual:Queue">Manual</a> . <br><br><h4>  Practice </h4><br><h5>  Network topology </h5><br>  My home network has the following topology: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d26/2f7/3f6/d262f73f6ad89238b00efcd36d3c8906.jpg" alt="image"><br><br>  The router connects to the PPPOE server of the provider with the PPPoE_Client interface, called by me ‚ÄúISP_Internet_Connection‚Äù and through this interface gets access to the Internet.  At the same time network settings (IP, Gate, DNS) are issued dynamically. <br>  Main_HomePC and Second_HomePC are desktop computers.  They have static addresses, by the example of which I will show how to balance the load on the channel between them. <br>  Note and Tablet are examples of devices using access via Wi-Fi (they will be dynamically included into the wireless_users group, addresses will be given to them from the wireless_users pool) and, as a rule, require receiving an address from the DHCP server since  can be used in different networks (therefore, often, they should not be hard-coded settings).  I only have a smartphone, but for the sake of completeness I hammered in the notebook  In general, the number of such devices will depend only on the allocated address pool. <br><br><h5>  Mangle </h5><br>  The first thing to do is to tag packages from all consumer devices. <br>  We will first label the connections, and only then the packages related to the connections.  In this case, the router does not recheck the contents of the packet headers belonging to the already marked connections.  This approach will prevent overloading of the processor processor. <br>  If you are sure that the router will cope with the labeling of each package - you can not label connections. <br>  The packet marker settings can be found in the Ip-&gt; Firewall-&gt; Mangle section. <br><br>  Marking will be carried out in the forward branch.  Here, the router already knows to whom the packet will be sent at the exit, as well as the firewall rules are applied, which means that no extra packets will be marked. <br>  We will do this on this principle: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cff/668/3ad/cff6683ade1de08e091097c6ce60f0ef.jpg" alt="image"><br><br>  Thus, we will separate the packages separately to each of the home computers and separately for the group of wireless devices. <br>  Such an algorithm must be applied to packets passing from the LAN to the WAN and from the WAN to the LAN. <br>  1. Mark connections established from the external network (I mark connections from two interfaces with one marker, but in the classic case only one interface is used to access the Internet and therefore the connection labeling rules for and for WAN can be omitted). <br>  To do this, we mark all connections connected to the WAN and leaving the LAN.  In order to separate packages for wireless devices and home computers, I applied the labeling rules only for selected groups of addresses. <br>  2. Mark packets inside the labeled compounds.  Separately, I mark the packages with the destination address 172.16.30.31, separately 172.16.30.32 and mark the packages for the pool 172.16.30.10-172.16.30.20 with a separate marker. <br><br>  Similar rules are created for outgoing packets. <br>  The result is as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/c82/2e3/fd9/c822e3fd93e5a1c0fd91680365dbcbd2.jpg" alt="image"><br>  Rules 0 and 1 are marked with the letter D, which means dynamic.  These rules are created automatically when a PPPoE connection is established.  So maybe not everywhere.  They do not relate to the topic of the article. <br>  Rule 4 is not fully reflected in the figure.  Additionally, you should specify the IP protocol and source port 80. The rule terminates the chain so that under the http_dl_boost marker there are only the first two million bytes of each new connection (I think this is enough to load most pages). <br>  According to this principle, it is possible to build and upload booster, as well as make smaller data packs go faster, for example, when playing heroes3 on a return trip, data transfer can be accelerated. <br><br><h5>  Queue </h5><br>  The second step is setting up the queues.  To begin with, we will create two new types of queues for incoming and outgoing traffic.  PCQ type. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3cc/58f/4e5/3cc58f4e5ea2059ed07531d478395336.jpg" alt="image"><br><br>  Packet flows, to which the PCQ_Download queue type will be applied, will be classified by destination address and each will be assigned the same priority.  Such a queue will ensure equality among consumers regardless of the number of flows to each of them. <br>  Similarly, the queue for outgoing packets will classify flows by source address. <br>  Based on this type of queues, it is also possible to balance packet flows for different applications of the same user (classifiers: address and port of destination).  Difficulty can only arise with torrents.  But with due diligence and this can be solved by applying a complex tree of queues. <br>  If you notice, the Limit parameter is different for incoming and outgoing packets.  To understand what this is for, go back to the theory about HTB. <br><br>  Now everything is ready to create your own queue tree. <br><br>  We are interested in two branches: <br>  - incoming packets (as I call the packets that come from the Internet and are intended for devices on the local network). <br>  - outgoing packets (packets originating from devices in the local network). <br><br>  This is what all the queue tree rules look like. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d4/aef/8f5/8d4aef8f5f2232313c347aca3e36d26e.jpg" alt="image"><br><br>  The parent of the Incoming_Packets branch is the LAN2 interface ‚Äî packets are sent from it to the local devices. <br>  Parent branch Outgoing_Packets - global-out  packets in my case can be sent with both WAN and ISP_Internet_Connection. <br>  Note that the priority HTTP_DL_BOOST is 2, as well as LimitAt = MaxLimit = 32M.  This gives a high priority and maximum bandwidth of ~ 2Mb of traffic received from port 80 over IP, which will ensure fast opening of pages even on slow links (tested for 2 Mb / s channel with three users). <br><br><h4>  Results. </h4><br>  In order to conduct a full-fledged experiment, I launch a download in 5 streams from nvidia.com on MainPC, and on SecondPC I launch a download with a torrent. <br>  Since it‚Äôs almost impossible to score all 32 megabits, I will artificially limit the band to 2 megabits. <br>  For the purity of the experiment, I turned off DL_BOOST. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce1/020/fa4/ce1020fa4796186f95f9b08bca2e65b2.jpg" alt="image"><br><br>  The numbers do not coincide a bit.  screenshots were not made in one moment. <br>  The disabled rule is not updated and therefore the numbers in it do not correspond to the moment. <br><br>  PS It should be added that in my case (local ISP resources are located behind the WAN interface and I get access to all 32 Mbit / s, while I have 8/8 Mbit / s access to the Internet) I need to approach it a little differently and threads for internal resources to allocate in separate branches.  Then it will be possible to divide the channel even more flexibly.  But I do not use internal resources, so I brought everything in a simpler form. <br><br><h4>  Meterialy affairs </h4><br>  As promised - I <a href="http://dl.dropbox.com/u/36476656/MikroTik/Config.txt">spread the config</a> . <br>  A couple of links: <br>  <a href="http://wiki.mikrotik.com/wiki/Manual">Manual</a> <br>  <a href="http://wiki.mikrotik.com/wiki/Manual">Configuration via web interface</a> <br>  <a href="http://wiki.mikrotik.com/wiki/Manual:Packet_Flow">Passing packets through the router</a> <br>  <a href="http://wiki.mikrotik.com/wiki/HTB">HTB</a> <br>  <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/Mangle">Mangle</a> <br>  <a href="http://wiki.mikrotik.com/wiki/Manual:Queue">Queue tree</a> <br><br>  <a href="">Download WinBox</a> <br><br><h4>  I advise you to look </h4><br><br>  Among other things, I decided at the same time to give some information about useful utilities. <br><br><h5>  <a href="http://www.mikrotik.com/thedude.php">The dude</a> </h5><br>  Very nice thing.  It helps to build a network topology, to track its integrity.  It is interesting to be able to connect to routers from it, check bandwidth of channels with the help of bandwith test, etc. <br><br><h5>  <a href="">Syslog daemon</a> </h5><br>  In connection with the location in the "archive" - ‚Äã‚Äãa little-known tool.  Allows remote logging of router events.  Supports many filters.  For debugging, the thing is excellent.  If I remember correctly, built into The Dude. <br><br><h4>  UPD: </h4><br>  Added information about web configurator and winbox work under linux / unix in the introduction. <br>  Added a couple of useful links. <br><br>  I will be happy to see criticism in the comments and try to make the article better. </div><p>Source: <a href="https://habr.com/ru/post/133244/">https://habr.com/ru/post/133244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133236/index.html">Normal offline documentation</a></li>
<li><a href="../133237/index.html">Little known Java features</a></li>
<li><a href="../133239/index.html">Caching images on the SD card</a></li>
<li><a href="../133240/index.html">Manual update of the time zone database in old Linux distributions</a></li>
<li><a href="../133242/index.html">And animals are good and money to earn</a></li>
<li><a href="../133247/index.html">Mandate OS OS MSVS 3.0</a></li>
<li><a href="../133248/index.html">In the questionnaires with fields like "mother's maiden name" or "favorite dish" you write</a></li>
<li><a href="../133249/index.html">Questions to Dmitry Sklyarov</a></li>
<li><a href="../133252/index.html">Domain Management Center 2ns.info - updated version</a></li>
<li><a href="../133253/index.html">Full video review of Android Ice Cream Sandwich on the Galaxy Nexus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>