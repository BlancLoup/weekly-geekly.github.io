<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP, static variables inside class methods and one bug history</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In general, I am a frontend developer. But sometimes you have to work with the server part. We have a small team, and when all  the real ones  backend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP, static variables inside class methods and one bug history</h1><div class="post__text post__text-html js-mediator-article"><p>  In general, I am a frontend developer.  But sometimes you have to work with the server part.  We have a small team, and when all <del>  the real ones </del>  backend programmers are busy, it is faster to implement some method myself.  And sometimes we sit down together to work on the tasks, so as not to waste time on commiting to and fro.  Recently, during one of these rounds of pair programming, a teammate and I ran into a bug that impressed me so much that I decided to share with you. <a name="habracut"></a></p><br><h2>  Bug </h2><br><p>  So, when after lunch I went to my colleague Roman <a href="https://habrahabr.ru/users/parpalak/" class="user_link">parpalak</a> , he had just finished tidying up the unit tests, and launched the whole pack.  One of the tests threw an exception and fell.  Yeah, we thought, now fix the bug.  We started the test alone, outside the package, and it was successful. </p><br><p>  Before throwing off the afternoon nap, we launched Codeception a few more times.  In the package, the test fell, alone passed, in the package fell ... </p><br><p>  We got into the code. </p><br><p> The <code>Call to private method</code> crashed from a method that converts an entity object into an array to send to the client.  Recently, the mechanism of this process has changed a little, but not all classes have been refactored, so the method should check whether the method that returns the list of required fields (this is the old method) is redefined in the child class.  If not, the list of fields is formed through reflection (this is a new method), and the corresponding getters are called.  In our case, one of the getters was declared as private, and, accordingly, is not available from the base class.  It all looks something like this: </p><br><div class="spoiler">  <b class="spoiler_title">Slightly simplified code to focus on the bottom line.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toClientModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $isClientPropsOriginal = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($isClientPropsOriginal === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { $reflector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ReflectionMethod(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'getClientProperties'</span></span>); $isClientPropsOriginal = $reflector-&gt;getDeclaringClass()-&gt;getName() === <span class="hljs-string"><span class="hljs-string">'AbstractEntity'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($isClientPropsOriginal) { <span class="hljs-comment"><span class="hljs-comment">// TODO       return $this-&gt;toClientModelNew($urlGenerator); } $result = []; foreach ($this-&gt;getClientProperties() as $clientKey =&gt; $property) { $value = call_user_func([$this, 'get' . ucfirst($property)]); $result[$clientKey] = $this-&gt;formatValueForClient($value); } return $result; } public function toClientModelNew() { $result = []; /*    ,    ,    */ return $result; } public function getClientProperties() { /*     */ } /*   */ } class Advertiser extends AbstractEntity { /*   */ private $name; private function getName() { return $this-&gt;getCalculatedName(); } public function toClientModel() { $result = parent::toClientModel(); $result['name'] = $this-&gt;getName(); $result['role_id'] = $this-&gt;getRoleId(); return $result; } public function getClientProperties() { return array_merge(parent::getClientProperties(), [ 'role_id' =&gt; 'RoleId' /*      */ /*  name  ,     toClientModel */ ]); } /*   */ }</span></span></code> </pre> </div></div><br><p>  As you can see, the result of the reflector is cached in the static <code>$isClientPropsOriginal</code> variable inside the method. </p><br><p>  - And what, reflection such a difficult operation?  - I asked. <br>  - Well, yes, - Roman nodded. </p><br><p>  The breakpoint on the reflection line did not work at all in this class.  Never.  The static variable was already set to <code>true</code> , the interpreter <code>toClientModelNew</code> into the <code>toClientModelNew</code> method and fell.  I offered to see where the assignment occurs: </p><br><pre> <code class="php hljs">$isClientPropsOriginal = $reflector-&gt;getDeclaringClass()-&gt;getName() === <span class="hljs-string"><span class="hljs-string">'AbstractEntity'</span></span> ? get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;</code> </pre> <br><p>  The variable <code>$isClientPropsOriginal</code> was <code>"PaymentList"</code> .  This is another class inherited from <code>AbstractEntity</code> , remarkable for exactly two things: it does not override the <code>getClientProperties</code> method and it was tested by a unit test, which has already successfully completed a little earlier. </p><br><p>  - How can this be?  - I asked.  - Is the static variable inside the method being fumbled when inheriting?  Why did we not notice this before? </p><br><p>  The novel was puzzled as much as mine.  While I went for coffee, he sketched a small unit test with an imitation of our class hierarchy, but it did not fall.  We missed something.  The static variable behaved incorrectly, not in the way we expected, but not in all cases, and we could not understand why.  Googling for the query "php static variable inside class method" did not give anything worthwhile, except that static variables are not good.  Well, duh! </p><br><p>  Now Roman went for coffee, and I thoughtfully opened the <a href="http://sandbox.onlinephpfunctions.com/">PHP sandbox</a> and wrote the simplest code: </p><br><p>  <strong>simple example 1</strong> </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $count = <span class="hljs-number"><span class="hljs-number">0</span></span>; printf(<span class="hljs-string"><span class="hljs-string">"%s: %d\n"</span></span>, get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), ++$count); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ } $a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); $b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B(); $a-&gt;printCount(); <span class="hljs-comment"><span class="hljs-comment">// A: 1 $a-&gt;printCount(); // A: 2 $b-&gt;printCount(); // B: 1 $b-&gt;printCount(); // B: 2 $b-&gt;printCount(); // B: 3</span></span></code> </pre> <br><p>  Somehow this should work.  The principle of least surprise, all things.  But we have because the static variable is defined inside the <code>toClientModel</code> method, and it is overridden in the child class.  And what if we write this: </p><br><p>  <strong>simple example 2</strong> </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $count = <span class="hljs-number"><span class="hljs-number">0</span></span>; printf(<span class="hljs-string"><span class="hljs-string">"%s: %d\n"</span></span>, get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), ++$count); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::printCount(); } } $a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); $b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B(); $a-&gt;printCount(); <span class="hljs-comment"><span class="hljs-comment">// A: 1 $a-&gt;printCount(); // A: 2 $b-&gt;printCount(); // B: 3 $b-&gt;printCount(); // B: 4 $b-&gt;printCount(); // B: 5</span></span></code> </pre> <br><p>  "How strange," I thought.  But there is some kind of logic here.  In the second case, the method containing the static variable is called via <code>parent::</code> , it turns out, is its instance used from the parent class?  And how to get out of this situation?  I scratched my head and slightly added my example: </p><br><p>  <strong>simple example 3</strong> </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doPrintCount(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPrintCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $count = <span class="hljs-number"><span class="hljs-number">0</span></span>; printf(<span class="hljs-string"><span class="hljs-string">"%s: %d\n"</span></span>, get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), ++$count); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::printCount(); } } $a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); $b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B(); $a-&gt;printCount(); <span class="hljs-comment"><span class="hljs-comment">// A: 1 $a-&gt;printCount(); // A: 2 $b-&gt;printCount(); // B: 1 $b-&gt;printCount(); // B: 2 $b-&gt;printCount(); // B: 3</span></span></code> </pre> <br><p>  Here it is!  The novel had just returned, and I, pleased with myself, demonstrated my achievements.  It took him only a few clicks on the keyboard in PHPStorm to refactor the section with a static variable into a separate method: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasOriginalClientProps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $isClientPropsOriginal = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($isClientPropsOriginal === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { $reflector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ReflectionMethod(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'getClientProperties'</span></span>); $isClientPropsOriginal = $reflector-&gt;getDeclaringClass()-&gt;getName() === <span class="hljs-string"><span class="hljs-string">'AbstractEntity'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $isClientPropsOriginal; }</code> </pre> <br><p>  But it was not there!  Our error persisted.  Looking closely, I noticed that the <code>hasOriginalClientProps</code> method <code>hasOriginalClientProps</code> declared <code>private</code> , in my example it was <code>public</code> .  A quick check showed that both <code>protected</code> and <code>public</code> , and <code>private</code> does not work. </p><br><p>  <strong>simple example 4</strong> </p><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-class"><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">A</span></span></span></span><span class="php"><span class="hljs-class"> </span></span></span><span class="php">{ </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;doPrintCount(); } </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">doPrintCount</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">static</span></span></span><span class="php"> $count = </span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php">; printf(</span><span class="hljs-string"><span class="php"><span class="hljs-string">"%s: %d\n"</span></span></span><span class="php">, get_class(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">), ++$count); } } </span><span class="hljs-class"><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">B</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">A</span></span></span></span><span class="php"><span class="hljs-class"> </span></span></span><span class="php">{ </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">printCount</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">parent</span></span></span><span class="php">::printCount(); } } $a = </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">new</span></span></span><span class="php"> A(); $b = </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">new</span></span></span><span class="php"> B(); $a-&gt;printCount(); </span><span class="hljs-comment"><span class="php"><span class="hljs-comment">// A: 1 $a-&gt;printCount(); // A: 2 $b-&gt;printCount(); // B: 3 $b-&gt;printCount(); // B: 4 $b-&gt;printCount(); // B: 5</span></span></span></span></code> </pre> <br><p>  As a result, we declared the <code>hasOriginalClientProps</code> method as <code>protected</code> and supplied with a lengthy comment. </p><br><h2>  Analysis </h2><br><p>  Time did not wait, and we moved on to further tasks, but still this behavior was puzzling.  I decided to figure out why PHP behaves that way.  The documentation failed to dig up anything but obscure hints.  Below I will try to restore the picture of what is happening, based on a thoughtful reading of the <a href="http://www.phpinternalsbook.com/">PHP Internals Book</a> , the <a href="https://wiki.php.net/internals/engine/objects">PHP Wiki</a> , studying the <a href="http://lxr.php.net/">source code</a> and information on how objects are implemented in other programming languages. </p><br><p>  The function inside the PHP interpreter is described by the <code>op_array</code> structure, which, <a href="">among other things, contains a hash table</a> with static variables for this function.  <a href="">When inheriting</a> , if there are no static variables, the function is reused in the child class, and if there is, a duplicate is created so that the child class has its own static variables in the method. </p><br><p>  So far so good, but if we call the parent method via <code>parent::printCount()</code> , then, naturally, we get into the method of the parent class, which works with its static variables.  Therefore, example 2 does not work, and example 1 works.  And when we brought a static variable to a separate method, as in Example 3, late binding helps us: the <code>A::printCount</code> method will still call a copy of the <code>A::doPrintCount</code> from class <code>B</code> (which, of course, is identical to the original <code>A::doPrintCount</code> ). </p><br><p>  To me personally, such copying seemed rather ponderous.  Apparently, PHP developers thought the same and refused to copy for private methods.  After all, they are still not visible from the child and parent classes!  Vaughn, we even caught a futur at the very beginning of the story because of this.  Therefore, a private method exists in a single copy throughout the entire class hierarchy, and static variables in it also exist in a single context.  Therefore, did not earn an example 4. </p><br><p>  This behavior is repeated on all versions of PHP that I tried in the <a href="http://sandbox.onlinephpfunctions.com/">sandbox</a> , starting with shaggy 5.0.4. </p><br><p>  Why the bug in the code of our project did not make it known before?  Apparently, entities were rarely created with groups of different types, and if they were created, then they refactored them simultaneously.  But when running the tests, two objects running through different mechanisms got into one script launch, and one of them spoiled the state for another. </p><br><h2>  findings </h2><br><p>  (after all, every serious article should have conclusions) </p><br><ol><li>  Static variables are evil. <br>  Well, that is, like any other evil in programming, they require a careful and thoughtful approach.  Of course, you can criticize us for using the hidden state, but with careful use this allows you to write quite effective code.  However, the static can hide the pitfalls, one of which I showed you.  therefore </li><li>  Write unit tests. <br>  No one can guarantee that the hidden jamb in your code will not come to light after the next refactoring.  So write the code under test and cover it with tests.  If a bug similar to the one described by me arose in the combat code, and not in tests, it could easily have gone all day, and not one and a half to two hours. </li><li>  Do not be afraid to get into the wilds. <br>  Even such a simple thing as static variables can be a reason to dive deep into the system documentation and PHP sources.  And even something to understand them. </li></ol><br><p>  On this inspirational note, I say goodbye to you.  I hope that this article will help someone to avoid the rake, which we stepped on.  Thanks for attention! </p><br><p>  PS: I thank Roman <a href="https://habrahabr.ru/users/parpalak/" class="user_link">parpalak</a> for valuable advice in preparing the material. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/301478/">https://habr.com/ru/post/301478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301468/index.html">GUI to the tacacs daemon - TacacsGUI</a></li>
<li><a href="../301470/index.html">Push notifications on Android in InterSystems Ensemble on the example of traffic police fines</a></li>
<li><a href="../301472/index.html">Storage Federation or all enterprise storage federation</a></li>
<li><a href="../301474/index.html">Seminar "Oracle in the cloud" and a tour of one of the largest data centers in Russia NORD 4, May 26, Moscow</a></li>
<li><a href="../301476/index.html">Application of statistical criteria for solving detection problems in radio engineering</a></li>
<li><a href="../301482/index.html">JQuery 3.0 Release Candidate Release</a></li>
<li><a href="../301484/index.html">Import a DXF drawing in a Java program, stepping on all the rakes of this ‚Äúsimple‚Äù format</a></li>
<li><a href="../301488/index.html">SimSim, open</a></li>
<li><a href="../301490/index.html">Content Marketing in Infographics</a></li>
<li><a href="../301492/index.html">Intel Edison + webcam = barcode scanner</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>