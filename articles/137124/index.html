<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We link Active Directory, Asterisk and OpenFire</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We're friends of Active Directory, Asterisk IP telephony server and OpenFire Jabber server. 

 I will not touch on the installation of everything sepa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We link Active Directory, Asterisk and OpenFire</h1><div class="post__text post__text-html js-mediator-article"><h4>  We're friends of Active Directory, Asterisk IP telephony server and OpenFire Jabber server. </h4><br><br>  I will not touch on the installation of everything separately - everything is well described and works individually very well.  I will write how I combined it all together, what I came across and what I did. <br><br><a name="habracut"></a><h5>  Disposition: </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is a domain controller <b>dc.steepler.local</b> ( <b>10.10.8.200</b> ).  Domain, respectively - steepler.local.  Users are on the server, beaten into departments, etc.  What is important is that each user has his number on the Asterisk server in the ‚Äúphone‚Äù column. <br><br>  There is an installed <b>Asterisk</b> VoIP server ( <b>10.10.8.98</b> ).  All users are connected via SIP, respectively, the device, in the understanding of Asterisk, they have the type SIP / XXX (where XXX is an extension number).  At the time of writing, the server was installed long ago and has already been subjected to serious settings.  That is why the work was not brought to a logical end - the logical end would be the automatic generation of the SIP configuration of the end devices and the dial plan.  Unfortunately, I was afraid that we would have to seriously rewrite the existing configuration, and in any case, the automatic generation of the recruitment plan that exists in our organization now and has many interactive menus and other customizations will not be interesting to the reader who has the task, first of all, to connect the server.  Where to go next - it will be clear.  Written scripts are not complicated and have a good foundation for further work. <br><br>  So, there is Asterisk with the FreePBX frontend installed, which greatly complicated the task.  For FreePBX is in use and the need to rewrite all configuration files on top after making any changes to the web interface.  That is, we can change configs from the command line, but as soon as we change something later through the web-face, the configs will be overwritten by FreePBX, as a decent front end.  Of course, the creators of the shell did not rely on their genius and left the opportunity for fine-tuning.  This feature is realized through the loading of additional contexts with the suffix ‚Äú-custom‚Äù (which, in the end, turned out to be enough), or with the help of ‚Äúoverride‚Äù configs, which rigidly fix the changes you need.  But, you have to understand that what is written in the custom or override config will work according to you, regardless of the FreePBX web interface.  Or checkered or go.  That is, no matter what you twist in the frontend there, whatever they set up - if it touches the customized settings - the settings from the files, not the frontend, will work.  That is why a lot of time was spent tracing the set plan generated by FreePBX - I wanted to find an entry point in such a procedure, which would have not been tied to further work. <br><br>  There are, or rather, at the time of this writing - there was no Jabber server.  The choice, for inexplicable reasons, fell on OpenFire.  In fact, the reasons are simple - OpenFire allows you to organize end-to-end (Kerberos / GSSAPI / SASL) user authentication.  I mean - the user does not need to enter a login or password.  If he passed the domain authorization at the entrance to the windows - he is our client.  When the client starts, it will itself substitute the user, send a request to the jabber server, and the latter, using Kerberos, will confirm or deny the authenticity of the client's request.  I will not go into details, it is important for us that the authorization is transparent for the client, even if there is a policy of periodically changing the password in the domain.  It is not necessary to generate stories about "stupid users" who write complaints to the authorities that something stopped working because they forgot to change the password.  You just need to do so that they have nowhere to blunt. <br>  On OpenFire, you can install a regular Asterisk-IM plugin to communicate with Asterisk.  It allows you to dynamically track the status of users, make calls to IP phones, send notifications.  Unfortunately, out of the box, automation leaves much to be desired - despite the fact that pass-through authentication and authorization of users through AD is possible and that information about the user's work phone was originally provided in AD, we have to manually match AD / Asterisk users. <br>  So.  Jabber server to be OpenFire, called <b>jbrgseveren01.steepler.local</b> and work at <b>10.10.8.226</b> . <br>  Then I proceed from the fact that I have Linux in the form of CentOS5, Asterisk 1.8.2, and the Win2008 domain controller.  Although it doesn‚Äôt matter at all, it will work in other ways.  Only Asterisk version is critical - jabber support appeared only from the 1.6 branch, and a compiled PBX should be with its support. <br><br><h5>  Tasks: </h5><br><br>  You need to install a Jabber server, configure it so that it takes the necessary users from the domain group IM.  It is necessary in one way or another to automate the comparison of information about domain users, jabber users, Asterisk subscribers. <br>  How does everything work out of the box?  (Or pitfalls) <br>  OpenFire contacts the domain controller using the ldap protocol and receives information from it about the users who are allowed to use jabber. <br>  Next, we need to install the Asterisk-IM plugin (two mouse clicks on the OpenFire web face).  In the plugin we need to register the server Asterisk.  And, oh-shit, with hands, re-register all users in the plan - login - phone number - its subscriber device in the understanding of Asterisk.  After that, the functionality of the plugin will work - with the help of a native OpenFire client called Spark, users can call each other using existing phones simply by clicking on the list of contacts.  That is, I find a contact, right-click ‚Äúcall‚Äù, my phone starts ringing on my desk, I pick up the phone, and immediately the phone starts ringing at the contact.  Moreover, when someone speaks by phone, his status in the contact list changes to the corresponding one.  Conveniently.  But, the job of prescribing users should be automated. <br>  We go further - there is a desire to send notifications of missed calls to jabber.  It‚Äôs one thing when the lamp blinks on the phone and you have to go on the menu, watch who called and it‚Äôs quite another when you are waiting for a message with the exact time and coordinates of the callers.  Out of the box is not implemented in any way.  That is, Asterisk, of course, easily clings to the OpenFire server in the client or component mode, but the whole further task of processing and sending messages falls on your shoulders.  Of course, it‚Äôs not the work of sending itself, but the explanatory work with Asterisk ;-) The most stupid decision here is the processing of each number separately.  But, if the numbers are more than five, then it does not suit us.  Plus, there is a possibility of users migrating between phones, adding new ones, deleting old ones.  In addition, do not forget about FreePBX.  If we strictly define the rules of recruitment, then we will not be able to use the wonderful web interface.  In general, refuse rudely.  Not okay.  We need to find the entry point in the dial plan, write our own procedure, which will search for the corresponding domain user by the addressee‚Äôs number and, in the event of a ‚Äúnedozvon‚Äù, send a message to that jabber - they say, you called such and such a number to such and such . <br><br><h5>  Getting started </h5><br><br>  The first thing we need is users.  We create two users in the domain.  We will need one for ldap authentication, another for Kerberos.  I called the first openfire, the second xmpp-openfire.  Next, we immediately create a group for jabber users (I have it called IM) and add the necessary users to it.  We check that all users who have an internal phone and are included in the IM group in the "telephone number" field should have an internal subscriber number. <br>  The second is to write our future jabber server in DNS.  We need both forward and reverse zone.  On the jabber server itself, we configure the host name - we set it in <b>/ etc / hosts</b> : <br><br><pre><code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.localdomain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.226</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jbrgseveren01</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.steepler</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jbrgseveren01</span></span></code> </pre> <br><br>  We check nslookup from all sides - everything should be resolved correctly.  Yes, the host name is in small case.  It is important. <br>  Third, we install OpenFire according to the instructions - <a href="http://www.igniterealtime.org/builds/openfire/docs/latest/documentation/ldap-guide.html">http://www.igniterealtime.org/builds/openfire/docs/latest/documentation/ldap-guide.html</a> <br>  Everything is simple, there are no pitfalls.  Maximum complexity - the formation of literate filters in the ldap request.  Connect through the first user.  At the exit, get a functioning server with pass-through authorization through AD.  You can connect customers and work.  But, our task is SSO: Single Sign On.  We need the user to not have to think about their username and password for the client. <br>  We are starting to configure Kerberos.  Here we use the second user created by us.  Everything is described here - <a href="http://community.igniterealtime.org/docs/DOC-1060">http://community.igniterealtime.org/docs/DOC-1060</a> <br>  Everything is a little more complicated, there are pitfalls.  The main thing is to remember PRO PROGRAMS - everything matters.  Write as in the manual - where the upper case, where the upper, where lower case, there lower case.  Do not forget to enter the server in the domain and check the fact of the introduction.  It is important!!! <br>  Yes, I created the keytab on a domain controller - everything worked for me.  I did not use java tools. <br>  Put Spark - a native OpenFire client, check if SSO works - well.  If not, you need to understand - look, write, see. <br>  We go to the Asterisk server (do not forget - I have FreePbx, so I give the names of the files relative to its scheme; in the case of a bare Asterisk, everything will be a little easier) and write to the <b>manager_custom.conf</b> user OpenFire: <br><pre> <code class="hljs pgsql">[openfire] secret = XXXX deny=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> permit=<span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.226</span></span>/<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">all</span></span></code> </pre><br>  Now we install the Asterisk-IM plugin.  It is in the OpenFire web interface, in a tab with available plugins.  We register our VoIP server on the Asterisk-IM tab that appears: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>: AsteriskGSeveren01 ServerAddress: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.98</span></span> Port: <span class="hljs-number"><span class="hljs-number">5038</span></span> Username: openfire <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>: XXXX</code> </pre><br>  It was the turn to prescribe users with hands ... We must go to the Phone Mappings tab and write, write, write.  We confine ourselves to a couple of users, check the work.  In the contact list Spark, when you right-click on the user name, the call option should appear.  We choose - our device should ring, when the tube is lifted - the subscriber's device. <br>  If everything works, well.  If not, you need to understand - look, write, see. <br>  Now begins what was spent most of the time. <br>  It is necessary to explain Asterisk-IM that there are domain users and that all the necessary information is in Active Directory. <br>  Directly - no way.  The plugin is old, its support has been discontinued - devour it, that is.  And we have a MySQL database in which the plugin stores its information.  The easiest way would be to remove information from the database on OpenFire users and slip Asterisk-IM into it.  But, since we have pass-through authentication, OpenFire does not store anything in its database - it drags directly from the domain controller. <br>  Good.  We write a script that will cling to AD via the ldap protocol (we already have a user), drag information on domain users that belong to the IM group, and remove fields containing the full name, login, and phone number.  Then we form a SQL injection and push it into Asterisk-IM directly.  Dumb crutch, but it works. <br>  There were two scripts - one I found ready <a href="http://habrahabr.ru/blogs/voip/125359/">here</a> .  It is written in perl - it pulls info out of the domain and, by the way, is able to output ready sip.conf after a minimal edit.  The second, on the bash, calls the first, prepares its output (yes, I know that I am a pervert, but once the problem has been solved by someone, there is no need to fence), it forms SQL injections and shoves everything into the database. <br>  The worn changed <b>users-from-AD.pl</b> <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # users.pl v1.1 # # Script to generate asterisk 'users.conf' file from Active Directory (LADP) on users which contains 'phone' attribute # # Using: # 1. Print users to STDOUT: # users.pl # # 2. Print users to file: # users.pl users_custom.conf use strict; use warnings; use Net::LDAP; use Lingua::Translit; ###################### ### BEGIN SETTINGS ### ###################### my $debug = 0; my $warning = 0; # name of Domain my $AD="steepler.local"; # Domain name in format AD # for example mydomain.ru my $ADDC="DC=steepler,DC=local"; # user in Active directory # example: "CN=asterisk,CN=Users,$ADDC" my $ADUserBind="cn=openfire, cn=users, dc=steepler, dc=local"; my $ADpass="XXXXXXX"; # base search tree # example "OU=Users,$ADDC" my $ADUsersSearchBase="$ADDC"; # Field in active directory where telephone number, display name, phone stored # "telephonenumber", "displayname", "mail" my $ADfieldTelephone="telephonenumber"; my $ADfieldFullName="displayname"; my $ADfieldMail="mail"; my $ADfieldUser="samaccountname"; my $ADfieldGroup="memberOf"; my $ADSearchGroup="CN=IM,CN=Users,DC=steepler,DC=local"; # You need to create a dialplan in your asterisk server; my $dialplan="office"; # default settings my $user_static = "context = $dialplan call-limit = 100 type = friend registersip = no host = dynamic callgroup = 1 threewaycalling = no hasdirectory = no callwaiting = no hasmanager = no hasagent = no hassip = yes hasiax = yes nat=yes qualify=yes dtmfmode = rfc2833 insecure = no pickupgroup = 1 autoprov = no label = macaddress = linenumber = 1 LINEKEYS = 1 callcounter = yes disallow = all allow = ulaw,alaw,iLBC,h263,h263p "; ####################### ### END OF SETTINGS ### ####################### my $ldap; # get array DNS names of AD controllers my $dig = "dig -t srv _ldap._tcp.$AD" . '| grep -v "^;\|^$" | grep SRV | awk "{print \$8}"'; my @adControllers = `$dig`; # try connect to AD controllers foreach my $controller (@adControllers){ $controller =~ s/\n//; #INITIALIZING $ldap = Net::LDAP-&gt;new ( $controller ) or next; print STDERR "Connected to AD controller: $controller\n" if $debug &gt; 0; last; } die "$@" unless $ldap; my $mesg = $ldap-&gt;bind ( dn=&gt;$ADUserBind, password =&gt;$ADpass); #PROCESSING - Displaying SEARCH Results # Accessing the data as if in a structure # ie Using the "as_struct" method my $ldapUsers = LDAPsearch ( $ADUsersSearchBase, "$ADfieldGroup=$ADSearchGroup", [ $ADfieldFullName, $ADfieldTelephone, $ADfieldMail, $ADfieldUser ] )-&gt;as_struct; # translit RUS module. # GOST 7.79 RUS, reversible, GOST 7.79:2000 (table B), Cyrillic to Latin, Russian my $tr = new Lingua::Translit("GOST 7.79 RUS"); my %hashPhones = (); my $phones = \%hashPhones; my @out; while ( my ($distinguishedName, $attrs) = each(%$ldapUsers) ) { # if not exist phone or name - skipping my $attrPhone = $attrs-&gt;{ "$ADfieldTelephone" } || next; my $attrUser = $attrs-&gt;{ "$ADfieldUser" } || next; my $attrName = $attrs-&gt;{ "$ADfieldFullName" } || next; my $encName = $tr-&gt;translit("@$attrName"); my $attrMail = $attrs-&gt;{ "$ADfieldMail" } || [""]; # check for duplicates phone number if ( $phones -&gt; {"@$attrPhone"} ){ my $currUser = "@$attrName"; my $existUser = $phones -&gt; {"@$attrPhone"}; print STDERR "@$attrPhone alredy exist! Exist:'$existUser' Current:'$currUser'... skipping - '[@$attrPhone] $currUser'\n" if $warning; next; } else { $phones -&gt; {"@$attrPhone"} = "@$attrName"; } # password for SID = (telephonenumber without first digit) + 1 # example: phone=6232 pass=233 #$phsecret =sprintf("%03d",( substr("@$attrVal",1,100)+1)); my $phsecret = "@$attrPhone"; my $lcuser = "@$attrUser"; $lcuser = lc($lcuser); push (@out, "@$attrPhone " . "$lcuser " . "$encName\n" ); } # End of that DN # print to file if (@ARGV){ open FILE, "&gt; $ARGV[0]" or die "Error create file '$ARGV[0]': $!"; print STDOUT "Printing to file '$ARGV[0]'"; print FILE @out; close FILE; print STDOUT " ...done!\n"; } # print to STDOUT else{ print @out; } exit 0; #OPERATION - Generating a SEARCH #$base, $searchString, $attrsArray sub LDAPsearch { my ($base, $searchString, $attrs) = @_; my $ret = $ldap-&gt;search ( base =&gt; $base, scope =&gt; "sub", filter =&gt; $searchString, attrs =&gt; $attrs ); LDAPerror("LDAPsearch", $ret) &amp;&amp; die if( $ret-&gt;code ); return $ret; } sub LDAPerror { my ($from, $mesg) = @_; my $err = "[$from] - error" ."\nCode: " . $mesg-&gt;code ."\nError: " . $mesg-&gt;error . " (" . $mesg-&gt;error_name . ")" ."\nDescripton: " . $mesg-&gt;error_desc . ". " . $mesg-&gt;error_text; print STDERR $err if $warning; }</span></span></code> </pre><br>  But the second on the bash: <br>  <b>phone-bindings-update-from-AD.sh</b> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash TIMESTAMP=`/bin/date +%d%m%y%k%M%S` BACKUPDIR=/opt/openfire/bin/phone-mappings/backup BINDIR=/opt/openfire/bin WORKDIR=$BINDIR/phone-mappings SCRIPTNAMEDEVICE=$WORKDIR/phone-bindings-from-AD-device.sql SCRIPTNAMEUSER=$WORKDIR/phone-bindings-from-AD-user.sql SCRIPT=$WORKDIR/$SCRIPTNAME PERLSCRIPT=$BINDIR/users-from-AD.pl DEVICETPLHEAD=$WORKDIR/phoneDevice.tplhead DEVICEINJ=$WORKDIR/phoneDevice.inj DEVICETPLFOOT=$WORKDIR/phoneDevice.tplfoot USERTPLHEAD=$WORKDIR/phoneUser.tplhead USERINJ=$WORKDIR/phoneUser.inj USERTPLFOOT=$WORKDIR/phoneUser.tplfoot #backuping tables mysqldump -uXXXXXXX -pXXXXXXX openfire phoneDevice &gt; $BACKUPDIR/phoneDevice-$TIMESTAMP.sql mysqldump -uXXXXXXX -XXXXXXX openfire phoneUser &gt; $BACKUPDIR/phoneUser-$TIMESTAMP.sql # Clearing injections cat /dev/null &gt; $DEVICEINJ cat /dev/null &gt; $USERINJ # finding current Asterisk server ID in openfire DB serverID=`mysql -Bse "SELECT serverID FROM openfire.phoneServer;" -uXXXX -pXXXX` # resetting counters counter=0 counter2=0 #executing perl script to retrieve current phone numbers from AD for i in `$PERLSCRIPT`; do counter=`expr $counter + 1` binder[$counter]=$i done maxcount=$counter counter=1 while [ "$counter" -lt "$maxcount" ] do # deviding array into two with extensions and jids counter2=`expr $counter2 + 1` extension=${binder[$counter]} counter=`expr $counter + 1` username=${binder[$counter]} counter=`expr $counter + 1` callerID=${binder[$counter]} counter=`expr $counter + 1` callerID=$callerID\ ${binder[$counter]} counter=`expr $counter + 1` deviceID=$counter2 userID=$counter2 # Creating phoneDevice injection echo INSERT INTO \`phoneDevice\` VALUES\($deviceID,\'SIP/$extension\',\'$extension\',\'$callerID\',1,$userID,$serverID\)\; &gt;&gt; $DEVICEINJ # Creating phoneUser injection echo INSERT INTO \`phoneUser\` VALUES\($userID,\'$username\'\)\; &gt;&gt; $USERINJ done # Compile complete injections cat $DEVICETPLHEAD &gt; $SCRIPTNAMEDEVICE cat $DEVICEINJ &gt;&gt; $SCRIPTNAMEDEVICE cat $DEVICETPLFOOT &gt;&gt; $SCRIPTNAMEDEVICE # Compile complete injections cat $USERTPLHEAD &gt; $SCRIPTNAMEUSER cat $USERINJ &gt;&gt; $SCRIPTNAMEUSER cat $USERTPLFOOT &gt;&gt; $SCRIPTNAMEUSER # Injecting into tables cat $SCRIPTNAMEDEVICE | mysql -uXXXXXXX -pXXXXXXX cat $SCRIPTNAMEUSER | mysql -uXXXXXXX ‚ÄìpXXXXXXX</span></span></code> </pre><br>  As you can see, the second script uses templates for the header and footer injection.  Templates are obtained by running mysqldump on existing tables and then trimming the result.  Actually, here are the templates: <br><br>  <b>phoneUser.tplhead:</b> <br><br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET NAMES utf8 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40103 SET TIME_ZONE='+00:00' */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> openfire; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`phoneUser`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @saved_cs_client = @@character_set_client; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> character_set_client = utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> phoneUser ( userID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, username <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (userID) ); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> character_set_client = @saved_cs_client; <span class="hljs-keyword"><span class="hljs-keyword">LOCK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLES</span></span> <span class="hljs-string"><span class="hljs-string">`phoneUser`</span></span> WRITE; <span class="hljs-comment"><span class="hljs-comment">/*!40000 ALTER TABLE `phoneUser` DISABLE KEYS */</span></span>;</code> </pre><br><br>  <b>phoneUser.tplfoot:</b> <br><pre> <code class="hljs ruby">/*!<span class="hljs-number"><span class="hljs-number">40000</span></span> ALTER TABLE <span class="hljs-string"><span class="hljs-string">`phoneUser`</span></span> ENABLE KEYS *<span class="hljs-regexp"><span class="hljs-regexp">/; UNLOCK TABLES; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40103</span></span> SET TIME_ZONE=@OLD_TIME_ZONE *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET SQL_MODE=@OLD_SQL_MODE *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40014</span></span> SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40014</span></span> SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40111</span></span> SET SQL_NOTES=@OLD_SQL_NOTES *<span class="hljs-regexp"><span class="hljs-regexp">/;</span></span></code> </pre><br><br>  <b>phoneDevice.tplhead:</b> <br><br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET NAMES utf8 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40103 SET TIME_ZONE='+00:00' */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> openfire; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`phoneDevice`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @saved_cs_client = @@character_set_client; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> character_set_client = utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`phoneDevice`</span></span> ( <span class="hljs-string"><span class="hljs-string">`deviceID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`device`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`extension`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`callerId`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`isPrimary`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`userID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`serverID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`deviceID`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> character_set_client = @saved_cs_client; <span class="hljs-keyword"><span class="hljs-keyword">LOCK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLES</span></span> <span class="hljs-string"><span class="hljs-string">`phoneDevice`</span></span> WRITE; <span class="hljs-comment"><span class="hljs-comment">/*!40000 ALTER TABLE `phoneDevice` DISABLE KEYS */</span></span>;</code> </pre><br><br>  <b>phoneDevice.tplfoot:</b> <br><br><pre> <code class="hljs ruby">/*!<span class="hljs-number"><span class="hljs-number">40000</span></span> ALTER TABLE <span class="hljs-string"><span class="hljs-string">`phoneDevice`</span></span> ENABLE KEYS *<span class="hljs-regexp"><span class="hljs-regexp">/; UNLOCK TABLES; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40103</span></span> SET TIME_ZONE=@OLD_TIME_ZONE *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET SQL_MODE=@OLD_SQL_MODE *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40014</span></span> SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40014</span></span> SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40101</span></span> SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION *<span class="hljs-regexp"><span class="hljs-regexp">/; /</span></span>*!<span class="hljs-number"><span class="hljs-number">40111</span></span> SET SQL_NOTES=@OLD_SQL_NOTES *<span class="hljs-regexp"><span class="hljs-regexp">/;</span></span></code> </pre><br><br>  The script is pushed into crones, we execute and we find the appeared binding of users to phones in the Phone Bindings tab of the Asterisk-IM plug-in.  Half done. <br><br>  The next task is to send missed call messages.  If you have a TrixBox or FreePBX - do as I do - everything will probably work.  If naked Asterisk is all in your hands, improvise, much is available to you.  I even kind of envy))) <br><br>  First you need to perform authorization via ssh on the keys - we will use scp and remote execution of the procedure.  ssh-keygen will help you, there are enough manuals on the network, I will not repeat.  The script on the jabber server will crawl into the database, which we ruled by the previous script (yes, they can be combined into one, but I solved the problems not at the same time, but in general - unix way says that the tasks are correctly divided into components), take out the user's login , phone number.  Generate jID.  Next, we prepare an executable script that will enter information into the built-in Asterisk database, transfer it to the Asterisk server and launch it. <br><br>  Here's what happened: <br>  <b>phone-mapping-request.sh</b> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash WORKDIR=/opt/openfire/bin/phone-mappings SCRIPTNAME=phone-mappings-script.sh SCRIPT=$WORKDIR/$SCRIPTNAME SERVER=jbrgseveren01.steepler.local #asterisk USER@HOST:/PathToFile ASTERISK=root@10.10.8.98 #asterisk /PathToFile RPATH=/etc/asterisk/scripts counter=0 counter2=0 #clearing script file cat /dev/null &gt; $SCRIPT #perform MYSQL request for mappings for i in `mysql -Bse "SELECT extension,username FROM openfire.phoneDevice JOIN openfire.phoneUser ON openfire.phoneUser.UserID=openfire.phoneDevice.UserID;" -uXXXX -pXXXX`; do counter=`expr $counter + 1` mapper[$counter]=$i done maxcount=$counter counter=1 while [ "$counter" -lt "$maxcount" ] do # deviding array into two with extensions and jids counter2=`expr $counter2 + 1` extension[$counter2]=${mapper[$counter]} counter=`expr $counter + 1` jid[$counter2]=${mapper[$counter]} counter=`expr $counter + 1` # forming asterisk script outstringdel="asterisk -rvx \"database del AMPUSER "${extension[$counter2]}"/jid\"" outstringadd="asterisk -rvx \"database put AMPUSER "${extension[$counter2]}"/jid "${jid[$counter2]}"@"$SERVER"\"" echo $outstringdel &gt;&gt; $SCRIPT echo $outstringadd &gt;&gt; $SCRIPT done # moving scrip to asterisk host chmod 755 $SCRIPT scp $SCRIPT $ASTERISK:$RPATH # run script ssh $ASTERISK $RPATH/$SCRIPTNAME</span></span></code> </pre><br><br>  Things are easy - to explain Asterisk what to do about it.  There was spent a huge amount of time finding the entry point.  If it works like mine, fine.  If not, I give a tip.  An asterisk, in the case of including different instructions on the same condition (that is, one action on the condition is written in the dialplan, another in the inclusion of the loadable context, the other) takes the instruction that was received first.  Subsequent stupidly ignored.  I mean, if you have written some function, inserted it, and the result is zero, do dialplan show and see where this condition in this context branch meets all include before yours. <br>  In my case, it was enough to add to <b>extensions_custom.conf</b> : <br><br><pre> <code class="hljs ruby">[from-internal-noxfer-custom] ; Missed calls Jabber notification exten =&gt; h,<span class="hljs-number"><span class="hljs-number">1</span></span>,Macro(XMPPSend,) exten =&gt; h,n,Macro(hangupcall) [macro-XMPPSend] ; Missed calls Jabber notification exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,GotoIf($[<span class="hljs-string"><span class="hljs-string">"foo${DB(AMPUSER/${THISDIAL:4}/jid)}"</span></span> = <span class="hljs-string"><span class="hljs-string">"foo"</span></span>]<span class="hljs-string"><span class="hljs-string">?5</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>) exten =&gt; s,n,Set(JID=${DB(AMPUSER/${<span class="hljs-symbol"><span class="hljs-symbol">THISDIAL:</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>}/jid)}) exten =&gt; s,n,Jabbersend(asterisk-jabber,${JID},${STRFTIME(${EPOCH},,%d/%m/%Y-%<span class="hljs-symbol"><span class="hljs-symbol">H:</span></span>%<span class="hljs-symbol"><span class="hljs-symbol">M:</span></span>%S)} -     ${<span class="hljs-symbol"><span class="hljs-symbol">THISDIAL:</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>}  ${CALLERID(name)},  ${CALLERID(num)}) exten =&gt; s,n,MacroExit() exten =&gt; s,n,Noop(No Jabber ID provided <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> target extension - ${<span class="hljs-symbol"><span class="hljs-symbol">THISDIAL:</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>}) exten =&gt; s,n,MacroExit()</code> </pre><br><br>  And, register Asterisk as a component of OpenFire: <br>  On the Asterisk side: <br>  <b>Jabber.conf:</b> <br><pre> <code class="hljs pgsql">[general] <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ;;Turn <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> debugging <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>. ;autoprune=yes ;;Auto remove users <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> buddy list. ;autoregister=yes ;;Auto register users <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> buddy list. [asterisk-jabber] ;;label <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=component ;;Client <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> Component <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> serverhost=jbrgseveren01.steepler.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ;;Route <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> username=asterisk ;;Username <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> optional roster. secret=XXXX ;;<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> port=<span class="hljs-number"><span class="hljs-number">5275</span></span> ;;Port <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> use defaults <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">5222</span></span></code> </pre><br><br>  On the OpenFire side, go to Server -&gt; Server Settings -&gt; External Components Settings <br>  Enable Service Enabled.  Optionally add asterisk to whitelist. <br><br>  We check the work of the service ... <br><br>  I hope something helped.  If you have questions - write. </div><p>Source: <a href="https://habr.com/ru/post/137124/">https://habr.com/ru/post/137124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137117/index.html">Flex flex sdk</a></li>
<li><a href="../137119/index.html">Canobuvosti, 128th edition</a></li>
<li><a href="../137120/index.html">Gamer system unit with a fridge inside</a></li>
<li><a href="../137121/index.html">Spatial data storage in PostGIS / PostgeSQL</a></li>
<li><a href="../137122/index.html">Tair-3C + K-1 Converter. Nikon Infinity</a></li>
<li><a href="../137125/index.html">Segment-statistical approach to the Internet as a corpus - a new seminar in the ABBYY Open series</a></li>
<li><a href="../137126/index.html">IT education in Russia: reality or myth?</a></li>
<li><a href="../137127/index.html">History of one resource</a></li>
<li><a href="../137128/index.html">Medicine + IT: what can you do with the data</a></li>
<li><a href="../137129/index.html">Commentary of the day: Odyssey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>