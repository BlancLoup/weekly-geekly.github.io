<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chef for 21 days. Part Three Chef and AWS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habrauzer. So the third part of my article arrived, which will summarize the cycle ( part 1 and part 2 ) of articles for beginners. This part w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chef for 21 days. Part Three Chef and AWS</h1><div class="post__text post__text-html js-mediator-article">  Hello, habrauzer.  So the <b>third</b> part of my article arrived, which will summarize the cycle ( <a href="http://habrahabr.ru/company/epam_systems/blog/208542">part 1</a> and <a href="http://habrahabr.ru/company/epam_systems/blog/209368">part 2</a> ) of articles for beginners.  This part will focus on a specific example of how to use Chef in the <b>Amazon</b> cloud.  As I already mentioned, this is quite a popular scenario. <img src="https://habrastorage.org/getpro/habr/post_images/a25/506/278/a25506278cd046f70d0209b7e4a7b356.jpg" align="right">  For ease of understanding, we will consider the case of two <b>ec2-instance</b> (Amazon virtual servers), one of which will act as a Chef server, and the second as a node. <br><br><h2>  AWS and Chef </h2><br>  Immediately I will clarify that we will run the instance using <b>AWS CloudFormation</b> .  One could, of course, start and manage them manually, but what is the point of such automation? <br><a name="habracut"></a><br>  <b>CloudFormation</b> can be divided into 2 <i>concepts</i> : <br>  - <i>template</i> , which is a json-file, which describes all the resources we need to run the instance; <br>  - <i>stack</i> , which is the AWS resources themselves, described in the template. <br>  For those who are starting on AWS, Amazon provides a ready-made <i>sample template</i> that covers most aspects that are needed when working with AWS.  The link to the templates will be given at the end of the article. <br>  Consider what the <b>template is</b> .  In the base case, it consists of 4 blocks: <i>Parameters, Mappings, Resources, Outputs</i> . <br>  The <b>Parameters</b> block describes variables and their values ‚Äã‚Äãthat will be passed to the stack at the time it is created.  Parameter values ‚Äã‚Äãcan be entered when creating resources, or can be set using the default field in the parameter description.  Parameter can be any information, starting from a password and ending with a network port or path to a directory.  To get the parameter value, the Ref function is used in the template. <br>  The <b>Mappings</b> block contains a set of keys with the appropriate parameters and their values.  Most often, you can see how mapping is used to define AWS regions and their corresponding virtual images (instance).  To get the value of a mapping, use the Fn :: FindInMap function, which indicates the key and parameters by which a particular value is searched for. <br>  The <b>Resources</b> block describes our <i>ec2-instance</i> or other AWS resources.  It is in this section that the images for the Chef server and client node are declared.  In the description, you must specify the type of resource (for example, AWS :: EC2 :: Instance), it is also possible to specify metadata, in which you can specify the description of our node or pre-install procedure directives (for example, if you need to install any package when running the image ).  The main part of the block is the <b>Properties</b> block, which describes in detail the image being launched.  In this block, you can specify the type of image that will be launched (for example, Amazon Linux 32-bit), the identity of the image being launched to this or that <b>Security Group</b> (in fact, this is a <i>firewall</i> , with defined traffic rules, in which the default action is deny ).  However, the most important part of the Properties block is <b>User Data</b> .  This is where we describe the script that will turn our faceless instance into a Chef server or Chef client. <br>  <b>The template</b> I use is shown below under the cat, consider it and I will comment on it. <br><br><div class="spoiler">  <b class="spoiler_title">Template</b> <div class="spoiler_text"><pre><code class="hljs smalltalk">{ <span class="hljs-comment"><span class="hljs-comment">"AWSTemplateFormatVersion"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"2010-09-09"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"Template for stack"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Parameters"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"KeyName"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"Name of an existing EC2 KeyPair to enable SSH access to the instances"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Type"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"String"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"MinLength"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"MaxLength"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"255"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"AllowedPattern"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"[\\x20-\\x7E]*"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ConstraintDescription"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"can contain only ASCII characters."</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"HostKeys"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"Public Key"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Type"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"String"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"SecretAccessKey"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"Name of an existing EC2 KeyPair to enable SSH access to the instances"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Type"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"String"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"InstanceType"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"Chef Server EC2 instance type"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Type"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"String"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Default"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"m1.small"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"AllowedValues"</span></span> : [ <span class="hljs-comment"><span class="hljs-comment">"t1.micro"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"m1.small"</span></span>], <span class="hljs-comment"><span class="hljs-comment">"ConstraintDescription"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"must be a valid EC2 instance type."</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"SSHLocation"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Description"</span></span> : <span class="hljs-comment"><span class="hljs-comment">" The IP address range that can be used to SSH to the EC2 instances"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Type"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"String"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"MinLength"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"9"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"MaxLength"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"18"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Default"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"0.0.0.0/0"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"AllowedPattern"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ConstraintDescription"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"must be a valid IP CIDR range of the form xxxx/x."</span></span> } }, <span class="hljs-comment"><span class="hljs-comment">"Mappings"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"AWSInstanceType2Arch"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"t1.micro"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Arch"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"64"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"m1.small"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"Arch"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"64"</span></span> } }, <span class="hljs-comment"><span class="hljs-comment">"AWSRegionArch2AMI"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"us-east-1"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"32"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-d7a18dbe"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-bba18dd2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64HVM"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-0da96764"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"us-west-2"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"32"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-def297ee"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-ccf297fc"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64HVM"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"NOT_YET_SUPPORTED"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">"us-west-1"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"32"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-923909d7"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ami-a43909e1"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"64HVM"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"NOT_YET_SUPPORTED"</span></span> } } }, <span class="hljs-comment"><span class="hljs-comment">"Resources"</span></span> : { <span class="hljs-type"><span class="hljs-type">ChefClient</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">EC2</span></span>::<span class="hljs-type"><span class="hljs-type">Instance</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">Metadata</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Description</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">Chef</span></span> <span class="hljs-type"><span class="hljs-type">Client</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">Init</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>config<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>packages<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>yum<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>git<span class="hljs-comment"><span class="hljs-comment">" : [] } } } } }, "</span></span><span class="hljs-type"><span class="hljs-type">Properties</span></span><span class="hljs-comment"><span class="hljs-comment">": { "</span></span><span class="hljs-type"><span class="hljs-type">ImageId</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">FindInMap</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ "</span></span><span class="hljs-type"><span class="hljs-type">AWSRegionArch2AMI</span></span><span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">Region</span></span><span class="hljs-comment"><span class="hljs-comment">" }, { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">FindInMap</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ "</span></span><span class="hljs-type"><span class="hljs-type">AWSInstanceType2Arch</span></span><span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">Arch</span></span><span class="hljs-comment"><span class="hljs-comment">" ] } ] }, "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">SecurityGroups</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ {"</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">WebServerSecurityGroup</span></span><span class="hljs-comment"><span class="hljs-comment">"} ], "</span></span><span class="hljs-type"><span class="hljs-type">KeyName</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">KeyName</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">UserData</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">Base64</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">Join</span></span><span class="hljs-comment"><span class="hljs-comment">" : ["</span></span><span class="hljs-comment"><span class="hljs-comment">", [ "</span></span>#!/bin/bash -v\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum update -y aws-cfn-bootstrap\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>function error_exit\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>{\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span> cfn-signal -e <span class="hljs-number"><span class="hljs-number">1</span></span> -r \<span class="hljs-comment"><span class="hljs-comment">"$1\"</span></span> <span class="hljs-string"><span class="hljs-string">'", { "Ref" : "WaitHandle" }, "'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>}\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum update -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum install git -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/service iptables stop\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/service ip6tables stop\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/chkconfig iptables off\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/chkconfig iptables off\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum install git -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/curl -<span class="hljs-type"><span class="hljs-type">L</span></span> https://www.opscode.com/chef/install.sh | bash\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>cd /root/\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/git git://github.com/opscode/chef-repo.git\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir -p /root/chef-repo/.chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir -p /etc/chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /root/.aws\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/touch /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'[default]'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'region = ", {"Ref" : "AWS::Region" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'aws_access_key_id = ", { "Ref" : "HostKeys" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'aws_secret_access_key = ", { "Ref" : "SecretAccessKey" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/admin.pem /root/chef-repo/.chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/chef-validator.pem /root/chef-repo/.chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/knife.rb /root/chef-repo/.chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/client.rb /etc/chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/json_attribs.json /etc/chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/cp -p /root/chef-repo/.chef/chef-validator.pem /etc/chef/validation.pem\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/sbin/ntpdate -q <span class="hljs-number"><span class="hljs-number">0.</span></span>europe.pool.ntp.org\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'\nchef_server_url \"", { "Ref" : "ChefServerURL" }, "\"'</span></span> &gt;&gt; /etc/chef/client.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'\nchef_server_url \"", { "Ref" : "ChefServerURL" }, "\"'</span></span> &gt;&gt; /root/chef-repo/.chef/knife.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/chef-client\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/opt/aws/bin/cfn-signal -e <span class="hljs-number"><span class="hljs-number">0</span></span> -r \<span class="hljs-comment"><span class="hljs-comment">"ChefClient setup complete\"</span></span> <span class="hljs-string"><span class="hljs-string">'", { "Ref" : "WaitHandle" }, "'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">" ]]}} } }, "</span></span><span class="hljs-type"><span class="hljs-type">WaitHandle</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">WaitConditionHandle</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">WaitCondition</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">WaitCondition</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">DependsOn</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">ChefClient</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">Properties</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Handle</span></span><span class="hljs-comment"><span class="hljs-comment">" : {"</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">WaitHandle</span></span><span class="hljs-comment"><span class="hljs-comment">"}, "</span></span><span class="hljs-type"><span class="hljs-type">Timeout</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">1200</span></span><span class="hljs-comment"><span class="hljs-comment">" } }, "</span></span><span class="hljs-type"><span class="hljs-type">ChefServer</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">EC2</span></span>::<span class="hljs-type"><span class="hljs-type">Instance</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">Metadata</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Description</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">Bootstrap</span></span> <span class="hljs-type"><span class="hljs-type">ChefServer</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">Init</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>config<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>packages<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>yum<span class="hljs-comment"><span class="hljs-comment">" : { "</span></span>wget<span class="hljs-comment"><span class="hljs-comment">" : [] } } } } }, "</span></span><span class="hljs-type"><span class="hljs-type">Properties</span></span><span class="hljs-comment"><span class="hljs-comment">": { "</span></span><span class="hljs-type"><span class="hljs-type">ImageId</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">FindInMap</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ "</span></span><span class="hljs-type"><span class="hljs-type">AWSRegionArch2AMI</span></span><span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">Region</span></span><span class="hljs-comment"><span class="hljs-comment">" }, { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">FindInMap</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ "</span></span><span class="hljs-type"><span class="hljs-type">AWSInstanceType2Arch</span></span><span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">Arch</span></span><span class="hljs-comment"><span class="hljs-comment">" ] } ] }, "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">InstanceType</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">SecurityGroups</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ {"</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">WebServerSecurityGroup</span></span><span class="hljs-comment"><span class="hljs-comment">"} ], "</span></span><span class="hljs-type"><span class="hljs-type">KeyName</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">KeyName</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">UserData</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">Base64</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Fn</span></span>::<span class="hljs-type"><span class="hljs-type">Join</span></span><span class="hljs-comment"><span class="hljs-comment">" : ["</span></span><span class="hljs-comment"><span class="hljs-comment">", [ "</span></span>#!/bin/bash\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>cfn-init --region <span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">Region</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span> -s <span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">StackId</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span> -r <span class="hljs-type"><span class="hljs-type">ChefServer</span></span> <span class="hljs-comment"><span class="hljs-comment">", "</span></span> -c orderby <span class="hljs-comment"><span class="hljs-comment">", "</span></span> --access-key <span class="hljs-comment"><span class="hljs-comment">", { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">HostKeys</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span> --secret-key <span class="hljs-comment"><span class="hljs-comment">", {"</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">SecretAccessKey</span></span><span class="hljs-comment"><span class="hljs-comment">"}, "</span></span> || error_exit <span class="hljs-string"><span class="hljs-string">'Failed to run cfn-init'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum update -y aws-cfn-bootstrap\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>function error_exit\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>{\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span> cfn-signal -e <span class="hljs-number"><span class="hljs-number">1</span></span> -r \<span class="hljs-comment"><span class="hljs-comment">"$1\"</span></span> <span class="hljs-string"><span class="hljs-string">'", { "Ref" : "WaitHandle" }, "'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>}\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum update -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/service iptables stop\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/service ip6tables stop\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/chkconfig iptables off\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/sbin/chkconfig ip6tables off\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Install</span></span> <span class="hljs-type"><span class="hljs-type">ChefServer</span></span> package\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>cd /root/\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/wget https://opscode-omnibus-packages.s3.amazonaws.com/el/<span class="hljs-number"><span class="hljs-number">6</span></span>/x86_64/chef-server<span class="hljs-number"><span class="hljs-number">-11.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">-1.</span></span>el6.x86_64.rpm\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/rpm -ivh /root/chef-server<span class="hljs-number"><span class="hljs-number">-11.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">-1.</span></span>el6.x86_64.rpm\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/wget https://s3.amazonaws.com/storage/default.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/cp -f default.rb /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Configure</span></span> <span class="hljs-type"><span class="hljs-type">ChefServer</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>su - -c <span class="hljs-string"><span class="hljs-string">'/usr/bin/chef-server-ctl reconfigure'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>su - -c <span class="hljs-string"><span class="hljs-string">'/usr/bin/chef-server-ctl restart'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#AWS</span></span> creds installation\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /root/.aws\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/touch /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'[default]'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'region = ", {"Ref" : "AWS::Region" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'aws_access_key_id = ", { "Ref" : "HostKeys" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo <span class="hljs-string"><span class="hljs-string">'aws_secret_access_key = ", { "Ref" : "SecretAccessKey" }, "'</span></span> &gt;&gt; /root/.aws/config\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Upload</span></span> files for client\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp /etc/chef-server/admin.pem s3://storage/\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp /etc/chef-server/chef-validator.pem s3://storage/\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Chef</span></span> client and dirs for it\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/curl -<span class="hljs-type"><span class="hljs-type">L</span></span> https://www.opscode.com/chef/install.sh | /bin/bash\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /root/.chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /etc/chef\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /etc/chef/cookbooks\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mkdir /etc/chef/roles\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Knife</span></span> client config files from <span class="hljs-type"><span class="hljs-type">S3</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/cp /etc/chef-server/admin.pem /etc/chef/client.pem\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/knife_admin.rb /root/.chef/knife.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Roles</span></span> and cookbooks from <span class="hljs-type"><span class="hljs-type">S3</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/roles/ /etc/chef/roles/ --recursive\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/aws s3 cp s3://storage/cookbooks/ /etc/chef/cookbooks/ --recursive\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Cookbooks</span></span> from community\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/knife cookbook site download cron\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/knife cookbook site download jenkins\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/knife cookbook site download ntp\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/sbin/ntpdate -q <span class="hljs-number"><span class="hljs-number">0.</span></span>europe.pool.ntp.org\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum remove ruby -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>yum install ruby19 -y\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Unpack</span></span> and move cookbooks\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/mv /root/*.tar.gz /etc/chef/cookbooks\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>for i in `/bin/ls /etc/chef/cookbooks/*.tar.gz`; do /bin/tar zxf <span class="hljs-string"><span class="hljs-string">$i</span></span> -<span class="hljs-type"><span class="hljs-type">C</span></span> /etc/chef/cookbooks/; /bin/rm -f <span class="hljs-string"><span class="hljs-string">$i</span></span>; done\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>for i in `/bin/ls /etc/chef/cookbooks`; do /usr/bin/knife cookbook upload <span class="hljs-string"><span class="hljs-string">$i</span></span>; done\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-symbol"><span class="hljs-symbol">#Upload</span></span> cookbooks and roles\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/knife cookbook upload * -c <span class="hljs-string"><span class="hljs-string">'/root/.chef/knife.rb'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/usr/bin/knife role from file /etc/chef/roles/*.rb\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo -e \<span class="hljs-comment"><span class="hljs-comment">"*/5 * * * * root /usr/bin/knife exec -E 'nodes.find(\\\"</span></span>!roles:<span class="hljs-type"><span class="hljs-type">BaseRole</span></span>\\\<span class="hljs-comment"><span class="hljs-comment">") { |n| puts n.run_list.add(\\\"</span></span>role[<span class="hljs-type"><span class="hljs-type">BaseRole</span></span>]\\\<span class="hljs-comment"><span class="hljs-comment">"); n.save}' -c '/root/.chef/knife.rb'\"</span></span> &gt;&gt; /etc/crontab\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo -e \<span class="hljs-comment"><span class="hljs-comment">"*/5 * * * * root /usr/bin/knife exec -E 'nodes.find(\\\"</span></span>env_role:master <span class="hljs-type"><span class="hljs-type">AND</span></span> !roles:master\\\<span class="hljs-comment"><span class="hljs-comment">") { |n| puts n.run_list.add(\\\"</span></span>role[master]\\\<span class="hljs-comment"><span class="hljs-comment">"); n.save}' -c '/root/.chef/knife.rb'\"</span></span> &gt;&gt; /etc/crontab\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/bin/echo -e \<span class="hljs-comment"><span class="hljs-comment">"*/5 * * * * root /usr/bin/knife exec -E 'nodes.find(\\\"</span></span>env_role:slave <span class="hljs-type"><span class="hljs-type">AND</span></span> !roles:slave\\\<span class="hljs-comment"><span class="hljs-comment">") { |n| puts n.run_list.add(\\\"</span></span>role[slave]\\\<span class="hljs-comment"><span class="hljs-comment">"); n.save}' -c '/root/.chef/knife.rb'\"</span></span> &gt;&gt; /etc/crontab\n<span class="hljs-comment"><span class="hljs-comment">", "</span></span>/opt/aws/bin/cfn-signal -e <span class="hljs-number"><span class="hljs-number">0</span></span> -r \<span class="hljs-comment"><span class="hljs-comment">"ChefServer setup complete\"</span></span> <span class="hljs-string"><span class="hljs-string">'", { "Ref" : "WaitHandle" }, "'</span></span>\n<span class="hljs-comment"><span class="hljs-comment">" ]]}} } }, "</span></span><span class="hljs-type"><span class="hljs-type">WaitHandle</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">WaitConditionHandle</span></span><span class="hljs-comment"><span class="hljs-comment">" }, "</span></span><span class="hljs-type"><span class="hljs-type">WaitCondition</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">CloudFormation</span></span>::<span class="hljs-type"><span class="hljs-type">WaitCondition</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">DependsOn</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">ChefServer</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">Properties</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Handle</span></span><span class="hljs-comment"><span class="hljs-comment">" : {"</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">WaitHandle</span></span><span class="hljs-comment"><span class="hljs-comment">"}, "</span></span><span class="hljs-type"><span class="hljs-type">Timeout</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">1200</span></span><span class="hljs-comment"><span class="hljs-comment">" } }, "</span></span><span class="hljs-type"><span class="hljs-type">WebServerSecurityGroup</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Type</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">AWS</span></span>::<span class="hljs-type"><span class="hljs-type">EC2</span></span>::<span class="hljs-type"><span class="hljs-type">SecurityGroup</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">Properties</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">GroupDescription</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">Enable</span></span> <span class="hljs-type"><span class="hljs-type">HTTP</span></span> access via port <span class="hljs-number"><span class="hljs-number">80</span></span> and <span class="hljs-type"><span class="hljs-type">SSH</span></span> access<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">SecurityGroupIngress</span></span><span class="hljs-comment"><span class="hljs-comment">" : [ {"</span></span><span class="hljs-type"><span class="hljs-type">IpProtocol</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span>tcp<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">FromPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">80</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">ToPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">80</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">CidrIp</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-comment"><span class="hljs-comment">"}, {"</span></span><span class="hljs-type"><span class="hljs-type">IpProtocol</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span>tcp<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">FromPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">8080</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">ToPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">8080</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">CidrIp</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-comment"><span class="hljs-comment">"}, {"</span></span><span class="hljs-type"><span class="hljs-type">IpProtocol</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span>tcp<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">FromPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">443</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">ToPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">443</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">CidrIp</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-comment"><span class="hljs-comment">"}, {"</span></span><span class="hljs-type"><span class="hljs-type">IpProtocol</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span>tcp<span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">FromPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">ToPort</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-comment"><span class="hljs-comment">", "</span></span><span class="hljs-type"><span class="hljs-type">CidrIp</span></span><span class="hljs-comment"><span class="hljs-comment">" : { "</span></span><span class="hljs-type"><span class="hljs-type">Ref</span></span><span class="hljs-comment"><span class="hljs-comment">" : "</span></span><span class="hljs-type"><span class="hljs-type">SSHLocation</span></span><span class="hljs-comment"><span class="hljs-comment">"}} ] } }, }</span></span></code> </pre> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From the template you can see that we have <i>five</i> parameters declared.  Two of them have default values ‚Äã‚Äã- the type of the created <i>instance</i> (in this case, m1.small) and the subnet of IP addresses from which <b>SSH</b> access to the host will be allowed.  When creating a stack, you will need to specify 3 <b>parameters</b> - a key for SSH access to the nodes (created separately in the AWS Console), an access key and a secret key (both are generated when registering an AWS access account). <br>  In the <b>mapping</b> , two types of instance are described, both with a <i>64-bit</i> architecture.  And also, AWSRegionArch2AMI describes virtual image IDs that correspond to instances from Amazon Linux OS (ID data can be obtained from AWS Console). <br>  Next, we describe the <b>resources of the</b> Chef server and the Chef client.  In both cases, through the <b>Metadata</b> section, before running commands from the <b>User Data</b> section, <i>wget is</i> installed (just in case, in fact, Amazon Linux images must contain such packages).  The resources created are determined by the <i>ImageId</i> and <i>InstanceType</i> variables (in this case, these are the previously specified parameters, in this case Amazon Linux, m1.small, and 64-bit architecture).  Next comes the main body of the resource - <b>User Data</b> .  It is the body of the configuration bash script, which is executed step by step after our instance is initialized. <br>  In short, for the node that will be the <b>Chef server</b> , the following actions are taken: <br><ul><li>  disabling iptables (so that there are no problems with drop-ohm packages); </li><li>  Installing the Open Source Chef Server; </li><li>  the substitution of default.rb (yes, the bug of Amazon Linux images is that they are presented not as redhat, which is in essence, but as amazon, and the Chef-server service cannot fully work); </li><li>  auto configuration and server restart; </li><li>  creating a configuration file for the AWS console; </li><li>  uploading admin.pem and chef-validator.pem files to the repository (we will need them on the client); </li><li>  installing chef-client on the node (yes, the Chef server does not have its own knife); </li><li>  getting the client.pem and knife.rb files for the knife running on the server (such a starter-kit from the first part of the article); </li><li>  Recreation of the chef-repo directory structure in which our cookbooks, role files, etc. are stored; </li><li>  download and install cookbooks to the server (our cookbooks are in the storage, and some are taken from the community); </li><li>  Download and install roles on the server; </li><li>  adding a periodic task that will poll every node every 5 minutes and establish a base role for each new one. </li></ul><br>  I understand that this may seem like a confusing and incomprehensible explanation, but a detailed examination of each part of the script would take a lot of space.  Therefore - if you have questions - feel free to write me in the LAN or in the comments. <br>  Go back to our template.  For a node that will be a <b>Chef-client</b> , the following actions are taken: <br><ul><li>  disabling iptables (so that there are no problems with drop-ohm packages); </li><li>  Install Chef Client; </li><li>  creating a configuration file for the AWS console; </li><li>  Downloading client configuration files from the storage; </li><li>  adding the address of the Chef server to the client‚Äôs configuration (it may change even when the images are restarted, or when the stack is started again); </li><li>  adding a periodic task to run the Chef client. </li></ul><br>  It is worth noting that thanks to such an option as <i>json_attribs</i> , we can create a label for the node that will determine its <b>role</b> in the infrastructure.  This is done in the case when there may be nodes that take on various infrastructure roles among Chef clients. <br>  The following resources, <b>WaitHandle</b> and <b>WaitCondition</b> , describe the conditions under which the stack creation process can be suspended.  If WaitHandle receives a signal that the process has completed successfully during the timeout specified in WaitCondition, then the stack creation process continues / ends. <br>  The next advertised resource is the <b>Security Group</b> - a firewall for our sites.  The group describes the ports forwarded and the source address of the packets. <br>  The last block, <b>Outputs</b> , is used to successfully start stack and instance to get any variables that we are interested in.  For example, a domain name in order to gain access to the instance. <br>  As a result, we get a universal <b>template</b> and the ability to "expand" our modest infrastructure (if you are interested in a larger number of instance - use the Auto-Scaling Group) by executing one command in the AWS management console.  The result of the launch can be viewed in the <b>CloudFormation</b> section. <br>  What's next?  Then you get the ability to control nodes by knife, cookbooks and roles.  You can use the <i>community cookbook</i> , write your own, write <i>wrappers</i> to other <i>cookbooks</i> .  There are many possibilities and everything depends on the final task. <br>  In this series of articles, I tried, albeit superficially, to describe the process of automating the management of the PC fleet and interaction with AWS cloud resources.  Hopefully for beginners <i>DevOps</i> these articles will be interesting. <br>  If you have any questions and suggestions - feel free to write in the dialogues or comments on my articles.  Thanks to everyone who took the time to read the articles. <br>  <b>See you soon!</b> <br><br>  <b>References</b> : <br><ul><li>  AWS Documentation - <a href="http://aws.amazon.com/documentation/">aws.amazon.com/documentation</a> </li><li>  AWS CloudFormation - <a href="http://aws.amazon.com/documentation/cloudformation/">aws.amazon.com/documentation/cloudformation</a> </li><li>  AWS EC2 - <a href="http://aws.amazon.com/documentation/ec2/">aws.amazon.com/documentation/ec2</a> </li><li>  AWS Sample Templates - <a href="http://aws.amazon.com/cloudformation/aws-cloudformation-templates/">aws.amazon.com/cloudformation/aws-cloudformation-templates</a> </li><li>  AWS Console - <a href="http://docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/getting-started.html">docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/getting-started.html</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/211050/">https://habr.com/ru/post/211050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211034/index.html">The hardware paravirtualization mode will be available in the Xen 4.4 hypervisor and the Linux 3.14 kernel.</a></li>
<li><a href="../211040/index.html">Sometimes free lunches do happen.</a></li>
<li><a href="../211042/index.html">Capture filters for network analyzers (tcpdump, Wireshark, Paketyzer)</a></li>
<li><a href="../211044/index.html">Welcome to Moscow PM 06/02</a></li>
<li><a href="../211046/index.html">Curiosity explores the way through the sand dunes</a></li>
<li><a href="../211052/index.html">20-gram ornithopter with stereoscopic vision independently bends around obstacles</a></li>
<li><a href="../211054/index.html">Imperceptible complexity of rocket technology. Part 3: types of liquid fuels, geometrical dimensions, transportation</a></li>
<li><a href="../211058/index.html">How to get a free professional account in Wunderlist</a></li>
<li><a href="../211060/index.html">Scanning with support for JavaScript / Ajax / DomMutation or SlimerJS + CasperJS + Magic = Profit</a></li>
<li><a href="../211064/index.html">How the Guardian newspaper destroyed computers with Edward Snowden files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>