<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NODE.JS + Windows: look inside</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An article for node.js programmers who understand the principles of asynchronous event programming, but do not know how it works from the inside. If a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NODE.JS + Windows: look inside</h1><div class="post__text post__text-html js-mediator-article">  An article for node.js programmers who understand the principles of asynchronous event programming, but do not know how it works from the inside.  If a standard picture with ‚Äúlooped‚Äù circles is no longer enough for you and you want to at least take a look at what‚Äôs happening in the cycle of events under the hood, then you are under the cat. <br><img src="https://habrastorage.org/storage2/469/dad/f82/469dadf8228c475c2637b1d4750798e2.png"><br><a name="habracut"></a><br><h4>  Limitation </h4><br>  For ease of description, I decided to build my article around a simple file open operation, i.e.  <b>open</b> functions from the <b>fs</b> module.  Naturally, because of this, VERY much will remain outside the article, but you have to compromise between simplicity of perception and technical details. <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>).open(<span class="hljs-string"><span class="hljs-string">"c:\\1.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOpen</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Result: "</span></span>, result); });</code> </pre> <br><br><h4>  IOCP </h4><br>  To understand how Node.js works under Windows, you need to understand IOCP technology.  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365198%2528v%3Dvs.85%2529.aspx">Input / output completion port</a> - a technology designed to perform asynchronous input / output operations used in Windows.  The main object in this technology is the IOCP port created using the CreateIoCompletionPort () function. We are primarily interested in the fact that the IOCP port encapsulates an event queue created in the operating system.  The PostQueuedCompletionStatus () function places the event in a queue, and the GetQueuedCompletionStatus () function retrieves.  Moreover, if the queue is empty, then the thread that caused GetQueuedCompletionStatus pauses until the first event occurs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/23f/478/6d0/23f4786d06d4ac02e8644c4b0f83dbbc.png"><br><br><h4>  Initialization </h4><br>  Now, before proceeding directly to our example, consider some moments of node.js initialization.  At launch, a <a href="">special structure</a> is created <a href="">that describes the event loop</a> , let's call it loop.  Among other fields, the structure contains a link to the IOCP port, and an asynchronous request counter.  For simplicity, we denote it as an integer variable req_count.  When the loop is initialized, the IOCP port is created: <br><br><pre> <code class="javascript hljs">iocp _handle= CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br><img src="https://habrastorage.org/storage2/956/6da/1da/9566da1daa459777cb1f101dd5dbc61d.png"><br><br>  Next comes the launch of the event loop, which we will talk about later. <br><br><h4>  <b>Open</b> function </h4><br>  Well, finally, the algorithm of the open function itself. <br>  First, a <a href="">structure describing an asynchronous request</a> is created and initialized, let's call it fs_open_req.  It contains a link to the callback onOpen, the path and modifiers of access to the file and other information describing the request.  In addition, the structure contains a field for storing the result of the query or a link to it. <br>  Second, the asynchronous request counter in the loop structure is incremented. <br>  Thirdly, a separate stream is created in which the file will be opened.  In this case, the main stream node.js, returns from the open function and then goes to the next iteration of the event loop.  In the generated thread, the file 1.txt is opened using the operating system tools.  Its descriptor is written to the fs_open_req structure. <br><br><img src="https://habrastorage.org/storage2/054/d41/fcf/054d41fcfc9f15fdc0534292cd5fd5f4.png"><br><br>  Fourth, after opening the file and completing all the necessary operations, the spawned thread triggers PostQueuedCompletionStatus (), thereby placing the file open event on the IOCP queue.  Moreover, through one of the PostQueuedCompletionStatus parameters, a link to the fs_open_req structure is attached to the generated event. <br><br><img src="https://habrastorage.org/storage2/35f/03e/cf8/35f03ecf8b9cf21710567fd3b5cf548c.png"><br><br><h4>  The cycle of events. </h4><br>  At the entrance to the event loop, the asynchronous request counter is checked.  If there are no registered requests, the program ends.  If it does, the GetQueuedCompletionStatus () function is called, which either returns the next event or, if there are no events, pauses the work of the thread until they appear. <br>  At one of the iterations, the GetQueuedCompletionStatus function will return an event of opening the file and with it a link to the fs_open_req structure.  Next, node.js will reduce the asynchronous request counter and start callback onOpen, passing the file opening result as a parameter to it. <br><br><img src="https://habrastorage.org/storage2/df7/c21/8d8/df7c218d8743df843712323b1376aac7.png"><br><br><h4>  Conclusion </h4><br>  That's all.  I wanted to show only the basic principles, so much remains to be described.  For example, network I / O operations are organized somewhat differently and make fuller use of IOCP capabilities.  But let's leave it for the next time. </div><p>Source: <a href="https://habr.com/ru/post/159201/">https://habr.com/ru/post/159201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159183/index.html">A copyright harm report was removed from the site of one of the US Congress committees one day after publication.</a></li>
<li><a href="../159187/index.html">Google wants to be a wireless internet provider</a></li>
<li><a href="../159189/index.html">How do you set element styles if you do not use ‚Äúforeign‚Äù libraries</a></li>
<li><a href="../159193/index.html">Voluntary limits for cloud servers</a></li>
<li><a href="../159199/index.html">How do you feel about open source software?</a></li>
<li><a href="../159203/index.html">Configure Nginx + LAMP server at home. Part 1: Configuring the frontend - backend</a></li>
<li><a href="../159209/index.html">Overlaying text and images onto an image using MagickWand and GD libraries</a></li>
<li><a href="../159215/index.html">How many portable computer devices do you have (smartphones, tablets, laptops)?</a></li>
<li><a href="../159217/index.html">Phalcon - Compiled PHP MVC Framework</a></li>
<li><a href="../159219/index.html">Knock and open you: smartphones will learn to recognize fingers, nails and knuckles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>