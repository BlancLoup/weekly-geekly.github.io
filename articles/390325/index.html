<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup power supply with sine output. Part 2. Development of electrical concepts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue 
 In the last article , we considered the formulation of the problem of developing a low-power backup power source of 60 W with a sine output...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup power supply with sine output. Part 2. Development of electrical concepts</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>Prologue</b> </h4><br>  In the <a href="https://geektimes.ru/post/270464/">last article</a> , we considered the formulation of the problem of developing a low-power backup power source of 60 W with a sine output for the heating circulating pump.  The concept of the implementation of this device was chosen.  This article will discuss the development of the electrical circuit of the device, with the necessary calculations to select the ratings of the components included in the device. <br><br>  Armed with <s>CADs and textbooks,</s> drafts, pencil and GOOGLE we will proceed to the design.  Let's start with a simple - the power supply system of the device. <br><a name="habracut"></a><br><br><h4>  <b>Catering</b> </h4><br>  To power the circuit elements, we need three <s>types</s> of DC bus voltage of 12, 5 and 3.3 Volts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Twelve volt bus - the main one.  It is the power supply of the bridge, which injects current into the low-voltage winding of the linear network transformer.  From it we feed the drivers of transistors included in the bridge.  Commuting relays will also be powered from this bus. <br><br>  The five-volt bus is needed to power the ACS712 current chip, logic chip, character LCD, etc. <br><br>  A three-volt bus will power the ‚Äúbrains‚Äù of the device - the MK STM32F100C8T6B. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  For clarity, the pieces of the scheme were drawn in Proteuse v 7.7.  Its libraries do not have all the components used, so some components are replaced by analogues.  The final, complete scheme will be in the Dip Trace CAD format.  With all approved components.  But this is already in the next article. <br></div></div><br>  This scheme was born: <br><br> <a href=""><img src="https://habrastorage.org/files/da3/eeb/8c4/da3eeb8c4ba74b40887d38a03890c4e3.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  Tire shapers 5 and 3.3 Volts are organized on 1% LDO stabilizers like NCP1117STxx.  The analog power supply of the ADC module is taken from the 3.3 Volt bus through inductance, smoothing and blocking capacitors.  An analog land would also be worth sharing.  But in this scheme it is not, because the measurements are not critical, and an error in a couple of digits will not lead to a ‚Äúbreakdown‚Äù of the device.  Let's apply a software filter - a moving average and we can even achieve errors in one bit. <br><br><h4>  <b>Current measurement and overload protection</b> </h4><br>  The current sensor ACS712ELCTR-05B-T is an integrated circuit.  Current detection occurs on the Hall effect.  This sensor allows MK to measure both direct and reverse current.  Other characteristics can be found in his <a href="http://www.allegromicro.com/~/media/Files/Datasheets/ACS712-Datasheet.ashx%3Fla%3Den">pdf</a> .  The output of the sensor is analog.  The mean point corresponding to zero current is 2.5 V. The gain is 185 mV per 1 Ampere.  Although the sensor registers large currents, only linearity is distorted, and at a certain current enters saturation.  So to coordinate the output of the sensor with the MK, we put a voltage divider.  And divide the scale in half.  The ADC of the MK will be enough for acceptable accuracy. <br><br>  For high-speed protection against overload or short circuit in the low-voltage winding of a linear transformer, we install a current shunt.  We will amplify the signal from the shunt on the op amp and on the comparator and assemble a latching comparison circuit.  Data on overload will be pounded in the MK, and also on this signal we will close <b>ALL the</b> bridge keys. <br><br>  <b>A small video, simulations of current protection, is presented below.</b> <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/iR8gvVTQq-s%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiaUQICxIdYtl7DvSkexVRc2Tyd2w" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  <b>Power unit</b> </h4><br>  The power part of the RIP is shown in the figure. <br><br> <a href=""><img src="https://habrastorage.org/files/c8c/786/9c1/c8c7869c18854947b3d0e492010afced.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  The bridge transistors "relies" on the current shunt, to provide high-speed protection.  The bridge output through the LC filter, designed for a cutoff frequency of ~ 1 kHz, is fed to the low-voltage winding of the transformer.  About the filter and the transformer should talk in more detail. <br><br>  The calculation of the filter was made in the program "Calculator RL" link to the so-called off.  the site will not find.  Therefore, the archive with the calculator posted <a href="https://yadi.sk/d/fJcONKNQobfTb">here</a> .  Here is the calculation screen. <br><br><img src="https://habrastorage.org/files/dc2/8dc/eb6/dc28dceb67bb460d8227fa55b471b2be.jpg"><br><br>  The resulting inductance of 10 milligenres is quite impressive.  But the capacity was decent.  Since we have the output from the filter reversal, then the polar capacitor is not enough.  In the circuit laid two ceramic capacitors in parallel - 4.7 microfarads, X7R, 25V (1206). <br><br>  Calculation of the choke according to the obtained data produced in the program Coil32.  Here is a <a href="https://yadi.sk/d/fTn4XkDaobguG">link</a> to the archive with the program.  Ferrite ring for such a choke chose with the following parameters: Ring N87 R25x15x10.  Here is the calculation screen in the program. <br><br><img src="https://habrastorage.org/files/51b/758/890/51b7588901e340a4b59b3ca05112346b.JPG"><br><br>  It turned out 70 turns of wire with a diameter of 1 mm, to ensure the desired inductance.  It is quite acceptable for manual winding. <br><br>  The choice of a transformer fell on a TTP-60 type toroidal transformer, with a secondary voltage of 9 volts.  The calculation is simple.  An alternating voltage of 9 volts gives an amplitude of 12.7 volts.  The voltage of a charged battery is about 13 volts.  So we can more or less get 220 volts at the output.  To charge the battery of course is not enough.  Therefore, there is a proposal, to domotat the secondary coils by 5-6.  That is, it turned out low-voltage winding with a tap.  With the extreme conclusions of the winding remove the overvoltage to charge the battery, while running on the network.  And on the extreme and average output, we apply voltage from the bridge when working from the battery.  According to the voltage taken from the extreme terminals of the winding, we judge the voltage in the high-voltage winding during operation from the battery, feedback for adjustment. <br><br>  Bridge transistors are controlled from the MK through the half bridge drivers IRS2101S.  Top keys are controlled by the bootstrap scheme.  The P-channel charging transistor is controlled by a conventional bipolar.  The smoothing charging choke has the same dimensions and design values ‚Äã‚Äãas the choke in the LC filter after the bridge. <br><br><h4>  <b>Network presence detection and switching</b> </h4><br>  For the detection of the network applied capacitor power circuit.  Voltage is put on the optocoupler.  The output of the optocoupler is driven into the MK to monitor the presence of the network.  The diagram is shown below. <br><br> <a href=""><img src="https://habrastorage.org/files/264/9ee/f3c/2649eef3c58b4921b038af91573de3f2.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  The mains voltage through the quenching capacitor, diodes, zener diode, smoothing capacitors, current limiting resistor is fed to the LED of the optocoupler.  The output is in the MK. <br><br>  The control of the relay, switching the network to the load, is carried out from the MC. <br><br>  Current protection is implemented on the OS and comparator.  The output of the comparator diverges into two transistors.  One to enter the signal in the MC, the second to close <b>all the</b> transistors of the bridge. <br><br>  The figure below shows the driver enablement schemes for the bridge. <br><br> <a href=""><img src="https://habrastorage.org/files/b41/a23/a3d/b41a23a3dda649f698ebd24c372383ed.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  All typical, according to the <a href="http://www.irf.com/product-info/datasheets/data/irs2101pbf.pdf">data</a> on the driver IRS2101S. <br><br><h4>  <b>Scheme of the formation of impulses of the bridge</b> </h4><br>  In order not to load the MC with useless work, the formation of signals of the bridge pulses is collected on logic I. Three signals are required from the MC.  One sinusoidal PWM for the period, as well as two discrete signals, the first half-wave and the second.  The implementation of this approach is shown in the figure. <br><br> <a href=""><img src="https://habrastorage.org/files/efe/746/c7c/efe746c7cb334b50a48f5f5305735e01.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  Overcurrent, wound up in the MC and duplicated LED.  P-channel transistor control is organized on a bipolar NPN transistor. <br><br>  The logic of the bridge will be as follows.  20 kHz PWM will be modulated by the sine table in the amount of 400 values.  The transfer of values ‚Äã‚Äãto the PWM register will be organized through DMA.  After loading half of the buffer, i.e. 200 values, of one half period, DMA will cause an interrupt, where the signals MCU_P_1 and MCU_P_2 will be mutually inverted.  After loading the entire buffer, in the DMA interrupt, the reverse inversion of the signals MCU_P_1 and MCU_P_2 will occur.  And further in a cyclic mode.  The constant half-wave level will be fed to the upper transistor of the shoulder, and the sinusoidal PWM to the lower key of the opposite shoulder.  The next half cycle is another pair of transistors. <br><br>  During an overcurrent, the NPN transistor Q7 will provide a low level at the input of the logic, which in turn will lead to a low level at the output of the logic and, as a result, the locking of ALL bridge transistors. <br><br>
<h4>  <b>Hardware platform</b> </h4><br><blockquote>  A three-volt bus will power the ‚Äúbrains‚Äù of the device - the MK STM32F100C8T6B. </blockquote><br>  As mentioned above, the MK will be from ST of the STM32 family.  What is the reason for this choice? <br><br><ul><li>  MK has a low cost.  Analogs on opportunities from ATMEL or PIC have even higher prices, with a bit of 8 bits. </li><li>  The presence on board of a 12-bit ADC, DAC, DMA controller. </li><li>  32 bit kernel capacity. </li><li>  Increased capacity of program and data memory. </li></ul><br>  In a word wins in many positions. <br><br>  To indicate the operation of the device and output the necessary data in the scheme, the sign-based LCD will be used with the control controller KS0066 (HD44780).  Libraries for working with such a display in RuNet are full. <br><br>  The display connection to the controller is as follows. <br><br> <a href=""><img src="https://habrastorage.org/files/74b/ac3/de6/74bac3de6bc249298d22fbea0598833c.jpg"></a> <br>  <i>The picture is clickable.</i> <br><br>  Connection is direct.  Ports MK directly connected to the display.  The conjugation of 3 volt and 5 volt logic was not made.  There may be problems, and you have to configure the MK outputs as open-collector outlets, and pull up the lines to 5 volts, and the MK outputs themselves use tolerant to 5 volts.  As they say, life will show, but when designing a printed circuit board, it is necessary to make this ‚Äúupdate‚Äù. <br><br>  Custom buttons are needed to organize navigation through the menus and parameters displayed on the display. <br><br><h4>  <b>Additional calculations</b> </h4><br>  To calculate the bootstrap capacitor, we use the method proposed in this <a href="http://valvolodin.narod.ru/articles/FETsCntr.pdf">article</a> .  At the end of the description there is an example of calculating the required capacity of the bootstrap capacitor.  Take it as a basis and recalculate for our realities. <br><br>  <b>We define the parameters of the scheme:</b> <br><br><ul><li>  V <sub>IN, MAX</sub> = 15V maximum input voltage, </li><li>  V <sub>DRV</sub> = 12V driver supply voltage and the amplitude of the control signal, </li><li>  dV <sub>BST</sub> = 0.5V voltage ripple on capacitor C <sub>BST</sub> in steady state, </li><li>  dV <sub>BST, MAX</sub> = 3V maximum voltage drop on C <sub>BST</sub> before the undervoltage protection circuit works or the amplitude of the control signal becomes insufficient, </li><li>  f <sub>DRV</sub> = 100 Hz conversion frequency, since our capacitor operates in the interval of 10 ms, </li><li>  D <sub>MAX</sub> = 1 maximum fill factor at minimum input voltage. </li></ul><br>  <b>Characteristics of the components used:</b> <br><br><ul><li>  Q <sub>G</sub> = 24 nC total switching charge IRLZ44ZS with V <sub>DRV</sub> = 5V and V <sub>DS</sub> = 44V, </li><li>  R <sub>GS</sub> = 10K the value of the resistor R <sub>GS</sub> , </li><li>  I <sub>R</sub> = 10uA the leakage current of the diode D <sub>BST</sub> at the maximum input voltage and its transition temperature TJ = 80 ¬∞ C, </li><li>  V <sub>F</sub> = 0.6V voltage drop across the diode D <sub>BST</sub> at a current of 0.1A and a transition temperature TJ = 80 ¬∞ C, </li><li>  I <sub>LK</sub> = 0.13mA level leakage current at the maximum input voltage and crystal temperature TJ = 100 ¬∞ C, </li><li>  I <sub>QBS</sub> = 1mA current consumed by the top level driver. </li></ul><br><img src="https://habrastorage.org/files/2e7/24d/5f6/2e724d5f693b440c85e239b9d467d937.JPG"><br><br><img src="https://habrastorage.org/files/7cd/6d0/e0e/7cd6d0e0ea1f4431a35927026d0a6d30.JPG"><br><br>  The calculated value is selected from the standard series.  The type of capacitor we take tantalum, to reduce the leakage current of the capacitor itself.  The total is 47 microfarads x 25 V, type D. <br><br>  Calculate the charge current of the capacitor, thereby pick up the diode. <br><br><img src="https://habrastorage.org/files/0ef/591/b7c/0ef591b7c71a468e8a9e5aec4e0089f7.JPG"><br><br>  So the diode is designed for a direct current of 1 A, will cope with this task. <br><br><h4>  <b>Conclusion</b> </h4><br>  This article has developed the RIP circuitry.  Now all the pieces of the scheme put together.  And based on the already approved scheme, we will develop the topology of the printed circuit board.  The layout of the printed circuit board and the generalized electrical circuit with a specification for the components will be presented in the next article. <br><br>  Software implementation of the functional device will sign in a separate article.  There is an idea to implement many interesting solutions in the program, for example, PID regulation of the output voltage when operating from the battery. <br><br><h4>  <b>Epilogue</b> </h4><br>  With this article, I wanted to bring to the public and experienced radio amateurs and non-lovers, too, schematic decisions.  Perhaps the attentive reader will find any critical errors in the circuit design or suggest a more correct execution of individual nodes.  There will be some simpler solution of the nodes or to improve the reliability to introduce additional circuit solutions. <br><br>  <b>PS</b> <br>  Links to all parts of the cycle: <br><br><ol><li>  <a href="https://geektimes.ru/post/270464/">Development of a low-power backup power source with a sine output.</a>  <a href="https://geektimes.ru/post/270464/">Part 1. Statement of the problem.</a> </li><li>  <a href="https://geektimes.ru/post/270954/">Development of a low-power backup power source with a sine output.</a>  <a href="https://geektimes.ru/post/270954/">Part 2. Development of electrical concepts.</a> </li><li>  <a href="https://geektimes.ru/post/271322/">Development of a low-power backup power source with a sine output.</a>  <a href="https://geektimes.ru/post/271322/">Part 3. Work on the bugs</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/390325/">https://habr.com/ru/post/390325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../390313/index.html">Unmanned aircraft on "solid hydrogen" made the first flight</a></li>
<li><a href="../390315/index.html">We need your brains</a></li>
<li><a href="../390319/index.html">Bootloop iphone when the date is January 1, 1970</a></li>
<li><a href="../390321/index.html">From people to machines: the robotic revolution in China</a></li>
<li><a href="../390323/index.html">On Safe Internet Day, Google distributes 2 GB per security check</a></li>
<li><a href="../390327/index.html">Another way to determine the quality of air on the Arduino - with the transfer of data to the network</a></li>
<li><a href="../390331/index.html">Tablet on windows 10 - a review of the powerful tablet Chuwi Hi10 for $ 180</a></li>
<li><a href="../390333/index.html">Official Press Conference on Gravitational Wave Detectors: Answers to All Your Questions This Thursday</a></li>
<li><a href="../390337/index.html">Video review laptop Asus G752VT</a></li>
<li><a href="../390339/index.html">Video review 3D-printer Wanhao Duplicator i3 v2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>