<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lamp-rainbow do it yourself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 

 Foreword 
 The idea of ‚Äã‚Äãcreating a multi-color lamp came to my mind after seeing the fascinating effect of a flashing garland on my six-m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lamp-rainbow do it yourself</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr! <br><br><h2>  Foreword </h2><br>  The idea of ‚Äã‚Äãcreating a multi-color lamp came to my mind after seeing the fascinating effect of a flashing garland on my six-month-old son.  I wanted to create something similar, only performing some useful function - for example, a nightlight, with the possibility of flexible mode setting and with the possibility of remote control.  And, of course, the device created should be no less attractive for a child than a Chinese garland. <br><br><img src="https://habrastorage.org/files/662/49f/03c/66249f03c4424112933a38a0e42e702c.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Attention, under the cut a lot of photos. <br><a name="habracut"></a><br><h2>  Preliminary Steps </h2><br>  The choice fell on the creation of a floor lamp-floor lamp, which, due to the dimming of the light by the lamp shade, would not shine like a searchlight at night, would take up little space, and could simultaneously display several colors simultaneously.  Something similar was already created by habravchaninin - then it was a lamp showing the weather, collected on Malinka.  I did not have the task of climbing the Internet, I just wanted to ‚Äúflash the LEDs‚Äù, so it was decided to take Arduinka as a brain, since a small version of Nano bought from Uncle Liao was lying around at home.  For remote control, I decided to use the simplest Bluetooth module Bolutek for a couple of evergreens. <br><br>  Next came the question of creating the lamp itself.  It was decided not to reinvent the wheel, and take ready.  A floor lamp with a paper shade, bought in the nearest Ikea, came to the base for quite similar 500 rubles.  It was decided that inside it would be possible to fasten several pads on the rod for the LED tape sticker, which would create decent brightness.  Tape took color, models 5050, 60 LEDs per meter, without individual control of LEDs. <br><br>  Sites made of metal mounting tape for fixing underfloor heating - sold in all hardware stores.  Reel tape 20m enough for the eyes.  From a tape rolled up rings, with a diameter about 14 cm, with a possibility of fixing on a lamp core.  At the same time, the rings act as a heat sink, since  The tape is very noticeably heated. <br><br>  Then I began to think about how to independently control the color of all levels, having a limited number of PWM outputs on arduinka.  The number of levels chose 8, since  with a larger lamp began to bend under the weight of metal pads.  Still, the Swedish designers did not expect that something else would be attached to the lamp shaft.  Thus, I got the need to control 24 outputs, with the possibility of smooth adjustment of the output voltage to them.  Not a single Arduin has so many ways out (it can have Mega, but this solution is primitive), therefore, to solve the problem, I used the ShiftPWM library, which will satisfy any reasonable requirements on the number of levels.  With the help of inexpensive and affordable mikruh - shift register 74hc595 and keys uln2803 - provided the required number of controlled outputs and the current required to power the tapes. <br><br><h2>  Embodiment </h2><br>  First of all, he made 8 pads of metal tape, which he fastened on the rod of the lamp.  It was not possible to withstand the same distance between the levels due to the peculiarities of mounting the stock light source, but this turned out to be unprincipled: <br><br><table><tbody><tr><td><img src="https://habrastorage.org/files/34b/189/c0f/34b189c0f9b74c44b44aadd87d19cc33.JPG"></td><td><img src="https://habrastorage.org/files/b56/6cb/b54/b566cbb54afd4a93a586d5ce118da8e3.JPG"></td><td><img src="https://habrastorage.org/files/8de/055/c79/8de055c7981f42c0b3bba01d47a91678.JPG"></td></tr></tbody></table><br><br>  Then he prepared the cables of the wires, which led to the levels below.  The controller decided to place the bottom of the lamp, closer to the power supply.  All the loops, so as not to dangle, tied the tape to the rod: <br><br><table><tbody><tr><td><img src="https://habrastorage.org/files/b6d/2f7/c98/b6d2f7c982ce4d82af0ed02c079fbde2.JPG"></td><td><img src="https://habrastorage.org/files/a76/755/8c3/a767558c37a8496197bf4c713ced9817.JPG"></td></tr></tbody></table><br><br>  Next came the turn of the actual assembly circuit.  The connection scheme of the shift registers 74hc595 took a sample, from the site-guide to ShiftPWM. <br><br><div class="spoiler">  <b class="spoiler_title">Wiring register shift registers</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b5f/12d/913/b5f12d913c8544e399ac2a645bdbe210.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Connection diagram uln2803</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b93/d92/5ee/b93d925ee9fe41c8b3855e42a766984c.jpg"><br></div></div><br><br>  I assembled a scheme on a model board with a single-LED scheme, filled in a sketch example - made sure that everything works as it should: <br><br><img src="https://habrastorage.org/files/c9d/385/66f/c9d38566fc1c47e2b7121bdef0695cca.JPG"><br><br>  After that, it's time to build the circuit in production version.  Since  I wanted to assemble the circuit as quickly as possible, and there was no time to try the LUT-technology - I assembled the controller on two textolite layout boards, 4 by 6 cm in size.  On the first one there is an arduin and a bluetooth module for remote control, on the second one are registers, keys, and connectors for connecting tapes: <br><br><img src="https://habrastorage.org/files/2ee/509/e0d/2ee509e0dd694fe89eace5d4f5ef7b11.JPG"><br><br>  Then twisted both boards together, it turned out a kind of sandwich: <br><br><img src="https://habrastorage.org/files/992/81d/d7b/99281dd7b3564dd9b548889fffd54320.JPG"><br><br>  As a power supply, I took inexpensive Chinese, at 12V, with an output current of up to 5A: <br><br><img src="https://habrastorage.org/files/b8d/1ad/dd2/b8d1addd2073478d847c656abae81081.JPG"><br><br>  As a case, I used a switch box that fit in: <br><br><img src="https://habrastorage.org/files/17e/fa6/751/17efa6751edf46669dac5aae891f111f.JPG"><br><br>  Next - placed inside the case of the power supply, and a sandwich of the boards, stretching the wires from the tapes inside: <br><br><img src="https://habrastorage.org/files/65b/093/6c4/65b0936c4ed1404caaf8b60c8c66d492.JPG"><br><br>  It turned out to be a rather compact device, which was easily hidden under the lamp shade so that it did not attract attention. <br><br>  To control the controller, I previously wrote a program for Android.  In general, any bluetooth terminal will be suitable for controlling the circuit - it will suffice to program a few preset commands to transmit, and to select a custom backlight color, specify the RGB color code in <b>R, G, B</b> format. <br><br>  Next, I provide the sketch code that should be uploaded.  The scheme has 10 preset modes, as well as the ability to set its own colors. <br><br><div class="spoiler">  <b class="spoiler_title">Sketch</b> <div class="spoiler_text"><pre><code class="hljs ruby">/* * ShiftPWM non-blocking RGB fades example, (c) Elco Jacobs, updated August <span class="hljs-number"><span class="hljs-number">2012</span></span>. * * This example <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ShiftPWM shows how to control your LED<span class="hljs-string"><span class="hljs-string">'s in a non-blocking way: no delay loops. * This example receives a number from the serial port to set the fading mode. Instead you can also read buttons or sensors. * It uses the millis() function to create fades. The block fades example might be easier to understand, so start there. * * Please go to www.elcojacobs.com/shiftpwm for documentation, fuction reference and schematics. * If you want to use ShiftPWM with LED strips or high power LED'</span></span>s, visit the shop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> boards. *<span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ShiftPWM uses timer1 by default. To use a different timer, before '#include &lt;ShiftPWM.h&gt;', add /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ #define SHIFTPWM_USE_TIMER2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ for Arduino Uno and earlier (Atmega328) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ #define SHIFTPWM_USE_TIMER3 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ for Arduino Micro/</span></span>Leonardo (Atmega32u4) /<span class="hljs-regexp"><span class="hljs-regexp">/ Clock and data pins are pins from the hardware SPI, you cannot choose them yourself. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Data pin is MOSI (Uno and earlier: 11, Leonardo: ICSP 4, Mega: 51, Teensy 2.0: 2, Teensy 2.0++: 22) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Clock pin is SCK (Uno and earlier: 13, Leonardo: ICSP 3, Mega: 52, Teensy 2.0: 1, Teensy 2.0++: 21) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ You can choose the latch pin yourself. const int ShiftPWM_latchPin=8; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ** uncomment this part to NOT use the SPI port and change the pin numbers. This is 2.5x slower ** /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ #define SHIFTPWM_NOSPI /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ const int ShiftPWM_dataPin = 11; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ const int ShiftPWM_clockPin = 13; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ If your LED's turn on if the pin is low, set this to true, otherwise set it to false. const bool ShiftPWM_invertOutputs = false; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ You can enable the option below to shift the PWM phase of each shift register by 8 compared to the previous. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ This will slightly increase the interrupt load, but will prevent all PWM signals from becoming high at the same time. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ This will be a bit easier on your power supply, because the current peaks are distributed. const bool ShiftPWM_balanceLoad = false; #define rxPin 2 #define txPin 4 #include &lt;SoftwareSerial.h&gt; #include &lt;ShiftPWM.h&gt; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ include ShiftPWM.h after setting the pins! /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Function prototypes (telling the compiler these functions exist). void oneByOne(void); void inOutTwoLeds(void); void inOutAll(void); void alternatingColors(void); void hueShiftAll(void); void randomColors(void); void fakeVuMeter(void); void rgbLedRainbow(unsigned long cycleTime, int rainbowWidth); void printInstructions(void); void setColor(int r, int g, int b); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Here you set the number of brightness levels, the update frequency and the number of shift registers. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ These values affect the load of ShiftPWM. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Choose them wisely and use the PrintInterruptLoad() function to verify your load. unsigned char maxBrightness = 255; unsigned char pwmFrequency = 75; unsigned int numRegisters = 6; unsigned int numOutputs = numRegisters*8; unsigned int numRGBLeds = numRegisters*8/</span></span><span class="hljs-number"><span class="hljs-number">3</span></span>; unsigned int fadingMode = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//start</span></span> with all LED<span class="hljs-string"><span class="hljs-string">'s off. int r = 0; int g = 0; int b = 0; unsigned long startTime = 0; // start time for the chosen fading mode SoftwareSerial mySerial = SoftwareSerial(rxPin, txPin); void setup(){ while(!Serial){ delay(100); } Serial.begin(9600); pinMode(rxPin, INPUT); pinMode(txPin, OUTPUT); // Sets the number of 8-bit registers that are used. ShiftPWM.SetAmountOfRegisters(numRegisters); // SetPinGrouping allows flexibility in LED setup. // If your LED'</span></span>s are connected like <span class="hljs-symbol"><span class="hljs-symbol">this:</span></span> RRRRGGGGBBBBRRRRGGGGBBBB, use SetPinGrouping(<span class="hljs-number"><span class="hljs-number">4</span></span>). ShiftPWM.SetPinGrouping(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>This is the default, but I added here to demonstrate how to use the funtion ShiftPWM.Start(pwmFrequency,maxBrightness); printInstructions(); mySerial.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); } void loop() { String command = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (mySerial.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { char c = mySerial.read(); Serial.println(c); command.concat(c); } command.trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">""</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { startTime = millis(); } int firstCommaPos = -<span class="hljs-number"><span class="hljs-number">1</span></span>; int lastCommaPos = -<span class="hljs-number"><span class="hljs-number">1</span></span>; firstCommaPos = command.indexOf(<span class="hljs-string"><span class="hljs-string">','</span></span>); lastCommaPos = command.lastIndexOf(<span class="hljs-string"><span class="hljs-string">','</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstCommaPos != -<span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; lastCommaPos != -<span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; lastCommaPos != firstCommaPos) { String rStr = command.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, firstCommaPos); String gStr = command.substring(firstCommaPos + <span class="hljs-number"><span class="hljs-number">1</span></span>, lastCommaPos); String bStr = command.substring(lastCommaPos + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Serial.println(<span class="hljs-string"><span class="hljs-string">"r is -&gt; "</span></span> + rStr); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Serial.println(<span class="hljs-string"><span class="hljs-string">"g is -&gt; "</span></span> + gStr); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Serial.println(<span class="hljs-string"><span class="hljs-string">"b is -&gt; "</span></span> + bStr); r = rStr.toInt(); g = gStr.toInt(); b = bStr.toInt(); fadingMode = <span class="hljs-number"><span class="hljs-number">10</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"a"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"b"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"c"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"d"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"e"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"f"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"g"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"h"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"i"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == <span class="hljs-string"><span class="hljs-string">"j"</span></span>) fadingMode = <span class="hljs-number"><span class="hljs-number">9</span></span>; Serial.println(<span class="hljs-string"><span class="hljs-string">"command is -&gt; "</span></span> + command); switch(fadingMode){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Turn all LED<span class="hljs-string"><span class="hljs-string">'s off. ShiftPWM.SetAll(0); break; case 1: oneByOne(); break; case 2: inOutAll(); break; case 3: inOutTwoLeds(); break; case 4: alternatingColors(); break; case 5: hueShiftAll(); break; case 6: randomColors(); break; case 7: fakeVuMeter(); break; case 8: rgbLedRainbow(3000,numRGBLeds); break; case 9: rgbLedRainbow(10000,5*numRGBLeds); break; case 10: setColor(r,g,b); break; default: Serial.println("Unknown Mode!"); delay(1000); break; } } void setColor(int r, int g, int b) { ShiftPWM.SetAll(0); ShiftPWM.SetAllRGB(r,g,b); } void oneByOne(void){ // Fade in and fade out all outputs one at a time unsigned char brightness; unsigned long fadeTime = 500; unsigned long loopTime = numOutputs*fadeTime*2; unsigned long time = millis()-startTime; unsigned long timer = time%loopTime; unsigned long currentStep = timer%(fadeTime*2); int activeLED = timer/(fadeTime*2); if(currentStep &lt;= fadeTime ){ brightness = currentStep*maxBrightness/fadeTime; ///fading in } else{ brightness = maxBrightness-(currentStep-fadeTime)*maxBrightness/fadeTime; ///fading out; } ShiftPWM.SetAll(0); ShiftPWM.SetOne(activeLED, brightness); } void inOutTwoLeds(void){ // Fade in and out 2 outputs at a time unsigned long fadeTime = 500; unsigned long loopTime = numOutputs*fadeTime; unsigned long time = millis()-startTime; unsigned long timer = time%loopTime; unsigned long currentStep = timer%fadeTime; int activeLED = timer/fadeTime; unsigned char brightness = currentStep*maxBrightness/fadeTime; ShiftPWM.SetAll(0); ShiftPWM.SetOne((activeLED+1)%numOutputs,brightness); ShiftPWM.SetOne(activeLED,maxBrightness-brightness); } void inOutAll(void){ // Fade in all outputs unsigned char brightness; unsigned long fadeTime = 2000; unsigned long time = millis()-startTime; unsigned long currentStep = time%(fadeTime*2); if(currentStep &lt;= fadeTime ){ brightness = currentStep*maxBrightness/fadeTime; ///fading in } else{ brightness = maxBrightness-(currentStep-fadeTime)*maxBrightness/fadeTime; ///fading out; } ShiftPWM.SetAll(brightness); } void alternatingColors(void){ // Alternate LED'</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> different colors unsigned long holdTime = <span class="hljs-number"><span class="hljs-number">2000</span></span>; unsigned long time = millis()-startTime; unsigned long shift = (time/holdTime)%<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(unsigned int led=<span class="hljs-number"><span class="hljs-number">0</span></span>; led&lt;numRGBLeds; led++){ switch((led+shift)%<span class="hljs-number"><span class="hljs-number">6</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> red <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> green <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> blue <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">128</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> orange <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> turqoise <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: ShiftPWM.SetRGB(led,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> purple <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } void hueShiftAll(void){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Hue shift all LED<span class="hljs-string"><span class="hljs-string">'s unsigned long cycleTime = 10000; unsigned long time = millis()-startTime; unsigned long hue = (360*time/cycleTime)%360; ShiftPWM.SetAllHSV(hue, 255, 255); } void randomColors(void){ // Update random LED to random color. Funky! unsigned long updateDelay = 100; static unsigned long previousUpdateTime; if(millis()-previousUpdateTime &gt; updateDelay){ previousUpdateTime = millis(); ShiftPWM.SetHSV(random(numRGBLeds),random(360),255,255); } } void fakeVuMeter(void){ // imitate a VU meter static unsigned int peak = 0; static unsigned int prevPeak = 0; static unsigned long currentLevel = 0; static unsigned long fadeStartTime = startTime; unsigned long fadeTime = (currentLevel*2);// go slower near the top unsigned long time = millis()-fadeStartTime; currentLevel = time%(fadeTime); if(currentLevel==peak){ // get a new peak value prevPeak = peak; while(abs(peak-prevPeak)&lt;5){ peak = random(numRGBLeds); // pick a new peak value that differs at least 5 from previous peak } } if(millis() - fadeStartTime &gt; fadeTime){ fadeStartTime = millis(); if(currentLevel&lt;peak){ //fading in currentLevel++; } else{ //fading out currentLevel--; } } // animate to new top for(unsigned int led=0;led&lt;numRGBLeds;led++){ if(led&lt;currentLevel){ int hue = (numRGBLeds-1-led)*120/numRGBLeds; // From green to red ShiftPWM.SetHSV(led,hue,255,255); } else if(led==currentLevel){ int hue = (numRGBLeds-1-led)*120/numRGBLeds; // From green to red int value; if(currentLevel&lt;peak){ //fading in value = time*255/fadeTime; } else{ //fading out value = 255-time*255/fadeTime; } ShiftPWM.SetHSV(led,hue,255,value); } else{ ShiftPWM.SetRGB(led,0,0,0); } } } void rgbLedRainbow(unsigned long cycleTime, int rainbowWidth){ // Displays a rainbow spread over a few LED'</span></span>s (numRGBLeds), which shifts <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hue. /<span class="hljs-regexp"><span class="hljs-regexp">/ The rainbow can be wider then the real number of LED's. unsigned long time = millis()-startTime; unsigned long colorShift = (360*time/cycle</span></span>Time)%<span class="hljs-number"><span class="hljs-number">360</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> this color shift is like the hue slider <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Photoshop. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(unsigned int led=<span class="hljs-number"><span class="hljs-number">0</span></span>;led&lt;numRGBLeds;led++){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> loop over all LED<span class="hljs-string"><span class="hljs-string">'s int hue = ((led)*360/(rainbowWidth-1)+colorShift)%360; // Set hue from 0 to 360 from first to last led and shift the hue ShiftPWM.SetHSV(led, hue, 255, 255); // write the HSV values, with saturation and value at maximum } } void printInstructions(void){ Serial.println("---- ShiftPWM Non-blocking fades demo ----"); Serial.println(""); Serial.println("Type '</span></span>l<span class="hljs-string"><span class="hljs-string">' to see the load of the ShiftPWM interrupt (the % of CPU time the AVR is busy with ShiftPWM)"); Serial.println(""); Serial.println("Type any of these numbers to set the demo to this mode:"); Serial.println(" 0. All LED'</span></span>s off<span class="hljs-string"><span class="hljs-string">"); Serial.println("</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>. Fade <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> out one by one<span class="hljs-string"><span class="hljs-string">"); Serial.println("</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>. Fade <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> out all LED<span class="hljs-string"><span class="hljs-string">'s"); Serial.println(" 3. Fade in and out 2 LED'</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parallel<span class="hljs-string"><span class="hljs-string">"); Serial.println("</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>. Alternating LED<span class="hljs-string"><span class="hljs-string">'s in 6 different colors"); Serial.println(" 5. Hue shift all LED'</span></span>s<span class="hljs-string"><span class="hljs-string">"); Serial.println("</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>. Setting random LED<span class="hljs-string"><span class="hljs-string">'s to random color"); Serial.println(" 7. Fake a VU meter"); Serial.println(" 8. Display a color shifting rainbow as wide as the LED'</span></span>s<span class="hljs-string"><span class="hljs-string">"); Serial.println("</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>. Display a color shifting rainbow wider than the LED<span class="hljs-string"><span class="hljs-string">'s"); Serial.println(""); Serial.println("Type '</span></span>m<span class="hljs-string"><span class="hljs-string">' to see this info again"); Serial.println(""); Serial.println("----"); }</span></span></code> </pre> <br></div></div><br><br>  The video shows the rainbow mode, IMHO the most beautiful mode of operation: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/PoHrfmJQLSA%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhGmAJ8Goi4fc6A8xnUEBYD6FAApQ" frameborder="0" allowfullscreen=""></iframe><br><br>  And a couple of photos of the finished device - it's a pity that the camera can not convey the richness of color: <br><br><table><tbody><tr><td><img src="https://habrastorage.org/files/890/655/cac/890655cac24e4cc783751dfabfaac4dc.JPG"></td><td><img src="https://habrastorage.org/files/35d/7a5/637/35d7a5637c224db2b9c99850b46c1152.JPG"></td></tr></tbody></table><br><br><h2>  Results </h2><br>  The assembled lamp fully satisfies the original idea, looks like a finished product, the wires do not stick out, is controlled easily, the son is satisfied - and this is the main thing! <br><br>  All components of the controller were purchased on Ebee, everyone can find them there - the prices are minimal.  The total cost of the lamp turned out to be approximately: 500r lamp itself, 800r for the LED strip, 100r for the power supply unit, microcircuits for 50r, 200r for the broom, case and steel tape for fastening for 200r.  Total - about 1900r. <br>  By the time the assembly took about 2 weeks in free time in the evenings.  Surely you can do it faster if you do not get distracted. <br><br>  What else can you do: <br><br><ul><li>  Use LUT instead of mockups </li><li>  Modify the software for the phone - so that you can adjust the brightness / speed of effects, etc. </li><li>  Instead of Adruinka, take Raspberry - and be able to automatically turn on the lights, manually control the existing modes or create new ones without reloading the firmware </li><li>  Instead of 5050 ribbons, take the ws2811 ribbon - and get the ability to control not the levels entirely, but each individual LED </li><li>  Now the stock light has nothing to do with the microcontroller - or you can install a relay and control it remotely from the phone as well </li><li>  Make the inclusion of the clap of his hands - so as not to climb every time in the program to include </li><li>  ... </li><li>  Dozens of dodelok </li></ul><br><br>  I would be glad to see in comments reviews, criticism, and ideas about improving the design. </div><p>Source: <a href="https://habr.com/ru/post/258291/">https://habr.com/ru/post/258291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258281/index.html">Release of a new version of WordPress 4.2 Powell and a security breach</a></li>
<li><a href="../258283/index.html">Install AirSlax on a virtual machine. Work with WiFi</a></li>
<li><a href="../258285/index.html">What is TLS</a></li>
<li><a href="../258287/index.html">Habrahabr appropriated to everyone according to the ‚Äúdog‚Äù</a></li>
<li><a href="../258289/index.html">Cach√© audit log analysis using Cach√© (DeepSee)</a></li>
<li><a href="../258293/index.html">Object Storage - The Near Future of Storage Systems</a></li>
<li><a href="../258295/index.html">Do-it-yourself analysis of links in a project</a></li>
<li><a href="../258297/index.html">Commercial site security research</a></li>
<li><a href="../258301/index.html">50+ Best Bootstrap Add-ons</a></li>
<li><a href="../258303/index.html">Running load tests made with JMeter using StormRunner Load</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>