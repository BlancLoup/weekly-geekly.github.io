<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modifying a function bytecode in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I needed to solve a rather unusual task, namely, to add a non-standard operator in the python language. This task was to generate a Pyth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modifying a function bytecode in Python</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I needed to solve a rather unusual task, namely, to add a non-standard operator in the python language.  This task was to generate a Python code using a pseudo-code similar to an assembler that contains the goto operator.  I didn‚Äôt want to write a complex lexical analyzer, in the pseudocode operator goto was used to organize cycles and transitions according to conditions, and I wanted to have some of its analogs in python, which is not present. <br><a name="habracut"></a><br>  There is a module laid out in honor of April 1 as a joke, but it did not work for me.  At once I want to make a reservation that I am aware of the drawbacks of using this operator, however, in some cases, with automatic code generation, its use greatly simplifies the life of a programmer.  Plus, the described approach allows you to add any necessary code modification, if such is required, and this will be described below as an example of adding the goto operator. <br><br>  So, there is a problem how to add a couple of new commands to the python and how to make it interpret them correctly (go to the necessary addresses).  To do this, we write a decorator that will hook up to the function within which we want to use the goto operator and add labels (label), and use the dis modules that allow you to work with the python bytecode, and new, which allows you to create internal python objects dynamically . <br><br>  For a start, let's define the format of the commands.  Since the python has a number of restrictions on syntax, commands like 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="python hljs">a: goto a</code> </pre> <br><br>  do not succeed.  However, the python allows you to add constructions like <br><br><pre> <code class="python hljs">label .a goto .a</code> </pre><br><br>  Here it should be noted that the point plays an important role, since  the python skips spaces and reduces this to calls to class attributes.  Writing without a dot will result in a syntax error message.  So, consider the byte code of these commands.  To do this, execute the following code: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> &gt;&gt;&gt; label .a &gt;&gt;&gt; goto .a &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dis &gt;&gt;&gt; dis.dis( f ) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_GLOBAL <span class="hljs-number"><span class="hljs-number">0</span></span> (label) <span class="hljs-number"><span class="hljs-number">3</span></span> LOAD_ATTR <span class="hljs-number"><span class="hljs-number">1</span></span> (a) <span class="hljs-number"><span class="hljs-number">6</span></span> POP_TOP <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> LOAD_GLOBAL <span class="hljs-number"><span class="hljs-number">2</span></span> (goto) <span class="hljs-number"><span class="hljs-number">10</span></span> LOAD_ATTR <span class="hljs-number"><span class="hljs-number">1</span></span> (a) <span class="hljs-number"><span class="hljs-number">13</span></span> POP_TOP <span class="hljs-number"><span class="hljs-number">14</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span> RETURN_VALUE</code> </pre><br><br>  Consequently, the command to declare a label and go over a label is reduced to three operations LOAD_GLOBAL, LOAD_ATTR, POP_TOP, the main of which are the first two.  The dis module allows you to determine the bytecode of these commands using the opmap dictionary and get their symbolic representation by bytecode using the opname dictionary. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>dis.opmap[ <span class="hljs-string"><span class="hljs-string">'LOAD_GLOBAL'</span></span> ] <span class="hljs-number"><span class="hljs-number">116</span></span> &gt;&gt;&gt; dis.opmap[ <span class="hljs-string"><span class="hljs-string">'LOAD_ATTR'</span></span> ] <span class="hljs-number"><span class="hljs-number">105</span></span></code> </pre><br><br>  The byte representation of the function f is stored in f.func_code.co_code, and the symbolic representations of its variables are stored in f.func_code.co_names. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>f.func_code.co_names (<span class="hljs-string"><span class="hljs-string">'label'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'goto'</span></span>)</code> </pre><br><br>  Now a little about the byte representations of the teams of interest.  One piece of the disassembler shows that the LOAD_GLOBAL and LOAD_ATTR commands are represented by three bytes (the offset is indicated on the left), the first of which is the byte-operation code (from opmap), the second and third are the data (low and high byte, respectively) representing the index in the list f.func_code.co_names corresponding to which variable or attribute we want to declare. <br><br>  You can determine if the command has arguments (and thus the length of the command in bytes) by comparing with dis.HAVE_ARGUMENT.  If it is greater than or equal to the given constant, then it has arguments, otherwise - no.  Thus, we obtain a function for parsing the byte-code function.  Next, we replace the tag code with the NOP operation, and the goto statement code with JUMP_ABSOLUTE, which takes an offset as a parameter within the function.  Here, almost all.  The decorator code and usage example is shown below. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dis, new <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MissingLabelError</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( Exception )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExistingLabelError</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( Exception )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( function )</span></span></span><span class="hljs-function">:</span></span> labels_dict = {} gotos_list = [] command_name = <span class="hljs-string"><span class="hljs-string">''</span></span> previous_operation = <span class="hljs-string"><span class="hljs-string">''</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> i &lt; len( function.func_code.co_code ): operation_code = ord( function.func_code.co_code[ i ] ) operation_name = dis.opname[ operation_code ] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> operation_code &gt;= dis.HAVE_ARGUMENT: lo_byte = ord( function.func_code.co_code[ i + <span class="hljs-number"><span class="hljs-number">1</span></span> ] ) hi_byte = ord( function.func_code.co_code[ i + <span class="hljs-number"><span class="hljs-number">2</span></span> ] ) argument_position = ( hi_byte &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> ) ^ lo_byte <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> operation_name == <span class="hljs-string"><span class="hljs-string">'LOAD_GLOBAL'</span></span>: command_name = function.func_code.co_names[ argument_position ] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> operation_name == <span class="hljs-string"><span class="hljs-string">'LOAD_ATTR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous_operation == <span class="hljs-string"><span class="hljs-string">'LOAD_GLOBAL'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> command_name == <span class="hljs-string"><span class="hljs-string">'label'</span></span>: label = function.func_code.co_names[ argument_position ] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> labels_dict.has_key( label ): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ExistingLabelError( <span class="hljs-string"><span class="hljs-string">'Label redifinition: %s'</span></span> % label ) labels_dict.update( { label : i - <span class="hljs-number"><span class="hljs-number">3</span></span> } ) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> command_name == <span class="hljs-string"><span class="hljs-string">'goto'</span></span>: gotos_list += [ ( function.func_code.co_names[ argument_position ], i - <span class="hljs-number"><span class="hljs-number">3</span></span> ) ] i += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: i += <span class="hljs-number"><span class="hljs-number">1</span></span> previous_operation = operation_name codebytes_list = list( function.func_code.co_code ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> label, index <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> labels_dict.items(): codebytes_list[ index : index + <span class="hljs-number"><span class="hljs-number">7</span></span> ] = [ chr( dis.opmap[ <span class="hljs-string"><span class="hljs-string">'NOP'</span></span> ] ) ] * <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-comment"><span class="hljs-comment">#  7     LOAD_GLOBAL, LOAD_ATTR  POP_TOP  NOP for label, index in gotos_list: if label not in labels_dict: raise MissingLabelError( 'Missing label: %s' % label ) target_index = labels_dict[ label ] + 7 codebytes_list[ index ] = chr( dis.opmap[ 'JUMP_ABSOLUTE' ] ) codebytes_list[ index + 1 ] = chr( target_index &amp; 0xFF ) codebytes_list[ index + 2 ] = chr( ( target_index &gt;&gt; 8 ) &amp; 0xFF ) #  -    code = function.func_code new_code = new.code( code.co_argcount, code.co_nlocals, code.co_stacksize, code.co_flags, str().join( codebytes_list ), code.co_consts, code.co_names, code.co_varnames, code.co_filename, code.co_name, code.co_firstlineno, code.co_lnotab ) #    new_function = new.function( new_code, function.func_globals ) return new_function</span></span></code> </pre><br><br>  Example of use: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@goto def test_function( n ): goto .label1 label .label2 print n goto .label3 label .label1 print n n -= 1 if n != 0: goto .label1 else: goto .label2 label .label3 print 'the end' test_function( 10 )</span></span></code> </pre><br><br>  The result of the example: <br><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> the end</code> </pre><br><br>  In conclusion, I want to add that this solution does not quite correspond to the general python style: it is not very reliable due to the strong dependence on the interpreter version (in this case, the interpreter 2.7 was used, but it should work for all versions of 2-ki), but the solution to this problem once again proves the great flexibility of the language and the possibility of adding new necessary functionality. </div><p>Source: <a href="https://habr.com/ru/post/140356/">https://habr.com/ru/post/140356/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140350/index.html">Development: proper timing</a></li>
<li><a href="../140351/index.html">"Autoswitch layouts" in php-applications</a></li>
<li><a href="../140352/index.html">We disassemble xlsx in PHP without ready libraries</a></li>
<li><a href="../140353/index.html">Difference permissions devices. Developer Tips</a></li>
<li><a href="../140354/index.html">Save file change history</a></li>
<li><a href="../140357/index.html">C ++ 11 User Literals</a></li>
<li><a href="../140358/index.html">Online Store Integration with Google Merchant</a></li>
<li><a href="../140360/index.html">The Pirate Bay goes to the sky</a></li>
<li><a href="../140361/index.html">Amazon buys robots company for $ 775 million</a></li>
<li><a href="../140362/index.html">Ruby 2.0 Lazy Enumerable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>