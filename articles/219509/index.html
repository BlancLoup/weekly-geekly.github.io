<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Skeletal animation for the first time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Good day. I am writing an article here for the first time, and my goal is very simple, I want to share my vision of skeletal animation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Skeletal animation for the first time</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Good day.  I am writing an article here for the first time, and my goal is very simple, I want to share my vision of skeletal animation and have a great desire to receive criticism and help.  All the creation of this system was a trial and error, I did not find any books about how to do it, what it is all about and how to use it.  But now I am at a dead end, I would like to find a way out of it here. <br><a name="habracut"></a><br><h5>  What did I use? </h5><br><ul><li>  <b>MSVS 2013 Professional</b> is my main IDE </li><li>  <b>Qt Creator</b> - with this, I wrote an animation editing program </li><li>  <b>Qt 5.1</b> - like GUI for animation editor </li><li>  <b>SDL 2</b> - input / output of commands and display graphics in the final program (where animation should take place) </li><li>  <b>OpenGL 2.1</b> - for displaying graphics </li><li>  <b>GLEW</b> - to connect extensions OpenGL </li><li>  <b>Boost</b> - to use the timer </li><li>  <b>Google Protobuf</b> - To save to animation files </li><li>  <b>With ++</b> - YaP on which I also did everything </li></ul><br><br><h4>  Where to begin? </h4><br>  I decided that for a start I need to define structures, and it will be easier for me to understand how they should then work. <br>  First, I‚Äôll show my define definitions: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M_PI 3.1415926535 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M_PI_2 M_PI/2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M_PI_3 M_PI/3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M_PI_4 M_PI/4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RAD1 M_PI/180.0f #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEG1 180.0f/M_PI #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RAD2DEG(rad) rad*DEG1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEG2RAD(deg) deg*RAD1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_CHILDREN_COUNT 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_KEYFRAME_COUNT 20</span></span></code> </pre> <br><br>  and here I finally came to such structures: <br><h5>  Joint is a joint </h5><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Joint</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//inheritanse _Joint* root; /* Pointer to root element. All elements have it. */ _Joint* parent; /* Pointer to parent */ //simple joints variables float x, y; /* Position */ float angle; /* Angle of rotate. In radians!!! */ uint8_t level; /* Level of hierarchy. Root have 0, next level +1 */ float dX, dY; /* Default Position */ float dAngle; /* Default Angle */ float aX, aY; /* Animation Position */ float aAngle; /* Animation Angle */ //children uint8_t childCount; /* Number of children */ _Joint* child[MAX_CHILDREN_COUNT]; /* Array of children */ //index uint16_t indexCount; /* Last number for index. Only Root have the var. */ uint16_t index; /* Unique index of joint */ } S_Joint;</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>dX, dY, dAngle</b> - These are the default values.  I decided to store the angles in radians, from 0 to 6.28.  And with that, I later had a lot of problems.  But more about that later. <br>  <b>aX, aY, aAngle</b> - These are the animation parameters.  They indicate that the frame has already been interpolated.  Ie the last animation is recorded in them.  For example, the animation lasts 900 ms ( <b>TIME</b> ), 450 ms ( <b>NOW</b> ) now occurs, but the animation cannot be updated every millisecond, so if it used to be 400 ms, but 450, we interpolate X and imagine that there are 2 keys in the first X = 50 ( <b>KEY1</b> ), in the second 100 ( <b>KEY2</b> ), then I consider the final value of <b>X</b> as follows: <br> <code>_Joint.x += (KEY2 - KEY1) / TIME * NOW - _Joint.aX;</code> <br> <code>_Joint.aX = (KEY2 - KEY1) / TIME * NOW;</code> <br> <code>22,3 += (100-50) / 900 * 450 - 22,3</code> <br>  22.3 - This is X bone given that when time ( <b>NOW</b> ) was 0, then <b>X</b> was also zero. <br><br><h5>  KeyData and Keyframe are the structures for animation. </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KeyData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y, angle; } S_KeyData; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Keyframe</span></span></span><span class="hljs-class"> {</span></span> S_KeyData data; <span class="hljs-comment"><span class="hljs-comment">/* data of Joint */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> time; <span class="hljs-comment"><span class="hljs-comment">/* ~32 sec.(32768 ms) is maximum time for animation. Only Root have it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> index; <span class="hljs-comment"><span class="hljs-comment">/* Index of joint, which we want interpolate */</span></span> _Keyframe* parent; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> childCount; <span class="hljs-comment"><span class="hljs-comment">/* Number of children */</span></span> _Keyframe* child[MAX_CHILDREN_COUNT]; } S_Keyframe;</code> </pre><br><br>  I have been thinking for a long time how to organize a bone search for interpolation.  Searching the tree is a rather obscure process for animation in my opinion.  I had 2 solutions in my head.  The first solution is to use idedes to designate branches, and this would speed up the search a bit, since  this would be normal addressing.  But I chose the second solution.  In my opinion, updating a whole tree is much easier and faster than some separate parts of it.  Very simply, imagine we have a main bone, which has 10 children each, which in turn have 5 more. As a result, we have only 51 bones (by the way, I don‚Äôt see the root joint at all, changing it x and y will lead to a change the position of the whole object). <br>  We will need 10 cycles of 5 iterations, that is, only 50 iterations.  And in the end we get 51 interpolation when updating the entire tree.  Otherwise, if we use a bone search, then searching for the last added bone will require 50 iterations, for the penultimate 49, and so on, in total, much more than updating the entire tree.  <b>_Keyframe</b> having an index of <b>0</b> , stores the time of this input, all its children have the time parameter 0. <br><br><h5>  Animation - stores a list of keys </h5><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animation</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyNumber; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyCount; S_Keyframe* key[MAX_KEYFRAME_COUNT]; } S_Animation;</code> </pre><br>  <b>keyNumber</b> is the index of the animation being played, default to zero.  All animation keys are stored in the <b>key</b> array, in chronological order.  I will hide all ways of implementing, creating deleting structures and adding new objects to them so as not to clutter up a lot of code here.  But I will show the functions for the animation itself. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(S_Joint *root, S_Animation *anim, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!root) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!anim) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> timeOut = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; anim-&gt;keyCount; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time &lt; anim-&gt;key[i]-&gt;time) <span class="hljs-comment"><span class="hljs-comment">//search keyframes for interpolation { //  1200,  2400, 2400-1200=1200 uint16_t mtime = anim-&gt;key[i]-&gt;time - anim-&gt;key[i - 1]-&gt;time; //nowTime is 1560, mtime = 1200(ERROR), 1560 - 1200(last key)=360(realtime) uint16_t nowTime = time - anim-&gt;key[i - 1]-&gt;time; if (i != anim-&gt;keyNumber) //    keyNumber,        { setDefaultAnimTree(root); //set to 0.0 animation changes(aX,yX,aAngle) } anim-&gt;keyNumber = i; //   doInterpolate(root, anim-&gt;key[i - 1], anim-&gt;key[i], mtime, nowTime); timeOut = false; break; } } if (timeOut == true) { setDefaultTree(root); //          } return timeOut; }</span></span></code> </pre><br><br>  When the function returns true, the timer is reset to zero. (Boost :: timer) <br><br>  And the final function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInterpolate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(S_Joint* root, S_Keyframe* key1, S_Keyframe* key2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nowTime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (root-&gt;index != key2-&gt;index) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x = (key2-&gt;data.x - key1-&gt;data.x) / time * nowTime; <span class="hljs-comment"><span class="hljs-comment">//        float y = (key2-&gt;data.y - key1-&gt;data.y) / time * nowTime; float angle = (key2-&gt;data.angle - key1-&gt;data.angle) / time * nowTime; root-&gt;x += x - root-&gt;aX; //root-&gt;aX -        ,        root-&gt;y += y - root-&gt;aY; root-&gt;angle += angle - root-&gt;aAngle; root-&gt;aX = x; //     ,     x,y,angle root-&gt;aY = y; root-&gt;aAngle = angle; //     for (int i = 0; i &lt; root-&gt;childCount; i++) { doInterpolate(root-&gt;child[i], key1-&gt;child[i], key2-&gt;child[i], time, nowTime); } }</span></span></code> </pre><br><br>  This is the skeleton animation and it works quite well.  A cloud of problems arose at the stage of creating a program in Qt, and the very first is the movement of bones with a mouse, and indeed the movement of bones.  The length of rotation of the bone in a circle is 6.28, ie 2 * Pi or 360 degrees.  But it turns out the movement happens only in one direction.  If we get let's say at calculations 4.47, but we want to move in the other direction, in principle we can do this: <br> <code>4,47-6.28=-1,81</code> <br>  Like a move to the other side.  But it is not very convenient.  I also tried to find the best way to the goal of rotation.  If we imagine our position is admitted 1.57 (A), our goal is 5.57 (B), then: <br><pre> <code class="cpp hljs">negAngle = BA; posAngle = (B<span class="hljs-number"><span class="hljs-number">-6.28</span></span>)-A; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">fabs</span></span>(posAngle) &gt; <span class="hljs-built_in"><span class="hljs-built_in">fabs</span></span>(negAngle)) { <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> }</code> </pre><br><br>  But the optimal path is not always needed.  Therefore, it is also not quite suitable.  I'll think about two options for solving these problems.  The first option is to calculate strict interpolation.  Ie, the key in the animation will be the key.  The second way is to set the key only movement, nothing more.  But in truth, I was stumped and I do not know what to do next.  The Qt program works with relative success, but the animation itself seems not bad, but as long as I wrote the GUI editor I understood its inefficiency and cumbersomeness.  How do I limit skeletal animation to physics (I‚Äôm eager to join Box2d), but I don‚Äôt have any idea how to do this.  I decided to redo everything, but I want to hear advice, criticism, what and how I did wrong.  Once again, this is my system, it was not done by example, this is my view on skeletal animation, do not judge strictly.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/219509/">https://habr.com/ru/post/219509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219493/index.html">Fingerprint scanner in the Samsung Galaxy S5 is also vulnerable</a></li>
<li><a href="../219497/index.html">Math and Play 2048</a></li>
<li><a href="../219499/index.html">Vidonn X5 - bracelet from heaven to monitor physical activity</a></li>
<li><a href="../219505/index.html">The basic rules of indie gamedev. Part 1</a></li>
<li><a href="../219507/index.html">LSI MegaRAID SAS 8208XLP to Debian</a></li>
<li><a href="../219521/index.html">Humble Mobile Bundle 5!</a></li>
<li><a href="../219523/index.html">Your best friend, anonymous</a></li>
<li><a href="../219525/index.html">Samsung made a discovery that could turn the entire consumer electronics industry</a></li>
<li><a href="../219533/index.html">Ratchet 2.0 - the most beautiful HTML5 framework is now friendly with both iOS and Android</a></li>
<li><a href="../219535/index.html">PassportVision - an easy way to recognize documents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>