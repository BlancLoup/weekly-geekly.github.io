<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make preview sites in the style of Yandex Browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost two months have passed since Yandex has pleased some users with a new product - Yandex Browser. Despite the incredible dynamics in the developm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make preview sites in the style of Yandex Browser</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/4b9/ae7/4d1/4b9ae74d167ec93be33ef35976d5bb92.png" alt="yandex browser">  Almost two months have passed since Yandex has pleased some users with a new product - Yandex Browser.  Despite the incredible dynamics in the development of products in this area (Chrome and Firefox), Yandex managed to bring a number of new ideas into its browser. <br><br>  Of all the features of this browser, most of all I was hooked by their design decision regarding the images of sites in ‚Äúspeed bookmarks‚Äù (Speed ‚Äã‚Äãdial).  People love with their eyes and therefore it is nice to see in their new tabs not a blank white page, but colorful pictures.  The only trouble is that I personally, most often, look at the caption under this picture or on the favicon, since it can be very difficult to recognize it from the screenshot of the site.  Designers of Yandex, in my opinion, decided this problem very elegantly.  In this post we will look at how to implement this idea on the client side. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The essence of the idea is as follows: <br><br><ol><li>  We get a favicon site </li><li>  Determine the dominant favicon color </li><li>  Draw a rectangle with the dominant color and insert a favicon into it </li><li>  For greater attractiveness, a gradient is superimposed above. </li></ol><br>  It sounds really very simple.  The most difficult moment here is the definition of the dominant color in favicon.  To do this, we need to solve three problems: <br><br><ol><li>  Get favicon. </li><li>  Get access to the value of each pixel of the image. </li><li>  Decide on the algorithm for determining the dominant color. </li></ol><br><br><h4>  Getting favicon </h4><br>  In order to get a favicon, you can either write a handler on the server that will search and return a favicon for the domain, or you can see how the Yandex browser does it ... And it does this with the help of a request for the same-name service Yandex.  For example, such a request: <br><br> <code><a href=""></a> GET favicon.yandex.net/favicon/habrahabr.ru</code> <br> <br>  Will return here such a picture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d20/dcf/ccd/d20dcfccdc9d0ebc6907486e89994be4.png" alt="image"></div><br><br><h4>  Access to image pixels </h4><br>  Regarding the second task, the only way to access the pixel values ‚Äã‚Äãof the image on the client side is to use the element.  Having loaded the image in canvas we will be able to receive value of any pixel. <br><br>  However, there is some problem.  Accessing image pixels using the canvas tag is possible only for those images that are loaded from the same domain as the page that processes them (cross-domain browser policy works). <br><br>  Thus, to use the canvas element to search for the dominant color in favicon, you need to create a proxy on your server that download favicon (for example, from favicon.yandex.ru service) and return it back to you on the page. <br><br>  In this regard, the implementation of such a preview of sites purely on the client side, alas, will not work.  In fact, since we still need a server as a proxy for images, we could transfer the dominant color to the server and get the color, not the icon, back to the page.  However, how to implement this on the server side is not so interesting and very heterogeneous, since depending on the language used on the server (Python, PHP, Java), the implementation will be different.  Therefore, we will look at how to do this on the client using the canvas element. <br><br><h4>  Algorithm for determining the dominant color </h4><br>  There are many algorithms for determining the dominant color image.  The general idea of ‚Äã‚Äãthese algorithms is as follows.  Each pixel of the image is a quadruple of numbers R, G, B, A. We go through all the pixels and in a special way analyze their components: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   canvas var canvas = document.createElement('canvas'); var ctx = canvas.getContext('2d'); //   canvas  favicon ctx.drawImage( faviconImage, 0, 0, 18, 18); //     var data = ctx.getImageData(0, 0, 18, 18); //    for ( i = 0; i&lt;data.data.length; i=i+4 ) { rgb = {}; rgb.r = data.data[i]; rgb.g = data.data[i + 1]; rgb.b = data.data[i + 2]; }</span></span></code> </pre><br><br>  In our case, the implementation should take into account two features: <br><br>  I. Many favicons have transparent pixels that, when drawn to the canvas element, are represented as rgba (0, 0, 0, 0).  Since we ignore the alpha channel, for us these pixels will look like black (# 000000), which is not true.  To fix this, just paint the canvas in white before drawing a favicon on it. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  canvas   ctx.fillStyle = 'rgb(255, 255, 255)'; ctx.fillRect(0, 0, 18, 18); //  favicon ctx.drawImage( faviconImage, 0, 0, 18, 18);</span></span></code> </pre><br><br>  Ii.  Since the favicon is intended to fit into a white circle, if the predominant color in the image is white, we will not see either the circle or the borders of our element.  To avoid this, we will simply ignore the white pixels in each algorithm. <br><br>  I will consider three different algorithms for determining the dominant color by increasing their complexity. <br><br><h5>  Algorithm 1. Average color value </h5><br>  The first and most simple algorithm is as follows.  We simply go through all the pixels and count the arithmetic average of the corresponding colors.  In order not to overload the article with code - all source codes are available on <a href="https://github.com/krustnic/site-preview-yandex-style/blob/master/mainColor.html">gihub</a> , I will only show the results of their work: <br><br><img src="https://lh3.googleusercontent.com/-YiGM7iq880Y/UK3g95_yoqI/AAAAAAAAA7Y/THWqR6clMTU/avg.png" alt="image"><br><br><h5>  Algorithm 2. Euclidean distance </h5><br>  This algorithm is a little more complicated and is as follows.  Each color is a vector in three-dimensional space (r, g, b).  We traverse each pixel and count its distance to all other pixels (Euclidean distance between two vectors).  Then we look for the pixel that is closest to everything else.  The color of this pixel is our desired color.  It should be noted here that this algorithm, unlike the previous one, does not create a new color, but only selects from those already existing in this image. <br><br><img src="https://lh3.googleusercontent.com/-ZlkVvE8jZ44/UK3lPThs_II/AAAAAAAAA7o/V13_tEFD06E/evclid.png" alt="image"><br><br><h5>  Algorithm 3. The k-means clustering method </h5><br>  The essence of this algorithm is as follows.  Randomly selected k pixels (centers) of the image of a different color.  We pass through all the other pixels and assign each of them to one of the centers on the basis of their proximity to each other (we consider the Euclidean distance as in algorithm 2).  Then we recalculate the centers - we set for them a value equal to the average among all the pixels assigned to it (as in Algorithm 1).  Again we go through all the pixels and distribute them to the new centers.  We do all this until the value of the centers stops changing.  The desired color will be the center value with the most pixels.  It should be noted that this method is used for <a href="http://www.quora.com/Google-Chrome/How-does-Chrome-pick-the-color-for-the-stripes-on-the-Most-visited-page-thumbnails">the same purpose</a> in the Chrome browser.  The result of his work for k = 3 is as follows: <br><br><div style="text-align:center;"><img src="https://lh3.googleusercontent.com/-VC2LGhSDfRs/UK3rRgDnGrI/AAAAAAAAA8I/FHKIzr4ETWQ/kcluster-3.png" alt="image"></div><br><br>  For k = 5: <br><br><div style="text-align:center;"><img src="https://lh5.googleusercontent.com/-mkpmdH43L9E/UK3oAoPxBXI/AAAAAAAAA74/DTkJp131bJw/kcluster.png" alt="image"></div><br><br>  (for the remaining values ‚Äã‚Äãof the parameter k, the results are not so indicative) <br><br><h4>  Conclusion </h4><br>  The question of which of these algorithms is better is controversial. <br><br><ul><li>  The average algorithm is incredibly simple and generally works, but it can give a rather dirty result. </li><li>  Calculation through Euclidean distance, for my taste, gives a rather nice result and at the same time is easy to implement. </li><li>  The clustering algorithm is the most complex.  Gives the most vivid image and requires the most calculations. </li></ul><br><br>  PS Github-user static-lab proposed and implemented another algorithm "YUV averaged with contrast", which also gives a very good result: <br><br><img src="https://lh6.googleusercontent.com/-ioAMz4zU-fE/UK_e-TrJc_I/AAAAAAAAA9U/aRbfOnLMbyU/yuv.png" alt="image"><br><br>  The example can be run in your browser (favicons encoded in Base64): <a href="http://jsfiddle.net/krustnic/Vg3Dg/">DEMO</a> <br>  Sources here: <a href="https://github.com/krustnic/site-preview-yandex-style/blob/master/mainColor.html">github</a> </div><p>Source: <a href="https://habr.com/ru/post/159961/">https://habr.com/ru/post/159961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159949/index.html">offtopic Instructions for creating notes from kar files</a></li>
<li><a href="../159951/index.html">How often do you use programs to "clean" the system on your desktop?</a></li>
<li><a href="../159953/index.html">Virtual prototyping in Linux with examples</a></li>
<li><a href="../159955/index.html">How to get a job at Google</a></li>
<li><a href="../159957/index.html">Game for Kinect, nothing better to do</a></li>
<li><a href="../159965/index.html">IClebo Arte and Neato XV-21 vacuum cleaning robots - comparison based on experience</a></li>
<li><a href="../159971/index.html">Pair and magnetic resonances on fingers and their use</a></li>
<li><a href="../159973/index.html">Dirty, clean, aspiring</a></li>
<li><a href="../159977/index.html">We invite to work secret agents</a></li>
<li><a href="../159979/index.html">Level Up in Project Management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>