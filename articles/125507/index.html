<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>.NET A piece of truth about the placement of objects at run-time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, in .NET memory is divided into two categories: the stack (Stack) and the managed heap (managed heap, then just a heap). On the stack is a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>.NET A piece of truth about the placement of objects at run-time</h1><div class="post__text post__text-html js-mediator-article">  As you know, in .NET memory is divided into two categories: the stack (Stack) and the managed heap (managed heap, then just a heap).  On the stack is a link (ObjectRef) to the object (ObjectInstance), which, in turn, is located on the heap. <br><br>  This article will focus on the location of the object in the heap. <br><br>  It is assumed that the reader has knowledge of: <br>  1. stack <br>  2. managed heap <br>  3. GC <br>  4. Weak references <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>ObjectInstance</b> </h5><br>  <b>ObjectInstance</b> is a data structure (object) located at the address pointed to by ObjectRef. <br>  Instances of significant types can be stored: <br>  1. in the thread stack <br>  2. in GC Heap. <br>  Instances of reference types, depending on their size, can be stored: <br>  1. in the Garbage Collector Heap (objects up to 85,000 bytes in size) <br>  2. in Large Object Heap (objects larger than 85000 bytes) <br><br><img title="Sample object instance structure" alt="   " src="http://mu.cosmostv.by/habr/ObjectInstance/1.png"><br><br>  <b>Figure 1. Sample object instance structure</b> <br><br>  As can be seen in Figure 1, ObjectInstance contains the following fields: <br>  1. Object Header <br>  2. Type Handle (consideration of this field is beyond the scope of the article) <br>  3. Object instance fields <br>  4. Links to string literals <br><br><h5>  <b>Object header</b> </h5><br>  Take another look at Figure 1. As you can see, the ObjectRef points to an address that is offset by 4 bytes from the beginning of ObjectInstance.  This is done for optimization - the Object Header contains information that is not used as often as the other fields of an object instance. <br>  This field contains the cell number in the Sync Block Entry Table.  Number is counted from one.  If the lock statement or the GetHashCode () method has never been used for ObjectInstance, then the 0 0 will be stored in the Object Header cell. <br>  Since the Sync Block Entry Table and ObjectInstance are linked by index, the CLR can freely change the size of this table in memory. <br>  The cell of the Sync Block Entry Table, the index of which is contained in the Object Header, in turn contains a weak reference to the same ObjectInstance - this is done so that the CLR can track the owner of this cell (for example, to synchronize threads). <br>  Also, this cell contains a reference to the SyncBlock object in the SyncBlock List structure.  SyncBlock contains useful but rarely used information: <br>  1. Information about locking (thunking) <br>  2. AppDomain Index <br>  3. Data on object blocking <br>  4. Hash code <br><br>  Consider an example.  Given code: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { //,   } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> <font color="#2b91af">Sample</font> { <font color="#2b91af">TestClass</font> sync = <font color="#0000ff">new</font> <font color="#2b91af">TestClass</font> (); <font color="#0000ff">void</font> Main() { <font color="#0000ff">lock</font> (sync) { <font color="#008000">//,  </font> } sync.GetHashCode(); } }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In line 3, the sync object contains the value 0 in the Object Header field. Next, in line 7, the field value changes and becomes nonzero.  This is due to the fact that the CLR creates a SyncBlock object in the SyncBlock List and places the index of the record in the Object Header.  On line 11, the hash code value is placed in the SyncBlock object. <br>  Consideration of the remaining fields of the SyncBlock object is beyond the scope of this article. <br><br><h5>  <b>Object instance fields and string literals</b> </h5><br>  For Type Handle is a list of fields of the instance, the length of which is different.  By default, the fields of the instance are arranged so that the memory is used efficiently and the gaps between the fields are minimal. <br>  Listing 1 shows the SimpleClass class, which declares several instance variables of different sizes. <br><table border="1"><tbody><tr><td>  Listing 1 </td></tr><tr><td><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> <font color="#2b91af">SimpleClass</font> </li><li>  { </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">byte</font> b1 = 1;  <font color="#008000">// 1 byte</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">byte</font> b2 = 2;  <font color="#008000">// 1 byte</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">byte</font> b3 = 3;  <font color="#008000">// 1 byte</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">byte</font> b4 = 4;  <font color="#008000">// 1 byte</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">char</font> c1 = <font color="#A31515">'A'</font> ;  <font color="#008000">// 2 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">char</font> c2 = <font color="#A31515">'B'</font> ;  <font color="#008000">// 2 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">short</font> s1 = 11;  <font color="#008000">// 2 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">short</font> s2 = 12;  <font color="#008000">// 2 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">int</font> i1 = 21;  <font color="#008000">// 4 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">long</font> l1 = 31;  <font color="#008000">// 8 bytes</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">string</font> str = <font color="#A31515">"MyString"</font> ;  <font color="#008000">// 4 bytes (this is only OBJECTREF)</font> </li><li></li><li>  <font color="#008000">// The total size of the instance fields is 28 bytes</font> </li><li>  <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main () </li><li>  { </li><li>  <font color="#2b91af">SimpleClass</font> simpleObject = <font color="#0000ff">new</font> <font color="#2b91af">SimpleClass</font> (); </li><li>  <font color="#0000ff">return</font> ; </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote></td></tr></tbody></table><br><br><img title="Memory window for SimpleClass Object Instance" alt="   SimpleClass Object Instance" src="http://mu.cosmostv.by/habr/ObjectInstance/2.png"><br><br>  <b>Figure 2. Memory window for SimpleClass Object Instance</b> <br><br>  In fig.  Figure 2 shows what an instance of the SimpleClass object looks like in the memory window. <br>  Before opening the Debugger Memory Window (Debug-&gt; Windows-&gt; Memory-&gt; Memory1), the breakpoint was set on the return statement.  Then, at the simpleObject address contained in the ECX register, the address of the object instance for which you need to look at the memory dump was determined. <br>  1. The first 4-byte block is the syncblk number.  Since we did not write the synchronization code for this object (and did not access its hash code), this number is 0. <br>  2. A reference to an object stored in the variable simpleObject placed on the stack indicates 4 bytes, the beginning of which is at offset 4. <br>  3. Next comes the eight-byte value of the variable l1 in memory. <br>  4. The variable str of type String is represented by a 4-byte ObjectRef reference pointing to an instance of a string hosted in the GC Heap. <br>  5. A variable i1 of type int is placed next, occupying 8 bytes. <br>  6. Two variables of type char - c1 and c2 - are arranged side by side. <br>  7. Two variables of the type short - s1 and s2 - are also located side by side. <br>  8. Variables b1, b2, b3 and b4 of the type Byte are packed in a DWORD and arranged side by side. <br>  By default, object members are not necessarily placed in memory in the order in which they are declared in the source code. <br>  In order to keep their lexical sequence when placing fields in memory, the StructLayoutAttribute attribute must be applied.  The attribute takes as input a LayoutKind enumeration that has the following values: <br>  1. Sequential - The members of the object are arranged sequentially, in the order of their appearance when exported to unmanaged memory. <br>  2. Explicit - The exact position of each member of an object in unmanaged memory is explicitly controlled.  Each member must use the FieldOffsetAttribute attribute to indicate the position of this field within the type. <br>  3. Auto - The CLR automatically selects the appropriate location for object members in unmanaged memory.  Access to objects defined by this enumeration member cannot be granted outside of managed code.  An attempt to perform such an operation will cause an exception. <br><br>  Having examined the unstructured contents of the memory, we examine the object instance using the Son of Strike (SOS) utility. <br>  Moving the project to unmanaged debug mode (Properties-&gt; Debug-&gt; Enable unmanaged code debugging), and opening the Immediate Window (ctrl + alt + I), we will execute the following commands: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  .load sos </li><li>  ! DumpHeap -type SimpleClass </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  As a result of the output, we obtain the contents of all the heaps and all instances of the specified type: <br><br><img title="Result of the &quot;! DumpHeap -type SimpleClass&quot; Command" alt="  ¬´!DumpHeap -type SimpleClass¬ª" src="http://mu.cosmostv.by/habr/ObjectInstance/3.png"><br><br>  <b>Figure 3. The result of the "! DumpHeap -type SimpleClass" command</b> <br><br>  As can be seen from Figure 3, the object size is 36 bytes.  These 36 bytes are: <br>  1. The SimpleClass instance fields are 28 bytes (the length of the string does not matter, since the SimpleClass instance contains only a reference to the literal table, 4 bytes in size.). <br>  2. The remaining 8 bytes are contained in Object Header (4 bytes) and Type Handle (4 bytes). <br><br>  We learned the address of the instance of simpleObject, now let's dump the contents of this instance with the command "! DumpObj 0x0214ba30": <br><br><img title="Result of the command! DumpObj 0x0214ba30" alt="  !DumpObj 0x0214ba30" src="http://mu.cosmostv.by/habr/ObjectInstance/4.png"><br><br>  <b>Figure 4. The result of the "! DumpObj 0x0214ba30" command</b> <br><br>  The C # compiler uses LayoutType.Auto for class members by default; therefore, the class loader can arrange fields as it sees fit to minimize gaps between fields. <br><br>  Materials: <br>  <a href="http://msdn.microsoft.com/en-us/magazine/cc163791.aspx">MSDN</a> </div><p>Source: <a href="https://habr.com/ru/post/125507/">https://habr.com/ru/post/125507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125501/index.html">Video: Igor Ashmanov about the crisis, crooks and snails</a></li>
<li><a href="../125502/index.html">Import photos from Picasa and Flickr into albums VKontakte</a></li>
<li><a href="../125503/index.html">Explosive Friday and the Social App per Day</a></li>
<li><a href="../125505/index.html">Local Area Network LED (800 Mbps)</a></li>
<li><a href="../125506/index.html">Intervalometer for SONY NEX-5 for 20 minutes and $ 0</a></li>
<li><a href="../125510/index.html">Asynchronous loading in iOS</a></li>
<li><a href="../125511/index.html">Debugging mobile sites with Dashcode</a></li>
<li><a href="../125512/index.html">Asterisk + UniMRCP + VoiceNavigator. Synthesis and speech recognition in Asterisk. Part 3</a></li>
<li><a href="../125516/index.html">Android captured almost half of the global smartphone market</a></li>
<li><a href="../125517/index.html">Social games: dreams or reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>