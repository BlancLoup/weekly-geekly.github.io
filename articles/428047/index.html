<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of the performance of WSGI-servers: return uWSGI to the place</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last week, a translation of a two-year-old article on the performance analysis of WSGI servers was published : Part Two , where it was undeservedly de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of the performance of WSGI-servers: return uWSGI to the place</h1><div class="post__text post__text-html js-mediator-article"><p>  Last week, a translation of a two-year-old article on the <a href="https://habr.com/post/427217/">performance analysis of WSGI servers</a> was published <a href="https://habr.com/post/427217/">: Part Two</a> , where it was undeservedly deprived of the glory of uWSGI. </p><br><p>  It is urgent to double-check the tests! </p><br><p><img src="https://habrastorage.org/webt/nq/8d/mj/nq8dmje1vzgpvfevzxuz1xlitbw.png"></p><a name="habracut"></a><br><h1 id="celi">  Goals </h1><br><p>  I have been using uWSGI for a long time, and I want to show that it is not as bad as described in the 2016 tests. <br>  Initially, I just wanted to reproduce the tests, and figure out what was wrong with uWSGI. <br>  There are no versions of used packages and modules in the <a href="https://github.com/omedhabib/WSGI_Benchmarks">code</a> . </p><br><p>  Therefore, to run tests and get similar results does not work. <br>  Next, my quest, to run the tests and compare the results on the charts. <br>  At the request of readers, added NginX Unit. </p><br><h1 id="shagi">  Steps </h1><br><h2 id="wrk-410">  wrk 4.1.0 </h2><br><p>  Find <a href="https://github.com/GetPageSpeed/wrk-rpm">specs</a> , <a href="https://github.com/GetPageSpeed/wrk-rpm/pull/2">patch</a> , <a href="https://copr.fedorainfracloud.org/coprs/vorona/wrk/packages/">collect</a> <br>  Information added to readme.rd. </p><br><h2 id="docker-stats">  docker stats </h2><br><p>  For 2 years, the output of statistics has changed. </p><br><p> A second column, <code>NAME</code> , was added, and this broke the statistics parser. </p><br><p>  In order not to meet a similar problem in two years, we will use a formatted output: </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- docker stats &gt; "$BASE/$1.$2.stats" &amp; + docker stats --format "{{.CPUPerc}} {{.MemUsage}}" &gt; "$BASE/$1.$2.stats" &amp;</span></span></code> </pre> <br><p>  And accordingly, let's slightly simplify the parser code. </p><br><h2 id="debian">  debian </h2><br><p>  Now the <em>latest</em> debian image is version <em>9.5</em> , display it in the Dokerfile: </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- FROM debian + FROM debian:9.5</span></span></code> </pre> <br><p>  In April 2016 <em>latest</em> <a href="https://hub.docker.com/r/library/debian/tags/">corresponded</a> to version 8.4 </p><br><p>  Nevertheless, Apache remained almost the same: now the version of Apache 2.4.25, and in 2016 it was Apache 2.4.10. </p><br><h2 id="cherrypy-tornado-uwsgi-gunicorn-bjoern-meinheld-mod_wsgi">  cherrypy tornado uwsgi gunicorn bjoern meinheld mod_wsgi </h2><br><p>  It even makes no sense to say that the modules have changed. <br>  We indicate the current version: </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- RUN pip install cherrypy tornado uwsgi gunicorn bjoern meinheld mod_wsgi + RUN pip install cherrypy==17.4.0 \ + uwsgi==2.0.17.1 \ + gunicorn==19.9.0 \ + bjoern=2.2.3 \ + meinheld==0.6.1 \ + mod_wsgi==4.6.5</span></span></code> </pre> <br><p>  What is there doing tornado, where is running a wsgi file to run tornado?  Remove the artifact. <br>  It would not be bad to put it in separate requirements.txt, but for now let's leave it that way. </p><br><h2 id="cherrypy---cherootwsgi">  cherrypy -&gt; cheroot.wsgi </h2><br><p>  As shown above, the current version is 17.4.0. <br>  In April 2016, version v5.1.0 was probably used. <br>  And in 2017, in version <a href="http://docs.cherrypy.org/en/latest/history.html">9.0</a> there were changes, which affected the import of the server: </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- from cherrypy import wsgiserver - server = wsgiserver.CherryPyWSGIServer( + from cheroot.wsgi import Server as WSGIServer + server = WSGIServer(</span></span></code> </pre> <br><h1 id="socket-errors-read-100500">  Socket errors: read 100500 </h1><br><p>  After the edits described above, the first full test was launched. <br>  The results were good: uwsgi did not give out 3 ... 200, but 7500 ... 5000 requests per second. <br>  But when we looked at the graphs in detail, it turned out that all the responses of <em>wrk were</em> detected as read errors. </p><br><p>  After checking a dozen keys for launching uwsgi, it turned out that there were no errors when http1.1 was enabled: <em>--http-keepalive</em> and <em>--http11-socket</em> . <br>  Moreover, the first one gives 7500 ... 5000 requests per second, and the second one is stable 29 thousand! </p><br><h1 id="chto-zhe-izmenilos-v-uwsgi-na-dannyy-moment">  what has changed in uWSGI at the moment </h1><br><p>  Most likely, in August 2016, the version uWSGI 2.0.12 (20151230) was used. <br>  After, in May, <a href="https://uwsgi-docs.readthedocs.io/en/latest/Changelog-2.0.13.html">uWSGI 2.0.13 was released</a> . </p><br><p>  It was a significant event, but this did not solve the performance problem according to <em>wrk</em> until 2018, with the release of <a href="https://uwsgi-docs.readthedocs.io/en/latest/Changelog-2.0.16.html">uWSGI 2.0.16</a> : </p><br><blockquote>  Back-ported HTTP / 1.1 support (--http11-socket) from 2.1 </blockquote><p>  This is why uWSGI recommended using with NginX, <br>  And why this is important in the framework of the article can be understood from this 2012 <a href="https://github.com/wg/wrk/issues/13">ticket</a> . </p><br><h1 id="pochemu-togda-byli-takie-rezultaty">  Why then were these results </h1><br><p>  I tried these versions: </p><br><ul><li>  2.0.12 for debian 8.4, on the nine it is not collected because of the fresh openssl. </li><li>  2.0.13 ... 2.0.17 for debian 8.4 and 9.5 </li></ul><br><p>  But I could not get such bad results as 3 ... 200 requests per second. <br>  Attention attracted the application launch line: </p><br><blockquote>  uwsgi --http: 9808 --plugin python2 --wsgi-file app.py --processes ... </blockquote><p>  Specifying the plug-in that says it installs uwsgi from the repository, not pip. <br>  This may indicate that the author does not have the necessary experience with this stack. </p><br><p>  Therefore, I admit several possibilities: </p><br><ul><li>  The test of each of the uwsgi-servers was performed separately, at different times. </li><li>  there was some conflict between the uwsgi system version, and the one installed via pip. </li><li>  wrk version of the author in 2016, had some features to work on http1.0 </li><li>  uwsgi started with a different set of parameters </li><li>  custom article numbers from the ceiling. </li></ul><br><h1 id="kakie-rezultaty-seychas">  What are the results now </h1><br><p>  There are several uWSGI diagrams: <br>  The first two <em>uWSGI</em> and <em>uWSGIbase</em> (v2.0.17.1), were performed in a long test, with their competitors, with parameters: <br>  <code>--http11 :9808 --processes 5 --threads 2 --enable-threads</code> . <br>  <code>--http11 :9808 --processes 5</code> . <br>  As practice has shown, there is NO qualitative difference for a dummy application test. </p><br><p>  And, separately, versions and uWSGI 2016: <br>  uWSGI-v2.0.12th-old and uWSGI-v2.0.12nt-old are respectively v2.0.12 with threads and without in a debian 8.4 container. <br> <code>--http :9808 --http-keepalive --processes 5 --threads 2 --enable-threads</code> <br> <code>--http :9808 --http-keepalive --processes 5</code> </p> <br><p><img src="https://habrastorage.org/webt/jz/vd/fw/jzvdfwrebe8h8u57t7dydpszmbq.png" alt="RPS 2018 ALL"><br>  uWSGI takes 2nd place, without reducing the results with increasing load. <br>  In third place - NginX Unit. </p><br><p><img src="https://habrastorage.org/webt/80/cg/8b/80cg8b29zqffaau3kcby-hfpcyq.png" alt="RPS 2018 LOW"><br>  In the low-segment uWSGI-v2.0.12 best of all, even with increasing load. </p><br><p><img src="https://habrastorage.org/webt/zh/wi/af/zhwiafqrpt-qwfs6spiluqg7kj0.png" alt="LATENCIES 2018 ALL"><br>  <em>Here we see how Unit didn‚Äôt show itself from the best side.</em> </p><br><p><img src="https://habrastorage.org/webt/z6/yo/sk/z6yoskrszxuarzdlx2bcgo1hagk.png" alt="LATENCIES 2018 LOW"><br>  <em>uWSGI and CherryPy are undoubted latency winners.</em> </p><br><p><img src="https://habrastorage.org/webt/p2/x7/l-/p2x7l-kqjmr92fot8qa3ub4dqi8.png"><br>  <em>This picture is similar to the 2016th year.</em> </p><br><p><img src="https://habrastorage.org/webt/jx/be/at/jxbeat9znsmwv6gmaxkri8stxpo.png"><br>  <em>Here we see how the old uWSGI ate the memory with increasing load.</em> <br>  Unit also linearly increases memory consumption. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c3a/7b2/82c/c3a7b282c58c2baa0e4e91359b93ab83.png"><br>  <em>A new uWSGI, gunicorn, mod_wsgi - confidently "keep the bar", and that says a lot.</em> </p><br><p><img src="https://habrastorage.org/webt/rv/wu/fk/rvwufkagkiqf8faajvnyge2y_vk.png"><br>  The old uWSGIs start picking up mistakes after 300 open connections. </p><br><p><img src="https://habrastorage.org/webt/9g/ac/nf/9gacnfewpynu_1kwvifoo7yyjia.png"><br>  Unit and CherryPy - no mistakes! <br>  Bjoern starts donating with 1000 connections. <br>  But with the new uWSGI weirdness, starting 200 connections, we get 50 errors, and the number no longer increases.  This moment requires detailed consideration. </p><br><p>  All data is collected <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSTmHtegrA2mKYb-yam00ii_cTq7rvVqLk0cSXVoovQCboTOBJYdQMnTx4KshyMsmuj4qrirbskMTav/pubhtml">here.</a> <br>  All code changes can be seen in <a href="https://github.com/omedhabib/WSGI_Benchmarks/pull/2">RP</a> . </p><br><h1 id="vyvody">  findings </h1><br><p>  uWSGI is not so bad, or even very good! <br>  If you do not like the results of the WRK tests, try using other tools. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/428047/">https://habr.com/ru/post/428047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428035/index.html">Red Hat will be absorbed by IBM</a></li>
<li><a href="../428039/index.html">Government does not plan to legally protect network neutrality</a></li>
<li><a href="../428041/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ336 (October 22 - 28, 2018)</a></li>
<li><a href="../428043/index.html">Waiting for the sixth, Winamp 5.8: the ‚Äúmystery‚Äù of origin, the possibilities of the official version</a></li>
<li><a href="../428045/index.html">PHP Digest number 142 (October 15 - 29, 2018)</a></li>
<li><a href="../428051/index.html">How to make even more incorrect states even more inexpressible</a></li>
<li><a href="../428053/index.html">How to create a testing strategy: the version of real engineers</a></li>
<li><a href="../428055/index.html">Retrospective of technology startups. Z3 - the first relay computer</a></li>
<li><a href="../428057/index.html">A new look at documenting API and SDK in Yandex. Lecture on Hyperbaton</a></li>
<li><a href="../428059/index.html">Connecting Multipath LUN storage to VMware ESXi and Debian GNU / Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>