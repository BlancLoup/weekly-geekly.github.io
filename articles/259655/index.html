<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write chat for the local network using C ++ Builder. Client part</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 This is a continuation of the article , in which I will talk about creating a client for my chat. 

 I spent much more time for the clien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write chat for the local network using C ++ Builder. Client part</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  This is a continuation of the <a href="http://habrahabr.ru/post/259641/">article</a> , in which I will talk about creating a client for my chat. <br><a name="habracut"></a><br>  I spent much more time for the client part of the server, since there is a second important component here - the graphic part. <br><br>  Customer design is very simple, even primitive.  I did not see the point in creating a menu bar in the application.  There are 2 panels on the form, one of them changes color, if the client is connected to the server it is green, otherwise it is red.  The next panel is the TabControl.  I tried 5 or 6 variants of the application design, and found the most convenient use of the TabControl component.  In its tabs, the names of users who are online are entered; when selecting the appropriate tab, correspondence with this user begins (the message history is also displayed).  Messages are displayed in the Memo component, you need to write messages in the Edit component, sending - by pressing the corresponding button or the Enter key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The client also has minimized windows in the notification area. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall TFormMain::DrawItem(TMessage&amp; Msg) { IconDrawItem((LPDRAWITEMSTRUCT)Msg.LParam); TForm::Dispatch(&amp;Msg); } <span class="hljs-comment"><span class="hljs-comment">//--------------------------------------------------------------------------- void __fastcall TFormMain::MyNotify(TMessage&amp; Msg) { POINT MousePos; switch(Msg.LParam) { case WM_RBUTTONUP: if (GetCursorPos(&amp;MousePos)) { PopupMenu1-&gt;PopupComponent = FormMain; SetForegroundWindow(Handle); PopupMenu1-&gt;Popup(MousePos.x, MousePos.y); } else Show(); break; case WM_LBUTTONDBLCLK: Show(); break; default: break; } TForm::Dispatch(&amp;Msg); } //--------------------------------------------------------------------------- //--------------------------------------------------------------------------- bool __fastcall TFormMain::TrayMessage(DWORD dwMessage) { NOTIFYICONDATA tnd; PSTR pszTip; pszTip = TipText(); tnd.cbSize = sizeof(NOTIFYICONDATA); tnd.hWnd = Handle; tnd.uID = IDC_MYICON; tnd.uFlags = NIF_MESSAGE | NIF_ICON | NIF_TIP; tnd.uCallbackMessage = MYWM_NOTIFY; if (dwMessage == NIM_MODIFY) { tnd.hIcon = (HICON)IconHandle(); if (pszTip) lstrcpyn(tnd.szTip, pszTip, sizeof(tnd.szTip)); else tnd.szTip[0] = '\0'; } else { tnd.hIcon = NULL; tnd.szTip[0] = '\0'; } return (Shell_NotifyIcon(dwMessage, &amp;tnd)); } //--------------------------------------------------------------------------- HICON __fastcall TFormMain::IconHandle(void) { return (Image2-&gt;Picture-&gt;Icon-&gt;Handle); } //--------------------------------------------------------------------------- PSTR __fastcall TFormMain::TipText(void) { return ("Office Chat"); } //--------------------------------------------------------------------------- LRESULT IconDrawItem(LPDRAWITEMSTRUCT lpdi) { return 0; } //--------------------------------------------------------------------------- //--------------------------------------------------------------------------- void __fastcall TFormMain::FormDestroy(TObject *Sender) { TrayMessage(NIM_DELETE); } //--------------------------------------------------------------------------- void __fastcall TFormMain::N1Click(TObject *Sender) { Show(); } //--------------------------------------------------------------------------- void __fastcall TFormMain::N2Click(TObject *Sender) { Application-&gt;Terminate(); } //--------------------------------------------------------------------------- void __fastcall TFormMain::FormCloseQuery(TObject *Sender, bool &amp;CanClose) { CanClose=false; FormMain-&gt;Hide(); } //---------------------------------------------------------------------------</span></span></code> </pre> <br>  When a new message arrives, a pleasant sound is played. <br><br>  For all work with the network meets the standard component ClientSocket.  The client, as well as the server, accepting messages first of all separates the first 4 characters from them.  Then it is determined what to do next.  Everything happens in the OnRead event. <br><br>  Code 4796 means that the client should send his name to the "registration" on the server. <br><br>  7788 - one of the most important codes, it is placed at the beginning of the incoming message.  This separates the sender's name and the message itself.  Next comes a check on the state of the client window.  If the tab with the message sender's dialog is open, the message is simply added to the new Memo line, at the beginning the time of receipt of the message is added.  If the tab of correspondence with another user is open, the sound is played and in the tab with the desired user, the inscription "+1" is added after the name.  When you go to this tab, the inscription is removed.  If the application window is minimized, a context menu pops up with two options: close the menu and go to the correspondence.  The menu is called on all computers in the same place - the upper right corner.  For this, the monitor resolution is determined.  In any case, the message along with the time of receipt is entered in the file.  For each user there is a correspondence file, from which the history of correspondence is taken. <br><br>  8714 - it means it's time to update the list of users in TabControl. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall TForm1::ClientSocketRead(TObject *Sender, TCustomWinSocket *Socket) { AnsiString str=Now().CurrentDateTime(); message=Socket-&gt;ReceiveText(); AnsiString recieveText=message; AnsiString Text=recieveText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(message.SubString(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>).AnsiCompare(<span class="hljs-string"><span class="hljs-string">"4796"</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { ClientSocket-&gt;Socket-&gt;SendText(<span class="hljs-string"><span class="hljs-string">"6141"</span></span>+myname); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(message.SubString(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>).AnsiCompare(<span class="hljs-string"><span class="hljs-string">"7788"</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TabControl1-&gt;Tabs-&gt;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> [](TabControl1-&gt;TabIndex).AnsiCompare(message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)<span class="hljs-number"><span class="hljs-number">-5</span></span>))==<span class="hljs-number"><span class="hljs-number">0</span></span>) { ListBox-&gt;Lines-&gt;Add(str+<span class="hljs-string"><span class="hljs-string">" "</span></span>+message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Length())); file(message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)<span class="hljs-number"><span class="hljs-number">-5</span></span>),message.SubString(message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>,message.Length()),Now().CurrentDateTime(),<span class="hljs-string"><span class="hljs-string">"in"</span></span>); PlaySound(<span class="hljs-string"><span class="hljs-string">"message.wav"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,SND_ASYNC); PopupMenu2-&gt;PopupComponent = Form1; PopupMenu2-&gt;Popup(GetSystemMetrics(SM_CXSCREEN)<span class="hljs-number"><span class="hljs-number">-200</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TabControl1-&gt;Tabs-&gt;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> [](TabControl1-&gt;TabIndex).AnsiCompare(message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)<span class="hljs-number"><span class="hljs-number">-5</span></span>))!=<span class="hljs-number"><span class="hljs-number">0</span></span>) { PlaySound(<span class="hljs-string"><span class="hljs-string">"message.wav"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,SND_ASYNC); AnsiString im; AnsiString mess; im=message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)<span class="hljs-number"><span class="hljs-number">-5</span></span>); mess=message.SubString(message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>,message.Length()); file(im,mess,Now().CurrentDateTime(),<span class="hljs-string"><span class="hljs-string">"in"</span></span>); AnsiString name=message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Pos(<span class="hljs-string"><span class="hljs-string">":"</span></span>)<span class="hljs-number"><span class="hljs-number">-5</span></span>); active=TabControl1-&gt;TabIndex; count=TabControl1-&gt;Tabs-&gt;Count; AnsiString n; TabControl1-&gt;Tabs-&gt;Clear(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;count;i++) { n=m[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n.AnsiCompare(name)!=<span class="hljs-number"><span class="hljs-number">0</span></span>) TabControl1-&gt;Tabs-&gt;Add(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n.AnsiCompare(name)==<span class="hljs-number"><span class="hljs-number">0</span></span>) TabControl1-&gt;Tabs-&gt;Add(n+<span class="hljs-string"><span class="hljs-string">"+1"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(message.SubString(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>).AnsiCompare(<span class="hljs-string"><span class="hljs-string">"8714"</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { TabControl1-&gt;Tabs-&gt;Clear(); AnsiString str=message.SubString(<span class="hljs-number"><span class="hljs-number">5</span></span>,message.Length()); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> separator[]=<span class="hljs-string"><span class="hljs-string">","</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *Ptr=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; Ptr=strtok(str.c_str(),separator); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Ptr) { <span class="hljs-comment"><span class="hljs-comment">//if(myname.AnsiCompare(Ptr)!=0) TabControl1-&gt;Tabs-&gt;Add(Ptr); strcpy(m[i],Ptr); Ptr=strtok(0,separator); i++; } } }</span></span></code> </pre><br>  A configuration file must be stored in the same folder with the application (with a purely symbolic extension ".config", then I will do a normal INI file).  There are three lines in the file: client name, server ip-address and application version.  When you run the application, all this is extracted from the files and used for its intended purpose. <br><br><h4>  Total </h4><br>  I managed to develop a primitive, but still very workable program that allows you to <s>chat in the workplace</s> to connect dozens of computers in the office and stop communicating using phone calls or even more walking around the office. <br><br>  I have some ideas that will be implemented in the future, for example, adding a graphic chat, the ability to transfer files, maybe voice chat.  All this, of course, must be realized not with the help of the 2006 builder.  The project, for example, I have already transferred to Embarcadero RAD Studio XE8, I really needed a version for Mac. <br><br>  On this I think everything, the most important thing I wrote.  I really hope that this article will be useful for beginners working in C ++ Builder.  All source code and the program itself is <a href="https://yadi.sk/d/7hAJPdajh78bi">here</a> . <br><br>  <b>PS The</b> first part of the article was zaminusovali, but I really liked the first experience of writing articles.  Comment, I will correct my mistakes.  Thank you for your attention! </div><p>Source: <a href="https://habr.com/ru/post/259655/">https://habr.com/ru/post/259655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259645/index.html">Configuring VPLS Multihoming on Juniper Routers</a></li>
<li><a href="../259647/index.html">Developed by the University of Alabama will help passive cooling systems for servers and ordinary PCs.</a></li>
<li><a href="../259649/index.html">Problems of recognition of ID-documents on mobile devices on the example of machine-readable zones</a></li>
<li><a href="../259651/index.html">SaaS, PaaS, IaaS, or your hardware: What do domestic IT companies use?</a></li>
<li><a href="../259653/index.html">Restore databases using Veeam Explorer for Microsoft SQL Server</a></li>
<li><a href="../259657/index.html">Why in Russia there are so few committers in large open source projects</a></li>
<li><a href="../259663/index.html">Online store trump card: online shopping usability study</a></li>
<li><a href="../259667/index.html">Installing OpenStreetMap Nominatim to find latitude and longitude at the address entered</a></li>
<li><a href="../259671/index.html">Fast security-oriented fuzzing with AFL</a></li>
<li><a href="../259675/index.html">Ruby and C. Part 4. We are on friendly terms with the accelerometer, gyroscope and range finder with Raphael.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>