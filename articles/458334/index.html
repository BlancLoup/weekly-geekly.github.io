<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuous replication from old to new PostgreSQL using Slony</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Native streaming replication in PostgreSQL only works between servers with the same major version. We talked about logical replication in a previous p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuous replication from old to new PostgreSQL using Slony</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/c-/eo/j8/c-eoj8fosll1jnolz9jlnmi1wrg.jpeg"></p><br><p>  Native streaming replication in PostgreSQL only works between servers with the same major version.  We talked about logical replication in a <a href="https://habr.com/ru/company/southbridge/blog/457512/">previous post</a> .  We saw how logical replication helps move data from one version of PostgreSQL to another.  But logical replication is suitable only for supported versions of PostgreSQL, for example, for PostgreSQL 9.4 and PostgreSQL 11. What should I do with versions up to 9.4?  Use <a href="http://www.slony.info/">Slony-i</a> . </p><br><p>  Use replication with Slony-I to transfer data from old databases to the latest version of PostgreSQL.  What is Slony and how does it work? </p><a name="habracut"></a><br><p>  This is the fourth post in our series <a href="https://www.percona.com/blog/2019/03/04/postgresql-webinar-wed-april-17-upgrading-migrating-legacy-postgresql-newer-versions/">Updating or migrating old versions of PostgreSQL to new ones</a> , where we study different methods for updating PostgreSQL databases. </p><br><h3 id="slony">  Slony </h3><br><p>  Slony is an application-level logical replication implementation for PostgreSQL.  Or rather, it is a third-party replication tool that requires separate installation and configuration.  Slony has been around for a long time.  The latest version supports PostgreSQL from 8.4 to 11. </p><br><p>  The main goal of replication is to transfer changes from one database server to another.  To better understand the architecture, let's understand the terms: Slon, events and slonik. </p><br><p>  By the way, Slony, if you didn‚Äôt guess, is "elephants."  And they really have a great memory.  Not by chance on the PostgreSQL logo flaunts a strict, but cute <a href="https://grokbase.com/t/postgresql/pgsql-advocacy/0472hrfyqa/two-flyers">elephant</a> . </p><br><h3 id="slon">  Slon </h3><br><p>  Slon is a daemon that runs on every PostgreSQL node in Slony-I replication.  These daemons are used to handle configuration and replication events for each PostgreSQL server.  Each PostgreSQL server is called a node.  All nodes together form a Slony cluster. </p><br><p>  The publisher node is the source of the changes, and the subscriber node receives and applies the changes from the publisher. </p><br><p>  To configure replication, you must specify all replicated tables, or a replication set.  A subscription works for a specific set.  Changes to replicated tables are combined in SYNC, a group of transactions that are applied together at subscribers. </p><br><h3 id="sobytiya">  Developments </h3><br><p>  Changes are transmitted from the publisher in the form of events.  When an event is processed by the Slon daemon on the remote host, an acknowledgment is generated.  Events also notify nodes of configuration changes, such as the addition or removal of new nodes, new subscriptions, or changes to the DDL. </p><br><p>  Each event has its own unique source identifier, sequence number, transaction identifier for a snapshot on the event node, several arguments, and a time stamp with a time zone. <br>  Triggers written to PL / pgSQL capture all changes in replicated tables.  Unfortunately, there is no reliable way to handle blob changes, DDL, or changes to users and roles. </p><br><h3 id="slonik">  slonik </h3><br><p>  This is a command line utility with an analyzer and interpreter that accepts slonik scripts - a simple declarative language.  It is designed to overcome the limitations of a procedural language.  Using slonik commands, you can customize or change the replication in Slony, and you can embed them in shell scripts.  It accepts commands from standard input or from files.  In the example below you can see how the slonik script is passed to the slonik utility and embedded in shell scripts. </p><br><p>  The script that creates the initial configuration for a simple master-slave scheme in our pgbench database looks like this: </p><br><pre><code class="plaintext hljs">#!/bin/sh slonik &lt;&lt;_EOF_ cluster name = percona_pg; node 1 admin conninfo = 'dbname=pg93 host=pg93_host user=percona_pg93_user'; node 2 admin conninfo = 'dbname=pg11 host=pg11_host user=percona_pg11_user'; #-- # Creates a _$(clustername), this example, _percona_pg schema #-- init cluster ( id=1, comment = 'Legacy PG Node'); #-- # Add a list of tables being replicated to a set. #-- create set (id=1, origin=1, comment='pgbench'); set add table (set id=1, origin=1, id=1, fully qualified name = 'public.pgbench_accounts', comment='accounts'); set add table (set id=1, origin=1, id=2, fully qualified name = 'public.pgbench_branches', comment='branches'); set add table (set id=1, origin=1, id=3, fully qualified name = 'public.pgbench_tellers', comment='tellers'); set add table (set id=1, origin=1, id=4, fully qualified name = 'public.pgbench_history', comment='history'); #-- # Create the second node (the slave) tell the 2 nodes how to connect to # each other and how they should listen for events. #-- store node (id=2, comment = 'Target node', event node=1); store path (server = 1, client = 2, conninfo='dbname=pg93 host=pg93_host user=percona_pg93_user'); store path (server = 2, client = 1, conninfo='dbname=pg11 host=pg11_host user=percona_pg11_user'); _EOF_</code> </pre> <br><h3 id="pochemu-slony-udobno-ispolzovat-dlya-migraciy">  Why is Slony convenient to use for migrations? </h3><br><p>  Despite the advantages of internal logical replication, for versions prior to PostgreSQL 9.4, you have to use this third-party solution.  The trigger-based approach depends on the database API - both versions must be compatible to use the PL / pgSQL and SQL syntax. </p><br><h3 id="kak-adaptirovat-bazu-dannyh-dlya-ispolzovaniya-so-slony">  How to adapt the database for use with Slony? </h3><br><ul><li>  Tables must have primary keys.  Add the serial field to all tables without a primary key. </li><li>  Changes in OID blob not replicated.  If you have columns with short values, convert them to BYTEA.  If the objects are very large, for example, images, it is better to store data in external storage (say, S3 in the Amazon cloud).  If changing the application is too difficult, apply the change blob at the last stage of the migration. </li><li>  ALTER TABLE and other DDL operations.  Slony does not detect changes to the table structure.  Use the slonik EXECUTE SCRIPT command to apply a SQL file with SQL or DDL strings to the entire replication cluster. </li></ul><br><h3 id="onlayn-migraciya-iz-predyduschih-versiy-postgresql">  Online migration from previous versions of PostgreSQL </h3><br><ol><li>  Create a replication user with superuser privileges.  You can fine-tune the rights, but it is much more difficult. </li><li>  Create a database at your destination with TCP / IP access. </li><li>  Copy table definitions from master to slave. </li><li>  Install Slony-I.  On servers with an old OS version, it will be easier to install Slony-I from source code. </li><li>  Define a cluster, a set of tables, and information about connecting to nodes as a list of slonik commands. </li><li>  Run the slon daemon on each PostgreSQL server.  Check the standard output or log files for connection errors. </li><li>  Run slonik subscription commands to start synchronization. </li><li>  Test read-only requests in the new Postgres version. </li><li>  When all data has been replicated and synchronized, stop the applications and send them to the new Postgres server. </li><li>  Use the uninstall node in the new PostgreSQL version to remove all traces of Slony replication. </li></ol><br><h3 id="perehod-na-predyduschie-versii">  Switch to previous versions </h3><br><p>  To upgrade to previous versions, use the same procedure.  With Slony, you can replicate from any version to any version of PosgreSQL that Slony version supports.  The minimum supported version is 8.4. </p><br><h3 id="itogi">  Results </h3><br><p>  We outlined how you can upgrade to the new version with minimal downtime using Slony.  Learn more at our <a href="https://www.percona.com/resources/webinars/upgrading-migrating-your-legacy-postgresql-newer-postgresql-versions">webinar</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458334/">https://habr.com/ru/post/458334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458324/index.html">Everything you need to get started with Vue.js</a></li>
<li><a href="../458326/index.html">Yandex opens datasets Toloki for researchers</a></li>
<li><a href="../458328/index.html">How to duplicate goals from Yandex. Metrics to Google Analytics</a></li>
<li><a href="../45833/index.html">Page-view pattern in javascript</a></li>
<li><a href="../458332/index.html">Asynchronous programming - async performance: understand the costs of async and await</a></li>
<li><a href="../45834/index.html">SimpleModal - simple modal windows</a></li>
<li><a href="../458342/index.html">Texturing, or what you need to know to become an artist on surfaces. Part 1. Pixel</a></li>
<li><a href="../458344/index.html">Use asynchronous messaging to improve accessibility</a></li>
<li><a href="../458346/index.html">Solution of the task with pwnable.kr 01 - fd. File Descriptors and Processes</a></li>
<li><a href="../458348/index.html">"Samsung Ecosystem" - the results of the competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>