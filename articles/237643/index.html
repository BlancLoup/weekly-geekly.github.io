<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using SQLite in Windows and Windows Phone JavaScript applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="New to Windows Phone 8.1 is the ability to create and run applications written in JavaScript as well as on Windows 8.1. However, there are some differ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using SQLite in Windows and Windows Phone JavaScript applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/53a/9d2/ed7/53a9d2ed7726402b845c306a972cc24c.png"><br><br>  New to Windows Phone 8.1 is the ability to create and run applications <a href="http://msdn.microsoft.com/library/windows/apps/br211385">written in JavaScript</a> as well as on Windows 8.1.  However, there are some differences in the specifics of the API available for applications on Windows Phone 8.1.  One of these differences is the lack of <a href="http://www.w3.org/TR/IndexedDB/">IndexedDB</a> on the phone.  This presents difficulties for JavaScript developers of universal applications that need structured storage.  In this article, we will look at how to create a WinRT component that allows using <a href="http://www.sqlite.org/">SQLite</a> from JavaScript.  We also prepared <a href="http://code.msdn.microsoft.com/windowsapps/Universal-JavaScript-5728abdb">an example application</a> for you. <br><a name="habracut"></a><br>  <b>Note</b> : The following are two existing projects that wrap SQLite in WinRT.  You can use them instead of writing your own wrapper.  Before writing your wrappers, see if they provide the functionality you need and whether their licenses are right for you.  The decision about which there is a speech in this post, arose mainly to avoid problems with licensing. <br><br><ul><li>  <a href="http://sqlwinrt.codeplex.com/">SQLite-WinRT on CodePlex</a> : Read more about this in the post <a href="http://blogs.msdn.com/b/ukmsdn/archive/2013/06/06/sqlite-winrt-database-programming-on-windows-phone-and-windows-8.aspx">SQLite-WinRT</a> . </li><li>  <a href="https://github.com/doo/SQLite3-WinRT">SQLite3-WinRT on GitHub</a> : Read more about this on the <a href="https://github.com/doo/SQLite3-WinRT">github</a> page. </li></ul><br><h3>  Plan </h3><br>  We will adhere to the following plan to learn how to use SQLite in a universal Windows JavaScript application: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Open the Visual Studio project for an existing universal Windows application in JavaScript. </li><li>  Install the SQLite extensions for Visual Studio. </li><li>  Create a WinRT component for a universal application project. </li><li>  Let's write the code for SQLite wrapper. </li><li>  Let's write common application code using the WinRT component for SQLite. </li></ol><br>  We will follow this plan by examining the application implementation and paying attention to changing the IndexedDB code to use SQLite.  We took the <a href="http://code.msdn.microsoft.com/IndexedDB-sample-eb1e95af/view/">example of IndexedDB</a> for Windows 8.1 as a basis, made it a universal application, and went through the steps described below. <br><br><h3>  Installing the SQLite extension for Visual Studio </h3><br>  The SQLite team has released an extension for Visual Studio <a href="http://visualstudiogallery.msdn.microsoft.com/1d04f82f-2fe9-4727-a2f9-a2db127ddc9a">SQLite for the Windows Runtime (Windows 8.1)</a> , making it as easy as possible to add SQLite to Windows 8.1 applications.  Follow the <a href="http://visualstudiogallery.msdn.microsoft.com/1d04f82f-2fe9-4727-a2f9-a2db127ddc9a">link above</a> , click the Download link, and open the VSIX file to install the extension in Visual Studio. <br><br>  Also, the SQLite development team has released another VS extension - <a href="http://visualstudiogallery.msdn.microsoft.com/5d97faf6-39e3-4048-a0bc-adde2af75d1b">SQLite for Windows Phone 8.1</a> .  Follow the same steps to install the extension. <br><br><h3>  Creating a WinRT Component for a Universal Application Project </h3><br>  SQLite is written in C, and to use it in JavaScript applications, you need to wrap the SQLite API in the WinRT component. <br><br>  Open your application in Visual Studio and add a new Windows Runtime Component project for universal applications, which can be found along the following path: Visual C ++&gt; Store Apps&gt; Universal Apps.  Windows, Windows Phone projects and shared files will be created in your solution for the new WinRT component. <br><br>  To use the new WinRT component, you need to add references from the application projects to the project of the WinRT component.  In the Windows 8.1 project, add a link to the WinRT component for Windows 8.1, and in the Windows Phone 8.1 project, respectively, a link to the WinRT component for Windows Phone. <br><br>  Now applications can use the WinRT component, but they still do not use the SQLite extension.  Add references to SQLite in the WinRT component for Windows 8.1 and for Windows Phone 8.1.  Extensions can be found in the Add Links dialog box in the Windows Extensions (Phone) 8.1. <br><br><h3>  Writing SQLite wrapper code </h3><br>  For more information on creating C ++ / CX WinRT components, see the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh441569.aspx">Creating Windows Runtime Components in C ++ document</a> and <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh699871.aspx">Visual C ++ Language Reference (C ++ / CX)</a> links.  We will create a WinRT component with the minimum necessary functionality that will allow it to be used for most JavaScript tasks. <br><br>  In our case, the application needs to connect to the database, create tables, insert data, and perform operations in transactions.  The schema required for our example is very simple, so the WinRT wrapper contains only the Database object, which can open and close the database and execute SQL statements.  In order to simplify the addition of data, we support the parameters of communication with SQL statements.  To retrieve the requested data, we return an array of string objects from our executable method.  All our methods are asynchronous, so they do not block the flow of the user interface of the application while using the database. <br><br>  In JavaScript, we implement several functions that allow you to execute queries asynchronously, one by one or in a transaction, and convert the results of the queries into JavaScript objects. <br><br>  For your own project, additional SQLite APIs may be required;  our example is just a sample for which no advanced SQLite functions are required. <br><br><h3>  Sample implementation details </h3><br>  Below is the WinRT code for SQLite. <br><br><h4>  C ++ / CX </h4><br>  The SQLite library API is written in C and mostly uses the UTF-8 char * and returns an error code when an error occurs.  WinRT, on the contrary, usually uses <i>UTF-16 Platform :: String</i> when an error occurs, returns an exception.  In the util. * Files, we implemented <i>ValidateSQLiteResult</i> , which turns error codes returned from SQLite functions into WinRT exceptions, or passes the return value in case an error did not occur.  Also in the util. * Files there are two functions for converting between UTF-8 <i>string</i> types <i>std :: string</i> , and UTF-16, and Platform :: String string types. <br><br>  In the Database. * Files, we implement the Database class for WinRT, which has several methods.  Below is the code for the class Database.h: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ref <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Database</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sealed</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Windows::Foundation::IAsyncOperation&lt;Database^&gt; ^OpenDatabaseInFolderAsync(Windows::Storage::StorageFolder ^databaseFolder, Platform::String ^databaseFileName); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Database(); Windows::Foundation::IAsyncOperationWithProgress&lt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^, ExecuteResultRow^&gt; ^ExecuteAsync(Platform::String ^statementAsString); Windows::Foundation::IAsyncOperationWithProgress&lt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^, ExecuteResultRow^&gt; ^BindAndExecuteAsync(Platform::String ^statementAsString, Windows::Foundation::Collections::IVector&lt;Platform::String^&gt; ^parameterValues); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Database(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseDatabase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnsureInitializeTemporaryPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;databasePath)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SQLiteExecCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> columnCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **columnNames, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **columnValues)</span></span></span></span>; sqlite3 *database; };</code> </pre> <br>  The static <i>OpenDatabaseInFolderAsync</i> method is the only public method for creating a <i>Database</i> object.  This asynchronous method returns an IAsyncOperation &lt;Database ^&gt; ^ created or open Database object.  In the implementation, we make sure that the <a href="http://www.sqlite.org/c3ref/temp_directory.html">temporary path of SQLite is configured</a> as described in the SQLite documentation, and then we call <i>sqlite3_open_v2</i> , using functions from util. *.  We implement an asynchronous operation using <a href="http://msdn.microsoft.com/en-us/library/hh750102.aspx">PPL create_async</a> . <br><br>  Here is the definition of the OpenDatabaseInFolderAsync method from the Database.cpp file: <br><br><pre> <code class="cpp hljs">Windows::Foundation::IAsyncOperation&lt;Database^&gt; ^Database::OpenDatabaseInFolderAsync(Windows::Storage::StorageFolder ^databaseFolder, Platform::String ^databaseFileName) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> create_async([databaseFolder, databaseFileName]() -&gt; Database^ { Database ^database = ref <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Database(); <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> databasePath = PlatformStringToUtf8StdString(databaseFolder-&gt;Path); databasePath += <span class="hljs-string"><span class="hljs-string">""</span></span>; databasePath += PlatformStringToUtf8StdString(databaseFileName); database-&gt;OpenPath(databasePath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database; }); }</code> </pre><br>  Database :: ExecuteAsync is also asynchronous, this time returns IAsyncOperationWithProgress &lt;IVector &lt;ExecuteResultRow ^&gt; ^, ExecuteResultRow ^&gt;, in which the asynchronous result is the vector of any ExecuteResultRows requested by the executable SQL statement and additionally providing execution notifications containing the same requested rows but provided only in case of simultaneous selection.  We call <i>sqlite3_exec</i> , which uses a callback, to return the result of the query.  Below is the implementation of the ExecuteAsync method and SQLiteExecCallback from the Database.cpp file: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteExecCallbackContext</span></span></span><span class="hljs-class"> {</span></span> Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt; ^rows; Concurrency::progress_reporter&lt;SQLite::ExecuteResultRow^&gt; reporter; }; Windows::Foundation::IAsyncOperationWithProgress&lt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^, ExecuteResultRow^&gt; ^Database::ExecuteAsync(Platform::String ^statementAsString) { sqlite3 *database = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;database; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> create_async([database, statementAsString](Concurrency::progress_reporter&lt;SQLite::ExecuteResultRow^&gt; reporter) -&gt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^ { SQLiteExecCallbackContext context = {ref <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector&lt;ExecuteResultRow^&gt;(), reporter}; ValidateSQLiteResult(sqlite3_exec(database, PlatformStringToUtf8StdString(statementAsString).c_str(), Database::SQLiteExecCallback, <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*&gt;(&amp;context), <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.rows; }); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Database::SQLiteExecCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *contextAsVoid, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> columnCount, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **columnNames, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **columnValues) { SQLiteExecCallbackContext *context = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(context)&gt;(contextAsVoid); ExecuteResultRow ^row = ref <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecuteResultRow(columnCount, columnNames, columnValues); context-&gt;rows-&gt;Append(row); context-&gt;reporter.report(row); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  To provide the SQL parameter binding, we have implemented <i>Database :: BindAndExecuteAsync</i> , which returns the same value as Database :: ExecuteAsync.  Database :: ExecuteAsync accepts a parameter that is a vector of strings that should be bound to SQL statements.  Interestingly, the IVector &lt;String ^&gt; ^ parameter is bound to the calling thread, so we create a copy of the list of strings as std :: vector &lt;String ^&gt;.  We fix it in our create_async lambda expression and can use it in another thread.  Since  <i>sqlite3_exec</i> does not provide parameter binding, we run a sequence of explicit implementations of <i>sqlite3_prepare, sqlite3_bind, sqlite3_step,</i> and <i>sqlite3_finalize</i> . <br><br>  Below is the definition of BindAndExecuteAsync from the Database.cpp file: <br><br><pre> <code class="cpp hljs">Windows::Foundation::IAsyncOperationWithProgress&lt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^, ExecuteResultRow^&gt; ^Database::BindAndExecuteAsync( Platform::String ^statementAsString, Windows::Foundation::Collections::IVector&lt;Platform::String^&gt; ^parameterValuesAsPlatformVector) { sqlite3 *database = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;database; <span class="hljs-comment"><span class="hljs-comment">//     ,   // IVector      std::vector&lt;Platform::String^&gt; parameterValues; for (unsigned int index = 0; index &lt; parameterValuesAsPlatformVector-&gt;Size; ++index) { parameterValues.push_back(parameterValuesAsPlatformVector-&gt;GetAt(index)); } return create_async([database, statementAsString, parameterValues](Concurrency::progress_reporter&lt;SQLite::ExecuteResultRow^&gt; reporter) -&gt; Windows::Foundation::Collections::IVector&lt;ExecuteResultRow^&gt;^ { IVector&lt;ExecuteResultRow^&gt; ^results = ref new Vector&lt;ExecuteResultRow^&gt;(); sqlite3_stmt *statement = nullptr; ValidateSQLiteResult(sqlite3_prepare(database, PlatformStringToUtf8StdString(statementAsString).c_str(), -1, &amp;statement, nullptr)); const size_t parameterValuesLength = parameterValues.size(); for (unsigned int parameterValueIndex = 0; parameterValueIndex &lt; parameterValuesLength; ++parameterValueIndex) { //   1 ValidateSQLiteResult(sqlite3_bind_text(statement, parameterValueIndex + 1, PlatformStringToUtf8StdString(parameterValues[parameterValueIndex]).c_str(), -1, SQLITE_TRANSIENT)); } int stepResult = SQLITE_ROW; while (stepResult != SQLITE_DONE) { stepResult = ValidateSQLiteResult(sqlite3_step(statement)); if (stepResult == SQLITE_ROW) { const int columnCount = sqlite3_column_count(statement); ExecuteResultRow ^currentRow = ref new ExecuteResultRow(); for (int columnIndex = 0; columnIndex &lt; columnCount; ++columnIndex) { currentRow-&gt;Add( reinterpret_cast&lt;const char*&gt;(sqlite3_column_text(statement, columnIndex)), sqlite3_column_name(statement, columnIndex)); } results-&gt;Append(currentRow); reporter.report(currentRow); } } ValidateSQLiteResult(sqlite3_finalize(statement)); return results; }); }</span></span></code> </pre><br><br>  In the ExecuteResultRow. * <i>Files</i> , we implement <i>ExecuteResultRow</i> and <i>ColumnEntry</i> , which contain the results of database queries.  This is necessary for using data in WinRT and there is no interaction with the SQLite API.  The most interesting part of <i>ExecuteResultRow</i> is how it uses the methods Database :: * ExecuteAsync. <br><br><h4>  Javascript </h4><br>  In the default.js file, we implement several methods to simplify the use of the WinRT component in a JavaScript application. <br><br>  The <i>runPromisesInSerial</i> function accepts an array of Promise and Ensure objects that are run one after the other to simplify the launch of a series of asynchronous <i>ExecuteAsync</i> commands. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runPromisesInSerial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promiseFunctions</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promiseFunctions.reduce(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promiseChain, nextPromiseFunction</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promiseChain.then(nextPromiseFunction); }, WinJS.Promise.wrap()); }</code> </pre><br>  The <i>executeAsTransactionAsync</i> function opens a transaction, executes a function, then closes the transaction.  The only interesting aspect is that the function is asynchronous, to complete the transaction we need to wait for the asynchronous execution and get the result.  Make sure that it still returns a successful result or returns an error value. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeAsTransactionAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">database, workItemAsyncFunction</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database.executeAsync(<span class="hljs-string"><span class="hljs-string">"BEGIN TRANSACTION"</span></span>).then(workItemAsyncFunction).then( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> successResult = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database.executeAsync(<span class="hljs-string"><span class="hljs-string">"COMMIT"</span></span>).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> successResult; }); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorResult = error; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database.executeAsync(<span class="hljs-string"><span class="hljs-string">"COMMIT"</span></span>).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> errorResult; }); }); }</code> </pre><br>  <i>ExecuteStatementsAsTransactionAsync</i> and <i>bindAndExecuteStatementsAsTransactionAsync</i> combine the two previous functions to facilitate the work with queries and results. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeStatementsAsTransactionAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">database, statements</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> executeStatementPromiseFunctions = statements.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statementToPromiseFunction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">statement</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database.executeAsync.bind(database, statement); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> executeAsTransactionAsync(database, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> runPromisesInSerial(executeStatementPromiseFunctions); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindAndExecuteStatementsAsTransactionAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">database, statementsAndParameters</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindAndExecuteStatementPromiseFunctions = statementsAndParameters.map( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">statementAndParameter</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> database.bindAndExecuteAsync.bind(database, statementAndParameter.statement, statementAndParameter.parameters); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> executeAsTransactionAsync(database, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> runPromisesInSerial(bindAndExecuteStatementPromiseFunctions); }); }</code> </pre><br>  Next, you can see how these functions are used to execute SQL queries, asynchronously and sequentially: <br><br><pre> <code class="javascript hljs">SQLite.Database.openDatabaseInFolderAsync( Windows.Storage.ApplicationData.current.roamingFolder, <span class="hljs-string"><span class="hljs-string">"BookDB.sqlite"</span></span>).then( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">openedOrCreatedDatabase</span></span></span><span class="hljs-function">) </span></span>{ database = openedOrCreatedDatabase; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SdkSample.executeStatementsAsTransactionAsync(database, [ <span class="hljs-string"><span class="hljs-string">"CREATE TABLE IF NOT EXISTS books (id INTEGER PRIMARY KEY UNIQUE, title TEXT, authorid INTEGER);"</span></span>, <span class="hljs-string"><span class="hljs-string">"CREATE TABLE IF NOT EXISTS authors (id INTEGER PRIMARY KEY UNIQUE, name TEXT);"</span></span>, <span class="hljs-string"><span class="hljs-string">"CREATE TABLE IF NOT EXISTS checkout (id INTEGER PRIMARY KEY UNIQUE, status INTEGER);"</span></span> ]); <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre><br><h3>  Transition from IndexedDB to SQLite </h3><br>  The reason for the transition may be that you have an application on Windows 8.1 that uses IndexedDB and you want to make a universal application out of it.  To do this, you will need to change your code to use WinRT SQLite wrapper instead of IndexedDB. <br><br>  Unfortunately, there is no simple answer what to do in this situation.  For the application described in the example, we provide raw SQL contracts and use regular SQL tables that require preliminary schema and represent asynchronous execution with Promise objects.  IndexedDB, on the other hand, reads and writes JavaScript objects.  It focuses more on the use of SQL statements, and uses Event objects, unlike Promise. <br><br>  The converted code in the sample application is very different from the original IndexedDB example.  If you have a lot of IndexedDB code, you can write your WinRT wrapper so that its interface will more resemble IndexedDB.  We hope that the database code of your application is well separated from the rest of the code or is easy to convert. <br><br><h4>  Additional materials </h4><br>  <a href="http://www.sqlite.org/">SQLite library</a> <br>  <a href="http://visualstudiogallery.msdn.microsoft.com/1d04f82f-2fe9-4727-a2f9-a2db127ddc9a">Download SQLite for Windows Runtime</a> <br>  <a href="http://code.msdn.microsoft.com/windowsapps/Universal-JavaScript-5728abdb">An example of a generic SQLite application in JavaScript</a> <br>  <a href="http://sqlwinrt.codeplex.com/">SQLite-WinRT article</a> <br>  <a href="http://www.microsoftvirtualacademy.com/">Microsoft Virtual Academy (MVA) Training Courses</a> <br>  <a href="http://www.visualstudio.com/ru-ru/downloads/download-visual-studio-vs">Download a free or trial version of Visual Studio 2013</a> </div><p>Source: <a href="https://habr.com/ru/post/237643/">https://habr.com/ru/post/237643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237631/index.html">What could be the AI ‚Äã‚Äãprogram</a></li>
<li><a href="../237633/index.html">To help the leading "Mafia"</a></li>
<li><a href="../237635/index.html">How to make a good video for the application page on the App Store</a></li>
<li><a href="../237639/index.html">Crowdfunding project math</a></li>
<li><a href="../237641/index.html">What to do an IT specialist in the army or how I wrote games on a VBA</a></li>
<li><a href="../237645/index.html">How to write a game in 1 day or Another snotty post-half manual on how to quickly learn C #</a></li>
<li><a href="../237651/index.html">Maven spacecraft successfully arrived at Mars orbit</a></li>
<li><a href="../237653/index.html">Double afterburner. The first success story of Russian crowdinvesting</a></li>
<li><a href="../237657/index.html">Kill all humans with a cat, or state machines on Akka.FSM</a></li>
<li><a href="../237659/index.html">Principles of building management reports based on data from existing accounting databases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>