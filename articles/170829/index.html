<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Kerberos authentication using smart cards</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the continuation of a long-standing topic about the use of two-factor authentication in the GNU / Linux OS, let me tell you about the scheme of wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Kerberos authentication using smart cards</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/7c4/ac2/c95/7c4ac2c956a808e2d7179111e5bde18e.jpg">  In the continuation of a <a href="http://habrahabr.ru/company/aktiv-company/blog/144700/">long-standing topic</a> about the use of two-factor authentication in the GNU / Linux OS, let me tell you about the scheme of work and setting up authentication using Kerberos.  In this article, we will look at how to configure MIT Kerberos to authenticate users with certificates and key pairs located on a USB token.  Also, the materials described in the article can be used to configure authentication in a Windows domain. <a name="habracut"></a><br><br><h1>  Brief introduction </h1>  To begin with, we will conduct a small educational program in Kerberos terminology and consider the available implementations of this protocol in the operating system based on GNU / Linux.  I‚Äôll just make a reservation that I couldn‚Äôt find an unambiguous translation of the terms used in Kerberos, so in order to avoid confusion, I will duplicate the basic terms in English. <br>  So, let's begin.  To quote Wikipedia, <blockquote>  Kerberos is a network authentication protocol that allows data to be transmitted over unsecured networks for secure authentication.  Focused primarily on the client-server model and provides mutual authentication - both users through the server confirm the identity of each other. </blockquote>  It is worth noting that Kerberos is primarily a protocol, and not a specific authentication system.  Its implementations are used in various operating systems, including Windows, as a method of authenticating users in a domain.  There are several open source implementations of the Kerberos protocol, such as the original MIT Kerberos and Heimdal.  This zoo has arisen due to US restrictions on the export of cryptographic information security tools; today this situation around MIT Kerberos has already subsided.  In the article we will look at the configuration process for MIT Kerberos V5. <br><br><br><h1>  Kerberos Terminology </h1><ul><li>  Ticket (ticket) - temporary data issued to the client for authentication on the server on which the necessary service is located. </li><li>  A client is a kind of entity on the network (user, host, or service) that can receive a ticket from Kerberos. </li><li>  A key distribution center (key distribution center, KDC) is a service that issues Kerberos tickets. </li><li>  Domain (realm) is a network used by Kerberos, consisting of KDC servers and multiple clients.  The realm name is case-sensitive, usually written in uppercase and the same as the domain name. </li><li>  Principal is a unique name for the client for which Kerberos authentication is allowed.  It is written as root [/ instance] @REALM. </li></ul><br><h3>  Kerberos Settings Files </h3><h5>  On server: </h5><ul><li>  /etc/krb5kdc/kdc.conf - KDC Settings </li></ul><h5>  On the client and server: </h5><ul><li>  /etc/kbr5.conf - authentication server settings (description of realms, domain names and other settings) </li></ul><br><h1>  Setting up the working environment </h1>  First you need to deploy the environment in which the authentication will be performed.  The easiest way to do this is by taking two virtual machines on the same subnet.  Just install Ubuntu on one virtual machine (this will be our server), and then clone it and get a client.  When writing this article, I used a fresh Ubuntu 12.10 (x86) and VMWare virtual machine.  To make it easier for virtual machines to see each other over the network, it is worth switching network cards to Bridged mode. <br>  <b>Important!</b>  Make sure that the time on the client and the server is synchronized, it is necessary for the correct operation of Kerberos. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Network configuration </h3>  Kerberos clients look for their servers by domain names, so you need to configure DNS and make sure that server names are resolved successfully.  In our example, it suffices to put the server's domain name in / etc / hosts, which I did.  The network diagram is shown below. <br><img src="https://habrastorage.org/storage2/475/c96/252/475c96252ba9563727df3752e20efad4.png"><br><br><h3>  Installing the necessary packages </h3><h5>  On the server we need: </h5><ul><li>  krb5-kdc - KDC service </li><li>  krb5-admin-server - Kerberos administration server (it controls user accounts) </li><li>  krb5-pkinit - Kerberos extension for certificate authentication </li></ul><br><h5>  The following packages should be delivered to the client: </h5><ul><li>  krb5-user - a basic set of utilities for client authentication work </li><li>  krb5-config - Kerberos Settings Files </li><li>  krb5-pkinit </li><li>  libpam-krb5 - PAM module for using Kerberos authentication </li><li>  pcscd, opensc, libengine-pkcs11-openssl - packages needed to work with tokens </li></ul><br>  When installing packages, we will be asked for the default settings, we will use the following: <ul><li>  Default realm: AKTIV-TEST.RU </li><li>  Server names (admin server and KDC): aktiv-test.ru (it is also registered in / etc / hosts on the client) </li><li>  User: testuser@AKTIV-TEST.RU </li></ul><br><h1>  Kerberos Setup </h1><h3>  Basic settings </h3>  After installing the packages on the server, you need to initialize the realm command <pre><code class="bash hljs">$ sudo krb5_newrealm</code> </pre> <br>  And on the client, update the configuration files: <pre> <code class="bash hljs">$ sudo dpkg-reconfigure krb5-config</code> </pre><br>  Also on the client and server, add the following lines to /etc/krb5.conf: <pre> <code class="bash hljs">[domain_realm] .aktiv-test.ru = AKTIV-TEST.RU aktiv-test.ru = AKTIV-TEST.RU</code> </pre><br>  Now we will create a new user on the server with the name testuser <pre> <code class="bash hljs">$ sudo kadmin.local <span class="hljs-comment"><span class="hljs-comment"># username = testuser # password = test #        kadmin.local:$ addprinc testuser # ... kadmin.local:$ quit</span></span></code> </pre><br>  On the client, you can now check whether we configured the network and Kerberos correctly: <pre> <code class="bash hljs">$ kinit testuser@AKTIV-TEST.RU <span class="hljs-comment"><span class="hljs-comment">#    $ klist #    ticket,        $ kdestroy</span></span></code> </pre><br><h3>  Configuring public key authentication </h3>  To use the pkinit module, we will have to use openssl as a mini-TC to create key pairs and certificates of the client and the server. <h5>  On server: </h5>  Let's create a key pair and certificate of our ‚ÄúTC‚Äù.  Here we generate the CA key and create a self-signed certificate using openssl.  In the real world, the key naturally must be securely protected from falling into the wrong hands. <pre> <code class="bash hljs">$ openssl genrsa -out cakey.pem 2048 <span class="hljs-comment"><span class="hljs-comment"># ... $ openssl req -key cakey.pem -new -x509 -out cacert.pem # ...</span></span></code> </pre><br>  Let's create a key pair for the KDC, an application for a certificate and write it out for ourselves. <br>  Here we will need the special OpenSSL extension file ( <a href="https://dl.dropbox.com/u/715171/pkinit_extensions">pkinit_extensions</a> ), which will contain additional certificate fields used in Kerberos.  In particular, we will specify: <ul><li>  Extended Key Usage (EKU) - an identifier (OID) that tells how you plan to use the certificate </li><li>  otherName - the field specifying our principal for which the certificate is issued </li></ul><br><pre> <code class="bash hljs">$ openssl genrsa -out kdckey.pem 2048 <span class="hljs-comment"><span class="hljs-comment">#   $ openssl req -new -out kdc.req -key kdckey.pem #   $ REALM=AKTIV-TEST.RU; export REALM $ CLIENT=aktiv-test.ru; export CLIENT #   pkinit_extensions .    $ openssl x509 -req -in kdc.req -CAkey cakey.pem -CA cacert.pem -out kdc.pem -extfile pkinit_extensions -extensions kdc_cert ‚ÄìCAcreateserial</span></span></code> </pre><br>  After that, transfer the following files to / var / lib / krb5kdc /: <ul><li>  kdc.pem </li><li>  kdckey.pem </li><li>  cacert.pem </li></ul><br>  On the server, edit the Kerberos settings (/etc/krb5kdc/kdc.conf file) to use the keys and certificates of the server and CA: <pre> <code class="bash hljs">[kdcdefaults]    kdc_tcp_ports = 88    pkinit_identity = FILE:/var/lib/krb5kdc/kdc.pem,/var/lib/krb5kdc/kdckey.pem    pkinit_anchors = FILE:/var/lib/krb5kdc/cacert.pem [realms]    AKTIV-TEST.RU = {        database_name = /var/lib/krb5kdc/principal        admin_keytab = FILE:/etc/krb5kdc/kadm5.keytab        acl_file = /etc/krb5kdc/kadm5.acl        key_stash_file = /etc/krb5kdc/stash        max_life = 10h 0m 0s        max_renewable_life = 7d 0h 0m 0s        master_key_type = des3-hmac-sha1        supported_enctypes = aes256-cts:normal arcfour-hmac:normal des3-hmac-sha1:normal des-cbc-crc:normal des:normal des:v4 des:norealm des:onlyrealm des:afs3        default_principal_flags = +preauth    }</code> </pre><br>  Next on the server, you must enable pre-authentication for our user. <pre> <code class="bash hljs">$ kadmin.local kadmin.local$: modprinc +requires_preauth testuser</code> </pre><br><h5>  Further actions will be performed on the client. </h5>  Format the token <pre> <code class="bash hljs">$ pkcs15-init --erase-card -p rutoken_ecp $ pkcs15-init --create-pkcs15 --so-pin <span class="hljs-string"><span class="hljs-string">"87654321"</span></span> --so-puk <span class="hljs-string"><span class="hljs-string">""</span></span> $ pkcs15-init --store-pin --label <span class="hljs-string"><span class="hljs-string">"User PIN"</span></span> --auth-id 02 --pin <span class="hljs-string"><span class="hljs-string">"12345678"</span></span> --puk <span class="hljs-string"><span class="hljs-string">""</span></span> --so-pin <span class="hljs-string"><span class="hljs-string">"87654321"</span></span> ‚Äìfinalize</code> </pre><br>  Let's generate a key pair of RSA 2048 bits on the token and create a certificate application.  It is important to note that the paths to the libraries engine_pkcs11.so and opensc-pkcs11.so on your system may differ, so you should first check their location. <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      ID  ,     $ pkcs15-init -G rsa/2048 --auth-id 02 --id 42 --label "testuser's key" --public-key-label "testuser's public key" # ... $ openssl #  multiarch- opensc-pkcs11.so  engine_pkcs11.so      OpenSSL&gt; engine dynamic -pre SO_PATH:/usr/lib/openssl/engines/engine_pkcs11.so -pre ID:pkcs11 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:opensc-pkcs11.so (dynamic) Dynamic engine loading support [Success]: SO_PATH:/usr/lib/openssl/engines/engine_pkcs11.so [Success]: ID:pkcs11 [Success]: LIST_ADD:1 [Success]: LOAD [Success]: MODULE_PATH:opensc-pkcs11.so Loaded: (pkcs11) pkcs11 engine OpenSSL&gt; req -engine pkcs11 -new -key 1:42 -keyform engine -out client.req -subj "/C=RU/ST=Moscow/L=Moscow/O=Aktiv/OU=dev/CN=testuser/emailAddress=testuser@mail.com" engine "pkcs11" set. PKCS#11 token PIN: OpenSSL&gt; quit</span></span></code> </pre><br>  After this, we will receive the client.req application file, which must be placed on the server and the user certificate issued based on the CA data: <pre> <code class="bash hljs">$ REALM=AKTIV-TEST.RU; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> REALM $ CLIENT=testuser; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CLIENT $ openssl x509 -CAkey cakey.pem -CA cacert.pem -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client.req -extensions client_cert -extfile pkinit_extensions -out client.pem</code> </pre><br>  Then it is worth restarting the server and KDC: <pre> <code class="bash hljs">$ /etc/init.d/krb5-admin-server restart $ /etc/init.d/krb5-kdc restart</code> </pre><br>  At the output of openssl, we get a file with client.pem client certificate.  It needs to be transferred to the client machine, put in / etc / krb5 / and written to the token: <pre> <code class="bash hljs">$ pkcs15-init --store-certificate client.pem --auth-id 02 --id 42 --format pem</code> </pre><br>  And finally, we will need to make a setting in the Kerberos configuration file that will indicate what data to use for authentication (in our case, this is the CA certificate and the path to the PKCS # 11 module).  The MIT Kerberos <a href="http://web.mit.edu/Kerberos/krb5-1.9/krb5-1.9.1/doc/krb5-admin.html">documentation</a> contains various parameters that allow you to customize the selection of authentication data on the token, but in our case, we simply specify the PKCS # 11 module, since this is sufficient in this situation. <pre> <code class="bash hljs">[libdefaults] default_realm = AKTIV-TEST.RU <span class="hljs-comment"><span class="hljs-comment">#     pkinit_anchors = FILE:/etc/krb5/cacert.pem #    PKCS#11 pkinit_identities = PKCS11:/usr/lib/opensc-pkcs11.so</span></span></code> </pre><br>  Check if we can get the ticket on the client using the data from the token: <pre> <code class="bash hljs">$ kinit testuser <span class="hljs-comment"><span class="hljs-comment">#        PIN-   $ klist</span></span></code> </pre><br><h1>  Configuring PAM Authentication Using Kerberos </h1>  Earlier, when setting up the client machine, we installed the libpam-krb5 package.  It will help us to perform authentication in Kerberos when logging into the system, as well as in applications using system authentication (for example, login, lightdm, etc.).  To connect the PAM module, just run the command <pre> <code class="bash hljs">$ sudo pam-auth-update</code> </pre><br>  and select the required authentication modules in the dialog.  For more fine-tuning, you can look at the /etc/pam.d/common-auth file and edit it at will.  I described the structure of the file in a <a href="http://habrahabr.ru/company/aktiv-company/blog/144700/">previous article</a> . <br><br><h1>  Conclusion </h1>  The use of the Kerberos protocol for centralized authentication in conjunction with the centralized creation of the storage and distribution of accounts (for example, through a directory based on OpenLDAP) allows you to create a "UNIX domain", consisting entirely of machines running free software.  Such a solution can be used in the corporate sector, and smart card authentication will be a pleasant bonus for both administrators and users of the company's network. <br><br><h1>  useful links </h1><ul><li>  <a href="http://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos protocol description</a> </li><li>  <a href="http://web.mit.edu/kerberos/www/krb5-1.2/krb5-1.2.6/doc/admin_toc.html">Official documentation</a> </li><li>  <a href="https://help.ubuntu.com/community/Kerberos">Setup instructions from the Ubuntu community</a> </li><li>  <a href="http://k5wiki.kerberos.org/wiki/Pkinit_configuration">PKINIT setup</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/170829/">https://habr.com/ru/post/170829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170809/index.html">Quick code dialing for developers - typing.io</a></li>
<li><a href="../170815/index.html">GitHub as an artifact repository</a></li>
<li><a href="../170817/index.html">Battery Calibration with the Mugen Power App for Android</a></li>
<li><a href="../170819/index.html">Infographics: Internet startup development, its life cycle and investments</a></li>
<li><a href="../170827/index.html">Books by Cach√© and MUMPS</a></li>
<li><a href="../170831/index.html">Come to experience new flash storage systems for data centers</a></li>
<li><a href="../170835/index.html">Anyone can program at any age.</a></li>
<li><a href="../170843/index.html">Enthusiasts ported Ubuntu for 24 smartphones and tablet PCs</a></li>
<li><a href="../170845/index.html">PyCon is gone</a></li>
<li><a href="../170847/index.html">Unit testing and continuous integration with Jenkins for C ++ projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>