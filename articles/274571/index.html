<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write in Java in Arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will tell you how to write in Java for Arduino. 

 Why java? In short - just for fun! 

 I am a Java programmer and in my spare time I pla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write in Java in Arduino</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/963/23d/f48/96323df48cf64a5591ca74a3421975d0.png"><br><br>  The article will tell you how to write in Java for Arduino. <br><br>  Why java?  In short - just for fun! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I am a Java programmer and in my spare time I play with Arduino and I wanted to transfer my knowledge of Java into the world of microcontrollers and embedded devices. <br><br>  At the moment there are several possibilities to run Java on embedded devices.  In this article I will review them. <br><a name="habracut"></a><br><h4>  Official JVM </h4><br>  The first is the official JVM for embedded: <br>  <a href="http://www.oracle.com/technetwork/java/embedded/embedded-se/overview/index.html">www.oracle.com/technetwork/java/embedded/embedded-se/overview/index.html</a> <br>  <a href="http://habrahabr.ru/post/243549/">habrahabr.ru/post/243549</a> Starting Java Runtime on 256KB of RAM <br><br>  There is almost a real JVM which executes byte-code.  But there are big drawbacks - it only works for the Raspberry Pi and Freescale K64F (maybe I missed something, if so, please add in the comments).  Raspberry Pi support is definitely good, but it‚Äôs essentially a computer, albeit a single board.  You can run a simple JVM on it.  Yes, and it costs from 3 tr.  K64F is already a dev board with a Cortex M4 on board.  But it is also worth from 3 tr.  Which is much more expensive than the common Arduino Uno. <br><br><h4>  JVM with byte code compilation </h4><br>  There are several VMs that allow you to run Java on microcontrollers - this is LeJOS ( <a href="http://www.lejos.org/">www.lejos.org</a> ) and HaikuVM ( <a href="http://haiku-vm.sourceforge.net/">haiku-vm.sourceforge.net</a> ) <br>  LeJOS - allows you to run Java applications on Lego MindStorm.  HaikuVM - on AVR microcomputers.  Now LeJOS is divided into two parts: <br>  - for the latter, EV3, this is the real JVM from Oracle ( <a href="http://www.oracle.com/technetwork/java/embedded/downloads/javase/javaseemeddedev3-1982511.html">www.oracle.com/technetwork/java/embedded/downloads/javase/javaseemeddedev3-1982511.html</a> ).  I can say nothing more about it - just a JVM. <br>  - For previous versions, NXJ and RCX, TinyVM-based JVM ( <a href="http://tinyvm.sourceforge.net/">tinyvm.sourceforge.net</a> ) is used.  Here it is worth to talk about it in more detail. <br><br>  Since  in microcontrollers there is very little memory (in Arduino Uno 28kB Flash and 2kB SRAM), a real JVM with which class files would interpret cannot be run there.  But you can convert the byte code of the program and compile it into native code, while cutting out all unnecessary, all not used runtime.  Compilation loses some of the Java functionality (for example, reflection).  But the program will work! <br><br>  HaikuVM also works - it takes Java code, compiles it with JRE from LeJOS (an alternative implementation of some standard classes - String, StringBuilder, Integer, etc. - is needed for optimization) instead of JRE from the original JVM (rt.jar in HotSpot), resulting in The class files convert to C ++ code, add the runtime from HaikuVM (it supports threads, GC, exception) and compiles all this with avr-gcc.  And thus it is possible to run a Java program up to ATMega8 with 8kB flash memory! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ea/d05/270/0ead05270bed8108eb3ce8cd753f98cb.png" alt="image"><br>  Algorithm work HaikuVM.  Picture taken from <a href="http://haiku-vm.sourceforge.net/">haiku-vm.sourceforge.net</a> <br><br><h5>  Code Conversion Example </h5><br>  Java code: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">57600</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Serial.isOpen()) { } }</code> </pre> <br><br>  Byte code: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">V L0 LINENUMBER 140 L0 GETSTATIC processing/hardware/arduino/cores/arduino/Arduino.Serial : Lprocessing/hardware/arduino/cores/arduino/HardwareSerial</span></span>; LDC <span class="hljs-number"><span class="hljs-number">57600</span></span> INVOKEVIRTUAL processing/hardware/arduino/cores/arduino/HardwareSerial.begin (J)V L1 LINENUMBER <span class="hljs-number"><span class="hljs-number">141</span></span> L1 FRAME SAME GETSTATIC processing/hardware/arduino/cores/arduino/Arduino.Serial : Lprocessing/hardware/arduino/cores/arduino/HardwareSerial; INVOKEVIRTUAL processing/hardware/arduino/cores/arduino/HardwareSerial.isOpen ()Z IFNE L2 GOTO L1 L2 LINENUMBER <span class="hljs-number"><span class="hljs-number">144</span></span> L2 FRAME SAME RETURN MAXSTACK = <span class="hljs-number"><span class="hljs-number">3</span></span> MAXLOCALS = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  C generated code: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** public static void setup() Code(max_stack = 3, max_locals = 0, code_length = 22) */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> JMETHOD #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> JMETHOD ru_timreset_IrTest_setup_V const ru_timreset_IrTest_setup_V_t JMETHOD PROGMEM ={ 0+(2)+3, 0, 0, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// MaxLocals+(lsp+pc)+MaxStack, purLocals, purParams OP_GETSTATIC_L, SADR(processing_hardware_arduino_cores_arduino_Arduino_Serial), // 0: getstatic processing.hardware.arduino.cores.arduino.Arduino.Serial Lprocessing/hardware/arduino/cores/arduino/HardwareSerial; (16) OP_LDC2_W_L, CADR(Const0003), // 3: ldc2_w 57600 (35) OP_INVOKEVIRTUAL, B(2), LB(MSG_begin__J_V), // 6: invokevirtual processing.hardware.arduino.cores.arduino.HardwareSerial.begin (J)V (37) OP_GETSTATIC_L, SADR(processing_hardware_arduino_cores_arduino_Arduino_Serial), // 9: getstatic processing.hardware.arduino.cores.arduino.Arduino.Serial Lprocessing/hardware/arduino/cores/arduino/HardwareSerial; (16) OP_INVOKEVIRTUAL, B(0), LB(MSG_isOpen___Z), // 12: invokevirtual processing.hardware.arduino.cores.arduino.HardwareSerial.isOpen ()Z (38) OP_IFNE, TARGET(21), // 15: ifne #21 OP_GOTO, TARGET(9), // 18: goto #9 OP_RETURN, // 21: return };</span></span></span></span></code> </pre><br><br>  As can be seen from the example above - HaikuVM almost one to one transfers the byte code to C. <br><br>  In addition to Java support, HaikuVM allows you to call C functions directly - using NativeCppFunction / NativeCFunction annotations and contains methods for working with memory and interrupts. <br><br>  In general, I liked the project - I even tried to translate it to Gradle ( <a href="https://github.com/TimReset/HaikuVMGradle">github.com/TimReset/HaikuVMGradle</a> ), but since HaikuVM contains quite complex logic in bat / sh files, this has not yet been completely done. <br><br>  But there are downsides - since the memory microcontrollers and the processor frequency are few, then even a small overhead in the form of GC (although you can turn off the GC, but it doesn‚Äôt help much) and converting the byte code to C introduces noticeable delays.  This is expressed, for example, in the inability to work with Serial at high frequencies (more than 57600 kb / s) - data starts to be lost.  Therefore, I began to develop my own (with tests and library support) Java launch option in Arduino. <br><br><h4>  Convert Java Code to Wiring </h4><br>  Whatever overhead is in the form of GC and the native interpreter byte code, you can convert Java code directly into Wiring (programming language in Arduino, the same C ++).  I did not find ready implementations, so I decided to write my own ( <a href="https://github.com/TimReset/arduino-java">github.com/TimReset/arduino-java</a> ), since the Java syntax is very similar to C.  To do this, use AST analysis from Eclipse ( <a href="http://help.eclipse.org/mars/index.jsp%3Ftopic%3D%252Forg.eclipse.jdt.doc.isv%252Freference%252Fapi%252Forg%252Feclipse%252Fjdt%252Fcore%252Fdom%252FASTNode.html">help.eclipse.org/mars/index.jsp?topic=%2Forg.eclipse.jdt.doc.isv%2Freference%2Fapi%2Forg%2Feclipse%2Fjdt%2Fcore%2Fdom%2FASTNode.</a> ) <br><br><h5>  Conversion algorithm </h5><br>  There is an abstract class with abstract methods loop () and setup () and with utility constants and methods digitalRead (int), analogRead (int), etc.  Abstract loop / setup methods are required for mandatory redefinition.  Utility methods and constants should emulate the behavior of Wiring - in the sketches for Arduino, you can refer to these methods / constants. <br><br>  The sketch inherits this base class (I called it BaseArduino) and implements the setup and loop methods. <br><br>  Next, just write the logic.  You can create methods, use variables.  To use third-party libraries, you need to create stub classes in Java that contain methods from these libraries and use these classes in your code.  Stub classes should be in a package with the name of the library that these classes implement.  The libraries themselves must be located in the folder parser / src / main / c in the folder with the name of the library.  When compiling already Wring code, these libraries will be used. <br><br>  Finally, the Java class is converted using Visitor, a successor of the org.eclipse.jdt.internal.core.dom.NaiveASTFlattener class ( <a href="http://www.cs.utep.edu/cheon/download/jml4c/javadocs/org/eclipse/jdt/internal/core/dom/NaiveASTFlattener.html">www.cs.utep.edu/cheon/download/jml4c/javadocs/org/eclipse/jdt/internal /core/dom/NaiveASTFlattener.html</a> ), in which some methods are redefined: <br>  <i>boolean visit (VariableDeclarationStatement), boolean visit (FieldDeclaration), boolean visit (MethodDeclaration)</i> - to track the use of classes from libraries and remove all modifiers (final, visibility modifiers and static).  Perhaps this is unnecessary, but so far it works. <br>  Also replaces the creation of the object: <br>  <i>decode_results results = new decode_results ();</i>  converts to <i>decode_results results ();</i> <br><br>  <i>boolean visit (MethodInvocation)</i> - to track calls to library classes and pass them to methods when passing them to methods (via &amp;): <br>  <i>irrecv.decode (results)</i> converts to <i>irrecv.decode (&amp; results)</i> <br><br>  If there are experts in C ++, tell me, do you always need to pass objects or are there any other options? <br><br>  6) All this is wrapped Gradle script that allows you to run the verification and loading the sketch. <br><br>  Example: <br><img src="https://habrastorage.org/files/94c/61d/15c/94c61d15c7bc4e1c8bc8ec8a692c93c0.png"><br>  Sketch compilation <br><br><img src="https://habrastorage.org/files/fa3/e68/25b/fa3e6825b84540f9be5d15037533f710.png"><br>  Download sketch <br><br>  As an example, I‚Äôll take a program for converting IR signals for speakers (there is a long history - Microlab Speakers Solo 6C speakers with a remote control, the remote stopped working after a few months, didn‚Äôt find the original, had to be replaced with a universal remote, but it was large, eventually made a signal converter on the Arduino from a small <a href="http://chipster.ru/catalog/arduino-and-modules/control-modules/2077.html">chipster.ru/catalog/arduino-and-modules/control-modules/2077.html</a> remote in signals for speakers). <br><br>  Java code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IrReceiverLib</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseArduino</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> REMOTE_CONTROL_POWER = <span class="hljs-number"><span class="hljs-number">0xFF906F</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> REMOTE_CONTROL_VOL_UP = <span class="hljs-number"><span class="hljs-number">0xFFA857</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> REMOTE_CONTROL_VOL_DOWN = <span class="hljs-number"><span class="hljs-number">0xFFE01F</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> REMOTE_CONTROL_REPEAT = <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_POWER = <span class="hljs-number"><span class="hljs-number">2155823295L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_VOL_DOWN = <span class="hljs-number"><span class="hljs-number">2155809015L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_VOL_UP = <span class="hljs-number"><span class="hljs-number">2155841655L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_BASS_UP = <span class="hljs-number"><span class="hljs-number">2155843695L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_BASS_DOWN = <span class="hljs-number"><span class="hljs-number">2155851855L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_TONE_UP = <span class="hljs-number"><span class="hljs-number">2155827375L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_TONE_DOWN = <span class="hljs-number"><span class="hljs-number">2155835535L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_AUX_PC = <span class="hljs-number"><span class="hljs-number">2155815135L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> SPEAKER_IR_REPEAT = <span class="hljs-number"><span class="hljs-number">4294967295L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IR_PIN = A0; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IRrecv irrecv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IRrecv(IR_PIN); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IRsend irsend = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IRsend(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> last_value = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ irrecv.enableIRIn(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ decode_results results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> decode_results(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (irrecv.decode(results) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> value = results.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == REMOTE_CONTROL_POWER) { last_value = SPEAKER_IR_POWER; irsend.sendNEC(SPEAKER_IR_POWER, <span class="hljs-number"><span class="hljs-number">32</span></span>); irrecv.enableIRIn(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == REMOTE_CONTROL_VOL_DOWN) { last_value = SPEAKER_IR_VOL_DOWN; irsend.sendNEC(SPEAKER_IR_VOL_DOWN, <span class="hljs-number"><span class="hljs-number">32</span></span>); irrecv.enableIRIn(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == REMOTE_CONTROL_VOL_UP) { last_value = SPEAKER_IR_VOL_UP; irsend.sendNEC(SPEAKER_IR_VOL_UP, <span class="hljs-number"><span class="hljs-number">32</span></span>); irrecv.enableIRIn(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == REMOTE_CONTROL_REPEAT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (last_value != <span class="hljs-number"><span class="hljs-number">0</span></span>) { irsend.sendNEC(last_value, <span class="hljs-number"><span class="hljs-number">32</span></span>); irrecv.enableIRIn(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { last_value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } }</code> </pre><br><br>  Converted to this code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;IRremote.h&gt; public static long REMOTE_CONTROL_POWER=0xFF906F; public static long REMOTE_CONTROL_VOL_UP=0xFFA857; public static long REMOTE_CONTROL_VOL_DOWN=0xFFE01F; public static long REMOTE_CONTROL_REPEAT=0xFFFFFFFF; public static long SPEAKER_IR_POWER=2155823295L; public static long SPEAKER_IR_VOL_DOWN=2155809015L; public static long SPEAKER_IR_VOL_UP=2155841655L; public static long SPEAKER_IR_BASS_UP=2155843695L; public static long SPEAKER_IR_BASS_DOWN=2155851855L; public static long SPEAKER_IR_TONE_UP=2155827375L; public static long SPEAKER_IR_TONE_DOWN=2155835535L; public static long SPEAKER_IR_AUX_PC=2155815135L; public static long SPEAKER_IR_REPEAT=4294967295L; public static int IR_PIN=A0; IRrecv irrecv(IR_PIN); IRsend irsend; long last_value=0; void setup(){ Serial.begin(256000); irrecv.enableIRIn(); } void loop(){ decode_results results; if (irrecv.decode(&amp;results) != 0) { long value=results.value; if (value == REMOTE_CONTROL_POWER) { last_value=SPEAKER_IR_POWER; irsend.sendNEC(SPEAKER_IR_POWER,32); irrecv.enableIRIn(); } else if (value == REMOTE_CONTROL_VOL_DOWN) { last_value=SPEAKER_IR_VOL_DOWN; irsend.sendNEC(SPEAKER_IR_VOL_DOWN,32); irrecv.enableIRIn(); } else if (value == REMOTE_CONTROL_VOL_UP) { last_value=SPEAKER_IR_VOL_UP; irsend.sendNEC(SPEAKER_IR_VOL_UP,32); irrecv.enableIRIn(); } else if (value == REMOTE_CONTROL_REPEAT) { if (last_value != 0) { irsend.sendNEC(last_value,32); irrecv.enableIRIn(); } else { } } else { last_value=0; } } }</span></span></span></span></code> </pre><br><br>  The code is simple - we get a signal and if it is a supported signal from the console, then we transform it into the corresponding signal for the speakers. <br><br>  And the signal conversion test: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(Parameterized.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRReceiverTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Parameterized</span></span>.Parameters(name = <span class="hljs-string"><span class="hljs-string">"{index}: Type={0}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Iterable&lt;Object[]&gt; data() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Arrays.asList(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[][]{ {<span class="hljs-string"><span class="hljs-string">"Power"</span></span>, IrReceiverLib.REMOTE_CONTROL_POWER, IrReceiverLib.SPEAKER_IR_POWER}, {<span class="hljs-string"><span class="hljs-string">"Vol down"</span></span>, IrReceiverLib.REMOTE_CONTROL_VOL_DOWN, IrReceiverLib.SPEAKER_IR_VOL_DOWN}, {<span class="hljs-string"><span class="hljs-string">"Vol up"</span></span>, IrReceiverLib.REMOTE_CONTROL_VOL_UP, IrReceiverLib.SPEAKER_IR_VOL_UP} }); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> remoteSignal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> speakerSignal; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IRReceiverTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> remoteSignal, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> speakerSignal)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.remoteSignal = remoteSignal; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speakerSignal = speakerSignal; } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IrReceiverLib irReceiverLib = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IrReceiverLib(); irReceiverLib.setup(); Assert.assertTrue(irReceiverLib.irrecv.isEnabled()); irReceiverLib.irrecv.receive(remoteSignal); irReceiverLib.loop(); Assert.assertEquals(speakerSignal, irReceiverLib.irsend.getLastSignal()); } }</code> </pre><br><br>  For the test, I added methods to the stub classes of the IRremote library, so that we could emulate the reception and transmission of the signal.  In the test, I initialize and transmit the signal to the sketch, then check that the signal sent from the sketch is as expected. <br><br>  The conversion is still very raw, but so far it performs the functions necessary for me.  Plus, I used TDD there and all the modest conversion possibilities are covered with tests, which will allow to change it without further loss of functionality (already tested - the code has already been rewritten once when adding support for libraries). <br><br>  In general, while for myself I stopped at my version of the conversion of Java to C. <br><br>  Remark about converting Java code to other languages.  Java code can be converted to JS.  Now there are several working options: GWT ( <a href="http://www.gwtproject.org/">www.gwtproject.org</a> ) and TeaVM ( <a href="https://github.com/konsoletyper/teavm">github.com/konsoletyper/teavm</a> ).  And they also use two different approaches - GWT converts the source code to JS, TeaVM - byte code. <br><br><h4>  useful links </h4><br>  It describes how to work Eclipse AST: <a href="http://habrahabr.ru/post/269129/">habrahabr.ru/post/269129</a> Parse Java program using java program <br>  Convert Groovy code into shaders: <a href="http://habrahabr.ru/post/269591/">habrahabr.ru/en/post/269591</a> Debugging Shaders in Java + Groovy <br>  AST analysis: <a href="http://habrahabr.ru/post/270173/">habrahabr.ru/post/270173</a> AST analysis using patterns </div><p>Source: <a href="https://habr.com/ru/post/274571/">https://habr.com/ru/post/274571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274561/index.html">New from Google. Is authentication safe without entering a password?</a></li>
<li><a href="../274563/index.html">Firefox will support non-standard CSS for compatibility with WebKit</a></li>
<li><a href="../274565/index.html">Creating a function on Rust that returns a String or & str</a></li>
<li><a href="../274567/index.html">Why is functional programming mainstream?</a></li>
<li><a href="../274569/index.html">Parallelism vs Concurrency: choosing the right tools</a></li>
<li><a href="../274573/index.html">Sunrise developeromics (ending)</a></li>
<li><a href="../274575/index.html">IBM continues to work with Apache Spark: corporation launches Spark-as-a-service</a></li>
<li><a href="../274577/index.html">Some modern approaches to natural language processing</a></li>
<li><a href="../274581/index.html">Docker compose and merge projects using mixer-a</a></li>
<li><a href="../274585/index.html">Eddystone and Physical Web: Beacon Evolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>