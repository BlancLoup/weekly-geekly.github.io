<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Beans with Annotations: Solving the Inheritance Problem for Annotation Interfaces</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Description of the problem 
 Suppose we have some class X parametrized from the PX property container and there is a class Y extending X parametrizing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Beans with Annotations: Solving the Inheritance Problem for Annotation Interfaces</h1><div class="post__text post__text-html js-mediator-article"><h4>  Description of the problem </h4><br>  Suppose we have some class X parametrized from the PX property container and there is a class Y extending X parametrizing the PY container extending PX. <br><br>  If the containers of properties are annotations, then we have two classes: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PX</span></span>(propertyX1 = &lt;valueX1&gt;, ..., propertyXN = &lt;valueXN&gt;) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  And there is a class: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PY</span></span>(propertyY1 = &lt;valueY1&gt;, ..., propertyYN = &lt;valueYN&gt;) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Y</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre><br>  Java (including Java 8) does not provide the ability to inherit annotations, so you cannot write something like an example below: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> PX extends PY { }</code> </pre><br>  Of course, this is not a problem, here is the solution: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PX</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ... propertyX1; ... <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ... propertyY1; X() { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PX px = getClass().getAnnotation(PX.class); propertyX1 = px.propertyX1(); ... propertyXN = px.propertyXN(); } } <span class="hljs-meta"><span class="hljs-meta">@PY</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Y</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span></span>{ Y() { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PY py = getClass().getAnnotation(PY.class); propertyY1 = py.propertyY1(); ... propertyYN = py.propertyYN(); } }</code> </pre><br><br>  What is the disadvantage here?  The disadvantage is that we doom ourselves that if a class does not have annotations, it will be configured with default values ‚Äã‚Äã(the PX and PY annotations must be @Inherited for this). <br><br>  What if we, for example, need to inject a property from a .properties file or take them from some other source, for example from a Spring Environment? <br><br>  If you do not resort to sophisticated tricks such as creating annotated classes on the fly with the substitution of annotation parameters, then nothing. <br><a name="habracut"></a><br><h4>  Solution example </h4><br>  Suppose we need to create an abstract class of a configurable service that has some Executor that performs certain tasks.  Let's call it AbstractService. <br>  The container for storing the properties of this service is the @CommonServiceParams annotation. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf.service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.ThreadPoolExecutor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.LogFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-comment"><span class="hljs-comment">/** * Abstract demo service. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> &lt;P&gt; Service parameters container type. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractService</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">P</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommonServiceParams</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoCloseable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Log log = LogFactory.getLog(getClass()); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> P parameters; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadPoolExecutor executor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AbstractService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(P parameters)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parameters = parameters; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> threadCount = parameters.threadCount() == <span class="hljs-number"><span class="hljs-number">0</span></span> ? Runtime.getRuntime().availableProcessors() : parameters.threadCount(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadPoolExecutor( threadCount, parameters.threadCount(), parameters.keepAlive(), parameters.timeUnit(), parameters.queueType().createBlockingQueue(parameters.queueSize()), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadPoolExecutor.CallerRunsPolicy() ); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ executor.shutdown(); } <span class="hljs-comment"><span class="hljs-comment">/** * Merges annotated parameters from class annotations. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> &lt;P&gt; Parameters type. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Merged parameters. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;P&gt; <span class="hljs-function"><span class="hljs-function">P </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeAnnotationParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServiceParameterUtils.mergeAnnotationParameters(); } <span class="hljs-comment"><span class="hljs-comment">/** * Get parameters from Spring environment. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> &lt;P&gt; Parameters type. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> prefix Environment prefix. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> environment Spring environment. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Parameters parsed from the environment. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;P&gt; <span class="hljs-function"><span class="hljs-function">P </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String prefix, Environment environment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServiceParameterUtils.parameters(prefix, environment); } }</code> </pre><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf.service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.ElementType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Inherited; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Retention; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.RetentionPolicy; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Target; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.TimeUnit; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.concurrent.BlockingQueueType; <span class="hljs-comment"><span class="hljs-comment">/** * Common service parameters. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.TYPE}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Inherited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> CommonServiceParams { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">threadCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> 0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keepAlive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> 0L</span></span>; <span class="hljs-function"><span class="hljs-function">TimeUnit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> TimeUnit.MILLISECONDS</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> 0</span></span>; <span class="hljs-function"><span class="hljs-function">BlockingQueueType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> BlockingQueueType.LINKED_BLOCKING_QUEUE</span></span>; }</code> </pre><br><br>  From this service we want to inherit the DemoService service, parameterized by the @DemoServiceParams annotation: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf.service.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.net.httpserver.HttpExchange; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.net.httpserver.HttpHandler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.net.httpserver.HttpServer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.HttpURLConnection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.InetSocketAddress; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.charset.StandardCharsets; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.annotation.PostConstruct; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.annotation.PreDestroy; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.AbstractService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.CommonServiceParams; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.ServiceParameterUtils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-comment"><span class="hljs-comment">/** * Demo service. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> &lt;P&gt; Demo service parameters container type. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoService</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">P</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommonServiceParams</span></span></span><span class="hljs-class"> &amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoServiceParams</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractService</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">P</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HttpServer httpServer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(P parameters)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(parameters); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpServer = HttpServer.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InetSocketAddress(parameters.host(), parameters.port()), <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpServer.setExecutor(executor); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpServer.createContext(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpHandler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpExchange he)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ he.getResponseHeaders().add(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain; charset=utf-8"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] message = <span class="hljs-string"><span class="hljs-string">"hello!"</span></span>.getBytes(StandardCharsets.UTF_8); he.sendResponseHeaders(HttpURLConnection.HTTP_OK, message.length); he.getResponseBody().write(message); } }); log.info(ServiceParameterUtils.reflectToString(<span class="hljs-string"><span class="hljs-string">"demoService"</span></span>, parameters)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(DemoService.&lt;P&gt;mergeAnnotationParameters()); <span class="hljs-comment"><span class="hljs-comment">// In Java 8 just call mergeAnnotationParameters() ;-) } public DemoService(String prefix, Environment environment) throws IOException { this(DemoService.&lt;P&gt;parameters(prefix, environment)); } @PostConstruct public void start() { httpServer.start(); log.info(getClass().getSimpleName() + " started"); } @PreDestroy public void stop() { httpServer.stop(parameters.shutdownTimeout()); log.info(getClass().getSimpleName() + " destroyed"); } }</span></span></code> </pre><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf.service.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.ElementType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Inherited; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Retention; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.RetentionPolicy; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Target; <span class="hljs-comment"><span class="hljs-comment">/** * Demo service parameters. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.TYPE}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Inherited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> DemoServiceParams { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">host</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "localhost"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">port</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> 8080</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shutdownTimeout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> 10</span></span>; }</code> </pre><br><br>  The key element here is the &lt;P extends CommonServiceParams &amp; DemoServiceParams&gt; declaration for the DemoService class. <br><br>  In order to create instances of P extends PA &amp; PB &amp; ... &amp; PZ, we need the following class: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf.service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.Annotation; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.InvocationHandler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Method; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Proxy; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Type; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.TypeVariable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.IdentityHashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.LinkedHashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Objects; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-comment"><span class="hljs-comment">/** * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unchecked"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceParameterUtils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> AnnotationParameters </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">annotationParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt;[] stack = ClassResolver.CLASS_RESOLVER.getClassContext(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; caller = stack[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Class&lt;? extends Annotation&gt;&gt; interfaces = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); Class&lt;?&gt; topCaller = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">3</span></span>; i &lt; stack.length &amp;&amp; caller.isAssignableFrom(stack[i]); i++) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; c = stack[i]; topCaller = stack[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c.getTypeParameters().length != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TypeVariable&lt;? extends Class&lt;?&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> = c.getTypeParameters()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Class&lt;? extends Annotation&gt;&gt; bounds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.getBounds().length); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type : <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.getBounds()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Class&lt;?&gt; &amp;&amp; ((Class&lt;?&gt;) type).isAnnotation()) { bounds.add((Class) type); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bounds.size() &gt; interfaces.size()) { interfaces.clear(); interfaces.addAll(bounds); } } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;Class&lt;? extends Annotation&gt;, List&lt;Annotation&gt;&gt; annotationMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityHashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">3</span></span>; i &lt; stack.length &amp;&amp; caller.isAssignableFrom(stack[i]); i++) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; c = stack[i]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;? extends Annotation&gt; itf : interfaces) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Annotation annotation = c.getAnnotation(itf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (annotation != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { List&lt;Annotation&gt; annotationList = annotationMap.get(itf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (annotationList == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { annotationMap.put(itf, annotationList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;()); } annotationList.add(<span class="hljs-number"><span class="hljs-number">0</span></span>, annotation); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnnotationParameters(topCaller, interfaces, annotationMap); } <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>({<span class="hljs-string"><span class="hljs-string">"element-type-mismatch"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;P&gt; <span class="hljs-function"><span class="hljs-function">P </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeAnnotationParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AnnotationParameters aParameters = annotationParameters(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (P) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), aParameters.annotations.toArray(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[aParameters.annotations.size()]), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvocationHandler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object proxy, Method method, Object[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"toString"</span></span>.equals(method.getName())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reflectToString(aParameters.topCaller.getSimpleName(), proxy); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; annotationClass = method.getDeclaringClass(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Annotation&gt; annotations = aParameters.annotationMap.containsKey(annotationClass) ? aParameters.annotationMap.get(annotationClass) : Collections.&lt;Annotation&gt;emptyList(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Annotation annotation : annotations) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object value = method.invoke(annotation, args); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.deepEquals(method.getDefaultValue(), value)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> method.getDefaultValue(); } }); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;P&gt; <span class="hljs-function"><span class="hljs-function">P </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String prefix, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Environment environment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AnnotationParameters aParameters = annotationParameters(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (P) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), aParameters.annotations.toArray(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[aParameters.annotations.size()]), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvocationHandler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object proxy, Method method, Object[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"toString"</span></span>.equals(method.getName())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reflectToString(prefix, proxy); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> environment.getProperty( prefix + <span class="hljs-string"><span class="hljs-string">"."</span></span> + method.getName(), (Class) method.getReturnType(), method.getDefaultValue()); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reflectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, Object proxy)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, Object&gt; map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedHashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Method method : proxy.getClass().getMethods()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.getDeclaringClass() == Object.class || method.getDeclaringClass() == Proxy.class) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (method.getName()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"toString"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"hashCode"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"annotationType"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.getParameterCount() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { map.put(method.getName(), method.invoke(proxy)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ReflectiveOperationException x) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(x); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name + map; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnnotationParameters</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; topCaller; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Class&lt;? extends Annotation&gt;&gt; annotations; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;Class&lt;? extends Annotation&gt;, List&lt;Annotation&gt;&gt; annotationMap; AnnotationParameters( Class&lt;?&gt; topCaller, List&lt;Class&lt;? extends Annotation&gt;&gt; annotations, Map&lt;Class&lt;? extends Annotation&gt;, List&lt;Annotation&gt;&gt; annotationMap) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.topCaller = topCaller; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.annotations = annotations; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.annotationMap = annotationMap; } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassResolver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecurityManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Class[] getClassContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getClassContext(); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ClassResolver CLASS_RESOLVER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassResolver(); } }</code> </pre><br><br>  As it is easy to guess from the code, the annotationParameters method gets the current call stack (this is necessary so that at the call stage this (...) or super (...) in the constructor to know which class we are dealing with. <br>  Then a list of annotation classes is created that can annotate this abstract class or any of its descendants. <br>  Then all these annotations are found and an instance of the Proxy type is formed, which ‚Äúlooks through‚Äù all the declared annotations and merges the values ‚Äã‚Äãfor a particular method call. <br><br>  This class also solves the problem with the property injection through the pro-field interface P, which extends the annotation interfaces PA, PB, ..., PZ.  Of course, it now becomes possible to get these annotations <b>at the stage of invoking the constructor</b> from a completely different source. <br><br>  Consider a specific example of property injection from a Spring Environment: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi.conf; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.demo.DemoService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.PropertySource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment; <span class="hljs-comment"><span class="hljs-comment">/** * Demo application configuration. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@PropertySource</span></span>(<span class="hljs-string"><span class="hljs-string">"classpath:/application.properties"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoApplicationConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Environment environment; <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DemoService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">demoService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoService(<span class="hljs-string"><span class="hljs-string">"demoService"</span></span>, environment); } }</code> </pre><br><br>  Here we get the properties from the application.properties file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Copyright 2014 Dmitry Ovchinnikov. # # Licensed under the Apache License, Version 2.0 (the "License"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an "AS IS" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. demoService.threadCount = 24 demoService.timeUnit = SECONDS demoService.keepAlive = 1 demoService.queueSize = 1024 demoService.queueType = ARRAY_BLOCKING_QUEUE demoService.port = 8080</span></span></code> </pre><br><br>  Write the entry point for the application: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.logging.LogFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.DemoApplicationConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.AnnotationConfigApplicationContext; <span class="hljs-comment"><span class="hljs-comment">/** * Demo entry-point class. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Log LOG = LogFactory.getLog(Demo.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String confPkgName = DemoApplicationConfiguration.class.getPackage().getName(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AnnotationConfigApplicationContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnnotationConfigApplicationContext(confPkgName)) { LOG.info(<span class="hljs-string"><span class="hljs-string">"Context "</span></span> + context + <span class="hljs-string"><span class="hljs-string">" started"</span></span>); context.start(); Thread.sleep(<span class="hljs-number"><span class="hljs-number">60_000L</span></span>); } } }</code> </pre><br><br>  After launch we get: <br><br><pre> -------------------------------------------------- ----------------------
 Building AnnotationServiceParameters 1.0-SNAPSHOT
 -------------------------------------------------- ----------------------<font></font>
<font></font>
 --- exec-maven-plugin: 1.2.1: exec (default-cli) @ AnnotationServiceParameters ---
 Nov 23, 2014 1:52:36 PM org.springframework.context.annotation.AnnotationConfigApplicationContext prepareRefresh
 INFO: Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@50040f0c: startup date [Sun Nov 23 13:52:36 FET 2014];  root of context hierarchy
 Nov 23, 2014 1:52:36 PM org.dimitrovchi.conf.service.demo.DemoService &lt;init&gt;
 INFO: demoService {shutdownTimeout = 10, threadCount = 24, keepAlive = 1, timeUnit = SECONDS, queueType = ARRAY_BLOCKING_QUEUE, queueSize = 1024, host = localhost, port = 8080}
 Nov 23, 2014 1:52:36 PM org.dimitrovchi.conf.service.demo.DemoService start
 INFO: DemoService started
 Nov 23, 2014 1:52:36 PM org.dimitrovchi.Demo main
 INFO: Context org.springframework.context.annotation.AnnotationConfigApplicationContext@50040f0c: startup date [Sun Nov 23 13:52:36 FET 2014];  root of context hierarchy started
 Nov 23, 2014 1:53:36 PM org.springframework.context.annotation.AnnotationConfigApplicationContext doClose
 INFO: Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@50040f0c: startup date [Sun Nov 23 13:52:36 FET 2014];  root of context hierarchy
 Nov 23, 2014 1:53:46 PM org.dimitrovchi.conf.service.demo.DemoService stop
 INFO: DemoService destroyed
 -------------------------------------------------- ----------------------
 BUILD SUCCESS
 -------------------------------------------------- ----------------------
 Total time: 01:10 min
 Finished at: 2014-11-23T13: 53: 46 + 03: 00
 Final Memory: 8M / 304M
 -------------------------------------------------- ----------------------
</pre><br><br>  As you can see, all the parameters ‚Äústretched‚Äù correctly from the prop. <br><br>  Now make an entry point for the annotated class: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2014 Dmitry Ovchinnikov. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.dimitrovchi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.CommonServiceParams; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.demo.DemoService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.dimitrovchi.conf.service.demo.DemoServiceParams; <span class="hljs-comment"><span class="hljs-comment">/** * Annotated service demo. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Dmitry Ovchinnikov */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnnotatedServiceDemo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AnnotatedDemoService service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnnotatedDemoService()) { service.start(); Thread.sleep(<span class="hljs-number"><span class="hljs-number">60_000L</span></span>); service.stop(); } } <span class="hljs-meta"><span class="hljs-meta">@CommonServiceParams</span></span>(threadCount = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DemoServiceParams</span></span>(port = <span class="hljs-number"><span class="hljs-number">8888</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnnotatedDemoService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnnotatedDemoService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ } } }</code> </pre><br><br>  After launch: <br><br><pre> -------------------------------------------------- ----------------------
 Building AnnotationServiceParameters 1.0-SNAPSHOT
 -------------------------------------------------- ----------------------<font></font>
<font></font>
 --- exec-maven-plugin: 1.2.1: exec (default-cli) @ AnnotationServiceParameters ---
 Nov 23, 2014 1:55:47 PM org.dimitrovchi.AnnotatedServiceDemo $ AnnotatedDemoService &lt;init&gt;
 INFO: demoService {host = localhost, port = 8888, threadCount = 1, shutdownTimeout = 10, keepAlive = 0, timeUnit = MILLISECONDS, queueType = LINKED_BLOCKING_QUEUE, queueSize = 0}
 Nov 23, 2014 1:55:47 PM org.dimitrovchi.AnnotatedServiceDemo $ AnnotatedDemoService start
 INFO: AnnotatedDemoService started
 Nov 23, 2014 1:56:57 PM org.dimitrovchi.AnnotatedServiceDemo $ AnnotatedDemoService stop
 INFO: AnnotatedDemoService destroyed
 -------------------------------------------------- ----------------------
 BUILD SUCCESS
 -------------------------------------------------- ----------------------
 Total time: 01:10 min
 Finished at: 2014-11-23T13: 56: 58 + 03: 00
 Final Memory: 8M / 304M
 -------------------------------------------------- ----------------------
</pre><br><br>  As you can see, the service was launched on port 8888 with the number of threads 1. <br><br><h4>  Conclusion </h4><br>  So, we have a small framework to create parameterized services, and it is possible to transfer parameters using annotations as well as inject properties from other sources. </div><p>Source: <a href="https://habr.com/ru/post/244015/">https://habr.com/ru/post/244015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244003/index.html">Information Project Management Methodologies</a></li>
<li><a href="../244007/index.html">Polyphasic sleep: reviews, "theory", personal experience</a></li>
<li><a href="../244009/index.html">How I tortured Selenium tests for GAE Django and what came to the end</a></li>
<li><a href="../244011/index.html">How to increase the speed of communication and productivity: The introduction of Vim ideology in the messenger</a></li>
<li><a href="../244013/index.html">HungryBread - a startup about a lunch in a pleasant company</a></li>
<li><a href="../244017/index.html">Pseudo-practical example of closures and decorators</a></li>
<li><a href="../244023/index.html">CryptSync and GnuPG - customization options and inability to use</a></li>
<li><a href="../244027/index.html">We analyze the proxying methods based on HAProxy</a></li>
<li><a href="../244029/index.html">Corporate software: main trends and why they are important</a></li>
<li><a href="../244031/index.html">Protect .net applications from prying eyes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>