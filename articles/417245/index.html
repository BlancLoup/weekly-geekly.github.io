<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Erlang for IoT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The wave of interest in microelectronic devices and their interaction with each other for industrial and domestic needs led to the development of a la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Erlang for IoT</h1><div class="post__text post__text-html js-mediator-article">  The wave of interest in microelectronic devices and their interaction with each other for industrial and domestic needs led to the development of a large number of designers to develop on the basis of sufficiently powerful SoC (systems on a chip), fairly miniature with respect to microcontroller solutions, but already containing a full-fledged operating system.  Developing applications for such designers is practically no different from the usual server development, except for the fact that the resource limit still needs to be kept in mind. <br><br><img src="https://habrastorage.org/webt/sv/dz/4k/svdz4kyrpxvjmt-0soj6xodo14g.jpeg"><br><a name="habracut"></a><br>  As productivity and capabilities grow, the practice of using interpreted high-level languages ‚Äã‚Äãsuch as Lua, Python, JS for application development is gaining momentum.  Some languages ‚Äã‚Äãgradually penetrate into the "younger brothers", microcontrollers, however, in a very limited version. <br><br>  There are several reasons for this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Rapid prototyping - with all due respect to the C language, which mainly develops for microcontrollers, it is very difficult to call it concise.  High-level languages ‚Äã‚Äãallow you to write less code and make it easier to make changes to what is already written, which is very important at the stage of creating a prototype; </li><li>  automatic memory management and abstraction of the mechanisms of complex calculations - I think, does not need comments, both processes in manual execution with a sufficient volume of the project turn into a source of a large number of headaches; </li><li>  Simplify debugging and testing - it is easier to check the interpreted code at the workstation until the moment of field testing </li><li>  the struggle with complexity - often, high productivity gives rise to a natural pragmatic desire to cram more preprocessing and analysis onto the device, which does not add to the simplicity of development. </li></ul><br>  Alas, for all the convenience you have to pay.  In this case, the price for convenience is the most valuable resources, performance, and code size (in many cases, you have to carry with you a rather voluminous execution environment).  Therefore, the field application of high-level languages ‚Äã‚Äãin SoC and SoM is ambiguous and, at times, a compromise. <br><br>  We use the Erlang language for development, applying it both for its intended purpose (creating server applications and the control plane), and very unusual - web applications.  Therefore, the idea to use the infrastructure of this language to create IoT solutions arose long before the appearance of boards on which the Erlang runtime environment could work without problems. <br><br>  There were many reasons to use Erlang: <br><br><ul><li>  Erlang is very convenient for parsing and creating binary sequences.  Pattern matching (paired matching) paired with bit data processing allows implementing binary protocols very quickly and concisely; </li><li>  the absence of global variables and immobility for most data - allows you to write and, last but not least, support reliable applications in which it is difficult to accidentally change something that is not right; </li><li>  lightweight messaging processes, very much like what embedded developers have to deal with.  In essence, they are an initialization procedure and a procedure that, in an infinite loop, processes incoming messages, changing the internal state.  Very similar to Arduino, only processes can be many and they work in parallel, moreover, in the interval between messages, the processing procedure can be changed on the fly (hot code reload), which is very convenient in the case when you need to correct minor errors or correct behavior; </li><li>  isolated environment and automatic memory allocation, I think, do not need an explanation; </li><li>  cross-platform - the byte code for the ERTS runtime can be assembled on the developer's machine, and then transferred to the target device without any problems; </li><li>  Excellent introspection tools - the ability to connect to a running application over the network and see that it slows down so often is very useful. </li></ul><br>  The first working board on which we tried Erlang was <a href="https://www.8devices.com/products/carambola-2">Carambola 2 8devices</a> Lithuanian developers assembled on the popular AR9331 chip.  The first version of this board, alas, did not have enough flash memory to put the runtime environment.  But the second version already allowed itself to accommodate both ERTS and a small application. <br><br><img src="https://habrastorage.org/webt/bw/hy/pc/bwhypc6udycl3pa3umaj13_enck.jpeg"><br><br>  The installation was carried out using the classic method for such devices - building an OpenWRT image containing Erlang, followed by flashing it into the device's flash-memory.  The first launch of Wednesday, alas, led to disappointment - everything hung.  The reasons for this I have already <a href="https://www.youtube.com/watch%3Fv%3DCns_pqejk9g">told at the conference InoThings 2018</a> , but, alas, as it turned out, I misled my colleagues, mistakenly naming the source of such behavior. <br><br>  Briefly retell.  When working with files, the ERTS virtual machine uses the <i>off_t</i> type, the size of which in the distribution kit is calculated during the autoconfiguration of the assembly (if it runs on the target platform) or is substituted from the cross-compilation environment, as it happened in the case of OpenWRT.  It is not clear why, but in the settings for MIPS processors and derivatives in the configuration file of the assembly is twice the size than it is in fact.  There would be no problem if the virtual machine code used non-preprocessor directives like <br><br><pre><code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SIZEOF_OFF_T == 4</span></span></code> </pre> <br>  and a banal check in the code (I suspect that the final result of the compilation would be the same, but the check did not have enough fuse): <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">off_t</span></span>) == <span class="hljs-number"><span class="hljs-number">4</span></span>) {</code> </pre> <br>  As a result, the file collected at the first ERTS iteration, when trying to read the <i>~ / .erlang.cookie</i> file at startup (a kind of password for identification during network interaction), successfully received garbage in the upper digits and hung up with a crash. <br><br>  <a href="">The patching patch</a> and package with the penultimate version of ERTS for OpenWRT can be downloaded from <a href="https://github.com/mkrentovskiy/openwrt-repo">GitHub</a> .  In addition, there were no problems yet, everything worked as expected. <br><br>  The second hardware platform on which we tried Erlang was <a href="https://www.seeedstudio.com/LinkIt-Smart-7688-p-2573.html">LinkIt Smart 7688</a> designer from Mediatek and <a href="https://www.seeedstudio.com/">SeeedStudio</a> , specially created for rapid prototyping and learning the basics.  This board is just the apotheosis of debauchery in terms of resources - the frequency of the MIPS core increased one and a half times, more RAM (for ERTS it matters, GC does not sleep) and more flash memory, as well as the presence of a MicroSD card and the possibility of using the Atmel co-processor Atmega 32U4 in <a href="https://www.seeedstudio.com/LinkIt-Smart-7688-Duo-p-2574.html">the Duo version</a> for working with peripherals. <br><img src="https://habrastorage.org/webt/8m/fb/cf/8mfbcfrgfnfdc7tnjkvicni19hg.png"><br>  In general, the platform was very suitable for the continuation of the banquet, and the presence of additional connected devices, connecting without soldering, allows you to quickly and conditionally assemble a stand on the knee for testing. <br><br>  Included with the platform is software with its own web-interface, as well as with Python and NodeJS-libraries for development.  The assembly ecosystem has not changed - this is still OpenWRT.  If for some reason you think that all this diversity is superfluous, then there are packages on the aforementioned repository containing the <a href="https://github.com/mkrentovskiy/openwrt-repo/tree/master/linkit">minimum set of required components</a> .  After assembly, the flash memory image is written to the device and after a reboot, you can safely use the REPL. <br><br>  To build applications on Erlang for IoT, it is necessary to solve one architectural issue. <br><br>  The language was designed and developed with an eye to what the control plane will serve, i.e.  control layer, while working with iron was assumed by FFI.  For this there are three types of interaction: <br><br><ol><li>  ports (ports) - separately working processes written in any language, interaction with which occurs through input / output streams.  They can be restarted in case of a fall, but due to the interaction method, their performance in terms of communication is small (however, it will be enough for us); </li><li>  NIF functions look like standard language functions, but their call causes the execution of compiled code in the runtime environment.  In case of an error, they can drag out the entire virtual machine. </li><li>  C-node - when the work is performed entirely in a separate process, and the interaction is carried out as with a separately running runtime over the network.  We will not consider this option due to sufficiently large overhead within one weak device. </li></ol><br>  The dilemma is as follows - we can bring only transport items to FFI (that is, support for GPIO, I2C, SPI, PWM, UART, etc.), and interact directly with sensors and other devices on Erlang, or on the contrary, it is possible to take out device drivers entirely in the code of external modules, leaving the application to receive raw data and process them; in this case, it may make sense to use the code already written. <br><br>  We decided to use the first option.  There are several reasons for this: <br><br><ul><li>  because we can; </li><li>  as I already mentioned, Erlang has powerful enough tools for assembling and disassembling binary sequences, and quite simple math, which does not care about overflow protection and other magic used for processing results.  Not that this magic is scary, but it acts shockingly on neophytes; </li><li>  intuitively, it seemed that drivers in a high-level language would be simpler and more reliable (the crashed process will restart the supervisor, which will lead to the reinitialization of the monitored device). </li></ul><br>  Therefore, the <a href="https://github.com/esl/erlang_ale">ErlangALE</a> library was quickly found, which contained already implemented support for GPIO, I2C and SPI through the kernel interfaces, and the developers of the hardware platform, in turn, took care of them.  We already had a <a href="https://github.com/relabsoss/uart">library for working with UART</a> , plus we <a href="https://github.com/saleyn/erlexec">added erlexec</a> , a supplement that allows us to create and manage OS processes. <br><br>  All of these applications used ports (separately launched binary processes) for working with hardware and operating systems, which required cross-compilation support for C and C ++ languages, for which a rather <a href="">elaborate shell script</a> was written that configures the build environment to use the necessary compilers. <br><br>  To test the decisions we made, we assembled a simple device from the LinkIt Smart 7866, two I2C devices (a temperature and pressure sensor BMP280 and an OLED display 128 at 64 points) and a USB GPS module that provides UART data.  The GPIO was tested on the LED on the board, it works, and connecting the SPI display seemed unnecessary at this stage. <br><br><img src="https://habrastorage.org/webt/y-/sg/fk/y-sgfkmhneogiscctg6qs8a20ou.jpeg"><br><br>  It turned out quite compact and simple application, the <a href="https://github.com/relabsoss/erlem">source code</a> can be viewed on Github. <br><br>  I will not delve into the code snippets, but will try to briefly describe how the application works. <br><br>  All device drivers are implemented as gen_server processes, which is convenient because it allows you to add additional parameters to the state and, sometimes, the state of the device.  The latter can be seen in the example of <a href="">uart_gps</a> - data from the UART <a href="">arrives</a> asynchronously, is <a href="">parsed by the NMEA0183 parser,</a> and the results are written to the state of the process, from which they are retrieved by request. <br><br>  The main application cycle is described in the <a href="">gps_temp_display</a> module - every second the process reads GPS data and requests the temperature and pressure status from the BMP280 and outputs them to the OLED display.  For the sake of interest, you can look at <a href="">the display drivers</a> and the <a href="">BMP280 sensor</a> - everything turned out quite succinctly, 150-170 lines per module. <br><br>  In general, the above task (writing driver code, combining everything into one application, building and testing) took about four evenings of two hours on average, i.e.  strictly speaking - a couple of working days.  As I personally think, this is a good indicator to try to use Erlang in more complex and serious embedded applications that do not require strict real-time restrictions. <br><br>  Of course, our attempts to use Erlang for embedded systems are not the only ones.  There are several interesting projects on this subject: <br><br><ul><li>  <a href="https://nerves-project.org/">nerves-project.org</a> - aims to create an embedded ecosystem based on Elixir; </li><li>  <a href="https://www.grisp.org/">www.grisp.org</a> - an even more radical approach, involving the launch of ERTS directly on the gland (bare metal Erlang system); </li><li>  <a href="https://github.com/bettio/AtomVM">github.com/bettio/AtomVM</a> and <a href="https://github.com/cloudozer/ling">github.com/cloudozer/ling</a> - attempts to create a compact version of ERTS, suitable for use in microcontrollers and weak SoC / SoM. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/417245/">https://habr.com/ru/post/417245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417235/index.html">How online stores lose money because of the address on the order form</a></li>
<li><a href="../417237/index.html">What the developers are listening to: from classics to game soundtracks - we discuss the most interesting</a></li>
<li><a href="../417239/index.html">The digest of interesting materials for the mobile developer # 261 (July 9 - July 15)</a></li>
<li><a href="../417241/index.html">S3 metadata in PostgreSQL. Yandex lecture</a></li>
<li><a href="../417243/index.html">Install the 3CX SBC Session Border Controller on Windows, Raspberry Pi or Debian 9</a></li>
<li><a href="../417247/index.html">VSCE # 1: a podcast about media entrepreneurs</a></li>
<li><a href="../417249/index.html">The US Accounts Chamber warns: SpaceX and Boeing are waiting for new delays, it is possible that the United States will have a break in flights to the ISS</a></li>
<li><a href="../417251/index.html">Using the Fish eye camera on a Raspberry Pi 3 with ROS - part 1</a></li>
<li><a href="../417255/index.html">Lego Mindstorms cuckoo clock</a></li>
<li><a href="../417257/index.html">C pointers as a linguistic paradox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>