<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android Process: I gave birth to you, I you and ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever thought about what happens to your application after the system has killed its process as unnecessary? Sadly, many people don‚Äôt even wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android Process: I gave birth to you, I you and ...</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b79/1de/41e/b791de41e9634b99b5ba085dbc1c8cea.jpg"><br><br>  Have you ever thought about what happens to your application after the system has killed its process as unnecessary?  Sadly, many people don‚Äôt even worry about it, as if it would happen in a parallel universe, and it doesn‚Äôt concern them.  Beginners are especially affected.  Their blind faith in the steadfastness of link statics is simply amazing. <br><br>  In this article I will talk about some of the mistakes that may arise as a result of violation of the sixth commandment (do not kill) in relation to the application process, and how to check how well it returns from the next world. <br><a name="habracut"></a><br>  It's no secret that the process can be killed by the system.  And you were interested in, is it possible to imitate it?  You can try to ‚Äúunleash‚Äù the system on your application, launching a bunch of other applications that eat up a notable piece of memory, and then hope that the system did come down to us by killing the desired application.  Directly some kind of shamanism turns out, and this is the path of the admins, but not the programmers.  I was interested in how you can quickly and easily kill the application, so much as if the system did it to release resources.  After all, if we succeed in repeating such behavior in ‚Äúlaboratory conditions‚Äù, it will be possible to catch a lot of errors at the development stage, or easily reproduce them to identify the causes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As it turned out, the necessary mechanism is already available in the SDK, and this is ... drumming ... The "Terminate Application" button. <br><br><img src="https://habrastorage.org/files/97e/935/854/97e935854ebf41fcb529d792942fa656.png"><br><br>  Clicking on it is similar to executing the following code: <br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//       . // ,   "Terminate Application"   ‚Äú1‚Äù. System.exit(1);</span></span></code> </pre>  This, in fact, kills the process.  A similar action occurs when the system tries to get rid of an unnecessary process. <br><br>  In order to reproduce the situation with the resumption of the application after it is completely stopped, the following sequence of actions should be done: <br><ol><li>  Using Android Stidio run the app; </li><li>  Minimize the application by pressing the ‚ÄúHome‚Äù button; </li><li>  In Android Studio, go to the Android tab, select the application and click the "Terminate Application" button; </li><li>  Deploy a minimized application. </li></ol><br>  If the Activity does not quite correctly handle the restore after destruction, you will immediately notice it.  At best, it will fall, at worst, it will hang. <br><br>  So, we have learned to lure one of the most secretive types of errors.  Let's learn to foresee these mistakes.  Let's start with the most obvious cases, and then move on to less unambiguous cases. <br><br><h2>  Situation 1: Static is not reliable </h2><br>  Imagine this situation: In one Activity, we enter a certain set of data, for example, a first and last name.  This Activity strictly monitors the correctness of data entry, so it is possible to guarantee their ‚Äúcorrectness‚Äù with firm confidence, and in general that they have been entered. <br><div class="spoiler">  <b class="spoiler_title">First Activity</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticActivityFirst</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EditText mEditFirstName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EditText mEditLastName; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.sit01_0_activity_first); mEditFirstName = (EditText) findViewById(R.id.editFirstName); mEditLastName = (EditText) findViewById(R.id.editLastName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNextClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ String firstName = mEditFirstName.getText().toString().trim(); <span class="hljs-comment"><span class="hljs-comment">//      if (TextUtils.isEmpty(firstName)) mEditFirstName.setError(getString(R.string.sit01_0_empty_text_error_message)); else { mEditFirstName.setError(null); String lastName = mEditLastName.getText().toString().trim(); //      if (TextUtils.isEmpty(lastName)) mEditLastName.setError(getString(R.string.sit01_0_empty_text_error_message)); else { mEditLastName.setError(null); StaticActivitySecond.sPerson = new Person(firstName, lastName); startActivity(new Intent(this, StaticActivitySecond.class)); } } } }</span></span></code> </pre></div></div>  After clicking the ‚ÄúNext‚Äù button, an object is created that stores the entered data and a link is recorded in the static, and then the second Activity is opened, which shows this data in the appropriate form.  For example, writes: "Your name is Vladimir Putin." <br><div class="spoiler">  <b class="spoiler_title">Second Activity</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticActivitySecond</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Person sPerson; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.sit01_0_activity_second); TextView txtSummary = (TextView) findViewById(R.id.txtSummary); txtSummary.setText(String.format(getString(R.string.sit01_0_summary_message), sPerson.firstName, sPerson.lastName)); } }</code> </pre></div></div>  As you can see from the code, in the first Activity the developer decided not to ‚Äúbother‚Äù and put the data in static variables.  This is very tempting when you need to transfer a rather extraordinary object that is not amenable to simple serialization.  He also did not think long over the second Activity and did not check for zero.  Why, when the first Activity has already done everything? <br><br>  We perform the sequence described earlier for correctly destroying the process for the second Activity.  Application falls. <br><br>  <b>What happened?</b> <br>  The problem here is not the absence of a check for null.  The worst problem is the loss of user data.  Static objects should not be a data warehouse, especially if this is their only place.  This applies to both ordinary variables and singletons.  So if something important is stored in statics, be prepared to lose this important one at any moment. <br><br>  <b>What to do?</b> <br>  The presence of such errors often indicates a low qualification of the programmer, or an excessively high sense of laziness.  About how to do correctly, it is written a huge number of tutorials.  In this example, the best way is to transfer data through a bundle.  You can also write this data in SharedPreferences, or you should think about creating a database. <br>  <b>Important:</b> Do not forget that singleton is also a static variable.  If you use singleton, then it should act only as a tool to facilitate access to data, but not to be the only repository for them. <br><br>  <b>Magic Power Application</b> <br>  How often do I see tips to use the Application class as a singleton or to initialize a singleton in the onCreate () method of the Application class.  Allegedly, after that he will become steeper than Lenin, that is, he will be more alive than all living under any circumstances.  Perhaps this is a special case of error found only by me.  Moreover, all the publications that I found, clearly do not declare such properties of Singleton.  Some of them say that a singleton can be destroyed by the garbage collector if you initiate it in the Activity class (which sounds a little crazy to me).  In others, they are afraid of unloading the class from the classifier (and this already seems to be true). <br><br>  Now I am not going to find out what is true here and what is speculation.  In any case, this only reduces the likelihood of losing static links, but neither does it help to stop the process.  Stopping the process will lead to the complete destruction of the classifier, and with it the destruction of all classes, including the class Application. <br><br><h2>  Situation 2: setRetainInstance as a solution to all problems </h2><br>  Suppose a certain programmer decided to repeat the example with the name and surname, but using the dialogue of fragments. <br>  So, there is a DialogFragment with a text box for entering the last name and first name.  This fragment can be assigned a listener for data entry.  In order not to lose the reference to the listener in onCreate () is called setRetainInstance (true). <br><div class="spoiler">  <b class="spoiler_title">Part of the dialogue code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Situation2DialogFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogFragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OnPersonChooseListener mListener; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setRetainInstance(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OnPersonChooseListener listener)</span></span></span><span class="hljs-function"> </span></span>{ mListener = listener; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invokePersonChoose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person)</span></span></span><span class="hljs-function"> </span></span>{ mListener.onPersonChoose(person); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnPersonChooseListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPersonChoose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person)</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre></div></div><br>  There is a button on the screen, when clicked, this dialog is displayed. <br><div class="spoiler">  <b class="spoiler_title">Calling a dialogue from the Activity</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChoosePersonClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ Situation2DialogFragment dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Situation2DialogFragment(); dialog.setListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Situation2DialogFragment.OnPersonChooseListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPersonChoose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person)</span></span></span><span class="hljs-function"> </span></span>{ Toast.makeText( Situation2Activity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, String.format( getString(R.string.sit02_summary_message), person.firstName, person.lastName), Toast.LENGTH_SHORT ).show(); } }); dialog.show(getSupportFragmentManager(), Situation2DialogFragment.class.getName()); }</code> </pre></div></div><br>  Such an implementation is resistant to any screen rotations.  Everything will work like a clock.  For the time being ... <br>  We apply a sequence of actions for the cunning destruction process when the dialogue is open.  When deployed, nothing will happen.  However, when invokePersonChoose is called, the application will crash with a NullPointerException. <br><br>  <b>What happened?</b> <br>  setRetainInstance (true) did not allow the dialog to be destroyed.  After the destruction of the process, the dialogue was nevertheless destroyed.  Activity restores the snippet as much as possible.  Unfortunately, the listener is not restored, as it was installed in a completely different place for a completely different object.  When in a dialog, in the invokePersonChoose method, a call is made to the listener, an exception is thrown.  And the trouble is not in the absence of checking for null.  Putting a check on null without a proper reaction to an empty link would be an even <b>worse</b> solution. <br><br>  <b>What to do?</b> <br>  The Internet describes a bunch of ways to transfer messages from the fragment in the Activity.  Unfortunately, not all of them are correct.  The following method is correct and one of my favorites: <br><ul><li>  Activity implements the desired interface: <br><div class="spoiler">  <b class="spoiler_title">Part of the Activity Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Situation2Activity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnPersonChooseListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ @Override public void onPersonChoose(Person person) { Toast.makeText( Situation2Activity.this, String.format( getString(R.string.sit02_summary_message), person.firstName, person.lastName), Toast.LENGTH_SHORT ).show(); } }</span></span></code> </pre></div></div></li><li>  The fragment receives a link to the Activity via getActivity and leads it to the corresponding interface.  Then all the work is done through the interface: <br><div class="spoiler">  <b class="spoiler_title">Getting a listener in snippet</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAttach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Activity activity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onAttach(activity); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> OnPersonChooseListener) mListener = (OnPersonChooseListener) activity; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Activity must implement OnPersonChooseListener."</span></span>); }</code> </pre></div></div></li></ul><br>  The only thing you should not forget is that Activity can already be destroyed when it comes to sending a message.  Therefore, be sure to check whether the fragment is added to the Activity. <br>  By passing Activity, you can use the parent fragment or Target fragment. <br><br>  <b>Just a couple of words about setRetainInstance</b> <br>  I note this is only a special case with setRetainInstance.  The number of problems that he can hide (and not solve) a little more.  Together with the listeners, all other variables are also lost.  Anything that was not stored in the onSaveInstanceState method will be lost. <br>  Also, it hides the problem when the dialog class is anonymous.  Suppose, at the moment of creating a new dialog object, some method is redefined, in this case an object of an anonymous class will be created. <br><div class="spoiler">  <b class="spoiler_title">An example of creating an object with an anonymous class</b> <div class="spoiler_text"><pre> <code class="java hljs">DialogFragment dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DialogFragment() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setRetainInstance(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } };</code> </pre></div></div><br>  If this dialog is destroyed and the system tries to restore it, a ClassNotFoundException exception is thrown. <br><br><h2>  Situation 3: Broken threads </h2><br>  Let the essence of the application be as follows: <br>  On-screen button.  When you click on the button, a progress dialog opens, blocking interaction with the UI. <br><div class="spoiler">  <b class="spoiler_title">Progress dialogue code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProgressDialogFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogFragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String DISMISS_ACTION = <span class="hljs-string"><span class="hljs-string">"ru.kamisempai.ProgressDialogFragment.DISMISS_ACTION"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isWaitingForDismiss = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BroadcastReceiver mDismissActionReceiver; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAttach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Activity activity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onAttach(activity); mDismissActionReceiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ dismiss(); } }; LocalBroadcastManager.getInstance(activity) .registerReceiver(mDismissActionReceiver, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(DISMISS_ACTION)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDetach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mDismissActionReceiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) LocalBroadcastManager.getInstance(getActivity()) .unregisterReceiver(mDismissActionReceiver); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDetach(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Dialog </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> android.app.ProgressDialog dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> android.app.ProgressDialog(getActivity()) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBackPressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// do nothing } }; dialog.setMessage("Please wait..."); dialog.setCancelable(false); dialog.setCanceledOnTouchOutside(false); return dialog; } @Override public void onResume() { super.onResume(); if(isWaitingForDismiss) dismiss(); } @Override public void dismiss() { if(isResumed()) super.dismiss(); else isWaitingForDismiss = true; } }</span></span></code> </pre></div></div><br>  As you can see from the code, this dialog can be closed by sending a broadcast message.  This means that there is no need to keep a link to it, it is enough to have the application context. <br>  Immediately after starting the dialogue, a thread is started that performs something for a while.  At the very end of its work, the thread sends a message to close the progress dialog. <br><div class="spoiler">  <b class="spoiler_title">Creating and running a stream</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartActionClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProgressDialogFragment() .show(getSupportFragmentManager(), ProgressDialogFragment.class.getName()); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Context context = getApplicationContext(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } LocalBroadcastManager.getInstance(context) .sendBroadcast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(ProgressDialogFragment.DISMISS_ACTION)); } }.start(); }</code> </pre></div></div><br>  If you run this code and without waiting for it to terminate the application, and then cut down the process, then when deploying nothing foreshadows trouble, the application does not crash, and the dialog is shown.  We are waiting a little ... We are still waiting ... Then we are still waiting ... The dialogue does not close, although it should have been done for a long time. <br><br>  <b>What happened?</b> <br>  When a process is destroyed, all its threads are stopped, and during recovery only the main thread is started.  So if your thread is running too long, be prepared for the fact that it will be stopped.  And it is not necessary to do something for a long time, you can also step on this rake when using wait notify.  It will be especially funny if the public static final Object is used as a blocking object, because we already know that static objects are no exception when the process is destroyed. <br><div class="spoiler">  <b class="spoiler_title">Example with wait notify</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object LOCK = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartWaitClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... new Thread() { @Override public void run() { synchronized (LOCK) { try { //    . LOCK.wait(); } catch (InterruptedException e) { e.printStackTrace(); } } //    } }.start(); } public void onContinueClick(View view) { new Thread() { @Override public void run() { synchronized (LOCK) { LOCK.notify(); } } }.start(); }</span></span></code> </pre></div></div><br>  <b>What to do?</b> <br>  If the task takes a long time to put it into a separate service and run it in a new process, plus bring out the foreground Notification, otherwise the process will still be killed.  In the case of wait notify, everything is a little more complicated and depends on the specific situation.  In general, the topic of working with threads is quite extensive, and it is inappropriate to give any specific advice here.  Do not complicate and do not climb into the jungle, from which you can not get out. <br><br><h2>  Situation 4: Letter to Nowhere </h2><br>  There is an Activity with a single View.  She is subscribed to receive broadcast messages.  When an Activity receives such a message, the color of the View changes depending on the content of this message.  When you click on the View, the second Activity opens, through which you can send the same messages to change the color. <br><div class="spoiler">  <b class="spoiler_title">First Activity Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Situation4FirstActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String ACTION_SET_COLOR = <span class="hljs-string"><span class="hljs-string">"ru.kamisempai.Situation4FirstActivity.ACTION_SET_COLOR"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String EXTRA_COLOR = <span class="hljs-string"><span class="hljs-string">"ru.kamisempai.Situation4FirstActivity.EXTRA_COLOR"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> View mView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BroadcastReceiver mSetColorActionReceiver; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); mView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); setContentView(mView); mView.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   Activity startActivity(new Intent(Situation4FirstActivity.this, Situation4SecondActivity.class)); } }); mSetColorActionReceiver = new BroadcastReceiver() { @Override public void onReceive(Context context, final Intent intent) { //    view     runOnUiThread(new Runnable() { @Override public void run() { mView.setBackgroundColor(intent.getIntExtra(EXTRA_COLOR, Color.BLUE)); } }); } }; LocalBroadcastManager.getInstance(this) .registerReceiver(mSetColorActionReceiver, new IntentFilter(ACTION_SET_COLOR)); } @Override protected void onDestroy() { //   Activity       LocalBroadcastManager.getInstance(this) .unregisterReceiver(mSetColorActionReceiver); super.onDestroy(); } }</span></span></code> </pre></div></div><br>  In order for the first Activity not to be destroyed when the screen rotates, configChanges is added to the manifest file. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".situation_04.Situation4FirstActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:configChanges</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"orientation|screenSize"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  In the second Activity there is a button, clicking on which sends a message to change the color. <br><div class="spoiler">  <b class="spoiler_title">Second Activity Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Situation4SecondActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Random mRandom; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.sit04_activity_second); mRandom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(System.currentTimeMillis()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRandomizeColorClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Situation4FirstActivity.ACTION_SET_COLOR); intent.putExtra( Situation4FirstActivity.EXTRA_COLOR, Color.BLACK + mRandom.nextInt(<span class="hljs-number"><span class="hljs-number">0xFFFFFF</span></span>)); LocalBroadcastManager.getInstance(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).sendBroadcast(intent); } }</code> </pre></div></div><br>  When returning to the first Activity, the View color will be changed. <br><br>  However, if you switch to the second Activity, minimize the application, kill the process, and then deploy the application, something unforeseen happens.  No matter how many times you press the color change button, when you return to the first Activity, its View will be pure white. <br><br>  <b>What happened?</b> <br>  Despite the fact that the stack of activities has been preserved, after the application was deployed, only the second Activity was restored.  In fact, the color change messages went nowhere.  Since at that time there were no objects subscribed to this event.  Upon returning to the first Activity, it was restored, but it was too late to subscribe to the color change event. <br><br>  <b>What to do?</b> <br>  First of all, you need to understand the main thing - if you work with one Activity, the others do not exist for it.  If you need to convey any information, use the intended setResult.  Do not blindly rely on life cycles.  As you can see from the example, if Activity 1 launched Activity 2, this does not mean that the onCreate method was the first Activity to be executed. <br>  Also note, this example shows not only the problems with the stack of activities, but also problems with everything related to sending messages.  The only exceptions are BroadcastReceivers specified in the manifest or scheduled via AlarmManager.  Everything else does not give a 100% guarantee for the delivery of the message to the addressee. <br><br><h2>  Conclusion </h2><br>  For experienced coders, these situations may seem obvious, and examples are not so natural as to simply turn back.  However, we all once started from scratch and wrote code from which now would be a shame.  If I had known about these rakes at the very beginning of my journey, there would be fewer cones on my forehead.  I hope this article will help guide the true large number of beginner Android programmers on the way.  From ‚ÄúExperienced‚Äù I will be glad to see the comments.  And even better if you add to the list or write, did this article help catch bugs from the category ‚ÄúHow ?!  It can not be!". <br><br>  On this finish.  Thanks for attention.  Finally, I note that I still have one extraordinary case in my sleeve.  It has not been studied by me to the end, but I hope to soon split this tough nut.  So wait for the continuation. </div><p>Source: <a href="https://habr.com/ru/post/261721/">https://habr.com/ru/post/261721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261709/index.html">Financial Transmission Ways # 3: Plaza II Protocol</a></li>
<li><a href="../261711/index.html">Basics of using Cocoapods in iOS app development</a></li>
<li><a href="../261715/index.html">DevStack as a tool</a></li>
<li><a href="../261717/index.html">Magic Tensor Algebra: Part 3 - Curvilinear Coordinates</a></li>
<li><a href="../261719/index.html">We collect and configure the BUNDY DNS server (BIND10). Part 1</a></li>
<li><a href="../261723/index.html">Higher Order Functions in JavaScript</a></li>
<li><a href="../261727/index.html">Web experiments # 1. Adaptability lvl. 80: Web Applications, Brain Waves and Attention Levels</a></li>
<li><a href="../261729/index.html">HP Helion OpenStack Network Infrastructure</a></li>
<li><a href="../261731/index.html">Useful materials for iOS developers for the week</a></li>
<li><a href="../261733/index.html">Invisible File Mystery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>