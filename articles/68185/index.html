<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to return a remote config or Never give up!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sysadmins are divided into those who do not make backups, and those who already do them =) 

 Not one article was written about how to restore files f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to return a remote config or Never give up!</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e22/453/e94/e22453e9480a01fc95ecf56699061f7d.jpg" alt="image"></div><br>  <i>Sysadmins are divided into those who do not make backups, and those who <b>already</b> do them =)</i> <br><br>  Not one article was written about how to restore files from ext3 / ufs, so I won‚Äôt repeat and write about not the most widely known ways to restore configs to the production server. <br><br><a name="habracut"></a><br><h3>  How did this happen? </h3><br>  Call in the evening from an old friend who is now working in a web studio.  On the other side is complete panic and uncertainty. <br>  -! "‚Ññ;%: Aaaa! Everything has fallen, nothing is not working. I kapets, save. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After fifteen minutes of bringing a person into an adequate state and finding out what did happen, the following became clear: <br><ul><li>  Their studio not only makes websites, but also hosts them. </li><li>  The nginx config is generated by the script pulling out locations and rewrites from the MySQL service database. </li><li>  The base is on good servers with RAID-1 and master-slave replication </li><li>  Backups are not made, since ‚Äúthe chance that both screws die on both servers is zero‚Äù (c) The sysadmin of this studio </li></ul><br><br><h3>  About backups </h3><br>  What is true is true.  Indeed, 4 screws cannot die at the same time (possible, but statistically unlikely ¬© <a href="http://en.wikipedia.org/wiki/Charlie_Eppes">‚ÄúCharlie‚Äù Eppes, Numb3rs</a> ), however, for some reason, people do not think that rm -rf / * performed on RAID-1 will kill the info on both screws, they also forget that DROP TABLE is replicated from one server to another.  Also, rarely anyone suspects that one day the office could burn out due to fire / drown due to flooding / collapse due to an earthquake / leave with OBEP.  In general, off-site backups are generally very few people do ... And in vain, at least once a month, you can merge everything onto a flash drive into a password-protected .rar and take it home even manually, without steaming. <br><br>  Neither ZFS snapshots, nor RAID, nor replication are a replacement for backups.  Although all this reduces the chances of losing data, and it‚Äôs very good what it is, however, off-site backups should always be there! <br><br><h3>  Closer to the point </h3><br>  According <a href="http://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25BD_%25D0%259C%25D1%2591%25D1%2580%25D1%2584%25D0%25B8">to Murphy's Law</a> , what can happen, just has to happen.  So on this ill-fated evening because of an error in the UPDATE SQL query, the service table with the data from which the nginx config was generated was filled with '', and because of an error in the script, nginx.conf was overwritten with an empty file.  Fortunately, nginx is a smart thing and before reloading the config checks it for correctness, so nginx refused to use the new config. <br><br><h3>  How to recover the rewritten config? </h3><br>  My old friend gave me access to the frontend with nginx. <br>  It's all ordinary: The machine on FreeBSD, gmirror for two disks and nginx, nothing more. <br>  First, I stopped gmirror so that all my changes do not overwrite the files on the second screw.  Then I began to think about how to restore the killed file from disk, but then looking at the server uptime and remembering that a friend had said, they say, the configuration changes quite rarely, I decided to try another method. <br><br>  Looked at how much we have swap. <br> <code># swapinfo <br> Device 1K-blocks Used Avail Capacity <br> /dev/ad4s1b 2063152 94612 1968540 5%</code> <br>  The fact that he is currently busy at 5% does not mean that there is only 5% of information, most likely there it is much more =) <br><br>  Keep it current <br> <code># cat /dev/ad4s1b &gt; /usr/SWAP</code> <br> <br>  And knowing what the thread from the config line will begin to ram on it.  Since most people tyunyut, both fryuha, and nginx <a href="http://www.slideshare.net/Dolce727/sysoev-freebsd7%3Ftype%3Dpresentation">"by Sysoev"</a> , then in the config most likely there is a line "reset_timedout_connection on", well, let's check my luck and try to bind it: <br><br> <code># cat /usr/SWAP | grep -a -A10 reset_timedout_connection <br>  «à «à  «à  «à «à «à$ «à0 «à8 «à&lt; «àX «à\ «àd «àp «à  «à  «à  «à  «à  «à «à  «à  «à  «à   «à8 «àP «àp «à  «à  «à  «à «à  «àX «à <br>   «à «à m [»àh «àx»à“∞«à@         . ` `   0u 0u2 d d «à »à&lt;4 @T»à  »à <br> -- <br> reset_timedout_connection on; <br> sendfile on; <br> tcp_nopush on; <br> tcp_nodelay on; <br> send_lowat 12000; <br> <br> keepalive_timeout 65; <br> <br> gzip on; <br> gzip_min_length 2048; <br> gzip_types text/css text/js text/xml; <br> ^C</code> <br>  and here, voila, a piece of the config, it remains only to play with the values ‚Äã‚Äã-A and -B, to extract the config entirely and choose from the options the most new / unbeaten (maybe there will be several of them in the swap) <br><br> <code># cat /usr/SWAP | grep -a -A400 -B12 "reset_timedout_connection on;"</code> <br> <br>  All config in our hands.  It seems the sales are not broken and up-to-date.  Now you can restore it to MySQL table. <br><br>  This method is not a panacea or a silver bullet, the fact that it worked in my case is an exception rather than the rule, but maybe this method will help some of you to recover important data. <br><br><h3>  If there is no swap, and the screw file cannot be restored </h3><br>  There is also a second, less preferred option for restoring information if the server is still running the nginx process <br><br>  To begin with, we are looking for a nginx master <br> <code># ps -auxww | grep nginx <br> root 1197 0,0 0,1 13216 2488 ?? Is 18 0:00,02 nginx: master process /usr/local/sbin/nginx <br> www 29484 0,0 2,3 57248 47576 ?? I 7:58 0:00,06 nginx: worker process (nginx)</code> <br> <br>  Next we do it with coredump <br> <code># gcore 1197</code> <br>  And then we pick it as we want, even though <br> <code># cat core.1197 | strings | grep -B10 -A10 reset_timedout_connection</code> <br>  even so <br> <code># cat core.1197 | grep -a -B10 -A10 reset_timedout_connection</code> <br>  ... And we are terrified of how difficult it is to assemble the config bit by bit <br><br><h3>  Conclusion </h3><br>  People, do not be Yourselves Angry Buratinos, make frequent well-protected automatic backups of data.  And remember that even from the deepest ass there are at least two ways out%) <br><br><h3>  Instead of epilogue </h3><br>  MySQL database was eventually restored.  The admin himself, without knowing it, turned on --bin-log from the very beginning of the base's life (by the way, by the time I began to restore the database, the binlog already occupied 89% / var and after a couple of months, mysql would stop running).  Due to the fact that no one deleted them, <a href="http://dev.mysql.com/doc/refman/5.0/en/point-in-time-recovery.html">Point-in-Time Recovery</a> could be done. <br><br>  PS  It would be nice if nginx could, upon request, issue its current config or diff from the current one and what lies in the file on disk =) </div><p>Source: <a href="https://habr.com/ru/post/68185/">https://habr.com/ru/post/68185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68178/index.html">Food for the mind and not only</a></li>
<li><a href="../68179/index.html">Take the keyboard, take a sledgehammer ...</a></li>
<li><a href="../68180/index.html">IBM takes first molecular snapshot 3D</a></li>
<li><a href="../68182/index.html">Loader Theory</a></li>
<li><a href="../68184/index.html">Transferring ‚Äúbig‚Äù Outlook accounts</a></li>
<li><a href="../68188/index.html">2song.net - lyrics search</a></li>
<li><a href="../68189/index.html">Fonts common to all (current) versions of Windows and their Mac equivalents</a></li>
<li><a href="../68190/index.html">Qt + Ruby, 2D drawing example</a></li>
<li><a href="../68192/index.html">Infobox participates in the startup program BizSpark</a></li>
<li><a href="../68194/index.html">Core 2 Quad - the latest version?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>