<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of parsing one aspx site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 There is one online customer care system with which my young man has to work. The system is probably functional, good for administrators,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of parsing one aspx site</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  There is one online customer care system with which my young man has to work.  The system is probably functional, good for administrators, effective in management and so on, but how inconvenient it is in daily use! <br><ol><li>  I don‚Äôt remember my login, password and city - as a result, after logging in, you need to wait for all applications to load from the default city, and then go to your own. </li><li>  Not all necessary information is available from the general list of applications.  For part of it, you have to look inside the application, and each of them opens in a new window (there is javascript and there is not even a normal attribute href, can you imagine?). </li><li>  This beauty is made on asp, and therefore with each transition it drives its viewstate on the net. </li><li>  Well, the minimum width of the site and a half with something thousands of points is not a pleasure. </li></ol><br>  The specificity of the work sometimes makes you log in from a mobile phone and from the mobile Internet. <br>  And if I worked with her myself, then nothing would have happened - I would get used to it, adapt, and in general, the authorities yearn for it ... But it‚Äôs a pity for a loved one, and the idea was to write a parser of applications. <br><a name="habracut"></a><br><h4>  Story </h4><br>  Actually, I'm a coder.  And a web developer, but in this direction the skill is not so high, just doing passable websites on wordpress.  I have not come across any harsh curl requests before.  And with aspx sites too. <br>  But after all it is interesting! <br>  <i>(This resulted in a month of evenings with php and several sleepless nights. And a lot of fun, of course)</i> <br><br>  At first, there were attempts to cross-domain queries using javascript, but nothing happened on this side. <br>  Then timid excavation aside phantomjs and other emulation of user behavior.  But it turned out that I still lack js skills. <br>  As a result, everything works on curl requests coming from the php page. <br><br><h5>  Receiving the information </h5><br>  Authorization was fast enough, and it worked more or less without problems. <br>  <i>The most nasty problem was the restriction on the number of incorrect password entries: twice - and call the admin, restore access ...</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But with the transition to the desired city stubbornly failed.  The transition was made, but somewhere not there, although the POST request was executed by all the rules. <br>  It turned out that preg_match does not work correctly with very large numbers of characters. <br>  The directive directive saves it. <br><br><pre><code class="php hljs">ini_set(<span class="hljs-string"><span class="hljs-string">"pcre.backtrack_limit"</span></span>, <span class="hljs-number"><span class="hljs-number">10000000</span></span>);</code> </pre> <br>  First we get the initial state of the page (since we are not logged in yet, we get to the login page), and tear out the viewstate from there: <br><br><pre> <code class="php hljs"> $url = <span class="hljs-string"><span class="hljs-string">'http://***/Default.aspx'</span></span>; $content = curlFunction($url); preg_match_all(<span class="hljs-string"><span class="hljs-string">"/id=\"__VIEWSTATE\" value=\"(.*?)\"/"</span></span>, $content, $arr_viewstate); $viewstate = urlencode($arr_viewstate[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre><br>  Now, having already got an up-to-date snapshot of the page status, we enter the login and password. <br>  (postdata is the POST parameter of the request for the page, you can spy on the same firebug). <br><br><pre> <code class="php hljs"> $url = <span class="hljs-string"><span class="hljs-string">'http://***/Default.aspx?ReturnUrl=%2fHome%2fRoutes.aspx'</span></span>; $postdataArr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'__LASTFOCUS='</span></span>, <span class="hljs-string"><span class="hljs-string">'__EVENTTARGET='</span></span>, <span class="hljs-string"><span class="hljs-string">'__EVENTARGUMENT='</span></span>, <span class="hljs-string"><span class="hljs-string">'__VIEWSTATE='</span></span>.$viewstate, <span class="hljs-string"><span class="hljs-string">'ctl00$cphMainContent$loginBox$loginBox$UserName='</span></span>.$login, <span class="hljs-string"><span class="hljs-string">'ctl00$cphMainContent$loginBox$loginBox$Password='</span></span>.$password, <span class="hljs-string"><span class="hljs-string">'ctl00$cphMainContent$loginBox$loginBox$LoginButton='</span></span>, ); $postdata = implode(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>,$postdataArr); $content = curlFunction($url, $postdata); preg_match_all(<span class="hljs-string"><span class="hljs-string">"/id=\"__VIEWSTATE\" value=\"(.*?)\"/iu"</span></span>, $content, $arr_viewstate); $viewstate = urlencode($arr_viewstate[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre><br>  Due to the fact that the initial link is issued with a redirect, and curl is setting <br><br><pre> <code class="php hljs">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   </span></span></code> </pre><br>  we get we get as a result of the viewstate of the page we need. <br><br>  It was at this moment that a problem arose with the inactive preg_replace, but the solution - thanks to <a href="http://habrahabr.ru/post/58560/">Habra</a> - was found. <br>  There is!  Now you can go to the application for the desired city and already deal with parsing. <br><br><pre> <code class="php hljs"> $url = <span class="hljs-string"><span class="hljs-string">'http://***/Home/Routes.aspx'</span></span>; $postdataArr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'__EVENTTARGET=ctl00$cphMainContent$ddlCityID'</span></span>, <span class="hljs-string"><span class="hljs-string">'__EVENTARGUMENT='</span></span>, <span class="hljs-string"><span class="hljs-string">'__LASTFOCUS='</span></span>, <span class="hljs-string"><span class="hljs-string">'__VIEWSTATE='</span></span>.$viewstate, <span class="hljs-string"><span class="hljs-string">'ctl00$cphMainContent$ddlCityID='</span></span>.$city, <span class="hljs-string"><span class="hljs-string">'ctl00$cphMainContent$tbConnectionDate='</span></span>.$date, ); $postdata = implode(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>,$postdataArr); $content = curlFunction($url, $postdata);</code> </pre><br>  When you finally understand what you are doing, everything is quite simple: you need to follow exactly the link, the viewstate of which you received in the last step. <br><br><h5>  Data processing </h5><br>  Got, we start parsing. <br>  The first experience was associated with regular expressions.  Unfortunately, php on the hosting was somehow very strange working with multi-line expressions, and didn‚Äôt fully select (with all the options), no matter how I tried to persuade it (while everything worked on LAN). <br><br>  The next step was the library <a href="http://habrahabr.ru/post/176635/">Simple Html Dom</a> .  All is well, we‚Äôve got it, follow the links and parse the information ... Getting one page takes 0.9 seconds, and getting the same data from five inputs on the page takes another 5 seconds.  When you need to go through nine such links, everything becomes very sad. <br><br>  We google, we think, we read.  Find <a href="http://habrahabr.ru/post/110112/">Nokogiri</a> .  You know, easy and worthwhile!  Really fast and pleasant thing to work: <br><br><pre> <code class="php hljs"> $html = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> nokogiri($content); <span class="hljs-comment"><span class="hljs-comment">//  input' $RepairNumber = $html-&gt;get('#ctl00_cphMainContent_tbRepairNumber')-&gt;toArray(); $result['RepairNumber'] = $RepairNumber[0]['value']; //  select' $ConnectionTimeArr = $html-&gt;get('#ctl00_cphMainContent_ddlConnectionTime')-&gt;toArray(); foreach($ConnectionTimeArr as $e) { foreach($e['option'] as $el) { if(isset($el['selected'])) { $result['ConnectionTime'] = $el['#text'][0]; } } }</span></span></code> </pre><br><br><h5>  Beauty and design </h5><br>  Suddenly, a very strange problem appeared: the actual customer with obvious discontent used the version of the developer without css, js and other bells and whistles.  More precisely, he did not understand how <i>to</i> use it. <br><br>  We are looking for information about <a href="httprequest">XHR requests</a> . <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,   POST- var login = $('#login').val(); var password = $('#password').val(); var val = $('#datePicker').val(); //  var params = 'login=' + encodeURIComponent(login) + '&amp;password=' + encodeURIComponent(password) + '&amp;date=' + encodeURIComponent(date) + '&amp;firstlogin=true'; //       ,  ,   ,    var req = getXmlHttp() req.open('POST', 'script.php', true) req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded') req.send(params); //  -    ! $('.dark').fadeIn(); req.onreadystatechange = function() { if (req.readyState == 4) { if(req.status == 200) { // ,     $('.dark').fadeOut(); $('#worker').html(req.responseText); } } }</span></span></code> </pre><br><br>  Profit!  The user is happy, the user's mobile phone is free from the need to overtake tons of viewstates via the mobile Internet, and it‚Äôs somehow easier to manage the design of a handwritten page. <br><br>  PS Here I was just asked if it is possible with the help of this client to also change the data in the application management system.  Looks like it was a threat ... </div><p>Source: <a href="https://habr.com/ru/post/221811/">https://habr.com/ru/post/221811/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221801/index.html">Linus Torvalds received the IEEE Computer Pioneer award</a></li>
<li><a href="../221803/index.html">VPS Optimization Checklist for PHP / Mysql / Nginx</a></li>
<li><a href="../221805/index.html">Fast web application - network trepanation</a></li>
<li><a href="../221807/index.html">Benchmark 14 sorting algorithms on arrays with different dimensions and content</a></li>
<li><a href="../221809/index.html">Space free launch</a></li>
<li><a href="../221813/index.html">Comparison of biological sequences</a></li>
<li><a href="../221815/index.html">We create a website using Laravel and Recurly. Part 2</a></li>
<li><a href="../221817/index.html">PocketBook 626 vs Sony PRS-T3: tested in humans</a></li>
<li><a href="../221819/index.html">Using Git hooks to block edits of published commits</a></li>
<li><a href="../221821/index.html">Macrorails on MSP430</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>