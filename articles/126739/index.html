<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a macro bot for the browser game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Not so long ago, games appeared on Google+. After reading the topic about it , I decided to play something. The choice fell on the game...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a macro bot for the browser game</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Not so long ago, games appeared on Google+.  After reading the <a href="http://habrahabr.ru/blogs/google/126171/">topic about it</a> , I decided to play something.  The choice fell on the game <a href="https://plus.google.com/games/54990740671">Diamond Dash</a> .  After a while, the programmer in me started talking about the need to automate actions of the same type.  And that's what came of it ... <br><img src="https://habrastorage.org/storage1/398109ff/767d9631/1aea9d9c/9f28876d.png"><br>  * Note: it is difficult for even an experienced player to gain more than 400k with "hands" <br><br>  Before, I had never encountered the tasks of working with a screen and a mouse.  After a short googling, it was decided to use the macro language <a href="http://ru.wikipedia.org/wiki/AutoIt">AutoIt</a> to decide. <br>  Under the cat you will find a brief description of the game, my way of recognizing the field, the algorithm for determining the point of depression, and a number of optimizations.  As well as a link to the script github repository. <br>  <b>UPD</b> Added video of the script. <br><a name="habracut"></a><br><h4>  Brief description of the game </h4><br>  The game is a simple click-to-area-more-three-square-one-color puzzle. <br><img src="https://habrastorage.org/storage1/e130adbb/85ab76a5/e65bcc96/d52fef93.png"><br>  There is a field of 9 by 10, filled with squares of 5 colors.  We have one minute to score the maximum points.  When you click on an area of ‚Äã‚Äã3 or more monochrome cells, it disappears, what falls through it, and the missing drops from above.  The number of points awarded depends on the size of the area: the larger it is, the more points. <br>  In addition, if you make clicks quickly, and almost unmistakably, the field around lights up, and each deletion (in this case an explosion), captures the cells adjacent to the deleted area. <br><img src="https://habrastorage.org/storage1/02e7aff9/f5a7c646/40a83aef/0552b368.png"><br>  And finally, the last feature: at the top there is a scale with a diamond at the end, which is filled as the cells are destroyed (and decreases with erroneous clicks).  When it is filled, a burning diamond appears in a random place on the field.  When you click on it, time stops, and a fireball falls on top of the field, destroying all the cells in the row and column where the stone was located. <br><img src="https://habrastorage.org/storage1/9041e5c5/3d892c31/c067c77a/ab3e7d58.png"><br><br><h4>  Determining window coordinates </h4><br>  This part was added at the very last turn, before that the coordinates of the angle were fixed in the code.  Uses a function from the third-party ImageSearch library to search for a saved 10 by 10 pixel template.  Apparently, the background varies slightly from game to game, because not every piece fit. <br>  The forums everywhere do not recommend the use of ImageSearch due to the long working time.  But since we need to determine the coordinates only once at the beginning of the game, there is no need to fear sagging in time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Recognizing colors and saving screenshots </h4><br>  To determine the color of a pixel by its coordinates, AutoIt has a PixelGetColor function.  But as practice has shown, the measurement of only 90 pixels takes a half second, which, of course, is not very good.  But in fairness it must be said that a bot written using this function gained 400-600 thousand points, and this is more than a person can gain, even with great skill. <br>  The forums found a method to save the current state of the monitor in Bitmap using WinAPI.  By the way, this bitmap, if necessary (for example, for debug), can be saved into a file by the function _ScreenCapture.  Next, we look at the colors of 90 pixels located along the lattice and build a table of color squares on them. <br><blockquote><ol><li>  <font color="#0000FF">Func</font> _GetField <font color="#FF0000">(</font> <font color="#0000FF">ByRef</font> <font>$ aiField</font> <font color="#FF0000">)</font> <font>;</font>  <font>getting an array of field colors</font> </li><li>  <font>;</font>  <font>getting a bitmap of a screen using WinAPI</font> </li><li>  <font color="#0000FF">Local</font> <font>$ hWnd</font> <font color="#FF0000">=</font> <font color="#000080">WinGetHandle</font> <font color="#FF0000">(</font> <font>"Google+ Games - Google Chrome"</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ Size</font> <font color="#FF0000">=</font> <font color="#000080">WinGetClientSize</font> <font color="#FF0000">(</font> <font>$ hWnd</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ hDC</font> <font color="#FF0000">=</font> <font color="#0080FF">_WinAPI_GetDC</font> <font color="#FF0000">(</font> <font>$ hWnd</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ hMemDC</font> <font color="#FF0000">=</font> <font color="#0080FF">_WinAPI_CreateCompatibleDC</font> <font color="#FF0000">(</font> <font>$ hDC</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ hBitmap</font> <font color="#FF0000">=</font> <font color="#0080FF">_WinAPI_CreateCompatibleBitmap</font> <font color="#FF0000">(</font> <font>$ hDC</font> <font color="#FF0000">,</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">,</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ hSv</font> <font color="#FF0000">=</font> <font color="#0080FF">_WinAPI_SelectObject</font> <font color="#FF0000">(</font> <font>$ hMemDC</font> <font color="#FF0000">,</font> <font>$ hBitmap</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_BitBlt</font> <font color="#FF0000">(</font> <font>$ hMemDC</font> <font color="#FF0000">,</font> <font color="#AC00A9">0</font> <font color="#FF0000">,</font> <font color="#AC00A9">0</font> <font color="#FF0000">,</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">,</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> <font color="#FF0000">,</font> <font>$ hDC</font> <font color="#FF0000">,</font> <font color="#AC00A9">0</font> <font color="#FF0000">,</font> <font color="#AC00A9">0</font> <font color="#FF0000">,</font> <font>$ SRCCOPY</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_SelectObject</font> <font color="#FF0000">(</font> <font>$ hMemDC</font> <font color="#FF0000">,</font> <font>$ hSv</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_DeleteDC</font> <font color="#FF0000">(</font> <font>$ hMemDC</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_ReleaseDC</font> <font color="#FF0000">(</font> <font>$ hWnd</font> <font color="#FF0000">,</font> <font>$ hDC</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Local</font> <font>$ L</font> <font color="#FF0000">=</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">*</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> </li><li>  <font color="#0000FF">Local</font> <font>$ tBits</font> <font color="#FF0000">=</font> <font color="#000080">DllStructCreate</font> <font color="#FF0000">(</font> <font>'dword ['</font> <font color="#FF0000">&amp;</font> <font>$ L</font> <font color="#FF0000">&amp;</font> <font>']'</font> <font color="#FF0000">)</font> </li><li>  _WinAPI_GetBitmapBits <font color="#FF0000">(</font> <font>$ hBitmap</font> <font color="#FF0000">,</font> <font color="#AC00A9">4</font> <font color="#FF0000">*</font> <font>$ L</font> <font color="#FF0000">,</font> <font color="#000080">DllStructGetPtr</font> <font color="#FF0000">(</font> <font>$ tBits</font> <font color="#FF0000">)</font> <font color="#FF0000">)</font> </li><li>  <font>;</font>  <font>cell color detection</font> </li><li>  <font color="#0000FF">For</font> <font>$ iCol</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> <font color="#0000FF">To</font> <font>$ iNumCols</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">For</font> <font>$ iRow</font> <font color="#FF0000">=</font> <font>$ iNumRows</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> <font color="#0000FF">to</font> <font color="#AC00A9">0</font> <font color="#0000FF">Step</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font>;</font>  <font>square color measurement</font> </li><li>  <font>$ iX</font> <font color="#FF0000">=</font> <font>$ iCornerX</font> <font color="#FF0000">+</font> <font color="#FF0000">(</font> <font>$ iCol</font> <font color="#FF0000">*</font> <font color="#AC00A9">40</font> <font color="#FF0000">)</font> <font color="#FF0000">+</font> <font>$ iDeltaX</font> </li><li>  <font>$ iY</font> <font color="#FF0000">=</font> <font>$ iCornerY</font> <font color="#FF0000">+</font> <font color="#FF0000">(</font> <font>$ iRow</font> <font color="#FF0000">*</font> <font color="#AC00A9">40</font> <font color="#FF0000">)</font> <font color="#FF0000">+</font> <font>$ iDeltaY</font> </li><li>  <font>$ iPixelColor</font> <font color="#FF0000">=</font> <font color="#000080">Mod</font> <font color="#FF0000">(</font> <font color="#000080">DllStructGetData</font> <font color="#FF0000">(</font> <font>$ tBits</font> <font color="#FF0000">,</font> <font color="#AC00A9">1</font> <font color="#FF0000">,</font> <font>$ iY</font> <font color="#FF0000">*</font> <font>$ Size</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">+</font> <font>$ iX</font> <font color="#FF0000">)</font> <font color="#FF0000">,</font> 0x1000000 <font color="#FF0000">)</font> </li><li>  <font>$ aiField</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> _GetCheckColor <font color="#FF0000">(</font> <font>$ iPixelColor</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font>;</font>  <font>data deletion to avoid memory leaks</font> </li><li>  <font color="#0080FF">_WinAPI_DeleteObject</font> <font color="#FF0000">(</font> <font>$ hBitmap</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_DeleteObject</font> <font color="#FF0000">(</font> <font>$ hMemDC</font> <font color="#FF0000">)</font> </li><li>  <font color="#0080FF">_WinAPI_DeleteObject</font> <font color="#FF0000">(</font> <font>$ tBits</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Endfunc</font> </li></ol></blockquote><br><img src="https://habrastorage.org/storage1/26c27d7f/f6b1f0db/6d80a16e/219d21a8.png"><br>  Here it is worth making a reservation, why the measurement occurs at only 1 point.  This method was tried by me in the first place, and remained in the final version.  Between these two moments a rather large number of alternative methods were tried, among which were: measuring 64 points on each square (grid 8 by 8) and various averaging of the obtained values, random selection of coordinates for measuring, storing the history of several recent measurements for better accuracy ... But they all turned out to be less accurate or convenient than the very first method. <br>  It is possible that since I am very far from the topic of image recognition, I do not know anything simple that can help me in this matter.  In this case, I will be glad to any suggestions.  =) <br><br><h4>  Single-color area detection from the color table </h4><br>  Well, finally, it remains to find a suitable place and click there.  To do this, we go around the field from the bottom up (because everything falls down, which means that the bottom is less empty than the top), and we check monochrome parts.  I did this using a non-recursive depth-first search ( <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA_%25D0%25B2_%25D0%25B3%25D0%25BB%25D1%2583%25D0%25B1%25D0%25B8%25D0%25BD%25D1%2583">DFS</a> ) algorithm.  In short, the essence is this: we put the starting cell on the stack, and then, until the stack is empty, we pull the current cell out of it and go around its neighbors, if we match the color, we put it on the stack.  Well, what to say, the code is clearer.  =) <br><blockquote><ol><li>  <font color="#0000FF">Func</font> _DfsAreaSize <font color="#FF0000">(</font> <font color="#0000FF">ByRef</font> <font>$ aiField</font> <font color="#FF0000">,</font> <font>$ iStartX</font> <font color="#FF0000">,</font> <font>$ iStartY</font> <font color="#FF0000">)</font> <font>;</font>  <font>non-recursive one-color region size search algorithm</font> </li><li>  <font>;</font>  <font>depth search method</font> </li><li>  <font color="#0000FF">Local</font> <font>$ aiResult</font> <font color="#FF0000">[</font> <font>$ iNumCols</font> <font color="#FF0000">*</font> <font>$ iNumRows</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">2</font> <font color="#FF0000">]</font> <font>;</font>  <font>cell list</font> </li><li>  <font color="#0000FF">Local</font> <font>$ iResultSize</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> </li><li>  <font color="#0000FF">Local</font> <font>$ afMap</font> <font color="#FF0000">[</font> <font>$ iNumRows</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iNumCols</font> <font color="#FF0000">]</font> <font>;</font>  <font>flags of transcendence</font> </li><li>  <font color="#0000FF">For</font> <font>$ iRow</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> <font color="#0000FF">to</font> <font>$ iNumRows</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">For</font> <font>$ iCol</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> <font color="#0000FF">to</font> <font>$ iNumCols</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font>$ afMap</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font color="#0000FF">False</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font>$ afMap</font> <font color="#FF0000">[</font> <font>$ iStartX</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iStartY</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font color="#0000FF">True</font> </li><li>  <font color="#0000FF">Local</font> <font>$ aiStack</font> <font color="#FF0000">[</font> <font>$ iNumRows</font> <font color="#FF0000">*</font> <font>$ iNumCols</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">2</font> <font color="#FF0000">]</font> <font>;</font>  <font>active stack</font> </li><li>  <font color="#0000FF">Local</font> <font>$ iStackSize</font> <font color="#FF0000">=</font> <font color="#AC00A9">1</font> </li><li>  <font>$ aiStack</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iStartX</font> </li><li>  <font>$ aiStack</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iStartY</font> </li><li>  <font color="#0000FF">While</font> <font>$ iStackSize</font> <font color="#FF0000">&gt;</font> <font color="#AC00A9">0</font> </li><li>  <font>$ iStackSize</font> <font color="#FF0000">- =</font> <font color="#AC00A9">1</font> </li><li>  <font>$ iX</font> <font color="#FF0000">=</font> <font>$ aiStack</font> <font color="#FF0000">[</font> <font>$ iStackSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> </li><li>  <font>$ iY</font> <font color="#FF0000">=</font> <font>$ aiStack</font> <font color="#FF0000">[</font> <font>$ iStackSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> </li><li>  <font>$ aiResult</font> <font color="#FF0000">[</font> <font>$ iResultSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iX</font> </li><li>  <font>$ aiResult</font> <font color="#FF0000">[</font> <font>$ iResultSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iY</font> </li><li>  <font>$ iResultSize</font> <font color="#FF0000">+ =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">For</font> <font>$ iDirection</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> <font color="#0000FF">to</font> <font color="#AC00A9">3</font> <font>;</font>  <font>search 4 adjacent cells</font> </li><li>  <font color="#0000FF">Local</font> <font>$ iNewX</font> <font color="#FF0000">=</font> <font>$ iX</font> </li><li>  <font color="#0000FF">Local</font> <font>$ iNewY</font> <font color="#FF0000">=</font> <font>$ iY</font> </li><li>  <font color="#0000FF">Switch</font> <font>$ iDirection</font> </li><li>  <font color="#0000FF">Case</font> <font color="#AC00A9">0</font> </li><li>  <font>$ iNewY</font> <font color="#FF0000">+ =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">Case</font> <font color="#AC00A9">1</font> </li><li>  <font>$ iNewY</font> <font color="#FF0000">- =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">Case</font> <font color="#AC00A9">2</font> </li><li>  <font>$ iNewX</font> <font color="#FF0000">+ =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">Case</font> <font color="#AC00A9">3</font> </li><li>  <font>$ iNewX</font> <font color="#FF0000">- =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">End switch</font> </li><li>  <font color="#0000FF">If</font> <font color="#FF0000">(</font> <font>$ iNewX</font> <font color="#FF0000">&gt; =</font> <font color="#AC00A9">0</font> <font color="#0000FF">And</font> <font>$ iNewX</font> <font color="#FF0000">&lt;</font> <font>$ iNumRows</font> <font color="#0000FF">And</font> _ </li><li>  <font>$ iNewY</font> <font color="#FF0000">&gt; =</font> <font color="#AC00A9">0</font> <font color="#0000FF">And</font> <font>$ iNewY</font> <font color="#FF0000">&lt;</font> <font>$ iNumCols</font> <font color="#0000FF">And</font> _ </li><li>  <font color="#0000FF">Not</font> <font color="#FF0000">(</font> <font>$ afMap</font> <font color="#FF0000">[</font> <font>$ iNewX</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iNewY</font> <font color="#FF0000">]</font> <font color="#FF0000">)</font> <font color="#0000FF">And</font> <font>$ aiField</font> <font color="#FF0000">[</font> <font>$ iNewX</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iNewY</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ aiField</font> <font color="#FF0000">[</font> <font>$ iStartX</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iStartY</font> <font color="#FF0000">]</font> <font color="#FF0000">)</font> </li><li>  <font>$ afMap</font> <font color="#FF0000">[</font> <font>$ iNewX</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iNewY</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font color="#0000FF">True</font> </li><li>  <font>$ aiStack</font> <font color="#FF0000">[</font> <font>$ iStackSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">0</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iNewX</font> </li><li>  <font>$ aiStack</font> <font color="#FF0000">[</font> <font>$ iStackSize</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font color="#AC00A9">1</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font>$ iNewY</font> </li><li>  <font>$ iStackSize</font> <font color="#FF0000">+ =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">Endif</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font color="#0000FF">Wend</font> </li><li>  <font color="#0000FF">Return</font> <font>$ iResultSize</font> </li><li>  <font color="#0000FF">Endfunc</font> </li></ol></blockquote><br><br><h4>  Optimization </h4><br><br><h5>  Optimization 1. Almaziki </h5><br>  Written above was enough to get a million.  But I wanted more.  The biggest drawback of the above algorithm was, perhaps, the inability to determine diamonds.  Therefore, at the end of the minute, the field looked like this: <br><img src="https://habrastorage.org/storage1/c6a586ec/a94a1d46/6fa60523/0e188e90.png"><br>  Meanwhile, diamonds are a very useful thing, because while the fireball falls, the timer stops and the squares fall.  So the gaps are filled, and there will be fewer errors. <br>  To determine diamonds, to begin with, we had to play with the coordinates of the measurements, so that the colored cells were determined correctly, and the diamonds did not fall under any of their colors.  After that, we create an array of $ aiDiams of size 3 (we will check only the bottom 3 lines, because all diamonds will fall there sooner or later) * width (in our case - 10).  At each measurement, we look through the bottom 3 lines, and if the cell is defined, then reset the corresponding place in $ aiDiams, otherwise we increment it.  Thus, for cells with diamonds, the values ‚Äã‚Äãwill be high.  With the accumulation of a certain threshold, we click. <br><blockquote><ol><li>  <font color="#0000FF">For</font> <font>$ iRow</font> <font color="#FF0000">=</font> <font>$ iNumRows</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> <font color="#0000FF">to</font> <font>$ iNumRows</font> <font color="#FF0000">-</font> <font color="#AC00A9">3</font> <font color="#0000FF">Step</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">For</font> <font>$ iCol</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> <font color="#0000FF">to</font> <font>$ iNumCols</font> <font color="#FF0000">-</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">If</font> <font>$ aiField</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">&lt;&gt;</font> <font color="#AC00A9">0</font> <font color="#0000FF">Then</font> </li><li>  <font>$ aiDiams</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> </li><li>  <font color="#0000FF">Else</font> </li><li>  <font>$ aiDiams</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">+ =</font> <font color="#AC00A9">1</font> </li><li>  <font color="#0000FF">If</font> <font>$ aiDiams</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">&gt;</font> <font color="#AC00A9">15</font> <font color="#0000FF">Then</font> </li><li>  <font color="#000080">MouseClick</font> <font color="#FF0000">(</font> <font>"Left"</font> <font color="#FF0000">,</font> <font>$ iCornerX</font> <font color="#FF0000">+</font> <font color="#AC00A9">30</font> <font color="#FF0000">+</font> <font color="#FF0000">(</font> <font>$ iCol</font> <font color="#FF0000">*</font> <font color="#AC00A9">40</font> <font color="#FF0000">)</font> <font color="#FF0000">,</font> <font>$ iCornerY</font> <font color="#FF0000">+</font> <font color="#AC00A9">10</font> <font color="#FF0000">+</font> <font color="#FF0000">(</font> <font>$ iRow</font> <font color="#FF0000">*</font> <font color="#AC00A9">40</font> <font color="#FF0000">)</font> <font color="#FF0000">,</font> <font color="#AC00A9">1</font> <font color="#FF0000">,</font> <font>$ iMouseSpeed</font> <font color="#FF0000">)</font> </li><li>  <font>$ aiDiams</font> <font color="#FF0000">[</font> <font>$ iRow</font> <font color="#FF0000">]</font> <font color="#FF0000">[</font> <font>$ iCol</font> <font color="#FF0000">]</font> <font color="#FF0000">=</font> <font color="#AC00A9">0</font> </li><li>  <font color="#000080">Sleep</font> <font color="#FF0000">(</font> <font color="#AC00A9">500</font> <font color="#FF0000">)</font> </li><li>  <font color="#0000FF">Return</font> <font color="#AC00A9">0</font> </li><li>  <font color="#0000FF">Endif</font> </li><li>  <font color="#0000FF">Endif</font> </li><li>  <font color="#0000FF">Next</font> </li><li>  <font color="#0000FF">Next</font> </li></ol></blockquote><br><br><h5>  Optimization 2. Over Explosion </h5><br>  Here it is necessary to explain why it is very important to reduce the number of errors, and why there is a 1/10 second delay in my script between adjacent screenshots.  The fact is that when the field lights up and the cells start to explode, the number of points increases many times.  But if you make too many mistakes, the field stops lighting up.  Therefore, the minimization of errors is no less important part than the optimization of recognition time (and taking into account the time margin, the only important one). <br>  Despite a 1/10 second delay between adjacent screenshots, some cells still do not have time to fall, and are not determined in their places.  To reduce their number, an explosion test was introduced.  When the explosion in the box appears a halo of almost pure white color (#fffefc to be exact), and it is easy to determine.  All cells above the explosion, without further ado, can be stamped as indefinite. <br><br><h5>  Optimization 3. Last Clicked Area </h5><br>  Protection against a repeated error, in the effectiveness of which I am not sure.  The fact is that in the game itself, if an error occurs, the cell becomes gray, and the gray color is determined by the algorithm as undefined (the tautology turned out =)).  But this check can‚Äôt be made worse, so let it live. <br>  The bottom line is that with each click we save the area we click on, and with the next click we don‚Äôt touch it. <br><br><h4>  Total </h4><br>  After all of the above, my record has become something like this: <br><img src="https://habrastorage.org/storage1/dd088c2a/068163c8/1e211655/ee9e7b60.png"><br>  I really wanted 2 million, but 4 days of attempts, a couple of thousand lines of experimental code (with self-logging and saving screenshots), careful smoking of logs and checking with screenshots did not give any results.  = ( <br>  Link to github repository: <a href="https://github.com/EvilTosha/DiamondDash">github.com/EvilTosha/DiamondDash</a> <br><br><h4>  Instead of postscript.  A couple of words about AutoIt </h4><br>  I was very surprised that this language is almost not covered in Habr√©.  Actually, the desire to correct this injustice and prompted to write this topic. <br>  The language at the same time knows quite a lot, and has an amazing ease of learning.  A couple of hours after I learned about its existence, I already had all the knowledge necessary to write this macro. <br>  With AutoIt, you can automate almost any routine action: saving a screenshot, installing the program (if you need to install on many computers), multiple login somewhere ... You can compile into an exe-file, connect DLLs. <br>  But something I, as an evangelist, spoke.  =) <br><br>  <b>UPD</b> Video work. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Os6hE5UZEv8%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgXQiaacHMtf5GqZXeVOA2iEbiOMw" frameborder="0" allowfullscreen=""></iframe><br><br>  Thank you for your attention, I will be glad to any comments. </div><p>Source: <a href="https://habr.com/ru/post/126739/">https://habr.com/ru/post/126739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126734/index.html">The August update of Windows Phone Toolkit is out!</a></li>
<li><a href="../126735/index.html">IT movies</a></li>
<li><a href="../126736/index.html">phpMyExcel - table with formulas in PHP</a></li>
<li><a href="../126737/index.html">If PHP were British</a></li>
<li><a href="../126738/index.html">Blitzkrieg in the tablet market. How could HP fly webOS or a ghostly chance for RIM and ...?</a></li>
<li><a href="../126741/index.html">Quick send screenshots</a></li>
<li><a href="../126744/index.html">Hiring VS Outsourcing (in small business projects)</a></li>
<li><a href="../126745/index.html">Samsung has announced a laptop for gamers</a></li>
<li><a href="../126746/index.html">Chinese Twitter, Weibo's service already has 200 million users</a></li>
<li><a href="../126747/index.html">Readme based development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>