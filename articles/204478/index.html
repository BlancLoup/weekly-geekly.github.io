<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Temperature monitoring of the containment using 1-wire sensors and Zabbix 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have in stock a containment on 4 rows with 16 open racks in each row. 
 Air conditioning scheme: hot-cold corridors, internal air conditioners with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Temperature monitoring of the containment using 1-wire sensors and Zabbix 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/608/a6d/b85/608a6db85ea81ffec62bf0b819c06106.jpg" alt="image" align="right"><br><br>  We have in stock a containment on 4 rows with 16 open racks in each row. <br>  Air conditioning scheme: hot-cold corridors, internal air conditioners with external evaporators, 3 air conditioners per row, that is, 6 air conditioners per cold corridor. <br><br>  Objective: to build a temperature monitoring system for the containment zone with the possibility of preventing the air conditioners from failing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To solve this problem, it was decided to use a network of 1-wire temperature sensors and the Zabbix 2 monitoring system. <br><a name="habracut"></a><br>  <b>We collect network 1-wire.</b> <br><br>  What is a 1-wire network can be found <a href="http://www.elin.ru/1-Wire/">here</a> . <br><br>  We need: <br><br>  <b>1. DS9490R 1-Wire Network Controller</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/89b/d69/9cf/89bd699cf907f078e4f85a0300db4dac.jpg" alt="image"><br><br>  <b>2. DS18B20 temperature sensors</b> , in quantity, are calculated: 4 rows * 16 racks in a row * 2 sensors per rack (cold and hot corridors), that is 128 sensors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca6/96a/602/ca696a6024446ed950f78ddb4af953be.jpg" alt="image"><br><br>  3. For convenient installation of the sensor used such an <b>adapter RJ45 to RJ45, cat.</b>  <b>5e GCT11-8p8c</b> , also in the amount of 128 pieces <br><br><img src="https://habrastorage.org/getpro/habr/post_images/078/45e/977/07845e977ba736c4d8aa26e11a91dff0.jpg" alt="image"><br><br>  4. And for each sensor, there are 2 patch cords, that is, 128 * 2 = 256, the patch cord length is half the width of the server rack <br><br>  We assemble the sensor, select three any wires in the adapter, make 3 holes in the adapter, solder the sensor and so 128 times :) <br>  It is recommended to fill the place of solder with glue from the thermogun, it turns out something similar to this: <br><img src="https://habrastorage.org/getpro/habr/post_images/514/f5d/775/514f5d77563585cb6c19b9784e1d6991.jpg" alt="image"><br><br>  Sensors are immediately recommended to be checked for operation by directly connecting to the 1-wire network controller and reading information from it.  It is also recommended to number the sensors: consistently stick the numbers from 1 to 128. Initialization of the 1-wire network will be described below. <br><br>  And so it looks if you fix on the rack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/972/77c/63d/97277c63d42088bf4aa693bad9a4e52e.jpg" alt="image"><br><br>  Since on the controller there is an RJ11 connector, and not RJ45, I recommend making a zero adapter sensor, its sequence number will be zero, and the rack numbers will start from 1, which is more usual. <br><br>  <i>IMPORTANT!</i> <i><br></i>  <i>The length of our network was about 140 meters, since the server was in the 2nd row.</i> <i><br></i>  <i>During testing, it turned out that the USB port power is not enough for such a network length, the controller simply cannot interrogate the sensors, then half the network, so I recommend to buy a USB hub, always with external power, and connect the controller to it.</i>  <i>After connecting the hub, the speed of polling the sensors increased, and errors ceased to appear on the network, all sensors were read.</i> <i><br></i>  <i>I did not succeed in breaking the network into two segments, since the program that reads the data from the sensors could not understand with which controller I could not at least get it.</i> <i><br></i> <br><br>  <b>Initialization of 1-wire network and obtaining sensor values.</b> <br><br>  So proceed to setting up the software. <br><br>  The server to which the USB controller of the 1-wire network is connected is running FreeBSD 9.1, Zabbix 2.0.8 is installed from the ports. <br><br>  <a href="http://www.digitemp.com/">DigiTemp</a> software is used to obtain sensor values <a href="http://www.digitemp.com/">.</a> <br><br>  Download the DigiTemp source and compile, the compiled programs I have are: <code>/usr/local/etc/digitemp/new/digitemp-3.6.0/</code> <br><br>  To work with our controller, we use the program digitemp_DS2490 <br><br> <code># cd /usr/local/etc/digitemp/new/digitemp-3.6.0/ <br> # ./digitemp_DS2490 -i <br></code> <br><br>  DigiTemp needs to be run as root, so that it can read data from the device. <br>  It is necessary to run the program only from its directory, as the network configuration file is stored there. <br><br>  <code>./digitemp_DS2490 -i</code> - the result of the execution will be a 1-wire network configuration file with the name .digitemprc, in the program‚Äôs home directory. <br>  At the same time, digitemp will display 64-bit sensor IDs, which will be written to a file. <br><br>  Example .digitemprc <br> <code>TTY USB</code> <br> <code>READ_TIME 1000</code> <br> <code>LOG_TYPE 1</code> <br> <code>LOG_FORMAT "%b %d %H:%M:%S Sensor %s C: %.2C F: %.2F"</code> <br> <code>CNT_FORMAT "%b %d %H:%M:%S Sensor %s #%n %C"</code> <br> <code>HUM_FORMAT "%b %d %H:%M:%S Sensor %s C: %.2C F: %.2F H: %h%%"</code> <br> <code>SENSORS 133</code> <br> <code>ROM 0 0x28 0x62 0xB5 0x19 0x03 0x00 0x00 0x61</code> <br> <code>ROM 1 0x28 0x29 0xD5 0x19 0x03 0x00 0x00 0xFD</code> <br> <code>ROM 2 0x28 0x59 0xDE 0x19 0x03 0x00 0x00 0x15</code> <br> <code>ROM 3 0x28 0xDA 0xD6 0x19 0x03 0x00 0x00 0x98</code> <br> <code>ROM 4 0x28 0xFD 0xBE 0x19 0x03 0x00 0x00 0x84</code> <br> <code>ROM 5 0x28 0xCB 0xE2 0x19 0x03 0x00 0x00 0x6F</code> <br> <br>  <i>IMPORTANT</i> <i><br></i>  <i>The counter number ROM 0 0x28 0x62 0xB5 0x19 0x03 0x00 0x00 0x61, IS NOT its physically sequential number in the network, this number was obtained during network initialization, that is, the first one who answered was recorded in the file.</i> <i><br></i>  <i>Therefore, at the stage of soldering sensors and checking them, I recommend forming a serial network right away.</i>  <i>That is, we take the sensor, solder it, connect it directly to the controller, run ./digitemp_DS2490 -i got its ID, copied it into an Excel spreadsheet, and also added a ROM number ... to the table.</i> <i><br></i>  <i>They disconnected the sensor, pasted a serial number on it, and hung it on a garland, connecting patch cards.</i>  <i>I do not recommend to connect the garland to the controller and run the check, firstly it will be much longer, and secondly in light of the above, due to the fact that the responses from the sensors do not come consistently, it will be more difficult to look for the ID of the new sensor.</i> <br><br>  After you have tested all the sensors, connect the garland to the controller and run <code>./digitemp_DS2490 -i</code> <br><br>  Your network configuration file .digitemprc will be generated. <br><br>  You need to replace <br> <code>ROM 0 0x28 0x62 0xB5 0x19 0x03 0x00 0x00 0x61</code> <br> <code>ROM 1 0x28 0x29 0xD5 0x19 0x03 0x00 0x00 0xFD</code> <br> <code>ROM 2 0x28 0x59 0xDE 0x19 0x03 0x00 0x00 0x15</code> <br> <code>ROM 3 0x28 0xDA 0xD6 0x19 0x03 0x00 0x00 0x98</code> <br> <code>ROM 4 0x28 0xFD 0xBE 0x19 0x03 0x00 0x00 0x84</code> <br> <br>  on the one that you got in Excel in the same format. <br><br>  Save the resulting .digitemprc file in a different folder, because if you suddenly run <code>./digitemp_DS2490 -i</code> again, your file will be overwritten, and then the physical addressing will be incorrect with a high probability. <br><br>  After the 1-wire network is configured, you can read the values ‚Äã‚Äãof the sensors, run <code>./digitemp_DS2490 -q -a -r1 -n1</code> , the program will display the values ‚Äã‚Äãof the sensors. <br><br>  Check the correctness of the serial connection in the network, for example, heat the 5 sensor, and run the program, the temperature should increase by 4 (since the numbering comes from 0) <br><br>  <b>Go to the configuration of Zabbix</b> . <br><br>  The server on which Zabbix is ‚Äã‚Äãinstalled in zabbix is ‚Äã‚Äãcalled ZabbixServer. <br>  We create in it 129 data elements, that is, for each temperature sensor on the data element. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cae/026/82c/cae02682c2b44487f0ac46f79b851538.jpg" alt="image"><br><br>  For us it is important to understand: <br>  gmz.temp.t17 is the item key, they are used to send the sensor value <br>  and the element type must be ‚ÄúZabbix trapper‚Äù, since the values ‚Äã‚Äãwill be sent through the zabbix_sender program. <br><br>  We also create 12 additional data elements for each of the 12 air conditioners.  The sensors are located so that the 3 sensors are located under the cold air outlet of the air conditioner, therefore we consider the average of these three sensors, then the data element will be calculated. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59e/afa/9dc/59eafa9dc9aaab1120960a1fd989fc15.jpg" alt="image"><br><br>  Pay attention to the formula, that is, the last obtained sensor values ‚Äã‚Äãare added up and divided by three. <br><br>  After we have added the data elements we can send the data of the values ‚Äã‚Äãto Zabbix. <br><br>  Add the task to the root crontab: <br> <code>*/1 * * * * /usr/local/etc/digitemp/digitemp_cron.sh &gt; /dev/null 2&gt;&amp;1 <br></code> <br><br>  That is, run once a minute the script digitemp_cron.sh <br> <code>cat /usr/local/etc/digitemp/digitemp_cron.sh</code> <br> <br> <code>#!/usr/local/bin/bash</code> <br> <code>cd /usr/local/etc/digitemp/new/digitemp-3.6.0/</code> <br> <code>./digitemp_DS2490 -q -a -r1 -n1 -o"ZabbixServer gmz.temp.t%s %N %.2C" | /usr/local/bin/zabbix_sender -vv -z 127.0.0.1 -I 127.0.0.1 -T -i -</code> <br> <br>  <code>-o"ZabbixServer gmz.temp.t%s %N %.2C"</code> - this line defines the output format. <br><br>  <i>IMPORTANT!</i> <i><br></i>  <i>ZabbixServer is the host name with the Zabbix server installed in Zabbix.</i> <br><br>  Run <code>./digitemp_DS2490 -q -a -r1 -n1 -o"ZabbixServer gmz.temp.t%s %N %.2C" | /usr/local/bin/zabbix_sender -vv -z 127.0.0.1 -I 127.0.0.1 -T -i -</code> <code>./digitemp_DS2490 -q -a -r1 -n1 -o"ZabbixServer gmz.temp.t%s %N %.2C" | /usr/local/bin/zabbix_sender -vv -z 127.0.0.1 -I 127.0.0.1 -T -i -</code> <br><br>  as a result of the zabbix_sender operation, it should be that all strings are sent and received: <br><br>  <i>Info from server: "Processed 133 Failed 0 Total133 Seconds spent 0.000540"</i> <i><br></i>  <i>sent: 133;</i>  <i>skipped: 0;</i>  <i>total: 133</i> <br><br>  If so, then you can add graphs and triggers, and set up alerts. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d41/f58/c43/d41f58c433cccf84898aac238826455a.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/693/a84/520/693a845205c87d240d03819e6476ed4b.jpg" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/204478/">https://habr.com/ru/post/204478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204464/index.html">Caching Tutorial Part 2</a></li>
<li><a href="../204466/index.html">Microsoft Robotics. Parallel data processing</a></li>
<li><a href="../204470/index.html">Calculation of the position of celestial bodies in the sky. Part 1</a></li>
<li><a href="../204474/index.html">Furious bulls: how Wall Street became dependent on "high-speed" trades. Part 5 (and last)</a></li>
<li><a href="../204476/index.html">We write beautiful idiomatic Python</a></li>
<li><a href="../204484/index.html">Creating a Microsoft Word printable with PHP</a></li>
<li><a href="../204486/index.html">Admin tale about the economic aspects of information security</a></li>
<li><a href="../204488/index.html">Extract 3D models in O2C format from dat file</a></li>
<li><a href="../204490/index.html">Domain servers.com sold at auction for $ 300,000</a></li>
<li><a href="../204494/index.html">GameDev as a hobby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>