<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How the CIA caused the rain: using Rain Maker to gather information from closed objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The sensational news about the leak of the CIA archive was most often presented in the context of what the US secret service could overhear, spy, and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How the CIA caused the rain: using Rain Maker to gather information from closed objects</h1><div class="post__text post__text-html js-mediator-article">  The sensational news about the leak of the CIA archive was most often presented in the context of what the US secret service could overhear, spy, and learn about us from phones, computers and even televisions.  We bring to your attention information about one of their projects with the unusual name Rain Maker.  It is a set of utilities aimed at the hidden collection of information on the object under study, not connected to the Internet.  The agent receives a special USB flash drive with music and a portable VLC-player, connects it to the victim's computer and quietly works with modern hits.  When finished, sends the flash drive with the encrypted data hidden on it to the coordinator, who sends it to the center for decryption.  How is this technically implemented? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/438/0c6/1d8/4380c61d81464f17ad3865f009adb7f0.gif"></div><br>  * From the <a href="https://wikileaks.org/ciav7p1/cms/page_15728775.html">CIA archive</a> to this project.  The agents also have humor! <br><a name="habracut"></a><br><h2>  Running malware </h2><br>  Let's skip the stage of special preparation of the flash drive (we will reveal it a little later) and start with what happens when the user starts vlc.exe from this media. <br><br>  First of all, the player reads the file with its <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa374191(v%3Dvs.85).aspx">xml-manifest</a> in order to understand if there are any additional dependencies that need to be loaded.  There, the call of the supposedly standard library psapi.dll (process status application programming interface) is pre-registered, but its analog stub is launched, which then redirects requests to the original library.  In addition to the important function of redirection, the stub determines whether it is necessary to activate the main functionality of the spyware program or still do not give out.  To do this, the fact of launching the file from the ‚Äúprepared‚Äù flash drive (and not from other media) is checked by checking the hard-wired serial number of the disk volume and the number of the media on which the program runs.  Thus, the "spy" will not reveal itself if it is transferred somewhere. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How persistense is provided </h2><br>  This example is also interesting because the CIA has great experience in loading payload and ensuring persistense.  There is no need to think every time how to do this - there is a <a href="https://wikileaks.org/ciav7p1/cms/page_13762647.html">special library</a> and even <a href="https://wikileaks.org/ciav7p1/cms/files/Persisted-DLL-Spec-v2-SECRET.pdf">recommendations</a> on <a href="https://wikileaks.org/ciav7p1/cms/files/Persisted-DLL-Spec-v2-SECRET.pdf">how</a> to ensure the resistance of the malware to detection.  For example, advice is given to use standard functions for loading the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibrary</a> library, and the loader must correctly process all exit statuses in accordance with MSDN.  Fulfillment of such rules takes time and it happens that such things are simply ignored by blackhat-developers. <br><br>  However, attacks of this type are known.  A description of the principle of implementing such a side-by-side attack is available <a href="https://www.fireeye.com/blog/threat-research/2014/04/dll-side-loading-another-blind-spot-for-anti-virus.html">here</a> .  There is a chance that if the real file of this software got into the sandbox, it would be revealed.  However, there is still a human factor: would the administrator pay attention to the recommendation from the sandbox? <br><br>  If the dll stub was launched from the correct media, it converts the serial number into an AES key and decrypts the main library of the Rain Maker DLL and loads it in a separate thread as part of the main VLC process.  Moreover, the stub installs mutex in the OS, so that the main payload does not start several times to avoid errors in its operation. <br><br><h2>  Data collection </h2><br>  A new piece of malware, just created from ‚Äúout of nowhere‚Äù, checks how long it has been running on this computer, requesting its name and current time, and comparing the md5 hash of the name with the saved ones.  If 7 days have not passed, then the program will not search for new files on the computer, if it did not start or did not work for a long time (7 or more days), then it will proceed to the next steps.  The program keeps information secretly in NTFS streams.  This technique is not new, but effective, especially since, apparently, the CIA has already written <a href="https://wikileaks.org/ciav7p1/cms/page_13763236.html">libraries</a> to work with them - you just need to call the correct function DTNtfsAds_BK (wchar_t * filenameToAppendADS), connecting the library in advance, so the developer in the team does not even need to think how to use it.  This is once again confirmed by the simplicity of the <a href="https://wikileaks.org/ciav7p1/cms/page_11629033.html">guide</a> for beginners.  The data is written to the stream [drive_disc_displaced_flashki]: \\: $ DataIdN <br><br>  As soon as the program has determined that there is enough disk space to prevent the flash drive from overflowing and not interfere with listening to music to the agent, it starts collecting files on the configuration pre-wired into it.  For example, you could configure the package before uploading as follows: <br><br><pre><code class="dos hljs">RainMakerConfigurator.exe -t TargetDirectories.txt -e *.docx;*.doc;*.xls;*.xlsx;*.pdf; -f <span class="hljs-number"><span class="hljs-number">23</span></span> -vlc E:\vlc-<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>\vlc.exe -r plugins\access\customplugins.dat -p RainMaker_PubKey.pem</code> </pre> <br>  Where: <br>  <b>-t TargetDirectories.txt</b> - a list of directories on the target computer where to look for files <br>  <b>-e * .docx; *. doc; *. xls; *. xlsx; *. pdf</b> ‚Äî types of files to copy <br>  <b>-f 23</b> - the percentage of free space that should remain on the flash drive <br>  <b>-vlc E: \ vlc-2.1.5 \ vlc.exe</b> - VLC executable file that is stitched with malware <br>  <b>-r plugins \ access \ customplugins.dat</b> - the storage location for the encrypted data container <br>  <b>-p RainMaker_PubKey.pem</b> - path to the certificate, whose public key will protect the data in the container until the transfer of the media back to the CIA and their decryption using the private key, which is not issued to the agent. <br><br><h2>  Summary </h2><br>  Thus, information about which files were collected and what their contents are, remains closed until the moment of decryption and is not protected from disclosure if the media is in the wrong hands or data from the media will be copied to another media.  Most likely, such an attack vector was used to gather information in closed networks where there is no access to the Internet.  Unfortunately, there is no way to verify the truthfulness of the data published in the Wikileaks archive, especially since no one published the source codes of the tool, but the description of the attack script from the ‚Äúinternal CIA portal‚Äù looks quite plausible and should be considered as an actual way of penetration for such specific objects. <br><br>  Yuri Sergeyev, Jet Information Systems Information Security Center. </div><p>Source: <a href="https://habr.com/ru/post/324920/">https://habr.com/ru/post/324920/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324910/index.html">Why do you need a manufacturer‚Äôs service for IT equipment and its cost estimate?</a></li>
<li><a href="../324912/index.html">PayPal Node.js</a></li>
<li><a href="../324914/index.html">We develop video chat between the browser and the mobile application</a></li>
<li><a href="../324916/index.html">The winning decision of the ML Boot Camp III contest</a></li>
<li><a href="../324918/index.html">Docker and detection of available resources inside the container</a></li>
<li><a href="../324922/index.html">Threat Horizon 2017-2019 by the International Security Forum (executive executive)</a></li>
<li><a href="../324924/index.html">Cook ML Boot Camp III: Starter Kit</a></li>
<li><a href="../324926/index.html">We are friends of Angular with Google (Angular Universal)</a></li>
<li><a href="../324930/index.html">WhatsApp messages may be available to outsiders: a serious vulnerability allows access to your correspondence</a></li>
<li><a href="../324932/index.html">Everything you wanted to know about stack traces and hip dumps. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>