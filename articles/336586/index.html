<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of MS SQL Server, for those who see it for the first time (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1 

 We continue to analyze what is happening on our MS SQL server. In this part, we will look at how to get information about the work of users:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of MS SQL Server, for those who see it for the first time (part 2)</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/post/336302/">Part 1</a> <br><br>  We continue to analyze what is happening on our MS SQL server.  In this part, we will look at how to get information about the work of users: who does what and how much resources are spent on it. <br><br>  I think the second part will be of interest not only to DBA administrators, but also to developers (maybe even more developers) who need to understand what is wrong with queries on the production server, which previously worked fine in the test. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The tasks of analyzing user actions can be divided into groups and we will consider each separately: <a name="habracut"></a><br><br><ol><li>  <a href="https://habr.com/ru/post/336586/">analyze a specific query</a> </li><li>  <a href="https://habr.com/ru/post/336586/">analyze the load from the application in specific conditions (for example, when a user clicks a button in a third-party application working with the database)</a> </li><li>  <a href="https://habr.com/ru/post/336586/">analysis of the current situation</a> </li></ol><br><div class="spoiler">  <b class="spoiler_title">A warning</b> <div class="spoiler_text">  Performance analysis requires a deep understanding of the device and the principles of the database server and operating system.  Therefore, reading only these articles will not make you an expert. <br><br>  Considered criteria and counters in real systems are complexly dependent on each other.  For example, a high load HDD is often associated with the problem not of the HDD itself, but with a lack of RAM.  Even if you take some of the measurements, this is not enough for a balanced assessment of problems. <br><br>  The purpose of the articles is to introduce basic things using simple examples.  Recommendations should not be considered as a ‚Äúguide to action‚Äù, consider them as learning tasks (simply reflecting reality) and as ‚Äúthink about‚Äù options designed to clarify the train of thought. <br>  I hope, on the basis of the articles, you will learn how to argue in numbers your conclusions about the server‚Äôs work.  And instead of the words ‚Äúserver slows down‚Äù you will give specific values ‚Äã‚Äãof specific indicators. <br></div></div><br><h4><a name="razdel1"></a>  Analyzing a specific query </h4><br>  The first paragraph is quite simple, we‚Äôll dwell on it briefly.  Consider only some less obvious things. <br><br>  <abbr title="SQL Server Management Studio">SSMS</abbr> , in addition to the results of the query, allows you to receive additional information about the execution of the query: <br><br><ul><li>  Practically everyone knows that the query plan is obtained with the buttons ‚ÄúDisplay Estimated Execution Plan‚Äù (evaluation plan) and ‚ÄúInclude Actual Execution Plan‚Äù (actual plan).  They differ in that the evaluation plan is built without fulfilling the request.  Accordingly, information on the number of processed lines in it will be only an estimate.  In actual terms, there will be both estimated and actual data.  Strong discrepancies between these values ‚Äã‚Äãindicate that statistics are irrelevant.  However, the analysis of the plan is a topic for a separate large article - until we go deep. </li><li>  A less well-known fact is that you can receive measurements of the cost of the processor and server disk operations.  To do this, you must enable the SET options either in the dialog through the menu "Query" / "Query options ..." <br><br><div class="spoiler">  <b class="spoiler_title">Screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/d7f/8da/028/d7f8da02864145508a70af8e0990aaaa.png"></div></div><br>  or directly with the SET commands in the request, for example <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Production.Product p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Production.ProductDocument pd <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.ProductID = pd.ProductID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Production.ProductProductPhoto ppp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.ProductID = ppp.ProductID</code> </pre> <br>  As a result of execution, we obtain data on the time spent on compiling and executing, as well as the number of disk operations. <br><br><div class="spoiler">  <b class="spoiler_title">Sample output</b> <div class="spoiler_text"><blockquote>  SQL Server parse and compile time: <br>  CPU time = 16 ms, elapsed time = 89 ms. <br><br>  SQL Server running time: <br>  CPU time = 0 ms, elapsed time = 0 ms. <br><br>  SQL Server running time: <br>  CPU time = 0 ms, elapsed time = 0 ms. <br><br>  (32 row (s) affected) <br>  Table "ProductProductPhoto".  The number of views is 32, logical reads 96, physical reads 5, preemptive reads 0, lob logical reads 0, lob physical reads 0, lob prefetching reads 0. <br>  Table "Product".  The number of views 0, logical reads 64, physical reads 0, prefetch reads 0, lob logical reads 0, lob physical reads 0, lob prefetch reads 0. <br>  Table "ProductDocument".  The number of views 1, logical reads 3, physical reads 1, preemptive reads 0, lob logical reads 0, lob physical reads 0, lob prefetching reads 0. <br><br>  SQL Server running time: <br>  CPU time = 15 ms, elapsed time = 35 ms. </blockquote><br></div></div><br>  Here you should pay attention to the compilation time and the text of "logical readings 96, physical readings 5".  With the second and subsequent executions of the same query, the physical reads may decrease, and re-compilation may not be necessary.  Because of this, it often happens that the second and subsequent times the request is executed faster than the first.  The reason, as you understand, is in caching data and compiled query plans. </li><li>  Another useful button next to the buttons of the plans - ‚ÄúInclude Client Statistics‚Äù - displays information on the network exchange, the number of operations performed and the total execution time, taking into account the costs of network exchange and processing by the client. <br><br><div class="spoiler">  <b class="spoiler_title">An example that shows that the first execution takes more time.</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/f36/a89/d29/f36a89d29cde4c8ea9be691e854839ae.png"></div></div></li><li>  In the SSMS 2016 version, the button "Include Live Query Statistics" appeared.  Displays a picture as in the case with the request plan, only the numbers of the processed lines on it are not static, but change on the screen right in the process of executing the request.  The picture is very clear - you can immediately see from the flashing arrows and running numbers where time is wasting.  The button is in the 2016 studio, but works with servers since the 2014 version. </li></ul><br>  Let's summarize the first part: <br><br><ul><li>  Processor costs are using SET STATISTICS TIME ON. </li><li>  Disk operations: SET STATISTICS IO ON.  Do not forget that ‚Äúlogical read‚Äù is a read operation that ends in the disk cache without physically accessing the disk system.  ‚ÄúPhysical reading‚Äù takes significantly longer. </li><li>  We estimate the volume of network traffic using ‚ÄúInclude Client Statistics‚Äù. </li><li>  We analyze the query execution algorithm in detail according to the ‚Äúexecution plan‚Äù using the ‚ÄúInclude Actual Execution Plan‚Äù and ‚ÄúInclude Live Query Statistics‚Äù. </li></ul><br><h4><a name="razdel2"></a>  Analyzing the load from the application </h4><br>  For the second section we arm with <abbr title="SQL Server Profiler">profiler</abbr> th.  After starting and connecting to the server, it is necessary to select logged events.  You can go a simple way - run profiling with a standard trace template.  On the ‚ÄúGeneral‚Äù tab, in the ‚ÄúUse the template‚Äù field, select ‚ÄúStandard (default)‚Äù and click ‚ÄúRun‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/616/319/642/616319642aa64c45a2ed0812c863b0ca.png"></div></div><br>  A slightly more complicated way is to add (or subtract) filters or events to the selected template.  These options on the second tab of the dialogue.  To see the full set of possible events and columns for selection, select the ‚ÄúShow All Events‚Äù and ‚ÄúShow All Columns‚Äù checkboxes. <br><br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/c14/07e/427/c1407e42712a482fafcb2df45f3b1c6a.png"></div></div><br>  From the events we will need (it is better not to include the extra ones - in order to create less traffic): <br><br><ul><li>  Stored Procedures \ RPC: Completed </li><li>  TSQL \ SQL: BatchCompleted </li></ul><br>  These events log all external sql calls to the server.  They arise, as the name implies (Completed), after the end of the processing of the request.  There are similar events fixing the start of the sql call: <br><br><ul><li>  Stored Procedures \ RPC: Starting </li><li>  TSQL \ SQL: BatchStarting </li></ul><br>  But they suit us less, because they do not contain information about server resources spent on the execution of the request.  It is obvious that such information is available only at the end of execution.  Accordingly, columns with data on CPU, Reads, Writes in * Starting events will be empty. <br><br>  Still useful events that we will not include yet: <br><br><ul><li>  Stored Procedures \ SP: Starting (* Completed) - records an internal call to a stored procedure (not from the client, but within the current request or another procedure). </li><li>  Stored Procedures \ SP: StmtStarting (* Completed) - fixes the start of each expression inside the stored procedure.  If there is a cycle in the procedure, there will be as many events for the commands within the cycle as there were iterations in the cycle. </li><li>  TSQL \ SQL: StmtStarting (* Completed) - fixes the start of each expression inside SQL-batch.  If your request contains several commands, it will be an event for each.  Those.  similar to the previous one, only valid not for commands within procedures, but for commands within a request. </li></ul><br>  These events are convenient for tracking execution steps.  For example, when using the debugger is impossible. <br><br>  <b>By columns</b> <br><br>  Which to choose, as a rule, is clear from the name of the column.  We will need: <br><br><ul><li>  TextData, BinaryData - for the events described above contain the request text itself. </li><li>  CPU, Reads, Writes, Duration - data on the cost of resources. </li><li>  StartTime, EndTime - start / end time.  Convenient for sorting. </li></ul><br>  Add other columns to your taste. <br><br>  By clicking the "Column Filters ..." button, you can open the event filter installation dialog.  If you are interested in the activity of a particular user, set the filter by session number or username.  Unfortunately, in the case of connecting the application through the app-server with the pool of connections, it is more difficult to track a specific user. <br><br>  Filters can be used, for example, to select only "heavy" requests (Duration&gt; X).  Or requests that cause intensive writing (Writes&gt; Y).  Yes, even just the contents of the request. <br><br>  <b>What else do we need from the profiler?</b>  <b>Of course the execution plan!</b> <br><br>  This possibility is available.  You need to add the event "Performance \ Showplan XML Statistics Profile" to the trace.  Fulfilling our request, we get about the following image. <br><br><div class="spoiler">  <b class="spoiler_title">Request text</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/abd/57b/c9b/abd57bc9bdc84fc0adb14837b72cdb17.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution plan</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/f18/21e/9e9/f1821e9e98a74b92b717316d9abdbd35.png"></div></div><br>  <b>And that is not all</b> <br><br>  The route can be saved to a file or a database table (and not just display it on the screen). <br>  Trace settings can be saved as a personal template for quick launch. <br>  Tracing can also be performed without a profiler using t-sql code using the following procedures: sp_trace_create, sp_trace_setevent, sp_trace_setstatus, sp_trace_getdata.  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/sql-trace/create-a-trace-transact-sql">An example of how to do this.</a>  This approach can be useful, for example, to automatically start recording tracks to a file on a schedule.  How exactly to use these commands, you can peek at the profiler.  It is enough to run two traces and in one to track what happens when the second starts.  Pay attention to the filter on the column "ApplicationName" - check that there is no filter on the profiler itself. <br><br>  The list of events recorded by the profiler is very extensive and is not limited only to receiving query texts.  There are events fixing fullscan, recompilation, autogrow, deadlock and more. <br><br><h4><a name="razdel3"></a>  Analyzing the activity of users in the whole server </h4><br>  Life situations are also such when the information from the sections above does not help: <br>  Some kind of query hangs on the "execution" for a very long time and it is unclear whether it will ever end or not.  Analyze the problem request separately - I would like to - but you must first determine what kind of request.  The profiler is useless to catch - we have already missed the starting event, and the completed one is unclear how long to wait. <br><br>  Or maybe not a user request at all, or maybe the server itself is actively doing something ... <br><br>  <b>Let's understand</b> <br><br>  All of you probably saw "Activity Monitor".  In older studios, its functionality has become richer.  How can he help us?  There is a lot of useful and interesting information in the Activity Monitor, but the third section is not about it.  All we need is to get directly from the system views and functions (and the Monitor itself is useful because you can set a profiler on it and see what requests it performs). <br><br>  We will need: <br><br><ul><li>  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-sessions-transact-sql">sys.dm_exec_sessions</a> - information about sessions.  Displays information on connected users.  Useful fields (within the framework of this article) - identifying the user (login_name, login_time, host_name, program_name, ...) and fields with information about the resources expended (cpu_time, reads, writes, memory_usage, ...) </li><li>  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql">sys.dm_exec_requests</a> - information about requests currently executing.  There are also quite a few fields here, we will consider only a few: <br><ul><li>  session_id - session code to communicate with the previous view </li><li>  start_time - request start time </li><li>  command - this field, contrary to the name, contains not the request, but the type of the command being executed.  For user queries, this is usually something like select / update / delete /, etc.  (also, important notes below) </li><li>  sql_handle, statement_start_offset, statement_end_offset - information for getting the query text: handle, as well as the starting and ending position in the query text - denoting the part currently being executed (for the case when your query contains several commands). </li><li>  plan_handle - the generated plan handle. </li><li>  blocking_session_id - when locks interfere with the execution of the request - indicates the session number that caused the blocking </li><li>  wait_type, wait_time, wait_resource - fields with information about the cause and duration of the wait.  For some types of waiting, for example, data locking - the code of the blocked resource is additionally indicated. </li><li>  percent_complete - by name it is clear that this is the percentage of completion.  Unfortunately, it is only available for commands that have clearly predictable progress (for example, backup or restore). </li><li>  cpu_time, reads, writes, logical_reads, granted_query_memory - resource usage. </li></ul></li><li>  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-sql-text-transact-sql">sys.dm_exec_sql_text (sql_handle | plan_handle)</a> , <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-plan-transact-sql">sys.dm_exec_query_plan (plan_handle)</a> - functions for retrieving text and a query plan.  Below is an example of usage. </li><li>  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-stats-transact-sql">sys.dm_exec_query_stats</a> - aggregate statistics of execution by queries.  Shows which query has been executed and how many resources have been spent on it. </li></ul><br>  <b>Important notes</b> <br><br>  The above list is only a small part.  A complete list of all system views and functions is described in the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/system-dynamic-management-views">documentation</a> .  Also, there is a diagram of the links of the main objects in the form of a <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D39083">beautiful picture</a> - you can print it on A1 and hang it on the wall. <br><br>  The request text, its plan and execution statistics are the data stored in the procedural cache.  At runtime, they are available.  Once completed, accessibility is not guaranteed and depends on the pressure on the cache.  Yes, you can clear the cache manually.  Sometimes it is advised to do it when the execution plans ‚Äúfloated‚Äù, but there are a lot of nuances ... In general, ‚ÄúThere are contraindications, it is recommended to consult with a specialist‚Äù. <br><br>  The ‚Äúcommand‚Äù field is practically meaningless for user requests - after all, we can get the full text ... But everything is not so simple.  This field is very important for obtaining information about system processes.  As a rule, they perform some internal tasks and do not have the text sql.  For such processes, team information is the only hint at the type of activity.  In the comments to the previous article there was a question about what the server is busy when, it seems, it should not be busy with anything - perhaps the answer will be in the meaning of this field.  In my practice, the ‚Äúcommand‚Äù field for active system processes always showed something quite understandable: autoshrink / autogrow / checkpoint / logwriter /, etc. <br><br>  <b>How to use it</b> <br><br>  Let's move on to the practical part.  I will give a few examples of use, but do not limit your imagination.  Server possibilities are not limited to this - you can invent something of your own. <br><br>  <b>Example 1: What process consumes cpu / reads / writes / memory</b> <br><br>  To begin with, let's see which sessions consume the most, for example, CPU.  Information in sys.dm_exec_sessions.  But data on CPU (and also reads, writes) - accumulative.  That is, the number in the field contains "total" for all the time of connection.  It is clear that the one who connected a month ago will most of all, but has never disconnected.  This does not mean that he is loading the system right now. <br><br>  A bit of code solves the problem, an algorithm like this: <br><br><ol><li>  First, make a selection and save to a temporary table. </li><li>  then wait a bit </li><li>  do a second sample </li><li>  we compare the results of the first and second samples - the difference will be the costs incurred in step 2 </li><li>  for convenience, the difference can be divided by the duration of paragraph 2, to get the average "cost per second." </li></ol><br><div class="spoiler">  <b class="spoiler_title">Script example</b> <div class="spoiler_text"><pre> <code class="sql hljs">if object_id('tempdb..<span class="hljs-comment"><span class="hljs-comment">#tmp') is NULL BEGIN SELECT * into #tmp from sys.dm_exec_sessions s PRINT '       ' --     , ..      WAITFOR DELAY '00:00:01'; END if object_id('tempdb..#tmp1') is not null drop table #tmp1 declare @d datetime declare @dd float select @d = crdate from tempdb.dbo.sysobjects where id=object_id('tempdb..#tmp') select * into #tmp1 from sys.dm_exec_sessions s select @dd=datediff(ms,@d,getdate()) select @dd AS [ , ] SELECT TOP 30 s.session_id, s.host_name, db_name(s.database_id) as db, s.login_name,s.login_time,s.program_name, s.cpu_time-isnull(t.cpu_time,0) as cpu_Diff, convert(numeric(16,2),(s.cpu_time-isnull(t.cpu_time,0))/@dd*1000) as cpu_sec, s.reads+s.writes-isnull(t.reads,0)-isnull(t.writes,0) as totIO_Diff, convert(numeric(16,2),(s.reads+s.writes-isnull(t.reads,0)-isnull(t.writes,0))/@dd*1000) as totIO_sec, s.reads-isnull(t.reads,0) as reads_Diff, convert(numeric(16,2),(s.reads-isnull(t.reads,0))/@dd*1000) as reads_sec, s.writes-isnull(t.writes,0) as writes_Diff, convert(numeric(16,2),(s.writes-isnull(t.writes,0))/@dd*1000) as writes_sec, s.logical_reads-isnull(t.logical_reads,0) as logical_reads_Diff, convert(numeric(16,2),(s.logical_reads-isnull(t.logical_reads,0))/@dd*1000) as logical_reads_sec, s.memory_usage, s.memory_usage-isnull(t.memory_usage,0) as [mem_D], s.nt_user_name,s.nt_domain from #tmp1 s LEFT join #tmp t on s.session_id=t.session_id order BY cpu_Diff desc --totIO_Diff desc --logical_reads_Diff desc drop table #tmp GO select * into #tmp from #tmp1 drop table #tmp1</span></span></code> </pre></div></div><br>  In the code I use two tables: #tmp - for the first sample, # tmp1 - for the second.  When you first start, the script creates and fills #tmp and # tmp1 with an interval of one second, and does the rest.  On subsequent launches, the script uses the results of the previous execution as a base for comparison.  Accordingly, the duration of paragraph 2 on subsequent launches will be equal to the duration of your waiting between script launches.  Try to perform, you can immediately on the working server - the script creates only "temporary tables" (available only within the current session and self-destruct when disconnected) and does not carry a danger. <br><br>  Those who do not like to fulfill a request in the studio can wrap it in an application written in their favorite programming language.  I will show how to do this in MS Excel without a single line of code. <br><br>  In the menu "Data" connect to the server.  If you want to choose a table - choose an arbitrary - then change it.  As always, click ‚ÄúNext‚Äù and ‚ÄúFinish‚Äù until we see the ‚ÄúImport Data‚Äù dialog - in it you need to click ‚ÄúProperties ...‚Äù.  In the properties it is necessary to change the ‚Äúcommand type‚Äù to the value ‚ÄúSQL‚Äù and insert our slightly modified query into the field ‚Äúcommand text‚Äù. <br><br>  The request will have to be changed a bit: <br><br><ul><li>  add "SET NOCOUNT ON" - because  Excel does not like the cut-off number of lines; </li><li>  ‚ÄúTemporary tables‚Äù are replaced by ‚Äúvariable tables‚Äù; </li><li>  the delay will always be 1s - fields with averaged values ‚Äã‚Äãare not needed </li></ul><br><div class="spoiler">  <b class="spoiler_title">Modified Query for Excel</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tmp <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(session_id <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>,login_time datetime,host_name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),program_name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),login_name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),nt_user_name <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),cpu_time <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>,memory_usage <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>,writes <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>,logical_reads <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>,database_id <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @d datetime; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @d=<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @tmp(session_id,login_time,host_name,program_name,login_name,nt_user_name,cpu_time,memory_usage,<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>,writes,logical_reads,database_id) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> session_id,login_time,host_name,program_name,login_name,nt_user_name,cpu_time,memory_usage,<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>,writes,logical_reads,database_id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_sessions s; WAITFOR DELAY '00:00:01'; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @dd <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @dd=<span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span>(ms,@d,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> s.session_id, s.host_name, db_name(s.database_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> db, s.login_name,s.login_time,s.program_name, s.cpu_time-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.cpu_time,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cpu_Diff, s.reads+s.writes-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.reads,<span class="hljs-number"><span class="hljs-number">0</span></span>)-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.writes,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> totIO_Diff, s.reads-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.reads,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> reads_Diff, s.writes-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.writes,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> writes_Diff, s.logical_reads-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.logical_reads,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> logical_reads_Diff, s.memory_usage, s.memory_usage-<span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>(t.memory_usage,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [mem_Diff], s.nt_user_name,s.nt_domain <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_sessions s <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> @tmp t <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> s.session_id=t.session_id</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Process pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/b83/864/fca/b83864fcaf77450fb3487a97f0dc3fc7.png"><br><img src="https://habrastorage.org/web/38a/9cd/506/38a9cd506c514bd5aebf499edba2643a.png"><br><img src="https://habrastorage.org/web/f8b/7fc/fb0/f8b7fcfb0d4e4dd992d2162a3b743e67.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/2e9/8b3/58c/2e98b358ccfc4f03a9200cd21ccb815e.png"><br></div></div><br>  When the data is in Excel, you can sort it as you need.  To update the information - click "Update".  For convenience, in the settings of the book, you can set ‚Äúauto-update‚Äù after a specified period of time and ‚Äúupdate on opening‚Äù.  File can save and transfer to colleagues.  Thus, we have collected a convenient and simple tool from <s>manure and twigs of</s> improvised means. <br><br>  <b>Example 2: What the session is spending resources on</b> <br><br>  So, in the previous example, we identified problem sessions.  Now we define what they do.  We use sys.dm_exec_requests, and also functions of obtaining the text and the plan of request. <br><br><div class="spoiler">  <b class="spoiler_title">Request text and plan by session number</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sql_handle varbinary(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @plan_handle varbinary(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">sid</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @statement_start_offset <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @statement_end_offset <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @session_id <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-comment"><span class="hljs-comment">--      -    SELECT @sid=182 --       IF @sid IS NOT NULL SELECT @sql_handle=der.sql_handle, @plan_handle=der.plan_handle, @statement_start_offset=der.statement_start_offset, @statement_end_offset=der.statement_end_offset, @session_id = der.session_id FROM sys.dm_exec_requests der WHERE der.session_id=@sid --    DECLARE @txt VARCHAR(max) IF @sql_handle IS NOT NULL SELECT @txt=[text] FROM sys.dm_exec_sql_text(@sql_handle) PRINT @txt --    / IF @plan_handle IS NOT NULL select * from sys.dm_exec_query_plan(@plan_handle) --       / IF @plan_handle IS NOT NULL SELECT dbid, objectid, number, encrypted, CAST(query_plan AS XML) AS planxml from sys.dm_exec_text_query_plan(@plan_handle, @statement_start_offset, @statement_end_offset)</span></span></code> </pre> </div></div><br>  Substitute the session number in the request and execute.  After execution, there will be plans on the ‚ÄúResults‚Äù tab (two: the first for the entire request, the second for the current step - if there are several steps in the request), on the ‚ÄúMessages‚Äù tab - the query text.  To view the plan - you need to click on the line on the text in the form of url.  The plan will open in a separate tab.  Sometimes it happens that the plan is not opened in graphic form, but in the form of xml-text.  This is most likely due to the fact that the studio version is lower than the server.  Try resaving the resulting xml to a file with the sqlplan extension, first deleting the ‚ÄúVersion‚Äù and ‚ÄúBuild‚Äù references from the first line, and then opening it separately.  If this does not help, I remind you that 2016 studio is officially available for free on the MS website. <br><br><div class="spoiler">  <b class="spoiler_title">Pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/822/1af/1df/8221af1dfd9a4ec0bb126c29518b3d7b.png"><br><br><img src="https://habrastorage.org/web/24d/eb9/9ba/24deb99bae1545fea459c5ecc70207e4.png"><br><br><img src="https://habrastorage.org/web/228/04e/b4b/22804eb4bdb7492c8853316eaa0a27b1.png"><br></div></div><br>  Obviously, the resulting plan will be "estimated", because  The request is still running.  But you can still get some statistics on execution.  We use the sys.dm_exec_query_stats view with a filter by our handles. <br><br>  We add to the end of the previous query <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    IF @sql_handle IS NOT NULL SELECT * FROM sys.dm_exec_query_stats QS WHERE QS.sql_handle=@sql_handle</span></span></code> </pre><br>  After execution, in the results we will receive information about the steps of the executed query: how many times they were executed and what resources were spent.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information in the statistics gets after execution - when you first run there, unfortunately, is empty. Statistics is not tied to the user, but is maintained throughout the entire server ‚Äî if different users execute the same query ‚Äî the statistics will be summary for all. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example 3: And you can see all</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's combine the system views and functions discussed in one request. This can be convenient for assessing the overall situation.</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      SELECT LEFT((SELECT [text] FROM sys.dm_exec_sql_text(der.sql_handle)),500) AS txt --,(select top 1 1 from sys.dm_exec_query_profiles where session_id=der.session_id) as HasLiveStat ,der.blocking_session_id as blocker, DB_NAME(der.database_id) AS , s.login_name, * from sys.dm_exec_requests der left join sys.dm_exec_sessions s ON s.session_id = der.session_id WHERE der.session_id&lt;&gt;@@SPID -- AND der.session_id&gt;50</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The request displays a list of active sessions and the texts of their requests. For system processes, I recall, usually the request is absent, but the ‚Äúcommand‚Äù field is filled. Visible information about locks and waits. You can try to cross this query with example 1, and also sort by load. But be careful - the texts of the requests can be very large. Choosing them massively can be resource intensive. Yes, and traffic will be great. In the example, I limited the received request to the first 500 characters, but did not begin to make a plan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of requests laid out on </font></font><a href="https://github.com/71rmn/habr-sample"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">githab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It would still be nice to get Live Query Statistics for an arbitrary session. According to the manufacturer, at the moment, the constant collection of statistics requires significant resources and therefore, by default, is disabled. The inclusion is not a problem, but additional manipulations complicate the process and reduce the practical benefits. Perhaps we will try to do this in a separate article. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this part, we reviewed the analysis of user actions. We tried several ways: using the capabilities of the studio itself, using the profiler, as well as direct access to system views. All these methods allow us to estimate the cost of executing the request and get the execution plan. There is no need to be limited to one of them - each method is convenient in its situation. Try to combine.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We still have an analysis of the load on memory and the network, as well as other nuances. </font><font style="vertical-align: inherit;">Let's get to them. </font><font style="vertical-align: inherit;">Material for a few articles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to Vlad for help in creating the article.</font></font></div><p>Source: <a href="https://habr.com/ru/post/336586/">https://habr.com/ru/post/336586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336572/index.html">Go, go, go ... First impressions</a></li>
<li><a href="../336574/index.html">Generation of documents. Easy and free</a></li>
<li><a href="../336578/index.html">Cryptoalgorithms. Classification in terms of the number of keys</a></li>
<li><a href="../336580/index.html">Metasloy: ideas about applying prediction to optimize programming and resource allocation in the OS</a></li>
<li><a href="../336584/index.html">Using the Chrome profiler frontend in your own projects</a></li>
<li><a href="../336588/index.html">Inkscape: ms_meme and holiday tree</a></li>
<li><a href="../336590/index.html">Puzzle game from scratch on ASP.NET Core 2, let's play?</a></li>
<li><a href="../336592/index.html">Android Oreo bites off a piece of PWA</a></li>
<li><a href="../336594/index.html">Face segmentation on a selfie without neural networks</a></li>
<li><a href="../336596/index.html">Useful tricks when working with netcat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>