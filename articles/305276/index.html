<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Floating point calculations: can you trust the results?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Those who deal with applied calculations know what troubles the finite accuracy of the representation of real numbers in a computer can bring. The mos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Floating point calculations: can you trust the results?</h1><div class="post__text post__text-html js-mediator-article">  Those who deal with applied calculations know what troubles the finite accuracy of the representation of real numbers in a computer can bring.  The most well-known problems in this regard are the solution of perturbation-sensitive (so-called, ill-conditioned) systems of linear equations and the determination of the eigenvalues ‚Äã‚Äãof asymmetric matrices. <br><br>  When it comes to everyday arithmetic operations, problems with finite precision calculations do not look so frightening.  And the best test that the result is obtained correctly is a comparison of the values ‚Äã‚Äãobtained at different precisions. <br><br>  If, for example, the calculations obtained on single and double precision coincide, then a feeling of confidence is created as a result, at least with an accuracy comparable to single.  Here, I would like to give one interesting example, which demonstrates that even in a <i>relatively simple arithmetic problem, such stability with variable accuracy in the representation of numbers cannot serve as a basis for such certainty</i> . <br><a name="habracut"></a><br>  It is necessary to calculate the value of the function of two variables at certain values ‚Äã‚Äã(given below) of its arguments: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://s.easydan.com/media/habr/20160708/latex_f943236364a9ee7b868c04a49eea4528.png" alt="An example of a computationally unstable function"><br><br>  This example was noticed by me when I dealt with the <a href="http//www2.math.uni-wuppertal.de/~xsc/xsc/cxsc_new.html">C-XSC</a> library (the <a href="http//www2.math.uni-wuppertal.de/~xsc/xsc/cxsc_new.html">C</a> class system of classes for (mainly) interval scientific calculations with arbitrary precision).  This library is well suited for the practical study of the computational stability of various numerical algorithms. <br><br>  To emulate floating-point calculations in Python, install the <a href="http://mpmath.org/">mpmath</a> package.  In principle, if we confine ourselves to the IEEE 754 accuracy, we could use NumPy, but we need to show that the results obtained in the framework of IEEE 754 are incorrect. <br><br>  Calculate the value of the function <i>f</i> ( <i>a</i> , <i>b</i> ) with <i>a</i> = 77617 and <i>b</i> = 33096. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding: utf-8 from mpmath import * def f(a,b): ''' From: Ramp SM Algorithms for verified inclusions -- theory and practice, USA, NY, 1988. ''' return (333.75 - a * a) * b ** 6 + a * a * (11 * a * a * b * b - 121 * b ** 4 - 2) + 5.5 * b ** 8 + a/(2.0*b) #   mp.dps = 8 a = mpf(77617) b = mpf(33096) print ' f(a, b)   :', f(a, b) #   mp.dps = 16 a = mpf(77617) b = mpf(33096) print ' f(a, b)   :', f(a, b)</span></span></code> </pre> <br><br>  The reader may notice that setting accuracy through <b>dps</b> in <b>mpmath</b> is not quite the right approach when emulating real double precision.  If we are talking about doubled and \ or single precision within the IEEE framework, then, perhaps, it is more correct to describe their characteristics through a binary system.  Here, however, it is not so important;  but using <b>mp.dps</b> is easier to interpret - i.e.  as the number of decimal digits in the number representation. <br><br>  Performing the code, we get: <br><br><pre> <code class="bash hljs"> f(a, b)   : 1.1726039  f(a, b)   : 1.172603940053179</code> </pre><br><br>  Completely convincing, right?  Only the value is wrong!  The correct value for given <i>a</i> and <i>b is</i> generally less than one! <br><br>  Let's complete the example with the following calculations: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>): mp.dps = i a = mpf(<span class="hljs-number"><span class="hljs-number">77617</span></span>) b = mpf(<span class="hljs-number"><span class="hljs-number">33096</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">' dps={0}, f(a,b)={1}'</span></span>.format(mp.dps, f(a,b))</code> </pre><br><br>  We get (some lines are omitted): <br><br><pre> <code class="bash hljs"> dps=8, f(a,b)=1.1726039  dps=9, f(a,b)=1.17260394  dps=10, f(a,b)=-7.737125246e+25 ...  dps=13, f(a,b)=1.172603940053  dps=14, f(a,b)=1.1726039400532  dps=15, f(a,b)=1.17260394005318  dps=16, f(a,b)=1.172603940053179  dps=17, f(a,b)=-9.2233720368547758e+18 ...  dps=28, f(a,b)=1.172603940053178631858834905  dps=29, f(a,b)=1.1726039400531786318588349045  dps=30, f(a,b)=1.17260394005317863185883490452 ...  dps=36, f(a,b)=-0.827396059946821368141165095479816292  dps=37, f(a,b)=-0.827396059946821368141165095479816292  dps=38, f(a,b)=-0.827396059946821368141165095479816292  dps=39, f(a,b)=-0.827396059946821368141165095479816291999</code> </pre><br><br>  It can be seen that despite the stability, some values ‚Äã‚Äãstill significantly differ from the usual ones, which already makes you wonder. <br>  I have to say right away that the values ‚Äã‚Äãobtained with accuracy <b>dps = 36</b> and higher are correct.  But how to know that with further increase in accuracy there will not be any more jump, because, as was seen with the value 1.17260 ..., even the stability of the result with different precisions cannot guarantee its correctness. <br><br>  Fortunately, this question can also be answered using the <b>mpmath</b> package.  This package allows you to perform interval calculations, which makes it possible to estimate the range of possible values ‚Äã‚Äãof a function when representing its arguments with different accuracy. <br><br>  Perform calculations using the <b>mpmath</b> interval arithmetic <b>unit</b> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>): iv.dps = j a = iv.mpf(<span class="hljs-number"><span class="hljs-number">77617</span></span>) b = iv.mpf(<span class="hljs-number"><span class="hljs-number">33096</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'={0}: f(a, b)={1}'</span></span>.format(mp.dps, f(a,b))</code> </pre><br><br>  We get the following: <br><br><pre> <code class="bash hljs"> dps=6: f(a, b)=[-5.0706024009e+30, 6.3382542101e+30]  dps=7: f(a, b)=[-3.16912650057e+29, 3.16912654779e+29]  dps=8: f(a, b)=[-5.94211218857e+28, 2.971056097974e+28]  dps=9: f(a, b)=[-3.7138201178561e+27, 4.9517601582944e+27]  dps=10: f(a, b)=[-1.54742504910673e+26, 3.09485009825849e+26]  dps=11: f(a, b)=[-1.934281311383407e+25, 3.86856262277385e+25]  dps=12: f(a, b)=[-4.8357032784585167e+24, 3.6267774588444373e+24]  dps=13: f(a, b)=[-3.02231454903657294e+23, 2.26673591177745118e+23]  dps=14: f(a, b)=[-2.833419889721787128e+22, 2.833419889721790484e+22]  dps=15: f(a, b)=[-3.5417748621522339103e+21, 3.5417748621522344346e+21]  dps=16: f(a, b)=[-442721857769029238784.0, 442721857769029246976.0]  dps=17: f(a, b)=[-27670116110564327424.0, 27670116110564327456.0]  dps=18: f(a, b)=[-3458764513820540927.0, 2305843009213693953.5]  dps=19: f(a, b)=[-432345564227567614.828125, 288230376151711745.179688]  dps=20: f(a, b)=[-36028797018963966.8274231, 18014398509481985.17260742]  dps=21: f(a, b)=[-3377699720527870.8273963928, 1125899906842625.172604084]  dps=22: f(a, b)=[-140737488355326.827396061271, 422212465065985.172603942454]  dps=23: f(a, b)=[-17592186044414.8273960599472, 17592186044417.17260394006735]  dps=24: f(a, b)=[-1099511627774.8273960599468637, 3298534883329.17260394005325]  dps=25: f(a, b)=[-137438953470.827396059946822859, 412316860417.172603940053178917]  dps=26: f(a, b)=[-17179869182.82739605994682137446, 17179869185.17260394005317863941]  dps=27: f(a, b)=[-2147483646.8273960599468213681761, 2147483649.1726039400531786320407]  dps=28: f(a, b)=[-268435454.827396059946821368142245, 268435457.172603940053178631864532]  dps=29: f(a, b)=[-8388606.827396059946821368141165871, 8388609.172603940053178631858840746]  dps=30: f(a, b)=[-1048574.8273960599468213681411651475, 1048577.1726039400531786318588349559]  dps=31: f(a, b)=[-131070.827396059946821368141165095792, 131073.172603940053178631858834907439]  dps=32: f(a, b)=[-8190.827396059946821368141165095483, 1.172603940053178631858834904520184761]  dps=33: f(a, b)=[-1022.8273960599468213681411650954798445, 1.1726039400531786318588349045201837979]  dps=34: f(a, b)=[-126.82739605994682136814116509547981678, 1.17260394005317863185883490452018372567]  dps=35: f(a, b)=[-6.827396059946821368141165095479816292382, 1.172603940053178631858834904520183709123]  dps=36: f(a, b)=[-0.82739605994682136814116509547981629200549, -0.82739605994682136814116509547981629181741]  dps=37: f(a, b)=[-0.827396059946821368141165095479816292005489, -0.827396059946821368141165095479816291981979]  dps=38: f(a, b)=[-0.8273960599468213681411650954798162919996113, -0.827396059946821368141165095479816291998142]  dps=39: f(a, b)=[-0.82739605994682136814116509547981629199906033, -0.82739605994682136814116509547981629199887666]</code> </pre><br><br>  It is interesting to follow the evolution of the interval of possible values ‚Äã‚Äãof the function: it stabilizes only when using accuracy of 36 or more significant decimal digits, although it is gradually narrowing. <br>  From interval calculations it becomes quite clear that you should trust only the results obtained with precisions from <b>dps = 36</b> or more decimal digits. <br><br>  This example is a clear demonstration of how careful it is to perform floating-point calculations, and that even 128-bit (for example, <b>numpy.float128,</b> if we talk about Python and <a href="http://numpy.org/">NumPy</a> ), the accuracy may be insufficient.  It also shows that it is impossible to trust and sustainability of the result obtained at different accuracy.  The use of the interval computational apparatus can be one of the solutions in this case, which allows us to estimate the necessary accuracy for obtaining an adequate result. </div><p>Source: <a href="https://habr.com/ru/post/305276/">https://habr.com/ru/post/305276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305264/index.html">How we sent SMS from the old Nokia and the phone to Android</a></li>
<li><a href="../305268/index.html">How to answer the question - what is a "computer virus"</a></li>
<li><a href="../305270/index.html">Welcome</a></li>
<li><a href="../305272/index.html">Our experience in creating applications on microservices in the field of advertising technologies</a></li>
<li><a href="../305274/index.html">13 workflows for email marketing automation</a></li>
<li><a href="../305280/index.html">9 ¬æ really useful tips for working on large projects</a></li>
<li><a href="../305282/index.html">Introduction to JavaFx and working with the layout in the examples</a></li>
<li><a href="../305284/index.html">How to create your own VPS hosting from scratch and start making money on it? Simple billing with Virtuemart</a></li>
<li><a href="../305286/index.html">In the fight against cancer: a multidisciplinary approach</a></li>
<li><a href="../305288/index.html">Replacing Android system files with adb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>