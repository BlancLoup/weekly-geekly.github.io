<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quickly create Apache virtual hosts using the bash script</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I moved from a VPS to a dedicated server, and there was an acute problem for me about transferring sites from an old server to a new ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quickly create Apache virtual hosts using the bash script</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I moved from a VPS to a dedicated server, and there was an acute problem for me about transferring sites from an old server to a new one, namely the rapid creation of virtual hosts and databases.  Of course, the ISPmanager control panel went to the server in the appendage, but in this case I didn‚Äôt like two things: <br><ul><li>  The panel does everything for you, but I want to pump the skill in the area of ‚Äã‚Äãadmission. </li><li>  I do not like the way of creating sites through the panel, namely the paths created to the site folder (/var/www/user_name/data/www/site.ru) </li></ul><br>  By virtue of this, I decided to adjust everything with pens.  About the installation of Apache and php, I will not write, as well as on Habr√© and on the Internet a lot of materials on this topic.  We are more interested in the rapid creation of a user, a virtual host, and a database.  Who cares please in the tackle. <br><a name="habracut"></a><br>  Logic decided to split into two scripts. <br><ul><li>  Creates a user and adds sites to its folder.  If there is no user, then it is created, if there is, then only the site is created. </li><li>  The second script creates a database and a user for the database, assigning it privileges to the database. </li></ul><br>  Some conditions for scripts. <br><ul><li>  Both scripts generate default passwords. </li><li>  Virtual host configs should be in / etc / apache2 / vhosts. </li><li>  All actions should be performed only from under the superuser. </li></ul><br>  Script to create a new virtual host (/ home / addsite) <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash IP_ADDRESS="1.2.3.4" APACHE2_DIR="/etc/apache2" UID_ROOT=0 if [ "$UID" -ne "$UID_ROOT" ]; then echo "$0 - Requires root privileges" exit 1 fi function is_user(){ local check_user="$1"; grep "$check_user:" /etc/passwd &gt;/dev/null if [ $? -ne 0 ]; then #echo "NOT HAVE USER" return 0 else #echo "HAVE USER" return 1 fi } function generate_pass(){ CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&amp;*()-_=+\\|/" LENGTH="8" while [ "${n:=1}" -le "$LENGTH" ] ; do PASSWORD="$PASSWORD${CHARS:$(($RANDOM%${#CHARS})):1}" let n+=1 done echo $PASSWORD } function is_yes(){ #TODO - add check 3-rd parameter for set default ansver (if press enter) while true do echo -n "Yes or No[Y/n]:" read x if [ -z "$x" ] then return 0; #defaul answer: Yes fi case "$x" in y |Y |yes | | | ) return 0;; n |N |no | | | ) return 1;; # * ) ; # asc again esac done } function create_user(){ local login="$1" local password="$2" `useradd -m -s /bin/bash $login` #set password echo -e "$password\n$password\n" | passwd $login &gt;&gt; /dev/null } USER_NAME=$1 echo -n "Check user name $USER_NAME: " if( is_user "$USER_NAME" )then USER_PASSWORD="$(generate_pass)" echo "-----------------------------------" echo "User name : $USER_NAME" echo "User password: $USER_PASSWORD" echo "-----------------------------------" echo -n "Continue? " if(! is_yes) then exit; fi echo "--- create user ---" create_user "$USER_NAME" "$USER_PASSWORD" fi if [ $# -eq 2 ]; then if [ "$2" != "delete" ]; then SITE_NAME=$2 mkdir /home/$USER_NAME/$SITE_NAME mkdir /home/$USER_NAME/$SITE_NAME/www mkdir /home/$USER_NAME/$SITE_NAME/logs mkdir /home/$USER_NAME/$SITE_NAME/tmp mkdir /home/$USER_NAME/$SITE_NAME/cgi-bin hostConf=" &lt;VirtualHost ${IP_ADDRESS}:80&gt; ServerName $SITE_NAME ServerAlias www.$SITE_NAME ServerAdmin webmaster@$SITE_NAME AddDefaultCharset utf-8 AssignUserID ${USER_NAME} ${USER_NAME} DocumentRoot /home/$USER_NAME/$SITE_NAME/www CustomLog log combined ErrorLog /home/$USER_NAME/$SITE_NAME/logs/error.log DirectoryIndex index.php index.html ScriptAlias /cgi-bin/ /home/$USER_NAME/$SITE_NAME/cgi-bin &lt;FilesMatch \"\\.ph(p[3-5]?|tml)$\"&gt; SetHandler application/x-httpd-php &lt;/FilesMatch&gt; &lt;FilesMatch \"\\.phps$\"&gt; SetHandler application/x-httpd-php-source &lt;/FilesMatch&gt; php_admin_value upload_tmp_dir "/home/$USER_NAME/$SITE_NAME/tmp" php_admin_value session.save_path "/home/$USER_NAME/$SITE_NAME/tmp" php_admin_value open_basedir "/home/$USER_NAME/$SITE_NAME/www:." &lt;/VirtualHost&gt; &lt;Directory /home/$USER_NAME/$SITE_NAME/www&gt; Options +Includes +ExecCGI php_admin_flag engine on &lt;/Directory&gt; " touch ${APACHE2_DIR}/vhosts/${SITE_NAME}.conf echo "$hostConf" &gt;&gt; ${APACHE2_DIR}/vhosts/${SITE_NAME}.conf touch //home/$USER_NAME/$SITE_NAME/www/index.php echo "&lt;?php phpinfo() ?&gt;" &gt;&gt; /home/$USER_NAME/$SITE_NAME/www/index.php chown $USER_NAME:$USER_NAME /home/$USER_NAME/$SITE_NAME/* service apache2 restart fi fi; #display information echo "*****************************************" echo "* Profit!" echo "*****************************************"</span></span></code> </pre> <br>  In general, nothing complicated, right at the beginning we set the ip address of the server and the folder where we have the Apache settings.  Do not forget to add permissions to the file <br><pre> <code class="bash hljs">chmod -x /home/addsite</code> </pre> <br>  In order for Apache to pick up our configs at the end of the main configuration file we add <br><pre> <code class="bash hljs">Include vhosts/</code> </pre> <br>  Run the script just <br><pre> <code class="bash hljs">/home/addsite user_name site.ru</code> </pre> <br>  The script will create a user, a virtual host and restart Apache.  And of course, do not forget to show the password for the newly created user. <br>  Database creation.  I was a bit bothered by the creation of a database from phpMyAdmin, you must first create a database, then a user, and still remember to add the privileges of the database to the new user, so we simplify our life (/ home / addbd). <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash MYSQL_PASS="derev123blog" UID_ROOT=0 if [ "$UID" -ne "$UID_ROOT" ]; then echo "$0 - Requires root privileges" exit 1 fi function generate_pass(){ CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&amp;*()-_=+\\|/" LENGTH="8" while [ "${n:=1}" -le "$LENGTH" ] ; do PASSWORD="$PASSWORD${CHARS:$(($RANDOM%${#CHARS})):1}" let n+=1 done echo $PASSWORD } function is_running(){ local result="$(ps -A|grep $1|wc -l)" if [[ $result -eq 0 ]]; then return 1 else return 0 fi } if [ $# -eq 1 ]; then echo -n "Check MySQL status: " if(is_running mysqld)then echo "OK [Running]"; DB_NAME=$1 DB_PASSWORD="$(generate_pass)" mysql -uroot -p${MYSQL_PASS} --execute="create database ${DB_NAME};" mysql -uroot -p${MYSQL_PASS} --execute="GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_NAME}'@'localhost' IDENTIFIED by '${DB_PASSWORD}' WITH GRANT OPTION;" else echo "Error: need start mysql daemon!" exit fi fi; #display information echo "*****************************************" echo "* Data base name: ${DB_NAME}" echo "* Data base user: ${DB_NAME}" echo "* User password: ${DB_PASSWORD}" echo "* Profit!" echo "*****************************************"</span></span></code> </pre> <br>  At the very beginning of the script we set the password for the root user from MySQL.  Run the command <br><pre> <code class="bash hljs">/home/addsite bd_name</code> </pre> <br>  The database and user will be created and the connection data will be displayed. <br>  You can also add both files to the / bin directory for quick access to these commands. <br><pre> <code class="bash hljs">cp /home/addsite /bin/addsite cp /home/addbd /bin/addbd</code> </pre> <br>  It seems like everyone else.  I hope this way of creating virtual hosts will simplify the lives of users as well as me. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/209962/">https://habr.com/ru/post/209962/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209950/index.html">Research security sites on various CMS</a></li>
<li><a href="../209952/index.html">Selection of updated materialized views in PostgreSQL 9.3</a></li>
<li><a href="../209956/index.html">JUCE - Cross-platform C ++ framework for developing applications with a user interface</a></li>
<li><a href="../209958/index.html">How Line forced its users to play games 100 million times a day</a></li>
<li><a href="../209960/index.html">Thirty Years' Apple</a></li>
<li><a href="../209970/index.html">SELinux - description and features of working with the system. Part 2</a></li>
<li><a href="../209972/index.html">How I started working on Odesk and Elance</a></li>
<li><a href="../209974/index.html">Vkontakte presented SDK for Android</a></li>
<li><a href="../209976/index.html">Cooper Journal: Your flat design is convenient for only one of us.</a></li>
<li><a href="../209982/index.html">Gartner Report: PaaS Market Leaders for Enterprise Applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>