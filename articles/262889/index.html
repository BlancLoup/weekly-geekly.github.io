<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why Go and Rust are not enemies, but friends</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You can keep the holy war about programming languages. Each of them combines the advantages and disadvantages. There is always an example when one lan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why Go and Rust are not enemies, but friends</h1><div class="post__text post__text-html js-mediator-article">  You can keep the holy war about programming languages.  Each of them combines the advantages and disadvantages.  There is always an example when one language loses to another on a specific task.  Some of them may well coexist side by side in one program.  In this post I will tell you how to connect Go and Rust into one. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/7e1/cec/a90/7e1ceca905314f6f9290b2c4c5dd5d49.png"></div><br><a name="habracut"></a><br>  This post is the answer to <a href="http://habrahabr.ru/post/262779/">Why Go and Rust are not rivals</a> and <a href="http://habrahabr.ru/post/262841/">Why Go and Rust are not rivals, but damn foes</a> . <br><br>  Rust and go have a lot of differences.  A different approach to memory management, different ancestors, a different goal in the end.  Their scope is intersected only partially.  If rust cares more about safe memory management, then go tries to improve the readability of the code. <br><br>  But there are languages ‚Äã‚Äãand similarities.  Both languages ‚Äã‚Äãare compiled.  Both are trying to incorporate the best of the already proven practices.  And most importantly, go and rust have a mutual friend.  One of the oldest languages.  Perhaps the most common and cross-platform.  The C language. Both of them have tools for calling a shared code.  So no one bothers to bind them together at the linking stage and make them pull each other‚Äôs functions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Let's start with rust </h2><br>  The first thing to do before building the code for rust is to describe the cargo package.  Since go can only create executable files, the rust code will have to be a static library.  To do this, create a file Cargo.toml: <br><pre><code class="hljs pgsql">[package] <span class="hljs-type"><span class="hljs-type">name</span></span> = "hello" version = "0.1.0" autors = ["Lain-dono &lt;lain.dono@gmail.com&gt;"] [lib] <span class="hljs-type"><span class="hljs-type">name</span></span> = "hello" <span class="hljs-type"><span class="hljs-type">path</span></span> = "lib.rs" crate-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = ["staticlib"] [dependencies] libc = "0.1.8"</code> </pre> <br>  The <code>package</code> section describes the <code>package</code> meta-information, the <code>lib</code> section describes what to build and how, and the <code>dependencies</code> section manages dependencies.  Dependence only on the standard C library.  The result is stored in the folder <code>/target/debug</code> or <code>/target/release</code> , depending on the transferred cargo keys. <br>  Now turn the code.  To start importing the necessary. <br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> libc; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::ffi::{CStr, CString};</code> </pre><br>  Now we need to decide what exactly we will call from the code on go.  Let it be a function with one string parameter: <br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HelloFromGo</span></span></span></span>(name: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> libc::c_char); }</code> </pre><br>  In turn, we need to declare a function that can be connected and called go.  Note the <code>#[no_mangle]</code> and <code>extern "C"</code> .  The first one says to rust-y, that you should not alter the name of the function in the compilation process in any way, and the second, that you should export the function as a sishna. <br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_from_rust</span></span></span></span>(name: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> libc::c_char) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buf_name = <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { CStr::from_ptr(name).to_bytes() }; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> str_name = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::from_utf8(buf_name.to_vec()).unwrap(); <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"go\t: {}"</span></span>, str_name);</code> </pre><br>  A little further call the go-function. <br><pre> <code class="rust hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> hello = CString::new(<span class="hljs-string"><span class="hljs-string">" :3 ,  Nim  ?"</span></span>).unwrap(); <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { HelloFromGo(hello.as_ptr()); } }</code> </pre><br><br><h2>  Turn go </h2><br>  Now we need to write code calling <code>hello_from_rust</code> and containing the main function. <br><br>  Declare a package called main and import the output library: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span></code> </pre><br>  Now we should import everything we wrote on rust.  When invoking the build utility, go also calls the linker.  Let's agree that we have a release version of the library written on rust.  And since we have a static library, we should also import <code>m</code> and <code>dl</code> . <br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">/* #cgo LDFLAGS: -L./target/release -lhello -lm -ldl void hello_from_rust(char *name); */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span></code> </pre><br>  Next you need to write a function that will be called from rust.  The comment before the f is telling the compiler to go import it. <br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//export HelloFromGo func HelloFromGo(name *C.char) { fmt.Println("rust\t:", C.GoString(name)) }</span></span></code> </pre><br>  It remains only to write the entry point to the application.  Here, the <code>hello_from_rust</code> function external to go is <code>hello_from_rust</code> <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { C.hello_from_rust(C.CString(<span class="hljs-string"><span class="hljs-string">" Rust!"</span></span>)) }</code> </pre><br><br><h2>  Conclusion </h2><br>  That's all.  It now remains to secure the friendly union with the Makefile: <br><pre> <code class="hljs go">build: cargo build --release <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> build main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> clean: cargo clean rm -f <span class="hljs-string"><span class="hljs-string">"./main"</span></span></code> </pre><br>  You can safely compile and run.  The code can be taken <a href="https://github.com/lain-dono/go-n-rust">here</a> . <br><br>  : wq </div><p>Source: <a href="https://habr.com/ru/post/262889/">https://habr.com/ru/post/262889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262869/index.html">The path of the analyst. Bug work</a></li>
<li><a href="../262871/index.html">How computers stack numbers</a></li>
<li><a href="../262879/index.html">10+ tips on writing fast code in Mathematica</a></li>
<li><a href="../262883/index.html">A convenient log is not a luxury, but a debugging tool, or how to connect a dll using the h file</a></li>
<li><a href="../262887/index.html">Technical Interview: Five Ways to Scare a Candidate / Five Ways to Fuck the Interviewer</a></li>
<li><a href="../262891/index.html">Six ways to reliably protect your organization from external and internal threats</a></li>
<li><a href="../262893/index.html">Gigahertz does not happen much</a></li>
<li><a href="../262895/index.html">Information about the members of the community Vkontakte online</a></li>
<li><a href="../262897/index.html">RC4 NOMORE: break the RC4 stream for tens of hours in TLS and WPA-TKIP</a></li>
<li><a href="../262901/index.html">Unity Integration with Google Spreadsheets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>