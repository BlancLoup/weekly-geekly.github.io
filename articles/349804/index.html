<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From a series of conversations with colleagues or a grain of experience: DC Edge design</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yesterday I talked with my old friend, he told about the completion of a large data center upgrade project - a network design from scratch, Leaf / Spi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From a series of conversations with colleagues or a grain of experience: DC Edge design</h1><div class="post__text post__text-html js-mediator-article">  Yesterday I talked with my old friend, he told about the completion of a large data center upgrade project - a network design from scratch, Leaf / Spine, TOR, new equipment, fault tolerance, everything is beautiful and fresh.  We have known each other since when 40Gbit / s seemed to be something beyond the limits of the slot, our professional roads proper came together against the background of studying internal oversubscription, architecture and traffic transmission features in line cards of a well-known manufacturer.  Therefore, when a friend asked: ‚ÄúDo you know why I'm calling you?‚Äù, I replied without thinking about it: ‚ÄúWhat, again, drops?‚Äù <br><a name="habracut"></a><br>  Having received an affirmative answer, I tried to find out what they are trying to figure out in such a situation ‚Äî the matrix and the traffic profile, the switch models, the up / down capacitance ratio, the order of the number of active servers, the types of ports, and so on.  I cannot take out the details of what I heard for everyone to see, however, it would not be superfluous to say that the switches my buddy deals with are based on Broadcom's Trident-2, which means the problem described below is to some extent unique for a specific manufacturer.  Note rather not about the internal architecture, but about the external design as a whole.  So, I managed to find out that a pair of Leaf switches, which are designed to connect the data center to the outside world and service devices, are causing complaints. <br><br><img src="https://habrastorage.org/webt/sk/bk/4z/skbk4zooc9c8ubvgdww7jaake_u.png" alt="image"><br><br>  It turned out that on the pair of Border Leaf switches, the ‚Äúbroad‚Äù LAGs were assembled in the direction of the upstream WAN Edge routers.  Data center traffic usually has asymmetry with respect to the incoming and outgoing lanes, we are interested in the direction of Border Leaf - WAN, where drops are observed.  On the one hand, we have several 40G ports before Leaf, on the other - LAG from 10G ports with even greater capacity.  In this case, the middle band does not reach even half of the possible.  Once again, I asked the friend what types of ports the servers are connected to, it turned out that all TORs have 10G on access ports.  Then I offered to think about this network as an old good TDM - each port in the LAG to the WAN can be represented in one time slot, suppose that the rest of the factory is not completely blocked, i.e.  as soon as a server initiates the sending of a stream, one of the time slots is utilized exclusively for these needs.  Having made such an assumption, we will not be far from the truth, since the channel speeds of access ports and ports in LAGs to WAN coincide, and the server always ‚Äúthrows‚Äù data into the network at the channel speed of its network card.  If it is a TCP protocol, the time slot is reserved for the time required to transfer the volume of bytes to the TCP window.  No matter how ‚Äúwide‚Äù LAGs are, the number of servers in the data center clearly exceeds the number of ports in it, so two (actually more) streams may well end up in buffer memory (we returned from TDM to Ethernet networks) waiting to be sent one same port. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/yk/lx/qe/yklxqevocejb2kbgcnqs2w9qwey.png" alt="image"><br><br>  Is it correct to build joints with a data center with a WAN at the channel speed of the access port?  Such an approach can work if the volume of the buffer memory of the switch is able to accommodate Incast traffic surges, with Broadcom chips this focus often fails.  9-12Mb of buffer memory on SoC for 48 ports of a standard TOR switch allows you to smooth out bursts from two sources with a duration of no more than 9Mb / 1250Mb / s = 0.0072s, where 1250 is the data amount transmitted on the 10G port every second.  The number of simultaneous sources is not equal to the number of servers, and for each data center requires its own assessment, taking into account the observed traffic, but in any case it is more than two.  In this case, the TOR on the Broadcom chip was ‚Äúdeployed‚Äù from the point of view of traffic and forced to be engaged in something completely unusual for him.  Instead of accepting traffic from low-speed and ports and sending it over high-speed, minimizing the consumption of buffer memory, the chip is forced to do the opposite. <br><br>  Let's go back to the design to develop solutions to the problem, offhand a few: <br><br><ol><li>  replace Border Leaf switches from Broadcom with switches with Deep Buffers.  Many manufacturers have models built on chips of their own design, specialized for this kind of applications. </li><li>  increase the channel speed of LAG ports to WAN, so that this speed exceeds the channel speed of access ports. </li><li>  Switch to Flex Ethernet when this technology comes to the data center. </li></ol><br>  As you can see, the first two options require updating the hardware component, in a running project this is usually not welcome, and the third option is completely exotic.  In addition, each implementation requires consideration.  And this problem had to be solved here and now, so I suggested to go along the Scale Out path.  What a lot of data center?  TOR switches of course - there is a set of spare parts, there is to expand.  Adding an even amount of Border Leaf and reallocating LAG ports to them, multiply reduces the number of competing streams and redistributes them across the appeared buffer memory.  As a quick solution to the problem, in my opinion, it is not bad, but we will come back to the conversation on the right path number one. </div><p>Source: <a href="https://habr.com/ru/post/349804/">https://habr.com/ru/post/349804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349794/index.html">Magento Meetup Kharkov - Videos and Presentations</a></li>
<li><a href="../349796/index.html">Why I don't like DevOps (and modern software)</a></li>
<li><a href="../349798/index.html">Automate the removal of forgotten transactions</a></li>
<li><a href="../349800/index.html">Depth training with reinforcements does not work yet</a></li>
<li><a href="../349802/index.html">Multi-stage (multi-stage builds) builds in Docker</a></li>
<li><a href="../349808/index.html">How we do AB-DOC</a></li>
<li><a href="../349810/index.html">Hyperapp for Refugees with React / Redux</a></li>
<li><a href="../349812/index.html">Segregated Witness for Dummies</a></li>
<li><a href="../349816/index.html">Open webinar "Features of JavaScript"</a></li>
<li><a href="../349818/index.html">Asynchronous HTTP requests in C ++: incoming through RESTinio, outgoing through libcurl. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>