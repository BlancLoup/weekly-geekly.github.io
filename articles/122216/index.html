<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learning the L4 microkernel and writing the ‚ÄúHello world‚Äù application for the Xameleon system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you have ever studied C or come across a new development environment, you probably have written the simplest application at least once to print ‚ÄúHe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learning the L4 microkernel and writing the ‚ÄúHello world‚Äù application for the Xameleon system</h1><div class="post__text post__text-html js-mediator-article"> If you have ever studied C or come across a new development environment, you probably have written the simplest application at least once to print ‚ÄúHello world‚Äù.  So, one of the possible options in the C language: <br><br> <i><code>#include &lt;stdio.h&gt; <br> int main(int argc, char * argv[], char * envp[]) <br> { <br> puts("Hello world!"); <br> return 0; <br> } <br></code></i> <br>  Let's save this code to the ‚Äúhello.c‚Äù file and using the gcc compiler, create the executable file using the following command: <br> <code>gcc hello.c -o hello</code> <br> <br>  As a result, if the compiler, header files and libraries are installed on your system, we get the executable file hello.  Perform it: <br> <code>./hello</code> <br> <br>  Elementary?  Until you decide to build and run this application, for example, running your own written operating system.  Next, I will talk in detail about this process and I bet that not everyone will find the strength to read the article to the end. <br><a name="habracut"></a><br>  First, a little theory and simple things.  Let's try to collect not an executable, but an object file.  For this we need the following command: <br> <code>gcc -c hello.c</code> <br>  the result is an object file hello.o.  What is characteristic of object files?  Their code is positionally independent, the object files contain tables of imported and exported functions and variables, and, more interestingly for us, the code does not depend much on the software platform, but is tied to the processor architecture.  Why this is important, I will tell further, but for now let's take a closer look at the contents of the object file using the following command: <br> <code>objdump -hxS hello.o</code> <br> <br>  <b>Object File Header</b> <br> <code>hello.o: file format elf32-i386 <br> hello.o <br> architecture: i386, flags 0x00000011: <br> HAS_RELOC, HAS_SYMS <br> start address 0x00000000 <br></code> <br>  <b>Used sections and their size</b> <br> <code>Sections: <br> Idx Name Size VMA LMA File off Algn <br> 0 .text 0000002e 00000000 00000000 00000034 2**2 <br> CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE <br> 1 .data 00000000 00000000 00000000 00000064 2**2 <br> CONTENTS, ALLOC, LOAD, DATA <br> 2 .bss 00000000 00000000 00000000 00000064 2**2 <br> ALLOC <br> 3 .rodata 0000000d 00000000 00000000 00000064 2**0 <br> CONTENTS, ALLOC, LOAD, READONLY, DATA <br> 4 .comment 00000012 00000000 00000000 00000071 2**0 <br> CONTENTS, READONLY <br> 5 .note.GNU-stack 00000000 00000000 00000000 00000083 2**0 <br> CONTENTS, READONLY <br></code> <br>  The .text section contains the assembly code for the hello program's main function.  As you can see from the example, the size of the program code is 46 bytes (0x24). The date section is empty, because our example does not use static and global variables that would be stored in this section.  Finally, the 13-byte (0xd) .rodata section contains the string ‚ÄúHello world!‚Äù. <br><br>  <b>The table of exported and imported objects</b> <br> <code>SYMBOL TABLE: <br> 00000000 l df *ABS* 00000000 hello.c <br> 00000000 ld .text 00000000 .text <br> 00000000 ld .data 00000000 .data <br> 00000000 ld .bss 00000000 .bss <br> 00000000 ld .rodata 00000000 .rodata <br> 00000000 ld .note.GNU-stack 00000000 .note.GNU-stack <br> 00000000 ld .comment 00000000 .comment <br> 00000000 g F .text 0000002e main <br> 00000000 *UND* 00000000 puts <br></code> <br>  In this table, we are interested in the last two lines - the description of the main function, which is defined in our simplest program and the description of the external function of puts, which is defined elsewhere. <br>  In principle, if you compile this example under Linux and link the resulting source file under FreeBSD, then most likely it will work without problems.  True and vice versa.  And now let's take a look at the assembly code of our program hello.c 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Disassembly of section .text:</b> <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">00000000 &lt;main&gt;: <br> 0:    8d 4c 24 04             lea    0x4(%esp),%ecx <br> 4:    83 e4 f0                 and    $0xfffffff0,%esp <br> 7:    ff 71 fc                 pushl -0x4(%ecx) <br> a:    55                      push  %ebp <br> b:    89 e5                    mov    %esp,%ebp <br> d:    51                      push  %ecx <br> e:    83 ec 04                 sub    $0x4,%esp <br> 11:    83 ec 0c                 sub    $0xc,%esp <br> 14:    68 00 00 00 00          push  $0x0 <br> 15: R_386_32    .rodata <br> 19:    e8 fc ff ff ff          call  1a &lt;main+0x1a&gt; <br> 1a: R_386_PC32    puts <br> 1e:    83 c4 10                 add    $0x10,%esp <br> 21:    b8 00 00 00 00          mov    $0x0,%eax <br> 26:    8b 4d fc                 mov    -0x4(%ebp),%ecx <br> 29:    c9                      leave <br> 2a:    8d 61 fc                 lea    -0x4(%ecx),%esp <br> 2d:    c3                      ret</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  As a matter of fact, this is the assembler code of our application created by the compiler.  By the way, welcome to AT &amp; T syntax style :) <br><br>  It was easy, and now let's move on to more complicated things.  The very first example from the article will create an executable file for your system.  In my case, Slackware Linux.  We know that the contents of the object file depends on the processor architecture, but it depends little on the operating system.  How to create an executable file for the Xameleon system from the resulting object file?  To do this, you must associate (clicked) the object file with the library functions of the Chameleon. <br><br>  Our example uses the puts function defined in the stdio.h header file. What is the puts function?  This is a function that outputs a string and a line break to standard input / output. <br>  For example, the puts function can be written like this: <br><br> <code>int puts(char * str) <br> { <br> int status, len; <br> <br> len = strlen(str); //    <br> status = write( 1, str, len ); //       <br> if( status == len ) status = write( 1, "\n", 1 ); //   ,    <br> if( status ==1 ) status += len; <br> return status; <br> } <br></code> <br>  It is possible to ‚Äúinfinitely‚Äù delve into the jungle of libc, but the purpose of the article is to show how this works in the Chameleon system.  By the way, the above example of the puts function does not pretend to be optimal, it only demonstrates an example of the simplest function.  You can only believe that the Chameleon libc is written more optimally.  However, we are distracted from the topic of narration, so let's get back to business and look closely at the write function.  This function is defined in the POSIX standard and it implements the interaction of our example with the operating system.  Refresh your memory with the command: man 2 write <br><br> <code>#include &lt;unistd.h&gt; <br> ssize_t write(int fd, const void *buf, size_t count); <br></code> <br>  Our example writes to file descriptor number 1, which, by standard, is nothing more than a standard output stream descriptor.  The buf parameter is a pointer to the memory area containing the data to be output (yes, there will be the address of the string ‚ÄúHello world‚Äù).  The third parameter is the size of the output data. <br><br>  <b>What distinguishes application and system programmers?</b> <br>  The application will say: "The write function outputs an array of data to an open file."  The system will respond: "The write function passes the file descriptor, a pointer to the data, and the number of bytes to write to the system."  Both will be right, but I want to remind you of the name of this blog.  :) <br><br>  So, we understand that the library function write refers to the kernel of the operating system, so we need to understand how this happens.  Since the Chameleon system is implemented on top of the L4 Pistachio microkernel, the system call is an IPC with two phases: <br><ol><li>  Transmission Phase ‚Äî transmits the file system service that serves the write function, a file descriptor, and an L4 string ‚Äî a data type that describes a region of memory. </li><li>  Receive Phase ‚Äî receives the status of the operation from the file system service. </li></ol><br><br>  In the Chameleon documentation, the write system call is described as follows. <br><img src="https://habrastorage.org/getpro/habr/post_images/3d6/778/468/3d6778468a20891000022ab08fbeb1b8.gif"><br>  Thus, the write system call POSIX is translated into IPC, shown in the figure above. <br><br>  The source code of the library function write, which, on the one hand, provides POSIX write (), on the other hand, provides interaction with the operating system kernel: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">ssize_t write( <br> <font color="#0000ff">int</font> nFileDescriptor, <br> <font color="#0000ff">const</font> <font color="#0000ff">void</font> *  pBuffer, <br> size_t          nBytesWrite ) <br> { <br> <font color="#0000ff">int</font> nStatus; <br> <font color="#0000ff">int</font> nChunk; <br> <font color="#0000ff">int</font> nTotalSent; <br> <font color="#0000ff">char</font> *  pPointer; <br> <br> L4_MsgTag_t       tag; <br> L4_Msg_t        msg; <br> L4_StringItem_t     SendString; <br> <br> nStatus = nTotalSent = 0; <br> pPointer = ( <font color="#0000ff">char</font> *) pBuffer; <br> <br> <font color="#0000ff">while</font> ( nBytesWrite ) <br> { <br> nChunk = (nBytesWrite &gt; 4096) ? 4096 : nBytesWrite; <br> SendString = L4_StringItem ( nChunk, ( <font color="#0000ff">void</font> *) pPointer ); <br> <br> L4_Clear( &amp;msg ); <br> L4_Set_Label( &amp;msg, fsWriteFile ); <br> L4_Append( &amp;msg, nFileDescriptor ); <br> L4_Append( &amp;msg, &amp;SendString ); <br> L4_Load( &amp;msg ); <br> tag = L4_Call( fs_service_id ); <br> <font color="#0000ff">if</font> ( L4_IpcFailed(tag) ) <br> { <br> nStatus = nTotalSent ? nTotalSent : XAM_EINTR; <br> <font color="#0000ff">break</font> ; <br> } <br> <font color="#0000ff">else</font> <br> { <br> L4_Store( tag, &amp;msg ); <br> nStatus = L4_Get( &amp;msg, 0 ); <br> <font color="#0000ff">if</font> ( nStatus &lt; 0 ) break; <br> nTotalSent += nStatus; <br> } <br> <br> pPointer  += nChunk; <br> nBytesWrite -= nChunk; <br> } <br> <br> <font color="#008000">// POSIX workaround</font> <br> <font color="#0000ff">if</font> ( nStatus &lt; 0 ) <br> { <br> errno = nStatus; <br> nStatus = -1; <br> } <br> <font color="#0000ff">else</font> <br> { <br> nStatus = nTotalSent; <br> } <br> <br> <font color="#0000ff">return</font> nStatus; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It looks like something new from the greedy Chameleon developers.  Let's take a closer look at the code and see how it corresponds to the WriteFile call from the documentation.  The first thing that catches your eye is the boundary of the buffer size up to 4 kilobytes.  This limitation is related to the specifics of the design of the file system module ‚Äî it makes sense to transfer longer data with another system call, which provides a temporary mapping of the pages of the requesting process to the address space of the file system service.  This feature goes far beyond the simple Hello world, so we will not consider it. <br>  The following data types are the L4 Pistachio microkernel structures used for messaging. <br><ul><li>  L4_MsgTag_t - message tag. </li><li>  L4_Msg_t is the structure carrying the message data. </li><li>  L4_StringItem_t - string L4 </li></ul><br>  These structures are defined in the header file message.h, the L4 Pistachio microkernel. <br><br>  The following code prepares a message to send to the file system service: <br> <code>SendString = L4_StringItem ( nChunk, (void*) pPointer ); //    <br> L4_Clear( &amp;msg ); //   <br> L4_Set_Label( &amp;msg, fsWriteFile ); //     <br> L4_Append( &amp;msg, nFileDescriptor ); //       <br> L4_Append( &amp;msg, &amp;SendString ); //      <br> L4_Load( &amp;msg ); //     <br></code> <br><br>  Next comes the system call of the microkernel, which, in fact, provides Inter Process Communication <br><br> <code>tag = L4_Call( fs_service_id );</code> <br> <br>  Where fs_service_id is a variable of type L4_ThreadId_t containing the file system service identifier.  How to get it, I will tell below, when we turn to the magic of CRT (C RunTime code).  Now consider the code that analyzes the response from the file system service: <br><br> <code>if ( L4_IpcFailed(tag) ) <br> { <br> nStatus = nTotalSent ? nTotalSent : XAM_EINTR; <br> break; <br> } <br> else <br> { <br> L4_Store( tag, &amp;msg ); <br> nStatus = L4_Get( &amp;msg, 0 ); <br> if( nStatus &lt; 0 ) break; <br> nTotalSent += nStatus; <br> } <br></code> <br><br>  If the IPC is broken, then we check if the data was transmitted at the previous iteration and generate the corresponding return code.  In the case of correct completion of IPC, we process the return code. <br>  The description of the functions of the functions used with the L4_ prefix can be seen in the header files of the L4 Pistachio microkernel. <br><br>  Complicated?  I think yes.  But we are close to magic and baysex.  It is time to look carefully at the fs_service_id variable.  The Chameleon system is designed in such a way that the application initially does not know the file system service identifier, so you need to get it in some way. <br><br>  The allocation of all resources, including processes, program threads (execution threads) and memory, is supervisor process.  One of his system calls allows you to get the service ID by its name.  The initial initialization code for the libc functions that provide interaction with the file system is as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">const</font> <font color="#0000ff">char</font> szServiceName[3] = <font color="#A31515">"fs"</font> ; <font color="#008000">//     </font> <br> <br> L4_ThreadId_t  fs_service_id = L4_nilthread; <br> <br> <font color="#0000ff">extern</font> <font color="#A31515">"C"</font> <font color="#0000ff">int</font> xam_filesystem_init( <font color="#0000ff">void</font> ) <br> { <br> fs_service_id = GetDeviceHandle(szServiceName); <br> <font color="#0000ff">return</font> L4_IsNilThread(fs_service_id) ? XAM_ENODEV : 0; <br> } <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Let's go even deeper through the code and see the implementation of the function GetDeviceHandle, which returns the ID of the requested service. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">extern</font> L4_ThreadId_t  rootserver_id; <font color="#008000">//   Supervisor'</font> <br> <br> L4_ThreadId_t GetDeviceHandle( <font color="#0000ff">const</font> <font color="#0000ff">char</font> * szDeviceName) <br> { <br> L4_MsgTag_t           tag; <br> L4_Msg_t            msg; <br> L4_ThreadId_t          Handle; <br> <br> Handle = L4_nilthread; <br> <br> <font color="#0000ff">do</font> { <br> <br> L4_Clear(&amp;msg); <br> L4_Set_Label(&amp;msg, cmdGetDeviceHandle ); <br> L4_Append(&amp;msg, L4_StringItem( 1+strlen(szDeviceName), ( <font color="#0000ff">void</font> *) szDeviceName) ); <br> L4_Load(&amp;msg); <br> tag = L4_Call( rootserver_id ); <br> <font color="#0000ff">if</font> ( L4_IpcFailed(tag) ) <font color="#0000ff">break</font> ; <br> L4_Store( tag, &amp;msg ); <br> Handle.raw = L4_Get(&amp;msg, 1); <br> <br> } <font color="#0000ff">while</font> ( <font color="#0000ff">false</font> ); <br> <br> <font color="#0000ff">return</font> Handle; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You can draw an analogy with the previous example, but the difference is still there - this is the rootserver_id variable containing the Supervisor ID.  Since the xam_filesystem_init and GetDeviceHandle functions are called from CRT, the Supervisor ID must be obtained before the library is initialized. <br><br>  How can an application task get a Supervisor ID?  We are already very close to bytesex, so let's consider a data structure called the Kernel Interface Page (KIP).  This structure is described in the specification for the L4 Pistachio microcar and looks like this: <br><img src="http://img-fotki.yandex.ru/get/5507/almandrykin.2/0_5eb2d_55fd523f_orig"><br><br>  Since the supervisor is the first user process from the point of view of the microkernel, its identifier can be obtained based on the ThreadInfo field from the KIP.  A special feature of KIP is that the microkernel keeps this page in a single copy, but displays it in the address space of each process.  To get the KIP address, the process must run the following sequence of commands: <br><br><blockquote> <code><font color="black">lock;    nop <br> mov    %eax, kip <br></font></code> </blockquote><br><br>  The sequence of the assembler commands lock and nop will cause an exception that will intercept the microkernel and, before returning from the exception, will insert the address of the Kernel Interface Page in the EAX register. <br><br>  Finally, the final touch is finding the identifier of the Supervisor's serving thread, based on the data obtained from the Kernel Interface Page. <br><br><blockquote> <code><font color="black">mov  kip, %eax <br> movw  198(%eax), %ax <br> shrw  $4, %ax <br> movzwl  %ax, %eax <br> addl  $2, %eax <br> sall  $14, %eax <br> orl  $1, %eax <br> movl  %eax, rootserver_id <br></font> <br></code> </blockquote><br>  Thus, the CRT0 module at the time of program start initializes the library functions exchanging with various services of the Chameleon system. <br><br>  Dear readers, I am very surprised that you didn‚Äôt sleep, that you didn‚Äôt close the browser window and found the strength to read this far.  You will probably be interested in ‚Äúfeeling‚Äù the latest version of the <a href="http://l4os.ru/development_tools">Xameleon Developer's Toolkit</a> . <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/122216/">https://habr.com/ru/post/122216/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122210/index.html">Examining JOIN Performance in MySQL</a></li>
<li><a href="../122211/index.html">4 the lulz</a></li>
<li><a href="../122212/index.html">Apple has extended a lawsuit against Samsung</a></li>
<li><a href="../122214/index.html">Flash openly announced his friendship with regular telephony!</a></li>
<li><a href="../122215/index.html">Review of freely available and free IP PBXs (Asterisk, FreeSWITCH, SipXecs, Yate)</a></li>
<li><a href="../122220/index.html">Opening and viewing multiple recommendations with one click</a></li>
<li><a href="../122222/index.html">Genetic algorithm: struggling with premature convergence</a></li>
<li><a href="../122224/index.html">Rating of the largest IT companies in Russia 2010</a></li>
<li><a href="../122226/index.html">The unspoken rules for hunting news</a></li>
<li><a href="../122229/index.html">Join the broadcast Sharepoint Conference 2011 Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>