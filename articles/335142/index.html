<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About PKI "on the fingers" in 10 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="He suggested to colleagues to hold an internal mini-lecture on sabzh - the idea had come. I sat down to write a plan for the lecture and ... chot psih...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About PKI "on the fingers" in 10 minutes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/83b/4b3/e2e/83b4b3e2e9f248b48eaaea57e1f5361f.jpg"><br><br>  He suggested to colleagues to hold an internal mini-lecture on sabzh - the idea had come.  I sat down to write a plan for the lecture and ... chot psihanul - eventually woke up, writing down a small guide.  I thought it would be useful to add here something for quick understanding of what PKI is, why it is needed and how it works, as it was preparing to refresh the memory, I was looking for information, including on the favorite ‚ÄúHabrahabr√©‚Äù, but articles in this format not found. <br><br>  I am writing on the example of our everyday tasks that are familiar to many: passwordless access to OpenVPN servers and protection of access to resources using HTTPS. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Without a theory can not do </h2><br>  PKI (Public Key Infrastructure, public key infrastructure) is about security.  It is understood that each entity in the infrastructure has its own key, which it is uniquely identified by.  That is, if the key is stolen, the person who has stolen may appear as the affected entity.  PKI is needed in order to quickly minimize the consequences of such theft.  The key is represented in two parts: public and private. <br><br>  Analog is RSA keys for SSH, but it is difficult to call them infrastructure, since there is no centralized mechanism for managing them.  Also, the difference is that the public part of the key in the SSH key pair is unchanged, and the certificate (the public part of the PKI member key) can be reissued at any time. <br><br>  In PKI, there is one (in fact, there should be at least two) or several Certification Authority - certification centers (certification centers) that give public parts of their keys to customers who receive certificates signed by them.  Thus, the participants of the infrastructure ‚Äúunderstand‚Äù who controls them, and whether the certificate issued to them or their ‚Äúcomrades‚Äù is valid at the present time (one of the most important attributes of certificates is their expiration date).  Or the server, which has the public part of the CA key infrastructure, in which he and his clients work, understands that the client has come to him with a valid certificate, and allows him something, or prohibits otherwise. <br><br><h2>  OpenVPN: how it happens </h2><br>  In fact, many companies already have a ‚ÄúPKI‚Äù for this case and he has a name, because this is someone from the staff.  Let's call such a person, for example, Poluekt (c) and tell you how it usually works, and then I will tell you how it should be ideally. <br><br>  When a new employee appears in the company, Poluekt creates and sends him an archive in which, in addition to the configuration of the OpenVPN client itself, there are files (for example, employee Ivanov A.A.): <br><br><ul><li>  a.ivanov-office.  <u>key</u> - its private key, the very flesh, which needs to be stored as the apple of an eye and not shown to anyone (analog in SSH is the id_rsa file); </li><li>  a.ivanov-office.  <u>csr</u> - Certificate Signing Request, a certificate signing request, which describes for whom the certificate should be written out, is generated based on the previous file, so as not to ‚Äúburn‚Äù the private key (for the work of OpenVPN itself, nafig is not needed); </li><li>  a.ivanov-office.  <u>crt</u> - the desired certificate that it presents to the OpenVPN server so that it will allow it to connect (in fact, this is the public part of the key); </li><li>  ca.  <u>crt</u> is the certificate of our CA, so that the OpenVPN client presents it to the server, so that it matches it with the private part that lies with it, and makes sure that it was he who signed the certificate and not someone else.  ‚ÄúDetalka‚Äù, which means that the OpenVPN client belongs to A. Ivanov‚Äôs client  to the PKI in which the server is running. </li></ul><br>  These are simple text files in a special PEM format.  Very convenient, unlike, for example, Microsoft's Java Keystore or PFX from Microsoft: you can merge certificates into a single file with a simple cat to form CA chains (called bundles, which is useful for nginx, for example, which has no separate directive for specifying a CA certificate), you can combine CA certificates and your own, and even your private key, if you need it for some reason.  And another utility: you can register a CA certificate directly in the configuration of the OpenVPN client, between the &lt;ca&gt; &lt;/ ca&gt; tags.  Probably, it should be possible to register a certificate in this way.  However, I am already distracted by particulars. <br><br>  At Acme, all these files are generated by Poluekt ... <br><br><h2>  And now how it should be </h2><br>  In my example, simply: <br><br><ul><li>  I locally generate my private key (it is possible and, perhaps, logical, to use the ready-made from ~ / .ssh / id_rsa): </li></ul><br> <code>openssl genrsa -out openvpn.key 2048</code> <br> <br><ul><li>  I am preparing a certificate signing request - CSR, for which I fill out a short form: </li></ul><br> <code>openssl req -new -key openvpn.key -out a.vrublevskiy-office. <u>csr</u> <br> You are about to be asked to enter information that will be incorporated <br> into your certificate request. <br> What you are about to enter is what is called a Distinguished Name or a DN. <br> There are quite a few fields but you can leave some blank <br> For some fields there will be a default value, <br> If you enter '.', the field will be left blank. <br> ----- <br> Country Name (2 letter code) [XX]: <u>RU</u> <br> State or Province Name (full name) []:. <br> Locality Name (eg, city) [Default City]: <u>Moscow</u> <br> Organization Name (eg, company) [Default Company Ltd]: <u>Pixonic</u> <br> Organizational Unit Name (eg, section) []: <u>Sysadmins Dept</u> <br> Common Name (eg, your name or your server's hostname) []: <u>Alexander Vrublevskiy</u> <br> Email Address []: <u>a.vrublevskiy@pixonic.ru</u> <br> <br> Please enter the following 'extra' attributes <br> to be sent with your certificate request <br> A challenge password []: <br> An optional company name []:</code> <br> <br>  (it is better not to specify the password at the end, otherwise you will have to enter it every time you connect, and we have a VPN with certificates just to prevent it; all the more, we have Google‚Äôs <a href="https://github.com/evgeny-gridasov/openvpn-otp">OTP</a> in Pixonic); <br><br><ul><li>  I send the resulting file a.vrublevskiy-office.  <u>csr</u> halfway; </li></ul><br><ul><li>  Poluuekt, having received my request and having both parts of the CA key (here ca.key and ca.crt), issues a certificate for me, signing it with the CA key (fashionable hipsters use easy-rsa, but we are harsh bearded admins): </li></ul><br> <code>openssl x509 -req -in a.vrublevskiy-office. <u>csr</u> -CA ca. <u>crt</u> -CAkey ca. <u>key</u> -out a.vrublevskiy-office. <u>crt</u> -days 90</code> <br> <br><ul><li>  Halfway sends me the resulting file. </li></ul><br>  A reasonable question arises: why such difficulties?  What is the PKI feature?  I answer.  The fact is that in this chain the chip is simply missing.  And it is called - CRL (Cerificate Revocation List).  This is a list of revoked certificates, which is published by CA, and into which Poluekt can deposit my certificate, issued and signed earlier, if it turned out that, for example, I rubbed with substances and was able to dictate my private key to competitors (well, or I was stolen laptop). <br><br>  Do you need this chip - a question for discussion.  Accordingly, how to implement it, so far is beyond the scope of this article. <br><br>  And about the validity period of the client certificate: if we assume that I settled in Pixonic under a temporary contract for 3 months and we did not renew it, then in the situation described my access to VPN will automatically turn off after 90 days from the date of issuance of the certificate.  What will not happen with SSH-access, if colleagues forget to disable the account in <a href="https://habrahabr.ru/company/pixonic/blog/325546/">FreeIPA</a> or delete the line from authorized_keys with their hands.  C - sesurit. <br><br><h2>  Now over <s>Borschev</s> HTTPS </h2><br>  Suppose you want to ‚Äúenable SSL‚Äù for your site so that visitors have a beautiful lock in the browser.  Here, in fact, everything is the same, but with some nuances: <br><br><ul><li>  Obviously, on your side, you can only generate a private key and a certificate signing request. </li><li>  When generating a request as a Common Name, you must specify the ServerName of your virtual host and all the aliases that you specify for it in the configuration of the web server.  For example, domain.tld and <a href="http://www.domain.tld/">www.domain.tld</a> , although ‚Äúwww‚Äù CAs themselves are usually added when issuing certificates.  Most often, you can simply specify * .domain.tld (to request the so-called wildcard certificate), but it is possible to learn this from a specific CA, and also clearly understand the consequences of such a decision.  As a rule, public CAs do not allow using an IP address as an alias. </li><li>  When generating a request, it is not necessary to specify the challenge password, otherwise you will have to enter it manually at each restart of the web server. </li><li>  Typically, public CAs are venerable offices like Comodo, <s>Symantec,</s> and GoDaddy.  Issuing a certificate costs money, and a good certificate costs a lot of money.  However, apart from them, <a href="https://letsencrypt.org/">Let's Encrypt</a> exists relatively recently - a free project that many people tend to trust, but I would think very well what resources and under what circumstances to protect them with certificates. </li><li>  These guys have agreed with other guys in such a way that the latter pre-install certificates (public parts of the keys, i.e. ca.crt from the previous example) of these CAs into their browsers.  That is, PKI, as such, is out of the question.  Simply, everyone agreed to trust certain companies.  This is not bad, since HTTPS is ultimately needed to encrypt traffic, and you can encrypt it with a self-signed key pair.  Rather, here is the question of prestige, so as not to shine a warning about an expired / invalid certificate to the entire Internet. </li><li>  Some specially gifted CAs offer for convenience to generate a private key and CSR for you.  This is not necessary.  I hope I see why. </li><li>  About the validity of certificates.  You should always think over the system of their timely update.  This is especially true for certificates from Let's Encrypt, the validity of which is only 3 months (at the time of writing). </li><li>  And about the agreements between "these guys."  As it turned out after the recent <a href="https://geektimes.ru/post/287272/">enchanting story</a> with Google and Symantec, now you need to be able to spread straws on such a "fun" occasion. </li></ul><br>  So it goes.  I hope that the understanding promised at the beginning of the article appeared. <br><br>  PS Of course, the venerable pro-safe man, who ate this dog, can move his hair in the most immodest places on how this article describes such a complex thing as PKI.  I wrote this small guide for those who seem to be faced with this at work, but do not really understand what he is doing and why.  A hardcore "matana" and without me missing in these your interns.  If, despite this, you have something to say - welcome to the comments. </div><p>Source: <a href="https://habr.com/ru/post/335142/">https://habr.com/ru/post/335142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335132/index.html">Dedicated servers based on Intel Xeon processors Skylake-SP</a></li>
<li><a href="../335134/index.html">WiFiBeat: We detect suspicious traffic in a wireless network</a></li>
<li><a href="../335136/index.html">Intelligent Automatic Pet Feeder Based on Arduino - STEP 1</a></li>
<li><a href="../335138/index.html">RequestQueueLimitPerSession and its distribution to older versions of .net</a></li>
<li><a href="../335140/index.html">Optimization and automation of web application testing</a></li>
<li><a href="../335144/index.html">Malicious code in npm-packages and the fight against it</a></li>
<li><a href="../335146/index.html">The book "Android. Programming for professionals. 3rd edition "</a></li>
<li><a href="../335148/index.html">Defending the MODX Revolution</a></li>
<li><a href="../335152/index.html">So who's back, bro?</a></li>
<li><a href="../335154/index.html">Mobile applications: how to avoid a ban from the advertising network?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>