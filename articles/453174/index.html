<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Eight reasons to switch to the new Yandex.Cash API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In October 2017, Yandex.Cashi has a new payment protocol and a third version of the API. We have already talked about how and why we came to this, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Eight reasons to switch to the new Yandex.Cash API</h1><div class="post__text post__text-html js-mediator-article">  In October 2017, Yandex.Cashi has a new payment protocol and a third version of the API.  We have already <a href="https://habr.com/ru/company/yamoney/blog/340210/">talked</a> about how and why we came to this, and now let us recall the key reasons for switching to it for those who have not yet done so. <br><br><h3>  1. Payment connection has become really fast </h3><br>  On the new API, it happens 5-10 times faster than before, and now the average developer can connect payments to his (well, or not quite) website or application in one working day, and not five, as it was before.  This, of course, is about that part of the work, when everything is agreed, applications have been approved and access keys have been received.  But this is also enough day. <br><a name="habracut"></a><br>  And for those who sell in social networks, billing works by mail, text message or just a link that can be sent to private messages. <br><br><h3>  2. Saves the power of developers and admins </h3><br>  To maintain the old version, you need to take care of various small things ‚Äî allocate a static IP address for working with the API, change certificates every year.  And in the old version there is no support for the SNI mode of HTTPS, which is now free of charge (or almost free of charge) included in the ‚ÄúHTTPS hosting‚Äù service for many hosting providers 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For returns, confirmation, cancellation or recurring payments using the card, the MWS (Merchant Web Services) protocol is used.  With the help of MWS, a store can <a href="https://kassa.yandex.ru/tech/payment-management/payment-management-financial-return-payment.html">make refunds</a> , <a href="https://kassa.yandex.ru/tech/payment-management/payment-management-financial-confirm-payment.html">confirm</a> and <a href="https://kassa.yandex.ru/tech/payment-management/payment-management-financial-cancel-payment.html">cancel</a> deferred payments, as well as <a href="https://kassa.yandex.ru/tech/payment-management/payment-management-financial-repeat-card-payment.html">repeat payments by credit card</a> (if the payer has agreed to this).  In the old version of the API for working with MWS, the store needed to receive an X.509 certificate from the Yandex.Money certification center, with which the store made requests to Yandex.Money.  Now it all comes out of the box - you just get access keys and implement the necessary payment methods. <br><br>  In general, a lot of unnecessary things have disappeared from the integration process, which we had to deal with on our own and spend time on developers and admins. <br><br><h3>  3. Only REST and nothing more </h3><br>  We <a href="https://habr.com/ru/company/yamoney/blog/340210/">rewrote</a> everything in REST-style - now the protocol is clearly constructed and behaves predictably.  In the piggy bank of past difficulties - almost every payment method had its own syntax, script, and <i>process</i> that you had to go through when installing, setting up, and conducting payments.  The new protocol got rid of "childhood diseases", meets the standards - which, among other things, are set by international payment leaders. <br><br>  Let's take a look at the <a href="https://kassa.yandex.ru/tech/payment-management/payment-management-financial-return-payment.html">old</a> and <a href="https://kassa.yandex.ru/developers/payments/basics/refunds">new</a> payment refund methods for comparison. <br><br>  Previously, it was necessary to create an order document for executing an operation according to the XML 1.0 standard, to form a PKCS # 7 crypto package with a digital signature, but without certification chains, data compression and encryption.  After that, a POST request was formed over HTTP / 1.1 with the body of the crypto package or as an attachment through the application / pkcs-mime MIME type.  Then things are easy - to transfer eight input parameters and, in principle, everything is ready. <br><br>  Total HTTP request: <br><pre><code class="plaintext hljs">POST /webservice/mws/api/returnPayment HTTP/1.1 Content-Type: application/pkcs7-mime Content-Length: 906 ‚Äî‚Äî-BEGIN PKCS7‚Äî‚Äî- MIAGCSqGSIb3DQEHAqCAMIACAQExCzAJBgUrDgMCGgUAMIAGCSqGSIb3DQEHAaCA JIAEgbE8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCI/Pg0KPG1h a2VEZXBvc2l0aW9uUmVzcG9uc2UgY2xpZW50T3JkZXJJZD0iMTI5MTExNjIzNDUy OCIgc3RhdHVzPSIwIi6789Jvcj0iMCIgcHJvY2Vzc2VkRFQ9IjIwMTAtMTEtMzBU MTE6MjM6NTQuNjI0WiIgYmFsYW5jZT0iNTQxNDYuNzMiIC8+DQoAAAAAAAAxggF8 MIIBeAIBATB3MGoxCzAJBgNVBAYTAlJVMQ8wDQYDVQQIEwZSdXNzaWExFjAUBgNV BAcTDVN0LlBldGVyc2J1cmcxITAfBgNVBAoTGEludGVybmV0IFdpZGdpdHMgUHR5 IEx0ZDEPMA0GA1UEAxMGc2VydmVyAgkAy2xbdQckXjIwCQYFKw4DAhoFAKBdMBgG CSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTEwMTEzMDEx MjM1NVowIwYJKoZIhvcNAQkEMRYEFEYNh8glwqIXGR/n6oYrApa8DaO5MA0GCSqG SIb3DQEBAQUABIGAHlgGsYK30RXWBvuQao0V73KIPQE1A6BCg7Y6Iag/xlmZ3rBB kFpszF/O2fB+t84pCHfV15ErZQEkAqIotkEYEgA3hAddEW5+RWUzp+3npHpW5OY7 h3niP5Pj+r0P8EDgHe2j0Zb3dzj2mbwOshZD+FP1IcR8AmiTV3u35C6KAEsAAAAA AAA= ‚Äî‚Äî-END PKCS7‚Äî‚Äî-</code> </pre> <br><br>  And the request for a refund: <br><pre> <code class="plaintext hljs">&lt;returnPaymentRequest clientOrderId="46890" requestDT="2011-07-02T20:38:00.000Z" invoiceId="2000000433" shopId="6689" amount="10.00" currency="643" cause="   " /&gt;</code> </pre> <br>  In the new version of the API, the refund to Python looks like this: <br><pre> <code class="plaintext hljs">refund = Refund.create({   "amount": {       "value": "2.00",       "currency": "RUB"   },   "payment_id": "21741269-000d-50be-b000-0486ffbf45b0" })</code> </pre><br>  Returns clear JSON, which can be parsed with anything in minimum time: <br><pre> <code class="json hljs">{   <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"216742f7-0016-50be-b000-078a43a63ae4"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"succeeded"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">"amount"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.00"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"currency"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUB"</span></span>   },   <span class="hljs-attr"><span class="hljs-attr">"created_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-10-04T19:27:51.407Z"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">"payment_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"21746789-000f-50be-b000-0486ffbf45b0"</span></span> }</code> </pre> <br>  Beauty. <br><br><h3>  4. Support for different languages ‚Äã‚Äãand technologies </h3><br>  The new API also has an <a href="https://kassa.yandex.ru/integration-mobile/">SDK for mobile devices</a> , PHP, Python, and Node.js.  Whatever your backend guys do (well, except for very exotic cases), payments via Cashier connect quickly.  If a person has been actively writing in Python for more than a couple of months - he will cope with the integration. <br><br>  Last year, we released a library for iOS and Android mobile apps.  With its help, payment forms are embedded in the application and look like its part (and no WebView).  Users will be able to pay by credit card, from a Yandex.Money wallet, via Google Pay, Apple Pay or Sberbank Online. <br><br>  Being implemented is also easy - give instructions to your developer and soon you will see how beautiful it is.  More information about how mobile SDK increases the level of happiness you and the users of your mobile applications, we have already written in our <a href="https://habr.com/ru/company/yamoney/blog/416871/">Hrabrablog</a> . <br><br><h3>  5. Regular payments without shamanism </h3><br>  Immediately after installation and configuration, card payments with pre-authorization of funds will be earned - they are built into the default API. <br>  Recurrent payments (from the card and from the wallet) are also there: you need to coordinate them with the security service, but it was the same in the old protocol.  If a recurrent payment card is used with a mandatory 3D-Secure, then the new API will first return a link to it. <br>  In general, everything has become simpler - here, too, there is no need to perform long rituals with MWS, obtaining certificates and all other cryptographies. <br><br><h3>  6. Automatic notifications about changing payment status </h3><br>  Previously, you had to manually check the status of each payment, and now, if it has changed, the developer will automatically drop a notification. <br>  Four types of automatic payment status notifications are built into the API v3: <br><ol><li>  "Waiting for confirmation by the merchant after payment", <br></li><li>  "Paid", <br></li><li>  ‚ÄúCanceled or an error occurred while paying‚Äù, <br></li><li>  "Payment refunded." <br></li></ol><br>  The old protocol had to write a complex MWS method listOrders, which showed the list and properties of orders.  12 parameters, complex logic of sending a request and an intriguing opportunity to receive a response in CSV format: <br><br><pre> <code class="plaintext hljs">status=0;error=0;processedDT=2011-08-02T14:46:58.096+03:00;orderCount=2 shopId;shopName;articleId;articleName;invoiceId;orderNumber;paymentSystemOrderNumber;customerNumber;createdDatetime;paid;orderSumAmount; orderSumCurrencyPaycash;orderSumBankPaycash;paidSumAmount;paidSumCurrencyPaycash;paidSumBankPaycash;receivedSumAmount;receivedSumCurrencyPaycash; receivedSumBankPaycash;shopSumAmount;shopSumCurrencyPaycash;shopSumBankPaycash;paymentDatetime;paymentAuthorizationTime;payerCode;payerAddress;payeeCode; paymentSystemDatetime;avisoReceivedDatetime;avisoStatus;paymentType;agentId;uniLabel;environment 1;" ";2;"-";2000024717776;"2011.08.02 09:07:32";483512879684006008;97881;2011-08-02T08:07:59.148+03:00;true;10.15;643;1003;10.15;643; 1003;10.15;643;1003;10.15;643;1003;2011-08-02T08:07:59.684+03:00;483512879684006008;41003476047679;192.168.1.127;41003131475668;2011-08-02T08:07:59.684+03:00; 2011-08-02T08:07:59.660+03:00;1000;AC;200002;1cd12967-0001-5000-8000-000000034fd8;Live 1;" ";2;"-";2000024717780;2000024717780;483512937773006008;770367;2011-08-02T08:08:57.175+03:00;true;10.00;643;1003;10.00;643; 1003;10.00;643;1003;10.00;643;1003;2011-08-02T08:08:57.773+03:00;483512937773006008;41003494819180;192.168.1.127;41003131475668;2011-08-02T08:08:57.773+03:00; 2011-08-02T08:08:57.730+03:00;1000;AC;200002;1cd129a4-0001-5000-8000-000000034fe1;Live</code> </pre> <br>  In the new version so.  Request: <br><pre> <code class="plaintext hljs">curl https://payment.yandex.net/api/v3/payments/{payment_id} \ -u &lt; &gt;:&lt; &gt; : { "id": "22312f66-000f-5100-8000-18db351245c7", "status": "waiting_for_capture", "paid": true, "amount": {   "value": "2.00",   "currency": "RUB" }, "created_at": "2018-07-18T10:51:18.139Z", "description": " ‚Ññ72", "expires_at": "2018-07-25T10:52:00.233Z", "metadata": {}, "payment_method": {   "type": "bank_card",   "id": "22ebbf66-000f-5000-8000-18db351245c7",   "saved": false,   "card": {     "first6": "555555",     "last4": "4444",     "card_type": "MasterCard"   },   "title": "Bank card *4444" }, "test": false }</code> </pre> <br><h3>  7. It is immediately clear at what point the error occurred. </h3><br>  If the payment did not go through, then instead of ‚Äúsomething went wrong‚Äù, the new API will explicitly make it clear why this happened - for example, the card ran out of money or the user wanted to pay through Sberbank Online, but it is not connected. <br>  Occasionally there may be short-term ‚Äúsomething went wrong‚Äù - we, of course, fight with them (lead editor Natasha nods in this place and shows thumb), but sometimes predictions of differences in the error mapping of different banks or unexpected behavior of the software is impossible.  Even us. <br>  In general, if the payment is canceled, then the API response will immediately be clear, because of what: <br><pre> <code class="plaintext hljs">{ "id": "22379b7b-000f-5000-9030-1a603a795739", "status": "canceled", "paid": false, "amount": {   "value": "2.00",   "currency": "RUB" }, "created_at": "2018-05-23T15:24:43.812Z", "metadata": {}, "payment_method": {   "type": "bank_card",   "id": "22977a7b-000f-5000-9000-1a603a795129",   "saved": false }, "recipient": {   "account_id": "100001",   "gateway_id": "1000001" }, "test": false, "cancellation_details": {   "party": "payment_network",   "reason": "payment_method_restricted" } }</code> </pre> <br><h3>  8. You can check everything before you start. </h3><br>  In order to receive test keys and see how everything works, you need to register in your Yandex.Cashbox personal account - you need a login on Yandex and the company's TIN.  In the questionnaire, select self-registration - a test loop will be created in a minute and you will be able to check how the payments go. <br><br>  When we had not yet launched this feature, a <a href="https://goo.gl/UTxiRc">test environment</a> was available in which you can try API v3 with the help of the Insomnia REST client.  There are examples for paying with a bank card, which clearly shows which request is sent, which response is returned and what happens at all stages of the data exchange process. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f4/4b4/85b/3f44b485b5bab915a49f1589344a3b7d.png"><br><br>  For all stages of integration and maintenance, we have a step-by-step guide in <a href="https://kassa.yandex.ru/docs/guides/">Russian</a> and <a href="https://checkout.yandex.com/docs/guides/">English</a> , and an even more detailed <a href="https://kassa.yandex.ru/docs/checkout-api/">reference book on API</a> . <br><br>  In general, go to the new API, if not yet, or <a href="https://kassa.yandex.ru/joinups%3Futm_medium%3Darticle%26utm_source%3Dhabr">connect to Yandex.Kassa</a> - everything is ready for your visit. </div><p>Source: <a href="https://habr.com/ru/post/453174/">https://habr.com/ru/post/453174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453164/index.html">PKCS # 11 cryptographic tokens. Graphic utility "with the function of signing and adding the timestamp." Part 1</a></li>
<li><a href="../453166/index.html">Turning ViewPager into fragment manager with iOS-style animation.</a></li>
<li><a href="../453168/index.html">Study: Creating a lock-resistant proxy service using game theory</a></li>
<li><a href="../453170/index.html">Brainstorming: how to look at tasks from a different angle</a></li>
<li><a href="../453172/index.html">"Norilsk Nickel" and "Gazinformservice" completed the 1st stage of building the protection of corporate ERP-system</a></li>
<li><a href="../453178/index.html">The main skill of the developer who will make your code better</a></li>
<li><a href="../45318/index.html">Gay Test v.2</a></li>
<li><a href="../453188/index.html">How to explain to non-IT managers how to build a resilient IT infrastructure</a></li>
<li><a href="../45319/index.html">Bind an icon to each type of file on CSS</a></li>
<li><a href="../453192/index.html">Synchronous and asynchronous processes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>