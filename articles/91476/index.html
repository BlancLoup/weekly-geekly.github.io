<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of services in MSWin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to the working need sometimes have to write system services for Microsoft Windows. 

 On Habr√© there is already an article Creating your own...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of services in MSWin</h1><div class="post__text post__text-html js-mediator-article">  According to the working need sometimes have to write system services for Microsoft Windows. <br><br>  On Habr√© there is already an article <a href="http://habrahabr.ru/blogs/cpp/71533/">Creating your own Windows Service</a> , but in my opinion, this article is nothing more than a brief overview that can be found in MSDN.  It does not consider, for example, possible options for the behavior of the service in case of an error, or writing to the message logs. <br>  I will try, using the experience of writing such applications, to present the maximum possible amount of information. <a name="habracut"></a><br><br>  We will not consider options when the service functions as a device driver (and, accordingly, is located in the file with the .sys extension), this is too specialized. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Typically, a service is simply an application run by <b>SCM</b> (Service Control Manager) and controlled by it.  For a programmer, this means that to start you need to provide some additional action. <br>  In addition, the correct service should not directly interact with the user.  What does this mean in practice?  By launching any application - we can see either the console window or the GUI of this application.  System services running under <b>Windows 2000</b> / <b>Windows XP</b> / <b>Windows 2003 Server</b> operating systems are also allowed; this service is called <i>interactive</i> .  But, at the same time, Starting from <b>Windows Vista</b> - a ban is imposed on interactive services.  It turns out that, developing a service, it is more correct to abandon interactivity. <br>  At the same time, MSDN offers the following options for user interaction: <br>  1) Displaying the dialog with the <b>WTSSendMessage ()</b> function <br>  the behavior is very flexible, you can display a dialog and wait for the user's reaction, you can simply inform the user and continue the application, etc., but the service needs to either work with terminal sessions or rely on the fact that the user active in the current terminal session has the necessary knowledge and rights to respond to a pop-up window (many people who are ignorant of IT are afraid of this behavior, this should also be taken into account when designing) <br>  2) Creating a separate application in the current user session using <b>CreateProcessAsUser ()</b> <br>  the most correct option, if only because the user is given a simple tool for interacting with the service, but it must be understood that the interaction must be organized either through sockets (the most common option), or through IPC, COM, and others, which somewhat complicates the common code but simplifies the service itself. <br>  It is also possible not to create a separate executable file, but to use the same service file, launched with a specific key, which somewhat simplifies the distribution and updating of the program. <br>  3) Calling <b>MessageBox ()</b> with the MB_SERVICE_NOTIFICATION parameter <br>  the worst option, the service (or the thread that caused it) will ‚Äúhang‚Äù while the user responds. <br><br>  When installing the service in the system or deleting, you should also take into account that only the Administrator, or a user equal to him, has the right to interact with SCM. <br><br>  In addition, the working folder of the service is System32 of your system, and there may be no rights to write to the folder in which the service is installed, so you should use the system‚Äôs Eventlog for logging (see below). <br><br>  Before giving the code, I note that when developing services for NT systems, I personally prefer to write the full names of functions without trusting them to be expanded by macros, so instead of <b>OpenSCManager</b> I usually write <b>OpenSCManagerW</b> . <br><br>  And so, first things first. <br><br>  The entry point into the service is either the console function main () or WinMain ().  Since ideologically it is not a console project, I use the second function. <br>  In the function itself, you should make a command line parser and provide for the handling of <i>install</i> , <i>uninstall</i> , <i>run</i> and <i>stop</i> <i>commands</i> , you can do it as you like.  Running the executable file without parameters will be considered the launch of the service via SCM.  This is the most correct behavior.  If someone tries to run a file without keys, the service simply does not start, and by processing the necessary commands, you can easily control the behavior of your service without remembering the console commands and parameters. <br>  Additionally, you will need a couple of functions to check whether the service is running and whether it is installed in the system: <br><br><blockquote><code><a href="http://s-c.me/6827/s"></a> <a href="http://s-c.me/6827/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#008000">/*    </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt; <font color="#0000ff">bool</font> is_install()&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">bool</font> Result = <font color="#0000ff">false</font> ;&lt;br/&gt;    SC_HANDLE l_srv_manager = NULL;&lt;br/&gt;    SC_HANDLE l_srv_process = NULL;&lt;br/&gt; &lt;br/&gt;    l_srv_manager = OpenSCManagerW(NULL, NULL, SC_MANAGER_ALL_ACCESS);&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_manager)&lt;br/&gt;    {&lt;br/&gt;        l_srv_process = OpenServiceW(&lt;br/&gt;                l_srv_manager,&lt;br/&gt;                g_str_srv_name.c_str(),&lt;br/&gt;                SERVICE_ALL_ACCESS&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_process)&lt;br/&gt;        {&lt;br/&gt;            Result = <font color="#0000ff">true</font> ;&lt;br/&gt;            CloseServiceHandle(l_srv_process);&lt;br/&gt;        }&lt;br/&gt;        CloseServiceHandle(l_srv_manager);&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#008000">/*       </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt;        MessageBoxW(&lt;br/&gt; <font color="#A31515">0</font> ,&lt;br/&gt;                L <font color="#A31515">"Cannot connect to Service Manager\ntry run with Administrator right !"</font> ,&lt;br/&gt;                L <font color="#A31515">"ERROR"</font> ,&lt;br/&gt;                MB_ICONERROR&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">return</font> Result;&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt;</font></code> </blockquote> <br><blockquote> <code><a href="http://s-c.me/6830/s"></a> <a href="http://s-c.me/6830/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#008000">/*    </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt; <font color="#0000ff">bool</font> is_run()&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">if</font> (!is_install())&lt;br/&gt; <font color="#0000ff">return false</font> ;&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">bool</font> Result = <font color="#0000ff">false</font> ;&lt;br/&gt;    SC_HANDLE l_srv_manager = NULL;&lt;br/&gt;    SC_HANDLE l_srv_process = NULL;&lt;br/&gt; &lt;br/&gt;    l_srv_manager = OpenSCManagerW(NULL, NULL, SC_MANAGER_ALL_ACCESS);&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_manager)&lt;br/&gt;    {&lt;br/&gt;        l_srv_process = OpenServiceW(&lt;br/&gt;                l_srv_manager,&lt;br/&gt;                g_str_srv_name.c_str(),&lt;br/&gt;                SERVICE_ALL_ACCESS&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_process)&lt;br/&gt;        {&lt;br/&gt;            SERVICE_STATUS_PROCESS l_srv_status;&lt;br/&gt;            DWORD l_dw_temp;&lt;br/&gt; <font color="#0000ff">if</font> (QueryServiceStatusEx(&lt;br/&gt;                        l_srv_process,&lt;br/&gt;                        SC_STATUS_PROCESS_INFO,&lt;br/&gt;                        reinterpret_cast&lt; <font color="#2b91af">LPBYTE</font> &gt; (&amp;l_srv_status),&lt;br/&gt; <font color="#0000ff">sizeof</font> (SERVICE_STATUS_PROCESS),&lt;br/&gt;                        &amp;l_dw_temp&lt;br/&gt;                    ) == TRUE&lt;br/&gt;                )&lt;br/&gt;            {&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_status.dwCurrentState == SERVICE_RUNNING)&lt;br/&gt;                    Result = <font color="#0000ff">true</font> ;&lt;br/&gt;            }&lt;br/&gt;            CloseServiceHandle(l_srv_process);&lt;br/&gt;        }&lt;br/&gt;        CloseServiceHandle(l_srv_manager);&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#008000">/*       </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt;        MessageBoxW(&lt;br/&gt; <font color="#A31515">0</font> ,&lt;br/&gt;                L <font color="#A31515">"Cannot connect to Service Manager\ntry run with Administrator right !"</font> ,&lt;br/&gt;                L <font color="#A31515">"ERROR"</font> ,&lt;br/&gt;                MB_ICONERROR&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">return</font> Result;&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt;</font></code> </blockquote> <br>  hereinafter g_str_srv_name is the std :: wstring string containing the name of the service. <br><br><blockquote> <code><a href="http://s-c.me/6836/s"></a> <a href="http://s-c.me/6836/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#008000">/*  </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt; <font color="#0000ff">int</font> srv_install()&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">if</font> (is_install())&lt;br/&gt; <font color="#0000ff">return</font> srv_start();&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">int</font> Result = - <font color="#A31515">1</font> ;&lt;br/&gt;    SC_HANDLE l_srv_manager = NULL;&lt;br/&gt;    SC_HANDLE l_srv_process = NULL;&lt;br/&gt; &lt;br/&gt;    l_srv_manager = OpenSCManagerW(NULL, NULL, SC_MANAGER_ALL_ACCESS);&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_manager)&lt;br/&gt;    {&lt;br/&gt;        std::wstring l_wstr = get_path();&lt;br/&gt; &lt;br/&gt;        l_srv_process = CreateServiceW(&lt;br/&gt;                l_srv_manager,&lt;br/&gt;                g_str_srv_name.c_str(),&lt;br/&gt;                g_str_srv_name.c_str(),&lt;br/&gt;                SERVICE_ALL_ACCESS,&lt;br/&gt;                SERVICE_WIN32_OWN_PROCESS,&lt;br/&gt;                SERVICE_AUTO_START,&lt;br/&gt;                SERVICE_ERROR_NORMAL,&lt;br/&gt;                (l_wstr + get_name()).c_str(),&lt;br/&gt;                NULL,&lt;br/&gt;                NULL,&lt;br/&gt;                NULL,&lt;br/&gt;                NULL,&lt;br/&gt;                NULL&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">if</font> (l_srv_process)&lt;br/&gt;        {&lt;br/&gt;            registry_editor_t l_reg_edit;&lt;br/&gt; &lt;br/&gt;            Result = <font color="#A31515">0</font> ;&lt;br/&gt; &lt;br/&gt;            HKEY l_kservice = NULL;&lt;br/&gt; &lt;br/&gt;            SERVICE_DESCRIPTIONW l_srv_descr;&lt;br/&gt;            SERVICE_FAILURE_ACTIONSW l_srv_action_f;&lt;br/&gt;            SC_ACTION <font color="#2b91af">l_srv_action</font> [] =&lt;br/&gt;            {&lt;br/&gt;                { SC_ACTION_RESTART, <font color="#A31515">500</font> },&lt;br/&gt;                { SC_ACTION_RESTART, <font color="#A31515">500</font> },&lt;br/&gt;                { SC_ACTION_RESTART, <font color="#A31515">500</font> }&lt;br/&gt;            };&lt;br/&gt; &lt;br/&gt;            l_srv_descr.lpDescription = const_cast&lt; <font color="#2b91af">wchar_t</font> *&gt; (g_str_srv_descr.c_str());&lt;br/&gt;            l_srv_action_f.dwResetPeriod = <font color="#A31515">120</font> ;&lt;br/&gt;            l_srv_action_f.lpRebootMsg = NULL;&lt;br/&gt;            l_srv_action_f.lpCommand = NULL;&lt;br/&gt;            l_srv_action_f.cActions = <font color="#A31515">3</font> ;&lt;br/&gt;            l_srv_action_f.lpsaActions = <font color="#2b91af">l_srv_action</font> ;&lt;br/&gt; &lt;br/&gt;            ChangeServiceConfig2W(&lt;br/&gt;                    l_srv_process,&lt;br/&gt;                    SERVICE_CONFIG_DESCRIPTION,&lt;br/&gt;                    &amp;l_srv_descr&lt;br/&gt;                );&lt;br/&gt;            ChangeServiceConfig2W(&lt;br/&gt;                    l_srv_process,&lt;br/&gt;                    SERVICE_CONFIG_FAILURE_ACTIONS,&lt;br/&gt;                    &amp;l_srv_action_f&lt;br/&gt;                );&lt;br/&gt; &lt;br/&gt; <font color="#008000">// HKEY_LOCAL_MACHINE\Software\MyService</font> &lt;br/&gt;            l_kservice = l_reg_edit.create(&lt;br/&gt;                    registry_editor_t::root::local_mashine,&lt;br/&gt;                    L <font color="#A31515">"Software\\MyService"</font> &lt;br/&gt;                );&lt;br/&gt; <font color="#0000ff">if</font> (l_kservice)&lt;br/&gt;            {&lt;br/&gt;                l_reg_edit.write(l_kservice, L <font color="#A31515">"Path"</font> , l_wstr);&lt;br/&gt;                l_reg_edit.close(l_kservice);&lt;br/&gt;            }&lt;br/&gt; &lt;br/&gt; <font color="#008000">// HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\*</font> &lt;br/&gt;            DWORD l_support = EVENTLOG_ERROR_TYPE |&lt;br/&gt;                              EVENTLOG_WARNING_TYPE |&lt;br/&gt;                              EVENTLOG_INFORMATION_TYPE;&lt;br/&gt;            HKEY l_kevent_log = l_reg_edit.create(&lt;br/&gt;                    registry_editor_t::root::local_mashine,&lt;br/&gt;                    (L <font color="#A31515">"SYSTEM\\CurrentControlSet\\Services\\EventLog\\Application\\MySvrMessages"</font> ).c_str()&lt;br/&gt;                );&lt;br/&gt; <font color="#0000ff">if</font> (l_kevent_log)&lt;br/&gt;            {&lt;br/&gt;                l_reg_edit.write(&lt;br/&gt;                        l_kevent_log,&lt;br/&gt;                        L <font color="#A31515">"EventMessageFile"</font> ,&lt;br/&gt;                        l_wstr + L <font color="#A31515">"messages.dll"</font> &lt;br/&gt;                    );&lt;br/&gt;                l_reg_edit.write(&lt;br/&gt;                        l_kevent_log,&lt;br/&gt;                        L <font color="#A31515">"TypesSupported"</font> ,&lt;br/&gt;                        l_support&lt;br/&gt;                    );&lt;br/&gt;                l_reg_edit.write(&lt;br/&gt;                        l_kevent_log,&lt;br/&gt;                        L <font color="#A31515">"CategoryMessageFile"</font> ,&lt;br/&gt;                        l_wstr + L <font color="#A31515">"messages.dll"</font> &lt;br/&gt;                    );&lt;br/&gt;                l_support = <font color="#A31515">3</font> ;&lt;br/&gt;                l_reg_edit.write(&lt;br/&gt;                        l_kevent_log,&lt;br/&gt;                        L <font color="#A31515">"CategoryCount"</font> ,&lt;br/&gt;                        l_support&lt;br/&gt;                    );&lt;br/&gt;            }&lt;br/&gt; &lt;br/&gt; <font color="#008000">// start service</font> &lt;br/&gt;            StartServiceW(l_srv_process, <font color="#A31515">0</font> , NULL);&lt;br/&gt; &lt;br/&gt;            CloseServiceHandle(l_srv_process);&lt;br/&gt;        }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt;        {&lt;br/&gt; <font color="#008000">/*      </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt;            std::wstring l_wstr = L <font color="#A31515">"Installation service failed\n"</font> ;&lt;br/&gt;            l_wstr += get_error();&lt;br/&gt;            MessageBoxW( <font color="#A31515">0</font> , l_wstr.c_str(), L <font color="#A31515">"ERROR"</font> , MB_ICONERROR);&lt;br/&gt;        }&lt;br/&gt; &lt;br/&gt;        CloseServiceHandle(l_srv_manager);&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt; <font color="#008000">/*       </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt;        MessageBoxW(&lt;br/&gt; <font color="#A31515">0</font> ,&lt;br/&gt;                L <font color="#A31515">"Cannot connect to Service Manager\ntry run with Administrator right !"</font> ,&lt;br/&gt;                L <font color="#A31515">"ERROR"</font> ,&lt;br/&gt;                MB_ICONERROR&lt;br/&gt;            );&lt;br/&gt; <font color="#0000ff">return</font> Result;&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt;</font></code> </blockquote> <br>  Let's look at what has been done here: <br>  1) get_path () / get_name () are functions for getting the name of the folder where the executable file of the service and the name of this executable file are located.  Self-written, so the implementation is arbitrary. <br>  2) the value of the SERVICE_WIN32_OWN_PROCESS flag is suitable for the vast majority of services.  The exception is not considered device drivers and file systems.  The second possible, within the scope of this article, the SERVICE_WIN32_SHARE_PROCESS flag means that the service process has a common memory area with other services, this is required if you have several services in one executable file.  The total memory area will allow you to save memory, and simplify the interaction of services, but it will make the debugging much more difficult, so I advise you to use this feature only if you clearly understand why you need it and what else - well, no matter how. <br>  3) SERVICE_AUTO_START - the service will start automatically when the system starts.  Please note that the moment of starting the service in this case is the initialization of system services, i.e.  before the user logs in.  This point should be considered if the service is working on the server.  Other possible options within the framework of the tooltip, SERVICE_DEMAND_START - start manually and SERVICE_DISABLED - do not start at all. <br>  4) The <b>SERVICE_FAILURE_ACTIONSW</b> structure describes the behavior of SCM in case of an emergency termination of a service. <br>  * <b>dwResetPeriod</b> - period for resetting data on the service behavior, specified in seconds.  The <b>INFINITE</b> value indicates that the data will not be overwritten. <br>  * <b>cActions</b> - the number of elements in the array describing the SCM reaction to the emergency behavior of the service, usually this number is 3 (three).  According to the points ‚ÄúFirst failure‚Äù, ‚ÄúSecond failure‚Äù and ‚ÄúSubsequent failures‚Äù: <br> <a title="ImageShack - Image And Video Hosting" href="http://img504.imageshack.us/i/apachek.png/"><img src="http://img504.imageshack.us/img504/2840/apachek.png"></a> <br>  Accordingly, filling the l_srv_action [] array with the fields {SC_ACTION_RESTART, 500} means that the service will automatically restart every 500 milliseconds after a crash. <br><br>  All information filled in these fields will be saved in the registry branch <br>  <b>HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Services \ MyService</b> <br>  In addition, you should add message handling services, for this we add a special branch to the registry <b>HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Services \ EventLog</b> .  In this thread, you must specify a file in the resources of which the MMC can find a description for logged errors.  In principle, you can add these resources to the executable file, but it is easier to create a separate dynamic library (in my case, messages.dll). How to create this library - I will write below. <br>  Well, that's all with the installation. <br>  The removal, start and stop of the service can be overlooked in the article given in the title, or there is nothing special in the code of these procedures. <br><br>  As a result, with the installation, removal and other commands, we sort of figured out, so you can continue on. <br>  With the entry point into the service is well explained in the previous article, I will add just a few clarifications: <br>  Call <b>StartServiceCtrlDispatcherW ()</b> Your service should no later than 30 seconds after entering WinMain (), otherwise the SCM will decide that the process being started is ‚Äúfrozen‚Äù and will unload it. <br><br>  Further, the most correct behavior of the service will first be the declaration of status as ‚Äústarting‚Äù, and then changing it to ‚Äústarted‚Äù, however, nothing prevents to set the status of the service as ‚Äústarted‚Äù right away. <br>  To do this in ServiceMain, you must perform the following steps: <br><blockquote> <code><a href="http://s-c.me/6841/s"></a> <a href="http://s-c.me/6841/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#008000">/*   </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt; <font color="#0000ff">void</font> service_t::main()&lt;br/&gt;{&lt;br/&gt;    m_handle = RegisterServiceCtrlHandlerExW(&lt;br/&gt;            g_str_srv_name.c_str(),&lt;br/&gt;            &amp;service_handler,&lt;br/&gt;            NULL&lt;br/&gt;        );&lt;br/&gt; <font color="#0000ff">if</font> (!m_handle)&lt;br/&gt;    {&lt;br/&gt;        system_logger_t::instance()-&gt;trace_info(&lt;br/&gt;                L <font color="#A31515">"register service handler failed"</font> &lt;br/&gt;            );&lt;br/&gt;        _set_stop();&lt;br/&gt; <font color="#0000ff">return</font> ;&lt;br/&gt;    }&lt;br/&gt; <font color="#008000">//</font> &lt;br/&gt;    m_status.dwCurrentState = SERVICE_START_PENDING;&lt;br/&gt;    m_status.dwWin32ExitCode = ERROR_SERVICE_SPECIFIC_ERROR;&lt;br/&gt;    m_status.dwServiceSpecificExitCode = ERROR_NOT_READY;&lt;br/&gt;    m_status.dwWaitHint = <font color="#A31515">5000</font> ;&lt;br/&gt; <font color="#0000ff">if</font> (SetServiceStatus(m_handle, &amp;m_status) == FALSE)&lt;br/&gt;    {&lt;br/&gt;        std::wstring l_error = get_error();&lt;br/&gt;        system_logger_t::instance()-&gt;trace_info(l_error);&lt;br/&gt;        _set_stop();&lt;br/&gt; <font color="#0000ff">return</font> ;&lt;br/&gt;    }&lt;br/&gt; <font color="#008000">//</font> &lt;br/&gt;    SetUnhandledExceptionFilter(exception_filter);&lt;br/&gt;    SetErrorMode(SEM_FAILCRITICALERRORS);&lt;br/&gt; <font color="#008000">// init</font> &lt;br/&gt; <font color="#008000">// ----</font> &lt;br/&gt;    m_status.dwControlsAccepted = SERVICE_ACCEPT_STOP |&lt;br/&gt;                                  SERVICE_ACCEPT_SESSIONCHANGE |&lt;br/&gt;                                  SERVICE_ACCEPT_SHUTDOWN;&lt;br/&gt;    m_status.dwWin32ExitCode = NO_ERROR;&lt;br/&gt;    m_status.dwCurrentState = SERVICE_RUNNING;&lt;br/&gt;    m_status.dwWaitHint = <font color="#A31515">0</font> ;&lt;br/&gt; <font color="#0000ff">if</font> (SetServiceStatus(m_handle, &amp;m_status) == FALSE)&lt;br/&gt;    {&lt;br/&gt;        std::wstring l_error = get_error();&lt;br/&gt;        trace_msg(l_error);&lt;br/&gt;        system_logger_t::instance()-&gt;trace_info(l_error);&lt;br/&gt; <font color="#0000ff">return</font> ;&lt;br/&gt;    }&lt;br/&gt;    m_run = <font color="#0000ff">true</font> ;&lt;br/&gt;    system_logger_t::instance()-&gt;trace_info(&lt;br/&gt;            L <font color="#A31515">"service start success"</font> &lt;br/&gt;        );&lt;br/&gt; <font color="#0000ff">while</font> ( <font color="#0000ff">true</font> )&lt;br/&gt;    {&lt;br/&gt; <font color="#0000ff">if</font> (!m_run)&lt;br/&gt;        {&lt;br/&gt; <font color="#0000ff">break</font> ;&lt;br/&gt;        }&lt;br/&gt; <font color="#0000ff">else</font> &lt;br/&gt;            Sleep( <font color="#A31515">10</font> );&lt;br/&gt;    }&lt;br/&gt;    _set_stop();&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt; <font color="#008000">/*</font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt; <font color="#0000ff">void</font> service_t::_set_stop()&lt;br/&gt;{&lt;br/&gt;    m_status.dwCurrentState = SERVICE_STOPPED;&lt;br/&gt;    SetServiceStatus(m_handle, &amp;m_status);&lt;br/&gt;    system_logger_t::instance()-&gt;trace_info(&lt;br/&gt;            L <font color="#A31515">"MyService stop"</font> &lt;br/&gt;        );&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt;</font></code> </blockquote> <br>  Here the service informs the SCM that it takes 5 seconds for it to initialize, which means that before the 5 seconds have elapsed it is necessary to inform the SCM of the completion of the initialization.  Otherwise, the service will be unloaded as ‚Äúhung‚Äù. <br>  In the above code, it is assumed that during the initialization of the service class, the structure fields were filled in as follows: <br> <code>memset(&amp;m_status, 0, sizeof(SERVICE_STATUS)); <br> m_status.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</code> <br>  In this case, the value of the <b>dwServiceType</b> field must correspond to the type of service we specified during installation, otherwise SCM will regard this as an incorrect behavior and will not allow the service to start. <br>  Hiding error messages and intercepting exceptions will allow you to independently handle errors in the program code, as well as, at times, allow you to avoid suspending the service.  Additionally, it will save the user from having to send error reports to developers from Microsoft. <br>  Naturally, it will be inserted into the body of the main loop of the <b>Sleep</b> service <b>(10)</b> in order to allow other programs to function normally (this is beyond the scope of this article). <br>  My message handler looks like this: <br><blockquote> <code><a href="http://s-c.me/6844/s"></a> <a href="http://s-c.me/6844/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#008000">/*   </font> &lt;br/&gt; <font color="#008000">*/</font> &lt;br/&gt;DWORD service_t::handler(DWORD dwControl,&lt;br/&gt;                         DWORD dwEnterType,&lt;br/&gt;                         LPVOID lpEventData,&lt;br/&gt;                         LPVOID lpContext)&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">switch</font> (dwControl)&lt;br/&gt;    {&lt;br/&gt; <font color="#0000ff">case</font> SERVICE_CONTROL_STOP:&lt;br/&gt; <font color="#0000ff">case</font> SERVICE_CONTROL_SHUTDOWN:&lt;br/&gt;        system_logger_t::instance()-&gt;trace_info(&lt;br/&gt;                L <font color="#A31515">"service try to stop"</font> &lt;br/&gt;            );&lt;br/&gt;        m_status.dwCurrentState = SERVICE_STOP_PENDING;&lt;br/&gt;        m_status.dwWaitHint = <font color="#A31515">10000</font> ;&lt;br/&gt;        SetServiceStatus(m_handle, &amp;m_status);&lt;br/&gt;        m_run = <font color="#0000ff">false</font> ;&lt;br/&gt; <font color="#0000ff">break</font> ;&lt;br/&gt; <font color="#0000ff">case</font> SERVICE_CONTROL_SESSIONCHANGE:&lt;br/&gt; <font color="#0000ff">break</font> ;&lt;br/&gt; <font color="#0000ff">default</font> :&lt;br/&gt;        SetServiceStatus(m_handle, &amp;m_status);&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">return</font> NO_ERROR;&lt;br/&gt;}&lt;br/&gt; <font color="#008000">//------------------------------------------------------------------------------</font> &lt;br/&gt;</font></code> </blockquote> <br><br>  Actually, the last thing that is lit up on the Internet is the least, how to correctly add a message from the service to the system log.  How to register a library in the registry is already written above, now about how to create this library. <br>  1) create a file with the .mc extension of the following content: <br><blockquote> <code><a href="http://s-c.me/6848/s"></a> <a href="http://s-c.me/6848/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;MessageIdTypedef = DWORD&lt;br/&gt;SeverityNames =&lt;br/&gt;    (&lt;br/&gt;        Success = 0x0 : STATUS_SEVERITY_SUCCESS&lt;br/&gt;        Informational = 0x1 : STATUS_SEVERITY_INFORMATIONAL&lt;br/&gt;        Warning = 0x2 : STATUS_SEVERITY_WARNING&lt;br/&gt;        Error = 0x3 : STATUS_SEVERITY_ERROR&lt;br/&gt;    )&lt;br/&gt; &lt;br/&gt;FacilityNames =&lt;br/&gt;    (&lt;br/&gt;        System = 0x0 : FACILITY_SYSTEM&lt;br/&gt;        Runtime = 0x2 : FACILITY_RUNTIME&lt;br/&gt;        Io = 0x3 : FACILITY_IO_ERROR_CODE&lt;br/&gt;    )&lt;br/&gt; &lt;br/&gt;LanguageNames =&lt;br/&gt;    (&lt;br/&gt;        English = 0x409 : MSG00409&lt;br/&gt;    )&lt;br/&gt; &lt;br/&gt; ;// messages definition&lt;br/&gt;MessageId = 0x1&lt;br/&gt;Severity = Success&lt;br/&gt;Facility = System&lt;br/&gt;SymbolicName = SRV_MSG_SYSTEM_SUCCESS&lt;br/&gt;Language = English&lt;br/&gt;Operation %1 success&lt;br/&gt;. &lt;br/&gt;</font></code> </blockquote> <br>  Four levels of message importance are reserved and they should not change, but the object index (FacilityNames) is arbitrary.  Completion of the description - a point in the new line, it is not worth forgetting. <br>  The MessageID must be unique for each described message type (for example, 1, 2, 3, etc.) <br>  This file must be ‚Äúcompiled‚Äù into a resource file; for this, the MSVS package contains mc.exe, which creates .h and .rc files from .mc <br>  The header file generated by the utility must be connected to the project, and the resource file must be collected in the library (or connected to the executable file). <br><br> <code>rc -r messages.rc <br> link -dll -noentry -out:messages.dll messages.res</code> <br> <br>  An interesting feature is that in order to view messages in the correct format, a restart of the Eventlog service is required.  Otherwise, you will see something like this: <br> <code>       ( 1 )   ( MySrvMessages ). ,           DLL      .    /AUXSOURCE=    , -       .      : service starting.</code> <br> <br>  A nice opportunity is that the message log service can also keep its own, and not add it to a common one for all applications.  For this, when registering the message description library, you must specify not the <b>HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ EventLog \ Application</b> branch, but <b>HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ EventLog \ MyService</b> . <br>  But there is an interesting nuance. <br>  After creating a registry branch in MMC, the corresponding folder will appear in the ‚ÄúEvents‚Äù, but in some cases, messages from this branch are not processed correctly even after Eventlog is restarted.  In such ‚Äúhard cases‚Äù, a computer restart is required, which can be problematic for the server.  But, fortunately, it is extremely rare. <br><br>  Well, that's all.  It turned out a lot of text, a lot of code, but this, in my opinion, is the minimum that you need to know.  The rest is easy to learn from the Internet and MSDN. </div><p>Source: <a href="https://habr.com/ru/post/91476/">https://habr.com/ru/post/91476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91471/index.html">We write functional / integration tests for the project on django</a></li>
<li><a href="../91472/index.html">MonoMac - Mono Project for MacOSX</a></li>
<li><a href="../91473/index.html">Installing jira on ubuntu</a></li>
<li><a href="../91474/index.html">Summary on Habr√©</a></li>
<li><a href="../91475/index.html">seedJS - CommonJS Package Manager</a></li>
<li><a href="../91477/index.html">The history of one infrastructure. MS solutions. Part 2</a></li>
<li><a href="../91479/index.html">The history of one infrastructure. MS solutions. Part 3</a></li>
<li><a href="../91482/index.html">New hosting rating system</a></li>
<li><a href="../91483/index.html">Using RHEL, please describe it</a></li>
<li><a href="../91485/index.html">Transparent text when sharing Matrix and AlphaImageLoader filters in IE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>