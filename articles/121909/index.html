<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Versioned database structure migration: another approach</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I read an interesting and useful article ( 1 ) - and wanted to share my own experience. In our company for 12 years of working with one (its own, Orac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Versioned database structure migration: another approach</h1><div class="post__text post__text-html js-mediator-article"> I read an interesting and useful article ( <a href="http://habrahabr.ru/blogs/sql/121265/">1</a> ) - and wanted to share my own experience.  In our company for 12 years of working with one (its own, Oracle-oriented) program, hundreds of clients have accumulated a wealth of material on upgrading the database structure. <br><br>  Initially, we assumed that it was enough to store the version number of the latest upgrade in each database and roll the scripts incrementally, raising the version to the required one.  This technique was successfully used in the previous version of our program, which worked with Paradox DBMS.  But everything went wrong with the Oracle DBMS, each client had its own vision of what its database should be, and version out of sync became an inevitable evil.  The habitual upgrade technique for versions began to constantly lead to errors that no one paid any attention to, and the mismatch of the structures lasted for several years.  As a result, each client had its own, not identical to any other, structure of the database, and the client part of the program somehow had to deal with it. <br><br>  At some point, the management instructed the leading programmer of the company (me) to tackle the problem of upgrades to the database - a creative person who prefers to spend more time but avoid routine work.  And then a tool was developed that allowed virtually eliminating the differences in database structures for all clients.  About this technology I want to tell the world community. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  The basis of the new technology is three algorithms: <br><br>  - Getting the XML image of the real database <br>  - Comparing two XML images and identifying differences <br>  - Forming a script to eliminate differences <br><br>  <b>User interface</b> <br><br>  Visually, the tool looks like a window divided horizontally into three areas: <br>  - in the left panel there is a tree structure of loaded objects (for brevity - ‚Äútree‚Äù); <br>  - in the middle and right panels - a detailed description of the object selected in the tree in the structures being compared (I call these panels ‚Äúcomparison panels‚Äù). <br><br>  One or two structures are loaded into the program - from a real database or from an XML file.  The object tree displays a unified hierarchy, that is, objects that are present in at least one of the two loaded structures.  Identical objects that are different or absent on one side are represented by different icons ‚Äî white, blue or red-white, respectively (red from the side where the object is missing). <br><br>  Above the tree at the touch of a button, the filter panel appears or disappears. <br><br>  At the top of each of the comparison panels, the data source is displayed ‚Äî an Oracle schema or file. <br><br>  Above the comparison panels at the touch of a button, the options panel appears or disappears. <br><br>  The user interface could be different, it doesn‚Äôt matter - and maybe we will redo it in the future - but for now it looks something like what I described. <br><br>  <b>Obtaining an XML image of a real database</b> <br><br>  Connecting to a real database, the program executes a series of SQL queries, obtaining information about Oracle metadata, and the obtained information is collected in the program memory into a hierarchical object structure, where each metadata object is associated with its own hierarchy node. <br><br>  In this case, the user can impose a filter on the types and names of the metadata objects being loaded. <br><br>  In general, structures of several schemes are subject to loading.  The user selects one of three options: <br>  - Abstract scheme <br>  - Specific scheme <br>  - All server schemes <br><br>  If you select the first or second option, you can select several additional schemes on the next panel, and we immediately call the selected scheme the main one. <br><br>  If the third option is selected, the structures of all server schemes are loaded, except for standard ones (created during the Oracle installation and the creation of the database instance) <br><br>  "Abstract schema" means that the name of the main Oracle schema does not matter, so you can compare with each other similar in structure schema with different names.  Practically, this means that the host name of the main schema will not receive the name of the loaded schema, but the abstract name user - you cannot create a schema with that name (and even if someone succeeds, then there is little point in it). <br><br>  "Specific scheme" means that the name of the main scheme has a value, and its structure can only be compared with the structure of the same name scheme. <br><br>  Additional schemas are always compared by name, that is, the nodes of these schemas are named after the original Oracle schemas. <br><br>  The resulting object structure can be saved in an XML file that can be immediately packaged in ZIP format. <br><br>  Accordingly, such a file can be read by the program, and the object model is restored from the saved image. <br><br>  Each new release of our program comes with a standard database in a packed file so that the client‚Äôs server can analyze the differences by comparing the actual structure with the image from the attached file. <br><br>  <b>Comparing two XML images and identifying differences</b> <br><br>  The identification of the compared nodes is based on two criteria - a common parent node and the same name of the node itself.  The node name is also used to sort the child nodes of a single parent node.  Therefore, the naming of nodes of different types of objects is emphasized. <br><br>  At the top level of the hierarchy are the schematic nodes ‚Äî first there are additional schemas sorted by name, then the main schema (remember, this node is called either the schema name or the word user). <br><br>  Child schematic nodes - groups of objects of the same type (tables, views, sequencers, stored procedures, etc.) The names of these nodes correspond to their purpose: tables, views, etc. <br><br>  At the third level are the objects themselves, whose names must be unique within their group. <br><br>  The fourth and further levels are determined by the type of object, and are not displayed in the tree.  These levels correspond to objects or their groups stored and processed in the program memory and displayed on the comparison panels when selecting the corresponding third-level object. <br><br>  For example, a table has a child node columns with its child nodes describing each field of the table, there are nodes triggers, constraints, etc. <br><br>  Each object in the program's memory stores signs of the presence of an object in each of the compared structures and the differences between them.  Composite objects are compared by differences in child nodes, end nodes are compared using individual methods for each type of object. <br><br>  For PL / SQL objects (triggers, procedures, etc.) it is possible to launch an external utility to visually compare text data such as Beyond Compare, WinMerge or any other (it is assumed that this utility accepts the names of the compared files as the first two command line parameters) . <br><br>  But the decision on the identity of these objects is made on the basis of its own comparison algorithm, which ignores differences in comments, delimiters (spaces, tabs, line breaks) or the register of characters (except for string constants). <br><br>  <b>Forming a script to eliminate differences</b> <br><br>  The script can be formed both from left to right and from right to left - both comparison panels are equal for all algorithms. <br><br>  The script can be generated both for the entire loaded structure, and for the object selected in the tree (scheme, group of objects of one type or one object). <br><br>  When forming the script, the same filters are applied as when loading the structure (by type and by name).  For example, you can compare only triggers and procedures, etc.  - even if the download occurred without a filter, since it can be changed after the structures are loaded. <br><br>  The script is built in turn for each scheme in the order of their enumeration - thus, additional schemes are compared before the main one, and all operations on one scheme fall into the final script in one continuous fragment. <br><br>  Within one schema, the script is built by object types ‚Äî first synonyms are processed, then type headers, tables, foreign keys, sequencers, functions, procedures, package headers, views, type bodies, package bodies, triggers, and contexts. <br><br>  Objects of the same type are processed in the order of their names (alphabetically).  Sometimes (quite rarely), this still leads to conflicts that are eliminated by re-applying the synchronization algorithm ‚Äî but in most cases, the specified order of type processing eliminates errors associated with dependencies between objects. <br><br>  The following rules apply when handling differences: <br>  - If there is no object in the target structure, a command is added to the script to create it. <br>  - If there is a difference in the structure of the object, commands for making changes are added to the script. <br>  - If there is no object in the original structure, nothing is done by default, but there is an optional possibility to insert commands to the script to delete the object. <br>  - In the absence of changes in the default structure, nothing is done, but there is an optional possibility to insert commands to re-create the object in the script. <br><br>  <b>Connect to the database server</b> <br><br>  For the analysis of the scheme and for the application of the script, two connection options are possible - on behalf of the main scheme and on behalf of the superuser (sys). And the second is preferable, but if you do not have access (the sys password is unknown), you can work on behalf of the main scheme, but some this case is not available.  The program itself tries both connection options, first trying to connect on behalf of sys. <br><br>  The connection is established every time before downloading the metadata from the server and before executing the finished script, after performing the required operation, an automatic disconnection from the server is performed. <br><br>  <b>Conclusion</b> <br><br>  The described technology may not be perfect - and I will be happy to read the opinion of my colleagues, even if I disagree with them. <br><br>  Nevertheless, the described tool has been working in our company for about three years, and during this time it has helped to analyze and eliminate the differences in most of our clients' schemes. <br><br>  The tool is constantly improving and acquiring new features - now it can export and import data using a filter for data and metadata, make a full backup of the program (client, database and settings files), download and download files from the Oracle Directory, to which there is no direct access through the file system, it also <font color="red">implements the old method of stored scripts by version - we use this method in special cases, these scripts are executed before comparing with the new technology</font> . <br>  <sub>(I highlighted this place in color after I repeated it 3 or 4 times in the comments in response to the questions)</sub> <br><br>  All features of the tool are available through running in command line mode, that is, you can create batch command files that run on a schedule without human intervention. <br><br>  Of course, such things as upgrading the database structure, especially with a large number of differences, it is better to do manually, analyzing each different object in turn.  In addition, before such an operation it is strongly recommended to do a full backup of the database.  But as the described algorithms improve, the value of the user's qualification decreases right before our eyes. <br><br>  I am new to Habr√©, and here it seems that emoticons don't seem to be so I suggest that readers themselves guess in which phrases I allowed myself to joke. <br><br>  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/121909/">https://habr.com/ru/post/121909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121899/index.html">Denial of the Day: Android 2.3 (Gingerbread) will still be released on HTC Desire</a></li>
<li><a href="../121903/index.html">Multiuser chat on BAT</a></li>
<li><a href="../121904/index.html">Odorless filtering and non-linear estimation *</a></li>
<li><a href="../121905/index.html">Add a button for UIKeyboardTypeNumberPad</a></li>
<li><a href="../121906/index.html">Thrustmaster T500 RS: no compromise</a></li>
<li><a href="../121910/index.html">Can e-books replace textbooks</a></li>
<li><a href="../121911/index.html">Again about IE6, fanaticism, end-users and client-oriented web development market</a></li>
<li><a href="../121912/index.html">Mail.Ru Group launches ICQ On-Site</a></li>
<li><a href="../121914/index.html">Samsung Galaxy Tab 8.9: millimeters</a></li>
<li><a href="../121915/index.html">Relaxing text editors for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>