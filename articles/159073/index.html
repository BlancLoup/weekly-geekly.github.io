<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Keccak, a new data hash standard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear readers. 
 Many of you probably know that for several years NIST held a competition among the hash functions to adopt the new SHA-3 sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Keccak, a new data hash standard</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/31a/029/6e4/31a0296e4be265534c32657e0c9c8cbf.jpg" align="left">  Good day, dear readers. <br>  Many of you probably know that for several years NIST held a competition among the hash functions to adopt the new SHA-3 standard.  And this year the award found its hero.  The new standard has been safely accepted. <br>  Well, since the standard has already been adopted, it's time to see what it is like. <br>  And on a quiet Saturday night, <s>overlaid with manuals</s> , I opened my little research in google.com browser. <br><a name="habracut"></a><br><br><h5>  Prelude </h5><br>  The Keccak hash function with variable output lengths of 224,256,384 and 512 bits was chosen as the standard.  At the heart of Keccak is a construction called Sponge (the sponge, the one from the top of the picture). <br>  This design can be represented as follows: <br><img src="https://habrastorage.org/storage2/93f/b59/0d1/93fb590d13ea0b1f5e4aace6c69185c2.png"><br>  As can be seen from the figure, the scheme consists of two stages: <br><ul><li>  Absorbing.  The original message M is subject to multi-round permutations f. </li><li>  Squeezing.  The output of the result of the permutations of the value Z. </li></ul><br>  The attentive reader must have noticed the letters r and c in the figure.  We will not reveal the intrigue ahead of time, say, just by varying the value of these variables, we will get completely different hash functions.  So for SHA-512, as these values ‚Äã‚Äãyou need to choose r = 576, c = 1024. <br><br><h5>  And detail? </h5><br>  So, as I said above, the Keccak algorithm is based on the Sponge design.  This means that in order to get the hash, we need to do the following simple steps: <br><ul><li>  Take the original message M and add it to the length of the multiple r.  Add-on rules captivate with its simplicity.  In the form of a formula, they can be represented as follows: M = M || 0x01 || 0x00 || .. || 0x00 || 0x80.  Or speaking in Russian, a single byte is added to the message, the required number of zeros and the entire ensemble is completed byte with a value of 0x80. <br>  <b>UPD:</b> All of the above is true only for cases when more than one byte is added.  However, if it is necessary to add only one byte, then it suffices to add only 0x81.  The error was revealed thanks to the vigilance of the respected <a href="http://habrahabr.ru/users/overquantum/" class="user_link">OverQuantum</a> .  And even earlier, the habswerter <a href="http://habrahabr.ru/users/fdsc/" class="user_link">fdsc</a> spoke about this, whose post in the sandbox was unnoticed, but now justice has triumphed.  Thus, the code must be rewritten with this remark! </li><li>  Then for each block M <sub>i</sub> with the length r of bits we execute: </li><li>  Addition modulo 2 with the first r-bits of the set of initial states S. Before the function starts, all elements of S will be equal to zero. </li><li>  N times apply to the resulting data function f.  The set of initial states S for block M <sub>i + 1</sub> will be the result of the last round of block M <sub>i</sub> . </li><li>  After all the blocks M <sub>i have</sub> finished, take the final result and return it as a hash value. </li></ul><br><h5>  Anyway, nothing is clear! </h5><br>  Well, now all the ins and outs of the algorithm with <s>bleakchek and whores</s> code and explanations. <br>  But first we tear off the covers from the mystery and tell you why we need the parameters r and c. <br>  To do this, we need to say that the Keccak hash function is implemented in such a way that the user can select the permutation function f applied to each M <sub>i</sub> block from the set of predefined functions b = {f-25, f-50, f-100, f -200, f-400, f-800, f-1600}. <br>  In order for your implementation to use, say, the f-800 function, it is necessary to choose r and c such that the equality r + c = 800 holds. <br>  In addition, by changing the values ‚Äã‚Äãof r and c, you thereby change the number of rounds of your hash function.  Since  the number of these is calculated by the formula n = 12 + 2l, where 2 <sup>l</sup> = (b / 25).  So for b = 1600, the number of rounds is 24. <br>  However, although the user has the right to choose for his implementation any of the functions proposed by the authors, it should be noted that only the Keccak-1600 function is accepted as the SHA-3 standard and the authors strongly recommend using it only.  So, the authors chose the following parameters as basic values ‚Äã‚Äãfor hashes of different lengths: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      SHA-224: r = 1156, c = 448 (return the first 28 bytes of the result) <br>  SHA-256: r = 1088, c = 512 (return the first 32 bytes of the result) <br>  SHA-384: r = 832, c = 768 (return the first 48 bytes of the result) <br>  SHA-512: r = 576, c = 1024 (return the first 64 bytes of the result) <br><br><h5>  And where is the code? </h5><br>  And after all these clarifications, you can go directly to the pseudocode of the algorithm. <br>  The absorbing stage can be represented as the following function: <br><pre><code class="cs hljs">Keccak-f[b](A) { forall i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>‚Ä¶nr<span class="hljs-number"><span class="hljs-number">-1</span></span> A = Round[b](A, RC[i]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> A }</code> </pre> <br>  Here b is the value of the selected function (default 1600).  And the function Round () is a pseudo-random permutation applied at each round.  The number of rounds nr is calculated from the values ‚Äã‚Äãof r and c. <br><br>  The operations performed on each round are the following function: <br><pre> <code class="cs hljs">Round[b](A,RC) { Œ∏ <span class="hljs-function"><span class="hljs-function">step </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x++</span></span></span><span class="hljs-function">) C[x]</span></span> = A[x,<span class="hljs-number"><span class="hljs-number">0</span></span>] xor A[x,<span class="hljs-number"><span class="hljs-number">1</span></span>] xor A[x,<span class="hljs-number"><span class="hljs-number">2</span></span>] xor A[x,<span class="hljs-number"><span class="hljs-number">3</span></span>] xor A[x,<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x=<span class="hljs-number"><span class="hljs-number">0</span></span>; x&lt;<span class="hljs-number"><span class="hljs-number">5</span></span>; x++) D[x] = C[x<span class="hljs-number"><span class="hljs-number">-1</span></span>] <span class="hljs-function"><span class="hljs-function">xor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">C[x+</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">],</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x=<span class="hljs-number"><span class="hljs-number">0</span></span>; x&lt;<span class="hljs-number"><span class="hljs-number">5</span></span>; x++) A[x,y] = A[x,y] xor D[x]; œÅ and œÄ <span class="hljs-function"><span class="hljs-function">steps </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x++</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y++</span></span></span><span class="hljs-function">) B[y,2*x+3*y]</span></span> = rot(A[x,y], r[x,y]); œá <span class="hljs-function"><span class="hljs-function">step </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x++</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y++</span></span></span><span class="hljs-function">) A[x,y]</span></span> = B[x,y] xor ((not B[x+<span class="hljs-number"><span class="hljs-number">1</span></span>,y]) and B[x+<span class="hljs-number"><span class="hljs-number">2</span></span>,y]); Œπ step A[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>] = A[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>] xor RC <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> A }</code> </pre><br>  It consists of 4 steps on each of which a series of logical operations are performed on the input data. <br>  Here the function rot (X, n) denotes the cyclic shift of an element X by n positions. <br>  The r [] array is a predefined set of values ‚Äã‚Äãthat indicates how many bytes need to be shifted at each round.  The value of all elements of this array is shown in the table below: <br><img src="http://habrastorage.org/storage2/2cd/842/2b9/2cd8422b977654c0c8065be61d8c9896.jpg"><br>  The RC array is a set of constants that are also predefined: <br><img src="http://habrastorage.org/storage2/fe3/832/e23/fe3832e2320bbeaf5e329ea0407953b5.jpg"><br><br>  The Keccak function itself is the following: <br><pre> <code class="cs hljs">Keccak[r,c](M) { <span class="hljs-function"><span class="hljs-function">Initialization and padding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; x++</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y&lt;</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">; y++</span></span></span><span class="hljs-function">) S[x,y]</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; P = M || <span class="hljs-number"><span class="hljs-number">0x01</span></span> || <span class="hljs-number"><span class="hljs-number">0x00</span></span> || ‚Ä¶ || <span class="hljs-number"><span class="hljs-number">0x00</span></span>; P = <span class="hljs-function"><span class="hljs-function">P </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xor</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x00</span></span></span></span><span class="hljs-function"><span class="hljs-params"> || ‚Ä¶ || </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x00</span></span></span></span><span class="hljs-function"><span class="hljs-params"> || </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x80</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//Absorbing phase forall block Pi in P for(int x=0; x&lt;5; x++) for(int y=0; y&lt;5; y++) S[x,y] = S[x,y] xor Pi[x+5*y]; S = Keccak-f[r+c](S); //Squeezing phase Z = empty string; do { for(int x=0; x&lt;5; x++) for(int y=0; y&lt;5; y++) if((x+5y)&lt;r/w) Z = Z || S[x,y]; S = Keccak-f[r+c](S) } while output is requested return Z; }</span></span></code> </pre><br>  At the Absorbig stage, the hash value is calculated. <br>  And at the Squeezing stage, displaying the results until the required hash length is reached. <br><br><div class="spoiler">  <b class="spoiler_title">Under the spoiler is a small class written in C # that implements all these actions.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Keccack</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,   24 //   Œπ private ulong[] RC ={0x0000000000000001, 0x0000000000008082, 0x800000000000808A, 0x8000000080008000, 0x000000000000808B, 0x0000000080000001, 0x8000000080008081, 0x8000000000008009, 0x000000000000008A, 0x0000000000000088, 0x0000000080008009, 0x000000008000000A, 0x000000008000808B, 0x800000000000008B, 0x8000000000008089, 0x8000000000008003, 0x8000000000008002, 0x8000000000000080, 0x000000000000800A, 0x800000008000000A, 0x8000000080008081, 0x8000000000008080, 0x0000000080000001, 0x8000000080008008}; // ,       Œ∏ private int[,] r = {{0, 36, 3, 41, 18} , {1, 44, 10, 45, 2} , {62, 6, 43, 15, 61} , {28, 55, 25, 21, 56} , {27, 20, 39, 8, 14} }; private int w, l, n; //     b=1600 public Keccack(int b) { w = b / 25; l = (Convert.ToInt32(Math.Log(w, 2))); n = 12 + 2 * l; } //   x  n  private ulong rot(ulong x, int n) { n = n % w; return (((x &lt;&lt; n) | (x &gt;&gt; (w - n)))); } private ulong[,] roundB(ulong[,] A, ulong RC) { ulong[] C = new ulong[5]; ulong[] D = new ulong[5]; ulong[,] B = new ulong[5, 5]; // Œ∏ for (int i = 0; i &lt; 5; i++) C[i] = A[i, 0] ^ A[i, 1] ^ A[i, 2] ^ A[i, 3] ^ A[i, 4]; for (int i = 0; i &lt; 5; i++) D[i] = C[(i + 4) % 5] ^ rot(C[(i + 1) % 5], 1); for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) A[i, j] = A[i, j] ^ D[i]; // œÅ  œÄ for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) B[j, (2 * i + 3 * j) % 5] = rot(A[i, j], r[i, j]); // œá for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) A[i, j] = B[i, j] ^ ((~B[(i + 1) % 5, j]) &amp; B[(i + 2) % 5, j]); // Œπ A[0, 0] = A[0, 0] ^ RC; return A; } private ulong[,] Keccackf(ulong[,] A) { for (int i = 0; i &lt; n; i++) A = roundB(A, RC[i]); return A; } //  16-    r-      64-  private ulong[][] padding(string M, int r) { int size = 0; //     r M = M + "01"; while (((M.Length / 2) * 8 % r) != ((r - 8))) { M = M + "00"; } ; M = M + "80"; //     b-   size = (((M.Length / 2) * 8) / r); //   64-  ulong[][] arrayM = new ulong[size][]; arrayM[0] = new ulong[1600 / w]; string temp = ""; int count = 0; int j = 0; int i = 0; //     64-  foreach (char ch in M) { if (j &gt; (r/w-1)) { j = 0; i++; arrayM[i] = new ulong[1600 / w]; } count++; if ((count * 4 % w) == 0) { arrayM[i][j] = Convert.ToUInt64(M.Substring((count - w / 4), w / 4), 16); temp = ToReverseHexString(arrayM[i][j]); arrayM[i][j] = Convert.ToUInt64(temp, 16); j++; } } return arrayM; } private string ToReverseHexString(ulong S) { string temp = BitConverter.ToString(BitConverter.GetBytes(S).ToArray()).Replace("-", ""); return temp; } private string ToHexString(ulong S) { string temp = BitConverter.ToString(BitConverter.GetBytes(S).Reverse().ToArray()).Replace("-", ""); return temp; } // public string GetHash(string M, int r, int c, int d) { //    S=0 ulong[,] S = new ulong[5, 5]; for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) S[i, j] = 0; ulong[][] P = padding(M, r); // P     Pi, //        64-  foreach (ulong[] Pi in P) { for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) if((i + j * 5)&lt;(r/w)) S[i, j] = S[i, j] ^ Pi[i + j * 5]; Keccackf(S); } string Z = ""; //    ,      do { for (int i = 0; i &lt; 5; i++) for (int j = 0; j &lt; 5; j++) if ((5*i + j) &lt; (r / w)) Z = Z + ToReverseHexString(S[j, i]); Keccackf(S); } while (Z.Length &lt; d*2); return Z.Substring(0, d * 2); } }</span></span></code> </pre><br></div></div><br>  <a href="http://ge.tt/api/1/files/4jP5epR/0/blob%3Fdownload">You can download the source from here.</a> <br><br>  PS All materials and illustrations for this article were found on the <a href="http://keccak.noekeon.org/">official website of the Keccak hash function.</a> <br><br>  UPD: <a href="http://habrahabr.ru/users/fshp/" class="user_link">fshp</a> kindly shared a link to the <a href="https://www.pgpru.com/biblioteka/statji/keccaksponge">Russian-language description of the</a> main features of the new standard. <br><br>  UPD2: after publishing the articles the reader with the nickname Admiral addressed me in the mail.  He proposed more optimized code that does not use work with strings. <br><div class="spoiler">  <b class="spoiler_title">Admiral reader implementation</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*const */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Byte InstanceNumber = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*const */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UInt16[] b_array = { <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-number"><span class="hljs-number">800</span></span>, <span class="hljs-number"><span class="hljs-number">1600</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//permutation_width /*const */ static private Byte matrixSize = 5 * 5; /*const */ static private Byte[] w_array = { 1, 2, 4, 8, 16, 32, 64 }; //b / 25; /*const */ static private Byte[] l_array = { 0, 1, 2, 3, 4, 5, 6 }; //log(static_cast&lt;float&gt;(m_w)) / log(2.0F) /*const */ static private Byte[] n_array = { 12, 14, 16, 18, 20, 22, 24 }; //12 + 2 * l -&gt; number_of_permutation /*const */ static private Byte[,] r = { {0, 36, 3, 41, 18}, {1, 44, 10, 45, 2}, {62, 6, 43, 15, 61}, {28, 55, 25, 21, 56}, {27, 20, 39, 8, 14} }; /*const */ static private UInt64[] RC = {//24 by w_array[KeccakInstanceCount - 1] (for 1600), for less please use less in w_array 0x0000000000000001, 0x0000000000008082, 0x800000000000808A, 0x8000000080008000, 0x000000000000808B, 0x0000000080000001, 0x8000000080008081, 0x8000000000008009, 0x000000000000008A, 0x0000000000000088, 0x0000000080008009, 0x000000008000000A, 0x000000008000808B, 0x800000000000008B, 0x8000000000008089, 0x8000000000008003, 0x8000000000008002, 0x8000000000000080, 0x000000000000800A, 0x800000008000000A, 0x8000000080008081, 0x8000000000008080, 0x0000000080000001, 0x8000000080008008 }; static private UInt64[,] B = new UInt64[5, 5]; static private UInt64[] C = new UInt64[5]; static private UInt64[] D = new UInt64[5]; /*const*/ static public UInt16[] rate_array = { 576, 832, 1024, 1088, 1152, 1216, 1280, 1344, 1408 }; /*const*/ static public UInt16[] capacity_array = { 1024, 768, 576, 512, 448, 384, 320, 256, 192 }; public enum SHA3 { SHA512 = 0, SHA384, SHA256 = 3, SHA224 }; static private UInt64[,] Keccak_f(UInt64[,] A) { for(Byte i = 0; i &lt; n_array[InstanceNumber]; i++) A = Round(A, RC[i]); return A; } static private UInt64[,] Round(UInt64[,] A, UInt64 RC_i) { Byte i, j; //theta step for (i = 0; i &lt; 5; i++) C[i] = A[i,0] ^ A[i,1] ^ A[i,2] ^ A[i,3] ^ A[i,4]; for (i = 0; i &lt; 5; i++) D[i] = C[(i + 4) % 5] ^ ROT(C[(i + 1) % 5], 1, w_array[InstanceNumber]); for (i = 0; i &lt; 5; i++) for (j = 0; j &lt; 5; j++) A[i,j] = A[i,j] ^ D[i]; //rho and pi steps for (i = 0; i &lt; 5; i++) for (j = 0; j &lt; 5; j++) B[j,(2 * i + 3 * j) % 5] = ROT(A[i,j], r[i,j], w_array[InstanceNumber]); //chi step for (i = 0; i &lt; 5; i++) for (j = 0; j &lt; 5; j++) A[i,j] = B[i,j] ^ ((~B[(i + 1) % 5,j]) &amp; B[(i + 2) % 5,j]); //iota step A[0,0] = A[0,0] ^ RC_i; return A; } static private UInt64 ROT(UInt64 x, Byte n, Byte w) { return ((x &lt;&lt; (n % w)) | (x &gt;&gt; (w - (n % w)))); } static private Byte[] Keccak(UInt16 rate, UInt16 capacity, List&lt;Byte&gt; Message) { //Padding Message.Add(0x01); UInt16 min = (UInt16)((rate - 8) / 8); UInt16 n = (UInt16)Math.Truncate((Double)(Message.Count / min)); UInt32 messageFullCount = 0; if (n &lt; 2) { messageFullCount = min; } else { messageFullCount = (UInt32)(n * min + (n - 1)); } UInt32 delta = (UInt32)(messageFullCount - Message.Count); if ((Message.Count + delta) &gt; UInt16.MaxValue - 1) throw (new Exception("Message might be too large")); /*Byte[] byteArrayToAdd = new Byte[delta]; Message.AddRange(byteArrayToAdd);*/ while (delta &gt; 0) { Message.Add(0x00); delta--; } if ((Message.Count * 8 % rate) != (rate - 8)) throw (new Exception("Length was incorect calculated")); Message.Add(0x80); /*const*/ Int32 size = (Message.Count * 8) / rate; UInt64[] P = new UInt64[size * matrixSize]; Int32 xF = 0, count = 0; Byte i = 0, j = 0; for(xF = 0; xF &lt; Message.Count; xF++) { if (j &gt; (rate / w_array[InstanceNumber] - 1)) { j = 0; i++; } count++; if ((count * 8 % w_array[InstanceNumber]) == 0) { P[size * i + j] = ReverseEightBytesAndToUInt64( Message.GetRange(count - w_array[InstanceNumber] / 8, 8).ToArray() ); j++; } } //Initialization UInt64 [,]S = new UInt64[5,5]; for(i = 0; i &lt; 5; i++) for(j = 0; j &lt; 5; j++) S[i,j] = 0; //Absorting phase for(xF = 0; xF &lt; size; xF++) { for(i = 0; i &lt; 5; i++) for(j = 0; j &lt; 5; j++) if ((i + j * 5) &lt; (rate / w_array[InstanceNumber])) { S[i, j] = S[i, j] ^ P[size * xF + i + j * 5]; } Keccak_f(S); } //Squeezing phaze Byte a = 0; Byte d_max = (Byte)(capacity / (2 * 8)); List&lt;Byte&gt; retHash = new List&lt;Byte&gt;(d_max); for( ; ; ) { for(i = 0; i &lt; 5; i++) for(j = 0; j &lt; 5; j++) if((5 * i + j) &lt; (rate / w_array[InstanceNumber])) { if(a &gt;= d_max) i = j = 5; else { retHash.AddRange(FromUInt64ToReverseEightBytes(S[j, i])); a = (Byte)retHash.Count; } } if(a &gt;= d_max) break; Keccak_f(S); } return retHash.GetRange(0, d_max).ToArray(); } static private UInt64 ReverseEightBytesAndToUInt64(Byte[] bVal) { UInt64 ulVal = 0L; for (Byte i = 8, j = 0; i &gt; 0; i--) { ulVal += (UInt64)((bVal[i - 1] &amp; 0xF0) &gt;&gt; 4) * (UInt64)Math.Pow(16.0F, 15 - (j++)); ulVal += (UInt64)(bVal[i - 1] &amp; 0x0F) * (UInt64)Math.Pow(16.0F, 15 - (j++)); } return ulVal; } static private Byte[] FromUInt64ToReverseEightBytes(UInt64 ulVal) { Byte[] bVal = new Byte[8]; Byte a = 0; do { bVal[a] = (Byte)((ulVal % 16) * 1); ulVal = ulVal / 16; bVal[a] += (Byte)((ulVal % 16) * 16); a++; } while (15 &lt; (ulVal = ulVal / 16)); while (a &lt; 8) { bVal[a++] = (Byte)ulVal; ulVal = 0; } return bVal; } static void Main(String[] args) { if (args.Length &lt; 1) return; List&lt;Byte&gt; MessageB; String message = string.Copy(args[0]); MessageB = strToByteList(message); String hash_224 = ByteArrayToString(Keccak(rate_array[(Byte)SHA3.SHA224], capacity_array[(Byte)SHA3.SHA224], MessageB)); MessageB = strToByteList(message); String hash_256 = ByteArrayToString(Keccak(rate_array[(Byte)SHA3.SHA256], capacity_array[(Byte)SHA3.SHA256], MessageB)); MessageB = strToByteList(message); String hash_384 = ByteArrayToString(Keccak(rate_array[(Byte)SHA3.SHA384], capacity_array[(Byte)SHA3.SHA384], MessageB)); MessageB = strToByteList(message); String hash_512 = ByteArrayToString(Keccak(rate_array[(Byte)SHA3.SHA512], capacity_array[(Byte)SHA3.SHA512], MessageB)); Console.WriteLine("Message: " + message + "\r\n" + "Hash_224: " + hash_224 + "\r\n" + "Hash_256: " + hash_256 + "\r\n" + "Hash_384: " + hash_384 + "\r\n" + "Hash_512: " + hash_512 + "\r\n"); } static List&lt;Byte&gt; strToByteList(String str) { List&lt;Byte&gt; ret = new List&lt;byte&gt;(str.Length); foreach(char ch in str) { ret.Add((Byte)ch); } return ret; } static public String ByteArrayToString(Byte[] b) { System.Text.StringBuilder sb = new System.Text.StringBuilder(16); for (Int32 i = 0; i &lt; Math.Min(b.Length, Int32.MaxValue - 1); i++) sb.Append(String.Format("{0:X2}", b[i])); return sb.ToString(); } }</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/159073/">https://habr.com/ru/post/159073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159053/index.html">And again about Stuxnet</a></li>
<li><a href="../159055/index.html">What do you know about Sality?</a></li>
<li><a href="../159057/index.html">Layout like Metro UI</a></li>
<li><a href="../159059/index.html">Wave closings provider DC ++</a></li>
<li><a href="../159071/index.html">JavaScript SIP library from the authors of the standard</a></li>
<li><a href="../159075/index.html">Ingress - Answers to questions and some secrets</a></li>
<li><a href="../159077/index.html">FreeBSD.org is compromised</a></li>
<li><a href="../159079/index.html">Tagging cache in Yii</a></li>
<li><a href="../159083/index.html">MSP430 + LCD from ‚ÄúMinik 1101F‚Äù</a></li>
<li><a href="../159085/index.html">MySQL Tuning - thread_cache_size</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>