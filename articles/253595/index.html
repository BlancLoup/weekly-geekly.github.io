<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DOM L3 XPath support in Project Spartan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note from the translator: I am a server-side Java programmer, but at the same time it has historically developed that I work exclusively under Windows...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DOM L3 XPath support in Project Spartan</h1><div class="post__text post__text-html js-mediator-article">  Note from the translator: <i>I am a server-side Java programmer, but at the same time it has historically developed that I work exclusively under Windows.</i>  <i>In the team, everyone sits mostly on a Mac or Linux, but someone has to live test web-interfaces of projects under a real IE, not for me?</i>  <i>So I have been using it for quite a few years both for work and, due to laziness, as the main browser.</i>  <i>In my opinion, with each new version, starting with the ninth, it becomes more and more worthy, and Project Spartan promises to be excellent at all.</i>  <i>At least in terms of technology - on an equal footing with others.</i>  <i>I bring to your attention the translation of an article from the blog of developers, which gives some grounds for this hope.</i> <br><img src="https://habrastorage.org/files/af6/8f7/86d/af68f786d01c4a16838db206e7d9d588.gif" alt="image"><br><br><h2>  Providing compatibility with DOM L3 XPath </h2><br>  Having set ourselves the task of providing a truly compatible and modern web platform in Windows 10, we are constantly working to improve standards support, in particular with respect to the <a href="http://www.w3.org/TR/DOM-Level-3-XPath/Overview.html">DOM L3 XPath</a> .  Today we would like to tell you how we achieved this in Project Spartan. <br><a name="habracut"></a><br><h3>  A bit of history </h3><br>  Before implementing support for the DOM L3 Core standard and native XML documents in IE9, we provided web developers with the <a href="https://msdn.microsoft.com/en-us/library/ms763742(v%3Dvs.85).aspx">MSXML</a> library through an ActiveX mechanism.  In addition to the XMLHttpRequest object, MSXML also provided partial support for the XPath query language through a set of proprietary APIs, selectSingleNode and selectNodes.  From the point of view of applications using MSXML, this method simply worked.  However, it did not at all comply with the W3C standards for either interacting with XML or working with XPath. <br><br>  Library authors and website developers had to wrap up XPath calls to switch between implementations on the fly.  If you search online tutorials or examples on XPath, you will immediately notice wrappers for IE and MSXML, for example, <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// code for IE if (window.ActiveXObject || xhttp.responseType == "msxml-document") { xml.setProperty("SelectionLanguage", "XPath"); nodes = xml.selectNodes(path); for (i = 0; i &lt; nodes.length; i++) { document.write(nodes[i].childNodes[0].nodeValue); document.write("&lt;br&gt;"); } } // code for Chrome, Firefox, Opera, etc. else if (document.implementation &amp;&amp; document.implementation.createDocument) { var nodes = xml.evaluate(path, xml, null, XPathResult.ANY_TYPE, null); var result = nodes.iterateNext(); while (result) { document.write(result.childNodes[0].nodeValue); document.write("&lt;br&gt;"); result = nodes.iterateNext(); } }</span></span></code> </pre> <br>  For our new web-based engine without plug-ins, we needed to provide native support for XPath. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Evaluation of possible options </h3><br>  We immediately began to evaluate the options available for the realization of such support.  You could write it from scratch, or integrate it completely into MSXML browser, or port <a href="https://msdn.microsoft.com/en-us/library/system.xml.xpath(v%3Dvs.110).aspx">System.XML</a> from .NET, but all this would take too much time.  Therefore, we decided to start implementing the support of some main XPath subset, while thinking about the full one. <br><br>  To determine which initial subset of the standard is worth taking, we used an internal tool that collects statistics on requests from hundreds of thousands of the most popular sites.  It turned out that the most common requests of these types: <br><ul><li>  // element1 / element2 / element3 </li><li>  // element [@ attribute = "value"] </li><li>  .//* [contains (concat ("", @ class, ""), "classname")] </li></ul><br>  Each of them perfectly corresponds to a certain CSS selector that can be redirected to the very fast implementation of the CSS selectors API that we already have.  Compare yourself: <br><ul><li>  element1&gt; element2&gt; element3 </li><li>  element [attribute = "value"] </li><li>  * .classname </li></ul><br>  Thus, the first step in implementing XPath support was to write a converter from XPath requests to CSS selectors, and redirect the call to the right place.  Having done this, we again used our telemetry to measure the percentage of successful requests, and also to find out which of the unsuccessful ones are the most common. <br><br>  It turned out that such an implementation covers as much as 94% of requests, and allows you to immediately make a lot of sites.  Of the unsuccessful majority turned out to be <br><ul><li>  // element [contains (@ class, "className")] </li><li>  // element [contains (concat ("", normalize-space (@ class), ""), "className")] </li></ul>  and both are perfectly rewritten into the "element.className" selector.  By adding such a rule, we have improved support for up to 97% of sites, which means that the new engine is practically ready for the modern web. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7bf/ebb/9b1/7bfebb9b104864110829c9b715ffdec9.png"><br>  <i>The result of a telemetry run for XPath queries</i> <br><br><h3>  Providing support for the remaining 3% of sites </h3><br>  Maintaining the vast majority of XPath queries by simply converting to CSS selectors is great, but still not enough, because implementing the rest in a similar way will not work.  The XPath grammar includes such advanced things as functions, queries for non-DOM elements, document nodes, and complex predicates.  Some authoritative sites (including <a href="https://developer.mozilla.org/en-US/docs/Web/XPath">MDN</a> ) suggest that in such cases, platforms that do not have adequate native XPath support should use polyfill libraries. <br><br>  For example, <a href="http://code.google.com/p/wicked-good-xpath/">wicked-good-xpath</a> (WGX), which is written in pure JS.  We tested it on our internal test suite for the XPath specification, and compared to native implementations, it showed 91% compatibility, as well as very decent performance.  So the idea of ‚Äã‚Äãusing WGX for the remaining 3% of sites seemed very attractive to us.  Moreover, this is a project with source code opened under the MIT license, which is wonderfully combined with our intention to make an ever greater contribution to the open source business.  But we, however, have never used JavaScript polyfill inside IE to support any web standard. <br><br>  To enable WGX to work, and not to spoil the context of the document, we launch it in a separate, isolated JS engine instance, passing the request and necessary data from the page to the input, and take the finished result from the output.  By modifying the WGX code to work in such a mode ‚Äúcut off‚Äù from the document, we immediately improved the display of the content of many sites in our new browser. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/370/580/922/3705809221a6bb3f6c863f438e558aa1.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/3ff/a6d/692/3ffa6d6928ce4bffa29d3f0612796723.png" alt="image"><br>  <i>Sites before using WGX</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de0/7b2/317/de07b23171be0debf781d6530e4269ce.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/fbc/47d/b20/fbc47db20ceb01ee8b131a11d2bec86b.png" alt="image"><br>  <i>And this after.</i>  <i>Pay attention to the appeared prices and numbers of winning tickets.</i> <br><br>  However, in WGX there were also bugs, because of which it behaves differently from the W3C specification and from other browsers.  We plan to fix them all first, and then share the patches with the community. <br><br>  Thus, as a result of some data mining on the Web, and with the help of an open source library, our new engine in a short time gained productive support for XPath, and users will soon get better support for web standards.  You can download the latest <a href="http://insider.windows.com/">Windows 10 Technical Preview</a> , and see for yourself.  You can also write via <a href="https://wpdev.uservoice.com/forums/257854-internet-explorer-platform">UserVoice</a> how well we did it, or <a href="https://twitter.com/iedevchat">tweet</a> us, or <a href="http://blogs.msdn.com/b/ie/archive/2015/03/19/improving-interoperability-with-dom-l3-xpath.aspx">comment on the original article</a> . <br><br>  PS from translator: the <i>tendency of turning JavaScript into a language in which the platforms are written, as they say, is evident.</i>  <i>Get Firefox Shumway, or PDF.js.</i>  <i>Now, Microsoft also translates its browser, at least partially, to JS.</i> </div><p>Source: <a href="https://habr.com/ru/post/253595/">https://habr.com/ru/post/253595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253583/index.html">Web Components and JSON-LD to help the web developer</a></li>
<li><a href="../253585/index.html">Making web forms easier to fill out</a></li>
<li><a href="../253587/index.html">Backend and Golden Hammers</a></li>
<li><a href="../253589/index.html">MSBuild - in Open Source on github</a></li>
<li><a href="../253591/index.html">MSBuild - in Open Source on github</a></li>
<li><a href="../253597/index.html">Rivulet - audio player for torrents</a></li>
<li><a href="../253599/index.html">RuSSIR 2015: deadline for submission of articles is approaching</a></li>
<li><a href="../253601/index.html">Samsung's MagicIWB Interactive Demonstration for Business and Education</a></li>
<li><a href="../253605/index.html">Upcoming Microsoft Azure Events - Scott Guthrie Online and Moscow Community Meeting for ITPro</a></li>
<li><a href="../253607/index.html">"Soft + boxed server" or a complete solution?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>