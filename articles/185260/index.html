<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of work with faxes in asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a need to configure the reception and sending of faxes on asterisk. According to the technical task, receiving and sending faxes should take ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of work with faxes in asterisk</h1><div class="post__text post__text-html js-mediator-article">  There is a need to configure the reception and sending of faxes on asterisk.  According to the technical task, receiving and sending faxes should take place with the participation of operators and the possibility of a preliminary conversation. <br>  I found examples of implementation on the Internet, but in them, as a rule <br>  1) there was an automatic sending of faxes to a specific number without first talking to the operator; <br>  2) different bundles of iaxmodem or t38modem + hylafax were used, in which, in my opinion, there is no special need in this case.  Asterisk can work with faxes via SpanDSP (must be compiled with SpanDSP support). <br><br>  In the end, it all came down to the following: <br>  1) any operator of the company must have the functionality to receive and send faxes from his workplace, using a PC and telephone; <br>  2) to receive a fax, you need to transfer the call to the number 5555. The system should convert the received document from tiff to pdf, put it in the FAX common folder and duplicate it to the secretary's mailbox. <br>  3) when sending a fax, it should be possible to send any electronic document or document on paper (through a scanner).  The operator must first be able to tell who and what the document transmits, then, just as at admission, transfer to a specific number corresponding to this document. <br><a name="habracut"></a><br>  Asterisk is installed on a gentoo assembly. <br><br>  To avoid user involvement in translating a document in tiff format, it was decided to use the cups-pdf network virtual printer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Install: <br><br><pre><code class="bash hljs">emerge -va cups-pdf</code> </pre> <br><br>  To put the printer and folder for received faxes into the network use the samba package. <br><br><pre> <code class="bash hljs">emerge -va samba</code> </pre><br><br>  I have it already installed net-fs / samba-3.6.12 <br><br>  The cups package is also required, and the samba itself must be built with the support of this package.  Let's install our virtual printer via cups web interface, let's call it fax. <br><br>  We share the printer by adding the following lines to /etc/samba/smb.conf <br><br><pre> <code class="bash hljs">[global] printing = cups printcap name = /etc/printcap [fax] comment =  public = yes printable = yes writable = yes create mode = 0666</code> </pre><br><br>  Windows 7 is installed on the operator computers. The network printer is installed, as usual, it will only ask for the driver, I chose the HP LaserJet 2300 Series PS (any PostScript driver should fit) <br><br>  When printing to this printer, the document itself must go to the printer in a suitable format, and the user must receive a four-digit number during the transfer, to which the transfer of this document will occur. <br><br>  First, let's look at the settings of this virtual printer nano /etc/cups/cups-pdf.conf <br>  And change the following settings: <br><br><pre> <code class="bash hljs">Out /var/spool/cups-pdf <span class="hljs-comment"><span class="hljs-comment">#     AnonDirName /var/spool/cups-pdf Spool /var/spool/cups-pdf TitlePref 1 #      UserUMask 0000 #     PostProcessing /opt/pdf_to_tiff #     pdf  DecodeHexStrings 1 #     </span></span></code> </pre><br><br>  The / opt / pdf_to_tiff script reads the current value of ext_num (four-digit fax number) adds one and transfers the pdf file to the / usr / dumps folder as ext_num. <br>  Next, it converts the file to the tiff format and sends it to the user who sent the document with a four-digit number to the post office. <br><br>  Cups-pdf will run / opt / pdf_to_tiff with two parameters: <br>  file name is $ ARGV [0] <br>  username is $ ARGV [1] <br>  In an organization, the domain (samba-3.6) and mailboxes (corporate mail on postfix) correspond to user names (here and there we had to add a couple of mail aliases). <br><br>  The script itself: <br><br><pre> <code class="bash hljs">srv d <span class="hljs-comment"><span class="hljs-comment"># cat /opt/pdf_to_tiff</span></span></code> </pre><br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -w use strict; use File::Copy; #     $ENV{PATH} = '/bin:/usr/bin:/sbin:/usr/sbin'; #  my $debug=0; #     chdir '/'; my $ext=" "; my $num=0; open(ext_num,"/opt/ext_num"); $ext=&lt;ext_num&gt;; $num=int($ext); close(ext_num); if ($num &gt; 499) { $num=1; } else { $num=$num+1; } open(ext_num,"&gt;/opt/ext_num"); print ext_num "$num\n"; close(ext_num); $num=$num+5000; move("$ARGV[0]","/usr/dumps/$num.pdf"); system("/usr/bin/gs -dSAFER -dBATCH -dQUIET -sDEVICE=tiffg3 -sPAPERSIZE=a4 -r204x196 -dNOPAUSE -sOutputFile=/usr/dumps/$num.tiff /usr/dumps/$num.pdf"); chmod(0644,"/usr/dumps/$num.tiff"); system("/usr/bin/sendEmail -f asterisk_fax\@name.ru -t $ARGV[1]\@name.ru -u FAX -o message-charset=utf-8 -m     :$num -s localhost");</span></span></code> </pre><br><br>  We check the work by sending a document to print (you may have to create and correct the rights to access the / usr / dumps / folder) <br><br>  Next, configure Asterisk to receive and send faxes: <br><br>  The main thing is to disable faxdetect: <br><br><pre> <code class="bash hljs">/etc/asterisk/sip.conf</code> </pre><br><br><pre> <code class="bash hljs">[general] faxdetect=no ;faxdetect=yes t38pt_udptl=no ;t38pt_udptl=yes</code> </pre><br><br><pre> <code class="bash hljs">/etc/asterisk/extensions.conf</code> </pre><br><br><pre> <code class="bash hljs">[internal] exten =&gt; 5555,1,NoOp(-------------------Call from <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> to <span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>------------------) same =&gt; n,Goto(fax-rx,receive,1) exten =&gt; _5[0-4]XX,1,NoOp(-------------------Call from <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> to <span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>------------------) same =&gt; n,Set(FAXFILENAME=<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>) same =&gt; n,Goto(fax-tx,send,1) [fax-rx] exten =&gt; receive,1,NoOP(------------------- FAX from <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> ------------------) same =&gt; n,Answer() same =&gt; n,Set(DT=<span class="hljs-variable"><span class="hljs-variable">${TIMESTAMP}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${CALLERIDNUM}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${UNIQUEID}</span></span>) same =&gt; n,Set(FAXOPT(headerinfo)=Received by <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> <span class="hljs-variable"><span class="hljs-variable">${STRFTIME(${EPOCH}</span></span>,,%Y-%m-%d %H-%M)}) same =&gt; n,Set(FAXOPT(localstationid)=Name) same =&gt; n,Set(FAXOPT(maxrate)=14400) same =&gt; n,Set(FAXOPT(minrate)=2400) same =&gt; n,NoOp(FAXOPT(ecm) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(ecm)}</span></span>) same =&gt; n,NoOp(FAXOPT(headerinfo) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span>) same =&gt; n,NoOp(FAXOPT(localstationid) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(localstationid)}</span></span>) same =&gt; n,NoOp(FAXOPT(maxrate) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(maxrate)}</span></span>) same =&gt; n,NoOp(FAXOPT(minrate) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(minrate)}</span></span>) same =&gt; n,NoOp(**** RECEIVING FAX : <span class="hljs-variable"><span class="hljs-variable">${DT}</span></span> ****) same =&gt; n,ReceiveFax(/var/spool/asterisk/fax/<span class="hljs-variable"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span>.tif) same =&gt; n,System(/usr/bin/tiff2pdf <span class="hljs-string"><span class="hljs-string">"/var/spool/asterisk/fax/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span></span><span class="hljs-string">.tif"</span></span> -o <span class="hljs-string"><span class="hljs-string">"/var/spool/asterisk/fax/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span></span><span class="hljs-string">.pdf"</span></span>) same =&gt; n,System(/bin/cp <span class="hljs-string"><span class="hljs-string">"/var/spool/asterisk/fax/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span></span><span class="hljs-string">.pdf"</span></span> /mnt/public/samba/public/FAX ) same =&gt; n,System(/usr/bin/sendEmail -f asterisk_fax@name.ru -t office@name.ru -u FAX -o message-charset=utf-8 -m   -s localhost -a <span class="hljs-string"><span class="hljs-string">"/var/spool/asterisk/fax/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span></span><span class="hljs-string">.pdf"</span></span>) same =&gt; n,HangUp() [fax-tx] exten =&gt; send,1,NoOp(------------------- FAX from <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> ------------------) same =&gt; n,Wait(1) same =&gt; n,Set(DT=<span class="hljs-variable"><span class="hljs-variable">${TIMESTAMP}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${CALLERIDNUM}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${UNIQUEID}</span></span>) same =&gt; n,Set(FAXOPT(headerinfo)=Received by <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span> <span class="hljs-variable"><span class="hljs-variable">${STRFTIME(${EPOCH}</span></span>,,%Y-%m-%d %H-%M)}) same =&gt; n,Set(FAXOPT(localstationid)=Name) same =&gt; n,Set(FAXOPT(maxrate)=14400) same =&gt; n,Set(FAXOPT(minrate)=2400) same =&gt; n,NoOp(FAXOPT(headerinfo) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(headerinfo)}</span></span>) same =&gt; n,NoOp(FAXOPT(localstationid) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(localstationid)}</span></span>) same =&gt; n,NoOp(FAXOPT(maxrate) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(maxrate)}</span></span>) same =&gt; n,NoOp(FAXOPT(minrate) : <span class="hljs-variable"><span class="hljs-variable">${FAXOPT(minrate)}</span></span>) same =&gt; n,NoOp(**** RECEIVING FAX : <span class="hljs-variable"><span class="hljs-variable">${DT}</span></span> ****) same =&gt; n,SendFAX(/usr/dumps/<span class="hljs-variable"><span class="hljs-variable">${FAXFILENAME}</span></span>.tiff,d) same =&gt; n,NoOp(<span class="hljs-variable"><span class="hljs-variable">${FAXSTATUS}</span></span>) same =&gt; n,NoOp(number is <span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>) same =&gt; n,System(/usr/bin/sendEmail -f asterisk_fax@name.ru -t office@name.ru -u <span class="hljs-string"><span class="hljs-string">'Fax message Sent'</span></span> -o message-charset=utf-8 -m <span class="hljs-string"><span class="hljs-string">':${CALLERID(number)}\nStatus:${FAXSTATUS}'</span></span> -s localhost -l /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/fax.log) same =&gt; n,HangUp()</code> </pre><br><br>  That's all.  As a result, no additional software is needed and it is easier to train operators to work with faxes. </div><p>Source: <a href="https://habr.com/ru/post/185260/">https://habr.com/ru/post/185260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185246/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 15</a></li>
<li><a href="../185248/index.html">Authentication in a new way, or superkuki</a></li>
<li><a href="../185250/index.html">Summer, vacation, asterisk or your own VoIP operator</a></li>
<li><a href="../185252/index.html">C ++ notification area icon</a></li>
<li><a href="../185256/index.html">Weekday rdp or modest RDCMan say a word</a></li>
<li><a href="../185264/index.html">UAC, let's be friends!</a></li>
<li><a href="../185266/index.html">Plasmoid in pure QML and JavaScript</a></li>
<li><a href="../185268/index.html">Drawings in SVG format. Part 2. - Draft Standard</a></li>
<li><a href="../185270/index.html">Connect to the live online broadcast of Visual Studio 2013 July 5</a></li>
<li><a href="../185274/index.html">ntop is back. New generation release - ntopng</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>