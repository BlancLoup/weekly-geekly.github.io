<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acceleration of the library HeatonResearchNeural (neural network) 30 times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I want to share a little history of finishing HeatonResearchNeural - libraries of various neural networks. At once I will make a reservation th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acceleration of the library HeatonResearchNeural (neural network) 30 times</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I want to share a little history of <a href="http://www.heatonresearch.com/">finishing HeatonResearchNeural</a> - libraries of various neural networks.  At once I will make a reservation that I work as an analyst, and I stopped being an honest programmer 10 years ago. <br><br>  However, I have my own project in C #, which I develop in my free time.  In order not to bother with writing a bicycle, I once downloaded HeatonResearchNeural with an adhesive tape and calmly drove tests, refined the logic of my code, etc.  For maximum acceleration, laid into the architecture of the solution the parallelization of calculations and looking at the CPU load, 80-90% of the body spread pleasant warmth of the body - everyone plows, everyone does it! <br><a name="habracut"></a><br>  On the other hand, I have large volumes, I had to wait a long time until it worked out.  I even thought about buying a second server, until I suddenly had the idea to look under the hood of this very bike with the help of a profiler.  Moreover, it did not appear on its own, but under the impression of this <a href="https://habrahabr.ru/company/intel/blog/311618/">article by a</a> respected habial society. <br><br>  Initially, in my code, I was sure.  It is clear that the neural network is such a thing that must fly, otherwise it will not pull serious topics.  However, just like after reading the medical reference book, you find most of the signs of the most horrendous diseases in yourself, I decided to <s>check</s> it <s>out by</s> going through the code with the profiler. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When profiling pointed to library functions, cold-blooded anxiety fluttered in my heart.  It is clear that the developers of such a good library thought about speed, right?  Or the world is not ruled by a secret lodge, but an obvious crap?  To answer this question, let's take a closer look at the result of running 100 cycles of my program, almost entirely consisting of the work of neural networks: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/42d/f57/68d/42df5768da03440caefe7647f4d7234f.png" alt="image"></div><br>  We fall into the Call Tree report and find the most difficult functions: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e79/4fb/b54/e794fbb54a884aaaa49573b0378d47a8.png" alt="image"></div><br>  We go to them and see a truly heartbreaking sight.  If you are not completely confident in your psyche, it may be worthwhile to turn away and not see how the GetCol function deals with the ungodly extraction of a vector from the matrix: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Matrix </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCol</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> col</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (col &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Cols) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixError(<span class="hljs-string"><span class="hljs-string">"Can't get column #"</span></span> + col + <span class="hljs-string"><span class="hljs-string">" because it does not exist."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[,] newMatrix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Rows, <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row = <span class="hljs-number"><span class="hljs-number">0</span></span>; row &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Rows; row++) { newMatrix[row, <span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix[row, col]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Matrix(newMatrix); }</code> </pre> <br>  Only for transfer to DotProduct: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.next.NeuronCount; i++) { Matrix.Matrix col = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.GetCol(i); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> sum = MatrixMath.DotProduct(col, inputMatrix); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.next.SetFire(i, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activationFunction.ActivationFunction(sum)); }</code> </pre><br>  We deprive this parasite of nutrients and vitamins full of vitamins with two exact slashes and pass the whole matrix together with the required column number to DotProduct: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Matrix.Matrix col = this.matrix.GetCol(i); double sum = MatrixMath.DotProduct(this.matrix, i, inputMatrix);</span></span></code> </pre><br>  And already inside instead of elegant lace: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DotProduct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Matrix a, Matrix b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!a.IsVector() || !b.IsVector()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixError( <span class="hljs-string"><span class="hljs-string">"To take the dot product, both matrixes must be vectors."</span></span>); } Double[] aArray = a.ToPackedArray(); Double[] bArray = b.ToPackedArray(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aArray.Length != bArray.Length) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixError( <span class="hljs-string"><span class="hljs-string">"To take the dot product, both matrixes must be of the same length."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = aArray.Length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; length; i++) { result += aArray[i] * bArray[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre><br>  Sculpt as simple as an ax, bydlokod: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DotProduct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Matrix a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, Matrix b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!b.IsVector()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixError( <span class="hljs-string"><span class="hljs-string">"To take the dot product, both matrixes must be vectors."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a.Rows != b.Cols || b.Rows != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixError( <span class="hljs-string"><span class="hljs-string">"To take the dot product, both matrixes must be of the same length."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rows = a.Rows; <span class="hljs-comment"><span class="hljs-comment">//    ,    a.Rows     for (int r = 0; r &lt; rows; r++) { result += a[r, i] * b[0, r]; } return result;</span></span></code> </pre><br>  Validators for going beyond the array also make sense to comment out, still sizes are set statically during compilation and it‚Äôs hard to mess up, and the time for them is killed as much as the Japanese from skyscrapers weakening the yen by 5%. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> col] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Validate(row, col); return this.matrix[row, col]; } set { //Validate(row, col); if (double.IsInfinity(value) || double.IsNaN(value)) { throw new MatrixError("Trying to assign invalud number to matrix: " + value); } this.matrix[row, col] = value; } }</span></span></code> </pre><br>  So, an exciting moment, we run again 100 program cycles.  When I saw the effect of these simple actions, I almost poplohe from joy.  Such a strange feeling, as if you were given and presented 30 servaks like that (which, it turns out, you were standing in the closet, but you just did not know to look there): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d61/f25/52e/d61f2552ee944ff9aa8c68b8649a2fe6.png" alt="image"></div><br>  The first 6 seconds on the graph is data preparation, so the real time of work was reduced from 780 to 26 seconds, with absolutely the same result, naturally.  Thus, the acceleration happened 30 times! <br><br>  Thus, the practice still shows that Murphy's laws are as stable as African-Americans sit on the welfer and if something can go wrong, then there is no doubt that it will happen.  It is also worth noting that maybe some types of networks will not work on such code, it is worth testing and taking into account if necessary.  Thank you all for your attention, I hope this will help someone in some way in a successful fight against the uncontrollably growing entropy of the universe and code. </div><p>Source: <a href="https://habr.com/ru/post/313740/">https://habr.com/ru/post/313740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313726/index.html">Interview with Max Stoiber and Sergey Lapin: Choosing a state management solution for React.js</a></li>
<li><a href="../313728/index.html">IT bulldogs under the carpet</a></li>
<li><a href="../313730/index.html">Problems installing a bootloader on a flash drive</a></li>
<li><a href="../313732/index.html">Gamification forum on the engine XenForo</a></li>
<li><a href="../313736/index.html">What applications, games and online stores do the Chinese use?</a></li>
<li><a href="../313742/index.html">Used servers: exposing the purchase with the hands</a></li>
<li><a href="../313744/index.html">The opening of a mobile development studio from scratch in St. Petersburg - 3.5 years later. Reincarnation. Part 2</a></li>
<li><a href="../313746/index.html">Busfor's start-up startup has raised $ 20 million in investment</a></li>
<li><a href="../313750/index.html">The most popular network for supercomputers or Why did we choose InfiniBand?</a></li>
<li><a href="../313752/index.html">Video description of SalesForce CRM. Subtitles in Russian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>