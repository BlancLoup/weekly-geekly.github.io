<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking a bitcoin exchange on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, a lot of Bitcoin services. And what used to be a ‚Äúfor fun‚Äù project suddenly began to store tens and even hundreds of thousands of dollars. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking a bitcoin exchange on Rails</h1><div class="post__text post__text-html js-mediator-article">  Recently, a lot of Bitcoin services.  And what used to be a ‚Äúfor fun‚Äù project suddenly began to store tens and even hundreds of thousands of dollars.  The price of bitcoin increased, but the level of security of bitcoin services remained the same low. <br><br>  For the sake of the portfolio, we conducted a free audit of the <a href="http://github.com/peatio/peatio">Bitcoin exchange open source Peatio</a> using Ruby on Rails.  Report in pdf can be <a href="http://sakurity.com/peatio.pdf">downloaded here</a> .  The most interesting thing is that as a result, there were not regular dull flights with Kondisheny or SQLi, but rather a curious chain of bugs leading to account hijacking and theft of a substantial part of a hot wallet. <br><a name="habracut"></a><br><h4>  Account hijacking </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/534/a99/7c6/534a997c6ef383e06bc3932607c428b0.png" alt="image"><br><br>  The entrance through Weibo immediately catches the eye (this is a popular social sphere among the Chinese).  If you read the <a href="http://www.oauthsecurity.com/">OAuth security cheat sheet,</a> it becomes obvious where OAuth is there and account hijacking. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Joining Veybo attacker to the victim's account</b> <br>  In <a href="https://github.com/beenhero/omniauth-weibo-oauth2/pull/12">omniauth-weibo-oauth2 there</a> was a bug fixing state.  state is an important parameter for protection against CSRF, and protection against it was built in (not immediately, of course) in omniauth.  That's just a line <br><br><pre><code class="bash hljs">session[<span class="hljs-string"><span class="hljs-string">'omniauth.state'</span></span>] = params[:state] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v == <span class="hljs-string"><span class="hljs-string">'state'</span></span></code> </pre> <br>  turned off this protection by inserting the value from the GET parameter into the session ['omniauth.state'].  Now you can fix state = 123 and use the code released for the weibo attacker.  Example of operation: <br><pre> <code class="bash hljs">require <span class="hljs-string"><span class="hljs-string">'sinatra'</span></span> get <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = Faraday.new(:url =&gt; <span class="hljs-string"><span class="hljs-string">'https://api.weibo.com'</span></span>) new_url = conn.get <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |r| r.url <span class="hljs-string"><span class="hljs-string">"/oauth2/authorize?client_id=456519107&amp;redirect_uri=https%3A%2F%2Fyunbi.com%2Fauth%2Fweibo%2Fcallback&amp;response_type=code&amp;state=123"</span></span> r.headers[<span class="hljs-string"><span class="hljs-string">'Cookie'</span></span>] =&lt;&lt;COOKIE YourWeiboCookies COOKIE r.options.timeout = 4 r.options.open_timeout = 2 end.headers[<span class="hljs-string"><span class="hljs-string">"Location"</span></span>] redirect new_url end get <span class="hljs-string"><span class="hljs-string">'/peatio_demo'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> response.headers[<span class="hljs-string"><span class="hljs-string">'Content-Security-Policy'</span></span>] = <span class="hljs-string"><span class="hljs-string">"img-src 'self' https://yunbi.com"</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;img src='https://yunbi.com/auth/weibo?state=123'&gt;&lt;img src=''&gt;"</span></span> end</code> </pre><br>  As a result, we have a weybo attacker connected to the victim‚Äôs accounts on the exchange, and we can go into it directly. <br><br>  <b>And if the Weibo is already connected to the victim?</b> <br>  The second account can not be connected, so you need to find a way to steal the code for the current weybo victim. <br>  Weibo does not tie the code to redirect_uri (which is a blunder in itself, but I could not blame the Chinese) and therefore finding the page that merges the code through the referrers we will reach the goal.  The search for such a page, like the open redirect, was not successful, but at the very end an interesting line in DocumentsController saved the situation: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not @doc redirect_to(request.referer || root_path) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> end</code> </pre><br>  If the document is not found, then a redirect to request.referer occurs, which means the following chain of redirects will merge the code: <br><br>  1. attacker_page redirect on weibo.com/authorize?...redirect_uri=http://app/documents/not_existing_doc%23‚Ä¶ <br>  2. Weibo wrong parsit redirect_uri c% 23 and redirect the victim to <a href="http://app/documents/not_existing_doc">app / documents / not_existing_doc #? Code = VALID_CODE</a> <br>  3. Peatio cannot find not_existing_doc and returns a Location header equal to the current request.referer, which is still attacker_page (the browser continues to send it from the very beginning) <br>  4. The browser copies the #? Code = VALID_CODE snippet and loads attacker_page #? Code = VALID_CODE.  Now the code on the page can read VALID_CODE via location.hash and download the real <a href="http://app/auth/weibo/callback%3Fcode%3DVALID_CODE">app / auth / weibo / callback? Code = VALID_CODE</a> to enter the victim‚Äôs account on the exchange. <br><br>  So, we hijacked the account of users with and without Weibo.  But further we are stopped by two-factor authentication. <br><br><h4>  2FA bypass </h4><br>  Peatio out of the box makes all users use Google Authenticator and / or SMS codes for important functions (bitcoin output).  So we somehow need to find a way around. <br>  <b>If the victim has only Google Authenticator enabled</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/87e/1b7/241/87e1b724131bda6c4dceb2d37691d485.png" alt="image"><br>  In SmsAuthsController there was a serious error - the filter two_factor_required!  It was called only for the show action, but not for the update action, which was then responsible for connecting the SMS 2FA. <br><br><pre> <code class="bash hljs">before_action :auth_member! before_action :find_sms_auth before_action :activated? before_action :two_factor_required!, only: [:show] def show @phone_number = Phonelib.parse(current_user.phone_number).national end def update <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> params[:commit] == <span class="hljs-string"><span class="hljs-string">'send_code'</span></span> send_code_phase <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> verify_code_phase end end</code> </pre><br>  So, bypassing requests for show, we send requests directly to update: <br>  curl 'http: // app / verify / sms_auth' -H ' = 9123222211 &amp; commit = send_code ' <br><img src="https://habrastorage.org/getpro/habr/post_images/e75/7e9/f6b/e757e9f6b1893c2b68f5e5b03ecde955.png" alt="image"><br>  curl 'http: // app / verify / sms_auth' -H ' = 9123222211 &amp; sms_auth% 5Botp% 5D = CODE_WE_RECEIVED ' <br><img src="https://habrastorage.org/getpro/habr/post_images/380/c87/e2a/380c87e2a0c758fa441326715b127661.png" alt="image"><br>  When connecting SMS 2FA, we can receive codes to our number and output bitcoins to our address. <br><br>  <b>If the victim has an SMS and Authenticator</b> <br>  If the paranoid victim connected both methods to 2FA, then the work becomes a bit more difficult.  The system is vulnerable to 2FA codes brutoforus, in other words, it is very easy to get around.  Unlike the regular password, where there are 36 ^ 8 + variants, in the one-time code there are only 1 million variants.  <b>Three days is enough</b> to calmly guess it.  You can count on the <a href="http://sakurity.com/otp">OTP Bruteforce Calculator</a> yourself: <br><img src="https://habrastorage.org/getpro/habr/post_images/ce3/145/b5f/ce3145b5f8c94989a7d38daf515f6b79.png" alt="image"><br>  Without protection against brute 2FA does not make sense, that's right at all.  A common misconception, by the way, is that a 30-second window makes bruteforce more difficult.  In fact, there is practically no difference, that for 1 second that 24 hours this code is active, 3 days will be enough. <br><br>  <b>If only SMS 2FA</b> <br>  It looks like the most difficult option - after all, it will not work out imperceptibly, and the victim will immediately notice suspicious SMS to his number.  However, another error in the code will help us: <br><pre> <code class="bash hljs">def two_factor_by_type current_user.two_factors.by_type(params[:id]) end</code> </pre><br>  In this method, the ‚Äúactivated‚Äù scop is not used, which means that you can continue to brutalize 2FA like Google Authenticator as in the previous case, despite the fact that it has never been activated, because it has already generated a seed! <br><br><h4>  We attack the admin </h4><br>  Now that we have learned how to steal and bypass 2FA for any user, let's try to apply the resulting exploit wisely.  We will not hunt for users, and immediately write such a ticket to the admin "What is wrong with my account can you please check?  <a href="http://i.will.hack.you/now">i.will.hack.you/now</a> .  After visiting this page, our script will steal the admin account. <br><img src="https://habrastorage.org/getpro/habr/post_images/9c1/58d/b34/9c158db34911d6d73a6da9c21e026456.png" alt="image"><br>  Unfortunately, it turned out that the admin can practically nothing.  There are no functions ‚Äúsend all bitcoins to X‚Äù or ‚Äúadd Bitcoins to this user‚Äù.  The only clue is the possibility of approval of Fiat deposits made by users.  So we can create a deposit for a lot of money and approve it ourselves: <br><img src="https://habrastorage.org/getpro/habr/post_images/9ae/6f1/963/9ae6f196364bead32228f2b90d9c95e5.png" alt="image"><br>  Then we can buy all the bitcoins available on the orders and immediately withdraw them (instantly just because we are the admin and approve our Withdraw request themselves, the conclusions in the exchange are made manually!).  But much more profit IMHO bring the option when we will quietly drink blood from the exchange for a week or two. <br><br><h4>  Morality: </h4><br>  1. Never add an entry through social networks in important sites.  There are too many ideological flaws in them, so it‚Äôs better not to get involved at all. <br>  2. If you decide to do two-factor authorization, do it right from the very beginning - clearly follow the procedure for adding a new method and prevent brute-force by blocking your account after N attempts. <br>  3. Create a separate Superradmin with the function of injecting an arbitrary amount of money into the system.  He should not be able to read tickets and in general this account should be kept as the apple of his eye. <br><br>  Thank you for your attention, and if you want to secure your service, you know who to contact. </div><p>Source: <a href="https://habr.com/ru/post/248887/">https://habr.com/ru/post/248887/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248871/index.html">Runscript - utility to run python scripts</a></li>
<li><a href="../248873/index.html">Skyforge rendering technology</a></li>
<li><a href="../248875/index.html">Meteor. And now loading photos</a></li>
<li><a href="../248879/index.html">Boost.DI: dependency injection in C ++</a></li>
<li><a href="../248881/index.html">Overview Friendly interactive shell (fish) and why it is better than bash</a></li>
<li><a href="../248889/index.html">‚ÄúOpen Financial Data: Possibilities for Using It‚Äù</a></li>
<li><a href="../248891/index.html">Do not rush to throw out the old servers, you can assemble fast Ethernet-storage in an hour</a></li>
<li><a href="../248893/index.html">Practice "Intel IoT". Galileo Gen2 - Linux & Arduino</a></li>
<li><a href="../248895/index.html">Buttons do not happen much</a></li>
<li><a href="../248897/index.html">C ++ 11 variadic templates and long arithmetic at compile time</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>