<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Offline-first app with Hoodie & React. Part One: Browser Database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modern web allows you to solve some of the tasks that were previously the prerogative of native mobile applications. We will create a web application ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Offline-first app with Hoodie & React. Part One: Browser Database</h1><div class="post__text post__text-html js-mediator-article"><p>  Modern web allows you to solve some of the tasks that were previously the prerogative of native mobile applications.  We will create a web application (website) that will load and retain full functionality even in the absence of the Internet, and when it appears, it is automatically synchronized with the server.  For a mobile device, for such an application it is enough to create a shortcut and in terms of autonomy we will get an analogue of the native application. </p><br><p>  We will write a semblance of a todo-list, with one difference: ‚Äúcompleted‚Äù tasks will not be deleted, but transferred to the end of the list and as the remaining tasks are solved, it will pop up.  This list is convenient to use for repetitive things, such as various sports activities, entertainment, food, etc.  One of my socially realized friend uses it to evenly maintain contact with a large population of his friendszone. </p><br><p>  What you get as a result can be <a href="https://action-loop.com/">viewed here</a> .  Try to make some changes, close the tab, turn off the Internet and re-open the site.  You will find that it opens and retains full functionality.  If you log in to different devices and make changes offline, after the connection is restored, the changes are synchronized in an intuitively expected way. </p><br><p>  You will be surprised how little code we need to implement this functionality. </p><a name="habracut"></a><br><h2>  Part 0: Setting Up the Environment </h2><br><p> In order not to clutter the text with the next webpack settings, I created a <a href="https://github.com/imbolc/action-loop">turnip</a> with ready-made settings.  Just incline it and switch to part 0: <code>git checkout part0</code> .  Key points to pay attention to: </p><br><ul><li>  <code>npm start</code> - launches the hoodie-server and assembly of the application with a webpack in watch mode (reassembly when changed) </li><li>  <code>public/index.html</code> - exactly what you thought, here we create the root div of the application and connect the bundle compiled by the webpack </li><li>  <code>src/index.js</code> - entry point into the application, here we render the root component: <code>ReactDOM.render(&lt;App /&gt;</code> </li><li>  <code>src/App.js</code> is our only component so far; here we will start writing code in the next section. </li></ul><br><p>  Try to start the server.  When the webpack says that everything is ready, at <a href="http://localhost:8000/">http: // localhost: 8000 /</a> you should see a nice site header. </p><br><h2>  Part 1: Browser Database </h2><br><p>  In order for the application to function in offline mode, we will need to store data somewhere and somehow synchronize it between devices.  <a href="https://pouchdb.com/">Pouchdb</a> is perfect for this.  But we will work with it not directly but through the <a href="http://docs.hood.ie/camp/">Hoodie</a> wrapper, which can authorize.  Let's connect it in <code>src/App.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Hoodie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@hoodie/client'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hoodie = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hoodie()</code> </pre> <br><h3>  Add a document to the database </h3><br><p>  Now create a component to add a loop (a separate todo list): </p><br><div class="spoiler">  <b class="spoiler_title">AddLoop.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextField <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'material-ui/TextField'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RaisedButton <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'material-ui/RaisedButton'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddLoop</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(props) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(props) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> } } handleTitleChange = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: e.target.value}) handleSubmit = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) =&gt;</span></span> { e.preventDefault() <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.store.add({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'loop'</span></span>, <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.title }) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}) } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;form onSubmit={this.handleSubmit}&gt; &lt;TextField hintText="New loop" value={this.state.title} onChange={this.handleTitleChange} style={{marginRight: '10px'}} /&gt; &lt;RaisedButton label="Add" type="submit" primary={true} /&gt; &lt;/form&gt; ); } }</code> </pre> </div></div><br><p>  The bottom line here lies in the line <code>this.props.store.add</code> .  Where <code>store</code> is <code>hoodie.store</code> which we need to pass in the properties of the components when rendering it in <code>App.js</code> : </p><br><pre> <code class="javascript hljs">render() { ... &lt;AddLoop store={hoodie.store} /&gt;</code> </pre> <br><h3>  Reading database </h3><br><p>  Let's now display the documents saved in the database.  In <code>App.js</code> we add the <code>loadLoops</code> method: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(props) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(props); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">loops</span></span>: [] }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loadLoops(); } loadLoops = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { hoodie.store.findAll(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">doc</span></span></span><span class="hljs-function"> =&gt;</span></span> doc.type == <span class="hljs-string"><span class="hljs-string">'loop'</span></span>) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loops</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({loops})) }</code> </pre> <br><p>  We needed a constructor in which we initialize the <code>state</code> and initiate the loading of documents.  In <code>hoodie.store.findAll</code> we pass a filter for the necessary documents and get a promise, in which we simply write the received documents to the <code>state</code> . </p><br><p>  Let's now draw them by adding to <code>render()</code> : </p><br><pre> <code class="javascript hljs"> {<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.loops.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loop</span></span></span><span class="hljs-function"> =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Paper</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{loop.id}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">zDepth</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{2}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{{maxWidth:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">400</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">margin:</span></span></span></span><span class="xml"><span class="hljs-tag"> '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">20px</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">auto</span></span></span></span><span class="xml"><span class="hljs-tag">'}}&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{{padding:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">15</span></span></span></span><span class="xml"><span class="hljs-tag">}}&gt;</span></span></span><span class="xml">{loop.title}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Paper</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ))}</code> </pre> <br><p>  Now you should see a list of added loopes.  However, when adding new ones, they will appear in the list only when the page is reloaded.  Let's fix it. </p><br><h3>  Subscribe to changes to the database </h3><br><p>  All the code for this item will consist of adding a couple of lines to our <code>App.js</code> : </p><br><pre> <code class="javascript hljs"> componentDidMount() { hoodie.store.on(<span class="hljs-string"><span class="hljs-string">'change'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loadLoops); }</code> </pre> <br><p>  Now, when adding loops, they will automatically appear in the list.  And no matter how the database has changed.  <strong>This is important</strong> - even if changes occurred during synchronization with another device, our callback will work. </p><br><h3>  Why React </h3><br><p>  From the logic of working with the database, it becomes clear why a reaction was chosen among the abundance of browser template engines.  In response to each change in DB, we will simply restart the entire state.  And if I loved vue.js in place of the reactor, it would re-render the entire dom.  And this is not just slow, imagine you fill out a form and at this moment another device initiates a change in the database - the form is redrawn, your changes are lost.  Whereas the reaction with its virtual dom will accurately redraw the changed details and even not focus on your form. </p><br><h3>  the end </h3><br><p>  Today we learned how to interact with browser database.  In the next part, we will configure the server database and fasten the authorization.  I will be glad to any of your comments / corrections / wishes.  The code for this part is available here: <a href="https://github.com/imbolc/action-loop">https://github.com/imbolc/action-loop</a> under the tag <code>part1</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309166/">https://habr.com/ru/post/309166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309156/index.html">Testing IVR on Asterisk with ... Asterisk</a></li>
<li><a href="../309158/index.html">Survey: Programmer and Salary</a></li>
<li><a href="../309160/index.html">Russian Post for Dummies</a></li>
<li><a href="../309162/index.html">Implementing a finite state machine in VHDL</a></li>
<li><a href="../309164/index.html">The digest of interesting materials for the mobile developer # 169 (August 29 - September 4)</a></li>
<li><a href="../309168/index.html">Interview with Artyom Malyshev, who will speak at Moscow Python in October</a></li>
<li><a href="../309170/index.html">Cable Management: Some Tips From Your Own Experience</a></li>
<li><a href="../309172/index.html">Zabbix 3.0.4: Windows Agent with TLS, LLD drives, a simple SMART example and command line only</a></li>
<li><a href="../309174/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ226 (August 29 - September 4, 2016)</a></li>
<li><a href="../309176/index.html">PHPixie vs Laravel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>