<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>cat, awk and sed</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All the good time! 

 Picking up my old scripts, I found one script similar to the following: 



#!/bin/sh # PKCS if [ -f /etc/openvpn/ssl/vars ]; th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>cat, awk and sed</h1><div class="post__text post__text-html js-mediator-article">  All the good time! <br><br>  Picking up my old scripts, I found one script similar to the following: <br><a name="habracut"></a><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #           PKCS if [ -f /etc/openvpn/ssl/vars ]; then . /etc/openvpn/ssl/vars &gt;/dev/null else echo " /etc/openvpn/ssl/vars  " exit 1 fi MAILTO="root" SKIP=$((`cat $0 | awk '/#!\/bin\/sh/,/^#END/{print}'|wc -l`+1)) Dialog=${Dialog=dialog} CWD=$(pwd) cd $KEY_DIR Files=`ls -1 *.p12` cd $CWD Spisok="" for i in $Files; do Spisok="$Spisok $i -"`basename $i .p12` done Choice=`$Dialog --stdout --clear --menu " " 20 71 14 $Spisok` retval=$? User=`basename $Choice .p12` case $retval in 0) TEMP="/tmp/$User.vpn" if [ -e $TEMP ]; then rm -rf $TEMP fi mkdir -p $TEMP 2&gt;/dev/null mkdir -p $TEMP/yyy 2&gt;/dev/null config="$TEMP/YYY-$User.ovpn" cat &lt;&lt; EOF_CONFIG &gt; $config client remote xxxxx port 1194 proto udp dev tun ns-cert-type server tls-client reneg-sec 60 mtu-test cipher AES-256-CBC comp-lzo persist-key persist-tun keysize 256 nobind explicit-exit-notify 2 pkcs12 yyy/$Choice EOF_CONFIG cp $KEY_DIR/$Choice $TEMP/yyy 2&gt;/dev/null tail -n +$SKIP $0 | gzip -cd | tar xvf - -C $TEMP &gt;/dev/null cd $TEMP tar zcvf ${User}_YYY.tgz `basename $config` `basename $TEMP/Readme-OpenVPN.doc` yyy &gt;/dev/null . . . . exit 0 #END          </span></span></code> </pre> <br>  In principle, the script provides a menu for selecting a container file and sends the file with an instruction to the specified address.  In order to be able to transfer the script to different servers and not to think about the instructions, I put the instructions in the executable script and when executing it I took it out, unzipped it and sent it.  But the note itself is not about the instructions, but about the non-optimal use of some commands. <br>  The very team that I did not like and that I wanted to optimize looks like this <br><pre> <code class="bash hljs">SKIP=$((`cat <span class="hljs-variable"><span class="hljs-variable">$0</span></span> | awk <span class="hljs-string"><span class="hljs-string">'/#!\/bin\/sh/,/^#END/{print}'</span></span>|wc -l`+1))</code> </pre><br>  In it we get the offset in the lines from the beginning of the file to the archived data at the end of the file. <br>  The first thing that caught my eye was the use of cat and awk through a pipe.  Naturally, I immediately rewrote to <br><pre> <code class="bash hljs">SKIP=$((`awk <span class="hljs-string"><span class="hljs-string">'/#!\/bin\/sh/,/^#END/{print}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>|wc -l`+1))</code> </pre><br>  But this seemed to me a little.  Why use wc also if you use awk, which can do more than that.  In toga something happened <br><pre> <code class="bash hljs">SKIP=$(awk <span class="hljs-string"><span class="hljs-string">'BEGIN{comp_str=0} /#!\/bin\/sh/,/^#END/{comp_str++} END{print ++comp_str}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>)</code> </pre><br>  And again, too many characters, and very hard to read, as a result we have <br><pre> <code class="bash hljs">SKIP=$(awk <span class="hljs-string"><span class="hljs-string">'/^#END/{print ++NR}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>)</code> </pre><br>  But, here the condition is not satisfied that before the first occurrence of #END characters.  Although it suits me, for the sake of interest, having run the script on the test data for more than 500 megabytes, I found that the script execution time was about 25 seconds.  I started to look for the exit function (as I was advised by the habrechelok <a href="http://habrahabr.ru/users/oxpa/">oxpa</a> ) on awk, but at that moment due to inattention I couldn‚Äôt get it to work, how funny it doesn‚Äôt sound, and I started looking towards sed.  The result was this <br><pre> <code class="bash hljs">SKIP=$((`sed -n <span class="hljs-string"><span class="hljs-string">'/^#END/{=}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>` + 1))</code> </pre><br>  Checking on the same file in 500 megabytes saw the execution time less than 2 seconds.  Great, but why do we need to watch the entire file, and again, in the first version, there was a condition before the first entry into the file.  There was nothing like to rewrite this option <br><pre> <code class="bash hljs">SKIP=$((`sed -n <span class="hljs-string"><span class="hljs-string">'/^#END/{=;q;}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>` + 1))</code> </pre><br>  well, or awk <br><pre> <code class="bash hljs">SKIP=$(awk <span class="hljs-string"><span class="hljs-string">'/^#END/{print ++NR; exit;}'</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span>)</code> </pre><br>  Thanks for attention! <br><br>  PS: from habrachelovek <a href="http://habrahabr.ru/users/oxpa/">oxpa</a> (for which he thanks a lot!) <a href="http://habrahabr.ru/users/oxpa/">Did</a> this option <br><pre> <code class="bash hljs">SKIP=$(grep -A1 -n <span class="hljs-string"><span class="hljs-string">"^#END"</span></span> <span class="hljs-variable"><span class="hljs-variable">$0</span></span> | tail -1 | cut -f 1 -d -)</code> </pre><br>  This option works twice as fast as the version on sed, of course, it‚Äôs about if the file is large and the label is at the end. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/152183/">https://habr.com/ru/post/152183/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152169/index.html">Why there are 1.3 billion reasons that are ‚Äúfor‚Äù new maps in iOS 6</a></li>
<li><a href="../152171/index.html">Tesla Motors is going to build a network of charging stations for electric vehicles</a></li>
<li><a href="../152175/index.html">Let's talk about security at Yet Another Conference</a></li>
<li><a href="../152179/index.html">Google introduced the YouTube video translator to 300 languages ‚Äã‚Äãand begins to broadcast TV shows</a></li>
<li><a href="../152181/index.html">Exactmouse - exact mouse + color from the screen</a></li>
<li><a href="../152185/index.html">Yandex presents a new service for choosing clothes</a></li>
<li><a href="../152187/index.html">Steve Jobs Candidate</a></li>
<li><a href="../152189/index.html">Problems of the updated App Store</a></li>
<li><a href="../152191/index.html">Ubooly: plush toy with iphone instead of brain</a></li>
<li><a href="../152193/index.html">Unusual hard disk overflow or how to delete millions of files from one folder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>