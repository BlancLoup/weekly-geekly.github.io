<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASA5525-X + MS CA Windows Server 2012R2 - two-factor authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To pass the certification for compliance with the requirements of the PCI DSS standard , it was necessary to configure two-factor authentication. And ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASA5525-X + MS CA Windows Server 2012R2 - two-factor authentication</h1><div class="post__text post__text-html js-mediator-article">  To pass the certification for compliance with the requirements of the <b><a href="https://ru.wikipedia.org/wiki/PCI_DSS">PCI DSS</a></b> standard <b><a href="https://ru.wikipedia.org/wiki/PCI_DSS">,</a></b> it was necessary to configure two-factor authentication.  And since we use a solution from Cisco as a firewall, we decided to use it ... It would seem that nothing complicated, everything has been studied for a long time and more than once configured and you can easily find the necessary instructions, for example, these: <br><blockquote>  <a href="https://technet.microsoft.com/library/hh831348.aspx">Test Lab Guide: Deploying the Active Directory Certificate Services Public Key Infrastructure Public Key Infrastructure Two-Level Hierarchy</a> </blockquote><br><blockquote>  <a href="http://www.cisco.com/c/en/us/td/docs/security/asa/asa90/configuration/guide/asa_90_cli_config/aaa_certs.html">CISCO: Configuring Digital Certificates</a> </blockquote><br><blockquote>  <a href="http://www.crossrealms.com/cisco-asa-with-radius-and-certificates-for-two-factor-authentication-using-a-microsoft-ca/">Cisco ASA with Radius and Certificates for Two-Factor Authentication (using a Microsoft CA)</a> </blockquote><br>  but, as is usually the case with such "universal" instructions - they do not take into account the subtleties, and this just takes most of the time when deploying.  I just want to tell you about these moments.  I hope this will save you a lot of time! <br><a name="habracut"></a><br>  The first unpleasant moment was that Offline Root CA issued a certificate for Subordinate Issuing CA for a period of 1 year (!) And this despite the previously created <div class="spoiler">  <b class="spoiler_title">CAPolicy.inf:</b> <div class="spoiler_text"><pre><code class="vbscript hljs">[Version] Signature=<span class="hljs-string"><span class="hljs-string">"$Windows NT$"</span></span> [PolicyStatementExtension] Policies=InternalPolicy [InternalPolicy] OID= <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1455</span></span><span class="hljs-number"><span class="hljs-number">.67</span></span><span class="hljs-number"><span class="hljs-number">.89</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> Notice=<span class="hljs-string"><span class="hljs-string">"Legal Policy Statement"</span></span> URL=http://www.contoso.com/pki/cps.txt [Certsrv_Server] RenewalKeyLength=<span class="hljs-number"><span class="hljs-number">2048</span></span> RenewalValidityPeriod=Years RenewalValidityPeriodUnits=<span class="hljs-number"><span class="hljs-number">20</span></span> CRLPeriod=weeks CRLPeriodUnits=<span class="hljs-number"><span class="hljs-number">26</span></span> CRLDeltaPeriod=Days CRLDeltaPeriodUnits=<span class="hljs-number"><span class="hljs-number">0</span></span> LoadDefaultTemplates=<span class="hljs-number"><span class="hljs-number">0</span></span> AlternateSignatureAlgorithm=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </div></div><br>  Therefore, carefully check the validity of the certificate and if it is issued for 1 year, change it immediately.  You can change it like this: <br><blockquote>  Click Start, and then click Run. <br>  In the Open box, type <b>regedit,</b> and then click OK. <br>  Find and highlight the following registry key: <br>  <b>HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Services \ CertSvc \ Configuration \ &lt;CcName&gt;</b> <br>  In the right pane, double-click <b>ValidityPeriod</b> . <br>  In the Value field, enter one of the following, and then click OK: <br>  Days <br>  Weeks <br>  Months <br>  Years old <br>  . <br>  In the right pane, double-click <b>ValidityPeriodUnits</b> . <br>  In the Value field, enter the numeric value that you want and click OK.  For example, enter 2. <br>  Stop and restart certificate services.  For this: <br>  Click Start, and then click Run. <br>  In the Open box, type cmd, and then click OK. <br>  At the command prompt, enter the following commands.  Press ENTER after each line. <br><pre> <code class="bash hljs">certsvc net stop net start certsvc</code> </pre><br>  Type exit to exit the command line. </blockquote><br><br>  Another big mistake was ignoring the warning from Microsoft: <br><br><blockquote>  Caution Caution <br>  Certificate clients running Windows XP and Windows Server 2003 do not support an alternate signing algorithm.  To allow such clients to apply for certificates, do not add the string AlternateSignatureAlgorithm = 1 to the CAPolicy.inf file.  For more information, see Recommendations for using alternative signature formats. </blockquote><br>  Therefore - remove the string <b>AlternateSignatureAlgorithm = 1</b> from <b>CAPolicy.inf</b> , otherwise you will have a problem installing certificates on the ASA: <a href="https://supportforums.cisco.com/discussion/12193326/microsoft-ca-rsassa-pss-algorithm-issue-asa">Microsoft CA RSASSA-PSS Algorithm Issue with ASA</a> <br>  It is solved by changing the parameters in the registry: <br><div class="spoiler">  <b class="spoiler_title">Windows Registry Editor Version 5.00</b> <div class="spoiler_text">  [HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ CertSvc \ Configuration \% Your_CA_Name% \ CSP] <br>  "ProviderType" = dword: 00000000 <br>  "Provider" = "Microsoft Software Key Storage Provider" <br>  "HashAlgorithm" = dword: 00008004 <br>  "CNGPublicKeyAlgorithm" = "RSA" <br>  "CNGHashAlgorithm" = "SHA1" <br>  "AlternateSignatureAlgorithm" = dword: 00000001 <br>  "MachineKeyset" = dword: 00000001 <br></div></div><br>  and reissuing all certificates. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And finally, the third point was related to configuring the <b>SSL</b> settings on the ASA, namely <b>TLS V1</b> and acc.  Cipher (versions and algorithms).  At the time of the deployment of the PKI infrastructure, we had the <b>asa911-smp-k8</b> firmware installed, which did not allow it to be properly configured.  Decided to upgrade to the version <b>asa941-smp-k8</b> , but again did not quite carefully read the order of the configuration update.  got such a strange mistake: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b08/b07/57e/b08b0757e091160432e44e2a6e8f0a48.jpg" alt="image"><br><br>  - This is when trying to download the firmware file to the hardware.  But all you had to do was install the firmware version <b>asa912-smp-k8 first</b> <br><br>  I hope someone this knowledge and experience will be useful.  Good luck! <br><br>  PS as rightly noted in the comments - I completely forgot about two-factor authentication, wrote about certificates, forgot about <b>Active Directory</b> .  I will try to fix it, to start the configuration process through ASDM: <br><img src="https://habrastorage.org/files/16b/24f/25d/16b24f25d5204cfb8e0159ecf1409b81.jpg" alt="image"><br>  Go to <b>Configuration -&gt; Device Management -&gt; Users / AAA -&gt; AAA Servers Group</b> , create a new group (name and protocol).  I'll show the settings for the LDAP protocol in the pictures, and in the config, and RADIUS too (for someone that is more convenient to use).  Next, add the server to the newly created group: <br>  1. specify the DNS name or server IP;  Microsoft server type <br>  2. Base DN, - in the example, let it be <b>DC = domain, DC = ru</b> <br>  3. Attribute of the user, which will be produced from AD objects - <b>sAMAccountName</b> <br>  4. Distinguished Name of the user who has access to view \ search for objects in AD (you can take it from the "Active Directory Users and Computers" console by turning on the display of additional components in the attribute editor) <br>  5. The path to the OU, which will be searched for groups <br>  Pay attention to the <b>LDAP Attribute Map</b> - an important detail that needs to be configured! <br><img src="https://habrastorage.org/files/f28/199/084/f2819908454a4807b069c2b0e2f34eb4.jpg" alt="image"><br><blockquote>  ldap attribute-map AD <br>  map-name memberOf IETF-Radius-Class </blockquote><br>  Finally, when the CA is already configured, all the necessary certificates are installed, the connection to AAA servers is checked, AnyConnect \ WebVPN is configured, you can enable two-factor authentication: <br><img src="https://habrastorage.org/files/7c2/f95/e32/7c2f95e32e17464db14f4bdb68a8c97f.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">The promised part of the config</b> <div class="spoiler_text">  ASA Version 9.4 (1) <br>  ! <br>  domain-name domain.ru <br>  ! <br>  ldap attribute-map AD <br>  map-name memberOf IETF-Radius-Class <br>  aaa-server domain.RU protocol ldap <br>  aaa-server domain.RU (VLAN100) host 10.0.0.101 <br>  ldap-base-dn DC = domain, DC = ru <br>  ldap-group-base-dn OU = GROUPS, OU = domainNOLOGIES, DC = domain, DC = ru <br>  ldap-scope subtree <br>  ldap-naming-attribute sAMAccountName <br>  ldap-login-password ***** <br>  ldap-login-dn CN = s-connect_asa-LDAP, OU = system_accounts, OU = BRANCH, DC = domain, DC = en <br>  server-type microsoft <br>  ldap-attribute-map AD <br>  aaa-server domain_NPS protocol radius <br>  aaa-server domain_NPS (VLAN100) host 10.0.0.101 <br>  key ***** <br>  no user identity enable <br>  user identity domain domain aaa-server domain.RU <br>  user-identity default-domain domain <br>  user-identity action domain-controller-down domain disable-user-identity-rule <br>  aaa authentication enable console domain_NPS LOCAL <br>  aaa authentication http console domain_NPS LOCAL <br>  aaa authentication serial console LOCAL <br>  aaa authentication ssh console domain_NPS LOCAL <br>  aaa authentication telnet console LOCAL <br>  aaa authorization command LOCAL <br>  aaa authorization exec authentication-server auto-enable <br>  ! <br>  ! <br>  webvpn <br>  enable ISP1 <br>  anyconnect image disk0: /AnyConnect/anyconnect-linux-3.1.07021-k9.pkg 1 regex "Linux" <br>  anyconnect image disk0: /AnyConnect/anyconnect-linux-64-4.1.00028-k9.pkg 2 regex "Linux" <br>  anyconnect image disk0: /AnyConnect/anyconnect-macosx-i386-4.1.00028-k9.pkg 3 regex "Intel Mac OS X" <br>  anyconnect image disk0: /AnyConnect/anyconnect-win-4.1.00028-k9.pkg 4 regex "Windows NT" <br>  anyconnect profiles domain_AnyVPN disk0: /domain_anyvpn.xml <br>  anyconnect profiles domain_VPN_Users disk0: /domain_vpn_users.xml <br>  anyconnect enable <br>  tunnel-group-list enable <br>  certificate-group-map DefaultCertificateMap 10 domain_AnyVPN <br>  error-recovery disable <br>  group-policy DfltGrpPolicy attributes <br>  default-domain value domain.ru <br>  group-policy GroupPolicy_domain_AnyVPN internal <br>  group-policy GroupPolicy_domain_AnyVPN attributes <br>  wins-server none <br>  dns-server value 10.0.0.101 <br>  vpn-tunnel-protocol ikev2 ssl-client ssl-clientless <br>  default-domain value domain.ru <br>  webvpn <br>  anyconnect mtu 1406 <br>  anyconnect ssl keepalive 20 <br>  anyconnect profiles value domain_AnyVPN type user <br>  always-on-vpn profile-setting <br>  group-policy GroupPolicy_VPN_USERS internal <br>  group-policy GroupPolicy_VPN_USERS attributes <br>  dns-server value 10.0.0.101 <br>  vpn-tunnel-protocol ikev2 ssl-client <br>  default-domain value domain.ru <br>  address-pools value VPN_Users <br>  webvpn <br>  anyconnect profiles value domain_VPNv_Users type user <br>  customization value DfltCustomization <br>  tunnel-group domain_AnyVPN type remote-access <br>  tunnel-group domain_AnyVPN general-attributes <br>  address-pool VPN_Admins <br>  authentication-server-group domain.RU <br>  default-group-policy GroupPolicy_domain_AnyVPN <br>  tunnel-group domain_AnyVPN webvpn-attributes <br>  authentication aaa certificate <br>  radius-reject-message <br>  group-alias domain_ADMINS enable <br>  group-alias domain_AnyVPN disable <br>  tunnel-group domain_USERS type remote-access <br>  tunnel-group domain_USERS general-attributes <br>  address-pool VPN_Users <br>  authentication-server-group domain.RU <br>  default-group-policy GroupPolicy_VPN_USERS <br>  tunnel-group domain_USERS webvpn-attributes <br>  group-alias Users_Access enable <br>  ! <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/256139/">https://habr.com/ru/post/256139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256127/index.html">Anonymous Functions in Swift</a></li>
<li><a href="../256129/index.html">Creating a local network using the existing 220v power network</a></li>
<li><a href="../256131/index.html">The digest of events from the world D</a></li>
<li><a href="../256133/index.html">Apple Watch's first successes, App Annie and Tapjoy reports, Europe vs. Google - and other news of the week for a mobile developer</a></li>
<li><a href="../256137/index.html">API and SOA Management</a></li>
<li><a href="../256141/index.html">VIII Annual Conference "Embedded Technologies 2015"</a></li>
<li><a href="../256143/index.html">Interactive gender on Android</a></li>
<li><a href="../256145/index.html">How to assemble a robot with your own hands in 6 hours and become the soul of the company</a></li>
<li><a href="../256147/index.html">How to catch what is not. Part Five: The Myth of the Need for Certified Software</a></li>
<li><a href="../256151/index.html">DLang plugin for IntelliJ IDEA (Alpha, EAP, POC)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>