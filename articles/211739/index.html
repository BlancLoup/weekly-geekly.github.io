<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proper Use of Yii</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In fact, the title should be a question mark. For a long time I did not code on both yii and php in general. Now, returning, I want to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proper Use of Yii</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In fact, the title should be a question mark.  For a long time I did not code on both yii and php in general.  Now, returning, I want to rethink my principles of development, to understand where to go next.  And the best way is to state them and put them on the review to the professionals, which I do in this post.  Despite the fact that I pursue purely selfish goals, the post will be useful to many beginners, and not even beginners. <br><a name="habracut"></a><br><h4>  Design and concepts </h4><br>  In the text, the concepts ‚Äúcontroller‚Äù and ‚Äúmodel‚Äù will appear in two contexts: MVC and Yii, pay attention to this.  In non-obvious places, I will explain what context I use. <br>  A ‚Äúview‚Äù is a view in the context of MVC. <br>  ‚ÄúView‚Äù is a file from the views folder. <br>  I will highlight patterns in CAPITAL letters. <br><br><h4>  Go! </h4><br><br>  Yii is a very flexible framework.  This makes it possible for some developers not to care about structuring their code, which always leads to a bunch of bugs and complex refactoring.  However, Yii has nothing to do with it - quite often the problems begin with a banal misunderstanding of the MVC principle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, in this post I will look at the basics of MVC, and its C and V in the context of Yii.  The letter M is a separate complex topic that deserves its post.  All code examples will be commonplace, but reflect the essence of the principles. <br><br><h4>  MVC </h4><br>  MVC is a great design principle that helps avoid many problems.  In my opinion, the necessary-sufficient knowledge about this design pattern can be gleaned from becoming on Wikipedia. <br><br>  Unfortunately, I have often seen when the expression ‚ÄúYii is the MVC framework‚Äù was taken too verbatim (that is, M is <code>CModel</code> , C is <code>CController</code> , V is <code>views</code> from the <code>views</code> folder), which leads away from understanding the principle .  This causes a lot of errors, for example, when the controller selects all the necessary data for the view, or when pieces of business logic are carried to the controller. <br><br>  <b>The controller (‚ÄúC‚Äù)</b> is the operational level of the application.  Do not confuse it with the class <code>CContrller</code> .  <code>CContrller</code> has many responsibilities.  In MVC, the concept of "controller" is primarily a <code>CController'</code> action.  In the case of performing any operation on an object, the controller does not need to know exactly how to perform this operation ‚Äî this is the ‚ÄúM‚Äù task.  In the case of the display of an object, it does not need to know how to display an object ‚Äî that is the ‚ÄúV‚Äù task.  In fact, the controller should simply take the desired object (s) and tell it (them) what to do. <br><br>  <b>The model (‚ÄúM‚Äù)</b> is the level of the business logic of the application.  It is dangerous to associate the concept of a model in Yii with the concept of a model in MVC.  A model is not only an entity class (usually <code>CModel</code> ).  This includes, for example, special validators <code>CValidator</code> , or SERVICES (if they reflect business logic), REPOSITORIES, and much more.  The model does not need to know anything about the controllers or displays that use it.  It contains only business logic and nothing else. <br><br>  <b>Presentation ("V")</b> - the display level.  You should not take it as just a php file to display (although, as a rule, it is).  He has his own, sometimes very complicated logic.  And if we need some specific data to display the object, for example, a list of languages ‚Äã‚Äãor something else, this level should request them.  Unfortunately, in Yii, it is impossible to associate a view with any particular class (unless using <code>CWidget</code> , etc.), which would contain the display logic.  But it is easy to implement it yourself (rarely needed, but sometimes it is extremely useful). <br><br>  Yii itself provides us with a luxurious infrastructure for all these three levels. <br><br><h4>  Typical MVC errors </h4><br><br>  I will give a couple of typical mistakes.  These examples are extremely exaggerated, but they reflect the essence.  On the scale of a large application, these errors grow into catastrophic problems. <br><br>  1. Suppose we need to display the user with his posts.  A typical action looks something like this: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionUserView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $user = User::model()-&gt;findByPk($id); $posts = Post::model()-&gt;findAllByAttributes([<span class="hljs-string"><span class="hljs-string">'user_id'</span></span> =&gt; $user-&gt;id]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'userWithPosts'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; $user, <span class="hljs-string"><span class="hljs-string">'posts'</span></span> =&gt; $posts ]); }</code> </pre><br>  Here is a mistake.  The controller does not need to know how the user will be displayed.  He has to find the user, and tell him to "show up with the help of this view."  Here we bring part of the display logic to the controller (namely, the knowledge that it needs posts). <br><br>  The problem is that if you do it like in the example, you can forget about code reuse and catch universal duplication. <br><br>  Wherever we want to use this view, we will have to transfer to it a list of posts, which means we will have to select them everywhere in advance - duplication of code. <br><br>  Also, we will not be able to reuse this action.  If we remove a selection of posts from it, and make the name of the view a parameter (for example, by implementing it as a <code>CAction</code> ), we can use it wherever we need to display a view with user data.  It would look something like this: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'showWithPost'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; UserViewAction::class, <span class="hljs-string"><span class="hljs-string">'view'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'withPost'</span></span> ], <span class="hljs-string"><span class="hljs-string">'showWithoutPost'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; UserViewAction::class, <span class="hljs-string"><span class="hljs-string">'view'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'withoutPost'</span></span> ], <span class="hljs-string"><span class="hljs-string">'showAnythingUserView'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; UserViewAction::class, <span class="hljs-string"><span class="hljs-string">'view'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'anythingUserView'</span></span> ] ]; }</code> </pre><br><br>  If you interfere with the controller and the display - it is not possible. <br><br>  This error creates only duplication of code.  The second error is much more disastrous. <br><br>  2. Suppose we need to translate the news into the archive.  This is done by setting the <code>status</code> field.  We look action: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionArchiveNews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $news = News::model()-&gt;findByPk($id); $news-&gt;status = News::STATUS_ARCHIVE; $news-&gt;save(); }</code> </pre><br><br>  The error of this example is that we transfer the business logic to the controller.  This also leads to the inability to reuse the code (I will explain why below), but this is only a trifle compared to the second problem: what if we change the translation method?  For example, instead of changing the status, we will assign <code>true</code> to the <code>inArchive</code> field?  And this action will be performed in several places of the application?  And this is not news, but a transaction for $ 10 million? <br><br>  In the example, these places are easy to find - just make <code>Find Usage</code> for the <code>STATUS_ARCHIVE</code> constant.  But if you did it with the help of the query <code>"status = 'archive'"</code> - it is much more difficult to find, because even one extra space - and you would not find this line. <br><br>  Business logic must always remain in the model.  Here we should single out a separate method in essence, which translates the news into an archive (or in some other way, but precisely in the layer of business logic).  This example is extremely exaggerated, few make the same mistake. <br><br>  But in the example from the first error there is also this problem, much less obvious: <br><br><pre> <code class="php hljs"> $posts = Post::model()-&gt;findAllByAttributes([<span class="hljs-string"><span class="hljs-string">'user_id'</span></span> =&gt; $user-&gt;id]);</code> </pre><br><br>  Knowing exactly how <code>Post</code> and <code>User</code> are connected is also the business logic of the application.  Therefore, this string should not occur in the controller or in the view.  Here, the correct solution would be to use a relay for a <code>User</code> , or a scop for a <code>Post</code> : <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">//  $posts = $user-&gt;posts; //  $posts = Post::model()-&gt;forUser($user)-&gt;findAll();</span></span></code> </pre><br><br><h4>  Magic caction </h4><br>  Controllers (in MVC terminology, in Yii terminology, actions) are the most reusable part of the application.  They carry almost no application logic.  In most cases, they can be safely copied from project to project. <br><br>  Let's see how you can implement the <code>UserViewAction</code> from the examples above: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserViewAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string view for render */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $view; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $id string user id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CHttpException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $user = User::model()-&gt;findByPk($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$user) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(HttpResponse::STATUS_NOT_FOUND, <span class="hljs-string"><span class="hljs-string">"User not found"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;render(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view, $user); } }</code> </pre><br><br>  Now we can ask any view in the action config.  This is a good example of reuse code, but it is not perfect.  We modify the code so that it works not only with the <code>User</code> model, but with any successor of <code>CActiveRecord</code> : <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelViewAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string model class for action */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $modelClass; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string view for render */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $view; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $id string model id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CHttpException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $model = CActiveRecord::model(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelClass)-&gt;findByPk($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$model) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(HttpResponse::STATUS_NOT_FOUND, <span class="hljs-string"><span class="hljs-string">"{$this-&gt;modelClass} not found"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;render(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view, $model); } }</code> </pre><br><br>  In essence, we simply replaced the hard-coded <code>User</code> class with the configurable property <code>$modelClass</code> As a result, we have an action that can be used to output any model using any view. <br><br>  At first glance, it is not flexible, but this is just an example for understanding the general principle.  PHP is a very flexible language, and it gives us room for creativity: <br><br><ul><li>  in the <code>$view</code> property we can pass not a string, but an anonymous function that returns the name of the view.  In an action check: if a line is in the <code>$view</code> , then this is a <code>$view</code> , if <code>callable</code> , then call it and get a view. </li><li>  make the <code>renderPartial</code> property <code>renderPartial</code> and render using it if necessary </li><li>  check the title on <code>Accept</code> : if <code>html</code> - render the view, if json - give <code>json</code> </li><li>  many many other things </li></ul><br><br>  Such actions can be written for almost any action: CRUD, validation, execution of business operations, work with related objects, etc. <br><br>  In fact, it is enough to write about 30-40 such actions, which will cover 90% of the controller code (of course, if you share a model, a view and a controller).  The most pleasant plus, of course, is a reduction in the number of bugs, because much less code + easier to write tests + when the action is used in a hundred places, they pop up much faster. <br><br><h4>  Example action for Update </h4><br>  I will give a couple of examples.  Here's an action on update <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ARUpdateAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string update view */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $view = <span class="hljs-string"><span class="hljs-string">'update'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $modelClass; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string model scenario */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $modelScenario = <span class="hljs-string"><span class="hljs-string">'update'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string|array url for return after success update */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $returnUrl; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $id string|int|array model id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CHttpException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $model = CActiveRecord::model(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelClass)-&gt;findByPk($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($model === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(HttpResponse::STATUS_NOT_FOUND, <span class="hljs-string"><span class="hljs-string">"{$this-&gt;modelClass} not found"</span></span>); $model-&gt;setScenario(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelScenario); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($data = Yii::app()-&gt;request-&gt;getDataForModel($model)) { $model-&gt;setAttributes($data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($model-&gt;save()) Yii::app()-&gt;request-&gt;redirect(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;returnUrl); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Yii::app()-&gt;response-&gt;setStatus(HttpResponse::STATUS_UNVALIDATE_DATA); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;render(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view, $model); } }</code> </pre><br><br>  I took his code from CRUD gii, and reworked it a bit.  In addition to introducing the <code>$modelClass</code> property for reusability, it is complemented by several other important points: <br><br><ul><li>  Setting the <code>scenario</code> for the model.  This is a crucial point that many people forget.  The model should know what they are going to do with it!  In more detail about it I will write in the following post devoted to models. </li><li>  Receiving data is not from <code>$_POST</code> , but using <code>Yii::app()-&gt;request-&gt;getDataForModel($model)</code> , because the data can come in <code>json</code> format, or in some other way.  Knowledge of the format in which data arrives and how to parse them correctly is not a controller task, it is an infrastructure task, in this case <code>HttpRequest</code> . </li><li>  In the case of non-validation (which is in the save method), <code>http</code> status <code>STATUS_UNVALIDATE_DATA</code> .  It is very important.  In the standard version, the code would return status <code>200</code> - which means ‚Äúeverything is fine‚Äù.  But this is not so!  If, for example, the client determines the success of the operation on the <code>http</code> status, then this caused problems.  And since we do not know exactly how the client will work, you need to follow all <code>http</code> protocol rules. </li></ul><br><br>  Naturally, this controller is much simpler than real: <br><br><ul><li>  <code>$view</code> and <code>$retrunUrl</code> are just strings (for flexibility, it is better to make <code>string|callable</code> ) </li><li>  the <code>Accept</code> header is not checked in order to understand how to display the data and whether to redirect or simply output <code>json</code> </li><li>  Hard preset model method to save.  For example, it would be more flexible to do this: <code>$model-&gt;{$this-&gt;updateMethod}()</code> </li><li>  much more </li></ul><br><br>  One more important point which is omitted here is the reduction of the input data to the required types.  Now the data is usually sent to <code>json</code> , which partially facilitates the task.  But the problem still remains, for example, if the client sends a <code>timestamp</code> , and in the model - <code>MongoDate</code> .  Providing the model with the correct data is definitely the controller's task.  But the information about which types of fields are the knowledge of the model class. <br><br>  In my opinion, the best place to perform a cast is the <code>Yii::app()-&gt;request-&gt;getDataForModel($model)</code> method.  You can get field types in several ways, for me the most attractive ones are: <br><br><ul><li>  If we have <code>AR</code> , then we can get this information from the table schema. </li><li>  Make the model <code>getAttributesTypes</code> in the model, which will return information about the types. </li><li>  Reflection, namely, getting a list of attributes using <code>CModel::getAttributeNames</code> , then traversing them with reflection to parse a comment to the field and calculate the type, saving it to the cache.  Unfortunately, there are no normal annotations in php, so this is a rather controversial way.  But he gets rid of writing the routine. </li></ul><br><br>  In any case, we can make the interface <code>IAttributesTypes</code> where we define the <code>getAttributesTypes</code> method, and declare the <code>HttpRequest::getDataForModel</code> as <code>public getDataForModel(IAttributesTypes $model)</code> .  And let each class itself determine how to implement the interface. <br><br><h4>  Example action for List </h4><br>  Perhaps this is the most difficult example, I will give it to show the division of responsibilities between classes: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MongoListAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string view for action */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $view = <span class="hljs-string"><span class="hljs-string">'list'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array|EMongoCriteria predefined criteria */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $criteria = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $modelClass; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string scenario for models */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $modelScenario = <span class="hljs-string"><span class="hljs-string">'list'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array dataProvider config */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $dataProviderConfig = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string dataProvuder class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $dataProviderClass = <span class="hljs-string"><span class="hljs-string">'EMongoDocumentDataProvider'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string filter class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $filterClass; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string filter scenario */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $filterScenario = <span class="hljs-string"><span class="hljs-string">'search'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//            /** @var $filter EMongoDocument */ $filterClass = $this-&gt;filterClass ? $this-&gt;filterClass : $this-&gt;modelClass; $filter = new $filterClass($this-&gt;filterScenario); $filter-&gt;unsetAttributes(); if($data = Yii::app()-&gt;request-&gt;getDataForModel($filter)) $filter-&gt;setAttributes($data); $filter-&gt;search(); //    ,            //        $filter-&gt;getDbCriteria()-&gt;mergeWith($this-&gt;criteria); //    .     yiimongodbsuite     //    (   - ) /** @var $dataProvider EMongoDocumentDataProvider */ $dataProviderClass = $this-&gt;dataProviderClass; $dataProvider = new $dataProviderClass($filter, $this-&gt;dataProviderConfig); //     .    ,         self::setScenario($dataProvider-&gt;getData(), $this-&gt;modelScenario); //   $this-&gt;controller-&gt;render($this-&gt;view, [ 'dataProvider' =&gt; $dataProvider, 'filter' =&gt; $filter ]); } }</span></span></code> </pre><br><br>  And an example of its use, displaying inactive users: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'unactive'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; MongoListAction::class, <span class="hljs-string"><span class="hljs-string">'modelClass'</span></span> =&gt; User::class, <span class="hljs-string"><span class="hljs-string">'criteria'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'scope'</span></span> =&gt; User::SCOPE_UNACTIVE], <span class="hljs-string"><span class="hljs-string">'dataProviderClass'</span></span> =&gt; UserDataProvider::class ], ]; }</code> </pre><br><br>  The logic of the work is simple: we get the filtering criterion, make the data provider, and output. <br><br>  <b>Filter:</b> <br><br>  For simple filtering by attribute value, it is enough to use a model of the same class.  But usually, filtering is much more complicated - it can have its own very complex logic, which may well make a bunch of queries to the database or something else.  Therefore, it is sometimes reasonable to inherit the filter class from the model, and implement this logic there. <br><br>  But the only purpose of the filter is to get the criteria for the selection.  The implementation of the filter in the example is not entirely successful.  The fact is that despite the ability to set a filter class (using <code>$filterClass</code> ), it still implies that it will be a <code>Model</code> .  This is evidenced by calling the methods <code>$filter-&gt;unsetAttributes()</code> and <code>$filter-&gt;search()</code> , which are inherent in models. <br><br>  The only thing you need to filter is to receive input data and give <code>EMongoCriteria</code> .  It just has to implement this interface: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMongoDataFilter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFilterAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> EMongoCriteria */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilterCriteria</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br><br>  I inserted <code>Filter</code> in the method names in order not to depend on the declaration of the <code>setAttributes</code> and <code>getDbCriteria</code> in the implementation class.  To use the model as a filter, it is best to write a simple treit: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> MongoDataFilterTrait { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFilterAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;unsetAttributes(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setAttrubites($data); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> EMongoCriteria */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilterCriteria</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validate()) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDbCriteria(); } }</code> </pre><br><br>  <code>IMongoDataFilter</code> action to use the interface, we could use any class that implements the <code>IMongoDataFilter</code> interface, <code>IMongoDataFilter</code> it is a model or something else. <br><br>  <b>Data provider:</b> <br>  All that concerns the logic of sampling the necessary data - the data provider is responsible for this.  Sometimes it also contains quite complex logic, so it makes sense to configure its class using <code>$dataProviderClass</code> . <br><br>  For example, in the case of the <code>yiimongodbsuite</code> extension, in which there is no possibility to describe relays, we need to load them manually.  (in fact, it is better to add this extension, but the example is good). <br><br>  The load logic can be placed in some class repository, but if it is the responsibility of a particular data provider to return data along with relays, it is the data provider that should call the repository handler method.  About reusability data providers, I will write below. <br><br><h4>  Criteria in the use of action: </h4><br>  I want to once again draw attention to the most "bug-generating" problem: <br><br>  Knowing who to display (in this case, inactive users) is the knowledge of the controller.  But the knowledge of what criterion determines the inactive user is the knowledge of the model. <br><br>  In the example of using the action, everything is done correctly.  With the help of the scoup, we indicated who we want to withdraw, but the scop itself is in the model. <br><br>  In fact, skoup is a ‚Äúpiece‚Äù of SPECIFICATION.  You can easily rewrite the action to work with specifications.  Although, it is claimed only in complex applications.  In most cases, skoup - the perfect solution. <br><br><h4>  About the separation of the controller and presentation: </h4><br>  Sometimes completely separate the view from the controller is impractical.  For example, if for listing the list we need only a few attributes of the model, it‚Äôs foolish to select the whole document.  But these are features of specific actions that are configured using configuration (in this case, the task of <code>select</code> the criterion).  The most important thing is that we learned these settings from the action code, making them reusable. <br><br><br><h4>  A bunch of action with the model class </h4><br>  In most cases, the controller (namely <code>CController</code> ) works with one class (for example, with <code>User</code> ).  In this case, there is no special need for each action to specify the class of the model - it is easier to specify it in the controller.  But in action, this opportunity must be left. <br>  To resolve this situation, in an action you need to register a getter and a setter for $ modelClass.  The getter will look like this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getModelClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_modelClass === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> IModelController &amp;&amp; ($modelClass = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;getModelClass())) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_modelClass = $modelClass; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CException(<span class="hljs-string"><span class="hljs-string">'Model class must be setted'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_modelClass; }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In principle, you can even make the controller blank for a standard CRUD: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Class BaseARController */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseARController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IModelController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getModelClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array default actions */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'list'</span></span> =&gt; ARListAction::class, <span class="hljs-string"><span class="hljs-string">'view'</span></span> =&gt; ARViewAction::class, <span class="hljs-string"><span class="hljs-string">'create'</span></span> =&gt; ARCreateAction::class, <span class="hljs-string"><span class="hljs-string">'update'</span></span> =&gt; ARUpdateAction::class, <span class="hljs-string"><span class="hljs-string">'delete'</span></span> =&gt; ARDeleteAction::class, ]; } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we can do a CRUD controller in several lines: </font></font><br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseARController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string model class */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getModelClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> User::class; } }</code> </pre><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Total controllers </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A large set of customizable actions reduces code duplication. </font><font style="vertical-align: inherit;">If you divide the classes of actions into a clear structure (for example, an action on editing </font></font><code>CActiveRecord</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>EMongoDocument</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">differ only in the way the objects are selected), duplication can be practically avoided. </font><font style="vertical-align: inherit;">Such code is much easier to refactor. </font><font style="vertical-align: inherit;">And it‚Äôs harder to make a bug. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, such actions can not cover absolutely all needs. </font><font style="vertical-align: inherit;">But a significant part of them is definitely yes.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Representation </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yii gives us a great infrastructure for building it. This </font></font><code>CWidget</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>CGridColumn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>CGridView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Menu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and more. Do not be afraid to use it all, expand, rewrite. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is all easily studied by reading the documentation, but I want to explain something else. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I mentioned above that the controller should not know exactly how the entity will be displayed, so it should not contain code for fetching data for views. I am well aware that this statement will cause a lot of protests - everyone always prepares the data in the controllers. Even Yii himself hints to us that the controller and the view are connected, passing the copy of the controller as a view </font></font><code>$this</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br>  But it is not.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the controller side, the benefits of getting rid of high coherence with views are obvious. </font><font style="vertical-align: inherit;">But what to do with the views? </font><font style="vertical-align: inherit;">I will answer this question here. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will consider two common cases: the presentation of an entity with related data, and the presentation of a list of entities. </font><font style="vertical-align: inherit;">Examples are trivial, but the essence will be explained. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose we have an online store. </font><font style="vertical-align: inherit;">There is a client (model </font></font><code>Client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), his address (model </font></font><code>Address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and orders (model </font></font><code>Order</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">One client can have one address and many orders.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Representation of an entity with related data </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose we need to display information about the client, his address, and a list of his orders. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In essence, each view has its own ‚Äúinterface‚Äù. This is the data transferred to it from </font></font><code>CController::render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the controller instance itself (accessible by </font></font><code>$this</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The less data is transferred to it - the better, because the more it is independent. This approach will make the view reusable within the project. Especially considering that views in Yii are quietly invested in each other, and can even ‚Äúcommunicate‚Äù with each other, for example, with the help </font></font><code>CController::$clips</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The necessary data to display our view is the client object. Having it, we calmly get all the other data.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is necessary to retreat and pay attention to the letter "M" of </font></font><code>MVC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each subject area has its own essence and connections between them. </font><font style="vertical-align: inherit;">And it is very important that our code displays them as identically as possible. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our store, the customer owns both the address and the order. </font><font style="vertical-align: inherit;">This means that in the model </font></font><code>Clients</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we have to explicitly display these relationships using properties </font></font><code>$client-&gt;adress</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or methods.</font></font><code>$client-&gt;getOrders()</code> <br>  It is very important.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will tell you more about this in the next post. </font></font></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the domain is properly designed, we will always have an easy way to get the related data. </font><font style="vertical-align: inherit;">And it absolutely solves the problem with the fact that the controller did not give us a list of orders. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, the output code is as simple as possible:</font></font><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.CDetailView'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $client, <span class="hljs-string"><span class="hljs-string">'attributes'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'fio'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'address.city'</span></span>, <span class="hljs-string"><span class="hljs-string">'adress.street'</span></span> ] ]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($client-&gt;orders <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $order) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.CDetailView'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'model'</span></span> =&gt; $order, <span class="hljs-string"><span class="hljs-string">'attributes'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'sum'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>, ] ]); }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If we decide to divide this view so that we can use its parts independently, then the code will be like this: </font></font><br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;renderPartial(<span class="hljs-string"><span class="hljs-string">'_client'</span></span>, $client); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;renderPartial(<span class="hljs-string"><span class="hljs-string">'_address'</span></span>, $client-&gt;address); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;renderPartial(<span class="hljs-string"><span class="hljs-string">'_orders'</span></span>, $client-&gt;orders);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code is simple, but has a flaw - if the client has many orders, you need to output it with pagination. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No one bothers to push us all this in the date of the provider. </font><font style="vertical-align: inherit;">Suppose a model </font></font><code>Order</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a mongo document. </font><font style="vertical-align: inherit;">Will wrap in </font></font><code>EMongoDocumentDataProvider</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EMongoDocumentDataProvider((<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order())-&gt;forClient($client)), <span class="hljs-string"><span class="hljs-string">'columns'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'sum'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>] ]);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a data provider in a view is somewhat unusual. </font><font style="vertical-align: inherit;">But in fact, everything is in place here: the controller has already fulfilled its responsibilities, knowledge of how related </font></font><code>Client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">located in the subject area (thanks to scopes </font></font><code>forClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), and knowledge of how to display data are in the view. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, some of my colleagues, seeing this, twisted at the temple - creating a data provider in a view - what kind of nonsense? </font><font style="vertical-align: inherit;">At the same time, they themselves performed similar actions in widgets, not realizing that the widget is, first of all, the presentation infrastructure.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A widget is a great tool for creating a reusable and flexible presentation, as well as a logical distinction. </font><font style="vertical-align: inherit;">But its purpose is a representation, so there is no conceptual difference where the above code is located - in the widget or in the view.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Entity List View </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The representation of the list of entities differs from the representation of a specific entity only in the selection of data. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose that </font></font><code>Client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Order</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are three different collections in </font></font><code>MongoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In the case of withdrawal of a single client, we can easily call </font></font><code>$client-&gt;address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This will make a query to the database, but it is inevitable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we select 100 clients, and for each call </font></font><code>$client-&gt;address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will receive 100 queries to the database - this is unacceptable. Download addresses for all customers at once. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we used </font></font><code>AR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we would describe relays, and use them in the action criteria. But with </font></font><code>MongoDB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(more precisely, with the extension </font></font><code>yiimongodbsuite</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) it will not work.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The best place to implement a sample of additional data is the data provider. </font><font style="vertical-align: inherit;">It, as an object intended for data sampling, must know what data it should return and how to select it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done somehow like this:</font></font><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientsDataProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EMongoDocumentDataProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> bool $refresh * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($refresh=false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || $refresh) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fetchData(); <span class="hljs-comment"><span class="hljs-comment">//   id  $addressIds = []; foreach($this-&gt;_data as $client) $addressIds[] = $client-&gt;addressId; //   $adresses = Address::model()-&gt;findAllByPk($addressIds); ...          .... } return $this-&gt;_data; } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are 2 problems here: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it contains knowledge of the subject area </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> address upload code is not reusable </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The solution is to move the load code to the repository, which can be the model class itself. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we move it there, our data provider will look like this:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientsDataProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EMongoDocumentDataProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> bool $refresh * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($refresh=false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || $refresh) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fetchData(); Client::loadAddresses(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data; } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now everything is in place. </font></font><br><br><blockquote>   ¬´¬ª: <br>         <code>Client</code> ,   <code>Address</code> .    ,     Client.           .   ,      ,   ,   ‚Äî   -.        ,  .      <code>Client</code> ,      .    . <br></blockquote><br><br><h4>  - </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data providers are also reusable (as part of the application). </font><font style="vertical-align: inherit;">Suppose we have 2 actions: displaying a list of orders, and the above user page, where the list of orders is also displayed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In both cases, we can use the same data provider, which will load us with the necessary data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I also see no reason not to make them configurable.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Controller as $ this in views </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In my opinion, this is a mistake. Of course, a class </font></font><code>CController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performs many actions unrelated to its conceptual purpose. But nevertheless in his views, his immediate presence creates confusion. I have seen many times (yes, to confess, and I did it myself), as the presentation logic was carried to the controller (some special methods for formatting or something like that) only because the controller was present in all its views. It is not right. A view must be represented by its own separate class.</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All examples are greatly simplified. The real class of controllers, the structure of the models are much larger. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is too complicated and confusing - many will think so. Many, having sat down to work for a similar code, without having understood the structure, will simply cut it out and write ‚Äúby simple‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is quite understandable - I just described the interaction of several classes - and already a wild confusion, the simplest implementation code scattered around a bunch of files. But in reality it is a clear and logical structure of classes in which each line is exactly in its place. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps a small project will destroy such an approach. On writing of one infrastructure rather decent time is necessary. But for the big one, this is the only chance to survive.</font></font><br><br><h4>  Afterword </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that the post is called "how to do it right", it does not pretend to be correct. </font><font style="vertical-align: inherit;">I myself do not know how to. </font><font style="vertical-align: inherit;">He is an attempt to convey that we need a more intelligent approach to the design of classes and their interaction. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP developers gave us a powerful language. </font><font style="vertical-align: inherit;">The developers of Yii gave us a great framework. </font><font style="vertical-align: inherit;">But look around - representatives of other languages ‚Äã‚Äãand frameworks consider us to be bylocloders. </font><font style="vertical-align: inherit;">PHP and Yii - we disgrace them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With our negligent attitude to design, the banal ignorance of the basic principles of MVC, object-oriented design, the language in which we write, and the framework that we use - all this we bring PHP. </font><font style="vertical-align: inherit;">We let Yii down. </font><font style="vertical-align: inherit;">We bring the companies we work for and who provide us. </font><font style="vertical-align: inherit;">But most importantly - we let ourselves down.</font></font><br><br>  Think about it. <br><br>  All good. </div><p>Source: <a href="https://habr.com/ru/post/211739/">https://habr.com/ru/post/211739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211727/index.html">LibRaw, Coverity SCAN, PVS-Studio</a></li>
<li><a href="../211729/index.html">Exit school of programming: what can be done with students in three days in a dark forest</a></li>
<li><a href="../211731/index.html">Wozniak: Apple needs to make a smartphone on Android</a></li>
<li><a href="../211733/index.html">Poll. How do you deploy the production server (s)?</a></li>
<li><a href="../211735/index.html">Decreased SharePoint performance while increasing unique Security Scopes on large lists</a></li>
<li><a href="../211741/index.html">6 things that Satya Nadella has to do right now</a></li>
<li><a href="../211743/index.html">Using CRTP Pattern in C #</a></li>
<li><a href="../211747/index.html">Do you know arrays?</a></li>
<li><a href="../211751/index.html">Just about make</a></li>
<li><a href="../211755/index.html">Bacula: for those who need to quickly and in pictures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>