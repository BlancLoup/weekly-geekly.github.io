<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Text at any cost: WCBFF and DOC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A bit later than we wanted, but we continue our conversation about getting text from different data formats. We already got acquainted with how to wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Text at any cost: WCBFF and DOC</h1><div class="post__text post__text-html js-mediator-article"> A bit later than we wanted, but we continue our conversation about getting text from different data formats.  We already got acquainted with how to work with initially XML-base files (docx and odt), read the text from pdf, convert the contents of rtf to plain-text.  We now turn to the yummy and sweet - DOC format. <a name="habracut"></a><br><br>  Before the attentive reader asks about the strange abbreviation in the title, I still ask to look at the contents of some doc file: <br><br><img src="https://habrastorage.org/storage2/bac/47f/6a9/bac47f6a9d200af82514c146d1f2294f.gif">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I think that many of us, at the dawn of their computer literacy, tried to open doc-files with a notebook and saw similar crackers.  But let us ask ourselves the question: what can we take out of this mess of bytes, which is nothing else but the same ‚ÄúSail‚Äù?  The most interesting thing for us here is the first eight bytes that will come across from file to file, namely, <code>"D0 CF 11 E0 A1 B1 1A E1"</code> in hexes, or <code>"–é¬±"</code> , if you wish <code>"–é¬±"</code> in a notebook. <br><br>  Now it‚Äôs worth decoding the second abbreviation in the title.  WCBFF is nothing more than the <i>Windows Compound Binary File Format</i> , which in Russian sounds like " <a href="http://translate.google.com/translate_t%3Fhl%3Dru">Windows Compound Binary Files Format</a> ."  Let's leave the translation on the conscience of the corporation and think about how this format with a terrible name will help us. <br><br>  So, CFB is the progenitor, or, even more correctly, the skeleton for all Microsoft Office formats from version 97 to 2007 (when saved in compatibility format).  This CFB is used not only to store Word text, but also to save Excel sheets or PowerPoint presentations.  As a result, we will have to read the backbone that is ‚Äúencrypted‚Äù in CFB, and only then find the text in the read data, taking into account the DOC format. <br><br><h4>  CFB or small file system </h4><br>  The first stage, as I said, will be reading CFB.  CFB represents a file structure in miniature: with sectors, root directories and some similarity of files.  Even the problems with this file are the same as with ordinary filesystems - the fragmentation of sectors, for example.  Therefore, without knowing the structure of the format, this file will not be easy to read - thanks to Microsoft, for a couple of years, I opened the documentation on both CFB and all other add-on formats. <br><br>  Let's try to understand how the information is packaged in CFB files.  The entire file is divided into sectors - 512 bytes each (in the new, fourth, version, the sector size can be 4096 bytes).  In the first sector is the header of the file, a piece of which we saw in the screenshot above.  It (the header) contains all the information about how, what and in what sequence to read from the file. <br><br>  The data in the file is stored in segments (FAT) in the very 512 bytes.  If there is not enough space in the sector segment, the remaining data is transferred to the next one along the chain.  Chain sectors can be scattered across a file (i.e., a file can be fragmented, as noted above).  To maintain the integrity of the chain of sectors, there are special sectors that contain which sector to move from the current one if all data is not read.  The end of the chain is characterized by the special word <code>ENDOFCHAIN = 0xFFFFFFFE</code> . <br><br>  Due to the fact that for some data 512 bytes can be very much, there are "miniature" sectors, called mini FAT.  The mini FAT sector has a length of 64 bytes, so 8 (or 64) such small segments can fit into one FAT sector.  The choice towards FAT or mini FAT is made on the basis of the full length of the current data.  If it is less than 4096 bytes (one of the file header parameters), then you should use mini FAT, otherwise - FAT. <br><br>  The data in the CFB file is not piled up just like that - it is structured into some tree structure, rooted in the special ‚Äúfile entry‚Äù <code>Root Entry</code> .  Each such entry has a length of 128 bytes (4 or 32 entries fit into one FAT segment) and is characterized by its name, type (storage ‚Äî storage, stream ‚Äî stream, root storage ‚Äî root storage, empty space ‚Äî unused), child and fraternal elements, color in a red-black tree.  In addition, for the threads and the root element, there are parameters such as the offset and the length of the content. <br><br>  Thus, each entry into the file system can be characterized by ‚Äúcontent attached to it‚Äù.  For streams, this will be the data stored in them, for the root element, the mini FAT file. <br><br>  In addition, the file has a structure called DIFAT, which stores references to sectors with chains of FAT sequences.  The first 109 DIFAT links are located at the end of the file header and can ‚Äúserve‚Äù files up to 8.5 MB in length, if this is not enough, then the header may contain links to an additional DIFAT sector, which can end with a link to the next DIFAT and so on. <br><br>  This information briefly describes all the confusion and vacillation that is going on in the CFB files.  The format, in principle, is fairly well documented (links, as usual, at the end of the topic), it is enough to read manuals carefully and thoughtfully.  The purpose of this article I did not put a full explanation of the work of CFB-files, so let's move on to the main thing - how to read the doc from all this ... <br><br><h4>  Doc or they stole my offsets </h4><br>  To begin with, I will say that I wrote the doc parsing (along with cfb) only on the third attempt.  Before that, something somewhere was somehow not read.  And the reason is that everything had to be done according to the documentation, but ... if it‚Äôs not a big problem with CFB (except English, as the language of the manual), then with DOC problems are provided. <br><br>  Let's start with the fact that we have read the file system of our DOC and we are eager to find text data in it.  Well, Microsoft, who opened the specification, gave us a gift and made it possible to do it.  To do this, we will work with only two entries in the tree structure of the CFB-file elements: this is a stream called ‚Äú <code>WordDocument</code> ‚Äù and a stream called ‚Äú <code>0Table</code> ‚Äù or ‚Äú <code>1Table</code> ‚Äù, depending on the situation. <br><br>  In the first thread is the text of the Word document, but just do not get it.  Everything is awful binary, and everything else in Unicode encoding with inverse byte order (as in all CFB files, it's worth noting).  In this regard, for the beginning we will read several fields from the FIB - <i>File Information Block</i> - which lies at the beginning of the WordDocument stream and is filled from version to version (in 97 Word, this header occupied about 700 bytes, in 2007 <sup>it</sup> was already more than 2000) . <br><br>  First of all, we will read the word at offset <code>0x000A</code> , in which we will find <code>0x0200</code> bits, the unit of which will tell us that we will deal with the table <code>1Table</code> , and zero - with <code>0Table</code> .  It is worth noting that I came across files with both tables, so the bit will have to be read anyway. <br><br>  Next, we need to find the CLX - the most <del>  asshole </del>  an important part of one of the previously selected plates.  This <code>CompLeX</code> structure stores offsets and lengths of text data sequences in a WordDocument stream.  The length and offset to CLX are in <code>0x01A2</code> and <code>0x01A6</code> FORD DWORD'ah "documentary flow."  After receiving this information, we read the CLX from the table flow and run into the gag ... <br><br>  The fact is that CLX contains two completely different data structures of variable size - the RgPrc and the important PlcPcd, which we do not need.  The fact is that the length of PgPrc can be either zero or any.  Fortunately, the documentation does not say how to cut the first data from the second, so in the final code I had to write some kind of crutch, which, oddly enough, works. <br><br>  After getting PlcPcd or, to be more adequate in the names of the Piece Table, we can split this array into two: the array cp is the length of the text pieces ( <code>lcb <sub>i</sub> = cp <sub>i+1</sub> - cp <sub>i</sub></code> ) and pcd (piece descriptors).  Each of the latter contains information about the displacement in the WordDocument-stream and the characteristic of <code>fCompress</code> - is this piece compressed in Unicode, or is it ANSI (Windows-1252). <br><br>  Some control characters can be found in the received pieces, for example, the insertion of an object or an image.  In my code, some of them are deleted, I leave the parsing of the other special characters to the reader. <br><br><h4>  Code option </h4><br>  Well, as usual at the end, a piece of code and links to the sources: <br><blockquote><ol><li>  <font color="#000000">class</font> doc <font color="#000000">extends</font> cfb <font color="#009900">{</font> </li><li>  <font color="#000000">public</font> <font color="#000000">function</font> parse <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  parent <font color="#339933">::</font> <font color="#004000">parse</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ wdStreamID</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getStreamIdByName</font> <font color="#009900">(</font> <font color="#0000ff">"WordDocument"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ wdStreamID</font> <font color="#339933">===</font> <font color="#009900">false</font> <font color="#009900">)</font> <font color="#009900">{</font> <font color="#b1b100">return</font> <font color="#009900">false</font> <font color="#339933">;</font>  <font color="#009900">}</font> </li><li></li><li>  <font color="#000088">$ wdStream</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getStreamById</font> <font color="#009900">(</font> <font color="#000088">$ wdStreamID</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ bytes</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getShort</font> <font color="#009900">(</font> <font color="#208080">0x000A</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ fComplex</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#000088">$ bytes</font> <font color="#339933">&amp;</font> <font color="#208080">0x0004</font> <font color="#009900">)</font> <font color="#339933">==</font> <font color="#208080">0x0004</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ fWhichTblStm</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#000088">$ bytes</font> <font color="#339933">&amp;</font> <font color="#208080">0x0200</font> <font color="#009900">)</font> <font color="#339933">==</font> <font color="#208080">0x0200</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ fcClx</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x01A2</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ lcbClx</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x01A6</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ ccpText</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x004C</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpFtn</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0050</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpHdd</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0054</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpMcr</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0058</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpAtn</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x005C</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpEdn</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0060</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpTxbx</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0064</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ ccpHdrTxbx</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#208080">0x0068</font> <font color="#339933">,</font> <font color="#000088">$ wdStream</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ lastCP</font> <font color="#339933">=</font> <font color="#000088">$ ccpFtn</font> <font color="#339933">+</font> <font color="#000088">$ ccpHdd</font> <font color="#339933">+</font> <font color="#000088">$ ccpMcr</font> <font color="#339933">+</font> <font color="#000088">$ ccpAtn</font> <font color="#339933">+</font> <font color="#000088">$ ccpEdn</font> <font color="#339933">+</font> <font color="#000088">$ ccpTxbx</font> <font color="#339933">+</font> <font color="#000088">$ ccpHdrTxbx</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ lastCP</font> <font color="#339933">+ =</font> <font color="#009900">(</font> <font color="#000088">$ lastCP</font> <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#339933">+</font> <font color="#000088">$ ccpText</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ tStreamID</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getStreamIdByName</font> <font color="#009900">(</font> <font color="#990000">intval</font> <font color="#009900">(</font> <font color="#000088">$ fWhichTblStm</font> <font color="#009900">)</font> <font color="#339933">.</font> <font color="#0000ff">"Table"</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ tStreamID</font> <font color="#339933">===</font> <font color="#009900">false</font> <font color="#009900">)</font> <font color="#009900">{</font> <font color="#b1b100">return</font> <font color="#009900">false</font> <font color="#339933">;</font>  <font color="#009900">}</font> </li><li></li><li>  <font color="#000088">$ tStream</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getStreamById</font> <font color="#009900">(</font> <font color="#000088">$ tStreamID</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ clx</font> <font color="#339933">=</font> <font color="#990000">substr</font> <font color="#009900">(</font> <font color="#000088">$ tStream</font> <font color="#339933">,</font> <font color="#000088">$ fcClx</font> <font color="#339933">,</font> <font color="#000088">$ lcbClx</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ lcbPieceTable</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ pieceTable</font> <font color="#339933">=</font> <font color="#0000ff">""</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ pieceCount</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ from</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">while</font> <font color="#009900">(</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#990000">strpos</font> <font color="#009900">(</font> <font color="#000088">$ clx</font> <font color="#339933">,</font> <font color="#990000">chr</font> <font color="#009900">(</font> <font color="#208080">0x02</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#000088">$ from</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">! ==</font> <font color="#009900">false</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000088">$ lcbPieceTable</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">+</font> <font color="#cc66cc">1</font> <font color="#339933">,</font> <font color="#000088">$ clx</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ pieceTable</font> <font color="#339933">=</font> <font color="#990000">substr</font> <font color="#009900">(</font> <font color="#000088">$ clx</font> <font color="#339933">,</font> <font color="#000088">$ i</font> <font color="#339933">+</font> <font color="#cc66cc">5</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">strlen</font> <font color="#009900">(</font> <font color="#000088">$ pieceTable</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#000088">$ lcbPieceTable</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000088">$ from</font> <font color="#339933">=</font> <font color="#000088">$ i</font> <font color="#339933">+</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">continue</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#b1b100">break</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  <font color="#000088">$ cp</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font>  <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">while</font> <font color="#009900">(</font> <font color="#009900">(</font> <font color="#000088">$ cp</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">,</font> <font color="#000088">$ pieceTable</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#000088">$ lastCP</font> <font color="#009900">)</font> </li><li>  <font color="#000088">$ i</font> <font color="#339933">+ =</font> <font color="#cc66cc">4</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ pcd</font> <font color="#339933">=</font> <font color="#990000">str_split</font> <font color="#009900">(</font> <font color="#990000">substr</font> <font color="#009900">(</font> <font color="#000088">$ pieceTable</font> <font color="#339933">,</font> <font color="#000088">$ i</font> <font color="#339933">+</font> <font color="#cc66cc">4</font> <font color="#009900">)</font> <font color="#339933">,</font> <font color="#cc66cc">8</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ text</font> <font color="#339933">=</font> <font color="#0000ff">""</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">for</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">&lt;</font> <font color="#990000">count</font> <font color="#009900">(</font> <font color="#000088">$ pcd</font> <font color="#009900">)</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">++</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000088">$ fcValue</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">getLong</font> <font color="#009900">(</font> <font color="#cc66cc">2</font> <font color="#339933">,</font> <font color="#000088">$ pcd</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ isANSI</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#000088">$ fcValue</font> <font color="#339933">&amp;</font> <font color="#208080">0x40000000</font> <font color="#009900">)</font> <font color="#339933">==</font> <font color="#208080">0x40000000</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ fc</font> <font color="#339933">=</font> <font color="#000088">$ fcValue</font> <font color="#339933">&amp;</font> <font color="#208080">0x3FFFFFFF</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ lcb</font> <font color="#339933">=</font> <font color="#000088">$ cp</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#339933">+</font> <font color="#cc66cc">1</font> <font color="#009900">]</font> <font color="#339933">-</font> <font color="#000088">$ cp</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#009900">]</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#000088">$ isANSI</font> <font color="#009900">)</font> </li><li>  <font color="#000088">$ lcb</font> <font color="#339933">* =</font> <font color="#cc66cc">2</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">else</font> </li><li>  <font color="#000088">$ fc</font> <font color="#339933">/ =</font> <font color="#cc66cc">2</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ part</font> <font color="#339933">=</font> <font color="#990000">substr</font> <font color="#009900">(</font> <font color="#000088">$ wdStream</font> <font color="#339933">,</font> <font color="#000088">$ fc</font> <font color="#339933">,</font> <font color="#000088">$ lcb</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#000088">$ isANSI</font> <font color="#009900">)</font> </li><li>  <font color="#000088">$ part</font> <font color="#339933">=</font> <font color="#000088">$ this</font> <font color="#339933">-&gt;</font> <font color="#004000">unicode_to_utf8</font> <font color="#009900">(</font> <font color="#000088">$ part</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li></li><li>  <font color="#000088">$ text</font> <font color="#339933">. =</font> <font color="#000088">$ part</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li></li><li>  <font color="#b1b100">return</font> <font color="#000088">$ text</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote>  You can get the code with comments on <a href="https://github.com/rembish/TextAtAnyCost">GitHub</a> . <br><br><h4>  Literature </h4><br><ul><li>  <a href="http://download.microsoft.com/download/1/6/f/16f4e321-aa6b-4fa3-8ad3-e94c895a3c97/%255BMS-CFB%255D.pdf">[MS-CFB]: Compound File Binary File Format</a> ; </li><li>  <a href="http://download.microsoft.com/download/0/B/E/0BE8BDD7-E5E8-422A-ABFD-4342ED7AD886/WindowsCompoundBinaryFileFormatSpecification.pdf">Windows Compound Binary File Format Specification</a> ; </li><li>  <a href="http://download.microsoft.com/download/0/B/E/0BE8BDD7-E5E8-422A-ABFD-4342ED7AD886/Word97-2007BinaryFileFormat(doc)Specification.pdf">MICROSOFT OFFICE WORD 97-2007 BINARY FILE FORMAT SPECIFICATION</a> ; </li><li>  <a href="http://download.microsoft.com/download/2/4/8/24862317-78F0-4C4B-B355-C7B2C1D997DB/%255BMS-DOC%255D.pdf">[MS-DOC]: Word Binary File Format (.doc) Structure Specification</a> ; </li><li>  <a href="http://b2xtranslator.sourceforge.net/howtos/How_to_retrieve_text_from_a_binary_doc_file.pdf">How to Retrieve Text from a Binary .doc File</a> . </li></ul>  How not to do: <br><ul><li>  <a href="http://obninsk.name/obninsk_doc/">Option from a certain Max Brown from Obninsk</a> </li></ul>  Links to other articles on the topic "Text at any cost": <br><ul><li>  <a href="http://habrahabr.ru/blogs/php/70119/">Text at any cost: RTF</a> </li><li>  <a href="http://habrahabr.ru/blogs/php/69568/">Text at any cost: PDF</a> </li><li>  <a href="http://habrahabr.ru/blogs/php/69417/">Text at any cost: DOCX and ODT</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/72745/">https://habr.com/ru/post/72745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72731/index.html">DaBase is not another ORM for PHP</a></li>
<li><a href="../72732/index.html">I will give in good hands</a></li>
<li><a href="../72734/index.html">Windows packaging history</a></li>
<li><a href="../72739/index.html">ebay in russian</a></li>
<li><a href="../72740/index.html">Oauth id</a></li>
<li><a href="../72746/index.html">"Slow" sending from a script</a></li>
<li><a href="../72747/index.html">I just posted a picture - you did the rest!</a></li>
<li><a href="../72750/index.html">How to make money on vending machines: laws and taxes</a></li>
<li><a href="../72753/index.html">Barter Startups</a></li>
<li><a href="../72754/index.html">Backup on amazon S3 for beginners</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>