<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weather Station on Arduino from A to Z. Part 5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ending. The previous part . 


 Table of contents: 


- Part 1. Requirements. The choice of iron. General scheme 
- Part 2. Software. Central unit, ir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weather Station on Arduino from A to Z. Part 5</h1><div class="post__text post__text-html js-mediator-article"><p>  Ending.  <a href="https://habr.com/post/425963/">The previous part</a> . </p><br><p>  Table of contents: </p><br><ul><li>  <a href="https://habr.com/post/425901/">Part 1. Requirements.</a>  <a href="https://habr.com/post/425901/">The choice of iron.</a>  <a href="https://habr.com/post/425901/">General scheme</a> </li><li>  <a href="https://habr.com/post/425927/">Part 2. Software.</a>  <a href="https://habr.com/post/425927/">Central unit, iron</a> </li><li>  <a href="https://habr.com/post/425953/">Part 3. Central unit, software</a> </li><li>  <a href="https://habr.com/post/425963/">Part 4. Transom Sensor</a> </li><li>  <a href="https://habr.com/post/426019/">Part 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Window sensor.  Software </h1><br><p>  Let's talk about the software behind the window sensor.  After that you will have a complete system with which you can already experiment. </p><br><p>  Let me remind you that the <em>server</em> is a central, home unit that can communicate with the Internet via WiFi, and the <em>client</em> is a remote, out-of-window sensor that transmits data to the server via radio. </p><br><p>  The source code for both server and client <a href="https://github.com/tim4dev/arduino/tree/master/project/weather-station/">is here</a> . <br>  Source texts are provided with detailed comments. </p><br><p>  Almost nothing needs to be configured on the client. </p><a name="habracut"></a><br><p>  The radio transmitter nRF24L01 +, or rather the RadioHead library, requires specifying the server and client addresses.  Addresses are provided in case you have more than one server and client.  An address is just any integer.  When a client sends a packet with data to the server, it indicates for which server the packet is intended.  The server, knowing its own address, in turn, determines whether this packet is intended for it. </p><br><p> Therefore, <code>SERVER_ADDRESS</code> on the server and on the client must match, but the <code>CLIENT_ADDRESS</code> for different clients must be different.  In other words, if in the future you connect another new sensor to our system, then <code>CLIENT_ADDRESS</code> will need to be changed for it. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  Radio number <code>RF_CHANNEL</code> should be the same for all.  The default is 2. I changed the default number, you can choose any other. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  The settings of the voltmeter to measure the battery supply voltage must be changed: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  To save energy, the <a href="https://github.com/rocketscream/Low-Power">Lightweight low power library for Arduino is used</a> . </p><br><p>  Here are my measurements of actual consumption for the Arduino Pro Mini with this one: </p><br><ul><li>  usually 25mA </li><li>  when working with DHT the same </li><li>  with radio transmission 38 mA </li><li>  with LowPower.idle 15 mA </li><li>  with LowPower.powerDown 7.5 mA </li></ul><br><p>  The client makes measurements of temperature, humidity and voltage, packs it all into a data structure, sends data to the server and ‚Äúfalls asleep‚Äù.  If there were errors during the transfer, then the transfer is immediately repeated. </p><br><p>  The server (central, home unit), in turn, receives data, acknowledges receipt and processes it. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Database, MySQL, PHP, WWW-server </h1><br><p>  After the work done, we have a fully functional construction of the weather station.  But now such meteorological stations are a dime a dozen, local crafts, this is no longer fashionable.  We have the internet of things. </p><br><p>  Therefore, let's talk about how to access these your Internet sites, attach to our weather station a database and a web-face to it. </p><br><p>  Task setting for "webcam": </p><br><ul><li>  receive and store weather station data: temperature, humidity, atmospheric pressure, supply voltage </li><li>  display this data </li><li>  build graphics. </li></ul><br><p>  In this case, we need a hosting with support for Apache, PHP and MySQL with the module mysqli.  And these conditions are satisfied by almost any hosting on planet Earth.  Or, instead of hosting, your computer will play the role of a server, connected to a home network router and having Internet access. </p><br><h2 id="sozdanie-bazy-dannyh">  Database creation </h2><br><p>  Let's start from the very beginning, namely from designing and creating a database. </p><br><p>  The database is your world and you can study it for a long time, so we will only briefly touch on those things that are directly necessary for us. </p><br><p>  All SQL scripts are in the <code>weather-station/server/php-sql/</code> directory </p><br><p>  Where does the design of the database begin?  With a logical and physical representation. </p><br><p>  Logical representation or database schema: </p><br><ul><li>  table with DHT data of temperature and humidity sensor </li><li>  table with BMP data of pressure and temperature sensor </li><li>  The specified tables do not have connections among themselves, more precisely, connections are not needed. </li></ul><br><p>  The physical scheme is based on a specific DBMS and data types.  Easier to sort on a specific example.  The SQL script <code>make_tables.sql</code> reveals the logical and physical schemes. </p><br><p>  Each table should have a type field </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  The field name may differ in different databases, but the meaning is the same - it is a unique identifier, a record key.  For the future, if you see a database in the tables of which there is no such counter, you should know that this database was designed by a person who is very far from programming, most likely a humanist. </p><br><p>  Data from the same type of sensors is stored in one table, for sensors of another type we create another table.  This slightly complicates the database and PHP binding to it, but it simplifies the expansion or modification of the entire system in the future. </p><br><p>  Our project has two tables.  The <code>arduino_dht</code> table stores data from the DHT type sensor (s) (temperature, humidity), and the data from the BMP type sensor (temperature, pressure) is stored in the <code>arduino_bmp</code> table.  If you want to have, for example, a gas sensor or a motion detector in the future, then create additional tables, do not be lazy.  If you connect another sensor like DHT11 or DHT22, then you do not need to create an additional table, use the table <code>arduino_dht</code> .  I hope the principle is clear: a separate physical entity - a separate table. </p><br><p>  If data from several sensors of the same type are stored in the table, how can they be distinguished?  For this, a field is entered in each table. </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  In fact, this is the <code>CLIENT_ADDRESS</code> that we <code>CLIENT_ADDRESS</code> in the <code>client/client.ino</code> for each instance of the remote client sensor and in <code>server/server.ino</code> for the sensor that is connected directly to the server - the central unit. </p><br><p>  In industrial systems, there must be another table ‚Äî the correspondences of <code>idSensor</code> and its verbal, human-readable description.  For example, a sensor with <code>idSensor</code> = 2 is <em>‚ÄúTemperature, humidity in the apartment‚Äù</em> , etc.  But in our project we will not complicate, just remember that: </p><br><ul><li>  the sensor with <code>idSensor</code> , it is <code>CLIENT_ADDRESS</code> , equal to 11 - this is the home sensor on the server - the central unit, </li><li>  The sensor with <code>idSensor</code> , also <code>CLIENT_ADDRESS</code> as <code>CLIENT_ADDRESS</code> , equal to 20 is the first (in our project and the only) remote sensor client. </li></ul><br><p>  Further.  The following data is stored in the tables: </p><br><ul><li>  ipRemote - the IP address of the weather station (server) from which the data came from, useful for debugging and monitoring, </li><li>  dateCreate - the date the record was created, </li><li>  millis - useful for debugging, this time in milliseconds since the start of the sketch on the Arduino, </li><li>  temperature - temperature </li><li>  humidity - humidity </li><li>  voltage - supply voltage </li><li>  pressure - pressure </li><li>  errors - the number of errors (not used).  Conceived to store the number of errors during transmission, etc., so that you can remotely assess the state of the entire system. </li></ul><br><p>  As you can see the tables <code>arduino_dht</code> and <code>arduino_bmp</code> very similar, the only difference is in the fields of pressure and humidity, and there is a desire to dump everything in one pile (table).  But the <a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0">first normal form</a> does not allow it to do so, a lot of novice programmers tried to get around it, but none of them succeeded, and we will not.  This is how not to notice the law of the world, for the time being it may well turn out. </p><br><p>  The <code>arduino_error_log</code> table <code>arduino_error_log</code> useful when debugging - this is a log of errors and other system messages. </p><br><p>  Creating a database and its user with the rights described in <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  This is done once, the database name and user name can come up with your own.  And what exactly needs to be done is to set your password. </p><br><h2 id="php-i-veb-server">  PHP and web server </h2><br><p>  All web interface settings are stored in <code>config.php</code> .  Modify it according to your database settings. </p><br><p>  Set your time zone in PHP format </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  All available <a href="http://php.net/manual/ru/timezones.php">time zones are described here</a> . </p><br><p>  Set your secret key for access (as a number) which must match the <code>SOURCE_KEY</code> constant from the <code>SOURCE_KEY</code> sketch </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  In our web server there is no authorization, login by password, this would complicate the whole structure.  For the prototype, this is not necessary.  Therefore, all protection is based on the <code>robots.txt</code> file, the absence of <code>index.php</code> and this secret key for access. </p><br><p>  The main PHP script, <code>weather.php</code> accepts a simple HTTP GET request with data and stores it in the appropriate database tables.  If the <code>$access_key</code> key <code>$access_key</code> not match, then the request will be rejected. </p><br><p>  The <code>weather-view.php</code> used to view data tables and contains hyperlinks to other web interface scripts.  Call him like this </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  for example </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> displays simple <code>weather-view.php</code> where you need to remember that: </p><br><ul><li>  The sensor with id 11 is the home sensor on the server, </li><li>  The sensor with id 20 is an outside sensor. </li></ul><br><p>  The <code>function.php</code> script contains functions common to all PHP scripts. </p><br><p>  The script <code>chart-dht.php</code> is responsible for drawing charts using <a href="https://developers.google.com/chart/interactive/docs/">Google Charts</a> .  Here, for example, is a graph of the power supply voltage of an out-of-window sensor.  The voltage rises on a sunny day at the expense of the solar battery and then the power supply on batteries gradually discharges. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Schedule"></p><br><p>  <code>export-dht.php</code> exports data from MySQL database tables to a CSV file.  For further import and analysis in spreadsheets. </p><br><p>  <code>export-voltage.php</code> exports the power supply voltage of the window sensor from the MySQL database to a CSV file.  Useful for debugging. </p><br><p>  <code>truncate.php</code> clears all tables, i.e.  deletes all our data.  Useful for debugging.  There are no references to this script from <code>weather-view.php</code> , so you need to call it via a direct link in the address bar of the browser indicating <code>$access_key</code> . </p><br><p>  When receiving data, the <code>mysqli_real_escape_string()</code> function is commonly used to prevent incorrect values ‚Äã‚Äãfrom getting into the database. </p><br><p>  Do not forget to put a <code>robots.txt</code> in the root of your site to prevent it from entering the search engines. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi and data transfer </h1><br><p>  And now we return to the <code>server.ino</code> sketch, to the part that connects to the WiFi access point and sends the data to the web server. </p><br><p>  As I already wrote, I could not find a normal library for Arduino to control the ESP8266 module using AT commands, I had to ‚Äúcollective farm‚Äù myself.  Let me remind you also that you will have to flash the firmware of a certain version in ESP8266-01.  And now that everything is ready, let us analyze how it works. </p><br><p>  To access the web server in a <code>server.ino</code> sketch, <code>server.ino</code> need to change these constants. </p><br><pre> <code class="hljs ruby">const String DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  habr.com const String DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">80</span></span> const String DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; const String SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    $access_key  config.php</code> </pre> <br><p>  In <code>server.ino</code> in the <code>void setup()</code> function, the ESP8266 is first switched to Station mode, i.e.  he starts working as a wifi client </p><br><pre> <code class="hljs lisp">espSendCmd(¬´AT+CWMODE_CUR=1¬ª, ¬´OK¬ª, <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  and then follows the connection to the access point </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  If the connection does not occur, the attempt is repeated (once) </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Then select a single TCP / IP connection mode. </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  When sending data from DHT type sensors to a web server, a function is used indicating the type of data as <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  When sending data from BMP sensors to a web server, the same function is used with the indication of the data <code>type=bmp</code> as <code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  At the input, the <code>espSendData()</code> function takes an HTTP GET request string and sends it to its destination to a web server. </p><br><p>  Inside itself, <code>espSendData()</code> checks the availability of the ESP module by sending it an ‚ÄúAT‚Äù command, then it checks the connection to WiFi and reconnects if necessary.  Then the data is sent and the TCP connection is closed. </p><br><h1 id="android-prilozhenie">  Android app </h1><br><p>  Nowadays, when everyone can already blink an LED, no meteorological station will surprise anyone.  But if the odd job is able to communicate with the server via WiFi, has a web-muzzle and a mobile application, then this is already something!  The server here means of course the application server, i.e.  in our case, this is PHP binding and MySQL.  Not getting the cherries on the cake, namely the application for Android writing of which we now deal with. </p><br><h2 id="arhitektura">  Architecture </h2><br><p>  The architecture of the entire weather station software platform is simple: </p><br><ul><li>  the server part (central unit) of the weather station collects data from remote sensor clients </li><li>  then it also sends data to the web application server, which saves this data to the database </li><li>  An application on Android (or any other remote application: iOS, browser) requests data from the web server and displays it on the screen. </li></ul><br><p>  On the Android device screen, we will display the current, most recent sensor readings. </p><br><h2 id="http-get-i-json">  HTTP GET and JSON </h2><br><p>  The question that needs to be resolved first is how the data will be transferred from the web server to the Android application. </p><br><p>  There is no need to invent anything, everything has already been invented for us - this is HTTP GET and JSON. </p><br><p>  In our case, a simple GET request to the web server can be compiled and debugged manually, while the Android application is not yet ready. </p><br><p>  Java and Android have ready-made libraries for processing data in JSON format.  JSON text format is readable by humans, which is useful for debugging. </p><br><p>  In order to generate the current data from the weather station sensors, create a new <a href="https://github.com/tim4dev/arduino/blob/master/project/weather-station/server/php-sql/last-data-to-json.php">last-data-to-json.php</a> script on the web server on the web server. </p><br><p>  Calling the script: </p><br><pre> <code class="hljs pgsql">http://&lt;&gt;/last-data-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-<span class="hljs-type"><span class="hljs-type">json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  where <code>&lt;access_key&gt;</code> , as we remember, is the secret key to access the database. </p><br><p>  Sample response in JSON format: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  It is necessary to remind that we have 3 sensors.  Their ID and type (DHT or BMP) are hard-coded throughout the weather station code.  This way of hardcore coding is ideologically incorrect, but for a kneeled prototype (where a quick and easy solution is needed) this is a reasonable compromise. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  The <code>last-data-to-json.php</code> takes from the database the latest data from these different types of sensors and packs it in JSON format.  A sample of data from the database "from the end" is performed in this way: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Now we will write a simple application for Android, which requests, receives, decodes JSON-data and displays information on the screen. </p><br><p>  Our Android application will be as simple as possible, only the very essence of the technology.  Further around this "skeleton" it will already be possible to turn various "prettiness". </p><br><p>  Here is a screenshot of what should end up. </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  As you can see, the UI is just spartan, based on LinearLayout, nothing superfluous. </p><br><p>  At the top of the TextView shows the ID of the sensors and their meteorological data.  The ‚ÄúRefresh‚Äù button initiates a repeated request to the web server.  Next in EditText is the only setting of the program - this is the URL of the request </p><br><pre> <code class="hljs pgsql">http://&lt; &gt;/last-data-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-<span class="hljs-type"><span class="hljs-type">json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  What should be noted? </p><br><p>  In the manifest, add lines that allow the Internet and check the status of the network connection: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Working with the network and receiving data from the website is as follows. </p><br><p>  Use AsyncTask to create a background task separately from the main user interface thread.  This background task takes the request URL and uses it to create an <code>HttpURLConnection</code> . </p><br><p>  After the connection is established, AsyncTask loads the contents of the web page (JSON) as an InputStream.  Next, the InputStream is converted to a string, which is decoded using JSONObject and displayed in the user interface by the <code>onPostExecute()</code> method. </p><br><p>  In MainActivity.java, change the URL to your: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  It will be used by default when you first start the Android application. </p><br><h2 id="epilog">  Epilogue </h2><br><p>  Well, something has already earned.  Then you can optimize something, replace something, you can throw everything out, but also borrow something. </p><br><p>  A separate big sore point is <strong>energy consumption</strong> .  I recommend reading comments on posts where there are a lot of practical advice. </p><br><p>  <em>To infinity ... and beyond.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/426019/">https://habr.com/ru/post/426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426001/index.html">MIT course "Computer Systems Security". Lecture 11: Ur / Web Programming Language, part 3</a></li>
<li><a href="../426009/index.html">Epic fail resistance 1 or Lisets crept unnoticed. Testing anonymity and security + VPN for a user</a></li>
<li><a href="../426013/index.html">Career steroids</a></li>
<li><a href="../426015/index.html">The use of sawn civilian drones for professional geodetic aerial photography of the area</a></li>
<li><a href="../426017/index.html">How to reduce the number of experiments on animals</a></li>
<li><a href="../426021/index.html">libGDX and feelings</a></li>
<li><a href="../426023/index.html">Open lesson "Virtual Lab on Vagrant"</a></li>
<li><a href="../426025/index.html">Use offensive techniques to enrich Threat Intelligence</a></li>
<li><a href="../426027/index.html">Amazon Cloud Services and Investment Portfolio Analysis</a></li>
<li><a href="../426029/index.html">Hands down and want to quit the task? This is effective developer training.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>