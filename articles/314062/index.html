<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How the Python parser works, and how to reduce memory consumption by three times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anyone who has studied the programming language device has an idea of ‚Äã‚Äãhow they work: the parser, in accordance with the formal grammar of the PL, tu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How the Python parser works, and how to reduce memory consumption by three times</h1><div class="post__text post__text-html js-mediator-article">  Anyone who has studied the programming language device has an idea of ‚Äã‚Äãhow they work: the parser, in accordance with the formal grammar of the PL, turns the input text into a kind of tree view that the subsequent steps work with (semantic analysis, various transformations and code generation). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fa/0cc/67e/6fa0cc67e4e1575067be71f4dfe10d6d.jpg" width="450" alt="KDPV" title="He is a parseltongue."></div><br>  In Python, everything is a bit more complicated: there are two parsers.  The first parser is guided by the grammar specified in the <code><a href="https://hg.python.org/cpython/file/default/Grammar/Grammar">Grammar/Grammar</a></code> file as regular expressions (with a slightly different syntax).  According to this grammar, during the compilation of <code>python</code> using <code>Parser/pgen</code> , a whole set of <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582"><i>finite state machines is</i></a> generated that recognize the given regular expressions ‚Äî one spacecraft for each nonterminal.  The format of the resulting set of spacecraft is described in <code><a href="">Include/grammar.h</a></code> , and the spacecraft itself is defined in <code><a href="">Python/graminit.c</a></code> , in the form of a global structure <code>_PyParser_Grammar</code> .  Terminal symbols are defined in <code><a href="">Include/token.h</a></code> , and they correspond to the numbers 0..56;  non-terminal numbers start at 256. <br><br>  It is easiest to illustrate the work of the first parser with an example.  Suppose we have a program <code>if 42: print("Hello world")</code> . <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Here is the part of the grammar that corresponds to our program.</b> <div class="spoiler_text"><pre> single_input: NEWLINE |  simple_stmt |  compound_stmt NEWLINE
 compound_stmt: if_stmt |  while_stmt |  for_stmt |  try_stmt |  with_stmt |  funcdef |  classdef |  decorated |  async_stmt
 if_stmt: 'if' test ':' suite ('elif' test ':' suite) * ['else' ':' suite]
 suite: simple_stmt |  NEWLINE INDENT stmt + DEDENT
 simple_stmt: small_stmt (';' small_stmt) * [';'] NEWLINE
 small_stmt: expr_stmt |  del_stmt |  pass_stmt |  flow_stmt |  import_stmt |  global_stmt |  nonlocal_stmt |  assert_stmt
 expr_stmt: testlist_star_expr (annassign | augassign (yield_expr | testlist) | ('=' (yield_expr | testlist_star_expr)) *)
 testlist_star_expr: (test | star_expr) (',' (test | star_expr)) * [',']
 test: or_test ['if' or_test 'else' test] |  lambdef
 or_test: and_test ('or' and_test) *
 and_test: not_test ('and' not_test) *
 not_test: 'not' not_test |  comparison
 comparison: expr (comp_op expr) *
 expr: xor_expr ('|' xor_expr) *
 xor_expr: and_expr ('^' and_expr) *
 and_expr: shift_expr ('&amp;' shift_expr) *
 shift_expr: arith_expr (('&lt;&lt;' | '&gt;&gt;') arith_expr) *
 arith_expr: term (('+' | '-') term) *
 term: factor (('*' | '@' | '/' | '%' | '//') factor) *
 factor: ('+' | '-' | '~') factor |  power
 power: atom_expr ['**' factor]
 atom_expr: [AWAIT] atom trailer *
 atom: '(' [yield_expr | testlist_comp] ')' |  '[' [testlist_comp] ']' |  '{' [dictorsetmaker] '}' |
                     NAME |  NUMBER |  STRING + |  '...' |  'None' |  'True' |  'False'
 trailer: '(' [arglist] ')' |  '[' subscriptlist ']' |  '.'  NAME
 arglist: argument (',' argument) * [',']
 argument: test [comp_for] |  test '=' test |  '**' test |  '*' test
</pre></div></div><br><div class="spoiler">  <b class="spoiler_title">And this is how the parts of the _PyParser_Grammar structure in Python are defined as such:</b> <div class="spoiler_text"><pre> <code class="hljs ruby">static arc arcs_0_<span class="hljs-number"><span class="hljs-number">0</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] = { {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}, }; static arc arcs_0_1[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, }; static arc arcs_0_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, }; static state states_<span class="hljs-number"><span class="hljs-number">0</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] = { {<span class="hljs-number"><span class="hljs-number">3</span></span>, arcs_0_<span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_0_1}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_0_2}, }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... static arc arcs_39_<span class="hljs-number"><span class="hljs-number">0</span></span>[<span class="hljs-number"><span class="hljs-number">9</span></span>] = { {<span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, }; static arc arcs_39_1[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, }; static state states_39[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">9</span></span>, arcs_39_<span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_39_1}, }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... static arc arcs_41_<span class="hljs-number"><span class="hljs-number">0</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, }; static arc arcs_41_1[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}, }; static arc arcs_41_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}, }; static arc arcs_41_3[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, }; static arc arcs_41_4[<span class="hljs-number"><span class="hljs-number">3</span></span>] = { {<span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, }; static arc arcs_41_5[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>}, }; static arc arcs_41_6[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>}, }; static arc arcs_41_7[<span class="hljs-number"><span class="hljs-number">1</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>}, }; static state states_41[<span class="hljs-number"><span class="hljs-number">8</span></span>] = { {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_<span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_1}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_2}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_3}, {<span class="hljs-number"><span class="hljs-number">3</span></span>, arcs_41_4}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_5}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_6}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, arcs_41_7}, }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... static dfa dfas[<span class="hljs-number"><span class="hljs-number">85</span></span>] = { {<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-string"><span class="hljs-string">"single_input"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, states_<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"\004\050\340\000\002\000\000\000\012\076\011\007\262\004\020\002\000\300\220\050\037\102"</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... {<span class="hljs-number"><span class="hljs-number">270</span></span>, <span class="hljs-string"><span class="hljs-string">"simple_stmt"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, states_14, <span class="hljs-string"><span class="hljs-string">"\000\040\200\000\002\000\000\000\012\076\011\007\000\000\020\002\000\300\220\050\037\100"</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... {<span class="hljs-number"><span class="hljs-number">295</span></span>, <span class="hljs-string"><span class="hljs-string">"compound_stmt"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, states_39, <span class="hljs-string"><span class="hljs-string">"\000\010\140\000\000\000\000\000\000\000\000\000\262\004\000\000\000\000\000\000\000\002"</span></span>}, {<span class="hljs-number"><span class="hljs-number">296</span></span>, <span class="hljs-string"><span class="hljs-string">"async_stmt"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, states_4<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"\000\000\040\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"</span></span>}, {<span class="hljs-number"><span class="hljs-number">297</span></span>, <span class="hljs-string"><span class="hljs-string">"if_stmt"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, states_41, <span class="hljs-string"><span class="hljs-string">"\000\000\000\000\000\000\000\000\000\000\000\000\002\000\000\000\000\000\000\000\000\000"</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ^^^ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>... }; static label labels[<span class="hljs-number"><span class="hljs-number">176</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EMPTY"</span></span>}, {<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ‚Ññ<span class="hljs-number"><span class="hljs-number">2</span></span> {<span class="hljs-number"><span class="hljs-number">270</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ‚Ññ<span class="hljs-number"><span class="hljs-number">3</span></span> {<span class="hljs-number"><span class="hljs-number">295</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ‚Ññ<span class="hljs-number"><span class="hljs-number">4</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/... {305, 0}, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ‚Ññ26 {11, 0}, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ‚Ññ27 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... {297, 0}, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ‚Ññ91 {298, 0}, {299, 0}, {300, 0}, {301, 0}, {296, 0}, {1, "if"}, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ‚Ññ97 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... }; grammar _PyParser_Grammar = { 86, dfas, {176, labels}, 256 };</span></span></code> </pre></div></div><br>  (The following description of the operation of the parser would be convenient to follow this listing - for example, by opening it in the adjacent tab.) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The parser starts parsing with the <code>single_input</code> ;  this spacecraft is defined by the <code>states_0</code> array of three states.  Three arcs ( <code>arcs_0_0</code> ) correspond to the initial state, corresponding to the input symbols <code>NEWLINE</code> (label No. 2, symbol No. 4), <code>simple_stmt</code> (label No. 3, symbol No. 270) and <code>compound_stmt</code> (label No. 4, symbol No. 295).  The input terminal <code>"if"</code> (symbol No. 1, label No. 97) is included in the <code>d_first</code> set for <code>compound_stmt</code> , but not for <code>simple_stmt</code> ‚Äî it corresponds to the \ 002 bit in the 13th byte of the set.  (If during parsing it turns out that the next terminal enters the <code>d_first</code> sets for several outgoing arcs at once, then the parser displays a message stating that the grammar is ambiguous and refuses to continue parsing.) So, the parser goes over the <code>{4, 2}</code> arc to the state No. 2, and simultaneously switches to the spacecraft <code>compound_stmt</code> specified by the <code>states_39</code> array.  In this KA, nine arcs go out of the initial state at once ( <code>arcs_39_0</code> );  among them we choose the arc <code>{91, 1}</code> corresponding to the input symbol <code>if_stmt</code> ( <code>if_stmt</code> 297).  The parser goes to the state # 1 and switches to the <code>if_stmt</code> spacecraft specified by the <code>states_41</code> array. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a3/625/d57/0a3625d572034923be735749fcb203c1.png"></div><br>  From the initial state of this spacecraft there is only one arc <code><nobr>{97, 1}</nobr></code> , corresponding to our input terminal <code>"if"</code> .  According to it, the parser goes to the state # 1, from where the single arc <code>{26, 2}</code> , which corresponds to the non-terminal <code>test</code> (# 305), again comes out.  Along this arc, the parser goes to state # 2 and switches to the spacecraft <code>test</code> , and so on.  After a long-long transformation of the number <code>42</code> into a nonterminal <code>test</code> , the parser will return to the state # 2, from which the only arc <code>{27, 3}</code> , corresponding to the <code>COLON</code> terminal (symbol # 11), will continue and will continue to parse the nonterminal <code>if_stmt</code> .  As a result of its parsing, the parser will create a node of a <i>specific syntactic tree</i> ( <code><a href="">node</a></code> structure), which will have node type 297, and four children - types 1 ( <code>NAME</code> ), 305 ( <code>test</code> ), 11 ( <code>COLON</code> ) and 304 ( <code>suite</code> ).  In state # 4, the creation of a node for <code>if_stmt</code> completed, the parser returns to state # 1 of the KA <code>compound_stmt</code> , and the newly created node for <code>if_stmt</code> becomes the only child of the node corresponding to <code>compound_stmt</code> .  The entire QDC of our program will look like the one shown on the right.  Notice how the short program of the seven terminals <code>NAME NUMBER COLON NAME LPAR STRING RPAR</code> turned into a "bamboo" - a huge, almost unbranching parse tree from as many as 64 nodes!  If you count in bytes, then the source program takes 27 bytes, and its QDC is two orders of magnitude more: one and a half kilobytes on a 32-bit system, and three - on a 64-bit one!  (64 nodes of 24 or 48 bytes each).  It is because of the rampant KSD that trying to skip source files of just a few tens of megabytes through <code>python</code> results in a fatal <code>MemoryError</code> . <br><br>  To work with KSD in Python there is a standard <code><a href="https://docs.python.org/3.7/library/parser.html">parser</a></code> module: <br><br><pre> <code class="xml hljs">$ python Python 3.7.0a0 (default:98c078fca8e0, Oct 31 2016, 08:33:23) [GCC 4.7.3] on linux Type "help", "copyright", "credits" or "license" for more information. &gt;&gt;&gt; import parser &gt;&gt;&gt; parser.suite('if 42: print("Hello world")').tolist() [257, [269, [295, [297, [1, 'if'], [305, [309, [310, [311, [312, [315, [316, [317, [318, [319, [320, [321, [322, [323, [324, [2, '42']]]]]]]]]]]]]]]], [11, ':'], [304, [270, [271, [272, [274, [305, [309, [310, [311, [312, [315, [316, [317, [318, [319, [320, [321, [322, [323, [324, [1, 'print']], [326, [7, '('], [334, [335, [305, [309, [310, [311, [312, [315, [316, [317, [318, [319, [320, [321, [322, [323, [324, [3, '"Hello world"']]]]]]]]]]]]]]]]]], [8, ')']]]]]]]]]]]]]]]]]]], [4, '']]]]]], [4, ''], [0, '']] &gt;&gt;&gt;</code> </pre><br>  In its source code ( <code><a href="">Modules/parsermodule.c</a></code> ), there were&gt; 2000 handwritten lines to check the QDC for compliance with the Python grammar, which looked like this: <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/... /</span></span>* simple_stmt <span class="hljs-params"><span class="hljs-params">| compound_stmt * */ static int validate_stmt(node *tree) { int res = (validate_ntype(tree, stmt) &amp;&amp; validate_numnodes(tree, 1, "stmt")); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (res) { tree = CHILD(tree, 0); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (TYPE(tree) == simple_stmt) res = validate_simple_stmt(tree); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> res = validate_compound_stmt(tree); } </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">return</span></span></span><span class="hljs-params"> (res); } static int validate_small_stmt(node *tree) { int nch = NCH(tree); int res = validate_numnodes(tree, 1, "small_stmt"); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (res) { int ntype = TYPE(CHILD(tree, 0)); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> ( (ntype == expr_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == del_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == pass_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == flow_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == import_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == global_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == nonlocal_stmt) |</span></span><span class="hljs-params"><span class="hljs-params">| (ntype == assert_stmt)) res = validate_node(CHILD(tree, 0)); </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> { res = 0; err_string("illegal small_stmt child type"); } } </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (nch == 1) { res = 0; PyErr_Format(parser_error, "Unrecognized child node of small_stmt: %d.", TYPE(CHILD(tree, 0))); } </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">return</span></span></span><span class="hljs-params"> (res); } /* compound_stmt: * if_stmt |</span></span> while_stmt <span class="hljs-params"><span class="hljs-params">| for_stmt |</span></span> try_stmt <span class="hljs-params"><span class="hljs-params">| with_stmt |</span></span> funcdef <span class="hljs-params"><span class="hljs-params">| classdef |</span></span> decorated *<span class="hljs-regexp"><span class="hljs-regexp">/ static int validate_compound_stmt(node *tree) { int res = (validate_ntype(tree, compound_stmt) &amp;&amp; validate_numnodes(tree, 1, "compound_stmt")); int ntype; if (!res) return (0); tree = CHILD(tree, 0); ntype = TYPE(tree); if ( (ntype == if_stmt) || (ntype == while_stmt) || (ntype == for_stmt) || (ntype == try_stmt) || (ntype == with_stmt) || (ntype == funcdef) || (ntype == async_stmt) || (ntype == classdef) || (ntype == decorated)) res = validate_node(tree); else { res = 0; PyErr_Format(parser_error, "Illegal compound statement type: %d.", TYPE(tree)); } return (res); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/...</span></span></code> </pre><br>  It is easy to guess that such a uniform code could be automatically generated by a formal grammar.  It is a little harder to guess that such a code is <b>already</b> generated automatically - this is how the automata used by the first parser work!  Above, I then explained his device in detail in order to explain how, in March of this year, I <a href="http://bugs.python.org/issue26526">proposed</a> replacing all these sheets of handwritten code that need to be edited each time the grammar changes, with a run of all the same automatically generated SCs that are used the parser itself.  This is to <a href="https://habrahabr.ru/post/279093/">talk</a> about whether programmers need to know the algorithms. <br><br>  In June, my patch was accepted, so in Python 3.6+ the above sheets in <code>Modules/parsermodule.c</code> are no longer there, but then there are a few dozen lines of my code. <br><br><hr><br><br>  Working with such a bulky and redundant QDC, as was shown above, is rather inconvenient;  and therefore the second parser ( <code><a href="">Python/ast.c</a></code> ), written entirely by hand, bypasses the CFC and creates an <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE"><i>abstract syntax tree from it</i></a> .  The grammar of the SDA is described in the <code><a href="">Parser/Python.asdl</a></code> ;  for our program, the SDA will be as shown on the right. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4c0/a77/57a/4c0a7757a1214834a006b525fba40178.png"></div><br>  Instead of working with KSD using the <code>parser</code> module, the documentation advises using the <code><a href="https://docs.python.org/3.7/library/ast.html">ast</a></code> module and working with an abstract tree: <br><br><pre> <code class="xml hljs">$ python Python 3.7.0a0 (default:98c078fca8e0, Oct 31 2016, 08:33:23) [GCC 4.7.3] on linux Type "help", "copyright", "credits" or "license" for more information. &gt;&gt;&gt; import ast &gt;&gt;&gt; ast.dump(ast.parse('if 42: print("Hello world")')) "Module(body=[If(test=Num(n=42), body=[Expr(value=Call(func=Name(id='print', ctx=Load()), args=[Str(s='Hello world')], keywords=[]))], orelse=[])])" &gt;&gt;&gt;</code> </pre><br>  As soon as the SDA is created - the CFC is no longer necessary, and all the memory occupied by it is released;  therefore, for a ‚Äúlong-running‚Äù Python program, there is not much value for how much memory the KSD takes.  On the other hand, for large, but ‚Äúquick-firing‚Äù scripts (for example, searching for a value in a huge <code>dict</code> literal), the size of the CFC will determine the memory consumption of the script.  All this in addition to the fact that the size of the KSD determines whether there is enough memory to load and run the program. <br><br>  The need to go through long ‚Äúbamboo branches‚Äù makes the <code>Python/ast.c</code> just disgusting: <br><br><pre> <code class="hljs bash">static expr_ty ast_for_expr(struct compiling *c, const node *n) { //... loop: switch (TYPE(n)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> test_nocond: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TYPE(CHILD(n, 0)) == lambdef || TYPE(CHILD(n, 0)) == lambdef_nocond) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_lambdef(c, CHILD(n, 0)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) &gt; 1) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_ifexpr(c, n); /* Fallthrough */ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> or_test: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> and_test: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) == 1) { n = CHILD(n, 0); goto loop; } //    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> not_test: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) == 1) { n = CHILD(n, 0); goto loop; } //  not_test <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> comparison: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) == 1) { n = CHILD(n, 0); goto loop; } //  comparison <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> star_expr: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_starred(c, n); /* The next five cases all handle BinOps. The main body of code is the same <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>, but the switch turned inside out to reuse the code <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of operator. */ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> xor_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> and_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> shift_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> arith_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> term: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) == 1) { n = CHILD(n, 0); goto loop; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_binop(c, n); // <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> yield_expr:    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> factor: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NCH(n) == 1) { n = CHILD(n, 0); goto loop; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_factor(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> power: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_power(c, n); default: PyErr_Format(PyExc_SystemError, <span class="hljs-string"><span class="hljs-string">"unhandled expr: %d"</span></span>, TYPE(n)); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> NULL; } /* should never get here unless <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> error is <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> */ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> NULL; }</code> </pre><br>  Repeated many times throughout the second parser <code>if (NCH(n) == 1) n = CHILD(n, 0);</code>  - sometimes, as in this function, inside the cycle - means ‚Äúif the current node has only one child, then instead of the current node it is necessary to consider its child‚Äù. <br><br>  But does something interfere right away during the creation of the KSD to remove the ‚Äúone-child" nodes, substituting their children instead?  After all, it will save a lot of memory, and simplify the second parser, allowing you to get rid of repeating the <code>goto loop;</code>  all over the code, from the look of which <a href="http://hosting.vspu.ac.ru/~chul/dijkstra/goto/goto.htm">Dijkstra</a> would have been spinning in a coffin! <br><br>  In March, along with the aforementioned patch for <code>Modules/parsermodule.c</code> , I proposed <a href="http://bugs.python.org/issue26415">another patch</a> , which: <br><br><ol><li>  An automatic ‚Äúcompression‚Äù of non-branching subtrees is added to the first parser ‚Äî at the moment of <i>convolution</i> (creating the KSD node and returning from the current spacecraft to the previous one), the ‚Äúone-child‚Äù node of a suitable type is replaced with its child: <br><br><pre> <code class="diff hljs">diff -r ffc915a55a72 Parser/parser.c --- a/Parser/parser.c Mon Sep 05 00:01:47 2016 -0400 +++ b/Parser/parser.c Mon Sep 05 08:30:19 2016 +0100 @@ -52,16 +52,16 @@ #ifdef Py_DEBUG static void s_pop(stack *s) { if (s_empty(s)) Py_FatalError("s_pop: parser stack underflow -- FATAL"); - s-&gt;s_top++; + PyNode_Compress(s-&gt;s_top++-&gt;s_parent); } #else /* !Py_DEBUG */ -#define s_pop(s) (s)-&gt;s_top++ +#define s_pop(s) PyNode_Compress((s)-&gt;s_top++-&gt;s_parent) #endif diff -r ffc915a55a72 Python/ast.c --- a/Python/ast.c Mon Sep 05 00:01:47 2016 -0400 +++ b/Python/ast.c Mon Sep 05 08:30:19 2016 +0100 @@ -5070,3 +5056,24 @@ FstringParser_Dealloc(&amp;state); return NULL; } + +void PyNode_Compress(node* n) { + if (NCH(n) == 1) { + node* ch; + switch (TYPE(n)) { + case suite: case comp_op: case subscript: case atom_expr: + case power: case factor: case expr: case xor_expr: + case and_expr: case shift_expr: case arith_expr: case term: + case comparison: case testlist_star_expr: case testlist: + case test: case test_nocond: case or_test: case and_test: + case not_test: case stmt: case dotted_as_name: + if (STR(n) != NULL) + PyObject_FREE(STR(n)); + ch = CHILD(n, 0); + *n = *ch; + // All grandchildren are now adopted; don't need to free them, + // so no need for PyNode_Free + PyObject_FREE(ch); + } + } +}</code> </pre><br></li><li>  Corrects the second parser accordingly, excluding the ‚Äúbamboo branches‚Äù bypass from it: for example, the above <code>ast_for_expr</code> function <code>ast_for_expr</code> replaced with: <br><br><pre> <code class="hljs bash">static expr_ty ast_for_expr(struct compiling *c, const node *n) { //... switch (TYPE(n)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> lambdef: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> lambdef_nocond: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_lambdef(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> test_nocond: assert(NCH(n) &gt; 1); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_ifexpr(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> or_test: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> and_test: assert(NCH(n) &gt; 1); //    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> not_test: assert(NCH(n) &gt; 1); //  not_test <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> comparison: assert(NCH(n) &gt; 1); //  comparison <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> star_expr: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_starred(c, n); /* The next five cases all handle BinOps. The main body of code is the same <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>, but the switch turned inside out to reuse the code <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of operator. */ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> xor_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> and_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> shift_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> arith_expr: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> term: assert(NCH(n) &gt; 1); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_binop(c, n); // <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> yield_expr:    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> factor: assert(NCH(n) &gt; 1); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_factor(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> power: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_power(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> atom: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_atom(c, n); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> atom_expr: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ast_for_atom_expr(c, n); default: PyErr_Format(PyExc_SystemError, <span class="hljs-string"><span class="hljs-string">"unhandled expr: %d"</span></span>, TYPE(n)); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> NULL; } /* should never get here unless <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> error is <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> */ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> NULL; }</code> </pre><br>  On the other hand, many nodes as a result of the ‚Äúcompression of branches‚Äù children can now have new types, and therefore in many places in the code one has to add new conditions. <br><br></li><li>  Since the ‚Äúcompressed QDC‚Äù no longer corresponds to the Python grammar, to verify its correctness in <code>Modules/parsermodule.c</code> instead of ‚Äúraw‚Äù <code>_PyParser_Grammar</code> now need to use automata corresponding to the ‚Äútransitive closure‚Äù of the grammar: for example, for a pair of products <blockquote><pre> or_test :: = and_test
 test :: = or_test 'if' or_test 'else' test
</pre></blockquote>  ‚ÄîThe following "transitive" products are added: <br><blockquote><pre> test :: = or_test 'if' and_test 'else' test
 test :: = and_test 'if' or_test 'else' test
 test :: = and_test 'if' and_test 'else' test
</pre></blockquote><br>  During the initialization of the <code>parser</code> module, the <code>Init_ValidationGrammar</code> function bypasses the auto-generated spacecraft in <code>_PyParser_Grammar</code> , creates ‚Äútransitively closed‚Äù spacecraft on the basis of them, and stores them in the <code>ValidationGrammar</code> structure.  <code>ValidationGrammar</code> used to check the correctness of the CFC. </li></ol><br>  The compressed QDC for our sample code contains a total of 21 nodes: <br><br><pre> <code class="xml hljs">$ python Python 3.7.0a0 (default:98c078fca8e0+, Oct 31 2016, 09:00:27) [GCC 4.7.3] on linux Type "help", "copyright", "credits" or "license" for more information. &gt;&gt;&gt; import parser &gt;&gt;&gt; parser.suite('if 42: print("Hello world")').tolist() [257, [295, [297, [1, 'if'], [324, [2, '42']], [11, ':'], [270, [271, [272, [323, [324, [1, 'print']], [326, [7, '('], [334, [335, [324, [3, '"Hello world"']]]], [8, ')']]]]], [4, '']]]], [4, ''], [0, '']] &gt;&gt;&gt;</code> </pre><br><a name="plea"></a>  With my patch, a <a href="https://hg.python.org/benchmarks">standard set of benchmarks</a> shows a <b>reduction in memory consumption by the <code>python</code> process up to 30%</b> , with unchanged operating time.  In degenerate examples, the reduction in memory consumption reaches <b>threefold</b> ! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/afe/6bb/b37/afe6bbb37aaa4ab2a9233d788c167feb.png"></div><br>  But alas, for half a year since I offered my patch, none of the main maintainers have ever dared to revisit it - it‚Äôs so big and scary.  In September, <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B0%25D0%25BD_%25D0%25A0%25D0%25BE%25D1%2581%25D1%2581%25D1%2583%25D0%25BC,_%25D0%2593%25D0%25B2%25D0%25B8%25D0%25B4%25D0%25BE">Guido van Rossum</a> himself <a href="https://mail.python.org/pipermail/python-dev/2016-September/146503.html">answered me</a> : <i>‚ÄúOnce in all this time, no one showed interest in the patch,‚Äù which means that no one else cares about the memory used by the parser.</i>  <i>So it makes no sense to waste the time on the reviewers. ‚Äù</i> <br><br>  I hope this article explains why my big and scary patch is really necessary and useful;  and hopefully, after this explanation, the Python community will reach into his hands. </div><p>Source: <a href="https://habr.com/ru/post/314062/">https://habr.com/ru/post/314062/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314050/index.html">As I wrote the application on Elm</a></li>
<li><a href="../314054/index.html">Editing a hopeless support letter</a></li>
<li><a href="../314056/index.html">Optimization by example. Ant algorithm (ACS) vs Annealing Method. Part 2</a></li>
<li><a href="../314058/index.html">Grouping Sednit uses bootkit in cyber attacks</a></li>
<li><a href="../314060/index.html">TextBlock with backlit text (WPF)</a></li>
<li><a href="../314068/index.html">ASO optimization. Compiling a semantic core for app stores</a></li>
<li><a href="../314072/index.html">Simple and convenient notifications</a></li>
<li><a href="../314074/index.html">3CX Phone System V15 SP3 released and integrated with Insightly CRM</a></li>
<li><a href="../314076/index.html">Checking an open source partner</a></li>
<li><a href="../314078/index.html">How Windows NT Became the ‚ÄúKiller‚Äù of Novell NetWare OS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>