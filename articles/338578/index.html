<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks for the harshest. Part thirteen. MPLS Traffic Engineering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modern computer networks, offering cheap traffic, high profit, superstability and divine convergence, have lost such attractive qualities of old techn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks for the harshest. Part thirteen. MPLS Traffic Engineering</h1><div class="post__text post__text-html js-mediator-article">  Modern computer networks, offering cheap traffic, high profit, superstability and divine convergence, have lost such attractive qualities of old technologies as the ability to determine the path of traffic and ensure the quality of the channel from beginning to end. <br><br>  However, the network linkmeup has grown to the size of the federal operator.  The ability to manage traffic and quickly restore services has become a very important requirement in the MPLS network. <br>  It's time to implement Traffic Engineering. <br><br> <a href="http://linkmeup.ru/blog/302.html"><img src="https://habrastorage.org/web/790/526/1bc/7905261bcc814c89928efb9f2a93df51.jpg" width="1000"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Issue Content:</b> <div class="spoiler_text"><ul><li>  <a href="http://linkmeup.ru/blog/303.html">Prerequisites for MPLS TE</a> </li><li>  How MPLS TE works </li><li>  Ways to route traffic to TE tunnels </li><li>  Tunnel Management Methods <br><br><ul><li>  Metrics </li><li>  Bandwidth restrictions </li><li>  Tunnel Priorities </li><li>  Explicit-Path </li><li>  SRLG </li><li>  Affinity and Attribute-Flag </li></ul><br></li><li>  Reliability and Convergence <br><br><ul><li>  Path protection </li><li>  Local Protection - Fast ReRoute </li></ul></li><li>  MPLS QoS <br><br><ul><li>  MPLS TE IntServ </li><li>  MPLS TE DiffServ </li><li>  Modes of operation MPLS QoS </li></ul></li><li>  Simplify Tunnel Tuning </li><li>  Conclusion </li><li>  useful links </li></ul><br></div></div><br><hr><br>  Why do you need traffic engineering at all? <br><br><a name="habracut"></a><br>  I will give a simple example. <br>  Convergent network of mobile operator. <br><br><img src="https://habrastorage.org/web/7f0/6de/084/7f06de08484e4acea0a89dc61a06659c.png"><br><br>  Two types of traffic: <br><br><ul><li>  Mobile </li><li>  Broadband </li></ul><br>  The left shoulder is a wide 10G optical channel.  Right - reserve through a leased line - 1G. <br>  The total traffic volume is 2.5 Gb / s, mobile: 800 Mb / s. <br>  In the event of a break of the main channel, you need to switch to the backup only mobile traffic and do it in 50ms. <br><br>  Think, can we do it by standard means?  Of course, we can divide traffic of different services by different VPNs, but send them by different routes - no. <br><br>  Without the use of TE, <b>all</b> traffic will be redirected to the right shoulder, and there, who could have imagined that there is not enough bandwidth, drops will begin. <br><br>  In addition, the convergence rate of OSPF or ISIS, even when using BFD, amounts to tens of ms, but after that the transport LSPs must also be reconfigured.  Nowadays, it will not pass unnoticed by subscribers. <br><br><h1>  Principles of MPLS Traffic Engineering </h1><br>  What are the traffic management functions provided by MPLS Traffic Engineering? <br><br><ul><li>  Extends the capabilities of standard IGPs, allowing you to route traffic of different classes in different ways. </li><li> Transmits traffic through the network using MPLS switching, which means support for all VPNs. </li><li>  When constructing a route, it takes into account specified constraints, for example, what resources are necessary for this class of traffic and how many of them are available at all nodes and lines along the way, or which lines cannot be used to build tunnels. </li><li>  Fast rebuilding of tracks in accordance with the requirements in case of an accident. </li><li>  Periodic optimization of paths. </li></ul><br>  The basic mechanisms for the operation of MPLS TE were discussed in the <a href="http://linkmeup.ru/blog/154.html">release of SDSM 10</a> , where I send you for detailed consideration.  And here is a brief summary. <br><br><hr><br><h3>  Data plane </h3><br>  In terms of data transmission, TE is slightly different from LDP.  Bold highlights: <br><br><ol><li>  <b>Traffic must be forcibly placed in the TE tunnel, whereas it automatically enters the LDP</b> <br><blockquote>  Juniper is an exception. </blockquote></li><li>  The first router hangs the external MPLS label (PUSH LABEL) </li><li>  Transit routers look at which interface the packet and the value of the label arrived and, changing it to a new one according to the table of labels, send it to the output interface (SWAP LABEL) </li><li>  The penultimate router removes the transport label (POP LABEL, PHP - depends on the implementation and settings) </li><li>  <b>In case of a break in the path, traffic can be saved by forwarding packets to a pre-prepared tunnel.</b> </li></ol><br><hr><br><h3>  Control plane </h3><br>  But in terms of management, the differences are much more significant.  C them the rest of the way and we will understand. <br><br><blockquote><h5>  Terminology </h5><br>  <b>LSP</b> - <u>Label Switched Path</u> - generally speaking, any path through the MPLS network, but sometimes imply LDP LSP.  However, we will not be so categorical - if necessary, I will indicate what I mean by LDP LSP. <br>  <b>RSVP LSP</b> - LSP, respectively, built using RSVP TE, taking into account the restrictions imposed.  It may also be sometimes called CR-LSP - <u>ConstRaint-based LSP</u> . <br>  We will call one or more MPLS LSPs connecting two LSR routers as a <b>tunnel</b> .  The MPLS label is essentially tunnel encapsulation. <br>  In the case of LDP, each LSP is a separate tunnel. <br>  In the case of RSVP, the tunnel can consist of one or more LSPs: primary, backup, best-effort, temporary. <br>  Speaking of <b>TE-tunnel</b> , we will already mean specifically MPLS <u>Traffic Engineering tunnel</u> built by RSVP-TE. <br>  <b>TEDB</b> - <u>Traffic Engineering Data Base</u> is the same LSDB of IS-IS / OSPF protocols, but taking into account network resources that are of interest to the TE module. <br>  <b>CSPF</b> - <u>Constrained Shortest Path First</u> - an extension of the SPF algorithm, which looks for the shortest path, taking into account the restrictions imposed. <br></blockquote>  So, MPLS TE wants to build an LSP taking into account the required resources and the wishes of the operator, which is why such a simple LDP with its best route is irrelevant. <br><br>  And his place is taken by RSVP-TE - the successor of the <a href="http://lookmeup.linkmeup.ru/">RSVP</a> protocol rejected by the TCP / IP stack. <br>  TE works in close symbiosis with IGP.  Although it is more correct to call it parasitism.  He forces them (OSPF or IS-IS) to serve themselves: to transfer the information he needs and thereby fill TEDB. <br><br>  The process is as follows: <br><br><ol><li>  IGP collects information from the entire network: <br>  - about lines and networks, <br>  - about metrics <br>  - about available resources, <br>  - about the characteristics of the lines. <br>  And fills TEDB, where all this is reflected. <br></li><li>  When RSVP-TE wants to build a LSP to a node, it simply calls the CSPF and says: ‚ÄúI want the shortest route to G with these restrictions‚Äù.  Restrictions <i>may</i> be as follows: <br>  - required bandwidth, <br>  - a certain path or lines <br>  - line characteristics. <br></li><li>  CSPF takes restrictions from the RSVP-TE request, and real network information from TEDB.  And gives the route ... or does not give, if the constraints could not be satisfied. <br></li><li>  When a route is received, RSVP-TE sends an RSVP PATH to this G point with a request for reservation of resources. <br></li><li>  Point G returns RSVP RESV ‚Äî this is how resources are reserved all the way.  And if the RESV is back with good news, the RSVP LSP / tunnel goes up. <br></li></ol><br>  All this in detail and in colors in the article <a href="http://linkmeup.ru/blog/154.html">10</a> .  And there is the simplest example in practice. <br><br>  Next we will beat around the bush of this scheme: <br><br><img src="https://habrastorage.org/web/93c/32e/e2c/93c32ee2c49145d4b3bb6877bd485ca3.png"><br><br>  We have a L3VPN client whose offices are connected to Linkmeup_R1 and Linkmeup_R4. <br><br><hr><br><h1>  Ways to route traffic to the TE tunnel </h1><br>  Unlike LDP LSP, which traffic runs by default and so on, we need to send traffic to TE tunnels. <br><br>  And there are for this the following ways: <br><br><ol><li>  Static route </li><li>  PBR </li><li>  Igp shortcut </li><li>  Tunnel-policy * </li><li>  Or will it automatically get into the tunnel? * </li></ol><br><h3>  Static route </h3><br>  The easiest to understand and the most difficult to maintain. <br><br><pre><code class="python hljs">Linkmeup_R1(config) ip route <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> Tunnel <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br><h3>  PBR </h3><br>  Essentially the same static route. <br><br><pre> <code class="python hljs">Linkmeup_R1(config) ip access-list extended lennut Linkmeup_R1(config-ext-nacl)) permit ip <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> Linkmeup_R1(config) route-map lennut permit <span class="hljs-number"><span class="hljs-number">10</span></span> Linkmeup_R1(configconfig-route-map) match ip address lennut Linkmeup_R1(config-route-map) set interface Tunnel4 Linkmeup_R1(config) interface Ethernet0/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip policy route-map lennut</code> </pre> <br><h3>  Igp shortcut </h3><br>  This method is the most common and is supported by almost all manufacturers. <br>  The router treats the tunnel as a virtual interface.  And through this interface, remote routers seem to be directly connected to the local one, and not in dozens of hopes.  A sort of telecommunication wormhole.  It is called - shortcut - shortened path. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/243/3d7/e1e/2433d7e1e7f2aee2f249aeb19c6d2e24.jpg"><br>  <i><a href="http://elementy.ru/nauchno-populyarnaya_biblioteka/433254/Interstellar_Nauka_za_kadrom_Glava_iz_knigi">Flamm's Wormhole</a></i> <br><br>  But the default IGP protocols do not want to see this and use the physical interface to send traffic. <br><br>  With the help of IGP Shortcut (in AutoRoute Announce cisarea), we force the routing protocol on the Ingress LSR to treat the tunnel as a normal line ‚Äî the Egress LSR is supposedly connected directly.  And accordingly, all networks located behind the Egress LSR will be accessible through the tunnel. <br><br>  Thus, all whose destination point this router, or nodes behind it, will be sent to the tunnel.  Including VPN packages. <br><br><img src="https://habrastorage.org/web/785/5ca/fef/7855cafef3cd49aca84e43f7599f8efa.png" width="700"><br><br>  Thus, the tunnel becomes a common interface, and, like any other interface, it must have a metric. <br><br><h4>  Tunnel metric </h4><br>  <u>First</u> , there are two types of metrics: <br><br>  <b>IGP metric</b> is a well-known interface metric from the basic routing course. <br>  <b>TE metric</b> is the metric that will be used when calculating the TE tunnel metric. <br><br><ul><li>  By default, TE = IGP. </li><li>  By default, TE is used. </li><li>  By default, the tunnel metric is equal to the sum of the TE metrics of all the lines from Ingress to Egress <b>by the shortest IP path</b> (and not by the <b>path</b> that the tunnel goes through).  That is, the metrics of the usual IP routes and routes through the tunnel will be the same, even if the tunnel is actually much longer. <br>  Why choose the shortest path?  It is logical that the tunnel metric should interrupt the metric of the best IP path. </li><li>  If the metrics are equal, the router will choose the tunnel, since IGP shortcut does exactly that. <br><blockquote>  If there are IP paths that <b>do not have common segments</b> with a tunnel LSP, and their metrics are equal, then balancing will occur. <br></blockquote></li></ul><br>  <u>Secondly</u> , we have the following methods for managing the tunnel metric: <br><br><ol><li>  Change the value of the TE metric on physical interfaces. </li><li>  Tell MPLS TE to use IGP metric instead of TE. </li><li>  Accordingly, change the IGP metric of the physical interface. </li><li>  Configure the tunnel interface metrics directly: </li></ol><br><blockquote>  Here a person explains in a very accessible way how metrics work. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/eLLSMsgYiNQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/GXGzcF8oQrU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OFho6er9Bcw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></blockquote>  Well, in general, I recommend a resource: <a href="http://labminutes.com/video/sp">labminutes.com/video/sp</a> <br><br><blockquote><h3>  Forwarding adjacencies </h3><br>  Forwarding adjacencies is a thing of a similar nature from IGP Shortcut, with the only (significant) difference that the tunnel will now be announced to Ingress LSR IGP neighbors as a normal link.  Accordingly, all surrounding routers will take it into account in their SPF calculations. <br><br>  IGP Shortcut only affects the routing table on the Ingress LSR, and the surrounding neighbors do not know about this tunnel. <br></blockquote><br><h3>  Tunnel-policy * </h3><br>  <i>* This method depends on the manufacturer - someone has, someone does not.</i> <br>  Tunnel-policy is used to redirect VPN traffic exclusively to tunnels. <br>  That is, in the VPN configuration mode (whether L2 or L3 is important), it is indicated which tunnel should be used. <br><br>  There are two possibilities: <br><br><ol><li>  <b>Tunnel binding mode</b> .  Depending on the Egress PE select a specific tunnel.  Applicable to RSVP LSP only. </li><li>  <b>Select-Seq mode</b> .  The tunnel will be selected in the order specified in the configuration.  This may be a TE tunnel, LDP tunnel, with or without balancing. </li></ol><br><h3>  Juniper Features </h3><br>  The juna often has its own approach (see for yourself today).  So it has several routing tables: <br><br><ol><li>  IP routing table (inet.0) </li><li>  MPLS routing table (inet.3) </li><li>  MPLS forwarding table (mpls.0). </li></ol><br>  When placing VPN routes into an IP routing table, BGP is checked against the inet.3 MPLS table.  If in it he finds the LSP before the Next Hop of the VPN route, then the traffic is automatically driven into that LSP.  No additional action is required. <br><br>  This is in a sense similar to the mix Tunnel-Policy and IGP Shortcut, only automatically. <br><br><img src="https://habrastorage.org/web/ed9/171/a72/ed9171a72bb64f42b90721664fbd4153.png"><br><br><h2>  Practice </h2><br>  All the same network, but with bandwidth limitations. <br><br><img src="https://habrastorage.org/web/f84/ae3/a9b/f84ae3a9bb574ddcbb5c336f2c126345.png"><br><br>  We need to provide L3VPN to the client. <br>  The client has requirements: 8 Mb / s.  Take out and put it down. <br>  We direct traffic to the tunnel through Auto-Route. <br><blockquote>  In the laboratory, the interface limit is 10,000 Kb / s.  Therefore, when specifying the requirements of the tunnel and the available lanes, we repel exclusively from this figure. <br></blockquote>  Go! <br><br>  So let's start with the fact that no LDP - only RSVP-TE.  That is, there is no LSP until we configure the tunnel. <br><br>  Although we already did all this last time, but we will start the setup from the beginning. <br><br><ol><li>  Basic configuration already exists (IP + IGP) <br>  <a href="https://docs.google.com/document/d/1F03GvVpAd97kEOf7X4oR9rA4FdK50rWOz3HwOxfhuMs/pub">Configuration file.</a> <br></li><li>  Turn on TE features <br><br><pre> <code class="python hljs">Linkmeup_R1(config) mpls traffic-eng tunnels</code> </pre> <br>  And at the same time on all interfaces we will immediately configure the bandwidth limit <br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth _</code> </pre> <br>  When specifying bandwidth requirements for a tunnel, this command is mandatory ‚Äî the band must be explicitly specified, otherwise IGP does not announce this information, and the CSPF will not take this line into account and will not calculate the path for the tunnel requirements. <br><br>  In the diagram above, I outlined which of the interfaces have a limit of 5 MB / s.  If not signed, then there is no limit - set 10. <br><blockquote>  It should always be remembered that this is only a reference value for calculating the TE path, and in fact the team <b>does not limit the</b> actual speed of TE traffic through the interface. <br></blockquote><br><pre> <code class="python hljs">Linkmeup_R1(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">5000</span></span> Linkmeup_R1(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span></code> </pre> <br><blockquote>  Note that the <b>ip rsvp bandwidth command</b> points the band in one direction only.  That is, if we configured it on the E0 / 0 interface in the direction of Linkmeup_R2, then this means that the bandwidth is limited to 5 MB / s for outgoing traffic only. <br>  To restrict the other way, you need to configure the E0 / 1 interface from Linkmeup_R2. <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Configuration of other nodes</b> <div class="spoiler_text"><hr><br><pre> <code class="python hljs">Linkmeup_R2(config) mpls traffic-eng tunnels Linkmeup_R2(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">5000</span></span> Linkmeup_R2(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R2(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R2(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R2(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> &lt;hr&gt; Linkmeup_R3(config) mpls traffic-eng tunnels Linkmeup_R3(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R3(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R3(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R3(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> &lt;hr&gt; Linkmeup_R4(config) mpls traffic-eng tunnels Linkmeup_R4(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R4(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> &lt;hr&gt; Linkmeup_R5(config) mpls traffic-eng tunnels Linkmeup_R5(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R5(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">5000</span></span> Linkmeup_R5(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R5(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R5(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> &lt;hr&gt; Linkmeup_R6(config) mpls traffic-eng tunnels Linkmeup_R6(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R6(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R6(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R6(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R6(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> &lt;hr&gt; Linkmeup_R7(config) mpls traffic-eng tunnels Linkmeup_R7(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R7(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span> Linkmeup_R7(config) interface FastEthernet <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R7(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip rsvp bandwidth <span class="hljs-number"><span class="hljs-number">10000</span></span></code> </pre> <br><hr><br></div></div><br></li><li>  Configure IS-IS for the ability to collect and transmit TE data <br><br><pre> <code class="python hljs">Linkmeup_R1(config) router isis Linkmeup_R1(config-router) metric-style wide Linkmeup_R1(config-router) mpls traffic-eng router-id Loopback0 Linkmeup_R1(config-router) mpls traffic-eng level<span class="hljs-number"><span class="hljs-number">-1</span></span></code> </pre> <br>  The metric-style wide team is obligatory, I remind you.  The point is that TE uses new TLVs with extended labels, and by default ISIS only generates short ones. <br><br>  Since the configuration is completely the same, for the other nodes I do not cite. <br><br><img src="https://habrastorage.org/web/0d0/5b3/161/0d05b3161ae147be99bc00102ea746c4.png"><br></li><li>  Configure the TE tunnel. <br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface Tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) description To Linkmeup_R4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip unnumbered Loopback0 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mode mpls traffic-eng Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel destination <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng bandwidth <span class="hljs-number"><span class="hljs-number">8000</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">1</span></span> dynamic</code> </pre> <br>  Here we have indicated that the tunnel is built up to node 4.4.4.4, 8 Mb / s is required, and the LSP is built dynamically (without Explicit-Path) <br><br>  Immediately after this we see that the tunnel has risen. <br><br><img src="https://habrastorage.org/web/fe4/089/0a5/fe40890a53464c718671b20636afe977.png"><br><br>  That is, CSPF calculated the route taking into account our limitations, RSVP PATH successfully signaled the path, and RSVP RESV reserved resources all the way. <br><br><blockquote>  Tracing shows that the path is laid exactly the way we wanted it. <br><br><img src="https://habrastorage.org/web/124/a79/e94/124a79e949d94a028d4df08e81d3d752.png"><br><br>  And in the RSVP PATH message you can see that it carries information about the required band. <br><br><img src="https://habrastorage.org/web/a18/9f9/575/a189f9575a9946b58fd9c19785796da2.png"><br><br>  In the dump you can see the beginning of the ERO object listing all the nodes along the path of the future RSVP LSP and a request for bandwidth reservation. <br>  It costs 1,000,000 bytes per second or exactly 8 megabits per second (unless we confuse Mega with Mobi).  This value is discrete and varies with some steps.  In the case of this lab - it is 250 kb / s. <br><br>  You can play around with the parameters and see how the tunnel reacts to changes in the network. <br></blockquote>  The same on the back side: <br><br><pre> <code class="python hljs">Linkmeup_R4(config) interface Tunnel1 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) description To Linkmeup_R1 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip unnumbered Loopback0 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mode mpls traffic-eng Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel destination <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng bandwidth <span class="hljs-number"><span class="hljs-number">8000</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">1</span></span> dynamic</code> </pre> <br></li><li>  Create a VPN ( <a href="http://linkmeup.ru/blog/204.html">see how</a> ) <br><br><pre> <code class="python hljs">Linkmeup_R1(config) ip vrf TARS Linkmeup_R1(config-vrf) rd <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R1(config-vrf) route-target export <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R1(config-vrf) route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R1(config-vrf) interface Ethernet0/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) description To TARS_1 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip vrf forwarding TARS Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip address <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> Linkmeup_R1(config-router) neighbor <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> remote-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">64500</span></span> Linkmeup_R1(config-router) neighbor <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> update-source Loopback0 Linkmeup_R1(config-router) address-family vpnv4 Linkmeup_R1(config-router-af) neighbor <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> activate Linkmeup_R1(config-router-af) neighbor <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> send-community both Linkmeup_R1(config-router) address-family ipv4 vrf TARS Linkmeup_R1(config-router-af) redistribute connected</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Setup on Linkmeup_R4</b> <div class="spoiler_text"><hr><br><pre> <code class="python hljs">Linkmeup_R4(config) ip vrf TARS Linkmeup_R4(config-vrf) rd <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R4(config-vrf) route-target export <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R4(config-vrf) route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">64500</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> Linkmeup_R4(config-vrf) interface Ethernet0/<span class="hljs-number"><span class="hljs-number">3</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) description To TARS_2 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip vrf forwarding TARS Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip address <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng tunnels Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> Linkmeup_R4(config-router) neighbor <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> remote-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">64500</span></span> Linkmeup_R4(config-router) address-family vpnv4 Linkmeup_R4(config-router-af) neighbor <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> activate Linkmeup_R4(config-router-af) neighbor <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> send-community both Linkmeup_R4(config-router-af) address-family ipv4 vrf TARS</code> </pre> <br></div></div><br>  If we now try to ping, then a bummer - nothing will happen. <br>  Note that BGP has distributed VPN routes along with their labels, but there is no data transfer. <br>  This is because there is no link to the transport LSP, and without this, there is no point in the VPN tags. <br></li><li>  We send traffic to it via IGP Shortcut. <br>  One command on both PE is enough for this: <br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface Tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng autoroute announce</code> </pre> <br><pre> <code class="python hljs">Linkmeup_R4(config) interface Tunnel1 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng autoroute announce</code> </pre> <br>  If necessary, you can also configure the metric of the tunnel interface: <br><br><pre> <code class="python hljs">Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng autoroute metric relative <span class="hljs-number"><span class="hljs-number">-5</span></span></code> </pre> <br><pre> <code class="python hljs">Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng autoroute metric relative <span class="hljs-number"><span class="hljs-number">-5</span></span></code> </pre> <br><img src="https://habrastorage.org/web/cc7/7f2/2c9/cc77f22c909141e19f2ba5d9f1637a25.png"><br><br><img src="https://habrastorage.org/web/924/cda/952/924cda9523d245189c073ddacd0d74c4.png"><br><br><img src="https://habrastorage.org/web/672/9fb/52f/6729fb52febe4ddeba64e4e1b96ea266.png"><br></li><li>  There is a ping, there is happiness! <br><br><img src="https://habrastorage.org/web/496/610/cf6/496610cf6e5b4656b21f1ef2f9d7cb7b.png"><br></li></ol><br><blockquote>  So what happened? <br><br><ol><li>  First we set up basic TE support, <br>  a) Enable TE support globally <br>  b) Enable the TE function on the trunk interfaces <br>  d) Indicate the available bandwidth of the physical interfaces <br>  e) Forced IGP to announce TE data. <br><br>  <b>In this step, the IGP has already compiled a TEDB.</b> <br></li><li>  Created a tunnel (forward and reverse): <br>  a) Indicate a destination <br>  b) Mode of operation - TE, <br>  c) Indicate the required band, <br>  d) Allowed to build LSP dynamically. <br><br>  <b>In this step, the CSPF first calculates the list of nodes through which the LSP should be laid.</b>  <b>The exhaust of this process is placed in an ERO object.</b>  <b>then RSVP-TE uses the PATH and RESV messages to reserve resources and build the LSP.</b> <br><br>  But this is still not enough for practical use of the tunnel. <br><br></li><li>  Set up L3VPN ( <a href="http://linkmeup.ru/blog/204.html">see how</a> ). <br>  When MP-BGP exchanged VRF route data, Next Hop for these routes was the Loopback address of the remote PE. <br>  However, the routes from the BGP table are not installed in the routing table of this VRF, since we have not yet started the traffic on the LSP. <br></li><li>  Forced IGP to consider TE-tunnel as a possible output interface. <br>  It does not entail any changes in other parts of the network ‚Äî only local action ‚Äî IGP only changes the routing table of this node. <br><br>  Now the LoopBack of the remote PE is available via the tunnel, and the routes are added to the VRF routing table. <br><br>  That is, when an IP packet comes from a client, <br>  a) he gets a VPN label (16). <br>  b) from the FIB VRF TARS he knows that for this prefix the packet should be sent to the address 4.4.4.4 <br>  c) Until 4.4.4.4, there is a TE tunnel (Tunnel 4) and its output interface / tag pair is known - Ethernet0 / 1, 18 - it will be a transport one. <br></li></ol><br><img src="https://habrastorage.org/web/b33/cf0/966/b33cf0966b6445d8b89c9a70d0dced34.png"><br><br><img src="https://habrastorage.org/web/e7a/759/c8c/e7a759c8cdd447feb4d50fa0376b0c9a.png"><br>  <i>In this illustration, absolutely nothing to select - everything is absolutely perfect - all the information about the TE-tunnel in one team.</i> <br></blockquote><br><hr><br>  Now the path from R1 to R4 looks like this: R1-&gt; R5-&gt; R2-&gt; R6-&gt; R3- <b>&gt; R4</b> - all because of these damn restrictions. <br><br>  Now we start messing around. <br>  Let's try to break our working link R3-&gt; R4, while continuous ping lasts. <br><br><img src="https://habrastorage.org/web/5dd/824/ba6/5dd824ba687d4f82bd0018d5b8d109a7.png"><br><br>  LSP changed to R1-&gt; R5-&gt; R2-&gt; R6-&gt; R3-&gt; R7-&gt; R4 with the loss of one packet.  This time can increase significantly if there is no physical line drop on the routers. <br><br><blockquote>  What happened? <br><br><ol><li>  First, R1, through the RSVP PATH ERROR message, learned that the line was broken. </li><li>  R1 sent RSVP PATH TEAR towards 4.4.4.4, and RSVP RESV TEAR going back went to remove the LSP. </li><li>  Meanwhile, on R1, CSPF has calculated a new route around the broken link. </li><li>  Then RSVP-TE signaled the new LSP R1-&gt; R5-&gt; R2-&gt; R6-&gt; R3-&gt; R7-&gt; R4 <br><br><img src="https://habrastorage.org/web/637/cad/f44/637cadf4478848f68bb9028b614c0893.png"></li></ol><br></blockquote>  If we do not have paths that meet the specified conditions - trouble - LSP will not. <br><br>  For example, turn off the R2-R5 line and observe the fall of the TE tunnel on R1 without further restoring it. <br><br><h2>  Re-optimizing tunnels </h2><br>  If the link R3-&gt; R4 is restored, will the tunnel be rebuilt? <br>  Yes.  But not soon.  Fly many packets before Ingress PE shifts its RSVP.  ( <i>Actually depends on the manufacturer</i> ) <br>  This is called Tunnel reoptimization.  At some intervals, Ingress PE causes the CSPF to check whether more optimal routes have appeared. <br><br><ol><li>  CSPF finds a new path that satisfies all conditions.  In our case, R1-&gt; R5-&gt; R2-&gt; R6-&gt; R3- <b>&gt; R4</b> . </li><li>  Ingress PE signals the new RSVP LSP by sending RSVP PATH. </li><li>  Having received RSVP RESV, he realizes that the new LSP is ready. </li><li>  Sends RSVP PATH TEAR to break the old LSP. </li><li>  When RSVP RESV TEAR returns, it's all over. </li></ol><br>  That is, first he builds a new RSVP LSP, lets traffic go in there and only then breaks the old one.  This mechanism is called Make-Before-Break, about which at the end. <br><br><h1>  Tunnel Management Methods </h1><br>  So, we have enough ways to influence the traffic path with TE: <br><br><ol><li>  MPLS TE path metric </li><li>  Bandwidth Limit </li><li>  Explicit-Path </li><li>  SRLG </li><li>  Administrative Groups / Affinity </li></ol><br><h3>  MPLS TE path metric </h3><br>  The first most obvious method is interface metrics. <br>  As we remember, there are IGP-metrics, and there are TE-metrics.  The second ones are by default the first. <br>  TE metrics on link interfaces not only affect the tunnel metric in terms of IGP Shortcut, but are also taken into account when building LSPs. <br><blockquote>  Why might you need to configure a TE metric other than IGP? <br>  For example, there is a line with a high delay value.  We set the larger value of the TE-metrics to it. <br>  Then: <br>  When building tunnels for voice traffic, we will use the TE metric, <br>  In tunnels for other data - IGP. <br></blockquote>  Used for this command <br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng administrative-weight  TE-</code> </pre> <br>  To tell the tunnel which metric to consider: <br>  Default value: <br><br><pre> <code class="python hljs">Router(config) mpls traffic-eng path-selection metric {igp | te}</code> </pre> <br>  Concrete tunnel: <br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-selection metric {igp | te}</code> </pre> <br>  <a href="http://www.cisco.com/c/en/us/td/docs/ios/12_2s/feature/guide/fsmetric.html">Cisco in detail about metrics</a> . <br><br><h3>  Bandwidth Limit </h3><br>  In practice, we got acquainted with the basic function of TE - the ability to build MPLS tunnels with reservation of resources throughout the entire LSP. <br><br>  But does this idea with Bandwidth bother you?  Do not we return to the stone age, when there was no re-subscription.  Yes, and how do you determine the magnitude of this limit?  And what to do with the fact that it floats on the order of the day? <br><br><h4>  Offline Bandwidth </h4><br>  The method when we adjust the static value of the required band is called Offline Bandwidth. <br>  The idea is that there is a certain program costing three in the Patriarch's Ponds, which, according to some algorithms, calculates one figure for your traffic, which you need to configure in the tunnel. <br><br>  The band can be configured for the entire tunnel, as we did in practice above: <br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng bandwidth   </code> </pre> <br>  And it is possible for a specific RSVP LSP: <br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">1</span></span> dynamic bandwidth   </code> </pre> <br>  This value may differ from what is specified for the tunnel and has a higher priority. <br><br>  At the same time, for another LSP (path-option 2, for example), the value may differ - they say, if you cannot reserve 8 Mb / s, let's try at least 5? <br><br>  Offline Bandwidth has two significant drawbacks: <br>  - Handwork, which a good engineer tries to avoid. <br>  - Non-optimal use of resources.  Well, we will assign a 300 Mb / s band to the client, reserve it on each line, but in fact it needs something from the power of 30. And only at the peak, when the database is backed up, you need 300. Inaccurately. <br><br>  This option was practiced at the dawn of TE.  He exists now. <br>  However, keeping up with the times, you need to be more flexible and pliable. <br><br><h4>  Auto-Bandwidth </h4><br>  And Autobandwidth is great. <br>  This mechanism tracks the loading of the tunnel for a certain period and then adapts the reservation. <br><br><blockquote><h5>  Terminology </h5><br>  <b>Adjust Interval</b> - the time during which the router monitors traffic and monitors peaks. <br>  <b>Adjust Threshold</b> ‚Äî The threshold after which RSVP re-queries the reservation. <br></blockquote>  Closer to the body. <br><br><img src="https://habrastorage.org/web/299/626/449/299626449a714e3395c9604f8ba21afd.png"><br><br>  For example, Adjust Interval we have 2 hours.  The current value of the reserved bandwidth is 90 Mb / s. <br>  Adjust Threshold - 20 Mb / s. <br><br>  In the first interval, a burst of 119 Mb / s (up to 119 Mb / s) is greater than the threshold.  So RSVP-TE is trying to build a new tunnel with new values ‚Äã‚Äãfor bandwidth. <br><br>  In the second - 23 Mb / s (up to 142) - again more than the threshold.  Update reservations whenever possible. <br><br>  In the third, the maximum value drops to 137 Mb / s - the difference is only 5. Nothing happens. <br><br>  In the fourth burst drops to 116 (a difference of 21) - RSVP signals the new LSP with reduced bandwidth requirements. <br><br>  So, every two hours there will be a check and, possibly, a rebuilding of the tunnels. <br>  The shorter the Adjust Interval, the more consequently the reservations will be updated and the more efficiently used available bandwidth. <br><br>  Something like this at the two-hour interval will look like the 24-hour auto-bandwidth behavior. <br><br><img src="https://habrastorage.org/web/594/36b/eea/59436beea7644000a6b5161c17bc9bd9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Already noticed the problem? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take the typical profile of morning traffic: </font></font><br><br><img src="https://habrastorage.org/web/3ba/8c2/076/3ba8c2076fa6486881a194c052d4c6d2.png" width="800"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And such rubbish all day.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here we measured at 8 am splash - 200 Mb / s. And for two hours this value is kept for the tunnel. And during this time, people have already come to work and launched YouTube - the average speed is already 240, and the bursts are up to 300. Until 10 am, there will be a quiet degradation. Silent, because neither the tunnel nor the Auto-Bandwidth know about it. But users know and their ITshnik also knows, believe me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If, however, the adjustment interval is greatly reduced, then new LSPs will be constantly resigned to the network. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To solve this and other problems, there are mechanisms </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Underflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The first is for tracking the growth of traffic, the second is for the decrease.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the difference between current redundancy and traffic surges exceeds the Overflow threshold several times in a row, RSVP TE will try to build a new LSP without waiting for the Adjust Interval to expire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The same is true for Underflow - RSVP-TE will reregenerate LSPs with lower requirements if they notice a tendency to decrease traffic volume. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And there is only one, but a serious problem.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how our world works, that when traffic grows from one subscriber, it usually grows from another. And it may be that when the time comes to increase the reservation again, it will have nowhere to increase it - everything is taken. And then, if there are no other ways that meet the new conditions, the old one will be used. And no one will care that there is not enough of it, that the packages have started to get lost, that the client is looking for the director‚Äôs number in order to find an engineer who can be torn off something superfluous. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will deal with this with the help of tunnel prioritization, which is described below. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To enable the AutoBandwidth function globally and at the same time the Adjust Interval settings:</font></font><br><br><pre> <code class="python hljs">Router(config) mpls traffic-eng auto-bw timers frequency [sec]</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, for each tunnel separately, you need to activate AutoBandwidth. </font><font style="vertical-align: inherit;">You can also set a different value for the Adjust Interval, as well as set the minimum and maximum possible values ‚Äã‚Äãfor the reserved band.</font></font><br><br><pre> <code class="python hljs">Router(config) tunnel mpls traffic-eng auto-bw max-bw  min-bw </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To configure overflow: </font></font><br><br><pre> <code class="python hljs">Router(config) tunnel mpls traffic-eng auto-bw [overflow-limit   overflow-threshold  ]</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more about Auto-Bandwidth in a very </font></font><a href="https://ripe64.ripe.net/presentations/52-mpls-autobandwidth.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">honest document</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tunnel Priorities </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the mechanism that prioritizes tunnels: which one is more important. It is applicable, as for the case of Auto-Bandwidth in particular, and for any construction of RSVP LSP in general. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is very logical: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setup Priority</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the priority of installing RSVP LSP. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hold Priority</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the priority of holding RSVP LSP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there is not enough bandwidth on the node, and the new tunnel has a higher installation priority than the old one‚Äôs retention priority, a new one will be built - the old one is broken. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both have 8 values: from 0 to 7. For both, 0 is the highest, 7 is the lowest. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, we have a LSP1 tunnel that has Hold priority </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here comes a request from RSVP-TE on LSP2 with Setup Priority </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and Hold Priority too</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If there is enough bandwidth, then it‚Äôs just built. </font><font style="vertical-align: inherit;">If not, then the router will not allow this, because the existing tunnel is more priority than the new one (4&gt; 6). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose there are enough lanes and both tunnels went up normally. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here comes a new request for LSP3 with Setup / Hold Priority </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is higher than that of LSP2, but lower than that of LSP1. </font><font style="vertical-align: inherit;">And he already lacks the band. </font><font style="vertical-align: inherit;">LSP1 will definitely not be touched, because its Hold priority is still the highest. </font><font style="vertical-align: inherit;">And then there are two options:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you break LSP2, the band is enough for LSP3. </font><font style="vertical-align: inherit;">In this case, Setup LSP3 priority is higher than Hold LSP2. </font><font style="vertical-align: inherit;">Ingress PE LSP2 finds out that his LSPs have broken down treacherously and will search for a new path - his luck if he finds one.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you break LSP2, the band is still not enough for LSP3. </font><font style="vertical-align: inherit;">LSP1 router will not give up. </font><font style="vertical-align: inherit;">And then LSP1 and LSP2 remain, and Ingress PE LSP3 will look for other opportunities for self-realization.</font></font><br></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regarding the values, they are usually chosen the same for Setup and Hold. </font><font style="vertical-align: inherit;">And you should not configure Hold lower than Setup. </font><font style="vertical-align: inherit;">Firstly, this is not logical. </font><font style="vertical-align: inherit;">Secondly, a situation may occur when two tunnels enter a loop, when they constantly overwork each other ‚Äî once one is established, the second will break it and build itself, then the first will break the second and so on. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are two tunnel replacement modes: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hard preemption</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äî A higher priority LSP simply replaces a low priority LSP. </font><font style="vertical-align: inherit;">Even if a low priority LSP then finds a new path, some of the traffic will be lost. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soft preemption</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- The Make-Before-Break mechanism is used. A router via RSVP-TE tells the Ingress LSR of a low-priority LSP to look for a new path. A high priority LSP waits until low-priority LSP traffic switches to the new LSP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, if the path could not be found for some time, the low-priority LSP still breaks and the high-priority one is built. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replacement priority data is transferred to the RSVP-TE PATH and is taken into account when reserving resources at intermediate nodes.</font></font><br><br><h2>  Practice </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you noticed, after configuring tunnel mpls traffic-eng badnwidth on the tunnel interface, the line </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunnel mpls traffic-eng priority 7 7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatically appears in the configuration </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact is that without bandwidth requirements, priorities have no meaning ‚Äî you can build as many tunnels as you want through a single node - after all, the band is not reserved - and there is no command. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, as soon as the demand appeared, along the way, priorities begin to play a role. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 is the default value ‚Äî the smallest. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's set up a new tunnel on Linkmeup_R1 to 4.4.4.4 with a higher priority?</font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface Tunnel42 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip unnumbered Loopback0 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mode mpls traffic-eng Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel destination <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng priority <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng bandwidth <span class="hljs-number"><span class="hljs-number">4000</span></span> Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">1</span></span> dynamic</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The required band is only 4 Mb / s. Therefore, the tunnel must pass along the path R1-&gt; R2-&gt; R3-&gt; R4. </font></font><br><br><img src="https://habrastorage.org/web/f84/ae3/a9b/f84ae3a9bb574ddcbb5c336f2c126345.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's </font></font><br><br><img src="https://habrastorage.org/web/9f3/4e8/022/9f34e8022ea14af9940dc5e296d715b6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">right </font><font style="vertical-align: inherit;">, here is his trace: </font><font style="vertical-align: inherit;">With Tunnel4, they have only one common link R3-&gt; R4, but its bandwidth is only 10. And two tunnels need 8 + 4 = 12. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel42 with installation priority 4 squeezes Tunnel4 with retention priority 7. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And you have to look for a new path. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And it is located: </font></font><br><br><img src="https://habrastorage.org/web/b05/a81/9c4/b05a819c464748e7ada0540483df7a42.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the old RSVP LSP Tunnel4 is removed and a new one is signaled according to the available path. </font></font><br><br><img src="https://habrastorage.org/web/b4f/190/01a/b4f19001adee4d8eae13c9ba71ab4cc2.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then RSVP-TE signals the LSP for Tunnel42.</font></font><br><br><img src="https://habrastorage.org/web/008/6ee/d33/0086eed334404ad0a6ca60be6f6f2f6f.png"><br><br><img src="https://habrastorage.org/web/ef2/b1a/172/ef2b1a1726d34e5ea3caf3ae1bef381c.png"><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this point, back to Autobandwidth. A bunch of Tunnel priority + Autobandwidth gives an elegant solution. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One early morning there was little traffic, autobandwidth calculated exactly how much it was in each tunnel, and TE had enough bandwidth everywhere. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then closer to dinner traffic grew, autobandwidth adapted, re-reserved new bands - still enough. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One evening, one by one, the tunnels begin to fly out, because TE cannot reserve a new lane. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here it is important that the tunnels of fat clients, IP-telephony and the channel for the Ministry of Internal Affairs never fall. Then we set Hold priority for these tunnels higher than the others. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- If you try to reserve a low-priority band on the interface, where it is not enough, it will break off.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - High priority, on the contrary, will crowd out the low-priority one and occupy the vacant strip. </font></font><br><br>  Turns out that <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> without Autobandwidth, we either adjust the bandwidth requirements manually on the entire network, or do not do it at all by letting it go by itself, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> without Autobandwidth, we never know how much traffic is really in a tunnel, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> without Autobandwidth, we can‚Äôt limit it at all, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> without Tunnel priority, we cannot say for sure which tunnels will suffer. </font></font></li></ul><br><hr><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explicit-Path </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The idea of ‚Äã‚ÄãExplicit-Path was more than fully disclosed in the </font></font><a href="http://linkmeup.ru/blog/154.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10th edition of the SDSM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you remember, CSPF calculates the shortest path based on constraints. Further, this path is transformed into an ERO object (Explicit Route Object) of the RSVP-TE PATH message, which explicitly states which path this PATH should be passed on. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So if you want some nodes to be present or vice versa absent in this path, you can explicitly specify this in the Explicit-Path, which will be one of the input constraints for the CSPF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we manually specify which nodes the LSP should go through, and which ones should not. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSVP-TE asks CSPF to calculate the route taking into account the Explicit-Path and other tunnel constraints. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If one is at odds with the other - trouble, there will be no LSP.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explicit-Path is a strictly local restriction ‚Äî only the Ingress LSR knows about it and does not transmit either in IGP announcements or in RSVP-TE messages. </font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting the Explicit-path is done in two steps: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Creating the most explicit-path with constraints:</font></font><br><br><pre> <code class="python hljs">Router(config) ip explicit-path name  Router(cfg-ip-expl-path) next-address IP- Router(cfg-ip-expl-path) exclude-address IP- ...</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2) Applying it to path-option on the tunnel: </font></font><br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">1</span></span> explicit name </code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SRLG </font></font></h2><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SRLG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shared Risk Link Group</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Another way to influence the LSP and a great idea against </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flat rings</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The task of this function is to prevent the construction of the main and backup LSPs through lines that can be damaged at the same time. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, two fibers that physically pass in the same cable will most likely be torn by the same excavator bucket. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An SRLG group</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a group of interfaces that "share the risk."</font></font> ABOUT!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Risk group. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manually (of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">course, and how else would the router know that these are physically identical lines</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) are configured interfaces that are members of one SRLG group. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information about SRLG is distributed over the network along with IGP announcements, as is the available band or Attribute-Flag value, and is then placed in TEDB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The CSPF should then take this information into account when calculating the shortest routes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are two modes: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Force Mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> forces the CSPF to take into account SRLG data - if there is no other way, then the backup LSP will not be built at all. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preffered Mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows the construction of spare tunnels via SRLG lines, if there are no other possibilities. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The mode is set on the Ingress LSR.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To add interfaces to one risk group, the following command is entered on any nodes: </font></font><br><br><pre> <code class="python hljs">Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls traffic-eng srlg  </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And on Ingress PE enable the SRLG check: </font></font><br><br><pre> <code class="python hljs">Router(config) mpls traffic-eng auto-tunnel backup srlg exclude force/preffered</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What is this team, let's talk in the FRR section. </font></font><br><br><hr><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Administrative Groups or Affinity </font></font></h2><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should be scary right now. </font><font style="vertical-align: inherit;">I'm scared. </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, by this moment we learned about four traffic management tools:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MPLS TE metric. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Channel bandwidth requirements and substitution priority. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explicit-path. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SRLG. </font></font></li></ul><br> <a href="https://tools.ietf.org/html/rfc3630"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC3630</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for OSPF, and for ISIS, define the TLV for the Administrative Group, which is transmitted by the IGP along with other characteristics of the lines.</font></font><br><br><blockquote>       ,    . <br><br>   linkmeup.  ,   ,  ,    ,      .      MPLS,   ‚Äî TE-. <br><br>     ,     . <br> ,  2G         - ‚Äî     . <br>        ,      90-      . <br>         . <br><br>     - . <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each time, setting up a tunnel, take into account in the Explicit Path all these details - you can go crazy. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the new bundle is an amazing rescue that will solve all our problems, just click the ‚Äúdo well‚Äù button. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The idea is that we mark each interface with certain colors. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And then we say that this tunnel can go along the red and purple lines, but it cannot go along the green, yellow and brown.</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Marketing Bullshit!</font></font> Unclear?  Me too. <br><br>  So. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Administrative Group (for Juniper: admin-group, for Cisco: Attribute-Flag) is an attribute of the physical interface that can describe its 32 discrete characteristics. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Which bit of 32 for which the operator decides is responsible. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since we have examples in the Cisco console, then I will use the term Attribute-Flag along with the Administrative group, which is not entirely correct.</font></font></i> <br><br><blockquote>  For example, <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we count from the least significant bits (from the end): the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first bit in 1 means that it is optics, the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second bit in 1 means that this is a radio relay link, the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">third bit in 0 means that it is a line to the access network, and 1 is a trunk interface. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the fourth bit in 1 means that the lease is the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fifth bit in 1 means that this is Balagan Telecom, the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sixth bit in 1 means that this is Filkin-Certificate of the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seventh bit in 1 means that it is a channel through the Internet without guarantees.</font></font><br>  ... <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a tenth bit in 1 means that the bandwidth is less than 500 MB / s </font></font><br>  etc.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I can recycle all 32. </font></font><br></blockquote><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affinity and mask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are tunnel requirements for their path. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What kind of relationship can be formed in this triangle {Affinity, Mask, Attribute-Flag}?</font></font><br><br><pre> <code class="python hljs">(AFFINITY &amp;&amp; MASK) == (ATTRIBUTE &amp;&amp; MASK)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If this equality holds, the tunnel can be built through this interface. </font></font><br><br>  Consider an example. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have 32 bits and a policy - for which each of them is responsible (take the example above). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Mask, we indicate what characteristics of the channel we are interested in. </font><font style="vertical-align: inherit;">For example, for a 2G tunnel it‚Äôs important</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RRL is it or not </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trunk line or towards the access segment </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Channel via the Internet or not </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, we put 1 in the mask where it‚Äôs important what it is: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mask: 0100 0110 </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Took only the first 8 bits for simplicity. </font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that this is </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wildcard Mask</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><img src="https://habrastorage.org/web/c6f/b92/c0b/c6fb92c0b2b545a9a2006c908a763f5c.png" width="700"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Affinity, we specify what we need.</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That it was not RRL ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That it was the main link ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Channel is not via the Internet ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affinity: 0000 0100. Perform the </font></font><br><br><img src="https://habrastorage.org/web/d07/40e/fa4/d0740efa43534a6f999bdc2e218b2411.png" width="700"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation and we get: 0000 0100. </font></font><br><br><img src="https://habrastorage.org/web/ae2/c5f/50c/ae2c5f50c56f435bb85dd78059deb2ea.png" width="700"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's take three interfaces for example.</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribute-Flag 0000 0100 - Not RRL, trunk and not via the Internet. </font><font style="vertical-align: inherit;">Attribute-Flag &amp;&amp; Mask = 0000 0100 = Affinity &amp;&amp; Mask - traffic can be sent here.</font></font><br><br><img src="https://habrastorage.org/web/5e1/d52/031/5e1d52031d944133b92ca8ac99f77817.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribute-Flag 0100 0000 - Not RRL, but in the direction of the access segment, and even through the Internet. </font><font style="vertical-align: inherit;">Attribute-Flag &amp;&amp; Mask = 0100 0000 ‚â† Affinity &amp;&amp; Mask - traffic should not be allowed here.</font></font><br><br><img src="https://habrastorage.org/web/829/1a5/a40/8291a5a4094f4e1e8bd9775680564770.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribute-Flag 0000 0101 - Optics, not RRL, trunk, and not via the Internet. </font><font style="vertical-align: inherit;">Attribute-Flag &amp;&amp; Mask = 0000 0100 = Affinity &amp;&amp; Mask - traffic can be sent here. </font><font style="vertical-align: inherit;">It does not matter whether the optics or not - the result is the same.</font></font><br><br><img src="https://habrastorage.org/web/6c2/d86/b8e/6c2d86b8ef2e47ee9fe65af33555f90a.png"><br></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, when building the LSP, the value of Attribute-Flag will be taken into account on each link. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default Attribute-Flag value on the interface is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And in a sense - it is regrettable - because the result of the operation ‚ÄúAnd‚Äù with a mask will differ from the result with Affinity, which means we must configure Attribute-Flag on all interfaces. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, within the company, policies can be developed, how to tag interfaces, and how to manage traffic. You can even assign this task to the control system so that the work of the engineer can be reduced to placing ticks in the graphical interface, and the configuration would then be applied automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But in any case, this does not detract from the human factor on the one hand, and simply the incomprehensible complexity of debugging and maintenance on the other.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, there have been cases of the integrated implementation of the Administrative Group even on the networks of Russian operators. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other examples of use could be regional or country codes. Then it would be possible to ask through what geography to pass traffic. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this light, 32 bits is very small, so </font></font><a href="https://tools.ietf.org/html/rfc7308"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 7308</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> defines extended administrative groups, the number of bits in which is limited by the natural limit of LSA or MTU in general. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The guy on the fingers </font></font><a href="http://blog.codergenie.com/blog/post/2014/01/02/MPLS-TE-Affinity.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chews Affinity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and folds it in a pile with his mouth.</font></font><br><br><h3>  Practice </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very very short. Just see what works. Short because Affinity requires Attribute-Flag configuration on all nodes and all interfaces. And this is what the last thing you want, to be honest. </font></font><br><br><img src="https://habrastorage.org/web/ca3/811/a16/ca3811a1667040448c438b9baa2fc00f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue with the last configuration, where we have two tunnels. </font></font><br> <a href="https://docs.google.com/document/d/e/2PACX-1vQKReT4OtpH0fELxXf2AekJakhdikx2UHMPNOaFJRvNv3ML82Wmme65AaGgBBjEs3Ft6em1jyaLEH9v/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration file.</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tunnel42 follows the path R1-R2-R3-R4. With him and play. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default Attribute-Flag is 0x0. Therefore, we take it as Affinity - that is, all the interfaces we have under the condition. In addition to R3-R4, on which we configure Attribute-Flag 0x1. Since the equality will not be fulfilled - the CSPF will not be able to build the shortest path through this link.</font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface Tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls trafic-eng affinity <span class="hljs-number"><span class="hljs-number">0x0</span></span> mask <span class="hljs-number"><span class="hljs-number">0x1</span></span></code> </pre> <br><pre> <code class="python hljs">Linkmeup_R3(config) interface e0/<span class="hljs-number"><span class="hljs-number">0</span></span> Linkmeup_R3(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) mpls trafic-eng attribute-flags <span class="hljs-number"><span class="hljs-number">0x1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we observe how the tunnel went around this link. </font></font><br><br><img src="https://habrastorage.org/web/b05/d2f/cd6/b05d2fcd628544f8b6c43ba19998e9e8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, Tunnel4 fell apart safely. </font><font style="vertical-align: inherit;">The default Affinity value is also 0x0, but the mask is 0xFFFF. </font><font style="vertical-align: inherit;">Therefore, he also did not fit into the reconfigured link R3-R4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, we could adjust the mask 0x0 on it - ignore any Affinity and Attribute-Flag bits:</font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface Tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls trafic-eng affinity <span class="hljs-number"><span class="hljs-number">0x0</span></span> mask <span class="hljs-number"><span class="hljs-number">0x0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And then the tunnel will rise, not taking into account these restrictions. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reliability and convergence </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In practice, we have already seen that rebuilding a tunnel in the event of a breakdown takes several seconds. </font><font style="vertical-align: inherit;">Well, it was not so bad at the time of my grandfather. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole history of the development of computer networks is the story of the fight against accidents, the struggle for the speed of convergence, for the reduction of the break time. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we have in service?</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physical protection. </font><font style="vertical-align: inherit;">For example, APS to SONET or LAG to Ethernet.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP - the solution to all problems. </font><font style="vertical-align: inherit;">IGP, BGP, VRRP and so on.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A set of technologies in MPLS. </font></font></li></ol><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If evolution built people according to this principle, we would die predominantly from old age (the second reason for the number of deaths would be ‚Äúperish under its own weight‚Äù). </font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physical protection typically provides a convergence time of ¬± 50 ms. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP is good, but converges in seconds, or even minutes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MPLS TE offers two options to increase stability and reduce service interruption time.</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Path protection </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Local protection </font></font></li></ul><br><img src="https://habrastorage.org/web/ae9/ee0/337/ae9ee033751e45b88f82e7f05a9fbf51.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The first implements protection at the level of the entire LSP, the second at the level of a link or node - and it is called FRR - Fast ReRoute. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Path protection </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When setting up a tunnel, we can specify how many and which LSPs we want to build. </font></font><br><br><img src="https://habrastorage.org/web/896/f35/77a/896f3577a3cb4db8bd90e4af9e5a4793.png" width="800"><br><br><ol><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is the </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main LSP</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which will be used to transmit traffic.</font></font></li><li> <b>Secondary</b> ‚Äî <u> LSP</u> .  Ingress PE     ‚Äî     . <br>       : <br><br><ul><li> <b>Standby</b> ‚Äî  :     LSP .       .    Hot-standby. <br></li><li> <b>Non-standby</b> ‚Äî   ,  LSP  .    LSP Ingress LSP    RSVP-TE  ,     .     .   Ordinary. <br></li></ul></li><li> <b>Best Effort</b> ‚Äî            ,  RSVP-TE   -   . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection is not only and not so much about the restoration of the service, as about the speed of this recovery. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this vein, it is clear that non-standby is not the case. </font><font style="vertical-align: inherit;">Based on IGP, RSVP-TE first waits for updating the routing information, then it has to work out itself - the count for seconds. </font><font style="vertical-align: inherit;">The signal is a notification from RSVP-TE or BFD that the LSP is no longer live, or the information from the IGP about the topology change. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the Standby case, the primary RSVP LSP and the standby are built simultaneously. </font><font style="vertical-align: inherit;">Accordingly, as soon as the Ingress LSR fixes the gap of </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> main LSP </font><s><font style="vertical-align: inherit;">pattern</font></s><font style="vertical-align: inherit;"> , the traffic immediately switches to the spare one - we are threatened with losing only those packets that were sent exactly before the accident was detected.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Local Protection (FRR) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FRR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Fast Reroute - allows you to save even those cars that are already now striving for the purpose, not even knowing that the bridge has collapsed there. </font><font style="vertical-align: inherit;">That is, FRR is like a detour on the section of the road where repairs are underway, and Backup LSP is another route. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FRR uses workarounds and is described in </font></font><a href="https://tools.ietf.org/html/rfc4090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC4090. The</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> average switching time after detection of an accident is 50ms. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a thing that just turns on, and then it works automatically. </font><font style="vertical-align: inherit;">That is, from the point of view of configuration, it looks elementary. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As is usually the case, things that are simply customized, hide something interesting under a coat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, FRR has two functions:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Protect the line - Link Protection. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protect </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> node - Node Protection.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, it is called Local Protection - it does not monitor the entire LSP, but only checks the availability of the nearest link or node. </font></font><br><br><img src="https://habrastorage.org/web/31c/5ff/1f4/31c5ff1f4a544105abe88c35d001da57.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When terrible happens, it simply takes the packets to the bypass tunnel. </font></font><br><br><img src="https://habrastorage.org/web/02b/cf5/aab/02bcf5aabcd142a581e53adcc2836d20.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure a) shows line protection. On b) - protection of nodes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take LSP from R1 to R4. Each node along the path, except R4, will try to build its own workarounds. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So R1 to protect the line R1-R2 will choose the path R1-&gt; R5-&gt; R2. And to protect against the fall of the node R2: R1-&gt; R5-&gt; R6-&gt; R3. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2 must protect line R2-R3 and node R3. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETC.</font></font><br><br><blockquote><h5>  Terminology </h5><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point of Local Repair</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - point of consumption. </font><font style="vertical-align: inherit;">This is the node that initiates line or node protection. </font><font style="vertical-align: inherit;">It can be Ingress PE or any transit P, but not Egress PE </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merge Point</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the vanishing point where the protective tunnel lands. </font><font style="vertical-align: inherit;">Any transit P or Egress PE, but not Ingress PE. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primary LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protected LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">original LSP</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that requires protection. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bypass LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protective LSP</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NHOP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next Hop</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the next node after the PLR ‚Äã‚Äãin the Primary LSP. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NNHOP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next Next Hop</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - respectively the next node after Next Hop.</font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's first deal with Link Protection? </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FRR Link Protection </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The task of FRR is to save those bags that fly directly into the abyss of the collapsed link, leading them to this very Bypass LSP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the PLR ‚Äã‚Äãnotices that the line through which the transit LSP lies has fallen, it instantly redirects traffic. </font><font style="vertical-align: inherit;">Note that it is not Ingress PE that does this, but the node where the break occurred. </font><font style="vertical-align: inherit;">A link drop is fixed by a drop in an interface or a BFD session. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can compare the FRR with the arrow on the track. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To redirect packets so quickly, the Bypass LSP must be built in advance. </font><font style="vertical-align: inherit;">This is what happens. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each node in the course of Primary LSP is looking for how to get around the fall of the next link and the fall of the next hop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, it launches the full LSP engine:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CSPF to MP (NHOP for link drops and NNHOP for node drops) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sends an RSVP PATH computed path with a reservation request. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RSVP RESV if the reservation succeeds. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnels are built automatically and are not displayed in the configuration. </font><font style="vertical-align: inherit;">But otherwise, these are ordinary tunnels, through which you can view information or trace them.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technically, bare FRR requires manual tuning of all Bypass tunnels. </font><font style="vertical-align: inherit;">That is, the operator himself must provide all the places where something can break down and set up a reservation.</font></font><br>  <i>Yeah.</i> <i>   ,      .</i> <br>         ,       . <br><br>     AutoTunnel,       Primary LSP     Bypass-. <br>    Ingress LSR   : <br><br><pre> <code class="python hljs">Router(config) mpls traffic-eng auto-tunnel backup</code> </pre> <br> <i> auto-tunnel  ,    FRR-.    <a href="https://www.cisco.com/c/en/us/td/docs/ios/12_0s/feature/guide/gsautotn.html"></a> .</i> <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we need to solve two problems - </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- how to put packets from Primary LSP into this Bypass LSP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- How on MP to understand what to do with the received happiness. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is very simple - FRR LSP is a regular tunnel. That is, it is enough for us to tunnel our previous tunnel in the section from PLR to MP, which means add one more MPLS tag to each packet. There will be 3 of them: VPN, Tunnel, FRR. </font></font><br><br><img src="https://habrastorage.org/web/7c4/067/4b7/7c40674b7fc14671a86571e82db0acff.gif" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, when a packet arrives at the PLR ‚Äã‚Äãat the time of the crash, it first does the usual external label SWAP, as if it should go through the old (currently broken interface) and he also knows that you need to transfer it to the FRR tunnel - adds another tag </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the packet is switched by Bypass LSP according to standard rules - the external (FRR) label changes, and the two internal ones remain unchanged.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the last but one node, the external label is removed - PHP and before the MP the package comes with the original two. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MP receives the packet, looks at the transport label and then commutes the packet, as if nothing happened.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is important that all this works only if the global tag pool is used, and not interface-specific. </font><font style="vertical-align: inherit;">So MP does not take into account which interface the packet came from with this label.</font></font><br></blockquote><br><img src="https://habrastorage.org/web/939/867/abe/939867abe1dd4984b8af726584d1e82d.png" width="800"><br><br><img src="https://habrastorage.org/web/52c/526/c75/52c526c7515b4a539be0ff34ba7da6c9.png" width="800"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FRR Node Protection </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is absolutely the same except for the transport tag - PLR should know what label the NNHOP is waiting for. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The tunnel is now not built to the next node, but through one - NNHOP. </font><font style="vertical-align: inherit;">This is assisted by the attribute of the RSVP message - LRO (Label Request Object). </font><font style="vertical-align: inherit;">Being in the RSVP PATH, he asks the nodes to highlight tags along the way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in the RSVP RESV Label Object contains these same highlighted tags.</font></font><br><br><img src="https://habrastorage.org/web/611/e20/a48/611e20a48fa44969b76ec7ee9e48120a.png" width="800"><br><br><img src="https://habrastorage.org/web/de5/b0e/cc7/de5b0ecc71ca484fa2309324a6441d13.png" width="800"><br><br><img src="https://habrastorage.org/web/612/fb1/641/612fb1641db14b1e93f79561149a8e10.gif" width="800"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bandwidth Protection </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When signaling Bypass LSP, the question arises: whether to reserve resources. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If yes, then it is already called Bandwidth Protection. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, it usually does not make sense to reserve resources twice for the same tunnel. </font><font style="vertical-align: inherit;">Well, really - from the fact that we have taken the traffic from Primary to Bypass, it does not follow that the resources will be used twice on PLR and MP? </font><font style="vertical-align: inherit;">Moreover, the free line may not be enough. </font><font style="vertical-align: inherit;">Therefore, the concept of SE (Shared Explicit) is introduced. </font><font style="vertical-align: inherit;">If this attribute is set in the original RSVP PATH, resources will not be backed up twice - intermediate nodes will know that this is not a completely independent LSP - this is the old idea of ‚Äã‚Äãsomething.</font></font><br><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the procedure is as follows:</font></font></b> <br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When setting up a tunnel, we indicate that we want a FRR and a set of attributes of this tunnel: </font></font><br><ul><li>   ‚Äî RSVP TE       LSP ‚Äî     ,    NNHOP. </li><li>      ( ). </li><li>  SE ‚Äî / . </li></ul><br></li><li> Ingress LSR  Primary LSP. </li><li> PLR  Bypass LSP     NHOP.     : <br><br><ul><li> LSR ID  MP (NHOP     NNHOP   NHOP). </li><li>  ,  MP    FEC. </li><li>        . </li><li>      ¬´¬ª,    : SE  . </li></ul><br>    <br><br><ul><li>   Bypass LSP. </li><li>   . </li></ul><br></li><li> PLR   <br><br><ul><li>    ,         BFD  . </li><li>    ,      , BFD  RSVP     RSVP Hello. </li></ul><br></li><li> PLR      .     Ingress LSR : <br><br><ol><li>      ,   MP. </li><li>    Bypass . </li><li>      Bypass LSP. </li></ol><br></li><li>  Ingress PE      RSVP ‚Äî  ,             LSP. </li><li>    Bypass LSP,     Bypass LSP,   Bypass  ( <a href="http://lookmeup.linkmeup.ru/">PHP</a> ). </li><li> MP  MPLS    ,     , ,  ,   . </li><li>    ,  FRR   . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After switching, Ingres LSR will constantly try to restore Primary LSP using the Make-Before-Break mechanism. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When he succeeds, the new LSP will be called the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modified LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notice that MP did nothing at all - only at first it took part in building the LSP - he didn‚Äôt even know that this was some kind of Bypass LSP - for him it was a normal request from RSVP TE.</font></font><br></li></ol><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FRR Modes. </font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The only question that still needs to be discussed about FRR is which LSPs should be redirected? </font><font style="vertical-align: inherit;">He is not the only one who probably goes through this PLR? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are two options:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many-to-One</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facility mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Respectively - all will fly through one tunnel.</font></font></li><li> <b>One-to-One</b> .      LSP      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first option is preferred because it uses resources more efficiently. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All that was above about the Facility mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One-to-One introduces a couple of new terms: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detour LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spare tunnel</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Same Backup LSP, but Detour protects only one Primary LSP, </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detour Merge Point</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Same MP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This method is very similar to Facility, but there is one significant difference. In Facility mode, the existing LSPs were tunneled into the Bypass LSP, getting the third label on the stack. In the One-to-One mode, when you go around an obstacle, two labels will remain in the stack, that is, it will look and work like the most common LSP.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLR when a crash is detected, the received packets of the old LSPs will be sent in a new way, simply by performing the usual Swap transport tag. But the label and output interface will be new - from the Detour LSP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMP also performs a normal swap transport label. Instead of the Detour LSP tag, it substitutes the old one from the Primary LSP and sends it further. </font></font><br><br><img src="https://habrastorage.org/web/6a0/4f7/0fd/6a04f70fd2bc4a2aa976f6d24f5b54d0.png" width="800"><br><img src="https://habrastorage.org/web/d7f/f6d/300/d7ff6d300252485f90e45b1f5f54028e.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I disassembled the Facility mode in detail, because it is the most commonly used.</font></font><br><br><blockquote> ,       FRR,     . <br><br>   ,     ,     ,     . <br><br> ,   Juniper, One-to-One   Fast Reroute ‚Äî      .  -     FRR     .   link  link-node protection    Facility mode. <br><br> , Cisco    One-to-One,    FRR ,  MPLS-    ,    .    ‚Äî  -  . <br><br>  Cisco   ,  LSP       .  <a href="http://www.cisco.com/c/en/us/td/docs/routers/asr9000/software/asr9k_r4-2/mpls/configuration/guide/b_mpls_cg42asr9k/b_mpls_cg42asr9k_chapter_0100.html">More details</a> . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we talk about Huawei, then by default the Facility mode assumes manual tuning of the tunnels to the PLR. </font><font style="vertical-align: inherit;">But there is an Auto-FRR mode - then everything will work automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As they say, the farther into the selva, the angrier the gaucho. </font></font><br><br> <a href="http://www.cisco.com/c/en/us/td/docs/ios/12_0s/feature/guide/gslnh29.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cisco. </font></font></a> <br> <a href="http://www.juniper.net/techpubs/en_US/junos9.6/information-products/topic-collections/nog-mpls-frr/mpls-protection-overview.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juniper.</font></font></a> <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> That's all you need to know about FRR. </font></font><br><br><img src="https://habrastorage.org/web/e4e/ff3/ca9/e4eff3ca95744e55b77968e4769f6831.png" width="800"><br><br><h3>  Practice </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue with the same network from the point at which we stopped (except for affinity). </font></font><br> <a href="https://docs.google.com/document/d/e/2PACX-1vQKReT4OtpH0fELxXf2AekJakhdikx2UHMPNOaFJRvNv3ML82Wmme65AaGgBBjEs3Ft6em1jyaLEH9v/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration file.</font></font></a> <br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Path-Protection </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add Standby LSP with lower bandwidth requirements: 3 Mb / s. </font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traf path-option protect <span class="hljs-number"><span class="hljs-number">1</span></span> dynamic bandwidth <span class="hljs-number"><span class="hljs-number">3000</span></span></code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Note that Preference (1) must be the same as Primary LSP. </font></font><br></blockquote><br><img src="https://habrastorage.org/web/8ce/687/738/8ce687738331419b87261013ca42fdfe.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The path of the protective tunnel was laid down as follows: </font></font><br><br><img src="https://habrastorage.org/web/591/ed8/dd0/591ed8dd08e04b57b0ef3c190baab4da.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, on the R1-R2 line, 4 Mb / s out of 5 already occupied Tunnel42. Therefore, there is no band left for the spare LSP Tunnel4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly, the primary and backup LSPs usually use the Shared Explicit (SE) bandwidth reservation method, which means that there will not be a bandwidth reserved for the same tunnel twice. Therefore, through 10 Mb / s, the link R1-R5 managed to lay both the main LSP (8 Mb / s) and the backup (3 Mb / s). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thirdly, you can see that the backup LSP on the R6-R4 segment has chosen the same path as the main one. Therefore, the use of Explicit-path can sometimes be quite justified. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For pleasure and satisfaction, you can pull the link R2-R5 and make sure that the traffic of subscribers is almost not interrupted.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If in your current configuration your ping has stopped and is not restored, try to understand why. </font></font><br></blockquote><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Local-Protection (FRR) </font></font></h5><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are still pulling link R2-R5, please stop and return it to the Up state. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, for clarity of the FRR, you will have to remove Path-Protection. </font></font><br> <a href="https://docs.google.com/document/d/e/2PACX-1vQKReT4OtpH0fELxXf2AekJakhdikx2UHMPNOaFJRvNv3ML82Wmme65AaGgBBjEs3Ft6em1jyaLEH9v/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuration file</font></font></a> <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So we want to configure FRR for this Tunnel4. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Turn on FRR on the tunnel</font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) interface tunnel4 Linkmeup_R1(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng fast-reroute</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is logical to do this at the other end </font></font><br><br><pre> <code class="python hljs">Linkmeup_R4(config) interface tunnel1 Linkmeup_R4(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng fast-reroute</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Right after that, RSVP signaled a new attribute along the LSP. </font></font><br><br><img src="https://habrastorage.org/web/aaf/0a2/ca6/aaf0a2ca67cb4085a48a4880a6ad7bd9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He said that link protection was needed for this LSP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the tunnels do not appear yet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Now you need to enable the ability to build tunnels automatically:</font></font><br><br><pre> <code class="python hljs">Linkmeup_R1(config) mpls traffic-eng auto-tunnel backup</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does this team do? </font><font style="vertical-align: inherit;">Checks which interfaces are used for tunnels that require Local-protection, and tries to protect the link and the next node, so on each node (where it can) it builds the necessary tunnels. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, on Linkmeup_R2 would be 4:</font></font><br><br><img src="https://habrastorage.org/web/731/270/644/731270644dc64ca7bcdd2c176da94d4a.png"><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to protect the link R2-&gt; R6 (R2-&gt; R5-&gt; R6). </font></font><br><br><img src="https://habrastorage.org/web/0f7/655/580/0f76555800d346969c0a3f5f71097e99.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for protection against the fall of the node R6: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2-&gt; R6-&gt; R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (R2-&gt; R3).</font></font><br><br><img src="https://habrastorage.org/web/cb4/083/3f6/cb40833f64184be29afbdffa9a974461.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to protect the link R2-&gt; R5 (R2-&gt; R6-&gt; R5) </font></font><br><br><img src="https://habrastorage.org/web/854/00f/44b/85400f44b06945a9b2df3f763a584e68.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to protect against the fall of the node R5: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2-&gt; R5-&gt; R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (R2-&gt; R1).</font></font><br><br><img src="https://habrastorage.org/web/bf5/67a/164/bf567a16450447e7a8097d67cdaaf9db.png"><br></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Please note that protection tunnels are built without any bandwidth accounting, until this is discussed separately. </font></font><br><br><img src="https://habrastorage.org/web/8d4/4b9/912/8d44b99124ca433a9e9ac4f9b35831b9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, now I want to break the line R2-&gt; R6. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In theory, to protect this line, we have Tunnel65436 (R2-&gt; R5-&gt; R6). But then the full path will look a little strange: R1-&gt; </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5-&gt; R2-&gt; R5</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; R6-R3-&gt; R4 - that is, along the R5-R2 line, the traffic will pass twice - back and forth. Therefore, R2 briefly turns on the intellect and selects Tunnel65437, which directly leads to R3. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then on section R2-R3 we should see </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> labels in the stack - VPN and tunnel. The bypass tag will not be inserted because PHP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to see all three tags, to make sure that the FRR is working, enter the command to R2</font></font><br><br><pre> <code class="python hljs">Linkmeup_R2(config) mpls traffic-eng auto-tunnel backup nhop-only</code> </pre> <br>   R2     . <br><br><blockquote>    .    . <br><br>   ,       ,         Bypass- FRR    Primary. <br><br>   ,  Primary LSP       ICMP-.        Bypass LSP,   Primary LSP,  ,   ,  . <br><br>           ‚Äî Primary LSP      R2-&gt;R3 -   ,  Bypass LSP,   , . <br><br>     Bypass  Primary  ,      Bypass. <br></blockquote><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at the VPN and transport labels R1:</font></font></b> <br><br><img src="https://habrastorage.org/web/be6/666/40f/be666640f8a74238b21f9aee27697af8.png"><br><br><img src="https://habrastorage.org/web/e9f/824/ee5/e9f824ee59d9494792d823d1632de9ef.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH VPN - 16 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUSH Tunnel - 26 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at the table of labels on R5:</font></font></b> <br><br><img src="https://habrastorage.org/web/2d7/249/7db/2d72497db7244d4dbabab7125c4740cd.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SWAP Tunnel 26-&gt; 16 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look FRR on R2:</font></font></b> <br><br><img src="https://habrastorage.org/web/9b1/623/7d8/9b16237d83aa46b89ff65d30b59c16b5.png"><br><br><img src="https://habrastorage.org/web/fd6/23f/fe7/fd623ffe778b4eb0aa178f60827e58fd.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SWAP Tunnel 16-&gt; 27 (label that is waiting for NHOP) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUSH Bypass Implicit Null - that is, the label is not really inserted. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tags on R3:</font></font></b> <br><br><img src="https://habrastorage.org/web/0c1/278/ab7/0c1278ab793948dcb777c16d911fb9ac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHP: POP Tunnel 27 (wait). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at the dump on the site - 2 tags (implicit null was not really added):</font></font></b> <br><br><img src="https://habrastorage.org/web/25f/d95/c55/25fd95c55b5e4e8dbc74db27ed232635.png"><br><br>  Perfectly! <br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And finally, a couple of light topics without practice. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MPLS QoS </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A separate issue will be dedicated to QoS. </font></font> Get ready.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But not to talk a little about it now would be unforgivable. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MPLS TE IntServ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So MPLS TE uses the IntServ QoS paradigm - pre-reservation of resources all the way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, we are initially confident that the necessary band (and other requirements) will be provided to the service. </font><font style="vertical-align: inherit;">In this case, the packets inside the tunnel (LSP) are all equivalent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, it happens that the client traffic grows. </font><font style="vertical-align: inherit;">Maybe at some point its volume exceeds the static threshold, and there is no longer a free band, or Autobandwidth has not yet managed to work out the speed increase. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One way or another, packets are beginning to be discarded, and without any parsing whether they are important or not. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, the idea of ‚Äã‚ÄãIntServ in the MPLS TE implementation by itself does not guarantee that there will be no problems on every single node.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MPLS TE DiffServ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And who is responsible for Per-Hop Behavior? Remind me? DiffServ? And if we do not combine these two beautiful paradigms? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indeed, in the MPLS header there is an EXP field, which was planned to be an Expeditional, but it has long been </font></font><a href="https://tools.ietf.org/html/rfc5462"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">officially</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used to set the priority of packets and is called the Traffic class. That's just the old habit of it and now continue to call EXP, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is called MPLS DiffServ-aware Traffic Engineering - MPLS DS-TE. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The idea, generally speaking, is to provide MPLS-packages with the quality of service expected by the original packages. That is, ideally, it is necessary to make a 1 to 1 correspondence. But EXP is only 3 bits, that is, 8 priority values, while DSCP is 6 bits (64 values), whatever one may say, but the details with such archiving are lost.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, there are two approaches: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E-LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXP-Inferred LSP</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To score and rejoice at what we have. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L-LSP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Label-Inferred LSP</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Encode priority with EXP + tag.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E-lsp </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the case when we initially deal with the DSCP field, we transfer only the three most significant (left) bits of the DSCP to MPLS EXP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And yes, we accept the loss of detail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the PDU arrives at the Ingress LSR, we place it in the tunnel and set the priority in the EXP field. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, for example, in one tunnel we will have the data of broadband access and fixed telephony. </font><font style="vertical-align: inherit;">Naturally, we will give priority to telephony 5, and everything else to 0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then even if a traffic jam occurs within one tunnel, the weak will die first.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L-lsp </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, the QoS data is encoded into a bunch of Tag + EXP. </font><font style="vertical-align: inherit;">It is assumed that the label specifies the processing mechanism in the queues, and the label - the priority of packet drop. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHB information must be signaled during the installation of the LSP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each L-LSP carries only one type of service. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Today, operators for the most part define four traffic classes: BE, AF, EF and CS. </font><font style="vertical-align: inherit;">E-LSP is more than enough for this, so L-LSP is not only practically not used, but moreover, not all vendors have it. </font><font style="vertical-align: inherit;">Therefore, I will not dwell further on the comparison of methods.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> QoS Modes </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But what is interesting is what CoS field to trust on each node: IP DSCP, Tunnel EXP or VPN EXP? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are three modes:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uniform mode </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pipe mode </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Short-Pipe Mode </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember, already faced with such concepts when parsing TTL in </font></font><a href="http://linkmeup.ru/blog/204.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MPLS L3VPN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Something similar here.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uniform mode </font></font></h3><br>    End-to-End. <br><br><img src="https://habrastorage.org/web/e50/932/53b/e5093253bcf94dc091f88500be2b6f9d.png" width="1000"><br><br>  Ingress PE   IP DSCP   ( <i> , ,      ¬´¬ª</i> )    MPLS EXP ( ,   VPN ).    Ingress PE         EXP   MPLS. <br><br>   P       EXP.       ,    . <br><br>      (PHP)    EXP  VPN-.  ,    ‚Äî   Uniform,  . <br><br> Egress PE   VPN,    EXP  IP DSCP,     . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> That is, if somewhere in the middle the value of the EXP tag in the tunnel header has changed, then this change will be inherited by the IP packet. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pipe mode </font></font></h3><br><img src="https://habrastorage.org/web/5a1/f9a/a46/5a1f9aa46bb94ed88d62185535f5b41e.png" width="1000"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If, on Ingress PE, we decided not to trust the DSCP value, then the EXP value that the operator wishes is inserted into the MPLS headers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But it is permissible to copy those that were in the DSCP. For example, you can override the values ‚Äã‚Äã‚Äî copy everything up to EF, and CS6 and CS7 map to EF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each transit P looks only at the EXP of the upper MPLS header. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last but one node removes the transport label (PHP) and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the EXP value to the VPN header. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Egress PE first processes the packet, based on the EXP field in the MPLS header, and only then removes it, while </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not copying the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> value in the DSCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, regardless of what happened to the EXP field in the MPLS headers, IP DSCP remains unchanged.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Such a scenario can be used when the operator has his own domain Diff-Serv, and he does not want client traffic to somehow influence him. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Short-Pipe Mode </font></font></h3><br><img src="https://habrastorage.org/web/f80/1c8/e2d/f801c8e2dac84ff1b376a5f68824d93e.png" width="1000"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This mode can be viewed as a variation of Pipe-mode. </font><font style="vertical-align: inherit;">The only difference is that at the exit from the MPLS network, the packet is processed in accordance with its IP DSCP field, and not MPLS EXP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means that the priority of a packet at the exit is determined by the client, and not by the operator. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ingress PE does not trust IP DSCP incoming packets. </font><font style="vertical-align: inherit;">Transit Ps look in the EXP header field. </font><font style="vertical-align: inherit;">The penultimate P removes the transport label and copies the value to the VPN label. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Egress PE first removes the MPLS label, then processes the packet in queues. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explanation from </font></font><a href="http://www.cisco.com/c/en/us/support/docs/multiprotocol-label-switching-mpls/mpls/47815-diffserv-tunnel.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cisco</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><hr><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Simplify Tunnel Tuning </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a typical carrier network, BGP-based L3 / L2VPN with Auto-Discovery and dedicated BGP Route Reflector are being deployed to scale and reduce load. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If LDP LSP is used as a transport, then MPLS tunnels automatically form a fully connected topology. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In such circumstances, the addition of a new PE requires only the configuration of this new PE and RR. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, the situation is quite different if on the RSVP-TE transport. </font><font style="vertical-align: inherit;">If there are a lot of PE nodes, it can be a headache to set up tunnels between all the necessary pairs of routers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are two approaches that allow you to avoid this conformational madness.</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LDP over TE </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RSVP Auto-Mesh </font></font></li></ul><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LDP over TE </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This approach does not require new functionality. </font><font style="vertical-align: inherit;">A hierarchy is introduced - a fully meshed system of TE tunnels between P routers rises in a certain unchanging core of the network. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done once and never changes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And ordinary PE routers to each other build LDP LSP. </font></font><br><br><img src="https://habrastorage.org/web/155/6b5/c29/1556b5c29a624f1a9607928d6fb9870d.png" width="800"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the stack of the MPLS packet moving in the network core, there will be three labels ‚Äî VPN, LDP, RSVP-TE. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, LDP LSP, as if tunneled in RSVP LSP. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e3f/892/647/e3f892647291b93814b2a1b3342d3650.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Illustration from the site </font></font><a href="http://www.nexthop.me/ldp-over-rsvp-te/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.nexthop.me</font></font></a></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On, let's call it, the access segment, we have a comfortable and cozy LDP, and in the core of the network (this can be a long-distance trunk line), it is possible to control traffic.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RSVP Auto-Mesh / Auto-Tunnel </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a small but extremely useful improvisation that allows you to automate the tuning of tunnels. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as a new PE device appears in TEDB, direct and reverse tunnels are instantly built with it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the configuration? </font><font style="vertical-align: inherit;">A preconfiguration pattern is created for the tunnel interface. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do I know if a new node is PE? </font><font style="vertical-align: inherit;">The template indicates the ACL, which determines with whom you can build. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, we take the rule that the PE nodes Loopback 127 interface will be 10.127.127.0/24, and announce it in IGP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simplest configuration will look like this:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> With a familiar command, we enable the Auto-tunnel feature in Mesh mode: </font></font><br><br><pre> <code class="python hljs">Router(config) mpls traffic-eng auto-tunnel mesh</code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Identify potential PEs in an ACL: </font></font><br><br><pre> <code class="python hljs">Router(config) ip access-list standard <span class="hljs-number"><span class="hljs-number">1</span></span> Router(config-std-nacl) permit source <span class="hljs-number"><span class="hljs-number">10.127</span></span><span class="hljs-number"><span class="hljs-number">.127</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span></code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We get a configuration template: </font></font><br><br><pre> <code class="python hljs">Router(config) interface auto-template <span class="hljs-number"><span class="hljs-number">1</span></span> Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) ip unnumbered Loopback127 Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mode mpls Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng autoroute announce Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng priority <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng auto-bw Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel mpls traffic-eng path-option <span class="hljs-number"><span class="hljs-number">4</span></span> dynamic Router(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>) tunnel destination access-list <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br></li></ol><br><hr><br><h1>  Conclusion </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I would like to summarize in one sentence: everything that was described in this article is really found in this world and not at all locks on the sand. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, briefly repeat:</font></font><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MPLS TE uses RSVP-TE as a label distribution and resource reservation protocol. </font><font style="vertical-align: inherit;">And he, in turn, relies on </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LS IGP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OSPF with its Opaque LSA </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IS-IS with </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLV</font></font></a> </li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can control how RSVP LSP is built in the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> following ways:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Metric (IGP or TE) </font></font></li><li>  Resource requirements </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explicit-path </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SRLG </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Administrative Groups / Affinity </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IGP distributes and writes to TEDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> information about:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Line condition </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Metrics </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Free Resources with Hold Priority </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SRLG </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Attribute-Flag / Administrative Group </font></font></li></ul><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When calculating the shortest routes, CSPF takes the requirements from the TE-Tunnel configuration, and the restrictions from the TEDB. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel Requirements:</font></font></b> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Required lane and installation priority </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Affinity / Administrative Group </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explicit-Path </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSVP-TE transmits in its messages:</font></font></b> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Required band for reservation with priority of setting and holding </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Mode - SE or FF </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ERO - LSP node list </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RRO - a real list of nodes and tags on each site </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FRR Needs Information </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can </font><b><font style="vertical-align: inherit;">send traffic to the tunnel in</font></b><font style="vertical-align: inherit;"> two main ways:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Static route or PBR </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IGP Shortcut (or Forwarding Adjacencies) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vendor-dependent mechanisms: automatically on Juniper or Tunnel-policy on Huawei / HP </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make-Before-Break:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is a widely used concept in MPLS TE ‚Äî get it first! </font><font style="vertical-align: inherit;">Before breaking something that is already working, build a new LSP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Used when:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Re-optimizing tunnels </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FRR </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An important tunnel is trying to oust the less important. </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shared Explicit or Fixed Filter:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closely related to MBB concepts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shared Explicit (SE) - two different reservations (LSP) for one tunnel are considered related and the rinsing strip will not be reserved twice. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fixed Filter (FF) - different LSPs from the same sender are always considered independent and the band for them is reserved separately. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The SE mode is very convenient in the MBB mechanism, and in general, the FRR and re-optimization capabilities are often disabled in the FF mode.</font></font><br><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel Protection:</font></font></b> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When the line / node breaks, FastReRoute fulfills the first 50 ms, saving those packets that already go to the LSP. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Then the Ingress LSR finds out about the problems with the main LSP and redirects traffic to the backup LSP ‚Äî all subsequent packets are already saved. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Next, Ingress LSR attempts to restore the primary LSP to bypass the problem area, if possible. </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tunnel priority:</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Each tunnel has two meanings:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Setup Priority </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hold Priority. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usually they are equal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 - the highest, 7 - the lowest. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tunnel with a higher Setup Priority value will crowd out the established tunnel with a lower Hold Priority.</font></font><br><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adjustment simplification mechanisms:</font></font></b> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LDP over TE </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RSVP Auto-Mesh / Auto-tunnel </font></font></li></ul><br><hr><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CoS field processing rules in MPLS DS-TE:</font></font></b> <br><br><ul><li> Uniform.           CoS  PDU      . </li><li> Pipe.   CoS  PDU  . Egress PE      MPLS. </li><li> Short-pipe.   CoS  PDU  . Egress PE       CoS PDU. </li></ul><br><hr><br><h1>  useful links </h1><br><ul><li>    cisco   MPLS TE.    : <br><br><ol><li> <a href="https://www.cisco.com/c/en/us/td/docs/ios/12_0s/feature/guide/TE_1208S.pdf">MPLS Traffic Engineering</a> </li><li> <a href="https://www.cisco.com/c/en/us/products/collateral/ios-nx-os-software/multiprotocol-label-switching-traffic-engineering/whitepaper_c11-551235.html">Advanced Topics in MPLS-TE Deployment</a> </li><li> <a href="http://lvk.cs.msu.su/~vbabernov/BRKMPL-2100.pdf">Deploying MPLS Traffic Engineering</a> </li></ol><br></li><li> Cisco   FRR: <a href="https://www.cisco.com/c/dam/en/us/products/collateral/ios-nx-os-software/multiprotocol-label-switching-mpls/mpls_te_frr.pdf">MPLS Traffic Engineering. Traffic Protection using Fast Re-route (FRR)</a> </li><li>    Autobandwidth: <a href="https://ripe64.ripe.net/presentations/52-mpls-autobandwidth.pdf">Deploying MPLS Traffic Engineering</a> </li><li> <a href="http://blog.codergenie.com/blog/post/2014/01/02/MPLS-TE-Affinity.aspx">MPLS TE Affinity</a> </li><li> <a href="https://www.cisco.com/c/en/us/support/docs/multiprotocol-label-switching-mpls/mpls/47815-diffserv-tunnel.html">DiffServ Tunneling Modes for MPLS Networks</a> </li><li>     MPLS: <a href="http://labminutes.com/video/sp">labminutes.com</a> </li></ul><br><hr><blockquote><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Someone will say: SDTSM is becoming more and more strange. </font><font style="vertical-align: inherit;">You break away from reality. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And it will be wrong: next time, let us return to the burning topics - QoS. </font><font style="vertical-align: inherit;">The long-awaited, promising, and how difficult, as much and useless. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be the same trash and waste for 140k characters, but about what you work with every day.</font></font></h3></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I also remind you that the list of the best books on networks is </font></font><a href="http://linkmeup.ru/page/bb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All abbreviations used in the article can be found in the </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linkmeup glossary</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>  <b>Thanks</b> <br> <a href="https://www.linkedin.com/in/andrey-glazkov-5a8283b3/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andrei Glazkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://www.linkedin.com/in/alex-clipper-93a2533%3Ftrk%3Dhp-identity-name"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexander Klipper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://ru.linkedin.com/in/loxmatiymamont"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexander Fatin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for reading material and comments. </font></font><br> <a href="http://illustrators.ru/users/rabbits_manufactory"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artem Chernobay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the illustration. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My wife and children who were deprived, but allowed to close the topic MPLS.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All issues SDSM ...</font></font></b> <div class="spoiler_text"> <a href="http://linkmeup.ru/blog/261.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. Networks for the harshest. </font><font style="vertical-align: inherit;">Part twelfth. </font><font style="vertical-align: inherit;">MPLS L2VPN</font></font></a> <br>  <a href="http://linkmeup.ru/blog/248.html">11.1.</a> <a href="http://linkmeup.ru/blog/248.html">   .  ‚Ññ6. MPLS L3VPN    </a> <br> <a href="http://linkmeup.ru/blog/204.html">11.    .  . MPLS L3VPN</a> <br> <a href="http://linkmeup.ru/blog/154.html">10.    .  .  MPLS</a> <br> <a href="http://linkmeup.ru/blog/129.html">9.    .  . </a> <br> <a href="http://linkmeup.ru/blog/92.html">8.1    .  ‚Ññ3. IBGP</a> <br> <a href="http://linkmeup.ru/blog/65.html">8.    .  . BGP  IP SLA</a> <br> <a href="http://linkmeup.ru/blog/50.html">7.    .  .</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br> <a href="http://linkmeup.ru/blog/33.html">6.    .</a>  <a href="http://linkmeup.ru/blog/33.html">Part six.</a> <a href="http://linkmeup.ru/blog/33.html"> </a> <br> <a href="http://linkmeup.ru/blog/16.html">5.    :  . NAT  ACL</a> <br> <a href="http://linkmeup.ru/blog/15.html">4.    :  . STP</a> <br> <a href="http://linkmeup.ru/blog/14.html">3.    :  .  </a> <br> <a href="http://linkmeup.ru/blog/13.html">2.    .</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a> <a href="http://linkmeup.ru/blog/13.html"></a> <br> <a href="http://linkmeup.ru/blog/12.html">1.    .</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a> <a href="http://linkmeup.ru/blog/12.html">   cisco</a> <br> <a href="http://linkmeup.ru/blog/11.html">0.    .  .</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/338578/">https://habr.com/ru/post/338578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338562/index.html">20 years to Yandex. Lecture by Ilya Segalovich - the person who invented this word</a></li>
<li><a href="../338564/index.html">Your own Python cover server for Internet radio</a></li>
<li><a href="../338568/index.html">Creating the Google Maps API Maps Component with VueJs2</a></li>
<li><a href="../338572/index.html">Eggs Datacenter: how Emercoin allowed to implement the idea of ‚Äã‚Äãa distributed data center on the blockchain</a></li>
<li><a href="../338576/index.html">Facebook Messenger bug or feature - Poll</a></li>
<li><a href="../338580/index.html">How on animeshniki cryptocurrency mined</a></li>
<li><a href="../338582/index.html">We work with long API in ASP.NET Core correctly or the subtleties of moving to a new platform</a></li>
<li><a href="../338584/index.html">The implementation of "Tetris" in the game "Life"</a></li>
<li><a href="../338590/index.html">ViewModel and LiveData: patterns and antipatterns</a></li>
<li><a href="../338592/index.html">The digest of interesting materials for the mobile developer # 222 (September 18 - 24)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>