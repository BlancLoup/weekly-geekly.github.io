<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Table binding in Model :: find ()</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation notes on Bakery by Nate, one of the authors of CakePHP. It seemed to me interesting and illustrating how this framework works, but difficu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Table binding in Model :: find ()</h1><div class="post__text post__text-html js-mediator-article">  <em>Translation notes on <a href="http://bakery.cakephp.org/articles/view/quick-tip-doing-ad-hoc-joins-in-model-find">Bakery</a> by Nate, one of the authors of CakePHP.</em>  <em>It seemed to me interesting and illustrating how this framework works, but difficult to understand in English.</em> <br><br>  This note describes a little-known technique that allows you to join tables (joins) in CakePHP queries directly, without using the bind and unbind methods. <br><br>  Note: Reception will work only if you use the new syntax Model :: find (), which has only two parameters.  Otherwise, read the <a href="http://book.cakephp.org/view/449/find">Cookbook</a> or API. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  One of the "chips" design CakePHP - "layering."  For example: many Helper methods accept the $ options parameter, and methods built on their basis (see the FormHelper or PaginatorHelper methods) allow you to transfer some settings to the lower levels, providing the ability to fine-tune even from high levels of abstraction. <br><br>  So with the models: all parameters passed to Model :: find () are then passed to DboSource for processing, which is responsible for generating SQL queries.  That is, you can transfer some parameters, in particular the ‚Äújoins‚Äù parameter, from a higher level to DboSource. <br><br>  One of the most common examples is the search for tags that relate to the model as ‚Äúmany-to-many‚Äù (hasAndBelongsToMany).  Usually this is achieved by binding models or writing the query manually.  But the same result can be achieved by simply describing the relationship using the "joins" parameter. <br>  At the moment I am working on a single project that allows you to leave marks on the map and look for marks by their tags.  In the search form for tags sent by the ‚Äúget‚Äù method, there is a text field ‚Äúq‚Äù, which accepts space-separated tags.  Here is an example of the code for searching in MarkersController: <br><br><blockquote><code><font color="#000000"><font color="#0000BB">&lt;?php <br> $markers</font> <font color="#007700">=</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;</font> <font color="#0000BB">Marker</font> <font color="#007700">-&gt;</font> <font color="#0000BB">find</font> <font color="#007700">(</font> <font color="#DD0000">'all'</font> <font color="#007700">, array(</font> <font color="#DD0000">'joins'</font> <font color="#007700">=&gt; array( <br> array( <br></font> <font color="#DD0000">'table'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'markers_tags'</font> <font color="#007700">, <br></font> <font color="#DD0000">'alias'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'MarkersTag'</font> <font color="#007700">, <br></font> <font color="#DD0000">'type'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'inner'</font> <font color="#007700">, <br></font> <font color="#DD0000">'foreignKey'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">false</font> <font color="#007700">, <br></font> <font color="#DD0000">'conditions'</font> <font color="#007700">=&gt; array(</font> <font color="#DD0000">'MarkersTag.marker_id = Marker.id'</font> <font color="#007700">) <br> ), <br> array( <br></font> <font color="#DD0000">'table'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'tags'</font> <font color="#007700">, <br></font> <font color="#DD0000">'alias'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'Tag'</font> <font color="#007700">, <br></font> <font color="#DD0000">'type'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'inner'</font> <font color="#007700">, <br></font> <font color="#DD0000">'foreignKey'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">false</font> <font color="#007700">, <br></font> <font color="#DD0000">'conditions'</font> <font color="#007700">=&gt; array( <br></font> <font color="#DD0000">'Tag.id = MarkersTag.tag_id'</font> <font color="#007700">, <br></font> <font color="#DD0000">'Tag.tag'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">explode</font> <font color="#007700">(</font> <font color="#DD0000">' '</font> <font color="#007700">,</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;</font> <font color="#0000BB">params</font> <font color="#007700">[</font> <font color="#DD0000">'url'</font> <font color="#007700">][</font> <font color="#DD0000">'q'</font> <font color="#007700">]) <br> ) <br> ) <br> ))); <br></font> <font color="#0000BB">?&gt;</font></font></code> </blockquote> <br><br>  We get automatic filtering in the many-to-many relationship.  However, for this you will have to write quite a lot of code and make a lot of extra gestures.  Let's see if you can rework the code so that it is more convenient for later use. <br><br><blockquote> <code><font color="#000000"><font color="#0000BB">&lt;?php <br></font> <font color="#007700">class</font> <font color="#0000BB">AppModel</font> <font color="#007700">extends</font> <font color="#0000BB">Model</font> <font color="#007700">{ <br></font> <font color="#0000BB">public</font> <font color="#007700">function</font> <font color="#0000BB">find</font> <font color="#007700">(</font> <font color="#0000BB">$type</font> <font color="#007700">,</font> <font color="#0000BB">$options</font> <font color="#007700">= array()) { <br> if (!isset(</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'joins'</font> <font color="#007700">])) { <br></font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'joins'</font> <font color="#007700">] = array(); <br> } <br> switch (</font> <font color="#0000BB">$type</font> <font color="#007700">) { <br> case</font> <font color="#DD0000">'matches'</font> <font color="#007700">: <br> if (!isset(</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">]) || !isset(</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'scope'</font> <font color="#007700">])) { <br> break; <br> } <br></font> <font color="#0000BB">$assoc</font> <font color="#007700">=</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;</font> <font color="#0000BB">hasAndBelongsToMany</font> <font color="#007700">[</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">]]; <br></font> <font color="#0000BB">$bind</font> <font color="#007700">=</font> <font color="#DD0000">"{$assoc['with']}.{$assoc['foreignKey']} = {$this-&gt;alias}.{$this-&gt;primaryKey}"</font> <font color="#007700">; <br> <br></font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'joins'</font> <font color="#007700">][] = array( <br></font> <font color="#DD0000">'table'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$assoc</font> <font color="#007700">[</font> <font color="#DD0000">'joinTable'</font> <font color="#007700">], <br></font> <font color="#DD0000">'alias'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$assoc</font> <font color="#007700">[</font> <font color="#DD0000">'with'</font> <font color="#007700">], <br></font> <font color="#DD0000">'type'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'inner'</font> <font color="#007700">, <br></font> <font color="#DD0000">'foreignKey'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">false</font> <font color="#007700">, <br></font> <font color="#DD0000">'conditions'</font> <font color="#007700">=&gt; array(</font> <font color="#0000BB">$bind</font> <font color="#007700">) <br> ); <br></font> <font color="#0000BB">$bind</font> <font color="#007700">=</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">] .</font> <font color="#DD0000">'.'</font> <font color="#007700">.</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;{</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">]}-&gt;</font> <font color="#0000BB">primaryKey</font> <font color="#007700">.</font> <font color="#DD0000">' = '</font> <font color="#007700">; <br></font> <font color="#0000BB">$bind</font> <font color="#007700">.=</font> <font color="#DD0000">"{$assoc['with']}.{$assoc['associationForeignKey']}"</font> <font color="#007700">; <br></font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'joins'</font> <font color="#007700">][] = array( <br></font> <font color="#DD0000">'table'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;{</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">]}-&gt;</font> <font color="#0000BB">table</font> <font color="#007700">, <br></font> <font color="#DD0000">'alias'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">], <br></font> <font color="#DD0000">'type'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'inner'</font> <font color="#007700">, <br></font> <font color="#DD0000">'foreignKey'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">false</font> <font color="#007700">, <br></font> <font color="#DD0000">'conditions'</font> <font color="#007700">=&gt; array(</font> <font color="#0000BB">$bind</font> <font color="#007700">) + (array)</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'scope'</font> <font color="#007700">], <br> ); <br> unset(</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'model'</font> <font color="#007700">],</font> <font color="#0000BB">$options</font> <font color="#007700">[</font> <font color="#DD0000">'scope'</font> <font color="#007700">]); <br></font> <font color="#0000BB">$type</font> <font color="#007700">=</font> <font color="#DD0000">'all'</font> <font color="#007700">; <br> break; <br> } <br> return</font> <font color="#0000BB">parent</font> <font color="#007700">::</font> <font color="#0000BB">find</font> <font color="#007700">(</font> <font color="#0000BB">$type</font> <font color="#007700">,</font> <font color="#0000BB">$options</font> <font color="#007700">); <br> } <br> }</font> <font color="#0000BB">?&gt;</font></font></code> <br> </blockquote><br>  So instead of rigidly defining connections for one association, we make the code more universal and place it inside the AppModel.  Thus, we can use it for any many-to-many relationship and any field of a related table. <br>  Before we figure out how the code works, let's see how to use it: <br><br><blockquote> <code><font color="#000000"><font color="#0000BB">&lt;?php <br> $markers</font> <font color="#007700">=</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;</font> <font color="#0000BB">Marker</font> <font color="#007700">-&gt;</font> <font color="#0000BB">find</font> <font color="#007700">(</font> <font color="#DD0000">'matches'</font> <font color="#007700">, array( <br></font> <font color="#DD0000">'model'</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'Tag'</font> <font color="#007700">, <br></font> <font color="#DD0000">'scope'</font> <font color="#007700">=&gt; array(</font> <font color="#DD0000">'Tag.tag'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">explode</font> <font color="#007700">(</font> <font color="#DD0000">' '</font> <font color="#007700">,</font> <font color="#0000BB">$this</font> <font color="#007700">-&gt;</font> <font color="#0000BB">params</font> <font color="#007700">[</font> <font color="#DD0000">'url'</font> <font color="#007700">][</font> <font color="#DD0000">'q'</font> <font color="#007700">])) <br> )); <br></font> <font color="#0000BB">?&gt;</font></font></code> </blockquote> <br><br>  Now, carefully ‚Äúhiding‚Äù the logic in the model, we only indicate the name of the associated model and the filtering criteria when linking instead of building entangled links in the controller.  Since the specified filtering is used only for searching strings and does not affect the list of requested fields, data is returned in the same format as usual, without transferring unnecessary information. <br><br>  The method we have reworked is very simple if you look at it.  For each link, we do what CakePHP usually does, using the associative links specified for the model ‚Äî we fill in the ‚Äújoins‚Äù parameter.  The $ bind variable is used to form a string that defines the foreign key relationship for the tables being linked.  We also use INNER JOIN instead of LEFT JOIN, since we do not need records that do not meet our filtering criteria. <br><br>  I hope this advice will help you in your work.  If you have any questions or comments - write. </div><p>Source: <a href="https://habr.com/ru/post/50302/">https://habr.com/ru/post/50302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50290/index.html">The best movie and cybersquatters</a></li>
<li><a href="../50293/index.html">The idea for the competition. Criticize.</a></li>
<li><a href="../50294/index.html">Startup - or birth, or reality.</a></li>
<li><a href="../50298/index.html">Socio-creative photo project</a></li>
<li><a href="../50299/index.html">Google ocean</a></li>
<li><a href="../50305/index.html">Fresh modification of the OSX.Trojan.iServices trojan</a></li>
<li><a href="../50310/index.html">The basics</a></li>
<li><a href="../50312/index.html">Building a relational structure from the ER model</a></li>
<li><a href="../50314/index.html">Four generations of SaaS</a></li>
<li><a href="../50317/index.html">Experience setting up nginx on debian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>