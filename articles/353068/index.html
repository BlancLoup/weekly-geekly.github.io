<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sending mail from the Docker container (postfix and sasl dokerization)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I placed the application in the Docker-container and tried to send email to the mail server in another Docker-container, I ran into an unexpected...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sending mail from the Docker container (postfix and sasl dokerization)</h1><div class="post__text post__text-html js-mediator-article">  When I placed the application in the Docker-container and tried to send email to the mail server in another Docker-container, I ran into an unexpected problem.  By default, the postfix mail server sends mail to an arbitrary recipient domain only from the local client.  All other domains need to be registered in the relay_domains parameter, and if the mynetwors parameter is configured correctly, mail will be sent to the domains listed in the relay_domains parameter from the client from mynetwors. <br><br>  In principle, this was enough for me, because  the application theoretically had to send mail to exactly one corporate mail server.  But this solution did not suit me very well, because the task may change at any time.  Therefore, I tried to configure sasl-authorization, which allows sending mail to authorized users on an arbitrary domain. <br><a name="habracut"></a><br><br>  The first solution I tried was to install postfix outside the Docker container and send messages from the Docker container directly to port 25 on it.  Of course, I was disappointed, because  localhhost inside a container has nothing to do with localhost outside a container. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, you would have to access postfix not through localhost.  Yes, and initially the goal was to install everything in containers, and not to depend on the environment on the server.  That is, it was desirable to install postfix in a container. <br><br>  An additional advantage of installing postfix inside the container is that it is completely closed to the outside world, unless you explicitly publish its port to docker-compose, which is naturally easier to control than the exotic parameters in the configuration files of postfix itself. <br><br>  In order to be able to access the postfix server that runs inside the container, you need to configure authorization.  The most popular solution is sasl authentication.  I decided to configure it using sasldb2.  As it turned out, there were not too many detailed instructions for installing sasl for postfix using sasldb2.  Some instructions contained outdated information and did not contain the necessary information.  As a result, from the first time authorization stubbornly refused to work.  As it turned out, the two main reasons were: use of the postfix server to the file system in the sandbox / var / spool / postfix /, which sasl knows nothing about, and the need to distribute rights to the database file / etc / sasldb2, which the user sasl creates - user postfix. <br><br>  The resulting Dockerfile file is quite simple, although I had to tinker with when searching for a solution, mainly with user rights, which I will discuss in more detail. <br><br><pre><code class="hljs swift"><span class="hljs-type"><span class="hljs-type">FROM</span></span> ubuntu:xenial <span class="hljs-type"><span class="hljs-type">ARG</span></span> <span class="hljs-type"><span class="hljs-type">UID</span></span> <span class="hljs-type"><span class="hljs-type">RUN</span></span> \ useradd -u $<span class="hljs-type"><span class="hljs-type">UID</span></span> www-arc &amp;&amp; \ apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> update &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install tzdata &amp;&amp; \ echo <span class="hljs-type"><span class="hljs-type">Europe</span></span>/<span class="hljs-type"><span class="hljs-type">Kiev</span></span> | tee /etc/timezone &amp;&amp; \ dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; \ apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y <span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span> rsyslog sasl2-bin &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"mydestination = localhost"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"myhostname = example.com"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"always_bcc = www-arc@localhost"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"smtpd_sasl_auth_enable=yes"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"broken_sasl_auth_clients=yes"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"smtpd_relay_restrictions=permit_sasl_authenticated,reject_unauth_destination"</span></span> &amp;&amp; \ postconf -e <span class="hljs-string"><span class="hljs-string">"smtpd_sasl_security_options = noanonymous"</span></span> &amp;&amp; \ echo <span class="hljs-number"><span class="hljs-number">123456</span></span> | saslpasswd2 -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> -p -u example.com <span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span> &amp;&amp; \ ln /etc/sasldb2 /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/<span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span>/etc/sasldb2 &amp;&amp; \ adduser <span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span> sasl &amp;&amp; \ touch /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/mail.log <span class="hljs-type"><span class="hljs-type">COPY</span></span> ./smtpd.conf /etc/<span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span>/sasl/smtpd.conf <span class="hljs-type"><span class="hljs-type">CMD</span></span> service rsyslog start &amp;&amp; service <span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span> start &amp;&amp; tail -f /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/mail.log</code> </pre> <br>  <code>ln /etc/sasldb2 /var/spool/postfix/etc/sasldb2</code> By default, postfix works with the file system in the sandbox / var / spool / postfix /.  There he will look for a file with logins / etc / sasldb2.  Therefore, we set the link to the / etc / sasldb2 file from the sandbox to the real file.  The link should only be hard (without the -s option). <br><br>  <code>adduser postfix sasl</code> is quite understandable and very important action allows postfix to work with the file / var / spool / postfix / etc / sasldb2. <br><br>  The <code>postconf -e "smtpd_recipient_restrictions=permit_sasl_authenticated,reject_unauth_destination"</code> rule allows you to send mail to an arbitrary domain to all authenticated sasl clients. <br><br>  The sasl authorization configuration in the ./smtpd.conf file: <br><br><pre> <code class="hljs pgsql">log_level: <span class="hljs-number"><span class="hljs-number">3</span></span> pwcheck_method: auxprop auxprop_plugin: sasldb mech_list: PLAIN <span class="hljs-keyword"><span class="hljs-keyword">LOGIN</span></span> CRAM-MD5 DIGEST-MD5 NTLM</code> </pre><br>  The <code>postconf -e "mydestination = localhost"</code> parameter <code>postconf -e "mydestination = localhost"</code> says that mail for this domain should not be sent further, but received on this host.  As experience shows, mail servers that should receive mail are very often configured incorrectly, losing mail.  Sometimes this is critical.  can harm the business if the mailing message contains a customer application for the purchase of a product or service.  Therefore, this configuration is configured to send a copy to the local recipient <code>postconf -e "always_bcc = www-arc@localhost"</code> .  This recipient is created with the current user ID of <code>useradd -u $UID www-arc</code> . <br><br>  The current user is defined in the docker-compose configuration: <br><br><pre> <code class="hljs swift"> <span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span>: build: context: ./docker/<span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span> args: - <span class="hljs-type"><span class="hljs-type">UID</span></span> volumes: - ./docker/<span class="hljs-keyword"><span class="hljs-keyword">postfix</span></span>/mail:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/mail</code> </pre><br>  When building, the current user is transferred from the <code>env UID=$UID docker-compose build</code> environment. <br><br>  To connect from another docker container to this service, you need to specify postfix (the name of the service from docker-compose.yml) as the host, and the name with regard to the domain (postfix@example.com) and password.  In all cases, the postfix name is optional and is configured in the configuration. <br><br>  Setting up mail on the application side and on the mail service side is not even half of what needs to be done.  All that needs to be done in addition to this in the settings of the domain often lies outside the control of the developer or devops, and for some specialist with the rights to edit the domain account.  With whom you have to communicate on the damaged phone.  While there will be a leisurely dialogue in the style of ‚Äúhey guys, look there at your place, this is your back‚Äù - your ip-address will be blacklisted by various mail services, from where it will be difficult to exclude them.  Therefore, it makes sense to immediately use the services of paid mail services, for example, <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/postfix.html">docs.aws.amazon.com/ses/latest/DeveloperGuide/postfix.html</a> .  You can integrate with them through the API, but from my point of view, it is more reliable to do this via postfix (which is <code>relayhost = [email-smtp.us-west-2.amazonaws.com]:587</code> it is for this purpose) by setting the parameter <code>relayhost = [email-smtp.us-west-2.amazonaws.com]:587</code> .  For more integration, see the AWS website (link above).  They are, on the one hand, ensuring that your ip is not blacklisted and your mail is spam, but they themselves can declare you a spammer at any time and block your mail.  Toak that there are no ideal solutions. <br><br>  Addition. <br><br>  Of course, when solving a problem, I ‚Äúpeeped‚Äù like other developers in open repositories do it and learned a lot from these sources.  Therefore, I will analyze how some of the configurations solve similar problems. <br><br>  For this review I used the keyword phrase in Google search ‚Äúdocker sasl postfix‚Äù.  Therefore, if someone advises some other repositories, I will include it in this list. <br><br>  1) <a href="https://github.com/MarvAmBass/docker-versatile-postfix">github.com/MarvAmBass/docker-versatile-postfix</a> <br><br>  The author did not use the postfix <code>auxprop_plugin: sasldb</code> plugin, but the standard sasl <code>pwcheck_method: saslauthd</code> tool.  This is another additional process that runs in a container, and which is not very convenient to configure, because  by default it is off.  Therefore, the author uses the following constructions in his configuration: <br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">RUN</span></span> sed -i <span class="hljs-symbol"><span class="hljs-symbol">'s</span></span>/^<span class="hljs-type"><span class="hljs-type">START</span></span>=.*/<span class="hljs-type"><span class="hljs-type">START</span></span>=yes/g' /etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/saslauthd; \ sed -i <span class="hljs-symbol"><span class="hljs-symbol">'s</span></span>/^<span class="hljs-type"><span class="hljs-type">MECHANISMS</span></span>=.*/<span class="hljs-type"><span class="hljs-type">MECHANISMS</span></span>=<span class="hljs-string"><span class="hljs-string">"shadow"</span></span>/g' /etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/saslauthd <span class="hljs-type"><span class="hljs-type">RUN</span></span> sed -i <span class="hljs-symbol"><span class="hljs-symbol">'s</span></span>/^<span class="hljs-type"><span class="hljs-type">OPTIONS</span></span>=/#<span class="hljs-type"><span class="hljs-type">OPTIONS</span></span>=/g' /etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/saslauthd; \ echo <span class="hljs-symbol"><span class="hljs-symbol">'OPTIONS</span></span>=<span class="hljs-string"><span class="hljs-string">"-c -m /var/spool/postfix/var/run/saslauthd"</span></span>' &gt;&gt; /etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/saslauthd</code> </pre><br><br>  2) <a href="https://github.com/cloudposse/postfix">github.com/cloudposse/postfix</a> <br><br>  Similar to the previous one, <code>pwcheck_method: saslauthd</code> <br><br>  3) <a href="https://github.com/floriandejonckheere/docker-postfix">github.com/floriandejonckheere/docker-postfix</a> <br><br>  The author used sasldb2 with the postfix plugin, but turned off the sandbox mechanism: <code>smtp inet n - n - - smtpd</code> , and used supervisor to start processes, thus including several processes in the container. <br><br>  4) <a href="https://github.com/catatnight/docker-postfix">github.com/catatnight/docker-postfix</a> <br>  Like the previous one, the author turned off the sandbox: <code>postconf -F '*/*/chroot = n'</code> and used the supervisor. <br><br>  5) <a href="https://github.com/juanluisbaptiste/docker-postfix">github.com/juanluisbaptiste/docker-postfix</a> <br><br>  Uses flat password file: <code>echo "[$SMTP_SERVER]:587 $SMTP_USERNAME:$SMTP_PASSWORD" &gt;&gt; /etc/postfix/sasl_passwd</code> <br><br>  6) <a href="https://github.com/container-images/postfix">github.com/container-images/postfix</a> <br><br>  Disables the sandbox <code>sed -i 's/^smtp\(\s*\)inet\(.*\)/docker_smtp\1inet\tn\ty\tn\t-\t-\tsmtpd -v/g' "$MASTER"</code> <br><br>  In general, I do not claim that, for example, disabling the sandbox or building several processes in one container is a more unsuccessful solution, I just note how these problems were solved by other authors. <br><br>  I would be grateful for the addition of this list of repositories, and I promise to quickly supplement this list by your comments. <br><br>  List of useful literature <br><br>  1. <a href="https://community.vscale.io/hc/ru/community/posts/211887505-%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0-%25D0%25B8-%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-Docker-Docker-Compose-Postfix-OpenDKIM-%25D0%25BD%25D0%25B0-Debian-%25D0%25B2-VScale-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25BE%25D1%2582%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BA%25D0%25B8-e-mail-%25D1%2581-%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D1%258E">Install and configure Docker + Docker Compose + Postfix + OpenDKIM on Debian in VScale to send an e-mail with a signature.</a>  <a href="https://community.vscale.io/hc/ru/community/posts/211887505-%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0-%25D0%25B8-%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-Docker-Docker-Compose-Postfix-OpenDKIM-%25D0%25BD%25D0%25B0-Debian-%25D0%25B2-VScale-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25BE%25D1%2582%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BA%25D0%25B8-e-mail-%25D1%2581-%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D1%258E">Vadim Khakulov.</a>  <a href="https://community.vscale.io/hc/ru/community/posts/211887505-%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0-%25D0%25B8-%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-Docker-Docker-Compose-Postfix-OpenDKIM-%25D0%25BD%25D0%25B0-Debian-%25D0%25B2-VScale-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25BE%25D1%2582%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BA%25D0%25B8-e-mail-%25D1%2581-%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D1%258E">December 7, 2016 19:25</a> <br><br>  apapacy@gmail.com <br>  April 8, 2018 </div><p>Source: <a href="https://habr.com/ru/post/353068/">https://habr.com/ru/post/353068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353056/index.html">PHP Digest 128 (March 25 - April 8, 2018)</a></li>
<li><a href="../353058/index.html">Is there any powder in the old dog? Hackathon Radio Canada 2018 (Part Three - Start! Attention! March!)</a></li>
<li><a href="../353060/index.html">Application of convolutional neural networks for NLP problems</a></li>
<li><a href="../353064/index.html">Kubernetes 1.10: we stabilize data storage, security and networking</a></li>
<li><a href="../353066/index.html">ITSM literacy program: 7 ways to diagnose the causes of IT incidents and problems</a></li>
<li><a href="../353070/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ309 (April 2 - 8, 2018)</a></li>
<li><a href="../353072/index.html">Developing native extensions for Node.js</a></li>
<li><a href="../353074/index.html">About the main reason for the existence of modern JS frameworks</a></li>
<li><a href="../353076/index.html">React-testing-library library overview</a></li>
<li><a href="../353080/index.html">Misconceptions about automated testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>