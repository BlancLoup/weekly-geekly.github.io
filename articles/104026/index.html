<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk, or home telephony for (pro) moved users</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began two long years ago, when, during a business trip to the USA, I was suddenly left without a mobile connection: I changed the phone wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk, or home telephony for (pro) moved users</h1><div class="post__text post__text-html js-mediator-article">  This story began two long years ago, when, during a business trip to the USA, I was suddenly left without a mobile connection: I changed the phone with a fool before the trip, but it turned out to be ‚Äútwo-band‚Äù ... And roaming is not cheap ... <br>  The result was the discovery of SIP-telephony. <br><br>  And here several months ago, from articles on Habr√©, I find out that other people's uncles can and don‚Äôt pay for intercity if you need to call from somewhere in your hometown via the Internet!  It is enough to put the VoIP server and configure it exactly as you need it! <br><br>  And so, taking Asterisk in my hands, I began an operation to combat the excessive greed of OpSoSov ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Note </h4><br><ul><li>  This topic is a compilation of some solutions that I applied for myself.  Someone can realize something differently or better - I will listen with pleasure and, perhaps, improve something in my own work. </li><li>  It is assumed that the reading topic understands the initial level in the question.  If not - at the end I gave a link to download the textbook. </li></ul><br><br><h4>  Introduction </h4><br>  There was a 2-core server on ubuntu (10.04), which, in principle, fulfills my duties as a file archive, but in practice it is often idle. <br>  It was necessary to simplify my life with telephone conversations. <br>  In particular, the following tasks were set: <br><ul><li>  If I am absent at home - I should not miss incoming calls to MGTS number </li><li>  If I am on a business trip - through the Internet I should be able to make calls around the city </li><li>  Again - on a business trip, ideally, I should not spend money on roaming, but at the same time receive calls made to my number </li><li>  Ideally, protect yourself from Acade type auto dialers, who simply got </li><li>  Simplification of calls, taking into account that it was planned to transfer PBX to code 499 </li><li>  Convenience of using all this </li></ul><br>  Having outlined a range of tasks, we proceed to the purchase of glands for this business. <br><br><h4>  Hardware </h4><br><h5>  D-Link DVG-7111S - GTS-VoIP Adapter </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/f8d/da0/308/f8dda0308098d9bd171a9ef8ed2004ba.jpg" alt="image"><br>  I chose it for a relatively ‚Äúcheap‚Äù cost - in Moscow it costs from 2,152 to 2,610 rubles, which is slightly cheaper than the Linxuses, who also need to be found. <br>  In fact, it makes two SIP clients that connect to Asterisk from the city line and telephone. <br>  <a href="http://www.3cx.com.ua/node/289">Settings do here so Makar</a> <br><br>  The subtlety is one connected with CallerID - for its correct transmission, you need to miss one call, so that the adapter has managed to determine the number: <br>  HOT LINE-&gt; Ring count before FXO pick up = 1 <br><br>  If necessary, you can upgrade the firmware, but unlike routers and other DLink devices, this is a <a href="http://forum.dlink.ru/viewtopic.php%3Ft%3D110451%26sid%3D3419fca12473c4c37b4c345a810275c0">rather uncommon process</a> ... <br><br>  Sometimes the adapter beats the definition of the signal "Busy".  To do this, you need to adjust the duration of these signals.  <a href="http://nsgate.ru/doc/voip_app/tone_analysis.pdf">Instructions on how to get them are available</a> , but he hasn‚Äôt dealt with himself yet - it‚Äôs only the second day that this problem started after the equipment was changed to PBX. <br><br>  For a call from Asterisk to a city number, the following format is used for Dial in Dialplan: <br>  Dial (SIP / FXO channel number / telephone) <br>  To call the phone: <br>  Dial (SIP / FXS channel number) <br><br>  To simplify life with marasmus from MGTS, I myself made it possible to dial all the numbers in Moscow with the same ‚Äú8-code-7 digits‚Äù, and the server will deal with the dialing rules: <br><br>  Below are two configuration options.  The first option is for those who have a number in the 495 code, and the second - in 499. Both options allow you to call both phones in the 495 code, and in 499. <br><br>  For rooms in code 495 <br> <code>; 495 -    <br> exten =&gt; _8495XXXXXXX,1,Dial(SIP/701/${EXTEN:4}) <br> exten =&gt; _8495XXXXXXX,n,Hangup() <br> ; 499 -   <br> exten =&gt; _8499XXXXXXX,1,Dial(SIP/701/${EXTEN:0}) ;    -   499  ,  ,      - -,    8... <br> exten =&gt; _8499XXXXXXX,n,Hangup() <br></code> <br>  For numbers in 499 code <br> <code>; 495 -  "" <br> exten =&gt; _8495XXXXXXX,1,Dial(SIP/701/${EXTEN:0}) <br> exten =&gt; _8495XXXXXXX,n,Hangup() <br> ; 499 -  "" <br> exten =&gt; _8499XXXXXXX,1,Dial(SIP/701/${EXTEN:1}) <br> exten =&gt; _8499XXXXXXX,n,Hangup() <br></code> <br><br><h5>  Phone </h5><br>  Initially, he used a Panasonic radio receiver connected to an adapter's FXS port as a telephone, but quickly became disillusioned: its clumsy display only dealt with the digital CallerID.  Therefore, <b>Siemens Gigaset C470 IP</b> + <b>Siemens Siemens Gigaset C47H handset was purchased</b> . <br><img src="https://habrastorage.org/getpro/habr/post_images/092/41a/526/09241a52681981697dd0ebd2a4ba9db8.jpg" alt="image"><br>  For them, I laid out a total of five thousand and I do not regret: The main charm of the unit is that it supports simultaneous work with 6 tubes (basic + 5 additional). <br>  ‚ÄúAnd what's the point?  There is one line! ‚ÄùYou will say and ... You will be fundamentally wrong! <br>  In addition to 6 handsets - the base station also supports 6 sip accounts!  Each of which can be tied to your handset !!! <br>  Those.  - if you put a radio tube in each room in an apartment, then these will be completely different sip-users who can calmly talk at the same time! <br><br>  A few words about the setting: <br>  Whatever you say in the instructions - the dynamic allocation of the address on the phone does not occur.  Therefore, there are two options - with a handset to drive the correct one or by briefly pressing the button on the base - to determine the current network and configure it. <br>  The pin-code can be changed ONLY from the handset - there is no such item in the web panel: so it is better to change it right away, until it was done by some cunning hacker! <br><br><h5>  GSM adapter </h5><br>  Then I took the path of least resistance and bought the MTS modem Huawei E1550. <br>  Why mts? <br>  Firstly - 770 rubles, not 1500 for "not broken" <br>  Secondly, the Bee and Megi have voice functions AT ALL. <br>  Thirdly, I needed a modem under A-Mobile's Ashanovsky tariff, which didn‚Äôt have to be reflashed on the MTS network. <br>  Who does not know - A-Mobile allows you to make 15 minutes of free calls per day to another A-Mobile, after which - a nominal fee of 90 kopecks per minute.  I needed it as a backup channel to the home network and tariff, IMHO, the most enjoyable! <br>  <a href="http://www.asterisk-pbx.ru/wiki/doku.php/new2">Device settings are dreary</a> , but nothing complicated. <br><br>  + now on Habrapish has received a message from <a href="https://habrahabr.ru/users/angel2s2/" class="user_link">Angel2S2</a> : <br>  ‚ÄúBy the way, about the unlock of huawei modems ... If you're interested, you can look at me - <a href="http://angel2s2.blogspot.com/2010/07/huawei.html">angel2s2.blogspot.com/2010/07/huawei.html</a> .  I broke E160G and E1550 from a megaphone and mts, you can also call :) ‚Äû <br>  MB will help someone! <br><br><h6>  Uchkuduk two modem ... </h6><br>  A few more words complement ... <br>  I put the second modem on the system for incoming AlloIncognito and then he came in the most ... P-c which: the modems themselves swapped acrobats in the circus!  When disconnecting one - the second strove to move to its ports, etc.  etc. <br><br>  And since  Dialplans are fundamentally different for them - it was necessary to somehow decide ... <br>  The solution is quite reasonable for Linux: a fixed ‚Äúlink‚Äù can be assigned to the port! <br>  Those.  - we set for modem 1 - ports are not ttyUSB1 and 2, but hv0 and hi0 (HuaweiVois and HuaweiInfo)! <br>  How? <br>  We disconnect both modems from the computer, we insert the first one. <br>  We give the command dmesg from the root in the terminal <br>  In response, a lot of everything falls out, but at the end - the cherished lines: <br> <code>[291015.913221] option 1-2:1.0: GSM modem (1-port) converter detected <br> [291015.913364] usb 1-2: GSM modem (1-port) converter now attached to ttyUSB0 <br> [291015.913926] option 1-2:1.1: GSM modem (1-port) converter detected <br> [291015.914026] usb 1-2: GSM modem (1-port) converter now attached to ttyUSB1 <br> [291015.916678] option 1-2:1.2: GSM modem (1-port) converter detected <br> [291015.916812] usb 1-2: GSM modem (1-port) converter now attached to ttyUSB2</code> <br>  ‚ÄúWho is who?‚Äù: <br>  After the option comes the port ID. <br>  1-2 - the first USB host, the second device <br>  : 1.1 is the first port on this device. <br>  The next line - infa on how the port has become this our internal. <br>  We are interested in the pre-last and last - 1 and 2 in this case. <br>  1 - port for voice, 2 - for data. <br>  Now open the file /etc/udev/rules.d/huawei.rules from under the root for editing - here the rules for all Huawei devices in the system are written.  Most likely it will be empty. <br>  We drive in the lines: <br> <code>KERNEL=="ttyUSB[0-9]*", ID=="1-2:1.1", NAME="%k", SYMLINK+="hv0", GROUP="root", MODE="0666" <br> KERNEL=="ttyUSB[0-9]*", ID=="1-2:1.2", NAME="%k", SYMLINK+="hi0", GROUP="root", MODE="0666"</code> <br>  ‚ÄúAll devices on this particular port are now also called hv0, and this one is hi0!  Save, Amen! ‚Äù <br>  We repeat the process starting from plugging in for the second modem - two more lines will appear in the file, in which there are already ports from the second modem and hv1 and hi1 ... You can add the third and the hundred and thirty-fifth one ... <br><br>  Now if you pull out the modems and insert, then using the command ls -1 / dev / hv * or ls -1 / dev / hi * will ALWAYS give the necessary device, the main thing is not to confuse the connector on your computer! <br><br>  /etc/asterisk/datacard.conf is also changing - instead of faceless <br> <code>audio=/dev/ttyUSB1 ; tty for audio connection <br> data=/dev/ttyUSB2 ; tty for AT commands <br></code> <br>  Appear <br> <code>audio=/dev/hv0 ; tty for audio connection <br> data=/dev/hi0 ; tty for AT commands <br></code> <br>  Now we restart Asterisk and hurray - there will be no more confusion! <br>  On this with iron for now. <br><br><h4>  SIP operators </h4><br>  In principle, with the existing equipment, we already have a city + mobile line, but I want additional opportunities, and I need to call somehow through the intercity! <br><br><h5>  Multiphone </h5><br>  Multiphone is a service from Moscow Megaphone.  The point is that this is not just Internet telephony!  This is Internet telephony, tied to your Megaphone number! <br>  Translated into Russian: if someone calls your number, both the cellular and SIP client will work with the appropriate settings! <br>  <a href="http://habrahabr.ru/blogs/telecom/66023/">The Asterisk setting for this case was pretty well described on Habr√©</a> , I can only add instructions on <a href="http://community.livejournal.com/ru_asterisk/59316.html">how to attach SEVERAL Multifonov to the server</a> - some moments are controversial and did not work for me due to incompatibility with codecs, but perhaps this is a bug of my config ?! <br>  <b>UPD.</b>  <a href="http://multifon.ru/publications/settings_ip_pbx/">Native instruction of the Multiphone on setting up in Asterisk</a> <br><br>  A few words are common for all SIP-operators: if you are going ONLY to call from some SIP account, then register is not needed, but if you intend to accept ... <br>  By the way, register with such a furious syntax - only for Megaphone: for the rest, it is more standard ... <br><br><h5>  Europhone </h5><br>  Euroset CIP-telephony service.  In the black, the lion‚Äôs share of Russian cities is priced at 49 kopecks.  There are incoming numbers in Moscow and a bunch of cities, so if you are not too lazy to drive in a number + your number in Europhone - you can receive incoming calls from there ... <br>  Potentially, if the incoming city is not particularly needed, and you do not need to call very much, it may be more profitable than the monthly 155 rubles from MGTS "for the line" ... <br><br>  For registration - you need to buy a telephony card from Euroset.  Username-password - will be listed on the card, in the future, this account can be credited.  There is no registration without a card. <br><br><h5>  pctel.ru </h5><br>  Calls to all Russian numbers - by ruble per minute. <br>  I took it as an ‚Äúadd-on‚Äù to Europhone: calls to mobiles are cheaper in it, but I‚Äôm not talking about a ruble and a half for outgoing ones in the Multiphone!  If you want to hide your number - the most it. <br><br><h5>  Sipnet </h5><br>  Nothing special, but many prefer it. <br><br><h4>  DID, or Direct Telephone Number </h4><br>  This service is that you can get a phone number in one of the cities of any country and receive calls to this number via Asterisk. <br>  The advantage is that if you move often, it will allow you to always keep your number, minus - unlike 155 rubles per month at MGTS, the prices for Moscow numbers from operators start from 250 rubles, approximately.  (For comparison, the number in the United States costs about $ 3.5 per month). <br><br><h5>  Go2baza </h5><br>  According to the people who used it, the direct Moscow number costs 250 rubles per month.  <a href="http://go2baza.ru/price/">Tariffs are</a> not clearly defined, so I can neither confirm nor deny ... Approximately 250 per month for a room, plus the initial payment for the allocation of a number ‚Äî 500 rubles for 499 or 3000 for 495 ... It‚Äôs worth paying more if MGTS becomes here in 499 to push all ?! <br>  Plus, what is provided by as many as five incoming channels ... However, only when redirecting to phone numbers, and on SIP - only 2 (they overloaded in April).  But the redirect to the phones is paid, and on the CIP - a freebie! <br>  Well, then: a two-channel phone number - IMHO, very good!  Most often, more and do not! <br><br><h5>  "Personal phone number" or "Number that is always with you" </h5><br>  MGTS bullshit.  In fact - the Moscow number through SIP.  In the time-based version of the subscription fee is not, the price per minute - the same 36 kopecks.  Connection - 8340 rubles, and the Siemens 470 I was talking about comes in the kit. <br><br>  Sponges rolled?  Freebie?  Cool? <br>  Catch the machine: it works ONLY through ADSL from MGTS!  As explained in the support, this is only for organizing a second phone number at home. <br>  Potentially, it is obviously possible to tamp down with Asterisk, but I don‚Äôt need such a phone tied to the main line and I don‚Äôt need a gift, but I couldn‚Äôt find the happy owners of this service on the Internet. <br>  Just keep in mind what it is, and if at home someone periodically hangs on the phone, you can connect, so that there is a backup line ... <br><br><h5>  gtalk2voip </h5><br>  Direct numbers in different countries. <br>  Registration idiotic: <br>  1. <a href="http://www.gtalk2voip.com/">Go</a> to <a href="http://www.gtalk2voip.com/">gtalk2voip</a> , in the corner there is a field for entering e-soap.  Enter google soap. <br>  2. Connect to Jabber on your Google account, see the invitation from the user service@gtalk2voip.com.  Connect to the "conversation" <br>  3. Further, this bot command MYPAGE get a page through which you can register numbers and replenish the balance. <br><br><h5>  ipkall </h5><br>  <a href="http://www.ipkall.com/">A company with a ‚Äúnon-print‚Äù name</a> provides free phone numbers in the USA with redirect to SIP.  If you don‚Äôt need it, don‚Äôt need to occupy it with registrations: what if someone needs it, and everything goes away in habraeffekt ?! <br>  About this service I have an eternal scandal with a toad: <br>  - s!  Cool!  US Toll Free!  It is necessary, it is necessary, it is necessary! <br>  - What for?  - asks realist.  - Are you a thread from the States calling? <br>  - Because they do not call!  Want Want want! <br>  - Learn English, Wishlist!  That call, and what do you say ?! <br>  - Hyundai-hoh?  Ay Widersein?  Hows  What would such a pyleglot like me say nothing ?!  Ha! <br>  - All the same - the meaning in it is zero now! <br>  - So what?  Halyaaaaava! <br><br><h5>  Alloincognito: "The Perfect 499" </h5><br>  <a href="http://www.alloincognito.ru/%3Fid%3D189">Ideal 499</a> , tariff plan from Alyinkognito, without subscription fee for 499 ... Included is a SIM card from MegaFon, to which calls are received ... <br>  <a href="https://habrahabr.ru/users/bdmalex/" class="user_link">Link</a> threw <a href="https://habrahabr.ru/users/bdmalex/" class="user_link">bdmalex</a> .  According to him, he has been using it for a long time, there really is no subscription fee and, even that, in general, beyond my understanding, there is no payment for re-sending incoming calls to a mobile number !!! <br><br><h4>  Asterisk Dialplan Plans </h4><br>  With iron and operators, somehow, we figured out ... <br>  Now a few tricks related to Asterisk: <br><br><h5>  Black list </h5><br>  Sometimes I really want something to stop calling a person: an ex-girlfriend, an idiot who is always mistaken with a number, advertising agents, polls, etc.  etc. <br>  To do this, there is a BLACKLIST () command in Asterisk.  In fact, it checks CallerID with a list in its database, and if it returns 1, then you can safely send the caller to hell! <br>  <a href="http://mysyslog.ru/posts/175">You can read about the ‚ÄúSimple‚Äù version here</a> , but I wanted to make my life a little easier: well, I‚Äôm lazy to look at the number on the determinant, after which I‚Äôm trying to drive it in the right place! <br>  Let Asterisk do it himself! <br><br>  In Dialplan, when we call from the right context, we write (when I call from MGTS, I redirect to number 123 - replace it with what you have indicated!): <br> <code>exten =&gt; 123,n,Set(_From=${CALLERID(name)}) ; name,   num ,      CallerID     ! <br> exten =&gt; 123,n,GotoIf($[${BLACKLIST()}=1]?banned) ;  -     -       -    banned <br> exten =&gt; 123,n,Set(DB(ToMe/LastCaller)=${From}) ;     <br> ..... <br> ;      . <br> ..... <br> exten =&gt; 123,n,Hangup() <br> <br> ;    ! <br> exten =&gt; 123,n(banned),Answer() <br> exten =&gt; 123,n,Playback(,      ) <br> exten =&gt; 123,n,Hangup()</code> <br> <br>  And in the dialplan of the telephone: <br> <code>;  20 -       <br> exten =&gt; 20,1,Set(tmp=${DB(ToMe/LastCaller)}) <br> exten =&gt; 20,n,Set(DB(blacklist/${tmp})=1) <br></code> <br><br>  Now, if after calling the spammer you pick up the phone and dial "20" - it will add it to the list of banned! <br>  How to remove the number - shown in the instructions above. <br><br><h5>  Speed ‚Äã‚Äãdial </h5><br>  All of us have numbers that we most often call: relatives, work colleagues, acquaintances ... <br>  To drive in every time 10 digits of the number is lazy!  Therefore, you can create a notebook directly on your PBX! <br>  In the dialplan for the phone: <br> <code>exten =&gt; 1,1,Dial(SIP/701/8495......) ;  <br> exten =&gt; 2,1,Dial(SIP/701/8495......) ;  <br> exten =&gt; 3,1,Dial(SIP/701/8495......) ;  <br> exten =&gt; 4,1,Dial(SIP/701/8499......) ;  <br></code> <br>  Etc.  etc. <br><br>  In general, I wanted to make a voice menu, but for some reason, when I remove the radio tube, the processing of the number ‚Äús‚Äù does not happen ... So you can simply write to the ‚Äúwho is xy‚Äù button ... <br>  If several handsets are bought, as in my case, each one may have its own context with its ‚Äúshort numbers‚Äù: parents do not need my friends on the phone in the room, and theirs are not necessary for me ... <br><br><h5>  Greetings from the time of day </h5><br>  You can add a bit of ‚Äúhumanity‚Äù to your ATSC, so that it gives out a different greeting, depending on the time of day (and, if desired, the day of the week, month, etc., etc.).  For example, in the morning she can greet the caller with a yawn, and at night she can express everything that she thinks of a person who calls when all normal people are already sleeping. <br><br> <code>;     <br> exten =&gt; 1200,1,Background(hello_utro) ;  "" <br> exten =&gt; 1200,n,Goto(123,naberite) ;  <br> <br> exten =&gt; 1201,1,Background(hello_den) ;  "" <br> exten =&gt; 1201,n,Goto(123,naberite) ;  <br> <br> exten =&gt; 1202,1,Background(hello_vecher) ;  "" <br> exten =&gt; 1202,n,Goto(123,naberite) ;  <br> <br> exten =&gt; 123,1,Verbose("   ") <br> exten =&gt; 123,n,Answer() ;  <br> exten =&gt; 123,n,GotoIfTime(07:00-12:00|*|*|*?1200,1) ;   7  12 <br> exten =&gt; 123,n,GotoIfTime(12:01-19:00|*|*|*?1201,1) ;  -  12  19 <br> exten =&gt; 123,n,GotoIfTime(19:01-22:00|*|*|*?1202,1) ;  -  19  22 <br> exten =&gt; 123,n,Background(hello_noch) ;  - :   "" <br> <br> exten =&gt; 123,n(naberite),Verbose(" ") ;    ... <br> ...</code> <br> <br><h5>  Antibot </h5><br>  If you are often called by left people asking for ‚ÄúMasha, Sasha or Dasha,‚Äù or even some Barakobam in general, the following example is yours! <br>  The general idea is that when you answer, you will receive a greeting in the style ‚ÄúHello, you called the apartment.  If you are sure that this is Ivanov's apartment - press 1, if Petrovs are 2, Sidorovs are 3!  If none of the names does not match, or you call the organization - hang up: you did not get there! ‚Äù <br>  Minus - will be wrapped and "useful" bots, like "You forgot to pay the phone and soon we will cut off you!", But here either-or ... <br><br> <code>exten =&gt; 123,n,Answer() <br> ... <br> exten =&gt; 123,n(naberite),Background(familie) ;     <br> exten =&gt; 123,n,WaitExten() ;    <br> <br> exten =&gt; 1,1,Goto(normal,s,1) ; 1 - , !  1   2, 3     . "normal" -      ,    . <br> <br> exten =&gt; i,1,Playback(invalid) ;    ‚Äî    <br> exten =&gt; i,n,Hangup() ;   <br> <br> exten =&gt; t,1,Playback(bay) ;   -  <br> exten =&gt; t,n,Hangup() ;   <br></code> <br><br><h5>  Sly Callback </h5><br>  I have a mobile phone with two SIM cards: one for talking, the second for A-Mobaylovskaya to communicate with my mini-PBX. <br>  Well, the problem is that a couple of times by mistake I called from the wrong SIM card - 2.40 is not money, of course, but when you debug and call periodically to the server - it's unpleasant! <br>  In this connection, I slightly redid <a href="http://graber.net.ru/sysadmin/kak-sdelat-callback-na-asterisk/">the Callback script to</a> fit my needs. <br><br> <code>[incoming_mobile] <br> ;   <br> exten =&gt; s,1,GotoIf($["${CALLERID(num)}" = "+7916......."]?allow) ;  - - ! <br> exten =&gt; s,n,GotoIf($["${CALLERID(num)}" = "+7926........"]?callback) ;  - ! <br> exten =&gt; s,n(reject),Hangup() ;  -   ,  ! <br> exten =&gt; s,n(allow),Verbose("   -") <br> exten =&gt; s,n,Goto (incoming_mobile,200,1) ;    <br> exten =&gt; s,n,Hangup() <br> exten =&gt; s,n(callback),Verbose("  -   !") <br> exten =&gt; s,n,System(/etc/asterisk/scripts/callback) <br> exten =&gt; s,n,Hangup() <br> <br> exten =&gt; 200,1, .... ;      ,   ,   ,     . <br> ..... <br> <br> exten =&gt; 601,1,Dial(Datacard/g1/+7916....) ;   - <br> exten =&gt; 601,n,Hangup() <br></code> <br><br>  And this is / etc / asterisk / scripts / callback - do not forget to give it execution rights: I could not understand for half an hour why it did not work! <br> <code>#!/bin/sh <br> sleep 10 <br> echo "Channel: Local/601@incoming_mobile <br> MaxRetries: 1 <br> RetryTime: 10 <br> WaitTime: 20 <br> Context: incoming_mobile <br> Extension: 200 <br> Priority: 1 <br> AlwaysDelete: Yes" &gt;/var/spool/asterisk/tmp/tst.call <br> mv /var/spool/asterisk/tmp/tst.call /var/spool/asterisk/outgoing/tst.call</code> <br> <br><h5>  ‚ÄúI'm not all home!‚Äù Or ‚ÄúI'm in the house!‚Äù </h5><br>  This fragment is so elementary that it takes longer to describe why it is needed, than the extensions themselves! <br>  So, you went somewhere for business, put your mobile phone in your pocket, combed it to the other end of the city and suddenly someone decided to call you at home!  And ‚Äúyour call is important for us,‚Äù but you cannot answer ... Or can you? <br> <code>;     DID <br> ... <br> exten =&gt; 123,n,Dial("sip/702",10) ; 10       -       ... <br> exten =&gt; 123,n,Verbose("     -   ,     !") <br> exten =&gt; 123,n,Dial("sip/702"&amp;"Datacard/g1/+7916....",20) ;       ... <br> exten =&gt; 123,n,Hangup() <br></code> <br><br>  The second piece - will be of interest to the owners of the Multiphone. <br>  I, and many acquaintances, have a ‚Äúdisease‚Äù: forgetting a mobile phone in a pocket of trousers or a bag and stuffing this ‚Äúvault‚Äù into a closet ... As a result, the choked phone squeals can hardly be heard, but the call could be important !!! <br>  To combat this, I paralleled a radio tube to the Megaphone-Multiphone in my room. <br>  It becomes stupid in 2.5 lines: <br> <code>exten =&gt; 7926.......,1,Verbose("   !") <br> exten =&gt; 7926.......,n,Dial("SIP/702") <br> exten =&gt; 7926.......,n,Hangup() <br></code> <br><br><h4>  Protection </h4><br>  Unlike home web ftp servers - home mini-PBX is a pretty serious threat to your well-being: bad radishes, having access to your telephone network, can be so interspersed so that a Beeline‚Äôs expense to a tourist for a connection in the amount of half a million can seem cheap! <br>  I recommend reading the <a href="http://asteriskpbx.ru/wiki/secure-asterisk">article about the protection of Asterisk</a> , a note on Habr√© about the <a href="http://habrahabr.ru/blogs/voip/103341/">Cuban Epidemic</a> ... <br>  Well, simple tips: <br>  1. If calls from the city line go only to landline numbers - block the dialing of any other numbers at the extension level. <br>  2. To enter the intercity - create a separate context for the intercity, the entrance to which will be through the "password" - the number that must be entered. <br>  3. For local phone accounts, type in a sip.conf for each local user its fixed IP address, in extreme cases, a local sub grid, the benefit is that SIP phones and adapters most often have the option to set a fixed IP. <br><br><h4>  Conclusion </h4><br>  This is only a small part of what can be done with Asterisk.  Some more things I just could not remember - trite falling asleep on the go. <br>  All this, if desired, the readers can be supplemented and corrected: write wishes in the comments! <br><br><h4>  Literature </h4><br>  <a href="http://asterisk.ru/store/files/Asterisk_RU_OReilly_DRAFT.pdf">O'Reilly, Asterisk: The Future of Telephony</a> - Mast Hev!  Bible! <br>  <a href="http://www.opennet.ru/docs/RUS/voip_asterisk/2.html">Asterisk and Linux - IP Telephony Mission, Part 1</a> <br>  <a href="http://www.opennet.ru/docs/RUS/voip_asterisk/3.html">Asterisk and Linux - IP Telephony Mission, Part 2</a> <br>  <a href="http://www.opennet.ru/docs/RUS/voip_asterisk/4.html">Asterisk and Linux - IP Telephony Mission, Part 3</a> <br>  <a href="http://www.xakep.ru/magazine/xa/134/119/1.asp">Making money on the stars</a> <br>  <a href="http://sbelikov.ru/2009/03/golosovoe-menyu-v-asterisk/">Asterisk Voice Menu</a> <br><br>  PS ‚ÄúHead bo-bo, in the mouth byak ....‚Äù - I will sleep off and add more about the protection of all this, a few words about NAT and some other examples. <br><br>  PPS Some places in the dialplan "cut by the living" - may be a little buggy: write - I will clarify and correct! </div><p>Source: <a href="https://habr.com/ru/post/104026/">https://habr.com/ru/post/104026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104018/index.html">Ubuntu Maverick added drivers for Apple Magic Trackpad!</a></li>
<li><a href="../104021/index.html">ION netbook</a></li>
<li><a href="../104022/index.html">Full translation of App Store Review Guidelines</a></li>
<li><a href="../104023/index.html">Jailbreak for PS3 ported to Ham and Cheese Sandwich</a></li>
<li><a href="../104025/index.html">Xen Cloud Platform in Enterprise [1]</a></li>
<li><a href="../104027/index.html">Opera and Facebook Widget Contest</a></li>
<li><a href="../104029/index.html">Ubuntu pre-configured automatic installation: isolinux and preseed</a></li>
<li><a href="../104031/index.html">Google launched Family Safety Center</a></li>
<li><a href="../104033/index.html">Pirates are going to strip advertising revenue</a></li>
<li><a href="../104034/index.html">Microsoft employees are burying the iPhone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>