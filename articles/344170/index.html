<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we taught smart socket to measure power</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Welcome 


 We - the company Rubetek, are engaged in developments in the field of solutions for smart home. 
 In this article we will talk about how, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we taught smart socket to measure power</h1><div class="post__text post__text-html js-mediator-article"><p>  Welcome </p><br><p>  We - the company Rubetek, are engaged in developments in the field of solutions for smart home. <br>  In this article we will talk about how, during the development of one of the devices of our Wi-Fi line, we chose a solution for accurate measurement of the power of connected electrical appliances. <br><img src="https://habrastorage.org/webt/gj/hf/sb/gjhfsbds13iol-r-ytnqtc4w2_c.png"><br>  <em>Our Wi-Fi outlet</em> </p><a name="habracut"></a><br><p>  <strong>What kind of device did?</strong> <strong><br></strong> <br>  Wi-Fi socket Rubetek is a device designed for remote power management of connected electrical appliances up to 3000 watts.  The outlet is controlled by a button located on the case locally (smartphone - WiFi socket, smartphone - WiFi router - Wi-Fi socket) and remotely when the router is connected to the Internet. </p><br><p>  The state of the device is changed by the triggering of sensors connected to the outlet of the RF or through the use of pre-configured user scripts. </p><br><p>  One of the key functions of the device is monitoring the power consumption of the connected load. </p><br><p>  To display the load level of the socket uses an LED indicator that changes the color of the glow in accordance with the power consumed by the load. </p><br><p>  The device allows you to connect compatible sensors with the EV1527 protocol (433.92 MHz, ASK) RF sensors (movements, openings, water leaks, gas and smoke leaks) and create scenarios of interaction between the connected devices. </p><br><p>  In addition, the smart socket is compatible with the Apple Homekit platform and supports control with Siri voice assistant.  Remote control of Homekit via the Internet is possible only with the help of Apple TV, but you can control the voice locally from the iPhone without using Apple TV. </p><br><p>  <strong>First attempts</strong> </p><br><p>  At the first stage, the Z-Wave module was selected as the basis for the future outlet (Fig. 2). <br>  According to the terms of reference, the socket had to measure the consumed electricity in single-phase circuits, in the range from 0 W to 3000 W., with an error of no more than 1%. </p><br><ul><li>  To measure the current consumed by the load, and the voltage on the load, we used a circuit consisting of a dual opamp TSV522, a current shunt and a resistive amplifier. </li></ul><br><p><img src="https://habrastorage.org/webt/iv/l9/nu/ivl9nu9pyeaq8_0vyeuq6fb94xs.png"><br>  <em>The first prototype on the module Z-Wave</em> </p><br><p>  The calculation of the active power consumed by the load was calculated by the formula: </p><br><p><img src="https://habrastorage.org/webt/qc/9x/fs/qc9xfsdpzhgazl-drmaulk76eds.png"></p><br><p>  Where: <br>  P - active power consumed by the load <br>  U - effect.  load voltage equal to mains voltage <br>  I - effect.  load current <br>  œÜ - phase shift between current and voltage on the load </p><br><ul><li>  The advantages were low input current (1 ŒºA) and low bias voltage (0.8 mV).  The input and output signal had a voltage sweep (rail-to-rail). </li><li>  The accuracy of measuring the load current with a power consumption of up to 100 W in the range from 0 to 3000 W did not suit us, and to increase it, we used two operational amplifiers operating from a common current shunt and having different gain factors: an amplifier with a large gain factor worked in range from 0 watts to 100 watts, and an amplifier with lower gain worked in the range from 100 watts to 3000 watts. </li></ul><br><p>  When developing Wi-Fi sockets, one of the main requirements was the compactness of the product, therefore, we considered the use of several cases of amplifier circuits and ADCs to be irrational.  In addition, the analog signal at the output of the amplifiers was very ‚Äúnoisy‚Äù, the level of interference did not allow to achieve the specified error in measuring the power consumed by the load.  This was especially noticeable on an amplifier operating in the range from 0 W to 100 W.  (Fig.3). </p><br><p><img src="https://habrastorage.org/webt/_3/as/g2/_3asg2zffzsa2_kguajahapc938.png"><br>  <em>Oscillogram from the current shunt of the Z-Wave ADC module with a power of 10 W load</em> </p><br><p>  At this stage, in order to increase the measurement accuracy and increase the degree of integration, it was necessary to find a new solution for implementing the power measurement.  It was decided to abandon the Z-Wave module, due to the high cost and poor performance, and OU.  The new foundation was the Wi-Fi MCU. </p><br><p>  The rejection of Z-Wave in favor of Wi-Fi was due to the obvious advantages of the latter: <br>  the presence of Wi-Fi in any smartphone that allows you to directly control the outlet from the application, the ability to connect to the router for remote control of the outlet from anywhere in the world.  This determined the further development of the line of our smart devices. </p><br><p>  <strong>Looking for a solution</strong> </p><br><p>  The search for options for the implementation of power measurement led us to specialized measuring RMS chips. <br>  We chose a relatively inexpensive RMS - STPM14A. </p><br><p><img src="https://habrastorage.org/webt/ie/-v/he/ie-vhe8hzyovtpnfmt8ojkcjy6o.png"><br>  <em>Prototype STPM14A Module</em> </p><br><p>  This RMS measures active, reactive and apparent power, effective values ‚Äã‚Äãof current, voltage and frequency, supports current transformers and shunts, is distinguished by low power consumption, high measurement accuracy, reliability of data transmission and storage.  In general, STPM14 suited us in many ways. </p><br><p><img src="https://habrastorage.org/webt/20/n9/dl/20n9dlghglvvm4vvwuu6fp1u63o.png" alt="image"><br>  <em>Block diagram of STPM14A</em> </p><br><p>  But not without its drawbacks. </p><br><p>  When using STPM14A, difficulties arose at the data processing stage: this measuring chip did not have a digital output, only a frequency one, which required resources from the Wi-Fi MCU to process the frequency signal.  Our Wi-Fi MCU was already loaded with a host of other functions: processing discrete signals, interaction with the server, encryption, timers, scripts.  It turned out that the processing of the frequency signal was not possible to implement without consequences for the rest of the functional. </p><br><p>  We had to return to the search for alternative solutions also because STPM14A did not have a digital output.  After examining several options, we decided to stop on the STPM32 chip.  To Wi-Fi MCU STPM32 connected via UART. </p><br><p>  STPM32 is a mixed signal processing device.  The processor consists of analog and digital blocks. </p><br><p>  Analog includes: </p><br><ol><li>  two low-noise amplifiers with programmable gain and low offset; </li><li>  four 24-bit delta-sigma second-order ADC; </li><li>  two sources of reference voltage based on the forbidden zone with independent temperature compensation; </li><li>  low drop voltage regulator; </li><li>  dc buffers. </li></ol><br><p>  The digital block consists of a cascade of digital filtering, a hardware-based digital signal processor, buffer cascades for input signals, and serial interfaces (UART or SPI). </p><br><p>  The measuring chip STPM32 contained two channels for processing analog current and voltage signals, followed by conversion to a digital signal and a high-precision digital signal processor DSP, designed to process digital signals in real time. </p><br><p>  The main and most noticeable disadvantage, against the background of all the listed advantages, was that when working with small signals, with the maximum gain (16x), the error in current measurement increased. </p><br><p><img src="https://habrastorage.org/webt/pa/kr/z9/pakrz9gjxziadsip2vc8xg7j2ck.png"><br>  <em>Block diagram of STPM32</em> </p><br><p>  <strong>How to test?</strong> </p><br><p>  For testing and testing, we have developed a prototype board. </p><br><p><img src="https://habrastorage.org/webt/bm/yu/as/bmyuasx0w9bfkycyy6izmwdzn_i.png"><br>  <em>This is how the prototype of power measurement looks like on STPM32</em> </p><br><p>  Testing took place at different loads with power from a few watts to 3.5 kW.  Incandescent lamps, heating elements (resistive load), fluorescent lamps and power tools (resistive-inductive load), electrical appliances with switching power supplies without a power factor corrector (resistive-capacitive load) were used as the load. </p><br><p>  During the prototyping on the debug board, we received positive results, which we were completely satisfied with.  STPM32 coped well with the task and could be used in our smart outlet. </p><br><p>  Later it turned out that the total measurement error of the device did not correspond to the real readings.  We obtained this data by measuring indicators with several household wattmeters of different price categories. </p><br><p> To achieve the specified accuracy of the load power measurement, it was decided to calibrate serial products at the production stage.  For this purpose, a special stand was designed and manufactured (Fig. 6), which contained a separate one, calibrated using the STPM32 standard power meter. </p><br><p>  The stand had a galvanic isolation from the network in order to ensure electrical safety. </p><br><p>  Each product after assembly was connected to the contact device of the stand. <br>  The operator ran a program that provided electrical testing of the outlet for the absence of errors during installation and firmware.  In addition, the main outlet functionality was tested and STPM32 calibration was performed. </p><br><p><img src="https://habrastorage.org/webt/zl/2u/ei/zl2ueixh2ztb1m7mrqf2zz-ygyo.png"><br>  <em>Calibration Stand</em> </p><br><p>  The use of the stand ensured high accuracy of power measurement, manufacturability and reliability of the product. </p><br><p>  In the process of flashing the socket, a color palette was also laid down (the proportional ratio of red, blue and green colors).  This color scale is used in the outlet by the LED rim to display the power consumed by the load connected to the device. </p><br><p>  <strong>What is the result?</strong> </p><br><p>  This was our first attempt to implement this functionality.  Despite the fact that we went through a lot of options, there is also a positive side to this - by experience we decided on the microcircuit necessary for operation, having studied the pros and cons of all samples. <br>  Our Wi-Fi outlet, having the ability to measure power, from an ordinary device capable of remotely controlling power supply, has become a smart device that greatly facilitates the user's life. </p><br><p>  There is still a lot of work ahead, above we mentioned the whole Wi-Fi line, which is being developed right now.  In addition to the outlet for purchase is already available, for example, the control module.  Many other smart devices are preparing for the exit. </p><br><p>  We will certainly tell about them in the following articles. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/344170/">https://habr.com/ru/post/344170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344150/index.html">Survey for users of the browser Vivaldi</a></li>
<li><a href="../344156/index.html">Visual Studio extension to render instances of custom classes in debug mode. Part 2</a></li>
<li><a href="../344160/index.html">List of useful ideas for high-load services</a></li>
<li><a href="../344164/index.html">Layers, Bulbs, Hexogons, Ports and Adapters - it's all about one thing</a></li>
<li><a href="../344166/index.html">TeamCity 2017.2: 100 free build configurations, Docker, .NET CLI, composite builds and improvements in Kotlin DSL</a></li>
<li><a href="../344172/index.html">Malfunctions of the site. How to effectively organize the support of web resources by third-party services</a></li>
<li><a href="../344174/index.html">How I came up with and used the format of storing the results of experiments Measurelook</a></li>
<li><a href="../344178/index.html">Postmortem Shadow Tactics: Blades of the Shogun</a></li>
<li><a href="../344180/index.html">Trading supervised: an example of a business monitoring system</a></li>
<li><a href="../344182/index.html">Examination of internal FPGA defects: we are looking for a black cat in a dark room</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>