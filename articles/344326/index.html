<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to VxLAN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about another interesting technology - VxLAN - what kind of beast it is and what it is eaten with, and whether you really need it. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to VxLAN</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/yu/4f/mb/yu4fmbkxmc-t88dnskg_qedupcc.png"><br><br>  Today we will talk about another interesting technology - VxLAN - what kind of beast it is and what it is eaten with, and whether you really need it.  My acquaintance with this technology began with the study of hypervisors - I constantly came across the term VxLAN, but I didn‚Äôt know how it works.  One day, I decided to still read what kind of beast.  After reading a couple of articles, I learned for myself the main aspects of the technology and exhaled with relief, having read that this technology is the inheritance of hypervisors and to the transport is indirectly related (although, as it turned out later, the relation of VxLAN to transport has the most ).  After that, I safely forgot about the technology and I returned to it again only a year later, when I started to dive into EVPN - most of the articles and manuals were about the symbiosis of EVPN and VxLAN.  There is a lot of literature on this technology, especially if you speak English.  I will try in this article to tell about the basics of this technology and show it in practice - how it is configured and works.  But let's start with MPLS ... <a name="habracut"></a><br><br>  For me, as an engineer who exploits the IP / MPLS network, the most important in this technology is its ability to organize virtual networks of the 2nd and 3rd level (L2CKT, VPLS, L3VPN, 6PE and so on).  Any traffic engineering and fastrerouts, although they provide the engineer with very great opportunities in terms of traffic management and increase the number of 9-app decimal points (theoretically, practically everything leads to complication of the network architecture and, as a result, an extension of the accident resolution period), but in fact are an end in itself to deploy an IP / MPLS network.  Would mpls be such a popular technology and de facto standard for large, and for small providers, if it were not able to make VPNs?  Naturally not.  Well, you can hardly agree that you would reshape your network for the sake of introducing engineering traffic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      IP / MPLS networks are usually built on high-performance routers, for example, Juniper MX or Cisco ASR9K / 99 (in any case, the core of an IP / MPLS network).  For a data center, such equipment is usually not typical, and usually, if routers of such a level are installed in the data center, then they play the role of some PE-NIS or border through which DCI and uplinks are organized.  The matter is mostly in the cost of equipment - the cost of one port on the switch is much lower than the cost of a similar port on the router (with similar indicators of throughput, port density per slot, and so on).  In data centers, high-performance non-blocking or partially non-blocking switches are usually installed with a high density of ports with a capacity of 1/10/40 / 100G (depending on the type of ToR / EoR / Spine / Leaf equipment), for example, Cisco Nexus, very good Arista or Juniper products. <br><br>  But the same Cisco Nexus 9K is not suitable for use in the MPLS domain, as it simply does not have support for label distribution protocols, or, for example, Juniper QFX, which MPLS does support, but still has limitations, for example, fib.  That is, in fact, it is theoretically possible to launch MPLS in a data center built on Juniper QFX, but in practice it will not be the best solution - at some point you will be faced with the capabilities of this equipment (and this moment will come very soon). <br><br>  On the other hand, there are many systems in data centers that want to have both L2 connectivity and a geo-backup simultaneously.  How to ensure L2 connectivity between servers located in different parts of the network without MPLS?  In general, then, if you dig, there are several different solutions to this problem.  We, as it is easy to guess from the title of the article, let's talk about the technology specially sharpened for these needs - VxLAN, which allows you to build geographically stretched L2 networks over an ordinary IP network and today is the de facto standard for data centers. <br><br>  Any service organized on top of an IP / MPLS network is tunneling in one form or another - in any case, we are tunneling through something.  For example, let's take a simple L3VPN between point A and B. In the simplest version, without any options C or Detour / Bypass tunnels, we have a stack of two tags - the bottom one, the service tag and the top one, transport one.  Naturally, to put some kind of service between points A and B into a tunnel, we need the end-to-end tunnel itself between these same points A and B. LDP / RSVP-TE LSP acts as such a tunnel in IP / MPLS .  Further, no one forbids us to put another tunnel inside this transport tunnel, which is intended for forwarding client traffic. <br><br>  As a result, we get a tunnel that is tunnelled through another tunnel.  That is, ultimately it turns out that one network (client network) is built on top of another network (provider network).  The provider's network is called the underlay network.  In essence, this is the foundation for building superimposed networks ‚Äî VPNs.  Client networks deployed over the underlay networks are overlay networks and are built using some of the existing overlay technologies ‚Äî for example, the same L3VPN.  That is, in VPLS / L2CKT / L3VPN and so on, the IP / MPLS network is used as the underlay and the same MPLS as the overlay. <br><br>  But what if we do not have MPLS, and we need L2VPN (to be more precise, then VPLS)?  As I said earlier - there are various technologies that allow you to do this, we will stop VxLAN.  This technology, in conjunction with UDP, can organize a virtual L2 multipoint network (essentially an analog of VPLS) without using MPLS tags over any IP network (it can work over IP / MPLS networks ‚Äî then you will see that only IP connectivity is important) .  Immediately a lot of questions arise, for example, what plays the role of a tunnel in underlay or what is used as a service tag in overlay?  We will answer these and some other questions further. <br><br>  So, VxLAN is a virtual extended private network (Virtual eXtensible Local Area Network).  In the literature, you can find another name MAC-in-UDP.  This is all the same VxLAN, and the second name describes the essence of the technology much better.  As you guessed, VxLAN is a technology that allows ordinary ethernet frames to be packed into UDP segments and transported in this form over an IP network.  I think so far that little is clear, so let's take a closer look. <br><br>  In an IP / MPLS network, routers usually have some specific purpose ‚Äî for example, PE, P, or ASBR.  PE routers are multiservice aggregation nodes.  In simple terms, these are the nodes to which client services are connected - it is on these nodes that the L2 / 3VPN, VPLS, and other VPN services that run on top of the IP / MPLS network start (end of the last mile and all sorts of options). A / B / C we are not considering).  The second important element of an IP / MPLS network is level P routers - essentially just traffic threshers (especially if you have Free Core), who do not even realize that they are involved in organizing any VPN services. <br><br>  VxLAN technology also has such nodes, only they are called a little differently, although they perform essentially the same functions.  The analog of the PE router is VTEP - Vitual Tunnel End Point.  It is VTEP that is a service aggregation node, and VTEP can be not only a ToR / EoR / Leaf switch or PE router, but also a regular server, if it has the necessary software (for example, VMWare can do this).  As in IP / MPLS, VxLAN tunnels begin and end at VTEP.  Analogous to a P-level router are routers / switches that do not terminate clients and simply forward IP traffic - these switches usually do not even know about the existence of tunnels in the VxLAN network (if they were not carried out, for example, gateways). <br><br>  It is always easier to explain something with an example, so before moving on to the basic principles of VxLAN, let us recall another very important and well-known technology for all of us - VLAN. <br><br>  VLAN is a technology designed for network segmentation at the second level.  As we all know, the standard switch produces frame forwarding based on the forwarding table (built by himself in the process of work), which takes into account not only the mac address of the frame, but also its vlan tag.  If we draw an analogy of VLAN with VRF, then each vlan is easiest to consider as a separate virtual entity - that is, a virtual switch.  By issuing the vlan 100 command on Cisco, we create a virtual switch with a tag of 100. Each virtual switch created by us has a certain set of interfaces (by allowing the interface on a certain interface, we add a port to a specific virtual switch), as well as a table of correspondence mac addresses and ports (we see it with the command show mac-address-table dynamic vlan 100). <br><br>  Theoretically, we can imagine that when a frame with a vlan tag arrives at some switch port, then the decision to further send the frame is made on the basis of the mac table of addresses of the corresponding virtual switch.  If a frame with a tag of 100 is received, then the decision to forvard this frame will be made based on the mac of the virtual switch table with a tag of 100. <br><br>  A classic switch when receiving a frame (for us it doesn't matter what frame it is - broadband or unicast) floods it into all of its ports.  If the switch has a reason not to flood the packet to any port or group of ports, it will not do this: if the switch knows for sure, no matter where it is that the destination mac is not located at a specific port or that the frame is sent to a specific port or Since the ports are not needed (well, for example, igmp-snooping is enabled), then the switch will not flood the frame into this port (or ports).  It is logical that when you receive a frame, the switch has at least a reason not to flood this frame back to the port from which it came - this is a banal horizon splitting rule.  If the switch knows for sure that the destination mac address lives behind a certain port, the frame will be sent to only one specific port.  Based on the foregoing, the logical switch can be represented as follows: <br> <a href=""><img src="https://habrastorage.org/webt/lb/y5/lc/lby5lc4ye48hmwpio_ccloevtvu.png"></a> <br>  As you can see from the picture, it turns out that the frame that came with the tag 100 100 enters the virtual switch 100 and it is logical that now it cannot just get into another virtual switch ‚Äî that is, another vlan, well, for example, 200, because There is no direct connectivity between virtual switches.  When we create a routing interface, we create an interface through which a virtual switch can communicate with other virtual switches that also have a routing interface - that is, route packets between vlans. <br><br>  The diagram shows that the virtual switches VLAN-100 and VLAN-200 have routing interfaces through which these virtual switches can communicate.  At the same time, the virtual switch VLAN-N does not have the L3 interface configured - that is, this virtual switch does not have the ability to communicate with other virtual switches (in our case with VLAN-100 and VLAN-200).  The Vlan number in the classic L2 network is global - if we have an L2 domain from, for example, 10 switches, then the Vlan numbers are global for the entire domain. <br><br>  But we must understand that this is just a simplified logical model of the switch for understanding the principle of its operation.  And although the vlan can be thought of as a virtual switch, in reality it is not.  That is, we do not have a separate switching table for Vlan 100 or Vlan 200. Naturally, we can see which poppies we studied in a particular vlan (and you can see that the same poppy can be in different vlans) but this does not mean that a separate table has been allocated for this vlan on the equipment.  The switchboard has one single forwarding table, regardless of the number of vlans configured on it.  Just when a received frame is flooding, the switch knows that it is not necessary to send this frame to certain ports.  For example, if the eth1 / 1 port is an access port in 200 of the 200 and the eth1 / 2 port is a trunk port, but the 100 is not allowed on it, then the switch (meaning physical) will not flood the ports with the tag 100, because knows for sure that there are no hosts in the 100th vlan behind these ports.  Physically, this is exactly the case, but it is logically easier to imagine that these ports do not belong to the virtual switchboard with 100 VLAN, and therefore the frame cannot simply be sent to them. <br><blockquote>  Note: You should not try to apply this concept to bridge domains on modern routers - this is essentially a different world with its own laws, in which the vlan number essentially matters only on the link.  All described corresponds to the classic switch, which does not support the extended vlan space.  I wrote a separate article about bridge domains (for JunOS).  If anyone is interested, I can do a similar article for IOX-XR. </blockquote><br>  That is, we have the following: we have a virtual switch, defined by some vlan tag and having some set of ports.  Exactly the same concept underlies the VxLAN.  Only in VxLAN, the role of the vlan tag is played by the VxLAN Network Identifier (sometimes also called the Virtual Network Identifier), or VNI for short.  Unlike the vlan tag, which is 12 bits long (that is, there can be a maximum of 4096 vlans in one L2 domain), the VNI is 24 bits long ‚Äî that is, it can take 16,777,214 unique values.  Like the vlan tag, VNI is unique to the entire VxLAN domain.  That is, if Host A lives behind VTEP A and Host B behind VTEP B, then on both VTEPs, these hosts must be behind the interface that belongs to the same VNI, otherwise L2 connectivity between hosts A and In will not.  Everything is the same as VLAN - after all, if on one switch the host will be in 100 100 and on the next other host in 200, then there will be no L2 connectivity between these hosts. <br><blockquote>  Note: it is very important to understand that unlike MPLS tags, which are unique only within one node, the VNI identifier has global meaning for the entire VxLAN domain.  Therefore, it is very difficult to calculate what will be more L2 networks when using VxLAN or VPLS (with MPLS).  Absolute value is natural and points in favor of VxLAN.  But if in VPLS you can use the same label for different clients (for example, if VPLS domain 1 on PE 1 uses the label 299001, this does not mean that the VPLS domain 2 on PE 2 cannot use the same label 299001) .  But when using VxLAN this number will not work.  If you use the same VNI on both PE1 and PE2, then the client connected to PE1 will be able to communicate with the client connected to PE2. </blockquote><br>  As I wrote earlier, when creating a vlan, we essentially create a virtual switch and then add some ports and a routing interface to it (if necessary).  But what ports do we add?  Do we have to use physical ports?  Or you can use virtual?  Recall, for example, a protocol such as GRE.  When creating a GRE tunnel, a logical interface is created ‚Äî for example, gre-0/0/0 on JunOS.  Similarly, when creating a VxLAN tunnel, a tunnel interface appears on the switch, for example, vtep.xxx on JunOS.  This interface, as we will see later, is trunk and is capable of transferring both tagged and untagged frames.  If you have the opportunity to climb on some box and look at the table of MAC addresses in VPLS, then you will see that some of the poppies will not be visible through the physical port, but the logical lsi interface (for example, JunOS).  The lsi interface is nothing more than a tunnel (pseudowire in VPLS terms) to any PE router.  What is worse VxLAN tunnel?  The VxLAN uses the same principle - only the tunnel signaling is different. <br><br>  As a result, the switch uses the VxLAN tunnels it has as trunk ports, into which, like the real port, packets are flooded and through it examines poppies.  That is, if we have several remote VTEPs, then the switch logic will now look like this: <br> <a href=""><img src="https://habrastorage.org/webt/4r/jz/br/4rjzbrq3vjcukjlne3k9n5dtnfw.png"></a> <br>  But as I said at the beginning, if the port has a reason not to flood the received frame into any port or group of ports, then it will not do that.  By default, the frame is not sent only to the port from which it arrived - this is a simple rule for splitting the horizon.  In VxLAN, this rule also works, but there are some nuances. <br><br>  Suppose a frame is received through a physical port.  In this scenario, everything is fine - the switch just floods the packet to all ports (well, except for the port from which the frame was received).  But what if the frame is received through a VxLAN tunnel?  Since between all VTEPs, a fully connected topology from VxLAN tunnels is created, it is logical that the frame received from the tunnel does not need to be flooded again to other VxLAN tunnels, since the other VTEPs have already received this frame - this is the essence of the fully connected topology . <br><br>  But how to understand under what circumstances to which ports the frame should flood, and which ones should not?  For this, ports that are VxLAN tunnels are combined into a virtual group (let's call it the split horizon group) and if the frame is received from a port that is a member of this group, then the other ports that are in this group will not flood.  Naturally, the equipment allows you to change this behavior, for example, for the hub-and-spoke topology.  But you just shouldn't do it this way - the broadcast storm is a ‚Äúfun‚Äù thing. <br><br>  To summarize the first part of our article: VxLAN is an extended analog of VLAN - that is, it is a virtual L2 network.  L2             ‚Äî    .  VLAN, VxLAN   VLAN ,     L2  ‚Äî VxALN Network Identifier (VNI).  VNI  24 ,     16   L2    .   VLAN , VNI      L2 (VxLAN) .  mac    flood-and-learn ‚Äî       (         )   source mac    .     ,     VTEP-   . <br><br> ,       ‚Äî vpn   -  -.  IP/MPLS  underlay  IP/MPLS ,    MPLS  overlay.    ,     - .     GRE.  overlay- ,    p2p      .     IP    IP ,       GRE . <br><br> VxLAN   ,    .    GRE,   ethernet   VxLAN .     8             VNI.  ,      ,        ,   VNI    ‚Äî       VLAN .  What's next?       GRE     VxLAN   IP .  But there is a problem.    IP   protocol,    ,     ,       IP . GRE     47,   VxLAN   .      VxLAN   IP ,           ,     .  VxLAN ,    GTP,    UDP,    protocol .         UDP   IP .  VxLAN    UDP  4789. <br><br>   ‚Äî  UDP?   TCP,   ,        .   ,  TCP         ‚Äî     ‚Äî            .    ,      TCP.     TCP  TCP ‚Äî    .  ,   ,    ,       underlay  VTEP-A&lt;&lt;&gt;&gt;VTEP-B    overlay  SERVER-A&lt;&lt;&gt;&gt;SERVER-B.        TCP,     ‚Äî     .       underlay    overlay .   ,  underlay TCP       ,    overlay TCP .         ,             ‚Äî  .            UDP   ,  UDP   ,  TCP ‚Äî   p2p       p2mp ‚Äî     ,    . <br><br>  VxLAN    : <br> <a href=""><img src="https://habrastorage.org/webt/lz/vw/qu/lzvwquv46camhcktasziytgmexo.png"></a> <br>        VNI. <br><br>     ,       UDP   IP ‚Ä¶   ?     . VxLAN     ,       .       ,   VTEP?       . <br><br>         (      ). VxLAN    .    . <br><br> <b><font color="#0112FF">Static (Unicast) VxLAN</font></b> <br><br>    ‚Äî     VTEP.     VPLS Martini.    ,    VNI       VTEP,      VNI.    VTEP    IP     ‚Äî    VTEP. ,  VTEP-   ,           .   IP     ,       VxLAN    VTEP       VTEP-,   .   ,  VTEP  ,   VNI             VNI (  ,        ).  ,      ,  mac       source mac,    VxLAN  VTEP  mac ,      ethernet     VTEP,     .      ‚Äî VxLAN       . <br><br>     ‚Äî     ,   BUM     VTEP        ,        VTEP       VTEP-       ().    -     .         ,  openvswitch       ,       (   ). <br><br>            VTEP.          VxLAN   . <br><br> <b><font color="#0112FF">Multicast VxLAN</font></b> <br><br>   ,    ,    VTEP- ,      underlay,     VTEP.      VTEP-    .        ,     -  ,      VNI (  VNI).  ,      VNI,  ( VTEP,        )    .     ? ,        VTEP- (      VNI-multicast ) ‚Äî      .         ,     VTEP-.           VTEP-. <br><br>        ‚Äî VTEP  VxLAN ,    (   IP ),          VNI   ‚Äî   ,  VTEP        .        .     VTEP   ,     VxLAN .      ,    ‚Äî   ,   (      VTEP  ,   VTEP-     mac     VTEP)  . <br><br>      VxLAN  UDP   ‚Äî   UDP?       p2mp  ‚Äì     . TCP    p2mp ,    UDP,     . <br><br>   -   bidir-PIM,    ,   VTEP         (       ).         ‚Äî ,   VxLAN       VxLAN . <br><br>         BUM    underlay       .         .          VTEP  IP   .    -   (     ,   ) ‚Äî    ,       VNI- .         . <br><br> <b><font color="#0112FF">EVPN/VxLAN</font></b> <br><br>  ,       ‚Äî   EVPN  control plane  VxLAN.  -  ,    EVPN,      ,       MPLS/EVPN,       VxLAN/EVPN.    EVPN/VxLAN    ‚Äì   . <br><br>    ,  EVPN ‚Äî     ( )  BGP,        VTEP-   .        ,    link-state  (   ),        mac ?  EVPN       l2vpn (AFI 25).    mac          BGP  ‚Äî    ,     L3VPN.   EVPN/MPLS  BGP NLRI   mac  (    RT/RD/next-hop    )  MPLS .       ‚Äî    MPLS.      ,      VNI!    ,     BGP   VNI. <br><br> EVPN NLRI      3  ‚Äî   24 ,      VNI.     BGP       VNI.  ,    ‚Äî  ,    EVPN   ,    MPLS Label   VNI,   MPLS ?          ,      .    Wireshark     VNI,  MPLS  (    4   ,  Wireshark       6,   VNI 100): <br> <a href=""><img src="https://habrastorage.org/webt/y5/04/yx/y504yxiodotkxnhldsmjhp3ebho.png"></a> <br>        ,  ,        vxlan : <br> <a href=""><img src="https://habrastorage.org/webt/q6/pa/sf/q6pasfzcnifwvnjztcjyuhyftfk.png"></a> <br>     ,       ,    VNI: <br> <a href=""><img src="https://habrastorage.org/webt/0i/1j/q5/0i1jq546zyo5xt5agklvvzrcb20.png"></a> <br>       ‚Äî   5-   ( ,       8 ,        ). -,       ,        ( VTEP),       .           ,  -  ( RP  ,    ,          RP). <br><br>       .    EVPN?           ‚Äî EVPN      data plane  control plane.     ,   ,       ? -,     -VTEP ,  ,  data-plane. ,  ,    ? ,      ,  ,      (  ). <br><br>  EVPN    ‚Äî      VTEP-  mac   data plane,   BGP ,          .   VTEP-,   BGP    mac   .  What does this give us?  ,            ,    ,     ,   mac .   ,      control plane ‚Äî    . <br><br>              ,      ? , ,  -    mac ,  BGP           ‚Äî    ,      mac.         mac  ,            .      flood-and-learn   ,      EVPN        ,      data-plane      control plane.   EVPN        ,       . <br><br>      EVPN?       ,       . <br><br>      EVPN  ,  Single-Active,   All-Active (             MC-LAG).         (MLAG -Arista, vPC ‚Äì Cisco Nexus),    EVPN.       ‚Äî     EVPN  .      ,    L2  ( All-Active,  Single-Active   ) ‚Äî            .    ,      DF ‚Äî  ,     BUM    .      BUM ,  .    ,        non-DF        DF. ,   DF   ,    . <br><br>  EVPN/MPLS      ESI    ‚Äî      ,  DF       ,    .   VxLAN  .  ?       . <br><br>    EVPN/MPLS ,                ‚Äî ESI.     4,      ESI (   MC-LAG     )   DF,       .      ,       ESI,     ,   ,       (    ).     VTEP-,    ,    ESI,       .            local bias.    DF          . <br><br>     EVPN       ,       (Mass Withdrawal),     ,   mac      (Aliasing),  L3   anycast GW,       . <br><br> <b><font color="#0112FF">VxLAN   </font></b> <br><br>        .     VTEP     ,         .         ,  ,      ,      ,      ,    . <br><br>    ,   . ,   VxLAN  underlay   IP  (    ),    end-to-end   IP    VTEP-.      overlay   udp   VxLAN.       (   ),   ‚Äî    ( VNI   )  EVPN,     . <br><br>  ,     ,     L2   VxLAN     IP ,  ,      . ,   ,   :  RFC ,      vlan    ,        VxLAN.     , ,  Cisco Nexus  Juniper QFX.    ,        rewrite-          VTEP.         .   VTEP A VNI 100   100,      VTEP B VNI 100   200. VxLAN     ,      ,        VTEP (   VTEP B  200   100  ,     ‚Äî  100   200)     .     ,       VNI     VTEP   . <br><blockquote> :    ,     (   vlan-bundle   VNI ‚Äì            ‚Äì           VxLAN    -,       VTEP  ,       ,     . </blockquote><br> , ,     : <br><br> 8  (VxLAN ) + 8  (UDP ) + 20  (IPv4 ) + 14  ( L2 ) = 50  (54 c   ). <br><br> , - ,  .       Jumbo ,        . <br> <a href=""><img src="https://habrastorage.org/webt/xs/tu/uk/xstuukhjhpvqjg7tpm9x_kpztek.png"></a> <br>   ,   NVGRE,       : <br><br> 4  ( ,    ) + 8  (GRE) + 20  (IPv4) + 14  (L2) = 46  <br><br>  VPLS: <br><br> 4  ( MPLS ) + 4  ( MPLS ) + 14  (L2 ) = 22  (26          ). <br><br>   FRR , , BGP-LU     ,     : ¬´,   ¬ª <br><br>   ,     64-  ,          ,      4000-9000  ‚Äî    ,  . <br><br>  , ,     VxLAN     L2  (   ,    ): <br><br> 1.      STP; <br> 2.        ; <br> 3.   L2  (4K vs 16M); <br> 4.      (ECMP); <br> 5. L2     ; <br> 6.                 (        ‚Äî switchport trunk    add ‚Äî   ,       ) ‚Äî  VxLAN     VTEP. <br><br>  ,            . <br><br>    ,          JunOS?  , ,  .       ,  ,    .     ,      ?                . <br><blockquote>      . </blockquote><br><br> <b><font color="#0112FF"> </font></b> <br><br>        : <br> <a href=""><img src="https://habrastorage.org/webt/ne/-g/yn/ne-gynbp2as7m_ko7s5pxhg6edm.png"></a> <br>        ‚Äî  Spine   Leaf-.             (         ECMP         ),   ,         . <br><br>   Spine    lldp   Leaf-: <br><pre><code class="javascript hljs">Spine<span class="hljs-number"><span class="hljs-number">-1</span></span>#show lldp neighbors Last table change time : <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span> ago <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> table inserts : <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> table deletes : <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> table drops : <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> table age-outs : <span class="hljs-number"><span class="hljs-number">0</span></span> Port Neighbor Device ID Neighbor Port ID TTL Et1 Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span> Ethernet1 <span class="hljs-number"><span class="hljs-number">120</span></span> Et2 Leaf<span class="hljs-number"><span class="hljs-number">-2</span></span> Ethernet1 <span class="hljs-number"><span class="hljs-number">120</span></span> Et3 Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span> Ethernet1 <span class="hljs-number"><span class="hljs-number">120</span></span></code> </pre> <br>  IGP in its usual form - I did not launch ISIS / OSPF / EIGRP, BGP was used for this purpose - between the Spine and Leaf nodes the eBGP ipv4 sessions are stretched: <br><pre> <code class="javascript hljs">Spine<span class="hljs-number"><span class="hljs-number">-1</span></span>#show ip bgp summary BGP summary information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Router identifier <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>, local AS number <span class="hljs-number"><span class="hljs-number">65000</span></span> Neighbor Status Codes: m - Under maintenance Neighbor V AS MsgRcvd MsgSent InQ OutQ Up/Down State PfxRcd PfxAcc <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> Estab <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> Estab <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">65003</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> Estab <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  Redistribution of all connected networks is included in BGP (in general, only Lupbacks are needed for VxLAN operation, but I announced everything in order to test routing later).  In the future, we will change configurations - add new address families, launch multicast, and so on. Each test will start with the clean topology presented above (all configs that will be made in the previous test will be deleted, so that we can understand what we are running ). <br>  Well, let's start with the banal: <br><br>  <b><font color="#0112FF">Static (Unicast) VxLAN</font></b> <br><br> <a href=""><img src="https://habrastorage.org/webt/km/cw/i2/kmcwi2hmtitjjocbyqtvv5ag5co.png"></a> <br>  We go in order.  Create vlan 100 and enable it on the interface towards the server: <br><pre> <code class="javascript hljs"> vlan <span class="hljs-number"><span class="hljs-number">100</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-1</span></span> ! interface Ethernet5 description Server<span class="hljs-number"><span class="hljs-number">-1</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">100</span></span> switchport mode trunk</code> </pre> <br>  Now we need to associate vlan 100 with some vni (no matter what, I chose vni 100 for a long time - you can take any, at least 1 at least 16 million - it does not matter).  To do this, create a virtual interface vxlan1: <br><pre> <code class="javascript hljs">interface Vxlan1 vxlan source-interface Loopback0 vxlan udp-port <span class="hljs-number"><span class="hljs-number">4789</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> flood vtep <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  vxlan 1 is a tunnel interface that is designed to heat VxLAN tunnels.  On Cisco, a similar interface is called nve (network virtualized interface), on Junos - vtep (there is no need to decrypt, thinking), but as you understand, the name bears only a semantic load - the principle of operation does not change from this. <br><br>  In the configuration of the vxlan interface, we specify which vlan to which vni mappits: <br><pre> <code class="javascript hljs">vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>  In our case, vlan 100 in VNI 100. <br>  Since we have a static VxLAN, we need to specify all the remote VTEPs, as can be seen in the last line of the vxlan interface config: <br><pre> <code class="javascript hljs"> vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> flood vtep <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  The diagram shows that in the direction of Server-3, not vlan 100, but vlan 300 is used. Therefore, on Leaf-3, the config is somewhat different: <br><pre> <code class="javascript hljs">vlan <span class="hljs-number"><span class="hljs-number">300</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-1</span></span> ! interface Ethernet5 description Server<span class="hljs-number"><span class="hljs-number">-1</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">300</span></span> switchport mode trunk ! interface Vxlan1 vxlan source-interface Loopback0 vxlan udp-port <span class="hljs-number"><span class="hljs-number">4789</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">300</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">300</span></span> flood vtep <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  Actually, that's all.  Next, check that everything started. <br>  At the moment everything is calm - there was no traffic exchange between the hosts, as evidenced by the lack of poppies in the forwarding table: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show mac address-table vlan <span class="hljs-number"><span class="hljs-number">100</span></span> unicast Mac Address Table ------------------------------------------------------------------ Vlan Mac Address Type Ports Moves Last Move ---- ----------- ---- ----- ----- --------- Total Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Although all the vteps are statically registered by us: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan flood vtep VXLAN Flood VTEP Table -------------------------------------------------------------------------------- VLANS Ip Address ----------------------------- ------------------------------------------------ <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  but the switch still does not see them, since the exchange has not yet been: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Here, the behavior of different vendors is different - Nexus or QFX will immediately show you that they see remote VTEP, if they are available over IP.  Arista will show us the presence of remote VTEP only after any exchange has been made. <br>  So, we have the following summary information on the VNI configured by us (we have it alone): <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Replication/Flood Mode is headend <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Flood List Source: CLI Remote MAC learning via Datapath Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Headend replication flood vtep list is: <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  What can we actually say about this conclusion?  We use loopback0 with address 62.0.0.1 as a source for vxlan tunnels, flood frames occur according to the list of remote VTEPs specified in the CLI, vlan 100 is statically mapped to the VNI 100, and at the end the list of VTEPs we have configured. <br><br>  On Leaf-2, everything is practically the same (only the list of peers is different, which is logical), and on Leaf-3 there are more changes, as we have already seen, therefore I will give a conclusion from it.  As you can see, on Leaf-3 vlan 300 mappits into the same vni 100: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show vxlan vni <span class="hljs-number"><span class="hljs-number">100</span></span> VNI to VLAN Mapping <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1 VNI VLAN Source Interface <span class="hljs-number"><span class="hljs-number">802.1</span></span>Q Tag --------- ---------- ------------ --------------- ---------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Ethernet5 <span class="hljs-number"><span class="hljs-number">300</span></span> Note: * indicates a Dynamic VLAN</code> </pre> <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Replication/Flood Mode is headend <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Flood List Source: CLI Remote MAC learning via Datapath Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Headend replication flood vtep list is: <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  Now we‚Äôll run the ping between the servers and see if the circuit will take off or not: <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> source <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">59.807</span></span>/<span class="hljs-number"><span class="hljs-number">119.973</span></span>/<span class="hljs-number"><span class="hljs-number">338.390</span></span>/<span class="hljs-number"><span class="hljs-number">109.381</span></span> ms</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> source <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">64.941</span></span>/<span class="hljs-number"><span class="hljs-number">89.089</span></span>/<span class="hljs-number"><span class="hljs-number">157.432</span></span>/<span class="hljs-number"><span class="hljs-number">35.149</span></span> ms</code> </pre> <br>  Ping pass - there is connectivity through the tunnels.  Let's look at the mac address table on the switches: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan address-table dynamic vlan <span class="hljs-number"><span class="hljs-number">100</span></span> Vxlan Mac Address Table ---------------------------------------------------------------------- VLAN Mac Address Type Prt VTEP Moves Last Move ---- ----------- ---- --- ---- ----- --------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e02</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e03</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> ago Total Remote Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Two mac addresses are learned dynamically and are visible through the tunnel interface, or to be more precise, through the VxLAN tunnel to Leaf-2 and Leaf-3. <br>  The very same table poppy addresses has the following form: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show mac address-table vlan <span class="hljs-number"><span class="hljs-number">100</span></span> unicast Mac Address Table ------------------------------------------------------------------ Vlan Mac Address Type Ports Moves Last Move ---- ----------- ---- ----- ----- --------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e01</span></span> DYNAMIC Et5 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e02</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e03</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span> ago Total Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  In both cases, you see timers.  After a certain time (the default is 300 seconds of inactivity), the poppy will be deleted - everything is standard here. <br><br>  After the traffic exchange occurred, Leaf-1 found two neighbors: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  But Leaf-3 (as well as Leaf-2) sees only one neybor: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  This is logical and normal, since there was no traffic exchange between server 2 and 3. <br><br>  Now let's see how it will look when removing the dump on the link between Leaf-1 and Spine-1. <br>  The whole exchange is as follows: <br> <a href=""><img src="https://habrastorage.org/webt/3y/zt/9g/3yzt9gt24rg2qqz3ddnryq53qyg.png"></a> <br>  First, the Server forms an ARP request that the switch must send to all remote VTEPs.  As we found out earlier, replication occurs on the outgoing node with the further distribution of the package by unicast: <br> <a href=""><img src="https://habrastorage.org/webt/zl/bf/uy/zlbfuyborouwohlvsbi4nnb8bx8.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/ae/ki/lh/aekilhfedyfqlwgjhtyto6mbpju.png"></a> <br>  One of their servers just drops the received packet, since this request is not addressed to it, but the second server responds safely: <br> <a href=""><img src="https://habrastorage.org/webt/fm/0x/pc/fm0xpcmxxvsd_6jbpkg1ppeowbq.png"></a> <br>  After that, both servers know each other‚Äôs mac addresses and can start exchanging traffic, in our case ICMP: <br> <a href=""><img src="https://habrastorage.org/webt/fs/i_/pp/fsi_ppt4h54qz5e8tehcjekax5q.png"></a> <br>  Now we will make a gateway for access to the external network with VRRP: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show running-config interfaces vlan <span class="hljs-number"><span class="hljs-number">100</span></span> interface Vlan100 ip address <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> priority <span class="hljs-number"><span class="hljs-number">128</span></span> vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> authentication text vlan100 vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> ip <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span></code> </pre> <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-2</span></span>#show running-config interfaces vlan <span class="hljs-number"><span class="hljs-number">100</span></span> interface Vlan100 ip address <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.253</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> priority <span class="hljs-number"><span class="hljs-number">64</span></span> vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> authentication text vlan100 vrrp <span class="hljs-number"><span class="hljs-number">100</span></span> ip <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span></code> </pre> <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vrrp group <span class="hljs-number"><span class="hljs-number">100</span></span> interface vlan <span class="hljs-number"><span class="hljs-number">100</span></span> Vlan100 - Group <span class="hljs-number"><span class="hljs-number">100</span></span> VRF is <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> VRRP Version <span class="hljs-number"><span class="hljs-number">2</span></span> State is Master Virtual IPv4 address is <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> Virtual MAC address is <span class="hljs-number"><span class="hljs-number">0000.5e00</span></span><span class="hljs-number"><span class="hljs-number">.0164</span></span> Mac Address Advertisement interval is <span class="hljs-number"><span class="hljs-number">30</span></span>s VRRP Advertisement interval is <span class="hljs-number"><span class="hljs-number">1</span></span>s Preemption is enabled Preemption delay is <span class="hljs-number"><span class="hljs-number">0</span></span>s Preemption reload delay is <span class="hljs-number"><span class="hljs-number">0</span></span>s Priority is <span class="hljs-number"><span class="hljs-number">128</span></span> Authentication text, string <span class="hljs-string"><span class="hljs-string">"vlan100"</span></span> Master Router is <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> (local), priority is <span class="hljs-number"><span class="hljs-number">128</span></span> Master Advertisement interval is <span class="hljs-number"><span class="hljs-number">1</span></span>s Skew time is <span class="hljs-number"><span class="hljs-number">0.500</span></span>s Master Down interval is <span class="hljs-number"><span class="hljs-number">3.500</span></span>s</code> </pre> <br>  Now run ping server 3 to the gateway: <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-3</span></span> source <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">56.915</span></span>/<span class="hljs-number"><span class="hljs-number">75.978</span></span>/<span class="hljs-number"><span class="hljs-number">134.126</span></span>/<span class="hljs-number"><span class="hljs-number">29.286</span></span> ms</code> </pre> <br>  Gateway is available.  Since we have a vlan interface in grt, then having announced this address via BGP, we can reach other networks, for example, our own Leaf-3 loopback: <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-3</span></span> source <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">93.210</span></span>/<span class="hljs-number"><span class="hljs-number">111.745</span></span>/<span class="hljs-number"><span class="hljs-number">138.930</span></span>/<span class="hljs-number"><span class="hljs-number">16.970</span></span> ms</code> </pre> <br>  The traffic path in this scenario is as follows: a packet from the server on the default route falls on Leaf-3.  Since the MAC address of the gateway, which is specified as the destination address, Leaf-3 knows through the VxLAN tunnel to Leaf-1, the packet through this tunnel flies to Leaf-1.  Further, Leaf-1 decapsulates the packet, and sees that the destination address is 62.0.0.3, the route to which it is known in grt through bgp.  Next, the packet is routed back to Leaf-3.  The response from the loopback Leaf-3 is returned in the same way. <br><br>  As you can see, the VxLAN technology, and especially in the version we have considered ‚ÄîStatic (Unicast) VxLAN ‚Äî is as simple as a boot and as reliable as a Kalashnikov assault rifle.  Well, what is there to break as a matter of fact? <br><br>  For example, here are the configs from Cisco and Juniper: <br><br>  On the Cisco Nexus, everything is more or less similar to the Arista configuration - in any case, the approach is the same. <br>  We create nve interface (analog vxlan) and the vlan we need: <br><pre> <code class="javascript hljs">vlan <span class="hljs-number"><span class="hljs-number">100</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-100</span></span> vn-segment <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br><pre> <code class="javascript hljs">interface nve1 no shutdown source-interface loopback0 member vni <span class="hljs-number"><span class="hljs-number">100</span></span> ingress-replication protocol <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> peer-ip <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> peer-ip <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  Further we allow this vlan towards the client and everything is ready.  Naturally, since this Nexus does not forget to include the features we need: <br><pre> <code class="javascript hljs">interface Ethernet1/<span class="hljs-number"><span class="hljs-number">2</span></span> description Server<span class="hljs-number"><span class="hljs-number">-1</span></span> | LS<span class="hljs-number"><span class="hljs-number">-3</span></span> switchport mode trunk switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br><pre> <code class="javascript hljs">feature bgp feature vn-segment-vlan-based feature lldp feature nv overlay</code> </pre> <br><br>  On Juniper QFX, everything is a little different (well, it's a juniper).  In the switch-options hierarchy, we specify the source for the VxLAN tunnel and the addresses of the remote VTEPs: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>-options { vtep-source-interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span>; remote-vtep-list [ <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ]; }</code> </pre> <br><pre> <code class="javascript hljs">vlans { VLAN400 { vlan-id <span class="hljs-number"><span class="hljs-number">400</span></span>; vxlan { vni <span class="hljs-number"><span class="hljs-number">16000100</span></span>; ingress-node-replication; } } }</code> </pre> <br>  Further we allow this vlan towards the client and everything is ready. <br><br>  I think we figured it out.  Now let's move on to the second option - we will use multicast to automatically search for neighbors and replicate BUM traffic. <br><br>  <b><font color="#0112FF">Multicast VxLAN</font></b> <br><br>  As you might guess, first we need to run PIM.  We will use Spine as RP, since it has an ideal location in the topology for performing this function.  I will not show off and set up a static RP, and I have only one spine: <br> <a href=""><img src="https://habrastorage.org/webt/md/xq/ky/mdxqkyddcrk-ddsgrvaeka1sl0y.png"></a> <br><pre> <code class="javascript hljs">ip pim rp-address <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> ! interface Ethernet1 ip pim sparse-mode</code> </pre> <br>  Since we deleted the entire config we made in the first test, we need to create the required vlan again (100 vlan on Leaf-1/2 and 300 on Leaf-3), and allow them to the server (I will not show the config , you already saw it). <br>  Now we create the vxlan interface: <br><pre> <code class="javascript hljs">interface Vxlan1 vxlan multicast-group <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> vxlan source-interface Loopback0 vxlan udp-port <span class="hljs-number"><span class="hljs-number">4789</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>  Like last time, vlan 100 corresponds to vni 100 (on Leaf-3, vlan 300 corresponds to vni 100).  Now we need to associate vni 100 with mgroup 230.0.0.100.  Such a chain was obtained - vlan 100 &gt;&gt; vni 100 &gt;&gt;&gt; mgroup 230.0.0.100. <br><br>  That's the whole configuration.  Check that our configuration will take off.  Let's see if a neighborhood with all leaf has climbed to RP: <br><pre> <code class="javascript hljs">Spine<span class="hljs-number"><span class="hljs-number">-1</span></span>#show ip pim neighbor PIM Neighbor Table Neighbor Address Interface Uptime Expires Mode <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Ethernet1 <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> sparse <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Ethernet2 <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> sparse <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Ethernet3 <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> sparse</code> </pre> <br>  Great, the Nybora are visible.  We look at the summary information on vxlan: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Replication/Flood Mode is multicast Remote MAC learning via Datapath Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Multicast group address is <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  Here, the replication method and the flood are indicated - multicast, and instead of a sheet listing all remote VTEPs - only the multicast group.  For Leaf-3, everything is the same, adjusted for the Vlan number: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">0</span></span> Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Replication/Flood Mode is multicast Remote MAC learning via Datapath Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Multicast group address is <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  Since we already know how VxLAN should work through multicast, then according to the rules, after we configured the vxlan interface and added the vlan &lt;&lt; &gt;&gt; VNI association, Leafs should join the 230.0.0.100 group: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show ip mroute PIM Bidirectional Mode Multicast Routing Table RPF route: U - From unicast routing table M - From multicast routing table PIM Sparse Mode Multicast Routing Table Flags: E - Entry forwarding on the RPT, J - Joining to the SPT R - RPT bit is set, S - SPT bit is set, L - Source is attached W - Wildcard entry, X - External component interest I - SG Include Join alert rcvd, P - (*,G) Programmed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hardware H - Joining SPT due to policy, D - Joining SPT due to protocol Z - Entry marked <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deletion, C - Learned <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a DR via a register A - Learned via Anycast RP Router, M - Learned via MSDP N - May notify MSDP, K - Keepalive timer not running T - Switching Incoming Interface, B - Learned via Border Router RPF route: U - From unicast routing table M - From multicast routing table <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>, RP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>, <span class="hljs-attr"><span class="hljs-attr">flags</span></span>: W Incoming interface: Ethernet1 RPF route: [U] <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Outgoing interface list: Loopback0</code> </pre> <br>  We see the record (*, G) - that is, Leaf-1 wants to receive multicast traffic of the group 230.0.0.100 and no matter who will be the source for this group.  Since there was no traffic exchange, there are no poppies in the forwading table on the switch either: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan address-table Vxlan Mac Address Table ---------------------------------------------------------------------- VLAN Mac Address Type Prt VTEP Moves Last Move ---- ----------- ---- --- ---- ----- --------- Total Remote Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  As well as there are no known remote VTEPs: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Let's start ping between servers and check the fact of connectivity, and, accordingly, the presence of poppies in VTEP tables: <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">57.521</span></span>/<span class="hljs-number"><span class="hljs-number">69.366</span></span>/<span class="hljs-number"><span class="hljs-number">82.147</span></span>/<span class="hljs-number"><span class="hljs-number">10.469</span></span> ms</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">59.762</span></span>/<span class="hljs-number"><span class="hljs-number">81.369</span></span>/<span class="hljs-number"><span class="hljs-number">164.374</span></span>/<span class="hljs-number"><span class="hljs-number">41.505</span></span> ms</code> </pre> <br>  There is a connection, and judging by the conclusion below, Leaf-1 found two remote VTEPs: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  It is logical that the addresses of servers 2 and 3 will be visible through the vxlan tunnel: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan address-table vlan <span class="hljs-number"><span class="hljs-number">100</span></span> Vxlan Mac Address Table ---------------------------------------------------------------------- VLAN Mac Address Type Prt VTEP Moves Last Move ---- ----------- ---- --- ---- ----- --------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e02</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.1e03</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> ago Total Remote Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  But we have already seen everything described above in the past test - where are the differences?  Differences further.  Since Leaf-1 sent traffic to the group address 230.0.0.100, we should see that this switch became the source for this group: <br><pre> <code class="javascript hljs">Spine<span class="hljs-number"><span class="hljs-number">-1</span></span>#show ip pim upstream joins Neighbor address: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Via interface: Ethernet1 (<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>) Group: <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> Joins: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> SPT Prunes: No prunes included</code> </pre> <br>  Now let's move to Leaf-3, and see which groups this switch listens on: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show ip mroute PIM Bidirectional Mode Multicast Routing Table RPF route: U - From unicast routing table M - From multicast routing table PIM Sparse Mode Multicast Routing Table Flags: E - Entry forwarding on the RPT, J - Joining to the SPT R - RPT bit is set, S - SPT bit is set, L - Source is attached W - Wildcard entry, X - External component interest I - SG Include Join alert rcvd, P - (*,G) Programmed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hardware H - Joining SPT due to policy, D - Joining SPT due to protocol Z - Entry marked <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deletion, C - Learned <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a DR via a register A - Learned via Anycast RP Router, M - Learned via MSDP N - May notify MSDP, K - Keepalive timer not running T - Switching Incoming Interface, B - Learned via Border Router RPF route: U - From unicast routing table M - From multicast routing table <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>, RP <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>, <span class="hljs-attr"><span class="hljs-attr">flags</span></span>: W Incoming interface: Ethernet1 RPF route: [U] <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Outgoing interface list: Loopback0 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">flags</span></span>: S Incoming interface: Ethernet1 RPF route: [U] <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>] via <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Outgoing interface list: Loopback0</code> </pre> <br>  Here we see a record of the type (*, G) that was previously (it tells us that the switch listens to the group 230.0.0.100 and does not care who the source is).  But the second entry already has the form (S, G), which tells us that the switch is listening to the group 230.0.0.100 with the address sorsa 62.0.0.1. <br><br>  Now we‚Äôll see a dump to see the whole exchange, so to speak, live: <br> <a href=""><img src="https://habrastorage.org/webt/fo/xt/d2/foxtd29wglsov0ndvszy70yg_yk.png"></a> <br>  The whole exchange looks a little different than in the first case.  First, a message is sent to the multicast group address: <br> <a href=""><img src="https://habrastorage.org/webt/du/4e/zd/du4ezdmr0rixnrlbvj3zmqoiagy.png"></a> <br>  In the dump, the PIM Register and Register-stop messages are clearly visible - that is, the multicast operation is in its pure form. <br><br>  Next we see the answer from the remote server, but unicast: <br> <a href=""><img src="https://habrastorage.org/webt/mt/qo/hi/mtqohipq9eoq1pqovl2tji5ryp4.png"></a> <br>  Well, after what the traffic exchange follows: <br> <a href=""><img src="https://habrastorage.org/webt/lr/hs/el/lrhselcpicrmknbkzje00mo9-po.png"></a> <br>  Now we will add another Server-4 server to the schema, connect it to Leaf-3 and place it on the VNI 200: <br>  The configuration on Leaf-3 has changed somewhat: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>(config-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-Vx1)#show active interface Vxlan1 vxlan multicast-group <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> vxlan source-interface Loopback0 vxlan udp-port <span class="hljs-number"><span class="hljs-number">4789</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">200</span></span> vni <span class="hljs-number"><span class="hljs-number">200</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">300</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>  I want to note that both VNI will use the same multicast group. <br><br>  Now, when trying to view information on the VxLAN interface, we see that we now have two VNIs: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Replication/Flood Mode is multicast Remote MAC learning via Datapath Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>] [<span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Multicast group address is <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  Vlan 200 is mapped in VNI 200, vlan 300 in VNI 100. They are looking at the same port: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show vxlan vni VNI to VLAN Mapping <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1 VNI VLAN Source Interface <span class="hljs-number"><span class="hljs-number">802.1</span></span>Q Tag --------- ---------- ------------ --------------- ---------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Ethernet5 <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Ethernet5 <span class="hljs-number"><span class="hljs-number">200</span></span> Note: * indicates a Dynamic VLAN</code> </pre> <br>  Next, create L3 interfaces.  On Leaf-1/2 we will make the vlan 100 interface with vrrp (as in the last test, I will not re-configure), and on Leaf-3 we will create a gate for the VNI 200: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show running-config interfaces vlan <span class="hljs-number"><span class="hljs-number">200</span></span> interface Vlan200 ip address <span class="hljs-number"><span class="hljs-number">200.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Leaf<span class="hljs-number"><span class="hljs-number">-3</span></span>#show vlan id <span class="hljs-number"><span class="hljs-number">200</span></span> VLAN Name Status Ports ----- -------------------------------- --------- ------------------------------- <span class="hljs-number"><span class="hljs-number">200</span></span> VNI<span class="hljs-number"><span class="hljs-number">-200</span></span> active Cpu, Et5, Vx1</code> </pre> <br>  As a result, our scheme acquired the following form: <br> <a href=""><img src="https://habrastorage.org/webt/cm/fp/jt/cmfpjttyokiyadd-8czrzkr9pvo.png"></a> <br>  Now let's check if routing between VNI works: <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-4</span></span> source <span class="hljs-number"><span class="hljs-number">200.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">0</span></span> ttl=<span class="hljs-number"><span class="hljs-number">61</span></span> time=<span class="hljs-number"><span class="hljs-number">155.736</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">61</span></span> time=<span class="hljs-number"><span class="hljs-number">117.702</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">61</span></span> time=<span class="hljs-number"><span class="hljs-number">120.800</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>: icmp_seq=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">61</span></span> time=<span class="hljs-number"><span class="hljs-number">127.033</span></span> ms ^C --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">4</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">4</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">117.702</span></span>/<span class="hljs-number"><span class="hljs-number">130.318</span></span>/<span class="hljs-number"><span class="hljs-number">155.736</span></span>/<span class="hljs-number"><span class="hljs-number">15.055</span></span> ms</code> </pre> <br>  The traffic path at the moment is the same - from Server-3 traffic flies along the default route to the mac address of the default gateway, which is on Leaf-3.  The switch, having received the packet, decapsulates it, and sees that it is intended for itself (vlan interface), then IP lookup occurs.  Since the host 100.0.0.3 lives on the network 100.0.0.0/24, the traffic is sent to Leaf-1, since the destination network is terminated there (VRRP Master lives on Leaf-1).  Over the IP network via Spine, the packet reaches Leaf-1.  The switch, accepting an IP packet (not a VxLAN but a pure IP), looks at the destination address and realizes that it sees it through the VxLAN tunnel to Leaf-3.  The packet is encapsulated in the VxLAN and sent to Leaf-3.  Leaf-3, receives the packet, decapsulates it, sees that the destination address is 100.0.0.3, which is connected to it via the eth5 interface, hangs a vlan tag and sends it to the server.  Here we have such an optimal routing, we have two servers that live on the same interface and communicate through the entire IP factory. <br><br>  As in the previous section for an example configuration of a similar service with Cisco and Juniper: <br>  On the Nexus, everything again looks like Arista.  We also create the necessary vlan and associate it with VNI: <br><pre> <code class="javascript hljs">vlan <span class="hljs-number"><span class="hljs-number">100</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-16000100</span></span> vn-segment <span class="hljs-number"><span class="hljs-number">16000100</span></span></code> </pre> <br>  And in the nve interface we indicate which multicast group should be tied to vni <br><pre> <code class="javascript hljs">interface nve1 no shutdown source-interface loopback0 overlay-encapsulation vxlan member vni <span class="hljs-number"><span class="hljs-number">16000100</span></span> mcast-group <span class="hljs-number"><span class="hljs-number">225.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  Naturally, we include the PIM feature and the PIM itself on the right interfaces.  Next, the vlan is prescribed in the direction of the client and everything should take off. <br><pre> <code class="javascript hljs">interface Ethernet1/<span class="hljs-number"><span class="hljs-number">2</span></span> description Server<span class="hljs-number"><span class="hljs-number">-1</span></span> | LS<span class="hljs-number"><span class="hljs-number">-3</span></span> switchport mode trunk switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br><br>  On Juniper QFX, you first need to enable pim on the right interfaces (including Lo0), as well as enable tunnel services on some of the FPC (necessary for PIM to work): <br><pre> <code class="javascript hljs">pim { rp { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { address <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>; } } interface xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { mode sparse; } interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span> { mode sparse; } interface xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { mode sparse;</code> </pre> <br><pre> <code class="javascript hljs">chassis { fpc <span class="hljs-number"><span class="hljs-number">0</span></span> { pic <span class="hljs-number"><span class="hljs-number">0</span></span> { tunnel-services { bandwidth <span class="hljs-number"><span class="hljs-number">40</span></span>g; } } } }</code> </pre> <br>  Further, the configuration looks like this: <br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">master</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}[edit] bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span># show <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>-options vtep-source-interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span>;</code> </pre> <br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">master</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}[edit] bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span># show vlans BRIDGE<span class="hljs-number"><span class="hljs-number">-4093</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">4093</span></span>; vxlan { vni <span class="hljs-number"><span class="hljs-number">4093</span></span>; multicast-group <span class="hljs-number"><span class="hljs-number">230.0</span></span><span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.93</span></span>; } }</code> </pre> <br>  Further we allow this vlan towards the client. <br><br>  I think we figured it out, so we move on. <br><br>  <b><font color="#0112FF">EVPN / VxLAN</font></b> <br><br>  Forgot your previous configuration and do it all over again: <br> <a href=""><img src="https://habrastorage.org/webt/im/4m/9m/im4m9m6wfpwkx-jceu75skoxhxa.png"></a> <br>  Create vlan 100 and enable it on the interface towards the server: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show running-config section vlan <span class="hljs-number"><span class="hljs-number">100</span></span> vlan <span class="hljs-number"><span class="hljs-number">100</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-1</span></span> ! interface Ethernet5 description Server<span class="hljs-number"><span class="hljs-number">-1</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">100</span></span> switchport mode trunk</code> </pre> <br>  Now we create the vxlan interface again, but now we only need to specify the outgoing interface for the vxlna tunnel (usually one of the loopbacks) and associate vlan 100 with vni 100: <br><pre> <code class="javascript hljs">interface Vxlan1 vxlan source-interface Loopback0 vxlan udp-port <span class="hljs-number"><span class="hljs-number">4789</span></span> vxlan vlan <span class="hljs-number"><span class="hljs-number">100</span></span> vni <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>  And then go to bgp.  Add the ability to forward extended communities, include the evpn address family, and add a neybor, which is Spine-1: <br><pre> <code class="javascript hljs">router bgp <span class="hljs-number"><span class="hljs-number">65001</span></span> neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> remote-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> description Spine<span class="hljs-number"><span class="hljs-number">-1</span></span> neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> soft-reconfiguration inbound all neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> send-community extended neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> maximum-routes <span class="hljs-number"><span class="hljs-number">100</span></span> redistribute connected ! vlan <span class="hljs-number"><span class="hljs-number">100</span></span> rd <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">65003</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> redistribute learned ! address-family evpn neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> activate ! address-family ipv4 neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> activate</code> </pre> <br>  evpn      (ibgp/ebgp multihop),      ebgp,    ,     ‚Äî        ‚Äî     .      ,       .             ‚Äî     (     ). <br><br>    bgp   vlan.       evpn  (EVI).    ‚Äî   rd (       ), rt ‚Äî        VTEP  .        ‚Äî      Leaf-2,  ‚Äî  Leaf-3.  redistribute learned   ,        data plane,     bgp.       L3 .       arista,  Juniper    . <br><br>     .      ,   ,   Leaf-3  vni 100  vlan 300. <br><br>      : <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show interfaces vxlan <span class="hljs-number"><span class="hljs-number">1</span></span> Vxlan1 is up, line protocol is up (connected) Hardware is Vxlan Source interface is Loopback0 and is active <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Replication/Flood Mode is headend <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Flood List Source: EVPN Remote MAC learning via EVPN Static VLAN to VNI mapping is [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>] Note: All Dynamic VLANs used by VCS are internal VLANs. Use <span class="hljs-string"><span class="hljs-string">'show vxlan vni'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Static VRF to VNI mapping is not configured Headend replication flood vtep list is: <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>   ,  ‚Äî  loopback0   62.0.0.1,       ,    EVPN. Vlan 100    VNI 100.           VTEP-,    EVPN.          VTEP: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan vtep Remote VTEPS <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Vxlan1: <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> remote VTEPS: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>   ,  Leaf-2/3     VxLAN ?    EVPN   3: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show bgp evpn route-type ? auto-discovery Filter by Ethernet Auto-Discovery (AD) route (Type <span class="hljs-number"><span class="hljs-number">1</span></span>) ethernet-segment Filter by Ethernet Segment Route (Type <span class="hljs-number"><span class="hljs-number">4</span></span>) imet Filter by Inclusive Multicast Ethernet Tag Route (Type <span class="hljs-number"><span class="hljs-number">3</span></span>) &lt;&lt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mac-ip</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Filter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">by</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">MAC</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">IP</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">advertisement</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">route</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span></span></span></code> </pre> <br>    ‚Äî    ,   ‚Äî  Inclusive Multicast Ethernet Tag    VTEP-: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show bgp evpn route-type imet BGP routing table information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Router identifier <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>, local AS number <span class="hljs-number"><span class="hljs-number">65001</span></span> Route status codes: s - suppressed, * - valid, &gt; - active, # - not installed, E - ECMP head, e - ECMP S - Stale, c - Contributing to ECMP, b - backup % - Pending BGP convergence Origin codes: i - IGP, e - EGP, ? - incomplete AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop Network Next Hop Metric LocPref Weight Path * &gt; RD: <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> imet <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> - - - <span class="hljs-number"><span class="hljs-number">0</span></span> i * &gt; RD: <span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> imet <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> - <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span> i * &gt; RD: <span class="hljs-number"><span class="hljs-number">65003</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> imet <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> - <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65003</span></span> i</code> </pre> <br>       : <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show bgp evpn route-type imet vni <span class="hljs-number"><span class="hljs-number">100</span></span> next-hop <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> detail BGP routing table information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Router identifier <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>, local AS number <span class="hljs-number"><span class="hljs-number">65001</span></span> BGP routing table entry <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> imet <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, Route Distinguisher: <span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> Paths: <span class="hljs-number"><span class="hljs-number">1</span></span> available <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (<span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>) Origin IGP, metric -, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, weight <span class="hljs-number"><span class="hljs-number">0</span></span>, valid, external, best Extended Community: Route-Target-AS:<span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> TunnelEncap:tunnelTypeVxlan VNI: <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>   AS-PATH ( ebgp  overlay  ,           ),  next-hop ( ,    ebgp  Spine     next-hop-,    B    ),      VxLAN (   : TunnelEncap:tunnelTypeVxlan)    VNI 100. <br><br>         (         VNI  ).            : <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show mac address-table unicast vlan <span class="hljs-number"><span class="hljs-number">100</span></span> Mac Address Table ------------------------------------------------------------------ Vlan Mac Address Type Ports Moves Last Move ---- ----------- ---- ----- ----- --------- Total Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>      : <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">72.731</span></span>/<span class="hljs-number"><span class="hljs-number">94.632</span></span>/<span class="hljs-number"><span class="hljs-number">115.048</span></span>/<span class="hljs-number"><span class="hljs-number">13.476</span></span> ms</code> </pre> <br><pre> <code class="javascript hljs">bormoglotx@ToR&gt; ping logical-system Server<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rapid PING <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>): <span class="hljs-number"><span class="hljs-number">56</span></span> data bytes !!!!! --- <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ping statistics --- <span class="hljs-number"><span class="hljs-number">5</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">5</span></span> packets received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss round-trip min/avg/max/stddev = <span class="hljs-number"><span class="hljs-number">67.071</span></span>/<span class="hljs-number"><span class="hljs-number">99.286</span></span>/<span class="hljs-number"><span class="hljs-number">177.772</span></span>/<span class="hljs-number"><span class="hljs-number">40.933</span></span> ms</code> </pre> <br> ,  .  ,      : <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show mac address-table Mac Address Table ------------------------------------------------------------------ Vlan Mac Address Type Ports Moves Last Move ---- ----------- ---- ----- ----- --------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9101</span></span> DYNAMIC Et5 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9102</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9103</span></span> DYNAMIC Vx1 <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> ago Total Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>   ,      VxLAN . ,       : <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show vxlan address-table Vxlan Mac Address Table ---------------------------------------------------------------------- VLAN Mac Address Type Prt VTEP Moves Last Move ---- ----------- ---- --- ---- ----- --------- <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9102</span></span> EVPN Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> ago <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9103</span></span> EVPN Vx1 <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> ago Total Remote Mac Addresses <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> criterion: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>    .      EVPN,        . ,      bgp: <br><pre> <code class="javascript hljs">Leaf<span class="hljs-number"><span class="hljs-number">-1</span></span>#show bgp evpn route-type mac-ip BGP routing table information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Router identifier <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>, local AS number <span class="hljs-number"><span class="hljs-number">65001</span></span> Route status codes: s - suppressed, * - valid, &gt; - active, # - not installed, E - ECMP head, e - ECMP S - Stale, c - Contributing to ECMP, b - backup % - Pending BGP convergence Origin codes: i - IGP, e - EGP, ? - incomplete AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop Network Next Hop Metric LocPref Weight Path * &gt; RD: <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> mac-ip <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9101</span></span> - - - <span class="hljs-number"><span class="hljs-number">0</span></span> i * &gt; RD: <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> mac-ip <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9101</span></span> <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> - - - <span class="hljs-number"><span class="hljs-number">0</span></span> i * &gt; RD: <span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> mac-ip <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9102</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> - <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span> i * &gt; RD: <span class="hljs-number"><span class="hljs-number">65003</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> mac-ip <span class="hljs-number"><span class="hljs-number">0005.8671</span></span><span class="hljs-number"><span class="hljs-number">.9103</span></span> <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> - <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">65003</span></span> i</code> </pre> <br>    ‚Äî       AS Path,     . <br><br>      : <br> <a href=""><img src="https://habrastorage.org/webt/in/mz/8p/inmz8pochjrx4oa-elhohmxhotm.png"></a> <br>      , VTEP-   IM ,      ,         BGP  (   - VNI  ).          : <br> <a href=""><img src="https://habrastorage.org/webt/8e/am/li/8eamlic--hj1zszbhvevexufppe.png"></a> <br>    ,   c VNI 100 (,       6),   ,      62.0.0.1      VxLAN. <br><br>        .   -    ,   ,       VxLAN,      (,    ,     ): <br> <a href=""><img src="https://habrastorage.org/webt/rb/vp/yk/rbvpykmu0g8z16hrmzklkq0nwlk.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/pc/my/vn/pcmyvnxitzzpcrb83cgxklps9ui.png"></a> <br>      ARP : <br> <a href=""><img src="https://habrastorage.org/webt/mm/ul/os/mmulosqw8xyhrid3awrgpcl6lms.png"></a> <br>       BGP Upgrade .    ,    - mac   data plane,    BGP     mac : <br> <a href=""><img src="https://habrastorage.org/webt/p1/r6/mv/p1r6mvvvp2lilyaofey2yhjgzri.png"></a> <br>          ‚Äî          .            data-plane    ,       Server-1 c Server-2  Server-3,   Leaf-2  Leaf-3        ‚Äî  ,    Leaf-1.     2  3   ,        .  ,   2     3,    ,   Leaf-2     -3.  EVPN Leaf-2  Leaf-3     ,      BGP. <br><br>       Cisco  Juniper: <br><br>  Cisco Nexus         VNI: <br><pre> <code class="javascript hljs">vlan <span class="hljs-number"><span class="hljs-number">100</span></span> name VNI<span class="hljs-number"><span class="hljs-number">-100</span></span> vn-segment <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>   nve , ,     BGP (host-reachability protocol bgp): <br><pre> <code class="javascript hljs">interface nve1 no shutdown source-interface loopback0 host-reachability protocol bgp member vni <span class="hljs-number"><span class="hljs-number">100</span></span> ingress-replication protocol bgp</code> </pre> <br>  ingress-replication protocol bgp   ,   .             VTEP-,   BGP. <br>   evpn  (EVI): <br><pre> <code class="javascript hljs">evpn vni <span class="hljs-number"><span class="hljs-number">100</span></span> l2 rd <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">65002</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-number"><span class="hljs-number">65003</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> route-target <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-number"><span class="hljs-number">65001</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br>            . <br><br>  Juniper QFX     ( bgp  ): <br><br>  : <br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">master</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>} bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span>&gt; show configuration vlans BRIDGE<span class="hljs-number"><span class="hljs-number">-4093</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">4093</span></span>; vxlan { vni <span class="hljs-number"><span class="hljs-number">15000001</span></span>; ingress-node-replication; } } BRIDGE<span class="hljs-number"><span class="hljs-number">-4094</span></span> { vlan-id <span class="hljs-number"><span class="hljs-number">4094</span></span>; vxlan { vni <span class="hljs-number"><span class="hljs-number">16000001</span></span>; ingress-node-replication; } }</code> </pre> <br>  switch-options: <br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">master</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>} bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span>&gt; show configuration <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>-options vtep-source-interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">62.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; vrf-<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VNI-IMPORT; vrf-target <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">42000</span></span>:<span class="hljs-number"><span class="hljs-number">9999</span></span>;</code> </pre> <br>      RD  RT,        VTEP,    RT,       1,  per-ESI. <br><br>  ,   : <br><pre> <code class="javascript hljs">bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span>&gt; show configuration policy-options policy-statement VNI-IMPORT term DC-DEFAULT { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol bgp; community DC-DEFAULT-SW; } then accept; } term VNI<span class="hljs-number"><span class="hljs-number">-16000001</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol bgp; community VNI16000001; } then accept; } term VNI<span class="hljs-number"><span class="hljs-number">-15000001</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> { protocol bgp; community VNI15000001; } then accept; } then reject;</code> </pre> <br>      evpn: <br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">master</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>} bormoglotx@LEAF<span class="hljs-number"><span class="hljs-number">-101</span></span>&gt; show configuration protocols evpn encapsulation vxlan; extended-vni-list [ <span class="hljs-number"><span class="hljs-number">15000001</span></span> <span class="hljs-number"><span class="hljs-number">16000001</span></span> ]; multicast-mode ingress-replication; vni-options { vni <span class="hljs-number"><span class="hljs-number">15000001</span></span> { vrf-target <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">1500</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; } vni <span class="hljs-number"><span class="hljs-number">16000001</span></span> { vrf-target <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">1600</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; } }</code> </pre> <br>     ,  rt    VNI   VNI    . <br><br>          . <br><br>      , ,   .      EVPN/VxLAN multihomig     Arista MLAG  Nexus vPC,      EVPN   Juniper QFX. <br><br>   - // ‚Äì    .  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/344326/">https://habr.com/ru/post/344326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344310/index.html">Fake design</a></li>
<li><a href="../344312/index.html">Language Lua and Corona SDK (2/3 part)</a></li>
<li><a href="../344314/index.html">Dagger 2 for novice Android developers. Dagger 2. Part 1</a></li>
<li><a href="../344320/index.html">Sparse matrices: how scientists accelerated machine learning on the GPU</a></li>
<li><a href="../344324/index.html">Continuous integration and deployment of Docker in GitLab CI</a></li>
<li><a href="../344328/index.html">Accelerate the site. How to understand if this is relevant for your site</a></li>
<li><a href="../344330/index.html">The digest of interesting materials for the mobile developer # 233 (December 4 - December 10)</a></li>
<li><a href="../344332/index.html">How to read technical literature: Quora, Reddit and Hacker News Resident Tips</a></li>
<li><a href="../344338/index.html">The prototype of the payment cryptosystem. Adventure project</a></li>
<li><a href="../344340/index.html">Selenium: Pumping Up Muscles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>