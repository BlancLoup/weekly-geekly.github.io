<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Speedy sync of billion files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several identical servers (4 nodes) on Amazon EC2 with Ubuntu. Everyone generates and stores on their disk a cache that they would like to s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Speedy sync of billion files</h1><div class="post__text post__text-html js-mediator-article">  There are several identical servers (4 nodes) on Amazon EC2 with Ubuntu.  Everyone generates and stores on their disk a cache that they would like to synchronize.  But a simple rsync will not work here - there are several billion files, nfs is too slow, and so on. The full list of options discussed with explanations below. <br><br>  In addition, from time to time, you need to delete obsolete files on all servers at once, which so far is done manually and takes several days.  The question is the quickest for such Use Case file system I plan to describe later.  I will only make a reservation that for several reasons XFS was chosen. <br><br>  After the test, several cluster technologies and file systems, on the advice of a senior friend, decided to use the same rsync, but in conjunction with inotify.  A little searching on the Internet for such a solution, so as not to reinvent the wheel, came across csyncd, inosync and lsyncd.  On Habr√© there was already an <a href="http://habrahabr.ru/blogs/linux/51419/">article about csyncd</a> , but it‚Äôs not suitable here, because  It stores a list of files in the SQLite database, which can hardly work tolerably even with a million records.  Yes, and an extra link with such volumes to anything.  But lsyncd turned out to be exactly what we needed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>UPD:</b> As practice has shown, a tangible change and addition in the text is necessary.  I decided to make only minor changes to the main part, and share new conclusions at the end of the article. <br><a name="habracut"></a><br><br><h2>  Rsync + inotify = lsyncd </h2><br>  <a href="http://code.google.com/p/lsyncd">Lsyncd</a> is a daemon that monitors changes in the local directory, aggregates them, and after a certain time rsync starts to synchronize them. <br><br><img src="https://habrastorage.org/storage1/aaf74f90/a1d66d48/bf19540f/22934d11.png"><br><br>  So, we cannot rsync all at once, but we can only update what has changed.  The latter will be <a href="http://ru.wikipedia.org/wiki/Inotify">told to</a> us by <a href="http://ru.wikipedia.org/wiki/Inotify">inotify</a> , a kernel subsystem notifying applications about changes in the file system.  Lsyncd monitors the changes to the local file tree, collects this information in 10 seconds (you can specify any other time) or until 1000 events are collected (depending on which event occurs first), and starts rsync to send these files to other nodes in our cluster.  Rsync starts with the update parameter, that is, the file on the receiver will be replaced with the one sent only if the latter is newer.  This makes it possible to avoid collisions and unnecessary operations (for example, if the same file was generated in parallel on both the sender and the receiver). <br><br><img src="https://habrastorage.org/storage1/712a1a6f/356ebb43/56d7e98c/0aa398a6.png"><br><br><h2>  Implementation </h2><br>  The installation process is described for Ubuntu 11.10.  In other versions there may be differences. <br><br>  <b>1. Configure ssh</b> so that you can log in from any node to another without authorization.  Most likely, everyone knows how to do it, but I will describe it just in case. <br><br><pre><code class="bash hljs">ssh-keygen</code> </pre> <br>  Passphrase leave blank. <br><br>  Next we add the contents of ~ / .ssh / id_rsa.pub to all the other nodes in the cluster in ~ / .ssh / authorized_keys.  Naturally, we select the $ HOME of the user who has rights to write to the synchronization folder.  It is easiest if it is / root, but it is not the best choice in terms of security. <br>  It is also advisable to register all nodes in / etc / hosts.  I called them node01, node02, node03. <br>  Repeat on all nodes. <br><br>  <b>2. Install lsyncd</b> <br><br><pre> <code class="bash hljs">apt-get install lsyncd</code> </pre> <br><br>  <b>3. Config</b> though you need to create manually, but it is quite simple.  Written in <a href="http://ru.wikipedia.org/wiki/Lua">Lua</a> .  An interesting <a href="http://code.google.com/p/lsyncd/wiki/Lsyncd20Manual">comment on the reasons for choosing Lua</a> from the author lsyncd.  I have also created a separate directory for logs. <br><br><pre> <code class="bash hljs">mkdir -p /etc/lsyncd mkdir -p /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/lsyncd vi /etc/lsyncd/lsyncd.conf.lua</code> </pre> <br><br>  The contents of the config with comments: <br><br><pre> <code class="lua hljs">settings = {&lt;br/&gt; logfile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.log"</span></span>, &lt;br/&gt; statusFile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.status"</span></span>, &lt;br/&gt; nodaemon = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">--&lt;==    .  .&lt;br/&gt; } &lt;br/&gt; --[[&lt;br/&gt; sync { &lt;br/&gt; default.rsync, --&lt;==  rsync  . -,    - .&lt;br/&gt; source="/raid", --&lt;==  ,  &lt;br/&gt; target="node01:/raid", --&lt;== dns-    -  &lt;br/&gt; rsyncOps={"-ausS", "--temp-dir=/mnt-is"}, --&lt;== temp-dir    .&lt;br/&gt; delay=10 --&lt;== ,       &lt;br/&gt; } &lt;br/&gt; ]]&lt;br/&gt; sync { &lt;br/&gt; default.rsync, &lt;br/&gt; source="/raid", &lt;br/&gt; target="node02:/raid", &lt;br/&gt; rsyncOps={"-ausS", "--temp-dir=/mnt-is"}, &lt;br/&gt; delay=10 &lt;br/&gt; } &lt;br/&gt; &lt;br/&gt; sync { &lt;br/&gt; default.rsync, &lt;br/&gt; source="/raid", &lt;br/&gt; target="node03:/raid", &lt;br/&gt; rsyncOps={"-ausS", "--temp-dir=/mnt-is"}, &lt;br/&gt; delay=10&lt;br/&gt; }</span></span></code> </pre> <br><br>  It is easier to make a config once and then post it to all nodes, commenting out the extra block for each server.  Comments - everything between "- [[" and "]]". <br><br>  Used rsync call options: <br>  <b>a</b> - archiving mode;  is equivalent to -rlptgoD, that is, to copy recursively, along with symlinks and special files, while retaining the permissions, group, owner. <br>  <s><b>l</b> - copy symlinks;</s> <br>  <b>u</b> - do not update files on the recipient if they are newer; <br>  <s><b>t, p, o, g</b> - copy time, permissions, owner, group, respectively.</s> <br>  <b>s</b> - <b>just</b> in case the space appears in the file name. <br>  <b>S</b> - optimize data transfer consisting of zeros. <br>  Read more in man lsyncd or in the <a href="http://code.google.com/p/lsyncd/wiki/Lsyncd20Manual">documentation</a> . <br><br>  <b>4. We start the demon</b> on all nodes: <br><br><pre> <code class="bash hljs">/etc/init.d/lsyncd start</code> </pre> <br><br>  If you left "nodaemon = true" in the config, you can see what is happening. <br><br>  Next, copy / create / delete something in the directory that we specified for synchronization (I have this / raid), wait a few seconds and check the result of synchronization. <br><br>  The data transfer rate reaches 300 Mbps and this has little effect on the server load (compared to the same GlusterFS, for example), and the delay in this case smoothes the peaks.  Much more depends on the FS used.  Here I also had to do a little research, with numbers and graphs, since the situation is quite specific and the results of existing published tests do not reflect what is required in the task. <br><br><h4>  What else was considered and why it is not suitable in this case </h4><br>  The entire study was aimed at working with Amazon EC2, given its limitations and features, therefore, the findings mainly relate to her. <br><ul><li>  <a href="http://ru.wikipedia.org/wiki/DRBD">DRBD</a> - replication is at the block level.  In case of degradation of one carrier both are killed.  Limit of 2 nodes.  (More is possible, but the 3rd and 4th can only be connected as slaves.) </li><li>  <a href="http://ru.wikipedia.org/wiki/OCFS">Ocfs2</a> is used either on top of DRBD (which is a good <a href="http://habrahabr.ru/tag/ocfs2/">article</a> in Habr√©), or you need to be able to mount one partition from several nodes.  Impossible on ec2. </li><li>  <a href="http://en.wikipedia.org/wiki/Global_File_System">Gfs2</a> is similar to ocfs2.  I did not try, because according to the tests, this FS is slower than ocfs2, otherwise it is its analogue. </li><li>  <a href="http://ru.wikipedia.org/wiki/GlusterFS">GlusterFS</a> - it all worked almost immediately and as it should!  Simple and logical in administration.  You can make a cluster of up to 255 nodes with an arbitrary value of replicas.  Created a cluster partition from a pair of servers and mounted it on them but in a different directory (that is, the servers were also clients at the same time).  Unfortunately on the client this cluster is mounted via FUSE, and the write speed was lower than 3 MB / s.  And so, the impressions of use are very good. </li><li>  <a href="http://ru.wikipedia.org/wiki/Lustre">Luster</a> - to start this thing in krenel mode you need to patch the kernel.  Strangely enough, there is a package with these patches in the Ubuntu repository, but I couldn‚Äôt find any patches for it, or at least for Debian.  And judging by the reviews, I realized that getting it in the deb-system is shamanism. </li><li>  <a href="http://ru.wikipedia.org/wiki/Hadoop">Hadoop</a> w / HDFS, <a href="http://en.wikipedia.org/wiki/Cloudera">Cloudera</a> - did not try, because another solution was found (see below).  But the first thing that catches the eye is written in Java, therefore there will be a lot of resources to eat, and the scale is not like that of Fesbuch or Yaha, there are only 4 nodes yet. </li></ul><br><br>  <b>UPD:</b> This solution performed well on tests (after which the article was written), but in combat conditions everything turned out to be completely different.  Minimum production configuration - 584 thousand nested directories.  And lsyncd puts inotify on <i>each</i> directory.  Make it all at once for the whole tree is impossible.  In memory, 584 thousand notifications, eat up relatively little, about 200 MB (out of 16 GB available), but this process takes 22 minutes.  In principle, not scary: once launched and forgotten.  But after that, with the standard configuration, lsyncd starts synchronization of all files, which in our conditions either buggy or took days.  In general - not an option.  100% consistency is not required and you can do without initial synchronization.  It remained to "turn off".  Fortunately, the demon is written so that you can change almost all of its functions directly from the config.  Also, to increase the performance, default.rsync was replaced by default.rsyncssh, and the kernel was changed to the limits of inotify.  That is, the config above is suitable for most tasks, but in our particular situation the following works: <br><br><pre> <code class="lua hljs">settings = { logfile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.log"</span></span>, statusFile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.status"</span></span>, statusInterval = <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-comment"><span class="hljs-comment">--&lt;==         } sync { default.rsyncssh, source = "/raid", host = "node02", targetdir = "/raid", rsyncOps = {"-ausS", "--temp-dir=/tmp"}, --&lt;==   delay = 3, --&lt;==  -,     init = function(event) --&lt;==   .             log("Normal","Skipping startup synchronization...") --&lt;==  ,         end } sync { default.rsyncssh, source = "/raid", host = "node03", targetdir = "/raid", rsyncOps = {"-ausS", "--temp-dir=/tmp"}, delay = 3, init = function(event) log("Normal","Skipping startup synchronization...") end }</span></span></code> </pre><br><br>  <b>Kernel settings</b> <br><br>  Inotify has three parameters (see ls / proc / sys / fs / inotify /): <br>  max_queued_events - the maximum number of events in the queue;  default = 16384; <br>  max_user_instances - how many inotify instances one user can start;  default = 128; <br>  max_user_watches - how many files a user can track;  default = 8192. <br><br>  Operating values: <br><pre> <code class="hljs ruby">echo <span class="hljs-string"><span class="hljs-string">" fs.inotify.max_user_watches = 16777216 # fs.inotify.max_queued_events = 65536 "</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>/etc/sysctl.conf echo <span class="hljs-number"><span class="hljs-number">16777216</span></span> &gt; <span class="hljs-regexp"><span class="hljs-regexp">/proc/sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/fs/inotify</span></span><span class="hljs-regexp"><span class="hljs-regexp">/max_user_watches echo 65536 &gt; /proc</span></span><span class="hljs-regexp"><span class="hljs-regexp">/sys/fs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/inotify/max</span></span>_queued_events</code> </pre><br><br>  So it all worked already in the production. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/132098/">https://habr.com/ru/post/132098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132088/index.html">Matryoshka principle</a></li>
<li><a href="../132092/index.html">Search for talent on Youtube using acoustic analysis</a></li>
<li><a href="../132093/index.html">New way to communicate with Gmail and friends (pages become available on Google+)</a></li>
<li><a href="../132094/index.html">Passion vs professionalism</a></li>
<li><a href="../132095/index.html">How I installed Openmeetings</a></li>
<li><a href="../132099/index.html">Initial setup of an APC UPS in Linux from a teapot point of view</a></li>
<li><a href="../132102/index.html">PHP Automated Testing</a></li>
<li><a href="../132103/index.html">Sony Ericsson Xperia active overview</a></li>
<li><a href="../132106/index.html">Automate the creation of VPN users in PFSense</a></li>
<li><a href="../132107/index.html">Online redo logs or Checkpoint Event in Oracle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>