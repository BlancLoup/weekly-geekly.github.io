<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Little Brave Arkanoid (Part 2 - YAML)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the story about our small (but very brave) arcanoid , I can not fail to mention such a wonderful language as YAML . Any, even the simplest,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Little Brave Arkanoid (Part 2 - YAML)</h1><div class="post__text post__text-html js-mediator-article">  Continuing the story about our small (but very brave) <a href="http://habrahabr.ru/post/165667/">arcanoid</a> , I can not fail to mention such a wonderful language as <a href="http://ru.wikipedia.org/wiki/YAML">YAML</a> .  Any, even the simplest, game should store a lot of data, such as: description of levels, current status of settings, list of achievements, etc.  It is desirable that all this is stored in a human-readable and easily editable form.  Traditionally, <a href="http://ru.wikipedia.org/wiki/XML">XML is</a> used for these purposes, but it is quite verbose and can hardly be considered convenient for manual editing. <br><br>  YAML is significantly more concise, and today, we will learn how to use it. <br><a name="habracut"></a><br>  For a start, let's decide why we need YAML.  I believe that, among other things, it will be convenient to store a description of the levels in it, for example, in this form: <br><br><div class="spoiler">  <b class="spoiler_title">level.json</b> <div class="spoiler_text"><pre><code class="hljs scala">{ board: { width: <span class="hljs-number"><span class="hljs-number">320</span></span> }, types: { odd: { inner_color: <span class="hljs-number"><span class="hljs-number">0xffffff00</span></span>, outer_color: <span class="hljs-number"><span class="hljs-number">0xff50ff00</span></span>, width: <span class="hljs-number"><span class="hljs-number">40</span></span>, height: <span class="hljs-number"><span class="hljs-number">20</span></span> }, even: { inner_color: <span class="hljs-number"><span class="hljs-number">0xff1010ff</span></span>, outer_color: <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>, width: <span class="hljs-number"><span class="hljs-number">40</span></span>, height: <span class="hljs-number"><span class="hljs-number">20</span></span> } }, level: [ { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">50</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">94</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">138</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">182</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">226</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">270</span></span>, y: <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">50</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">94</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">138</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">182</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">226</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">270</span></span>, y: <span class="hljs-number"><span class="hljs-number">54</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">50</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">94</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">138</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">182</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">226</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">270</span></span>, y: <span class="hljs-number"><span class="hljs-number">78</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">50</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">94</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">138</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">182</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even, x: <span class="hljs-number"><span class="hljs-number">226</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> }, { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd, x: <span class="hljs-number"><span class="hljs-number">270</span></span>, y: <span class="hljs-number"><span class="hljs-number">102</span></span> } ] }</code> </pre> <br></div></div><br>  Just do not cry angrily "we were deceived!".  Yes, this is <a href="http://ru.wikipedia.org/wiki/JSON">JSON</a> .  The good news is that this is also YAML.  Simply JSON is a subset of YAML and any JSON description should be parsed without any problems by the YAML parser.  JSON is slightly more syntactically strict and slightly less concise (but still much more concise than XML). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As <a href="http://habrahabr.ru/users/shokoladko/" class="user_link">shokoladko</a> quite rightly noted, in the comments below, the YAML variant will be significantly shorter and more convenient for editing (due to the absence of commas separating the list items).  Here is what it will look like: <br><br><div class="spoiler">  <b class="spoiler_title">level.yaml</b> <div class="spoiler_text"><pre> <code class="hljs scala">board: width: <span class="hljs-number"><span class="hljs-number">320</span></span> types: odd: inner_color: <span class="hljs-number"><span class="hljs-number">0xffffff00</span></span> outer_color: <span class="hljs-number"><span class="hljs-number">0xff50ff00</span></span> width: <span class="hljs-number"><span class="hljs-number">40</span></span> height: <span class="hljs-number"><span class="hljs-number">20</span></span> even: inner_color: <span class="hljs-number"><span class="hljs-number">0xff1010ff</span></span> outer_color: <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> width: <span class="hljs-number"><span class="hljs-number">40</span></span> height: <span class="hljs-number"><span class="hljs-number">20</span></span> level: - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">50</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">94</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">138</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">182</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">226</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">270</span></span> y: <span class="hljs-number"><span class="hljs-number">30</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">50</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">94</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">138</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">182</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">226</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">270</span></span> y: <span class="hljs-number"><span class="hljs-number">54</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">50</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">94</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">138</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">182</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">226</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">270</span></span> y: <span class="hljs-number"><span class="hljs-number">78</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">50</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">94</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">138</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">182</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: even x: <span class="hljs-number"><span class="hljs-number">226</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span> - <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: odd x: <span class="hljs-number"><span class="hljs-number">270</span></span> y: <span class="hljs-number"><span class="hljs-number">102</span></span></code> </pre><br></div></div><br>  In addition, YAML supports relational data.  Using the '&amp;' symbol in the description, an ‚Äúanchor‚Äù can be defined, which can later be used to perform substitutions made by ‚Äúaliases‚Äù (the '*' character).  In this way, recursive structures can be expressed. <br><br>  But enough theory get to the point.  We will find <a href="http://pyyaml.org/wiki/LibYAML">any</a> YAML library on the Internet and try to embed it in our project.  By the way, the library we chose was developed by Kirill Simonov and is freely distributed under the <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D1%2586%25D0%25B5%25D0%25BD%25D0%25B7%25D0%25B8%25D1%258F_MIT">MIT license</a> (which can be found in the section on the <a href="http://pyyaml.org/wiki/LibYAML">Copyright</a> page describing the library). <br><br>  We could just include all the necessary files in the <a href="http://www.madewithmarmalade.com/">Marmalade</a> project's mkb file, but this will not be very convenient.  I propose to arrange the library in the form of a subproject of Marmalade, the benefit of examples of such design in the supply of Maramalade abound.  Create the folder ‚Äúyaml‚Äù and place in it the mkf-file of the following content: <br><br><div class="spoiler">  <b class="spoiler_title">yaml.mkf</b> <div class="spoiler_text"><pre> <code class="cpp hljs">includepath h includepath source files { (h) yaml.h config.h (source) yaml_private.h api.c dumper.c emitter.c loader.c parser.c reader.c scanner.c writer.c }</code> </pre><br></div></div><br>  We create subdirectories and place the source texts of the library in them in accordance with the description of their placement in the mkf file.  That's all.  We have created a full-fledged Marmalade module, which we can easily use in any of our projects. <br><br>  Let's do it: <br><br><div class="spoiler">  <b class="spoiler_title">arcanoid.mkb</b> <div class="spoiler_text"><pre> <code class="cpp hljs">#!/usr/bin/env mkb options { module_path=<span class="hljs-string"><span class="hljs-string">"../yaml"</span></span> } subprojects { iwgl yaml } includepath { ./source/Main ./source/Model } files { [Main] (source/Main) Main.cpp Main.h Quads.cpp Quads.h Desktop.cpp Desktop.h IO.cpp IO.h [Model] (source/Model) Board.cpp Board.h Bricks.cpp Bricks.h Ball.cpp Ball.h [Data] (data) } assets { (data) level.json (data-ram/data-gles1, data/data-gles1) }</code> </pre><br></div></div><br>  Now, the YAML module is connected to the project and it remains for us to learn how to process the data received from it.  It is enough to make a number of changes in the Board: <br><br><div class="spoiler">  <b class="spoiler_title">Board.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _BOARD_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _BOARD_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;yaml.h&gt; #include &lt;vector&gt; #include &lt;String&gt; #include "Bricks.h" #include "Ball.h" #define MAX_NAME_SZ 100 using namespace std; enum EBrickMask { ebmX = 0x01, ebmY = 0x02, ebmComplete = 0x03, ebmWidth = 0x04, ebmHeight = 0x08, ebmIColor = 0x10, ebmOColor = 0x20 }; class Board { private: struct Type { Type(const char* s, const char* n, const char* v): s(s), n(n), v(v) {} Type(const Type&amp; p): s(ps), n(pn), v(pv) {} string s, n, v; }; Bricks bricks; Ball ball; yaml_parser_t parser; yaml_event_t event; vector&lt;string&gt; scopes; vector&lt;Type&gt; types; char currName[MAX_NAME_SZ]; int brickMask; int brickX, brickY, brickW, brickH, brickIC, brickOC; bool isTypeScope; void load(); void clear(); void notify(); const char* getScopeName(); void setProperty(const char* scope, const char* name, const char* value); void closeTag(const char* scope); int fromNum(const char* s); public: Board(): scopes(), types() {} void init(); void refresh(); void update() {} typedef vector&lt;string&gt;::iterator SIter; typedef vector&lt;Type&gt;::iterator TIter; }; #endif // _BOARD_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Board.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Board.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Desktop.h"</span></span></span><span class="hljs-meta"> const char* BOARD_SCOPE = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"board"</span></span></span><span class="hljs-meta">; const char* LEVEL_SCOPE = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"level"</span></span></span><span class="hljs-meta">; const char* TYPE_SCOPE = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"types"</span></span></span><span class="hljs-meta">; const char* TYPE_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"type"</span></span></span><span class="hljs-meta">; const char* WIDTH_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"width"</span></span></span><span class="hljs-meta">; const char* HEIGHT_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"height"</span></span></span><span class="hljs-meta">; const char* IC_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"inner_color"</span></span></span><span class="hljs-meta">; const char* OC_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"outer_color"</span></span></span><span class="hljs-meta">; const char* X_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"x"</span></span></span><span class="hljs-meta">; const char* Y_PROPERTY = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"y"</span></span></span><span class="hljs-meta">; void Board::init() { load(); ball.init(); } void Board::clear() { bricks.clear(); scopes.clear(); memset(currName, 0, sizeof(currName)); types.clear(); } void Board::load() { clear(); yaml_parser_initialize(&amp;parser); FILE *input = fopen(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"level.json"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rb"</span></span></span><span class="hljs-meta">); yaml_parser_set_input_file(&amp;parser, input); int done = 0; while (!done) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!yaml_parser_parse(&amp;parser, &amp;event)) { break; } notify(); done = (event.type == YAML_STREAM_END_EVENT); yaml_event_delete(&amp;event); } yaml_parser_delete(&amp;parser); fclose(input); } void Board::notify() { switch (event.type) { case YAML_MAPPING_START_EVENT: case YAML_SEQUENCE_START_EVENT: scopes.push_back(currName); memset(currName, 0, sizeof(currName)); break; case YAML_MAPPING_END_EVENT: closeTag(getScopeName()); case YAML_SEQUENCE_END_EVENT: scopes.pop_back(); break; case YAML_SCALAR_EVENT: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (currName[0] == 0) { strncpy(currName, (const char*)event.data.scalar.value, sizeof(currName)-1); break; } setProperty(getScopeName(), currName, (const char*)event.data.scalar.value); memset(currName, 0, sizeof(currName)); break; default: break; } } const char* Board::getScopeName() { const char* r = NULL; isTypeScope = false; for (SIter p = scopes.begin(); p !=scopes.end(); ++p) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!(*p).empty()) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (strcmp((*p).c_str(), TYPE_SCOPE) == 0) { isTypeScope = true; continue; } r = (*p).c_str(); } } return r; } int Board::fromNum(const char* s) { int r = 0; int x = 10; for (size_t i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; strlen(s); i++) { switch (s[i]) { case 'x': case 'X': x = 16; break; case 'a': case 'b': case 'c': case 'd': case 'e': case 'f': x = 16; r *= x; r += s[i] - 'a' + 10; break; case 'A': case 'B': case 'C': case 'D': case 'E': case 'F': x = 16; r *= x; r += s[i] - 'A' + 10; break; default: r *= x; r += s[i] - '0'; break; } } return r; } void Board::setProperty(const char* scope, const char* name, const char* value) { if (scope == NULL) return; if (isTypeScope) { types.push_back(Type(scope, name, value)); return; } if (strcmp(scope, BOARD_SCOPE) == 0) { if (strcmp(name, WIDTH_PROPERTY) == 0) { desktop.setVSize(fromNum(value)); } } if (strcmp(scope, LEVEL_SCOPE) == 0) { if (strcmp(name, TYPE_PROPERTY) == 0) { for (TIter p = types.begin(); p != types.end(); ++p) { if (strcmp(value, p-&gt;s.c_str()) == 0) { setProperty(scope, p-&gt;n.c_str(), p-&gt;v.c_str()); } } } if (strcmp(name, X_PROPERTY) == 0) { brickMask |= ebmX; brickX = fromNum(value); } if (strcmp(name, Y_PROPERTY) == 0) { brickMask |= ebmY; brickY = fromNum(value); } if (strcmp(name, WIDTH_PROPERTY) == 0) { brickMask |= ebmWidth; brickW = fromNum(value); } if (strcmp(name, HEIGHT_PROPERTY) == 0) { brickMask |= ebmHeight; brickH = fromNum(value); } if (strcmp(name, IC_PROPERTY) == 0) { brickMask |= ebmIColor; brickIC = fromNum(value); } if (strcmp(name, OC_PROPERTY) == 0) { brickMask |= ebmOColor; brickOC = fromNum(value); } } } void Board::closeTag(const char* scope) { if (scope == NULL) return; if (strcmp(scope, LEVEL_SCOPE) == 0) { if ((brickMask &amp; ebmComplete) == ebmComplete) { Bricks::SBrick b(desktop.toRSize(brickX), desktop.toRSize(brickY)); if ((brickMask &amp; ebmWidth) != 0) { b.hw = desktop.toRSize(brickW) / 2; } if ((brickMask &amp; ebmHeight) != 0) { b.hh = desktop.toRSize(brickH) / 2; } if ((brickMask &amp; ebmIColor) != 0) { b.ic = brickIC; } if ((brickMask &amp; ebmOColor) != 0) { b.oc = brickOC; } bricks.add(b); } brickMask = 0; } } void Board::refresh() { bricks.refresh(); ball.refresh(); }</span></span></span></span></code> </pre><br></div></div><br>  How does all this work?  The file with the description of the level is readable in the load method.  After that, we call the parse function yaml_parser_parse in a loop, analyzing the parsing events that occur.  This analysis is rather primitive.  Some revival is made only by processing the contents of the "types" section.  In it, we describe the ‚Äútemplates‚Äù of settings that we can later add to the ‚Äúbricks‚Äù description by adding the name of the corresponding type as the value of the ‚Äútype‚Äù attribute. <br><br>  In the "board" section we describe the width of the board.  All other dimensions in the level description are relative to it.  I draw your attention to the fact that we do not need to determine the height of the board in the description of the level.  Vertical dimensions are recalculated in the same ratio as horizontal dimensions.  Thus, we ensure that the level looks almost the same on devices with different ratios of the width and height of the screen (the difference is ‚Äúlost‚Äù in an empty area that exists at any level). <br><br>  Having started the program for execution, we will see that our data has successfully loaded: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/50f/03b/072/50f03b0725b981e0dd0dc63b816bc3cb.png" alt="image"><br><br>  It remains to be noted that the capabilities of LibYAML are not limited to parsing YAML files.  With the help of it, we can form YAML files ourselves, saving in them, for example, the current state of game settings.  An example of how this is done is available on <a href="http://pyyaml.org/wiki/LibYAML">the</a> library description <a href="http://pyyaml.org/wiki/LibYAML">page</a> .  DataDirIsRAM setting will help us to save files in the device file system: <br><br><pre> <code class="cpp hljs">[S3E] SysGlesVersion=<span class="hljs-number"><span class="hljs-number">1</span></span> DispFixRot=FixedPortrait DataDirIsRAM=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  That's all.  The module for working with YAML is posted on <a href="https://github.com/GlukKazan/mf/tree/master/modules/yaml">GitHub</a> . <br><br>  In the next <a href="http://habrahabr.ru/post/166929/">article</a> we will learn how to work with Box2D. <br></div><p>Source: <a href="https://habr.com/ru/post/166357/">https://habr.com/ru/post/166357/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166337/index.html">Microsoft hired a designer who created a futuristic brand</a></li>
<li><a href="../166339/index.html">CRUX 3.0 has been released</a></li>
<li><a href="../166341/index.html">How bad should the code be?</a></li>
<li><a href="../166351/index.html">Marked text in android.widget.TextView</a></li>
<li><a href="../166353/index.html">Haskell Polymorphia and Classes</a></li>
<li><a href="../166361/index.html">Project ‚ÄúProkaryotic Genome‚Äù - a scientific startup</a></li>
<li><a href="../166363/index.html">A few words about productivity</a></li>
<li><a href="../166367/index.html">Features of using roles with authentication in Oracle since 10.2.0.5</a></li>
<li><a href="../166369/index.html">Living computer museum</a></li>
<li><a href="../166373/index.html">Sending temperature data from the TL-MR3020 router and the Raspberry Pi to People's Monitoring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>