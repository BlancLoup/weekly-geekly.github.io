<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitor client PCs in Microsoft AD with Zabbix. Part 1 - Auto Install</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several hundred client machines based on the OS Windows 7 in the microsoft AD domain, I want to monitor them, and besides the usual cpu, mem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitor client PCs in Microsoft AD with Zabbix. Part 1 - Auto Install</h1><div class="post__text post__text-html js-mediator-article">  There are several hundred client machines based on the OS Windows 7 in the microsoft AD domain, I want to monitor them, and besides the usual cpu, mem, disk, etc., it would be nice to get information about the status of smart disks, information from usb ups, with all should be installed automatically and updated if necessary.  I will write about the templates, settings and alert script on the server later, while preparing the script for powershell to install agents.  Currently the current version of zabbix is ‚Äã‚Äã3.x. <br><a name="habracut"></a><br><h3>  External tools </h3><br>  Briefly I will describe what I use: <br><br><blockquote>  -smartmontools - SMART monitoring <br>  -Network UPS Tools (NUT) - monitoring ups <br>  -libusb driver - for NUT <br>  -awk, grep - for parsing </blockquote><br>  Unfortunately, NUT + libusb did not work as well as expected, I had to put crutches on, but I would still write about it, in case anyone needed it. <br><br><h3>  Installer configuration and logging </h3><br>  Over time, you will have to update the agent, or its configuration, or you want to add something new, so you need to have a label (mssql) of the configuration with the versions of the modules that we plan to update. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On local machines, versions will be stored in ‚Äúver‚Äù files in the appropriate directories. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[zabbix_cfg]( [zabbix_bin] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">--   zabbix [zabbix_cmd] [int] NULL, -- grep, awk,    . . [zabbix_conf] [int] NULL, -- config  zabbix_agentd [zabbix_extra] [int] NULL, --  ,   smartctl [nut_bin] [int] NULL, -- bin  NUT [nut_conf] [int] NULL -- conf  NUT ) ON [PRIMARY]</span></span></code> </pre> <br>  And you need somewhere centrally stored installation results, in case you need a diagnosis. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[zabbix_log]( [machine] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [osname] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [osarch] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [lastrun] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [zab_inst_err] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [zab_inst_run] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nut_inst_err] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nut_inst_run] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nut_upd_err] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nut_upd_run] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [zab_upd_err] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [zab_upd_run] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre> <br><blockquote>  lastrun - last run date of the script <br>  * _run - the date of the last launch of a function <br>  * _err - respectively the result of the launch </blockquote><br>  The tables have been created, you need to grant read access to cfg and write to the log group, which will include the necessary computers. <br><br><h3>  Script </h3><br><pre> <code class="hljs smalltalk"># !! #         c:\temp,         #   %<span class="hljs-type"><span class="hljs-type">TMP</span></span>%(      zabbix ,   ,    ) #   :\temp    . #    <span class="hljs-type"><span class="hljs-type">SQL</span></span>- function <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span>(<span class="hljs-string"><span class="hljs-string">$c</span></span>onn,<span class="hljs-string"><span class="hljs-string">$Q</span></span>uery,[<span class="hljs-type"><span class="hljs-type">Int32</span></span>]<span class="hljs-string"><span class="hljs-string">$Q</span></span>ueryTimeout=<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-string"><span class="hljs-string">$c</span></span>md=new-object system.<span class="hljs-type"><span class="hljs-type">Data</span></span>.<span class="hljs-type"><span class="hljs-type">SqlClient</span></span>.<span class="hljs-type"><span class="hljs-type">SqlCommand</span></span>(<span class="hljs-string"><span class="hljs-string">$Q</span></span>uery,<span class="hljs-string"><span class="hljs-string">$c</span></span>onn) <span class="hljs-string"><span class="hljs-string">$c</span></span>md.<span class="hljs-type"><span class="hljs-type">CommandTimeout</span></span>=<span class="hljs-string"><span class="hljs-string">$Q</span></span>ueryTimeout <span class="hljs-string"><span class="hljs-string">$d</span></span>s=<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> system.<span class="hljs-type"><span class="hljs-type">Data</span></span>.<span class="hljs-type"><span class="hljs-type">DataSet</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>a=<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> system.<span class="hljs-type"><span class="hljs-type">Data</span></span>.<span class="hljs-type"><span class="hljs-type">SqlClient</span></span>.<span class="hljs-type"><span class="hljs-type">SqlDataAdapter</span></span>(<span class="hljs-string"><span class="hljs-string">$c</span></span>md) [void]<span class="hljs-string"><span class="hljs-string">$d</span></span>a.fill(<span class="hljs-string"><span class="hljs-string">$d</span></span>s) <span class="hljs-string"><span class="hljs-string">$d</span></span>s.<span class="hljs-type"><span class="hljs-type">Tables</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] } #-------------------------------------------------------------------------------------------- function report-mail(<span class="hljs-string"><span class="hljs-string">$z</span></span>v) { <span class="hljs-symbol"><span class="hljs-symbol">#E</span></span>-<span class="hljs-type"><span class="hljs-type">Mail</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ender = <span class="hljs-string"><span class="hljs-string">'ZabbixInstall@domain.local'</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>ecipient = <span class="hljs-string"><span class="hljs-string">'admin@domain.local'</span></span> <span class="hljs-string"><span class="hljs-string">$S</span></span>MTPserver = <span class="hljs-string"><span class="hljs-string">'smtp'</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ubject = <span class="hljs-comment"><span class="hljs-comment">"At $HostName PS_version = $CurrentPS_Version"</span></span> if (<span class="hljs-string"><span class="hljs-string">$z</span></span>v -eq <span class="hljs-number"><span class="hljs-number">1</span></span>) {<span class="hljs-string"><span class="hljs-string">$s</span></span>ubject = <span class="hljs-comment"><span class="hljs-comment">"p***a #powershell install zabbix deployment aborted"</span></span>} <span class="hljs-string"><span class="hljs-string">$b</span></span>ody = <span class="hljs-comment"><span class="hljs-comment">"$HostName`t$OSName`t$OSVersion`t$OSLang`t$OSArchitecture`t$Date"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>sg = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">Mail</span></span>.<span class="hljs-type"><span class="hljs-type">MailMessage</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ender, <span class="hljs-string"><span class="hljs-string">$r</span></span>ecipient, <span class="hljs-string"><span class="hljs-string">$s</span></span>ubject, <span class="hljs-string"><span class="hljs-string">$b</span></span>ody <span class="hljs-string"><span class="hljs-string">$c</span></span>lient = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">Mail</span></span>.<span class="hljs-type"><span class="hljs-type">SmtpClient</span></span> <span class="hljs-string"><span class="hljs-string">$S</span></span>MTPserver <span class="hljs-string"><span class="hljs-string">$c</span></span>lient.<span class="hljs-type"><span class="hljs-type">Credentials</span></span> = [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Net</span></span>.<span class="hljs-type"><span class="hljs-type">CredentialCache</span></span>]::<span class="hljs-type"><span class="hljs-type">DefaultNetworkCredentials</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>lient.<span class="hljs-type"><span class="hljs-type">Send</span></span>(<span class="hljs-string"><span class="hljs-string">$m</span></span>sg) } #-------------------------------------------------------------------------------------------- #  : <span class="hljs-symbol"><span class="hljs-symbol">#Kill</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> <span class="hljs-comment"><span class="hljs-comment">"msiexec"</span></span> function <span class="hljs-type"><span class="hljs-type">Kill</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span>([string[]]<span class="hljs-string"><span class="hljs-string">$P</span></span>rocessNames) { if (<span class="hljs-string"><span class="hljs-string">$P</span></span>rocessNames -eq <span class="hljs-string"><span class="hljs-string">$n</span></span>ull) { <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-string"><span class="hljs-string">'The parametre "ProcessNames" cannot be empty'</span></span>; break } else { <span class="hljs-string"><span class="hljs-string">$p</span></span>r=(<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>rocessNames -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span>) <span class="hljs-string"><span class="hljs-string">$p</span></span>r.kill() } } #-------------------------------------------------------------------------------------------- #  <span class="hljs-type"><span class="hljs-type">NUT</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">#NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Install</span></span> -pth <span class="hljs-string"><span class="hljs-string">$p</span></span>nut -pth2 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2 -globalpath <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath function <span class="hljs-type"><span class="hljs-type">NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Install</span></span>() { <span class="hljs-type"><span class="hljs-type">Param</span></span>([string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th,[string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th2,[string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th3,[string]<span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath) <span class="hljs-string"><span class="hljs-string">$E</span></span>rrorActionPreference=<span class="hljs-comment"><span class="hljs-comment">"SilentlyContinue"</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-comment"><span class="hljs-comment">"$globalpath\driver\APC-UPS\InstallDriver.exe"</span></span> -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-comment"><span class="hljs-comment">"c:\temp\InstallDriver.exe"</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-process <span class="hljs-comment"><span class="hljs-comment">"c:\temp\InstallDriver.exe"</span></span> #   .      <span class="hljs-type"><span class="hljs-type">APC</span></span>,   exe  . <span class="hljs-string"><span class="hljs-string">$p</span></span>rocessid = (<span class="hljs-type"><span class="hljs-type">Start</span></span>-process msiexec -args <span class="hljs-comment"><span class="hljs-comment">"/quiet /passive /norestart /log c:\temp\inst_nutlog.txt /I $globalpath\nut.msi"</span></span> -<span class="hljs-type"><span class="hljs-type">PassThru</span></span>).id do #  silent  <span class="hljs-type"><span class="hljs-type">NUT</span></span>   exe, . { <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-comment"><span class="hljs-comment">"target_pid"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>rocessid [array]<span class="hljs-string"><span class="hljs-string">$m</span></span>siexecid = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> msiexec | % {<span class="hljs-string"><span class="hljs-string">$_</span></span>.id} [array]<span class="hljs-string"><span class="hljs-string">$x</span></span>er = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> wdi-simple if (<span class="hljs-string"><span class="hljs-string">$x</span></span>er.count -gt <span class="hljs-number"><span class="hljs-number">0</span></span>) {<span class="hljs-type"><span class="hljs-type">Kill</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> <span class="hljs-comment"><span class="hljs-comment">"wdi-simple"</span></span>} <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-comment"><span class="hljs-comment">"rem_proc"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>siexecid <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> [array]<span class="hljs-string"><span class="hljs-string">$p</span></span>roccount+=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-comment"><span class="hljs-comment">"pcount"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roccount.count <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> } while((<span class="hljs-string"><span class="hljs-string">$m</span></span>siexecid -contains <span class="hljs-string"><span class="hljs-string">$p</span></span>rocessid)-and(<span class="hljs-string"><span class="hljs-string">$p</span></span>roccount.count -lt <span class="hljs-comment"><span class="hljs-comment">"90"</span></span>)) #   <span class="hljs-type"><span class="hljs-type">NUT</span></span>    exe,    .     git. <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_sbin\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th3 -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_etc\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> # <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_bin\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th2 -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> #      .       <span class="hljs-type"><span class="hljs-type">MERGE</span></span>, . .     . <span class="hljs-string"><span class="hljs-string">$n</span></span>ut_inst_err=(<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Network UPS Tools'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StartService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-comment"><span class="hljs-comment">"MERGE [zabbix].[dbo].[zabbix_log] USING (values('$HostName','$nut_inst_err','$today')) AS foo (machine,nut_inst_err,nut_inst_run) ON (zabbix.dbo.zabbix_log.machine = foo.machine) WHEN MATCHED THEN UPDATE SET zabbix.dbo.zabbix_log.nut_inst_err = foo.nut_inst_err, zabbix.dbo.zabbix_log.nut_inst_run = foo.nut_inst_run;"</span></span> } #-------------------------------------------------------------------------------------------- #  <span class="hljs-type"><span class="hljs-type">NUT</span></span>: function <span class="hljs-type"><span class="hljs-type">NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Update</span></span>() { <span class="hljs-type"><span class="hljs-type">Param</span></span>([string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th,[string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th2,[string]<span class="hljs-string"><span class="hljs-string">$p</span></span>th3,[string]<span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath) (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Network UPS Tools'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StopService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_etc\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_bin\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th2 -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\nut_sbin\* -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>th3 -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>ut_upd_err=(<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Network UPS Tools'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StartService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-comment"><span class="hljs-comment">"MERGE [zabbix].[dbo].[zabbix_log] USING (values('$HostName','$nut_upd_err','$today')) AS foo (machine,nut_upd_err,nut_upd_run) ON (zabbix.dbo.zabbix_log.machine = foo.machine) WHEN MATCHED THEN UPDATE SET zabbix.dbo.zabbix_log.nut_upd_err = foo.nut_upd_err, zabbix.dbo.zabbix_log.nut_upd_run = foo.nut_upd_run;"</span></span> } #-------------------------------------------------------------------------------------------- #  zabbix: function zabbix-inst(<span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath,<span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin) { <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\<span class="hljs-type"><span class="hljs-type">Zabbix</span></span> -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\"</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Recurse</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> if (<span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin -eq <span class="hljs-comment"><span class="hljs-comment">"win32"</span></span>) {<span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\x86\<span class="hljs-type"><span class="hljs-type">Zabbix</span></span> -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\"</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Recurse</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span>} <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">11000</span></span> <span class="hljs-string"><span class="hljs-string">$z</span></span>conf = <span class="hljs-string"><span class="hljs-string">'"C:\Program Files\Zabbix\conf\zabbix_agentd.conf"'</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> -<span class="hljs-type"><span class="hljs-type">FilePath</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix\bin\$zbxbin\zabbix_agentd.exe"</span></span> -args <span class="hljs-comment"><span class="hljs-comment">"--config $zconf -i"</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-string"><span class="hljs-string">$z</span></span>ab_inst_err=(<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Zabbix Agent'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StartService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-comment"><span class="hljs-comment">"MERGE [zabbix].[dbo].[zabbix_log] USING (values('$HostName','$zab_inst_err','$today')) AS foo (machine,zab_inst_err,zab_inst_run) ON (zabbix.dbo.zabbix_log.machine = foo.machine) WHEN MATCHED THEN UPDATE SET zabbix.dbo.zabbix_log.zab_inst_err = foo.zab_inst_err, zabbix.dbo.zabbix_log.zab_inst_run = foo.zab_inst_run;"</span></span> } #-------------------------------------------------------------------------------------------- #  zabbix: function zabbix-update(<span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath,<span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin,<span class="hljs-string"><span class="hljs-string">$p</span></span>art) { (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Zabbix Agent'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StopService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\<span class="hljs-type"><span class="hljs-type">Zabbix</span></span>\<span class="hljs-string"><span class="hljs-string">$p</span></span>art -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix"</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Recurse</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">15000</span></span> if ((<span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin -eq <span class="hljs-comment"><span class="hljs-comment">"win32"</span></span>) -and ((<span class="hljs-string"><span class="hljs-string">$p</span></span>art -eq <span class="hljs-comment"><span class="hljs-comment">"conf"</span></span>) -or (<span class="hljs-string"><span class="hljs-string">$p</span></span>art -eq <span class="hljs-comment"><span class="hljs-comment">"cmd"</span></span>))) {<span class="hljs-type"><span class="hljs-type">Copy</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath\x86\<span class="hljs-type"><span class="hljs-type">Zabbix</span></span> -<span class="hljs-type"><span class="hljs-type">Destination</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\"</span></span> -<span class="hljs-type"><span class="hljs-type">Force</span></span> -<span class="hljs-type"><span class="hljs-type">Recurse</span></span> -<span class="hljs-type"><span class="hljs-type">Verbose</span></span>} <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -<span class="hljs-type"><span class="hljs-type">Milliseconds</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-string"><span class="hljs-string">$z</span></span>ab_upd_err=(<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_Service</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> <span class="hljs-comment"><span class="hljs-comment">"Name='Zabbix Agent'"</span></span>).<span class="hljs-type"><span class="hljs-type">InvokeMethod</span></span>(<span class="hljs-comment"><span class="hljs-comment">"StartService"</span></span>,<span class="hljs-string"><span class="hljs-string">$n</span></span>ull) <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-comment"><span class="hljs-comment">"MERGE [zabbix].[dbo].[zabbix_log] USING (values('$HostName','$zab_upd_err','$today')) AS foo (machine,zab_upd_err,zab_upd_run) ON (zabbix.dbo.zabbix_log.machine = foo.machine) WHEN MATCHED THEN UPDATE SET zabbix.dbo.zabbix_log.zab_upd_err = foo.zab_upd_err, zabbix.dbo.zabbix_log.zab_upd_run = foo.zab_upd_run;"</span></span> } ## <span class="hljs-type"><span class="hljs-type">START</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Transcript</span></span> -path c:\temp\zabbix_inst_debug.txt <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath=<span class="hljs-comment"><span class="hljs-comment">"\\domain.local\dfs\Zabbix_policy\zabbixinst"</span></span> #,     ,     ,   . <span class="hljs-string"><span class="hljs-string">$t</span></span>oday= get-date -<span class="hljs-type"><span class="hljs-type">Format</span></span> <span class="hljs-comment"><span class="hljs-comment">"yyyyMMdd"</span></span> # <span class="hljs-symbol"><span class="hljs-symbol">#Arch</span></span> <span class="hljs-string"><span class="hljs-string">$O</span></span>SArchitecture = (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> -<span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">Win32_OperatingSystem</span></span> -<span class="hljs-type"><span class="hljs-type">Namespace</span></span> root/cimv2).<span class="hljs-type"><span class="hljs-type">OSArchitecture</span></span> if (<span class="hljs-string"><span class="hljs-string">$O</span></span>SArchitecture -match <span class="hljs-comment"><span class="hljs-comment">"64-bit"</span></span>) { <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin=<span class="hljs-comment"><span class="hljs-comment">"win64"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files (x86)\NUT\etc\"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files (x86)\NUT\bin\"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut3=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files (x86)\NUT\sbin\"</span></span> } else { <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin=<span class="hljs-comment"><span class="hljs-comment">"win32"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files\NUT\etc\"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files\NUT\bin\"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut3=<span class="hljs-comment"><span class="hljs-comment">"c:\Program Files\NUT\sbin\"</span></span> } #  <span class="hljs-type"><span class="hljs-type">SQL</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn=new-object <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Data</span></span>.<span class="hljs-type"><span class="hljs-type">SqlClient</span></span>.<span class="hljs-type"><span class="hljs-type">SQLConnection</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn.<span class="hljs-type"><span class="hljs-type">ConnectionString</span></span>=<span class="hljs-comment"><span class="hljs-comment">"Server={0};Database={1};Integrated Security=True"</span></span> -f <span class="hljs-comment"><span class="hljs-comment">"server"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Zabbix"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn.<span class="hljs-type"><span class="hljs-type">Open</span></span>() #       . <span class="hljs-string"><span class="hljs-string">$H</span></span>ostName = <span class="hljs-string"><span class="hljs-string">$e</span></span>nv:<span class="hljs-type"><span class="hljs-type">COMPUTERNAME</span></span>; #     <span class="hljs-string"><span class="hljs-string">$O</span></span>peratingSystem = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">WmiObject</span></span> <span class="hljs-type"><span class="hljs-type">Win32_OperatingSystem</span></span>; #     <span class="hljs-string"><span class="hljs-string">$O</span></span>SName = <span class="hljs-string"><span class="hljs-string">$O</span></span>peratingSystem.caption; #   <span class="hljs-string"><span class="hljs-string">$O</span></span>SVersion = <span class="hljs-string"><span class="hljs-string">$O</span></span>peratingSystem.version; #   <span class="hljs-string"><span class="hljs-string">$O</span></span>SLang = <span class="hljs-string"><span class="hljs-string">$O</span></span>peratingSystem.oslanguage; #   # <span class="hljs-type"><span class="hljs-type">MinimalPS_Major_Version</span></span> <span class="hljs-string"><span class="hljs-string">$M</span></span>inimalPS_Major_Version = <span class="hljs-number"><span class="hljs-number">2</span></span> #   <span class="hljs-type"><span class="hljs-type">PowerShell</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentPS_Version = <span class="hljs-string"><span class="hljs-string">$h</span></span>ost.version.major #   <span class="hljs-type"><span class="hljs-type">PS</span></span> ,    <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-string"><span class="hljs-string">$C</span></span>urrentPS_Version -ge <span class="hljs-string"><span class="hljs-string">$M</span></span>inimalPS_Major_Version) { <span class="hljs-symbol"><span class="hljs-symbol">#main</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#log</span></span> <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-comment"><span class="hljs-comment">"MERGE [zabbix].[dbo].[zabbix_log] USING (values('$HostName','$OSName','$zbxbin','$today')) AS foo (machine,osname,osarch,lastrun) ON (zabbix.dbo.zabbix_log.machine = foo.machine) WHEN MATCHED THEN UPDATE SET zabbix.dbo.zabbix_log.osname = foo.osname, zabbix.dbo.zabbix_log.osarch = foo.osarch, zabbix.dbo.zabbix_log.lastrun = foo.lastrun WHEN NOT MATCHED BY TARGET THEN INSERT (machine,osname,osarch,lastrun) values (machine,osname,osarch,lastrun);"</span></span> # <span class="hljs-string"><span class="hljs-string">$Q</span></span>uery= <span class="hljs-comment"><span class="hljs-comment">"SELECT * FROM [zabbix].[dbo].[zabbix_cfg]"</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>esult= <span class="hljs-type"><span class="hljs-type">Invoke</span></span>-<span class="hljs-type"><span class="hljs-type">Sqlcmd</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onn <span class="hljs-string"><span class="hljs-string">$Q</span></span>uery [array]<span class="hljs-string"><span class="hljs-string">$t</span></span>estresult= <span class="hljs-string"><span class="hljs-string">$r</span></span>esult if (<span class="hljs-string"><span class="hljs-string">$t</span></span>estresult.count -ne <span class="hljs-number"><span class="hljs-number">1</span></span> ) { report-mail <span class="hljs-number"><span class="hljs-number">1</span></span>} #   [int]<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_bin = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix\bin\ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> [int]<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_cmd = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix\cmd\ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> [int]<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_conf = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix\conf\ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> [int]<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_extra = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\Zabbix\extra\ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> [int]<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_bin = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2<span class="hljs-comment"><span class="hljs-comment">"ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> [int]<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_conf = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Content</span></span> -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>nut<span class="hljs-comment"><span class="hljs-comment">"ver"</span></span> -<span class="hljs-type"><span class="hljs-type">ErrorAction</span></span> <span class="hljs-type"><span class="hljs-type">SilentlyContinue</span></span> #  if ((<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_bin -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) -and (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_cmd -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) -and (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_conf -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) -and (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_extra -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) -and (<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_bin -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) -and (<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_conf -lt <span class="hljs-number"><span class="hljs-number">1</span></span>) ) { <span class="hljs-type"><span class="hljs-type">NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Install</span></span> -pth <span class="hljs-string"><span class="hljs-string">$p</span></span>nut -pth2 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2 -pth3 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut3 -globalpath <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath zabbix-inst <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin } else { if (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_bin -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.zabbix_bin) {zabbix-update <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin <span class="hljs-comment"><span class="hljs-comment">"bin"</span></span>} if (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_cmd -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.zabbix_cmd) {zabbix-update <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin <span class="hljs-comment"><span class="hljs-comment">"cmd"</span></span>} if (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_conf -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.zabbix_conf) {zabbix-update <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin <span class="hljs-comment"><span class="hljs-comment">"conf"</span></span>} if (<span class="hljs-string"><span class="hljs-string">$z</span></span>abbix_extra -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.zabbix_extra) {zabbix-update <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath <span class="hljs-string"><span class="hljs-string">$z</span></span>bxbin <span class="hljs-comment"><span class="hljs-comment">"extra"</span></span>} if (<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_bin -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.nut_bin) {<span class="hljs-type"><span class="hljs-type">NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Install</span></span> -pth <span class="hljs-string"><span class="hljs-string">$p</span></span>nut -pth2 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2 -pth3 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut3 -globalpath <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath} elseif (<span class="hljs-string"><span class="hljs-string">$n</span></span>ut_conf -lt <span class="hljs-string"><span class="hljs-string">$r</span></span>esult.nut_conf) {<span class="hljs-type"><span class="hljs-type">NUT</span></span>-<span class="hljs-type"><span class="hljs-type">Update</span></span> -pth <span class="hljs-string"><span class="hljs-string">$p</span></span>nut -pth2 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut2 -pth3 <span class="hljs-string"><span class="hljs-string">$p</span></span>nut3 -globalpath <span class="hljs-string"><span class="hljs-string">$g</span></span>lobalpath} } } else { report-mail } <span class="hljs-symbol"><span class="hljs-symbol">#end</span></span> main <span class="hljs-symbol"><span class="hljs-symbol">#close</span></span> connect <span class="hljs-string"><span class="hljs-string">$c</span></span>onn.<span class="hljs-type"><span class="hljs-type">Close</span></span>() <span class="hljs-type"><span class="hljs-type">Stop</span></span>-<span class="hljs-type"><span class="hljs-type">Transcript</span></span></code> </pre> <br><h3>  P.S </h3><br>  My script is located in dfs and is run by a task that is created using group policy. <br>  All used files are laid out on <a href="https://github.com/mikezsin/zabbix_policy">git</a> . <br><br>  <a href="https://habrahabr.ru/post/312146/">Monitor client PCs in Microsoft AD with Zabbix.</a>  <a href="https://habrahabr.ru/post/312146/">Part 2 - Template, Scripts and LLD</a> <a href="https://habrahabr.ru/post/312146/"><br></a> </div><p>Source: <a href="https://habr.com/ru/post/310928/">https://habr.com/ru/post/310928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310886/index.html">Replacing the boot-animation of an Android device with flickering Linux kernel logs</a></li>
<li><a href="../310892/index.html">Configuring D-link DSR routers to work with 3CX</a></li>
<li><a href="../310922/index.html">40% of organizations store admin passwords in spreadsheets and text files</a></li>
<li><a href="../310924/index.html">Forcing Asynchrony in Java Services for Baratine</a></li>
<li><a href="../310926/index.html">Android security. Lecture in Yandex</a></li>
<li><a href="../310930/index.html">Placement of the table of values ‚Äã‚Äãwith the help of additional requisite and expansion of the 1C configuration</a></li>
<li><a href="../310938/index.html">Laziness, impatience and self-conceit are the three main virtues of a programmer. Happy birthday, Larry Wall</a></li>
<li><a href="../310942/index.html">Ultralight BDD: Little Mechanization of Stand-Alone Tests</a></li>
<li><a href="../310944/index.html">After the biggest data theft in history on Yahoo! still ‚Äú33 misfortunes‚Äù</a></li>
<li><a href="../310946/index.html">Canvas Gauges 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>