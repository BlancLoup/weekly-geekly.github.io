<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interception of system calls in linux under x86-64</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Many articles on intercepting x32 system calls have been published on the Internet. As part of solving one task, it became necessary to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interception of system calls in linux under x86-64</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Many articles on intercepting x32 system calls have been published on the Internet.  As part of solving one task, it became necessary to intercept system calls under the x86-64 architecture using a loadable kernel module.  Let's start: <a name="habracut"></a><br><br><h4>  Intercept system calls </h4><br>  Algorithm: <br><ul><li>  Finding the address of the system call table </li><li>  Substitution for addresses of new system calls </li></ul><br><br><h5>  Finding the address of the system call table </h5><br>  The first option: can be found through the table of interrupt descriptors (IDT), IDT - is used to link the interrupt handler with the interrupt number.  In protected mode, the address in physical memory and the size of the interrupt table is determined by the 80-bit IDTR register. In protected mode, the IDT element is the 10-byte interrupt gateway containing the segment (logical) address of the interrupt handler, access rights, etc. This method is not interesting to us because  we get the address of the handler, which is made for compatibility with x32 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second option is more interesting. <br><br>  For a start, not a big digression: <a href="http://en.wikipedia.org/wiki/Machine_state_register">MSR</a> - machine state register is a set of registers of Intel processors used in the x86 and x86-64 processors.  These registers provide the ability to monitor and obtain information about the state of the processor.  All MSR registers are available only for system functions and are not accessible from user programs.  We are particularly interested in the following register: MSR_LSTAR - 0xc0000082 (long mode SYSCALL target) <br>  (the full list can be found in /usr/include/asm/msr-index.h). <br>  This register stores the address of the interrupt handler for x86-64. <br>  You can get the address as follows: <br> <code>int i, lo, hi; <br> asm volatile("rdmsr" : "=a" (lo), "=d" (hi) : "c" (MSR_LSTAR)); <br> system_call = (void*)(((long)hi&lt;&lt;32) | lo); <br></code> <br>  Next, find the address of the table itself.  Let's go to the address we just received and find the sequence \ xff \ x14 \ xc5 in memory (these magic numbers are taken if you look at the kernel code, in particular, the system_call function code, in which the handler is called from the required one).  Considering the following 4 bytes, we get the address of the syscall_table system call table.  Knowing its address, we can get the contents of this table (addresses of all system functions) and change the address of any system call, intercepting it. <br>  code to find the address of the system call table: <br> <code>unsigned char *ptr; <br> for (ptr=system_call, i=0; i&lt;500; i++) { <br> if (ptr[0] == 0xff &amp;&amp; ptr[1] == 0x14 &amp;&amp; ptr[2] == 0xc5) <br> return (void*)(0xffffffff00000000 | *((unsigned int*)(ptr+3))); <br> ptr++; <br> } <br></code> <br><br><h5>  Substitution for addresses of new system calls </h5><br>  Here, too, there are certain nuances, if you just try to change anything in the table, then an error will be generated.  Fortunately, this is easy enough: <br><ul><li>  Disable memory protection </li><li>  We rewrite the address to the address of our handler. </li><li>  Turn on memory protection </li></ul><br>  To remove and install protection, you need to know the following: Register CR0 - contains system control flags that control the behavior and state of the processor. WP flag - write protection (Write Protect), 48th bit of CR0.  When set, prevents system procedures from writing to user pages with read-only access (when the WP flag is cleared, it allows).  Unlike x32, only the size of the register and the flag number changed <br>  security removal code: <br> <code>asm("pushq %rax"); <br> asm("movq %cr0, %rax"); <br> asm("andq $0xfffffffffffeffff, %rax"); <br> asm("movq %rax, %cr0"); <br> asm("popq %rax"); <br></code> <br>  security enable code: <br> <code>asm("pushq %rax"); <br> asm("movq %cr0, %rax"); <br> asm("xorq $0x0000000000001000, %rax"); <br> asm("movq %rax, %cr0"); <br> asm("popq %rax"); <br></code> <br><br>  This knowledge is enough to replace the system calls in Linux x86-64.  I hope someone this will be useful. <br>  Thanks for attention. <br><br>  <b>UPD:</b> <ul><li>  <a href="http://www.goncharov.xyz/it/system-call-interception-in-linux-kernel-module.html">Russian version</a> </li><li>  <a href="https://github.com/ultral/linux-keylogger">github.com/ultral/linux-keylogger</a> </li><li><iframe width="560" height="315" src="https://www.youtube.com/embed/FgPVCQa0qsw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></li></ul></div><p>Source: <a href="https://habr.com/ru/post/110369/">https://habr.com/ru/post/110369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110363/index.html">Samsung bada Developers Challenge - World Contest Results</a></li>
<li><a href="../110364/index.html">Kno - a tablet with an Ubuntu-based operating system in two versions with single and double display</a></li>
<li><a href="../110366/index.html">Release ImpactJS Game Engine - $ 99</a></li>
<li><a href="../110367/index.html">SVG with transparent background in Chrome and Safari</a></li>
<li><a href="../110368/index.html">Groovy inspiration - Feel the difference</a></li>
<li><a href="../110374/index.html">"Ears" for every taste</a></li>
<li><a href="../110379/index.html">War¬ßow 0.6 released!</a></li>
<li><a href="../110382/index.html">The biggest sale on Steam, for all time of its existence</a></li>
<li><a href="../110384/index.html">Visual paradigm for language selection</a></li>
<li><a href="../110385/index.html">GeoIP - countries and cities, December 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>