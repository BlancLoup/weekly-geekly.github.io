<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programming & Music: Delay, Distortion and Parameter Modulation. Part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! You are reading the fourth part of an article about creating a VST synthesizer in C #. In the previous parts, we generated a signal, applied an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programming & Music: Delay, Distortion and Parameter Modulation. Part 4</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  You are reading the fourth part of an article about creating a VST synthesizer in C #.  In the previous parts, we generated a signal, applied an amplitude envelope and a frequency filter to it. </p><br><p>  This time we will look at the effects of <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D1%2581%25D1%2582%25D0%25BE%25D1%2580%25D1%2588%25D0%25BD">Distortion</a> - distortion of the signal, familiar to any electric guitar <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25BB%25D1%258D%25D0%25B9">player</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25BB%25D1%258D%25D0%25B9">Delay</a> (it is an echo). </p><br><p>  Many different interesting sounds can be obtained by changing (modulating) the parameters of the components of the synthesizer (generator, filter, effects) over time.  Consider the option of how this can be done. </p><br><p>  The source code for the <a href="https://www.youtube.com/watch%3Fv%3D6zAVMEtIb2w">synthesizer I've written</a> is available on <a href="https://github.com/lis355/Syntage">GitHub</a> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/548/3e9/4ff/5483e94ff1264b3883aa9a6ce08b4d5b.png"></div><br><p>  <i>Screenshot VST plugin <a href="http://www.gvst.co.uk/gclip.htm">GClip</a></i> </p><br><a name="habracut"></a><br><h2 id="cikl-statey">  Cycle of articles </h2><br><ol><li>  <a href="https://habrahabr.ru/post/311220/">We understand and write VSTi synthesizer on C # WPF</a> </li><li>  <a href="https://habrahabr.ru/post/311750/">ADSR signal envelope</a> </li><li>  <a href="https://habrahabr.ru/post/313062/">Buttervo Frequency Filter</a> </li><li>  Delay, Distortion and Parameter Modulation </li></ol><br><h2 id="oglavlenie">  Table of contents </h2><br><ol><li>  <a href="https://habr.com/ru/post/313338/">Clipping, distortion, overdrive and distortion</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Code Distortion Effect</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Delay and Reverb</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Code Delay effect</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Parameter Modulation</a> </li><li>  <a href="https://habr.com/ru/post/313338/">We write class LFO</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Interface IParameterModifier and the use of the current value of the parameter</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Conclusion</a> </li><li>  <a href="https://habr.com/ru/post/313338/">Bibliography</a> </li></ol><br><a name="Part1"></a><br><h2 id="klipping-iskazheniya-overdrayv-i-distorshn">  Clipping, distortion, overdrive and distortion </h2><br><p>  The initial models of guitar amplifiers and pickups were simple and of low quality, respectively, adding distortion to the signal being processed.  When using analog amplifiers, the signal was distorted depending on the outgoing volume of the signal.  With an increase in the amplitude of the signal, the nonlinear distortion coefficient increases, various harmonics are added.  If you turn on your home speakers to maximum, I am sure that you will also hear the distortion. </p><br><p>  There is a story that, in the 51st year, the guitarist of the Kings of Rhythm band used an amplifier that was damaged on the way, and the producer liked the sound - so one of the earliest recordings of a distorted guitar was made. </p><br><p>  The effect of "Distortion" - translated from English as "distortion".  If the signal starts to be strictly limited in amplitude, nonlinear distortions will be created, new harmonics will appear.  The greater the constraint (Theshold), the more distorted the signal. </p><br><p>  Almost any guitar in the genre with the word "rock" is distorted or <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B2%25D0%25B5%25D1%2580%25D0%25B4%25D1%2580%25D0%25B0%25D0%25B9%25D0%25B2">overdrive</a> .  <a href="http://buyguitar.narod.ru/electric_guitars_effects.html">Link to audio examples of famous effects</a> . </p><br><p>  <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B2%25D0%25B5%25D1%2580%25D0%25B4%25D1%2580%25D0%25B0%25D0%25B9%25D0%25B2">Overdrive</a> has a smoother amplitude limit than distortion.  Overdrive is also called Soft Clipping, and distortion, respectively, Hard Clipping.  Overdrive on guitars is used in more "quiet" genres such as indie rock, pop rock and the like. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fa1/faf/e88/fa1fafe8833f46e4bfc112d368e089d1.png"></div><br><p>  <em>An approximate comparison of the effects of Distortion (Hard Clipping) and Overdrive (Soft Clipping)</em> </p><br><p>  Clipping is called unwanted artifacts (clicks), when the <em>digital</em> amplitude exceeds 0 dB.  There are effects that implement "pure" (without emulating any analog pedals or preamps) signal distortion.  For example, the <a href="http://www.gvst.co.uk/gclip.htm">GClip</a> plugin (at the beginning of the article is just its screen) simply mathematically cuts off the incoming signal in amplitude. </p><br><a name="Part2"></a><br><h2 id="kodim-effekt-distorshn">  Code Distortion Effect </h2><br><p>  From the above we deduce that, in fact, the hard distortion is determined only by the parameter of the maximum absolute value of the amplitude - Threshold.  In our case, the absolute values ‚Äã‚Äãof the sample do not exceed 1, which means that the Threshold is enclosed in the interval [0,1]. </p><br><p>  The more we limit the signal (the closer Threshold is to zero), the weaker it becomes.  To keep the volume of the signal unchanged, you can restore it: divide the value of the sample into Threshold. </p><br><p>  We obtain a simple algorithm for the hard distortion, which is used for each sample separately: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e6b/f45/272/e6bf4527260c49eab490ecb69ac6903f.png"></div><br><ol><li>  If the value of the sample is greater than the threshold, make it equal to the threshold. </li><li>  If the value of the sample is less than-Threshold, make it equal to-Threshold. </li><li>  Multiply the value of the sample by the Threshold. </li></ol><br><p>  We return to the synthesizer written by me (a review of the architecture of classes in the <a href="https://habrahabr.ru/post/311220/">first article</a> ).  The Distortion class will inherit the SyntageAudioProcessorComponentWithParameters &lt;AudioProcessor&gt; class and implement the IProcessor interface. </p><br><p>  Add the Power parameter to indicate how the effect works.  The Treshold parameter cannot be equal to 0, otherwise we will have to divide by 0. To limit the signal, take a maximum of the value of the sample and Treshold if the value of the sample is greater than zero;  take the maximum of the value of the sample and -Treshold if the value of the sample is less than zero. </p><br><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> enum EPowerStatus { <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Distortion : SyntageAudioProcessorComponentWithParameters&lt;AudioProcessor&gt;, IProcessor { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EnumParameter&lt;EPowerStatus&gt; Power { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RealParameter Treshold { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Distortion(AudioProcessor audioProcessor) : base(audioProcessor) { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override IEnumerable&lt;Parameter&gt; CreateParameters(string parameterPrefix) { Power = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EnumParameter&lt;EPowerStatus&gt;(parameterPrefix + "Pwr", "Power", "", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); Treshold = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RealParameter(parameterPrefix + "Trshd", "Treshold", "Trshd", <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Parameter&gt; {Power, Treshold}; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Process(IAudioStream stream) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Power.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> == EPowerStatus.<span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; var count = Processor.CurrentStreamLenght; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; ++i) { var treshold = Treshold.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; stream.Channels[<span class="hljs-number"><span class="hljs-number">0</span></span>].Samples[i] = DistortSample(stream.Channels[<span class="hljs-number"><span class="hljs-number">0</span></span>].Samples[i], treshold); stream.Channels[<span class="hljs-number"><span class="hljs-number">1</span></span>].Samples[i] = DistortSample(stream.Channels[<span class="hljs-number"><span class="hljs-number">1</span></span>].Samples[i], treshold); } } private static <span class="hljs-type"><span class="hljs-type">double</span></span> DistortSample(<span class="hljs-type"><span class="hljs-type">double</span></span> sample, <span class="hljs-type"><span class="hljs-type">double</span></span> treshold) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((sample &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ? Math.Min(sample, treshold) : Math.Max(sample, -treshold)) / treshold; } }</code> </pre> <br><a name="Part3"></a><br><h2 id="diley-i-reverberaciya">  Delay and Reverb </h2><br><p>  <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25BB%25D1%258D%25D0%25B9">Delay</a> , it is an echo - the effect of repeating a signal with a delay.  Usually, delay refers to a clear repetition (multiple repetitions) of a signal.  Enter the archway, the transition - you will hear how a short loud sound will be reflected several times, losing volume.  If you stand in the concert hall, with a much more complex architecture and sound-reflecting surfaces than the arch in the house, you can no longer hear clear repetitions, but a fading sound. </p><br><p>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B2%25D0%25B5%25D1%2580%25D0%25B1%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">Reverberation</a> is the process of gradually reducing the intensity of a sound during its multiple reflections.  The received <em>reverberation time</em> is the time during which the sound level decreases by 60 dB.  Depending on the device of the room / hall, the reverberation time and sound picture can vary greatly. </p><br><p>  <a href="https://acousticalsolutions.com/reverberation-examples-and-explanations/">Listening is</a> always better than reading about sound.  And you can and <a href="https://www.youtube.com/watch%3Fv%3DTyGdFybLy5o">see</a> . </p><br><p>  Mention should be made of the realization of the reverberation effect by means of <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B2%25D1%2591%25D1%2580%25D1%2582%25D0%25BA%25D0%25B0_(%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7)">convolution</a> ( <a href="http://en.wikipedia.org/wiki/Convolution_reverb">Convolution Reverb</a> ).  The bottom line is that having a special file on our hands that "describes" the room we need ( <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D1%2585%25D0%25BE%25D0%25B4%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">impulse response</a> ), you can absolutely accurately reproduce the reverberation from the desired sound in this room. </p><br><p>  To get impulse responses (they are simply called impulses / impulses, which are very many on the network), you need to install a microphone in the right room, start recording and play a sound - ‚Äúimpulse‚Äù - or rather, a phenomenon as close as possible: for example, some extremely sharp hit;  record the echo of our impulse. </p><br><p>  We got a way to completely recreate the acoustics of the room - at least to the extent that it guarantees us that the sound is unchanged while the impulse function is unchanged.  Not all process parameters are determined by the impulse function, but most important for a person is still determined. </p><br><p>  Similarly, they make <em>impulse responses of</em> guitar cabinets for use in <a href="http://guitar.ru/articles/sound-rec/pro-reamping.html">reamping</a> guitars on a computer. </p><br><a name="Part4"></a><br><h2 id="kodim-effekt-dileya">  Code Delay effect </h2><br><p>  Echo is a signal repetition with some time delay.  That is, the current value of the signal is added as the current new value plus the value of the signal t time ago, t is the delay time. <br>  A simple formula for the value of the sample: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cc7/a90/cd1/cc7a90cd1cb24e39adfc39b9bcd93c04.gif"></div><br><p>  Where x is the input sequence of samples, y is the resultant, T is the delay in the samples. <br>  Need to store the last T calculated samples.  Each time you need to get the value of the sample with a delay and save the new calculated value.  For these purposes, suitable cyclic buffer. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/042/afe/c2d/042afec2d76246108491ebb2dadb450a.png"></div><br><p>  <em>Guitar pedal Ibanez AD9 Analog Delay</em> </p><br><p>  To adjust the volume (I would say "quantity") of the delay, you can substitute the factors in the formula.  Usually, the plug-ins use the terms Dry / Wet - the ratio in the mix of untreated ("dry") and processed ("wet") signals.  In the sum, the coefficients are equal to 1, since they denote shares.  In the photo of the pedal, the Wet parameter is called Delay Level. </p><br><p>  In this formula, there is no echo <em>attenuation</em> , it will always be repeated at the same volume level.  This parameter is usually called Feedback (in the photo the parameter is called Repeat), it lowers the volume depending on time. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f6d/3fa/7a7/f6d3fa7a74684851b383f7d1518bfbf1.gif"></div><br><p>  It turns out that in our simple delay there will be 4 parameters: </p><br><ol><li>  Power - effect works or not </li><li>  Drylevel </li><li>  Time - delay time in seconds </li><li>  Feedback </li></ol><br><p>  To find T (the delay in the samples, the size of the sample buffer), multiply the sampling rate by the Time parameter.  In order not to allocate memory for the buffer each time when the Time parameter is changed, we will immediately create an array of the maximum length Time.Max * SampleRate. </p><br><p>  Let's write an auxiliary class for a circular buffer: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Buffer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _index; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[] _data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Buffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length</span></span></span><span class="hljs-function">)</span></span> { _data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[length]; _index = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _data[_index]; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _data[_index] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Increment</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentLength</span></span></span><span class="hljs-function">)</span></span> { _index = (_index + <span class="hljs-number"><span class="hljs-number">1</span></span>) % currentLength; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Array.Clear(_data, <span class="hljs-number"><span class="hljs-number">0</span></span>, _data.Length); } }</code> </pre> <br><p>  Function to calculate the sample: </p><br><pre> <code class="hljs pgsql">private <span class="hljs-type"><span class="hljs-type">double</span></span> ProcessSample(<span class="hljs-type"><span class="hljs-type">double</span></span> sample, Buffer buffer) { var dry = DryLevel.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; var wet = <span class="hljs-number"><span class="hljs-number">1</span></span> - dry; var output = dry * sample + wet * buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>; buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> = sample + Feedback.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> * buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> length = (<span class="hljs-type"><span class="hljs-type">int</span></span>)(<span class="hljs-type"><span class="hljs-type">Time</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> * Processor.SampleRate); buffer.Increment(length); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Delay class code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Delay : SyntageAudioProcessorComponentWithParameters&lt;AudioProcessor&gt;, IProcessor { private <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Buffer { private <span class="hljs-type"><span class="hljs-type">int</span></span> _index; private readonly <span class="hljs-type"><span class="hljs-type">double</span></span>[] _data; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Buffer(<span class="hljs-type"><span class="hljs-type">int</span></span> length) { _data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span>[length]; _index = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _data[_index]; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _data[_index] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Increment</span></span>(int currentLength) { _index = (_index + <span class="hljs-number"><span class="hljs-number">1</span></span>) % currentLength; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Clear() { <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>.Clear(_data, <span class="hljs-number"><span class="hljs-number">0</span></span>, _data.Length); } } private Buffer _lbuffer; private Buffer _rbuffer; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> EnumParameter&lt;EPowerStatus&gt; Power { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RealParameter DryLevel { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RealParameter <span class="hljs-type"><span class="hljs-type">Time</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> RealParameter Feedback { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Delay(AudioProcessor audioProcessor) : base(audioProcessor) { audioProcessor.OnSampleRateChanged += OnSampleRateChanged; audioProcessor.PluginController.ParametersManager.OnProgramChange += ParametersManagerOnProgramChange; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override IEnumerable&lt;Parameter&gt; CreateParameters(string parameterPrefix) { Power = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> EnumParameter&lt;EPowerStatus&gt;(parameterPrefix + "Pwr", "Power", "", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); DryLevel = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RealParameter(parameterPrefix + "Dry", "Dry Level", "Dry", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>); <span class="hljs-type"><span class="hljs-type">Time</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RealParameter(parameterPrefix + "Sec", "Delay Time", "Time", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>); Feedback = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RealParameter(parameterPrefix + "Fbck", "Feedback", "Feedback", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Parameter&gt; {Power, DryLevel, <span class="hljs-type"><span class="hljs-type">Time</span></span>, Feedback}; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> ClearBuffer() { _rbuffer?.Clear(); _lbuffer?.Clear(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Process(IAudioStream stream) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Power.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> == EPowerStatus.<span class="hljs-keyword"><span class="hljs-keyword">Off</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; var leftChannel = stream.Channels[<span class="hljs-number"><span class="hljs-number">0</span></span>]; var rightChannel = stream.Channels[<span class="hljs-number"><span class="hljs-number">1</span></span>]; var count = Processor.CurrentStreamLenght; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; ++i) { leftChannel.Samples[i] = ProcessSample(leftChannel.Samples[i], i, _lbuffer); rightChannel.Samples[i] = ProcessSample(rightChannel.Samples[i], i, _rbuffer); } } private <span class="hljs-type"><span class="hljs-type">void</span></span> OnSampleRateChanged(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, SyntageAudioProcessor.SampleRateEventArgs e) { var size = (<span class="hljs-type"><span class="hljs-type">int</span></span>)(e.SampleRate * <span class="hljs-type"><span class="hljs-type">Time</span></span>.Max); _lbuffer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Buffer(size); _rbuffer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Buffer(size); } private <span class="hljs-type"><span class="hljs-type">void</span></span> ParametersManagerOnProgramChange(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, ParametersManager.ProgramChangeEventArgs e) { ClearBuffer(); } private <span class="hljs-type"><span class="hljs-type">double</span></span> ProcessSample(<span class="hljs-type"><span class="hljs-type">double</span></span> sample, <span class="hljs-type"><span class="hljs-type">int</span></span> sampleNumber, Buffer buffer) { var dry = DryLevel.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; var wet = <span class="hljs-number"><span class="hljs-number">1</span></span> - dry; var output = dry * sample + wet * buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>; buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> = sample + Feedback.ProcessedValue(sampleNumber) * buffer.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> length = (<span class="hljs-type"><span class="hljs-type">int</span></span>)(<span class="hljs-type"><span class="hljs-type">Time</span></span>.ProcessedValue(sampleNumber) * Processor.SampleRate); buffer.Increment(length); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output; } }</code> </pre> </div></div><br><a name="Part5"></a><br><h2 id="modulyaciya-parametrov">  Parameter Modulation </h2><br><p>  At this stage, the following chain of sound generation has been reviewed and coded (you will find all this in previous articles): </p><br><ol><li>  Generating a simple wave in an oscillator </li><li>  ADSR Envelope Signal Processing </li><li>  Signal processing frequency filter </li><li>  Further effects processing: Distrotion, Delay </li></ol><br><p>  After the effects, the signal usually undergoes master processing (usually just adjusting the resulting volume) and is fed to the output of the plug-in. </p><br><p>  Having such a sequence, you can already get a variety of sounds. <br>  A lot of sounds are made by changing any parameter in time.  For example, in the <a href="https://www.youtube.com/watch%3Fv%3DiuOc3wQB4Aw">sound of a ‚Äúlaser gun‚Äù shot,</a> you can clearly hear how the fundamental frequency changes from high to low. </p><br><p>  In theory, about all our parameters (the Parameter class) knows the host, they exist <strong>not only</strong> within our architecture.  In a host, you can make parameter automation to change them over time. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a14/cb2/b2d/a14cb2b2d57a447a90444699dd12229b.png"></div><br><p>  <em>Automation of parameters in FL Studio 12. Top track "Cerbera" - the track with notes for the Sytrus synthesizer, below the tracks with the graphs of parameter changes (Vocodex, Flangus, Delay, Reverb) added VST effects on this synthesizer track</em> </p><br><p>  Of course, such automation is very convenient and very often used when creating music.  But such automation will work only when playing a track, it is difficult to configure.  If we want a parameter to change with each push of a note, or just to constantly change according to some law?  It is more logical to make the automation already in the plugin itself - there will be more room for creating sound. </p><br><p>  Usually in synthesizers there is a special part / block / module responsible for modulating the parameters.  It is called so, modulation unit or modulation matrix.  Modulation of the parameters is similar to the amplitude modulation of the ADSR envelope from <a href="https://habrahabr.ru/post/311750/">the 2nd article</a> .  Only now imagine that instead of the envelope, you can come up with any law of parameter change at all, and modulate any parameter in the plugin (which implies that it can be modulated). </p><br><p>  As a "law", envelopes and the LFO are usually taken (Low Frequency Oscillator is essentially the same oscillator, but its samples are used as multipliers for modulation and not as a sound wave).  In many synthesizers, you can manually draw a graph of parameter changes, or collect it from pre-prepared patterns. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e97/8a0/3a8/e978a03a8874465b9302549ffccb54a8.png"></div><br><p>  <em>Modulation unit in the Sylenth1 synthesizer.</em>  <em>There are two ADSR envelopes, two LFO oscillators, and modulation based on other sources (like Velocity from pushing a note).</em>  <em>For each source, you can specify two modulated parameters and ‚Äúmodulation degree‚Äù as an intermediate factor (the twist to the left of the parameter name).</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f5a/036/cbb/f5a036cbbcba447c9c649dd5a9b6474d.png"></div><br><p>  <em>Modulation matrix in the Serum synthesizer.</em>  <em>Each line describes a pair of ‚Äúsource - modulated parameter‚Äù with additional settings (modulation type, ‚Äúquantity‚Äù multiplier, curve, and so on).</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4ed/53b/d43/4ed53bd4361445e3a26c64d2465d9b1f.png"></div><br><p>  <em>Envelopes and LFO in Massive synthesizer.</em>  <em>You can manually draw a change curve from individual patterns / pieces.</em> </p><br><a name="Part6"></a><br><h2 id="pishem-klass-lfo">  We write class LFO </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2d0/84b/5c7/2d084b5c7c96414db137489cdce05309.png"></div><br><p>  <em>Modulation block in the synthesizer written by me</em> </p><br><p>  Write the LFO class: its task will be to modulate the parameters.  The oscillator will generate a wave with an amplitude in the interval [-1,1], which we will use as a factor for the parameter.  The LFO oscillator is basically no different in principle from the ordinary oscillator, which we code to generate a simple wave.  The prefix "low frequency" is written because it can generate very low frequencies (less hertz).  Since a person does not hear notes below ~ 20 Hertz, then there is no such low frequencies on the musical keyboard (respectively, on the main oscillator). </p><br><p>  The oscillator has the following parameters: frequency, and wave type (Sine, Triangle, Square, Noise). <br>  For convenient generation of such signals, the WaveGenerator.GenerateNextSample function was previously written. </p><br><p>  Consider how we modify the value of the sample.  All parameters (the Parameter class) have the RealValue property, which displays the parameter value in the interval [0, 1].  This is what we need.  The oscillator generates values ‚Äã‚Äãin the interval [-1,1].  In fact, we twist the parameter knob to the maximum to the right, then to the maximum to the left. </p><br><p>  There is a problem - say, the value of the parameter is 0.25.  In order to equally change a parameter to a smaller and larger side, you can change it only from 0 to 0.5 (-1 corresponds to 0, 1 corresponds to 0.5, with 0 - the parameter does not change and is equal to 0.25).  Thus, we take the smallest segment that divides the value of the parameter r: f = min (r, 1 - r). <br>  Now the parameter will change in the range [r - f, r + f]. </p><br><p>  Add another parameter to control the "width" of the variable range of values ‚Äã‚Äã- Gain, with values ‚Äã‚Äãin the interval [0, 1]. <br>  We get the following formula for the modified sample value: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/10c/704/f10/10c704f103e748baa9e0eefd70e223f8.gif"></div><br><p>  Now you need to decide how the oscillator will work.  The LFO class does not generate or modify an array of samples.  Just for the oscillator to work, you need to remember the past tense.  Therefore, we will inherit from the IProcessor interface, in the Process function (IAudioStream stream) we will count the number of samples passed.  If we divide it into SampleRate, we get the elapsed time. </p><br><p>  There is an option in synthesizers so that the LFO is synchronized with a keystroke.  For us, this means that when you click (the MidiListenerOnNoteOn handler) you need to reset the oscillator phase (reset the time to 0).  For this will answer the parameter MatchKey. </p><br><p>  The function that calculates the value of the sample ModifyRealValue will take as input the current value of the currentValue parameter and the current sample number sampleNumber.  How correctly to use the modified value will be written further.  Now we need to understand that the ModifyRealValue function will be called for each sample in the incoming separate array (which is in the Process function). </p><br><p>  We get the following methods: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAudioStream stream</span></span></span><span class="hljs-function">)</span></span> { _time += Processor.CurrentStreamLenght / Processor.SampleRate; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModifyRealValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleNumber</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gain = Gain.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DSPFunctions.IsZero(gain)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentValue; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> amplitude = GetCurrentAmplitude(sampleNumber); gain *= amplitude * Math.Min(currentValue, <span class="hljs-number"><span class="hljs-number">1</span></span> - currentValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DSPFunctions.Clamp01(currentValue + gain); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrentAmplitude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleNumber</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timePass = sampleNumber / Processor.SampleRate; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTime = _time + timePass; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sample = WaveGenerator.GenerateNextSample(OscillatorType.Value, Frequency.Value, currentTime); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sample; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MidiListenerOnNoteOn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, MidiListener.NoteEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MatchKey.Value) _time = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  The most important parameter in the LFO class is the reference / name of the modulated parameter.  To do this, you have to write the ParameterName class, which will display a list of possible parameters for modulating.  Inherited from IntegerParameter, the value of the parameter will mean the number in the sequence of parameters of the ParametersManager.  Reef - you need to specify the maximum value of the parameter - the total number of parameters that changes during the development process. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ParameterName</span></span> : <span class="hljs-title"><span class="hljs-title">IntegerParameter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ParametersManager _parametersManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParameterName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> parameterPrefix, ParametersManager parametersManager</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parameterPrefix + </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Num"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"LFO Parameter Number"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Num"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">34</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { _parametersManager = parametersManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromStringToValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameter = _parametersManager.FindParameter(s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (parameter == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : _parametersManager.GetParameterIndex(parameter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromValueToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) ? _parametersManager.GetParameter(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Name : <span class="hljs-string"><span class="hljs-string">"--"</span></span>; } }</code> </pre> <br><a name="Part7"></a><br><h2 id="interfeys-iparametermodifier-i-ispolzovanie-aktualnogo-znacheniya-parametra">  Interface IParameterModifier and the use of the current value of the parameter </h2><br><p>  Now the parameter class must determine if its modulation is possible.  In the synthesizer I encoded, a simple case is considered - there is one object of the LFO class, and no more than one parameter can be modulated. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IParameterModifier</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModifyRealValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleNumber</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  Since the parameter can be associated with a single IParameterModifier, let's make a link and the ParameterModifier property.  To get the current value, you need to use the ProcessedValue method instead of the Value property. To do this, pass the current sample number. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IParameterModifier _parameterModifier; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool CanBeAutomated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IParameterModifier ParameterModifier { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _parameterModifier; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_parameterModifier == value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_parameterModifier != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !CanBeAutomated) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new ArgumentException(<span class="hljs-string"><span class="hljs-string">"Parameter cannot be automated."</span></span>); _parameterModifier = value; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> double ProcessedRealValue(int sampleNumber) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_parameterModifier == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RealValue; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modifiedRealValue = _parameterModifier.ModifyRealValue(RealValue, sampleNumber); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> modifiedRealValue; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter where T : struct { ... public T ProcessedValue</span></span></span></span>(int sampleNumber) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FromReal(ProcessedRealValue(sampleNumber)); } ... }</code> </pre> <br><p>  Using the ProcessedValue method instead of Value makes programming a bit difficult due to the sampleNumber parameter that needs to be passed.  When I wrote the LFO class, I had to change the Value of the parameters in ProcessedValue in all classes.  Basically, the samples were processed in a loop, and transferring sampleNumber was not a big problem. </p><br><p>  In the LFO class, we make the ParameterName parameter change handler, and in it we need to change the ParameterModifier parameter to this. </p><br><div class="spoiler">  <b class="spoiler_title">LFO Class Code</b> <div class="spoiler_text"><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LFO</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SyntageAudioProcessorComponentWithParameters</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioProcessor</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IProcessor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IParameterModifier</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> double _time; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parameter _target; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterName</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerParameter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly ParametersManager _parametersManager; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ParameterName(string parameterPrefix, ParametersManager parametersManager) : base(parameterPrefix + <span class="hljs-string"><span class="hljs-string">"Num"</span></span>, <span class="hljs-string"><span class="hljs-string">"LFO Parameter Number"</span></span>, <span class="hljs-string"><span class="hljs-string">"Num"</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { _parametersManager = parametersManager; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> int FromStringToValue(string s) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameter = _parametersManager.FindParameter(s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (parameter == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : _parametersManager.GetParameterIndex(parameter); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> string FromValueToString(int value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (value &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) ? _parametersManager.GetParameter(value).Name : <span class="hljs-string"><span class="hljs-string">"--"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EnumParameter&lt;WaveGenerator.EOscillatorType&gt; OscillatorType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> FrequencyParameter Frequency { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BooleanParameter MatchKey { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RealParameter Gain { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntegerParameter TargetParameter { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LFO(AudioProcessor audioProcessor) : base(audioProcessor) { audioProcessor.PluginController.MidiListener.OnNoteOn += MidiListenerOnNoteOn; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IEnumerable&lt;Parameter&gt; CreateParameters(string parameterPrefix) { OscillatorType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnumParameter&lt;WaveGenerator.EOscillatorType&gt;(parameterPrefix + <span class="hljs-string"><span class="hljs-string">"Osc"</span></span>, <span class="hljs-string"><span class="hljs-string">"LFO Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"Osc"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); Frequency = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FrequencyParameter(parameterPrefix + <span class="hljs-string"><span class="hljs-string">"Frq"</span></span>, <span class="hljs-string"><span class="hljs-string">"LFO Frequency"</span></span>, <span class="hljs-string"><span class="hljs-string">"Frq"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); MatchKey = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BooleanParameter(parameterPrefix + <span class="hljs-string"><span class="hljs-string">"Mtch"</span></span>, <span class="hljs-string"><span class="hljs-string">"LFO Phase Key Link"</span></span>, <span class="hljs-string"><span class="hljs-string">"Match"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); Gain = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RealParameter(parameterPrefix + <span class="hljs-string"><span class="hljs-string">"Gain"</span></span>, <span class="hljs-string"><span class="hljs-string">"LFO Gain"</span></span>, <span class="hljs-string"><span class="hljs-string">"Gain"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); TargetParameter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParameterName(parameterPrefix, Processor.PluginController.ParametersManager); TargetParameter.OnValueChange += TargetParameterNumberOnValueChange; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Parameter&gt; {OscillatorType, Frequency, MatchKey, Gain, TargetParameter}; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Process(IAudioStream stream) { _time += Processor.CurrentStreamLenght / Processor.SampleRate; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> double ModifyRealValue(double currentValue, int sampleNumber) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gain = Gain.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DSPFunctions.IsZero(gain)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentValue; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> amplitude = GetCurrentAmplitude(sampleNumber); gain *= amplitude * Math.Min(currentValue, <span class="hljs-number"><span class="hljs-number">1</span></span> - currentValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DSPFunctions.Clamp01(currentValue + gain); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> double GetCurrentAmplitude(int sampleNumber) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timePass = sampleNumber / Processor.SampleRate; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTime = _time + timePass; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sample = WaveGenerator.GenerateNextSample(OscillatorType.Value, Frequency.Value, currentTime); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sample; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MidiListenerOnNoteOn(object sender, MidiListener.NoteEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MatchKey.Value) _time = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TargetParameterNumberOnValueChange(Parameter.EChangeType obj) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> number = TargetParameter.Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameter = (number &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) ? Processor.PluginController.ParametersManager.GetParameter(number) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_target != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _target.ParameterModifier = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _target = parameter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_target != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _target.ParameterModifier = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } }</code> </pre> </div></div><br><a name="Part8"></a><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  I consider the cycle of articles to be complete: I told about the most important (in my opinion, of course) components of the synthesizer: wave generation, envelope processing, filtering, effects, and modulation of parameters.  Programming in places was far from ideal, without optimizations - I wanted to write the code as clearly as possible.  An inquisitive researcher can take my code and experiment with it as much as I want ‚Äî I will only be glad of it!  There is a good site <a href="http://musicdsp.org/">musicdsp.org</a> with a large archive of source codes of various pieces of synthesis and sound processing, mostly in C ++, go for it! </p><br><p>  Thanks to all who are interested!  I'm sure my articles will be visible from Google and will help beginners to enter the world of music programming and signal processing.  Thank you for your comments, especially <a href="https://habrahabr.ru/users/refridgerator/" class="user_link">Refridgerator</a> . </p><br><p>  <em>All good!</em> <em><br></em>  <em>Good luck in programming!</em> </p><br><a name="Part9"></a><br><h2 id="spisok-literatury">  Bibliography </h2><br><p>  Do not forget to look at the lists of articles and books in previous articles. </p><br><ol><li>  <a href="http://buyguitar.narod.ru/electric_guitars_effects.html">Audio examples of famous effects</a> </li><li>  <a href="http://wikisound.org/%25D0%2594%25D0%25B8%25D1%2581%25D1%2582%25D0%25BE%25D1%2580%25D1%2588%25D0%25BD">wikisound.org/Distribution</a> </li><li>  <a href="http://www.earlevel.com/main/1997/01/19/a-bit-about-reverb/">A Bit About Reverb</a> </li><li>  <a href="http://musicdsp.org/archive.php">Sources of various DSP algorithms</a> </li><li>  <a href="http://unisonrecords.org/%25D1%2581%25D0%25BE%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B6%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5/%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D1%258C%25D0%25B8/20-%25D1%2581%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B2-%25D0%25BE/%25D0%25A1%25D0%25B0%25D0%25B9%25D0%25BC%25D0%25BE%25D0%25BD-%25D0%259B%25D0%25B0%25D1%2583%25D0%25B7%25D0%25B5%25D1%2580-%25D0%259F%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B2">Synthesizer Programming Tips</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/313338/">https://habr.com/ru/post/313338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313326/index.html">Game industry: useful materials for game development from A to Z</a></li>
<li><a href="../313328/index.html">A massive DDoS on the infrastructure of the DNS provider Dyn.com led to the inaccessibility of Twitter, Github, Heroku and other sites.</a></li>
<li><a href="../313330/index.html">Binary (file) storage, a terrible tale with a gloomy end</a></li>
<li><a href="../313332/index.html">Hello everyone, I am a webmaster and I was hacked</a></li>
<li><a href="../313334/index.html">Code examples in 39 esoteric programming languages</a></li>
<li><a href="../313340/index.html">Thematic modeling on the way to exploratory information search. Lecture in Yandex</a></li>
<li><a href="../313342/index.html">MikroTik. Correct dst nat when using 2 or more providers</a></li>
<li><a href="../313344/index.html">How to order and promote a mobile application: digest of useful materials</a></li>
<li><a href="../313346/index.html">Diary of a bug: how I repaired pictures in e-mail</a></li>
<li><a href="../313350/index.html">Lambda and anonymous classes: who eats more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>