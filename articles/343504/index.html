<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Slower, Smoother: Understanding React Fiber</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="September 16, 2017 React Fiber was released - a new major version of the library. In addition to adding new features that you can read about here , th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Slower, Smoother: Understanding React Fiber</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/e7b/7db/910/e7b7db910ab62c731271447da4bef369.png"></p><br><p>  September 16, 2017 React Fiber was released - a new major version of the library.  In addition to adding new features that you can read about <a href="https://reactjs.org/blog/2017/09/26/react-v16.0.html">here</a> , the developers rewrote the core architecture of the library.  As a React-developer, I decided to figure out what kind of beast this Fiber is, what tasks it solves, due to what and how you can finally apply this knowledge on the projects I work for at <a href="https://livetyping.com/ru/">Live Typing</a> .  Understood and came to ambiguous conclusions. </p><a name="habracut"></a><br><h2 id="stack-protiv-fiber">  Stack vs fiber </h2><br><p>  To understand what has changed in the new architecture, you need to understand the flaws of the old.  For example, consider the following demo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Qu_6ItnlDQg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  We have two components, the source code of which you can see <a href="https://gist.github.com/Muffassa/cbd0c727539147a282d7cff72a93a865">here.</a> The first component works on the old version of the architecture, which was called Stack, the second - with the help of Fiber.  The difference is noticeable to the naked eye: the animation of the second component works much smoother than the animation of the first. </p><br><p>  What causes the delay in the animation of the component implemented on the Stack?  Let's open the Performance tab in the browser and look at the Frames field, as well as at the time the SierpinskiTriangle function is executed (by this we mean the execution of the render method of the SierpinskiTriangle component).  In this function, the process of comparing the old and the new virtual tree takes place.  From how quickly this process is performed, the frequency of the frame change depends.  In this case, it is 700 ms, and that is a long time. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cf6/c9c/831/cf6c9c8319a49c201b78238222e1f135.png" alt="Stack"><br>  <em>Figure 1. Component running on the Stack core</em> </p><br><p>  From here we can conclude that the main problem of the old architecture was the long execution of the render method of the SierpinskiTriangle component.  It would hardly have been possible to speed it up due to some optimization of the algorithm itself. </p><br><p>  Figure 2 illustrates how React on the Fiber core renders a component.  We see that frames change with frequency once every 17 ms.  Roughly speaking, Fiber somehow breaks down a function that runs for a long time into small functions that are performed quickly. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/10a/ef1/dc6/10aef1dc6b1280111503a60d58849a84.png" alt="Fiber"><br>  <em>Figure 2. Component running on the Fiber core</em> </p><br><h2 id="fiber-v-teorii">  Fiber in theory </h2><br><p>  How does Fiber break up a function?  To do this, you must manage the process of performing this function, as well as provide the opportunity to: </p><br><ul><li>  prioritize different types of work; </li><li>  stop work; </li><li>  interrupt work if it is no longer needed; </li><li>  use previous calculations. </li></ul><br><p>  To implement the above, we need to determine how to divide the work of comparing the old and the new DOM trees into parts. </p><br><p>  If you look at React, then all components in it are functions.  And drawing a React application is a recursive function call from the youngest component to the most senior component.  We have already seen that if the function of changing our component takes a long time to work out, then there is a delay.  To solve this problem, we can use two methods that provide browsers: </p><br><ol><li>  requestIdleCallback, which allows you to perform calculations with low priority while the main browser thread is idle; </li><li>  requestAnimationFrame, which allows you to make a request to execute our animation in the next frame. </li></ol><br><p>  As a result, the plan is this: we need to calculate the part of the change of our interface by the requestIdleCallback event, and, as soon as we are ready to render the component, request the requestAnimationFrame in which this will happen.  But it is still necessary to somehow interrupt the execution of the function of comparing virtual trees and at the same time preserve intermediate results.  To solve this problem, the React developers decided to develop their version of the call stack.  Then they will have the opportunity to stop the execution of functions, independently give priority to the performance of functions that need it more, and so on. </p><br><p>  Reimplementation of the call stack within React components is the new Fiber algorithm.  The advantage of reimplementing the call stack is that you can store it in memory, stop and start it when you need it. </p><br><h2 id="fiber-na-praktike-poisk-chisla-fibonachchi">  Fiber in practice: finding the Fibonacci number </h2><br><h3 id="standartnaya-realizaciya-poiska">  Standard search implementation </h3><br><p>  The implementation of the Fibonacci number search using the standard call stack can be seen below. </p><br><pre><code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = fib(n - <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  First, let's analyze how the Fibonacci number search function is performed on a normal call stack.  As an example, we will look for the third number. </p><br><p>  So, a stack frame is created in the call stack, in which local variables and function arguments will be stored.  In this case, the stack frame will initially look like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/edd/f63/2bf/eddf632bf17c94734f7946860062da6b.png"></p><br><p>  Since  n&gt; 2, then we get to the next line: </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    var b = fib(n - 2); return a + b; } }</span></span></code> </pre> <br><p>  Here the function fib will be called again.  A new stack frame will be created, but n will already be one less, that is, 2. Local variables will still be undefined. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cad/bb9/026/cadbb90267d22f2421f114a50431daa7.png"></p><br><p>  And since  n = 2, then the function returns one, and we go back to line 5 </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    var b = fib(n - 2); return a + b; } }</span></span></code> </pre> <br><p>  The call stack looks like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/af5/f88/1bd/af5f881bd549ff0be69a9cac9600e31b.png"></p><br><p>  Next, the Fibonacci number search function is called for the variable b, line 6. A new stack frame is created: </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = fib(n - <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    return a + b; } }</span></span></code> </pre> <br><p>  The function, as in the previous case, returns 1. </p><br><p>  The stack frame looks like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d26/b1f/70d/d26b1f70d0db56f623b4b7bfbd468a88.png"></p><br><p>  Then the function returns the sum of a and b. </p><br><h3 id="realizaciya-poiska-na-fiber">  Implementing Fiber Search </h3><br><p>  Disclaimer: In this case, we have shown how the search for the Fibonacci number is performed with the reimplementation of the call stack.  A similar method is implemented by Fiber. </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fiberFibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { var fiber = { <span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>: n, returnAddr: null, a: <span class="hljs-number"><span class="hljs-number">0</span></span> /* b is tail call */ }; rec: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fiber.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { var sum = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (fiber.returnAddr) { fiber = fiber.returnAddr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fiber.a === <span class="hljs-number"><span class="hljs-number">0</span></span>) { fiber.a = sum; fiber = { <span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>: fiber.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>, returnAddr: fiber, a: <span class="hljs-number"><span class="hljs-number">0</span></span> }; continue rec; } sum += fiber.a; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fiber = { <span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>: fiber.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>, returnAddr: fiber, a: <span class="hljs-number"><span class="hljs-number">0</span></span> }; } } }</code> </pre> <br><p>  Initially, we create a variable fiber, which in our case is a stack frame.  arg is the argument of our function, returnAddr is the return address, a is the value of the function. </p><br><p>  Since  fiber.arg in our case is 3, which is more than 2, then we go to line 17, </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fiberFibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fiber = { arg: n, returnAddr: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, a: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/* b is tail call */</span></span> }; rec: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fiber.arg &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sum = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (fiber.returnAddr) { fiber = fiber.returnAddr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fiber.a === <span class="hljs-number"><span class="hljs-number">0</span></span>) { fiber.a = sum; fiber = { arg: fiber.arg - <span class="hljs-number"><span class="hljs-number">2</span></span>, returnAddr: fiber, a: <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> rec; } sum += fiber.a; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fiber = { arg: fiber.arg - <span class="hljs-number"><span class="hljs-number">1</span></span>, returnAddr: fiber, a: <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//  17 } } }</span></span></code> </pre> <br><p>  where we create a new fiber (stack frame).  In it, we save the reference to the previous stack frame, the argument is one less and the initial value of our result.  Thus, we recreate the call stack, which we created when recursively calling the usual function of searching for the Fibonacci number. </p><br><p>  Then we iterate backwards on our stack and count our Fibonacci number.  lines 7-15. </p><br><pre> <code class="hljs axapta">var <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (fiber.returnAddr) { fiber = fiber.returnAddr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fiber.a === <span class="hljs-number"><span class="hljs-number">0</span></span>) { fiber.a = <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>; fiber = { arg: fiber.arg - <span class="hljs-number"><span class="hljs-number">2</span></span>, returnAddr: fiber, a: <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> rec; } <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> += fiber.a; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>;</code> </pre> <br><h2 id="vyvod">  Conclusion </h2><br><p>  Has React become faster after deploying Fiber?  According to this <a href="http://jsbin.com/muzaxehedi/edit%3Fjs,console">test</a> , no.  He became even slower about 1.5 times.  But the introduction of the new architecture made it possible to use the main stream of the browser more rationally, due to which the work of animations became smoother. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343504/">https://habr.com/ru/post/343504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343494/index.html">Investors reduced Uber's financial valuation by $ 18.5 billion after a series of scandals and hacker attacks</a></li>
<li><a href="../343496/index.html">Setting the user interface when installing applications on nanoCAD Plus 8.5</a></li>
<li><a href="../343498/index.html">Basics of information security. Part 2. Information and means of its protection</a></li>
<li><a href="../343500/index.html">Kotlin 1.2: common code for JVM and JavaScript</a></li>
<li><a href="../343502/index.html">Google, Softline, GDG and #tceh organize the second ‚ÄúGoogle Cloud Developer Meetup‚Äù</a></li>
<li><a href="../343506/index.html">MSA and more: how we create high-load services for the bank</a></li>
<li><a href="../343508/index.html">Yes, PVS-Studio can detect memory leaks</a></li>
<li><a href="../343510/index.html">Olympiad "I am a professional" track "Information and cyber security"</a></li>
<li><a href="../343512/index.html">Is it possible to push number recognition in any tamagotchi?</a></li>
<li><a href="../343514/index.html">Face Recognition. Create and try on masks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>