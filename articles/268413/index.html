<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Three days that shook us in 2013</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúIf you have doubts whether this is an accident or not, then this is an accident!‚Äù 
 (c) Wisdom of the ancestors 

 Big failures in online projects ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Three days that shook us in 2013</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/cf4/880/a8f/cf4880a8f9a6402c9d4aef8ecc19ed50.jpeg"></div><br><br>  <i>‚ÄúIf you have doubts whether this is an accident or not, then this is an accident!‚Äù</i> <br>  <i>(c) Wisdom of the ancestors</i> <br><br>  Big failures in online projects are rare.  And in large projects - even less.  Of course, the more complex the system, the higher the probability of error.  One hour of downtime for large systems, especially social networks, is expensive, and therefore large projects make a lot of efforts to prevent accidents and reduce the negative effect on users.  But sometimes either the stars add up to a special combination, or <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25BD_%25D0%259C%25D0%25B5%25D1%2580%25D1%2584%25D0%25B8">Murphy's law</a> takes on real power, and big accidents do occur.  In the history of Odnoklassniki, the largest failure occurred on April 4, 2013: for three days the project was wholly or partially inoperable.  About what happened then, for what reasons and how we struggled with this, there will be our story. <br><a name="habracut"></a><br><h3>  <font color="#f07d00">1. What happened?</font> </h3><br>  One evening, the monitoring system recorded a minor problem with one of the servers.  To fix it, you had to fix the configuration template.  The administrator on duty asked for help from a colleague who developed this template.  It turned out that it was necessary only to add one small line of code, in the image and likeness of the previous ones.  The administrator made the necessary corrections and sent the file to production. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Soon the messages about failures on different servers fell down, their number quickly grew.  The attendants immediately raised the log and suggested that the whole thing was a modified configuration template.  Naturally, the changes immediately tried to roll back, returning the original version of the template to the servers.  However, by that time, all Linux machines, which then made up most of the Odnoklassniki server park, had already failed.  So began the longest three days. <br><br>  A follow-up analysis in hot pursuit helped to establish the cause of the avalanche-like failure that paralyzed all subsystems. <br><br><ul><li>  At that time, we used the old version of openSUSE and, as a result, the old version of bash out of the box.  Zabekportit changes we needed looked easier than updating to a new branch (now bash has been updated to a new branch, which required fixing the syntax of some system and our scripts).  In the process of backporting, an error was made that manifested itself only with the next change of the configuration template, common to all servers. </li><li>  The developer who created and tested the template worked in a text editor that does not automatically add a newline at the end of the file. </li><li>  But the duty administrator of the rules is the template file in another editor, which placed this symbol at the end of the file. </li><li>  It turned out that in our centralized management system (CFEngine) there was a <a href="https://dev.cfengine.com/issues/1900">bug</a> , because of which a line break character is always added to the edited file.  The result is two hyphenation characters in a row ‚Äî an empty line at the end of the file. </li><li>  In the code we modified, bash turned out to be another bug, due to which the interpreter, upon detecting an empty line at the end of the configuration file, entered into an infinite loop and stopped responding to external commands. </li></ul><br>  As you know, the command interpreter is used in a variety of operations, including during the execution of service scripts.  The bash processes launched on the servers immediately went in cycles and swiftly absorbed the available computing resources of the machines.  As a result, the servers quickly reached the maximum load.  But it was still half the trouble.  The fact is that bash was also used by the centralized control system.  Therefore, overloaded servers in addition stopped responding to any external commands.  We could not log in to them, and within a very short period of time about 5,000 servers ceased to function. <br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br>  <i>What will you do if your centralized management system fails?</i>  <i>And if at the same time it will not be possible to log in to the server?</i> <br></blockquote><br><br><h3>  <font color="#f07d00">2. Three days of recovery</font> </h3><br>  Unfortunately, it was impossible to restore the system to work just by restarting the servers.  This is due to the architecture of the portal. <br><br><h4>  <font color="#f07d00">2.1.</font>  <font color="#f07d00">Interconnection subsystems</font> </h4><br>  Classmates consist of approximately 150 subsystems (various databases, business logic servers, caches, graphs, frontends, configuration systems, etc.).  And the performance of almost every subsystem depends on the availability of others.  If the servers are chaotically restarted, then it is possible to disrupt the work of not only one specific subsystem, but also many other related subsystems. <br><br>  An example of connections between subsystems: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ac0/744/1a9/ac07441a909d4f299238071787aee7a4.jpg"></div><br><br>  Something like a classic: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7fb/543/29d/7fb54329daa44ae0aba2d752bc13487f.jpg"></div><br><br>  The fact is that the development and changes in the project architecture did not create a scenario in which the entire server cluster could fail at the same time.  In the code of some subsystems, there was no mechanism for starting and operating under conditions of complete unavailability of some related components.  It was assumed that all systems will work at least partially due to duplication of functionality and the use of backup machines. <br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br>  <i>Do you have a mechanism for starting services in the event that all or part of interconnected subsystems are inoperable?</i> <br></blockquote><br><br><h4>  <font color="#f07d00">2.2.</font>  <font color="#f07d00">Server restart</font> </h4><br>  In order to launch the main subsystems at the same time, at first it was necessary to restore a small number of servers: the service ones and those needed to start one or another service.  This made it possible to gradually restore the work of services dependent on it, then others, etc.  As far as possible, duplicate servers were raised from non-existence for the most critical services. <br><br>  As you remember, it was necessary to revive about 5,000 cars.  It was impossible to reload them remotely and download over the network, since many were simply not configured for this.  This was the result of a once chosen approach to building infrastructure.  After all, Classmates did not deploy several thousand servers from scratch at the same time - the park gradually grew over several years.  Therefore, we had to manually reboot thousands of servers and allow the BIOS to control the network to automate the recovery. <br><br>  Initially, on some servers it was possible to ‚Äúreach the bootstrap‚Äù - get a description of the cluster and find out exactly where certain data is stored in it.  While the servers were not restarted, they very slowly, but still gave the configuration, and it was possible to start some services.  With the acceleration of the recovery process, we had to restart these servers.  But for the start or normal operation of each subsystem it is necessary that other related subsystems are available.  Because of the reset, access to the description of some clusters and the ability to start many subsystems was lost.  Those that could be running, have not started.  And those who worked, stopped working, and had to re-restore them. <br><br>  Another problem was related to hard drives.  If they work for a long time without stopping under a high load, then they often fail when shut down.  It is with this phenomenon that we encountered.  Therefore, we had to regularly replace failed disks and restore database consistency.  There were even cases when disks with a working copy and its backup failed.  And the servers were in different data centers.  So it coincided. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cd6/159/38f/cd615938f6034ef98b098a32b8743855.png"></div><br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br><ul><li>  <i>Are your servers configured for remote restart?</i> </li><li>  <i>How secure is your data backup system?</i> </li></ul><br></blockquote><br><br><h4>  <font color="#f07d00">2.3.</font>  <font color="#f07d00">Data recovery</font> </h4><br>  It was necessary to restore backups, making in them the accumulated transaction logs, then to deploy working copies and start services.  We were unable to restore the entire backup of one of the databases.  Then we simultaneously launched a new storage cluster, into which we transferred the missing data, collecting them from other subsystems, where they were stored for some minor needs.  First, we figured out where and what to look for, then changed the logic of the services, wrote scripts for data transfer, configured a new cluster, transferred data ... In the end, we completely recovered all the lost information. <br><br><h4>  <font color="#f07d00">2.4.</font>  <font color="#f07d00">Starting services</font> </h4><br>  After the servers were restarted, we sent a set of scripts to them to start the OS and remove that hapless empty line from the configuration template.  In parallel with writing and testing scripts, we manually restored servers around the clock.  Not only the Odnoklassniki team was involved in this work, but also employees from other projects. <br><br>  If, after the server restart, the hardware and file system did not fail, the scripts brought the service to a working state.  If, due to dependencies on other subsystems, the service could not be started, it was necessary to edit the code.  If this did not help, they understood and looked for a solution.  Fortunately, a significant amount of data and services was already distributed between data centers and we needed to revive only the part necessary for recovery. <br><br>  Monitoring and statistics systems are widely used in Internet projects, and such a large project as Odnoklassniki is no exception.  Constantly monitored a huge number of parameters relating to both the correct operation of equipment and applications, and user behavior.  During the elimination of the accident due to too many failures, information was collected slowly or not at all - attempts to connect monitors to many servers ended in timeouts.  As a result, the monitors marked the servers that had been fixed long ago as failed, and vice versa - they considered the non-working servers to be working, as they were not yet reached the turn in question by the monitor.  Often, monitoring systems failed at all.  We could not get current data on the status of servers and find out if the applications are working correctly.  Therefore, we had to do manual checks, which took extra time <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b6/92b/1ef/1b692b1efd38417da2a032d244a8b7c8.jpg"></div><br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br>  <i>Do you use the distribution of data and services across different data centers?</i>  <i>How much does this increase resistance to failure?</i> <br></blockquote><br><br><h4>  <font color="#f07d00">2.5.</font>  <font color="#f07d00">Completion of recovery</font> </h4><br>  From the very beginning, we drew up a recovery plan, outlining the sequence of work.  All procedures performed during the recovery process have been documented.  The work of the people was coordinated, and when someone completed the next task, he was given the following.  The assignment of tasks was carried out on the basis of the current situation and the operational plan.  That is, the process was manageable, but only in part.  I had to improvise a lot. <br><br>  Restoration of primary operability, when the portal began to at least load and earned some of the functionality, took about a day. <br><br>  The accident occurred on Thursday evening, and on Sunday morning we fully restored the work of the portal. <br><br><h3>  <font color="#f07d00">3. Learning lessons</font> </h3><br><h4>  <font color="#f07d00">3.1.</font>  <font color="#f07d00">Incident management</font> </h4><br>  In Odnoklassniki, as in many other projects, incident management is applied.  That is, all emergency situations are recorded and divided into categories: <br><br><ul><li>  bug in our code </li><li>  configuration errors </li><li>  hardware failure </li><li>  employee erroneous actions </li><li>  failures on the side of our partners: payment aggregators, telecom operators, data centers, etc. </li></ul><br><br>  To eliminate the causes and consequences of the incident immediately assigned a performer. <br>  Separately understand incidents that have serious consequences for users or potentially capable of it.  This allows you to detect suspicious trends (for example, an increase in the number of failures of a category), to prevent major accidents, and also to greatly reduce the negative effect of failures. <br><br>  Serious accidents have happened before.  For example, in 2012 Odnoklassniki did not work for several hours due to the unavailability of one of the data centers due to a fire in the communication collector.  After that, we set ourselves a global goal: our portal must be fully operational in case of loss of any of the data centers.  We will reach this goal soon. <br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br>  <i>Will your service be available:</i> <br><ul><li> <i>at failure of several servers?</i> </li><li>  <i>one or more subsystems?</i> </li><li>  <i>one of the data centers?</i> </li><li>  <i>How do you work with incidents?</i> </li></ul><br></blockquote><br><br>  But we were not ready for an accident of this scale.  Nobody thought that all servers would become inaccessible and that such complicating circumstances would arise. <br>  After the accident, we analyzed the sequence and progress of all restoration work: <br><br><ul><li>  how long did it take </li><li>  what difficulties arose and why </li><li>  how they were solved </li><li>  why some decisions were made. </li></ul><br><h4>  <font color="#f07d00">3.2.</font>  <font color="#f07d00">Changes in infrastructure, monitoring and management</font> </h4><br>  According to the results of the analysis, a plan of necessary works was drawn up, in which various accidents are foreseen.  To date, we have done the following: <br><br><ul><li>  <b>Completed the process of replacing unreliable storage systems (hereinafter referred to as storage systems) based on <a href="http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/overview/index.html">Berkeley DB</a></b> .  Since Odnoklassniki was founded, similar systems have been used to store large binary data and key value for various small business entities.  This storage system was characterized by many shortcomings.  For example, due to the specifics of the Single Master replication architecture, changes were periodically lost when the master failed, and sometimes when its replica failed.  Also during the accident, it turned out that the recovery procedure from backups is very slow and unreliable.  At the moment, the transition to systems based on <a href="http://cassandra.apache.org/">Cassandra</a> and <a href="http://www.project-voldemort.com/">Voldemort has been completed</a> . </li><li>  <b>Implemented an autonomous centralized server management system via <a href="https://en.wikipedia.org/wiki/Intelligent_Platform_Management_Interface">IPMI</a> .</b>  Now it‚Äôs enough to manage the servers so that they have power and network access to IPMI. </li><li>  <b>Increased reliability and accuracy of monitoring systems.</b>  After the accident, we disassembled the work of all monitoring systems and did the following: <br>  - completely rewritten the scripts to improve the stability of the work, <br>  - reduced timeouts checks, <br>  - introduced dependencies of application checks on the availability of servers over the network, <br>  - updated software, <br>  - changed active checks to passive ones and made many other changes. </li><li>  <b>Implemented protection against configuration changes on all servers.</b>  Now changes can be automatically applied only in one of the data centers and only during working hours. </li></ul><br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br><ul><li>  <i>How long have you been restoring data from a backup and how long did it take?</i> </li><li>  <i>Do you have the ability to remotely manage all servers?</i> </li><li>  <i>Is your monitoring system able to function correctly in the event of a full-scale accident?</i> </li><li>  <i>Is it physically possible to disrupt all servers in a short period of time by a single configuration change?</i> </li></ul><br></blockquote><br><br><h4>  <font color="#f07d00">3.3.</font>  <font color="#f07d00">Changes on the portal</font> </h4><br><ul><li>  <b>Changed the procedure for making changes to the configuration on production.</b>  Entered forced verification of all changes by another employee.  Testing any changes now passes through more environments: <br>  - unstable (virtuals where you can ‚Äúhack it out with an ax‚Äù), <br>  - testing (with a full set of service systems, but not in production), <br>  - stable (a dedicated group of hundreds of production servers of various types) <br>  - and then in production, separately for data centers. </li><li>  <b>Determined the mandatory types of tests that are exposed to new service systems or modified service components</b> (load, integration, fault tolerance, etc.), and supplemented them with examples. </li><li>  <b>Redid service systems and network, taking into account additional emergency scenarios.</b> </li><li>  <b>Reduced dependence on infrastructure, added duplication, organized emergency access.</b> </li><li>  <b>Fixed dependencies that prevented the launch of applications and implemented testing of service failures.</b>  Now, on an ongoing basis, the functionality is checked when the subsystems completely fail.  Also introduced "knife switches" that allow forcibly disable services. </li></ul><br>  <i><b>Questions for self-test:</b></i> <br><ul><li>  <i>How do you build a procedure for checking and testing changes made to production?</i> </li><li>  <i>How prone are your service and work tools infrastructure failures?</i> </li></ul><br><h4>  <font color="#f07d00">3.4.</font>  <font color="#f07d00">Accident Plan</font> </h4><br>  One of the main problems for us was the lack of an action plan for such a large-scale accident.  We developed it based on the results of the analysis of the restoration work.  What is included in the plan: <br><br><ol><li>  <b>Checklist for the monitoring team with a list of responsible persons</b> to be contacted and their contact details. </li><li>  <b>Distribution of roles and responsibilities:</b> <br><ul><li>  what employees are involved in the elimination of the accident, </li><li>  what areas of responsibility should be distributed and by whom, </li><li>  who is the coordinator </li><li>  who is responsible for preparing the operational plan, </li><li>  who is responsible for periodic general information on the status of the fix, </li><li>  who, why and how can take on roles - this applies both to the repair itself, and subsequent analysis and possible actions after the accident. </li></ul></li><li>  <b>Checklist on the restoration of services</b> : what to repair, in what order and how.  Here are defined lists of priority services and the order of their restoration;  lists of tools and systems that need to be monitored;  links to instructions and information on what to do if something went wrong. </li><li>  <b>Separate instructions for the person performing the role of coordinator.</b>  The manager of the accident elimination process should assess the scale, plan, provide the necessary information to the higher management, delegate, control, attract additional resources, record the necessary information and organize the analysis of the incident. </li><li>  <b>Separate instructions for the case of falling data center.</b>  It defines a list of specific actions in case of the fall of one of the data centers. </li><li>  <b>Rules of interaction with partners.</b>  Here, the ways of communication and the distribution of roles on our part when interacting with partners, as well as the levels of interaction with them: <br><ul><li>  Informational - in which case we limit ourselves to informing only. </li><li>  Resource mobilization - in which case we massively mobilize resources on the side of a partner or on our side. </li><li>  Working group - in which case we create a working group with the participation of partners and who participates in it. </li></ul></li></ol><br>  ‚ÄúEmergency‚Äù action plans should be tested regularly.  The importance of this procedure is difficult to overestimate.  If you do not, then after a few months your plan will become obsolete.  And when a problem arises one day, your actions either do not improve the situation or aggravate.  Therefore, we review our action plans every quarter, and sometimes more often, if we need to train new employees.  Each time it turns out that it is necessary to make some adjustments due to server migration, starting and closing microservices, changes in the operating system and monitoring systems, etc. <br><br><blockquote>  <i><b>Questions for self-test:</b></i> <br>  <i>Do you have plans for accidents of varying degrees of severity?</i>  <i>What will you do if all the data centers where your servers are located will be completely unavailable?</i> <br></blockquote><br><br><h3>  <font color="#f07d00">A couple of words in conclusion</font> </h3><br>  Provide all the events and failures in such a complex system, which are Odnoklassniki, impossible.  However, the project architecture, protection systems and all sorts of planned procedures allow us to retain most of the functionality and all the data in the event of a complete failure of any of our data centers.  Moreover, in the near future, even the fall of the data center will not be able to affect the operation of our portal. </div><p>Source: <a href="https://habr.com/ru/post/268413/">https://habr.com/ru/post/268413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268401/index.html">Natural Language Programming Instructions or Intentional Programming</a></li>
<li><a href="../268403/index.html">HackerSIM: small explanation (comment)</a></li>
<li><a href="../268405/index.html">Fractal bush from beginner for beginners</a></li>
<li><a href="../268409/index.html">Add system call. Part 4 and last</a></li>
<li><a href="../268411/index.html">Translation: One year with Go</a></li>
<li><a href="../268417/index.html">ANVE.ru - best friend of suppliers and dealers</a></li>
<li><a href="../268419/index.html">We received GOLD for the operation of the data center TIER III - the final progress after T-III for the project and T-III for the finished object</a></li>
<li><a href="../268421/index.html">USB killer v2.0</a></li>
<li><a href="../268423/index.html">About UEFI security, part final</a></li>
<li><a href="../268425/index.html">3D scanning using Intel RealSense</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>