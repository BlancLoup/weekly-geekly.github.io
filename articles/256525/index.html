<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the Haiku operating system (BeOS family) with PVS-Studio. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the final article on validating the Haiku operating system. In the first article were collected possible errors of various types of diagnostic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the Haiku operating system (BeOS family) with PVS-Studio. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b5c/a3f/a72/b5ca3fa729424a862852e149dc855578.png" align="left"><br>  This is the final article on validating the Haiku operating system.  In the <a href="http://habrahabr.ru/company/pvs-studio/blog/256347/">first article</a> were collected possible errors of various types of diagnostics, but one way or another connected with the verification of conditions.  This article will present the remaining analyzer warnings, which I would like to talk about.  The collected examples are divided into several groups. <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1530">Haiku</a> is a free operating system for personal computers that is aimed at binary compatibility with the BeOS operating system.  Haiku embodies the basic ideas of BeOS.  This is a modular system, architecturally designed as a hybrid core: a microkernel architecture that can dynamically load the necessary modules. <br><br>  The project was tested at the request of the Haiku user community with the help of <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio 5.24</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  Working with strings </h2><br>  <a href="http://www.viva64.com/ru/d/0116/">V527</a> It is odd that the '\ 0' value is assigned to the 'char' type pointer.  Probably meant: * scratchPtr = '\ 0'.  TextGapBuffer.cpp 228 <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* TextGapBuffer::Text() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* realText = RealText(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fPasswordMode) { .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* scratchPtr = fScratchBuffer; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numChars; i++) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(scratchPtr, B_UTF8_BULLET, bulletCharLen); scratchPtr += bulletCharLen; } scratchPtr = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== return fScratchBuffer; } return realText; }</span></span></code> </pre> <br>  Most likely, after working with a string, we wanted to write a terminal zero to the end of the string, rather than nullifying the pointer.  The correct option is: "* scratchPtr = '\ 0';". <br><br>  <a href="http://www.viva64.com/ru/d/0328/">V692</a> An inappropriate attempt to make a string.  To determine the correct length of the string st.  PoorManWindow.cpp 254 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PoorManWindow::MessageReceived(BMessage* message) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inet_ntop(AF_INET, &amp;sin_addr, addr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(addr)) != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>){ addr[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(addr)] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== line &lt;&lt; '(' &lt;&lt; addr &lt;&lt; ") "; } .... }</span></span></code> </pre> <br>  To write a <a href="http://www.viva64.com/ru/t/0088/">terminal zero</a> to the end of the line, the strlen () functions were used here, but the result of such an action is unpredictable, because for the operation of the strlen () function, the line should already end with a terminal zero.  Zero will be written just in the cell where it was found 0. In this case, the function strlen () can go far beyond the buffer, which will lead to undefined program behavior.  To fix the code, you need to calculate the length of the string in some other way. <br><br><h2>  Bad cycles </h2><br>  <a href="http://www.viva64.com/ru/d/0118/">V529</a> Odd semicolon ';'  after 'for' operator.  ringqueue.cpp 39 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compute_order</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> order; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> tmp; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (order = <span class="hljs-number"><span class="hljs-number">0</span></span>, tmp = size; tmp &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; ++order); <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (size &amp; ~(1 &lt;&lt; order)) ++order; return order; }</span></span></code> </pre> <br>  Something is wrong with this function: a loop without a body due to a semicolon at the end;  formatting the code indicates that the condition must be in the body of the loop.  On the other hand, the variable 'tmp' will not be used anywhere else. <br><br>  Maybe they wanted to do this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compute_order</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> order; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> tmp; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (order = <span class="hljs-number"><span class="hljs-number">0</span></span>, tmp = size; tmp &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; ++order) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmp &amp; ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; order)) ++order; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> order; }</code> </pre> <br>  But changing the for (;;) loop counter in the body is not a very good style. <br><br>  <a href="http://www.viva64.com/ru/d/0124/">V535</a> The variable 'k' is being used for the loop.  Check lines: 3598, 3610. rules.c 3610 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">solver_get_unneeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Solver *solv, Queue *unneededq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filtered)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dep_possible(solv, *dp, &amp;installedm)) { Queue iq; Id iqbuf[<span class="hljs-number"><span class="hljs-number">16</span></span>]; queue_init_buffer(&amp;iq, iqbuf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(iqbuf)/<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*iqbuf)); dep_pkgcheck(solv, *dp, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;iq); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; iq.count; k++) <span class="hljs-comment"><span class="hljs-comment">//&lt;== { Id p = iq.elements[k]; Solvable *sp = pool-&gt;solvables + p; if (....) continue; for (j = 0; j &lt; count; j++) if (p == unneededq-&gt;elements[j]) break; /* now add edge from j + 1 to i + 1 */ queue_insert(....); /* addapt following edge pointers */ for (k = j + 2; k &lt; count + 2; k++) //&lt;== edges.elements[k]++; } queue_free(&amp;iq); } .... }</span></span></code> </pre> <br>  The code is so badly formatted that if there is an error, then it was definitely made because of this.  Bad style to use one counter in nested loops for (;;). <br><br>  Similar place: <ul><li>  V535 The variable 'i' is being used for the loop.  Check lines: 2319, 2349. solver.c 2349 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0251/">V634</a> The operation of the operation is higher than that of the operation.  It's possible that parentheses should not be used in the expression.  RAW.cpp 1141 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DCRaw::_WaveletDenoise() { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; dim * <span class="hljs-number"><span class="hljs-number">2</span></span>); i++) { <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (fimg[i] &lt; -fThreshold) fimg[i] += fThreshold; else if (fimg[i] &gt; fThreshold) fimg[i] -= fThreshold; else fimg[i] = 0; } .... }</span></span></code> </pre> <br>  The multiplication operation takes precedence over shear.  It is not known how it was planned to do here, so it is necessary to check and determine the order of operations using round brackets for clarity in the future. <br><br>  Similar place: <ul><li>  V634 The operation of the operation is higher than that of the operation.  It's possible that parentheses should not be used in the expression.  RAW.cpp 1099 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0334/">V696</a> The 'continue' operator will terminate 'do {...} while (FALSE)' loop because the condition is always false.  Check lines: 1939, 1945. Roster.cpp 1939 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> BRoster::_LaunchApp(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-comment"><span class="hljs-comment">// find the app .... if (appType.InitCheck() == B_OK &amp;&amp; appType.GetAppHint(&amp;hintRef) == B_OK &amp;&amp; appRef == hintRef) { appType.SetAppHint(NULL); // try again continue; } ... } while (false); .... }</span></span></code> </pre> <br>  The 'continue' operator in the ‚Äúdo {...} while (...)‚Äù loop goes to the calculation of the condition for stopping the loop, and it is always false ‚Äî in fact, this is an unconditional exit from the loop and the ‚Äútry again‚Äù comment, it turns out, is just misleading . <br><br>  <a href="http://www.viva64.com/ru/d/0347/">V706</a> Suspicious division: sizeof (kBaudrates) / sizeof (char *).  Size of each element in the kBaudrates array does not equal to divisor.  SerialWindow.cpp 162 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SerialWindow::kBaudrates[] = { <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, .... }; SerialWindow::SerialWindow() : .... { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(kBaudrates) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*); --i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>;)<span class="hljs-comment"><span class="hljs-comment">//&lt;== { message = new BMessage(kMsgSettings); message-&gt;AddInt32("baudrate", kBaudrateConstants[i]); char buffer[7]; sprintf(buffer, "%d", kBaudrates[i]); //&lt;== BMenuItem* item = new BMenuItem(buffer, message); fBaudrateMenu-&gt;AddItem(item); } .... }</span></span></code> </pre> <br>  To get the number of elements in the array 'kBaudrates', for some reason, divide its size by the size of the pointer, in the end it turns out that in the 32-bit system the whole array will be indexed, and in the 64-bit system - only half. <br><br><h2>  Arrays </h2><br>  <a href="http://www.viva64.com/ru/d/0138/">V548</a> Consider reviewing type casting.  TYPE X [] [] in not equivalent to TYPE ** X.  RAW.cpp 1668 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DCRaw::_AdobeCoefficients(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *make, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *model) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefix; <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> black, trans[<span class="hljs-number"><span class="hljs-number">12</span></span>]; } table[] = { { <span class="hljs-string"><span class="hljs-string">"Canon EOS D2000"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { <span class="hljs-number"><span class="hljs-number">24542</span></span>,<span class="hljs-number"><span class="hljs-number">-10860</span></span>,<span class="hljs-number"><span class="hljs-number">-3401</span></span>,<span class="hljs-number"><span class="hljs-number">-1490</span></span>,<span class="hljs-number"><span class="hljs-number">11370</span></span>,<span class="hljs-number"><span class="hljs-number">-297</span></span>,<span class="hljs-number"><span class="hljs-number">2858</span></span>,<span class="hljs-number"><span class="hljs-number">-605</span></span>,<span class="hljs-number"><span class="hljs-number">3225</span></span> }}, { <span class="hljs-string"><span class="hljs-string">"Canon EOS D6000"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { <span class="hljs-number"><span class="hljs-number">20482</span></span>,<span class="hljs-number"><span class="hljs-number">-7172</span></span>,<span class="hljs-number"><span class="hljs-number">-3125</span></span>,<span class="hljs-number"><span class="hljs-number">-1033</span></span>,<span class="hljs-number"><span class="hljs-number">10410</span></span>,<span class="hljs-number"><span class="hljs-number">-285</span></span>,<span class="hljs-number"><span class="hljs-number">2542</span></span>,<span class="hljs-number"><span class="hljs-number">226</span></span>,<span class="hljs-number"><span class="hljs-number">3136</span></span> }}, .... }; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> cameraXYZ[<span class="hljs-number"><span class="hljs-number">4</span></span>][<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> table / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> *table; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!strncasecmp(model, table[i].prefix, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(....))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table[i].black) fMeta.black = table[i].black; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32 j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">12</span></span>; j++) { ((<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>**)cameraXYZ)[<span class="hljs-number"><span class="hljs-number">0</span></span>][j] = table[i].trans[j] /<span class="hljs-number"><span class="hljs-number">10000.0</span></span>; } _CameraXYZCoefficients(cameraXYZ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre> <br>  The array 'cameraXYZ', declared as ‚Äúdouble cameraXYZ [4] [3]‚Äù, is converted to the type ‚Äúdouble **‚Äù.  This type conversion most likely does not make sense and may lead to errors. <br><br>  The types ‚Äútype [a] [b]‚Äù and ‚Äútype **‚Äù are different data structures.  Type [a] [b] is a single piece of memory with which you can work as a two-dimensional array.  Type ** is an array of pointers to some areas of memory. <br><br>  <a href="http://www.viva64.com/ru/d/0145/">V554</a> Incorrect use of auto_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  DefaultCatalog.cpp 208 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> DefaultCatalog::ReadFromFile(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path) { .... <span class="hljs-built_in"><span class="hljs-built_in">auto_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; buf(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::nothrow) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> [sz]); .... }</code> </pre> <br>  The analyzer detected a situation where the use of a smart pointer could lead to undefined behavior.  The 'auto_ptr' class is not designed to work with arrays, it uses the 'delete' operator to free memory, and if you specify 'delete []', the code will not compile. <br><br>  Correct code example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> DefaultCatalog::ReadFromFile(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path) { .... <span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[]&gt; buf(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::nothrow) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[sz]); .... }</code> </pre> <br>  Another place: <ul><li>  V554 Incorrect use of auto_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  DefaultCatalog.cpp 249 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0148/">V557</a> Array overrun is possible.  The '8' index is pointing beyond array bound.  floppy_ctrl.c 637 <br>  V557 Array overrun is possible.  The '9' index is pointing beyond array bound.  floppy_ctrl.c 638 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">floppy</span></span></span><span class="hljs-class"> {</span></span> .... uint8 result[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* status of the last finished command */</span></span> .... }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">floppy_dump_reg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">floppy_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *flp)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">//uint8 result[10]; //&lt;== This was correct! uint8 *result = flp-&gt;result; //&lt;== Bad fix! :) .... dprintf(FLO "gap=%d wg=%d eis=%d fifo=%d poll=%d thresh=%d pretrk=%d\n", (result[7] &amp; 0x02) &gt;&gt; 1, result[7] &amp; 0x01, (result[8] &amp; 0x40) &gt;&gt; 6, (result[8] &amp; 0x20) &gt;&gt; 5, (result[8] &amp; 0x10) &gt;&gt; 4, result[8] &amp; 0x0f, result[9]); .... }</span></span></code> </pre> <br>  Two analyzer warnings indicate an out of bounds array.  Judging by the commented code, earlier the 'result []' array consisted of 10 elements, and after editing it became 8 elements long.  In this case, the code still accesses ten elements of the array with indices from 0 to 9. <br><br><h2>  Variable names </h2><br>  <a href="http://www.viva64.com/ru/d/0302/">V672</a> There is probably no need to create the new 'path' variable here.  This argument is a reference.  Check lines: 348, 429. translate.cpp 429 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> Translator::FindPath(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> translation_format *format, BPositionIO &amp;stream, TypeList &amp;typesSeen, TypeList &amp;path, ....) { .... TypeList path; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> quality; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FindPath(...) == B_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bestQuality &lt; quality * formatQuality) { bestQuality = quality * formatQuality; bestPath.SetTo(path); bestPath.Add(formats[j].type); status = B_OK; } } .... }</code> </pre> <br>  The coincidence of the name of the local variable 'path' with the function parameter (especially with the link, as in this case) can lead to the loss of local changes in this variable and other logical errors. <br><br>  It is a variable in this loop.  ipv4.cpp 514 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dump_ipv4_multicast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ MulticastState::Iterator it = sMulticastState-&gt;GetIterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (it.HasNext()) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; IPv4GroupInterface::AddressSet::Iterator it = state-&gt;Sources().GetIterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (it.HasNext()) { .... } kprintf(<span class="hljs-string"><span class="hljs-string">"}&gt; sock %p\n"</span></span>, state-&gt;Parent()-&gt;Socket()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  In the loop body, a declaration was found for the variable 'it', which coincides with the variable used to control the loop.  Such a code may contain logical errors, up to the receipt of an eternal loop. <br><br><h2>  Work with memory </h2><br>  <a href="http://www.viva64.com/ru/d/0208/">V597</a> The compiler couldn‚Äôt delete the memset function call, which is used to flush the password password.  The RtlSecureZeroMemory () function should be used to erase the private data.  login.cpp 126 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* user, struct passwd** _passwd)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ok = verify_password(passwd, spwd, password); <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(password, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(password)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ok) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> B_PERMISSION_DENIED; *_passwd = passwd; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> B_OK; }</code> </pre> <br>  Unfortunately, this code may leave the password uncleaned.  Note that the 'password' array is cleared at the end and is no longer used.  Therefore, when building the Release version of a program, the compiler will most likely remove the memset () function call.  The compiler has every right to do this.  The analyzer suggests using the function for Windows, but for this operating system you should find another way to avoid compiler optimization. <br><br>  More dangerous places: <ul><li>  V597 The compiler couldn‚Äôt have the function call, which is used to flush 'finalcount' buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  sha1.c 228 </li><li>  V597 The compiler couldn‚Äôt delete the memset function call, which is used to flush the encoded_block 'buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  dst_api.c 446 </li><li>  V597 The compiler couldn‚Äôt delete the memset function call, which is used to flush the in_buff 'buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  dst_api.c 916 </li><li>  V597 The compiler couldn‚Äôt have been set to the ‚Äúmemset‚Äù function call, which is used to flush.  The RtlSecureZeroMemory () function should be used to erase the private data.  passwd.cpp 171 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0247/">V630</a> The 'malloc' function is to allocate memory.  PDFWriter.cpp 117 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> PDFWriter::PrintPage(int32 pageNumber, int32 pageCount) { .... pictures = (BPicture **)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(pictureCount * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BPicture *)); picRects = (BRect *)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(pictureCount * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BRect)); <span class="hljs-comment"><span class="hljs-comment">//&lt;== picPoints = (BPoint *)malloc(pictureCount * sizeof(BPoint)); //&lt;== picRegion = new BRegion(); .... }</span></span></code> </pre> <br>  When allocating memory with the help of malloc for an array of objects of some class, neither the object's constructor is called at creation, nor the destructor is destroyed.  Such code can lead to working with uninitialized variables and other errors. <br><br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call of the memset function will lead to underflow of the buffer context.  sha2.c 623 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEMSET_BZERO(p,l) memset((p), 0, (l)) void solv_SHA256_Final(sha2_byte digest[], SHA256_CTX* context) { .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Clean up state data: */</span></span></span><span class="hljs-meta"> MEMSET_BZERO(context, sizeof(context)); usedspace = 0; }</span></span></code> </pre> <br>  The size of the memory being reset is not equal to the size of the structure, but to the size of the pointer. <br><br>  More places like this: <ul><li>  V512 A call of the memset function will lead to underflow of the buffer context.  sha2.c 644 </li><li>  V512 A call of the memset function will lead to underflow of the buffer context.  sha2.c 953 </li><li>  V512 A call of the memset function will lead to underflow of the buffer context.  sha2.c 973 </li><li>  V512 A call of the memset function will lead to underflow of the buffer context.  sha2.c 1028 </li><li>  V512 A call of the memset function will lead to underflow of the buffer context.  sha2.c 1048 </li></ul><br><h2>  Other </h2><br>  <a href="http://www.viva64.com/ru/d/0195/">V591</a> Non-void function should return a value.  pc.c 1031 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">ULONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_var</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *name, ULONG val)</span></span></span><span class="hljs-function"> </span></span>{ variable *v; v = lookup_var(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) v-&gt;value = val; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> add_var(name, val); }</code> </pre> <br>  Most likely, when calling the set_var () function, the return value is not used at all.  But if they ever use it, they will get an undefined value. <br><br>  <a href="http://www.viva64.com/ru/d/0301/">V671</a> It is possible that the 'swap' function interchanges the 'std :: declval &lt;_Alloc &amp;&gt; ()' variable with itself.  alloc_traits.h 191 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _S_nothrow_swap() { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::swap; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !_S_propagate_on_swap() || <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span>( swap(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::declval&lt;_Alloc&amp;&gt;(), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::declval&lt;_Alloc&amp;&gt;())); }</code> </pre> <br>  Incomprehensible use of the swap () function: the same arguments. <br><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'data-&gt; error' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 222, 223. repo_solv.c 223 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data_read_idarray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(.... , Repodata *data)</span></span></span><span class="hljs-function"> </span></span>{ .... data-&gt;error = pool_error( <span class="hljs-comment"><span class="hljs-comment">//&lt;== data-&gt;repo-&gt;pool, SOLV_ERROR_ID_RANGE, "data_read_idarray: id too large (%u/%u)", x, max); data-&gt;error = SOLV_ERROR_ID_RANGE; //&lt;== .... }</span></span></code> </pre> <br>  Assigning different values ‚Äã‚Äãof one variable in a row.  Perhaps a typo. <br><br>  <a href="http://www.viva64.com/ru/d/0163/">V568</a> It's odd that the sizeof () operator is the sizeof (struct tlv_header_t) 'expression.  print-slow.c 255 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slow_print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">register</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u_char *pptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">register</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u_int len)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vflag &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) print_unknown_data(tptr+<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(struct <span class="hljs-keyword"><span class="hljs-keyword">tlv_header_t</span></span>)), <span class="hljs-string"><span class="hljs-string">"\n\t "</span></span>, tlv_len-<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(struct <span class="hljs-keyword"><span class="hljs-keyword">tlv_header_t</span></span>)); .... }</code> </pre> <br>  The argument of the sizeof () operator is also sizeof ().  This operator calculates the type of expression and returns the size of this type, but the expression itself is not calculated, i.e.  the size of the structure does not affect anything here. <br><br>  There are many such places: <ul><li>  V568 It's an odd sizeof () operator is the sizeof (struct lmp_object_header) 'expression.  print-lmp.c 872 </li><li>  V568 It's odd that the sizeof () operator is the sizeof (struct tlv_header_t) 'expression.  print-slow.c 182 </li><li>  V568 It's an odd sizeof () operator is the sizeof (struct eigrp_tlv_header) 'expression.  print-eigrp.c 283 </li><li>  V568 It's an odd sizeof () operator is the sizeof (struct eigrp_tlv_header) 'expression.  print-eigrp.c 471 </li></ul><br><h2>  Conclusion </h2><br>  Haiku is a big and unusual project.  It was interesting to check it out and make a small contribution to the development.  Despite my experience with open-source projects, here I met many rare warnings of the analyzer.  The articles included the most suspicious, in my opinion, source code examples.  Anything else that was not included in the article or was missed by me, the authors of the project will be able to find in the full verification log. <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0318/">Analysis of Haiku Operating System (BeOS Family) by PVS-Studio.</a>  <a href="http://www.viva64.com/en/b/0318/">Part 2</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/256525/">https://habr.com/ru/post/256525/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256513/index.html">The challenge of a hundred boxes and the rescue of prisoners - the final chord</a></li>
<li><a href="../256515/index.html">Script to backup EC2-instance to AMI</a></li>
<li><a href="../256517/index.html">Separate interfaces for unit testing</a></li>
<li><a href="../256521/index.html">Scientifically looking for errors in the cloud: an unexpected CEO adventure</a></li>
<li><a href="../256523/index.html">Sprockets 3 encoding problem when working with HTML files</a></li>
<li><a href="../256527/index.html">Prototype this Or useful functionality faster than a cup of coffee</a></li>
<li><a href="../256529/index.html">Overview of add-ons for Blender 3D</a></li>
<li><a href="../256533/index.html">Fast stitching panorama</a></li>
<li><a href="../256535/index.html">Using Microsoft Azure as a backup data center</a></li>
<li><a href="../256537/index.html">Counting the cost of software development hours</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>