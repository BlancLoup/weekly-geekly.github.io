<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized backup of Windows and * nix servers using Bacula</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all the farmers! 

 As you might guess, it will be about backups. 
 Timely backup is an extremely important part of the work of the syste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized backup of Windows and * nix servers using Bacula</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all the farmers! <br><br>  As you might guess, it will be about backups. <br>  Timely backup is an extremely important part of the work of the system administrator.  A timely backup makes your sleep calm, and your nerves become steel, gives strength and protects your health. <br><br>  I think it would be quite reasonable to assume that this topic has already turned sore, but still I would venture to share my experience.  The client-server implementation of the backup scheme will be presented to the reader.  As a tool, I chose the open source Bacula project.  For more than half a year of experience in using it, I remain satisfied with my choice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Bacula consists of several demons, each of which carries its own functional load.  The figure below schematically shows the relationship of these demons. <br><br>  <i>Under habrakat I will describe all demons in detail</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/988/585/704/988585704447e8e1cc678ec5af7d39a2.png"><br><br>  <b>In my case, the backups are:</b> <br><ol><li>  Configuration files of various daemons from all servers. </li><li>  MySQL database. </li><li>  Document management from a Windows file server. </li><li>  Various important data from nix servers (site / forum engines, etc ..) </li></ol><br><br><a name="habracut"></a><br><br><h1>  1.Description of Bacula Demons </h1><br><br>  The system is built on client-server technology, and uses TCP for data transfer.  Backups are created in their own, fully open format. <br><br>  The Bacula data backup system consists of four main elements: Director Daemon, Storage Daemon, File Daemon and Bacula Console.  All these elements are implemented as standalone applications. <br><br>  Director Daemon (DD) is the central element of the system that manages its remaining components.  Its tasks include managing the backup / restore process, providing a management interface for administrators, and more.  Simply put, it is a dispatcher who initiates all processes and monitors their progress. <br><br>  Storage Daemon (SD) is an application that is responsible for reading / writing data directly to storage devices.  Accepts control commands from DD, as well as backup data from / to File Daemon. <br><br>  File Daemon (FD) - this element can still be called the Agent.  After all, it works within the operating system, the data of which must be backed up.  File Daemon performs the entire routine by accessing the backed up files and their further transfer to SD.  Also on the FD side, backup encryption is performed, if defined by the configuration. <br><br>  Bacula Console (BC) - system administrator interface.  At its core, it is a command interpreter for managing Bacula.  Strictly speaking, the Bacula Console can be expanded with the help of graphical control systems, which, as a rule, are just a superstructure above BC.  Such systems include Tray Monitor and Bat.  The first one is installed on the system administrator‚Äôs computer and monitors the backup system operation, while the second provides the ability to control via a graphical interface. <br><br>  Bacula Catalog is a database that stores information about all the reserved files and their location in backup copies.  The directory is necessary to ensure effective addressing to the required files.  MySql, PostgreSql and SqLite are supported. <br>  This structural division allows you to organize a very flexible backup system when the Storage Daemon is deployed on a dedicated server with multiple storage devices.  Also, Bacula Director can manage multiple instances of SD, providing backup of part of data to one storage device, and parts - on the other. <br><br><h1>  2. OS and iron </h1><br>  Now, when the reader has formed an idea of ‚Äã‚Äãthe work of the demons of Bacula, I will go on to describe how I realized all this beauty in myself. <br>  As a hardware for DD, SD and Bacula Catalog I have a PC with the following characteristics <br><table><tbody><tr><td>  <b>Device</b> </td><td>  <b>Model</b> </td><td>  <b>quantity</b> </td><td>  <b>Capacity / Frequency</b> </td></tr><tr><td>  HDD </td><td>  Hitachi HDS723020BLA642 </td><td>  3 </td><td>  2Tb </td></tr><tr><td>  CPU </td><td>  AMD Phenom (tm) II X4 970 Processor </td><td>  one </td><td>  3500 Mhz </td></tr><tr><td>  Motherboard </td><td>  Gigabyte GA-880GA-UD3H </td><td>  one </td><td>  - </td></tr><tr><td>  Ram </td><td></td><td></td><td>  3541 Mb </td></tr></tbody></table><br>  About OS and Software Versions Used on the Server <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsb_release -a LSB Version: :core-4.0-ia32:core-4.0-noarch:graphics-4.0-ia32:graphics-4.0-noarch:printing-4.0-ia32:printing-4.0-noarch Distributor ID: CentOS Description: CentOS release 5.7 (Final) Release: 5.7 Codename: Final # uname -a Linux backupsrv.domain.ru 2.6.18-274.7.1.el5PAE #1 SMP Thu Oct 20 17:03:59 EDT 2011 i686 athlon i386 GNU/Linux # rpm -qa |grep -E "syslog-ng|bacula|mysql-ser" bacula-libs-5. 0.3-1 syslog-ng-2.1.4-9.el5 bacula-mysql-5. 0.3-1 mysql-server-5. 0.77-4.el5_6.6</span></span></code> </pre> <br><br>  Data storage is handled by several software (mdadm) RAID arrays. <br>  Under the system, three partitions on three disks, you can boot from any of them, under the backups of one array of two partitions. <br><table><tbody><tr><td>  <b>Array name</b> </td><td>  <b>from which partitions</b> </td><td>  <b>mount point</b> </td><td>  <b>File system</b> </td><td>  <b>Array level</b> </td></tr><tr><td>  md0 </td><td>  / dev / sda1, / dev / sdb1, / dev / sdc1 </td><td>  boot </td><td>  ext2 </td><td>  one </td></tr><tr><td>  md1 </td><td>  / dev / sda2, / dev / sdb2, / dev / sdc2 </td><td>  / </td><td>  ext3 </td><td>  one </td></tr><tr><td>  md2 </td><td>  / dev / sda3, / dev / sdb3 </td><td>  / backup </td><td>  ext4 </td><td>  one </td></tr></tbody></table><br><h1>  3. Description of the backup scheme and settings of the Bacula daemons </h1><br>  I have a total of 19 Bacula clients configured, but I‚Äôll discuss in detail the description of the backup of the billing server and documents from the Windows file server.  The focus on these two servers is due to the fact that other clients are configured in a similar way, and you can build your configurations using the example of these server clients. <br><br>  Backup server billing is, in fact, backup mysql database and configuration files of demons. <br>  BD allows you to run a local script on the client both before and after the job. <br>  Every night, at the start of the task on the backup server, a local script is launched (on the billing server itself), which creates an archive of the billing database, then this archive picks up the BD and places volumes on the corresponding pool (in fact, SD controls read / write operations, but it is not important now).  Immediately after the task is completed, another script is launched, which in turn moves the created archive to a separate folder on the billing server, for greater reliability.  Thus, the database archive will be both in Bacula and locally on the billing server (yes, I am paranoid).  These mechanisms and scripts will be described in more detail below. <br><br>  From the Windows file server, we save all the necessary workflow.  On Sunday, a full backup is created, every next day, from Monday to Saturday, Diff backups. <br><br>  Now about the configuration files of the Bacula daemons.  Let's start with the most voluminous - bacula-dir.conf. <br>  The configuration files of all Bacula daemons consist of descriptions of the so-called resources.  Each of the resources describes a specific functional demon. <br>  I will comment on every line in the config, so the Bacula file resource blocks (bacula-dir.conf, bacula-sd.conf, bacula-fd.conf) will follow, if something needs to be explained in more detail, indicate this in the comments. <br>  Dirtector Resource <br><pre> <code class="bash hljs">Director { <span class="hljs-comment"><span class="hljs-comment">#  bacula director' Name = backupsrv.domain.ru-dir #   ,   default DIRport = 9101 #   ,   sql     Bacula Catalog(mysql database) QueryFile = "/usr/lib/bacula/query.sql" #      WorkingDirectory = "/backup/bacula-work/" # pid   PidDirectory = "/var/run" #      Maximum Concurrent Jobs = 1 #     BC    Password = "bacula_paS$w0rD10*" #   mail',    Messages Messages = Daemon #      DirAddress = 10.1.19.2 }</span></span></code> </pre> <br><br>  Resource catalog, describe the connection to the database <br><pre> <code class="bash hljs">Catalog { Name = MyCatalog dbname = <span class="hljs-string"><span class="hljs-string">"bacula"</span></span>; dbuser = <span class="hljs-string"><span class="hljs-string">"bacula"</span></span>; dbpassword = <span class="hljs-string"><span class="hljs-string">"edsfweo8vhwpe"</span></span> }</code> </pre> <br><br>  Resource Messages <br><pre> <code class="bash hljs">Messages { <span class="hljs-comment"><span class="hljs-comment">#      Director, ? Name = Daemon #    email mailcommand = "/usr/sbin/bsmtp -f \"\(Bacula\) \&lt;%r\&gt;\" -s \"Bacula daemon message\" %r" #     (root   admins@domain.ru) #   ,     mail = root@backupsrv.domain.ru = alert,error,fatal,terminate, !skipped #     console = all, !skipped, !saved #    append = "/var/lib/bacula/log" = alert,error,fatal,terminate, !skipped }</span></span></code> </pre> <br><br>  For each client in the tasks indicated Pool and Storage. <br>  Pool, sorry for the tautology, this is a pool of volumes (volume) on which backup copies of customer data are placed.  My volumes are bacula files located on the software raid array.  Different pools of volumes can be defined for different clients.  For example, I have created 6 pools for different types of clients.  In the example below, only one of them is described, for billing data. <br>  Storage describes which physical devices will be used as volumes. <br>  (Storage BGB-ST is described in the SD config) <br>  Pool resource <br><pre> <code class="bash hljs">Pool { <span class="hljs-comment"><span class="hljs-comment">#  ,      Name = bgb #  ,       Pool Type = Backup # #   (   1-,   2-, #  3-, 3-  -   1-) Recycle = yes #    bacula catalog( mysql  ) #    AutoPrune = yes #       (volumes) #    ,      #  Volume Retention = 90 days #    Maximum Volume Bytes = 100G #      Maximum Volumes = 3 #       LabelFormat = "Vol" }</span></span></code> </pre> <br><br>  Resource Storage <br><pre> <code class="bash hljs">Storage { <span class="hljs-comment"><span class="hljs-comment">#     (        #  Bacula,   ) Name = BGB-F Password = "StoRage_PaSSw0rD" # fqdn   Address = backupsrv.domain.ru #    SDPort = 9103 #      SD Device = BGB-ST #            # bacula( /backup/bgbilling/Vol0001) Media Type = File }</span></span></code> </pre> <br><br>  Task for example backup database billing. <br>  Resource Client <br><pre> <code class="bash hljs">Client { <span class="hljs-comment"><span class="hljs-comment">#  Name = bgbilling-fd # ip   Address = 10.103.2.5 # ,    FDPort = 9102 #  mysql   Bacula Catalog = MyCatalog #   FD Password = "Fd_paSSw0rd" #         #    ,      # (   !!) File Retention = 45 days #  ,     Job Retention = 90 days #    ( mysql)    AutoPrune = yes }</span></span></code> </pre> <br><br>  The task itself. <br>  Resource Job <br><pre> <code class="bash hljs">Job { <span class="hljs-comment"><span class="hljs-comment">#   Name = "BGBilling" # (backup or restore) Type = Backup # (,   ) Level = Full #   Client=bgbilling-fd #  -(   ,    ) FileSet="bgbilling-set" #  SD  Storage = BGB-F #  (     (volume)    # ) Pool = bgb #      (   - #    !) ClientRunBeforeJob = "/root/sh/before_bg_db_backup.sh" #      ClientRunAfterJob = "/root/sh/after_bg_db_backup.sh" #   messages,       Messages = Standard #   Schedule = "DaylyFullBGBilling" #       ,     # ,     , #     -    ,    Write Bootstrap = "/backup/bsr-files/bgbilling.bsr" }</span></span></code> </pre><br><br>  I promised to elaborate on the scripts running before and after the task. <br>  Script to set <br><pre> <code class="bash hljs">$ sudo cat /root/sh/before_bg_db_backup.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin mysql -e "flush tables with read lock" --user=root --password="ololo" bgbilling lvcreate -L20G -s -n backup_db /dev/BGB-LVM1/billing_db mysql -e "unlock tables" --user=root --password="ololo" bgbilling mount /dev/BGB-LVM1/backup_db /backup tar -czf /usr/backups/`date +%Y-%m-%d_%H-%M`.bgb.tgz /backup/bgbilling/ umount /backup lvremove -f /dev/BGB-LVM1/backup_db</span></span></code> </pre><br>  Script after the job <br><pre> <code class="bash hljs">$ sudo cat /root/sh/after_bg_db_backup.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin rm /usr/backups/after_run_bacula_backup/* mv /usr/backups/*.tgz /usr/backups/after_run_bacula_backup/</span></span></code> </pre><br><br>  Resource FileSet (what we backup and what not) <br><pre> <code class="bash hljs">FileSet { Name = <span class="hljs-string"><span class="hljs-string">"bgbilling-set"</span></span> Include { Options { <span class="hljs-comment"><span class="hljs-comment">#      , #      md5 signature = MD5 } #  ,    File = /usr/backups File = /etc File = /root/sh } Exclude { #      File = /usr/backups/after_run_bacula_backup/* File = /usr/backups/after_run_bacula_backup } }</span></span></code> </pre><br><br>  Schedule launch tasks. <br>  Resource Schedule <br><pre> <code class="bash hljs">Schedule { <span class="hljs-comment"><span class="hljs-comment">#   Name = "DaylyFullBGBilling" #    Run = Full sun-sat at 1:10 }</span></span></code> </pre> <br><br>  I will not comment on resources for backing up documents from a Windows server in detail, I‚Äôll give the full part of the bacula-dir.conf config <br><pre> <code class="bash hljs">Storage { Name = WINDOWS-F Address = backupsrv.domain.ru <span class="hljs-comment"><span class="hljs-comment"># NB Use a fully qualified name here SDPort = 9103 Password = "StoRage_PaSSw0rD" Device = WINDOWS-ST Media Type = File } Pool { Name = windows Pool Type = Backup Recycle = yes # Bacula can automatically recycle Volumes AutoPrune = yes # Prune expired volumes Volume Retention = 60 days Maximum Volume Bytes = 30G # Limit Volume size to something reasonable Maximum Volumes = 5 # Limit number of Volumes in Pool LabelFormat = "Vol-Windows" } Job { Name = "centra-bdk" Type = Backup Level = Full Client= centra-bdk-fd FileSet="centra-bdk-fd-fs" Storage = WINDOWS-F Pool = windows Messages = Standard Schedule = "Windows_Centra-bdk" Write Bootstrap = "/backup/bsr-files/centra-bdk.bsr" } FileSet { Name = "centra-bdk-fd-fs" Include { Options { signature = MD5 Compression=GZIP } #       ! File = "D:\\Public\\!!!\ " File = "D:\\Public\\\ " File = "D:\\Public\\tex\\Maps" File = "D:\\Public\\\  " File = "D:\\Public\\\ 1" } Exclude { File = "*.mp3" File = "*.avi" File = "*.wmv" } } Client { Name = centra-bdk-fd Address = 10.1.19.50 FDPort = 9102 Catalog = MyCatalog Password = "Fd_paSSw0rd" # password for FileDaemon File Retention = 30 days # 30 days Job Retention = 2 months # two months AutoPrune = yes # Prune expired Jobs/Files } Schedule { Name = "Windows_Centra-bdk" Run = Level=Full on sun at 07:10 Run = Level=Differential on mon-sat at 22:15 }</span></span></code> </pre><br>  The BD configuration file is now complete.  Go to the SD configuration - the description of the file bacula-sd.conf <br><br>  Resource Storage <br><pre> <code class="bash hljs">Storage { <span class="hljs-comment"><span class="hljs-comment">#   SD Name = backupsrv.domain.ru-sd #   SDPort = 9103 #   (  ) WorkingDirectory = "/var/lib/bacula" # pid   Pid Directory = "/var/run/bacula" #    ip SDAddress = 10.1.19.2 }</span></span></code> </pre><br><br>  Resource Director (connection to BD described in the bacula-dir.conf config) <br><pre> <code class="bash hljs">Director { <span class="hljs-comment"><span class="hljs-comment">#  DD,  ,     Name = backupsrv.domain.ru-dir #  Password = "StoRage_PaSSw0rD" }</span></span></code> </pre> <br><br>  The description of various devices begins, in total 4 different devices are used by me.  I will give as an example two, for billing and for Windows. <br>  Resource Device for billing. <br><pre> <code class="bash hljs">Device { <span class="hljs-comment"><span class="hljs-comment"># ,         Name = BGB-ST #  Media Type = File #      (, volumes) Archive Device = /backup/bgbilling #       Pool'( Vol*) . #  DD LabelMedia = yes; #    File    Random Access = Yes; #   ,   AutomaticMount = yes; #   =) RemovableMedia = no; #   ,     AlwaysOpen = no; }</span></span></code> </pre><br><br>  Resource Device for Windows File Server <br><pre> <code class="bash hljs">Device { Name = WINDOWS-ST Media Type = File Archive Device = /backup/windows LabelMedia = yes; Random Access = Yes; AutomaticMount = yes; RemovableMedia = no; AlwaysOpen = no; }</code> </pre><br><br>  Resource Messeges. <br><pre> <code class="bash hljs">Messages { <span class="hljs-comment"><span class="hljs-comment">#  Name = Standard #  DD =   =   director = backupsrv.domain.ru-dir = all }</span></span></code> </pre> <br><br>  Configuration file bconsole.conf, access to the console Bacula. <br><pre> <code class="bash hljs">Director { Name = backupsrv.ray-com.ru-dir DIRport = 9101 address = 10.1.19.2 Password = <span class="hljs-string"><span class="hljs-string">"bacula_paS</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$w0rD10</span></span></span><span class="hljs-string">*"</span></span> }</code> </pre><br><br>  <i>Do not forget to create the appropriate Storage folders and assign bacula the owner of these folders.</i> <br>  Advice from the comments <br><blockquote>  @ / usr / local / etc / bacula / client.conf <br><br>  @ / usr / local / etc / bacula / job.conf <br><br>  @ / usr / local / etc / bacula / pool.conf <br><br>  @ / usr / local / etc / bacula / fileset.conf <br>  Configs can be divided into different files. <br>  Options {signature = MD5 compression = GZIP} <br>  and enable compression. <br></blockquote><br>  Configuring the server side is complete. <br><br>  Config client <br><h2>  <i>It is important to note that each of the clients must rezolvit fqdn server name in its ip address!</i>  <i>Provide it with dns or write to the hosts!</i> </h2><br>  Resource Director. <br><pre> <code class="bash hljs">Director { <span class="hljs-comment"><span class="hljs-comment">#  BD Name = backupsrv.domain.ru-dir #     BD  (   Client  BD) Password = "Fd_paSSw0rd" }  FileDaemon FileDaemon { #   Name = bgbilling-fd #   9102 FDport = 9102 WorkingDirectory = /usr/lib/bacula Pid Directory = /var/run/bacula FDAddress = 10.103.2.5 }  Messeges Messages { Name = Standard director = backupsrv.domain.ru = all, !skipped, !restored append = "/var/bacula/log" = all, !skipped }</span></span></code> </pre><br><br>  I mentioned in the comments of the configuration files about the correspondence scheme of passwords and daemon names in various configuration files, so if you get confused somewhere, use the image below. <br> <a href="http://hostingkartinok.com/" title="upload image"><img src="https://habrastorage.org/getpro/habr/post_images/e2e/bbd/8e3/e2ebbd8e3a2c71371f68e78686d416ca.png"></a> <br><br><h1>  4. Sample recovery procedure </h1><br>  To monitor and restore your backups, it is convenient to use the bat utility. <br>  In ubuntu it is put so <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sudo aptitude install bacula-console-qt</span></span></code> </pre><br>  I didn't find it in Gentoo Portage, so I collected it from sources. <br>  <i>The configuration file bat.conf is completely analogous to bconsole.conf given earlier.</i> <br>  So, for example, I want to restore the archive of the billing database for a certain number.  The algorithm that I use is as follows: <br>  1. Open the bat and find the desired task. <br> <a href="http://hostingkartinok.com/" title="upload image"><img src="https://habrastorage.org/getpro/habr/post_images/dd7/aa4/a6b/dd7aa4a6b6be0490d884d996e46858bd.png"></a> <br>  2. enter the command list files jobid = 3059 to make sure that the task contains the necessary files <br> <a href="http://hostingkartinok.com/" title="image hosting"><img src="https://habrastorage.org/getpro/habr/post_images/d0c/381/097/d0c381097188db6d219f43f17c1b6654.png"></a> <br>  3. Now go to the console (it's easier for me just to =)).  In the console, I will restore the billing archive to another client <br><br><pre> <code class="bash hljs">$ sudo bconsole [sudo] password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> onotole: Connecting to Director 10.1.19.2:9101 1000 OK: backupsrv.domain.ru-dir Version: 5.0.3 (30 August 2010) Enter a period to cancel a <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>. *restore Automatically selected Catalog: MyCatalog Using Catalog <span class="hljs-string"><span class="hljs-string">"MyCatalog"</span></span> First you select one or more JobIds that contain files to be restored. You will be presented several methods of specifying the JobIds. Then you will be allowed to select <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> files from those JobIds are to be restored. To select the JobIds, you have the following choices: 1: List last 20 Jobs run 2: List Jobs <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> a given File is saved 3: Enter list of comma separated JobIds to select 4: Enter SQL list <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 5: Select the most recent backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client 6: Select backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client before a specified time 7: Enter a list of files to restore 8: Enter a list of files to restore before a specified time 9: Find the JobIds of the most recent backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client 10: Find the JobIds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client before a specified time 11: Enter a list of directories to restore <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> found JobIds 12: Select full restore to a specified Job date 13: Cancel Select item: (1-13): 9 Defined Clients: 1: 192.168.15.12-fd 2: 1.1.1.1-fd 3: 1.1.1.75-fd 4: ASTERISK-configs-fd 5: DHCPD-configs-fd 6: GW1-configs-fd 7: GW2-configs-fd 8: NAS-20-configs-fd 9: NAS-21-configs-fd 10: NAS-6-configs-fd 11: NAS-ololo-configs-fd 12: NS_AND_MAIL-configs-fd 13: RADIUS-ololo-configs-fd 14: VIRTSRV1-configs-fd 15: bgbilling-fd 16: configs-fd 17: domain.ru-fd 18: mydomain.ru-fd 19: tv.domain.ru-fd 20: zabbix.domain.ru-fd Select the Client (1-20): 15 Automatically selected FileSet: bgbilling-set +-------+-------+----------+----------------+---------------------+------------+ | JobId | Level | JobFiles | JobBytes | StartTime | VolumeName | +-------+-------+----------+----------------+---------------------+------------+ | 3,292 | F | 1,666 | 10,874,552,420 | 2011-12-19 02:31:08 | Vol0014 | +-------+-------+----------+----------------+---------------------+------------+ To select the JobIds, you have the following choices: 1: List last 20 Jobs run 2: List Jobs <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> a given File is saved 3: Enter list of comma separated JobIds to select 4: Enter SQL list <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 5: Select the most recent backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client 6: Select backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client before a specified time 7: Enter a list of files to restore 8: Enter a list of files to restore before a specified time 9: Find the JobIds of the most recent backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client 10: Find the JobIds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a backup <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a client before a specified time 11: Enter a list of directories to restore <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> found JobIds 12: Select full restore to a specified Job date 13: Cancel Select item: (1-13): 12 Enter JobId to get the state to restore: 3059 Selecting <span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> to build the Full state at 2011-12-06 02:28:47 You have selected the following JobId: 3059 Building directory tree <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> JobId(s) 3059 ... +++++++++++++++++++++++++++++++++++++++++++++ 1,535 files inserted into the tree. You are now entering file selection mode <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> you add (mark) and remove (unmark) files to be restored. No files are initially added, unless you used the <span class="hljs-string"><span class="hljs-string">"all"</span></span> keyword on the <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> line. Enter <span class="hljs-string"><span class="hljs-string">"done"</span></span> to leave this mode. cwd is: / $ ls etc/ root/ usr/ $ ls usr usr/ $ mark usr 1,667 files marked. $ <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> Bootstrap records written to /backup/bacula-work//backupsrv.domain.ru-dir.restore.8.bsr The job will require the following Volume(s) Storage(s) SD Device(s) =========================================================================== Vol0010 BGB-F BGB-ST Volumes marked with <span class="hljs-string"><span class="hljs-string">"*"</span></span> are online. 1,667 files selected to be restored. Run Restore job JobName: restore Bootstrap: /backup/bacula-work//backupsrv.domain.ru-dir.restore.8.bsr Where: /usr/restore Replace: always FileSet: bgbilling-set Backup Client: bgbilling-fd Restore Client: bgbilling-fd Storage: BGB-F When: 2011-12-26 15:01:38 Catalog: MyCatalog Priority: 10 Plugin Options: *None* OK to run? (yes/mod/no): mod Parameters to modify: 1: Level 2: Storage 3: Job 4: FileSet 5: Restore Client 6: When 7: Priority 8: Bootstrap 9: Where 10: File Relocation 11: Replace 12: JobId 13: Plugin Options Select parameter to modify (1-13): 5 The defined Client resources are: 1: bgbilling-fd 2: GW1-configs-fd 3: GW2-configs-fd 4: NAS-6-configs-fd 5: NAS-20-configs-fd 6: NAS-21-configs-fd 7: NAS-ololo-configs-fd 8: DHCPD-configs-fd 9: ASTERISK-configs-fd 10: NS_AND_MAIL-configs-fd 11: VIRTSRV1-configs-fd 12: mydomain.ru-fd 13: tv.domain.ru-fd 14: domain.ru-fd 15: 1.1.1.1-fd 16: 1.1.1.75-fd 17: zabbix.domain.ru-fd 18: 192.168.15.12-fd Select Client (File daemon) resource (1-18): 2 Run Restore job JobName: restore Bootstrap: /backup/bacula-work//backupsrv.ray-com.ru-dir.restore.8.bsr Where: /usr/restore Replace: always FileSet: bgbilling-set Backup Client: bgbilling-fd Restore Client: GW1-configs-fd Storage: BGB-F When: 2011-12-26 15:01:38 Catalog: MyCatalog Priority: 10 Plugin Options: *None* OK to run? (yes/mod/no): yes Job queued. JobId=3453 You have messages. *</code> </pre><br><br>  4. We are waiting for the successful completion of the task, the status can be monitored in the same bat. <br><img src="https://habrastorage.org/getpro/habr/post_images/578/1c0/d5f/5781c0d5fd99b6b442deb7858eb032c3.png"><br><br>  Some more screenshots <br><br><img src="https://habrastorage.org/getpro/habr/post_images/caf/be6/5b8/cafbe65b8f3bfcbeba9afc5fa0be7ac4.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/daa/906/bd5/daa906bd5883eb15241e3d7f95e197a0.png"><br><br> <a href="http://hostingkartinok.com/" title="imagehost"><img src="https://habrastorage.org/getpro/habr/post_images/418/78f/956/41878f956b7d09f16f6ed2d533e89d4a.png"></a> <br><br>  I thank everyone who read my opus to the end. <br>  By way of completion I will allow myself some more tips. <br>  It is important not only to make backups and keep track of what they have completed without errors, but also deploy and check them regularly.  This practice gives another +100 to those indicated at the beginning of calmness, nerve endurance and health.  It is also a very good practice to regularly back up the bacula database and bsr files. <br><br>  Happy New Year to you !!! <br><br><h4>  Sources used: </h4><br>  1. <a href="http://www.ibm.com/developerworks/ru/library/l-Backup_4/">www.ibm.com/developerworks/ru/library/l-Backup_4</a> <br>  2. <a href="http://www.bacula.org/en/%3Fpage%3Ddocumentation">www.bacula.org/en/?page=documentation</a> </div><p>Source: <a href="https://habr.com/ru/post/135291/">https://habr.com/ru/post/135291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135286/index.html">Microsoft Lync goes to mobile platforms, client review, server setup</a></li>
<li><a href="../135287/index.html">Algorithm winner AI Challenge 2011 (Ants)</a></li>
<li><a href="../135288/index.html">ICQ office</a></li>
<li><a href="../135289/index.html">Qt Creator Extension System</a></li>
<li><a href="../135290/index.html">Handling errors and crashes proprietary programs</a></li>
<li><a href="../135292/index.html">How to develop a personal business automation system for 1 day</a></li>
<li><a href="../135293/index.html">Students from the University of Amsterdam (VU) play Tetris with an optical tweaser</a></li>
<li><a href="../135295/index.html">Member of the project Kickstarter is going to release triangular tablets</a></li>
<li><a href="../135297/index.html">Changes in the Criminal Code, which may affect many</a></li>
<li><a href="../135299/index.html">Execution of a piece of code on behalf of a specific user</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>