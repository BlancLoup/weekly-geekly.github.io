<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unified dynamic corporate signature with Postfix + alterMIME + addAttachFilter + Active Directory or MySQL logo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Practically in any company, management requires to observe one or another format of business correspondence, where a special role is as...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unified dynamic corporate signature with Postfix + alterMIME + addAttachFilter + Active Directory or MySQL logo</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Practically in any company, management requires to observe one or another format of business correspondence, where a special role is assigned to the postal signature.  It often happens that the management of the company obliges everyone to put a unified corporate signature, but in practice most employees ignore this obligation for various reasons, or the signature structure is different from the corporate one (in font, color, text pattern). <br><br>  Of course, almost all the work to accomplish this task falls on the shoulders of the system administrator.  This is good, when a couple dozen employees work in the company and adding a corporate signature once will not be difficult.  But what to do when your company employs more than 50 people who can use different email clients and who periodically need software replacement? <br><br>  It turns out that in the long term, to fulfill this requirement is almost impossible.  As a result, management has to kick their employees from time to time, which can cause anger towards the offending employee, as well as the entire IT department.  At best, someone will get a comment, at worst - lose the prize. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will tell you how you can accomplish the task, what difficulties you will have to face, and how to overcome these difficulties. <br><br><h4>  The task and problems of its implementation </h4><br>  As a rule, management requires that a corporate signature with a company logo is present in every letter of all employees.  Agree on such a signature is quite simple, but to implement the task is very difficult on the side of the mail server. <br><br>  Perhaps many of you have already tried to cope with this task, using a bunch of <b>alterMIME + addAttachFilter</b> , but abandoned this venture for many reasons.  As a rule, whatever you do, the structure of letters or signatures becomes unreadable, especially when there is active correspondence, and also if someone is using <b>Microsoft Outlook</b> .  Well, let's look at all these problems ... <br><a name="habracut"></a><br><h4>  The implementation of the task </h4><br>  First you need a fully configured <b>Postfix</b> mail server with configured <b>Active Directory</b> or <b>MySQL</b> authorization.  In my case, the following software was used: <br><ul><li>  Debian 7.x </li><li>  Postfix 2.x </li><li>  alterMIME 0.3.10 </li><li>  addAttachFilter </li><li>  Active Directory </li></ul><br>  <b>alterMIME</b> is a program that changes MIME <br>  <b>addAttachFilter</b> - a script that adds a logo <br><br>  You <b>can</b> install <b>alterMIME</b> for <b>Debian</b> like this: <br><ul><li>  apt-get install altermime </li></ul><br>  Or download and install it from the official website: <a href="http://www.pldaniels.com/altermime">www.pldaniels.com/altermime</a> <br><br>  Also install <b>addAttachFilter</b> from the official site: <a href="http://addattachfilter.sourceforge.net/">addattachfilter.sourceforge.net</a> <br><br>  To begin, set up <b>alterMIME</b> and <b>addAttachFilter</b> strictly according to the instructions from these sites: <br><ul><li>  <a href="http://www.howtoforge.com/add-disclaimers-to-outgoing-emails-with-altermime-postfix-debian-etch">alterMIME</a> </li><li>  <a href="http://sourceforge.net/projects/addattachfilter/files/">addAttachFilter</a> </li></ul><br>  These articles are in English, but they are intuitive.  If you did everything correctly with these instructions, then the first reaction will be a smile from ear to ear with a shout from Yahooo when sending a test letter.  That's just you will not be happy for a long time.  From this point on, the setup is just beginning ... <br><br><h4>  "Underwater rocks" </h4><br>  I think that many of you reached this point on your own, but that was all, and then you had to roll back the settings. <br><br>  <b>The first pitfall</b> I had to deal with was the inability to add a logo like <b>base64</b> inside the <b>IMG SRC</b> <b>HTML</b> tag.  The problem is that most email clients, including <b>Outlook</b> , do not recognize this tag with the <b>base64</b> picture format.  Also, you cannot use external links to the image, since all e-mail clients that are configured by default will block such a logo.  Therefore, we will solve this problem using the <b>addAttachFilter</b> <b>perl</b> script. <br><br>  <b>The second pitfall</b> .  This is not the regular insertion of signatures in letters.  The fact is that when a letter is formed, the " <b>From:</b> " field can be with the simple meaning of the mailing address, that is, it is formed as <b>From: ivan.ivanov@your.domain</b> , although for many this line will look like <b>From: "Ivan Ivanov ‚Äù&lt;ivan.ivanov@your.domain&gt;</b> . <br><br>  To solve this problem, replace the line in the <b>disclaimer</b> script: <br><ul><li>  from_address = `grep -m 1" From: "in. $$ |  cut -d "&lt;" -f 2 |  cut -d "&gt;" -f 1` </li></ul><br>  This line: <br><ul><li>  from_address = `grep -m 1" From: "in. $$ |  cut -d "&lt;" -f 2 |  cut -d "&gt;" -f 1 |  sed 's / ^ From: // g'` </li></ul><br>  <b>The third underwater stone</b> .  If you do everything exactly according to the previous instructions, then during the correspondence you can see a lot of oddities.  All these "oddities" will be visible both when displaying text and when displaying a signature in various email clients, including <b>Outlook</b> .  It makes no sense to list them, you will see for yourself.  The fact is that with this configuration, your mail server will always insert a logo in every letter, even if it was sent by another server to an employee in your company.  So you need to change the <b>disclaimer</b> script. <br><br>  Delete the line: <br><ul><li>  cat |  /var/spool/filter/addAttachFilter.pl&gt; in. $$ ||  {echo Cannot save mail to file;  exit $ EX_TEMPFAIL;  } </li></ul><br>  Add a line instead: <br><ul><li>  cat&gt; in. $$ ||  {echo Cannot save mail to file;  exit $ EX_TEMPFAIL;  } </li></ul><br>  With this action you return the settings of the <b>disclaimer</b> script to the primary setting. <br><br>  After this, replace the line: <br><ul><li>  trap "rm -f in. $$" 0 1 2 3 15 </li></ul><br>  By line: <br><ul><li>  trap "rm -f in. $$;  rm -f pic. $$ ¬ª0 1 2 3 15 </li></ul><br>  And after the line: <br><ul><li>  if [`grep -wi ^ $ {from_address} $ $ {DISCLAIMER_ADDRESSES}`];  then </li></ul><br>  Add 2 lines: <br><ul><li>  cat in. $$ |  $ INSPECT_DIR / addAttachFilter.pl&gt; pic. $$ ||  {echo Cannot save mail to file;  exit $ EX_TEMPFAIL;  } </li><li>  cat pic. $$&gt; in. $$ ||  {echo Cannot save mail to file;  exit $ EX_TEMPFAIL;  } </li></ul><br>  This is necessary so that the logo is added only to those letters that are sent by your employees, and not to everything. <br><br>  <b>The fourth pitfall</b> is in the <b>Outlook</b> email client.  If it is used in your company, then depending on its settings, the mail client can add extended data to the letter.  This data is in the attached file <b>winmail.dat</b> .  When you add this file, many clients do not display a corporate signature.  To avoid this, you need to add one key <b>DisableTNEF = 1</b> (DWORD) to the registry.  I strongly recommend adding this value on all computers where any version of <b>Microsoft Outlook is</b> installed.  You can read more about the problem and how to solve it here <a href="http://www.slipstick.com/problems/outlook-is-sending-winmail-dat-attachments">www.slipstick.com/problems/outlook-is-sending-winmail-dat-attachments</a> <br><br>  <b>The fifth underwater stone</b> (cosmetic).  The essence of this problem lies in the fact that the corporate signature will <b>always</b> be added <b>to the bottom</b> and it can not be added after your answer.  Since this letter is formed on the server, and the server simply does not know where to put the signature, unlike any email client, when you format the letter yourself.  This can create a problem with long correspondence.  The solution is quite simple - create a minimal text signature, for example: <br><br><ul><li>  __ </li><li>  Best Regards, </li><li>  Ivan Ivanov </li></ul><br>  Thus, during a long correspondence, you will always have two signatures inserted, corporate and minimum (to separate the answers). <br><br>  " <b>Dynamic</b> " underwater stone.  Let's analyze the last pitfall associated with the dynamic listing of employees.  As you have already noticed, the signature is added only for those employees who are registered in the <b>disclaimer_addresses</b> file.  It is easy to guess that you will need to regularly monitor this file if you edit it manually.  Well, if a couple of dozen employees work in your company ... In order to solve this problem, put a script in <b>cron</b> that will form this list.  I think that the execution of this script 1-2 times a day will solve the problem with the list.  Sample script: <br><br><ul><li>  / usr / bin / ldapsearch -D USER@YOUR.DOMAIN -w PASSWORD -LLL -h 192.168.1.100 -p 3268 -S mail -N -b dc = YOUR, dc = DOMAIN "(mail = * @ *)" mail |  grep "mail:" |  cut -d "" -f 2&gt; / etc / postfix / disclaimer_addresses </li></ul><br>  where <b>192.168.1.100</b> , the IP of your domain controller <br><br>  You will also need the <b>ldap-utils</b> package to run this command. <br><br><h4>  Dynamic signature </h4><br>  Now we come to the final stage.  Here we look at how you can change the signature dynamically.  In my case, I have to change the <b>name</b> , <b>surname</b> and <b>telephone number of the</b> employee.  This can be done using data that is used in <b>Active Directory</b> or <b>MySQL</b> .  To do this, you will need the <b>ldapsearch</b> utility again.  The essence of using this utility is to read the <b>displayName</b> field and the <b>telephoneNumber</b> field.  Then you need to create a variable with these values ‚Äã‚Äãand substitute it in the signature.  Sample script, how to get <b>displayName</b> : <br><br><ul><li>  DisplayName = `ldapsearch -D USER@YOUR.DOMAIN -w PASSWORD -LLL -h 192.168.1.100 -p 3268 -N -b dc = YOUR, dc = DOMAIN" (mail = * $ from_address *) "displayName` </li></ul><br>  where the variable <b>$ from_address is</b> already in the <b>disclaimer</b> script <br><br>  I will not give the full text of my <b>disclaimer</b> script, which forms a dynamic signature.  Since it mainly consists of preparing <b>HTML</b> "caps".  In general, dynamic signature generation is reduced to the compilation of a ‚Äúheader‚Äù and data obtained from <b>Active Directory</b> or <b>MySQL</b> . <br><br><h4>  Conclusion </h4><br>  At the moment, adding a unified dynamic corporate signature works fine.  Tested with various email clients, including different versions of <b>Outlook</b> .  I do not exclude that there may still be any problems with this implementation.  If there are any, then please unsubscribe in the comments, and about your method of solving them. </div><p>Source: <a href="https://habr.com/ru/post/242185/">https://habr.com/ru/post/242185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242161/index.html">The work of the web project in an unstable connection</a></li>
<li><a href="../242167/index.html">SensioLabs PHP Profiler - blackfire.io (SensioLabsProfiler)</a></li>
<li><a href="../242173/index.html">Strutext C ++ word processing library - lexical implementation</a></li>
<li><a href="../242175/index.html">Facebook, hidden services and https certificates</a></li>
<li><a href="../242179/index.html">REST / CRUD. Am I cooking it wrong?</a></li>
<li><a href="../242187/index.html">EyeCare - relieving eye strain, treatment of myopia, accommodation spasm</a></li>
<li><a href="../242189/index.html">Dark times are coming: HabraDarkAge theme</a></li>
<li><a href="../242191/index.html">Calling to mobile phones from the browser with recording conversations</a></li>
<li><a href="../242193/index.html">Honeymoon Manager: how to spend it with benefit</a></li>
<li><a href="../242195/index.html">The digest of interesting materials for the mobile developer # 77 (October 26 - November 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>