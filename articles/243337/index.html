<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Semaphores, or how to steer access to resources in a DBMS Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, with multi-user or parallel data access, a situation arises when it is necessary to block / give access to a variable or memory section to seve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Semaphores, or how to steer access to resources in a DBMS Cach√©</h1><div class="post__text post__text-html js-mediator-article">  Often, with multi-user or parallel data access, a situation arises when it is necessary to block / give access to a variable or memory section to several processes simultaneously.  This task is solved with the help of mutexes, semaphores, monitors, etc. In this post, we will look at how one of the methods for providing shared data access, the <b>semaphore,</b> is implemented in Intersystems Cach√©. <br><img src="https://habrastorage.org/files/aa1/1fc/e11/aa11fce11d8c417e82bea4d0fa1fad5d.png" width="423" height="384"><img src="https://habrastorage.org/files/301/b20/6d5/301b206d58f04480a947fc356a7f4ee0.png" width="424" height="384"><br><a name="habracut"></a><br>  Semaphores are flexible and convenient means for synchronization and mutual exclusion of processes, accounting of resources.  Hidden semaphores are also used in operating systems as the basis for other means of interaction between processes. <br><br>  <a href="http://life-prog.ru/view_linux.php%3Fid%3D23">A semaphore</a> is a non-negative integer variable, over which two types of operations are possible: <br><ul><li>  <b>A P-operation</b> on a semaphore is an attempt to reduce the value of a semaphore by 1. If the value of the semaphore was greater than 0 before performing the P-operation, then the P-operation is performed without delay.  If, before performing a P operation, the value of the semaphore was 0, then the process performing the P operation is placed in the wait state until the value of the semaphore becomes greater than 0. </li><li>  <b>A V-operation</b> on a semaphore represents an increment of a semaphore value by 1. If there are processes that are delayed during the execution of a P-operation on a given semaphore, one of these processes goes out of the idle state and can perform its P-operation. </li></ul><br>  Semaphores are of two types: binary (picture on the left) and the general form, or counters (picture on the right).  They differ in that in the first case the variable can take only two values: 0 and 1, and in the second - any non-negative integer.  There are several options for using semaphores. <br><br><div class="spoiler">  <b class="spoiler_title">Mutual exclusion on semaphore</b> <div class="spoiler_text">  To implement mutual exclusion, for example, to prevent the possibility of simultaneous modification by two or more common data processes, a binary semaphore S is created. The initial value of this semaphore = 1. Critical sections of code (sections that can only be executed by one process at a time) are framed by brackets P ( S) (at the beginning of the section) and V (S) (at the end of the section).  The process included in the critical section performs operation P (S) and translates the semaphore to 0. If another process is already in the critical section, then the semaphore value is already 0, then the second process that wants to enter the critical section is blocked in its P-operation until the process that is now in the critical section comes out of it by executing operation V (S) at the output. </div></div><br><div class="spoiler">  <b class="spoiler_title">Semaphore sync</b> <div class="spoiler_text">  To ensure synchronization, a binary semaphore S is created with an initial value of 0. A value of 0 means that the event has not yet arrived.  The process signaling the occurrence of an event performs an operation V (S) setting the semaphore to 1. The process awaiting the occurrence of an event performs an operation P (S).  If at this point the event has already occurred, the waiting process continues to run, if the event has not yet occurred, the process is transferred to the wait state until the signaling process executes V (S). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If several processes are waiting for the same event, the process that successfully completed operation P (S) must follow V (S) after it in order to duplicate the event signal for the next pending process. </div></div><br><div class="spoiler">  <b class="spoiler_title">Semaphore - Resource Counter</b> <div class="spoiler_text">  If we have N units of a certain resource, then to control its distribution, a common semaphore S is created with an initial value N. Resource allocation is accompanied by operation P (S), release - by operation V (S).  The semaphore value thus reflects the number of free resource units.  If the semaphore value = 0, that is, there is no more free units, then the next process, the requesting resource unit, will be transferred to the pending operation P (S) until any of the processes using the resource releases the resource unit by executing this v (s). </div></div><br>  All these options can be implemented in Cach√© using the class <b><i>% SYSTEM.Semaphore</i></b> , which appeared in version <b><a href="http://www.intersystems.com/services-support/product-support/prerelease-trial-program/">2014.2</a></b> , which encapsulates a 64-bit non-negative integer and provides methods for changing its value to all running processes. <br><br>  Consider the use of a semaphore counter on a model example (the third use case). <br><br>  <i>Suppose that a university has allocated 10 slots for access to an international database of scientific articles.</i>  <i>Thus, we have a resource that we need to share among all students who wish to gain access.</i>  <i>Each student has his own login / password for access to the database, but only 10 people from the university can work at the same time.</i>  <i>Every time a student logs into the database, it is necessary to reduce the number of available slots by 1.</i>  <i>Accordingly, when it leaves the database, this 1 slot must be returned to the shared pool.</i> <br><br>  In order to check whether to give a student access or make him wait, we use a semaphore counter, the initial value of which equals 10. To see how the process of issuing access occurs, we use logging.  The main class will initialize the variables and monitor the work process of the students.  Another class will inherit from% SYSTEM.Semaphore and implement the semaphore.  Separate class will allocate for various utilities.  And the last two classes will simulate the entrance and exit of the student from the database.  Since the server ‚Äúknows‚Äù the name of the user who logs in and out of the system, we will <i>create a</i> separate global for modeling this ‚Äúknowledge‚Äù, which will store information about active users ( <i>^ LoggedUsers</i> ).  In it we will write logins of the entered students and from it we will take random names for exit from the system. <br><br>  Let's start with the Main class in which: <br><ol><li>  create a semaphore </li><li>  we set its initial value (equal to 10, which corresponds to 10 free slots for access to the database of scientific articles), </li><li>  stop the process and remove the semaphore, </li><li>  display the log. </li></ol><br><div class="spoiler">  <b class="spoiler_title">SemaphoreSample.Main</b> <div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SemaphoreSample.Main Extends %RegisteredObject [ ProcedureBlock ] { ///    ClassMethod Run() { //     <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).InitLog() <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).InitUsers() <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) //     <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> inventory = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (<span class="hljs-comment"><span class="hljs-comment">'($ISOBJECT(inventory))) { Set msg = "  SemaphoreSample.Counter %New()  " Do ..Log(msg) Quit } //     if 'inventory.Init(10) { Set msg = "    " Do ..Log(msg) Quit } //    Set msg = "     ..." Do ..Log(msg) Read *x //  Set msg = "    " _ inventory.Delete() Do ..Log(msg) Set msg = "  " Do ..Log(msg) do ##class(SemaphoreSample.Util).ShowLog() Quit } ///      ClassMethod Log(msg As %String) [ Private ] { Do ##class(SemaphoreSample.Util).Logger($Horolog, "Main", msg) Quit } }</span></span></code> </pre> </div></div><br>  The next class to create is a class with various utilities.  They will be needed for the test application.  There will be class methods responsible for: <br><ol><li>  global logging preparation for work ( <i>^ SemaphoreLog</i> ), </li><li>  write logs to global </li><li>  display logs </li><li>  entering into the global names of working users ( <i>^ LoggedUsers</i> ), </li><li>  random name selection from working users, </li><li>  Removing a name from the global working users by index. </li></ol><br><div class="spoiler">  <b class="spoiler_title">SemaphoreSample.Util</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SemaphoreSample.Util Extends %RegisteredObject [ ProcedureBlock ] { ///   ClassMethod InitLog() { //      Kill ^SemaphoreLog <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> ^SemaphoreLog = <span class="hljs-number"><span class="hljs-number">0</span></span> Quit } ///   ClassMethod InitUsers() { //        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $data(^LoggedUsers) <span class="hljs-comment"><span class="hljs-comment">'= 0 { Kill ^LoggedUsers } Set ^LoggedUsers = 0 } ///      ClassMethod Logger(time As %DateTime, sender As %String, msg As %String) { Set inx = $INCREMENT(^SemaphoreLog) Set ^SemaphoreLog(inx, 0) = time Set ^SemaphoreLog(inx, 1) = sender Set ^SemaphoreLog(inx, 2) = msg Write "(", ^SemaphoreLog, ") ", msg_"  "_$ztime($PIECE(time,",",2), 1), ! Quit } ///     ClassMethod ShowLog() { Set msgcnt = $GET(^SemaphoreLog, 0) Write " :   = ", msgcnt, !, ! Write "#", ?5, "", ?12, "", ?25, "", ! For i = 1 : 1 : msgcnt { Set time = ^SemaphoreLog(i, 0) Set sender = ^SemaphoreLog(i, 1) Set msg = ^SemaphoreLog(i, 2) Write i, ")", ?5, $ztime($PIECE(time,",",2), 1), ?15, sender, ":", ?35, msg, ! } Quit } ///       ClassMethod AddUser(Name As %String) { Set inx = $INCREMENT(^LoggedUsers) set ^LoggedUsers(inx) = Name } ///       ClassMethod DeleteUser(inx As %Integer) { kill ^LoggedUsers(inx) } ///        ClassMethod ChooseUser(ByRef Name As %String) As %Integer { //    "",      if $data(^LoggedUsers) = 1 { Set Name = "" Quit -1 } else { Set Temp = "" Set Numb = $Random(10)+5 For i = 1 : 1: Numb { Set Temp = $Order(^LoggedUsers(Temp)) //  ,        //         if (Temp = "") { set Temp = $Order(^LoggedUsers("")) } } set Name = ^LoggedUsers(Temp) Quit Temp } } }</span></span></code> </pre></div></div><br>  Next, the class with the implementation of the semaphore.  We inherit it from the% SYSTEM.Semaphore system class and add methods that implement the call <br><ol><li>  a method that returns a unique semaphore name, </li><li>  method of recording events in the log, </li><li>  callback methods for creating and destroying a semaphore (they just note the fact of creation / destruction), </li><li>  method of creating and initializing the semaphore. </li></ol><br><div class="spoiler">  <b class="spoiler_title">SemaphoreSample.Counter</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SemaphoreSample.Counter Extends %SYSTEM.Semaphore { ///        ClassMethod Name() As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> { Quit <span class="hljs-string"><span class="hljs-string">"Counter"</span></span> } ///      Method <span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(Msg As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) [ <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).Logger($Horolog, ..Name(), Msg) Quit } /// Callback      Method %OnNew() As %Status { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) Quit $$$OK } ///     Method Init(initvalue = <span class="hljs-number"><span class="hljs-number">0</span></span>) As %Status { Try { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (..Create(..Name(), initvalue)) { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">": """</span></span> _ ..Name() _ <span class="hljs-string"><span class="hljs-string">""";   = "</span></span> _ initvalue <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) Return <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">"       = """</span></span> _ ..Name() _ <span class="hljs-string"><span class="hljs-string">""""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) Return <span class="hljs-number"><span class="hljs-number">0</span></span> } } Catch errobj { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">"    : "</span></span>_errobj.Data <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) Return <span class="hljs-number"><span class="hljs-number">0</span></span> } } /// Callback     Method %OnClose() As %Status [ <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>(msg) Quit $$$OK } }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Note on semaphore naming</b> <div class="spoiler_text">  Semaphores are defined by the name that is passed to the system at the time the semaphore was created.  And this name must meet the requirements for local / global variables.  Naturally, the name of the semaphore must be unique.  Typically, the semaphore is stored in the instance of the database in which it was created, and it is visible to all other processes of this instance.  If the semaphore name complies with the global variable naming rules, then the semaphore becomes available to all running processes, including ECP. <br></div></div><br>  And the last two classes imitate the users entering into the system and leaving it.  To simplify the example, suppose that there are exactly 25 people.  Of course, it would be possible to start the process and create a new user until some key is pressed on the keyboard, but I decided to make it easier and use the end loop.  In both classes, we first connect to the existing semaphore and try to reduce (log in) / increase (log out) the counter.  We assume that the student will wait for his turn indefinitely (well, he really needs to get access), so we use the function <i>Decrement</i> , which allows us to set an infinite waiting period.  Otherwise, we can set a specific time interval to the timeout in tenths of a second.  So that all users do not simultaneously break into the system, put some arbitrary pause before the next login. <br><br><div class="spoiler">  <b class="spoiler_title">SemaphoreSample.LogIn</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SemaphoreSample.LogIn Extends %RegisteredObject [ ProcedureBlock ] { ///      ClassMethod Run() As %Status { // ,      <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> cell = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> cell.Open(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name()) //  <span class="hljs-string"><span class="hljs-string">""</span></span>   //    <span class="hljs-number"><span class="hljs-number">25</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> deccnt = <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">25</span></span> { //    <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> Name = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Library.PopulateUtils).LastName() try { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> result = cell.Decrement(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>) } catch { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..Logger(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name(), msg) Return } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).AddUser(Name) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = Name _ <span class="hljs-string"><span class="hljs-string">"   "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..Logger(Name, msg) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> waitsec = $RANDOM(<span class="hljs-number"><span class="hljs-number">10</span></span>) + <span class="hljs-number"><span class="hljs-number">7</span></span> Hang waitsec } <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">"    "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..Logger(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name(), msg) Quit $$$OK } ///      ClassMethod Logger(id As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, msg As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) [ <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).Logger($Horolog, id, msg) Quit } }</code> </pre></div></div><br>  When disconnecting from the server in our model, you need to check if there are any users there at all.  Therefore, we first look at the contents of the global with users ( <i>^ LoggedUsers</i> ) and if it is empty, then we wait for some arbitrary time and check once again whether someone has logged in to the system. <br><br><div class="spoiler">  <b class="spoiler_title">SemaphoreSample.LogOut</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SemaphoreSample.LogOut Extends %RegisteredObject [ ProcedureBlock ] { ///      ClassMethod Run() As %Status { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> cell = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> cell.Open(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name()) //    <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> addcnt = <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">25</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> inx = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).ChooseUser(.Name) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> inx = <span class="hljs-number"><span class="hljs-number">-1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> waitsec = $RANDOM(<span class="hljs-number"><span class="hljs-number">10</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span> Hang waitsec <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> inx = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).ChooseUser(.Name) } try { <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> cell.Increment(<span class="hljs-number"><span class="hljs-number">1</span></span>) } catch { <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..Logger(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name(), msg) Return } <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> waitsec = $RANDOM(<span class="hljs-number"><span class="hljs-number">15</span></span>) + <span class="hljs-number"><span class="hljs-number">2</span></span> Hang waitsec } <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> msg = <span class="hljs-string"><span class="hljs-string">"    "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ..Logger(##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Counter).Name(), msg) Quit $$$OK } ///      ClassMethod Logger(id As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, msg As %<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) [ <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Util).Logger($Horolog, id, msg) Quit } }</code> </pre></div></div><br>  Now the project is ready.  We compile it and you can run and watch what happened.  We will run in three different windows of the Terminal. <br><br>  In the first window, if necessary, go to the desired namespace (I did a project in the USER namespace) <br><pre> <code class="vbscript hljs">zn <span class="hljs-string"><span class="hljs-string">"USER"</span></span></code> </pre> <br>  and call the start method of our ‚Äúserver‚Äù from the <i>Main</i> class: <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.Main).Run()</code> </pre> <br>  In the second window, we call the <i>Run</i> method from the <i>LogIn</i> class, which will generate users who log into the system: <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.LogIn).Run()</code> </pre> <br>  And in the last window, we call the <i>Run</i> method from the <i>LogOut</i> class, which will generate users who log out: <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SemaphoreSample.LogOut).Run()</code> </pre> <br>  After everyone has logged in and out, we have the following results in the windows: <br><div class="spoiler">  <b class="spoiler_title">The first window will log</b> <div class="spoiler_text">  (1) The process starts at 21:50:44 <br>  (2) Creating a new semaphore at 21:50:44 <br>  (3) Created: ‚ÄúCounter‚Äù;  Initial value = 10 at 21:50:44 <br>  (4) Press any key to stop access ... at 21:50:44 <br>  (61) The semaphore is deleted with status 1 at 10:00:16 <br>  (62) End of the process at 22:00:16 <br>  Log messages: number of records = 62 <br><br>  # Time Sender Message <br>  1) 21:50:44 Main: Start of the process <br>  2) 21:50:44 Counter: Creating a new semaphore <br>  3) 9:50:44 Counter: Created: ‚ÄúCounter‚Äù;  Initial value = 10 <br>  4) 9:50:44 PM Main: Press any key to stop access ... <br>  5) 21:51:00 Counter: Creating a new semaphore <br>  6) 21:51:00 Zemaitis: Zemaitis is logged in <br>  7) 21:51:12 Goldman: Goldman logged in <br>  8) 21:51:24 Cooke: Cooke logged in <br>  9) 21:51:39 Kratzmann: Kratzmann has logged in <br>  10) 21:51:47 Roentgen: Roentgen logged in <br>  11) 21:51:59 Xerxes: Xerxes logged in <br>  12) 21:52:10 Houseman: Houseman logged in <br>  13) 21:52:18 Wijnschenk: Wijnschenk is logged in <br>  14) 21:52:33 Orwell: Orwell logged in <br>  15) 21:52:49 Gomez: Gomez logged in <br>  16) 21:53:46 Counter: Creating a new semaphore <br>  17) 21:53:46 Kratzmann: Kratzmann logged out <br>  18) 21:53:46 Quilty: Quilty logged in <br>  19) 21:54:00 Orwell: Orwell is logged out <br>  20) 21:54:00 Kelvin: Kelvin has logged in <br>  21) 21:54:11 Goldman: Goldman logged out <br>  22) 21:54:11 Nelson: Nelson logged in <br>  23) 21:54:23 Gomez: Gomez is logged out <br>  24) 21:54:23 Ragon: Ragon is logged in. <br>  25) 21:54:30 Zemaitis: Zemaitis is logged out <br>  26) 21:54:31 Quilty: Quilty logged in <br>  27) 21:54:42 Nelson: Nelson is logged out <br>  28) 21:54:42 Williams: Williams is logged in <br>  29) 21:54:49 Houseman: Houseman is logged out <br>  30) 21:54:52 Quilty: Quilty is logged out <br>  31) 21:54:58 Macrakis: Macrakis is logged in <br>  32) 21:55:00 Xerxes: Xerxes is logged out <br>  33) 21:55:02 Quilty: Quilty is logged out <br>  34) 21:55:04 Cooke: Cooke logged out <br>  35) 21:55:08 Brown: Brown logged in <br>  36) 21:55:14 Williams: Williams is logged out <br>  37) 9:55:16 PM Yancik: Yancik has logged in <br>  38) 21:55:17 Kelvin: Kelvin logged out <br>  39) 21:55:26 Roentgen: Roentgen logged out <br>  40) 21:55:27 Jaynes: Jaynes logged in <br>  41) 21:55:34 Jaynes: Jaynes is logged out <br>  42) 21:55:34 Rogers: Rogers Signed In <br>  43) 21:55:47 Basile: Basile logged in <br>  44) 21:55:50 Rogers: Rogers is logged out <br>  45) 21:55:58 Yancik: Yancik logged out <br>  46) 21:56:02 Taylor: Taylor has logged in <br>  47) 21:56:09 Ahmed: Ahmed logged in <br>  48) 21:56:11 Taylor: Taylor is logged out <br>  49) 21:56:15 Wijnschenk: Wijnschenk is logged out <br>  50) 21:56:23 Edwards: Edwards has logged in <br>  51) 21:56:29 Edwards: Edwards is logged out <br>  52) 21:56:32 Counter: Those wishing to log in have ended <br>  53) 21:56:32 Counter: Close the semaphore <br>  54) 21:56:42 Basile: Basile is logged out <br>  55) 21:56:58 Macrakis: Macrakis is logged out <br>  56) 21:57:11 Ahmed: Ahmed logged out <br>  57) 21:57:18 Ragon: Ragon is logged out <br>  58) 21:57:31 Brown: Brown logged out <br>  59) 21:57:36 Counter: All users are logged out <br>  60) 21:57:36 Counter: Close the semaphore <br>  61) 22:00:16 Main: Semaphore deleted with status 1 <br>  62) 22:00:16 Main: End of the process <br>  (63) Close the semaphore at 10:00:16 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">In the second window there will be a log</b> <div class="spoiler_text">  (5) Creating a new semaphore at 21:51:00 <br>  (6) Zemaitis entered the system at 21:51:00 <br>  (7) Goldman logged in at 9:51:12 PM <br>  (8) Cooke logged in at 9:51:24 <br>  (9) Kratzmann logged in at 9:51:39 PM <br>  (10) Roentgen logged in at 9:51:47 PM <br>  (11) Xerxes logged in at 9:51:59 PM <br>  (12) Houseman logged in at 21:52:10 <br>  (13) Wijnschenk logged in at 21:52:18 <br>  (14) Orwell logged in at 21:52:33 <br>  (15) Gomez logged in at 21:52:49 <br>  (18) Quilty logged in at 9:53:46 PM <br>  (20) Kelvin logged in at 21:54:00 <br>  (22) Nelson logged in at 9:54:11 <br>  (24) Ragon logged in at 21:54:23 <br>  (26) Quilty logged in at 9:54:31 <br>  (28) Williams logged in at 21:54:42 <br>  (31) Macrakis logged in at 21:54:58 <br>  (35) Brown logged in at 9:55:08 <br>  (37) Yancik logged in at 9:55:16 PM <br>  (40) Jaynes logged in at 9:55:27 PM <br>  (42) Rogers logged in at 9:55:34 <br>  (43) Basile logged in at 9:55:47 <br>  (46) Taylor logged in at 9:56:02 PM <br>  (47) Ahmed logged in at 9:56:09 PM <br>  (50) Edwards logged in at 9:56:23 PM <br>  (52) Those wishing to log in ended at 21:56:32 <br>  (53) Close the semaphore at 21:56:32 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">In the third window will be a log</b> <div class="spoiler_text">  (16) Creating a new semaphore at 21:53:46 <br>  (17) Kratzmann logged out at 9:53:46 PM <br>  (19) Orwell logged out at 21:54:00 <br>  (21) Goldman logged out at 9:54:11 <br>  (23) Gomez logged out at 9:54:23 PM <br>  (25) Zemaitis is logged out at 9:54:30 <br>  (27) Nelson logged out at 9:54:42 <br>  (29) Houseman logged out at 9:54:49 PM <br>  (30) Quilty logged out at 9:54:52 <br>  (32) Xerxes logged out at 9:55:00 PM <br>  (33) Quilty is signed out at 9:55:02 PM <br>  (34) Cooke logged out at 9:55:04 <br>  (36) Williams logged out at 9:55:14 <br>  (38) Kelvin logged out at 9:55:17 <br>  (39) Roentgen logged out at 9:55:26 PM <br>  (41) Jaynes logged out at 9:55:34 <br>  (44) Rogers logged out at 9:55:50 <br>  (45) Yancik logged out at 9:55:58 <br>  (48) Taylor logged out at 9:56:11 <br>  (49) Wijnschenk logged out at 9:56:15 <br>  (51) Edwards logged out at 9:56:29 <br>  (54) Basile logged off at 9:56:42 PM <br>  (55) Macrakis logged out at 9:56:58 <br>  (56) Ahmed logged out at 9:57:11 <br>  (57) Ragon logged out at 9:57:18 PM <br>  (58) Brown logged out at 9:57:31 <br>  (59) All users are logged off at 21:57:36 <br>  (60) Close the semaphore at 21:57:36 <br></div></div><br>  Now let's take a closer look at what happened.  I specifically waited for the 10 allowed users to ‚Äúenter‚Äù into the system to show that the semaphore value could not be less than 0. These are the users above the red line in the figure.  We see that there is a break almost a minute before being allowed to log in to the next user.  And that only after someone came out.  I deliberately <b>bold the</b> users who are logged in, and <s><i>strikethrough</i></s> those who leave it.  The colors are highlighted by the entry / exit pairs for each user. <br><br><img src="https://habrastorage.org/files/320/870/aed/320870aedc1747a79d953c1bb3bfec70.png"><br><br>  As for me, an interesting picture came out. <br><br>  In addition to the <i>Increment</i> and <i>Decrement</i> methods used in the example, you can use the wait list and methods for working with it to work with the semaphore: <br><ul><li>  <b>AddToWaitMany</b> - adding a semaphore operation to the list </li><li>  <b>RemoveFromWaitMany</b> - remove an operation from the list </li><li>  <b>WaitMany</b> - wait until all operations on the semaphore are completed. </li></ul><br>  In this case, <i>WaitMany loops</i> through all the tasks in the list and, after successfully completing the operation, calls the <i>Waitback</i> method <i>WaitCompleted</i> , which the developer must implement on his own.  It is called when the semaphore has allocated a non-zero value for the operation, or the wait has timed out.  The number by which the counter has been reduced is returned to the argument of this method (0 in the case of a timeout).  After this method has worked, the semaphore is removed from the WaitMany task list and then the next task is carried out. <br><br>  More information on semaphores in Cach√© can be found in the documentation (there you can also see another example of working with a semaphore) and in the class description.  <i>Since at the time of the creation of the article, the version of Cach√© 2014.2 is available only on the <a href="http://www.intersystems.com/services-support/product-support/prerelease-trial-program/">field test portal</a> for users on the support and participants of the academic program of <a href="http://intersystems.ru/cache/education/cachecampus/">InterSystems University</a> , the links will be added as soon as the release is released.</i> <br><br>  The project is on <a href="https://github.com/Gra-ach/CacheSemaphore">github</a> . <br><br>  If there are comments, comments or suggestions - you are welcome.  Thank you for attention! </div><p>Source: <a href="https://habr.com/ru/post/243337/">https://habr.com/ru/post/243337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243323/index.html">Mobile Pwn2Own 2014: results</a></li>
<li><a href="../243327/index.html">Using Go in Government</a></li>
<li><a href="../243329/index.html">JarvisJS: Functional Testing of Web Applications</a></li>
<li><a href="../243331/index.html">The digest of interesting materials for the mobile developer # 79 (November 10-16)</a></li>
<li><a href="../243335/index.html">npm for mere mortals</a></li>
<li><a href="../243339/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ22 (10 - 16 November 2014)</a></li>
<li><a href="../243343/index.html">Some interesting and useful things for web developer # 33</a></li>
<li><a href="../243345/index.html">Test iOS8 apps with Xcode 6.1 without Apple Developer Program Membership (Jailbreak) (Updated for Xcode 6.4)</a></li>
<li><a href="../243347/index.html">Repair through the ass or why you need debug-thinking</a></li>
<li><a href="../243351/index.html">Code that does not exist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>