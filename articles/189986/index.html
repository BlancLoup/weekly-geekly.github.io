<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python inside. Objects Head</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introduction 
 2. Objects. Head 
 3. Objects. Tail 
 4. Process structures 

 We continue to understand the insides of Python. Last time, we learne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python inside. Objects Head</h1><div class="post__text post__text-html js-mediator-article"><a href="http://www.flickr.com/photos/14405058%40N08/2168873251"><img src="https://habrastorage.org/getpro/habr/post_images/0b5/22b/bd6/0b522bbd67604b71187629990ede7ef4.jpg" align="left"></a>  1. <a href="http://habrahabr.ru/post/189972/">Introduction</a> <br>  2. <b>Objects.</b>  <b>Head</b> <br>  3. <a href="http://habrahabr.ru/post/190336/">Objects.</a>  <a href="http://habrahabr.ru/post/190336/">Tail</a> <br>  4. <a href="http://habrahabr.ru/post/191032/">Process structures</a> <br><br>  <i>We continue to understand the insides of Python.</i>  <i><a href="http://habrahabr.ru/post/189972/">Last time,</a> we learned how Python digests a simple program.</i>  <i>Today we begin to study the structure of its object system.</i> <br><br>  As I wrote in the previous episode (which, by the way, turned out to be successful; thank you all, your views and comments literally make me move on!) - today's post is dedicated to the implementation of <b>objects</b> in Python 3.x.  At first, I thought it was a simple topic.  But even when I read all the code that had to be read before writing a post, I can hardly say that the Python object system ... uhh, ‚Äúsimple‚Äù (and I can‚Äôt say that I understood it to the end).  But I was even more convinced that the implementation of objects is a good topic to start with.  In the following posts we will see how important it is.  At the same time, I suspect, very few people, even among the veterans of Python, fully understand it.  Objects are loosely connected with the rest of Python (when I wrote a post I didn‚Äôt look into <a href="http://hg.python.org/cpython/file/tip/Python"><code>./Python</code></a> and learned more <a href="http://hg.python.org/cpython/file/tip/Objects"><code>./Objects</code></a> and <a href="http://hg.python.org/cpython/file/tip/Include"><code>./Include</code></a> ).  It seemed to me easier to consider the implementation of objects as if it is not at all connected with everything else.  So, as if it is a universal API in the C language for creating object subsystems.  Perhaps it will also be easier for you to think in this way: remember, all this is just a set of structures and functions for managing these structures. <br><a name="habracut"></a><br>  Everything in Python is an object: numbers, dictionaries, user and built-in classes, stack frames and code objects.  In order for a pointer to a memory location to be considered an object, at least two fields are needed, defined in the <a href=""><code>./Include/object.h</code></a> structure: <a href="http://docs.python.org/3/c-api/structures.html"><code>PyObject</code></a> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> _object { Py_ssize_t ob_refcnt; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> _typeobject *ob_type; } PyObject;</code> </pre><br>  Many objects expand this structure by adding the required fields, but these two fields must be present anyway: the <b>reference counter</b> and the <b>type</b> (a pair of mysterious fields are added to track the references in special debug builds). <br><br>  The reference count is a number indicating how many other objects refer to the given.  In the code <code>&gt;&gt;&gt; a = b = c = object()</code> , an empty object is initialized and associated with three different names: <code>a</code> , <code>b</code> and <code>c</code> .  Each name creates a new link to the object, but the object is created once.  Linking an object with a new name or adding an object to the list creates a new link, but does not create a new object!  On this topic, you can still talk a <a href="http://docs.python.org/3/c-api/intro.html">lot</a> , but this is more related to garbage collection, and not to the object system.  I'd rather write a separate post about this, instead of sorting out this question here.  But before leaving this topic, I‚Äôll say that now it's easier for us to understand the macro <a href=""><code>./Include/object.h</code></a> : <a href="http://docs.python.org/c-api/refcounting.html"><code>Py_DECREF</code></a> , which we met in the first part: it only decrements <code>ob_refcnt</code> (and frees resources if <code>ob_refcnt</code> takes a zero value) .  On it we will finish with reference counting. <br><br>  It remains to make out <code>ob_type</code> , a pointer to <b>an</b> object <b>type</b> , the central concept of a Python object model (keep in mind: in the third Python, the <i>type</i> and <i>class</i> are essentially the same; for <a href="http://www.python.org/download/releases/2.2/descrintro/">historical reasons, the</a> use of these terms depends on the context).  Each object has only one type that does not change during the life of the object (the type can change in extremely rare circumstances. There is no API for this task, and you would hardly have read this article if you were working with objects with changing types).  Perhaps more importantly, the fact that the type of the object (and <i>only the</i> type of the object) determines what can be done with it (an example in the spoiler after this paragraph).  As you remember from the first part, when performing the subtraction operation, the same function is called ( <code>PyNumber_Subtract</code> ) regardless of the type of operands: for integers, for integer and fractional, or even for complete absurdity, like subtracting an exception from the dictionary. <br><br><div class="spoiler">  <b class="spoiler_title">Show code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ,   , ,      &gt;&gt;&gt; class Foo(object): ... "I don't have __call__, so I can't be called" ... &gt;&gt;&gt; class Bar(object): ... __call__ = lambda *a, **kw: 42 ... &gt;&gt;&gt; foo = Foo() &gt;&gt;&gt; bar = Bar() &gt;&gt;&gt; foo() Traceback (most recent call last): File "&lt;stdin&gt;", line 1, in &lt;module&gt; TypeError: 'Foo' object is not callable &gt;&gt;&gt; bar() 42 #   __call__? &gt;&gt;&gt; foo.__call__ = lambda *a, **kw: 42 &gt;&gt;&gt; foo() Traceback (most recent call last): File "&lt;stdin&gt;", line 1, in &lt;module&gt; TypeError: 'Foo' object is not callable #      Foo? &gt;&gt;&gt; Foo.__call__ = lambda *a, **kw: 42 &gt;&gt;&gt; foo() 42 &gt;&gt;&gt;</span></span></code> </pre> </div></div><br>  At first it seems strange.  How can a single function support <i>any</i> kind of objects passed to it?  It can get a <code>void *</code> pointer (in fact, it will get a <code>PyObject *</code> pointer, which is also opaque to the data), but how does it determine what to do with the resulting argument?  The answer lies in the type of object.  A type is also an object (it has both a reference count and its own type; the type of most types is <code>type</code> ), but in addition to the two main fields it contains many other fields.  The structure definition and description of its fields are <a href="http://docs.python.org/3/c-api/typeobj.html">here</a> .  The definition itself is in <a href=""><code>./Include/object.h</code></a> : <code>PyTypeObject</code> .  I recommend to contact him in the course of reading the article.  Many fields of an object of a type are called <b>slots</b> and indicate functions (or structures indicating related functions) that will be executed when calling the C-API function Python on objects of this type.  And although it seems to us that <code>PyNumber_Subtract</code> works with arguments of different types, in fact, the types of operands are dereferenced and the subtraction function specific to this type is called.  Thus, the C-API functions are not universal.  They rely on types and abstract from details, and it seems that they work with any data (while throwing a <code>TypeError</code> exception is also a job). <br><br>  Let's look at the details.  <code>PyNumber_Subtract</code> calls the universal function of two arguments <a href=""><code>./Objects/abstract.c</code></a> : <code>binary_op</code> , specifying that you need to work with the <code>nb_subtract</code> slot (there are similar slots for other operations, for example, <code>nb_negative</code> for negating numbers or <code>sq_length</code> for determining the length of a sequence).  <code>binary_op</code> is a error-checking wrapper over <code>binary_op1</code> , a function that does all the work.  <a href=""><code>./Objects/abstract.c</code></a> : <code>binary_op1</code> (read this function code - opens eyes to many things) takes the operands of the operation <code>BINARY_SUBTRACT</code> as <code>v</code> and <code>w</code> , and tries to dereference <code>v-&gt;ob_type-&gt;tp_as_number</code> , a <a href="http://docs.python.org/3/c-api/typeobj.html">structure</a> containing pointers to functions that implement numeric protocol.  <code>binary_op1</code> expects to find in <code>tp_as_number-&gt;nb_subtract</code> C function that either subtracts or returns the special value <code>Py_NotImplemented</code> if it determines that the operands are incompatible as decremented and subtracted (this will throw a <code>TypeError</code> exception). <br><br>  If you want to change the behavior of objects, you can write an extension in C that overrides the <code>PyTypeObject</code> structure and fills in the slots as you like.  When we create new types in Python ( <code>&gt;&gt;&gt; class Foo(list): pass</code> creates a new <i>type</i> , classes and types are one and the same), we do not manually describe any structures and do not fill in any slots.  But why then do these types behave the same as the built-in ones?  That's right, because of inheritance, in which typing has a significant role.  Python already has some built-in types, like <code>list</code> and <code>dict</code> .  As mentioned, these types have certain functions that fill the corresponding slots, which gives objects the desired behavior: for example, the variability of a sequence of values ‚Äã‚Äãor the mapping of keys to values.  When you create a new type in Python, on the heap for it (as for any other object) a new C-structure is dynamically determined and its slots are filled accordingly to the inherited, <i>basic</i> , type (you can ask, <i>what about multiple heritability?</i> <i>in other episodes</i> ).  Since  slots copied, newly conscious subtype and base have almost identical functionality.  In Python, there is a base type without any functionality - <code>object</code> ( <code>PyBaseObject_Type</code> in C), in which almost all slots are set to zero, and which can be expanded without inheriting anything. <br><br>  Thus, you cannot <i>create a</i> type in Python, you always inherit from something else (if you define a class without explicit inheritance, it will implicitly inherit from <code>object</code> ; in Python 2.x, in this case a ‚Äúclassic‚Äù class will be created , we will not consider them).  Naturally, you do not need to constantly inherit <i>everything</i> .  You can change the behavior of the type created right in Python, as shown in the snippet above.  Defining a <a href="http://habrahabr.ru/post/186608/">special method</a> <a href="http://docs.python.org/py3k/reference/datamodel.html">__call__</a> for the class <code>Bar</code> , we have made instances of this class callable. <br><br>  Something, somewhere, during the creation of our class, notices this method <code>__call__</code> and associates it with the <code>tp_call</code> slot.  <a href=""><code>./Objects/typeobject.c</code></a> : <code>type_new</code> is a complex, important function - this is the place where all this happens.  We will take a closer look at this function in the next post, and now we will pay attention to the line almost at the very end, after the new type has already been created, but before returning it: <code>fixup_slot_dispatchers(type);</code>  .  This function runs over all the correctly named methods defined in the new type and associates them with the necessary slots in the type structure, based on the names of the methods (but where are these methods stored?). <br><br>  Another incomprehensible point: how does the definition of a <code>__call__</code> method in a type <i>after its creation</i> make instances of this type invoked, even if they were instantiated before defining the method?  Easy and simple, my friends.  As you remember, a type is an object, and a type type is a <code>type</code> (if you have a broken head, do: <code>&gt;&gt;&gt; class Foo(list): pass ; type(Foo)</code> ).  Therefore, when we do something with a class (we could write the word <i>type</i> instead of <i>class</i> , but since we use ‚Äútype‚Äù in a different context, let's call our type a class for some time), for example, we call, we subtract or we define an attribute, the <code>ob_type</code> field of the <code>ob_type</code> object is dereferenced, and it is discovered that the type of the class is <code>type</code> .  Then to set the attribute, the slot <code>type-&gt;tp_setattro</code> .  That is, a class can have a separate attribute setting function.  And such a specific function (if you want to make friends on Facebook, here is its page - <a href=""><code>./Objects/typeobject.c</code></a> : <code>type_setattro</code> ) calls the same function ( <code>update_one_slot</code> ) that <code>fixup_slot_dispatchers</code> uses to resolve all issues after defining a new attribute.  New parts are revealed! <br><br>  On it, probably, it is necessary to finish introduction to objects of the Python.  I hope you enjoyed the trip and you are still with me.  I have to admit that writing this post turned out to be much more difficult than I thought (and without the help of <i>Antoine Pitrou</i> and <i>Mark Dickins</i> late at night on <code>#python-dev</code> I would most likely have given up!).  We still have a lot of interesting things: which slot of the operand is used in binary operations?  What happens with <a href="http://docs.python.org/3/tutorial/classes.html">multiple inheritance</a> , and what about those <s>dreadful</s> little details associated with it?  What about <a href="http://docs.python.org/3/reference/datamodel.html">metaclasses</a> ?  And <a href="http://docs.python.org/3/reference/datamodel.html"><code>__slots__</code></a> and <a href="http://docs.python.org/3/library/weakref.html">weak links</a> ?  What is going on in the built-in objects?  How do <i>dictionaries</i> , <i>lists</i> , <i>sets</i> and their brethren work?  And finally, what about <i>this</i> miracle? <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>a = object() &gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> ... &gt;&gt;&gt; b = C() &gt;&gt;&gt; a.foo = <span class="hljs-number"><span class="hljs-number">5</span></span> Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; AttributeError: <span class="hljs-string"><span class="hljs-string">'object'</span></span> object has no attribute <span class="hljs-string"><span class="hljs-string">'foo'</span></span> &gt;&gt;&gt; b.foo = <span class="hljs-number"><span class="hljs-number">5</span></span> &gt;&gt;&gt;</code> </pre><br>  How can you just add an arbitrary attribute to <code>b</code> , an instance of class <code>C</code> , which inherits from <code>object</code> , and you can't do the same with <code>a</code> , an instance of the same <code>object</code> ?  Those who know can say: <code>b</code> has <code>__dict__</code> , but <code>a</code> does not.  Yes it is.  But where did this new (and completely non-trivial!) Functionality come from if we don‚Äôt inherit it? <br><br>  Ha!  I am extremely happy with such questions!  The answers <i>will be</i> , but in the next episode. <br><br><hr><br>  A short list of references for curious: <br><br><ul><li>  documentation on <a href="http://docs.python.org/3/reference/datamodel.html">the data model</a> (the pythonic side of the force); </li><li>  C-API documentation on <a href="http://docs.python.org/3/c-api/abstract.html">abstract</a> and <a href="http://docs.python.org/3/c-api/concrete.html">concrete</a> objects (the side of force); </li><li>  <a href="http://www.python.org/download/releases/2.2.3/descrintro/">descrintro</a> , or the <i>Unification of Types and Classes in Python 2.2</i> , is a long, brain-bearing and extremely important archaeological find (I think that it should be added to the interpreter as a Easter egg, I suggest <code>&gt;&gt;&gt; import THAT</code> ); </li><li>  but above all this file is <a href=""><code>./Objects/typeobject.c</code></a> .  Read it again and again, until in tears you fall on the bed. </li></ul><br>  Have a nice sleep. <br><br><hr><br>  <i>Remember!</i>  <i><a href="http://buruki.ru/">We are</a> always happy to <a href="http://hantim.ru/jobs/21698-python-django-razrabotchik">meet</a> with interested people.</i> </div><p>Source: <a href="https://habr.com/ru/post/189986/">https://habr.com/ru/post/189986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189972/index.html">Python inside. Introduction</a></li>
<li><a href="../189974/index.html">How do spam traps help fight spam?</a></li>
<li><a href="../189980/index.html">Calculate keyed input using python</a></li>
<li><a href="../189982/index.html">Generating numbers for lucky tickets</a></li>
<li><a href="../189984/index.html">BLIND GAMES - an exam for a game developer</a></li>
<li><a href="../189990/index.html">EFF dissatisfied with the ban on servers at Internet providers</a></li>
<li><a href="../189992/index.html">The Kleene Fixed Point Theorem: Quine</a></li>
<li><a href="../189994/index.html">Some interesting and useful things for web developer</a></li>
<li><a href="../189996/index.html">About cyber warfare</a></li>
<li><a href="../189998/index.html">Toshiba Qosmio X70 laptop video review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>