<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik. IPSEC vpn over NAT as client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 

 It so happened that in our company over the past two years, we are gradually turning to microtics. The main nodes are built on the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik. IPSEC vpn over NAT as client</h1><div class="post__text post__text-html js-mediator-article">  Good day to all! <br><br>  It so happened that in our company over the past two years, we are gradually turning to microtics.  The main nodes are built on the CCR1072, and the local connection points for computers on devices are simpler.  Of course, there is also an association of networks via IPSEC tunnel, in this case the setup is quite simple and does not cause any difficulties, since there are a lot of materials on the network.  But with the mobile connection of clients there are certain difficulties, the manufacturer‚Äôs wiki tells you how to use the Shrew soft VPN client (everything seems clear for this setup) and this particular client uses 99% of remote access users, and 1% is me, I was just too lazy once I entered my username and password into the client and I wanted a lazy location on the sofa and a convenient connection to the work networks.  There are no instructions for setting up Mikrotik for situations where it is not even behind a gray address, but completely behind a black one and maybe even a few NATs on the network.  Therefore I had to improvise, and therefore I propose to look at the result. <br><br>  There is: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  CCR1072 as the main device.  version 6.44.1 </li><li>  CAP ac as a home connection point.  version 6.44.1 </li></ol><br>  The main feature of the setting is that the PC and Mikrotik must be in the same network with the same addressing, as issued by the core 1072. <br><a name="habracut"></a><br>  Go to the setting: <br><br>  1. Of course we turn on Fasttrack, but since fasttrack is not compatible with the VPN, we have to cut its traffic. <br><br><pre><code class="plaintext hljs">/ip firewall mangle add action=mark-connection chain=forward comment="ipsec in" ipsec-policy=\ in,ipsec new-connection-mark=ipsec passthrough=yes add action=mark-connection chain=forward comment="ipsec out" ipsec-policy=\ out,ipsec new-connection-mark=ipsec passthrough=yes /ip firewall filter add action=fasttrack-connection chain=forward connection-mark=!ipsec</code> </pre> <br>  2. Add network probes from / to home and work <br><br><pre> <code class="plaintext hljs">/ip firewall raw add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.76.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.98.0/24 add action=accept chain=prerouting dst-address=10.7.76.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.77.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.98.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.77.0/24</code> </pre><br>  3. Create a user connection description <br><br><pre> <code class="plaintext hljs">/ip ipsec identity add auth-method=pre-shared-key-xauth notrack-chain=prerouting peer=CO secret=\   xauth-login=username xauth-password=password</code> </pre><br>  4. Create IPSEC Proposal <br><br><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des lifetime=5m name="prop1" pfs-group=none</code> </pre><br>  5. Create IPSEC Policy <br><br><pre> <code class="plaintext hljs">/ip ipsec policy add dst-address=10.7.76.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes add dst-address=10.7.77.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes</code> </pre><br>  6. Create an IPSEC profile <br><br><pre> <code class="plaintext hljs">/ip ipsec profile set [ find default=yes ] dpd-interval=disable-dpd enc-algorithm=\ aes-192,aes-128,3des nat-traversal=no add dh-group=modp1024 enc-algorithm=aes-192,aes-128,3des name=profile_1 add name=profile_88 add dh-group=modp1024 lifetime=4h name=profile246</code> </pre><br>  7. Create IPSEC peer <br><br><pre> <code class="plaintext hljs">/ip ipsec peer add address=&lt;white IP 1072&gt;/32 local-address=&lt;  &gt; name=CO profile=\ profile_88</code> </pre><br>  And now some simple magic.  Since I didn‚Äôt really like to change the settings on all devices in my home network, I had to somehow hang up DHCP on the same network, but it is reasonable that Mikrotik does not allow hanging more than one address pool on one bridge, so I found a workaround option, namely for a laptop, he simply created DHCP Lease with the manual indication of parameters, and since netmask, gateway &amp; dns also have option numbers in DHCP, I specified them manually. <br><br>  1. DHCP Option <br><br><pre> <code class="plaintext hljs">/ip dhcp-server option add code=3 name=option3-gateway value="'192.168.33.1'" add code=1 name=option1-netmask value="'255.255.255.0'" add code=6 name=option6-dns value="'8.8.8.8'"</code> </pre><br>  2. DHCP Lease <br><br><pre> <code class="plaintext hljs">/ip dhcp-server lease add address=192.168.33.4 dhcp-option=\ option1-netmask,option3-gateway,option6-dns mac-address=&lt;MAC  &gt;</code> </pre><br>  At the same time, setting 1072 is practically basic, only when issuing an IP address to a client, in the settings, it is indicated that it is to give it an IP address entered manually, and not from a pool.  For regular clients from personal computers, the subnet is the same as in the configuration with Wiki 192.168.55.0/24. <br><br>  And I‚Äôll add a little, on the primary connection server 1072, you must also add to the IP-Firewall-RAW rules for symmetric forwarding of networks.  When adding a new network probros, you need to add rules to the IPSEC-Policy on the client, server, and also on the IP-Firewall-RAW server and the clipping list from NAT. <br><br>  Such a setting allows the PC not to connect through third-party software, and the tunnel itself is raised by the router as needed.  Client CAP ac load is almost minimal, 8-11% at a speed of 9-10MB / s in the tunnel. <br><br>  All settings were made via Winbox, although with the same success can be carried out through the console. </div><p>Source: <a href="https://habr.com/ru/post/448052/">https://habr.com/ru/post/448052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448036/index.html">Import to J.Connect from the file of the list of users through the API</a></li>
<li><a href="../448040/index.html">The digest of interesting materials for the mobile developer # 294 (April 8 - 14)</a></li>
<li><a href="../448044/index.html">Some aspects of monitoring MS SQL Server. Recommendations for setting trace flags</a></li>
<li><a href="../448048/index.html">Understanding Angular Ivy: Increase DOM and Virtual DOM</a></li>
<li><a href="../448050/index.html">Amateur holography - silver halide photographic materials</a></li>
<li><a href="../448054/index.html">SciPy, conditions optimization</a></li>
<li><a href="../448058/index.html">Developing a hexapod from scratch (part 5) - electronics</a></li>
<li><a href="../448060/index.html">We write a simple NTP client</a></li>
<li><a href="../448068/index.html">American scientists have taught robots to use auxiliary tools</a></li>
<li><a href="../448072/index.html">Joins understanding is broken. This is definitely not a lap crossing, honestly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>