<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Transparent" Squid with HTTPS filtering resources without certificate substitution (x86, x64 - universal instruction)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! The last article about transparent HTTPS proxying using Squid was quite successful. A lot of feedback came in the mail about the successful ins...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Transparent" Squid with HTTPS filtering resources without certificate substitution (x86, x64 - universal instruction)</h1><div class="post__text post__text-html js-mediator-article">  Hello!  <a href="http://habrahabr.ru/post/267851/">The last article</a> about transparent HTTPS proxying using Squid was quite successful.  A lot of feedback came in the mail about the successful installation of this system.  But there were also letters asking for help.  The problems were quite solvable.  But not so long ago, a colleague approached me with a request for assistance in installing this system on x64 architecture (Debian).  Here we are puzzled.  Firstly, it turned out that the previous article was unsuitable for this due to the lack of necessary source codes in the Debian repository (there is now 3.5.10 there).  It was not possible to find the Debian sources needed in the first article, and checkinstall produced strange errors.  Secondly, I wanted a more universal solution that would work without problems on x64, x86, and (if possible) on other distributions.  A solution was found.  It turned out a small addition to the previous article + some clarifications.  This instruction allows you to compile both x86 and x64 versions of Squid and create the appropriate packages.  The instruction will be divided into several points and sub-items.  If interested, go under the cat: <br><a name="habracut"></a>  We go in order. <br>  one) <br>  a) To get started, prepare for the assembly of packages: <br><pre><code class="bash hljs">apt-get install git fakeroot checkinstall build-essential devscripts patch apt-cache policy squid3 apt-get build-dep squid3 apt-get build-dep libecap2 apt-get install libssl-dev libgnutls28-dev</code> </pre> <br>  Do not forget to go to the folder where you will collect the source so as not to rid yourself of Home. <br>  b) Next, download the libressl: <br><pre> <code class="bash hljs">wget http://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-2.1.6.tar.gz tar -xzvf libressl-2.1.6.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libressl-2.1.6</code> </pre><br>  c) And now we collect: <br><pre> <code class="bash hljs">./configure make checkinstall --pkgname libressl --pkgversion 2.1.6</code> </pre><br><br>  2) Now you can install libressl: <br><pre> <code class="bash hljs">dpkg -i libressl_2.1.6-1_amd64.deb ldconfig</code> </pre><br>  After installation, you must configure the use of LibreSSL by default: <br><pre> <code class="bash hljs">mv /usr/bin/openssl /usr/bin/openssl-1 update-alternatives --install /usr/bin/openssl openssl /usr/bin/openssl-1 10 update-alternatives --install /usr/bin/openssl openssl /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/openssl 50 update-alternatives --config openssl</code> </pre><br>  Check to see if Libressl was installed: <br><pre> <code class="bash hljs">openssl version LibreSSL 2.1.6</code> </pre><br>  If the console exhaust is similar, then everything worked out.  Go ahead. <br><br>  3) At the queue Libecap. <br>  a) You need to edit sources.list, including the source code from the testing branch (this is necessary, since we need to compile a new libecap, which in turn is required to build Squid): <br><pre> <code class="bash hljs">deb-src http://ftp.de.debian.org/debian/ testing main contrib non-free</code> </pre><br>  Update the package cache: <br><pre> <code class="bash hljs">apt-get update</code> </pre><br>  And now we download the necessary sources from Testing: <br><pre> <code class="bash hljs">apt-get <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> libecap3/testing</code> </pre><br>  Next, collect libecap: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libecap-1.0.1/ dpkg-buildpackage -us -uc -nc -d</code> </pre><br>  b) Remove the old one and install the new one: <br><pre> <code class="bash hljs">apt-get purge libecap2 libecap3_1.0.1-2_amd64.deb libecap3-dev_1.0.1-2_amd64.deb</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      4) Sked to the compilation of Squid itself. <br>  a) Download the <s>latest and</s> <u>most</u> efficient Squid snapshot: <br><pre> <code class="bash hljs">wget http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.8.tar.gz</code> </pre><br>  Unpack: <br><pre> <code class="bash hljs">tar -xf squid-3.5.8.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> squid-3.5.8</code> </pre><br>  b) Download patch for bio.cc, and patch: <br><pre> <code class="bash hljs">wget -O bug-4330-put_cipher_by_char-t1.patch http://bugs.squid-cache.org/attachment.cgi?id=3216 patch -p0 -i bug-4330-put_cipher_by_char-t1.patch ¬ª patching file src/ssl/bio.cc</code> </pre><br><br>  5) And this stage is one of the most responsible.  It is necessary to configure Squid with the necessary options.  In the previous article, the debian / rules file was used, but we will compile Squid in this instruction using make, and we will create packages using checkinstall.  Therefore, there will be more options.  And here are some: <br><pre> <code class="bash hljs">./configure --build=x86_64-linux-gnu \ --prefix=/usr \ --includedir=<span class="hljs-variable"><span class="hljs-variable">${prefix}</span></span>/include \ --mandir=<span class="hljs-variable"><span class="hljs-variable">${prefix}</span></span>/share/man \ --infodir=<span class="hljs-variable"><span class="hljs-variable">${prefix}</span></span>/share/info \ --sysconfdir=/etc \ --localstatedir=/var \ --libexecdir=<span class="hljs-variable"><span class="hljs-variable">${prefix}</span></span>/lib/squid \ --srcdir=. \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-maintainer-mode \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-dependency-tracking \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-silent-rules \ --datadir=/usr/share/squid \ --sysconfdir=/etc/squid \ --mandir=/usr/share/man \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-inline \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-arch-native \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-async-io=8 \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-storeio=ufs,aufs,diskd,rock \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-removal-policies=lru,heap \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-delay-pools \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-cache-digests \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-icap-client \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-follow-x-forwarded-for \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-auth-digest=file,LDAP \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-auth-negotiate=kerberos,wrapper \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-auth-ntlm=fake,smb_lm \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-url-rewrite-helpers=fake \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-eui \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-esi \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-icmp \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-zph-qos \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-ecap \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-translation \ --with-swapdir=/var/spool/squid \ --with-logdir=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/squid \ --with-pidfile=/var/run/squid.pid \ --with-filedescriptors=65536 \ --with-large-files \ --with-default-user=proxy \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-ssl \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-ssl-crtd \ --with-openssl \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-linux-netfilter \ <span class="hljs-string"><span class="hljs-string">'CFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall'</span></span> \ <span class="hljs-string"><span class="hljs-string">'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now'</span></span> \ <span class="hljs-string"><span class="hljs-string">'CPPFLAGS=-D_FORTIFY_SOURCE=2'</span></span> \ <span class="hljs-string"><span class="hljs-string">'CXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security'</span></span></code> </pre><br>  Be extremely attentive.  We are more interested, as in the previous article, three options: --enable-ssl, --enable-ssl-crtd, --with-openssl.  The remaining options can be changed in accordance with your preferences (if you want to change them, be sure to read the documentation on configuration). <br><br>  6) Now we got to compiling. <br>  a) Compile. <br><pre> <code class="bash hljs">make</code> </pre><br>  b) Ambiguous stage.  It is necessary to create the / usr / share / squid / and / usr / share / squid / icons directories, otherwise the following stage will not be executed due to the absence of these folders (why checkinstall does not create them, I did not understand, unfortunately): <br><pre> <code class="bash hljs">mkdir -p /usr/share/squid/icons</code> </pre><br>  c) And now we create installation packages: <br><pre> <code class="bash hljs">checkinstall --pkgname squid --pkgversion 3.5.8</code> </pre><br><br>  7) We are approaching the final.  Install Squid: <br><pre> <code class="bash hljs">dpkg -i squid_3.5.8-1_amd64.deb</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text">  Yes, that's right, it turned out just one file, while in the previous article there were several of them, as is customary in Debian. <br></div></div><br><br>  8) Try running squid: <br><pre> <code class="bash hljs">systemctl start squid</code> </pre><br>  And we see a big FIG!  Wow ... We try in the old-fashioned way: <br><pre> <code class="bash hljs">service squid start</code> </pre><br>  And we also see a big FIG.  Why?  Because checkinstall did not include the Squid service files in the package.  No problem.  Create the necessary systemd service yourself: <br><pre> <code class="bash hljs">touch /etc/systemd/system/squid.service nano /etc/systemd/system/squid.service</code> </pre><br>  With the following content: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">## Copyright (C) 1996-2015 The Squid Software Foundation and contributors ## ## Squid software is distributed under GPLv2+ license and includes ## contributions from numerous individuals and organizations. ## Please see the COPYING and CONTRIBUTORS files for details. ## [Unit] Description=Squid Web Proxy Server After=network.target [Service] Type=simple ExecStart=/usr/sbin/squid -sYC -N ExecReload=/bin/kill -HUP $MAINPID KillMode=process [Install] WantedBy=multi-user.target</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text">  In fact, this very service is in the archive with the source code for Squid.  For what reasons, Checkinstall did not include it in the package, it is not known. <br></div></div><br><br>  Enable the created service <br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> squid</code> </pre><br><br>  9) Yes, you are right, that's not all.  Since we compiled completely original sources (with the exception of the bio.cc patch), we have installed the configuration files like squid.conf.default, mime.conf.default, etc.  Of course, Squid did not hear about them.  Rename them to Squid's readable view: <br><pre> <code class="bash hljs">cp /etc/squid/squid.conf.default /etc/squid/squid.conf cp /etc/squid/mime.conf.default /etc/squid/mime.conf cp /etc/squid/cachemgr.conf.default /etc/squid/cachemgr.conf cp /etc/squid/errorpage.css.default /etc/squid/errorpage.css</code> </pre><br><br>  10) And that's not all =) You must manually create a folder for Squid logs and assign the appropriate rights to it: <br><pre> <code class="bash hljs">mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/squid chown proxy /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/squid</code> </pre><br><br>  11) And here it is - the final stage.  Start Squid'a and check the status of the service! <br><pre> <code class="bash hljs">systemctl start squid systemctl status -l squid ‚óè squid.service - Squid Web Proxy Server Loaded: loaded (/etc/systemd/system/squid.service; enabled) Active: active (running) since  2015-12-04 23:32:04 YEKT; 2min 41s ago Main PID: 590 (squid) CGroup: /system.slice/squid.service ‚îú‚îÄ590 /usr/sbin/squid -sYC -N ‚îî‚îÄ591 (logfile-daemon) /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/squid/access.log  04 23:32:04 squidX64 squid[590]: Max Swap size: 0 KB  04 23:32:04 squidX64 squid[590]: Using Least Load store dir selection  04 23:32:04 squidX64 squid[590]: Current Directory is /  04 23:32:04 squidX64 squid[590]: Finished loading MIME types and icons.  04 23:32:04 squidX64 squid[590]: HTCP Disabled.  04 23:32:04 squidX64 squid[590]: Pinger socket opened on FD 16  04 23:32:04 squidX64 squid[590]: Squid plugin modules loaded: 0  04 23:32:04 squidX64 squid[590]: Adaptation support is off.  04 23:32:04 squidX64 squid[590]: Accepting HTTP Socket connections at <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>=[::]:3128 remote=[::] FD 14 flags=9  04 23:32:05 squidX64 squid[590]: storeLateRelease: released 0 objects</code> </pre><br>  If the console's exhaust looks similar, or rather there are no errors in it and the line ‚ÄúActive: active (running)‚Äù is sure to be present, then you have successfully installed Squid with support for HTTPS transparent proxying!  Congratulations! <br><br>  If you don't want to compile anything, you can download an <a href="">archive</a> with ready-made deb packages (x64 version!).  If you install from ready-made packages, then you will need steps: <b>2, 3 (b), 7, 8, 9, 10, 11</b> . <br><br>  I also want to note that checkinstall allows you to create rpm packages, and you can use this.  The only thing you need to build all the packages with the help of checkinstall, but I think there will be no problems with this, since the main and most difficult thing is already assembled by checkinstall. <br><br>  Squid's configuration file with the right directives, job description, etc.  read in the <a href="http://habrahabr.ru/post/267851/">previous article</a> ! <br><blockquote>  Thanks to Tatiana Illarionova and the Squid developers for helping to create this recipe! </blockquote><br><br>  <b>UPD 12/11/15:</b> At the request of the user <a href="https://habr.com/users/nikitasius/" class="user_link">nikitasius</a> checked Cloudflare.  Comrade <a href="https://habr.com/users/nikitasius/" class="user_link">nikitasius</a> wrote in the comments: <br><blockquote>  Apparently for sites that for Cloudflare such a system will not work correctly ... <br>  They usually have a pack of domains in certificates. <br>  If example.com is in the same certificate with freepron.cum, the squid will work on freepron, if the latter is in the local bath, right? </blockquote>  So, checked.  I added one of his domains from Cloudflare to the blacklist of HTTPS blocking, the browser does not enter it, but the browser quietly enters other domains that are registered in the certificate.  So, <b>Cloudflare check passed</b> <br><br>  <b>UPD 12/14/15: I want to share great news with my colleagues!</b>  <b>I found a way to make new versions of Squid work without special dances with a tambourine!</b>  <b>It is necessary that the clients and Squid settings have the same DNS!</b>  <b>In my case, the Bind is spinning on the squid gateway.</b>  <b>He appointed his clients, and Kalmar, with a directive:</b> <b><br></b> <pre> <b><code class="bash hljs">dns_nameservers 127.0.0.1</code></b> </pre>  <b>.</b>  <b>After that, everything worked successfully.</b>  <b>Tested on Squid 4.0.3, compiled WITHOUT Libressl!</b> <br><br>  UPD 12/16/15: <a href="http://habrahabr.ru/post/272733/">Centos packages!</a> <br><br>  <b>UPD 04/25/16: A request for those who have tested the x64 build write whether everything works.</b>  <b>There are reports of glitches, in particular, a heavy load on the CPU after some time has passed and a subsequent security.</b>  <b>I myself can not check yet</b> <br><br>  <b>UPD 04.05.18: wrote a <a href="https://habr.com/post/354708/">new article</a> where the problem of glitches of new versions of Squid + is solved in the logs beautiful domain names instead of ip addresses + RKN bypass blocking.</b> <br><br><div class="spoiler">  <b class="spoiler_title">For those who think that this is MITM =)</b> <div class="spoiler_text">  In the survey, the last item is of course comic =) If you CAREFULLY read the previous article, then it will immediately become clear that there is no attack on the user, since there is no substitution of certificates !!! <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/272733/">https://habr.com/ru/post/272733/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272719/index.html">Seminar ‚ÄúBackup any objects based on CommVault Simpana‚Äù, December 10, OST data center (Moscow)</a></li>
<li><a href="../272721/index.html">Simple Blender. Part 2</a></li>
<li><a href="../272723/index.html">How to display foreign applications on the Russian market</a></li>
<li><a href="../272725/index.html">DEV Labs 2015. Final online conference of the year. Java and javascript</a></li>
<li><a href="../272729/index.html">Robo code game challenge</a></li>
<li><a href="../272735/index.html">Postgres NoSQL is better than MongoDB?</a></li>
<li><a href="../272737/index.html">Using the MVVM (Model-View-ViewModel) pattern in Android</a></li>
<li><a href="../272739/index.html">Python Meetup October: Deliberate Practice and Desktop Applications on Penta.by</a></li>
<li><a href="../272743/index.html">Cyclic cuts, shifts and rotation of collections</a></li>
<li><a href="../272749/index.html">CRM implementation. From lead registration to closing a deal. Case and explanation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>