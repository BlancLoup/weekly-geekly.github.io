<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dirty place provider: the project blondemine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our company has a distributed sales network. Communication office with the store provides a router on which VPN is configured to the center. And so, f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dirty place provider: the project blondemine</h1><div class="post__text post__text-html js-mediator-article">  Our company has a distributed sales network.  Communication office with the store provides a router on which VPN is configured to the center.  And so, from a certain point on, this connection became extremely poor-quality, because of the squall of packets on the 53rd DNS port.  Communication, though improved after the introduction of blocking rules of the firewall, but the attacks did not stop. <br><br>  I asked the provider to solve the problem on his side.  To which he received the answer made in the headline: "Well, you understand, the Internet is a dirty place."  And then I decided to fight this phenomenon on my own. <br><br>  The result was a collection and analysis system for unauthorized network packets. <br>  And in order not to bore the reader with technical details, I will tell the most interesting things right away, but I recommend reading those who wish to repeat or improve it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result of almost two months of operation, the system received almost 200 million records.  Most (98%) are attacks of the type of DNS amplification, which were discussed more than once in Habr√© <a href="https://habrahabr.ru/post/51574/">[1]</a> , <a href="https://habrahabr.ru/post/83202/">[2]</a> .  Moreover, the attacks do not start immediately, but after some time, enough for a new public address to get into the database of scanning Internet bots.  In the rest of the events, a large segment of attacks on port 23 is highlighted.  As I found out, these are Hikvision's Chinese DVR systems scattered all over the world and scanning the entire Internet for telnet connections.  On the third of them, by the way, just the factory login and password.  And all the rest is already man-made port interruptions, attempts to log in, interrogate by snmp and so on. <br><br><a name="habracut"></a><br><br><h2>  How I came to this </h2><br><br>  First you had to configure a firewall on all remote routers.  Brought the ‚Äúexemplary‚Äù set of rules, checked and started to customize.  On the eighth router, I got bored and I looked into the device log: ‚Äúvk.com cannot connect to the manager‚Äôs computer‚Äù, ‚Äúyoutube.ru does not connect to the cash register‚Äù and so on and so forth.  But there were interesting entries: ‚Äúsrc = 1.1.1.1: 34567 dst = Zyxel: 23 dropped [4 times]‚Äù, ‚Äúsrc = 2.2.2.2: 45678 dst = Zyxel: 80 dropped [12 times]‚Äù. <br><br>  I decided to scan these addresses with Nmap-ohm: the 80th and 22nd ports are open.  The browser said that the first address is a webcam in a meeting room of some Ukrainian company (judging by geoip and whois), and the second is a certain Indian ubiquiti router.  The factory login and password worked only on the webcam, but with the router the factory settings were left ‚Äúonly‚Äù on ssh! <br><br>  Well, what kind of "blonde" do you need to be in order to parade the entire Internet with a device with a factory login and password?  And I decided to collect such ‚Äúblondes‚Äù in one place and study.  And in the future, implement the following algorithm: <br><br>  attacking attackers - passive analysis - active analysis - response <br><br><h3>  Step One: Collect Attackers </h3><br><br><h4>  Central Journal </h4><br><br>  In Zyxel routers, you can send a log to the central syslog server.  For this, I installed Linux Debian, and on it rsyslog: <br><br><pre><code class="hljs pgsql">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install rsyslog</code> </pre> <br><br>  However, simple installation is not enough.  It is necessary to allow syslog to receive messages from outside: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/rsyslog.conf</b> <div class="spoiler_text"><pre> <code class="hljs swift">... # provides <span class="hljs-type"><span class="hljs-type">UDP</span></span> syslog reception $<span class="hljs-type"><span class="hljs-type">ModLoad</span></span> imudp $<span class="hljs-type"><span class="hljs-type">UDPServerRun</span></span> <span class="hljs-number"><span class="hljs-number">514</span></span> ... # <span class="hljs-type"><span class="hljs-type">MAXA's</span></span> rules - the local facilities local0.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local0 local1.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local1 local2.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local2 local3.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local3 local4.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local4 local5.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local5 local6.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local6 local7.* /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/local7 # <span class="hljs-type"><span class="hljs-type">By</span></span> the way - the above files should also be rotated by logrotate # <span class="hljs-type"><span class="hljs-type">And</span></span>, of course, to work properly - there should be a <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> port translation on the border router ...</code> </pre><br></div></div><br><br>  Well, in order for this port to catch data from the Internet, you also need to broadcast on the border router.  In my case at Cisco, I did this: <br><br><pre> <code class="hljs objectivec">ip nat inside source <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> udp {syslog_IP} <span class="hljs-number"><span class="hljs-number">514</span></span> {public_IP} <span class="hljs-number"><span class="hljs-number">514</span></span> extendable</code> </pre><br><br>  Now you need to configure the remote router to send messages.  In my case, this is Zyxel zywall 2Plus or USG20. <br><br>  Models of these routers differ quite strongly, both outside and inside.  However, the whole point of the setup comes down to disabling all logs, except for the firewall, and sending events to the syslog server.  Here's what it looks like on the Zyxel USG 20: <br>  firewall configuration: <br><br><img src="https://habrastorage.org/webt/59/cc/bc/59ccbc9fbeab8871422166.png" alt="image"><br><br>  configure syslog log events: <br><br><img src="https://habrastorage.org/webt/59/cb/76/59cb768ef0cd5649338352.png" alt="image"><br><br>  configure syslog server address and type: <br><br><img src="https://habrastorage.org/webt/59/cb/76/59cb768f28162524549759.png" alt="image"><br><br>  Even in the device settings, you must set a meaningful host name - for ease of sorting. <br><br><h3>  First results </h3><br><br>  If everything is left like this, then a text file local5 will be created on the syslog server with all the events corresponding to the last rule of the firewall - that is, attacks on this router: <br><br><pre> <code class="bash hljs">Sep 27 17:34:54 2017 GW18PUB src=<span class="hljs-string"><span class="hljs-string">"5.188.203.30:54193"</span></span> dst=<span class="hljs-string"><span class="hljs-string">"XXXX:8173"</span></span> msg=<span class="hljs-string"><span class="hljs-string">"invalid state detected, DROP"</span></span> note=<span class="hljs-string"><span class="hljs-string">"ACCESS BLOCK"</span></span> user=<span class="hljs-string"><span class="hljs-string">"unknown"</span></span> devID=<span class="hljs-string"><span class="hljs-string">"b0b2dcc63eec"</span></span> cat=<span class="hljs-string"><span class="hljs-string">"Firewall"</span></span> class=<span class="hljs-string"><span class="hljs-string">"Access Control"</span></span> ob=<span class="hljs-string"><span class="hljs-string">"0"</span></span> ob_mac=<span class="hljs-string"><span class="hljs-string">"000000000000"</span></span> dir=<span class="hljs-string"><span class="hljs-string">"ANY:ANY"</span></span> protoID=6 proto=<span class="hljs-string"><span class="hljs-string">"others"</span></span> Sep 27 17:35:02 2017 GW36PUB src=<span class="hljs-string"><span class="hljs-string">"212.83.176.116:51855"</span></span> dst=<span class="hljs-string"><span class="hljs-string">"YYYY:4287"</span></span> msg=<span class="hljs-string"><span class="hljs-string">"invalid state detected, DROP"</span></span> note=<span class="hljs-string"><span class="hljs-string">"ACCESS BLOCK"</span></span> user=<span class="hljs-string"><span class="hljs-string">"unknown"</span></span> devID=<span class="hljs-string"><span class="hljs-string">"b0b2dcc63eed"</span></span> cat=<span class="hljs-string"><span class="hljs-string">"Firewall"</span></span> class=<span class="hljs-string"><span class="hljs-string">"Access Control"</span></span> ob=<span class="hljs-string"><span class="hljs-string">"0"</span></span> ob_mac=<span class="hljs-string"><span class="hljs-string">"000000000000"</span></span> dir=<span class="hljs-string"><span class="hljs-string">"ANY:ANY"</span></span> protoID=6 proto=<span class="hljs-string"><span class="hljs-string">"others"</span></span> Sep 27 17:35:17 2017 GW18PUB src=<span class="hljs-string"><span class="hljs-string">"212.83.176.116:51855"</span></span> dst=<span class="hljs-string"><span class="hljs-string">"XXXX:3875"</span></span> msg=<span class="hljs-string"><span class="hljs-string">"invalid state detected, DROP"</span></span> note=<span class="hljs-string"><span class="hljs-string">"ACCESS BLOCK"</span></span> user=<span class="hljs-string"><span class="hljs-string">"unknown"</span></span> devID=<span class="hljs-string"><span class="hljs-string">"b0b2dcc63eec"</span></span> cat=<span class="hljs-string"><span class="hljs-string">"Firewall"</span></span> class=<span class="hljs-string"><span class="hljs-string">"Access Control"</span></span> ob=<span class="hljs-string"><span class="hljs-string">"0"</span></span> ob_mac=<span class="hljs-string"><span class="hljs-string">"000000000000"</span></span> dir=<span class="hljs-string"><span class="hljs-string">"ANY:ANY"</span></span> protoID=6 proto=<span class="hljs-string"><span class="hljs-string">"others"</span></span></code> </pre><br><br>  The file will grow indefinitely until it eats the entire logical partition, so you need to configure the rotation of the log.  This can be done using logrotate scripts - split the log into days, daily archive and delete old archives.  However, I had a better idea - to take only the necessary from the record, split it into fields and transfer them to the database. <br><br><h3>  Database and Log Handler </h3><br><br>  As a DBMS, I installed postgresql - because I did not know anything about working with it at that time, but I really wanted to get to know each other. <br><br><pre> <code class="hljs pgsql">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install postgresql<span class="hljs-number"><span class="hljs-number">-9.5</span></span></code> </pre><br><br>  After installation, I connected to postgres: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> -u postgres psql</code> </pre><br><br>  Created a new user: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> pgmaxa <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-string"><span class="hljs-string">'strongpass'</span></span>;</code> </pre><br><br>  And the base: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> blondemine; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> blondemine <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> pgmaxa;</code> </pre><br><br>  The first ‚Äúwedro‚Äù table should contain the time of the event, the name of the router, the address of the attacker and the port attacked.  And everything would be fine, but storing the attacker's address in text form seemed to me wrong.  As a result, I installed the IP4R extension - it did not work out on the first attempt, but if I‚Äôm interested, I‚Äôll tell you.  As a result, the table was created as follows: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> wedro ( rt <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, gw <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>), ad ip4, pt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, dtst <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() )</code> </pre><br><br><h3>  Log handler </h3><br><br>  Now it‚Äôs time to create a local5 handler that will fill my database.  It was not written in one day, and even underwent five revisions, so I‚Äôll give you the latest working version: <br><br><div class="spoiler">  <b class="spoiler_title">/usr/sbin/handmade/logtopostgres.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # FILES SECTION # parsed file log=/var/log/local5 # prepared query file tmp=/var/log/local5.ptmp # final query file sql=/var/log/local5.psql # debug file err=/var/log/badform5.log # CONSTANTS yr=`date +%Y` # DATABASE SECTION # syntax: {var name}={corresponding field in DB} # local (gateway) time of atack lt=rt # hostname of atacked gateway gw=gw # ip address of blocked atacker ad=ad # blocked port number pt=pt echo "INSERT INTO wedro ($lt,$gw,$ad,$pt) VALUES " &gt; $tmp cat $log | grep "Access Control" | grep default | \ sed 's/ [0-9]\{4\} / /g;s/\([0-9]\): /\1:/' | \ awk '{ \ gsub(/"/,"",$5) \ sub(/src=/, "", $5 ) \ split($5,HA,":"); \ gsub(/"/,"",$6) \ sub(/dst=/, "", $6 ) \ split($6,OP,":"); \ if (length($4) &gt; 9) \ print \ "GWNAME too long: \x27" $4 "\x27 | whole line: \x27" $0 "\x27 |" \ &gt;&gt; "'$err'"; \ else \ if (OP[2]=="") \ print \ "PORT is empty: \x27 \x27 | whole line: \x27" $0 "\x27 |" \ &gt;&gt; "'$err'"; \ else \ print \ "(to_timestamp( \x27"'$yr'$2$1$3"\x27,\x27YYYYDDMonHH24:MI:SS\x27)," \ "\x27"$4"\x27," \ "\x27" HA[1] "\x27," \ "\x27" OP[2] "\x27)," &gt;&gt; "'$tmp'" \ }' truncate --size=-2 $tmp echo ";" &gt;&gt; $tmp mv $tmp $sql export PGPASSWORD=strongpass &amp;&amp; psql -h localhost -U pgmaxa -d blondemine -f $sql rm $sql # # awk afterprint section for debug local output # #" Day: " $2 \ #" Month: " $1 \ #" Time: " $3 \ #" Host: " $4 \ #" AtackerIP: " HA[1] \ #" MyPort: " OP[2] \ #</span></span></code> </pre><br></div></div><br><br>  The essence of this ‚Äúscript‚Äù is: <br><br><ul><li>  we process the journal line by line </li><li>  we take only lines with the phrases "Access Control" and "default" </li><li>  (!) remove the four-digit year and time gaps in the event </li><li>  From the fifth field we delete ‚Äúsrc =‚Äù, and write the address in the variable HA (HackerAddress) </li><li>  from the sixth field we delete ‚Äúdst =‚Äù, and we write the port to the variable OP (OurPort) </li><li>  check the length of the router name and port number for correctness </li><li>  collect the data in the string for the insert query </li><li>  cut the file with the request for two characters and complete the ‚Äú;‚Äù </li><li>  rename and paste into database </li></ul><br><br>  I put the exclamation mark for a separate comment.  The fact is that the format of magazines Zywall2Plus and USG20 are different in that one writes a year, and the other for some reason does not.  To bring these records to a general form, I delete the year from all the records, and then add the year value from the system.  This is actually not very correct, and after a while I realized that I had to do it differently.  For each format of the journal it would be necessary to make a certain processing template as a module.  However, there was no time and wrote how it goes. <br><br>  In order for the database to be filled automatically, in the rotation settings of the /etc/logrotate.d/ logs, you need to create a rule for local5, which sets the rotation by file size: <br><br><pre> <code class="hljs mel">/var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/local5 { <span class="hljs-keyword"><span class="hljs-keyword">rotate</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> prerotate /usr/sbin/handmade/logtopostgres.sh endscript postrotate invoke-rc.d rsyslog <span class="hljs-keyword"><span class="hljs-keyword">rotate</span></span> &gt; /dev/null endscript <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">2190000</span></span> missingok notifempty compress }</code> </pre><br><br>  However, rotation for some reason did not always work, and I did a forced rotation every 5 minutes in the cron scheduler: <br><br><pre> <code class="hljs markdown"><span class="hljs-emphasis"><span class="hljs-emphasis">*/5 *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> * root /usr/sbin/logrotate /etc/logrotate.d/loc5</code> </pre><br><br><h3>  Result </h3><br><br>  As a result, the database is really filled with an automatic machine - in two days, about four million entries from several routers. <br><br><h3>  Step Two: Passive Analysis </h3><br><br>  From the very beginning, it became clear that there were too many records with port 53 to see something else.  As a result, nothing better than deleting them, I have not yet invented.  A trigger on the AFTER INSERT was hung on the wedro table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.deldns() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> wedro <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pt=<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ad::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'192.168%'</span></span>; RETURN NEW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> sweep <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> public.wedro <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATEMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> public.deldns();</code> </pre><br><br><h3>  Result </h3><br><br>  With such a regular cleaning, the base ceased to grow at an alarming rate and there was an opportunity to find something in it.  True, there is also a need for AUTOVACUUM to free up once used resources. <br><br><h3>  Unique addresses </h3><br><br>  Attacks from the same addresses are repeated quite often.  Therefore, I decided that they should be collected in a separate table.  Since the data is updated every five minutes, there is no point in doing this in the form of a trigger - as a result, we had to master the installation and operation of the pgagent scheduler. <br><br>  Two more ipid and wedro_old tables were created for this purpose: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ipid ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'ipid_id_seq'</span></span>::regclass), ad ip4 <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, dtst <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> wedro_old ( rt <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, gw <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>), ad ip4, pt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, dtst <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() );</code> </pre><br><br>  And in pgagent-e, an hourly task was set up to fill these tables: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ipid (ad) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> ad <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> wedro <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dtst &gt; (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(dtst) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ipid)::<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ad <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ad <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ipid); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> wedro_old <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> wedro; <span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> wedro;</code> </pre><br><br><h3>  Step Three: Active Analysis </h3><br><br><h4>  Hikvision Cameras and DVRs </h4><br><br>  The remaining entries turned out to be quite a lot of attacks on the 23rd telnet port.  Moreover, a number of addresses did this many times and did not scan any other ports.  If you type this address in the browser, the form for entering credentials will open: <br><br><img src="https://habrastorage.org/webt/59/cc/af/59ccaf68a7733495074464.png"><br><br>  in some cases, factory admin / 12345 is allowed into the interface of the digital tape recorder Hikvision.  It is also interesting that on some devices there is an undocumented open port 9527. Here is an example for the active analysis phase: <br><br>  We are looking for addresses attacking only port 23: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ad <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> telnetz <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> wedro_old <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ad <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> a.ad <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ad,pt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wedro_old <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ad,pt) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> a.ad <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*)=<span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pt=<span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ad,pt;</code> </pre><br><br>  We use the resulting list in Nmap-e to search for vulnerable DVRs: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash nmap \ -n -Pn -p9527 --open `\ echo "select * from telnetz limit $1 offset $2;" | \ psql -U pgmaxa -d blondemine -t -h syslog_IP` | \ grep for | sed 's/^.*for //g'</span></span></code> </pre><br><br>  The limit and offset expressions are used here because of the scanner‚Äôs limitations on the number of targets.  On an unlimited list, it fails. <br><br><h3>  Step Four: Action </h3><br><br>  For the nodes found in the previous step, I also wrote a expect script to check the factory credentials and disable the 23rd port scanner.  However, I was far enough away from my original goal of actively preventing unauthorized access to my routers.  And I think it is time to summarize. <br><br><h3>  Conclusion </h3><br><br>  The Internet is a really ‚Äúdirty‚Äù place and my system allows it to be quantified.  I think, from what I brought here, it is clear that the system is far from perfect and needs to be improved: you need an interface, device templates, the integration of all modules into a single installation package, and much more.  But the system is already running, assembled from available and free components.  I do not exclude that systems like mine exist in commercial execution.  However, I doubt that all modules of such systems will be available for customization and modification. </div><p>Source: <a href="https://habr.com/ru/post/339196/">https://habr.com/ru/post/339196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339184/index.html">Ivan Ponomarev and Nikolai Potashnikov on the display of tabular data, Celesta and Flute on jug.msk.ru</a></li>
<li><a href="../339186/index.html">[CppCon 2017] Herb Sutter: Metaprogramming and Code Generation in C ++</a></li>
<li><a href="../339190/index.html">Obvious non-obviousness in assembly using a webpack</a></li>
<li><a href="../339192/index.html">Why in Go ampersand and asterisk (& and *)?</a></li>
<li><a href="../339194/index.html">Next billion users: who these people are and how they will affect the global economy</a></li>
<li><a href="../339198/index.html">Hacktoberfest Open Hack Day at Avito - October 7</a></li>
<li><a href="../339200/index.html">Development of the first game. Impressions and work on the bugs. Part 1</a></li>
<li><a href="../339204/index.html">Lectures on cryptography, blockchain and in general</a></li>
<li><a href="../339206/index.html">CIS Benchmarks: best practices and recommendations for information security</a></li>
<li><a href="../339208/index.html">Uneducated youth. The teacher‚Äôs response</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>