<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Entity Framework Code First in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 In this publication I want to share my personal experience of using the Entity Framework (EF) in a real application and give some useful tip...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Entity Framework Code First in practice</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  In this publication I want to share my personal experience of using the Entity Framework (EF) in a real application and give some useful tips on using this framework. <br><br>  I have been developing enterprise applications on the .NET platform for more than 7 years, during this time I tried several ORM libraries, but now I use the Entity Framework First for new projects. <br><a name="habracut"></a><br>  Initially, as the name suggests, this approach assumed that the database storing the application data is described first with the help of code, and then the framework itself creates or updates it.  However, many developers have chosen to use the opposite approach, when the database is first created and then objects are sent to it.  This is especially convenient for enterprise applications, where data is almost always put at the forefront and uses a fairly advanced DBMS such as Oracle or MSSQL Server.  I don‚Äôt like the EF designer when there are more than a hundred tables in it.  Therefore, Code First was taken personally by me as something incredibly convenient and extremely useful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Once again I want to repeat that, in my opinion, in an enterprise application, the main thing is data, not your application.  Applications come and go, are replaced with newer ones, and the data remains and is used for years.  Therefore, in any of my applications, the database is always created by the database designer, and not by my application. <br><br>  The first thing to do if you already have a database ready is to create classes that correspond to the tables.  Manually doing this is very tiring, therefore: <br><br><h4>  Council number 1.  Table-based class generation </h4><br>  The T-SQL script, which can be taken <a href="http://stackoverflow.com/questions/5873170/generate-class-from-database-table">from here</a> , really works and is very convenient. <br><br><h4>  Council number 2.  Pregeneration view </h4><br>  EF is known for the very long processing time of the first request for receiving and saving data.  In order to correct this situation, you can use the view pregeneration. <br><br>  The pregeneration view is something that happens inside the framework when the first request is executed.  This process can be transferred to the stage of compiling your application, which will significantly reduce the speed of the first request.  For different versions of EF, the methods are somewhat different.  I used <a href="http://blog.3d-logic.com/2012/06/13/entity-framework-codefirst-view-generation-templates-on-visual-studio-code-gallery/">this</a> approach and was completely satisfied with it. <br><br><h4>  Council number 3.  Bulk data update with DetectChanges </h4><br>  By default, the framework is configured to automatically track changes that must then be saved to the database. <br>  For example, consider this simple example: <br><br><pre><code class="hljs pgsql">var dbContext = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MyDbContext(); //       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">1000</span></span>;i++) { dbContext.People.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Person());//!!!    } //    dbContext.SaveChanges();</code> </pre> <br><br>  When launching it, many will probably be surprised that most of the time will be spent not on the database query itself, but on inserting objects into dbContext itself.  The fact is that when you change the data inside DbContext, there are a lot of checks and other little-studied things, more details about which can be found <a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">here</a> .  To avoid this, you can turn off tracking of changes in the DbContext class, and then explicitly call the DetectChanges () method, which itself will detect these changes.  So, this code will work much faster: <br><br><pre> <code class="hljs pgsql">var dbContext = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MyDbContext(); //     dbContext.<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>.AutoDetectChangesEnabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; //       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">1000</span></span>;i++) { dbContext.People.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Person());//      } dbContext.ChangeTracker.DetectChanges(); //   .   //    dbContext.SaveChanges();</code> </pre><br><br><h4>  Council number 4.  Keep track of the sql queries that the framework generates </h4><br>  This is quite universal advice, applicable, probably, to all ORM, but for some reason many people forget about it.  And after the introduction of the application, opening the profiler and seeing 50 queries to the database to display a fairly simple form are extremely surprised. <br><br>  Meanwhile, the framework offers mechanisms for some optimization.  Among these mechanisms, the most well-known is the Include method, which ‚Äúpulls‚Äù child objects in the same query.  For example: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   Person         Address var person = dbContext.People.Include(p=&gt;p.Address).FirstOrDefault(); //     var address = person.Address;</span></span></code> </pre><br><br><h4>  Council number 5.  Isolate database logic </h4><br>  Although the EF name contains the word ‚Äúframework‚Äù, it can also be used as a regular library simply to simplify work with the database. <br>  In most books and presentations, we see code similar to this: <br><br><pre> <code class="hljs pgsql">// MVC <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PersonController: Controller { // EF  AppDbContext dbContext; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PersonController(AppDbContext dbContext) { this.dbContext = dbContext; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IActionResult ViewPerson(<span class="hljs-type"><span class="hljs-type">int</span></span> id) { var person = dbContext.People.First(p=&gt;p.Id == id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(person); } }</code> </pre><br><br>  The problem with this code is that it tightly binds all parts of the application to the Entity Framework.  This is neither good nor bad in itself, but at the same time you need to understand that you are significantly complicating your life if the data access architecture has to be changed.  And there may be a lot of options: <br><br><ul><li>  You suddenly find that a particular query is extremely slow and decide to replace it with a stored procedure or View </li><li>  You will be surprised to find how difficult it is to store data obtained in different DbContext </li><li>  You will be surprised to observe the TransactionScope, DbConnection classes inside the controller when you need a non-trivial data update logic. </li><li>  You will think about reusing code to work with the database </li><li>  You decide to use NHibernate instead of EF </li><li>  And why not use the SOA architecture, and not start receiving and saving data through web services? </li></ul><br>  I like the approach when EF is used ONLY within a project called DAL (DataAccess, etc.) in classes called Repository, for example: <br><br><pre> <code class="hljs perl">//     Person public class PersonRepository: IPersonRepository { public Person GetPerson(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> personId) { var dbContext = new AppDbContext(); var person = dbContext.People.First(<span class="hljs-string"><span class="hljs-string">p=&gt;</span></span>p.Id == id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> person; } public void SavePerson(Person person) { var dbContext = new AppDbContext(); var dbPerson = dbContext.People.First(<span class="hljs-string"><span class="hljs-string">p=&gt;</span></span>p.Id == person.Id); dbPerson.LastName = person.LastName; ..... dbContext.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> person; } }</code> </pre><br><br>  This approach is good because your application will only know about your objects and how you can get them from the database and how to save them to the database.  Believe me, this will make your life much easier. </div><p>Source: <a href="https://habr.com/ru/post/236037/">https://habr.com/ru/post/236037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236027/index.html">Marketing: what is not taught in school</a></li>
<li><a href="../236029/index.html">Client-server work with tabular data for beginners</a></li>
<li><a href="../236031/index.html">Group order of printed circuit boards - myths and reality</a></li>
<li><a href="../236033/index.html">The third annual Russian AI Cup championship has begun.</a></li>
<li><a href="../236035/index.html">Game "life", Chaos, "black swan", ethnogenesis and how it all is connected</a></li>
<li><a href="../236039/index.html">Exhibition 3D PrintShow in London. Industry - a gold mine or a ghost hunt?</a></li>
<li><a href="../236041/index.html">RailsClub'Moscow 2014. Interview with Aaron Patterson</a></li>
<li><a href="../236043/index.html">Start Sandbox Championship Russian AI Cup 2014</a></li>
<li><a href="../236047/index.html">CSS GuideLines, part 3. Naming classes</a></li>
<li><a href="../236049/index.html">Let's look under the hood: Microsoft Outlook 2013 Attachments Reminder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>