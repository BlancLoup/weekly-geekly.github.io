<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>First experience with Handler Socket & php_handlersocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article ‚Äú MySQL as NoSQL‚Äù turned my head around a little bit - A story about how to reach 750,000 queries per second (Translated by my friend Vadi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>First experience with Handler Socket & php_handlersocket</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/06/87/068766b64e68ad4768a4d59f52e507a6.jpg" alt="handlersocket"><br><br>  The article ‚Äú <a href="http://l-o-n-g.livejournal.com/153756.html">MySQL as NoSQL‚Äù</a> turned my head around a little bit <a href="http://l-o-n-g.livejournal.com/153756.html">- A story about how to reach 750,000 queries per second</a> (Translated by my friend Vadim).  There are other <a href="http://habrahabr.ru/search/%3Fq%3Dhandlersocket">materials</a> on this topic.  And now they got their hands on the experiments. <br><br>  Three different clients have been developed for PHP: <br>  extension <a href="http://code.google.com/p/php-handlersocket/">code.google.com/p/php-handlersocket</a> <br>  PEAR <a href="http://openpear.org/package/Net_HandlerSocket">openpear.org/package/Net_HandlerSocket</a> <br>  PHP native <a href="http://github.com/tz-lom/HSPHP">github.com/tz-lom/HSPHP</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below are my impressions of the first experiments. <br><a name="habracut"></a><br>  I will not retell the <a href="http://tokarchuk.ru/2010/12/install-handlersocket-and-percona-server-from-packages/">article about the installation</a> .  If you installed MySQL from source, you should have no problems. <br><br>  After installing the handlersocket and executing the SHOW PROCESSLIST command;  There should be something like this: <br><br><img src="https://habrastorage.org/storage/habraeffect/5c/16/5c1665866386d01fce32f6ba2b6d7a13.gif" alt="handlersocket passive"><br><br>  In the loaded state, the picture will be approximately the same <br><img width="480" src="https://habrastorage.org/storage/habraeffect/75/1b/751b58be5d6a157b0fc3ef453535635f.gif" alt="handlersocket active"><br><br>  by the number of loaded processes we can see the handlersocket load.  The image shows that three connections are open, one of them is active (running). <br><br>  The number of working threads can be adjusted in my.conf parameters: <br> <code>loose_handlersocket_threads = 16 <br> loose_handlersocket_threads_wr = 1 <br></code> <br><br>  If you have collected at least one extension for PHP, then with the installation of php-hanlpersocket there should be no problems.  A little confused by the lack of documentation.  There are no particular complaints about the choice of example and clarity.  Tested on both MyISAM and InnoDb. <br><br>  The sample for PRIMARY KEY (by example) was a great success.  An example is in the documentation for php-handlersocket. <br>  Sampling is carried out as for the operation is equal to "=", operations are also possible: <br>  more '&gt;', <br>  less '&lt;' <br>  greater than or equal to '&gt; =' <br>  less than or equal to '&lt;=' <br><br>  With a sample of symbolic indices, the encoding must be considered.  If necessary, do the conversion using iconv, otherwise you will not find anything and lose a lot of time. <br><br>  An example of fetching by key name: <br><blockquote> <code><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> `test`.`cities` ( <br> `id_city` <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> AUTO_INCREMENT, <br> `id_region` <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `id_country` mediumint(8) unsigned <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `city_name` <font color="#0000ff">varchar</font> (255) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `city_order` <font color="#0000ff">int</font> (10) unsigned <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (`id_city`), <br> <font color="#0000ff">KEY</font> `id_region` (`id_region`), <br> <font color="#0000ff">KEY</font> `name` (`city_name`) <br> ) ENGINE=MyISAM</font> <br> <br> <font color="black">$hs = <font color="#0000ff">new</font> HandlerSocket($host, $port); <br> <br> <font color="#0000ff">if</font> (!($hs-&gt;openIndex(0, $dbname, $table, <font color="#008000">'name', 'city_name,id_city,id_region')))</font> <br> { <br> echo $hs-&gt;getError(), PHP_EOL; <br> die( <font color="#008000">'error open index');</font> <br> } <br> <br> $retval = $hs-&gt;executeSingle(0, <font color="#008000">'=', array(''), 10);</font> <br></font> <br></code> <br></blockquote><br>  Answer: <br> <code>array(1) { <br> [0]=&gt; array(2) { <br> [0]=&gt; string(6) "" <br> [1]=&gt; string(4) "1976" <br> [2]=&gt; string(1) "72" <br> } <br> } <br></code> <br><br>  You can sample the entire region (id_region = 1): <br><blockquote> <code><font color="black"><font color="#0000ff">if</font> (!($hs-&gt;openIndex(0, $dbname, $table, <font color="#008000">'id_region', 'city_name,id_city,id_region')))</font> <br> { <br> die($hs-&gt;getError()); <br> } <br> $retval = $hs-&gt;executeSingle(0, <font color="#008000">'=', array(1), 100, $off);</font> <br></font></code> </blockquote><br>  Constant 100 - number of selective records, $ off - offset, similarly LIMIT, OFFSET in SELECT. <br>  The response will be an array of 100 or less elements, similar to executing SQL: SELECT 'id_region', 'city_name, id_city, id_region' FROM cityes WHERE id_region = 1 LIMIT 100, $ off; <br><br>  For example, it is convenient, when implementing an autocomplex, using the operations (signs) '&gt; =' or '&lt;=' you can select the required number of words beginning with certain letters.  Tracking the range with standard means is impossible, but if the data is taken in chunks and checked for satisfaction with the second condition, then in principle any simple sampling can be performed. <br><br>  Protocol.  It should be noted that in the development of its knowledge is very helpful in debugging.  Requests at first, especially when something does not work, constantly have to compare with the results obtained through the implementation of telnet.  Protocol description lies in the file protokol.en.txt or its translation in the article <a href="http://tokarchuk.ru/2010/12/handlersocket-protocol-and-php-handlersocket-extension/">‚ÄúIntroduction to HandlerSocket: protocol description and php-handlersocket extensions‚Äù</a> <br><br>  Using the Protocol is very simple: In telnet we connect on port 9998 to the host database. <br> <code>telnet localhost 9998 <br> P 0 test cities name city_name,id_city <br> //     TAB (\t),   NULL,    TAB <br> 0 1 ---&gt;      0 1 <br> ///      <br> 0 &gt; 1 a 10 <br> ///  (int),  (&lt;&gt;= ...) - , [, Limit, Offset] <br> 0 2 A Baa 10564 A Barqueira 10565 A Corua 10566 A da Beja 15510 A dos Arcos 15511 A dos Bispos 15512 A dos Cunhados 15513 A dos Francos 15514 A Merca 11120 A Nario 13257 <br> //   =0 (),     (city_name,id_city)     <br> //    ,  TAB,   BK(\n) <br></code> <br><br>  In conclusion, I would like to add that you can make queries on composite keys using arrays and multi-queries, i.e.  multiple requests for one connection: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$hs-&gt;openIndex(0, $dbname, $table, <font color="#A31515">'PRIMARY'</font> , <font color="#A31515">'city_name,id_city,id_region'</font> ); <br> $hs-&gt;openIndex(1, $dbname, $table, <font color="#A31515">'id_region'</font> , <font color="#A31515">'city_name,id_city,id_region'</font> ); <br> $retval = $hs-&gt;executeMulti( <br> array(array(0, <font color="#A31515">'='</font> , array( <font color="#A31515">'23'</font> ), 1, 0), <br> array(1, <font color="#A31515">'='</font> , array( <font color="#A31515">'3'</font> ), 10, 0))); <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Behind a review side there were operations INSERT / UPDATE / DELETE.  I hope in the near future to give a more detailed review. <br><br>  Handlersocket is well shown in combination with sphinx.  With the help of the Sphinx, we search for the required document IDs, and with the help of the handlersocket we instantly select the necessary information. <br><br>  <strong>Customer Performance Comparison</strong> <br>  top line PHPHS <br>  bottom php-handlersocket <br>  time is dirty in microseconds, taking into account the classes and instances <br> <code>0.005791 <br> 0.001404 <br> --- <br> 0.007095 <br> 0.001383 <br> --- <br> 0.00456 <br> 0.002563 <br> --- <br> 0.006104 <br> 0.001384 <br></code> <br><br>  Time without inclusions and instances, purely one sample by PK <br> <code>$t1 = microtime(); <br> $retval = $hs-&gt;executeSingle(2, '=', array('60187')); <br> echo microtime()-$t1, PHP_EOL; <br> $t1 = microtime(); <br> $res = $rs-&gt;select('=','60187'); <br> echo microtime()-$t1, PHP_EOL; <br> <br> 0.000451 <br> 0.000632 <br> --- <br> 0.00039400000000001 <br> 0.00020700000000007 <br> --- <br> 0.00040000000000007 <br> 0.00021399999999994 <br> --- <br> 0.00053999999999998 <br> 0.002058 <br> --- <br> 0.002926 <br> 0.0002089999999999 <br> --- <br> 0.000386 <br> 0.00021100000000002 <br></code> <br><br>  <b>Revealed bug</b> <br>  When debugged, I dropped telnet on kill -9, which caused the socket to hang. <br>  Subsequent restarts of the script caused it to hang (the socket was waiting for reading). <br><br>  SHOW PROCESSLIST handlersocket processes not shown <br><br>  Cured by restarting muscle. </div><p>Source: <a href="https://habr.com/ru/post/113040/">https://habr.com/ru/post/113040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113026/index.html">Data generation using C ++ templates</a></li>
<li><a href="../113029/index.html">Computer control with variable resistor</a></li>
<li><a href="../113030/index.html">Satellite lost after launch</a></li>
<li><a href="../113035/index.html">How do you feel about HTML letters?</a></li>
<li><a href="../113039/index.html">Some subtleties of Update & Insert in Handler Socket</a></li>
<li><a href="../113042/index.html">We are looking for speakers at Mobility 2011</a></li>
<li><a href="../113044/index.html">camelCase vs under_score</a></li>
<li><a href="../113045/index.html">.NET Reflector will be paid</a></li>
<li><a href="../113046/index.html">The history of a very unsuccessful startup</a></li>
<li><a href="../113047/index.html">Presented by The Daily - media created for iPad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>