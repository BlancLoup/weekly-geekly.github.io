<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>First steps to an online office on Linux or how we ported to Mono (about the difficulties and how to overcome them)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yesterday we released ONLYOFFICE under Linux and we hasten to share not only the news, but also useful information for those who, like us, 5 years ago...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>First steps to an online office on Linux or how we ported to Mono (about the difficulties and how to overcome them)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8df/c2c/653/8dfc2c653e344c9cb5f94281cdc2aee3.jpg"><br><br>  Yesterday we released <a href="http://www.onlyoffice.com/ru">ONLYOFFICE</a> under Linux and we hasten to share not only the news, but also useful information for those who, like us, 5 years ago found themselves in their own trap called ‚ÄúASP.Net‚Äù <br><br>  Attempts to port the application to Unix using the Mono project were started 4 years ago, however, for a long time we did not succeed, because at that time Mono was far behind in functionality when porting from .Net under Windows.  In particular, wcf support was severely curtailed in Mono, and asp.net mvc was not working well.  However, all these years, fortunately for developers, the Mono project has been actively developing - support for .Net 4.0 and .Net 4.5 has been added, so in spring 2013 we decided to resume work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here we will talk about what problems we encountered in the process of porting the cloud office to Mono, how they were decided that we have in the end, and as one initiative user, within a couple of hours after the release, I wrapped everything in Dockerfile. <a name="habracut"></a><br><br><h2>  The main difficulties when porting to Mono </h2><br><br><h3>  <i>1. Work with the file system</i> </h3><br>  What is happening: the site does not open, images are not displayed or displayed incorrectly.  Now the problem <a href="http://www.mono-project.com/docs/advanced/iomap/">is described</a> in detail on the official website of the Mono Project. <br><br>  <b>What is the matter:</b> in Windows, forward and backward slash are the same thing, and in Unix they are two completely different ways.  On Windows, paths are case insensitive, and on Unix, they are different names. <br>  <b>How to solve a problem:</b> <br><ul><li>  replacement of all lines with paths and directory delimiters in them to work through the Path class.  Using everywhere Path.Combilne and Path.DirectorySeparatorChar. </li><li>  check all css and similar adjustment paths to work under both systems. </li><li>  using the MONO_IOMAP = all environment variable in Mono to work under Mono with paths with the possibility of ignoring the case of characters. </li></ul><br><h3>  <i>2. Non-closing transactions</i> </h3><br>  <b>What happens:</b> non-closing transactions in the MySQL database. <br>  <b>What is the matter:</b> unfortunately, they have not figured out until the end (there are suggestions?) <br>  <b>As decided:</b> added a parameter in the connection string AutoEnlist = false <br><br><h3>  <i>3. Differences in the work of xml Mono serializers</i> </h3><br>  <b>What happens: the</b> difference in the xml representation of the fields with the value null and the exception in the mono serializer when using empty namespace in xml. <br>  <b>As decided:</b> Removed wcf service module "Documents" and replaced by webapi. <br><br><h3>  <i>4. Memory leaks</i> </h3><br>  <b>What happens:</b> a memory leak when using mod_mono_server for apache2.  For example, when inserting new data into HttpRuntime.Cache with a key that is already in the cache, Mono, unlike .NET, does not free the memory occupied by the previous data. <br>  <b>What was the matter:</b> still a mystery to us. <br>  <b>How did you decide:</b> to solve this problem, you must explicitly delete old data before inserting new ones.  We, in turn, switched to nginx, where there was no such problem. <br><br><h3>  <i>5. NullReferenceException Exceptions</i> </h3><br>  <b>What happens:</b> in the WCF service, when accessing the members of the ConfigurationManager class, a NullReferenceException occurred if we had previously overwritten the HttpContext.Current property somewhere. <br>  <b>What is the matter:</b> if you manually set HttpContext.Current in a non-web application, then mono starts using WebConfigurationManager instead of ConfigurationManager, which leads to exceptions in a non-web application. <br>  <b>As decided:</b> got rid of the installation manually HttpContext.Current. <br><br><h3>  <i>6. Microsoft version incompatibility and HTTP WCF</i> </h3><br>  <b>What is the matter:</b> HTTP WCF Mono service has many minor differences compared to the Microsoft version (for example, small differences in xml during serialization; in the mono version, extensions cannot be specified through attributes, only through the configuration file; there is no HttpContext.Current, and so on) . <br>  <b>As decided:</b> rewrote HTTP WCF document service for a version based on Web API. <br><br><h3>  <i>7. SignalR server crash during load testing</i> </h3><br>  <b>What's the matter:</b> when messaging in a chat embedded in a page, we use the ASP.NET SignalR library.  When porting ONLYOFFICE under Mono, we would like to use this library there as well.  It supports several types of data transports: websockets, long polling, forever frame, server sent events.  The most preferable for us is the technology of web sockets, which we use in our Saas version.  Unfortunately, at the moment SignalR does not allow the use of websockets for Mono, so an attempt was made to use Long Polling as a transport.  But at the stage of load testing, the SignalR server fell with the exception System.IO.IOException: ‚ÄúToo many open files‚Äù - after about a thousand client connections.  Upon further investigation of the problem, a socket leak on the SignalR server was noticed after the client disconnect, which we reported to the SignalR developers.  We hope in the next version of SignalR this problem will be solved. <br>  <b>As they decided:</b> other transports are not suitable for solving our problems for various reasons, therefore at the moment for the version for Mono we had to disable the chat, which works through SignalR. <br><br>  In total, several hundred changes were made to the project, however, as a result, we managed to make a version that, when building from the same source, works correctly under Windows and under Unix using Mono. <br><br><h2>  What we have in the end </h2><br>  Half a year has passed since the first ONLYOFFICE page was launched under Mono.  Today we have a <a href="http://www.onlyoffice.com/ru/server-common.aspx">cross-platform solution</a> for managing projects and documents, maintaining a customer base, enhanced by a mail aggregator and other collaboration tools. <br><img src="https://habrastorage.org/files/cf3/ca6/640/cf3ca6640d3d4e338f9a2f7ca505bdb3.png"><br><br><ul><li>  The source code for ONLYOFFICE Common Server can be found in <a href="https://github.com/ONLYOFFICE">the GitHub repository</a> . </li><li>  You will find the installation files at <a href="http://sourceforge.net/projects/teamlab/files/ONLYOFFICE%25208.1/binaries/">Sourceforge</a> . </li><li>  ONLYOFFICE APT <a href="https://help.onlyoffice.com/products/files/doceditor.aspx%3Ffileid%3D4065006%26doc%3Ddzd3c25JRGFFa0xzL1lKNEIrd2xDZEJySWNhWTBzdVVyeFB6b3Rsa1BTbz0_IjQwNjUwMDYi0">repositories.</a> </li></ul><br>  As the copyright protection for our product, we have chosen the <a href="http://www.onlyoffice.com/ru/license-faq.aspx">AGPL v.3 license</a> , that is, you can deploy ONLYOFFICE Common for the team‚Äôs internal work, however, using the sources in your own project, you must open its code under the same license. <br><br><h2>  Docker Trend </h2><br>  Already a couple of hours after the release of the version, a message from an initiative user appeared on our <a href="http://dev.onlyoffice.org/ru/viewtopic.php%3Ff%3D5%26t%3D707">developer forum</a> , who was ahead of us and already managed to wrap the entire solution in the Dockerfile (for which we thank him very much). <br><br>  Despite the fact that we still need to work with this assembly, the trend has been guessed correctly - in the near future we plan to prepare ONLYOFFICE Docker-container for each distribution language. <br><br><h2>  Online Document Editors for Linux - Coming Soon </h2><br>  Most of the ONLYOFFICE backend of document editors is written in C ++, so the translation of the application under Linux is done by other methods. <br><br>  For example, we recently finished working with elements responsible for converting document formats.  The main difficulty here is to get rid of ActiveX and ATL components. <br><br>  To realize our plans, it was necessary to carry out four steps: <br><ul><li>  Get rid of ATL containers (such as lists, arrays, etc.) and use STL instead. </li><li>  Rewrite CString - class for working with strings - for other platforms. </li><li>  Get rid of platform-specific API calls and, where necessary, use third-party libraries (for example, they wrote a cURL wrapper for uploading pictures, instead of WinInet, the WinAPI part for networking). </li><li>  Leave ActiveX and build LIBs instead of COM libraries, as well as executable files using these libs. </li></ul><br>  The nearest plans include the development of desktop office applications for popular OSs, so for the build we used qmake from the Qt Framework framework.  In addition, IDE QtCreator seemed the most convenient option for developing and debugging code. <br><br>  * * * <br><br>  If we started developing the product today, of course, we would turn to <a href="http://blogs.msdn.com/b/dotnet/archive/2014/05/12/the-next-generation-of-net-asp-net-vnext.aspx">ASP.NET vNext</a> , which was announced just in time for the ONLYOFFICE porting process (about the unfair development world!).  However, the matter has already been done, and the plans, as always, are Napoleonic.  Next year we are launching an open online office for Linux, which means we can finally face off with OpenOffice on their own territory.  However, this is a completely different story, which we will discuss in more detail in January. <br><br>  In the meantime, our team wishes everyone a Happy New Year! <br>  ps.  Who is already on vacation with his soul, and with his body in the office, can pass the clock, counting all the penguins on the photo (our employees do not count;) <br><br><img src="https://habrastorage.org/files/af4/662/2a7/af46622a75fe4948952905e01a569c68.jpg"></div><p>Source: <a href="https://habr.com/ru/post/246777/">https://habr.com/ru/post/246777/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246757/index.html">How to scratch any application on the iPhone, and how to prevent it</a></li>
<li><a href="../246759/index.html">Scapegoat trees</a></li>
<li><a href="../246763/index.html">Writing vector on dlang</a></li>
<li><a href="../246765/index.html">How we built the ‚ÄúFault Tree‚Äù</a></li>
<li><a href="../246773/index.html">Interview with the Mainframe Quality Engineers team</a></li>
<li><a href="../246779/index.html">Cut by the most dynamically growing agencies / studios</a></li>
<li><a href="../246781/index.html">ROS Speech Recognition with Pocketsphinx and Kinect</a></li>
<li><a href="../246783/index.html">New Year, garland, arduino</a></li>
<li><a href="../246785/index.html">What you need to know to draw well?</a></li>
<li><a href="../246787/index.html">As the world's first computer saved from oblivion at the dump</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>