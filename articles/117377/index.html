<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Adding a disk to MDADM RAID 5/6 on the fly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to share with you a brief instruction on how to add a disk to an existing RAID 5/6 without rebuilding the array (it is often simply unrea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Adding a disk to MDADM RAID 5/6 on the fly</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/213/252/0b3/2132520b3382ae83bb8ad3b3f81faed9.gif" align="right">  Today I want to share with you a brief instruction on how to add a disk to an existing RAID 5/6 without rebuilding the array (it is often simply unrealistic to backup 4-10Tb of data) and not stopping the server for a day or so.  This instruction is written for Linux softrades via mdadm, with hardware controllers / Windows, the conversation is special and often very short (nothing at all). <br><br>  So let's get started (system - Ubuntu 10.04, but it should work almost everywhere). <br><a name="habracut"></a><br>  First of all, we connect the disk and a day or two (well, or at least once a complete overwrite), we drive it under load, write / read files.  It is necessary to immediately detect problems with the disk, controller, cable.  If this is not done, and adding a ‚Äúfailed‚Äù disk to the array can be quite fun (actually, it happened to me, the SATA6 disk was not very compatible with the SATA1 controller. But thanks to the security of mdadm, data loss was avoided). <br><br>  <b>0. Check the version of mdadm</b> - it is desirable to have the latest stable version.  (in particular, in the process of writing this guide, a bug was found when continuing to work after a failure - no stripe_cache_size was installed - but this should already be fixed) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. Disable write intent bitmap</b> if you have had one (it is used to speed up rebuilding of the array in case of failure): <br><br> <code>mdadm --grow --bitmap=none /dev/md0</code> <br> <br>  <b>2. Add disks to the array</b> as a hot spare (hot spare) - at this stage, while nothing starts to be written on them, the disks will be used in case of failure or subsequent resizing of the array. <br><br> <code>mdadm /dev/md0 -a /dev/sda1 <br> mdadm /dev/md0 -a /dev/sdb1 <br></code> <br>  We do cat / proc / mdstat, and we see that the disks were added as hot spare (S) <br><br> <code>Personalities : [raid6] [raid5] [raid4] <br> md0 : active raid6 sdb1[7](S) sda1[6](S) sdd1[2] sdc1[4] sdh1[0] sdg1[5] sdf1[1] <br> 2929683456 blocks super 1.2 level 6, 1024k chunk, algorithm 2 [5/5] [UUUUU] <br></code> <br><br>  <b>3. We check the UPS</b> by pulling the <s>socket out of the wall</s> from the outlet (although the outlet can also be).  Accumulators like to sulfatirovat over time imperceptibly for ups, and can suddenly die in a couple of seconds. <br><br>  Despite the fact that having a UPS is not necessary for a safe resize, it is quieter with it.  The raid array driver in the kernel keeps the resize progress constantly, and if it fails anywhere, it can continue without problems. <br><br>  <b>4. The most important team</b> : <br><br> <code>mdadm --grow /dev/md0 --raid-disk=8 --backup-file=/var/backup</code> <br> <br>  backup-file ‚Äî required to save a backup of the array data in the event of a failure at the very first stage of resizing the array.  Needless to file do not need to lay on the raid itself <img src="https://habrastorage.org/getpro/habr/comment_images/589/4ca/0c9/5894ca0c9e7ef627bfd7178b08017a4b.gif">  .  Similarly, RAID-5 can be made RAID-6 by specifying - level = 6 (recall that RAID-6 can withstand the death of 2 any drives, which is very important, since recovering large RAID-5 takes up to 10-20 hours and something can happen at this time ...) <br><br>  The resize operation on average occurs at the speed of the slowest disk.  Those.  if the slowest disk presses 60Mb / s, then mdadm will need one pass through the array at such a speed.  In the case of terabyte drives, this is about 5 hours, if the processor keeps up, and slower if it doesn't.  If the speed is too low - do <br><br> <code>echo "200000" &gt; /sys/block/md0/md/sync_speed_max <br></code> <br>  In the process of expanding the array, data remains available, you can watch the progress through / proc / mdstat. <br><br>  <b>5.</b> After the resize is completed, we <b>expand the file system</b> .  First check <br><br> <code>e2fsck -f /dev/md0 <br></code> <br>  Then the actual extension: <br><br> <code>resize2fs /dev/md0 <br></code> <br>  <b>6. Add back to write intent bitmap:</b> <br>  mdadm -G / dev / md0 --force -b / var / md0_intent --bitmap-chunk = 65536 <br><br>  <b>7. Re-generate the mdadm.conf config</b> .  We carry out <br><br> <code>mdadm --detail --scan ‚Äìverbose <br></code> <br><br>  And the result is inserted into /etc/mdadm/mdadm.conf <br><br>  <b>8. Re-generate ramfs</b> to use the correct mdadm config after reboot: <br><br> <code>update-initramfs -k all ‚Äìu <br></code> <br><br><h4>  Is done </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/210/833/ca4/210833ca418d52ae5bce04381fb9c973.png" align="right">  Now you have a bigger RAID, and you did not have to pay a lot of money to get this opportunity.  Do not forget about monitoring - the more disks, the higher the risk of one of them overheating. <br><br>  <b>PP.</b>  You can do other funny things with mdadm - for example, if you have a 1TB disk array, you suddenly find 2 to 500 - you can combine them into RAID-0, and add them to the main array.  And if there is 100MB of free space on these two disks, you can do it in a separate partition, merge into RAID-1, and mount / boot / there, and then the system can be completely transferred to RAID, and loaded without aids (like flash drives, old brooms and so on.). <br><br>  <b>Pps.</b>  Looking at the number of disks on the right from my home file server, I begin to think that I probably had a too small hard drive as a child ... However, it could be worse <img src="https://habrastorage.org/getpro/habr/comment_images/589/4ca/0c9/5894ca0c9e7ef627bfd7178b08017a4b.gif"><br><br>  Comments / questions - in the studio. </div><p>Source: <a href="https://habr.com/ru/post/117377/">https://habr.com/ru/post/117377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117372/index.html">Review Qumo Go!</a></li>
<li><a href="../117373/index.html">Orchard CMS for developer</a></li>
<li><a href="../117374/index.html">Not nginx by one ...</a></li>
<li><a href="../117375/index.html">GreenSQL: Protecting SQL Servers from Injections</a></li>
<li><a href="../117376/index.html">Post for Japan</a></li>
<li><a href="../117378/index.html">Flock browser support ends April 26</a></li>
<li><a href="../117380/index.html">In Google Docs appeared pagination and embedded print</a></li>
<li><a href="../117381/index.html">MySQL can work as a NoSQL server</a></li>
<li><a href="../117383/index.html">BDD: Adaptation of the Gherkin language for Russian-language projects in Asp.Net</a></li>
<li><a href="../117385/index.html">However, the trend: MUDs are slowly starting to evolve into Jabber instead of telnet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>