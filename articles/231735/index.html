<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting the display of the DVD player to the microcontroller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I'll start with the background, why do I need all this? I set out to make myself a HTPC computer based on the enclosure from the Daewoo DV-500 DVD pla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting the display of the DVD player to the microcontroller</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/6b6/d43/195/6b6d43195c50451f824e807d5a5e7a06.JPG"></div><br><br>  I'll start with the background, why do I need all this?  I set out to make myself a HTPC computer based on the enclosure from the Daewoo DV-500 DVD player, outwardly I like it, and there is enough free space in it to install the necessary hardware inside.  But above all, I decided to leave the native indicator and use it to display various information.  How I connected the display to the microcontroller and decrypted the protocol of an exchange of this display, will go in this article. <br><a name="habracut"></a><br>  Such work should be started with information retrieval, first of all I found the player's circuit; I was surprised that there were no problems with this.  According to the scheme, I was able to understand what I have to work with, but I could not immediately find the descriptions on the display controller, since  On the diagram, it is signed incorrectly.  Unfortunately, I found the documentation for the controller at the last moment, by chance, but by that time I had almost completely disassembled the protocol. <br><br>  So, what do we have: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/8ec/a33/587/8eca33587255445b947acc1a102b6868.png"></div><br><br>  We have a NEC D16312 VFD display controller (note how the controller is signed on the circuit, it‚Äôs not surprising that I couldn‚Äôt immediately find the info about it), with the VFD display, keyboard matrix and LED connected to it.  With the "outside world" controller is connected via a serial interface via connector CN1. <br><br>  To intercept messages from the mainboard controller to the display controller, I will use a logic analyzer.  I, for example, use the Chinese clone USBee AX PRO, it performs its functions perfectly well and is inexpensive. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/366/1cc/080/3661cc080fcd422d8edd7fcf8263284b.png"></div><br>  We connect the Data, Clk and Cs pins to any three pins of the logic analyzer, do not forget to also connect the earth.  Next, we connect the analyzer via USB to the computer and run the USBee Suite (I omit the installation process of the drivers and software for the logic analyzer, this is beyond the scope of the article).  In the settings for Speed ‚Äã‚Äãand Samples we set the following parameters: Sample Rate - 2Msps, Buffer Size - 10M samples.  This will be enough to capture an exchange frame size of 5 seconds. <br><br>  My further actions are as follows: I make a single capture (the Capture Once button) and immediately turn on the player.  As soon as the first information appeared on the screen, I turn off the capture.  After doing such actions for different versions of the displayed text, I began to analyze the information received. <br><br>  So, what are the patterns in all the sending teams.  The first thing that caught my eye right away was the frequency of sending a command with code 0x42 and three empty bytes after it.  The team has a strict periodicity of appearance even when the video player is at rest.  I assumed that this is a command for polling the keyboard, checking the theory is very easy, I pinch any button on the player and capture the frame in the program. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/066/560/33e/06656033e196440e874e7fd3b13d1816.png"></div><br><br>  Immediately after the byte 0x42, the non-zero byte appeared, but before it was 0!  Thus, 0x42 is a keyboard polling command that is sent by the mainboard controller to the display controller and, in response to this command, the display controller responds with the key code (or 0 if none is pressed). <br><br>  The next in line was a team with code 0x40, it appeared only when information was displayed on the screen.  After it, there are always two bytes, the first byte always starts with 0xCX, where X is a changing value.  The third byte has arbitrary values, but the main thing is that when it is first turned on it is always 0 <br><br><img src="https://habrastorage.org/files/db9/09e/28a/db909e28a0b443daa256496b234e595b.png"><br><br>  This screenshot shows that the second byte grows with each sending of the 0x40 group, most likely it sets the address of the character and the value of the character is written in the third byte.  In this case, 0 clears the character.  Always after sending all groups with code 0x40, two bytes 0x02 0x8F will follow. <br><br><img src="https://habrastorage.org/files/9b8/d91/047/9b8d91047cb54a91a00d4bf92dbcce56.png"><br><br>  Well, the last group of data is the command starting with the code 0x41 and the subsequent zero byte after it.  The command appears only when the video player is first turned on. <br><br>  Data analysis has drawn a more or less clear picture of the controller, it remains only to check everything in practice.  I used the LPCXpresso debug handkerchief, which I received in a free-fall manner as part of some kind of competition from NXP.  The shawl is equipped with a simple 32-bit LPC1114 controller.  Since  Since the controller is powered by 3.3V, and the display controller D16312 is from 5 volts, I did not decide to connect their outputs directly.  The microcontroller pins may be tolerant to 5V, but I had a 3.3-5V matching handkerchief and I used it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/43c/09d/e03/43c09de038244a8cab04435847b1cffa.jpg"></div><br><br>  So, from the connector going to the main board, we extract 3 wires responsible for the Data, Cs and Clk pins, 1, 2 and 3, respectively. GND and + 5V VCC.  For the first time, I attached three contacts extracted from the main board with the logic analyzer in order to debug the transmitted information. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d08/2d2/b44/d082d2b44cdf46a1bf7795f7644853a0.JPG"></div><br><br>  This is how I look like with a debugging <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb8/6d3/960/cb86d396087b4d459c4f3aa102cd04e4.JPG"></div><br><br>  All the iron part is ready, it's time to start the software.  To begin with, we will write a program that will repeat the data obtained during the analysis.  For LPCXpresso, the Eclipse-based LPCXpresso IDE is used.  We start, specify the path to our new workspace and import 2 standard libraries CMSIS_CORE_LPC11xx and LPC11xx_cmsis2_Lib into it, we will need them for development.  Next, create a new project File-&gt; New-&gt; C / C ++ -&gt; LPCXpresso C Project, then LPC11 / LPC12 -&gt; LPC11xx / ... -&gt; C Project.  Set the project name and in the next window select the target controller, in my case it is LPC1114 / 302.  At the next step, the library CMSIS_CORE_LPC11xx should appear in the list, since  we imported it earlier.  In the DSP library job window, we change nothing and in the next step we leave everything by default, click Finish. <br><br>  Add the following code to the generated file &lt;project name&gt; .c <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __USE_CMSIS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LPC11xx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clkconfig.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"gpio.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cr_section_macros.h&gt; void Delay(int32_t ticks); void BeginCommand(uint8_t cmd, uint8_t isSingle); void EndCommand(); void Clock(); void WriteData(uint8_t data); #define PORT 3 #define DATA_BIT 2 #define CLK_BIT 0 #define CS_BIT 1 int main(void) { GPIOInit(); // Set pins to output GPIOSetDir(PORT, CLK_BIT, 1); GPIOSetDir(PORT, CS_BIT, 1); GPIOSetDir(PORT, DATA_BIT, 1); while(1) { BeginCommand(0x40, 1); BeginCommand(0xC0, 0); WriteData(0xFF); EndCommand(); BeginCommand(0x02, 1); BeginCommand(0x8F, 1); Delay(3000000); } return 0 ; } void Delay(int32_t ticks) { volatile int32_t i = ticks; while(i--); } void BeginCommand(uint8_t cmd, uint8_t isSingle) { GPIOSetValue(PORT, CLK_BIT, 1); GPIOSetValue(PORT, CS_BIT, 0); Delay(10); WriteData(cmd); if (isSingle) { EndCommand(); } } void EndCommand() { GPIOSetValue(PORT, CLK_BIT, 1); GPIOSetValue(PORT, CS_BIT, 1); Delay(10); } void Clock() { Delay(10); GPIOSetValue(PORT, CLK_BIT, 0); Delay(10); GPIOSetValue(PORT, CLK_BIT, 1); } void WriteData(uint8_t data) { GPIOSetDir(PORT, DATA_BIT, 1); uint8_t i = 0; for (i = 0; i &lt; 8; ++i) { uint8_t isSet = (data &amp; 0x01); GPIOSetValue(PORT, DATA_BIT, isSet); Clock(); data = data &gt;&gt; 1; } }</span></span></span></span></code> </pre> <br>  Here we see several functions for working with a serial port.  At the very top of the file, the port and pin settings for data, synchronization and strobe are specified.  In my case, everything hangs on port 3, pin 2 is responsible for the Data signal, 0 is synchronization and 1 is gating. <br><br>  The fc BeginCommand sends a command to the port, this f-c has a second interesting parameter.  If you look at the graphs of signals above, you can see that the gating signal is set to the active (low) level, before sending data, and changes between two independent commands.  But it does not switch if data should be transmitted after sending the command <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ecc/c34/8e4/eccc348e4a664fa8b717c7df97c11e38.png"></div><br><br>  So, the second parameter says that the command is atomic if isSingle == 1. For the case of non-atomic commands, the EndCommand function is intended, which should be called after sending the data. <br><br>  Sending the data is done in the WriteData function, in turn, bit-for-bit, starting with the youngest, we pass the information to the Data pin.  Each data entry is accompanied by a synchronization signal, the Clock function generates it. <br><br>  In the f-main function, we first initialize the work with the I / O inputs, then expose the Data, Clk and Cs pins for output.  In an infinite loop, we imitate the commands that were obtained earlier in the data analysis stage.  So  we sent a 0x40 0xC0 0xFF 0x02 0x8F data sequence to the display controller, and the controller responded with the output _8 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dcb/192/c1f/dcb192c1f7b54f9dbc5c1ce139c2145b.JPG"></div><br><br>  So  it was found that the command: <br>  - 0x42 - is responsible for handling the keyboard.  After it is sent to the display controller, you need to set the Data port to the input and read data from it, previously synchronized with the signal Clk <br>  - 0x40 - a command to write data to the display, after it a command should be written to specify the address of the symbol, and after the address is specified, data is written <br>  - 0x41 is a command to control the LED, after it comes a data byte which LED should be on or not <br>  You can find more detailed information in the manual for this display controller D16312, where they describe how commands should be formed.  Well, I designed all the work in a small library that lies on the <a href="https://github.com/evg1985/D16312Lib">githaba</a> .  The library allows you to display text, manage special characters, fill in the drive symbol as a percentage, read the keyboard, change the display brightness and control the LED.  That's all, I hope someone this reading matter will be useful and interesting.  And I'll leave a video for a snack, with a demonstration of the library <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/XJvF05XNrD8%3Ffeature%3Doembed&amp;xid=17259,1500004,15700021,15700186,15700190,15700253&amp;usg=ALkJrhi3I27dPGSIFEoNw6OQNY9IdDXk2g" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/231735/">https://habr.com/ru/post/231735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231725/index.html">nooLite: new PT112 temperature sensor and RX2132 USB receiver</a></li>
<li><a href="../231727/index.html">Push mailings on PHP (Android and IOS). Minimum ready solution</a></li>
<li><a href="../231729/index.html">How to make the Galaxy S4 work with a Pioneer radio. Switch selinux to permissive</a></li>
<li><a href="../231731/index.html">Library for automating acceptance testing in mobile applications</a></li>
<li><a href="../231733/index.html">History of Audiomania. Part 1</a></li>
<li><a href="../231739/index.html">Classes in Swift [Part 1]</a></li>
<li><a href="../231741/index.html">Microsoft case: how to avoid contradictions by working with personal data in Europe and the USA?</a></li>
<li><a href="../231743/index.html">3D printer without a computer</a></li>
<li><a href="../231745/index.html">Highly loaded sites and applications in PHP / Symfony</a></li>
<li><a href="../231747/index.html">ONLYOFFICE. Naked Truth About Cloud Office Source Code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>