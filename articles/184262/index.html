<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centrifuge - real-time messaging broker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 In the article I will describe my small open-source project - Centrifuge (hereinafter referred to as Centrifuge). This is a Python server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centrifuge - real-time messaging broker</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  In the article I will describe my small open-source project - <a href="https://github.com/FZambia/centrifuge">Centrifuge</a> (hereinafter referred to as Centrifuge).  This is a Python server whose task is to send (broadcast) messages in real time to connected (mainly from the browser) clients. <br><br>  It will be a story filled with both personal emotions and a description of the technologies used, but without code examples.  If the topic is close to you - do not pass by, it will be curious. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For a start, please see the screencast (do not forget to include subtitles), if after watching the interest does not disappear, feel free to read further! <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/RCLnCexzfOk%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700190,15700253&amp;usg=ALkJrhgTuE7FSh0H2zxYhPbwNqc4-dAraw" frameborder="0" allowfullscreen=""></iframe><br><a name="habracut"></a><br><br>  The idea of ‚Äã‚Äãa real-time server of messages is not new at all; among existing similar projects I can cite as an example <a href="http://pusher.com/">Pusher</a> and <a href="http://www.pubnub.com/">Pubnub</a> .  Here is a quote from the Pusher website: <br><br><blockquote>  Pusher is a hosted API for web and mobile apps. </blockquote><br><br>  Pubnub on its main page tells us something similar: <br><br><blockquote>  Thousands of mobile, web, and desktop apps. </blockquote><br><br>  Goals Centrifuges are not so global.  This is not a ready distributed worldwide infrastructure for creating real-time applications, it‚Äôs just a server that you install on your machine and use as a message broker. <br><br>  I have no doubt that there are quite a few such servers.  Some time ago I myself happened to write a very similar thing - <a href="https://github.com/FZambia/cyclone-sse">cyclone-sse</a> .  This is a Twisted daemon that allows you to send messages to channels in real time using <a href="http://en.wikipedia.org/wiki/Server-sent_events">Server-Sent Events (SSE)</a> technology (or fallback to Long-Polling for old people like IE 7).  It turned out quite a decent piece of code that we successfully use in battle. <br><br>  However, that demon does not solve some important problems: <br><br>  1) Lack of any authorization.  In our case, all projects are closed from the outside by the company's firewall and we use cyclone-sse only for public data.  But to add real-time events to a project that is accessible to all Internet users, an authorization mechanism is needed. <br><br>  2) Does not use <a href="http://ru.wikipedia.org/wiki/WebSocket">Websockets</a> .  A protocol that provides the possibility of two-way data exchange (while SSE is a unidirectional protocol, messages are only possible from the server to the client).  In addition, web sockets support cross-domain communication, which is not always true for Server-Sent Events. <br><br>  One day a work colleague complained that he lacked the ability to monitor package updates for JAVA.  I thought it was a good idea for a small project - to track new packages, perhaps not only for Java, but also for other programming languages, to show updates in the web interface in real time - and I started. <br><br>  The more I wrote, the further the code went from the original idea.  From the package update aggregator, the project became the aggregator of everything. <br><br>  It sounds strong, but after a while I realized that the implementation of such a task requires something more than I have ... And it was decided to simplify everything - at that time the skeleton of sending messages to connected clients was written, why not develop this area?  I realized that I could write code similar in purpose and scope to cyclone-sse, but more adapted to mass use. <br><br>  So, you are a python programmer and you need to write such a server - what will you use?  A choice of <a href="http://twistedmatrix.com/trac/">Twisted</a> , <a href="http://www.gevent.org/">Gevent</a> and <a href="http://www.tornadoweb.org/en/stable/">Tornado</a> .  And, while Guido Van Rossum is standardizing the interface of event-loop programs in the <a href="http://code.google.com/p/tulip/source/browse/README">Tulip</a> library, we need to choose. <br><br>  I chose a tornado.  He works on the third python, he's just great after all.  In many ways, this choice and the desire for the final code to work in Python 3.3 predetermined the choice of other related technologies - <a href="http://www.zeromq.org/">ZeroMQ</a> ( <a href="https://github.com/zeromq/pyzmq">pyzmq</a> ), <a href="https://github.com/sockjs/sockjs-client">SockJS</a> ( <a href="https://github.com/mrjoes/sockjs-tornado">sockjs-tornado</a> ), <a href="http://www.mongodb.org/">MongoDB</a> ( <a href="https://github.com/mongodb/motor">motor</a> ) and <a href="http://www.postgresql.org/">PostgreSQL</a> ( <a href="https://github.com/FSX/momoko">momoko</a> ).  All libraries are asynchronous, excluding locks when interacting with sockets. <br><br>  I didn‚Äôt come to ZeroMQ right away. <br><br>  When there are several application processes behind the balancer, and customers can theoretically connect to any of them - it is necessary to somehow maintain the integrity of the internal state of such a system and be able to communicate between application instances.  Initially, for these purposes, I used the <a href="http://redis.io/">Redis</a> Pub / Sub mechanism.  But I stumbled upon a bug in the implementation of the <a href="https://github.com/leporo/tornado-redis">Tornado-Redis</a> library and looked towards other solutions. <br><br>  As a result, the choice fell on ZeroMQ - sockets on steroids, a set of patterns for organizing a wide variety of network interactions.  The lack of a separate broker is just great.  If you have not heard about this library, or have heard, but did not go into details - correct it now!  Read them <a href="http://zguide.zeromq.org/page:all">The Guide</a> , it's worth it.  This is my first project using this library, I hope experienced community members will look at the code and point out possible flaws. <br><br>  Each Centrifuge process creates a PUB socket that is bound to a specific address / port.  The process also has a SUB socket, which connects to the PUB socket of the current process and the PUB sockets of the other instances (if running).  <a href="http://zguide.zeromq.org/page:all">The disadvantage of this scheme</a> is the need to manually specify all the addresses of PUB sockets when starting the process.  Therefore, it is possible to run XPUB / XSUB proxies in a separate process and start all Centrifuge processes using this proxy.  That is, to organize all the interaction here according to this scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/551/8d7/cf1/5518d7cf1b8c4088f25295b8439b2589.png" alt="image"><br><br>  The last piece of the puzzle is the client.  Tornado out of the box works with web sockets, but I decided to go a little further and allow the client to use SockJS as well.  So everything will work in browsers without the support of web sockets.  I would like to separately thank <a href="http://mrjoes.github.io/">Serge S. Koval (mrjoes)</a> for sockjs-tornado.  Support for <a href="http://socket.io/">socket.io is</a> not planned. <br><br>  So, what is the result?  And something like this: <br><br><img src="https://habrastorage.org/storage2/e15/3ab/bf8/e153abbf895bd6f8263fcb2f58ebe2a6.png" alt="image"><br><br>  As can be seen in the diagram, MongoDB or PostgreSQL is used as a database.  What should we keep?  Projects and their settings, categories within these projects.  More on this talk a little below. <br><br>  It seems to me that I still haven‚Äôt been able to clearly explain what I‚Äôm doing to everyone here.  So, here‚Äôs something like this: <br><br>  1) You wanted to add something real-time to your site - comments, charts, updated counters, notifications ... <br><br>  2) However, your site is not on an asynchronous backend, or on the asynchronous one, but you don‚Äôt want to write from scratch the logic of the management of channels, subscriptions, etc. <br><br>  A centrifuge may well suit you in this case. <br><br>  3) pip install centrifuge.  Or a little more <a href="https://centrifuge.readthedocs.org/en/latest/starting/install.html">detail</a> in the documentation (the documentation is still crumpled, incomprehensible in some places, but in the future I hope to change it for the better). <br><br>  4) I still have to integrate ... I will emphasize some important points. <br><br>  For starters, you need to run a centrifuge.  Yes, there are all sorts of options for launching there, but I believe that you will succeed, and if not, write to me, I will help. <br><br>  After starting, you need to go to the administrative web interface, create a new project.  The project has several settings, I will not describe them in this article - the text and so it turns out too much. <br><br>  After creating the project, add categories to it - in fact, these are the namespaces in the project, within which there are channels.  Since channels are created on the fly, categories play the role of a repository of settings for channels, and also exist to limit subscription rights to a particular channel within a category. <br><br>  Perhaps the most important option for the category is bidirectional.  If you tick it off, then connected clients will be able to send messages to the channel themselves, without involving your application.  Otherwise, only a unidirectional message from the server to the client - when your application sends an event to the Centrifuge using a POST request.  A POST request contains data about the project, category, channel and the message being sent directly.  The message is sent to all subscribers subscribed to the channel. <br><br>  So, the Centrifuge (or several Centrifuges) is spinning its event-loop, projects and categories are created, it's up to the client part.  As I said before, you can use native web sockets or the SockJS library for communication.  Currently there are no javascript libraries that simplify interaction with the Centrifuge, they may appear in the future.  So far, in order to interact, you need to send JSON messages corresponding to JSON schemes.  Currently there are only 4 methods for such commands: <br><br><ul><li>  <i>auth</i> - the first message after the connection is established - authorization. </li><li>  <i>subscribe</i> - after successful authorization, you can subscribe to channels in various categories that were accessed during authorization. </li><li>  <i>unsubscribe</i> - unsubscribe from the channel </li><li>  <i>broadcast</i> - send a message to the channel, works only for channels belonging to the bidirectional category </li></ul><br><br>  In order not to allow everyone and everyone to connect to the Centrifuge channels, symmetric encryption is used based on the secret key.  This key can be seen in the web interface in the project settings.  Your web application should be able to generate a special token ( <a href="https://github.com/FZambia/centrifuge/blob/master/src/centrifuge/auth.py">like this</a> ) based on this project secret key. <br><br>  When connecting a new client, if you specified a special address in the project parameters - the Centrifuge will send a POST request to this address with the data of the connecting client, your application should determine whether this client has access to the requested sections, and if authorization is allowed - return corresponding centrifuge response. <br><br>  I omitted a lot of technical details.  Specially did not insert a single piece of code - the project is very young and who knows what will change in the near future, at least after comments on this article.  The interaction with the Centrifuge using a special client <a href="https://github.com/FZambia/cent">Cent</a> , a detailed description of client authorization, analysis of command parameters for interaction from the browser, description of project options and categories remained behind the scenes.  I think that would be too tiring.  If there is any interest in the project, I will write about it in the future. <br><br>  In the repository on Github there is <a href="https://github.com/FZambia/centrifuge/tree/master/examples/tornado_application">an example of an application</a> using a Centrifuge.  And in the documentation there is an example of <a href="https://centrifuge.readthedocs.org/en/latest/deployment/nginx.html">Nginx configuration</a> for deployment.  License - BSD.  If for any reason you want, but cannot use Centrifuge because of the license - write to me, I will reconsider. <br><br>  Waiting for your comments and suggestions for improvement. </div><p>Source: <a href="https://habr.com/ru/post/184262/">https://habr.com/ru/post/184262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184244/index.html">Cheap dedicated: on what do we save?</a></li>
<li><a href="../184246/index.html">On Edward Snowden opened a criminal case for espionage</a></li>
<li><a href="../184248/index.html">Github limits the maximum file size to 100 megabytes.</a></li>
<li><a href="../184250/index.html">The "constexpr" functions do not have the "const" specifier</a></li>
<li><a href="../184260/index.html">The game "guess anime on frame" - protection against cheating</a></li>
<li><a href="../184264/index.html">Auto-completion of SQL code directly in PHPStorm</a></li>
<li><a href="../184266/index.html">Facebook leaked personal data to 6 million users</a></li>
<li><a href="../184268/index.html">A collection of resources for frontend and backend developers</a></li>
<li><a href="../184274/index.html">Text in line or how to beat designer</a></li>
<li><a href="../184276/index.html">Electric can "fill" in 90 seconds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>