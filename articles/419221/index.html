<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Dependent items in Zabbix 4.0 using the example of HPE MSA 2040/2050</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Everyone who uses the Zabbix monitoring system and monitors its development knows that with the release of Zabbix 3.4 we have a great f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Dependent items in Zabbix 4.0 using the example of HPE MSA 2040/2050</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  Everyone who uses the Zabbix monitoring system and monitors its development knows that with the release of Zabbix 3.4 we have a great feature - Dependent Items (dependent data elements), which already had a <a href="https://habr.com/company/zabbix/blog/337856/">corresponding post</a> on the Zabbix blog.  However, in the form in which it was introduced in 3.4, using it ‚Äúto the fullest‚Äù was problematic in view of the fact that LLD macros were not supported for use in preprocessing rules ( <a href="https://support.zabbix.com/browse/ZBXNEXT-4109">ZBXNEXT-4109</a> ), and also as a ‚Äúparent‚Äù The data item could only be selected by the LLD rule itself ( <a href="https://support.zabbix.com/browse/ZBXNEXT-4200">ZBXNEXT-4200</a> ).  In short, I had to do everything exactly as described in the link above - to work with my hands, which, with a large number of metrics, was a lot of inconvenience.  However, with the release of Zabbix 4.0alpha9, everything has changed. <br><a name="habracut"></a><br><h2>  A bit of history </h2><br>  For me, the described functionality was important due to the fact that our company uses several HP storage systems, namely HP MSA 2040/2050, which metrics are retrieved by querying their XML API using a <a href="https://github.com/asand3r/zbx-hpmsa">Python script</a> . <br><br><img src="https://habrastorage.org/webt/fg/kr/pr/fgkrprt4os5uskdtfey9z3mgvw8.png"><br><br>  At the very beginning, when the task of monitoring the designated equipment arose and an option was found using the API, it turned out that in the simplest case, to find out, say, the health of one storage component, two requests were required: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Request authentication token (session key); </li><li>  The request itself that returns information on the component. </li></ul><br>  Now imagine that the storage consists of 24 disks (and maybe more), two power supply units, a pair of controllers, fans, several disk pools, etc. - we multiply all this by 2 and we get more than 50 data elements, which equals so many requests to API at every minute checks.  If you try to follow this path, the API quickly ‚Äúfalls‚Äù, and in fact we are talking only about requesting the ‚Äúhealth‚Äù of components, not taking into account other possible and interesting metrics - temperature, hours of working hours for hard drives, fan speed, etc. <br><br>  The first solution I made to unload the API, even before the release of Zabbix version 3.4, was to create a cache for the resulting token, the value of which was recorded in the file and stored for N-minutes.  This made it possible to reduce the number of calls to the API exactly twice, however, the situation did not change much - it was problematic to get something besides the state of health.  Around this time, I visited Zabbix Moscow Meetup 2017, hosted by Badoo, where I learned about the above-mentioned functionality of dependent data elements. <br><br>  The script was refined to the possibility of giving detailed JSON objects containing information of interest to us on various components of the repository and its output began to look something like this instead of single string or numeric values: <br><br><pre><code class="hljs objectivec">{<span class="hljs-string"><span class="hljs-string">"1.1"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"24"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27267"</span></span>},<span class="hljs-string"><span class="hljs-string">"1.2"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"23"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27266"</span></span>},<span class="hljs-string"><span class="hljs-string">"1.3"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"24"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27336"</span></span>}, ... }</code> </pre> <br>  This is an example of data being sent across all storage disks.  For the rest of the components, the picture is similar - the key is the ID of the component, and the value is the JSON object containing the desired metrics. <br><br>  Everything was fine, but the nuances described at the beginning of the article quickly surfaced - all dependent metrics had to be created and updated manually, which was quite painful (about 300 metrics per storage system plus triggers and graphs).  We could have been saved by the LLD, but here, when creating the prototype, it did not allow us to specify as the parent item that which was not created by the rule itself, but a dirty hack with the creation of a fictitious item through the LLD and replacing its itemid in the database with the necessary one, dropped Zabbix server.  The mentioned features quickly appeared in the Zabbix bugtracker, which indicated that this functionality was important not only for me. <br><br>  Since  all the preparatory operations on my part were completed, I decided to suffer and not produce temporary solutions, such as dynamic template generation, and waited only for the closure of the ZBXNEXTs mentioned at the beginning of the article, and just recently it was done. <br><br><h2>  How it looks now </h2><br>  To demonstrate the new features of Zabbix, we will take: <br><br><ul><li>  Storage HPE MSA 2040 available over HTTP / HTTPS; </li><li>  Zabbix 4.0alpha9 server installed from the official repository on CentOS 7.5.1804; </li><li>  A script written in Python of the third version that allows us to discover the storage components (LLD) and return the data in JSON format for parsing on the Zabbix server side using the JSON Path. </li></ul><br>  The parent data element will be an ‚Äúexternal check‚Äù (external check), calling the script with the necessary arguments and storing the received data as text. <br><br><h3>  Training </h3><br>  The Python script is installed in accordance with the <a href="https://www.zabbix.com/documentation/3.4/manual/config/items/itemtypes/external">documentation</a> and has the ‚Äúrequests‚Äù library in the Python dependencies.  If you have a RHEL-based distribution, you can install it using the yum package manager: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># yum install python3-requests</span></span></code> </pre><br>  Or using pip: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># pip install requests</span></span></code> </pre><br>  You can test the operation of the script from the shell by requesting, for example, LLD data about the disks: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># ./zbx-hpmsa.py -m MSA_DNS_NAME_OR_IP -d -c disks {"data":[{"{#DISK.ID}":"1.1","{#DISK.SN}":"KFGY7LVF"},{"{#DISK.ID}":"1.2","{#DISK.SN}":"Z0K02QVG0000C4297CH3"},{"{#DISK.ID}":"1.3","{#DISK.SN}":"KLK7XG0F"}, ... }</span></span></code> </pre><br><h3>  Host setup </h3><br>  First you need to create parent data elements that will contain all the metrics we need.  As an example, create the following element for physical disks: <br><br><img src="https://habrastorage.org/webt/l5/u4/t_/l5u4t_ruwd7ae4qjx5bkqvfyqgq.png"><br><br>  <b>Name</b> - specify arbitrary; <br>  <b>Type</b> - external check; <br>  <b>The key</b> is a script call with the necessary parameters (see the <a href="https://github.com/asand3r/zbx-hpmsa/wiki">script documentation</a> on GitHub); <br>  <b>Type of information</b> - text; <br>  <b>Update interval</b> ‚Äî the example uses the custom macro {$ UPDATE}, which expands to the value ‚Äú1m‚Äù; <br>  <b>The storage period</b> is one day.  I think that keeping the parent data element for longer does not make sense. <br>  Check the latest data on the created item: <br><br><img src="https://habrastorage.org/webt/gg/xu/yr/ggxuyr1cjvzptb332728c8kcdb4.png"><br><br>  JSON comes, so everything is done correctly. <br><br>  The next step is to set up detection rules that will find all components available for monitoring and create dependent items and triggers.  Continuing the example with physical disks, it will look like this: <br><br><img src="https://habrastorage.org/webt/th/sa/4-/thsa4-0teuslv_6ngcijvhwekfc.png"><br><br>  After creating the LLD rule, you need to create prototypes of the data elements.  Create such a prototype, for example, data on temperature: <br><br><img src="https://habrastorage.org/webt/fy/m_/jn/fym_jnzctgu7-bfrwrfmtdyzfw4.png"><br><br>  <b>Name</b> - specify arbitrary; <br>  <b>Type</b> - dependent.  As the parent data element, select the corresponding element created earlier; <br>  <b>The key</b> is to show imagination, but you need to consider that each key must be unique, so we will include the LLD macro in it; <br>  <b>Type of information</b> - in this case numeric; <br>  <b>The history storage period</b> ‚Äî in the example, this is a custom macro, specified at your discretion; <br>  <b>The trend storage period</b> is, again, a user macro; <br><br>  I also added a prototype of the ‚ÄúApplication‚Äù - you can conveniently bind to it metrics related to one component. <br><br>  On the ‚ÄúPreprocessing‚Äù tab, we will create a step of the ‚ÄúJSON Path‚Äù type with a rule that extracts temperature readings: <br><br><img src="https://habrastorage.org/webt/mm/e1/ew/mme1ewdlmonbyzzhtouw7xvet_e.png"><br><br>  The step expression looks like this: <code>$['{#DISK.ID}']['temperature']</code> <br><br>  Please note that now in the expression you can use LLD macros, which not only greatly simplifies our work, but also makes it possible to do such things quite simply (you would have been sent to the Zabbix API before). <br><br>  Next, by analogy with the temperature, we will create the remaining prototypes of the data elements: <br><br><img src="https://habrastorage.org/webt/of/_x/ea/of_xeaktpnxwt1fkr_cyqxg6hm4.png"><br><br>  At this stage, you can check the result obtained by going to the "Latest data" on the host.  If everything suits you there, we continue to work further.  I ended up getting the following picture: <br><br><img src="https://habrastorage.org/webt/xz/8j/ra/xz8jradoaqbgb82jenxd5tb8og4.png"><br><br>  We are waiting for the configuration cache to be updated or push its update manually: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># zabbix_server -R config_cache_reload</span></span></code> </pre><br>  After that you can use another cool feature of version 4.0 - the ‚ÄúCheck now‚Äù button to launch the created LLD rules: <br><br><img src="https://habrastorage.org/webt/ve/1n/us/ve1nusqx9dxihlrl81irsegjsd0.png"><br><br>  I got the following result: <br><br><img src="https://habrastorage.org/webt/hu/wl/y4/huwly49ohgadt6smw7wgraj82kq.png"><br><br><h3>  Conclusion </h3><br>  As a result, with only nine requests to the XML API, we were able to get more than three hundred metrics from one network node, spending a minimum of time and getting maximum flexibility.  LLD will give us the ability to automatically discover new components or update old ones. <br><br>  Thank you for reading the links to the materials used, and there you can find the current HPE MSA P2000G3 / 2040/2050 template below. <br><br>  PS By the way, in version 4.0, a new type of checks is also presented - an HTTP agent that paired with preprocessing and XML Path can potentially save us from using external scripts - you just need to solve the issue of obtaining an authentication token, which still needs to be updated periodically.  One of the options I see is the use of a global macro with this token, which can be updated via Zabbix API by cron, t.ch.  interested people can develop this idea.  =) <br><br>  <b><a href="https://github.com/asand3r/zbx-hpmsa">Script</a></b> <br>  <b><a href="https://share.zabbix.com/component/mtree/storage-devices/hp/hp-msa-2040-xml-api">Zabbix Template Share</a></b> <br>  <b><a href="https://www.zabbix.com/documentation/4.0/manual/config/items/itemtypes/dependent_items">Dependent Data Items</a></b> <br>  <b><a href="http://goessner.net/articles/JsonPath/">Json path</a></b> <br>  <b><a href="https://www.zabbix.com/rn/rn4.0.0alpha9">Zabbix 4.0alpha9</a></b> </div><p>Source: <a href="https://habr.com/ru/post/419221/">https://habr.com/ru/post/419221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419205/index.html">New Mikrotik vulnerability? No, but it's worth checking your devices.</a></li>
<li><a href="../419207/index.html">[Translation] 4 ways to style React components</a></li>
<li><a href="../419211/index.html">A few words in defense of smart pens</a></li>
<li><a href="../419215/index.html">Hf2Te2P - "silicon" quantum computers?</a></li>
<li><a href="../419219/index.html">"Mass Product": the first commercial DNA repository will be presented in 2019</a></li>
<li><a href="../419223/index.html">How we taught AI to recognize clusters of galaxies</a></li>
<li><a href="../419227/index.html">The history of the 1st "iPad"</a></li>
<li><a href="../419229/index.html">Situation: Meditation apps become more successful than podcasts.</a></li>
<li><a href="../419231/index.html">3 sins of the programmer: Hardcoding, Govnocoding and Shizokoding</a></li>
<li><a href="../419233/index.html">Why does the coffee machine have an account?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>