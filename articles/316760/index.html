<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Enhance your video surveillance system using OpenCV and Telegram bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began 
 It all started with the fact that I wanted to install a ‚Äúsmart‚Äù video surveillance system on Raspberry. 

 I want to separately not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Enhance your video surveillance system using OpenCV and Telegram bot</h1><div class="post__text post__text-html js-mediator-article"><h2>  How it all began </h2><br>  It all started with the fact that I wanted to install a ‚Äúsmart‚Äù video surveillance system on Raspberry. <br><br>  I want to separately note that for this I used several articles on Habr√©.  Thanks to the authors for their posts.  They really helped. <br><br>  As a result, I installed a Logitech USB camera on a purchased Raspberry Pi3, mounted Yandex.Disk and, at intervals of 30 seconds, took pictures, which I then copied to a folder on Yandex.Disk. <br>  Having played with the further archiving of files, mounting video from individual snapshots, I abandoned a new ‚Äútoy‚Äù for several months. <br><a name="habracut"></a><br><h2>  Continuation of a story </h2><br>  While Raspberry was taken out of production, I wondered how to get rid of a large number of images that would be accumulated on Yandex.Disk when the solution was working.  I wanted to optimize the implemented solution ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Idea </h3><br>  A little googling worked out such an improvement: copy only those images on Yandex.Disk, in which the presence of a person will be revealed or the image in the image will be changed, for example, first the door is closed on the image and then opened.  At the same time, send a notification when such events are detected using Telegram.  Telegram was chosen instead of mail, because  provides delivery of messages in real-time mode, plus, it is fashionable. <br>  I decided to develop it in Python and bash. <br><br><h3>  Implementation </h3><br>  To detect the presence of a person, the OpenCV library was chosen, which among other things, is able to determine the presence of an object in a picture, for example, a person's face.  Also, this library offers the implementation of a large number of Machine Learning algorithms. <br><br>  Sample Python code below.  I used one of the ready-made xml to determine the face (haarcascade_frontalface_default.xml). <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys imagePath = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] cascPath = sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] faceCascade = cv2.CascadeClassifier(cascPath) image = cv2.imread(imagePath) gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY) faces = faceCascade.detectMultiScale( gray, scaleFactor=<span class="hljs-number"><span class="hljs-number">1.3</span></span>, minNeighbors=<span class="hljs-number"><span class="hljs-number">5</span></span>, minSize=(<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>), flags = cv2.cv.CV_HAAR_SCALE_IMAGE ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(len(faces)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>): print(<span class="hljs-string"><span class="hljs-string">"Found {0} faces!"</span></span>.format(len(faces))) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">"Not found"</span></span>)</code> </pre> <br>  Identifying changes in the snapshot turned out to be not a completely trivial task, besides on Raspberry, I want to note that I have the latest version, Pi3, it takes time to identify the difference (changes) for the two snapshots.  Rummaged on the Internet, found several different methods. <br><br>  <i>At once I will make a reservation that I used ready algorithms in Python, I modified them only a little, if necessary.</i>  <i>Therefore, the lead codes did not.</i> <br><br>  1. I started with the subtract function from the OpenCV library. <br><br><pre> <code class="python hljs">diff=cv2.subtract(img2,img1)</code> </pre> <br>  2. I tried to determine the Euclidean and Manhattan distance using scipy. <br>  3. Played with the PIL library. <br><br>  Having tried these options, I stopped at determining the difference in file size between two images as a percentage.  Implemented this ‚Äúapproach‚Äù in a shell script.  This method was the most productive of the tested, which is not surprising.  Of course, there is no need to talk about high precision yet, but since my cron scheduler is set to take periodic surveys, which is performed every 30 seconds, I found myself to spend an extra 7-8 seconds to detect the difference, considered it too wasteful.  My face definition already ‚Äúeats up‚Äù for about 5 seconds (taking into account the low resolution of the shooting). <br><br>  A small piece of shell script below. <br><br><pre> <code class="bash hljs">f1=`<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> -c%s <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$prev_file</span></span></span><span class="hljs-string">"</span></span>` f2=`<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> -c%s <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$new_file</span></span></span><span class="hljs-string">"</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$f1</span></span> -le <span class="hljs-variable"><span class="hljs-variable">$f2</span></span> ]];<span class="hljs-keyword"><span class="hljs-keyword">then</span></span> top=<span class="hljs-variable"><span class="hljs-variable">$f1</span></span> base=<span class="hljs-variable"><span class="hljs-variable">$f2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> top=<span class="hljs-variable"><span class="hljs-variable">$f2</span></span> base=<span class="hljs-variable"><span class="hljs-variable">$f1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> percentage=$(( (100-(100*top / base)) )) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Difference is </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$percentage</span></span></span><span class="hljs-string">%"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-variable"><span class="hljs-variable">$percentage</span></span> &gt;= <span class="hljs-variable"><span class="hljs-variable">$hurdle</span></span>));<span class="hljs-keyword"><span class="hljs-keyword">then</span></span> changed=0 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Big change"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Small change"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><h4>  Telegram integration </h4><br>  Integration with Telegram is already well described.  I completed the necessary steps, registered a bot, and received a token. <br><br>  Then I wrote a small Python script that sends me a message from the telegram bot created.  A message is one of the parameters of the script that I specify when calling it. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telepot bot = telepot.Bot(<span class="hljs-string"><span class="hljs-string">'###############################'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#bot.getMe() #from pprint import pprint #response = bot.getUpdates() #pprint(response) #bot.sendMessage(########, 'Alarm from Telegram bot!') bot.sendMessage(########, sys.argv[1])</span></span></code> </pre> <br><h4>  Algorithm of the decision </h4><br>  The solution algorithm is implemented on a shell script that sequentially performs a survey, then analyzes whether there are changes in the received images, detects the face in the picture and sends a message from the created Telegram bot with a specific message if a change is detected or a face is detected.  If a person or change is identified, the file is copied to Yandex.Disk. <br><br>  Below is only a part of the script that reflects the calls of python scripts. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash #... face=$(python face_detect.py "$new_file" haarcascade_frontalface_default.xml 2&gt;&amp;1) echo "$face" if [[ $face != "Not found" ]];then ffound=0 echo "Faces found" else echo "Faces does not found" fi echo "----------" echo "Changes: $changed" echo "Faces found: $ffound" echo "----------" #=====================Processing========================================= now=$(date +"%Y-%m-%d_%H%M") # 1. Copy if [ $changed == 0 ] || [ $ffound == 0 ];then cp "$new_file" "/home/pi/webcam/$now---$new_file" \ &amp;&amp; echo "File copied." else echo "All Ok." fi # 2. Rename cd /home/pi \ &amp;&amp; mv "$new_file" previous.jpg \ &amp;&amp; echo "File renamed." # 3. Send telegram nessage if [ $changed == 0 ] &amp;&amp; [ $ffound == 0 ];then python send_telegram.py 'Alarm: Changes &amp; Faces detected!' \ &amp;&amp; echo "Alarm: Changes &amp; Faces detected!" elif [ $changed == 1 ] &amp;&amp; [ $ffound == 0 ];then python send_telegram.py 'Alarm: Faces detected!' \ &amp;&amp; echo "Alarm: Faces detected!" elif [ $changed == 0 ] &amp;&amp; [ $ffound == 1 ];then python send_telegram.py 'Alarm: Changes detected!' \ &amp;&amp; echo "Alarm: Changes detected!" else echo "Nothing to send." fi #... exit 0</span></span></code> </pre><br><h3>  results </h3><br>  Below I present some results of the solution. <br><br>  1. The results of the identification of persons in the photo.  I did not apply my photos. <br><br><img src="https://habrastorage.org/files/6a6/f83/1a0/6a6f831a0a2644a0b2ac26a6f0a9a4f6.jpg" alt="image"><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e9a/305/610/e9a3056105e84e64b3fa1b98a960e539.jpg" alt="image" width="600"></div><br>  2. Messages from Telegram bot. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/12a/54f/c20/12a54fc207a24d6faa25ee394890304c.jpg" alt="image" width="600"></div><br>  3. Photos on Yandex.Disk <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d0a/19a/de5/d0a19ade5e7340528b69d98be59b7270.jpg" alt="image" width="600"></div><br><h3>  Conclusions and Next Steps </h3><br>  Testing a new solution revealed a number of problems: <br><br>  Face detection and change control are things that require fine tuning.  I still have to tinker with this, so that, for example, my bot does not spam me with messages about the discovery of faces that a normal person would never think of as a person. <br><br>  In general, it remains quite a bit to run the idea in production. <br><br>  1. install an infrared camera; <br>  2. choose reliable methods of change control; <br>  3. and of course, adjust the settings for detecting faces in the pictures. <br><br>  Further research / testing solutions will be continued ... </div><p>Source: <a href="https://habr.com/ru/post/316760/">https://habr.com/ru/post/316760/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316750/index.html">Security Week 48: Tech Support Locker, Mirai Mutations, Vulnerability in Firefox and Tor Browser</a></li>
<li><a href="../316752/index.html">The story of a single plugin</a></li>
<li><a href="../316754/index.html">Death transit traffic?</a></li>
<li><a href="../316756/index.html">Creating and testing a firewall in Linux, Part 2.2. Firewall tables. Access to TCP / IP structures</a></li>
<li><a href="../316758/index.html">Linux kernel documentation goes to Python Sphinx</a></li>
<li><a href="../316762/index.html">MemC3 - compact Memcache with increased parallelism - due to more stupid caching and smarter hashing</a></li>
<li><a href="../316766/index.html">How Ionic 2 helps me to understand angular 2</a></li>
<li><a href="../316768/index.html">Ludum Dare translation</a></li>
<li><a href="../316770/index.html">Connection of peripheral modules to MIPSfpga, for example, ultrasonic distance sensors</a></li>
<li><a href="../316772/index.html">November digest of product design: Profstandard, algorithmic design, Adobe XD and technical proficiency</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>