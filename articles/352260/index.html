<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we did backups in the ISPsystem. Part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story of how ISPsystem developed a backup solution. Says the head of development, Alexander Bryukhanov. 



 All users are divided into three grou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we did backups in the ISPsystem. Part one</h1><div class="post__text post__text-html js-mediator-article">  The story of how ISPsystem developed a backup solution.  Says the head of development, Alexander Bryukhanov. <br><br><img src="https://habrastorage.org/webt/2h/xz/qk/2hxzqkv1ekvecx8o-zpzrxgf8d8.png" alt="As we in the ISPsystem backup did"><br><br>  <i>All users are divided into three groups:</i> <i><br></i>  <i>those who don't back up,</i> <i><br></i>  <i>those who already make them</i> <i><br></i>  <i>and those who check made.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Someone will just amuse my story, and someone in him will recognize himself.  This is a story about how it was in the ISPsystem 15 years ago, how and why it changed, what it came to.  In the first part I will tell you how we started developing a solution for backing up virtual servers. <br><br><a name="habracut"></a>  So, the beginning of the 2000-x yard.  OpenVZ and KVM are not yet created.  FreeBSD Jail comes out and on its base we are the first to develop a solution for providing virtual server services. <br><br>  If you have data, you have a problem: how not to lose this data? <br><br>  At first, they did the usual archiving of virtual server files, since UnionFS allows it. <br><br>  <i>True, there is a slippery moment: when you delete a file from a template, a so-called WHITEOUT is created, which tar does not see.</i>  <i>Consequently, when recovering from such a backup, deleted files, if no others were created in their place, rise from the <s>ashes of the</s> template.</i> <br><br>  The service, as they say, flooded, and we made incremental archives.  On FreeBSD, tar did it out of the box. <br><br>  The service is still a pearl.  The account of our clients' servers went not to pieces, but to the racks (for guys who started with the Internet in 56K and rooms in 20 squares - this was very good).  And over time, problems began to arise. <br><br><h2>  Problem one: CPU </h2><br>  Somewhere in this moment we began to look at ready-made solutions.  Then, in addition to bacula, a very young product at that time, I did not find anything suitable.  We tried to deploy it in one of the data centers, but it did not meet our expectations.  It turned out to be quite difficult to set up, getting the files from it was not as convenient as from the usual .tgz archive, and the performance was not impressive. <br><br>  Lowering the priority to the backup process also didn‚Äôt lead to anything good: backups either didn‚Äôt have time to be made within a day or stopped creating at all. <br><br>  The solution lay on the surface - it is necessary to transfer the backup to a separate machine!  Fortunately, this is done on the knee through the shell script.  We did, and instead of the usual file server, we had a full backup server.  The problem with the CPU has been solved!  But then another one appeared. <br><br><h2>  Problem Two: Disk </h2><br>  Especially with a weekly full backup.  The answer was quickly.  We also had a previous copy, in which there are most of the files!  Therefore, the next step was to get the contents of the files for the backup not from the server, but from the previous copy.  This is how the first ispbackup implementation appeared.  And it raised the speed at times! <br><br>  Along the way, this allowed to solve the WHITEOUT problem: <i>readdir ()</i> "does not see" deleted files, but <i>fts_read ()</i> sees them! <br><br>  The stream used for gz compression generally does not imply reading from the middle, and repacking data is quite a resource-intensive exercise. <br><br>  For this, backup copies were cut into separate parts (the part contained a certain set of files entirely and had a limit on the offset of the beginning of the file relative to the beginning of the archive).  In order not to repack files when they are reused, several parts of the previous one could be completely used in the new archive.  The reused parts could contain outdated data; to get rid of them, the ‚Äúcompression‚Äù function of the backup was implemented. <br><br>  We also got a funny unexpected bonus.  ‚ÄúHot‚Äù files began to gradually be collected in some parts, and ‚Äúcold‚Äù in others, which somewhat optimized the process.  It's nice when something good happens by itself :) <br><br><h2>  Problem three: And if something went wrong? </h2><br>  If at some point something went wrong, a broken archive could be created that could go unnoticed for months.  In fact, until the moment when you do not need it ... Advice based on your own bitter experience: If you care about your data, check your backups. <br><br><h2>  Epilogue </h2><br>  In general, the tool has acquired crutches.  But he worked !!!  For several years we lived happily, and then hard drives dramatically cheaper and the size of virtual machines in a short time increased several times (if not orders of magnitude). <br><br>  For a while, we resisted.  Introduced the setting for the virtual server: whether to back it up daily, weekly or not to back up at all, but it was already agony.  Backups have been replaced by reliable RAID or network storages with their subsequent sensitive monitoring.  Appeared KVM and OpenVZ. <br><br>  Instead of backing up all the files, we began to write a backup of user data for ISPmanager, but this is another story. <br><br>  Who cares, the source code of ispbackup is laid out on <a href="https://github.com/ispsystem/ispbackup">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/352260/">https://habr.com/ru/post/352260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352250/index.html">Alan Kay and Marvin Minsky: Computer Science already has a ‚Äúgrammar‚Äù. Need "literature"</a></li>
<li><a href="../352252/index.html">Application of the OWASP Mobile TOP 10 methodology for testing Android applications</a></li>
<li><a href="../352254/index.html">Linux fornsica in the face of tracking USB device connection history</a></li>
<li><a href="../352256/index.html">Marvin Minsky "The Emotion Machine": Chapter 2 "How our brain can control itself, despite its complexity"</a></li>
<li><a href="../352258/index.html">Implement targeted marketing on the site</a></li>
<li><a href="../352264/index.html">General cleaning in the company</a></li>
<li><a href="../352266/index.html">Flask Mega-Tutorial, Part XVII: Deploying Under Linux</a></li>
<li><a href="../352268/index.html">Conference DEFCON 21. ‚ÄúThe secret life of SIM cards‚Äù. Eric Butler, Karl Kosher</a></li>
<li><a href="../352270/index.html">How to track file downloads from your site on WordPress</a></li>
<li><a href="../352272/index.html">Thymeleaf Tutorial: Chapter 13. Template text modes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>