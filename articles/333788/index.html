<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MMO from scratch. Using Netty and the Unreal Engine. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In a few articles I would like to share the experience of creating a similarity of MMO games using the Unreal Engine and Netty. Perhaps the arc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MMO from scratch. Using Netty and the Unreal Engine. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello!  In a few articles I would like to share the experience of creating a similarity of MMO games using the Unreal Engine and Netty.  Perhaps the architecture and my experience will come in handy for someone and help you start building your game server as opposed to an unreal dedicated server that is slightly voracious or replace frameworks for developing multiplayer games such as Photon. <br><br>  In the end, we will have a client who logs in or registers in the game, can create game rooms, use chat and start games, the connection will be encrypted, clients will synchronize through the server, there will be one weapon in the game - a laser, a shot will be checked for verification server.  I did not want to make beautiful graphics, there will be only the necessary minimum, further functionality is added by analogy.  You can easily expand the logic on the server, for example, add random games and a balancer.  For me it was important to create an MMO base and figure out what is needed to create a full-fledged mobile MMO game. <br><br>  <a href="https://habrahabr.ru/post/333788/">Part 1. The overall picture, the assembly of libraries, preparing the client and server for messaging</a> <br>  <a href="https://habrahabr.ru/post/334786/">Part 2. Building game functionality + Diamond Square algorithm</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/cc1/58c/fc4/cc158cfc465448579a104982551b6cd2.jpg"><br><a name="habracut"></a><br><h3>  General architecture, how it works </h3><br>  In the beginning I will outline, and then we will write everything step by step.  The client-server communication is built on sockets, the Protobuf messaging format, each message after entering the game is encrypted using the AES algorithm using the OpenSSL library on the client and javax.crypto * on the server, the key exchange takes place using the Diffie-Hellman protocol.  Netty is used as an asynchronous server, we will store the data in MySQL and use Hibernate to select it.  I aimed to support the game on Android, so we will pay a little attention to porting to this platform.  I called the project Spiky - prickly, and for good reason: <br><br>  <a href="https://www.reddit.com/r/unrealengine/comments/3nqb91/as_a_primarily_c_programmer_unreal_engine_4_isnt/">As a first C ++ programmer, Unreal Engine 4 is not "fun" to develop with.</a> <br><br>  If I missed something or something does not converge, feel free to refer to the source code: <br><br>  <a href="https://github.com/VadimDev/Spiky-Project">Spiky source code</a> <br><br>  Ultimately, this is what we get: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/pMYijWJV56w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Let's start with the communication between the client and the server.  Both have MessageDecoder and DecryptHandler, these are entry points for messages, after reading a packet, messages are decrypted, their type is determined, and the type is sent to some handler.  The exit points are MessageEncoder and EncryptHandler, client and server respectively.  When we send a message to Netty, it will pass through the EncryptHandler.  Here you decide whether to encrypt, and how to wrap. <br><br>  Each message is wrapped in the protobraf Wrapper, the recipient checks that inside the Wrapper, to select a handler, it can be a CryptogramWrapper - encrypted bytes or open messages.  The Wrapper message will look something like this (part of it): <br><br><pre><code class="hljs pgsql">message CryptogramWrapper { bytes registration = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message <span class="hljs-keyword"><span class="hljs-keyword">Wrapper</span></span> { Utility utility = <span class="hljs-number"><span class="hljs-number">1</span></span>; CryptogramWrapper cryptogramWrapper = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  All messaging is based on the principle of Decoder-Encoder, if we need to add a new team to the game, we need to update the conditions.  For example, the client wants to register, the message enters the MessageEncoder, where it is encrypted, turned around and sent to the server.  On the server, the message arrives on DecryptHandler, is decrypted if necessary, the type is read by the presence of fields of the message and sent for processing <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.hasCryptogramWrapper()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wrapper.getCryptogramWrapper().hasField(registration_cw)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptogram = wrapper.getCryptogramWrapper().getRegistration().toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] original = cryptography.Decrypt(cryptogram, cryptography.getSecretKey()); RegModels.Registration registration = RegModels.Registration.parseFrom(original); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Registration().saveUser(ctx, registration); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrapper.getCryptogramWrapper().hasField(login_cw)) {} }</code> </pre><br>  In order to find a field in a message using .hasField, we will need a set of descriptors (registration_cw, login_cw) we will store them separately in the Descriptors class. <br><br>  So, if we need a new functionality, then we <br><br>  1. Create a new type of Protobuf message, attach it to the Wrapper / CryptogramWrapper <br>  2. Declare fields that need access in the descriptors of the client and server <br>  3. Create a logic class in which, after determining the type, send the message <br>  4. Add a condition defining a new type in the Decode-Encoder client and server <br>  5. We process <br><br>  This is a key point that will have to be repeated many times. <br><br>  In this project, I used the TCP protocol, of course it is better to write my add-on over UDP, which I tried to do at the beginning, but all I had was like TCP. The only drawback of which, in my situation, is the inability to disable packet acknowledgment, TCP is waiting for confirmation before continuing to send, it creates delays, and it will be difficult to get ping less than 100, if the packet is lost during transmission over the network, the game stops and waits until the packet is delivered again.  Unfortunately, it is impossible to change such TCP behavior, and it is not necessary, since the meaning of TCP lies in it.  The choice of the type of sockets depends entirely on the genre of the game, in games of the genre of action, it‚Äôs important not what happened a second ago, but the most relevant state of the game world is important.  We need to get the data from client to server as quickly as possible, and we don‚Äôt want to wait for the data to be sent again.  This is why you should not use TCP for multiplayer games. <br><br>  But if we want to make a reliable udp, difficulties await us, we need to implement ordering, the ability to turn off the delivery confirmation, control channel congestion, send large messages, more than 1,400 bytes.  Action games should use UDP for those who want to read more about this I advise you to start with these articles and books: <br><br>  <a href="https://habrahabr.ru/post/209144/">Network programming for game developers.</a>  <a href="https://habrahabr.ru/post/209144/">Part 1: UDP vs.</a>  <a href="https://habrahabr.ru/post/209144/">Tcp</a> <br>  <a href="https://habrahabr.ru/post/250227/">Implementing a Reliable Udp Protocol for .Net</a> <br>  Joshua Glazer - Multiplayer Games.  Chapter 7 delay, fluctuation and reliability. <br><br>  I needed a reliable, serial connection to transfer commands, encrypted messages and files (captcha).  TCP gives me such opportunities out of the box.  To transfer game data that is frequently updated and not very important, such as moving players, UDP is the best option, I added the ability to send UDP messages for completeness and to begin where to start, but in this project all communication will take place via TCP.  Perhaps you should use TCP and UDP together?  However, then the number of lost UDP packets increases, as TCP takes precedence.  UDP remained in the area of ‚Äã‚Äãfurther improvements.  In this article, I follow the principle of "Done in better when pefect" <br><br><img src="https://habrastorage.org/web/19f/cc1/334/19fcc133464a4e038498bb8e2e66f27b.jpg"><br><br>  At the core of the server is Netty, it takes on work with sockets, implementing a convenient architecture.  You can connect multiple handlers for incoming data.  In the first handler, we deserialize the incoming message using ProtobufDecoder, and then process the game data directly.  You can flexibly manage the settings of the library itself, allocate the required number of threads or memory to it.  Using Netty, you can quickly and easily write any client-server application that will be easily expanded and scaled.  If there is not enough one thread to process clients, you just need to pass the required number of threads to the EventLoopGroup constructor.  If at some stage of development of the project additional data processing is required, no need to rewrite the code, it is enough to add a new handler to ChannelPipeline, which greatly simplifies application support. <br><br>  The general architecture when using Netty with us looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketChannel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChannel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SocketChannel ch)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ChannelPipeline pipeline = ch.pipeline(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">//pipeline.addLast(new LoggingHandler(LogLevel.INFO)); /*   */ // Decoders protobuf pipeline.addLast(new ProtobufVarint32FrameDecoder()); pipeline.addLast(new ProtobufDecoder(MessageModels.Wrapper.getDefaultInstance())); /*   */ // Encoder protobuf pipeline.addLast(new ProtobufVarint32LengthFieldPrepender()); pipeline.addLast(new ProtobufEncoder()); /*          30  */ pipeline.addLast(new IdleStateHandler(30, 0, 0)); /*    */ pipeline.addLast(new EncryptHandler()); /*    */ pipeline.addLast(new DecryptHandler()); } }</span></span></code> </pre><br>  The advantage of this approach is that the server and the handlers can be distributed to different machines by getting a cluster for calculating game data, we get a fairly flexible structure.  While the load is small, you can keep everything on one server.  With increasing load, logic can be separated into a separate machine. <br><br>  To check hits, I created a special Unreal Engine client, whose task is to take shot parameters, to place an object in the world, based on where it was at the moment of the shot, to simulate a shot by returning to the main server information about the hit, the name of the overlap object, a bone if present, or that missed. <br><br><h3>  Let's start from scratch </h3><br>  I tried to write in detail, but I carried a lot under the spoiler. <br><br>  Create an empty project with a code called it Spiky.  First of all we will delete the GameMode created by default (this is the class that defines the rules of the current game, can be overridden for each specific level, which we will use later, there is only one GameMode instance) - we will delete the Spiky_ClientGameModeBase automatically created.  Next, open Spiky_Client.Build.cs, this is part of the Unreal Build System in which we connect various modules, third-party libraries and also configure various assembly variables, by default, starting with version 4.16, the SharedPCH mode (Sharing precompiled headers) is used, as well as Include- What-You-Use (IWYU), allowing you not to include heavy headers Engine.h.  In previous versions of the Unreal Engine, most of the functionality of the engine was included through files with a module header, such as Engine.h and UnrealEd.h, and the compilation time depended on how quickly these files could be compiled via Precompiled Header (PCH).  As the engine grew, it became a bottleneck. <br><br>  <a href="https://docs.unrealengine.com/latest/INT/Programming/UnrealBuildSystem/IWYUReferenceGuide/index.html">IWYU Reference Guide</a> <br><br>  In Spiky_Client.Build.cs we see <br><br> <code>PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs; <br></code> <br>  It works well on fast machines with ssd (to work with unreal - you must have a different headache, I also advise you to disable IntelliSense and use VisualAssist instead) but not ssd machines, for convenience and speed I would advise to switch to another mode that writes less to disk, which we will do by turning on PCHUsageMode.Default, thereby turning off the generation of Precompiled Header. <br><br>  All possible PCHUsage values: <br><br> <code>PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs; <br> PCHUsage = PCHUsageMode.UseSharedPCHs; <br> PCHUsage = PCHUsageMode.NoSharedPCHs; <br> PCHUsage = PCHUsageMode.Default; <br></code> <br>  Now our file contains the following: <br><br><div class="spoiler">  <b class="spoiler_title">Spiky_Client.Build.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnrealBuildTool; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Spiky_Client</span></span> : <span class="hljs-title"><span class="hljs-title">ModuleRules</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Spiky_Client</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ReadOnlyTargetRules Target</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Target</span></span></span><span class="hljs-function">)</span></span> { PCHUsage = PCHUsageMode.Default; PublicDependencyModuleNames.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Core"</span></span>, <span class="hljs-string"><span class="hljs-string">"CoreUObject"</span></span>, <span class="hljs-string"><span class="hljs-string">"Engine"</span></span>, <span class="hljs-string"><span class="hljs-string">"InputCore"</span></span> }); PrivateDependencyModuleNames.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { }); } }</code> </pre><br></div></div><br>  What is the difference between PublicDependencyModuleNames and PrivateDependencyModuleNames?  In Unreal projects, it is advisable to use Source / Public and Source / Private for header interfaces and source code, then PublicDependencyModuleNames will be available in Public and Private folders, but PrivateDependencyModuleNames will only be available in the Private folder.  You can change various other build parameters by overriding BuildConfiguration.xml, all parameters can be found here: <br><br>  <a href="https://docs.unrealengine.com/latest/INT/Programming/UnrealBuildSystem/Configuration/">Configuring Unreal Build System</a> <br><br><div class="spoiler">  <b class="spoiler_title">Minor editor settings for convenience</b> <div class="spoiler_text">  We include small icons, frame rate display and memory consumption: <br>  General-&gt; Miscellaneous-&gt; Performance-&gt; Show Frame Rate and Memory <br>  General-&gt; User Interface-&gt; Use Small Tool Bar Icons <br></div></div><br>  Moving on, we will add outside the game GameMode for login, registration and main menu screens. <br><br><div class="spoiler">  <b class="spoiler_title">Adding SpikyGameMode</b> <div class="spoiler_text">  File-&gt; New C ++ Class-&gt; Game Mode Base is called SpikyGameMode, select public and create the GameModes folder.  The final path should look like this: <br><br>  Spiky / Spiky_Client / Source / Spiky_Client / Public / GameModes <br></div></div><br>  The task of SpikyGameMode will be to create a valid link to the world.  The world is a top-level object representing the map in which the actors and components will exist and be visualized.  Later we will create a DiffrentMix class inherited from the UObject in which we will manage the interface, to create widgets we need a link to the current world, which cannot be obtained from the UObject classes, therefore we will create a GameMode through which we initialize DiffrentMix and pass it a link to the world. <br><br>  A single word about the interface, this refers to the client's architecture.  We have access to all widgets, via DifferentMix singleton, all widgets are placed inside the WidgetsContainer, which we need to place widgets in layers whose depth you can set, the WidgetsContainer root is the Canvas unfortunately I have not found a way to change the order of the widgets using Viewport.  This is convenient when you need for example, that the chat is guaranteed to be on top of everything else.  To do this, we set its widget the maximum depth (priority) in our program mainMenuChatSlot-&gt; SetZOrder (10), however, the priority can be any. <br><br>  Add the DifferentMix class, the parent of the UObject base class for all objects, put it in the new Utils folder. Here we will store links to widgets, rare functions for which to create your classes would be superfluous, this is the singleton through which we will manage the user interface. <br><br>  Add the SpikyGameInstance derived from the UGameInstance class, a generic UObject that can store any data that is transferred between levels.  It is created when creating a game, and exists until the game is closed.  We will use it to store unique game data, such as player login, game session id, encryption key, also here we start and stop listening sockets flows, and through it we will get access to the DifferentMix functions. <br><br><div class="spoiler">  <b class="spoiler_title">Location of new classes</b> <div class="spoiler_text">  Spiky_Client / Source / Spiky_Client / Private / GameModes / SpikyGameMode.h <br>  Spiky_Client / Source / Spiky_Client / Private / Utils / DifferentMix.h <br>  Spiky_Client / Source / Spiky_Client / Private / SpikyGameInstance.h <br><br>  Spiky_Client / Source / Spiky_Client / Public / GameModes / SpikyGameMode.cpp <br>  Spiky_Client / Source / Spiky_Client / Public / Utils / DifferentMix.cpp <br>  Spiky_Client / Source / Spiky_Client / Public / SpikyGameInstance.cpp <br></div></div><br>  Zemette, maybe from the editor, the game after adding new classes will refuse to assemble, this is due to the fact that we switched to a mode that requires the presence of #include "Spiky_Client.h" in all the source files, add it manually and collect it through the studio, I don‚Äôt add The new code through the editor, I copy, edit manually and click on the Spiky_Client.uproject pkm Generate Visual Studio project files. <br><br>  Let's go back to the editor, create the Maps folder and save the standard map in it, let's call it MainMap later we will place the rotating fur on it (or the choice of the game character as in many MMOs). <br><br>  Open Project Settings ‚Üí Maps &amp; Modes and set up the created GameMode / GameInstance / Map as in the picture: <br><br><img src="https://habrastorage.org/web/b73/82b/5ff/b7382b5ff55a482c8983d6def56e0a20.PNG"><br><br><h3>  Network part </h3><br>  With all the preparation, let's start to write the project from the network part, we implement the connection to the server, the restoration of the connection if it is lost, the listeners of the incoming messages and the stream checking the server availability.  The main object on the client through which we work with the network, we serve sockets, the SocketObject will be derived from UObject, we will add it to the Net folder.  Since we use the network, we need to add the modules ‚ÄúNetworking‚Äù, ‚ÄúSockets‚Äù to Spiky_Client.Build.cs <br><br><pre> <code class="cs hljs">PublicDependencyModuleNames.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Core"</span></span>, <span class="hljs-string"><span class="hljs-string">"CoreUObject"</span></span>, <span class="hljs-string"><span class="hljs-string">"Engine"</span></span>, <span class="hljs-string"><span class="hljs-string">"InputCore"</span></span>, <span class="hljs-string"><span class="hljs-string">"Networking"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sockets"</span></span> });</code> </pre><br>  Add a destructor to the SocketObject header, a number of self-describing static functions and the necessary SocketSubsystem and Networking inclusions. <br><br><div class="spoiler">  <b class="spoiler_title">SocketObject.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "CoreMinimal.h" #include "UObject/NoExportTypes.h" #include "Networking.h" #include "SocketSubsystem.h" #include "SocketObject.generated.h" /** *   ,  ,   -  . */ UCLASS() class SPIKY_CLIENT_API USocketObject : public UObject { GENERATED_BODY() ~USocketObject(); public: // tcp static FSocket* tcp_socket; // tcp   static TSharedPtr&lt;FInternetAddr&gt; tcp_address; //   static bool bIsConnection; //     static void Reconnect(); //     static bool Alive(); // udp static FSocket* udp_socket; // udp   static TSharedPtr&lt;FInternetAddr&gt; udp_address; //       UDP  ,  unreal  FUdpSocketReceiver,       - static FUdpSocketReceiver* UDPReceiver; static void Recv(const FArrayReaderPtr&amp; ArrayReaderPtr, const FIPv4Endpoint&amp; EndPt); static void RunUdpSocketReceiver(); static int32 tcp_local_port; static int32 udp_local_port; //     ,  GameInstance static void InitSocket(FString serverAddress, int32 tcp_local_p, int32 tcp_server_port, int32 udp_local_p, int32 udp_server_port); };</span></span></code> </pre><br></div></div><br>  Now in the source code, let's start by creating sockets in InitSocket, select the buffer, assign local ports, I know two ways to create sockets, one of them by the builder: <br><br><pre> <code class="cpp hljs">tcp_socket = FTcpSocketBuilder(<span class="hljs-string"><span class="hljs-string">"TCP_SOCKET"</span></span>) .AsNonBlocking() .AsReusable() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build();</code> </pre><br>  Or through the ISocketSubsystem: <br><br><pre> <code class="cpp hljs">tcp_socket = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateSocket(NAME_Stream, TEXT(<span class="hljs-string"><span class="hljs-string">"TCP_SOCKET"</span></span>), <span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre><br>  These are the basic abstractions of various socket-specific platform-specific interfaces.  Since we set the address somewhere in the configuration file or the code with the string, we should bring it into the necessary form, for this we use FIPv4Address :: Parse, then we connect and call bIsConnection = Alive ();  The method sends empty messages to the server if it means there is a connection.  Finally, we will create a UDP socket using FUdpSocketBuilder, the final view of InitSocket should be like this: <br><br><div class="spoiler">  <b class="spoiler_title">USocketObject :: InitSocket</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> USocketObject::InitSocket(FString serverAddress, int32 tcp_local_p, int32 tcp_server_port, int32 udp_local_p, int32 udp_server_port) { int32 BufferSize = <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; tcp_local_port = tcp_local_p; udp_local_port = udp_local_p; <span class="hljs-comment"><span class="hljs-comment">// tcp /*  FTcpSocketBuilder tcp_socket = FTcpSocketBuilder("TCP_SOCKET") .AsNonBlocking() // Socket connect always success. Non blocking you say socket connect dont wait for response (Don?t block) so it will return true. .AsReusable() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); */ tcp_socket = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateSocket(NAME_Stream, TEXT("TCP_SOCKET"), false); tcp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); FIPv4Address serverIP; FIPv4Address::Parse(serverAddress, serverIP); tcp_address-&gt;SetIp(serverIP.Value); tcp_address-&gt;SetPort(tcp_server_port); tcp_socket-&gt;Connect(*tcp_address); bIsConnection = Alive(); // udp udp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); FIPv4Address::Parse(serverAddress, serverIP); udp_address-&gt;SetIp(serverIP.Value); udp_address-&gt;SetPort(udp_server_port); udp_socket = FUdpSocketBuilder("UDP_SOCKET") .AsReusable() .BoundToPort(udp_local_port) .WithBroadcast() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); }</span></span></code> </pre><br></div></div><br>  Close the sockets and delete them in the destructor. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tcp_socket != <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> || udp_socket != <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { tcp_socket-&gt;Close(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> tcp_socket; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> udp_socket; }</code> </pre><br><br>  The current state of the SocketObject is: <br><br><div class="spoiler">  <b class="spoiler_title">SocketObject.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SocketObject.h" FSocket* USocketObject::tcp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::tcp_address = nullptr; bool USocketObject::bIsConnection = false; FSocket* USocketObject::udp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::udp_address = nullptr; FUdpSocketReceiver* USocketObject::UDPReceiver = nullptr; int32 USocketObject::tcp_local_port = 0; int32 USocketObject::udp_local_port = 0; USocketObject::~USocketObject() { if (tcp_socket != nullptr || udp_socket != nullptr) { tcp_socket-&gt;Close(); delete tcp_socket; delete udp_socket; } } void USocketObject::InitSocket(FString serverAddress, int32 tcp_local_p, int32 tcp_server_port, int32 udp_local_p, int32 udp_server_port) { int32 BufferSize = 2 * 1024 * 1024; tcp_local_port = tcp_local_p; udp_local_port = udp_local_p; /* tcp_socket = FTcpSocketBuilder("TCP_SOCKET") .AsNonBlocking() // Socket connect always success. Non blocking you say socket connect dont wait for response (Don?t block) so it will return true. .AsReusable() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); */ // tcp tcp_socket = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateSocket(NAME_Stream, TEXT("TCP_SOCKET"), false); // create a proper FInternetAddr representation tcp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); // parse server address FIPv4Address serverIP; FIPv4Address::Parse(serverAddress, serverIP); // and set tcp_address-&gt;SetIp(serverIP.Value); tcp_address-&gt;SetPort(tcp_server_port); tcp_socket-&gt;Connect(*tcp_address); // set the initial connection state bIsConnection = Alive(); // udp udp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); FIPv4Address::Parse(serverAddress, serverIP); udp_address-&gt;SetIp(serverIP.Value); udp_address-&gt;SetPort(udp_server_port); udp_socket = FUdpSocketBuilder("UDP_SOCKET") .AsReusable() .BoundToPort(udp_local_port) .WithBroadcast() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); } void USocketObject::RunUdpSocketReceiver() { } void USocketObject::Recv(const FArrayReaderPtr&amp; ArrayReaderPtr, const FIPv4Endpoint&amp; EndPt) { } void USocketObject::Reconnect() { } bool USocketObject::Alive() { return false; }</span></span></code> </pre><br></div></div><br>  Let's do the method of sending Alive messages, message format and server.  At the core of the server, I used the Netty asynchronous framework written in java.  The main advantage of which is simple reading and writing to sockets.  Netty supports non-blocking asynchronous I / O, it scales easily, which is important for an online game if your system needs to be able to handle many thousands of connections at the same time.  And what is also important - Netty is easy to use. <br><br>  Create a server, use IntelliJ IDEA, create a Maven project: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.spiky.server<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>Spiky server<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Add the dependencies we need, Netty <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.netty<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>netty-all<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.1.8.Final<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now let's deal with the message serialization format.  We use Protobuf.  The size of the message is extremely small, and judging by the graphs, it exceeds JSON in all. <br><br><div class="spoiler">  <b class="spoiler_title">Size comparison</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/6e8/2f3/961/6e82f396181f4dcaa3ced1686457fb88.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Performance comparison</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/b1f/323/611/b1f3236111c44853931f6b7d52229105.png"><br></div></div><br>  * taken <a href="http://homepages.lasige.di.fc.ul.pt/~vielmo/notes/2014_02_12_smalltalk_protocol_buffers.pdf">from here, good stuff, with examples of protobuff and different metrics</a> <br><br>  In order to determine the structure of the data being serialized, it is necessary to create a .proto file with the source code of this structure, for example: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Player { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> player_name = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> team = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> health = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">PlayerPosition</span></span> playerPosition = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> PlayerPosition {}</code> </pre><br>  After that, this data structure is compiled into classes by a special compiler, protoc, the compilation command looks like this: <br><br> <code>./protoc --cpp_out=. --java_out=. GameModels.proto</code> <br> <br>  Protobuff has good <a href="https://developers.google.com/protocol-buffers/docs/proto3">documentation</a> which will help better understand the meaning of each field. <br>  Protobaf is implemented for Java and C ++ used by our project.  Add another dependency: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.google.protobuf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>protobuf-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>3.0.0-beta-4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now you need to add support for the protobuff in Unreal, this is not so easy, first we get a <a href="https://github.com/google/protobuf/tree/3.0.0-beta-4">branch with github</a> .  Now you need to properly assemble, instructions on how to build through Visual Studio can be found <a href="">here</a> .  To set the link type for the Filter through to Configuration Properties&gt; C / C ++&gt; Code Generation&gt; Runtime Library, from the drop down list select Multi-threaded DLL (/ MD) ‚Äù <a href="https://wiki.unrealengine.com/Linking_Static_Libraries_Using_The_Build_System">see Linking Static Libraries Using the Build System</a> and compiling libprotobuf.lib .  After we add to the project, create the folder ThirdParty / Protobuf in the root in which you want to create Libs and Includes.  Put /protobuf-3.0.0-beta-4/cmake/build/solution/Release/libprotobuf.lib in Libs.  Put / proto-install / include / google in Includes. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since my goal was to support mobile devices, we will need to build a library for Android using Android NDK, the </font></font><a href="https://github.com/google/protobuf/blob/master/BUILD"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">list of files for compilation can be taken here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , at the beginning of the lite, then the rest. </font><font style="vertical-align: inherit;">The process itself looks like this, install the Android NDK, create the jni folder, put two Android.mk and Application.mk files in them, create src into which to copy src from protobuf-3.0.0-beta-4 / src and use ndk-build . </font><font style="vertical-align: inherit;">Application.mk and Android.mk files are ready:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application.mk</font></font></b> <div class="spoiler_text"> <code>APP_OPTIM := release <br> APP_ABI := armeabi-v7a #x86 x86_64 <br> APP_STL := gnustl_static <br> <br> NDK_TOOLCHAIN_VERSION := clang <br> <br> APP_CPPFLAGS += -D GOOGLE_PROTOBUF_NO_RTTI=1 <br> APP_CPPFLAGS += -D __ANDROID__=1 <br> APP_CPPFLAGS += -D HAVE_PTHREAD=1 <br></code> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android.mk</font></font></b> <div class="spoiler_text"> <code>LOCAL_PATH := $(call my-dir) <br> <br> include $(CLEAR_VARS) <br> <br> LOCAL_MODULE := libprotobuf <br> <br> LOCAL_SRC_FILES :=\ <br> src/google/protobuf/arena.cc \ <br> src/google/protobuf/arenastring.cc \ <br> src/google/protobuf/extension_set.cc \ <br> src/google/protobuf/generated_message_util.cc \ <br> src/google/protobuf/io/coded_stream.cc \ <br> src/google/protobuf/io/zero_copy_stream.cc \ <br> src/google/protobuf/io/zero_copy_stream_impl_lite.cc \ <br> src/google/protobuf/message_lite.cc \ <br> src/google/protobuf/repeated_field.cc \ <br> src/google/protobuf/stubs/bytestream.cc \ <br> src/google/protobuf/stubs/common.cc \ <br> src/google/protobuf/stubs/int128.cc \ <br> src/google/protobuf/stubs/once.cc \ <br> src/google/protobuf/stubs/status.cc \ <br> src/google/protobuf/stubs/statusor.cc \ <br> src/google/protobuf/stubs/stringpiece.cc \ <br> src/google/protobuf/stubs/stringprintf.cc \ <br> src/google/protobuf/stubs/structurally_valid.cc \ <br> src/google/protobuf/stubs/strutil.cc \ <br> src/google/protobuf/stubs/time.cc \ <br> src/google/protobuf/wire_format_lite.cc \ <br> src/google/protobuf/any.cc \ <br> src/google/protobuf/any.pb.cc \ <br> src/google/protobuf/api.pb.cc \ <br> src/google/protobuf/compiler/importer.cc \ <br> src/google/protobuf/compiler/parser.cc \ <br> src/google/protobuf/descriptor.cc \ <br> src/google/protobuf/descriptor.pb.cc \ <br> src/google/protobuf/descriptor_database.cc \ <br> src/google/protobuf/duration.pb.cc \ <br> src/google/protobuf/dynamic_message.cc \ <br> src/google/protobuf/empty.pb.cc \ <br> src/google/protobuf/extension_set_heavy.cc \ <br> src/google/protobuf/field_mask.pb.cc \ <br> src/google/protobuf/generated_message_reflection.cc \ <br> src/google/protobuf/io/gzip_stream.cc \ <br> src/google/protobuf/io/printer.cc \ <br> src/google/protobuf/io/strtod.cc \ <br> src/google/protobuf/io/tokenizer.cc \ <br> src/google/protobuf/io/zero_copy_stream_impl.cc \ <br> src/google/protobuf/map_field.cc \ <br> src/google/protobuf/message.cc \ <br> src/google/protobuf/reflection_ops.cc \ <br> src/google/protobuf/service.cc \ <br> src/google/protobuf/source_context.pb.cc \ <br> src/google/protobuf/struct.pb.cc \ <br> src/google/protobuf/stubs/mathlimits.cc \ <br> src/google/protobuf/stubs/substitute.cc \ <br> src/google/protobuf/text_format.cc \ <br> src/google/protobuf/timestamp.pb.cc \ <br> src/google/protobuf/type.pb.cc \ <br> src/google/protobuf/unknown_field_set.cc \ <br> src/google/protobuf/util/field_comparator.cc \ <br> src/google/protobuf/util/field_mask_util.cc \ <br> src/google/protobuf/util/internal/datapiece.cc \ <br> src/google/protobuf/util/internal/default_value_objectwriter.cc \ <br> src/google/protobuf/util/internal/error_listener.cc \ <br> src/google/protobuf/util/internal/field_mask_utility.cc \ <br> src/google/protobuf/util/internal/json_escaping.cc \ <br> src/google/protobuf/util/internal/json_objectwriter.cc \ <br> src/google/protobuf/util/internal/json_stream_parser.cc \ <br> src/google/protobuf/util/internal/object_writer.cc \ <br> src/google/protobuf/util/internal/proto_writer.cc \ <br> src/google/protobuf/util/internal/protostream_objectsource.cc \ <br> src/google/protobuf/util/internal/protostream_objectwriter.cc \ <br> src/google/protobuf/util/internal/type_info.cc \ <br> src/google/protobuf/util/internal/type_info_test_helper.cc \ <br> src/google/protobuf/util/internal/utility.cc \ <br> src/google/protobuf/util/json_util.cc \ <br> src/google/protobuf/util/message_differencer.cc \ <br> src/google/protobuf/util/time_util.cc \ <br> src/google/protobuf/util/type_resolver_util.cc \ <br> src/google/protobuf/wire_format.cc \ <br> src/google/protobuf/wrappers.pb.cc <br> <br> LOCAL_CPPFLAGS := -std=c++11 <br> LOCAL_LDLIBS := -llog <br> <br> ifeq ($(TARGET_ARCH),x86) <br> LOCAL_SRC_FILES := $(LOCAL_SRC_FILES) \ <br> src/google/protobuf/stubs/atomicops_internals_x86_gcc.cc <br> endif <br> <br> ifeq ($(TARGET_ARCH),x86_64) <br> LOCAL_SRC_FILES := $(LOCAL_SRC_FILES) \ <br> src/google/protobuf/stubs/atomicops_internals_x86_gcc.cc <br> endif <br> <br> LOCAL_C_INCLUDES = $(LOCAL_PATH)/src <br> <br> include $(BUILD_SHARED_LIBRARY) <br></code> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If successful, we will get a "bipod" / android / proto / libs / armeabi-v7a - libprotobuf.so. </font><font style="vertical-align: inherit;">Copy it into the project / Spiky / Spiky_Client / Source / Spiky_Client / armv7.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possible difficulties and mistakes</font></font></b> <div class="spoiler_text">   : <br><br> <code>ThirdParty/Protobuf/Includes\google/protobuf/arena.h(635,25) : error: cannot use typeid with -fno-rtti</code> <br> <br>  arena.h      <br><br> <code>#define GOOGLE_PROTOBUF_NO_RTTI</code> <br> <br>       ,       ‚Äî <code>error: "error C3861: 'check': identifier not found</code> ,      check   (AssertionMacros.h),  check   (type_traits.h),   check           ,  check  check_UnrealFix, ,   #undef check.     unreal answers ‚Äî <a href="https://answers.unrealengine.com/questions/241746/error-c3861-identifier-not-found-when-including-pr.html">Error C3861 (identifier not found) when including protocol buffers</a> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> B, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> D&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_base_of</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;yes)</span></span></span><span class="hljs-function">[1]</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;no)</span></span></span><span class="hljs-function">[2]</span></span>; <span class="hljs-comment"><span class="hljs-comment">// BEGIN GOOGLE LOCAL MODIFICATION -- check is a #define on Mac. #undef check // END GOOGLE LOCAL MODIFICATION static yes check(const B*); static no check(const void*); enum { value = sizeof(check(static_cast&lt;const D*&gt;(NULL))) == sizeof(yes), }; };</span></span></code> </pre><br>   type_traits.h  : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> B, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> D&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_base_of</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;yes)</span></span></span><span class="hljs-function">[1]</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;no)</span></span></span><span class="hljs-function">[2]</span></span>; <span class="hljs-comment"><span class="hljs-comment">// BEGIN GOOGLE LOCAL MODIFICATION -- check is a #define on Mac. //#undef check // END GOOGLE LOCAL MODIFICATION static yes check_UnrealFix(const B*); static no check_UnrealFix(const void*); enum { value = sizeof(check_UnrealFix(static_cast&lt;const D*&gt;(NULL))) == sizeof(yes), }; };</span></span></code> </pre><br><br>     ,          OpenSSL    .   Android NDK    ++ 11,         chrono  ,    ,    . <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I advise you to test the functionality of external libraries, before adding to the project, separately, outside of Unreal, it is much faster. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">While we postpone the protobuf connection, let's compile OpenSSL in order not to return to this topic and not to repeat it. </font><font style="vertical-align: inherit;">I am using OpenSSL-1.0.2k. </font><font style="vertical-align: inherit;">To build a library, use this guide ( </font></font><a href="http://developer.covenanteyes.com/building-openssl-for-visual-studio/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Building the 64-bit static libraries with debug symbols</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">A couple of tips if you have any difficulties:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Find in the folder with the studio ml64.exe and copy to the folder with OpenSSL, do not use NASM - this is only for x32 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Use clean sources (no build attempts) </font></font></li><li> <code>openssl fatal error LNK1112: module machine type 'x64' conflicts with target machine type 'X86'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- open Developer Command Prompt for VS2015, go to E: \ Program Files (x86) \ Microsoft Visual Studio 14.0 \ VC and run vcvarsall.bat x64 ( </font></font><a href="https://stackoverflow.com/questions/31595869/how-to-resolve-the-module-machine-type-x86-conflicts-with-target-machine-type"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Name Conflict with Unreal comment out the 172 line: </font></font><code>openssl/ossl_typ.h(172): error C2365: 'UI': redefinition; previous definition was 'namespace'</code> <br></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As for the compilation for android, the easiest way to do this is from under Ubuntu, using the scripts for armv7 and x86 that you can find in the source code of the project. </font></font><br><br> <a href="https://wiki.openssl.org/index.php/Android"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenSSL Android </font></font></a> <br> <a href="https://wiki.unrealengine.com/How_to_add_a_shared_library_(.so)_in_android_project"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to add a shared library (.so) in android project</font></font></a> <br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solving possible problems</font></font></b> <div class="spoiler_text">      ,     ,        : <br><br> <code>E/AndroidRuntime( 1574): java.lang.UnsatisfiedLinkError: dlopen failed: could not load library "libcrypto.so.1.0.0" needed by "libUE4.so"; caused by library "libcrypto.so.1.0.0" not found</code> <br>    <a href="http://stackoverflow.com/questions/33103867/unsatisfiedlinkerror-libcrypto-so-1-0-0-not-found">  </a> ,   Ubuntu  : <br> <code>rpl -R -e .so.1.0.0 "_1_0_0.so" /path/to/libcrypto.so</code> <br> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy the bipod to Source / Spiky_Client / armv7, libraries, titles in ThirdParty / OpenSSL and compile. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect libraries in Spiky_Client.Build.cs. </font><font style="vertical-align: inherit;">For convenience, we add two ModulePath and ThirdPartyPath functions, the first one returns the path to the project, the second to the folder with the link libraries.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Spiky_Client</span></span> : <span class="hljs-title"><span class="hljs-title">ModuleRules</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ModulePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ModuleDirectory; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ThirdPartyPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Path.GetFullPath(Path.Combine(ModulePath, <span class="hljs-string"><span class="hljs-string">"../../ThirdParty/"</span></span>)); } } ... }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specific to each platform, we add a library and headers. </font><font style="vertical-align: inherit;">When compiling, the library required by the platform is selected:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spiky_Client.Build.cs</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License using UnrealBuildTool; using System.IO; using System; public class Spiky_Client : ModuleRules { private string ModulePath { get { return ModuleDirectory; } } private string ThirdPartyPath { get { return Path.GetFullPath(Path.Combine(ModulePath, "../../ThirdParty/")); } } public Spiky_Client(ReadOnlyTargetRules Target) : base(Target) { PCHUsage = PCHUsageMode.Default; PublicDependencyModuleNames.AddRange(new string[] { "Core", "CoreUObject", "Engine", "InputCore", "Networking", "Sockets" }); PrivateDependencyModuleNames.AddRange(new string[] { "UMG", "Slate", "SlateCore" }); string IncludesPath = Path.Combine(ThirdPartyPath, "Protobuf", "Includes"); PublicIncludePaths.Add(IncludesPath); IncludesPath = Path.Combine(ThirdPartyPath, "OpenSSL", "Includes"); PublicIncludePaths.Add(IncludesPath); if ((Target.Platform == UnrealTargetPlatform.Win64)) { string LibrariesPath = Path.Combine(ThirdPartyPath, "Protobuf", "Libs"); PublicAdditionalLibraries.Add(Path.Combine(LibrariesPath, "libprotobuf.lib")); LibrariesPath = Path.Combine(ThirdPartyPath, "OpenSSL", "Libs"); PublicAdditionalLibraries.Add(Path.Combine(LibrariesPath, "libeay32.lib")); } if (Target.Platform == UnrealTargetPlatform.Android) { string BuildPath = Utils.MakePathRelativeTo(ModuleDirectory, BuildConfiguration.RelativeEnginePath); AdditionalPropertiesForReceipt.Add(new ReceiptProperty("AndroidPlugin", Path.Combine(BuildPath, "APL.xml"))); PublicAdditionalLibraries.Add(BuildPath + "/armv7/libprotobuf.so"); PublicAdditionalLibraries.Add(BuildPath + "/armv7/libcrypto_1_0_0.so"); } } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To add bipods to the assembly, you need to create the APL.xml (AndroidPluginLanguage) file in the source folder, which describes where the libraries should be copied from and where, and under what platform armv7, x86. </font><font style="vertical-align: inherit;">Examples and other parameters can be found </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APL</font></font></b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resourceCopies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">isArch</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">arch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"armeabi-v7a"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">copyFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$S(PluginDir)/armv7/libcrypto_1_0_0.so"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dst</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$S(BuildDir)/libs/armeabi-v7a/libcrypto_1_0_0.so"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">copyFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$S(PluginDir)/armv7/libprotobuf.so"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dst</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$S(BuildDir)/libs/armeabi-v7a/libprotobuf.so"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">isArch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resourceCopies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can test OpenSSL for windows and android by creating a test hud and output hash into it (missing in source code)</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// OpenSSL tests #include &lt;openssl/evp.h&gt; #include &lt;sstream&gt; #include &lt;iomanip&gt; void ADebugHUD::DrawHUD() { Super::DrawHUD(); FString hashTest = "Hash test (sha256): " + GetSHA256_s("test", strlen("test")); DrawText(hashTest, FColor::White, 50, 50, HUDFont); } FString ADebugHUD::GetSHA256_s(const void * data, size_t data_len) { EVP_MD_CTX mdctx; unsigned char md_value[EVP_MAX_MD_SIZE]; unsigned int md_len; EVP_DigestInit(&amp;mdctx, EVP_sha256()); EVP_DigestUpdate(&amp;mdctx, data, (size_t)data_len); EVP_DigestFinal_ex(&amp;mdctx, md_value, &amp;md_len); EVP_MD_CTX_cleanup(&amp;mdctx); std::stringstream s; s.fill('0'); for (size_t i = 0; i &lt; md_len; ++i) s &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; (unsigned short)md_value[i]; return s.str().c_str(); }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we add compiled .proto messages, anrial gives out various warnings, which can be disabled by either sorting out the engine sources, or suppressing them. </font><font style="vertical-align: inherit;">To do this, create DisableWarnings.proto and </font></font><code>./protoc --cpp_out=. --java_out=. DisableWarnings.proto</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then </font><font style="vertical-align: inherit;">compile the </font><font style="vertical-align: inherit;">resulting header DisableWarnings.pb.h suppress warnings, we will include DisableWarnings in each proto file. </font><font style="vertical-align: inherit;">There are only three lines in DisableWarnings.proto, the protobuff version, the name of the java package, and the name of the generated class.</font></font><br><br> <code>#define PROTOBUF_INLINE_NOT_IN_HEADERS 0 <br> #pragma warning(disable:4100) <br> #pragma warning(disable:4127) <br> #pragma warning(disable:4125) <br> #pragma warning(disable:4267) <br> #pragma warning(disable:4389) <br></code> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisableWarnings.proto</font></font></b> <div class="spoiler_text"> <code>syntax = "proto3"; <br> <br> option java_package = "com.spiky.server.protomodels"; <br> option java_outer_classname = "DisableWarnings"; <br></code> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisableWarnings.pb.h</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Generated by the protocol buffer compiler. DO NOT EDIT! // source: DisableWarnings.proto #define PROTOBUF_INLINE_NOT_IN_HEADERS 0 #pragma warning(disable:4100) #pragma warning(disable:4127) #pragma warning(disable:4125) #pragma warning(disable:4267) #pragma warning(disable:4389) #ifndef PROTOBUF_DisableWarnings_2eproto__INCLUDED #define PROTOBUF_DisableWarnings_2eproto__INCLUDED #include &lt;string&gt; #include &lt;google/protobuf/stubs/common.h&gt; #if GOOGLE_PROTOBUF_VERSION &lt; 3000000 #error This file was generated by a newer version of protoc which is #error incompatible with your Protocol Buffer headers. Please update #error your headers. #endif #if 3000000 &lt; GOOGLE_PROTOBUF_MIN_PROTOC_VERSION #error This file was generated by an older version of protoc which is #error incompatible with your Protocol Buffer headers. Please #error regenerate this file with a newer version of protoc. #endif #include &lt;google/protobuf/arena.h&gt; #include &lt;google/protobuf/arenastring.h&gt; #include &lt;google/protobuf/generated_message_util.h&gt; #include &lt;google/protobuf/metadata.h&gt; #include &lt;google/protobuf/repeated_field.h&gt; #include &lt;google/protobuf/extension_set.h&gt; // @@protoc_insertion_point(includes) // Internal implementation detail -- do not call these. void protobuf_AddDesc_DisableWarnings_2eproto(); void protobuf_AssignDesc_DisableWarnings_2eproto(); void protobuf_ShutdownFile_DisableWarnings_2eproto(); // =================================================================== // =================================================================== // =================================================================== #if !PROTOBUF_INLINE_NOT_IN_HEADERS #endif // !PROTOBUF_INLINE_NOT_IN_HEADERS // @@protoc_insertion_point(namespace_scope) // @@protoc_insertion_point(global_scope) #endif // PROTOBUF_DisableWarnings_2eproto__INCLUDED</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We put all our protobuffs in the Protobufs folder (Source / Spiky_Client / Protobufs), but it is better to configure automatic placement of the generated files by specifying full paths to --cpp_out =. --java_out =. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's go further, we will configure Spiky server! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create the com.spiky.server package and add the ServerMain class, the entry point of our server, here we will store global variables, initialize and run two Netty servers for tcp and udp connections (but I remind you that the project uses only tcp). We will definitely need a configuration file where we could store the ports of the servers (the server of the logic is Netty and the checker on Unreal), as well as the ability to enable disabling of cryptography. In the Recources folder, create configuration.properties. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's add server initialization to ServerMain, and read the settings file:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ResourceBundle configurationBundle = ResourceBundle.getBundle(<span class="hljs-string"><span class="hljs-string">"configuration"</span></span>, Locale.ENGLISH); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tcpPort = Integer.valueOf(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"tcpPort"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> udpPort = Integer.valueOf(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"udpPort"</span></span>)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_tcp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ EventLoopGroup bossGroup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NioEventLoopGroup(); <span class="hljs-comment"><span class="hljs-comment">// 1 EventLoopGroup workerGroup = new NioEventLoopGroup(); try { ServerBootstrap b = new ServerBootstrap(); // 2 b.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) // 3 .childHandler(new com.spiky.server.tcp.ServerInitializer()) // 4 .childOption(ChannelOption.SO_KEEPALIVE, true) .childOption(ChannelOption.TCP_NODELAY, true); ChannelFuture f = b.bind(tcpPort).sync(); // 5 f.channel().closeFuture().sync(); // 6 } catch (InterruptedException e) { e.printStackTrace(); } finally { workerGroup.shutdownGracefully(); bossGroup.shutdownGracefully(); } }</span></span></code> </pre><br><div class="spoiler"> <b class="spoiler_title"> ,   udp  main()</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.bootstrap.Bootstrap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.bootstrap.ServerBootstrap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelFuture; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelOption; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.EventLoopGroup; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.nio.NioEventLoopGroup; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.socket.nio.NioDatagramChannel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.socket.nio.NioServerSocketChannel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Locale; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ResourceBundle; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerMain</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ResourceBundle configurationBundle = ResourceBundle.getBundle(<span class="hljs-string"><span class="hljs-string">"configuration"</span></span>, Locale.ENGLISH); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tcpPort = Integer.valueOf(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"tcpPort"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> udpPort = Integer.valueOf(configurationBundle.getString(<span class="hljs-string"><span class="hljs-string">"udpPort"</span></span>)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_tcp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ EventLoopGroup bossGroup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NioEventLoopGroup(); EventLoopGroup workerGroup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NioEventLoopGroup(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ServerBootstrap b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServerBootstrap(); b.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) .childHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.spiky.server.tcp.ServerInitializer()) .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .childOption(ChannelOption.TCP_NODELAY, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); ChannelFuture f = b.bind(tcpPort).sync(); f.channel().closeFuture().sync(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { workerGroup.shutdownGracefully(); bossGroup.shutdownGracefully(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_udp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NioEventLoopGroup group = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NioEventLoopGroup(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Bootstrap bootstrap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bootstrap(); bootstrap.group(group).channel(NioDatagramChannel.class) .handler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.spiky.server.udp.ServerInitializer()); bootstrap.bind(udpPort).sync(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(ServerMain::run_tcp).start(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(ServerMain::run_udp).start(); } }</code> </pre><br></div></div><br><ol><li> NioEventLoopGroup ‚Äî   ,    -. Netty    EventLoopGroup    .       ,      NioEventLoopGroup. ,   ¬´¬ª,   . ,   ¬´¬ª,    ,         .          ,    EventLoopGroup      </li><li> ServerBootstrap ‚Äî   ,   .        .  ,    ,          </li><li>      NioServerSocketChannel,          </li><li>  Handler,           EventLoop.       , ,   , </li><li>       </li><li> ,       </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How Netty works, with simple examples of an echo server, with explanations can be found </font></font><a href="http://netty.io/wiki/user-guide-for-4.x.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I also strongly advise you to read the book Netty in Action, it is small. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our server is almost ready to start, we will add ServerInitializer for both protocols:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*  UDP  TCP*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NioDatagramChannel</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketChannel</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's create two packages </font></font><code>com.spiky.server.tcp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>com.spiky.server.udp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in each of them we will create a ServerInitializer class (with excellent NioDatagramChannel / SocketChannel) with the following contents:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.tcp; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelPipeline; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.socket.SocketChannel; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketChannel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChannel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SocketChannel ch)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ChannelPipeline pipeline = ch.pipeline(); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pipeline is what each message goes through, it contains a list of ChannelHandlers that process incoming and outgoing messages. For example, one of the handlers can only accept string data, another protobuff, if we call write (string), then a handler will be called for the strings, in which we decide to process the message further, send it to the other handler corresponding to the new type or send to the client. Each handler has a type that determines for which messages it is incoming or outgoing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add a standard debugging handler to ServerInitializer, which is very useful, you can see the size of incoming messages and in what form they are presented, also the addressee:</font></font><br><br><pre> <code class="java hljs">... ChannelPipeline pipeline = ch.pipeline(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingHandler(LogLevel.INFO)); ...</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processing protobaf messages sent via TCP is different from those sent via UDP, Netty has prepared handlers for protobuff, but they only work for streaming connections such as TCP, when we send a message we need to know where to finish reading, so at the beginning of each message it should go length, then the body itself. Let's start with UDP, add and test the reception and sending of messages by the server and client. Add a debug handler to the ServerInitializer, then create the com.spiky.server.udp.handlers package. Add the public class ProtoDecoderHandler extends SimpleChannelInboundHandler to it. ChannelInboundHandlerAdapter, allows you to explicitly process only certain types of incoming messages. For example, ProtoDecoderHandler processes only messages of type DatagramPacket.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Throw in the PackageHandler - class logic, after decoding (and then we will have to decode and decrypt) messages come here we used protobaf format class PackageHandler the extends the public SimpleChannelInboundHandler &lt;MessageModels.Wrapper&gt; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageModels is a wrapper class of the upper level, which will contain encrypted and unencrypted data. All messages turn into it, here is its final form, some types are not yet familiar to us:</font></font><br><br><pre> <code class="hljs pgsql">message <span class="hljs-keyword"><span class="hljs-keyword">Wrapper</span></span> { Utility utility = <span class="hljs-number"><span class="hljs-number">1</span></span>; InputChecking inputChecking = <span class="hljs-number"><span class="hljs-number">2</span></span>; Registration registration = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Login</span></span> <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>; CryptogramWrapper cryptogramWrapper = <span class="hljs-number"><span class="hljs-number">5</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we send a message, the receiving party reads the wrapper and looks at what fields it has. </font><font style="vertical-align: inherit;">Login, registration? </font><font style="vertical-align: inherit;">Or maybe the encrypted bytes of cryptogramWrapper? </font><font style="vertical-align: inherit;">Thereby choosing the flow of execution. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's define and describe all the proto-model of the model in our project so as not to be distracted anymore. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisableWarnings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an empty protobaf, whose only task is to disable warnings.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisableWarnings.proto</font></font></b> <div class="spoiler_text"> <code>syntax = "proto3"; <br> <br> option java_package = "com.spiky.server.protomodels"; <br> option java_outer_classname = "DisableWarnings"; <br></code> <br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contains the main wrapper Wrapper, inside which can be unencrypted messages Utility, InputChecking, Registration, Login and encrypted CryptogramWrapper. </font><font style="vertical-align: inherit;">CryptogramWrapper contains encrypted bytes, for example, after we exchanged keys and began to encrypt data, this data is assigned as one of the CryptogramWrapper fields. </font><font style="vertical-align: inherit;">The recipient received, checked whether there is encrypted data, decrypted, determined the type by the field name and sent further for processing.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"MessageModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"UtilityModels.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"RegLogModels.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> CryptogramWrapper { <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> registration = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> login = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> initialState = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> room = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> mainMenu = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> gameModels = <span class="hljs-number"><span class="hljs-number">6</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Wrapper { <span class="hljs-attribute"><span class="hljs-attribute">Utility</span></span> utility = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">InputChecking</span></span> inputChecking = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Registration</span></span> registration = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Login</span></span> login = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">CryptogramWrapper</span></span> cryptogramWrapper = <span class="hljs-number"><span class="hljs-number">5</span></span>; }</code> </pre><br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UtilityModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the only task for this model to send alive messages.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UtilityModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"UtilityModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Utility { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> alive = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegLogModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contains the models necessary for registration and logging, as well as checking user input and receiving captcha from the server.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegLogModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"RegistrationLoginModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"GameRoomModels.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> InputChecking { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> login = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> mail = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> captcha = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> getCaptcha = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> captchaData = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> loginCheckStatus = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> mailCheckStatus = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> captchaCheckStatus = <span class="hljs-number"><span class="hljs-number">8</span></span>; } } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Login { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> mail = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> hash = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> publicKey = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> stateCode = <span class="hljs-number"><span class="hljs-number">4</span></span>; } } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Registration { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> login = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> hash = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> mail = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> captcha = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> publicKey = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> stateCode = <span class="hljs-number"><span class="hljs-number">6</span></span>; } } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> InitialState { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> sessionId = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> login = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> CreateRoom createRoom = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre><br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MainMenuModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the data we need in the main menu, here only chat.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MainMenuModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"MainMenuModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ChatMessage { <span class="hljs-attribute"><span class="hljs-attribute">int64</span></span> time = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> name = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> text = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Chat { <span class="hljs-attribute"><span class="hljs-attribute">int64</span></span> time = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> name = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> text = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> subscribe = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> ChatMessage messages = <span class="hljs-number"><span class="hljs-number">5</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> MainMenu { <span class="hljs-attribute"><span class="hljs-attribute">Chat</span></span> chat = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoomModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - everything you need to create and update game rooms.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameRoomModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"GameRoomModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"MainMenuModels.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Room { <span class="hljs-attribute"><span class="hljs-attribute">CreateRoom</span></span> createRoom = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">RoomsListUpdate</span></span> roomsListUpdate = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">SubscribeRoom</span></span> subscribeRoom = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">RoomUpdate</span></span> roomUpdate = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> startGame = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">6</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> CreateRoom { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> mapName = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> gameTime = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> maxPlayers = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> creator = <span class="hljs-number"><span class="hljs-number">5</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> RoomsListUpdate { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> deleteRoom = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> addRoom = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomOwner = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> SubscribeRoom { <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> subscribe = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> stateCode = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">RoomDescribe</span></span> roomDescribe = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> player = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> team = <span class="hljs-number"><span class="hljs-number">6</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> RoomDescribe { <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> TeamPlayer team1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> TeamPlayer team2 = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> TeamPlayer undistributed = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> mapName = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> gameTime = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> maxPlayers = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> creator = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Chat</span></span> chat = <span class="hljs-number"><span class="hljs-number">9</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> TeamPlayer { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> player_name = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> RoomUpdate { <span class="hljs-attribute"><span class="hljs-attribute">RoomDescribe</span></span> roomDescribe = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> targetTeam = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomName = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre><br></div></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameModels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - model for the game, the position of the player, the parameters of the shot, the initial state, ping.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GameModels.proto</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_package = <span class="hljs-string"><span class="hljs-string">"com.spiky.server.protomodels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> java_outer_classname = <span class="hljs-string"><span class="hljs-string">"GameModels"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"DisableWarnings.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> GameInitialState { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> startGame = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">repeated</span></span> Player player = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Player { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> player_name = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> team = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> health = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">PlayerPosition</span></span> playerPosition = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> PlayerPosition { <span class="hljs-attribute"><span class="hljs-attribute">Location</span></span> loc = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Rotation</span></span> rot = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Location { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> X = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Y = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Z = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Rotation { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Pitch = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Roll = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Yaw = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> playerName = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int64</span></span> timeStamp = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Ping { <span class="hljs-attribute"><span class="hljs-attribute">int64</span></span> time = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Shot { <span class="hljs-attribute"><span class="hljs-attribute">Start</span></span> start = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">End</span></span> end = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">PlayerPosition</span></span> playerPosition = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Start { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> X = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Y = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Z = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> End { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> X = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Y = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> Z = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">int64</span></span> timeStamp = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> requestFrom = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> requestTo = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> roomOwner = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">oneof</span></span> v1 { <span class="hljs-attribute"><span class="hljs-attribute">bool</span></span> result_hitState = <span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> result_bonename = <span class="hljs-number"><span class="hljs-number">9</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> GameData { <span class="hljs-attribute"><span class="hljs-attribute">GameInitialState</span></span> gameInitialState = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">PlayerPosition</span></span> playerPosition = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Ping</span></span> ping = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Shot</span></span> shot = <span class="hljs-number"><span class="hljs-number">4</span></span>; }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All models you can find in Spiky / Spiky_Protospace. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To determine the type of message and how it should be processed, we learn that in it by the presence of named fields: </font><font style="vertical-align: inherit;">And in order not to clutter up the code, create separate classes with a set of descriptors, add the Descriptors class on the client and on the server to Utils.</font></font><br><br> <code>// java <br> if(wrapper.getCryptogramWrapper().hasField(registration_cw)) // - <br> // cpp <br> if (wrapper-&gt;cryptogramwrapper().GetReflection()-&gt;HasField(wrapper-&gt;cryptogramwrapper(), Descriptors::registration_cw)) // - <br></code> <br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descriptors.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License package com.spiky.server.utils; import com.spiky.server.protomodels.*; /** *         * */ public class Descriptors { public static com.google.protobuf.Descriptors.FieldDescriptor registration_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("registration"); public static com.google.protobuf.Descriptors.FieldDescriptor login_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("login"); public static com.google.protobuf.Descriptors.FieldDescriptor initialState_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("initialState"); public static com.google.protobuf.Descriptors.FieldDescriptor room_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("room"); public static com.google.protobuf.Descriptors.FieldDescriptor mainMenu_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("mainMenu"); public static com.google.protobuf.Descriptors.FieldDescriptor gameModels_cw = MessageModels.CryptogramWrapper.getDefaultInstance().getDescriptorForType().findFieldByName("gameModels"); public static com.google.protobuf.Descriptors.FieldDescriptor getCaptcha_ich = RegistrationLoginModels.InputChecking.getDefaultInstance().getDescriptorForType().findFieldByName("getCaptcha"); public static com.google.protobuf.Descriptors.FieldDescriptor login_ich = RegistrationLoginModels.InputChecking.getDefaultInstance().getDescriptorForType().findFieldByName("login"); public static com.google.protobuf.Descriptors.FieldDescriptor mail_ich = RegistrationLoginModels.InputChecking.getDefaultInstance().getDescriptorForType().findFieldByName("mail"); public static com.google.protobuf.Descriptors.FieldDescriptor captcha_ich = RegistrationLoginModels.InputChecking.getDefaultInstance().getDescriptorForType().findFieldByName("captcha"); public static com.google.protobuf.Descriptors.FieldDescriptor login_reg = RegistrationLoginModels.Registration.getDefaultInstance().getDescriptorForType().findFieldByName("login"); public static com.google.protobuf.Descriptors.FieldDescriptor mail_reg = RegistrationLoginModels.Registration.getDefaultInstance().getDescriptorForType().findFieldByName("mail"); public static com.google.protobuf.Descriptors.FieldDescriptor captcha_reg = RegistrationLoginModels.Registration.getDefaultInstance().getDescriptorForType().findFieldByName("captcha"); public static com.google.protobuf.Descriptors.FieldDescriptor publicKey_reg = RegistrationLoginModels.Registration.getDefaultInstance().getDescriptorForType().findFieldByName("publicKey"); public static com.google.protobuf.Descriptors.FieldDescriptor publicKey_log = RegistrationLoginModels.Login.getDefaultInstance().getDescriptorForType().findFieldByName("publicKey"); public static com.google.protobuf.Descriptors.FieldDescriptor subscribe_chat = MainMenuModels.Chat.getDefaultInstance().getDescriptorForType().findFieldByName("subscribe"); public static com.google.protobuf.Descriptors.FieldDescriptor chat_mm = MainMenuModels.MainMenu.getDefaultInstance().getDescriptorForType().findFieldByName("chat"); public static com.google.protobuf.Descriptors.FieldDescriptor deleteRoom_room = GameRoomModels.RoomsListUpdate.getDefaultInstance().getDescriptorForType().findFieldByName("deleteRoom"); public static com.google.protobuf.Descriptors.FieldDescriptor startGame_room = GameRoomModels.Room.getDefaultInstance().getDescriptorForType().findFieldByName("startGame"); public static com.google.protobuf.Descriptors.FieldDescriptor requestTo_shot_gd = GameModels.Shot.getDefaultInstance().getDescriptorForType().findFieldByName("requestTo"); }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descriptors.h / Descriptors.pp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include &lt;google/protobuf/descriptor.h&gt; class Descriptors { public: static const google::protobuf::FieldDescriptor* captchaDataField_ich; static const google::protobuf::FieldDescriptor* loginCheckStatus_ich; static const google::protobuf::FieldDescriptor* mailCheckStatus_ich; static const google::protobuf::FieldDescriptor* captchaCheckStatus_ich; static const google::protobuf::FieldDescriptor* publicKey_reg; static const google::protobuf::FieldDescriptor* stateCode_reg; static const google::protobuf::FieldDescriptor* publicKey_log; static const google::protobuf::FieldDescriptor* stateCode_log; static const google::protobuf::FieldDescriptor* registration_cw; static const google::protobuf::FieldDescriptor* login_cw; static const google::protobuf::FieldDescriptor* initialState_cw; static const google::protobuf::FieldDescriptor* room_cw; static const google::protobuf::FieldDescriptor* mainMenu_cw; static const google::protobuf::FieldDescriptor* gameModels_cw; static const google::protobuf::FieldDescriptor* chat_mm; static const google::protobuf::FieldDescriptor* nameField_chat; static const google::protobuf::FieldDescriptor* player_sub; static const google::protobuf::FieldDescriptor* player_team; static const google::protobuf::FieldDescriptor* chat_room; }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Descriptors.h" #include "Protobufs/RegLogModels.pb.h" #include "Protobufs/MessageModels.pb.h" #include "Protobufs/MainMenuModels.pb.h" const google::protobuf::FieldDescriptor* Descriptors::captchaDataField_ich = InputChecking::default_instance().descriptor()-&gt;FindFieldByName("captchaData"); const google::protobuf::FieldDescriptor* Descriptors::loginCheckStatus_ich = InputChecking::default_instance().descriptor()-&gt;FindFieldByName("loginCheckStatus"); const google::protobuf::FieldDescriptor* Descriptors::mailCheckStatus_ich = InputChecking::default_instance().descriptor()-&gt;FindFieldByName("mailCheckStatus"); const google::protobuf::FieldDescriptor* Descriptors::captchaCheckStatus_ich = InputChecking::default_instance().descriptor()-&gt;FindFieldByName("captchaCheckStatus"); const google::protobuf::FieldDescriptor* Descriptors::publicKey_reg = Registration::default_instance().descriptor()-&gt;FindFieldByName("publicKey"); const google::protobuf::FieldDescriptor* Descriptors::stateCode_reg = Registration::default_instance().descriptor()-&gt;FindFieldByName("stateCode"); const google::protobuf::FieldDescriptor* Descriptors::publicKey_log = Login::default_instance().descriptor()-&gt;FindFieldByName("publicKey"); const google::protobuf::FieldDescriptor* Descriptors::stateCode_log = Login::default_instance().descriptor()-&gt;FindFieldByName("stateCode"); const google::protobuf::FieldDescriptor* Descriptors::registration_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("registration"); const google::protobuf::FieldDescriptor* Descriptors::login_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("login"); const google::protobuf::FieldDescriptor* Descriptors::initialState_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("initialState"); const google::protobuf::FieldDescriptor* Descriptors::room_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("room"); const google::protobuf::FieldDescriptor* Descriptors::mainMenu_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("mainMenu"); const google::protobuf::FieldDescriptor* Descriptors::gameModels_cw = CryptogramWrapper::default_instance().descriptor()-&gt;FindFieldByName("gameModels"); const google::protobuf::FieldDescriptor* Descriptors::chat_mm = MainMenu::default_instance().descriptor()-&gt;FindFieldByName("chat"); const google::protobuf::FieldDescriptor* Descriptors::nameField_chat = Chat::default_instance().descriptor()-&gt;FindFieldByName("name"); const google::protobuf::FieldDescriptor* Descriptors::player_sub = SubscribeRoom::default_instance().descriptor()-&gt;FindFieldByName("player"); const google::protobuf::FieldDescriptor* Descriptors::player_team = SubscribeRoom::default_instance().descriptor()-&gt;FindFieldByName("team"); const google::protobuf::FieldDescriptor* Descriptors::chat_room = RoomDescribe::default_instance().descriptor()-&gt;FindFieldByName("chat");</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we need to send from the client to the Utility server which contains the only alive field that always accepts true, the bool type will allow using the minimum message size, I want to note that in order to send a message with the false field, you need to wrap oneof v1 {bool alive = 1; </font><font style="vertical-align: inherit;">}, if the field is false or zero, it is considered that it is missing when we receive a message and want to know if there is alive, we will not be able to recognize this false or there is simply no field (if there is no field, this is a signal to some actions eg). </font><font style="vertical-align: inherit;">We also always import DisableWarnings to disable warnings. </font><font style="vertical-align: inherit;">Each protobuff message has its own class, so that you do not have to recompile for any changes. </font><font style="vertical-align: inherit;">Let's generate the command classes:</font></font><br><br> <code>./protoc --cpp_out=c:/Spiky/Spiky_Client/Source/Spiky_Client/Protobufs --java_out=c:/Spiky/Spiky_Server/src/main/java *.proto <br></code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Headline DisableWarnings updated, do not forget to add error suppression again! </font><font style="vertical-align: inherit;">(from the file add.txt).</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add.txt</font></font></b> <div class="spoiler_text"> #define PROTOBUF_INLINE_NOT_IN_HEADERS 0 <br><br> #pragma warning(disable:4100) <br> #pragma warning(disable:4127) <br> #pragma warning(disable:4125) <br> #pragma warning(disable:4267) <br> #pragma warning(disable:4389) <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order for the project in the studio to be updated and see the new files, you need to click RMB on .uproject and select ‚ÄúGenerate Visual Studio project files‚Äù. </font><font style="vertical-align: inherit;">Now with the PackageHandler class everything is in order, SimpleChannelInboundHandler &lt;MessageModels.Wrapper&gt; is found, we will redefine channelRead0 as we are required to, the method that processes all incoming messages.</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelRead0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, MessageModels.Wrapper wrapper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add handlers to the ServerInitializer pipeline: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChannelInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NioDatagramChannel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChannel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NioDatagramChannel ch)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ChannelPipeline pipeline = ch.pipeline(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingHandler(LogLevel.INFO)); <span class="hljs-comment"><span class="hljs-comment">/* proto  */</span></span> pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProtoDecoderHandler()); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PackageHandler()); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open ProtoDecoderHandler, add exceptionCaught, the method that is called in case of an error, it is convenient to close the channel or connection to the database and channelReadComplete, where we clear the stream after writing to it. </font><font style="vertical-align: inherit;">Immediately update channelRead0, we read the packet, translate it into an array of bytes, which we then assemble into a message using parseDelimitedFrom - it reads the length, then the message itself. </font><font style="vertical-align: inherit;">We do not send further by handler, we will send a message back echoed.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProtoDecoderHandler</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2017, Vadim Petrov - MIT License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.spiky.server.udp.handlers; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.spiky.server.protomodels.MessageModels; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.buffer.ByteBuf; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.buffer.Unpooled; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.ChannelHandlerContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.SimpleChannelInboundHandler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.netty.channel.socket.DatagramPacket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.ByteArrayInputStream; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProtoDecoderHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleChannelInboundHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DatagramPacket</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelRead0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, DatagramPacket datagramPacket)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ByteBuf buf = datagramPacket.content(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[buf.readableBytes()]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> readerIndex = buf.readerIndex(); buf.getBytes(readerIndex, bytes); ByteArrayInputStream input = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayInputStream(bytes); MessageModels.Wrapper wrapper = MessageModels.Wrapper.parseDelimitedFrom(input); System.out.println(<span class="hljs-string"><span class="hljs-string">"udp: "</span></span>); System.out.println(wrapper.toString()); System.out.println(datagramPacket.sender().getAddress() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + datagramPacket.sender().getPort()); <span class="hljs-comment"><span class="hljs-comment">//   () ctx.write(new DatagramPacket(Unpooled.copiedBuffer(datagramPacket.content()), datagramPacket.sender())); } @Override public void channelReadComplete(ChannelHandlerContext ctx) throws Exception { ctx.flush(); } @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception { cause.printStackTrace(); ctx.close(); } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the client, we implement the listener and the sender, in the class SocketObject. </font><font style="vertical-align: inherit;">We need to add new functions SendByUDP and ReadDelimitedFrom, the </font></font><a href="https://stackoverflow.com/questions/2340730/are-there-c-equivalents-for-the-protocol-buffers-delimited-i-o-functions-in-ja/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementation in c ++ of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> which, unlike java, unfortunately, is missing.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SocketObject.cpp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Spiky_Client.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SocketObject.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Protobufs/MessageModels.pb.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;google/protobuf/message.h&gt; #include &lt;google/protobuf/io/zero_copy_stream_impl_lite.h&gt; #include &lt;google/protobuf/io/coded_stream.h&gt; FSocket* USocketObject::tcp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::tcp_address = nullptr; bool USocketObject::bIsConnection = false; FSocket* USocketObject::udp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::udp_address = nullptr; FUdpSocketReceiver* USocketObject::UDPReceiver = nullptr; int32 USocketObject::tcp_local_port = 0; int32 USocketObject::udp_local_port = 0; USocketObject::~USocketObject() { if (tcp_socket != nullptr || udp_socket != nullptr) { tcp_socket-&gt;Close(); delete tcp_socket; delete udp_socket; } } void USocketObject::InitSocket(FString serverAddress, int32 tcp_local_p, int32 tcp_server_port, int32 udp_local_p, int32 udp_server_port) { int32 BufferSize = 2 * 1024 * 1024; tcp_local_port = tcp_local_p; udp_local_port = udp_local_p; // tcp tcp_socket = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateSocket(NAME_Stream, TEXT("TCP_SOCKET"), false); // create a proper FInternetAddr representation tcp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); // parse server address FIPv4Address serverIP; FIPv4Address::Parse(serverAddress, serverIP); // and set tcp_address-&gt;SetIp(serverIP.Value); tcp_address-&gt;SetPort(tcp_server_port); tcp_socket-&gt;Connect(*tcp_address); // set the initial connection state bIsConnection = Alive(); // udp udp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); FIPv4Address::Parse(serverAddress, serverIP); udp_address-&gt;SetIp(serverIP.Value); udp_address-&gt;SetPort(udp_server_port); udp_socket = FUdpSocketBuilder("UDP_SOCKET") .AsReusable() .BoundToPort(udp_local_port) .WithBroadcast() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); } void USocketObject::RunUdpSocketReceiver() { FTimespan ThreadWaitTime = FTimespan::FromMilliseconds(30); UDPReceiver = new FUdpSocketReceiver(udp_socket, ThreadWaitTime, TEXT("UDP_RECEIVER")); UDPReceiver-&gt;OnDataReceived().BindStatic(&amp;USocketObject::Recv); UDPReceiver-&gt;Start(); } void USocketObject::Recv(const FArrayReaderPtr&amp; ArrayReaderPtr, const FIPv4Endpoint&amp; EndPt) { GLog-&gt;Log("Reveived UDP data"); uint8_t * buffer = ArrayReaderPtr-&gt;GetData(); size_t size = ArrayReaderPtr-&gt;Num(); GLog-&gt;Log("Size of incoming data: " + FString::FromInt(size)); google::protobuf::io::ArrayInputStream arr(buffer, size); google::protobuf::io::CodedInputStream input(&amp;arr); std::shared_ptr&lt;Wrapper&gt; wrapper(new Wrapper); ReadDelimitedFrom(&amp;input, wrapper.get()); std::string msg; wrapper-&gt;SerializeToString(&amp;msg); GLog-&gt;Log(msg.c_str()); } bool USocketObject::SendByUDP(google::protobuf::Message * message) { Wrapper wrapper; if (message-&gt;GetTypeName() == "Utility") { Utility * mes = static_cast&lt;Utility*&gt;(message); wrapper.set_allocated_utility(mes); } size_t size = wrapper.ByteSize() + 5; // include size, varint32 never takes more than 5 bytes uint8_t * buffer = new uint8_t[size]; google::protobuf::io::ArrayOutputStream arr(buffer, size); google::protobuf::io::CodedOutputStream output(&amp;arr); output.WriteVarint32(wrapper.ByteSize()); wrapper.SerializeToCodedStream(&amp;output); if (wrapper.has_utility()) { wrapper.release_utility(); } int32 bytesSent = 0; bool sentState = false; sentState = udp_socket-&gt;SendTo(buffer, output.ByteCount(), bytesSent, *udp_address); delete[] buffer; return sentState; } bool USocketObject::ReadDelimitedFrom(google::protobuf::io::CodedInputStream * input, google::protobuf::MessageLite * message) { // Read the size. uint32_t size; if (!input-&gt;ReadVarint32(&amp;size)) return false; // Tell the stream not to read beyond that size. google::protobuf::io::CodedInputStream::Limit limit = input-&gt;PushLimit(size); // Parse the message. if (!message-&gt;MergeFromCodedStream(input)) return false; if (!input-&gt;ConsumedEntireMessage()) return false; // Release the limit. input-&gt;PopLimit(limit); return true; } void USocketObject::Reconnect() { } bool USocketObject::Alive() { return false; }</span></span></span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunUdpSocketReceiver - sets the speed for checking new messages, delegates incoming Recv data. </font><font style="vertical-align: inherit;">Recv - reads the size, parses the bytes using ReadDelimitedFrom and creates a wrapper wrapper. </font><font style="vertical-align: inherit;">SendByUDP - sends via UDP, sends messages of various formats to the input, we determine what the format is inside, we wrap, serialize, and send. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open SpikyGameMode, send messages to the server by pressing the Q key.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginPlay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndPlay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EEndPlayReason::Type EndPlayReason)</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestSendUPDMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In BeginPlay, we add the ability to respond to user input by setting: </font></font><br><br><pre> <code class="cpp hljs">EnableInput(GetWorld()-&gt;GetFirstPlayerController()); InputComponent-&gt;BindAction(<span class="hljs-string"><span class="hljs-string">"Q"</span></span>, IE_Pressed, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;ASpikyGameMode::TestSendUPDMessage);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In EndPlay, just add a log message to see when game mode ends, or switch to another. </font><font style="vertical-align: inherit;">TestSendUPDMessage - the function that is called when you press the Q key.</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ASpikyGameMode::TestSendUPDMessage() { GLog-&gt;Log(<span class="hljs-string"><span class="hljs-string">"send -&gt;&gt;&gt;"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Utility&gt; utility(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Utility); utility-&gt;set_alive(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); USocketObject::SendByUDP(utility.get()); }</code> </pre><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpikyGameMode.cpp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SpikyGameMode.h" #include "SocketObject.h" #include "Runtime/Engine/Classes/Engine/World.h" #include "Protobufs/UtilityModels.pb.h" void ASpikyGameMode::BeginPlay() { Super::BeginPlay(); GLog-&gt;Log("AClientGameMode::BeginPlay()"); EnableInput(GetWorld()-&gt;GetFirstPlayerController()); InputComponent-&gt;BindAction("Q", IE_Pressed, this, &amp;ASpikyGameMode::TestSendUPDMessage); } void ASpikyGameMode::EndPlay(const EEndPlayReason::Type EndPlayReason) { Super::EndPlay(EndPlayReason); GLog-&gt;Log("AClientGameMode::EndPlay()"); } void ASpikyGameMode::TestSendUPDMessage() { GLog-&gt;Log("send -&gt;&gt;&gt;"); std::shared_ptr&lt;Utility&gt; utility(new Utility); utility-&gt;set_alive(true); USocketObject::SendByUDP(utility.get()); }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open SpikyGameInstance and initialize the sockets when starting the game, add functions that are called when the game starts and ends: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will need another Config class, where we will be storing various static settings on the server. </font><font style="vertical-align: inherit;">We will create it (Spiky_Client / Source / Spiky_Client / Public), without a parent, put the addresses, ports and the flag that the cryptography is included (for the future).</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Config.h / Config.cpp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// .h // Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include &lt;string&gt; class Config { public: static std::string address; static size_t tcp_local_port; static size_t tcp_server_port; static size_t udp_local_port; static size_t udp_server_port; static bool bEnableCrypt; }; // .cpp // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "Config.h" bool Config::bEnableCrypt = true; std::string Config::address = "127.0.0.1"; size_t Config::tcp_local_port = 7678; size_t Config::tcp_server_port = 7680; size_t Config::udp_local_port = 7679; size_t Config::udp_server_port = 7681;</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we initialize sockets in SpikyGameInstance :: Init () </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> USpikyGameInstance::Init() { GLog-&gt;Log(<span class="hljs-string"><span class="hljs-string">"UClientGameInstance::Init()"</span></span>); USocketObject::InitSocket(Config::address.c_str(), Config::tcp_local_port, Config::tcp_server_port, Config::udp_local_port, Config::udp_server_port); <span class="hljs-comment"><span class="hljs-comment">//    udp  USocketObject::RunUdpSocketReceiver(); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains only to set the response to pressing the keys in the editor, to do this, go to Edit ‚Üí Project Settings ‚Üí Input ‚Üí Action Mapping click + in the text field write the Q name we specified in the code, and add the Q button, that's it! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After starting the server and client, by clicking a button in the server log, thanks to the LoggingHandler, we will see something like the following: </font><font style="vertical-align: inherit;">In the Unreal Engine: </font><font style="vertical-align: inherit;">We will not return to the UDP theme anymore. </font><font style="vertical-align: inherit;">Disable the functions and creation of udp_socket on the server and client UDP: The </font><font style="vertical-align: inherit;">status of the SocketObject at the moment:</font></font><br><br> <code>udp: <br> utility { <br> alive: true <br> } <br> <br> /127.0.0.1 7679 <br>  10, 2017 4:42:30 PM io.netty.handler.logging.LoggingHandler channelRead <br> INFO: [id: 0x89373e1f, L:/0:0:0:0:0:0:0:0:7681] RECEIVED: DatagramPacket(/127.0.0.1:7679 =&gt; /0:0:0:0:0:0:0:0:7681, PooledUnsafeDirectByteBuf(ridx: 0, widx: 5, cap: 2048)), 5B <br> +-------------------------------------------------+ <br> | 0 1 2 3 4 5 6 7 8 9 abcdef | <br> +--------+-------------------------------------------------+----------------+ <br> |00000000| 04 0a 02 08 01 |..... | <br> +--------+-------------------------------------------------+----------------+ <br>  10, 2017 4:42:30 PM io.netty.handler.logging.LoggingHandler write <br> INFO: [id: 0x89373e1f, L:/0:0:0:0:0:0:0:0:7681] WRITE: DatagramPacket(=&gt; /127.0.0.1:7679, UnpooledUnsafeHeapByteBuf(ridx: 0, widx: 5, cap: 5)), 5B <br> +-------------------------------------------------+ <br> | 0 1 2 3 4 5 6 7 8 9 abcdef | <br> +--------+-------------------------------------------------+----------------+ <br> |00000000| 04 0a 02 08 01 |..... | <br> +--------+-------------------------------------------------+----------------+ <br>  10, 2017 4:42:30 PM io.netty.handler.logging.LoggingHandler flush <br> INFO: [id: 0x89373e1f, L:/0:0:0:0:0:0:0:0:7681] FLUSH <br></code> <br><font style="vertical-align: inherit;"></font><br> <code>Reveived UDP data <br> Size of incoming data: 5 <br></code> <br><font style="vertical-align: inherit;"></font><br><br> <code>ServerMain <br> //new Thread(ServerMain::run_udp).start(); <br> SpikyGameInstance <br> //    udp  <br> //USocketObject::RunUdpSocketReceiver(); <br></code> <br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SocketObject.cpp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "SocketObject.h" #include "Protobufs/MessageModels.pb.h" FSocket* USocketObject::tcp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::tcp_address = nullptr; bool USocketObject::bIsConnection = false; FSocket* USocketObject::udp_socket = nullptr; TSharedPtr&lt;FInternetAddr&gt; USocketObject::udp_address = nullptr; FUdpSocketReceiver* USocketObject::UDPReceiver = nullptr; int32 USocketObject::tcp_local_port = 0; int32 USocketObject::udp_local_port = 0; USocketObject::~USocketObject() { GLog-&gt;Log("USocketObject::~USocketObject()"); if (tcp_socket != nullptr || udp_socket != nullptr) { tcp_socket-&gt;Close(); //UDPReceiver-&gt;Stop(); delete tcp_socket; delete udp_socket; } } void USocketObject::InitSocket(FString serverAddress, int32 tcp_local_p, int32 tcp_server_port, int32 udp_local_p, int32 udp_server_port) { int32 BufferSize = 2 * 1024 * 1024; tcp_local_port = tcp_local_p; udp_local_port = udp_local_p; /* tcp_socket = FTcpSocketBuilder("TCP_SOCKET") .AsNonBlocking() // Socket connect always success. Non blocking you say socket connect dont wait for response (Don?t block) so it will return true. .AsReusable() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); */ // tcp tcp_socket = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateSocket(NAME_Stream, TEXT("TCP_SOCKET"), false); // create a proper FInternetAddr representation tcp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); // parse server address FIPv4Address serverIP; FIPv4Address::Parse(serverAddress, serverIP); // and set tcp_address-&gt;SetIp(serverIP.Value); tcp_address-&gt;SetPort(tcp_server_port); tcp_socket-&gt;Connect(*tcp_address); // set the initial connection state bIsConnection = Alive(); // udp udp_address = ISocketSubsystem::Get(PLATFORM_SOCKETSUBSYSTEM)-&gt;CreateInternetAddr(); FIPv4Address::Parse(serverAddress, serverIP); udp_address-&gt;SetIp(serverIP.Value); udp_address-&gt;SetPort(udp_server_port); /* udp_socket = FUdpSocketBuilder("UDP_SOCKET") .AsReusable() .BoundToPort(udp_local_port) .WithBroadcast() .WithReceiveBufferSize(BufferSize) .WithSendBufferSize(BufferSize) .Build(); */ } void USocketObject::RunUdpSocketReceiver() { FTimespan ThreadWaitTime = FTimespan::FromMilliseconds(100); UDPReceiver = new FUdpSocketReceiver(udp_socket, ThreadWaitTime, TEXT("UDP_RECEIVER")); UDPReceiver-&gt;OnDataReceived().BindStatic(&amp;USocketObject::Recv); UDPReceiver-&gt;Start(); } void USocketObject::Recv(const FArrayReaderPtr&amp; ArrayReaderPtr, const FIPv4Endpoint&amp; EndPt) { GLog-&gt;Log("Reveived UDP data"); uint8_t * buffer = ArrayReaderPtr-&gt;GetData(); size_t size = ArrayReaderPtr-&gt;Num(); GLog-&gt;Log("Size of incoming data: " + FString::FromInt(size)); google::protobuf::io::ArrayInputStream arr(buffer, size); google::protobuf::io::CodedInputStream input(&amp;arr); std::shared_ptr&lt;Wrapper&gt; wrapper(new Wrapper); ReadDelimitedFrom(&amp;input, wrapper.get()); std::string msg; wrapper-&gt;SerializeToString(&amp;msg); GLog-&gt;Log(msg.c_str()); } bool USocketObject::SendByUDP(google::protobuf::Message * message) { Wrapper wrapper; if (message-&gt;GetTypeName() == "Utility") { Utility * mes = static_cast&lt;Utility*&gt;(message); wrapper.set_allocated_utility(mes); } size_t size = wrapper.ByteSize() + 5; // include size, varint32 never takes more than 5 bytes uint8_t * buffer = new uint8_t[size]; google::protobuf::io::ArrayOutputStream arr(buffer, size); google::protobuf::io::CodedOutputStream output(&amp;arr); output.WriteVarint32(wrapper.ByteSize()); wrapper.SerializeToCodedStream(&amp;output); if (wrapper.has_utility()) { wrapper.release_utility(); } int32 bytesSent = 0; bool sentState = false; sentState = udp_socket-&gt;SendTo(buffer, output.ByteCount(), bytesSent, *udp_address); delete[] buffer; return sentState; } void USocketObject::Reconnect() { } bool USocketObject::Alive() { return false; } bool USocketObject::ReadDelimitedFrom(google::protobuf::io::CodedInputStream * input, google::protobuf::MessageLite * message) { // Read the size. uint32_t size; if (!input-&gt;ReadVarint32(&amp;size)) return false; // Tell the stream not to read beyond that size. google::protobuf::io::CodedInputStream::Limit limit = input-&gt;PushLimit(size); // Parse the message. if (!message-&gt;MergeFromCodedStream(input)) return false; if (!input-&gt;ConsumedEntireMessage()) return false; // Release the limit. input-&gt;PopLimit(limit); return true; }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do the same for TCP. </font><font style="vertical-align: inherit;">Create the Handlers package and add there two empty DecryptHandler, EncryptHandler classes. </font><font style="vertical-align: inherit;">All messages will arrive encrypted, go through DecryptHandler, decrypt and then, depending on the type, be sent further for processing. </font><font style="vertical-align: inherit;">Open the ServerInitializer, we need to prepare a message using the prototyp decoders built into Netty. </font><font style="vertical-align: inherit;">Add the protobuff encoders and decoders to the pipeline:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Decoders protobuf pipeline.addLast(new ProtobufVarint32FrameDecoder()); pipeline.addLast(new ProtobufDecoder(MessageModels.Wrapper.getDefaultInstance())); // Encoder protobuf pipeline.addLast(new ProtobufVarint32LengthFieldPrepender()); pipeline.addLast(new ProtobufEncoder());</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We extend the DecryptHandler extends MessageToMessageDecoder &lt;MessageModels.Wrapper&gt;, override the decode method and add it last to the pipeline: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> pipeline.addLast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecryptHandler());</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We do not process alive messages on the server in any way, we send back by an echo in DecryptHandler: </font></font><br><br><pre> <code class="java hljs">ctx.writeAndFlush(wrapper);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's return to sending messages on the client. </font><font style="vertical-align: inherit;">We will check the server status by sending a message every second using a separate stream. </font><font style="vertical-align: inherit;">In Unreal, there are several ways to create a stream, the simplest is to create a </font></font><a href="http://www.tomlooman.com/using-timers-in-ue4/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There are also Task created for small tasks, an example with the search for prime numbers: </font></font><br><br> <a href="http://orfeasel.com/implementing-multithreading-in-ue4/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementing Multithreading in UE4 </font></font></a> <br> <a href="https://wiki.unrealengine.com/Multi-Threading:_Task_Graph_System"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-Threading: Task Graph System </font></font></a> <br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Engine / Source / Runtime / Core / Public / Async / AsyncWork.h</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And you can implement the </font></font><a href="https://docs.unrealengine.com/latest/INT/API/Runtime/Core/HAL/FRunnable/index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FRunnable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><a href="https://docs.unrealengine.com/latest/INT/API/Runtime/Core/HAL/FRunnable/index.html"><font style="vertical-align: inherit;">,</font></a><font style="vertical-align: inherit;"> which we do . </font></font><br><br> <a href="https://wiki.unrealengine.com/Multi-Threading:_How_to_Create_Threads_in_UE4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-Threading: How to Create Threads in UE4</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's create a class ServerStatusCheckingTh with parent FRunnable in the Net folder.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FServerStatusCheckingTh</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/Core/Public/HAL/Runnable.h" #include "Runtime/Core/Public/HAL/RunnableThread.h" class SPIKY_CLIENT_API FServerStatusCheckingTh : public FRunnable { // Singleton instance, can access the thread any time via static accessor, if it is active! static FServerStatusCheckingTh* Runnable; // Thread to run the worker FRunnable on FRunnableThread* Thread; // The way to stop static bool bThreadRun; public: FServerStatusCheckingTh(); ~FServerStatusCheckingTh(); // FRunnable interface virtual bool Init(); virtual uint32 Run(); // Logics static FServerStatusCheckingTh* RunServerChecking(); // Shuts down the thread. Static so it can easily be called from outside the thread context static void Shutdown(); }; // Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "ServerStatusCheckingTh.h" #include "SocketObject.h" FServerStatusCheckingTh* FServerStatusCheckingTh::Runnable = nullptr; bool FServerStatusCheckingTh::bThreadRun = false; FServerStatusCheckingTh::FServerStatusCheckingTh() { Thread = FRunnableThread::Create(this, TEXT("ServerStatusChecking"), 0, TPri_BelowNormal); } FServerStatusCheckingTh::~FServerStatusCheckingTh() { delete Thread; Thread = nullptr; } bool FServerStatusCheckingTh::Init() { bThreadRun = true; return true; } uint32 FServerStatusCheckingTh::Run() { while (bThreadRun) { FPlatformProcess::Sleep(1.f); //    if (!USocketObject::bIsConnection) //   ,  { USocketObject::Reconnect(); } else { USocketObject::bIsConnection = USocketObject::Alive(); //    ,    } //    //GLog-&gt;Log("Connect state (bIsConnection) = " + FString::FromInt((int32)USocketObject::bIsConnection) + " | FServerStatusCheckingTh::CheckServer"); } return 0; } FServerStatusCheckingTh* FServerStatusCheckingTh::RunServerChecking() { if (!Runnable &amp;&amp; FPlatformProcess::SupportsMultithreading()) { Runnable = new FServerStatusCheckingTh(); } return Runnable; } void FServerStatusCheckingTh::Shutdown() { bThreadRun = false; GLog-&gt;Log("FServerStatusCheckingTh::Shutdown()"); if (Runnable) { delete Runnable; Runnable = nullptr; } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start the thread by calling RunServerChecking (), which passes through Init, Run and Exit. Finish shutdown (). Every second we send a message to Alive and if the messages do not reach, try reconnecting by calling Reconnect. Implement Reconnect and Alive in USocketObject. Reconnect - closes the socket, normalizes the address and initializes the sockets again. Alive - creates a message and immediately sends it:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> USocketObject::Reconnect() { tcp_socket-&gt;Close(); uint32 OutIP; tcp_address-&gt;GetIp(OutIP); FString ip = FString::Printf(TEXT(<span class="hljs-string"><span class="hljs-string">"%d.%d.%d.%d"</span></span>), <span class="hljs-number"><span class="hljs-number">0xff</span></span> &amp; (OutIP &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>), <span class="hljs-number"><span class="hljs-number">0xff</span></span> &amp; (OutIP &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>), <span class="hljs-number"><span class="hljs-number">0xff</span></span> &amp; (OutIP &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">0xff</span></span> &amp; OutIP); InitSocket(ip, tcp_local_port, tcp_address-&gt;GetPort(), udp_local_port, udp_address-&gt;GetPort()); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> USocketObject::Alive() { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Utility&gt; utility(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Utility); utility-&gt;set_alive(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Send  , : , ?  tcp? return UMessageEncoder::Send(utility.get(), false, true); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the Handlers folder and the MessageDecoder and MessageEncoder classes derived from UObject in the same way as the decoder and server encoder. This classes are engaged in decrypting / encrypting and scanning / wrapping incoming / outgoing messages. </font><font style="vertical-align: inherit;">Add #include "MessageEncoder.h" to SocketObject and compile. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We need a listener for incoming messages, for this we will create a class in Net, a separate stream TCPSocketListeningTh with the parent FRunnable. </font><font style="vertical-align: inherit;">Here we check the connection and set the speed of the stream so that it does not work in vain, we read, convert the bytes to protobuf, send for processing in the main game stream:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FTCPSocketListeningTh</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #pragma once #include "Runtime/Core/Public/HAL/Runnable.h" #include "Runtime/Core/Public/HAL/RunnableThread.h" class SPIKY_CLIENT_API FTCPSocketListeningTh : public FRunnable { FRunnableThread* Thread; static FTCPSocketListeningTh* Runnable; static bool bThreadRun; public: FTCPSocketListeningTh(); ~FTCPSocketListeningTh(); virtual bool Init(); virtual uint32 Run(); static FTCPSocketListeningTh* RunSocketListening(); static void Shutdown(); }; #include "Spiky_Client.h" #include "TCPSocketListeningTh.h" #include "SocketObject.h" #include "MessageDecoder.h" #include &lt;google/protobuf/io/zero_copy_stream_impl_lite.h&gt; #include &lt;google/protobuf/io/coded_stream.h&gt; #include "Protobufs/MessageModels.pb.h" #include "Async.h" FTCPSocketListeningTh* FTCPSocketListeningTh::Runnable = nullptr; bool FTCPSocketListeningTh::bThreadRun = false; FTCPSocketListeningTh::FTCPSocketListeningTh() { Thread = FRunnableThread::Create(this, TEXT("TCP_RECEIVER"), 0, TPri_BelowNormal); } FTCPSocketListeningTh::~FTCPSocketListeningTh() { delete Thread; Thread = nullptr; } bool FTCPSocketListeningTh::Init() { bThreadRun = true; return true; } uint32 FTCPSocketListeningTh::Run() { while (bThreadRun) { //    if (USocketObject::bIsConnection == false) //   { FPlatformProcess::Sleep(1.f); //   ,  } else { FPlatformProcess::Sleep(0.03f); if (!USocketObject::tcp_socket) return 0; //Binary Array! TArray&lt;uint8&gt; ReceivedData; uint32 Size; while (USocketObject::tcp_socket-&gt;HasPendingData(Size)) //     { ReceivedData.Init(FMath::Min(Size, 65507u), Size); int32 Read = 0; USocketObject::tcp_socket-&gt;Recv(ReceivedData.GetData(), ReceivedData.Num(), Read); } if (ReceivedData.Num() &gt; 0) { GLog-&gt;Log(FString::Printf(TEXT("Data Read! %d"), ReceivedData.Num()) + " | FTCPSocketListeningTh::Run"); //    protobuf uint8_t * buffer = ReceivedData.GetData(); size_t size = ReceivedData.Num(); google::protobuf::io::ArrayInputStream arr(buffer, size); google::protobuf::io::CodedInputStream input(&amp;arr); bool protosize = true; /*        , tcp      */ while (protosize) { std::shared_ptr&lt;Wrapper&gt; wrapper(new Wrapper); protosize = USocketObject::ReadDelimitedFrom(&amp;input, wrapper.get()); /*      ,    */ AsyncTask(ENamedThreads::GameThread, [wrapper]() { UMessageDecoder * Handler = NewObject&lt;UMessageDecoder&gt;(UMessageDecoder::StaticClass()); Handler-&gt;SendProtoToDecoder(wrapper.get()); }); } } } } return 0; } FTCPSocketListeningTh* FTCPSocketListeningTh::RunSocketListening() { if (!Runnable &amp;&amp; FPlatformProcess::SupportsMultithreading()) { Runnable = new FTCPSocketListeningTh(); } return Runnable; } void FTCPSocketListeningTh::Shutdown() { bThreadRun = false; GLog-&gt;Log("FTCPSocketListeningTh::Shutdown()"); if (Runnable) { delete Runnable; Runnable = nullptr; } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's enable two new streams in SpikyGameInstance: </font></font><br><br><pre> <code class="cpp hljs">... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ServerStatusCheckingTh.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TCPSocketListeningTh.h"</span></span></span><span class="hljs-meta"> ... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     USpikyGameInstance::Init() //      FServerStatusCheckingTh::RunServerChecking(); //    tcp  FTCPSocketListeningTh::RunSocketListening(); //     USpikyGameInstance::Shutdown() //     FServerStatusCheckingTh::Shutdown(); //    tcp  FTCPSocketListeningTh::Shutdown();</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We implement the encoder, the prototype message arrives, in the function we determine whether to encrypt it, type it, wrap it in the Wrapper, write the length and body to the buffer, then send it via TCP or UDP channel: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Messageencoder</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2017, Vadim Petrov - MIT License #include "Spiky_Client.h" #include "MessageEncoder.h" #include "SocketObject.h" #include "Protobufs/MessageModels.pb.h" #include &lt;google/protobuf/io/zero_copy_stream_impl_lite.h&gt; #include &lt;google/protobuf/io/coded_stream.h&gt; bool UMessageEncoder::Send(google::protobuf::Message * message, bool bCrypt, bool bTCP) { Wrapper wrapper; //     if (bCrypt) { } else { if (message-&gt;GetTypeName() == "Utility") { Utility * mes = static_cast&lt;Utility*&gt;(message); wrapper.set_allocated_utility(mes); } } size_t size = wrapper.ByteSize() + 5; // include size, varint32 never takes more than 5 bytes uint8_t * buffer = new uint8_t[size]; google::protobuf::io::ArrayOutputStream arr(buffer, size); google::protobuf::io::CodedOutputStream output(&amp;arr); //       buffer output.WriteVarint32(wrapper.ByteSize()); wrapper.SerializeToCodedStream(&amp;output); //     utility if (wrapper.has_utility()) { wrapper.release_utility(); } int32 bytesSent = 0; bool sentState = false; if (bTCP) { //send by tcp sentState = USocketObject::tcp_socket-&gt;Send(buffer, output.ByteCount(), bytesSent); } else { //send by udp sentState = USocketObject::udp_socket-&gt;SendTo(buffer, output.ByteCount(), bytesSent, *USocketObject::udp_address); } delete[] buffer; return sentState; }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the server and the client, and check that the messages and the echo come through. </font><font style="vertical-align: inherit;">Server </font></font><br> <code>utility { alive: true }</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log: Client Log:</font></font><br> <code>Connect state (bIsConnection) = 1 | FServerStatusCheckingTh::CheckServer <br> Data Read! 5 | FTCPSocketListeningTh::Run</code> <br> <br><h3>  Conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So with the necessary preparation, we are done. As a result, we have a client-server communicating with protobuff messages, compiled and connected to Android and Windows libraries, and the initial architecture over which we will further expand the functionality. Finally leave the bibliography list to help you better understand Netty and the architecture of online games. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thank you for reading this place! </font></font><br><br><img src="https://habrastorage.org/web/217/ef8/812/217ef881278549d3b01b9232b06aeb37.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Norman Maurer "Netty in Action" - with Netty you can quickly and easily write any client-server application that will be easily expanded and scaled. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Glazer "Multiplayer Game Programming: Architecting Networked Games" - this book, using real examples, tells about the features of developing online games and the basics of building a robust multi-user architecture.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Grenville Armitage "Networking and Online Games: Understanding and Engineering Multiplayer Internet Games" is a fairly old book, but a good book that explains how multiplayer games work. </font></font></div><p>Source: <a href="https://habr.com/ru/post/333788/">https://habr.com/ru/post/333788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333778/index.html">Especially for Habr: interview with Alan Kay</a></li>
<li><a href="../333780/index.html">The birth of Software Tools: how and why did GREP and AWK appear</a></li>
<li><a href="../333782/index.html">Sort by bubble in Qualcomm code</a></li>
<li><a href="../333784/index.html">A! Hack Summer - Alfa-Bank hackathon 5 and 6 August 2017</a></li>
<li><a href="../333786/index.html">How we added RAM to HPE servers</a></li>
<li><a href="../333790/index.html">Asterisk func_odbc or strange ael</a></li>
<li><a href="../333792/index.html">Bluetooth SIG announces bluetooth mesh network</a></li>
<li><a href="../333794/index.html">The system of electronic queue in the banking business</a></li>
<li><a href="../333796/index.html">How to subconsciously encourage employees to comply with the project deadlines</a></li>
<li><a href="../333798/index.html">Stantinko: large-scale adware campaign, operating since 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>