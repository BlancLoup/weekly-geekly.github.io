<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Step-by-step description of the live migration of OpenVZ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have 2 HN: node1.srv.my and node2.srv.my. On node1.srv.my we have a container (service.srv.my) that has grown out of the old node and wants to grow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Step-by-step description of the live migration of OpenVZ</h1><div class="post__text post__text-html js-mediator-article">  We have 2 HN: node1.srv.my and node2.srv.my.  On node1.srv.my we have a container (service.srv.my) that has grown out of the old node and wants to grow further. <br><br>  We want to reduce the maximum downtime of the container.  How much can this be done? <br>  Answer: Depending on the tasks of the VE, there may be no downtime at all. <br><img title="Openvz_logo" alt="OpenVZ_logo" src="http://elastics.mid.ua/habr/openvz.png"><br><a name="habracut"></a><br>  For example, I have a web service (LNAMP) on service.srv.my with a highly visited site and a group of filler editors.  They have access to the site ‚Äúon record‚Äù.  In general, this is the only category of service users who will notice the move.  Okay.  Let's get started <br><br>  We will use the vzmigrate utility. <br>  1. Temporarily enable root access on the node2.srv.my server in the sshd config: <br>  <em>PermitRootLogin yes</em> - performed on node2.srv.my 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2. Create keys on node1.srv.my: <br>  <em>ssh-keygen -t rsa -b 4096</em> - executed on node1.srv.my <br><br>  We select an empty password so that they do not even ask us the password when entering by key. <br>  3. Put the key in node2.srv.my: <br>  <em>ssh-copy-id -i ~ / .ssh / id_rsa.pub root@node2.srv.my</em> - executed on node1.srv.my <br><br>  They will be asked to enter the root node2.srv.my root password for validation. <br>  4. Update the DNS for the service.srv.my zone if the IP address changes.  (In this case, it is better to reduce the TTL - minutes to 15.) <br><br>  5. Now we boldly start the migration: <br>  <em>vzmigrate -v --remove-area no --online --rsync = "- v" host_target_ip veid_service.srv.my</em> - runs on node1.srv.my <br><br>  Depending on the size and speed of the network between the nodes, it can take a long time.  It may be worth using screen if connection breaks are likely. <br>  <em>--online</em> will allow relocation without ceasing to provide services service.srv.my <br>  <em>--rsync = "- v"</em> - rsync parameters, here you can configure whether to show files that will be transferred, whether to show the progress of files. <br>  <em>--remove-area no</em> allows you to save files regardless of the success of the transfer.  To my surprise, it still did not prevent the VE from stopping.  Probably I didn‚Äôt read something. If you need to be able to quickly cancel the migration, select ‚Äìremove-area no and rename the configuration file veid.conf.migrated to veid.conf.  If you need to delete files set yes. <br>  <em>host_target_ip</em> is the IP address of node2.srv.my <br>  <em>veid_service.srv.my</em> - service VEID, for example, 301 for me. <br><br>  <em>Sometimes problems arise due to different iptables settings (http://phpsuxx.blogspot.com/2010/08/openvz-error-most-probably-some.html)</em> <br><br>  6. vzlist on node2.srv.my shows that container 301 now works here, on node1.srv.me vzlist shows that there is no container anymore (but we saved the files just in case) <br><br>  7. We may need to change the IP service.srv.my.  In this case, we change the IP in the config and restart VE (vzctl restart 301).  Alternatively, by changing the IP address by using --ipdel and --ipdel. <br><br>  Moving over <br>  People write that when moving the network is not lost: for example, the backup data from VE could merge to the backup server when moving, smoothly moving from one node to another.  But did not check. <br><img title="Migration" alt="migration" src="http://elastics.mid.ua/habr/migration.jpg"><br><br>  For a long time did not write on Habr√©.  Now I will correct this situation. </div><p>Source: <a href="https://habr.com/ru/post/144219/">https://habr.com/ru/post/144219/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144212/index.html">‚ÄúRunet today‚Äù, May 21, 2012. Experts of the issue: Sergey Spivak, Alexey Zakharov</a></li>
<li><a href="../144214/index.html">Google Chrome finally bypasses Internet Explorer in world share.</a></li>
<li><a href="../144215/index.html">MODX Revolution Test Sites</a></li>
<li><a href="../144217/index.html">.NET Subbotnik in Kiev invites listeners to SkyPoint on May 26</a></li>
<li><a href="../144218/index.html">Juniper SRX100, acquaintance</a></li>
<li><a href="../144220/index.html">Accounting control of game time</a></li>
<li><a href="../144221/index.html">Methods for evaluating a startup. Continuation</a></li>
<li><a href="../144225/index.html">Yandeks.Afisha. Xss</a></li>
<li><a href="../144226/index.html">Programmers and Ponte</a></li>
<li><a href="../144228/index.html">Facebook shares fell below the placement price</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>