<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation SVN + Apache + LDAP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to the above mentioned bundle, a lot of things are written, however, I always felt some inconveniences when setting up a new repository: it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation SVN + Apache + LDAP</h1><div class="post__text post__text-html js-mediator-article">  According to the above mentioned bundle, a lot of things are written, however, I always felt some inconveniences when setting up a new repository: it was necessary to start a new location in the configuration file, create a repository using svnadmin, restart apache.  When such work has to be done once a month is tolerable, however, when such work has to be done several times a week, you should think about automating this process.  Actually it is about this and goes under the cut. <br><br><a name="habracut"></a><br>  Looking ahead, I want to start with the configuration of apache itself. <br><br>  <b>Main configuration file /etc/httpd/conf/httpd.conf</b> <br><pre><code class="hljs lua">...... # Load <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> files from the <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> directory <span class="hljs-string"><span class="hljs-string">"/etc/httpd/conf.d"</span></span>. # Include conf.d/*.conf ......</code> </pre> <br>  Actually everything is clear here (this is the default location of configs when installing apache from standard CentOS 5.6 repositories) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>File /etc/httpd/conf.d/subversion.conf</b> <br><pre> <code class="hljs pgsql">LoadModule dav_svn_module modules/mod_dav_svn.so LoadModule authz_svn_module modules/mod_authz_svn.so LoadModule authnz_ldap_module modules/mod_authnz_ldap.so &lt;VirtualHost *:<span class="hljs-number"><span class="hljs-number">5553</span></span>&gt; ServerName svn.company.ru ServerAdmin svn_admin@company.ru DocumentRoot /opt/svn/repo LimitRequestBody <span class="hljs-number"><span class="hljs-number">2147483647</span></span> CustomLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/httpd/subversion.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> combined ErrorLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/httpd/subversion-error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> &lt;IfModule rewrite_module&gt; RewriteLogLevel <span class="hljs-number"><span class="hljs-number">0</span></span> RewriteEngine <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> RewriteCond "%{REQUEST_METHOD}" !"^(GET|POST|HEAD)$" RewriteCond "%{REQUEST_FILENAME}" "^/([^/\.]+)$" RewriteCond "/opt/svn/repo/%1" -d RewriteRule "^/([^/\.]+)$" "/$1/" [passthrough] &lt;/IfModule&gt; <span class="hljs-keyword"><span class="hljs-keyword">Include</span></span> conf.d/subversion.d<span class="hljs-comment"><span class="hljs-comment">/*.conf &lt;/VirtualHost&gt;</span></span></code> </pre><br>  This configuration file describes the repository configuration itself.  It is worth noting that we put all the locales in the configuration files in the conf.d / subversion.d directory.  Why is this necessary?  First of all, it is easier for us to keep track of which repositories are included, and secondly, we get rid of parsing the config when the script is run (see below). <br>  <b>File /etc/httpd/conf.d/subversion.d/example_repo.conf</b> <br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">Location</span></span> "/example_repo/"&gt; DAV svn SVNPath /opt/svn/repo/example_repo SVNListParentPath <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> AuthType Basic AuthName "SVN Server" AuthBasicProvider ldap AuthzLDAPAuthoritative <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> AuthLDAPBindDN "cn=ldpcat,cn=users,dc=company,dc=ru" AuthLDAPBindPassword "12345678" AuthLDAPURL ldap://ldap.company.ru:<span class="hljs-number"><span class="hljs-number">389</span></span>/ou=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>,dc=company,dc=ru?sAMAccountName?sub?(objectClass=*) AuthBasicAuthoritative <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> PROPFIND&gt; Require <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> PROFIND PROPPATCH <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> MERGE PUT POST MKCOL MKACTIVITY <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MOVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOCK</span></span> UNLOCK&gt; Require ldap-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> cn=example_group,ou=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>,dc=company,dc=ru &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span>&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Location</span></span>&gt;</code> </pre><br>  Here we specify the name and location of the repository, we specify with which account we will look at the AD directory (yes, in this case, AD is used), the password for this account, the string and the filter for the search.  Further, using the directory, we indicate that viewing the repository is allowed to all users authorized in the domain (however, you can specify a specific group in the domain).  Next, the next directory, we specify which group of users in the domain (in this case, this example_group) is allowed to perform all other actions with the repository. <br><br>  With the apache configuration, everything is clear, now let's start implementing the script with which we will create new repositories.  The script should <ol><li>  Create an empty repository </li><li>  Create configuration file for repository </li><li>  Send to the members of the group entitled to make changes to the repository, an information letter </li></ol><br><br><h5>  Let's get started </h5><br><br>  I used python version 2.7 installed from sources with the options --prefix = / opt / python2.7 --with-threads --enable-unicode = ucs4 --includedir = / usr / include --disable-ipv6.  It will also be necessary to install the python-ldap module (I used setuptools).  Below is the actual script itself. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2.7 # -*- coding: utf-8 -*- import os import ldap import ldap.sasl import sys import smtplib from email.mime.text import MIMEText server_init_file = '/etc/init.d/httpd' apache_config_dir = '/etc/httpd/conf.d/subversion.d/' repo_path = '/opt/svn/repo/' user_owner_repo = 'apache' group_owner_repo = 'apache' mail_server = 'mail.company.ru' mail_smtp_port = 25 mail_from = 'redmine@company.ru' list_mail = [ ] root_svn_url = 'http://svn.company.ru/' if len(sys.argv)&lt;=2: print u"   " print u"           " print u": addsvnrepo example_repo example_group" sys.exit() server = 'ldap://ldap' user_id = 'ldpcat' pw = '12345678' dn_search = 'OU=User,DC=company,DC=ru' repo_name = sys.argv[1] group_commit = sys.argv[2] if repo_name != None: print "  "+repo_name else: sys.exit() def main(): try: con = ldap.initialize(server) con.set_option(ldap.OPT_REFERRALS, 0) con.simple_bind_s(user_id, pw) print ' ' except ldap.INVALID_CREDENTIALS: print "    " sys.exit() except ldap.LDAPError, e: if type(e.message) == dict and e.message.has_key('desc'): print 'Error - ' + e.message['desc'] else: print 'Error - ' + str(e) sys.exit() finally: print '' search(con, group_commit) repo_create() config_write() server_reload() mailer() def search(con, group_commit): try: base_dn = 'dc=company,dc=ru' filter = "(memberOf=CN="+group_commit+","+dn_search+")" attrs = ['mail'] timeout = 3 results = con.search_s(base_dn, ldap.SCOPE_SUBTREE, filter, attrs) for dn,entry in results: if dn != None: list_mail.extend(entry['mail']) con.unbind() print list_mail print u" " except ldap.LDAPError, e: print 'Error - ' + str(e) sys.exit() def mailer(): text = u' ' text2 = repo_name text3 = u' .\n    ' text4 = root_svn_url+repo_name text5 = u'/\n  !\n' text_s = text+text2+text3+text4+text5 subj = u'  '+repo_name msg = MIMEText(text_s, "", "cp1251") msg['Subject'] = subj msg['From'] = mail_from msg['To'] = ', '.join( list_mail ) print u"  " print msg['To'] s = smtplib.SMTP(mail_server, mail_smtp_port) s.sendmail(msg['From'], list_mail, msg.as_string()) s.quit() print u"...." def repo_create(): svnadmin_create_msg = result = os.popen("svnadmin create "+repo_path+repo_name).read() print svnadmin_create_msg chmod_msg = result = os.popen("chown -R "+user_owner_repo+":"+group_owner_repo+" "+repo_path+repo_name).read() print chmod_msg def config_write(): if os.path.exists(apache_config_dir+repo_name+".conf") : print u"   " sys.exit() else: print "  ......" f1 = open(apache_config_dir+repo_name+".conf", 'w') f = open(apache_config_dir+"skeleton.tpl", 'r') body_config = f.read() f.close() f1.write(body_config.format(repo_name, repo_path, group_commit, server, dn_search)) f1.close() def server_reload(): print u' apache.......' reload_msg = result = os.popen(server_init_file+" restart").read() print reload_msg if __name__=="__main__": main()</span></span></code> </pre><br><br>  Apparently from a script, I pushed each action on separate functions.  I want to note that the configuration file for the repository is created from the skeleton.tpl template, which must be placed inside the /etc/httpd/conf.d/subversion.d directory.  Template content <br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">Location</span></span> "/{0}/"&gt; DAV svn SVNPath {<span class="hljs-number"><span class="hljs-number">1</span></span>}{<span class="hljs-number"><span class="hljs-number">0</span></span>} SVNListParentPath <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> AuthType Basic AuthName "SVN Server" AuthBasicProvider ldap AuthzLDAPAuthoritative <span class="hljs-keyword"><span class="hljs-keyword">Off</span></span> AuthLDAPBindDN "cn=ldpcat,cn=users,dc=company,dc=ru" AuthLDAPBindPassword "12345678" AuthLDAPURL {<span class="hljs-number"><span class="hljs-number">3</span></span>}/{<span class="hljs-number"><span class="hljs-number">4</span></span>}?sAMAccountName?sub?(objectClass=*) AuthBasicAuthoritative <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> PROPFIND&gt; Require <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span> PROPPATCH <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> MERGE PUT POST MKCOL MKACTIVITY <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MOVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOCK</span></span> UNLOCK&gt; Require ldap-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> cn={<span class="hljs-number"><span class="hljs-number">2</span></span>},{<span class="hljs-number"><span class="hljs-number">4</span></span>} &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Limit</span></span>&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Location</span></span>&gt;</code> </pre><br><br>  Actually everything.  However, users must provide a list of repositories through which they can get into any repository and download the file from there.  This is done in the file /etc/httpd/conf.d/subversion.conf by adding the directive SVNListParentPath On.  However, it is necessary for the menu page to look corporate.  And I called python again.  In the initialization script apache /etc/init.d/httpd, in the function start (), added the line <br> <code>/opt/svn/repo/svn_gen &gt; /opt/svn/repo/index.html</code> <br> <br>  <b>File / opt / svn / repo / svn_gen</b> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2.7 import os sdir='/opt/svn/repo/' r, d, f = os.walk(sdir).next() lb=len(d) y=0 addrrepo='http://svn.company.ru/' print "&lt;ul&gt;" while y&lt;lb: print "&lt;li&gt;" print "&lt;a href='" print addrrepo+d[y] print "/" print "'" print "&gt;" print d[y] print "&lt;/a&gt;" print "&lt;br \&gt;" y=y+1 else: print "&lt;/ul&gt;" print "&lt;hr /" print '&lt;h2&gt;PopoWeb Server running on BolgenOS Server 1.6(fundamentally new system of Denis Popov)&lt;/ h2&gt;'</span></span></code> </pre><br>  Here I specifically removed the links to css, so as not to give out the organization in which I work (the colors are painfully recognizable), but as you understand, you can implement the page to your liking.  In this case, you can also use the template, but the svn_gen script was written before I was tired of adding repositories with handles. <br><br>  What I would like to implement in the future <ul><li>  Adding configs to existing repositories </li><li>  Disconnect and connect repositories </li><li>  Listing repositories with details (disconnected / connected, which group can commit </li><li>  Import from other repositories </li><li>  Ideally, create a group and add users to it.  However, adding objects to AD is not in my area of ‚Äã‚Äãresponsibility. </li></ul><br><br>  PS Link to the archive with scripts and heatplug <a href="http://rghost.ru/17349101">addsvnrepo.tar</a> <br>  PSS The code is not perfect, so I‚Äôm glad to accept any comments. </div><p>Source: <a href="https://habr.com/ru/post/126338/">https://habr.com/ru/post/126338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126327/index.html">Will Mars be as big as the full moon in August 2011?</a></li>
<li><a href="../126328/index.html">Digest Wanted.VC # 10</a></li>
<li><a href="../126330/index.html">Another physics engine in JavaScript</a></li>
<li><a href="../126332/index.html">Two-layer project management model</a></li>
<li><a href="../126333/index.html">Tiling in 2D games on Unity, scaling material</a></li>
<li><a href="../126340/index.html">Google will buy Motorola Mobility for 12.5 billion dollars</a></li>
<li><a href="../126342/index.html">$ 20k per person: InCube launches startup accelerator</a></li>
<li><a href="../126343/index.html">Google acquired Motorola's mobile business for $ 12.5 billion</a></li>
<li><a href="../126350/index.html">Mobile communication in the hauls and stations of the Moscow metro</a></li>
<li><a href="../126351/index.html">Intervalometer from the phone: continued</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>