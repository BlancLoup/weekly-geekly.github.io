<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog engine with Phoenix and Elixir / Part 1. Introduction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: ‚Äú Elixir and Phoenix are a great example of where modern web development is heading. Already, these tools provide high-quality ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog engine with Phoenix and Elixir / Part 1. Introduction</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/7f4/291/d93/7f4291d93be44ff3bc4036e9c5012824.png"><br><br>  From the translator: ‚Äú <i>Elixir and Phoenix are a great example of where modern web development is heading.</i>  <i>Already, these tools provide high-quality access to real-time technologies for web applications.</i>  <i>Sites with increased interactivity, multiplayer browser games, microservices - those areas in which these technologies will serve a good service.</i>  <i>The following is a translation of a series of 11 articles that describe in detail the aspects of development on the Phoenix framework that would seem such a trivial thing as a blog engine.</i>  <i>But do not hurry to sulk, it will be really interesting, especially if the articles encourage you to pay attention to the Elixir or to become its followers</i> . ‚Äù <br><a name="habracut"></a><br>  At the moment, our application is based on: <br><br><ul><li>  <b>Elixir</b> : v1.3.1 </li><li>  <b>Phoenix</b> : v1.2.0 </li><li>  <b>Ecto</b> : v2.0.2 </li><li>  <b>Comeonin</b> : v2.5.2 </li></ul><br><h2>  Install Phoenix </h2><br>  The best installation instructions for Phoenix is ‚Äã‚Äãon <a href="http://www.phoenixframework.org/docs/installation">its official website</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Step 1. Adding posts </h2><br>  Let's start by running the mix task to create a new project called ‚Äú <i>pxblog</i> ‚Äù.  To do this, run the command <b>`mix phoenix.new [project] [command]`</b> .  We answer in the affirmative to all questions, as the default settings will suit us. <br><br><pre><code class="bash hljs">mix phoenix.new pxblog</code> </pre> <br>  Conclusion: <br><br><pre> <code class="bash hljs">* creating pxblog/config/config.exs ... Fetch and install dependencies? [Yn] y * running mix deps.get * running npm install &amp;&amp; node node_modules/brunch/bin/brunch build We are all <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>! Run your Phoenix application: $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> pxblog $ mix phoenix.server You can also run your app inside IEx (Interactive Elixir) as: $ iex -S mix phoenix.server Before moving on, configure your database <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> config/dev.exs and run: $ mix ecto.create</code> </pre><br>  We should see a lot of information that the creation of our project has been completed, as well as teams for the preparatory work.  Perform them one by one. <br><br>  If you have not created a Postgres database or the application is not configured to work with it, the command <b>`mix ecto.create` will</b> throw an error.  To fix it, open the <b>config / dev.exs file</b> and just change the username and password for the role that has rights to create the database: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Configure your database config :pxblog, Pxblog.Repo, adapter: Ecto.Adapters.Postgres, username: "postgres", password: "postgres", database: "pxblog_dev", hostname: "localhost", pool_size: 10</span></span></code> </pre><br>  When everything works, let's start the server and make sure that everything is fine. <br><br><pre> <code class="bash hljs">$ iex -S mix phoenix.server</code> </pre><br>  To do this, go to <a href="http://localhost:4000/">http: // localhost: 4000 /</a> and see the <b>Welcome to Phoenix</b> page <b>!</b>  .  Good foundation is ready.  Let's add to it the main scaffold for working with posts, since we still have a blog engine. <br><br>  We use the generator built into Phoenix to create an Ecto-model, a migration, and an interface for processing CRUD operations of the <b>Post</b> module.  Since at the moment this is a <i>very, very</i> simple engine, we will limit ourselves to the title and the message.  The title will be a string, and the message will be text.  The team that makes this all for us is pretty simple: <br><br><pre> <code class="bash hljs">$ mix phoenix.gen.html Post posts title:string body:text</code> </pre><br>  Conclusion: <br><br><pre> <code class="bash hljs">* creating web/controllers/post_controller.ex ... Add the resource to your browser scope <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> web/router.ex: resources <span class="hljs-string"><span class="hljs-string">"/posts"</span></span>, PostController Remember to update your repository by running migrations: $ mix ecto.migrate</code> </pre><br>  We get an error!  To fix it, and at the same time make the post interface accessible from the browser, let's open the <b>web / router.ex file</b> , and add the following line to the root-scop: <br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/posts"</span></span>, PostController</code> </pre><br>  Now we can once again execute the command and make sure that our migration was successful. <br><br><pre> <code class="bash hljs">$ mix ecto.migrate</code> </pre><br>  Conclusion: <br><br><pre> <code class="bash hljs">Compiling 9 files (.ex) Generated pxblog app 15:52:20.004 [info] == Running Pxblog.Repo.Migrations.CreatePost.change/0 forward 15:52:20.004 [info] create table posts 15:52:20.019 [info] == Migrated <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.0s</code> </pre><br>  And finally, we restart our server go to <a href="http://localhost:4000/posts">http: // localhost: 4000 / posts</a> , where we should see the <b>Listing posts</b> header, as well as a list of our posts. <br><br>  A little fidgeting, we were able to add new posts, edit them and delete.  Pretty <i>cool</i> for such a small job! <br><br><h2>  Step 1B.  Writing tests for posts </h2><br>  One of the charms of working with scaffolds is that from the very beginning we get a set of basic tests.  We don‚Äôt even need to change them much until we start making major changes to the code of the application itself.  Now let's look at what tests were created to better understand how to write your own. <br><br>  First, open the <b>test / models / post_test.exs file</b> and take a look at the contents: <br><br><pre> <code class="ruby hljs">defmodule Pxblog.PostTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.ModelCase <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Post @valid_attrs <span class="hljs-string"><span class="hljs-string">%{body: "some content", title: "some content"}</span></span> @invalid_attrs <span class="hljs-string"><span class="hljs-string">%{}</span></span> test <span class="hljs-string"><span class="hljs-string">"changeset with valid attributes"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = Post.changeset(%Post{}, @valid_attrs) assert changeset.valid? <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test <span class="hljs-string"><span class="hljs-string">"changeset with invalid attributes"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = Post.changeset(%Post{}, @invalid_attrs) refute changeset.valid? <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Let's sort this code in parts to understand what is going on here. <br><blockquote>  defmodule Pxblog.PostTest do </blockquote>  Obviously, we need to define a test module in the namespace of our application. <br><blockquote>  use Pxblog.ModelCase </blockquote>  Next, we tell this module to use the functions and DSLs presented in the <b>ModelCase</b> macro <b>set</b> . <br><blockquote>  alias Pxblog.Post </blockquote>  Now we are convinced that the test can access the model directly. <br><blockquote>  @valid_attrs% {body: ‚Äúsome content‚Äù, title: ‚Äúsome content‚Äù} </blockquote>  We configure the main valid attributes that will allow you to successfully create a <i><b>changeset</b></i> .  This is just a module level variable that we can pull every time we want to create a valid model. <br><blockquote>  @invalid_attrs% {} </blockquote>  As above, but create a set of invalid attributes. <br><blockquote><pre> test "changeset with valid attributes" do
   changeset = Post.changeset (% Post {}, @valid_attrs)
   assert changeset.valid?
 end </pre></blockquote>  Now, we directly create our test with the <b>test</b> function, giving it a string name.  Inside the body of our function, we first create a revision from the <b>Post</b> model (passing an empty structure and a list of valid parameters).  Then, using the <b>assert</b> function, we check the validity of the revision.  This is what we need the <b>@valid_attrs</b> variable <b>for</b> . <br><blockquote><pre> test "changeset with invalid attributes" do
   changeset = Post.changeset (% Post {}, @invalid_attrs)
   refute changeset.valid?
 end </pre></blockquote>  Finally, we check the creation of a revision with invalid parameters, and instead of <i>‚Äúasserting‚Äù</i> that the audit is a valid one, we perform the reverse operation <b>refute</b> . <br><br>  This is a very good example of how to write a test model.  Now let's look at the test controller.  Looking at him, we should see something like the following: <br><br><pre> <code class="ruby hljs">defmodule Pxblog.PostControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Post @valid_attrs <span class="hljs-string"><span class="hljs-string">%{body: "some content", title: "some content"}</span></span> @invalid_attrs <span class="hljs-string"><span class="hljs-string">%{}</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Here <b>Pxblog.ConnCase is</b> used to obtain the controller-specific DSL level.  The remaining lines should already be familiar. <br><br>  Let's look at the first test: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"lists all entries on index"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = get conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Listing posts"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Here we capture the variable <b>conn</b> , which must be sent via the <b>tuner</b> to <b>ConnCase</b> .  I will explain this later.  The next step is to use the function of the same name with the appropriate HTTP method to make a request on the desired path ( <b>GET request</b> to action <b>: index</b> in our case).  Then we check that the response of this action returns HTML with a status of <b>200 (‚ÄúOK‚Äù)</b> and contains the phrase <b>Listing posts</b> . <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"renders form for new resources"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = get conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  The following test is essentially the same, only the action <b>new</b> is being tested.  It's simple. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"creates resource and redirects when data is valid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> @valid_attrs assert redirected_to(conn) == post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) assert Repo.get_by(Post, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And here we are doing something new.  First, we send a POST request with a list of valid parameters to <b>post_path</b> .  We expect to receive a redirect to the list of posts (action <b>: index</b> ).  The <b>redirected_to</b> function accepts a connection object as an argument, since we need to know where the redirection occurred. <br><br>  Finally, we claim that the object represented by these valid parameters was successfully added to the database.  This check is carried out through a request to the <b>Ecto Repo</b> repository to search for the <b>Post</b> model that corresponds to our <b>@valid_attrs</b> parameters. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"does not create resource and renders errors when data is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> @invalid_attrs assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Now we will try to create a post again, but with an invalid parameter list <b>@invalid_attrs</b> , and check that the post creation form is displayed again. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"shows chosen resource"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.insert! %Post{} conn = get conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, post) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Show post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  To test the <b>show</b> action, we need to create a <b>Post</b> model, with which we will work.  Then we call the <b>get</b> function with the <b>post_path</b> helper, and make sure that the corresponding resource is returned. <br><br>  We can also try to request the path to a resource that does not exist as follows: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"renders page not found when id is nonexistent"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert_error_sent <span class="hljs-number"><span class="hljs-number">404</span></span>, fn -&gt; get conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  It uses a different test record pattern, which is actually quite simple to understand.  We describe the expectation that a request for a non-existent resource will result in error 404. We also pass in an anonymous function containing the code, which, when executed, should return this error itself.  It's simple! <br><br>  The remaining tests just repeat the above for the remaining paths.  But on the distance we will stop in more detail: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"deletes chosen resource"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.insert! %Post{} conn = delete conn, post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>, post) assert redirected_to(conn) == post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) refute Repo.get(Post, post.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In general, everything is similar, except for using the HTTP <b>delete</b> method.  We <i>state</i> that we should be redirected from the delete page back to the list of posts.  We also use a new feature here - <i>‚Äúreject‚Äù the</i> existence of the <b>Post</b> object using the <b>refute</b> function. <br><br><h2>  Step 2. Add Users </h2><br>  To create a <b>User</b> model, we will go through almost the same steps as when creating a post model, with the exception of adding other columns.  For a start, let's execute: <br><br><pre> <code class="bash hljs">$ mix phoenix.gen.html User users username:string email:string password_digest:string</code> </pre><br>  Conclusion: <br><br><pre> <code class="bash hljs">* creating web/controllers/user_controller.ex ... Add the resource to your browser scope <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> web/router.ex: resources <span class="hljs-string"><span class="hljs-string">"/users"</span></span>, UserController Remember to update your repository by running migrations: $ mix ecto.migrate</code> </pre><br>  Next, open the <b>web / router.ex file</b> and add the following line to the same scopes as before: <br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/users"</span></span>, UserController</code> </pre><br>  The syntax here defines the standard resource path, where the first argument is the URL, and the second is the name of the controller class.  Then execute: <br><br><pre> <code class="bash hljs">$ mix ecto.migrate</code> </pre><br>  Conclusion: <br><br><pre> <code class="bash hljs">Compiling 11 files (.ex) Generated pxblog app 16:02:03.987 [info] == Running Pxblog.Repo.Migrations.CreateUser.change/0 forward 16:02:03.987 [info] create table users 16:02:03.996 [info] == Migrated <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.0s</code> </pre><br>  Finally, we reboot the server and check <a href="http://localhost:4000/users">http: // localhost: 4000 / users</a> .  Now, in addition to posts, we have the ability to add users! <br><br>  Unfortunately, this is not a very useful blog yet.  In the end, even though we can create users ( <i>unfortunately, now anyone can do this</i> ), we cannot even enter.  In addition, the password digest does not use any encryption algorithms.  We stupidly store the text that the user entered!  Not cool at all! <br><br>  Let's bring this screen into a look more like a registration. <br><br>  Our user tests look exactly the same as what was automatically generated for our posts, so until we leave them alone, until we begin to modify the logic ( <i>and we‚Äôll do this right now!</i> ). <br><br><h2>  Step 3. Saving the password hash instead of the password itself </h2><br>  Having opened the address <b>/ users / new</b> , we see three fields: <i>Username</i> , <i>Email</i> and <i>PasswordDigest</i> .  But when you register on other sites, you are not asked to enter a password digest, but the password itself, along with its confirmation!  How can we fix this? <br><br>  In the <b>web / templates / user / form.html.eex file,</b> delete the following lines: <br><br><pre> <code class="ruby hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_digest</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text_input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_digest</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_tag</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_digest</span></span></span><span class="hljs-class"> %&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  And add in their place: <br><br><pre> <code class="ruby hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">, "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Password</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_tag</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class"> %&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;div </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_confirmation</span></span></span><span class="hljs-class">, "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Password</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Confirmation</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_confirmation</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">" %&gt; &lt;%= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error_tag</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password_confirmation</span></span></span><span class="hljs-class"> %&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  After updating the page (should occur automatically) enter the user data and click <i>Submit</i> . <br><br>  Oops, error: <br><br><pre> <code class="bash hljs">Oops, something went wrong! Please check the errors below.</code> </pre><br>  This is because we use the password and password confirmation fields, which the application knows nothing about.  Let's write code that solves this problem. <br><br>  Let's start by changing the schema.  In the <b>web / models / user.ex file,</b> add a couple of lines: <br><br><pre> <code class="ruby hljs">schema <span class="hljs-string"><span class="hljs-string">"users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:username</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:string</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:string</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:password_digest</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:string</span></span> timestamps <span class="hljs-comment"><span class="hljs-comment"># Virtual Fields field :password, :string, virtual: true field :password_confirmation, :string, virtual: true end</span></span></code> </pre><br>  Note the addition of two fields <b>: password</b> and <b>: password_confirmation</b> .  We declared them as virtual fields, since in fact they do not exist in our database, but they must exist as properties in the <b>User</b> structure.  It also allows you to apply transformations in our <b>changeset</b> function. <br><br>  Then we add <b>: password</b> and <b>: password_confirmation</b> to the list of required fields: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct, params \\ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> struct <span class="hljs-params"><span class="hljs-params">|&gt; cast(params, [:username, :email, :password, :password_confirmation]) |</span></span>&gt; validate_required([<span class="hljs-symbol"><span class="hljs-symbol">:username</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:password</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:password_confirmation</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  If you now try to run tests from the file <b>test / models / user_test.exs</b> , then the <i>‚Äúchangeset with valid attributes‚Äù</i> test will fall.  This is because we added <b>: password</b> and <b>: password_confirmation</b> to the required parameters, but did not update <b>@valid_attrs</b> .  Let's change this line: <br><br><pre> <code class="ruby hljs">@valid_attrs <span class="hljs-string"><span class="hljs-string">%{email: "[email protected]", password: "test1234", password_confirmation: "test1234", username: "testuser"}</span></span></code> </pre><br>  Our model tests must pass again!  Now we need to repair the tests of the controllers  Let's make some changes to the <b>test / controllers / user_controller_test.exs file</b> .  First, select the valid attributes to create an object in a separate variable: <br><br><pre> <code class="ruby hljs">@valid_create_attrs <span class="hljs-string"><span class="hljs-string">%{email: "[email protected]", password: "test1234", password_confirmation: "test1234", username: "testuser"}</span></span> @valid_attrs <span class="hljs-string"><span class="hljs-string">%{email: "[email protected]", username: "testuser"}</span></span></code> </pre><br>  Then change our user creation test: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"creates resource and redirects when data is valid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, user_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> @valid_create_attrs assert redirected_to(conn) == user_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) assert Repo.get_by(User, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And the user update test: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"updates chosen resource and redirects when data is valid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = Repo.insert! %User{} conn = put conn, user_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, user), <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> @valid_create_attrs assert redirected_to(conn) == user_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, user) assert Repo.get_by(User, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  After our tests <b>turn</b> green again, we need to add a function to the <b>changeset</b> that converts the password into a digest: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct, params \\ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> struct <span class="hljs-params"><span class="hljs-params">|&gt; cast(params, [:username, :email, :password, :password_confirmation]) |</span></span>&gt; validate_required([<span class="hljs-symbol"><span class="hljs-symbol">:username</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:password</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:password_confirmation</span></span>]) <span class="hljs-params"><span class="hljs-params">|&gt; hash_password </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> defp hash_password(changeset) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> changeset |</span></span>&gt; put_change(<span class="hljs-symbol"><span class="hljs-symbol">:password_digest</span></span>, <span class="hljs-string"><span class="hljs-string">"ABCDE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  For now, we simply stabilize the behavior of our hashing function.  First of all, let's make sure that the revision change happens correctly.  Let's go back to the browser at <a href="http://localhost:4000/users">http: // localhost: 4000 / users</a> , click on the <i>New user</i> link and create a new user with any data.  Now a new line awaits us in the list of users, in which the password digest is <i>ABCDE</i> . <br><br>  Run the tests for this file again.  They pass, but there is not enough test to test the function <b>hash_password</b> .  Let's add: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"password_digest value gets set to a hash"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = User.changeset(%User{}, @valid_attrs) assert get_change(changeset, <span class="hljs-symbol"><span class="hljs-symbol">:password_digest</span></span>) == <span class="hljs-string"><span class="hljs-string">"ABCDE"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This is a big step forward for the application, but not so much for safety!  We need to fix the password hashing for the present with the use of <b>BCrypt</b> , kindly provided by the <b>Comeonin</b> library. <br><br>  To do this, open the <b>mix.exs</b> file and add <b>: comeonin</b> to the <b>applications</b> list: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mod</span></span></span><span class="hljs-function">: {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pxblog</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">[]</span></span></span><span class="hljs-function">}, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applications</span></span></span><span class="hljs-function">: [:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phoenix</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phoenix_pubsub</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phoenix_html</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cowboy</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logger</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gettext</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phoenix_ecto</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postgrex</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">comeonin</span></span></span><span class="hljs-function">]] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  We also need to change our dependencies.  Pay attention to <b>{: comeonin, ‚Äú~&gt; 2.3‚Äù}</b> : <br><br><pre> <code class="ruby hljs">defp deps <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [{<span class="hljs-symbol"><span class="hljs-symbol">:phoenix</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.2.0"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:phoenix_pubsub</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:phoenix_ecto</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 3.0"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:postgrex</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;= 0.0.0"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:phoenix_html</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 2.6"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:phoenix_live_reload</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:dev</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:gettext</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 0.11"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:cowboy</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}, {<span class="hljs-symbol"><span class="hljs-symbol">:comeonin</span></span>, <span class="hljs-string"><span class="hljs-string">"~&gt; 2.3"</span></span>}] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Now turn off the running server and run the command <b>`mix deps.get`</b> .  If everything goes well ( <i>and it should!</i> ), Then the command <b>`iex -S mix phoenix.server`</b> you can again start the server. <br><br>  Our old <b>hash_password</b> method <b>is</b> <i>not bad</i> , but generally we need the password to be hashed.  Since we have added the <b>Comeonin</b> library, which provides us with an excellent <b>Bcrypt</b> module with the <b>hashpwsalt</b> method, which we import into our <b>User</b> model.  In the <b>web / models / user.ex file,</b> add the line below right after the <b>use of Pxblog.Web,: model</b> : <br><br><pre> <code class="ruby hljs">import Comeonin.Bcrypt, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">hashpwsalt:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>]</code> </pre><br>  What have we done now?  We pulled the <b>Bcrypt</b> module out of the <b>Comeonin</b> namespace and imported the <b>hashpwsalt</b> method with the arity of 1. And with the following code, we make the <b>hash_password</b> function work: <br><br><pre> <code class="ruby hljs">defp hash_password(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> password = get_change(changeset, <span class="hljs-symbol"><span class="hljs-symbol">:password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset <span class="hljs-params"><span class="hljs-params">|&gt; put_change(:password_digest, hashpwsalt(password)) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> changeset </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>  I suggest trying to create a user again!  This time, after registration, we should see an encrypted digest in the <b>password_digest</b> field! <br><br>  Now let's modify the <b>hash_password</b> function a <b>little</b> .  First, in order for password encryption not to inhibit testing, it is necessary to make changes to the settings of the test environment.  To do this, open the <b>config / test.exs file</b> and add the following line to the bottom: <br><br><pre> <code class="ruby hljs">config <span class="hljs-symbol"><span class="hljs-symbol">:comeonin</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">bcrypt_log_rounds:</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br>  This will tell <b>Comeonin</b> not to encrypt the password too much during the execution of tests, because in tests, speed is more important to us than security!  And in production (the <b>config / prod.exs file</b> ), on the contrary, we need to strengthen the protection: <br><br><pre> <code class="ruby hljs">config <span class="hljs-symbol"><span class="hljs-symbol">:comeonin</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">bcrypt_log_rounds:</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span></code> </pre><br>  Let's write a test to call <b>Comeonin</b> .  We will make it less detailed, as we just want to make sure that the encryption works.  In the <b>test / models / user_test.exs file</b> : <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"password_digest value gets set to a hash"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = User.changeset(%User{}, @valid_attrs) assert Comeonin.Bcrypt.checkpw(@valid_attrs.password, Ecto.Changeset.get_change(changeset, <span class="hljs-symbol"><span class="hljs-symbol">:password_digest</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  To improve test coverage, let's consider the case where the line <b>`if the password = get_change () is</b> not true: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"password_digest value does not get set if password is nil"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = User.changeset(%User{}, <span class="hljs-string"><span class="hljs-string">%{email: "[email protected]", password: nil, password_confirmation: nil, username: "test"}</span></span>) refute Ecto.Changeset.get_change(changeset, <span class="hljs-symbol"><span class="hljs-symbol">:password_digest</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In this case, the <b>password_digest</b> field must remain empty, which is what happens!  We do a good job covering our code with tests! <br><br><h2>  Step 4. Let's get in! </h2><br>  Add a new <b>SessionController</b> controller and a related <b>SessionView view</b> .  Let's start with a simple, and eventually we will come to a more correct implementation. <br><br>  Create a <b>web / controllers / session_controller.ex</b> file: <br><br><pre> <code class="ruby hljs">defmodule Pxblog.SessionController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.Web, <span class="hljs-symbol"><span class="hljs-symbol">:controller</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, _params)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> render conn, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  As well as <b>web / views / session_view.ex</b> : <br><br><pre> <code class="ruby hljs">defmodule Pxblog.SessionView <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.Web, <span class="hljs-symbol"><span class="hljs-symbol">:view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And finally <b>web / templates / session / new.html.eex</b> : <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Add the following line to the scop <b>"/"</b> : <br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/sessions"</span></span>, SessionController, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>]</code> </pre><br>  Thus, we include our new controller in the router.  The only path we need now is <b>new</b> , which we explicitly specify.  Again, we need to get the most stable foundation with the most simple methods. <br><br>  Going to <a href="http://localhost:4000/sessions/new">http: // localhost: 4000 / sessions / new</a> , we should see the <b>Login</b> subtitle under the heading <b>Phoenix framework</b> . <br><br>  Add this form here.  To do this, create a file <b>web / templates / session / form.html.eex</b> : <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form_for</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">changeset</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">&gt;</span></span> %&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">f.errors</span></span></span><span class="hljs-tag"> != </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">[]</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"alert alert-danger"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Oops, something went wrong! Please check the errors below:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag"> {</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">attr</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">} &lt;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">f.errors</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">humanize</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">attr</span></span></span><span class="hljs-tag">) %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span>Username<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">text_input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:username</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form-control</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span>Password<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password_input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:password</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form-control</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">submit</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Submit</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-primary</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre><br>  And let's just create a form in the <b>web / templates / session / new.html.eex file</b> with just one line: <br><br><pre> <code class="ruby hljs">&lt;%= render <span class="hljs-string"><span class="hljs-string">"form.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> @changeset, <span class="hljs-symbol"><span class="hljs-symbol">action:</span></span> session_path(@conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>) %&gt;</code> </pre><br>  Thanks to the automatic reload of the code, an error will appear on the page, since we have not yet defined the <b>@changeset</b> variable, which, as you might guess, should be a revision.  Since we are working with an object that has fields <b>: name</b> and <b>: password</b> , let's use them! <br><br>  In the <b>web / controllers / session_controller.ex</b> file, we need to add an alias of the <b>User</b> model so that we can safely access it further.  At the top of our class, just below the line <b>use Pxblog.Web,: controller</b> add the following: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User</code> </pre><br>  And in the <b>new</b> function, change the render call, as shown below: <br><br><pre> <code class="ruby hljs">render conn, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> User.changeset(%User{})</code> </pre><br>  We must pass here the connection object, the template that we want to render (without the eex extension) and a list of additional variables that will be used inside the template.  In this case, we need to specify a <b>changeset:</b> and pass it an <b>Ecto</b> revision for <b>User</b> with an empty user structure. <br><br>  Update the page.  Now we should see another error that looks like this: <br><br><pre> <code class="bash hljs">No helper clause <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Pxblog.Router.Helpers.session_path/2 defined <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> action :create. The following session_path actions are defined under your router: *:new</code> </pre><br>  In our form, we refer to a path that does not yet exist.  We use the <b>session_path</b> helper, passing it the <b>@conn</b> object, but then we specify the path <b>: create</b> , which is yet to be created. <br><br>  Half way passed.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's implement the real login feature using the session. </font><font style="vertical-align: inherit;">For this we change our ways. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / router.ex file,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> include </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: create</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SessionController</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> description </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/sessions"</span></span>, SessionController, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>]</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / controllers / session_controller.ex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> import function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checkpw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of module </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bcrypt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comeonin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="ruby hljs">import Comeonin.Bcrypt, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">checkpw:</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This line says </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúImport only the checkpw function with arity 2" from the Comeonin.Bcrypt module</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And then connect the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scrub_params</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plug </font><b><font style="vertical-align: inherit;">-</font></b><font style="vertical-align: inherit;"> in that will work with user data. Add to our functions:</font></font><br><br><pre> <code class="ruby hljs">plug <span class="hljs-symbol"><span class="hljs-symbol">:scrub_params</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>]</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scrub_params</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a special function that clears user input. In the case when, for example, an attribute is passed as an empty string, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scrub_params will</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> convert it to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to avoid creating records with empty rows in the database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next we add a function to handle the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> action </font><font style="vertical-align: inherit;">. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Place</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it at the bottom of the </font><b><font style="vertical-align: inherit;">SessionController</font></b><font style="vertical-align: inherit;"> module </font><font style="vertical-align: inherit;">. There will be a lot of code here, so let's break it down in parts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / controllers / session_controller.ex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"user" =&gt; user_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Repo.get_by(User, <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> user_params[<span class="hljs-string"><span class="hljs-string">"username"</span></span>]) <span class="hljs-params"><span class="hljs-params">|&gt; sign_in(user_params["password"], conn) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>    <b>Repo.get_by(User, username: user_params[‚Äúusername‚Äù])</b>    <b>User</b>    <b>Ecto Repo</b> ,  <b>username</b>    <b>nil</b> . <br><br>    ,    : <br><br><pre> <code class="hljs pgsql">iex(<span class="hljs-number"><span class="hljs-number">3</span></span>)&gt; Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, username: "flibbity") [<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u0."id", u0."username", u0."email", u0."password_digest", u0."inserted_at", u0."updated_at" <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> "users" <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> u0 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (u0."username" = <span class="hljs-meta"><span class="hljs-meta">$1</span></span>) ["flibbity"] OK query=<span class="hljs-number"><span class="hljs-number">0.7</span></span>ms nil iex(<span class="hljs-number"><span class="hljs-number">4</span></span>)&gt; Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, username: "test") [<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u0."id", u0."username", u0."email", u0."password_digest", u0."inserted_at", u0."updated_at" <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> "users" <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> u0 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (u0."username" = <span class="hljs-meta"><span class="hljs-meta">$1</span></span>) ["test"] OK query=<span class="hljs-number"><span class="hljs-number">0.8</span></span>ms %Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>{__meta__: %Ecto.<span class="hljs-keyword"><span class="hljs-keyword">Schema</span></span>.Metadata{source: "users", state: :loaded}, email: "test", id: <span class="hljs-number"><span class="hljs-number">15</span></span>, inserted_at: %Ecto.DateTime{day: <span class="hljs-number"><span class="hljs-number">24</span></span>, hour: <span class="hljs-number"><span class="hljs-number">19</span></span>, min: <span class="hljs-number"><span class="hljs-number">6</span></span>, month: <span class="hljs-number"><span class="hljs-number">6</span></span>, sec: <span class="hljs-number"><span class="hljs-number">14</span></span>, usec: <span class="hljs-number"><span class="hljs-number">0</span></span>, year: <span class="hljs-number"><span class="hljs-number">2015</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: nil, password_confirmation: nil, password_digest: "$2b$12$RRkTZiUoPVuIHMCJd7yZUOnAptSFyM9Hw3Aa88ik4erEsXTZQmwu2", updated_at: %Ecto.DateTime{day: <span class="hljs-number"><span class="hljs-number">24</span></span>, hour: <span class="hljs-number"><span class="hljs-number">19</span></span>, min: <span class="hljs-number"><span class="hljs-number">6</span></span>, month: <span class="hljs-number"><span class="hljs-number">6</span></span>, sec: <span class="hljs-number"><span class="hljs-number">14</span></span>, usec: <span class="hljs-number"><span class="hljs-number">0</span></span>, year: <span class="hljs-number"><span class="hljs-number">2015</span></span>}, username: "test"}</code> </pre><br>    ,        <b>sign_in</b> .       ,      ! <br><br><pre> <code class="ruby hljs">defp sign_in(user, password, conn) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_nil(user) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:error, "Invalid username/password combination!") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp sign_in(user, password, conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checkpw(password, user.password_digest) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_session(:current_user, %{id: user.id, username: user.username}) |</span></span>&gt; put_flash(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Sign in successful!"</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; redirect(to: page_path(conn, :index)) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> conn |</span></span>&gt; put_session(<span class="hljs-symbol"><span class="hljs-symbol">:current_user</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:error, "Invalid username/password combination!") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main thing to pay attention to is the order in which these functions are defined. The first of them has a protection condition, therefore this method will be performed only in the case of the truth of this condition. So if we didn‚Äôt find the user, we‚Äôll redirect back to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root_path</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the appropriate message. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second function will handle all other scripts (when the guard condition is false). We check the password with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checkpw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. If it is correct, then we write the user to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session variable </font><font style="vertical-align: inherit;">and redirect with a message about successful login. Otherwise, we clear the current user session, set the error message, and redirect to the root.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can go to </font></font><a href="http://localhost:4000/sessions/new"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // localhost: 4000 / sessions / new</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and check how it works. </font><font style="vertical-align: inherit;">With the correct data we will go inside, and with the wrong we get an error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also need to write tests for this controller. </font><font style="vertical-align: inherit;">Create a file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test / controllers / session_controller_test.exs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and fill it with the following code:</font></font><br><br><pre> <code class="ruby hljs">defmodule Pxblog.SessionControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> User.changeset(%User{}, <span class="hljs-string"><span class="hljs-string">%{username: "test", password: "test", password_confirmation: "test", email: "[email protected]"}</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; Repo.insert {:ok, conn: build_conn()} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "shows the login form", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> conn = get conn, session_path(conn, :new) assert html_response(conn, 200) =~ "Login" </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "creates a new user session </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params"> a valid user", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> conn = post conn, session_path(conn, :create), user: %{username: "test", password: "test"} assert get_session(conn, :current_user) assert get_flash(conn, :info) == "Sign </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span><span class="hljs-params"> successful!" assert redirected_to(conn) == page_path(conn, :index) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "does </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">not</span></span></span><span class="hljs-params"> create a session with a bad login", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> conn = post conn, session_path(conn, :create), user: %{username: "test", password: "wrong"} refute get_session(conn, :current_user) assert get_flash(conn, :error) == "Invalid username/password combination!" assert redirected_to(conn) == page_path(conn, :index) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "does </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">not</span></span></span><span class="hljs-params"> create a session </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> user does </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">not</span></span></span><span class="hljs-params"> exist", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> conn = post conn, session_path(conn, :create), user: %{username: "foo", password: "wrong"} assert get_flash(conn, :error) == "Invalid username/password combination!" assert redirected_to(conn) == page_path(conn, :index) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start with the standard </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">and a fairly basic GET request check. </font><font style="vertical-align: inherit;">The creation test looks more interesting:</font></font><br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"creates a new user session for a valid user"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, session_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">%{username: "test", password: "test"}</span></span> assert get_session(conn, <span class="hljs-symbol"><span class="hljs-symbol">:current_user</span></span>) assert get_flash(conn, <span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>) == <span class="hljs-string"><span class="hljs-string">"Sign in successful!"</span></span> assert redirected_to(conn) == page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first line is to send a POST request for the session creation path. </font><font style="vertical-align: inherit;">Then there are checks whether the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session variable was set </font><font style="vertical-align: inherit;">, a login message appeared, and finally, whether the redirection took place. </font><font style="vertical-align: inherit;">In the rest of the tests, we also check other ways where the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sign_in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function can go </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Again, everything is very simple!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Step 5. Improving our current_user </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's change the main template so that it displays either the username or a link to the input, depending on whether the user is logged in or not. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, </font><font style="vertical-align: inherit;">add a helper to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / views / layout_view.ex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">, which will make it easier to get information about the current user:</font></font><br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Plug.Conn.get_session(conn, <span class="hljs-symbol"><span class="hljs-symbol">:current_user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now open the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / templates / layout / app.html.eex file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font><font style="vertical-align: inherit;">add the following </font><font style="vertical-align: inherit;">instead of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get Started</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> link </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">current_user(@conn)</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> Logged in as <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user.username</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Log</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">session_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:delete</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user.id</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:delete</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Log</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">session_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:new</span></span></span><span class="hljs-tag">) %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's break it down again in steps. One of the first things we need to do is find out who the current user is, assuming that he is already logged in. First, we will make a decision in the forehead, and we will deal with refactoring later. Install the user from the session directly in our template. The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_session</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">is part of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the user is logged in, we need to show him a link to the output. We will treat the session as a normal resource, so to exit, we will simply delete the session using the link to this action. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also need to display the name of the current user. We store the user structure in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session variable </font><font style="vertical-align: inherit;">, so we have the opportunity to get </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">username</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user.username</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we could not find the user, then simply show the link to the entrance. </font><font style="vertical-align: inherit;">Here, we again consider the session as a resource, so </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will provide the correct way to create a new session. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You probably noticed that after updating the page we get another message with an error about the missing function. </font><font style="vertical-align: inherit;">Let's connect the required path to make Phoenix happy! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / router.ex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file, </font><b><font style="vertical-align: inherit;">we also</font></b><font style="vertical-align: inherit;"> add to the session routes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: delete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/sessions"</span></span>, SessionController, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>]</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Still need to change the controller. </font><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web / controllers / session_controller.ex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file, </font><font style="vertical-align: inherit;">add the following:</font></font><br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, _params)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; delete_session(:current_user) |</span></span>&gt; put_flash(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Signed out successfully!"</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; redirect(to: page_path(conn, :index)) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since we have just deleted the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> key </font><font style="vertical-align: inherit;">, it doesn‚Äôt matter what parameters come in, so we mark them with an underscore at first as unused. We also set a message about a successful exit and redirected to the list of posts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we can log in, log out and check for unsuccessful logins. Everything goes for the better! But first we need to write a few tests. We will start with tests for our </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LayoutView</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The first thing we are going to do is to set aliases for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LayoutView</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modules </font><font style="vertical-align: inherit;">to shorten the code. Next, in the setup block, we create a user and add it to the database. And then return the standard tuple </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{: ok, conn: build_conn ()}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="ruby hljs">defmodule Pxblog.LayoutViewTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Pxblog.ConnCase, <span class="hljs-symbol"><span class="hljs-symbol">async:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.LayoutView <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> User.changeset(%User{}, <span class="hljs-string"><span class="hljs-string">%{username: "test", password: "test", password_confirmation: "test", email: "[email protected]"}</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; Repo.insert {:ok, conn: build_conn()} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "current user returns the user </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span><span class="hljs-params"> the session", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> conn = post conn, session_path(conn, :create), user: %{username: "test", password: "test"} assert LayoutView.current_user(conn) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> test "current user returns nothing </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> there is no user </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span><span class="hljs-params"> the session", %{conn: conn} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> user = Repo.get_by(User, %{username: "test"}) conn = delete conn, session_path(conn, :delete, user) refute LayoutView.current_user(conn) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now consider the tests themselves. </font><font style="vertical-align: inherit;">In the first of these, we create a session and state that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LayoutView.current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">should return certain data. </font><font style="vertical-align: inherit;">In the second we will consider the opposite situation. </font><font style="vertical-align: inherit;">We explicitly delete the session and refute that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">returns the user. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also added a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> action </font><font style="vertical-align: inherit;">to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SessionController</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , therefore, we also need to write a test for this:</font></font><br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"deletes the user session"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = Repo.get_by(User, <span class="hljs-string"><span class="hljs-string">%{username: "test"}</span></span>) conn = delete conn, session_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>, user) refute get_session(conn, <span class="hljs-symbol"><span class="hljs-symbol">:current_user</span></span>) assert get_flash(conn, <span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>) == <span class="hljs-string"><span class="hljs-string">"Signed out successfully!"</span></span> assert redirected_to(conn) == page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we make sure that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current_user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the session is empty, and also we check the returned flash message and redirection. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On it the first part came to an end.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An important conclusion from the translator </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have done a great job of translating both this article and the translation of the entire series. </font><font style="vertical-align: inherit;">What I continue to do now. </font><font style="vertical-align: inherit;">Therefore, if you liked the article itself or initiatives in popularizing Elixir in runet, please support the article with pluses, comments and reposts. </font><font style="vertical-align: inherit;">This is incredibly important both for me personally and for the whole </font></font><a href="http://wunsh.ru/%3Futm_source%3Dhabrahabr%26utm_medium%3Dcontent%26utm_campaign%3Dblog-phoenix-1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir community</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a whole.</font></font><br><br><h2>  Other series articles </h2><br><ol><li>  Introduction </li><li>  <a href="https://habrahabr.ru/post/313482/">Authorization</a> </li><li>  <a href="https://habrahabr.ru/post/315252/">Adding Roles</a> </li><li>  <a href="https://habrahabr.ru/post/316368/">Process roles in controllers</a> </li><li>  <a href="https://habrahabr.ru/post/316996/">We connect ExMachina</a> </li><li>  <a href="https://habrahabr.ru/post/317550/">Markdown support</a> </li><li>  <a href="https://habrahabr.ru/post/318790/">Add comments</a> </li><li>  <a href="https://habrahabr.ru/post/323462/">We finish with comments</a> </li><li>  <a href="https://habrahabr.ru/post/332094/">Channels</a> </li><li>  <a href="https://habrahabr.ru/post/333020/">Channel testing</a> </li><li>  <a href="https://habrahabr.ru/post/335048/">Conclusion</a> </li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About all inaccuracies, errors, poor translation, please write personal messages, I will promptly correct. </font><font style="vertical-align: inherit;">Thanks in advance to everyone involved.</font></font></div><p>Source: <a href="https://habr.com/ru/post/311088/">https://habr.com/ru/post/311088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311070/index.html">Partner Workshop "1C" - Open Sunday - the full program is available.</a></li>
<li><a href="../311076/index.html">Internet of things security: progress, hype and headache</a></li>
<li><a href="../311078/index.html">Development in InterSystems Cach√© in your favorite IDE</a></li>
<li><a href="../311084/index.html">Taming asynchronous processes in Android with RxJava. Yandex experience</a></li>
<li><a href="../311086/index.html">NanoFL: Brief Feature Description</a></li>
<li><a href="../311090/index.html">MapReduce in Qt Concurrent</a></li>
<li><a href="../311092/index.html">‚ÄúTrue, true truth and statistics‚Äù or ‚Äú15 probability distributions for all occasions‚Äù</a></li>
<li><a href="../311094/index.html">Yield: what, where and why</a></li>
<li><a href="../311096/index.html">Javascript frameworks: there should be only one</a></li>
<li><a href="../311098/index.html">Logeek Night in Voronezh</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>