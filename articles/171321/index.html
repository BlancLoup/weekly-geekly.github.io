<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ZFS Filer for Cloud Infrastructure - NexentaStor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In connection with the change of Hostkey from the main data center from Stordata to Megaphone and the transfer of the main virtualization site and tra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ZFS Filer for Cloud Infrastructure - NexentaStor</h1><div class="post__text post__text-html js-mediator-article">  In connection with the change of <a href="http://www.hostkey.ru/">Hostkey from the</a> main data center from Stordata to Megaphone and the transfer of the main virtualization site and transition to Server 2012 for Windows, we had to create a new high-performance filer for issuing iSCSI / NFS / SMB cluster targets and our clients to organize private clouds / clusters.  We chose and implemented <a href="http://www.nexenta.com/">NexentaStor</a> and this is what came out of it and how we did it. <br><a name="habracut"></a><br>  Last Friday, we talked about the experience with the deployment of 180 <a href="http://www.solusvm.com/">UPUs</a> via <a href="http://www.solusvm.com/">SolusVM</a> , which we all liked except for the lack of a fine allocation of resources.  That is what was important for us to ensure continuous maintenance of a cluster based on KVM with Linux, and on Hyper-V Windows Server 2012. <br><br>  For the last 2 years we have worked with varying success at Starwind.  The variable success lay in the fact that the high-available cluster of two equivalent filers for Hyper-V (as planned) had to be forgotten - it fell apart once a week.  As a result, it became more or less reliable to work only with the main and backup, where asynchronous replication took place.  Using the MPIO settings, we discarded the Hyper-V cluster to use the backup filer in all cases except crashes, but sometimes the targets themselves slipped into the archive filer. <br><br>  Another disadvantage is that you cannot do ANYTHING with the already created volume: neither migrate, expand, change settings, etc.  If the volume has a size of about 8 TB and under constant load from 1000 to 2000 IOPS, this is a problem, and each migration is a nightmare admin with a monthly preparation and replacement servers.  All sorts of stuff like resynchronization which takes about 3 days, blue screens of death, unstable deduplication, etc.  leave out the brackets.  Attempts to get to the bottom of the problem through support - a dead number, send logs and silence or vague answer not reflecting the essence of the phenomenon.  Any version upgrade == reload target == 2-3 days resync == nightmare. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The system works on Windows Server 2008 Standard edition.  2 cars, 2 processors, ~ 2000 rubles per month for SPLA each.  48,000 rubles a year.  Support for our HA license for 8TB is still about 60000r.  Total base most TCO about 100000r per year. <br><br><h2>  Nexenta </h2><br>  We have been looking for an alternative for a long time and began to look closely at the NexentaStor system based on ZFS / Open Solaris (yes, I know that Solaris is not quite open there, this is not about that).  Nexenta had a competent small local partner who helped us set everything up, suggested the desired configuration and set everything up as expected.  It took about a month for everything from the start of tests to launch. <br><br>  I will not touch the theory of ZFS, about this written mass posts. <br><br>  Just want to say - HCL (Hardware compatibility list) is our everything.  Do not even try to put there something not described in it, there will be no happiness.  As a hoster with a fleet of 1000 of our cars, it was relatively easy for us - we climbed into a wardrobe with spare parts or a free server and took out an alternative part.  Corporate client will not be easy in case of an error.  Solaris does not have such a mass of drivers as other popular OS. <br>  The license for 8TB and support cost us $ 1,700, there is a free version without support for 18TB.  All the same, but without useful and necessary plug-ins.  TCO - only support contract, about 30000r per year.  We save from scratch 70000r. <br><br>  The result of our collaboration was the server of the following configuration: <br><br><h2>  Materiel </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/600/818/329/600818329f6c177d1d5a7afff557be4d.jpg" alt="image"><br><br>  Special file <a href="http://www.supermicro.com/products/chassis/4u/847/sc847e16-r1k28lp.cfm">Supermicro, SuperChassis 847E16</a> . <br><br>  4U, redundant power supply, 36 3.5 ‚Äùhot-swap drives on both sides, 2 high-quality backplanes, large swappable fans and space for a standard mother with 8 low-profile expansion cards. <br>  Motherboard Supermicro, 2x s1366, 6xPCIe 8x, 2xSAS 2.0, 2x Xeon E5520 processors, 192Gb DDR3 LV RAM. <br>  3 controllers LSI HBA LSI9211-8i - Nexente need disks themselves, no RAID <br>  1 LSI HBA controller LSI9200-8e - for expansion by disk shelves on SAS. <br>  1 Adaptec controller for 4 ports for connecting SSD <br>  1 10G Intel 520 Network Adapter with 2 SFP + ports; we work with a switch through copper modules directly connected through it <br><br>  Wheels - 35xHitachi Ultrastar SAS 300Gb 15K <br>  One port is occupied by an AgeStar hot-box with two small 2.5 ‚ÄùSSD drives for storing ZFS logs (ZIL), consumable, you need to easily and easily change (and the box is included in the 3.5‚Äù case slot as your own).  The box is connected to Adaptek. <br>  One SSD on a 300Gb server class Intel 710 is the central ZFS cache.  Household are not suitable, fade at times.  Connected to Adaptek. <br>  Nexenta has a cache in RAM and keeps in memory a deduplication table and metadata.  The more memory the better.  We set the maximum, 12x16Gb = 192. <br>  The budget of the event: ~ 350 000 rub. <br><br><h2>  network </h2><br><br>  We have 2 Gigabit ports and 2 10G ports on the Intel 520 controller on the motherboard. 10G ports are connected to a Cisco 2960S switch - 24 1G ports and 2 10G, SFP + ports (~ 90000r).  They are connected via copper SFP + direct connect, it is inexpensive - about 1000r per meter cord with SFP + connectors. <br>  In the near future, an Extreme Summit 640 switch with 48 ports of 10G SFP + (~ 350000r) will arrive to us, then we will overlay the filer and rebuild it, and use Tsiska to reduce it by 1G. <br><img src="https://habrastorage.org/getpro/habr/post_images/bf1/5f5/6a9/bf15f56a9acb978a18a589e29cc86ab2.jpg" alt="image"><br><br><h2>  Features disk breakdown </h2><br>  As it turned out, the most reliable way is an analogue of RAID50, triples of disks are going to RAIDZ1 and are added together to the common disk pool.  They add a certain number of disks for hot swapping.  As you know, ZFS has a special method, scrub read, which in its free time compares the actual contents of the disk with the checksums of the blocks, and if it finds the difference, it immediately fixes it.  If there are many errors, the disk goes out of the array, a backup is put in its place. <br><img src="https://habrastorage.org/storage2/02e/133/5c4/02e1335c4baad8e9bc285136ffaa3e73.png"><br><br><h2>  Control </h2><br><img src="https://habrastorage.org/storage2/734/275/2b7/7342752b7e9d630c3a77744b4a5b63ab.png"><br>  Simple work through an intuitive web interface.  There is a console with a simple syntax and the usual ZFS control commands.  In web statistics, generating iSCSI / NSF / SMB targets, creating mount points and managing them.  This is where the most important thing is why we took Nexent - thin provisioning &amp; deduplication.  For us in the world of virtualization, deduplication is all - in each of the hundreds of Windows IPS 10GB, the places are almost the same.  In Nexent, they come together at the block level. <br><br>  Further, customers order large disks for virutalok and do not use them completely.  Average usage with OS is about 15G.  In Nexent, we can make a virtual iSCSI target (shared iSCSI mount point) with an arbitrary size, for example, 500T.  It does not affect the use of disks, as new data appears there - the place is consumed. <br><br>  The capacity of the pool can be expanded at any time by adding new disks.  This is not a dramatic event when expanding RAID6 with a capacity of 10Tb on a traditional controller, you simply add more disks and the system starts using them.  Nothing is rebuilt, the data does not move anywhere. <br><br>  Nexenta provides complete statistics on how she feels and works - here is the data on processor load, network interfaces, memory, cache, disk breakdown, IOPS on drives / targets, etc. <br><img src="https://habrastorage.org/storage2/049/e77/18a/049e7718a824c2849e0a542278fd9fe4.png"><br><br><h2>  Backup </h2><br>  The nature of ZFS is the simplicity of snapshots.  The system is able to take pictures from the mount points at a specified interval and add them to external storage.  You can do asynchronous replication on a side by side.  The virtual machines themselves can be backed up with the means of the virilization system used. <br><br><h2>  Performance </h2><br>  Yes, 10G and multi-tiered storage work almost wonders.  We received tests from the stand of Windows 2008 Standard edition with a regular iSCSI initiator and a Qlogic card with a delay of about 2-4 ms, linear transfers of about 700-800 MB per second and more than 31000 IOPS for reading with a queue depth of 16 requests.  There were about 25,000 IOPS entries, but in our mass virtualization environment, reading to the record is about 1 to 10. In one line, we have about 3000 IOPS.  The file size for tests does not affect the speed, you can at least make it 1T. <br>  As the disks are filled and the load increases, we will add more disks, which will add speed and space. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3f/5b7/6f3/b3f5b76f34b1b39b5d5ceea441487dcd.png" alt="image"><br><br><h2>  Using </h2><br>  The main purpose of this solution is to send iSCSI targets to a high-available Windows Server 2012 cluster for Cluster Shared Volumes and to KVM nodes working under SolusVM for organizing the LVM from which work is being done.  Deduplication and all the above described buns allow us to keep prices at an excellent level. <br><br>  The second purpose is to provide clients with the iSCSI target service as a pay-per-use service, so that our clients would no longer need to make their filer if they need a cluster.  Since we specialize in large dedicated servers with SLA 4 hours, we know why they are taken.  It will be possible to seriously save through the use of centralized infrastructure. <br><br>  We can now distribute the target at a speed of 1GB, and 10GB.  Client targats are automatically snapshoted and replicated to archive storage. <br><br>  I hope this post will be useful and will avoid rakes when choosing a solution for multi-level budget storage.  We will work, I will write observations.  We are waiting for comments and welcome to <a href="http://www.hostkey.ru/">HOSTKEY</a> . </div><p>Source: <a href="https://habr.com/ru/post/171321/">https://habr.com/ru/post/171321/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171303/index.html">Own CSS - framework</a></li>
<li><a href="../171305/index.html">Largest domain name registrar Godaddy blocked userapi.com</a></li>
<li><a href="../171307/index.html">Microsoft Surface 2 RT - powerful, cool, controversial</a></li>
<li><a href="../171315/index.html">The digest of interesting news and materials from the world of IT for the last week ‚Ññ46 (February 23 - March 1, 2013)</a></li>
<li><a href="../171317/index.html">An example of how a server running * nix can become part of a botnet</a></li>
<li><a href="../171325/index.html">Something that nobody has ever written about Nokia, Elop and the burning platform.</a></li>
<li><a href="../171327/index.html">Briefly about hydrodynamics: equations of motion</a></li>
<li><a href="../171329/index.html">Add WDS universality</a></li>
<li><a href="../171331/index.html">About abstraction, loosely coupled architecture and design in general</a></li>
<li><a href="../171335/index.html">Change of programming paradigm to C #, transition to signals and queues (slots)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>