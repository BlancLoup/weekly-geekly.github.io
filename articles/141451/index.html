<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IE8 memory leaks, or a scary fairy tale with a happy ending</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you been writing web applications for a long time, have you already seen everything and aren't you afraid of anything else? Then turn off the lig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IE8 memory leaks, or a scary fairy tale with a happy ending</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/e21/198/07c/e2119807cce857df4cd308a95e023a5f.png"><br><br>  Have you been writing web applications for a long time, have you already seen everything and aren't you afraid of anything else?  Then turn off the lights and sit down, I want to tell you a tale for the night. <br><br>  Once in one big-big city, in one big-big IT company, they tested one big-big project in one very used browser.  And they found memory leaks there.  Big-big.  Straight shortly before release. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And it would be no wonder if the developers were completely stupid.  But no, the developers by heart knew <a href="http://msdn.microsoft.com/en-us/library/bb250448.aspx">"Understanding and Solving Internet Explorer Leak Patterns"</a> .  Cyclic links were broken, closures were not used, events were treated with due respect, and handlers were not forgotten to remove.  Why, only it did not save from leaks. <br><br><a name="habracut"></a>  <i>Discalimer: All entities, events and code snippets below are fictional.</i>  <i>All matches are random.</i> <br><br>  Well, what was a good fellow to do?  Once again they sat down to comb their components and see if they missed something, they started to launch various <a href="http://sourceforge.net/projects/ieleak/">programs</a> and torture the answer from Google.  But the programs did not help, the wise Googol was also silent.  I had to roll up my sleeves and search for a line where the infection lurked.  And there was a malicious line, and it looked like this: <br><br> <code>var cell = tableEl.firstChild.rows[0].cells[0];</code> <br> <br>  And the developers came in bewilderment, they had to study the problem and solve it.  What they managed. <br><br>  And then the tale ends and the code begins to show the problem: <br><br> <code>&lt;!DOCTYPE HTML&gt; <br> &lt;html&gt; <br> &lt;body&gt; <br> &lt;span id="count"&gt;0&lt;/span&gt; \&lt;input id="num" value="1000" /\&gt; <br> &lt;input type="button" value="GO!" onclick="execute()" /&gt; <br> &lt;hr /&gt; <br> &lt;div id="test"&gt;&lt;/div&gt; <br> &lt;/body&gt; <br> <br> &lt;script type="text/javascript"&gt; <br> var count = 0; <br> function execute() <br> { <br> var val = document.getElementById('num').value; <br> for (var i = 0; i &lt; val; i++) <br> { <br> var domEl = document.getElementById('test'); <br> domEl.innerHTML = '&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;A1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;B1&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'; <br> domEl.firstChild.insertRow(0); <br> domEl.removeChild(domEl.firstChild); <br> count++; <br> } <br> document.getElementById('count').innerHTML = count; <br> }; <br> &lt;/script&gt; <br> &lt;/html&gt; <br></code> <br><br>  Run Process Explorer and click ‚ÄúGO!‚Äù Several times - 10 megabytes escapes with a click: <br><br><img src="https://habrastorage.org/storage2/e50/171/411/e501714117c1d0d245c489d7c3b32a4d.png" alt="image"><br><br>  The leak is hidden in the line <code>domEl.firstChild.rows[0]</code> which you can verify by simply <code>domEl.firstChild.rows[0]</code> it out.  And the bug only appears in the IE8 Standards mode, the IE7 and IE8 Quirks modes are not affected by this disease. <br><br>  Replacing with domEl.firstChild.firstChild or with getElementById helps fix the leak, but if there are hundreds of such lines throughout the project?  Maybe there is a less time consuming option? <br><br>  Let's try to estimate how the Hindus from Microsoft managed to achieve this effect.  Obviously, collections of columns and cells are created only when used, the solution is quite sound.  And when the table is uncoupled from the DOM of the document tree, they are not destroyed - it is also quite understandable and reasonable.  Only here in the garbage collector, for some reason, they forgot to take into account the cyclic references that are formed. <br>  The hypothesis can be tested.  If it is a matter of creating collections, there will be leaks in other cases when indexes are used.  Replace rows [0] with insertRow (0).  Bingo!  Leakage preserved. <br><br>  Now the way to fight is clear.  Once it‚Äôs a matter of circular references between the DOM elements TBODY and TD, it means you just need to remove all the descendants of TBODY: <br><br> <code>while(domEl.firstChild.firstChild) { <br> while(domEl.firstChild.firstChild.firstChild) <br> domEl.firstChild.firstChild.removeChild(domEl.firstChild.firstChild.firstChild); <br> domEl.firstChild.removeChild(domEl.firstChild.firstChild); <br> } <br></code> <br>  It worked, but this is still not enough for happiness; it is rather dreary to take care of the correct removal of the table in the component separately, and forget something for long.  You can, of course, automate the process, use something like getElementsByTag ('TABLE') ... But you don‚Äôt need to, as there is a magic innerHTML property that does everything for us: <br><br>  Replace <code>domEl.removeChild(domEl.firstChild)</code> with <code>domEl.innerHTML = ''</code> <br>  We are checking.  Works. <br><br><h5>  To summarize: </h5><br>  This type of leakage is not documented; it occurs only in the IE8 Standards mode when using methods and properties of DOM table objects that use row or column indexes.  (.rows [], .cells [], insertRow (), etc.) <br><br>  The best way to work around a problem is to not use these methods and properties. <br><br>  Alternative - make sure that the DOM elements of all rows of the table are disconnected from their ancestor, or use the simplest option: <code>innerHTML = ''</code> </div><p>Source: <a href="https://habr.com/ru/post/141451/">https://habr.com/ru/post/141451/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141442/index.html">Accelerate your Arduino</a></li>
<li><a href="../141444/index.html">Django Gmap v3 Widget - geolocation with search, saving coordinates and addresses in JSONField</a></li>
<li><a href="../141447/index.html">Verify compliance with the coding standards for PHP through git</a></li>
<li><a href="../141448/index.html">CodeIgniter Command Line library - a small assistant for working with CLI</a></li>
<li><a href="../141450/index.html">Build: markitUp, fancybox, elFinder - a great replacement for WYSIWYG editors</a></li>
<li><a href="../141454/index.html">A set of useful utilities and libraries in the .NET world</a></li>
<li><a href="../141456/index.html">Yandex launches disk</a></li>
<li><a href="../141457/index.html">Samsung Series 5 Ultrabook Video Review</a></li>
<li><a href="../141458/index.html">Yandex.Disk - flew!</a></li>
<li><a href="../141460/index.html">Disaster recovery plan - confidence in the future for the entire company and a restful sleep in the IT department</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>