<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recursive routing to MikroTik through DHCP designated gateways</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The most frequently asked question to me about using recursive routing is: ‚ÄúWhat should I do if the main provider assigns us an ip-address via dhcp, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recursive routing to MikroTik through DHCP designated gateways</h1><div class="post__text post__text-html js-mediator-article">  The most frequently asked question to me about using recursive routing is: ‚ÄúWhat should I do if the main provider assigns us an ip-address via dhcp, while the default gateway often changes?‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mn/ft/9g/mnft9gsqxl7s_v7qpucjkgeqnvw.png" alt="image"></div><a name="habracut"></a><br>  Warning!  The materials and schemes in this article are simplified to primitivism in order to give a general idea of ‚Äã‚Äãthe method of solving the problem.  Without deepening in particular. <br><br>  What is recursive routing for?  To monitor the availability of the Internet <b>behind the provider's gateway</b> .  After all, it often happens that the provider's router responds to echo requests perfectly, but the link to the global network from the provider has disappeared for some reason. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Recursive routing allows you to assess the availability of Internet access through a selected provider and decide on the routing of traffic. <br><br>  However, the fact is that the use of recursive routing implies the <s>presence of a</s> directly explicit indication of the <b>gateway IP address</b> among the parameters of the created route.  Specifying the name of the broadcast interface as a gateway is incorrect and in many cases simply does not work, because  requires proxy-arp on the part of the provider.  And yet, instead of a proxy-arp provider, your neighbor can switch on the ISP switch and try to intercept your traffic in this way by arranging a classic MITM! <br><br>  The magic of recursive routing is hidden behind the <a href="https://wiki.mikrotik.com/wiki/Manual:Using_scope_and_target-scope_attributes">"scope" and "target-scope"</a> parameters.  For a route to work as recursive, its ‚Äútarget-scope‚Äù must be greater than or equal to the value of the ‚Äúscope‚Äù of the static route to which it refers recursively, and the gateway specified in the route was out of direct reach through one of the interfaces. <br><br>  Consider the simplest scheme Active / Backup.  Our router performs NAT and is connected to two providers via the Ether1-isp1 and Ether2-isp2 interfaces.  The main provider (ISP-1) distributes IP addresses to its clients via DHCP and nothing else.  The second provider provides us with a static IP address, but significantly lower speed. <br>  Switching to a spare (ISP-2) should occur when access to the Internet through the main provider becomes impossible. <br><br><img src="https://habrastorage.org/webt/sp/6x/au/sp6xauunimjxvginbtlch9ehhgs.png" alt="image"><br><br>  The highlight of the provider for such a scheme is a periodic arbitrary change not only of the client‚Äôs IP address, but also of default-gateway. <br><br>  Before version 6.39, I had to see very sophisticated crutches in various combinations of <a href="https://wiki.mikrotik.com/wiki/Manual:System/Scheduler">sheduler</a> , <a href="https://wiki.mikrotik.com/wiki/Manual:Tools/Netwatch">netwatch</a> and similar mechanisms. <br><br>  Starting from version 6.39, RouterOS developers went to meet such users and created the ability to call a special <a href="https://wiki.mikrotik.com/wiki/Manual:IP/DHCP_Client">script</a> when a dhcp client is triggered on a device. <br><br>  The solution itself consists of two parts: <br><br><ol><li>  you need to get via the dhcp protocol from the provider the IP address and the gateway address for use in recursive routes </li><li>  If possible, the gateway address from the provider will be excluded from automatic use. </li></ol><br>  So let's start from the end. <br><br>  Let's create a backup route through "ISP-2" with a value of "distance" more than the future main one.  In this example, I used "distance = 2": <br><br><div class="spoiler">  <b class="spoiler_title">Backup via ISP-2</b> <div class="spoiler_text"><code>/ip route add dst-address=0.0.0.0/0 gateway=192.0.2.1 distance=2</code> <br> </div></div><br>  Further, in order to receive the default route from the ISP-1 provider, but do not use it directly, there is a special value ‚Äúdistance = 255‚Äù.  A route with such a distance value will fall into the system routing table, <a href="https://wiki.mikrotik.com/wiki/Manual:IP/Route">but it will never become active</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>/ip dhcp-client add comment="ISP-1 dhcp" default-route-distance=255 dhcp-options=hostname,clientid interface=Ether1-isp1</code> <br> </div></div><br>  We only need this route to read the parameters sent by the provider and embed them into the recursive route settings via a script. <br><br>  From the obtained parameters, we are more interested in the $ gateway-address variable.  As the name suggests, it contains the default gateway address in the provider's network.  We will use it to bring recursive routes up to date. <br>  The recursive routes themselves must be correctly identified from the script.  To do this, at the stage of their creation, we will specify a unique ‚Äúcomment‚Äù, which will be used to search for them within the table.  The code for creating a recursive pair of routes: <br><br><div class="spoiler">  <b class="spoiler_title">Creating a pair of routes</b> <div class="spoiler_text"> <code>/ip route add dst-address=8.8.4.4 gateway=127.0.0.1 scope=30 target-scope=30 comment=" <b>isp1route</b> " disabled=yes <br> /ip route add dst-address=0.0.0.0/0 gateway=8.8.4.4 check-gateway=ping</code> <br> </div></div><br>  The first line should (and will!) Point to the real gateway in the provider's network only after the provider issues the dhcp parameters and they will be processed using the dhcp-client script: <br><br><div class="spoiler">  <b class="spoiler_title">Simplified script</b> <div class="spoiler_text"> <code>/ip route set [find comment=" <b>isp1route</b> "] gateway=($"gateway-address") disabled=no</code> <br> </div></div><br><div class="spoiler">  <b class="spoiler_title">More advanced option</b> <div class="spoiler_text"> <code>:if ($bound=1) do={ /ip route set [find comment=" <b>isp1route</b> "] gateway=($"gateway-address")disabled=no; :log warning ("New ISP1 gateway: ".($"gateway-address")) }</code> <br> </div></div><br>  Now, when an IP address is received from the ISP-1 provider for use as the default gateway, it will be added to the routing pair <u>instead of 127.0.0.1.</u> <br>  The second line, where the route to 0.0.0.0/0 is indicated, actually performs all the magic.  The 8.8.4.4 node specified there as the gateway will be checked for response with the ‚Äúcheck-gateway = ping‚Äù option via the ISP-1 network.  In case the node 8.8.4.4 does not respond twice to the pings within 20 seconds, the router will consider the connection to the Internet through this route (ISP-1) unavailable.  New connections in this case will be routed through the ISP-2 backup provider. <br><br>  If everything is done correctly, then the words ‚Äúresursive via ...‚Äù will be visible in the winbox / ip-&gt; routes window near the route to 8.8.4.4.  This means the route was built exactly as recursive. <br><br>  In the end, for example only, the screen of the winbox window: <br><br> <a href=""><img src="https://habrastorage.org/webt/cs/qp/yg/csqpygzqinf53ae-ivjaac15pk8.png" alt="image"></a> </div><p>Source: <a href="https://habr.com/ru/post/428097/">https://habr.com/ru/post/428097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428085/index.html">Front-end strikes back: HolyJS 2018 Piter's top-10 (?) Reports</a></li>
<li><a href="../428087/index.html">"Lock-free, or not lock-free, that is the question" or "Healthy sleep worse than bitter radish"</a></li>
<li><a href="../428089/index.html">"Calendar tester" for October. Feedback: as it happens</a></li>
<li><a href="../428091/index.html">How an intern student created the world's most popular video game, or the history of Windows games</a></li>
<li><a href="../428095/index.html">Market research of web-studios and digital-agencies</a></li>
<li><a href="../428099/index.html">What do common dress and upcoming 5G era have in common?</a></li>
<li><a href="../428101/index.html">How to automate with Jenkins the assembly and rolling-out of artifacts of the metadata model for tables in the repository</a></li>
<li><a href="../428103/index.html">Mitap in Petersburg: Data Engineering and not only</a></li>
<li><a href="../428105/index.html">Blogger recommends: influence-marketing</a></li>
<li><a href="../428107/index.html">Containerizing Angular 6 SPA Template ASP .NET Core 2.1 Applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>