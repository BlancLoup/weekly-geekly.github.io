<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CouchDB: the story of one accident</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share a story about how our project has lasted for an hour and a half, and the experience of finding out the reasons. 

 At one point, we un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CouchDB: the story of one accident</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/9dc/561/168/9dc5611685ac348bef6aab8e4ae9fad8.png"><br>  I want to share a story about how our project has lasted for an hour and a half, and the experience of finding out the reasons. <br><br>  At one point, we understand that part of the site is loaded with a 15-minute delay, and the other part simply does not work, yielding a 504 error. <br><br>  <b>Attention!</b>  <b>Since people like to be clever and do not like to read, I write here.</b>  <b>The purpose of the post is to tell you how to get out of an emergency, everything else is just lyrics, for which for some reason everyone is focusing attention.</b> <br><a name="habracut"></a><br>  I am engaged in a project that uses CouchDB as a database.  There is a ‚ÄúPoster‚Äù section on it to which you can add events, in particular, you can add a periodic event by setting the start date of the period and the end date. <br>  After adding an event, an event document is created in the database, and a time period is added to its separate field for each day of the period.  At these intervals, a sample is made for output on the site.  The sample, in fact, simply selects temporary intervals from all documents. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, adding an event for 7 days, we get a document in which there are 7 records in the period field, and we have 7 records in our view. <br><br><h4>  Fail </h4>  On the server there was no check for the maximum period of the event.  For some reason, this was not foreseen, probably hoping that only users with a paid account would add events, but they should be conscious. <br><br><h4>  Dirty user </h4> A user appears with a paid account, and, for pampering, adds an event, indicating the final date of the event is 2100. <br>  On the server, php-fpm begins to work powerfully, starting to add 365 * 100 events.  Add something, he added, but the user did not wait for the message about the successful addition, having decided, probably, something glitched or the Internet fell off, and clicked on adding an event again, changing the time of the event a little.  The process went a second time.  Not that php-fpm gave any serious load, but in the list by the command top on the server there were more php-fpm processes than usual, which was confusing and made us think for a while in the wrong direction. <br><br>  As a result, we have 2 documents in the database with time intervals of 365 * 100 each.  CouchDB begins to update the view that it does not give him. <br><br>  In the server logs something like: <br> <code>[&lt;0.738.0&gt;] Exit from linked <br> pid: {&lt;0.742.0&gt;, <br> {timeout, <br> {gen_server,call, <br> [couch_query_servers, <br> {get_proc,&lt;&lt;"javascript"&gt;&gt;}]}}}</code> <br> <br>  When you try to log into the database in Futon, we see an os_process_error error.  In the Status section in Futon, we see a non-disappearing inscription with a note that it is in the event database (see line 1): <br><img src="https://habrastorage.org/storage2/6e1/76b/591/6e176b591a44859349114c29a4c6c981.png"><br>  There was a thought that something was buggy or beat the base, but service couchdb restart did not help, as did replacing the base on the server with the last copy from replication on another server. <br><br>  After googling, a solution was found in the archive of the CouchDB mailing list - the base came up when the view was updated to os_process_timeout = 5000 (5 seconds).  The view simply did not have time to process the document in the time allotted to it.  Having increased the value in the config to 15 seconds, they finally managed to achieve the application of changes and the site started working normally. <br><br>  Having dealt with the reason that the site simply did not load, giving out 504 error and sorting out the base, the script was finally restored and measures were taken to prevent this from happening again. <br><br>  By the way, the created 2 documents in the database had to be deleted with a quickly written script, since  the browser simply refused to open the document in Futon, hanging on tightly, obviously, trying to process the array with time intervals. <br><br>  The sequence of events was restored in approximately the reverse order of my narration, which made me pretty nervous, because  I personally had to face this for the first time (I must pay tribute to the authorities, who didn‚Äôt run around, demanding an urgent search and raising the site, and quietly allowed to deal with the problem). <br><br><h4>  Based on the above, some conclusions suggest themselves. </h4><ul><li>  Do not store a lot of data in one document, especially if it is an array that participates in the sample.  Here, however, another controversial issue is that it is better - many small documents, or few large, but too large documents in our case did not work out for themselves; </li><li>  if, having entered the database, the error os_process_error appears, and the word timeout in the logs - try to increase os_process_timeout in the config, this will allow the database to start working again and return the results, having processed the latest changes; </li><li>  the golden rule, which we, alas, did not use in a particular case - check the data entered by the user, think like a cunning user-bad guy. </li></ul><br><br>  I hope this post will save those who, like us, will face this for the first time, from agonizing googling.  Our project was cut off, alas, during peak attendance, I hope this will not happen to you again. <br><br>  PS Useful article on Habr√©: <a href="http://habrahabr.ru/post/123338/">16 practical tips on working with CouchDB</a> . </div><p>Source: <a href="https://habr.com/ru/post/141944/">https://habr.com/ru/post/141944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141937/index.html">Backing up to Yandex.Disk using D√©j√† Dup in Ubuntu and not only in it</a></li>
<li><a href="../141938/index.html">Cleaning infected site files from malicious code. Continuation</a></li>
<li><a href="../141940/index.html">YOTA begins testing a new LTE network in Moscow</a></li>
<li><a href="../141941/index.html">Withdrawing Yandex.Money to Visa cards in new countries</a></li>
<li><a href="../141943/index.html">We write "Snake" for Windows Phone 7</a></li>
<li><a href="../141945/index.html">The evolution of architecture: from "samopisnyh" services to HandlerSocket</a></li>
<li><a href="../141946/index.html">Create a session key using public and private keys</a></li>
<li><a href="../141948/index.html">1366 √ó 768px went around 1024 √ó 768px in the list of the most popular screen resolutions</a></li>
<li><a href="../141949/index.html">How to organize a corporate wintering?</a></li>
<li><a href="../141950/index.html">Habraigre tournament "Startup"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>