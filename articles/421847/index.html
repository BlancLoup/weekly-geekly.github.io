<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jump into the cloud. We build a budget solution for the Internet of things on NodeMCU + Azure IoT Hub</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The most popular purpose of IoT devices is telemetry collection. To date, prices for cloud IoT services have decreased so much that an ordinary ordina...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jump into the cloud. We build a budget solution for the Internet of things on NodeMCU + Azure IoT Hub</h1><div class="post__text post__text-html js-mediator-article"><p>  The most popular purpose of IoT devices is telemetry collection.  To date, prices for cloud IoT services have decreased so much that an ordinary ordinary user can afford to use them.  Today we will talk about how to send data to the cloud from the NodeMCU board using the Lua language. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Note: we continue the series of publications of the full versions of articles from the magazine Hacker.</em>  <em>Spelling and punctuation of the author saved.</em> </p><br><p>  I give the word to the author. </p><br><p>  Since I work in the stack of Microsoft technologies, I use Azure Functions and Table Storage to create the cloud part of the IoT solution, but my PoC for NodeMCU and Lua can also be used with other providers of cloud IoT solutions. </p><br><h1>  INFO </h1><br><p>  Expressif NodeMCU is one of the most inexpensive motherboards with Wi-Fi, micro USB and on-board programmer.  It is based on the ESP8266 module.  The second generation motherboard can be purchased for about 6 - 7 dollars.  You can work with the board from the Arduino IDE.  In addition, the board supports a scripting language called Lua (translated from Portuguese as "Moon"). </p><br><h2>  Connect and configure the device </h2><br><p>  In order for a Windows device to be recognized, you need to download the driver from the following link: <a href="https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers">CP210x USB to UART Bridge VCP Drivers</a> </p><br><p>  The standard speed of the serial port NodeMCU is 115'200bps.  You can set a different speed, at the first reset of the device, it will return to 115200. <br>  It is important that the driver be set to exactly the same speed: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Most likely in the original firmware something will be missed, so ideally flashing the device yourself.  You can assemble the firmware image in several ways.  Using a <a href="https://nodemcu-build.com/">cloud service</a> , <a href="https://hub.docker.com/r/marcelstoer/nodemcu-build/">a Docker image</a> , or using a <a href="http://www.esp8266.com/wiki/doku.php%3Fid%3Dtoolchain">Linux instruction</a> .  I collected using the cloud service.  I also advise you this option. </p><br><p>  If you need to send data to the cloud, then SNTP, MQTT, HTTP (WiFi, timer, file, GPIO, net, node, UART are already selected by default) are necessary for choosing functions.  It is also necessary to mark as necessary TLS / SSL support in Miscellaneous options <br>  Link to the bin file comes in the mail.  More precisely, even 2 links come at once.  One with the image supporting floating point operations, and the second with non-supporting. </p><br><p>  Before flashing the ESP8266 it is necessary to bring in a special mode.  The board has a separate FLASH button.  Pressing it during power on or pressing reset puts the device in bootloader mode.  If suddenly there is no such button in your board modification, then before flashing you need to connect GPIO0 with GND and press reset (this method is suitable for ESP-12). </p><br><p>  Firmware can be <a href="https://github.com/marcelstoer/nodemcu-pyflasher/releases">flashed</a> with <a href="https://github.com/marcelstoer/nodemcu-pyflasher/releases">PyFlasher</a> utility.  Py in the title means that the application is written in Python.  There is also a <a href="https://github.com/nodemcu/nodemcu-flasher">nodemcu flasher</a> , but it has not been updated for a long time.  I did not try it. </p><br><p>  The PyFlasher window looks like this: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  Flash mode is selected depending on what your board.  Most modern boards based on the ESP8266 ESP-12 and ESP32 modules fit the DIO mode.  ESP8266 01 to 07 Fits faster QIO mode.  DOUT is used by ESP8285. </p><br><h2>  IDE Setup </h2><br><p>  Download free IDE by link <a href="https://esp8266.ru/esplorer/">ESPlorer</a> .  Alternatively there is <a href="https://studio.zerobrane.com/">ZeroBrane Studio</a> .  I liked ESPlorer most of all, so I‚Äôll give an example of working with him.  ESPlorer is written in JAVA.  Application interface such </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  On the left side is the code, settings, and some other similar functionality.  On the right - the monitoring window and device control commands.  Open the application, select the port.  Set the speed at which the exchange will take place (most likely it is 115200) and click Open. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  To warm up, you can run a simple script that flashes with the built-in LED: </p><br><pre><code class="hljs matlab">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  If your board does not have a built-in LED (or you are completely bored with examples of blinking with the LED =), then you can try an even simpler script that displays the line: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  After you create a .lua file (say test.lua), enter the code into it and save it to disk, you can download it to the device.  To do this, you must open the port if it is not open (the Open button) and click the Upload button.  You can find it among the buttons that are located under the code (on the left). </p><br><p>  After uploading the file, you can execute it by sending the command: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  The command can be entered manually in the lower field, located on the right under the monitor.  Or if you do not want to type any text, you can click the Reload button (the extreme row of buttons on the right).  After clicking this button, you will receive a list of buttons with .lua files loaded on the board.  Pressing the button with the file name will launch the file for execution. </p><br><p>  If you want the file to start immediately after switching on the board, create a file with the name init.lua. </p><br><h2>  Setting up the cloud part to work with the device </h2><br><p>  Let's leave our device for some time and create its twin in the cloud.  Recently, a device twin can be created right on the Azure portal using the new functionality.  In the IoT hub settings group called Explorers, you must select IoT Devices and click ‚Äú+ Add‚Äù </p><br><p>  To connect the device to the IoT hub, we need to generate a SAS (shared access signature).  To generate SAS, the device double key is used, which can be obtained using any auxiliary utility (Device Explorer, iothub-explorer, IoT Extension for Azure CLI 2.0).  But the easiest way to get the key is there, on the Azure portal, by going to IoT Hub -&gt; IoT Devices. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  SAS can be generated on the device, or it can be generated using any of its online services.  If you use the SDK, then it can generate SAS for you automatically (it is enough to specify the device's twin key in the code). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  The way in which the SAS token is generated by a web service for a certain limited time is slightly more secure.  Although there is a certain nuance.  If you send the service only the name of the device, then someone can search through the names to get a token of some other device.  Therefore, in order to secure the process a bit, I propose this solution: let's save the device's hash key of the Azure key on the device.  And in the service code, before generating SAS, check whether the hash is the same as the device key hash.  Thus, you can get SAS only if you know the name of the device and the hash of its key. </p><br><p>  The first way in which SAS is generated on the device is simpler and more convenient, but slightly less secure.  Since gaining access to the device, an attacker will be able to get the key and generate the SAS devices on his own.  In the second case, by gaining access to the device, the attacker will be able to receive only SAS tokens, whose lifetime is limited. </p><br><p>  It turns out that both methods are by and large not ideal if the hacker has access to the device.  Even protecting a connection using a VPN does not help here.  In this case, the transmission channel will be protected, but the one who receives the device in his hands will be able to get access to the channel.  Unfortunately, on devices NodeMCU, Arduino, etc.  There is no possibility to store keys / passwords in any secure storage.  Perhaps the market for low-cost IoT devices requires new hardware functionality. </p><br><h2>  Creating Azure functions to generate SAS </h2><br><p>  As an online service, it‚Äôs easiest to use Azure functions.  These are some kind of snippets that can be written immediately on the Azure portal in the browser.  Jokes jokes, but this way you can even program from your smartphone.  Of course, no one forbids creating and debugging them from Visual Studio, and only then publish to Azure in compiled form. </p><br><p>  The task of the function is to perform some kind of not particularly complicated operation.  According to microservice idea, each function is able to do one thing, but very well (the principle of Single responsibility). </p><br><p>  You can create an Azure Function App on the portal by filling out a short form. </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  Consumption Plan allows you to pay only for those function calls that were made.  This is the most inexpensive option.  At the moment, a million function calls are given for free. </p><br><p>  Notice that along with the creation of the function, an auxiliary data storage (Storage) is also created. </p><br><p>  After creating the Function App, you can create the function itself.  In this case, we need a function like Webhook + API.  The function can be opened to all (anonymous access), or it can be accessed only by the owners of a special code.  The code can be obtained from the function window by clicking on the link &lt;/&gt; Get function URL: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  Functions can be written in various languages.  I prefer C #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Create a project.json file and add the following content to it: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  The code uses the connection string to the IoT hub.  It can be confused with the connection string to the device.  So that you are not confused I will remind you where you can get it: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  You need to take the Connection string from any Policy with Device connect rights. <br>  The connection string itself is best not to be specified in the code, as I did.  I did this solely for the sake of example.  It is best to go to the Application settings function. </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  And indicate there is a connection string.  After that, you can "get it" from the secure storage using </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  On the device, we need to save the hashedkey.  But first you need to encode characters.  HttpUtility.UrlEncode from System.Web space will help us in this. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  We will send a request using Get, and not all characters can be passed as a parameter value. </p><br><h2>  Writing code to send data to the cloud </h2><br><p>  I wrote a small code on Lua sending data to the cloud.  It turned out a kind of PoC.  You can use it and modify to fit your needs. <br>  Create 2 init.lua and SendDataToCloud.lua files <br>  Content first: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  This file connects to the network and executes the code from the SendDataToCloud.lua file in case of a successful connection. </p><br><p>  You must specify the data of your Wi-Fi access point as station_cfg.ssid and station_cfg.pwd values. </p><br><p>  In the following file, you need to change the device name and IoT hub (variable DEVICE and IOTHUB).  The funcurl variable contains the address of the SAS-generating function and the hash key of the device key (which we previously encoded using HttpUtility.UrlEncode) as the value of the hash parameter </p><br><pre> <code class="hljs php">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(funcurl, headers, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(code, data, header)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> if </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(code &lt; </span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> then print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"HTTP request failed"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> else sas = true print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(code, data)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> if string.match</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(data, </span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Shared"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> then tmr.stop</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SAS = string.sub</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(data,</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">,string.len</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(data)</span></span></span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(SAS)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connect</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(SAS)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end end end)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">240</span></span></span></span><span class="hljs-function"><span class="hljs-params">, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Connecting to MQTT broker. Please wait..."</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params"> client:connect</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(IOTHUB, PORT, </span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">, -- Callback     function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(client)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> tmr.stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(</span></span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(</span></span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Connected to MQTT: "</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">..IOTHUB..</span></span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">":"</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">..PORT..</span></span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">" as "</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">..DEVICE)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> connected = true senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> end, -- Callback    function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(client, reason)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(</span></span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Error Connecting: "</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">..reason)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> end )</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"offline"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(client)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"MQTT Disconnected."</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connected = false end)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\" : \""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\","</span></span>.. <span class="hljs-string"><span class="hljs-string">"\"iotdata\" :"</span></span>..somedata..<span class="hljs-string"><span class="hljs-string">"}"</span></span> --   client:publish(telemetry_topic, payload, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Data published successfully."</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  The data is sent without using the Azure SDK, so you can use this code not only to send data to Azure.  There are plenty of alternatives: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  The example uses the Message Queuing Telemetry Transport (MQTT) protocol.  This is an open protocol designed specifically for IoT devices.  Data is sent in JSON format.  Where in real projects data are taken from sensors, a random number is generated in the example. </p><br><p>  During the handshake process between the device and the IoT hub, the server can send its certificate, or it can request a device certificate.  If you remember, the <a href="https://xakep.ru/2017/06/01/arduino-azure-iot-hub-sensors/">last time</a> when working with an Arduino device, we were flashing it with a certificate.  Now, only one sink of code is enough: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  We are limited to the certificate that the server will send us. </p><br><h2>  INFO </h2><br><p>  You may be interested in the fact that you can get the contents of your hub certificates using the following OpenSSL command </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  For the preparation of the material were used the labs, which are available at the link: <a href="http://thinglabs.io/workshop/esp8266/sending-d2c-messages/">Sending Device-to-Cloud (D2C) Messages</a> <br>  The code is not entirely up to date and I had to update it a bit, but in general, the link may be useful. </p><br><h2>  We work with NodeMCU from Arduino IDE </h2><br><p>  I can not ignore the topic of using the SDK.  Its solution is good, but the SDK is the same code that is already debugged, simplified, and ready for use.  A few words about how to configure and use the Arduino IDE to work with NodeMCU. </p><br><p>  After installing the Arduino IDE you need to go to the menu File - Preferences </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  And add a link to an additional card manager - enter the address in the field Additional Boards Manager URLs: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Then go to the Tools menu - Board xxx - Boardx Manager and install ESP8266 <br>  Install the AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT libraries.  After installing the latest library in the examples (File - Examples - AzureIoTProtocol_MQTT), you can find an example simplesample_mqtt for ESP8266. </p><br><p>  Sample is ready to go.  Just fill in the values ‚Äã‚Äãof the variables in the iot_configs.h file. <br>  I will mention one small minus.  Compilation of the project and loading on the board, compared to Lua, takes quite a long time. </p><br><h2>  Saving data in the Azure cloud </h2><br><p>  With sending data, everything is clear, but how inexpensive it is to store data in the cloud. <br>  The most inexpensive way to send data from the IoT hub to the database is all the same Azure Functions.  And the most inexpensive data storage is Azure Table Storage. </p><br><p>  Interestingly, when you create a Function App, the Storage is automatically created and is required for the function itself to work.  If you create a separate repository, then the basic settings are desirable to make something like this: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  LSR replication is currently the cheapest option.  It is selected when automatically creating a repository associated with a function. <br>  What we need now is to receive data from the IoT hub and write it to the storage.  For this case, the Quick Start window will not be able to offer the desired option when creating a function. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Therefore, click the link Custom function, located at the bottom and select the option IoT Hub (Event Hub). <br>  Here we will open this window: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  In which we can fill in the field Event Hub connection with a simple choice (by pressing new).  But to specify the Event Hub name you need to go to the IoT hub.  In the hub you need to go to Endpoints (endpoints) and take the Event Hub-compatible name from there. </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Let's go to the function code.  The following snippet receives data from the IoT hub and stores it in Table Storage: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> https; AccountName = iotdatademostorage; AccountKey = JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34 + lGx3XrR + 0CPiY9RoxIDA6VSvMKlOEUrVWL + KWP0qLMLrw ==; EndpointSuffix = core.windows.net"); <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  If you use this code in a real project, do not forget to move the connection string to a safer place ‚Äî in App settings (just like the connection string of the first function). </p><br><p>  The connection string itself can be taken in the settings item called Access keys: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  View the contents of tables using the free <a href="https://azure.microsoft.com/en-us/features/storage-explorer/">Azure Storage Explorer</a> utility. </p><br><p>  Since the cost of Azure Table Storage is quite low, and the Azure Functions and IoT hub offer certain resources monthly for free, the cost of the entire solution per month can be less than $ 1.  Of course, it depends on the amount of data.  Count yourself.  At the moment, 1 GB of data costs 7 cents per month and for every million transactions you will be charged only 4 cents. </p><br><h2>  INFO </h2><br><p>  I always advise when using cloud services from any provider to tie a credit card with the minimum amount of money to your account.  Quite really accidentally choosing some kind of erroneous setting to pay much more than you expect. </p><br><p>  We remind you that this is the full version of an <a href="https://xakep.ru/2018/03/01/nodemcu-iot/">article from Hacker magazine</a> .  Its author is <a href="https://habrahabr.ru/users/asommer/">Alexey Sommer</a> . </p><br><h2>  Useful materials </h2><br><h4>  Cloud Application Architecture Guide </h4><br><p> <a href="https://azure.microsoft.com/ru-ru/campaigns/cloud-application-architecture-guide/%3Fwt.mc_id%3DAID729732_QSG_270347"><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Use a structured approach to developing cloud applications.  This 300-page e-book on cloud computing architecture discusses architecture, development, and deployment recommendations that apply regardless of the cloud platform chosen.  This guide includes steps to: </p><br><ul><li>  Choosing the right style of the cloud application architecture for your application or solution; </li><li>  selection of appropriate computing and data storage technologies; </li><li>  implementation of 10 development principles for creating a scalable, fault-tolerant and managed application; </li><li>  following the five principles of creating high-quality software that guarantees the success of your cloud application; </li><li>  using constructive patterns intended for the problem you are trying to solve. </li></ul><br><p>  ‚Üí <a href="https://azure.microsoft.com/ru-ru/campaigns/cloud-application-architecture-guide/%3Fwt.mc_id%3DAID729732_QSG_270347"><b>Download</b></a> </p><br><h4>  Azure Developer Guide </h4><br><p> <a href="https://azure.microsoft.com/ru-ru/campaigns/developer-guide/%3Fwt.mc_id%3DAID729732_QSG_270352"><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  From this update to the Azure Developer‚Äôs Guide, you‚Äôll find out how a complete set of services for the Azure software platform fits your needs.  Here you will find information about architectural approaches and the most common situations that arise when creating cloud applications. </p><br><p>  ‚Üí <a href="https://azure.microsoft.com/ru-ru/campaigns/developer-guide/%3Fwt.mc_id%3DAID729732_QSG_270352"><b>Download</b></a> </p><br><h4>  Microsoft Azure Basics </h4><br><p> <a href="https://info.microsoft.com/CE-AzureINFRA-CNTNT-FY18-05May-10-MicrosoftAzureEssentials-MGC0002411_01Registration-ForminBody.html%3Fwt.mc_id%3DAID729732_QSG_270354"><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  This book provides insight into important information about Azure key services for developers and IT professionals who are not familiar with cloud computing.  Step-by-step demos are included to help the reader understand how to get started with each of the key services.  Each chapter is independent, no practical demonstrations from previous chapters are required to understand a particular chapter. </p><br><p>  This book covers the following topics: </p><br><ul><li>  Get started with Azure; </li><li>  Azure App Service and Web Apps; </li><li>  Virtual machines; </li><li>  Storage service; </li><li>  Database; </li><li>  Additional Azure services. </li></ul><br><p>  ‚Üí <a href="https://info.microsoft.com/CE-AzureINFRA-CNTNT-FY18-05May-10-MicrosoftAzureEssentials-MGC0002411_01Registration-ForminBody.html%3Fwt.mc_id%3DAID729732_QSG_270354"><b>Download</b></a> </p><br><h2>  useful links </h2><br><ul><li>  <a href="http://aka.ms/iothubdocs">Russian IoT Hub Documentation</a> </li><li>  <a href="https://aka.ms/AzureIoTSamples1">Azure IoT examples for Csharp (.NET)</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421847/">https://habr.com/ru/post/421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421835/index.html">Interdepartmental Commission is developing a new technology to block Telegram</a></li>
<li><a href="../421837/index.html">Creating 1k intro Chaos for ZX-Spectrum</a></li>
<li><a href="../421839/index.html">Functional Java programming with Vavr</a></li>
<li><a href="../421841/index.html">Robotaksi Waymo not quite ready to go on public roads</a></li>
<li><a href="../421845/index.html">What do data analysts actually do? Findings from 35 interviews</a></li>
<li><a href="../421849/index.html">Events for HR in IT in September 2018: Digest of My Circle</a></li>
<li><a href="../421851/index.html">The problem of the owl and the globe: connecting two assemblies with identical namespaces and class names</a></li>
<li><a href="../421855/index.html">Projectors for the home: the best ‚Äúby version‚Äù, ultra-short focus, champions in brightness and speed</a></li>
<li><a href="../421857/index.html">ToFoIn v 1. Backup Gateways and Switch Between External Channels on FreeBSD</a></li>
<li><a href="../421859/index.html">Notes IoT provider. Devices and outbid</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>