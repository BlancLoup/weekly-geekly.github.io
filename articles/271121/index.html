<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DBMS Linter and ReactOS, Technical Details</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Largely due to the activity of the ReactOS foundation, it would not be a big mistake to assume that any regular reader Habra heard about the rather am...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DBMS Linter and ReactOS, Technical Details</h1><div class="post__text post__text-html js-mediator-article">  Largely due to the activity <a href="http://habrahabr.ru/company/reactos/profile/">of the ReactOS foundation,</a> it would not be a big mistake to assume that any regular reader Habra heard about the rather ambitious project of the ‚Äúfree Windous‚Äù.  I was not an exception, and even during the work on creating <a href="http://habrahabr.ru/company/relex/blog/265001/">the build system</a> for <a href="https://linter.ru/ru/">DBMS Linter, the</a> idea to include support for this operating system came to me more than once.  Most recently, she was able to realize. <br><br><img src="https://habrastorage.org/files/2ce/24a/f91/2ce24af91e4d4d4399b3bfca4dbfae32.jpg"><br><br>  Under the cut you are waiting for the technical details of the work, including the experience of deploying ReactOS on real hardware, and a bit of my subjective opinion about this project. <br><a name="habracut"></a><br><h1>  First experiments: blocking read error from mailslot </h1><br>  The start was encouraging - the installation of the Linter distribution kit on ReactOS was successful: the services were registered correctly, the databases were created, the server at first glance worked properly.  However, the first functional test did not give any result.  No one in the literal sense of the word - the client found the local database engine, tried to establish a connection, but the server did not respond to these attempts.  It was obvious that the problem was with <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D0%25BF%25D1%2580%25D0%25BE%25D1%2586%25D0%25B5%25D1%2581%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B2%25D0%25B7%25D0%25B0%25D0%25B8%25D0%25BC%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25B9%25D1%2581%25D1%2582%25D0%25B2%25D0%25B8%25D0%25B5">IPC</a> .  Linter supports several interprocess communication mechanisms: local sockets, shared memory, mailslot, but it was the <a href="https://ru.wikipedia.org/wiki/Mailslot">latter</a> that were the way to communicate tests with the default kernel.  After reconfiguring and rebuilding tests using shared memory, we were able to confirm our assumption - the problem was the implementation of mailslot under ReactOS, and a detailed study was able to find the reason: calling the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/aa365147%2528v%3Dvs.85%2529.aspx">CreateMailslot</a> function with the parameter lReadTimeout = MAILSLOT_WAIT_FOREVER led to an immediate return with the ERROR_SEM_TIMEOEOUTE code 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">hMailslotClient = CreateMailslot(LMS, <span class="hljs-number"><span class="hljs-number">0L</span></span>, MAILSLOT_WAIT_FOREVER, (LPSECURITY_ATTRIBUTES) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hMailslotClient == INVALID_HANDLE_VALUE) { dbgError(GetLastError(),__LINE__); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre>  <i>The full example is available <a href="">here</a> .</i> <br><br>  The corresponding <a href="https://jira.reactos.org/browse/CORE-10188">bug report was introduced</a> , which was corrected <a href="">quickly</a> enough.  As it turned out, the MAILSLOT_WAIT_FOREVER (-1LL) value was passed without checking as a parameter timeout to the <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff553350%2528v%3Dvs.85%2529.aspx">KeWaitForSingleObject</a> function, which was an error, since the latter operates not in milliseconds but in hundreds of nanoseconds, negative values ‚Äã‚Äãare interpreted as a relative timeout, and positive values ‚Äã‚Äãare interpreted as absolute, that is Before fixing this error, MAILSLOT_WAIT_FOREVER for ReactOS was 100 nanoseconds. <br>  <i>The patchboot report is available <a href="https://www.reactos.org/sites/all/modules/reactos/testman/compare.php%3Fids%3D41762,41764">here</a> .</i> <br><br><h1>  Asynchronous slot read error </h1><br>  The problem with timeouts was not the only problem in the implementation of mailslot - almost immediately after the start of communication, the client application with the kernel looked for a deadlock and slot.  Starting to look for the cause, I discovered that the mailslot file system (msfs.sys) driver in the ReactOS implementation does not support asynchronous reading from the slot: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ReadFile(hMailslotClient, lpszBuffer, LENMSG, &amp;cbRead, &amp;stOverlapped)) { <span class="hljs-comment"><span class="hljs-comment">//ERROR_IO_PENDING (997) is not a failure!! dbgError(GetLastError(),__LINE__); _tprintf(TEXT("starting writer...\n")); startWriter(); if (!GetOverlappedResult( hMailslotClient, &amp;stOverlapped, &amp;cbTr, TRUE)) { dbgError(GetLastError(),__LINE__); return 1; } }</span></span></code> </pre>  <i>The full example is available <a href="">here</a> .</i> <br><br>  The new <a href="https://jira.reactos.org/browse/CORE-10245">bug report</a> was not so rapidly closed, which is understandable, given the volume of corrections.  Therefore, I decided to help improve the driver, although, I confess, the last time the driver for Windows was written in student times. <br>  My improvements to msfs.sys were reduced to processing IRP packets using <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff540755%2528v%3Dvs.85%2529.aspx">Cancel-Safe IRP queues</a> , which made it possible to organize asynchronous reading from the slot.  Not the most elegant option, but quite simple and reliable.  Edits were added in commit <a href="https://svn.reactos.org/svn/reactos%3Fview%3Drevision%26revision%3D69475">69475</a> , after which we managed to successfully ‚Äúdrive out‚Äù all the functional tests of the Linter kernel. <br>  <i>The patchboot report is available <a href="https://www.reactos.org/sites/all/modules/reactos/testman/compare.php%3Fids%3D42284,42285">here</a> .</i> <br><br><h1>  Errors in mbstowcs and wcstombs </h1><br>  The last errors I found in ReactOS initially ‚Äúsurfaced‚Äù in the form of artifacts in the lines of the graphical interfaces of the Linter administration tools.  All these applications are built on the basis of our cross-platform UI library - RelAPI.  As it turned out, the most innocuous bugs turned out to be a manifestation of the most serious errors in ReactOS: the <a href="https://msdn.microsoft.com/en-us/library/k1f9b8cy.aspx">mbstowcs</a> and <a href="https://msdn.microsoft.com/ru-ru/library/5d7tc9zw.aspx">wcstombs</a> functions did not properly handle the situation when the first parameter was NULL: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> rosStr[BUFFER_SIZE] = <span class="hljs-string"><span class="hljs-string">"Reactos"</span></span>; cnt = mbstowcs(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,rosStr,BUFFER_SIZE); <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> rosStr[BUFFER_SIZE] = <span class="hljs-string"><span class="hljs-string">L"Reactos"</span></span>; cnt = wcstombs(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,rosStr,BUFFER_SIZE);</code> </pre>  <i>The full example is available <a href="">here</a> .</i> <br><br>  The corresponding <a href="https://jira.reactos.org/browse/CORE-10390">bug report</a> was quickly closed, which made it possible to complete the tests of our product under the control of ReactOS. <br>  <i>The patchboot report is available <a href="https://www.reactos.org/sites/all/modules/reactos/testman/compare.php%3Fids%3D42843,42848">here</a> .</i> <br><br><h1>  Iron test </h1><br>  In a discussion, ReactOS often skips questions in the spirit of ‚ÄúDoes this OS work on real modern hardware?‚Äù - in my case, the answer is yes: it works, but not without problems.  The first of these was the inability of the ehci controller, usb keyboard and mouse, was successfully emulated by the BIOS as legacy and worked, but until the usbehci.sys driver rejected the controller, so we had to refuse it (driver), with all the consequences consequences in the form of non-working USB devices.  The second problem was the unstable operation of the OS, which periodically "fell" in the BSOD in hdaudbus.sys (bus driver for High Definition Audio).  This problem was solved by disabling the corresponding controller in the BIOS settings. <br>  After all the manipulations made, the system running ReactOS (build 20151025-r69700) worked stably and allowed to ‚Äúrun out‚Äù all the necessary tests and performance measurements. <br><div class="spoiler">  <b class="spoiler_title">All experiments were conducted on the equipment:</b> <div class="spoiler_text">  pechenkin @ big: ~ $ lspci -nn <br>  00: 00.0 Host bridge [0600]: Intel Corporation 2nd Generation Core Processor Family DRAM Controller [8086: 0100] (rev 09) <br>  00: 01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 / 2nd Generation Core Processor PCI Express Root Port [8086: 0101] (rev 09) <br>  00: 16.0 Communication controller [0780]: Intel Corporation 6 Series / C200 Series Chipset Family MEI Controller # 1 [8086: 1c3a] (rev 04) <br>  00: 1a.0 USB controller [0c03]: Intel Corporation 6 Series / C200 Series Chipset USB Enhanced Host Controller # 2 [8086: 1c2d] (rev 05) <br>  00: 1c.0 PCI bridge [0604]: Intel Corporation 6 Series / C200 Series Chipset PCI Express Root Port 1 [8086: 1c10] (rev b5) <br>  00: 1c.3 PCI bridge [0604]: Intel Corporation 82801 PCI Bridge [8086: 244e] (rev b5) <br>  00: 1c.4 PCI bridge [0604]: Intel Corporation 6 Series / C200 Series Chipset PCI Express Root Port 5 [8086: 1c18] (rev b5) <br>  00: 1c.5 PCI bridge [0604]: Intel Corporation 6 Series / C200 Series Chipset PCI Express Root Port 6 [8086: 1c1a] (rev b5) <br>  00: 1d.0 USB controller [0c03]: Intel Corporation 6 Series / C200 Series Chipset USB Enhanced Host Controller # 1 [8086: 1c26] (rev 05) <br>  00: 1f.0 ISA bridge [0601]: Intel Corporation Z68 Express Chipset Family LPC Controller [8086: 1c44] (rev 05) <br>  00: 1f.2 SATA controller [0106]: Intel Corporation 6 Series / C200 Series Chipset Family SATA AHCI Controller [8086: 1c02] (rev 05) <br>  00: 1f.3 SMBus [0c05]: Intel Corporation 6 Series / C200 Series Chipset Family SMBus Controller [8086: 1c22] (rev 05) <br>  01: 00.0 VGA compatible controller [0300]: NVIDIA Corporation GF104 [GeForce GTX 460] [10de: 0e22] (rev a1) <br>  01: 00.1 Audio device [0403]: NVIDIA Corporation GF104 High Definition Audio Controller [10de: 0beb] (rev a1) <br>  03: 00.0 PCI bridge [0604]: Integrated Technology Express, Inc.  Device [1283: 8892] (rev 10) <br>  05: 00.0 USB controller [0c03]: Etron Technology, Inc.  EJ168 USB 3.0 Host Controller [1b6f: 7023] (rev 01) <br>  06: 00.0 USB controller [0c03]: Etron Technology, Inc.  EJ168 USB 3.0 Host Controller [1b6f: 7023] (rev 01) <br></div></div><br>  The result of the TPC-B test on ReactOS for fat32, the Linter pool size is 390 MB .: <br><pre> <code class="bash hljs">Mode = PESSIMISTIC Accounts = 1000 .... Transactions: 817600 Working time: 299 seconds Speed = 2727.333 tps</code> </pre><br><br>  The result of the TPC-B test on Windows 7, fat32, Linter pool size is 390 MB .: <br><pre> <code class="bash hljs">Mode = PESSIMISTIC Accounts = 1000 .... Transactions: 688400 Working time: 299 seconds Speed = 2298.881 tps</code> </pre><br><br><h1>  Slightly subjective </h1><br>  ReactOS is now in alpha state, which the project‚Äôs official <a href="https://reactos.org/ru">website</a> honestly reports and is not suitable for use in production, but I got the impression that if necessary, the OS can be brought to the ‚Äúmind‚Äù in a reasonable time to work on specific equipment with a limited set software.  In addition, I think that for those who like to ‚Äúget‚Äù iron or dig into the guts of the OS, this project will undoubtedly be interesting.  Separately, it is worth noting the goodwill of the ReactOS community and its focus on achieving results. </div><p>Source: <a href="https://habr.com/ru/post/271121/">https://habr.com/ru/post/271121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271111/index.html">AllcountJS and ionic: Mobile application for CRM in 30 minutes</a></li>
<li><a href="../271113/index.html">Two-factor authentication of AnyConnect clients. Active Directory and Azure Multi-Factor Authentication Server</a></li>
<li><a href="../271115/index.html">Hibernate. Basic principles of working with sessions and transactions</a></li>
<li><a href="../271117/index.html">Hammer on the ORM</a></li>
<li><a href="../271119/index.html">Microsoft boosts Edge web browser security</a></li>
<li><a href="../271123/index.html">Phishing Email Examples</a></li>
<li><a href="../271125/index.html">Indication notification LED webcam [Part 1]</a></li>
<li><a href="../271127/index.html">New Intel data center: high efficiency and extreme density of equipment placement</a></li>
<li><a href="../271131/index.html">GOTO or not GOTO that is the question</a></li>
<li><a href="../271133/index.html">Work with HealthKit. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>