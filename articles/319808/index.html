<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fighting borrowing verification</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most common questions for newbies is ‚ÄúHow can I please credit verification?‚Äù. Borrowing testing is one of the coolest parts of the Rust lea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fighting borrowing verification</h1><div class="post__text post__text-html js-mediator-article"><p>  One of the most common questions for newbies is ‚ÄúHow can I please credit verification?‚Äù.  Borrowing testing is one of the coolest parts of the Rust learning curve and, of course, beginners have difficulty applying this concept in their programs. </p><br><p>  Only recently, the question <a href="https://www.reddit.com/r/rust/comments/5ny09j/tips_to_not_fight_the_borrow_checker/">‚ÄúTips on how not to fight the borrowing test?‚Äù</a> Appeared on the <a href="https://www.reddit.com/r/rust/">Rust</a> <a href="https://www.reddit.com/r/rust/comments/5ny09j/tips_to_not_fight_the_borrow_checker/">loan</a> . </p><br><p>  Many members of the Rust community brought useful tips on how to avoid the troubles associated with this test, tips that shed light on how you should design your code on Rust (hint: not the way you do it in Java). </p><br><p>  In this post I will try to show a few pseudo-real examples of common traps. </p><a name="habracut"></a><br><p>  To begin with, I summarize the rules for checking borrowing: </p><br><ol><li>  You can only have one variable variable reference at a time. </li><li>  You may have as many non-exchangeable references to a variable as needed. </li><li>  You cannot mix mutable and immutable references to a single variable. </li></ol><br><h1 id="dolgozhivuschie-bloki">  Long lived blocks </h1><br><p>  Since  you can only have one variable borrowing at a time, then you can get problems if you want to change something twice in one function.  Even if the borrowing does not intersect, the borrowing check will complain. </p><br><p>  Look at an example that does not compile. </p><br><pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span></span> { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, age: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Person { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, age: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>) -&gt; Person { Person { name: name.into(), age: age, } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">celebrate_birthday</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.age += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{} is now {} years old!"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.age); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span> { &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill = Person::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jill_ref_mut = &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill; jill_ref_mut.celebrate_birthday(); <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, jill.name()); <span class="hljs-comment"><span class="hljs-comment">//   jill   //       //  }</span></span></code> </pre> <br><p>  The problem here is that we have a variable <strong>jill</strong> borrowing and then we again try to use it to print the name.  Restrict the situation will help limit the scope of borrowing. </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill = Person::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>); { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jill_ref_mut = &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill; jill_ref_mut.celebrate_birthday(); } <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, jill.name()); }</code> </pre> <br><p>  In general, it is a good idea to limit the scope of its variable links.  This avoids problems similar to the one shown above. </p><br><h1 id="cepochka-vyzovov">  Call chain </h1><br><p>  You often want to concatenate function calls to reduce the number of local variables and let-assignments.  Imagine that you have a library that <strong>leverages the Person</strong> and <strong>Name</strong> structures.  You want to receive a changeable link to the name of the person and update it. </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[derive(Clone)]</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Name</span></span></span></span> { first: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, last: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Name { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(first: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, last: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; Name { Name { first: first.into(), last: last.into(), } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first_name</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span> { &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.first } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span></span> { name: Name, age: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Person { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(name: Name, age: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>) -&gt; Person { Person { name: name, age: age, } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; Name { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name.clone() } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = Name::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>, <span class="hljs-string"><span class="hljs-string">"Johnson"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill = Person::new(name, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = jill.name().first_name(); <span class="hljs-comment"><span class="hljs-comment">//   //     }</span></span></code> </pre> <br><p>  The problem here is that <strong>Person :: name</strong> returns ownership of the variable instead of referring to it.  If we are trying to get a link using <strong>Name :: first_name</strong> , then the borrowing check will complain.  As soon as the block is completed, the value returned from <strong>jill.name ()</strong> will be deleted and the <strong>name</strong> will be a dangling pointer. </p><br><p>  The solution is to enter a temporary variable. </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = Name::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>, <span class="hljs-string"><span class="hljs-string">"Johnson"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill = Person::new(name, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = jill.name(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = name.first_name(); }</code> </pre> <br><p>  In a good way, we have to return the <strong>&amp; Name</strong> from <strong>Person :: name</strong> , but there are several cases in which returning ownership of a value is the only reasonable option.  If this happens, then it would be good to know how to fix your code. </p><br><h1 id="ciklicheskie-ssylki">  Cyclical links </h1><br><p>  Sometimes you come across circular references in your code.  This is what I have used too often in C programming.  The fight against checking borrowing in Rust showed me how dangerous such code could be. </p><br><p>  Create a presentation of classes and students enrolled in them.  The lesson refers to the students, and the students, in turn, retain references to the classes they attend. </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, classes: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;&amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { Person { name: name.into(), classes: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(), } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { pupils: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;&amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, teacher: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(teacher: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;) -&gt; Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { Class { pupils: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(), teacher: teacher, } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_pupil</span></span></span></span>(&amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, pupil: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Person&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;) { pupil.classes.push(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pupils.push(pupil); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jack = Person::new(<span class="hljs-string"><span class="hljs-string">"Jack"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jill = Person::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> teacher = Person::new(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> borrow_chk_class = Class::new(&amp;teacher); borrow_chk_class.add_pupil(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jack); borrow_chk_class.add_pupil(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> jill); }</code> </pre> <br><p>  If we try to compile the code, we will be bombarded with error messages.  The main problem is that we are trying to keep references to lessons from students and a lot of things.  When variables are deleted (in the reverse order of creation), the <strong>teacher</strong> will also be deleted, but <strong>jill</strong> and <strong>jack will</strong> still refer to the activity that should be deleted. </p><br><p>  The simplest (but difficult to read) solution is to avoid checking borrowing and use <strong>Rc &lt;RefCell&gt;</strong> . </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::rc::Rc; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::cell::RefCell; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span></span> { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, classes: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;Rc&lt;RefCell&lt;Class&gt;&gt;&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Person { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; Person { Person { name: name.into(), classes: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(), } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span></span> { pupils: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;Rc&lt;RefCell&lt;Person&gt;&gt;&gt;, teacher: Rc&lt;RefCell&lt;Person&gt;&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Class { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(teacher: Rc&lt;RefCell&lt;Person&gt;&gt;) -&gt; Class { Class { pupils: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(), teacher: teacher.clone(), } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pupils_mut</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;Rc&lt;RefCell&lt;Person&gt;&gt;&gt; { &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pupils } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_pupil</span></span></span></span>(class: Rc&lt;RefCell&lt;Class&gt;&gt;, pupil: Rc&lt;RefCell&lt;Person&gt;&gt;) { pupil.borrow_mut().classes.push(class.clone()); class.borrow_mut().pupils_mut().push(pupil); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jack = Rc::new(RefCell::new(Person::new(<span class="hljs-string"><span class="hljs-string">"Jack"</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jill = Rc::new(RefCell::new(Person::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> teacher = Rc::new(RefCell::new(Person::new(<span class="hljs-string"><span class="hljs-string">"John"</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> borrow_chk_class = Rc::new(RefCell::new(Class::new(teacher))); Class::add_pupil(borrow_chk_class.clone(), jack); Class::add_pupil(borrow_chk_class, jill); }</code> </pre> <br><p><del>  Note that now we have no guarantees of security, which gives a check of borrowing. </del></p><br><p>  As indicated / u / steveklabnik1, <a href="https://www.reddit.com/r/rust/comments/5obein/fighting_the_borrow_checker/dci15nw/">quote</a> : </p><br><blockquote>  Note that Rc and RefCell both rely on a security mechanism at runtime, i.e.  we lose compile-time checks: for example, RefCell will panic if we try to call borrow_mut twice. </blockquote><p>  Perhaps the best option would be to reorganize the code in such a way that circular references are not required. </p><br><p>  If you have ever normalized relationships in a database, then this is a similar case.  We will keep the links between the student and the lesson in a separate structure. </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Enrollment</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { person: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person, class: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; Enrollment&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(person: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person, class: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;) -&gt; Enrollment&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { Enrollment { person: person, class: class, } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span></span> { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Person { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; Person { Person { name: name.into(), } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { teacher: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(teacher: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person) -&gt; Class&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { Class { teacher: teacher, } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">School</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { enrollments: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;Enrollment&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; School&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>() -&gt; School&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { School { enrollments: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(), } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enroll</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, pupil: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Person, class: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> Class) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.enrollments.push(Enrollment::new(pupil, class)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jack = Person::new(<span class="hljs-string"><span class="hljs-string">"Jack"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> jill = Person::new(<span class="hljs-string"><span class="hljs-string">"Jill"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> teacher = Person::new(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> borrow_chk_class = Class::new(&amp;teacher); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> school = School::new(); school.enroll(&amp;jack, &amp;borrow_chk_class); school.enroll(&amp;jill, &amp;borrow_chk_class); }</code> </pre> <br><p>  In any case, this approach is better.  There is no reason for the student to keep information about what classes he attends and the class itself should not contain information about who attends it.  If this information is needed, it can be obtained from the list of visits. </p><br><h1 id="v-zaklyuchenie">  Finally </h1><br><p>  If you still do not understand why the rules for checking borrowing are as they are, then this explanation of the reddit user / u / Fylwind can help.  He remarkably <a href="https://www.reddit.com/r/rust/comments/5ny09j/tips_to_not_fight_the_borrow_checker/dcf9zdv/">cited an analogy with a read-write lock</a> : </p><br><blockquote>  I think of borrowing as a blocking system (read-write lock).  If you have an immutable link, then it appears as a shared lock on the object, in case you have a changeable link, then this is already an exclusive lock.  And, as with any lock system, holding the lock longer than necessary is a bad idea.  This is especially bad for mutable links. </blockquote><p>  Ultimately, if at first glance it seems to you that you are struggling with the verification of borrowing, then you will love it as soon as you learn how to use it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/319808/">https://habr.com/ru/post/319808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319796/index.html">Episode 3 - a new hope for the success of the game for Android</a></li>
<li><a href="../319798/index.html">Why do people play games</a></li>
<li><a href="../319800/index.html">What are the service providers of data centers, and how to choose the best?</a></li>
<li><a href="../319804/index.html">Pure javascript.Classes</a></li>
<li><a href="../319806/index.html">Product development: two years of work on the Otkrytie Bank mobile app</a></li>
<li><a href="../319810/index.html">Z-order vs R-tree, continued</a></li>
<li><a href="../319812/index.html">International Student School Recent Advances in Algorithms: St. Petersburg, May 22‚Äì26, 2017</a></li>
<li><a href="../319814/index.html">What to catch in the career of an IT architect: expectations VS reality</a></li>
<li><a href="../319820/index.html">How to avoid self-excitation of cellular amplifier</a></li>
<li><a href="../319822/index.html">IT outsourcing in Russia - current realities and perspectives, opinions and experience of experts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>