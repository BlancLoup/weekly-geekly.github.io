<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to Go - we write a grabber of web pages with multithreading and harlots</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone heard about the Go language from the Google team. But not all have tried, and it is in vain - communication with ground squirrels Go...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to Go - we write a grabber of web pages with multithreading and harlots</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone heard about the Go language from the Google team.  But not all have tried, and it is in vain - communication with <s>ground squirrels</s> Go is a sea of ‚Äã‚Äãpleasure, as I recently learned from my own experience. <br>  Getting started with a new language is the funniest thing to do on a life example, so I, without hesitation, took the first task ‚Äúfrom a life of the first importance‚Äù: <br><br>  There is an Internet site <a href="http://vpustotu.ru/">http://vpustotu.ru</a> on which anyone can anonymously speak about the painful.  All statements (I will call them ‚Äúquotations‚Äù in the future) first get into moderation (similar to the ‚Äúabyss‚Äù of the bashorg), where visitors can evaluate the flight of thought and vote for a quote in the style of ‚ÄúWow!‚Äù Or ‚ÄúNonsense!‚Äù.  On the moderation page ( <a href="http://vpustotu.ru/moderation/">http://vpustotu.ru/moderation/</a> ), we are shown a random quote, voting links and the ‚ÄúMore‚Äù link that leads to the same page.  Click, it's all very simple. <br><br>  <b>And then the problem arose</b> - urgently, under the cover of darkness, download a full dump of all quotes on moderation for further secret research.  We will not evaluate the everyday value and degree of idiocy of the task, but consider it from a technical point of view: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the moderation section there are no direct links to a specific quote, the only way to get a new quote is to refresh the page (or follow the link ‚Äúmore‚Äù, which is the same).  And repetitions are quite possible, which is easily detected after a couple of minutes of aggressive clipping. <br><br>  Thus, you need a program that: <br><br><ul><li>  Must consistently update and parse (parse) the page, writing down the quote. </li><li>  Must be able to discard duplicates. </li></ul><br><br>  It is logical that we have no idea whether all the quotes are loaded, but this can be indirectly guessed by a large number of repeated quotes in a row.  Therefore, we add: <br><br><ul><li>  Must stop not only on command, but also to achieve a certain number of "repetitions", for example 500! </li><li>  Since this will most likely take some time: you must be able to continue ‚Äúfrom the place where you left off‚Äù after closing. </li><li>  Well, since all the same it is a long time - let him do his dirty business in several streams.  Well, in as many as 4 threads (or even 5!). </li><li>  And reports on the success in the console every, say, 10 seconds. </li><li>  And let them take all these parameters from the command line arguments! </li></ul><br><br>  Well, everything seems to be clear.  Let the program keep two files - with quotes and with certain hashes of these quotes, so as not to repeat, and reread the file at the beginning of each launch.  Well, then in the cycle it parses the page, pulling out more and more new revelations, until it receives ctrl-c on the forehead or meets a certain number of repetitions.  The task is clear, there is a plan - let's go! <br><a name="habracut"></a><br>  Open your favorite editor to create a new project.  Initially, the code of an empty program looks like this: <br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>) }</code> </pre> <br>  We begin to go through the list and in the order of program execution: <br><br>  We have several parameters like the number of ‚Äústreams‚Äù, file names and more.  All this beauty to get from the command line will help the built-in package ‚Äú <a href="http://golang.org/pkg/flag/">flag</a> ‚Äú.  Add it to the import list and, at the same time, declare the parameter variables: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( WORKERS <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">//- "" REPORT_PERIOD int = 10 //  () DUP_TO_STOP int = 500 //    HASH_FILE string = "hash.bin" //   QUOTES_FILE string = "quotes.txt" //   )</span></span></code> </pre><br>  The type of a variable in Go is written after its name, which may be a bit unusual.  We also immediately initialize the default values ‚Äã‚Äãso that everything is convenient and in one place. <br><br>  Things like parsing arguments are usually done in the <i>init ()</i> function, and we‚Äôll do this: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  : flag.IntVar(&amp;WORKERS, "w", WORKERS, " ") flag.IntVar(&amp;REPORT_PERIOD, "r", REPORT_PERIOD, "  ()") flag.IntVar(&amp;DUP_TO_STOP, "d", DUP_TO_STOP, "-   ") flag.StringVar(&amp;HASH_FILE, "hf", HASH_FILE, " ") flag.StringVar(&amp;QUOTES_FILE, "qf", QUOTES_FILE, " ") //    flag.Parse() }</span></span></code> </pre><br>  <b>UPD:</b> <i>Habrayuser <a href="https://habrahabr.ru/users/forked/" class="user_link">Forked</a> in a <a href="http://habrahabr.ru/post/197598/">comment</a> explains why it is a bad habit to call the flag.Parse () function in init.</i>  <i>Thanks to him for that - from now on, I will do it in main (), which I advise you, but this example will remain here for the edification that ‚Äúfu do that!‚Äù</i> <br><br>  Let's use the functions <i>IntVar</i> (for numbers) and <i>StringVar</i> (for strings) from the <i>flag</i> package - they read the specified key from the command line arguments and pass it to the variable.  If the key is not specified, the default value is taken.  The syntax of the functions is the same: <br><pre> <code class="go hljs">flag.StringVar( &amp;_,  . ,    ,  )</code> </pre><br>  Please note that we pass a pointer to a variable (the &amp; symbol) so that the function can modify it if necessary.  Also interesting is the ‚Äúkey description‚Äù parameter - the fact is that the flag package automatically creates the argument legend available to us by the ‚Äú-h‚Äù key.  You can start the program right now and see this: <br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">C:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Go</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">src</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">habratest</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">habratest.exe</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Usage</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">habratest.exe</span></span></span><span class="hljs-function">: -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">=500: -    -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hf</span></span></span><span class="hljs-function">="</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash.bin</span></span></span><span class="hljs-function">":   -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qf</span></span></span><span class="hljs-function">="</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quotes.txt</span></span></span><span class="hljs-function">":   -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">=10:   () -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function">=2:  </span></span></code> </pre><br>  Further, according to the plan, hashes are loaded at the start of the program, but I propose to return to this later, when we already have something to load.  Imagine that we have so far every launch is the first. <br><br>  Now let's think about the program itself - it should read the page, disassemble it, record the results and analyze the progress.  Yes, and in several "threads" (we will immediately define ourselves - I call the thread thread and not stream. Well, just in case).  Ha! <br><br>  Multitasking in Go is implemented by goroutines ( <a href="http://golang.org/doc/effective_go.html">goroutine</a> ), that is, we can start any function ‚Äúin the background‚Äù by substituting the keyword ‚Äúgo‚Äù in front of it: it starts and the program execution immediately continues, it‚Äôs about running the command from &amp; at the end in linux - we Immediately we can do something else: <br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//   ... func GadgetUmbrella() { //...   ... } //...       ,   : go GadgetUmbrella() fmt.Println(" !") //          ,      GadgetUmbrella()</span></span></code> </pre><br>  In general, the gurutines are not pure flows, everything is much more interesting there, but such things are clearly beyond the scope of our task. <br><br>  I propose to put in a separate ‚Äústream‚Äù a function that will, in an infinite loop, perform the loading and parsing of the page and give the finished quote, let's call it ‚Äúgrabber‚Äù.  Let yourself be spinning in the background in several copies, while we are going to catch these quotes in a cycle from the main program, do what we need with them, and, in case of certain conditions, turn off the work.  It sounds suspiciously simple, especially for those who already have experience of multi-threaded programming and are ready to shout in horror about the numerous nuances of sharing and synchronization. <br><br>  But in reality, everything is really simple, because another great feature of Go is the channels.  Simplistically, the channel is easy to imagine as a pipe into which, on the one hand, it is casting meaning and, on the other hand, it is caught.  Channels are typed and require initialization - in short, working with them like this: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( c </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> {  &lt;- <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-comment"><span class="hljs-comment">//     } func main() { ch := make(chan int) //      (int) go send(ch) b:= &lt;-ch //    fmt.Println(b) }</span></span></code> </pre><br>  Note that I wrote exactly <i>go send (ch)</i> and not just <i>send (ch)</i> .  The fact is that by default, sending and receiving data from the channel blocks the subroutine that has called them until the other end is ready to process the data.  This is such a great synchronization tool. <br>  It turns out that if you remove the " <i>go</i> " then <i>send ()</i> will be executed in the main thread and block it, because it will wait until someone is ready to pick up our number 15. We will take it in the next line, but it will never be on it transferred control.  Deadlock, all in sorrow. <br>  But in the case of " <i>go send ()</i> " everything goes smoothly, because <i>send () is</i> blocked, but in its stream, and will stand until we read in another - and we do it very soon and data exchange occurs successfully. <br>  Also, if you remove the entry to the channel in the <i>send ()</i> function, then the main function on the line <i>b: = &lt;-c</i> will already be dead, on the contrary, it will have nothing to receive. <br>  Channels are first-class objects, respectively, they can be created, transmitted, returned and assigned as it is convenient. <br><br>  We will send data "grabber" and we will receive them in the main loop. <br><br>  The quote in the page code simply lies in a div with the class "fi_text".  In order to get it in the ‚Äúgrabber‚Äù we will use the <a href="http://github.com/opesun/goquery">goquery</a> package - it allows you to parse the html-page and access its contents through selectors a la jQuery.  This package is not in the standard package, so you need to install it first: <br><pre> <code class="dos hljs">#  : go get github.com/opesun/goquery</code> </pre><br>  And in the import section in the code we add the packages <i>‚Äúgithub.com/opesun/goquery‚Äù, ‚Äústrings‚Äù</i> and <i>‚Äútime‚Äù</i> - we will need the latter for the delay, but we will not constantly pull the server with our requests (well, and so we will, but you understood me): <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/opesun/goquery"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> )</code> </pre><br><br>  Closer to the matter - write the code "grabber": <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grab</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &lt;-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chan</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,        string c := make(chan string) for i := 0; i &lt; WORKERS; i++ { //       - worker'o go func() { for { //     x, err := goquery.ParseUrl("http://vpustotu.ru/moderation/") if err == nil { if s := strings.TrimSpace(x.Find(".fi_text").Text()); s != "" { c &lt;- s //     } } time.Sleep(100 * time.Millisecond) } }() } fmt.Println(" : ", WORKERS) return c }</span></span></code> </pre><br>  The code is very simple and requires almost no comments. <br>  We use a closure to create the number of ‚ÄúGourutin‚Äù we need to perform an anonymous function that constantly sends data to the channel returned by <i>grab ()</i> .  Such a pattern is called a generator. <br>  For some reason, <i>x.Find (". Fi_text"). Text ()</i> returned to me the contents of the desired element with spaces at the beginning and at the end, therefore, without hesitation, we clear it with the <i>TrimSpace</i> function from the standard <i>strings</i> module. <br><br>  So the generator is ready, you can make sure that it works by modifying the function main (): <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { quote_chan := grab() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; i++ { <span class="hljs-comment"><span class="hljs-comment">// 5    fmt.Println(&lt;-quote_chan, "\n") } }</span></span></code> </pre><br>  We start and see that everything is going according to plan: revelations flow into our channel in a wide stream! <br><img src="http://habrastorage.org/storage3/30b/975/a04/30b975a0470e6d17682226428c041cd0.png"><br><br>  Now we will think over the main cycle in which, according to the plan, values ‚Äã‚Äãshould be collected.  According to the requirements and wishes, we need a cycle that: <br><br><ul><li>  collects quotes. </li><li>  checks their uniqueness by comparing hash quotes with existing ones </li><li>  saves quote and hash to files in case of new quote </li><li>  monitors the number of repeats in a row </li><li>  reports every REPORT_PERIOD seconds </li><li>  well, and since the cycle is infinite, we will catch ctrl-c to exit correctly at the user's command. </li></ul><br><br>  With the collection, we have no problems anymore, let's decide on the hashes. <br>  For simplicity, I suggest taking md5 from a quote.  We will store the hashes in the <a href="http://golang.org/doc/effective_go.html">map</a> (built-in structure for key-value stores), so they will be easily and quickly searched.  Check the uniqueness, calculate statistics and repetitions - this is a matter of technology.  Working with files in Go is no different from other languages, so there are no problems here either. <br><br>  The time report can be implemented with the help of <a href="http://golang.org/pkg/time/">Ticker</a> from the standard package " <i>time</i> ".  This is the simplest timer that will work after a specified period of time and send a certain value to its channel ‚Äî all you have to do is monitor the channel and output statistics when data arrives. <br><br>  And we will catch the completion command with the help of the <i>os / signal</i> package, which allows a notifier to be sent to certain signals, sending event notifications to the channel. <br><br>  The plan is ready - but there is one nuance: we have three different channels from which we want to receive data, however, it was said earlier that when waiting for a read, the stream is blocked, so we can wait for information on a maximum of one channel at a time. <br>  But go, it is not for nothing that he eats his CPU time - another great tool is the <a href="http://golang.org/ref/spec">select</a> construct. <br>  <i>Select</i> allows you to expect data from an unlimited number of channels, blocking the execution only in the case of the arrival of the next data, while they are being processed.  What we need! <br><br>  Let's get down to the code!  First we will add the necessary packages to the import section, now it will look like this: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/opesun/goquery"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-comment"><span class="hljs-comment">//,        : "io" "os" "os/signal" //   -   : "crypto/md5" "encoding/hex" )</span></span></code> </pre><br>  Yes, a lot of things ... Given the static linking Go, the size of the executable file should be impressive! <br>  But not time to be sad, we will declare storage for hashes: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( ... used <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) <span class="hljs-comment"><span class="hljs-comment">//map        ,    -  . )</span></span></code> </pre><br>  And finally, our main function turns into: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ... quotes_file, err := os.OpenFile(QUOTES_FILE, os.O_APPEND|os.O_CREATE, 0666) check(err) defer quotes_file.Close() //...    hash_file, err := os.OpenFile(HASH_FILE, os.O_APPEND|os.O_CREATE, 0666) check(err) defer hash_file.Close() // Ticker          ticker := time.NewTicker(time.Duration(REPORT_PERIOD) * time.Second) defer ticker.Stop() // ,     ,     ... key_chan := make(chan os.Signal, 1) signal.Notify(key_chan, os.Interrupt) //...       hasher := md5.New() //    quotes_count, dup_count := 0, 0 // , ! quotes_chan := grab() for { select { case quote := &lt;-quotes_chan: // ""  : quotes_count++ // ,     : hasher.Reset() io.WriteString(hasher, quote) hash := hasher.Sum(nil) hash_string := hex.EncodeToString(hash) //    if !used[hash_string] { //   -    ,        used[hash_string] = true hash_file.Write(hash) quotes_file.WriteString(quote + "\n\n\n") dup_count = 0 } else { //  -   ,    ? if dup_count++; dup_count == DUP_TO_STOP { fmt.Println("  ,  .  : ", len(used)) return } } case &lt;-key_chan: //     : fmt.Println("CTRL-C:  .  : ", len(used)) return case &lt;-ticker.C: //, ,        fmt.Printf(" %d /  %d (%d /) \n", len(used), dup_count, quotes_count/REPORT_PERIOD) quotes_count = 0 } } }</span></span></code> </pre><br>  The code is absolutely transparent, we‚Äôll stop only on opening files: <br>  The <i>check ()</i> function is not standard - it is here for easy verification of the results of opening a file for errors.  Here is its code, put it somewhere before <i>main ()</i> : <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(e) } }</code> </pre><br>  Another interesting point: we "immediately" cause the file to be closed, although later we are going to work with it: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> quotes_file.Close() ... <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> hash_file.Close() ... <span class="hljs-comment"><span class="hljs-comment">//      : defer ticker.Stop()</span></span></code> </pre><br>  The bottom line is that by running a function with defer, we postpone its execution: it will be executed only before the function from which the defer call was completed (in other words, right before the ‚Äúparent‚Äù return). <br><br>  You can already start and rejoice at the execution of the ‚Äúterribly necessary mission‚Äù, but one more small detail remains - you need to write a function to read the hashes from the file, in case we want to restart the program again, but do not want to see duplicates in the resulting file.  Here is one way to do it: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readHashes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//    if _, err := os.Stat(HASH_FILE); err != nil { if os.IsNotExist(err) { fmt.Println("   ,   .") return } } fmt.Println(" ...") hash_file, err := os.OpenFile(HASH_FILE, os.O_RDONLY, 0666) check(err) defer hash_file.Close() //    16  -    : data := make([]byte, 16) for { n, err := hash_file.Read(data) //n    ,  err - ,   . if err != nil { if err == io.EOF { break } panic(err) } if n == 16 { used[hex.EncodeToString(data)] = true } } fmt.Println(".  : ", len(used)) }</span></span></code> </pre><br>  That's all, it remains only to remember to place the readHashes () call at the beginning of main () <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { readHashes() ...</code> </pre><br><br>  Done!  Combat launches: <br><img src="http://habrastorage.org/storage3/051/83f/06d/05183f06d93ac8816d6efbf530fbb134.png"><br><br>  Results of work: <br><img src="http://habrastorage.org/storage3/74e/9ed/a11/74e9eda114779583e1d10d000f1733ad.png"><br><br>  Creating files works, rereading hashes when you restart, too.  At the command, she stops, and she also knows how.  The executable file, of course, is too big - but Go with it. <br>  Our program for unloading <s>any nonsense of</s> very important data in the night is ready and does what we wanted from it. <br>  Of course, there is still a huge list of improvements, but for the simple accomplishment of the combat mission of this code is more than enough! <br><br>  <a href="http://pastebin.com/TJjBLLe5">Program code entirely on Pastbin.com</a> <br><br>  If you are interested in Go and its capabilities, here are a few places worth visiting: <br><br>  <a href="http://tour.golang.org/">tour.golang.org</a> - Online language tour, editing the code directly in the browser is very exciting. <br><br>  <a href="https://gobyexample.com/">gobyexample.com</a> - Examples of solving typical tasks <br><br>  <a href="http://golang.org/ref/spec">golang.org/ref/spec</a> - Language Specification <br><br>  <a href="http://golang.org/doc/effective_go.html">golang.org/doc/effective_go.html</a> - An article on the topic ‚Äúand now we are going to take off with all this garbage‚Äù - how to take off and fly Go <br><br>  Go groups dedicated to Google - " <a href="https://groups.google.com/forum/">https://groups.google.com/forum/#!forum/golang-nuts</a> " and " <a href="https://groups.google.com/forum/">https://groups.google.com/forum/#!forum/golang-ru</a> " <br><br>  <a href="http://godoc.org/">godoc.org</a> - Searching for Go packages and their documentation, both built-in and third-party, is an excellent anti-bike thing! <br><br>  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/197598/">https://habr.com/ru/post/197598/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197588/index.html">Collected Website Psd Layout Requirements</a></li>
<li><a href="../197590/index.html">MonoDB vs PostgreSQL performance comparison. Part I: No index</a></li>
<li><a href="../197592/index.html">Digging into SAP data</a></li>
<li><a href="../197594/index.html">System.exit (). What exit code to use?</a></li>
<li><a href="../197596/index.html">Brainbench: 600 free certificates till 10.25.2013</a></li>
<li><a href="../197604/index.html">Open Hand Dextrus - palm prosthesis, which costs less than $ 1000</a></li>
<li><a href="../197606/index.html">On a singularity of the Kotelnikov theorem</a></li>
<li><a href="../197608/index.html">The software package ViPNet Client for Android is certified by the Federal Security Service of Russia</a></li>
<li><a href="../197610/index.html">Xunlei download manager is used to hide Android applications</a></li>
<li><a href="../197612/index.html">Another FullHD option by air</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>