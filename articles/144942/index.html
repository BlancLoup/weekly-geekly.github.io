<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Liang-Knuth's algorithm in a real project, or as I did the iOS reader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! This time I want to tell you how I implemented the iBooks alternative. In my previous post I wrote about the soft hyphenation algorithm in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Liang-Knuth's algorithm in a real project, or as I did the iOS reader</h1><div class="post__text post__text-html js-mediator-article">  Hello!  This time I want to tell you how I implemented the iBooks alternative.  In my previous post I wrote about <a href="http://habrahabr.ru/post/138088/">the soft hyphenation algorithm</a> in the text.  It was just useful when creating your reading room, you can appreciate its work clearly in the <a href="http://itunes.apple.com/app/neobook-katalog-besplatnyh/id517973229">application</a> .  But besides this, when implementing the project I had to face many other interesting things, such as parsing and rendering HTML with CSS, implementing controls with custom design, etc.  Our <a href="http://habrahabr.ru/users/rashapasta/" class="user_link">rashapasta</a> designer loves to give me tasks with a non-standard interface, which needs to be implemented with pens, but first things first. <br><a name="habracut"></a><br><h2>  UI (or dancing with a tambourine) </h2><br>  In terms of UI in the project, it was not the easiest task to make a grid table with horizontal paging.  As usual, in search of ready-made solutions, I climbed onto <a href="http://stackoverflow.com/">stackoverflow.com</a> , but alas, everything that went over was more or less unsuitable. <br>  There were high hopes for <a href="https://github.com/AlanQuatermain/AQGridView">AQGridView</a> , but as it turned out, there are only empty stubs from horizontal filling and paging.  It was decided to give her a second chance and apply a familiar trick to turning the table 90 degrees.  At first this option even seemed to be working and less acceptable, but even here there were some stones. <br><br>  The <i>bugs</i> in the <i>AQGridView</i> itself and in the standard <i>UIScrollView</i> beat me <i>away</i> from the desire to use this component.  In some situations, the grid was constantly breaking down: some cells dropped out and order was constantly flying.  In order to dispel doubts about my curvature, I tried to reproduce the problem on the demo from the kit - the bug was confirmed. <br>  As for the <i>UIScrollView</i> and its derivatives - here I also first sinned on <i>AQGridView</i> , but when I began to use <i>UITableView</i> , the problem repeated.  The essence of the bug is that with the <i>UIScrollView</i> rotated through the transformation, the bounce effect fell off, which was very ugly and unnatural for iOS. <br><br>  It was experienced that it turned out that the resize and the movement of the <i>UIScrollView were</i> guilty when the device was turning, which was done by hand through the <i>layoutSubviews</i> handler.  Having taken my shaman tambourine, I found out that the positioning of the rotated <i>UIScrollView</i> through the <i>center</i> property breaks everything.  Probably there were some other conditions, but so many options were tried that it was impossible to remember. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This whole long story ended up having to be perverted with the good old <i>UITableView</i> .  I fixed the bounce, and the problem with the turn was solved.  A table cell is made the size of a page and consists of several sub-cells, each of which is implemented as an instance of a separate class.  It turned out like this: <br><br> <a href=""><img src="https://habrastorage.org/storage2/838/a2f/54a/838a2f54a8357a617abf5947d1ad670f.png"></a> <br><br><h2>  Working with HTML and Liang-Knuth algorithm. </h2><br>  With parsing popular e-book formats and rendering is another story.  HTML is not difficult in principle, <i>libxml</i> did a great job.  The HTML file is processed recursively, divided into blocks of text, each block is assigned the appropriate attributes.  It remains to drive all this into the framesetter from <i>CoreText</i> and is ready.  But it was not there!  It is necessary to make transfers and alignment in width.  I had to go down a level and use not the framesetter, but the typesetter.  With it, you can conveniently cut the text into lines, for example, by function <br><br><pre><code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CFIndex</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CTTypesetterSuggestClusterBreak</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">CTTypesetterRef</span></span> typesetter, <span class="hljs-built_in"><span class="hljs-built_in">CFIndex</span></span> startIndex, <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> width);</code> </pre> <br>  In the process of splitting into lines need to determine the place of the gap.  If a gap occurs in the middle of a word, then you need to correctly put the transfer.  This is where the implementation of the above-mentioned <a href="http://habrahabr.ru/post/138088/">Liang-Knuth algorithm</a> comes to the rescue. <br><br><h2>  Render (or don't make the user wait!) </h2><br>  All that remains is to cut the resulting mountain of lines of text into pages and render it.  Empirically it turned out that this whole bunch of word processing operations before the render takes a whole lot of time.  From the profiler, I realized that the distribution of hyphenation was to blame.  I drove the calculation of the book into the background and in a separate thread - it began to work faster. <br><br>  The only drawback is that while the render is going, you cannot use the rewind slider.  If it is necessary to move to a chapter that has not yet been processed, we put it first in the processing queue in order to display it on the screen as quickly as possible. <br><br>  The result was not bad, and on the iPad, books are processed fairly quickly (considering that this is a render on the fly). <br><br>  Here is how the rendered pages look in different screen orientations: <br><br> <a href=""><img src="https://habrastorage.org/storage2/c2a/5a8/f14/c2a5a8f1479dc43fb31d67e6a6f606dd.png"></a> <a href=""><img src="https://habrastorage.org/storage2/012/9bc/d4c/0129bcd4c0488b8d889c1a66e3bfc125.png"></a> <br><br>  AFNetworking was normally zayuzan to work on HTTP, I highly recommend it.  The truth was one ‚Äúbut‚Äù, when analyzing an application for memory leaks, there was a problem with the display of file download progress associated with circular references.  In the <i>setDownloadProgressBlock</i> method, <i>there</i> was a block like this: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.progressDelegate respondsToSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(fileDownloadRequest:progressBytes:withTotalBytes:)]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.progressDelegate fileDownloadRequest:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> progressBytes:alreadyDownloadedBytes+totalBytesRead withTotalBytes:alreadyDownloadedBytes+totalBytesExpectedToRead]; }</code> </pre><br>  The presence of self in the code block and caused a cyclical dependence.  This is solved by creating a separate local variable into which the pointer to the delegate is copied, and this variable is already used in the block.  It became like this: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;FileDownloadProgressDelegate&gt; progress = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.progressDelegate; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.request setDownloadProgressBlock:^(<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> bytesRead, <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> totalBytesRead, <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> totalBytesExpectedToRead) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([progress respondsToSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(fileDownloadRequest:progressBytes:withTotalBytes:)]) { [progress fileDownloadRequest:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> progressBytes:alreadyDownloadedBytes+totalBytesRead withTotalBytes:alreadyDownloadedBytes+totalBytesExpectedToRead]; } }];</code> </pre><br>  In the future, as soon as I have free time, I will continue to describe my experience in developing for iOS, but for now I invite you to discuss the result of my work in the comments. </div><p>Source: <a href="https://habr.com/ru/post/144942/">https://habr.com/ru/post/144942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144935/index.html">Mybuild - build system for modular applications</a></li>
<li><a href="../144936/index.html">Valid TK, very short</a></li>
<li><a href="../144938/index.html">Rename files downloaded from rutracker.org</a></li>
<li><a href="../144940/index.html">You will laugh, but Rostelecom-Siberia again reports about the increase in prices through the newspaper</a></li>
<li><a href="../144941/index.html">What is monitoring in IT or why admins began to sleep more?</a></li>
<li><a href="../144943/index.html">2GIS Online knows when the transport will arrive</a></li>
<li><a href="../144944/index.html">What is really going on in the mobile market</a></li>
<li><a href="../144945/index.html">Public transport routes in Novosibirsk, Perm and Stavropol</a></li>
<li><a href="../144946/index.html">Some subtleties of installation on the site of buttons "Share" (share) of social networks</a></li>
<li><a href="../144948/index.html">HP EVA Disk Array - simple!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>