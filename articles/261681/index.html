<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The tale of how "tsifir" did not agree</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I wrote about how to get reproducible results and what difficulties are associated with it. He also spoke in detail about the models tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The tale of how "tsifir" did not agree</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/745/e81/c7c/745e81c7c36e4e1280994fb0cf9d1579.png"></div><br><br>  Some time ago I wrote about how to get reproducible results and what difficulties are associated with it.  He also spoke in detail about the models that allow controlling the work with floating-point numbers in the compiler and separately clarified that if we use any libraries or standards, we must take care that the necessary flags are specified for them too.  And just recently, I came across an interesting problem related to the reproducibility of results when working with OpenMP. <br><br>  What is reproducibility?  Yes, everything is simple - we want to get the same "good tifir" from launch to launch, because for us it is important.  This is critical in many areas where parallel computing is being actively used. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, as you remember, the summation order plays an important role for machine computing, and if we have cycles parallelized using any technology, the reproducibility of results will inevitably arise because no one knows in what order the summation will be performed, and how many ‚Äúchunks‚Äù our initial cycle will be broken.  In particular, this is manifested when using OpenMP in reductions. <br><a name="habracut"></a><br>  Consider a simple example. <br><br><pre><code class="hljs php">!$OMP PARALLEL <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> schedule(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,n a=a+b(i) enddo</code> </pre> <br>  In this case, when using a static scheduler, we simply divide the entire iteration space into an equal number of parts and let each thread perform these iterations.  For example, if we have 1000 iterations, then with 4 threads running, we will get 250 iterations ‚Äúper brother‚Äù.  Our array is an example of shared data for different threads, and therefore we need to take care of the security of the code.  It is a working option to use the reduction and calculate its value in each stream, and then add the obtained "intermediate" results: <br><br><pre> <code class="hljs php">!$OMP PARALLEL <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> REDUCTION(+:a) schedule(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>,n a=a+b(i) enddo</code> </pre><br>  So, even on such a simple example, it is quite simple to get a variation in values. <br>  I changed the number of streams using <i>OMP_SET_NUM_THREADS</i> and got that with 2 streams <i>a</i> = 204.5992, and with 4 already 204.6005.  The method of initializing the array <i>b (i)</i> and <i>a</i> I dropped. <br><br>  It is interesting that talking about reproducible results is possible only under a variety of conditions.  So, the architecture, the OS, the version of the compiler that the application was going to have, and the number of threads should always be constant from launch to launch.  If we change the number of threads, the results will be different, and this is absolutely normal.  However, even if all these conditions are met, the result can still be different, and here the <i>KMP_DETERMINISTIC_REDUCTION</i> environment <i>variable</i> and the static scheduler should help us.  I will make a reservation that using it will not give us a guarantee of the coincidence of the results of parallel and sequential versions of the application, as well as with a different launch, which used a great number of threads.  It is important to understand. <br><br>  This is a fairly narrow case, when we really did not change anything, and the results did not agree.  And the main surprise lies in the fact that in some cases <i>KMP_DETERMINISTIC_REDUCTION</i> does not work, although we ‚Äúplayed by the rules.‚Äù <br>  This code, which is slightly more complicated than the first example, gives different results: <br><br><pre> <code class="hljs sql">!$OMP PARALLEL <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> REDUCTION(+:ue) schedule(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>,ns <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> y=<span class="hljs-number"><span class="hljs-number">1</span></span>,ny <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> x=<span class="hljs-number"><span class="hljs-number">1</span></span>,nx ue(x,y)=ue(x,y) + ua(x,y,<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>) enddo enddo enddo !$OMP <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARALLEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span></code> </pre><br>  Even after setting the <i>KMP_DETERMINISTIC_REDUCTION</i> variable, nothing has changed.  Why?  It turns out that in some cases, for performance reasons, the compiler creates its own loop implementation using locks, and does not care about the results.  These cases are easily traced by the assembler.  In the "good" variants, the function call <i>__kmp_reduce_nowait</i> must be.  But for my example this was not done, which somewhat undermines the credibility of <i>KMP_DETERMINISTIC_REDUCTION</i> . <br><br>  So, if you have written the code and the results of your calculations jump from start to start, do not rush to sprinkle ashes on your head.  Disable optimization and run your application.  Check if your data is aligned and set a "strict" model for working with floating point numbers.  The following compiler options may be useful for the test: <br><br><pre> <code class="hljs pgsql">ifort -O0 -openmp -fp-model <span class="hljs-keyword"><span class="hljs-keyword">strict</span></span> -align array32byte</code> </pre><br>  If even with this set of options, the results surprise you, check the cycles parallelized using OpenMP and reductions and turn on <i>KMP_DETERMINISTIC_REDUCTION</i> .  This may work and fix the problem.  If not, look at the assembler and check for the <i>__kmp_reduce_nowait</i> call.  In the case of this call, the problem is probably not with OpenMP or the compiler, but an error has crept into the code.  By the way, the problem with <i>KMP_DETERMINISTIC_REDUCTION</i> we have to solve soon.  But consider this feature now. </div><p>Source: <a href="https://habr.com/ru/post/261681/">https://habr.com/ru/post/261681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261671/index.html">We send and visualize data from the Intel Galileo / Edison board in the Azure cloud</a></li>
<li><a href="../261673/index.html">How to implement conversion from raster to black and white vector on the site</a></li>
<li><a href="../261675/index.html">Z-monitor - update service</a></li>
<li><a href="../261677/index.html">Hierarchical classification of sites in Python</a></li>
<li><a href="../261679/index.html">Grid for responsive design</a></li>
<li><a href="../261683/index.html">Dino - a new state-sponsored spyware with French roots</a></li>
<li><a href="../261687/index.html">Microsoft is preparing a major update for Windows RT</a></li>
<li><a href="../261689/index.html">Compromise microservices</a></li>
<li><a href="../261691/index.html">FLProg - continuation of evolution</a></li>
<li><a href="../261699/index.html">How I compiled the application bundle for MacOS on Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>