<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúProfit is great. We got a lot of freedoms that we didn‚Äôt have before, ‚Äù- Vladimir Plizga about microservices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now it is very fashionable to implement microservices, but not everyone is good at it. In particular, when it comes to large enterprises and banking s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúProfit is great. We got a lot of freedoms that we didn‚Äôt have before, ‚Äù- Vladimir Plizga about microservices</h1><div class="post__text post__text-html js-mediator-article"><p>  Now it is very fashionable to implement microservices, but not everyone is good at it.  In particular, when it comes to large enterprises and banking systems.  Someone over the years can not cut your monolith, someone is not sure about fault tolerance and so on. </p><br><p>  Today we will talk about the implementation of microservice architecture in the Center for Financial Technologies (CFT) - a group of companies working in the field of information technology for the financial sector since 1991.  That is, it is an organization where product quality is extremely important, real money depends on it. </p><br><p>  In turn, Vladimir Plizga for the last 6 years has been immersed in developing the backend of Internet banks and related services at CFT, where he actively drowns for microservices and other fashionable things.  To talk with him, I came straight to the CFT office, made a selfie and a mandatory photo of a red elephant :-) </p><br><p>  Topics covered: </p><br><ul><li>  Why do we need microservices; </li><li>  How to live with them (the fate of REST and SOAP, statefull vs. stateless, the transition from monolith to microservices, compatibility with legacy and much more); </li><li>  Microservice technologies (Spring Cloud Netflix, Zuul, ...), what problems with them, what needs to be done; </li><li>  Documentation: in Russian or English?  Writing and generating documentation (Swagger, SpringMVC, SpringFox).  Architectural diagrams - whether you need, in what to draw, how to store; </li><li>  Monitoring, recovery from failures; </li><li>  <strong>And most importantly: is the game worth the candle?</strong> </li></ul><br><div style="text-align:center;"><img width="1024" src="https://habrastorage.org/webt/nz/qg/uy/nzqguy-ia0-5s_aullz5kjfzliw.png"></div><br><p>  (on the left - Vladimir, on the right - <a href="https://habrahabr.ru/users/olegchir/" class="user_link">olegchir</a> ) </p><a name="habracut"></a><br><div style="text-align:center;"><img width="1024" src="https://habrastorage.org/webt/-s/l3/d4/-sl3d4bb4psfnjwcgqqcsebaah8.png"></div><br><p>  - My name is Vladimir Plizga, I have been working at CFT for several years now.  I mainly do Java backend development.  Prior to that, very little worked in other areas, but this can be attributed to the student and post-student period.  To be more precise, now I am engaged in the development of financial services - and not by some brokers and quotations, as they often think when I hear the word "finance", but by Internet banks and related services.  For example, such tools as gift card tracking sites - when people are given a branded universal card instead of cash, where they can pay wherever they accept these cards.  Attached to it is an application with which you can control the costs of this card, view history, activate, receive other profits. </p><br><p>  <strong>- This certificate card is renewable?</strong> </p><br><p>  - It depends on the modification of the product.  Most of them are not replenished.  Its very acquirer, the one who will give it, once replenishes the card for some amount that is comfortable for him, usually from 300 rubles to 15 thousand rubles, gives it, that's all.  There are separate modifications where it is possible to replenish.  But this is not a certificate, but a payment card, this is a full-fledged such financial product.  But it is rather a side, and the main thing for us is just prepaid cards, that is, those cards that are for people a kind of addition to the wallet, either to electronic or to real.  There you can in any convenient way to make money buzz, and then - to pay them even on the Internet, even in stores, even through the payment office itself (we often call it not the ‚ÄúInternet bank‚Äù, but the ‚Äúpayment office‚Äù) for all sorts of needs, ranging from basic payment services such as ‚Äúpay garden‚Äù, ‚Äúpay utility bills‚Äù and so on - a total of more than 5 thousand services are supported - and ending with all sorts of payments with AliExpress and others.  In principle, any electronic. </p><br><p>  My role in all this lies in the fact that at the moment the architectural decisions about the backend pass through me.  This is all about microservices.  Now we are on the way of leaving the monolith to microservices, we are gradually cutting off pieces and we don‚Äôt add new functionality to the monolith in order to follow the rule (someone who is already bored): to get out of the pit, you must first stop digging it.  I also deal with other things, for example, code review, many business tasks pass through me, including fundamentally new functionality.  Well, related cases in terms of performance, architectural improvements ... In a sense, the typical work of a backend developer. </p><br><p>  <strong>- Are you a straight architect-architect, drawing cubes in the editor?</strong> </p><br><p>  - No, because I myself still grow from the application developers, those who directly write the code for someone invented cubes, I feel closer to pushing from practical goals and reality.  Sometimes you have to raise the level of abstraction and try to spread it out for some cubes and diagrams, but I try not to soar in these clouds, but to be more close to the realities with which we have to work.  If these are microservices, then it is designated by specific concepts and paradigms specific to it.  I try especially not to go into abstraction. </p><br><p>  <strong>- But still, draw UML-diagrams?</strong> </p><br><p>  - Yes, we draw, but do not go into extremes of support for their syntax, correctness and so on. </p><br><p>  <strong>- That is, they are not the source of code generation.</strong> </p><br><p>  - No, they are not. </p><br><p>  <strong>- I just had this experience too, and the problem arises when you have a huge number of microservices, you want to have a complete picture of what is happening.</strong>  <strong>How to keep this whole picture, how to fix it before your eyes?</strong> </p><br><p>  - At the moment we go from the opposite.  We do not generate microservices by the picture, but by microservices we support the picture.  We have a scheme, in a sense, this is some kind of UML.  But let me emphasize that we focus primarily on the ease of its perception, support, and do not zeal at supporting syntax and rules.  At the moment we are not much in this direction, it is more than satisfying to us.  Our scheme contains both hyperlinks to documentation, and is in itself replete with some kind of conventions, there is a legend that, where and how it is designated, and thanks to this, we are in it normally oriented.  There are no problems. </p><br><p>  <strong>- Is it generated dynamically from source?</strong> </p><br><p>  - No, we support her in Confluence.  There is a Gliffy plugin that allows you to maintain a picture quite easily at the level of abstract shapes.  Dragging a single block does not force you to manually redraw any links.  Literally, these basic things are still satisfying.  Due to the fact that we divide the plots into separate diagrams, we do not need to support the whole picture, because it is also unsuitable for perception in this form.  There are blocks in which you can fall through and see another, isolated area, which is also suitable for direct perception. </p><br><p>  <strong>- Do you have a system designed so beautifully, competently and carefully that these blocks give a sane structure?</strong> </p><br><p>  - At the moment - yes.  I will not brag too much, I think that now it is explained more by the youth of the system than by the competent architecture :-) Of course, we are trying to support it.  A lot of problems that may arise - we present them a priori, prepare, arm, but in this global form the task has not yet risen, since we are not talking about hundreds of microservices yet. </p><br><p>  <strong>- Now how many microservices are there?</strong> </p><br><p>  - Units of tens. </p><br><p>  <strong>- Already not bad.</strong>  <strong>For many, this is not :-)</strong> </p><br><p>  ‚ÄúBut we're still at the beginning.‚Äù </p><br><p>  <strong>- What are your tasks in this beginning?</strong> </p><br><p>  - Tasks in terms of technical development, architectural? </p><br><p>  <strong>- Tasks in terms of anything.</strong>  <strong>You're an architect here!</strong> </p><br><p>  - Though I am an architect, but first of all I start from the needs of the business, as long as they are first-choice for us.  Business wants value right now.  As we try to be agile, we assume that some things may not even be useful.  If we invest in something, we obviously understand that we are experimenting, testing, testing the ground.  Based on this, we need to build our development and our application so that any refinement would be as cheap as possible - so cheap that it would not even be a shame to throw it away.  Of course, in the absolute this can not be, but nevertheless, thanks to the current direction, we can allow ourselves in one form or another to cut some piece incrementally, without injecting it into the monolith, where it will grow roots and change everything around it, but make such a slapstick next.  To play, to see how it will behave, what it will represent from the point of view of value to the end user, and then, if necessary, throw it out.  Based on these three priorities: speed, cheapness and independence from other components - we are trying to develop components further. </p><br><p>  In what way is this manifested purely technically, if we move from loud words to deeds.  We must try not to build up the monolith.  It is rather large in our case, we call it ‚Äúthe core‚Äù, everything that concerns it is ‚Äúnuclear‚Äù, ‚Äúnucleus‚Äù, something else ... In general, there is no need to go there whenever possible.  Naturally, building communications with external clients for us (this is both the web and various mobile platforms) is necessary without the participation of this core and its satellite satellites.  That is, it was possible to disconnect all connections directly through the entry point so that there at the route level, at the load balancer level, switch this traffic and somehow control it more flexibly than when it is poured into the core in a single stream. </p><br><p>  Plus, we try to build the development itself so that it is as cheap as possible.  We have a whole microservice - it is full-fledged, working, but does not do anything.  And it serves the only purpose - to be a template for creating the rest.  We stupidly copy-paste it, he is already able to do everything, everything is already uplifted in him, set up, he is adapted to the CI test, adapted for rolling on the battlefield, and it is already quite easy to push off from him.  This was done deliberately so that the developers should have minimal effort to start new microservices, up to the point that they played today - then turned and threw it away. </p><br><p>  <strong>- This template is based on what?</strong>  <strong>On something common, like Spring Cloud, or something different?</strong> </p><br><p>  - According to ready-made Cloud solutions ... Perhaps we will not even go down this path, but we will use separate libraries.  This is, first of all, Eureka, Zuul - standard solutions for the registry of services, entry points. </p><br><p>  <strong>- Do you already use it, or is it the direction of development?</strong> </p><br><p>  - Already using.  The entry point and registry services are already in operation.  To break in this solution, we turned on not the combat traffic from the end users, but the auxiliary from the call centers, the one that is not so active and loaded.  As for the base of microservice itself, this is Spring Boot, as, in principle, for all the others.  I do not know if he can be considered "naked."  Of course, with some additional frameworks, most often - frameworks of the same Spring.  We mostly rest on the decisions of the spring. </p><br><p>  <strong>- But did you screw it yourself or did you take what was?</strong>  <strong>For example, Spring Cloud Netflix.</strong>  <strong>That is, annotations, RestTemplate, etc.</strong> </p><br><p> - Yes.  Now the experience of our microservices is that the entry point, that the service registry - from the point of view of the application code - they are very small.  Almost everything comes down to the fact that we have added an annotation, and the rest of the beauty lies outside of the Java code: these are build scripts, start scripts, and everything related to its environment and adaptation to our realities, CI / CD and further down the devops.  However, at the entry point, we also had our own filters for additional access control, security issues, and ensuring backward compatibility of the API - in general, we have our own dopilki.  But again, even the concept of the filter itself is an abstraction taken from the Zuul library itself, which is drawn into Spring Cloud. </p><br><p>  <strong>- Got it.</strong>  <strong>Are you going to use circuit breakers like that?</strong> </p><br><p>  - Yes, we are.  But there is such a situation, that we are going to get ready, and we are already using it ourselves.  Just Zuul, in the delivery of Spring Cloud, already includes Hystrix, and it is already working, and we have to deal with its settings, take into account that its timeouts are configured, to put it mildly, in non-trivial ways, some squats have to be done.  We use it, but I cannot say that we do it as consciously as possible and control everything. </p><br><p>  <strong>- Was there any desire to finish something?</strong>  <strong>In Eureka, for example.</strong>  <strong>Or in Zuul.</strong> </p><br><p>  - Zuul, fortunately, was flexible enough that such a desire did not arise.  Oh, no, I'm lying.  I have a pool rekvestik on GitHub.  Although no, I apologize, now this is just a matter, and the pool-request is in development.  In general, it turned out that Zuul out of the box does not support custom HTTP statuses.  By ‚Äúcustom,‚Äù I mean those that are not standardized by the RFC itself for the HTTP protocol.  431 - no need, no way specified, no light anywhere.  It turned out that in Zuul they were built inside in the guts that the incoming code, which is proxied through the entry point to the outside, would necessarily correspond to one of the enumeration elements sewn into the same source code of Zuul itself.  And when HTTP status comes for it, for which there is no maping, it falls.  And it falls very badly, there is no workaround.  I wrote to them, they answered - well, yes, probably, so, try to fix it.  I just discovered with surprise for myself that this is the place where the main failure occurs, it carries a purely debugging role.  It is designed to bite out a piece of the request in order to correctly log it, and this ‚Äúcorrectly‚Äù implies that it is not the bare HTTP status that will be logged, but the element of this very listing. </p><br><p>  <strong>- It is necessary to deploy the wrapper.</strong> </p><br><p>  - And it turns out that due to debugging, which can be turned off, but at this level it still works, the whole application crashes.  In fact, the severity of this problem has fallen.  We decided not to contact custom HTTP statuses. </p><br><p>  <strong>‚ÄúWhy do you need them at all?‚Äù</strong> </p><br><p>  - There was one idea, if you're interested - I will tell you in a few words.  With their help, we wanted to convey the nuances of the errors that occur or, in general, the answers from the final microservices.  In our case, each business scenario implies a lot of all sorts of deviations from the result.  And for the client it is often important to know how the business scenario and its every step ended.  This can be either the need to retry, later or right now, and the repetition is both user-conscious and automatic - by the client.  This may indicate the need to display a dialog box with a suggestion to change something there.  If you give a specific example, you can take a deposit from a third-party credit card, from which we transfer money to our prepaid cards - there are several requests in this process, and some of them are able to branch further actions on sub-scenarios.  And we just wanted to create such things with custom HTTP statuses.  With your own, to negotiate directly with you at the API level (we have the entire API documented in Swagger) and write it in the following format: status + what the client needs to do.  The topic did not go for several reasons.  There were many different reasons, but one of the main reasons: at that time, the existing monolith had an established API, it was customary to transmit hues of errors not in the form of the HTTP status, but in the form of fields, in the body of the response. </p><br><p>  <strong>- Maybe it's better to put the HTTP headers?</strong> </p><br><p>  - It would be possible to have headers, but in any case, this would require a significant change in the API, which is backward incompatible.  It was possible to pervert and make it backward compatible, but with this we would have to continue to live indefinitely, since we have many fairly large clients.  Having weighed all this, we realized that it is easier now to dodge and adapt to the old API, than to pull along a huge amount of additional logic to maintain backward compatibility with those customers who have not yet crawled to the new API.  It was all not easy, a lot of additional circumstances that were brought to us by the developers of client parts, but in the end we settled on this solution: just transfer in bodies. </p><br><p>  <strong>- You said about Swagger.</strong>  <strong>What is your practice of using it?</strong>  <strong>How good is it?</strong>  <strong>Are there any pleasant or unpleasant moments?</strong> </p><br><p>  - Enough and those and others.  I dare say that a little more pleasant, since we are already on it.  First of all, the most important thing that we got (although the merit of Swagger is not so great here) is the simplicity of the description.  It so happened that the monolith we have built on the Play Framework.  In Play, though there are plugins for generating swagger documentation, but, as always happens, for historical reasons, different people wrote them at different times, and these plugins are not suitable for anything, they do not work for us.  Therefore, the documentation had to write manually.  Straight to specification, straight sit and write with your hands. </p><br><p>  <strong>- Like most of the world now does.</strong> </p><br><p>  - But, no matter how cool, agree that you write the same code, why else sit and repeat your hands? </p><br><p>  <strong>- And once again in jawadok.</strong>  <strong>And the fourth time in the tests.</strong> </p><br><p>  - Yes!  What for?  I really wanted to save on this, so when we started on the microservice path, we didn‚Äôt invent any bicycles, we analyzed several solutions.  Currently, the most mainstream, most developed solution seemed SpringFox.  Do you know anything about him? </p><br><p>  <strong>- There is nothing.</strong>  <strong>Now I know the name.</strong> </p><br><p>  - This generator Swagger-based documentation descriptions of controllers in the Spring itself.  In particular, in Spring Boot.  But in fact, under Boot it is not very sharp, but is focused on SpringMVC, where all the annotations come from.  But with Spring Boot is friends.  The idea is that the API structure, a set of methods, their parameters are already described in the controller, in the form of its methods and annotations, and they can be extracted.  This is the lion‚Äôs share of work, the skeleton of documentation.  All that is missing here is a verbal description.  But it is obvious that it is easy enough to add annotations in the code itself.  SpringFox goes exactly this way - it takes Swagger annotations (more precisely, from the swagger-annotation subproject, it is part of the generator), applies these annotations to the controllers on Spring (SpringMVC, or SpringBoot in this case).  Then interprets on the fly, generates the Swagger-specification.  And what is another beauty - right in the composition of microservice, exposes another endpoint (not on a separate port, but in a separate context), on which Swagger UI opens (these beautiful green HTML forms), where all the documentation is presented, ready not only to read it, but also to be able to play with it - the ‚Äútry it out‚Äù buttons work right out of the box to send a request to microservice.  At first glance, it looks really like magic: no need to manually write a specification, and at the same time it is available.  There is a separate URL where you can request it and then feed it to some SOAP UI or Postman.  All this is already there.  Plus, on the port of each microservice documentation is deployed (no need to look somewhere, remember), suitable for reading.  One more plus - any change in the code will entail a change in documentation.  It is necessary to try to write something and not to notice that in the same place you write about the same in the form of text.  This, of course, is a significant plus of such a decision. </p><br><p>  But, I confess honestly, it is imperfect.  Not everything is smooth.  SpringFox itself is well-versed in annotations and in Spring's query structures, but not perfect.  In particular, there are problems with collections.  When collection types are returned from methods, it is crooked in the UI.  In addition, it allows tyunit not all the parameters that provides naked Swagger - there is a Wishlist that should be taken into account.  There are a number of rough edges.  But as a whole, quite a working approach.  But the truth, and for this we had to regroup.  If earlier we did not hesitate to add some additional business logic to the controllers themselves (validation, for example, if it wasn‚Äôt done at the annotation level), now I‚Äôd have to say a lot at the command level.  To say that the controllers for us are the input point and source of documentation.  No business logic applied validation, for example, should not be there.  Otherwise they become unreadable, on each method a bunch of annotations.  Instead of being the same @RequestMapping method, @ApiOperation, @ApiResponse and so on suddenly appear - a bunch of different annotations. </p><br><p>  <strong>- Half of the sheet of code annotations filled?</strong> </p><br><p>  - In reality it happens even more.  But due to the fact that we agreed that the business logic is delegated to individual services, this improved test coverage and made it possible to draw a clear boundary.  Here we have controllers, and they solve two problems: the source of documentation and communication with the outside world.  And do the rest in application logic in services. </p><br><p>  <strong>- Programmers always write this documentation, or do you have documentaries?</strong> </p><br><p>  - No, we write ourselves, only developers. </p><br><p>  <strong>- And is this normally always happening, without rough edges?</strong> </p><br><p>  - Here, in microservices, it is very easy for us.  All the roughness was when the developers manually led the documentation for the monolith.  Constantly something was forgotten, something was constantly leaving, obsolete, mobile developers were cursing, because the documentation was irrelevant - that was really tin.  And now, when it happens, the developers are only happy. </p><br><p>  <strong>- What products do you have for your country?</strong> </p><br><p>  - To Russia. </p><br><p>  <strong>- And in what language is the documentation written?</strong> </p><br><p>  - In Russian.  We have our own team, there are no foreigners, including in remote offices, so we are all in Russian. </p><br><p>  <strong>- This documentation, it turns out, is generated for work within the company?</strong>  <strong>Or do you outsource it to outside contractors too?</strong> </p><br><p>  - We had this experience, but not now, and our contractors are Russian speakers. </p><br><p>  <strong>- Cool, very lucky.</strong> </p><br><p>  - I know! </p><br><p>  <strong>- Have you watched this SpringFox code?</strong>  <strong>If you really want it, you can patch it at all, or is there a hell of tin?</strong> </p><br><p>  - Yes, you can.  There are, of course, non-trivial places.  But in general, it is written normally.  I can't say it is great, but not bad.  A couple of times the hand has already been raised to fix any slippery places, but there has not yet been time.  And secondly, quite active guys stand behind him and they themselves saw him pretty well.  Not as active as we would like, but some updates regularly roll out.  True, so far, not one of our Wishlist has been covered. </p><br><p>  <strong>- Regarding HTTP: are you trying to impose your requests on any particular methodology, for example, on REST?</strong> </p><br><p>  - Yes, we are trying.  At one time, at the very start of the movement to microservices, we rested very strongly on this.  Discussed, pronounced, there were heated debates. </p><br><p>  <strong>‚ÄúBut it's usually very difficult, to pull an owl on a globe.‚Äù</strong>  <strong>How are you with this?</strong> </p><br><p>  - We have this as usual, historically.  If you remember, I have already mentioned the forced support for backward compatibility with the previous API, on which we have a huge fleet of clients.  Hundreds of thousands of people on the phones installed.  And all our attempts to be restful in all respects slipped from the globe due to the fact that we were forced to maintain backward compatibility with that API.  And then the API, to put it mildly, is not quite restful.  It uses only POST and GET, regardless of whether you delete or edit the entity.  Such a concept as an ‚Äúentity‚Äù around which the entire REST is being built is not particularly adhered to.  There, this approach is more like in Java itself - there is some method, let's shove its name into the address itself.  Here it is present in the address itself, getBySomething.  This approach is not terrible, it is working, normal.  With REST, it turns out, of course, more concise, cute, but I didn‚Äôt feel any kind of applied value, despite the fact that the API is big enough, an adult.  As it seemed to me, he risked becoming talkative due to the fact that there is no single paradigm, but in principle it turned out <em>badly</em> .  And now, despite the fact that we keep some REST chips in our head and try to use them, the same orientation on the essence, we try to design the addresses of the methods so that the essence is at the head of the corner and then it is then subdivided into some the subtleties following on a slash deep into request, all the same it is necessary to limit itself to these aspects of backward compatibility.  That is, we have such a semi-REST. </p><br><p>  <strong>- Stateless or stateful?</strong> </p><br><p>  - Microservices are now all stateless.  With one thing, perhaps there are questions, because the next step in the near future will be the deployment in the orchestration system.  We are planning to roll it all out on Kubernetes in Docker containers.  There is one of the main requirements that we agreed with our operation, which, in principle, is very natural - stateless microservices.  The reasons are clear: so that you can drop any of them at any time and immediately pick up another one so that he can pick up requests.  That they were as easy to lift and damage. </p><br><p>  <strong>- And if all the same there will be services that are heavy, what to do with them?</strong>  <strong>If k8s drops the service by 400 gigs in the heap ...</strong> </p><br><p>  - What to do with this data? </p><br><p>  <strong>- What to do with the data, how to design services so that they experience such migrations?</strong> </p><br><p>  - There are several approaches.  One of those practiced by us (although I can not say that he is good in this case) is to use distributed storage.  So that the place that you called hip was not just hip, but also stored somewhere between microservices.  The classic solution (I don‚Äôt know how classic it is for everyone, but for us it has become such) is Hazelcast.  Hazelcast-based distributed storage.  Now it works like a monolith.  It is clustered, it has shared distributed storage.  Any piece of data is stored on all nodes.  If one node falls, no one will lose this data (of course, if they managed to replicate). </p><br><p>  <strong>- What is the degree of replication?</strong> </p><br><p>  ‚ÄúNow I‚Äôll definitely not tell you.‚Äù </p><br><p>  <strong>- Let's just say, is it fullink or lower?</strong> </p><br><p>  - Depends on the data.  In some case, we use full, and for less critical data, which is easy to repeat, there is 2/3.  That is, the data is stored on two of the three nodes (if there are three nodes in the cluster).  But here I can lie in something.  This is one option. </p><br><p>  The second option is if microservice has hip swelled to 400GB, and all this is valuable data, is microservice okay?  Should he really act like that? </p><br><p>  <strong>- He is no longer ‚Äúmicro‚Äù, this is ‚Äúfatty service‚Äù.</strong> </p><br><p>  - It seems that it needs to be turned into several other ‚Äúmicro‚Äù ones.  Or there should be a persistent pad under it, which will protect it from such things.  Clearly, it will make it less agile, but it depends on the value of the data.  Maybe it makes sense to keep them separate somewhere.  Not necessarily in a full-fledged DBMS, it may be worth using some more lightweight solutions.  But we have not yet encountered such a problem, we keep them small enough.  There is no one that fell and pulled a bunch of valuable data to the bottom. </p><br><p>  <strong>- What will happen if in the middle of the microservice chain something that is actively used by neighbors falls in whole or in part?</strong>  <strong>Will there be any graceful degradation or something?</strong> </p><br><p>  - In most cases, no, but in some places we still insure.  But not by the means that are built into the same Spring Cloud Netflix, when folbek in Hystrix is ‚Äã‚Äãused - we have known about them, tried it, but so far there has been no need.  Instead, we manage our own means, right in the code we know what can be done in such a situation.  Somewhere we allow the request to end in favor of another request.  Or we pull some data from the cache, if they are there and it is permissible to take them older than the latest ones from the database, which we went to and broke off.  It all depends on the situation.  But these places are not very many. </p><br><p>  <strong>‚ÄúI just talked with different people, and there are two main strategies for people who don‚Äôt have honest GD / DR: if we have a billion Chinese people and a piece of the microservice graph falls, either we just lie and don‚Äôt even try to work a billion Chinese people, or‚Äú everything is lost ‚ÄúWe start to run around in horror, shout and kick admins.</strong>  <strong>How are you with this?</strong>  <strong>What will it be with you?</strong> </p><br><p>  - I think it will be closer to the first :-) </p><br><p>  <strong>- In the second case, when you have no workaround, somehow you need to arrange the prod so that it never falls at all.</strong> </p><br><p>  - Well, that sounds yes, good.  But in fact, how feasible is it? </p><br><p>  <strong>- Can I do this?</strong>  <strong>Are you doing this?</strong> </p><br><p>  - No, as you can see.  Currently not yet.  We are trying instead to get by with more point solutions.  Or we protect individual pieces, the most critical ones, for example, tried to cluster the same monolith.  It will not sustain a billion, but it can take a triple load at the expense of elementary clustering.  -  -,    ,     - ,  -   (  ) ‚Äî         - .           . </p><br><p> <strong>‚Äî     ,  ‚Äî  .</strong> </p><br><p>  - Yes.    -  ,  ,    ,        ,       ,     ,        ‚Äî    .        ,   . </p><br><p> <strong>‚Äî    ,    - ?    .</strong> </p><br><p> ‚Äî      .       SQL-      Apache .       ,     (, , ,   ..) ‚Äî       .  -  .   ,        ‚Äî     .          ,     ,   ,         .             . </p><br><p> <strong>‚Äî        -    - ?</strong> </p><br><p> ‚Äî      . ,   - ‚Äî     ,   Java ‚Äî     .    JAMon,  SpringBoot     Actuator (,     ).  ,     ‚Äî        ,  ,    ‚Äî        .    ,    ‚Äî   ,       ,    ,  ,   .     ,        .    -     ,   .   ,         . </p><br><p> <strong>‚Äî     -   -,     :    ,          ?</strong> </p><br><p> ‚Äî   .     -  , ,   ,   . ,                   (    ), , ,  - .      ‚Äî         (  ,    ),               ‚Äî  , , ,   ,  ‚Ä¶          . , ,    , , ,     .  , ,  . </p><br><p> <strong>‚Äî      ,     ?</strong> </p><br><p>  - Not. ,   ,   . ,     ‚Äî ,      ,             .       Machine Learning,     . </p><br><p> <strong>‚Äî     , .</strong> </p><br><p> ‚Äî     . , , ,      .   ,   ,   . </p><br><p> <strong>‚Äî          ?</strong> </p><br><p> ‚Äî        ,    ,     .       Java Melody ‚Äî   ,      Spring Boot.   ,     -   ,      ,                 .       ,   .   ,       JAMon ‚Äî   ,       Zabbix. JAMon ‚Äî  -      -,    ,   ‚Ä¶ ,          ,       . </p><br><p> <strong>‚Äî  ,     20 :   ,        ,  ?  ,   , ?</strong> </p><br><p> ‚Äî ‚Ä¶  ,   ? </p><br><p> <strong>‚Äî ,    .    -   ‚Äî  .  Java - ,     .      ,     ,      , ,  API,   , ,  ‚Äî      .</strong> </p><br><p> ‚Äî ,   .     ,   .     . ,     . ,       .      .       ‚Äî    ,     .       . ,   ‚Äî   Ops  DevOps    .    ,     ‚Äî  ,  ,       .       .    ,    .   ,       Ops' ‚Äî          ,     ,        .  ,   - ,      ,       ,       .      Ops-,        . ,    ,    ,           ,     ,     .        CI.       Jenkins,      . </p><br><p>     ‚Äî    , API, ,   ‚Äî          ,    .    ,   ,       .    .     . ,   ,           ,       ,     -  . ,   .       ‚Äî , ,  ( ,  ).    ,   .     -   ,       . ,       ,     ,     ‚Äî  ,     .      ,              .         ,     ,     . </p><br><p>  ,     .       ,         -  -300.  -400 ¬´¬ª   ,    -300    ,   .    (102 ),      .   ,               ,  ,    .  , ,         ,   ,    ,      ,   .      ,       .  ,  ,     ,         ‚Äî   , ,   ,        .        ‚Äî‚Äî   ,       .  , ,     ,   .  That is quite enough. </p><br><p> <strong>‚Äî       ,     ,     ?</strong> </p><br><p> ‚Äî ,   ,         ‚Äî ,     ,     . ,              .                 .       ,       ,   ,  ,     . ,      ,   ,           ,     .   , ,  ,   ,    ,     ,       .     ,    ,   -   :    ,    ,    API ‚Äî  .       . </p><br><p> <strong>‚Äî     , ,       ,         ,   .            ,   ,      100  .    .      ?</strong> </p><br><p> ‚Äî         .   -  -  ,    .     .  API, ,  , ,  -,   .      .  ,     , , , -  (   ).  ,     ‚Äî       ‚Äî    API.  ,    SpringFox  Spring Boot      .      ,  API  .   API    Swagger UI,    : ,   API, ?  ,   ,  - . ,  , .   -      .        ,   ,        ,  Confluence,    .      ,     . , ,    ,  -   ,        Swagger UI. </p><br><p> <strong>‚Äî       ,     HTTP, REST   .</strong> </p><br><p> ‚Äî  ,    ,       .         ,    ,     ‚Äî     ,    , . </p><br><p> <strong>‚Äî     -  ,  HTTP/REST? ,  ,   SOAP.</strong> </p><br><p> ‚Äî ,    ,   ¬´ ¬ª.    ‚Äî ,    ,  .    ,     95% ‚Äî      ,  .    .      . SOAP ‚Äî , ,  ,  . </p><br><p> <strong>‚Äî  - ?</strong> </p><br><p> ‚Äî , , ,  TCP-.      ,      :-)    ,      ‚Äî -   ,    ,  . </p><br><p> <strong>‚Äî , -  -.    HighLoad,      ,     .</strong> </p><br><p> ‚Äî  , , ,  ,    HTTP,     XML.    WSDL,      .  -    ,     .     ¬´   req,  ‚Äî  ans¬ª.    .  . </p><br><p> <strong>‚Äî  ,      .     ?   ‚Äî    , 4  ?  ?</strong> </p><br><p> - I am afraid to surprise you, but for some reason, in our financial services, videos do not transmit four gigabytes each!  But I understand your question, just small.  We recently solved a similar task, and we did not have to transfer such files to external systems using any of the protocols I have listed now.  We, as a rule, exchange documents, XML.  If they are due to something and grow - due to digital signatures and content.  As for the interaction with end clients from the API, then yes, you have to accept files, document scans, statements, and so on.  Such things we solve with the usual multipart / form-data, we simply distill the data, and everything that controls - so that in no place in the microservice are the entry points or some intermediate places - so that there is no buffer anywhere in which the file would be wholly.  We work at every moment only with a piece.  A piece received - a piece processed.  If it is necessary to put in the database, CLOB and BLOB (depending on whether binary or text data) is entered under this and is written in the form of an input or output stream.  We are only convinced that at any point in time the file is not entirely in memory.  Because there is one file, there is one file - and the hip is over.  There is no magic here, in fact, everything is already there, we tried to apply it correctly, and we try to customize the same parsers.  Not always, if there is a risk of a large file - we set up the stream parsers, not the DOM, which pull everything in at once. </p><br><p>  <strong>- Globally, how do you see the direction of development of the idea of ‚Äã‚Äãmicroservices?</strong>  <strong>Not only maybe in my company, but in the whole world?</strong>  <strong>What should people look at now?</strong>  <strong>What is good?</strong>  <strong>What do you respect?</strong> </p><br><p>  - The first thing that comes to mind is respect for the opinionated approaches, on the basis of which Spring Boot is built, among other things.  Approaches and tools (no matter for microservices or related tasks), based on the aggregation and synthesis of someone else's experience.  As our experience shows, this is almost the most invaluable addition that you can get from third-party tools.  When they are not just designed ‚Äúsaw what you want, here we have provided you with some basic abstractions, and now get up what you want.‚Äù  Here is a prime example - Ant was like that.  Very powerful, very flexible tool, but whatever you do, write everything from scratch, and you constantly accumulate it ... </p><br><p>  <strong>- Or makefiles.</strong> </p><br><p>  - Yes, makefiles.  Here Gradle, in my opinion, a very good solution.  They have put a lot in there of what has already proved itself, confirmed it as a working solution.  Starting from an elementary directory structure, which they consider default, why declare it explicitly and reinvent the wheel?  This also leads to the zoo, when people do not have enough experience, and then it turns out that it does not correspond to the generally accepted one, and a complete collapse begins.  Therefore, these silent opinionated approaches are extremely valuable both for beginner teams and for continuing ones, because they allow (sometimes without even realizing it) reusing the vast experience of other people who have already gone this way and collected rakes and minefields. .  Therefore, even without focusing on any specific tools or services, I see the superiority of opinionated approaches as global ideas. </p><br><p>  <strong>- Explain the word opinionated, so that we understand exactly what you are talking about now.</strong> </p><br><p>  - An opinion based approach.  For example, remembering how the Spring Boot guys wrote, why they developed it exactly the way we have it now - they didn‚Äôt invent anything new, but summarized their experience.  According to them, the basic project, the product should look like this.  Default.  This does not mean that it will look like this anyway, and if you do not agree, you will go through the forest.  This means that if you do not want to bother, it will look like this.  This is their opinion.  And then you have the opportunity to podtyunit it somehow, fix it, fix it - to fit your needs, already under your opinion.  In this combination of rich experience and flexibility lies the maximum value of such solutions. </p><br><p>  It is not always good.  An example of the first Play (with the second worked a little) - it is also opinionated, but there the guys had a very specific opinion.  I do not know what the hipsters wrote it :-) </p><br><p>  <strong>- Is that the one in Java yet?</strong> </p><br><p>  - Yes.  Didn't work with him? </p><br><p>  <strong>- I worked, but it was so long ago, my whole life was gone.</strong> </p><br><p>  ‚ÄúThere, if you remember, for some reason they do not accept the standard structures of Java packages.‚Äù  They believe that if you put something in a bag, then put it right here, right in the root.  Here you are called controllers, not some kind of org.company.app.controllers, but simply controllers - how much blood we drank! </p><br><p>  <strong>- How to resolve clashes when there is no structure?</strong>  <strong>You can organize the structure in the class name ...</strong> </p><br><p>  - Ha, ‚Äúexcellent‚Äù solution!  And such tin there very often.  Or, for example, they believe that the entire web is static.  Therefore, all the methods of all controllers there are static.  Well, in their opinion, it is.  This is just an example. </p><br><p>  <strong>- But they thus reduced the complexity of the development, focusing on a particular piece.</strong>  <strong>And if you came out of this happy piece, you are a kapets.</strong> </p><br><p>  - Our experience has shown that it is very easy to get past this piece.  As soon as your application turns from a hamster or a laboratory work into something a little more serious - everything is right there, you are right behind this zone. </p><br><p>  <strong>- And so they wrote the second Play, and even rewrote it on the rock.</strong>  <strong>By the way, I truly understood that you are using the first Play in the monolith?</strong>  <strong>So what, will you continue to use it or will you take something instead?</strong> </p><br><p>  ‚ÄúInstead, we will gradually mow the pieces out of the monolith until its value drops to zero.‚Äù </p><br><p>  <strong>- But still a web framework is still needed to show your face?</strong> </p><br><p>  - No, not needed.  In our case, the monolith is only the backend core.  And the front part is isolated by another satellite application.  And secondly, for the web part, we meet the individual guys who live completely in their own world and saw the web part as an independent web application on React.js.  We provide them with only API - no templates, HTML, nothing there doesn‚Äôt fly - a bare API that they use in their application.  Mobile phones, of course, the same thing.  We are not tied to any framework here, as long as the API complies.  And the API is HTTP. </p><br><p>  <strong>- It sounds like a fairy tale, many will burn with envy.</strong> </p><br><p>  - Well, I don‚Äôt know ... We suffered this, the first version of the Internet bank was old, and we rewrote it a long time ago, it was on the Wicket framework, heard about it? </p><br><p>  <strong>- Yes, this is a terrible framework, I worked on it for many years, I hate it with all my soul.</strong> </p><br><p>  - I can understand you, I also caught him pretty.  Do you remember that there is a concept of a component, it fits into HTML, there is a wicketId, which is then generated on the fly, replaced, that's all?  We had this, and we left it.  We understood where we were going, what we were leaving, what we were tired of.  In principle, the framework is not hopeless, it is even good somewhere, just everything has its place. </p><br><p>  <strong>- As far as I understand, Wicket is very difficult to scale.</strong> </p><br><p>  - Honestly, not at all. </p><br><p>  <strong>- They have a IClusterable interface in their class hierarchy, i.e.</strong>  <strong>theoretically you can work from him, drag Terrakotu, but the developers themselves have never rested on it.</strong> </p><br><p>  - We didn‚Äôt even get to that point - we just rewrote everything and began to cluster normally. <br>  Although some of our applications still work well on Wicket. </p><br><p>  <strong>- We have been talking for more than an hour.</strong>  <strong>Were there any ideas to make a report out of all this?</strong> </p><br><p>  - Not yet.  For me, all this is so close that it all seems to be some ordinary things.  I will come, tell you what everyone does?  But on the other hand, others come, tell, and nothing. </p><br><p>  <strong>- There is a big difference: for others it still does not work, but you succeed.</strong> </p><br><p>  - Just besides what I was talking about here, attention is taken up by other things.  For example, the topic about which I will talk on JBreak.  And I have a more recent project, where I developed a tool for aggregating server logs in a test environment.  In connection with the development of microservices, it has become important to watch the logs all in one place, how they are written, and right now, and not some indexed ones.  On the one hand, a bunch of solutions like ELK, Logstash, Kibana and others have already been invented, but as experience shows, on the test - this is shooting at the sparrows from a cannon.  It is necessary to customize formats, indexers, they do not always work in realtime.  The Christmas Tree itself is, I apologize, three applications, each of which must be closed.  You need some kind of more lightweight solution that can be quickly fixed and which allows you to quickly and easily see everything in the logs on the server.  And, obviously, on a remote server, which does not even have a UI.  All that can be done there is to call tail. </p><br><p>  <strong>- And for that you need SSH access, right?</strong> </p><br><p>  - They can only be accessed via SSH, well, via SFTP, there are no other options.  And it was just this task that I had already encountered for a long time, made a simple utility that at that time simply poured these files and returned it in a web page that is open in your browser.  And she writes right in realtime.  Such a tail, only browser.  No applications need to be put, it just gets and pollit.  But this was not enough when it came to microservices.  It took some decision to aggregate them.  And just at Spring Boot, I filed an application that launches tail, listens asynchronously to it, and as soon as messages appear there, aggregates them and sends them to the Angular application on a web page.  Since I‚Äôm not a web developer, I didn‚Äôt bother, I wrote everything down on Angular. </p><br><p>  <strong>- You know, web developers also sometimes write on Angular :-)</strong> </p><br><p>  - Yes, just recently it is considered that Angular is already all wrong, something more recent is needed. </p><br><p>  <strong>- Second or first?</strong> </p><br><p>  - I‚Äôm the first because StackOverflow had the most questions about it.  Actually, different passing problems are solved there.  How to recognize timestamps so that in the final log everything must be in order, despite the fact that they are written unevenly.  So that they do not overlap, i.e.  if a message is in the message - so that in the middle of it someone else's message does not creep out of another log.  There is an aggregation, recognition of timestamps, and all this is arranged in a sequence. </p><br><p>  <strong>- Well, everything seems to be discussed.</strong>  <strong>The next step is to come to your report.</strong>  <strong>Thanks for the answers, Vladimir!</strong> </p><br><blockquote>  Minute advertising.  Vladimir is the speaker at our conference <strong>JBreak 2018</strong> (which will be held <strong>this Sunday</strong> ).  In his talk ‚ÄúSide Effect Injection, or Virtuous Crutches,‚Äù he will talk about the Side Effect Injection approach, and we will admire the compilation options for Java code, pick up a single byte code modification case in the JVM, prepare a formal Java grammar and see it all with the real example. applications.  There are discussion zones at the conference, so after the report, it will be possible to meet with Vladimir and discuss various issues - not only Side Effect Injection, but also, for example, microservices.  Tickets <a href="https://2018.jbreak.ru/tickets/">can be purchased on the official website</a> . </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/349954/">https://habr.com/ru/post/349954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349942/index.html">Parsing telegram channels for content aggregator in PHP</a></li>
<li><a href="../349944/index.html">List.of () and everything, everything, everything ...</a></li>
<li><a href="../349946/index.html">Confession of a product manager</a></li>
<li><a href="../349948/index.html">Dismissal for keeping pornography on the computer: the European Court found no violation</a></li>
<li><a href="../349950/index.html">Making holes in torrents freeing up space and remaining on hand (part 1)</a></li>
<li><a href="../349958/index.html">Come and pick up the prototype books</a></li>
<li><a href="../349960/index.html">Disable PowerShell and other features of the fight against Malware. Part I</a></li>
<li><a href="../349962/index.html">"Do not get involved, kill!" Or the whole truth about the safety of automated process control systems. Part 2</a></li>
<li><a href="../349964/index.html">Useful tips on archiving Veeam backups to tape</a></li>
<li><a href="../349966/index.html">Vulnerability of technology to identify users in public wi-fi networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>