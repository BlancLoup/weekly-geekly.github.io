<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ARM programming on Pascal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day, suddenly, completely unexpectedly and without a declaration of war, an idea appeared. And it was necessary for this to write and program the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ARM programming on Pascal</h1><div class="post__text post__text-html js-mediator-article">  One day, suddenly, completely unexpectedly and without a declaration of war, an idea appeared.  And it was necessary for this to write and program the STM32 crystal. <br><br>  But what are the actual problems?  stm32vldiscovery was on the shelf and was waiting for its time, I know programming and often write ‚Äúto order‚Äù.  I am good friends with iron. <br><br>  The first thing to ask was ‚Äúwhat to write on‚Äù?  There are many programming environments, but the language is only ‚ÄúC‚Äù.  No options.  Assembler does not consider in principle.  You can blink the LED, but something more complicated requires huge labor costs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But I do not know Si!  At all.  All his life he wrote only on Pascal / Delphi.  Learn the language?  Have you tried to learn a language when you are over 40 years old?  When work, family and minimum free time.  When the mind is not as sharp as in youth.  And it makes no sense to start all this for the sake of one project, than to study for the rights and buy a car for the sake of going to the bakery in the neighboring house. <br><br>  The way out was the found ‚ÄúmikroPascal PRO for ARM‚Äù from MikroElektronika.  To be honest, I already worked with ‚ÄúmikroPascal PRO for PIC‚Äù at the peak of PIC chip popularity.  Impressions were not very good.  The compiler is ‚Äúweird‚Äù, the shell is also not very stable and friendly interface. <br><br>  It was especially interesting to see what has changed over the years and in what direction. <br><br>  And so, what we have on hand: <br><ul><li>  Fee stm32f4discovery; </li><li>  mikroPascal PRO for ARM with a license key (taken from a friend, then have to be returned).  Without a key - a limit of 2 kV on the size of the code; </li><li>  An engineer who was taught at the university exclusively Pascal. </li></ul><br>  Task: to master the programming of the microcontroller without a single line of C code. <br><br>  So let's start ... <br><a name="habracut"></a><br>  Creating a project is easy.  File -&gt; New -&gt; New Project. <br><br>  Specify the type of microcontroller.  Ask what standard libraries we use (by default - everything).  Leave.  ‚ÄúExtra‚Äù libraries will be thrown out automatically when compiled. <br><br>  Do not forget to configure the tactics.  If in doubt, use one of the standard ‚ÄúScheme‚Äù.  This is a set of settings for clocking options. <br><br>  First of all, let's play around with LEDs.  Let's just ask them to burn.  I remind you that the LEDs are located on the ports D12, D13, D14 and D15. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;
 begin
   // initialize the output port
   GPIO_Digital_Output (@GPIOD_BASE, _GPIO_PINMASK_12 or _GPIO_PINMASK_13 or _GPIO_PINMASK_14 or _GPIO_PINMASK_15);
   // we light
   SetBit (GPIOD_ODR, 12);
   SetBit (GPIOD_ODR, 13);
   SetBit (GPIOD_ODR, 14);
   SetBit (GPIOD_ODR, 15);

   while true do nop;
 end.
</pre><br></div></div><br>  Stop!  Now a huge number of people who have experience with these microcontrollers will have a question: where is the port clocking enabled ?! <br><br>  Very simple: <i>during port initialization, input or output clocking is enabled automatically.</i>  Do not believe - go View-&gt; Statistics-&gt; Functions Tree (my favorite!). <br><br><img src="https://habrastorage.org/files/2bc/78e/50a/2bc78e50a06a4201a2cd7fffa844003f.png"><br><br>  If there is any doubt that the compiler makes it ‚Äúautomatic,‚Äù go and see.  Looking at the burning LED is certainly nice.  But boring.  Let's ask him to blink <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;

 begin
   // set pins for exit and entry
   GPIO_Digital_Output (@GPIOD_BASE, _GPIO_PINMASK_12 or _GPIO_PINMASK_13 or _GPIO_PINMASK_14 or _GPIO_PINMASK_15);

   while true do begin
       if TestBit (GPIOD_ODR, 12) then ClearBit (GPIOD_ODR, 12) else SetBit (GPIOD_ODR, 12);
       Delay_1sec;
   end;
 end.
</pre><br></div></div><br>  There is a button on the board.  Let's run it to work.  When the button is pressed, the LEDs light up.  And when you release - go out (though unexpectedly! - a joke).  The button is on A0.  For reading, use the Button function.  It can suppress contact bounce and takes into account the logic of the button (NC or NO).  In principle, you can easily read the status of the port bit "directly", but it is more readable. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;

 begin
   // set pins for exit and entry
   GPIO_Digital_Output (@GPIOD_BASE, _GPIO_PINMASK_12 or _GPIO_PINMASK_13 or _GPIO_PINMASK_14 or _GPIO_PINMASK_15);
   GPIO_Digital_Input (@GPIOA_BASE, _GPIO_PINMASK_0);
   while true do
     if Button (GPIOA_IDR, 0, 10, 1) then begin
       // we light
       SetBit (GPIOD_ODR, 12);
       SetBit (GPIOD_ODR, 13);
       SetBit (GPIOD_ODR, 14);
       SetBit (GPIOD_ODR, 15);
     end else begin
       // extinguish
       ClearBit (GPIOD_ODR, 12);
       ClearBit (GPIOD_ODR, 13);
       ClearBit (GPIOD_ODR, 14);
       ClearBit (GPIOD_ODR, 15);
     end;
 end.
</pre><br></div></div><br>  Direct button polling in a loop?  It is not always possible to constantly check the button.  Often the crystal is busy with more important things than polling the buttons.  And we can just ‚Äúmiss‚Äù the moment of clicking.  It will be more correct when you click the button to generate an interrupt, where we process the event. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;

 procedure INT_EXTI0 ();  iv IVT_INT_EXTI0;  ics ICS_AUTO;
 begin
   EXTI_PR: = $ FFFF;  // clear flag
   if TestBit (GPIOD_ODR, 12) then ClearBit (GPIOD_ODR, 12) else SetBit (GPIOD_ODR, 12);
 end;

 begin
   // set up conclusions
   GPIO_Digital_Output (@GPIOD_BASE, _GPIO_PINMASK_12);
   GPIO_Digital_Input (@GPIOA_BASE, _GPIO_PINMASK_0);

   EXTI_IMR: =% 1;  We allow interruption from the necessary input.
   EXTI_FTSR: = $ FFFF;  Interruption on arrival 0
  
   NVIC_IntEnable (IVT_INT_EXTI0);  // Enable External interrupt
   EnableInterrupts ();

   while true do;
 end.
</pre><br></div></div><br><br>  What we have is idle in the crystal?  Timer?  Let's play with the PWM mode.  What is the conclusion?  The 4th timer comes to the conclusion that it is connected to the LED.  So what are we waiting for? <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;
 var
   ratio, tmp: word;
 begin
   ratio: = PWM_TIM4_Init (25000);
   tmp: = 0;
   PWM_TIM4_Set_Duty (0, _PWM_NON_INVERTED, _PWM_CHANNEL1);
   PWM_TIM4_Start (_PWM_CHANNEL1, @ _GPIO_MODULE_TIM4_CH1_PD12);

   while true do begin
     PWM_TIM4_Set_Duty (ratio-tmp, _PWM_INVERTED, _PWM_CHANNEL1);
     Inc (tmp);
     if tmp&gt; ratio then tmp: = 0;
     Delay_1ms;
   end;
 end.
</pre><br></div></div><br><br>  The timer can be used not only for PWM.  Hands just itch to use a timer to perform periodic actions.  Let's blink a timer for example.  The timer will pull the interrupt, and the interrupt itself will control the LED. <br><br>  To do this, you need long and hard to count the coefficients for writing to the timer registers.  And if not - use the free software ‚ÄúTimer Calculator‚Äù from the manufacturer‚Äôs website. <br><br>  We drive in the initial data and get the ready-made timer code.  Something like this: <br><br><img src="https://habrastorage.org/files/af7/630/248/af763024826a4e0b9ae6d101aee95c05.png"><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program ETXI;

 procedure Timer2_interrupt ();  iv IVT_INT_TIM2;
 begin
   TIM2_SR.UIF: = 0;
   if TestBit (GPIOD_ODR, 12) then ClearBit (GPIOD_ODR, 12) else SetBit (GPIOD_ODR, 12);
 end;

 procedure InitTimer2 ();
 begin
   RCC_APB1ENR.TIM2EN: = 1;
   TIM2_CR1.CEN: = 0;
   TIM2_PSC: = 2239;
   TIM2_ARR: = 62499;
   NVIC_IntEnable (IVT_INT_TIM2);
   TIM2_DIER.UIE: = 1;
   TIM2_CR1.CEN: = 1;
 end;

 begin
   // set pins to exit
   GPIO_Digital_Output (@GPIOD_BASE, _GPIO_PINMASK_12);  // Enable digital output on PORTD
   // // Timer2 Prescaler: 2239;  Preload = 62499;  Actual Interrupt Time = 1
   InitTimer2 ();

   while (TRUE) do nop;  // Infinite loop

 end.
</pre><br></div></div><br>  UART?  Easy too.  Connect the adapter UART-USB.  Let us, for example, display the value of the processor temperature every second. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program MyProject1;
 var 
   uart_tx: string [20];
   tmp: integer;
   tmp1: real;
  
 begin
   UART2_Init (9600);  // Set the UART to 9600 bps
   ADC1_Init ();
   Delay_ms (100);  // Waiting for UART to stabilize 
   TSVREFE_bit: = 1;
   UART2_Write_Text ('Hello!');
   UART2_Write (13);
   UART2_Write (10);

   while (TRUE) do
     begin
       tmp: = ADC1_Read (16);  // Read temperature data
       tmp1: = (3300 * tmp) / 4095;  // Recalculate mV.  From the calculation: 3.3 V = 4096 dc
       tmp1: = ((tmp1-760) /2.5) +25;  // Count in degrees.  V25 = 0.76VS = 2.5mV / C
       FloatToStr (tmp1, uart_tx);
       uart_tx: = 'T:' + uart_tx + 'C';
       UART2_Write_Text (uart_tx);
       UART2_Write (13);  UART2_Write (10);
       Delay_ms (1000);
     end;

 end.
</pre><br></div></div><br>  We start ... The temperature of the case is -27C.  This is despite the fact that in the room 23C.  In principle, nothing strange.  The manufacturer itself does not recommend using this sensor to measure absolute temperatures, but use it only to measure growth / decrease in temperature.  The output voltage of the temperature sensor is shifted from chip to chip, and the shift can reach 45 degrees. <br><br>  Stop!  Did we forget to initialize the GPIO?  And then there is another ‚Äúproprietary‚Äù chip: <i>when initializing a module that works ‚Äúto conclusions‚Äù, the initialization of the outputs occurs automatically.</i>  Doubts?  Come View-&gt; Statistics-&gt; Functions Tree (my favorite!). <br><br><img src="https://habrastorage.org/files/add/06c/a44/add06ca44e624d4ab7921e3d1e13d40c.png"><br><br>  As you can see, the conclusions are automatically transferred to an alternative mode and clocking is enabled for them. <br><br>  And finally - let's get to USB.  The easiest.  We make a HID device that simply returns the received message. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program HID_Read_Write_Polling;

 var cnt, kk: byte;

 var readbuff: array [64] of byte;
 var writebuff: array [64] of byte;

 begin
   HID_Enable (@ readbuff, @ writebuff);
   while TRUE do
     begin
       USB_Polling_Proc ();  // Call this routine periodically
       kk: = HID_Read ();
       if (kk &lt;&gt; 0) then
       begin
         for cnt: = 0 to 63 do
           writebuff [cnt]: = readbuff [cnt];
         HID_Write (@ writebuff, 64);
       end;
     end;
 end.
</pre><br></div></div><br>  Or a similar action using Interrupt: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> program HID_Read_Write;

 var cnt: byte;

 var readbuff: array [64] of byte;
 var writebuff: array [64] of byte;

 procedure USB1Interrupt ();  iv IVT_INT_OTG_FS;
 begin
    USB_Interrupt_Proc ();
 end;

 begin
   HID_Enable (@ readbuff, @ writebuff);
   while TRUE do
     begin
       while (HID_Read () = 0) do
         ;
       for cnt: = 0 to 63 do
         writebuff [cnt]: = readbuff [cnt];
       while (HID_Write (@ writebuff, 64) = 0) do
         ;
     end;
 end.
</pre><br></div></div><br>  For normal operation of this program (and any program that uses the standard USB library), it is necessary to generate the USBdsc.mpas file.  It contains the USB parameters for this device.  At once I will tell, from the ‚ÄúTools‚Äù menu there is a utility ‚ÄúHID Terminel‚Äù.  This utility allows you to create the correct file, sufficient to run examples and simple applications.  And if something more complicated - see the description of the USB bus.  And rule the file.  Fortunately, he generously provided with comments. <br><br><img src="https://habrastorage.org/files/1fa/57c/f0e/1fa57cf0e91d46059507486b6623d8cc.png"><br><br>  Using this utility, we check the operation of the example: <br><br><img src="https://habrastorage.org/files/a5b/641/2b6/a5b6412b6a314be0b094fb3ebff76189.png"><br><br>  Of course, there will be a bunch of grunts about the ‚Äúinefficiency‚Äù of the code.  But look - a rather ‚Äúhard‚Äù example with USB HID takes 1.7% of flash and 1.2% of operative memory. <br><br><img src="https://habrastorage.org/files/314/7b0/23d/3147b023d7234096b07f39919b967bcb.png"><br><br>  And a small digression. <br><br>  All this ‚Äúmagic‚Äù machinery works only with the correct setting of the clocking system.  If the absolutely correct code starts to ‚Äúfreak out‚Äù, the external interfaces start to ‚Äúdisappear‚Äù and the USB interface connection generates the message ‚ÄúDevice ID Request Error‚Äù - open the project settings and check the clocking again. <br><br><img src="https://habrastorage.org/files/85b/9ec/a9d/85b9eca9d2d04404989459dfbad5e412.png"><br><br>  All this shows that knowledge of C is not a prerequisite for effective programming of the microcontroller.  And the availability of standard libraries significantly reduces the entry threshold for unprepared people.  At the same time, the code is quite compact and readable. <br><br>  A detailed description of the programming environment will be written in a separate article. <br><br>  PS: Actually, I know C (C ++).  Freely read and understand the code.  But writing programs in this language is ‚Äúuncomfortable‚Äù for me.  Brains automatically give access to Pascal-like code. </div><p>Source: <a href="https://habr.com/ru/post/264441/">https://habr.com/ru/post/264441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264431/index.html">Embarcadero Announces Purchase of Raize Components</a></li>
<li><a href="../264433/index.html">Natural genetic algorithm or evidence of the evolution of living organisms in C ++</a></li>
<li><a href="../264435/index.html">Implementing multilingualism on Laravel 5 by the framework</a></li>
<li><a href="../264437/index.html">The digest of interesting materials from the world of web development and IT for the last week? 171 (August 3 - 10, 2015)</a></li>
<li><a href="../264439/index.html">PAP - old, but not useless !?</a></li>
<li><a href="../264443/index.html">Parsing a Word document to pictures or a story about pre-diploma weekdays</a></li>
<li><a href="../264445/index.html">How does ecology affect data center cooling</a></li>
<li><a href="../264447/index.html">The realities of SharePoint migration to the cloud</a></li>
<li><a href="../264449/index.html">Cloud for developer companies, release one: Azure Marketplace - a store of services and solutions for every taste</a></li>
<li><a href="../264451/index.html">On limitations in the applicability of the Minkowski metric in digital data processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>