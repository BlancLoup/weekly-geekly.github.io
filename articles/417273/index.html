<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The implementation of the voice directory based on YandexSpeechKit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the Internet, various implementations are presented, but, in my opinion, they are all quite simple. I want to present my version of the voice direc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The implementation of the voice directory based on YandexSpeechKit</h1><div class="post__text post__text-html js-mediator-article"><p>  On the Internet, various implementations are presented, but, in my opinion, they are all quite simple.  I want to present my version of the voice directory under the asterisk. </p><br><p>  <em>Note:</em> I am not a professional programmer, and perhaps some solutions may seem wild to you.  Some tricks may be outdated.  I am ready to accept criticism and correct the system for the better. </p><br><p>  <strong>Brief description of features:</strong> </p><br><p>  The user enters the IVR, pronounces his request and, in most cases, gets where he wants.  The system is also bolted statistics with a record in the mysql table. <br>  Briefly about the company and the network in which the system is deployed: <br>  ~ 1000 phones, about 50 departments </p><a name="habracut"></a><br><p>  <strong>Software products used by the system:</strong> </p><br><ul><li>  Asterisk 13.10 </li><li>  YandexSpeechKit </li><li>  python 2.6.6 </li><li>  Mysql, MSSQL </li><li>  sox 14.2.0 </li><li>  curl 7.19.7 </li><li>  lame 3.99.5 </li></ul><br><p>  <strong>Description of dialplan in asterisk.</strong> </p><br><pre><code class="hljs php">[officevoicerec] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,Answer() same =&gt; n,Macro(hangercheck,${CALLERID(num)}) same =&gt; n,Set(ITERATIONS=<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,Set(HANGFLAG=<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>) same =&gt; n,Background(/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/ru/speechrec/zdravstvuite)</code> </pre> <br><p>  In this snippet, a macro is run to check whether the caller just hung up after hearing a greeting message.  Next comes the setting of variable values: <br>  ITERATIONS - necessary to repeat the recognition process a specified number of times.  HANGFLAG - this variable is used by the hangercheck macro. </p><br><pre> <code class="hljs ruby">same =&gt; n(rec),Set(RECFILE=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>${UNIQUEID}.wav) same =&gt; n,Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/en/beep</span></span>) same =&gt; n,Record(${RECFILE},<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>) same =&gt; n,AGI(pyreq8.py,${RECFILE}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${NUMTOCALL}"</span></span> = <span class="hljs-string"><span class="hljs-string">"repeat"</span></span>]?repeat) same =&gt; n,Set(HANGFLAG=FALSE)</code> </pre> <br><p>  Set the file variable of the record, write the file.  We run an agi-script that is responsible for sending the file for recognition and searching for the number (the script will be described later), checking the variable NUMTOCALL (the value is set by the script), set the HANGFLAG flag, which means that the person did not hang up early. </p><br><pre> <code class="hljs ruby">same =&gt; n,Macro(VRstat,${CALLERID(num)},${NUMTOCALL},${RSTATUS},${CHANNEL},${RECREZ}) same =&gt; n,GotoIf($[[${EXISTS(${FNAME})}]]?<span class="hljs-symbol"><span class="hljs-symbol">foundName:</span></span>havenodescr) same =&gt; n(foundName),Set(FILE_FNAME=${STRREPLACE(FNAME, ,)}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STAT(f,/var/lib/asterisk/sounds/ru/cache/${FILE_FNAME}.mp3)}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?<span class="hljs-symbol"><span class="hljs-symbol">havecache:</span></span>nocache)</code> </pre> <br><p>  In this fragment, the Macro is launched to check the fact that the caller just hung up after hearing the greeting message, then the variables were set, ITERATIONS - needed to repeat the process of recognizing a specified number of times.  HANGFLAG - this variable is used by the hangercheck macro. </p><br><pre> <code class="hljs ruby">same =&gt; n(rec),Set(RECFILE=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>${UNIQUEID}.wav) same =&gt; n,Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/en/beep</span></span>) same =&gt; n,Record(${RECFILE},<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>) same =&gt; n,AGI(pyreq8.py,${RECFILE}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${NUMTOCALL}"</span></span> = <span class="hljs-string"><span class="hljs-string">"repeat"</span></span>]?repeat) same =&gt; n,Set(HANGFLAG=FALSE)</code> </pre> <br><p>  Set the file variable of the record, write the file.  Run the script responsible for sending the file to recognize and search for the number (the script will be described below), check the variable NUMTOCALL (the value is set by the script), put the HANGFLAG sign that the person did not hang up before the time. </p><br><pre> <code class="hljs ruby">same =&gt; n,Macro(VRstat,${CALLERID(num)},${NUMTOCALL},${RSTATUS},${CHANNEL},${RECREZ}) same =&gt; n,GotoIf($[[${EXISTS(${FNAME})}]]?<span class="hljs-symbol"><span class="hljs-symbol">foundName:</span></span>havenodescr) same =&gt; n(foundName),Set(FILE_FNAME=${STRREPLACE(FNAME, ,)}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STAT(f,/var/lib/asterisk/sounds/ru/cache/${FILE_FNAME}.mp3)}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?<span class="hljs-symbol"><span class="hljs-symbol">havecache:</span></span>nocache) same =&gt; n(nocache),System(curl <span class="hljs-string"><span class="hljs-string">"https://tts.voicetech.yandex.net/generate?format=mp3&amp;lang=ru-RU&amp;speaker=zahar&amp;emotion=neutral&amp;speed=0.8&amp;key="</span></span> -G --data-urlencode <span class="hljs-string"><span class="hljs-string">"text= ${FNAME}."</span></span> &gt; <span class="hljs-regexp"><span class="hljs-regexp">/tmp/speech</span></span>-${UNIQUEID}.mp3) same =&gt; n,System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/lame</span></span> -S --scale <span class="hljs-number"><span class="hljs-number">30</span></span> /tmp/speech-${UNIQUEID}.mp3 /var/lib/asterisk/sounds/ru/cache/${FILE_FNAME}.mp3) same =&gt; n(havecache),Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ru/cache</span></span><span class="hljs-regexp"><span class="hljs-regexp">/${FILE_FNAME}) same =&gt; n,Dial(Local/</span></span>${NUMTOCALL}@common-context)</code> </pre> <br><p>  Running the macro vrstat (responsible for the statistics, will not be described due to its triviality).  Check if there is a description of FNAME (the variable is set by pyreq8.py) for the query.  If there is a description, set the cache file name to the variable and check its presence.  If the file does not exist, we will synthesize it, convert it to mp3, increase the volume and, further (or if the cache exists), play it and call the subscriber. </p><br><pre> <code class="hljs php">same =&gt; n(repeat),GotoIf($[<span class="hljs-string"><span class="hljs-string">"${ITERATIONS}"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?secretary) same =&gt; n,Background(/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/asterisk/sounds/ru/speechrec/<span class="hljs-number"><span class="hljs-number">1</span></span>-wav) same =&gt; n,Set(ITERATIONS=$[${ITERATIONS}+<span class="hljs-number"><span class="hljs-number">1</span></span>]) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(rec)</code> </pre> <br><p>  Repeat recognition.  If the number of iterations exceeds the specified, then translate to secretaries. </p><br><pre> <code class="hljs cmake"> same =&gt; n(secretary),<span class="hljs-keyword"><span class="hljs-keyword">Macro</span></span>(VRstat,<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${NUMTOCALL}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${RSTATUS}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${CHANNEL}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${RECREZ}</span></span>) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(HANGFLAG=<span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) same =&gt; n,Dial(Local/<span class="hljs-number"><span class="hljs-number">1000</span></span>@common-context)</code> </pre> <br><p>  Transfer to secretaries.  We put in the statistics, set the flag that did not throw the phone.  Call the secretary. </p><br><pre> <code class="hljs ruby">same =&gt; n(havenodescr),Playback(<span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk/sounds</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ru/speechrec</span></span><span class="hljs-regexp"><span class="hljs-regexp">/wait2);thanks-wait) same =&gt; n,Noop('no description') same =&gt; n,Dial(Local/</span></span>${NUMTOCALL}@common-context) same =&gt; n,Hangup()</code> </pre> <br><p>  Call a subscriber who does not have a description in the directory.  We lose the message, we enter in statistics, we cause. </p><br><pre> <code class="hljs bash">exten =&gt; h,1,Gotoif($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${HANGFLAG}</span></span></span><span class="hljs-string">"</span></span>=<span class="hljs-string"><span class="hljs-string">"TRUE"</span></span>]?<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>:noop) same =&gt; n(<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>),Macro(VRstat,<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>,x,HANGER,<span class="hljs-variable"><span class="hljs-variable">${CHANNEL}</span></span>) same =&gt; n(noop),Noop(<span class="hljs-string"><span class="hljs-string">'exiting'</span></span>)</code> </pre> <br><p>  Call termination processing for the hangercheck macro. </p><br><p>  <strong>Description of the dialplan.</strong>  <strong>Macros.</strong> </p><br><pre> <code class="hljs pgsql">[macro-hangercheck] ;${ARG1} -clid exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,GotoIf($["${ARG1}"="anonymous"]?<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) exten =&gt; s,n,MYSQL(<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> connid SRV <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> db utf8) exten =&gt; s,n,MYSQL(<span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8) exten =&gt; s,n,MYSQL(Query resultid ${connid} <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> IFNULL((<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> clid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ivr_stat <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> rstatus="HANGER" <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> calldate &gt;=ADDDATE(NOW(),<span class="hljs-type"><span class="hljs-type">INTERVAL</span></span> <span class="hljs-number"><span class="hljs-number">-48</span></span> HOUR) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> clid="${ARG1}" <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> calldate <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>),"NF")) exten =&gt; s,n,MYSQL(<span class="hljs-keyword"><span class="hljs-keyword">Fetch</span></span> fetchid ${resultid} VAR) exten =&gt; s,n,MYSQL(Clear ${resultid}) exten =&gt; s,n,MYSQL(Disconnect ${connid}) exten =&gt; s,n,GotoIf($["${VAR}"="NF"]?<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) exten =&gt; s,n,Macro(VRstat,${ARG1},x,H_RECALL,${CHANNEL}) exten =&gt; s,n,Dial(<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span>/<span class="hljs-number"><span class="hljs-number">1000</span></span>@common-context) exten =&gt; s,n,Hangup() exten =&gt; s,n(<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>),Noop(Hanger <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> failed)</code> </pre> <br><p>  We check in the statistics database whether this number has called the last 48 hours, and if he hung up without waiting for the recognition to be completed, we enter them in the statistics and connect with the secretary. </p><br><p>  <strong>A brief description of the used sql and mysql tables.</strong> </p><br><p>  Sql table dbo.phrases. </p><br><p> <code>id(PK, int), phrase (text), number(varchar(50))</code> </p> <br><p>  For this table, full-text search is raised, used to switch by keyword when getting a long phrase.  For example, I received the phrase: ‚ÄúPlease connect me with a representative of the advertising department‚Äù, if there is a record in the database, where the phrase = ‚Äúadvertising department‚Äù, then the caller will connect to the corresponding number (number). </p><br><p>  Mysql table recogStats. </p><br><p> <code>id(PK, int), date (datetime), ctime(float), rtime(float),stime(float), phrase(varchar(60))</code> </p> <br><p>  This table is used for storing recognition results and collecting statistics on recognition time.  ctime is the time taken to convert an audio file, rtime is the time taken to load and recognize, stime is the time taken to search </p><br><p>  Mysql table ivr_stat. </p><br><p> <code>id(PK, int), calldate (datetime),clid(varchar(15)),duration(int(20)),callednum(varchar(10)),rstatus(varchar(20)),channame(varchar30)),RECREZ(varchar(200))</code> </p> <br><p>  This table is used to keep records of recognition results (RECREZ, rstatus), to whom the caller went on the search results of the recognized phrase (callednum), to keep statistics on how much time the person spent in the recognition menu (duration) and for debugging (channame) </p><br><p>  Mysql table CustomRequests. </p><br><p> <code>id(PK, int), nomer(int(10)), request(varchar(100))</code> <br>  Auxiliary directory of additional groups and departments. </p><br><p>  Mysql table numdescriptions. </p><br><p> <code>Num(text), name(text)</code> </p> <br><p>  Reference c description of the entered numbers for voice. </p><br><p>  Mysql tables spravochnik_rus and spravochnik_rus_name_num_no_tops </p><br><p> <code>nomer(varchar(11)), fio(varchar(100))</code> </p> <br><p>  Reference persons with numbers.  The first is complete, for internal use.  At the second, for external use, the numbers of directors and managers are wrapped in the secretariat. </p><br><p>  <strong>AGI script that converts, sends and searches the recognized phrase.</strong> </p><br><p>  Used libraries: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> difflib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> exit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MySQLdb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pymssql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> itertools <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> permutations <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> remove <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> timeit</code> </pre> <br><p>  As well as the <strong>asterisk.agi</strong> library, which we import depending on debugging (debugging is done on windows machines). </p><br><p>  <strong>Description of variables.</strong> </p><br><pre> <code class="python hljs">WINDEBUG = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p>  Debug flag </p><br><pre> <code class="python hljs">_digits = re.compile(<span class="hljs-string"><span class="hljs-string">'\d'</span></span>)</code> </pre> <br><p>  Variable compiled regular expression on numbers. </p><br><pre> <code class="python hljs">uniqid = str(uuid.uuid1()).replace(<span class="hljs-string"><span class="hljs-string">'-'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)</code> </pre> <br><p>  Unique identifier variable </p><br><pre> <code class="python hljs">dkey = <span class="hljs-string"><span class="hljs-string">'12345678-9101-1121-3141-51617181920'</span></span></code> </pre> <br><p>  API-key Yandex speech kit. </p><br><pre> <code class="python hljs">lang = <span class="hljs-string"><span class="hljs-string">'ru-RU'</span></span></code> </pre> <br><p>  Language option for Yandex speechkit. </p><br><pre> <code class="python hljs">topic = <span class="hljs-string"><span class="hljs-string">'queries'</span></span></code> </pre> <br><p>  Theme recognition option for Yandex speechkit. </p><br><pre> <code class="python hljs">callnumber = <span class="hljs-string"><span class="hljs-string">'222'</span></span></code> </pre> <br><p>  The number to call by default. </p><br><pre> <code class="python hljs">setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, callnumber)</code> </pre> <br><p>  Set the number to call by default, in case something goes wrong. </p><br><pre> <code class="python hljs">persondic = dict()</code> </pre> <br><p>  Dictionary name - number. </p><br><pre> <code class="python hljs">persondicFI=dict()</code> </pre> <br><p>  FI Dictionary - number. </p><br><pre> <code class="python hljs">persondicF=dict()</code> </pre> <br><p>  Dictionary Last Name - Number. </p><br><pre> <code class="python hljs">otherdic = dict()</code> </pre> <br><p>  Dictionary with other records of the form Record - number. </p><br><pre> <code class="python hljs">descriptions = dict()</code> </pre> <br><p>  The dictionary with descriptions for generating voice acting, Record view - number. </p><br><pre> <code class="python hljs">duplicates = list()</code> </pre> <br><p>  Service list for filtering duplicates. </p><br><pre> <code class="python hljs">nums = list()</code> </pre> <br><p>  List with all internal numbers. </p><br><pre> <code class="python hljs">outfile = <span class="hljs-string"><span class="hljs-string">'/tmp/'</span></span> + uniqid + <span class="hljs-string"><span class="hljs-string">'-pcm.wav'</span></span></code> </pre> <br><p>  Variable temporary output audio file. </p><br><pre> <code class="python hljs">mysqlhost=<span class="hljs-string"><span class="hljs-string">'myhost'</span></span> mysqlpass=<span class="hljs-string"><span class="hljs-string">'mypass'</span></span> mysqluser=<span class="hljs-string"><span class="hljs-string">'myuser'</span></span> mysqldb=<span class="hljs-string"><span class="hljs-string">'mydb'</span></span> mssqlhost=<span class="hljs-string"><span class="hljs-string">'mshost'</span></span> mssqlpass=<span class="hljs-string"><span class="hljs-string">'mspass'</span></span> mssqluser=<span class="hljs-string"><span class="hljs-string">'msuser'</span></span> mssqldb=<span class="hljs-string"><span class="hljs-string">'msdb'</span></span></code> </pre> <br><p>  Details to connect to mysql and mssql. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asterisk.agi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * agi = AGI() infile = agi.env[<span class="hljs-string"><span class="hljs-string">'agi_arg_1'</span></span>] caller = agi.get_variable(<span class="hljs-string"><span class="hljs-string">'CALLERID(num)'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: caller = <span class="hljs-string"><span class="hljs-string">'1064'</span></span> infile = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br><p>  Import the library, set the variable name of the input audio file and the number of the caller, depending on the debugging. </p><br><p>  <strong>Feature Description</strong> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: agi.verbose(s) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> s</code> </pre> <br><p>  Depending on the value of the debug variable, we display messages in the asterisk console or in stdout. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setVar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(varname, varval)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: agi.set_variable(varname, varval) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"setting var "</span></span> + varname + <span class="hljs-string"><span class="hljs-string">" with value "</span></span> + varval</code> </pre> <br><p>  Depending on the value of the debug variable, we assign the value of the dialplan variable to the asterisk or output to stdout. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contains_digits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">'enter contains_digits'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bool(_digits.search(s))</code> </pre> <br><p>  Check if s contains digits. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return_digits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">'return digits'</span></span>) pstr = s.encode(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) all = string.maketrans(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) nodigs = all.translate(all, string.digits) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unicode(pstr.translate(all, nodigs), <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>)</code> </pre> <br><p>  We return only numbers from s. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_dob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(num)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int(num) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nums: verb(<span class="hljs-string"><span class="hljs-string">'checkdob success'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'checkdob fail'</span></span> + num) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p>  Check for the existence of an extension number in the nums list. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_dob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(strnum)</span></span></span><span class="hljs-function">:</span></span> buf = return_digits(strnum) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> contains_digits(strnum): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> check_dob(buf): verb(<span class="hljs-string"><span class="hljs-string">'setting var '</span></span> + buf) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SAYDIAL'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span></code> </pre> <br><p>  The function of setting the extension number. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(infile)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int(os.stat(infile).st_size) &lt;= <span class="hljs-number"><span class="hljs-number">26364</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, <span class="hljs-string"><span class="hljs-string">'repeat'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SILENCE'</span></span>) verb(<span class="hljs-string"><span class="hljs-string">'empty file received'</span></span>) remove(infile) exit(<span class="hljs-number"><span class="hljs-number">9</span></span>)</code> </pre> <br><p>  Checking the received audio recording file for recognition, if the size is too small, we assume that the phone is silent. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSessionStat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctime, rtime, stime, phrase)</span></span></span><span class="hljs-function">:</span></span> cdate = time.strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span></span>) db = MySQLdb.connect(host=mysqlhost, user=mysqluser, passwd=mysqluser, db=mysqldb, charset=<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) cur = db.cursor() cur.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO recogStats(date,ctime,rtime,stime,phrase) VALUES ('"</span></span> + cdate + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str(ctime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str( rtime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + str(stime) + <span class="hljs-string"><span class="hljs-string">"','"</span></span> + phrase + <span class="hljs-string"><span class="hljs-string">"')"</span></span>) db.commit() db.close()</code> </pre> <br><p>  Record recognition statistics function. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillDics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> db = MySQLdb.connect(host=mysqlhost, user=mysqluser, passwd=mysqlpass, db=<span class="hljs-string"><span class="hljs-string">"central_cdr"</span></span>, charset=<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) cur = db.cursor() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(caller) != <span class="hljs-number"><span class="hljs-number">4</span></span>: tbname = <span class="hljs-string"><span class="hljs-string">'spravochnik_rus_name_num_no_tops'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: tbname = <span class="hljs-string"><span class="hljs-string">'svravochnik_rus_persons'</span></span> cur.execute(<span class="hljs-string"><span class="hljs-string">"""SELECT nomer,fio from """</span></span> + tbname) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cur.fetchall(): fullfio=row[<span class="hljs-number"><span class="hljs-number">1</span></span>].lower() f=<span class="hljs-string"><span class="hljs-string">" "</span></span>.join(fullfio.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persondicF.keys():<span class="hljs-comment"><span class="hljs-comment"># and f not in duplicates : persondicF[f] = int(row[0]) elif fullfio in persondic.keys(): pass else: duplicates.append(f) if not fullfio in persondic.keys(): persondic[fullfio] = int(row[0]) fi=" ".join(fullfio.split(' ')[0:2]) if not fi in persondicFI.keys(): persondicFI[fi] = int(row[0]) elif fullfio in persondic.keys(): pass else: persondicFI.pop(fi) uniquedups=[x for x in list(set(duplicates)) if x != ''] for item in uniquedups: for key in persondicF.keys(): if item in key: persondicF.pop(key) cur.execute("""SELECT nomer,request from CustomRequests """) for row in cur.fetchall(): otherdic[row[1].lower()] = row[0] cur.execute("""SELECT num,name from numdescriptions """) for row in cur.fetchall(): descriptions[str(row[0])] = row[1] cur.execute("""SELECT nomer from spravochnik_rus """) for row in cur.fetchall(): nums.append(int(row[0])) db.close()</span></span></code> </pre> <br><p>  This function fills dictionaries of Surnames (persondicF), Surnames of Names (persondicFI), full name (persondic), department names (otherdic), descriptions for speech synthesis (descriptions) and all company numbers (nums). <br>  Depending on the length of the caller's number, a table is taken which contains the directors' numbers (internal caller) or does not contain (external caller). <br>  The directory of surnames is being tested for uniqueness in order to exclude the presence in it of two Ivanovs with different numbers. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(infile, outfile)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#convert file verb("Converting WAV " + infile) soxconvert = subprocess.Popen(['sox', infile, '-r', '16000', '-b', '16', '-c', '1', outfile], stdout=subprocess.PIPE) (out, err) = soxconvert.communicate() # remove(infile) if soxconvert.returncode != 0: setVar('NUMTOCALL', callnumber) # return "" exit(9)</span></span></code> </pre> <br><p>  The conversion function of the file recorded in the asterisk, in case sox gives an error, set the default number and exit the script. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendRecog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(file)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">"Sending file to yandex: "</span></span> + outfile) proc = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'--max-time'</span></span>, <span class="hljs-string"><span class="hljs-string">'5'</span></span>, <span class="hljs-string"><span class="hljs-string">'--silent'</span></span>, <span class="hljs-string"><span class="hljs-string">'asr.yandex.net/asr_xml?key='</span></span> + dkey + <span class="hljs-string"><span class="hljs-string">'&amp;uuid='</span></span> + uniqid + <span class="hljs-string"><span class="hljs-string">'&amp;topic='</span></span> + topic + <span class="hljs-string"><span class="hljs-string">'&amp;lang=ru-RU'</span></span>, <span class="hljs-string"><span class="hljs-string">'-F'</span></span>, <span class="hljs-string"><span class="hljs-string">'Content-Type=audio/x-pcm;bit=16;rate=16000'</span></span>, <span class="hljs-string"><span class="hljs-string">'-F'</span></span>, <span class="hljs-string"><span class="hljs-string">'audio=@'</span></span> + outfile], stdout=subprocess.PIPE) (out, err) = proc.communicate() verb(<span class="hljs-string"><span class="hljs-string">"return code is: "</span></span> + str(proc.returncode)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> proc.returncode != <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> remove(file) e = xml.etree.ElementTree.fromstring(out) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e.attrib[<span class="hljs-string"><span class="hljs-string">'success'</span></span>] == <span class="hljs-string"><span class="hljs-string">'1'</span></span>: verb(e._children[<span class="hljs-number"><span class="hljs-number">0</span></span>].text) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e._children[<span class="hljs-number"><span class="hljs-number">0</span></span>].text <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  The function of sending a file to recognize and receive a response from Yandex.  In case recognition succeeded, take the first answer.  With curl library, I could not do this, for this reason I use this option. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchfiobyf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(f.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>))==<span class="hljs-number"><span class="hljs-number">2</span></span>: limit=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(f.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>))&gt;=<span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: limit=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fio,num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> persondic.iteritems(): cutfio=<span class="hljs-string"><span class="hljs-string">" "</span></span>.join(fio.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>:limit]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> f == cutfio: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fio</code> </pre> <br><p>  The full name search function, depending on whether the last name or surname and first name came to the input. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">combinationSearcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phrase,pdic,quality)</span></span></span><span class="hljs-function">:</span></span> verb(<span class="hljs-string"><span class="hljs-string">u'searching in persons'</span></span>) result = difflib.get_close_matches(phrase, pdic.keys(), <span class="hljs-number"><span class="hljs-number">1</span></span>, quality) <span class="hljs-comment"><span class="hljs-comment">#verb(" ".join(result)) if len(result) &gt; 0: fullfio=searchfiobyf(result[0]) verb(u'found ' + str(pdic[result[0]])) setVar('RSTATUS', 'NAMESUCCESS') setVar('FNAME', fullfio) return pdic[result[0]] else: return ""</span></span></code> </pre> <br><p>  The search function combinations, example: phrase = "Alexey Peter", in the pdic contains the entry "Alexeyev Peter", the function get_close_matches returns "Alexeyev Peter".  The function may produce incorrect results, but, as practice has shown, there are much more correct responses.  The quality parameter allows you to set the accuracy of searching for similar phrases. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNumByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recognizedString)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">u''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> recognizedString: verb(<span class="hljs-string"><span class="hljs-string">'enter dobavochn'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(recognizedString.replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)) == <span class="hljs-number"><span class="hljs-number">4</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'enter num say'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(recognizedString) &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> recognizedString.lower() <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>]: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SHORT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> verb(<span class="hljs-string"><span class="hljs-string">u'start searching'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  split = list(set(recognizedString.split(" "))) parts = len(split) fixedstring=" ".join(split) if parts &gt;= 5: verb('Phrase is long. Using FTDB') buf = mssqlwrapper(fixedstring) if buf != '': buf = mssqlwrapper(fixedstring)[0] if str(buf) in descriptions.keys(): setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') return buf else: setVar('RSTATUS', 'REQUESTNOTFOUND') return "repeat" result="" if parts == 1: mssqlcheck=mssqlwrapper(fixedstring) if mssqlcheck!='': if mssqlcheck[2]&gt;=80: buf=str(mssqlcheck[0]) if buf in descriptions.keys(): setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') result=buf else: result=combinationSearcher(fixedstring,persondicF,0.7) elif parts ==2: combs = list(permutations(split, parts)) # (  ,   ,   .....) for item in combs: element = " ".join(item) result=combinationSearcher(element,persondicFI,0.7) if result!="": break elif parts ==3: combs = list(permutations(split, parts)) for item in combs: element = " ".join(item) result=combinationSearcher(element,persondic,0.8) if result!="": break if result!="": return result verb('Low ftdbsearch') buf = mssqlwrapper(recognizedString) if buf != '': buf = mssqlwrapper(recognizedString)[0] if str(buf) in descriptions.keys(): verb('it is') setVar('FNAME', descriptions[str(buf)]) setVar('RSTATUS', 'DEPTSUCCESS') return buf else: verb(u'item not found ' + recognizedString) #    setVar('RSTATUS', 'REQUESTNOTFOUND') return callnumber</span></span></code> </pre> <br><p>  <strong>The main function of finding a number by phrase.</strong> </p><br><p>  Let's sort this function in parts. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">u''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> recognizedString: verb(<span class="hljs-string"><span class="hljs-string">'enter dobavochn'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString)</code> </pre> <br><p>  Example: the phrase ‚ÄúPlease extension 1234‚Äù will return the extension number (if any). </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(recognizedString.replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)) == <span class="hljs-number"><span class="hljs-number">4</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'enter num say'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set_dob(recognizedString)</code> </pre> <br><p>  In case the user has said a four-digit number, return the corresponding additional number (if any). </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(recognizedString) &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> recognizedString.lower() <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>,<span class="hljs-string"><span class="hljs-string">u""</span></span>]: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SHORT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span></code> </pre> <br><p>  In order not to make extra runs of the program on short phrases (this can happen when Yandex heard and recognized a part of the conversation when the caller did not listen to the recognition message). </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parts &gt;= <span class="hljs-number"><span class="hljs-number">5</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'Phrase is long. Using FTDB'</span></span>) buf = mssqlwrapper(fixedstring) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf != <span class="hljs-string"><span class="hljs-string">''</span></span>: buf = mssqlwrapper(fixedstring)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(buf) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'REQUESTNOTFOUND'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"repeat"</span></span> result=<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre><br><p>  For long phrases (more than five words), we immediately turn to FT base mssql. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parts == <span class="hljs-number"><span class="hljs-number">1</span></span>: mssqlcheck=mssqlwrapper(fixedstring) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mssqlcheck!=<span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mssqlcheck[<span class="hljs-number"><span class="hljs-number">2</span></span>]&gt;=<span class="hljs-number"><span class="hljs-number">80</span></span>: buf=str(mssqlcheck[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) result=buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: result=combinationSearcher(fixedstring,persondicF,<span class="hljs-number"><span class="hljs-number">0.7</span></span>)</code> </pre> <br><p>  If the recognized phrase consists of one word, we first look at the FT database, with 80% match accuracy, look for the description of the recognized number, set the result variable and the number plan status variable, otherwise we search for similar words in the surnames dictionary. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> parts ==<span class="hljs-number"><span class="hljs-number">2</span></span>: combs = list(permutations(split, parts)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> combs: element = <span class="hljs-string"><span class="hljs-string">" "</span></span>.join(item) result=combinationSearcher(element,persondicFI,<span class="hljs-number"><span class="hljs-number">0.7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p>  If the phrase consists of two words, we assume that it is a surname and first name. <br>  We make a list of combinations (Ivanov Ivan, Ivan Ivanov) and look for similar matches. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> parts ==<span class="hljs-number"><span class="hljs-number">3</span></span>: combs = list(permutations(split, parts)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> combs: element = <span class="hljs-string"><span class="hljs-string">" "</span></span>.join(item) result=combinationSearcher(element,persondic,<span class="hljs-number"><span class="hljs-number">0.8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p>  In case of receiving a phrase from three words, we assume that it is a full name, we make a list of combinations and look for it in a dictionary with a full name.  Return result if the variable is not empty. </p><br><pre> <code class="python hljs">buf = mssqlwrapper(recognizedString) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> buf != <span class="hljs-string"><span class="hljs-string">''</span></span>: buf = mssqlwrapper(recognizedString)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(buf) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> descriptions.keys(): verb(<span class="hljs-string"><span class="hljs-string">'it is'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'FNAME'</span></span>, descriptions[str(buf)]) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEPTSUCCESS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: verb(<span class="hljs-string"><span class="hljs-string">u'item not found '</span></span> + recognizedString) <span class="hljs-comment"><span class="hljs-comment">#    setVar('RSTATUS', 'REQUESTNOTFOUND') return callnumber</span></span></code> </pre> <br><p>  If we have not found a match, we do a search in the FT database, if we find a match, we return the result and description, otherwise, we return the default number and set the status that the phrase was not found. </p><br><p>  <strong>The main body of the program.</strong> </p><br><pre> <code class="python hljs">fillDics() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: checkSize(infile) start_time = timeit.default_timer() convert(infile, outfile) convert_elapsed = timeit.default_timer() - start_time start_time = timeit.default_timer() checkstring = sendRecog(outfile).lower() recog_elapsed = timeit.default_timer() - start_time verb(<span class="hljs-string"><span class="hljs-string">'convert_elapsed = '</span></span> + str(recog_elapsed)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checkstring == <span class="hljs-string"><span class="hljs-string">""</span></span>: verb(<span class="hljs-string"><span class="hljs-string">'not recognized. using default.'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, <span class="hljs-string"><span class="hljs-string">'repeat'</span></span>) setVar(<span class="hljs-string"><span class="hljs-string">'RSTATUS'</span></span>, <span class="hljs-string"><span class="hljs-string">'SILENCE'</span></span>) exit(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: setVar(<span class="hljs-string"><span class="hljs-string">'RECREZ'</span></span>, checkstring) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: checkstring = <span class="hljs-string"><span class="hljs-string">u""</span></span> start_time = timeit.default_timer() callnumber = getNumByName(checkstring) search_elapsed = timeit.default_timer() - start_time <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> WINDEBUG: setVar(<span class="hljs-string"><span class="hljs-string">'NUMTOCALL'</span></span>, str(callnumber)) addSessionStat(convert_elapsed, recog_elapsed, search_elapsed, checkstring.lower())</code> </pre> <br><p>  The function of filling in dictionaries starts, if we are not debugging the program - we fill in the timer variables, check the file size, convert, send for recognition, otherwise, we fill in the checkstring variable with a check phrase. <br>  Next, we fill in the variables of the timers for recognition, conduct a search for phrases in our structure.  And, in the case of combat operation, we set a variable for the numbering plan and enter statistics. </p><br><p>  <strong>Some statistics.</strong> </p><br><p>  <em>June 2018:</em> <br>  successful recognition - 1010 <br>  silent on the phone - 78 <br>  recognition failed (no match found) - 79 <br>  short request - 4 <br>  recognized department - 7 <br>  average recognition time (average response time of Yandex) - 2.6 seconds </p><br><p>  <em>June 2017:</em> <br>  successful recognition - 1271 <br>  recognized department - 18 <br>  recognition failed (no match found) - 127 <br>  short request - 9 <br>  silent on the phone - 71 <br>  average recognition time (average response time of Yandex) - 1.5 seconds </p><br><p>  This service is successfully used in the company where I work.  I hope my achievements will help other people to implement their ideas or similar functionality.  Ready to answer all questions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/417273/">https://habr.com/ru/post/417273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417261/index.html">Uber after the accident with the participation of his mobile phone decided to reduce the staff of operators of smart machines in Pittsburgh</a></li>
<li><a href="../417263/index.html">Javascript as the embodiment of evil</a></li>
<li><a href="../417265/index.html">Top 10: best reports DotNext 2017 Moscow</a></li>
<li><a href="../417269/index.html">Where to go to the designer: prestigious international awards</a></li>
<li><a href="../417271/index.html">Can a hacker block the English Channel?</a></li>
<li><a href="../417275/index.html">7 skills of effective designers. Powerful development tools in the profession</a></li>
<li><a href="../417277/index.html">Free libraries for creating and editing PDF files</a></li>
<li><a href="../417283/index.html">Disney introduced its own hair animation system HairControl</a></li>
<li><a href="../417285/index.html">Where to insert quotation mark in IPv6</a></li>
<li><a href="../417287/index.html">"Calendar of the tester" for July. Analytics testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>