<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx as Reverse Proxy for a site that uses SSL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 How to configure nginx as a frontend to apache and why it is needed is written repeatedly, including on Habr√©. My case is a little diff...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx as Reverse Proxy for a site that uses SSL</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  How to configure nginx as a frontend to apache and why it is needed is written repeatedly, including on Habr√©.  My case is a little different from the classic one.  It all started as usual, a project on apache, an increase in the number of visitors and, associated with it, insufficient server resources.  But the project used SSL to protect the exchange of data with clients.  What I encountered and how I solved the problems I will tell under the cut. <br><a name="habracut"></a><br><h4>  Problems </h4><br>  Since the direct reception of client requests has passed on to nginx, then work with SSL should be transferred to it.  Apache, which now hung but loopback 127.0.0.1:8080, did not need SSL support.  The first problem was that the certificate was from Thawte, and they required the use of an intermediate certificate.  Nginx for working with such certificates has no special directive.  In apache config it was like this: <br><br><pre><code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost 1.2.3.4:443&gt;</span></span> ... <span class="hljs-attribute"><span class="hljs-attribute">SSLEngine</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span> SSLCertificateFile /usr/local/ssl/www.blabla.ru/public.crt SSLCertificateKeyFile /usr/local/ssl/www.blabla.ru/private.key SSLCACertificateFile /usr/local/ssl/www.blabla.ru/intermediate.crt ... &lt;/VirtualHost&gt;</code> </pre> <br>  How to <b>deal</b> with <b>SSLCACertificateFile</b> in nginx?  It turned out that you just need to ‚Äúsplice‚Äù two files by putting their contents into one (public certificate, followed by an intermediate one): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/ssl/www.blabla.ru cp public.crt public_concat.crt cat intermediate.crt &gt;&gt; public_concat.crt</code> </pre><br>  Everything, now in nginx we just write: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">1.2.3.4:443</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.blabla.ru; <span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /usr/local/ssl/www.blabla.ru/public_concat.crt; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /usr/local/ssl/www.blabla.ru/private.key; ... }</code> </pre><br>  A redirect from an unprotected site to a protected one did not cause any difficulties in setting up: <br><br><pre> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">1.2.3.4:80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.blabla.ru blabla.ru; <span class="hljs-comment"><span class="hljs-comment"># rewrite ^(.*) https://www.blabla.ru$1 permanent; return 301 https://www.blabla.ru$request_uri; }</span></span></code> </pre><br>  Difficulties started with ajax.  Asynchronous requests to the server were performed with the http: // prefix, which caused the ajax-destructive redirect 301. There was a need to transfer environment variables, in particular the protocol name, from nginx to apache, it was done this way: <br>  in nginx: <br><br><pre> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { ... <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>; ... } ... }</code> </pre><br>  The most important thing in apache is to specify in the definition of a virtual host: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost 127.0.0.1:8080&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">ServerName</span></span></span></span> www.blabla.ru ... SetEnvIf X-Forwarded-Proto https HTTPS=<span class="hljs-literal"><span class="hljs-literal">on</span></span> ... &lt;/VirtualHost&gt;</code> </pre><br>  Now all ajax requests go to https: // as required.  For this trick, the apache setenvif_module module must be installed and enabled in the config file: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">LoadModule</span></span></span></span> setenvif_module libexec/apache22/mod_setenvif.so</code> </pre><br>  It is also worth bearing in mind that some applications may themselves determine their path based on environment variables.  For example, phpMyAdmin, which is needed by resource developers, if it doesn‚Äôt have the full path in the config file, it will form it with the port specified.  So I got something like this: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">https</span></span>://www.blabla.ru:80/myadmin</code> </pre><br>  This is the most: 80 badly spoiled everything, phpMyAdmin did not open with a curse that SSL security error.  It was cured, as stated above, by direct indication of the path in the phpMyAdmin config: <br><br><pre> <code class="php hljs">$cfg[<span class="hljs-string"><span class="hljs-string">'PmaAbsoluteUri'</span></span>] = <span class="hljs-string"><span class="hljs-string">'https://www.blabla.ru/myadmin'</span></span>;</code> </pre><br><br>  Do not forget about the transfer of real IP addresses of visitors to apache to save the existing logging scheme.  This is painted repeatedly, dig in the direction of the apache rpaf_module module. <br><br>  <b>PS:</b> Everything was done under FreeBSD 8.2, Apache 2.2.22_5, nginx-1.0.14,1.  I did not post the full texts of the configs so as not to inflate the note.  For the same reason, I focused on the transfer of real IP clients and the rpaf_module module.  If necessary - lay out. </div><p>Source: <a href="https://habr.com/ru/post/142363/">https://habr.com/ru/post/142363/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142356/index.html">Project Lombok, or declare war on a boilerplate</a></li>
<li><a href="../142358/index.html">How to get money from an investor without an iron and a rubber truncheon?</a></li>
<li><a href="../142359/index.html">NFC + metronchiki = great benefit</a></li>
<li><a href="../142360/index.html">Management of sharing and likes on Khabryaks</a></li>
<li><a href="../142361/index.html">Statistics on iOS and Android devices in Russia</a></li>
<li><a href="../142366/index.html">How to make a good promotional video for a startup. Part 1. Problem-solution</a></li>
<li><a href="../142368/index.html">2012: We start in the AppStore</a></li>
<li><a href="../142369/index.html">Nvidia for professional 3D applications</a></li>
<li><a href="../142372/index.html">Asynchronous programming in ASP.NET MVC 4 applications</a></li>
<li><a href="../142373/index.html">phpBBex - add class autoloading and AJAX request handlers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>