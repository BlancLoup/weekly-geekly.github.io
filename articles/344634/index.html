<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ATOL Online Online Cash Desk Service: API and CMS Integration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We reveal the general details of working with the online service of online cash registers, the nuances of integration with CMS and the pitfalls that y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ATOL Online Online Cash Desk Service: API and CMS Integration</h1><div class="post__text post__text-html js-mediator-article">  We reveal the general details of working with the online service of online cash registers, the nuances of integration with CMS and the pitfalls that you stumble upon if you don‚Äôt use ready-made solutions and will be engaged in the integration yourself. <br><br><img src="https://habrastorage.org/webt/tq/q0/nk/tqq0nkxmfumkdkvhlbazej0fkse.png"><br><br><a name="habracut"></a><br>  According to 54-FZ, all trade and service platforms accepting payment via the Internet should go to online cash desks, sending real-time electronic checks to the FTS.  From July 1, 2017, this requirement applies not only to online stores, but also to a wide variety of online services that collect payments from individuals using bank cards, and from July 1, 2018, changes will also affect those who use the services of alternative means of payment (online wallets) - Webmoney, Yandex, Money, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although the transition to the new cash registers had to take place, the FTS data suggest that the lion's share of the online trading and service platforms on the Internet has not yet legalized online payments to consumers.  According to official statistics, about 14 thousand cash registers are registered with a sign of ‚Äúpayments on the Internet‚Äù, while the market segment, according to various sources, has at least 50 thousand enterprises (here we are talking only about companies that accept payments via the Internet from individuals). <br><br>  Thus, more than half of the companies have not yet bothered with the fiscalization of settlements.  Some online sites remain in the shadows, hoping that in the transition period they will not be interested in the FTS, while others, in order not to violate the law, simply turned off the reception of online payments. <br><br>  We write a lot about how to do everything legally.  Today we will talk about the details of the interaction of our cash desks within the framework of the ATOL Online service with the internal systems of online stores. <br><br><h2>  Briefly about the service </h2><br>  Buying an online ticket office is not a cheap event.  An available alternative to buying is renting (‚Äúonline booking as a service‚Äù).  This service is what ATOL Online provides. <br><br>  The idea of ‚Äã‚Äãthe service is similar to SaaS, but in this case, due to the limitations of 54-, this is not about renting virtual capacities, but about temporary use of quite real (physical) cash desk located in our data center. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/45f/0ea/ccc/45f0eaccc040a9d73fc4e4a945d87de0.jpg"><br><br>  Under the contract, one or several cash desks are reserved for the client and are registered by him through the personal account of the taxpayer on the FTS website. <br><br>  Although today there are alternative rental services, ATOL Online in 2017 was the first in this market segment.  Currently, approximately every third cash desk registered with the Federal Tax Service for payments on the Internet is rented from ATOL. <br><br>  The number of cash desks required for each specific store depends on the amount of information transmitted to the FTS - that is, in fact, on the number of orders processed per unit of time.  The queue of documents at the cash desk is managed on the service side - they are evenly distributed among the available hardware resources.  Recommendations and <a href="https://online.atol.ru/">calculator</a> for calculating the approximate number of units of equipment are on our website. <br><br>  The service allows to evaluate the parameters of the queue from the documents at the cash desks (processing speed of each document), from which it is possible to draw conclusions about whether the number of cash desks was correctly calculated.  The growth of the queue of the raw documents is a clear sign that the volume of leased resources should be increased. <br><br>  Like the "classic" software rental services or infrastructure services, the service allows for flexible scaling of resources available to the end user.  However, due to the registration requirements of each cash register in the Federal Tax Service for a particular company, the scaling procedure has some peculiarities. <br><br>  In case of failure of excessive resources, the procedure is performed quickly.  However, the FN archive used in the ‚Äúextra cash‚Äù will have to be closed and the cash register itself deregistered (the unused cash desk will most likely be transferred to another client, and the FN, although it is valid for 13 months, is firmly assigned to the company and the physical cash desk - thus, with another cashier for expanding the fleet of leased vehicles at the expense of an arbitrary cash desk, it cannot be used). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e84/358/df0/e84358df057bd285c6e7c2fa25977ffa.jpg"><br><br>  With an increase in the number of cash registers, the procedure is slightly stretched in time.  Since the subject of taxation is required to register with the FTS each cash desk independently (through a personal account at nalog.ru), the speed with which additional resources will be provided depends, among other things, on the store itself.  In principle, it is possible to do it within a day. <br><br>  Scaling opens up the possibility to flexibly vary the number of cash registers, predicting peak loads.  Although this is only one of the options for work.  Most of the stores prefer a different approach - to count the number of constantly rented cash desks, including the peak loads.  Outside of the peaks, the equipment is not used to its full capacity, but this scheme provides greater fault tolerance. <br><br><h2>  Why and who needs API </h2><br>  In addition to the use of online cash registers, 54-FZ regulates the new parameters of the cash voucher - additional details and a mandatory reflection in the document of all commodity items with the corresponding tax rates.  Regardless of whether the cash register was acquired by the company or leased, information on product positions and their total value (with all discounts and surcharges, along with the tax rate) must be received from the external system - from the CMS store or service platform .  The subtleties of this process depend on the details of the task, but in the general case, ensuring the integration of the CMS and the online cash register, both in the presence and absence of the payment aggregator, is a technically non-trivial task. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/27a/c79/6bf/27ac796bf574566a0b1ef9fc8df5bf22.png"><br><br>  From the very beginning, ATOL Online offered an open, universal API for interacting with third-party systems.  With a number of popular CMS and payment aggregators, the service already has a ready-made integration out of the box (and the list of partners is constantly growing).  That is, for a store that has just decided to align its activities with current legislation, this simplifies the procedure: if you use a popular CMS, you will not have to understand the details of the API, you can use a ready-made module.  And buying a ready-made solution (CMS) from scratch or choosing a payment aggregator, you can pick up a tool with integration with the online cash register already implemented. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43d/c9f/335/43dc9f335e489866b72f6a55b321dbfe.png"><br><br>  <b>Integrated payment aggregators and banks:</b> Sberbank, Yandex Cash, RoboKassa, RBKmoney, Raiffeisen Bank, Tinkoff, Gazprombank and others. <br><br>  The API as such will be of interest to those who use handwriting tools.  At one time, a number of companies (mostly large ones), instead of acquiring a third-party CMS system, chose the way of writing their own.  They have to work with the API directly.  From our point of view, this segment of users is the most difficult, since self-written CMS processes processes a little differently, can give out wrong information, etc.  And with each client there is a separate project. <br><br><h2>  API details </h2><br>  Let's try, without plunging into details, to tell what the ATOL Online API is. <br><br>  Communication with the online cashier within the API consists of three parts: <br><br><ul><li>  authorization (getting a token); <br></li><li>  sending checks for fiscalization; <br></li><li>  obtaining the result of fiscalization. <br></li></ul><br>  In the course of interaction, only the parameters that are really needed for fiscalization of checks are required from the Internet site - no complicated additional systems, such as the calculation of discounts and promotions, are provided here.  In strict accordance with the 54-FZ API, it is possible to transfer from the online store to the online cash desk a list of goods in the basket with all the related information: <br><br><ul><li>  the names of commodity items are within 128 characters according to the law (at the moment, the API has a length of 64 characters, but the service will process 128 characters); <br></li><li>  price per unit; <br></li><li>  the number of units (for each commodity item); <br></li><li>  full price; <br></li><li>  tax rate for each item (if you wish, you can transfer the amount of VAT, but this is not necessary). <br></li></ul><br>  Protocols exchange information online cash with CRF and the FTS provide for a limit on the total size of the electronic check in 30 KB.  The number of goods that can be placed in such a check depends on a whole set of parameters (such as the length of the product name and service information, which adds about 15% of the volume), therefore, in general, it is impossible to forecast the number of goods that fit in one check. <br><br>  Until recently, the ATOL Online API had its own limit of 100 items in a check, which allowed it to meet the prescribed 30 KB with a margin.  But since the operation of the service showed that for some customers the restriction of 100 products plays a significant role, it was removed.  Now the stores need to independently control the check overflow - that is, it is required to accept and process the corresponding error from ATOL online.  This is especially true of shops where the buyer can collect a large number of small piece goods (fasteners, electronic components, etc.) into the basket, or platforms where collective purchases are popular (textbooks and office for the whole school class). <br><br>  Technically, checks of more than 30 Kbytes in online trading are processed in the same way as in offline trading, where the cashier simply splits the basket into two checks.  However, this logic must be on the side of the external system ‚Äî i.e.  the store, since ATOL Online can only give an error that fiscalization is not performed (by law, you can not pay two checks through a single transaction). <br><br>  In addition to the above information through the API, the store must provide the user's phone or email where the electronic check will be sent. <br><br>  By law, it is the online store that must ensure the delivery of the electronic check to the buyer, that is, his duty is to find out the delivery address (although, of course, the retailer will be liable if the user has provided deliberately incorrect data).  Directly delivery, he can delegate the OFD or carry out independently.  In the latter case, signs of a fiscal document are transferred back through the API after fiscalization, for which an electronic check can be found at the FTS or at the CRF. <br><br>  The API delivers notifications that the document has been transferred for fiscalization - that is, it stood in a queue and went to the cashier - or, on the contrary, returned with an error, for example, by timeout (if the queue is too large and it is five minutes never got to the ticket office).  The time that the average documents spend in the queue is a good marker of whether the bank has leased the store. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/990/3d5/72e/9903d572e32e13b3c001b85de03dfd56.png"><br><br>  It should be noted that the ATOL Online service provides a wider functionality through a personal account.  Various statistics are available there, as well as fiscalized checks themselves.  Later similar functionality will appear in the API.  In addition, it is planned to make a reconciliation mechanism. <br><br><h2>  What does an online store need besides API </h2><br>  Working with online cash registers in practice rests not so much on finding equipment and setting up interaction by API, but on changing some business processes inside the store. <br><br>  The first step is to prepare for the transfer of the basket to the side for fiscalization.  Until now, many stores work with payment systems, simply transferring the amount to be paid.  It is impossible to continue working legally according to this scheme.  It is necessary to specify the entire list of goods in the basket.  And if the buyers in the sex shop will be happy to replace the names of real services with abstract ‚Äúservice 1‚Äù, ‚Äúservice 2‚Äù and so on, then consumers in the home appliance store will hardly be happy when nonsense appears in the check instead of real goods. <br><br>  Each item in the check must have a final price after the application of all discounts and surcharges.  Previously, the ticket office could itself calculate the discount, but now this can not be done.  In addition, in many CMS this logic is simply not embedded, so serious improvements are required here. <br><br>  In addition to the names and prices, as mentioned above, it is necessary to transfer the tax rate.  With this, there were difficulties even with large offline stores.  It was a real challenge for their internal automation system, since previously such information was not required or taken into account, and, accordingly, was not monitored.  Sometimes the logistician who takes the goods, simply out of habit, left the tax rates by default, because I was used to working like that.  But for the correct operation of the CMS bundle with the online cash register, it is necessary that the ‚Äúcorrect‚Äù mathematics everywhere (corresponding to the 54- models) be laid everywhere.  Without this, checks simply will not be fiscalized. <br><br>  A good example of non-compliance with mat-models is rounding.  The specification implies the transfer of kopecks in the form of two decimal places.  But many of their own systems transmit four and even five characters.  ATOL Online discards extra characters, while in the store‚Äôs own system, when calculating the total amount, it can be rounded off according to mathematical rules.  This is how the discrepancy of a few kopecks appears, which will not pass through the checkout  And such errors are very hard to catch. <br><br>  Another mandatory change is the said requirement for a mobile phone number or email address with the user.  Without this data there will be no fiscalization.  Until now, quite a lot of checks without identification data have been received in our system (their share reaches a few percent).  After sending such an ‚Äúanonymous‚Äù check, the online store receives an error message, but cannot do anything, because the transaction has already passed.  In this case, everything ‚Äúcleanly‚Äù can be done only through cancellation of the payment transaction (or the check can be sent later - with the correct details). <br><br>  As a result, the cost of the integration of the CMS and the online cash registers may be much less than the restructuring of the entire information system to the requirements of the federal law.  And this must be prepared. </div><p>Source: <a href="https://habr.com/ru/post/344634/">https://habr.com/ru/post/344634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344624/index.html">HP leaves random keylogger in laptop keyboard driver</a></li>
<li><a href="../344626/index.html">We understand and work with gulp</a></li>
<li><a href="../344628/index.html">Veritas Access 7.3: pros, cons, pitfalls</a></li>
<li><a href="../344630/index.html">Tutorial on creating a tracker cryptocurrency for android on Kotlin</a></li>
<li><a href="../344632/index.html">SOC for beginners. How to organize monitoring of incidents and response to attacks in the 24x7 mode</a></li>
<li><a href="../344638/index.html">Corona SDK - Crush Crush Game</a></li>
<li><a href="../344640/index.html">Mail for Good: how the community of programmers helps NGOs</a></li>
<li><a href="../344642/index.html">Something is wrong with the IDS signature</a></li>
<li><a href="../344644/index.html">Dynamic sound on destructible levels of Rainbow Six: Siege</a></li>
<li><a href="../344648/index.html">Born to intercept traffic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>