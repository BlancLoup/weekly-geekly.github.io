<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dive into Centrifugo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article about Centrifuge, I told you that the server was rewritten from Python to Go (Centrifugo code on github , description on opens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dive into Centrifugo</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/939/023/35d/93902335d4ef41d8b5f97e8ceaa2c59e.gif" align="left">  In the <a href="http://habrahabr.ru/company/mailru/blog/266017/">previous article</a> about Centrifuge, I told you that the server was rewritten from Python to Go (Centrifugo code on <a href="https://github.com/centrifugal/centrifugo">github</a> , description on <a href="https://opensource.mail.ru/Centrifugo">opensource.mail.ru</a> ).  Several months have passed since then, during which time the Centrifuge managed to get version 1.0.0 and even go a little further (the latest version at the time of this post is 1.4.2). <br><br>  In this article, we are waiting for a quick start working with Centrifuge, examples of real use, reflections on the location and purpose of the Centrifuge in the realities of 2016, a description of some architectural features / capabilities of the real-time server and Go code examples that are responsible for implementing the main features.  Welcome aboard! <br><a name="habracut"></a><br>  Let me remind you what a centrifuge is.  This is the server that runs next to the backend of your application.  Application users connect to the Centrifuge using the <a href="https://en.wikipedia.org/wiki/WebSocket">Websocket</a> protocol or the SockJS polyfill library.  Having connected and logged in using <a href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC-</a> token (received from the application backend), they subscribe to the channels of interest.  Having learned about a new event, the backend of the application sends it to the desired channel in Centrifuge using the HTTP API or the queue in Redis.  The centrifuge, in turn, sends a message to all connected interested users.  Nothing fundamentally new: <a href="http://www.leggetter.co.uk/real-time-web-technologies-guide/">a lot of products</a> are designed to solve real-time problems, some of them work in a similar way. <br><br>  If you have heard of the <a href="https://pusher.com/">pusher.com</a> service, then in some approximation you can consider Centrifugo as a self-hosted counterpart. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/ed2/2ad/919/ed22ad919cc04ad4b09aa413bfb14ef5.png"><br><br>  That is, conceptually nothing has changed.  Let's take a closer look at how the centrifuge works and how some of the associated problems are solved.  But let's start with how the internal device of the server is presented to users-developers outside. <br><br><h1>  Fast start </h1><br>  Let us show a quick example of how to use Centrifuge to prototype simple real-time-ideas.  In a real production case, everything is a bit more complicated and, for example, will require the generation of connection parameters on the backend side of your application, but now we will disable all sorts of checks to do without the backend.  This will allow us to get a working version as soon as possible and to understand the main purpose of the Centrifuge. <br><br>  The task will be simple: the user enters the page in the browser and sees the picture.  With the help of the <a href="https://github.com/centrifugal/centrifuge-js">Centrifuge JavaScript client,</a> we will subscribe to the screen-updates channel in the Centrifuge and wait for incoming messages from it.  Next, we will send (publish) messages like this from the Centrifuge administrative web interface: <br><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://habrastorage.org/files/6b3/ae5/fcb/6b3ae5fcbeaf49c480baca60f88e7d40.jpg"</span></span> }</code> </pre> <br>  where image is the url of the image. <br><br>  When this message is received from all users, the picture will automatically change to the one we sent in the message. <br><br>  Download the latest release of Centrifuge for your operating system <a href="https://github.com/centrifugal/centrifugo/releases">from here</a> .  At the time of this writing, this is version 1.4.2.  Unpack the zip-archive and run the binary executable file: <br><br><pre> <code class="bash hljs">CENTRIFUGO_SECRET=secret ./centrifugo --insecure --insecure_admin --web</code> </pre><br>  Open <a href="http://localhost:8000/">http: // localhost: 8000</a> and see the web interface, from which we will send messages to clients using the form in the Actions tab. <br><br>  By the way, you can install Centrifugo in another way.  For example, use the <a href="https://fzambia.gitbooks.io/centrifugal/content/deploy/docker.html">Docker image</a> or download the <a href="https://packagecloud.io/FZambia/centrifugo">RPM / DEB package from packagecloud.io</a> . <br><br>  Create a `index.html` file with the contents in the new directory: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//cdn.jsdelivr.net/sockjs/1.0/sockjs.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//rawgit.com/centrifugal/centrifuge-js/1.3.4/centrifuge.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"img"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//habrastorage.org/files/d8e/0f5/46c/d8e0f546cb374398a636f8b54f9fca54.jpg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500px"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> img = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"img"</span></span></span><span class="javascript">); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> centrifuge = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> Centrifuge({ </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">url</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'http://localhost:8000/connection'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">insecure</span></span></span><span class="javascript">: </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">true</span></span></span><span class="javascript"> }); centrifuge.subscribe(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'screen-updates'</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">message</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ img.src = message.data.image; }); centrifuge.connect(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  After that, we can start an HTTP server that provides this HTML page: <br><br><pre> <code class="bash hljs">python -m SimpleHTTPServer 3000</code> </pre><br>  and open several tabs with the address <a href="http://localhost:3000/">http: // localhost: 3000</a> in the browser. <br><br>  In the Actions tab of the Centrifuge administrative web interface, we can write the name of the screen-updates channel in the channel, JSON field of the above type in the data field and publish it to the channel.  For example: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://habrastorage.org/files/6b3/ae5/fcb/6b3ae5fcbeaf49c480baca60f88e7d40.jpg"</span></span> }</code> </pre><br><br><img src="https://habrastorage.org/files/949/76e/385/94976e385aaf4db7bcc69633c462f7f8.png"><br><br>  On all open pages, the picture will change to the one you just sent.  Here is a <a href="https://codepen.io/FZambia/pen/WwERge">ready codepen example</a> using the Centrifugo demoinstants on Heroku: <br><br><img src="https://habrastorage.org/files/09c/2f0/e29/09c2f0e296204b3c8b122971ec2baa7b.png"><br><br>  This is a slightly prettier version of the example above.  You can go through the <a href="https://centrifugo.herokuapp.com/">demoinstants on Heroku</a> (password for entry: demo) and from the Actions tab send messages to the screen-updates channel, watching the result in the codepen windows.  In this case, you do not have to install anything to get a general idea. <br><br>  It was a quick start, and the result is rather primitive.  But imagine what opportunities open up as soon as you transfer it to the realities of a live web application - they are limited only by imagination.  In a real project, you will not send new messages manually from the interface, but using the Centrifuge API and client libraries for this API.  Also, most likely, insecure flags and parameters that you may have observed above will not be used.  A full description of all the features you will find in the <a href="https://fzambia.gitbooks.io/centrifugal/content/">documentation</a> . <br><br>  As I have already said, in our Mail.Ru Group the centrifuge is used on the intranet (an internal social network for company employees) - for likes, comments, employment status of negotiation, voting results and more.  Now we have 700 users online at the same time and about 300 new messages are published per minute.  This, of course, very little.  CPU consumption - on average about 1%, memory - about 200 MB.  There are cases (for example, after corporate mailings) when the number of published messages reaches 2 thousand per minute and the fan-out (that is, the number of users sent to the connection) reaches 300 thousand messages per minute.  Again, nothing fantastic.  Just such a case can be seen on the chart below: <br><br><img src="https://habrastorage.org/files/9c4/111/d36/9c4111d36c5b40d8a34c19116327921d.png"><br><br>  Unfortunately, at the moment there are no properly made benchmarks. Centrifuges are not there, so you have to operate with figures from real projects - in our case, the Centrifugo load is insignificant. <br><br>  There are several interesting applications in the Mail.Ru Group Centrifuge, which I would like to talk about. <br><br>  First, this is a game for employees.  Players get together in the same room, they are divided into teams at the touch of a button.  Further, as soon as the teams are seated at the tables, the game itself begins.  Players enter the site from their mobile devices - smartphones, tablets, laptops - receive questions using push messages and answer them.  At the same time, the game statistics appears on the big screen (TV, image from the projector), and the presenter controls the game from his device: transfers it from round to round, sending players new questions and then the correct answers to them.  If you heard about The <a href="http://jackboxgames.com/">Jackbox Party Games</a> , then this is something similar. <br><br>  My colleague is currently working on the project <a href="https://drawr.ru/">https://drawr.ru</a> .  This is a cooperative real-time game in which people can have fun by drawing and guessing what is shown in the pictures of others.  The game in its internal architecture is a lot like the one I described in the previous paragraph - Django + Centrifugo under the hood.  The centrifuge is responsible for sending notifications about changes in the game state to users and for in-game chat.  You can try right now, but you need to find with whom: the minimum number of players is three. <br><br>  Further, in our big office Mail.Ru a lot of doors.  Doors open after applying a pass to the reader device.  This allowed us to do some interesting things.  For example, the so-called exit-poll - an employee enters a room and answers a question that instantly appears on the screen in front of him.  In such an unobtrusive manner, the staff of our personnel department can collect the most diverse statistics and opinions of employees on certain issues.  The interface on the screen is simply a browser tab, subscribed to a channel in the Centrifuge, through which data about aisles through the door arrive. <br><br>  Our administrators from technical support at the entrance of the employee, using approximately the same scheme, show on the big screen information about the person and task in Jira, with whom he looked to them: it saves a few seconds with further communication. <br><br>  One of the developers of the site from Alexa TOP 250 (if it‚Äôs very interesting which site it is, read <a href="https://gitter.im/centrifugal/centrifugo">Centrifugo chat on gitter.com</a> ) in a test mode launched the Centrifuge for 50 thousand users online.  At the same time, 6 thousand new messages per second are published (these are new, not fan-out messages).  For client balancing, two m4.xlarge instances with a centrifuge on Amazon were used.  This example proves that the overwhelming majority of Centrifuge productivity projects should suffice with head. <br><br><h1>  Server-side only push in 2016 </h1><br>  In the example above, we used push clients from the server side.  The centrifuge allows you to publish new messages directly from the client, bypassing the backend of the application, but still its main use is server-side only push: sending messages initiated by the server in one direction - from the server to the client. <br><br>  Such a unidirectional scheme is sufficient for solving real-time problems in most applications, perhaps, except for dynamic multiplayer games and the like, which require the lowest possible response time and closer integration of the backend and real-time kernel. <br><br>  Most modern applications are mostly read-only, new content is rarely created, so any backend should easily cope with new events generated by users of the application.  For example, if a user added a comment in a web application, then you simply send it with an HTTP POST request (normal or AJAX) ‚Äî process, validate, save to the database ‚Äî and then send it to everyone.  To do this, you do not need to organize communication between the user and the server through a two-way connection that web sockets provide.  <a href="https://www.meteor.com/">Meteor</a> - and <a href="http://derbyjs.com/">Derby-like</a> frameworks are beautiful in their own way - but they are not the only tools for the simple implementation of real-time applications. <br><br>  The significant advantage of Centrifuges: using it, you do not change the way new events are generated in your application.  This is especially critical if the application backend is written in a language or framework that does not support working with a large number of persistent connections (PHP and many frameworks on it, Django, etc.). <br><br>  Once again, I‚Äôll emphasize the main point I‚Äôm trying to voice: in most cases, we don‚Äôt need bidirectional interaction between the client and the server through a permanent connection.  All that is needed is a way to quickly deliver new content to users as soon as the application backend learns about its appearance. <br><br>  Recently, the Django framework received the <a href="https://www.djangoproject.com/weblog/2015/dec/11/django-awarded-moss-grant/">MOSS Grant</a> .  Judging by this news, soon we (Django users) are waiting for the adoption <a href="http://channels.readthedocs.org/en/latest/">of the Channels project</a> framework into the core.  This will turn Django into a set of workers who, through channels, will communicate with the so-called interface servers through a broker.  The server interface can serve client requests for a variety of protocols ‚Äî HTTP, Websocket, etc. The concept is very beautiful and interesting, and among the features that will become possible are bidirectional client and backend communication on Django via web sockets.  Special Websocket interface servers will be responsible for it.  However, there are problems with this, when events come in a different order to different Django workers, you will need to <a href="http://channels.readthedocs.org/en/latest/getting-started.html">synchronize</a> them using locks in the broker (one of the possible brokers is <a href="http://redis.io/">Redis</a> ).  It is not clear what the innovations will result in in practice, but the appearance of locks in a separate broker is at least a controversial decision.  Due to this, Django will occupy an additional niche in the market of frameworks and real-time decisions, but whether this is good given the above said, we will see. <br><br>  Django is not the only example.  I'm not a big connoisseur of what is happening in the world of Ruby on Rails, but judging by <a href="https://samsaffron.com/archive/2015/12/29/websockets-caution-required">this article</a> , ‚Äúrails‚Äù will also soon receive (already received?) Support for bidirectional communication with the user via web sockets, and some developers are alarmed . <br><br>  The funny thing is: as soon as the Internet has almost completely moved to browsers that support web sockets (after all, we waited for this, right?), There are doubts about how good the websockets are for the web in the beginning of HTTP / 2.  Each tab opened in the browser is a new permanent client connection to the server.  Why redundancy, if HTTP / 2 allows to multiplex all requests to the domain in different browser tabs through one connection?  Already now, when a client and server are connected via HTTP / 2, the HTTP / 1.1 specification restriction on the number of connections to one domain is lost.  You can open a large number of browser tabs, each of which uses an Eventsource or XHR-Streaming to deliver messages to the user, and not rest on a limit (usually five to six, depending on the browser). <br><br>  With all this, it should be noted that Websocket as a protocol is very good and, importantly, allows you to connect to the server from a non-browser environment: clients for web sockets are available for almost all programming languages.  The stated lack (use of separate connections when opening tabs) mainly concerns only websites, but there are other applications - desktop, mobile.  It‚Äôs a pity that the draft on multiplexing web sockets via an <a href="http2-01">HTTP / 2 connection</a> didn‚Äôt bring to mind: apparently there were good reasons, I don‚Äôt know them - maybe someone has a hunch? <br><br>  Unfortunately, now, at the beginning of 2016, we do not have the ideal transport for <a href="https://banksco.de/p/state-of-realtime-web-2016.html">real-time communication</a> .  Anyway, all existing have a number of advantages and disadvantages.  As with many things in programming, the choice of transport is trade-off.  We will wait for new features, especially given the specification of PUSH PROMISE frames in HTTP / 2 (here, for example, the working <a href="https://tools.ietf.org/html/draft-ietf-webpush-protocol-02">draft for delivering notifications</a> (online and offline) to browsers based on PUSH PROMISE, the implementation should appear in Firefox soon, and then in other browsers).  Perhaps in some future Centrifuge will support this draft to send offline push messages to users of sites. <br><br>  Anyway, Centrifuge allows you to forget about a headache with transports and deliver real-time messages to customers, even if your application‚Äôs backend is not suitable for this purpose (or not yet - Rails, Django from the examples above).  At the same time, neither the code nor the philosophy of a working project needs to be changed - you can continue to use your favorite framework and assign responsibility for maintaining permanent connections and sending real-time messages to Centrifugo.  Even if you are writing an application on Go or Node.js, you can focus on the core and core functionality of the application using Centrifuge for real-time messaging.  Later, if you wish, you can easily abandon it in favor of your own project-integrated solution (write the processing of persistent connections yourself, for example, to <a href="https://github.com/primus/primus">Primus</a> in the case of Node.js).  As a transport, as I mentioned above, you can use ‚Äúclean‚Äù web sockets or all available SockJS transports.  In the near future, the Centrifuge will learn to communicate with clients over HTTP / 2 - thanks to the implementation of HTTP / 2, which is built into the standard Go 1.6 library.  This will have a positive effect on connections that use SockJS HTTP transports (eventsource, xhr-streaming, etc.). <br><br>  Do not forget about the quick example of a real-time application that we implemented above: you can prototype a real-time application without a backend (and with a backend) - for this there is a ready JavaScript client and server as a binary file without dependencies.  In my slightly biased opinion, this is one of the most convenient and quickest solutions to start. <br><br>  An interesting model can be obtained by using Centrifuge in conjunction with <a href="https://www.rethinkdb.com/">RethinkDB</a> on the backend: by subscribing to changefeed documents, you can build applications that need to synchronize the data structure between the server and the backend ‚Äî a la <a href="https://www.firebase.com/">Firebase</a> . <br><br><h1>  Internal organization </h1><br>  Now about what's inside.  In previous articles, I wrote a lot about the capabilities of the Centrifuge, but not much about how it all works.  Much has changed with the evolution of the project, including the language (Python -&gt; Go).  Now used approaches and tools are quite stable.  Therefore, it seems the most time to talk about the internal structure of the server. <br><br><h3>  HTTP / Websocket server </h3><br>  In a simple approximation, Centrifugo is a Websocket / HTTP server.  On a separate port, a standard Go HTTP server rises with registered functions - request handlers.  Handlers can be divided into three categories: <br><br><ol><li>  Client connections (Websocket or SockJS). </li><li>  HTTP API (posting messages, unloading metrics, etc.). </li><li>  Administrative resources required including the operation of the web interface. </li></ol><br>  Client connections are not short stateless HTTP requests, but persistent connections.  In the case of Websocket connections and HTTP streaming transports (xhr-streaming, eventsource) that use SockJS when web sockets are unavailable, everything is quite clear.  After the connection is established, we do not close it until the client is online (in fact, this is not quite true, as in the case of streaming transports, sometimes you still have to drop the client connection so that the Garbage Collector can clean up the response body that has grown to a certain size ).  The blessing of Go allows you to work almost carelessly with a huge number of such connections.  There is a small problem with polling transports, for example xhr-polling (aka long-polling), because when sending a message, connections with clients are broken and reinstalled again.  It is necessary to store the client's session for some time, sufficient for reconnect.  This is the <a href="https://github.com/igm/sockjs-go/">server implementation of SockJS</a> .  And the client, in turn, is recommended to reconnect to the same server instance (this is assumed by the balancer - for example, a sticky session in <a href="http://nginx.org/ru/">Nginx</a> ). <br><br>  About HTTP API.  If you want to post a new message to the channel, send a well-formed POST request to the url `/ api /`.  I would like to note that every API request by default must be signed with a secret key that only the Centrifuge and your backend know.  In most cases, this additional protection can be disabled, since requests to the API will most likely be sent from a specific IP - so firewall rules in production are enough.  In this case, the request to the API is just a POST request with JSON containing the commands.  Approximately this type: <br><br><pre> <code class="javascript hljs">{ ‚Äúmethod‚Äù: ‚Äúpublish‚Äù, ‚Äúparams‚Äù: { ‚Äúchannel‚Äù: ‚Äúupdates‚Äù, ‚Äúdata‚Äù: { ‚Äútext‚Äù: ‚Äúhello world‚Äù } } }</code> </pre><br><br>  With regards to the administrative web interface, this is an endpoint that allows you to log in with a password, a handler that distributes static administrative web interface files and a websocket endpoint, through which the web interface receives real-time messages published to a particular channel (optional), and also executes commands (for example, publishes a message to the channel - what we saw in the example above). <br><br><h3>  Engine </h3><br>  Perhaps the most interesting under the hood Centrifuges are concentrated in the so-called Engine'ah. <br><br>  However, before proceeding with the description of the work of the built-in Engine, let's look at the features of the Centrifuge, which are somehow tied to the Engine: <br><br><ul><li>  the ability to run multiple Centrifuge instances on different machines to balance client connections between them; </li><li>  presence-information ‚Äî that is, information about which clients are currently in the channel; </li><li>  history information - the latest messages sent to the channel. </li></ul><br><br>  The first feature results in a problem: clients subscribed to the same channel can be connected to different instances, so when a message is posted to the channel, it must be delivered to both.  Much the same for presence and history: each Centrifuge instance must have access to full channel information in order to provide it to the client in the event of a request. <br><br>  Add to this the remark that the Centrifuge does not store anything in permanent storage.  In the case of presence information, this is not a problem: we store as much data as there are now users in the channels.               ‚Äî          (         ) ‚Äî  --    . <br><br>   ,   , Engine     Go-: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Engine <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { name() <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> run() error publish(chID ChannelID, msg []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, opts *publishOpts) &lt;-<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> error subscribe(chID ChannelID) error unsubscribe(chID ChannelID) error channels() ([]ChannelID, error) addPresence(chID ChannelID, uid ConnID, info ClientInfo) error removePresence(chID ChannelID, uid ConnID) error presence(chID ChannelID) (<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[ConnID]ClientInfo, error) history(chID ChannelID, opts historyOpts) ([]Message, error) }</code> </pre><br>       <a href=""></a> . <br><br>     ‚Äî      Go- .       ,       ,      .  ,     - .  ,          Go.    ,      ‚Äî   .    ,  ,    , ‚Äî   ,        Memory Engine  Redis Engine. <br><br><h3> Memory Engine </h3><br>    ,             -  .    Memory engine,   ,  ,    . <br><br>    Memory Engine'      . Presence  history    .        ‚Äî            ‚Äî      . <br><br>  presence- :   ‚Äî    ,   ‚Äî   . <br><br> ,    ‚Äî    .    ,     .  ,     Memory Engine'.         , ,         string,     ( string). <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> historyItem <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { messages []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> expireAt <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i historyItem)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i.expireAt &lt; time.Now().Unix() } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> memoryHistoryHub <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { sync.RWMutex history <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]historyItem queue priority.Queue nextCheck <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newMemoryHistoryHub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memoryHistoryHub</span></span></span></span> { hub := &amp;memoryHistoryHub{ history: <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]historyItem), queue: priority.MakeQueue(), nextCheck: <span class="hljs-number"><span class="hljs-number">0</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> hub.expire() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hub }</code> </pre><br>  queue ‚Äî  priority queue   <a href="https://golang.org/pkg/container/heap/"> Go</a> .       <a href=""></a> . <br><br>  ,        Push          Pop.        O(log(n)). <br><br> ,    priority queue   ‚Äî  ,       generics  Go. <br><br>    ,         : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h *memoryHistoryHub)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(channel </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, message </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, size, lifetime </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { h.Lock() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> h.Unlock() _, ok := h.history[channel] expireAt := time.Now().Unix() + <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(lifetime) heap.Push(&amp;h.queue, &amp;priority.Item{Value: channel, Priority: expireAt}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !ok { h.history[channel] = historyItem{ messages: []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{message}, expireAt: expireAt, } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { messages := h.history[channel].messages messages = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{message}, messages...) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(messages) &gt; size { messages = messages[<span class="hljs-number"><span class="hljs-number">0</span></span>:size] } h.history[channel] = historyItem{ messages: messages, expireAt: expireAt, } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> h.nextCheck == <span class="hljs-number"><span class="hljs-number">0</span></span> || h.nextCheck &gt; expireAt { h.nextCheck = expireAt } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>        ,     ,  size  lifetime, ‚Äî             ,    , . <br><br> ,        ,   : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h *memoryHistoryHub)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(channel </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { h.RLock() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> h.RUnlock() hItem, ok := h.history[channel] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !ok { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hItem.expired() { <span class="hljs-built_in"><span class="hljs-built_in">delete</span></span>(h.history, channel) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hItem.messages, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br> ,    ‚Äî  expire,             : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h *memoryHistoryHub)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextCheck <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { time.Sleep(time.Second) h.Lock() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> h.nextCheck == <span class="hljs-number"><span class="hljs-number">0</span></span> || h.nextCheck &gt; time.Now().Unix() { h.Unlock() <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } nextCheck = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> h.queue.Len() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { item := heap.Pop(&amp;h.queue).(*priority.Item) expireAt := item.Priority <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> expireAt &gt; time.Now().Unix() { heap.Push(&amp;h.queue, item) nextCheck = expireAt <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } channel := item.Value hItem, ok := h.history[channel] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !ok { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hItem.expireAt &lt;= expireAt { <span class="hljs-built_in"><span class="hljs-built_in">delete</span></span>(h.history, channel) } } h.nextCheck = nextCheck h.Unlock() } }</code> </pre><br>  ,          nextCheck ‚Äî     ,        . <br><br>        ,      ,               .     ,        ,         . <br><br><h3> Redis Engine </h3><br>      ‚Äî  Engine ,  Redis          presence  history . <br><br>  ,   ,   : <br><br><pre> <code class="bash hljs">centrifugo --config=config.json --engine=redis</code> </pre><br><br>  Redis Engine'         Memory Engine': <br><br><ul><li>    ()     (  PUB/SUB  ),      ; </li><li>          ; </li><li>        ( RPUSH ) ‚Äî     ,   ,          . </li></ul><br>        ,   SUBSCRIBE,     ,     .      ‚Äî      (UNSUBSCRIBE).  ,          ,   ,   . <br><br> O presence.             ‚Äî     expiration-.         EXPIRE.     presence-   ‚Äî  HASH-  ,   ¬´¬ª  HASH ,    . Redis Engine  ,       ‚Äî HASH'a  SET'a.    ,  / presence-,    . Centrifugo  <a href="https://github.com/garyburd/redigo">Redigo</a>   Redis-,       API  . <br><br>      presence-   : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *RedisEngine)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPresence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ch </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, uid </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, info []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { conn := e.pool.Get() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> conn.Close() expire := <span class="hljs-number"><span class="hljs-number">60</span></span> expireAt := time.Now().Unix() + <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(expire) hashKey := ‚Äúhash.‚Äù + channel setKey := ‚Äúset.‚Äù + channel conn.Send(<span class="hljs-string"><span class="hljs-string">"MULTI"</span></span>) conn.Send(<span class="hljs-string"><span class="hljs-string">"ZADD"</span></span>, setKey, expireAt, uid) conn.Send(<span class="hljs-string"><span class="hljs-string">"HSET"</span></span>, hashKey, uid, info) conn.Send(<span class="hljs-string"><span class="hljs-string">"EXPIRE"</span></span>, setKey, expire) conn.Send(<span class="hljs-string"><span class="hljs-string">"EXPIRE"</span></span>, hashKey, expire) _, err = conn.Do(<span class="hljs-string"><span class="hljs-string">"EXEC"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err }</code> </pre><br>       (  ) ‚Äî  a addPresence,  ,      ,   25  ( )  ,     .    channel ‚Äî   , uid ‚Äî  ID , info ‚Äî     .      HASH-  SET-. HASH  ,   ,  SET     HASH'a.      60               HASH',       . <br><br>  presence-,     ,   : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *RedisEngine)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removePresence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(channel </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, uid </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { conn := e.pool.Get() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> conn.Close() conn.Send(<span class="hljs-string"><span class="hljs-string">"MULTI"</span></span>) conn.Send(<span class="hljs-string"><span class="hljs-string">"HDEL"</span></span>, ‚Äúhash.‚Äù + channel, uid) conn.Send(<span class="hljs-string"><span class="hljs-string">"ZREM"</span></span>, ‚Äùset.‚Äù + channel , uid) _, err := conn.Do(<span class="hljs-string"><span class="hljs-string">"EXEC"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err }</code> </pre><br> ,  -  presence- ‚Äî   presence,         (     ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *RedisEngine)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(channel </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">map</span></span></span></span><span class="hljs-function"><span class="hljs-params">[</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">][]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { conn := e.pool.Get() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> conn.Close() now := time.Now().Unix() hashKey := ‚Äúhash.‚Äù + channel setKey := ‚Äúset.‚Äù + channel reply, _ := conn.Do(<span class="hljs-string"><span class="hljs-string">"ZRANGEBYSCORE"</span></span>, setKey, <span class="hljs-number"><span class="hljs-number">0</span></span>, now) expiredKeys, _ := redis.Strings(reply, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(expiredKeys) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { conn.Send(<span class="hljs-string"><span class="hljs-string">"ZREMRANGEBYSCORE"</span></span>, setKey, <span class="hljs-number"><span class="hljs-number">0</span></span>, now) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, key := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> expiredKeys { conn.Send(<span class="hljs-string"><span class="hljs-string">"HDEL"</span></span>, hashKey, key) } } reply, _ = conn.Do(<span class="hljs-string"><span class="hljs-string">"HGETALL"</span></span>, hashKey) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> replyToPresenceInfo(reply) }</code> </pre><br>   Centrifugo  <a href="">   Lua-</a> ,     EVALSHA   .      .     presence-      round-trip     .     Lua    ,  . <br><br>      Redis engine'    ‚Äî      LPUSH, LTRIM, LRANGE  EXPIRE. <br><br> ,    Redis Engine'a ‚Äî    ()  ,           .  RPUSH      ,     BLPOP,     .   ,    :  ,   ,  ,      .   ,        . <br><br>         ,     ,       ,       . ,          .        ,       ,     ,    ,  - : <br><br><pre> <code class="hljs lisp">crc16(<span class="hljs-name"><span class="hljs-name">CHANNEL_NAME</span></span>) mod N</code> </pre><br>  N ‚Äî    ,   . <br><br> ,           HTTP API,    Redis engine.      . <br><br> Redis ‚Äî    .              ,          ,    -,     . .       (. <a href="http://engineering.bloomreach.com/the-evolution-of-fault-tolerant-redis-cluster/"></a> ).         ‚Äî     Redis Sentinel.      ‚Äî <a href="http://www.haproxy.org/">Haproxy</a> , <a href="https://github.com/twitter/twemproxy">twemproxy</a> , <a href="https://github.com/CodisLabs/codis">codis</a> .  PaaS-  High-Availability (HA) Redis  . <br><br>   1.4.2     Sentinel ‚Äî       Sentinel     Sentinel-.  ,      twemproxy  codis,      PUBSUB-. C haproxy   ‚Äî     <a href="http://blog.haproxy.com/2014/01/02/haproxy-advanced-redis-health-check/"> </a> . <br><br> ,   ,  Redis Engine, ‚Äî   .         ( ,     ,  ,   ,     )        Redis,     PUBLISH        . ,      ,  Redis pipeline, . .       - (RTT)  Redis', ‚Äî     latency     . ,      ,      ,                (   )     .   ,     <a href="http://mechanical-sympathy.blogspot.ru/2011/10/smart-batching.html">   </a> ,    latency   .       .        .             Redis.          .    Redis'       .  ,    ,    ,   : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillPublishBatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ch </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pubRequest, prs *[]*pubRequest)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(*prs) &lt; RedisPublishBatchLimit { <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> pr := &lt;-ch: *prs = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(*prs, pr) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *RedisEngine)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runPublishPipeline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prs []*pubRequest <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { pr := &lt;-e.pubCh prs = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(prs, pr) fillPublishBatch(e.pubCh, &amp;prs) conn := e.pool.Get() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> prs { conn.Send(<span class="hljs-string"><span class="hljs-string">"PUBLISH"</span></span>, prs[i].channel, prs[i].message) } _ := conn.Flush() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> prs { _, _ := conn.Receive() } conn.Close() prs = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } }</code> </pre><br>               Lua-    <a href=""> </a> . <br><br><h3>   </h3><br>        ‚Äî       PUB/SUB-,   Go     .        ‚Äî  ,             (   ),          .     ,            -  . <a href=""> </a>      <a href="http://blog.dubbelboer.com/2015/04/25/go-faster-queue.html"> </a> . <br><br>         ,        . ,       Go-  , , -,           (       ,    ),  -,      .   ,      ,  , . .   ,        : <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> client.messageCh &lt;- message: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ErrChannelFull }</code> </pre><br>       .         ,     (          ). <br><br> ,   Centrifugo,        (ID ,     JSON-),  HMAC SHA-256 .           .       ,     ‚Äî      <a href="https://fzambia.gitbooks.io/centrifugal/content/clients/javascript.html">  Javascript-</a> . <br><br><h3>     </h3><br>      ‚Äî     -,    .     ‚Äî        , ,    public:news,  Centrifugo    public      .    ,      .       ,      :   ,    .     ,        .     : <br><br><ul><li> <b>publish</b> ‚Äî       ,    .     ,  ,         ,    .       ‚Äî     server-side push; </li><li> <b>watch</b> ‚Äî        websocket-    -    (          ,      -).            ‚Äî -       ,          ; </li><li> <b>anonymous</b> ‚Äî        ID  (,            --    ).   ,  ID  ‚Äî   (‚Äú‚Äù),   ; </li><li> <b>presence</b> ‚Äî  presence-  ; </li><li> <b>join_leave</b> ‚Äî     ,  -   (join)     (leave)  ; </li><li> <b>history_size</b> ‚Äî     (  ; ,  ‚Äî     ,        ); </li><li> <b>history_lifeime</b> ‚Äî     ,      ; </li><li> <b>recover</b> ‚Äî    , , ,      (  ,     ).     <a href="https://www.w3.org/TR/2011/WD-eventsource-20110310/">Last-Event-ID   Eventsource</a> ; </li><li> <b>history_drop_inactive</b> ‚Äî   ,    ,       .  ,        ,          . </li></ul><br><br>     ,        .        presence-,        .         PUB/SUB. <br><br>  ,         ,     real-time      ,       (,  ). <br><br><h1>    </h1><br>   ,   ,       ,       ,     (best effort).        (at most once).   --   ‚Äî        . <br><br>  ,         .        PUB/SUB-  ,   ,    ,    . <br><br> Centrifugo       .      API-                ,           .   ,        API             . <br><br><h1>  Conclusion </h1><br>    ,      ,       Centrifugo ‚Äî        Mail.Ru Group,        . ,         ‚Äî -,          .      ,        .    ‚Äî   ( MIT). ,       pusher.com    20     (  fan-out ),  10 .     499$   (  2016-, <a href="https://pusher.com/pricing">https://pusher.com/pricing</a> ).        ,  10 .    500 M   . <br><br> , c ,      .     Centrifugo      . ,          .     ,     . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d98/31f/8e1/d9831f8e1f7a4a95b9a7404b11b4e495.jpg"></div><br><br> , -       : ,         iOS  Android.        (, <a href="https://github.com/SammyVimes/ACentrifugo"> Android</a> ),     .     <a href="https://github.com/centrifugal/centrifuge-go">  Go</a> .  ,   <a href="https://github.com/golang/mobile">gomobile</a>    ‚Äî ,      Go       . <br><br>  References: <br><br><ul><li> <a href="https://github.com/centrifugal/centrifugo">Centrifugo  Github</a> </li><li>  <a href="https://fzambia.gitbooks.io/centrifugal/content/">Documentation</a> </li><li> <a href="https://centrifugo.herokuapp.com/">  -  Heroku</a> (   ‚Äî demo) </li><li> <a href="https://opensource.mail.ru/Home">OpenSource Mail.Ru</a> ‚Äî       Mail.Ru Group </li></ul><br> PS     <a href="https://github.com/banks">Paul Banks</a> ,        .              . </div><p>Source: <a href="https://habr.com/ru/post/280346/">https://habr.com/ru/post/280346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280334/index.html">As one programmer Jocly shoe</a></li>
<li><a href="../280336/index.html">IBM has released a new generation of storage - Storwize v5000 Gen2</a></li>
<li><a href="../280338/index.html">Juniper Networks Routing, Switching and Security Solutions and Updates</a></li>
<li><a href="../280340/index.html">Investigating the performance issues of calling ClassLoader.getResourceAsStream</a></li>
<li><a href="../280344/index.html">Rules for working with Tasks API. Part 2</a></li>
<li><a href="../280348/index.html">Police against the mafia or entertaining statistics online stage NeoQUEST-2016</a></li>
<li><a href="../280354/index.html">The book "Computer Networks. Principles, technologies, protocols "</a></li>
<li><a href="../280356/index.html">aBeing One: at the center of the Internet of Things</a></li>
<li><a href="../280358/index.html">Monolithic repositories in Git</a></li>
<li><a href="../280360/index.html">Report from Moscow Python Meetup March 18</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>