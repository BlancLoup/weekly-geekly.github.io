<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Just add meat or embedding on mode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="the very essence 

 With the advent of affordable ARM and MIPS solutions, on which Linux or WinCE can be installed, amateur embedding has reached a qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Just add meat or embedding on mode</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/eb8/f2e/997/eb8f2e997659469fa1b22595e854d6a8.jpg"><br>  <i>the very essence</i> <br><br>  With the advent of affordable ARM and MIPS solutions, on which Linux or WinCE can be installed, amateur embedding has reached a qualitatively new level (in general, it has been there for a long time, but not on such a wide scale as it is today).  The emergence of such massive software products as Android, very much popularized processors with non-x86 architecture, opened up new opportunities for the general public in the form of lowering the price of high-speed hardware and provided access to information that was previously distributed only after the signing of the NDA. <br>  And everyone seems to be good .nix hardware: routers, Raspberry Pi and various devices a la MK802.  For many, they are driving production and domestic processes, robots and coffee makers.  However, the low reaction rate to external influence somewhat limits the use of such systems in embedding.  Such functions, which are completely absent in such devices (meaning consumer goods, not specialized solutions <a href="http://habrahabr.ru/post/176943/">once</a> , <a href="http://habrahabr.ru/company/virt2real/">twice</a> ), can be PWM with emergency shutdown, high-speed PID controller, quadrature encoder processing and many, many others.  All these things require a certain degree of realtime. <br><br>  A brief description of some ways to add muscle, a little theory, personal reflection and of course, the solution from me under the cut. <br><a name="habracut"></a><br><h4>  <b>Part one.</b>  <b>Theory and Reflections</b> </h4><br>  Let's look at the existing iron ways of solving the problem of ‚Äúsmart but weak‚Äù.  There are several variants of such iron: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  <b>1. 74xx, 40xx and other multi-legged</b> </h6><br>  Logics.  Just logic. <br>  A time-tested option for expanding logical functions. <br>  Simple logic will allow you to collect several signals into one, disassemble one into several and form a digestible signal from the garbage.  And do it all very quickly. <br>  The disadvantage of this method is the large size of the scheme, which tend to grow to incredible sizes with increasing complexity. <br><br>  Point two follows from the first, but I set it apart. <br>  This is also logic, but logic is programmable. <br><br><h6>  <b>2. CPLD and FPGA</b> </h6><br>  The disadvantages of this method of iron expansion functions virtually none.  It is widely used in practice, but a rather high entry threshold, a rather high price for pieces of iron and some (and in the case of FPGA even quite specific) monstrosity, do not allow to use this approach where it is not necessary to count flops and steer by tens and hundreds of logical levels . <br><br>  Considering that our smart hardware is trained to communicate normally via RS-232 or SPI, and much less willingly through GPIO, we do not have a comforting conclusion: in order for our stupid fast logic to communicate with a smart slow host, you need a miracle device . <br><br><img src="https://habrastorage.org/storage2/c32/7f4/938/c327f493894638b64822737a8ff0cf00.png"><br>  <i>miracle device in the habitat</i> <br><br>  The miracle device must be able to accept a command from the host that is understandable to the host and issue it in a form that is understandable for logic, as well as receive data in a form that is convenient for logic, and send it to the host in a convenient form for it. <br>  The technology is somewhat confused, but it describes the process of communicating stupid iron with smart intelligently. <br>  In the role of a miracle device, it is customary to use a microcontroller (in the case of FPGA, you can often do without it). <br><br><h6>  <b>3. Microcontroller</b> </h6><br>  Of course the microcontroller!  This resource has already seen successful precedents of crossing the router as the ‚Äúsmartest‚Äù and microcontroller as the exoskeleton.  The trend of crossing an Android with an Arduino or STM32 has also become very noticeable in recent weeks.  Actually, this trend prompted the writing of the article. <br><br>  With the arrival of the MK in this scheme, the use of logic as a labor force becomes unclear, but a close examination of the electrical processes taking place in the system with buttons, relays, power converters and other control and actuation devices does not make it possible to completely abandon logic in some cases. <br>  One of such cases may be an automaton with a certain number of parallel inputs.  Suppose that the desired state of the inputs is deterministic and looks not just like ‚Äúall to zero‚Äù, but has some sort of complex form.  In this case there is nothing left for the microcontroller, except for how to monitor this most certain number of inputs in the operating cycle and ... do nothing else.  And even in this particular case, the microcontroller does not provide comparable performance, because each individual state change of the port will be approached separately.  He will need to first process the interrupt, read the contents of the port (or several), compare the state with the desired one and make his resume entry in the port.  Even single-ended devices will spend a lot of time on this process.  A simple logic scheme will solve this problem in the forehead, without any analysis.  She will always work quickly and clearly. <br><br><h4>  <b>Part two.</b>  Or how I came to such a life </h4><br>  Working at the production site as a ‚Äúproduction jammer solver‚Äù, quite often I had to deal with the need to solder, program and flash something.  Whether it was the control of the valve of the water set in the reserve tank, or the automatic switch of the heating pumps according to a given program, these were autonomous devices built on the MC.  And in those prehistoric times (5‚Äì6 years ago) there were almost no available automation possibilities besides an industrial PLC and an improvised device on the MC. <br>  Agree, because the program that serves the pump (download if the water level is lower - do not download if higher) is not worthy of a whole PLC for 100+ dollars.  Anticipating comments from core circuit engineers, I hasten to declare that the MC is also a candidate for this program redundant, but it has indisputable advantages over the analog circuit - time and thresholds programmed in human numbers (instead of applying the magic of mathematics to capacitors and resistors). <br>  And since, to solve the problem, a bare MK was chosen, apart from the obvious savings, I also get an obvious smut in the form of soldering.  The balance of costs and problems was decisive in choosing a solution.  Particularly critical processes and work in bad electromagnetic conditions, as it should, were trusted by the PLC without any curtsy towards the moder. <br><br>  The emergence of the notorious routers for $ 20, allowed a new look at the automation of non-critical processes.  The experience was twofold.  On the one hand, for a penny, I got a system that speaks to me in almost human language.  On the other hand, the device is fundamentally incapable of working with discrete signals at an acceptable level of speed.  This imposed its limitations in the application of the new technology.  Further popularization of arduin-like and boards like STM32 Discovery, predetermined a bunch of Linux devices with a low-level exoskeleton in the form of 8, 16 or 32-bit MC (plus logic, OS and other bare metal). <br><br>  Simple devices were made according to the old-new scheme: <br>  1) Take the Arduino Nano <br>  2) we tie with infrastructure <br>  3) ??? <br>  4) PROFIT! <br><br>  As before, all this was good only for office use and in the presence of a huge amount of empty space. As for small-sized devices, everything was bad here.  And if a simple device that did not need a firmware update could be done on a bare MK, then in a device for which I wasn‚Äôt particularly sure (and should be yesterday), it was dumb to install a bare MK.  First, you need a programmer to upgrade the firmware.  Secondly ... however, the first item was enough for me.  I don‚Äôt like programmers in any way.  For me, the best programmer is a USB cable. <br>  Constant discontent with these nuances has generated a burning desire to unify, unify, unify ... <br><br><h4>  <b>Part Three</b>  Three weeks ago </h4><br>  Three weeks ago, I put the next project into production (my main activity is the mass production of electronics), and the next one only appeared after about two weeks.  Two weeks of browsing the Internet?  Hmm ... tempting ... but something knocked in my head, and the word "unification" came to mind.  And with him the old dissatisfaction with the Embedder life.  On such a depressive note, I set myself the task: to create at least something to get a positive for the new project, to meet the ChSV and improve the quality of life of earthlings in two weeks. <br><br>  To implement such ambitious plans, it was necessary to not less ambitious iron.  And it was found among the products widely known in narrow circles of the company Microchip.  This is a relatively new MK PIC16F1509.  Here, I have to make a theoretical digression and tell about the nature of this irresistible force, which made modern man not use 32bit MK. <br><br>  So, the periphery. <br>  In addition to the standard peripherals (USART | SPI | I2C, 4xPWM, 10bit ADC, 5 bit DAC, 3 Timers, a crystal temperature sensor, and of course GPIO), there were some interesting innovations among the entry level MCs.  These innovations, unconditionally, tipped the scales from the fashionable 32bit STM to the non-fashionable 8bit Microchip. <br><br><h5>  CLC (Configurable Logic Cell) </h5><br>  Programmable logic on the crystal MK. <br><br>  Each of the <b>four</b> modules has the form: <br><img src="https://habrastorage.org/storage2/122/32a/e45/12232ae45ae5658903693f6e85440d0a.png"><br><br>  On the left there are four inputs to which you can connect the physical outputs of the MK, interrupts from timers, comparators, PWM, a generator, and in general much of what is inside and outside the MK.  The source set for one module includes 16 signals, but there are differences between the sets for each of the four modules.  In particular, different physical findings MK.  Next on the diagram is the switch.  Signals can be connected both directly and with inversion.  The outputs of the elements going after the switch OR are also controlled (direct / inverse).  At the very end on the right, there is the output of the module, which can be inverted, output to the physical output of the MC, or input to the CLC.  The output generates an interrupt on the front or on the decline (as configured). <br><br>  The red box indicates a variable logic function, which, in addition to the one already represented by AND-OR, has 7 more options: <br><img src="https://habrastorage.org/storage2/06f/888/38b/06f88838be42ad538de40f7fe2b45159.png"><br><img src="https://habrastorage.org/storage2/1e6/e7a/a9d/1e6e7aa9d26e6521e4e2c36d4a6a8f69.png"><img src="https://habrastorage.org/storage2/a96/ed0/e03/a96ed0e039acafac4820d8765aadbcd2.png"><br><img src="https://habrastorage.org/storage2/7cb/6a2/0ec/7cb6a20ec58b9d1b50e1f2041c193f2b.png"><img src="https://habrastorage.org/storage2/aaa/30d/b84/aaa30db84cef3c17eb36a31a6feeb1f0.png"><br><img src="https://habrastorage.org/storage2/224/ac3/382/224ac3382dcf1f85bdf29bbe5fd0e6e0.png"><img src="https://habrastorage.org/storage2/5ca/a15/45e/5caa1545e80dce2fbf1c2cec62f7a966.png"><br><br>  Unfortunately, the purpose of this article is not an educational program on digital circuitry, so there‚Äôs nothing to comment on - the illustrations speak for themselves.  I will only note that all this farm is configured directly in the code, by banal assignment of values ‚Äã‚Äãto registers as the most common periphery like a timer or GPIO.  To facilitate the configuration of this not the easiest figovin, there is a GUI: <br><br><img src="https://habrastorage.org/storage2/c92/422/844/c9242284454890227ea928adc702f350.png"><br><br>  With a GUI, everything becomes extremely simple.  In the upper right corner you can see the values ‚Äã‚Äãof the registers, but you can simply generate a ready assembler or C code.  I promise to return to this curious periphery and examples of use next time.  And for those interested, I recommend to visit <a href="http://www.microchip.com/wwwproducts/Devices.aspx%3FdDocName%3Den553474">this page</a> . <br><br><h5>  <b>NCO</b> (Numerically Controlled Oscillator) </h5><br>  In fact, it is a frequency synthesizer up to 500 kHz (when clocked from an internal 16 MHz oscillator) with a tuning step from 0.03 Hz (when clocked from an internal 31 kHz generator) to 15 Hz (clock 16 MHz) <br>  Able to generate a meander and PWM. <br><br>  One of the options for the use of NCO and CLC ( <a href="http://www.microchip.com/stellent/idcplg%3FIdcService%3DSS_GET_PAGE%26nodeId%3D1824%26appnote%3Den560120">appnout</a> ) gives 16bit PWM in the range of the fill factor from 0% to 100% at a frequency of PWM 500kHz. <br><br><h5>  <b>CWG</b> (Complementary Waveform Generator) </h5><br>  Programmable half bridge driver. <br>  There are several signal sources to choose from (CLC1, NCO, PWM and Comparators). <br>  This is a very useful thing, and in many cases it can save the developer from the fire, smoke and bitterness of loss.  With the warning of these troubles, the hardware control of the dead time is intended to fight. <br><img src="https://habrastorage.org/storage2/539/b73/92c/539b7392cd153fd8fcd0b700d6cf4180.png"><br><br>  Each of the transistors of the pair, opens strictly when the second is probably already closed.  This is done to eliminate through-current, leading to beautiful, but sometimes expensive special effects.  The time given to the previous transistor to close (deadtime) is regulated separately for the leading and trailing edges.  Also, the forced stop signals, which are here four, are designed to fight with special effects: a special output of GPIO, CLC2 and both comparators.  Considering that we can send ‚Äúwhat else‚Äù to the CLC2 input, we get a rather extensive list of possibilities for a <b>speedy</b> emergency stop of the driver without any involvement of the kernel.  From timeouts to analog and logic levels. <br><br>  On this note, perhaps, it is time to tie with the theory and go directly to the practice. <br><br><h4>  Part Four  Development and production </h4><br>  Having decided on MK, I begin to think over the rest of the construct.  I wanted the minimum possible footprint.  After losing several options in my head, I settled on a solution that covers the area of ‚Äã‚Äãthe chip in the DIP 20 package (!).  Further, already starting from dimensional requirements, I chose the element base.  The well-known chip CP2102 was used as a USB-TTL converter (QFN case and quartz is not needed), the USB connector was chosen vertical, and the microcontroller in the QFN case.  All this stuff was immediately purchased on the maser. <br><br>  With the board, too, did not particularly stand on ceremony.  She, in view of her extreme simplicity, was divorced in about an hour.  The power outputs are pointedly placed in the same place where they are located at the 74xx logic chips.  Next, I ordered the manufacture of several pieces at the factory and began to wait.  While waiting, the work on the module was carried out exclusively mental ... dreamy, I would say. <br><br>  By the time all the iron was received, the initial two weeks were almost at the end.  I ventured to overwhelm my own terms and get a large portion of the depression that is so harmful to a 30-year-old male body. <br>  As a matter of urgency, as a bootloader, without which no microcontroller device can do without, the selected option was chosen - <a href="http://mrmackey.no-ip.org/elektronik/ds30loader/">ds30 Loader</a> .  In its free version, it only allows you to load the compiled hex into the MK via UART and has a convenient GUI (well, there is a console utility for connoisseurs). <br><br>  Result on the photo: <br><img src="https://habrastorage.org/storage2/0ee/4f0/0a9/0ee4f00a9dd16726546ff857c2fcd73b.png"><br>  <i>in profile next to DIP20 (ATtiny2313)</i> <br><br><img src="https://habrastorage.org/storage2/5aa/317/383/5aa317383caa8a290e961620e0d8d965.png"><br>  <i>view from above</i> <br><br><img src="https://habrastorage.org/storage2/d0f/706/428/d0f706428e681cae72af8c3abfedcf5d.png"><br>  <i>perspective ...</i> <br><br>  MK works from the built-in 16 MHz generator.  Quartz, which is visible in the photo, for software RTC, which is implemented on Timer1.  18 of the 20 MK pins are directly output to the connector (two are occupied by quartz), including the RX and TX for direct RS-232 TTL connection.  If you use only this very RS-232 TTL, then the board takes on a degenerate appearance <s>and loses half the cost</s> : <br><img src="https://habrastorage.org/storage2/025/3e1/550/0253e15502f509bfa40b107523f80e5b.png"><br>  <i>so looks bad laundered fee</i> <br><br><h4>  <b>Instead of conclusion</b> </h4><br>  It turned out pretty nice trinket, which, however, can greatly facilitate communication with the cruel outside world for Linux-powered devices.  Since the competition with Arduino in this form factor is huge, I focused on the size and unique periphery. <br>  At the moment, in the firmware, the inclusion and configuration of parameters of several peripheral modules using RS-232 commands is implemented.  These are PWM, DAC, GPIO and partly CLC.  You can also find out what time it is and read the ADC (both external inputs and the crystal temperature sensor).  That is, it already copes with some functions of a fast exoskeleton for a slow OS. <br><br>  But even if absolutely all the periphery works under the RS-232 tune (there‚Äôs no need for a special mind), this will not be the limit.  It is already clear that this functionality will take far from all the space in the MK memory, and I think the most suitable way to dispose of the remaining several kilobytes will be the limited interpreter of the SFC graphic language for the simplest automation within 30-50 steps, as well as software modules, such as PID, expansion of the number of I / Os through <a href="http://www.microchip.com/wwwproducts/Devices.aspx%3FdDocName%3Den021393">I2C expanders</a> , which will enable the possibility of unified connecting of displays and keyboards. <br><br>  The main sources of inspiration were Habrahabr, some Chinese website with androidobalaykami for 50 bucks and the site <a href="http://www.microchip.com/">www.microchip.com</a> <br><br>  Peace for everyone. </div><p>Source: <a href="https://habr.com/ru/post/177803/">https://habr.com/ru/post/177803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177793/index.html">Capture video from the camera and transmit it over the network</a></li>
<li><a href="../177795/index.html">Convenient library for working with media tags</a></li>
<li><a href="../177797/index.html">Organization of storage of intermediate tables for the CART algorithm</a></li>
<li><a href="../177799/index.html">I want to write tests</a></li>
<li><a href="../177801/index.html">Yandex.Maps-Time.Lapse</a></li>
<li><a href="../177805/index.html">Creating a graphic captcha with a choice of extra</a></li>
<li><a href="../177807/index.html">Labyrus: 3D maze</a></li>
<li><a href="../177811/index.html">MegaFon Login (SP-A1): well, very budget Android</a></li>
<li><a href="../177813/index.html">Google joins FIDO Alliance to find a reliable alternative to user password authentication.</a></li>
<li><a href="../177817/index.html">Refactoring with a tambourine, or as we Hulk pacified</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>