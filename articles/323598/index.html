<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Digitizing sound on STM32 (ADC + DMA) and encoding to Speex for transmission</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of my yesterday's article on Geektimes, I want to tell more about the implementation of digitizing and encoding sound on the STM32 mic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Digitizing sound on STM32 (ADC + DMA) and encoding to Speex for transmission</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/13f/8da/140/13f8da14008545deb4f517a110e83202.jpg" alt="image" align="left" width="320">  In continuation of my yesterday's article on Geektimes, I want to tell more about the implementation of digitizing and encoding sound on the STM32 microcontroller. <br><br>  The article will show how to set up a project in STM32CubeMX, collect data from the ADC in two circular buffers using DMA, connect the Speex library and encode the data.  Perhaps a lot of material will seem very obvious, but I hope at least someone will find it useful. <br><br>  I ask under the cat. <br><a name="habracut"></a><br>  <b>What is Speex?</b> <br><blockquote>  Speex is a free speech compression codec that can be used in voice-over-the-Internet (VoIP) applications.  Speex codec compressed data can be stored either in the Ogg audio data storage format or transmitted directly using UDP / RTP packets.  ¬© Wiki </blockquote><br>  I learned about Speex from <a href="https://geektimes.ru/post/257382/">Speech Recognition on STM32F4-Discovery</a> , I advise you to read, most of the code was taken from there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Element base</b> <br><br><img src="https://habrastorage.org/files/fcd/533/331/fcd533331c30411cb87be8e2f8741afe.jpg" alt="image" align="right" width="300">  In this article, I will use the cheapest and most common debugging board based on the STM32F103C8T6 microcontroller.  To her must be separately purchased programmer.  The approach will not change for any Discovery card.  I connected to the debugging microphone module with amplifier Max9812. <br><br>  The scheme can be seen in the article specified at the very beginning.  There, I turn on the ADC signal straight from the output of Max9812.  To do this, on the purchased module you need to short-circuit the capacitor on the leg OUT (I feel that as a fifth point I cannot do this, but I don‚Äôt know how to do that).  The input signal is obtained from the constant component of ~ 1.6V.  We shoot it and in the program we bring it to the sign type for encoding. <br><br>  <b>Setting up a project in STM32CubeMX</b> <br><br>  Let's create a new project with the STM32F103C8T6 microcontroller.  First of all, we indicate that we have an external quartz resonator connected.  We do not need clock quartz now, although it is also on the debug board.  Do not forget to enable the Serial Wire debugging interface.  Then we turn on the necessary input of the ADC, I have this IN8 (see the diagram in the previous article).  Well, a convenient timer by which the DMA will take data from the buffer. <br><br><img src="https://habrastorage.org/files/8b0/075/f04/8b0075f04aef4ff387600f91a4ba92a7.jpg" alt="image"><br><br>  After that, go to the <b>Clock Configuration</b> tab and configure the clocking scheme.  I did this: <br><br><img src="https://habrastorage.org/files/7be/b63/229/7beb6322902e4ee68f2e21386ba03093.jpg" alt="image"><br><br>  I set the frequency for the main periphery of the microcontroller to a maximum of 72 MHz.  Timers are also set to 72 MHz, remember this value.  You can do it differently, but then the timer will have to be recalculated in its own way. <br><br>  Go to the <b>Configuration</b> tab.  Here we need to configure the ADC, DMA and Timer. <br><br>  The ADC is set up using timer 3 trigger. Right there in the DMA tab, select the first DMA Peripheral To Memory channel (from peripheral to memory).  Priority is not important if there is nothing else in the program.  The mode is Circular, the data size is Half Word (half words, 2 bytes) and the memory address will be incremented. <br><br><img src="https://habrastorage.org/files/7f2/b1e/00d/7f2b1e00d6c242b999650f9f1c9b42b2.jpg" alt="image"><br><br>  Next, set the timer.  Speex supports data coding in a narrow frequency band (Narrowband, 8 kHz), wide (wideband, 16 kHz) and ultra wide (ultra-wide band, 32 kHz).  We will not load the controller, we take the minimum.  It turns out the controller must capture data from the ADC at a frequency of 8 kHz.  The timer comes to us 72 MHz.  We consider: <br><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>T</mi><mi>i</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>r</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>72000000</mn></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>s</mi><mi>e</mi><mi>c</mi><mo stretchy=&quot;false&quot;>)</mo><mspace linebreak=&quot;newline&quot; /><mi>P</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi><mo>.</mo><mi>f</mi><mi>o</mi><mi>r</mi><mn>.8</mn><mi>k</mi><mi>H</mi><mi>z</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>8000</mn></mrow><mo>=</mo><mn>0.125</mn><mo stretchy=&quot;false&quot;>(</mo><mi>m</mi><mi>s</mi><mi>e</mi><mi>c</mi><mo stretchy=&quot;false&quot;>)</mo><mspace linebreak=&quot;newline&quot; /><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>.</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>r</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>P</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi><mo>.</mo><mi>f</mi><mi>o</mi><mi>r</mi><mn>.8</mn><mi>k</mi><mi>H</mi><mi>z</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mi>i</mi><mi>c</mi><mi>k</mi><mo>.</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>r</mi></mrow><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>72000000</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>8000</mn></mrow><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>$</mo></mrow><mn>900</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="93.735ex" height="9.286ex" viewBox="0 -832 40358 3998.3" role="img" focusable="false" style="vertical-align: -7.354ex; max-width: 778px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(13616,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-54" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="704" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="1050" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6B" x="1483" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="2005" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="2471" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="3200" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="4507" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="5057" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-61" x="5509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="6038" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-31" x="6472" y="0"></use><g transform="translate(6972,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-37"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="3003" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="3503" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-28" x="10976" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-73" x="11366" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="11835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="12302" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-29" x="12735" y="0"></use></g><g transform="translate(10025,-1433)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-50" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="1218" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="1669" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6F" x="2015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-64" x="2500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E" x="3024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="3469" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6F" x="4019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="4505" y="0"></use><g transform="translate(4956,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-38" x="278" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6B" x="5735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-48" x="6257" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-7A" x="7145" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="7891" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="9198" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="9748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-61" x="10200" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="10729" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-31" x="11163" y="0"></use><g transform="translate(11663,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-38"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1501" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="13943" y="0"></use><g transform="translate(14999,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-31" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-32" x="1279" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-35" x="1780" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-28" x="17280" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6D" x="17669" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-73" x="18548" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="19017" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="19484" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-29" x="19917" y="0"></use></g><g transform="translate(2810,-2866)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6F" x="760" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-75" x="1246" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6E" x="1818" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-74" x="2419" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E" x="2780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-74" x="3225" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="3587" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6D" x="3932" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="4811" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="5277" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="6006" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="7313" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="7863" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-61" x="8315" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="8844" y="0"></use><g transform="translate(9278,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-50" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="1218" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="1669" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6F" x="2015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-64" x="2500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E" x="3024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="3469" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6F" x="4019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="4505" y="0"></use><g transform="translate(4956,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-38" x="278" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6B" x="5735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-48" x="6257" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-7A" x="7145" y="0"></use></g><g transform="translate(16892,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-54" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="704" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="1050" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6B" x="1483" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-2E" x="2005" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-74" x="2450" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-69" x="2811" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-6D" x="3157" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-65" x="4035" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="4502" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="22123" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-66" x="23430" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-72" x="23980" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-61" x="24432" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMATHI-63" x="24961" y="0"></use><g transform="translate(25395,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-37"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="3003" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="3503" y="0"></use></g><g transform="translate(29399,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-38"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1501" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-3D" x="31678" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-24" x="32735" y="0"></use><g transform="translate(33235,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-39"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/323598/&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjNGdGIXYuF_gS1Pd-ZmnaVklPc4g#MJMAIN-30" x="1001" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>T</mi><mi>i</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>r</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mn>72000000</mn></mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>c</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>P</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi><mo>.</mo><mi>f</mi><mi>o</mi><mi>r</mi><mn>.8</mn><mi>k</mi><mi>H</mi><mi>z</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mn>8000</mn></mrow><mo>=</mo><mn>0.125</mn><mo stretchy="false">(</mo><mi>m</mi><mi>s</mi><mi>e</mi><mi>c</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>C</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>.</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>r</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>P</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi><mo>.</mo><mi>f</mi><mi>o</mi><mi>r</mi><mn>.8</mn><mi>k</mi><mi>H</mi><mi>z</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>T</mi><mi>i</mi><mi>c</mi><mi>k</mi><mo>.</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>r</mi></mrow><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>72000000</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mn>8000</mn></mrow><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo>$</mo></mrow><mn>900</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> Ticker = \ frac {1} {72000000} (sec) \\ Period.for.8kHz = \ frac {1} {8000} = 0.125 (msec) \\ Count.timer = \ frac { Period.for.8kHz} {Tick.timer} = \ frac {72000000} {8000} = $ 900</script></p><br>  We adjust the timer to the value of 8999 (counting it starts from zero) and the event by the Update Event timer.  We tick the global interrupt. <br><br><img src="https://habrastorage.org/files/eac/e57/9af/eace579afd4e448493ceed09930d44ef.jpg" alt="image"><br><br>  You can proceed to the generation of the project.  Go to <b>Project ‚Üí Serrings</b> .  Specify the path to save the project and the size of the stack and heap.  For Speex encoding, we will need approximately 0x600 and 0x1600.  After that, we generate for our environment and open, I have this IAR. <br><br><img src="https://habrastorage.org/files/884/ef7/94a/884ef794abc647668c95dfae4f360ddf.jpg" alt="image"><br><br><img src="https://habrastorage.org/files/f57/391/632/f573916324b946978dd3b70666923a27.jpg" alt="image" align="right">  <b>Connect the Speex library</b> <br><br>  The first thing to do is copy the folder STM32F10x_Speex_Lib with the Speex library into the project's Drivers folder.  Then add the libspeex group to the project, and add the following files to it (see screenshot). <br><br>  In the project properties, on the <b>Preprocessor</b> tab, add define <b>HAVE_CONFIG_H</b> and the following directories: <br><br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / include <br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / libspeex <br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / STM32 <br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / STM32 / include <br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / STM32 / libspeex <br>  $ PROJ_DIR $ / .. / Drivers / STM32F10x_Speex_Lib / STM32 / libspeex / iar <br><br>  Let's try to compile, everything should be fine without wiring and errors. <br><br>  <b>Programming</b> <br><br>  The main thing here is to write the code in the blocks specially allocated by USER CODE BEGIN-END, then, if you need to make changes to the Cuba project and re-generate it, all your code will be saved.  I will work with the library in a separate speexx.c file.  I will give his code and the code of the speexx.h header file immediately: <br><br><div class="spoiler">  <b class="spoiler_title">speexx.h</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> HAVE_CONFIG_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"config.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;speex/speex.h&gt; #include "stm32f1xx_hal.h" #define FRAME_SIZE 160 //*0.125 = 20 ( 8) #define ENCODED_FRAME_SIZE 20 //  8  #define MAX_REC_FRAMES 90 //   ,  = MAX_REC_FRAMES*0,02 extern __IO uint16_t IN_Buffer[2][FRAME_SIZE]; extern __IO uint8_t Start_Encoding; void Speex_Init(void); void EncodingVoice(void);</span></span></span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">speexx.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"speexx.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//SPEEX variables __IO uint16_t IN_Buffer[2][FRAME_SIZE]; __IO uint8_t Start_Encoding = 0; uint8_t Index_Encoding = 0; uint32_t Encoded_Frames = 0; uint8_t REC_DATA[2][MAX_REC_FRAMES*ENCODED_FRAME_SIZE]; //    uint8_t* Rec_Data_ptr = &amp;REC_DATA[0][0]; //    uint8_t* Trm_Data_ptr; //    int quality = 4, complexity=1, vbr=0, enh=1;/* SPEEX PARAMETERS, MUST REMAINED UNCHANGED */ SpeexBits bits; /* Holds bits so they can be read and written by the Speex routines */ void *enc_state, *dec_state;/* Holds the states of the encoder &amp; the decoder */ void Speex_Init(void) { /* Speex encoding initializations */ speex_bits_init(&amp;bits); enc_state = speex_encoder_init(&amp;speex_nb_mode); speex_encoder_ctl(enc_state, SPEEX_SET_VBR, &amp;vbr); speex_encoder_ctl(enc_state, SPEEX_SET_QUALITY,&amp;quality); speex_encoder_ctl(enc_state, SPEEX_SET_COMPLEXITY, &amp;complexity); } void EncodingVoice(void) { uint8_t i; //====================     ====================== if(Start_Encoding &gt; 0) { Index_Encoding = Start_Encoding - 1; for (i=0;i&lt;FRAME_SIZE;i++) IN_Buffer[Index_Encoding][i]^=0x8000; /* Flush all the bits in the struct so we can encode a new frame */ speex_bits_reset(&amp;bits); /* Encode the frame */ speex_encode_int(enc_state, (spx_int16_t*)IN_Buffer[Index_Encoding], &amp;bits); /* Copy the bits to an array of char that can be decoded */ speex_bits_write(&amp;bits, (char *)Rec_Data_ptr, ENCODED_FRAME_SIZE); Rec_Data_ptr += ENCODED_FRAME_SIZE; Encoded_Frames += 1; Start_Encoding = 0; } if (Encoded_Frames == MAX_REC_FRAMES) { __no_operation(); //   ,    &amp;REC_DATA[0][0] } if (Encoded_Frames == MAX_REC_FRAMES*2) { Rec_Data_ptr = &amp;REC_DATA[0][0]; Encoded_Frames = 0; __no_operation(); //   ,    &amp;REC_DATA[1][0] } }</span></span></span></span></code> </pre> <br></div></div><br>  You also need to find the timer interrupt handlers and DMA in the stm32f1xx_it.c file and supplement them by switching the Start_Encoding encoded data flag and resetting the TIM3_IRQn timer flag: <br><br><div class="spoiler">  <b class="spoiler_title">Interrupt handlers</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DMA1_Channel1_IRQHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN DMA1_Channel1_IRQn 0 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DMA1-&gt;ISR &amp; DMA_FLAG_HT1) { Start_Encoding = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//   DMA ,     if (DMA1-&gt;ISR &amp; DMA_FLAG_TC1) { Start_Encoding = 2; } //  DMA ,      /* USER CODE END DMA1_Channel1_IRQn 0 */ HAL_DMA_IRQHandler(&amp;hdma_adc1); /* USER CODE BEGIN DMA1_Channel1_IRQn 1 */ /* USER CODE END DMA1_Channel1_IRQn 1 */ } /** * @brief This function handles TIM3 global interrupt. */ void TIM3_IRQHandler(void) { /* USER CODE BEGIN TIM3_IRQn 0 */ HAL_NVIC_ClearPendingIRQ(TIM3_IRQn); /* USER CODE END TIM3_IRQn 0 */ HAL_TIM_IRQHandler(&amp;htim3); /* USER CODE BEGIN TIM3_IRQn 1 */ /* USER CODE END TIM3_IRQn 1 */ }</span></span></code> </pre> </div></div><br>  Thus, the entire main program is reduced to starting the timer and DMA, initializing Speex and encoding it (in addition to the standard HAL initialization of course): <br><br><pre> <code class="cpp hljs"> Speex_Init(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HAL_TIM_Base_Start_IT(&amp;htim3) != HAL_OK) Error_Handler(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HAL_ADC_Start_DMA(&amp;hadc1,(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*)&amp;IN_Buffer[<span class="hljs-number"><span class="hljs-number">0</span></span>],FRAME_SIZE*<span class="hljs-number"><span class="hljs-number">2</span></span>) != HAL_OK) Error_Handler(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { EncodingVoice(); }</code> </pre> <br>  And now a little run through the code.  In the Speex_Init function, only the Speex encoder is initialized, the decoder must be initialized separately. <br><br>  So, we set up the ADC to trigger the timer.  We reset the trigger timer in the interrupt every 0.125 ms (8 kHz). <br><br><pre> <code class="cpp hljs">HAL_NVIC_ClearPendingIRQ(TIM3_IRQn);</code> </pre> <br>  On DMA interruption, we have the following: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DMA1-&gt;ISR &amp; DMA_FLAG_HT1) { Start_Encoding = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DMA1-&gt;ISR &amp; DMA_FLAG_TC1) { Start_Encoding = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  The DMA_FLAG_HT1 (half transfer complete) flag is raised when the DMA completed the work half (read the first half of the buffer is full), and the DMA_FLAG_TC1 (transfer complete flag) flag, respectively, when the DMA has completed the transfer (the second half is filled). <br><br>  Here I came across an interesting feature that I did not know and lost time on it.  On the debugger, during shutdown, DMA continues to work.  Thus, the buffer always looks full and both flags are raised.  It is impossible to debug the work of DMA, it does not stop. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FRAME_SIZE 160 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//*0.125 = 20 ( 8) #define ENCODED_FRAME_SIZE 20 //   #define MAX_REC_FRAMES 90 //   ,  = MAX_REC_FRAMES*0,02</span></span></span></span></code> </pre> <br>  ADC sampling goes to the IN_Buffer [2] [FRAME_SIZE] double buffer, each half with 160 samples.  At the output, we already get ENCODED_FRAME_SIZE bytes of data, which are sent to the REC_DATA array [2] [MAX_REC_FRAMES * ENCODED_FRAME_SIZE] at Rec_Data_ptr.  The address is incremented by ENCODED_FRAME_SIZE. <br><br>  After each encoding, the Encoded_Frames counter is incremented and at the moment when it becomes equal to MAX_REC_FRAMES, the first half of the output buffer becomes full and you can take data.  We have time for this until the second half is filled, and so on in a circle.  Data is taken from REC_DATA [0] and REC_DATA [1], respectively. <br><br>  You can try to play with frame frames, quality settings, etc., but I did not. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quality = <span class="hljs-number"><span class="hljs-number">4</span></span>, complexity=<span class="hljs-number"><span class="hljs-number">1</span></span>, vbr=<span class="hljs-number"><span class="hljs-number">0</span></span>, enh=<span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-comment"><span class="hljs-comment">/* SPEEX PARAMETERS, MUST REMAINED UNCHANGED */</span></span></code> </pre> <br>  An example of the transferred audio file is in the repository of the first article. <br><br>  <b>Materials</b> <br><br>  1. <a href="https://github.com/xDWart/SpeexForHabr">The repository with the resulting project on Github</a> <br>  2. <a href="https://speex.org/docs/manual/speex-manual.pdf">Speex Codec Manual</a> <br>  3. <a href="https://www.silabs.com/documents/public/application-notes/AN0055.pdf">Application Note from Silicon Labs</a> </div><p>Source: <a href="https://habr.com/ru/post/323598/">https://habr.com/ru/post/323598/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323588/index.html">Create an isomorphic / universal application on Next.JS + Redux</a></li>
<li><a href="../323590/index.html">Electrical circuit simulation</a></li>
<li><a href="../323592/index.html">Recruitment to St. Petersburg Academic University</a></li>
<li><a href="../323594/index.html">Localization of Unity games in Hindi</a></li>
<li><a href="../323596/index.html">‚ÄúExclude cannot be used‚Äù - new risk management method</a></li>
<li><a href="../323600/index.html">+500 free tools to launch your startup in 2017</a></li>
<li><a href="../323602/index.html">Sticky Attacks: when key sticking helps hackers</a></li>
<li><a href="../323604/index.html">Magento BarCamp - the new season of reports. March 2017</a></li>
<li><a href="../323606/index.html">Check Point. What is it, what is it eaten with or briefly about the main thing</a></li>
<li><a href="../323608/index.html">Transition from DateTime to DateTimeOffset</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>