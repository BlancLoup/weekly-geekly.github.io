<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record time: how we increased the launch speed of Mail.Ru Mail application on iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Launch speed is a critical factor for the long-term success of an application. It is especially important for applications such as Mail.Ru Mail, which...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record time: how we increased the launch speed of Mail.Ru Mail application on iOS</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/mailru/blog/307778/"><img src="https://habrastorage.org/files/e25/693/31c/e2569331c64c4dbe8fbb245113f670ae.jpg"></a> <br><br>  Launch speed is a critical factor for the long-term success of an application.  It is especially important for applications such as Mail.Ru Mail, which run many times a day in order to quickly check for new emails in the Inbox. <br><br>  The article focuses on optimizing a large-volume application code that has a relatively long history of development and has managed to accumulate during this time a lot of visible and hidden from the user functionality.  The challenge was to reduce startup time without cutting back on functionality. <br><a name="habracut"></a><br>  Content: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">What can and should be optimized?</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Loading the application into memory</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Search for optimization opportunities</a> <br><ul><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Time profiler</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Logs embedded in the application</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Input Output</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Layout and stuff</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Optimization</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Subjective perception</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">Automation of measurements</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/307778/">results</a> </li></ul><br><a name="1"></a><h1>  What can and should be optimized? </h1><br><anchor>  By launch time, we mean </anchor>  the interval between clicking on the application icon and the moment when the user has the opportunity to perform actions for which he starts the application.  The most important thing is the subjective perception of time by the user, so you can go for various tricks that are not directly related to code optimization.  But the objective indicators, that is, the measured time of the main stages of the launch, directly affect the subjective ones.  In addition, they allow you to measure the impact of a change on the result. <br><br>  We consider the case when the application is unloaded from RAM, since the opening of an already running application takes much less time.  Ideally, you should limit the conditions even more, eliminating the influence of various operating system caches, but then you would have to reboot the device before each measurement, which takes more time and is more difficult to automate. <br><br>  The entire launch of the application can be divided into two major stages: the first is from clicking on the icon to the first call of custom code (usually these are <code>+load</code> methods), the second is the direct execution of application code, including actions performed by system frameworks (run run loop, screen load) launch and main UI) and your own code. <br><br><a name="2"></a><h1>  Loading the application into memory </h1><br>  The first stage is the loading of the executable application code into virtual memory, the loading of the used system and user dynamic libraries, the matching of addresses pointing to various characters inside and outside the main executable file, the initialization of Objective-C runtime.  Some system frameworks may have their own <code>+load</code> methods or constructor functions that are also executed at this stage. <br><br>  A very detailed story about the first stage was at WWDC this year in a wonderful <a href="https://developer.apple.com/videos/play/wwdc2016/406/">406 Optimizing App Startup Time</a> report, a brief squeeze from which you can read on the <a href="http://useyourloaf.com/blog/slow-app-startup-times/">Use Your Loaf</a> blog <a href="http://useyourloaf.com/blog/slow-app-startup-times/">- Slow App Startup Times</a> . <br><br>  I will list the main recommendations. <br><br><ul><li>  Run the application with the environment variable <code>DYLD_PRINT_STATISTICS</code> (to work on iOS 9, you must also check the Dynamic Linker API Usage checkbox) to see how long the various actions of the first stage take.  Here is an example of such statistics on the iPhone 5 under iOS 9.2.1: <br><br><pre> <code class="bash hljs">total time: 2.1 seconds (100.0%) total images loaded: 309 (304 from dyld shared cache) total segments mapped: 14, into 2352 pages with 140 pages pre-fetched total images loading time: 842.08 milliseconds (39.3%) total dtrace DOF registration time: 0.19 milliseconds (0.0%) total rebase fixups: 310,006 total rebase fixups time: 51.52 milliseconds (2.4%) total binding fixups: 376,990 total binding fixups time: 598.68 milliseconds (27.9%) total weak binding fixups time: 6.55 milliseconds (0.3%) total bindings lazily fixed up: 0 of 0 total time <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> initializers and ObjC setup: 639.21 milliseconds (29.8%) libSystem.B.dylib : 130.68 milliseconds (6.1%) libBacktraceRecording.dylib : 1.05 milliseconds (0.0%) libc++.1.dylib : 0.16 milliseconds (0.0%) CoreFoundation : 1.74 milliseconds (0.0%) CFNetwork : 0.02 milliseconds (0.0%) vImage : 0.00 milliseconds (0.0%) libGLImage.dylib : 0.15 milliseconds (0.0%) QuartzCore : 0.02 milliseconds (0.0%) libViewDebuggerSupport.dylib : 0.11 milliseconds (0.0%) libTelephonyUtilDynamic.dylib : 0.00 milliseconds (0.0%) CoreTelephony : 0.04 milliseconds (0.0%) MRMail-Alpha-Enterprise-Shared : 275.17 milliseconds (12.8%) MRMail-Alpha-Enterprise : 224.68 milliseconds (10.5%) total symbol trie searches: 473750 total symbol table binary searches: 0 total images defining weak symbols: 26 total images using weak symbols: 63</code> </pre><br></li><li>  To shorten the <code>total images loading time</code> , use as few dynamic frameworks as possible.  Usually most of them (about 200‚Äì300) are system frameworks that come with iOS, and their load times are already optimized.  But if you add your own frameworks, it can negatively affect the launch speed of the application.  By the way, standard Swift libraries are also considered user-defined. <br><br></li><li>  The time of <code>rebase fixups</code> , <code>binding fixups</code> and <code>ObjC setup</code> affected by the number of Objective-C characters: classes, selectors, categories.  For existing applications it is difficult to give recommendations that would not be associated with significant refactoring or cutting back on functionality.  But if you have such an opportunity, you can try to write the maximum amount of code on pure Swift, that is, without using Objective-C runtime. </li></ul><br>  These recommendations can provide a good acceleration, and they should not be neglected.  But it is much more interesting to consider the second stage, when the code that we write ourselves is executed and, therefore, we can profile, investigate and improve. <br><br><a name="3"></a><h1>  Search for optimization opportunities </h1><br>  First of all, it is necessary to determine key indicators by which we will evaluate the utility of optimizations.  We decided to focus the main efforts on one of the most common scenarios: the user has already been logged into his account and, launching the application, enters the list of letters in the Inbox.  In addition, we have identified several invisible to the user stages, which are part of the internal logic of the application, in order to better understand which of them takes most of the time.  Here are some of them: loading application settings, loading accounts, loading a cached list of folders, appearing a view controller list, initializing background screens. <br><br><a name="4"></a><h3>  Time profiler </h3><br>  Of course, any competent iOS developer, when looking for performance problems, will first of all turn to the Time Profiler tool.  And we also started with him.  In our view, the task should have been easily solved in approximately the following sequence of steps: we look at the profiler, we notice that most of the time is spent on two or three, well, a maximum of ten individual calls, and we concentrate all efforts on optimizing them.  But in the profiler we saw the following. <br><br><ul><li>  There are no clear lead times in Call Tree that you can easily get rid of.  Basically, this is loading UI from xibs, creating a tree of UI objects, layout.  It is clear that if the goal of launching the application is to see the UI, then we cannot simply discard this code. <br><br></li><li>  If we exclude the UI boot code from consideration, the rest of the time is smeared with a very thin layer across all stages and launch sub-stages.  From each individual change here, it was possible to squeeze 50 ms at best. <br><br></li><li>  On the graph of CPU usage, it can be seen that the processor is not continuously used to 100% (or at least 50%, corresponding to single-threaded execution), in some places dips and pauses are visible.  What happens at these moments, with the help of Time Profiler, you can find out only approximately by looking in the Samples list, which stack traces precede the pause.  Most often it is input / output or interaction with system services via XPC. </li></ul><br><img src="https://habrastorage.org/files/a38/285/d14/a38285d1464c4fea9835b647804f7f12.png"><br>  <sup><i>CPU usage schedule</i></sup> <br><br>  However, the Time Profiler was still useful. <br><br>  First, it gives an idea of ‚Äã‚Äãwhat code inside the system frameworks, especially in the UI Kit, takes a lot of time.  Based on this, we can make decisions about the use of certain means of the UI Kit and the UI initialization sequence. <br><br>  Secondly, after we have identified the key events in the startup process, we can see what exactly is being done between these events.  Without the use of Time Profiler, this is not always obvious, since the launch sequence is a complex interrelation of various subsystems and classes of business logic and UI, asynchronous callbacks and code running in parallel.  We used this method: we find samples that interest us in which the event occurred in the Samples list, put a label in these places on the chart (Edit&gt; Add Flag), select the area between the two labels and study Call Tree. <br><br>  Another Time Profiler allows you to find functions and methods that are themselves quickly executed, but slow down the launch due to the large number of calls.  To do this, tick the Invert Call Tree and Top Functions checkboxes in the Call Tree settings, arrange the list by Self Weight or Self Count field and go through the resulting list from top to bottom, excluding uninteresting calls using the Charge XXX to callers or Prune XXX and subtrees options.  So you can, for example, find out that almost 228 ms are occupied by calls to the <code>objc_msgSend</code> function, that is, the overhead of calling methods in Objective-C, and 106 ms are occupied by calls to <code>CFRelease</code> ‚Äî the overhead of managing memory.  It is unlikely that this will be possible to optimize, but in each particular case there is a chance to find something else interesting.  In our case, these were calls to <code>+[UIImage imageNamed:]</code> , since the creation of appearance configurations for all application screens took place at the start. <br><br><a name="5"></a><h3>  Logs embedded in the application </h3><br>  Time Profiler does not provide an easy way to measure the total time spent on a complex sequence of actions, consisting of asynchronous calls.  The method described above ‚Äî with Samples search and labeling ‚Äî cannot be automated.  Therefore, we decided to use a different approach - to place logs at critical points of the launch process.  Each record of such a log consists of the name of the event, the absolute time since the beginning of measurements, the relative time elapsed from the previous event.  An example of a log. <br><br><pre> <code class="bash hljs">load 0 0 main 44 44 did finish launching 295 250 did init BIOD 489 194 will load accounts 1145 655 ELVC view did appear 1663 518 did load accounts 1933 269 did load cached folders 2075 142 items from cache 5547 3471 ELVC did show initial items 7146 1599 did update slide stack 7326 179 stop 7326 0</code> </pre><br>  How to choose the right place for the arrangement of logs?  Considering that in the process of launching individual sub-steps can be carried out in parallel, it makes sense to pay more attention to those that take more time and the end of which you have to wait to continue the launch process.  For example, downloading the list of messages from the database and loading the xib controller view can be done in parallel, but you cannot download the list of messages from the database until we open the database.  To form such a critical path from the events that must be executed, you can use the Xcode feature, which allows you to see not only the current stack-trace, but all previous stack-traces in the sequence of asynchronous calls.  Just put a breakpoint in the line that you think is the end of the startup process, switch the Debug Navigator to View Process By Queue mode - and get a critical path leading from <code>main</code> or <code>application:didFinishLaunchingWithOptions:</code> to the final goal. <br><br>  Although logs have less granularity than Time Profiler data, they have several important advantages. <br><br><ul><li>  Measurements using logs can be automated.  This will help to quickly assess the effect of the implemented change during development, as well as to make the launch speed check part of the Continuous Integration process. <br><br><img src="https://habrastorage.org/files/395/c79/d85/395c79d8506a4ec4bcf7120438e57f73.png"><br>  <sup><i>Grafana</i></sup> <br></li><li>  You may have noticed that the execution time of the same code may differ quite significantly from launch to launch.  The duration is affected by various optimizations built into the operating system itself (such as disk cache), as well as other processes running in parallel at the same time on the device.  In order to get more stable and comparable results, we take measurements several times and take the average or median. <br><br></li><li>  Logs can be copied to Google Sheets, analyzed and compared in any convenient way, and even build beautiful diagrams that clearly show the sequence and duration of various stages. </li></ul><br> <a href=""><img src="https://habrastorage.org/files/1ee/279/195/1ee27919599348c9ab7b2ddd48cf6137.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/8fd/f20/a0f/8fdf20a0f6d643a68cee1fbb6a690888.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/002/d7f/333/002d7f333e9a46779630e374c917ced7.png"></a> <br><br>  In profiling using logs there are pitfalls.  Sometimes you will notice that one of the stages takes a disproportionately long time.  Do not rush to blame him.  First make sure that all this time really applies to this stage.  Perhaps the completion of the stage is actually slowed down by waiting for <code>dispatch_async</code> on the main queue, and the main queue is busy at this time with other things.  If you remove <code>dispatch_async</code> in this place, the duration of this stage can be reduced, but the total time for the execution of all stages will simply be redistributed and remain the same. <br><br>  When searching for places to optimize, it is not enough just to look at how long a particular function is performed: you also need to pay attention to how the high-level application architecture is organized.  It is important to understand the dependencies between the launch stages: can they be performed in parallel or only sequentially.  It is possible that acceleration is achievable due to parallelization of consecutive stages or due to postponement of optional stages for a later time.  Profiling logs can help with this. <br><br><a name="6"></a><h3>  Input Output </h3><br>  Reading files even from flash memory takes an order of magnitude longer than working with RAM or CPU, so it makes sense to minimize the number of disk operations at the start.  The inhibition associated with reading data from the disk appears in Time Profiler as failures at best, and often in no way, so other methods should be used for tracking. <br><br><ul><li>  The I / O Activity tool (System Usage template) only works on real devices.  It shows all system calls related to input / output, paths to opened files, and stack traces of places in the code from which the corresponding operations were performed. <br><br></li><li>  If the first method does not suit you, similar information can be obtained using the usual breakpoint on the <code>__open</code> function.  In this case, the name of the file being opened can be obtained using the LLDB <code>p (char *)$r0</code> command (the name of the register in which the first call parameter is located will <a href="https://www.objc.io/issues/19-debugging/debugging-case-study/">depend on the architecture</a> ). </li></ul><br><a name="7"></a><h3>  Layout and stuff </h3><br>  Some calls that put a load on the CPU are almost impossible to analyze with the Time Profiler: their stack traces do not always contain information about which part of the application they belong to.  An example is a layout walk through a hierarchy view.  Often their stack-trace consists only of system methods, but we would like to know for which view layout takes the most time.  Such calls can be measured and correlated with the objects on which they work, using swizzling, by adding, before and after the corresponding call, a code that displays information about the objects being processed and the execution time of each call to the console.  Having such a log, it is easy to build in Google Sheets a sign with the allocation of time spent on the layout of each of the views.  We used the Swing <a href="https://github.com/steipete/Aspects">Aspects</a> library. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> LayoutLoggingForClassSelector(Class cls, SEL selector) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> *counters = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!counters) { counters = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> dictionary]; } SEL selector = <span class="hljs-built_in"><span class="hljs-built_in">NSSelectorFromString</span></span>(selectorName); [cls aspect_hookSelector:selector withOptions:AspectPositionBefore usingBlock:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;AspectInfo&gt; info) { TLLOG(NL(<span class="hljs-string"><span class="hljs-string">@"lob %s %p"</span></span>), class_getName([[info instance] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]), (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)[info instance]); } error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [cls aspect_hookSelector:selector withOptions:AspectPositionAfter usingBlock:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;AspectInfo&gt; info) { <span class="hljs-built_in"><span class="hljs-built_in">NSValue</span></span> *key = [<span class="hljs-built_in"><span class="hljs-built_in">NSValue</span></span> valueWithPointer:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)[info instance]]; <span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> *counter = counters[key]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!counter) { counter = @(<span class="hljs-number"><span class="hljs-number">0</span></span>); } counter = @(counter.integerValue + <span class="hljs-number"><span class="hljs-number">1</span></span>); counters[key] = counter; TLLOG(NL(<span class="hljs-string"><span class="hljs-string">@"loa %s %p %@"</span></span>), class_getName([[info instance] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]), (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)[info instance], counter); } error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; }</code> </pre><br><a name="8"></a><h1>  Optimization </h1><br>  We formulated the conclusions that we have made for ourselves in the course of work to accelerate the launch in the form of tips.  We hope they will be useful to other developers.  Often, in the process of analyzing the collected performance data, we do not quite correctly interpret certain data.  By taking a false mark, we are trying to correct something that does not really require corrections.  Often, attempts to optimize code make it more difficult to understand and less reliable, the number of extreme cases to be taken into account increases, and so on.  Therefore, when you are trying to optimize something, it is very important to do it not blindly, but having a clear measurement method, showing stable results and helping to evaluate the usefulness of each edit. <br><br><img src="https://habrastorage.org/files/49a/580/70b/49a58070b4344d73a71048461d2e2ee7.png"><br>  <sup><i>Premature optimization</i></sup> <br><br>  Before proceeding with the optimization of the launch time, it is useful to determine which start time limit is in principle achievable if all the code are removed from the application to the maximum, except for what is needed so that the application looks at least externally (it doesn't talk about preserving the functionality here). ).  In our case, such a minimal application is a single screen containing a <code>UINavigationController</code> with a bar and buttons, a <code>UITableView</code> and several cells. <br><br>  Test the version of the application that is as close as possible to the build for the App Store, disable all kinds of runtime checks, logs and asserts, turn on optimization in the build settings.  In our case, the assembly for internal testing contains, for example, a swizzling of a large number of methods for running time-checking of their execution on the main thread.  Naturally, this has a very large impact on the results obtained. <br><br>  First of all, you should optimize the code that runs on the main thread, since the ultimate goal of the entire startup process is to show something on the screen, and this can only be done from the main thread.  Background threads also should not be ignored, since the hardware parallelization capabilities are not limitless: on most devices only two cores are available, and very heavy code running in the background can significantly affect the overall launch time.  We encountered this when we examined the influence of one of the analytics libraries on the launch time.  After the library was initialized, it worked completely in the background thread, but despite this, turning it off gave a relatively large gain. <br><br>  Studying how to reduce the time spent on building a UI, we found that considerable time is spent on loading, configuring and displaying cells in the list of letters.  There are several reasons: there are many cells, each of them consists of a set of subviews, of which the most voracious are various icons and labels.  Icons are relatively slow because loading images in principle is slower than other actions, and the slowness of labels is caused by the necessity of calculating their sizes depending on the content. <br><br>  The icons that are displayed in the letter cell are indicators of the letter attributes (unread, flagged, presence of attachments), as well as action icons that appear during the swipe.  We made the creation of the action pane lazy: it is not created until the swipe happens.  We did the same with attribute icons - they will not be loaded if there are no letters with such attributes in the list. <br><br>         ,    . ,       ,     :  ,     , , ,    UI  .    ‚Äî     <code>+[UIImage imageNamed:]</code> .  , <code>imageNamed:</code>     ,             ‚Äî        .                  <code>AppearanceConfigurator</code> .         ,       ,        ,      ,             .   <code>imageNamed:</code> ,    :   <code>imageNamed:</code>    <code>imageNamed:inBundle:compatibleWithTraitCollection:</code> ,    ,        <code>imageNamed:</code> .      -,       <code>UIImage</code> ,         . <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *)imageWithBlock:(<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *(^)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>))block { MRLazyImage *lazyImage = [(MRLazyImage *)[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> alloc] initWithBlock:block]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *)lazyImage; } - (<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *)image { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_image &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block) { _image = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.block = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _image; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)forwardInvocation:(<span class="hljs-built_in"><span class="hljs-built_in">NSInvocation</span></span> *)invocation { invocation.target = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image; [invocation invoke]; } - (<span class="hljs-built_in"><span class="hljs-built_in">NSMethodSignature</span></span> *)methodSignatureForSelector:(SEL)sel { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image methodSignatureForSelector:sel]; }</code> </pre><br>      <code>UIAppearance</code>        ,      .          . <br><br>  <code>UILabel</code>     ,  <a href="http://asyncdisplaykit.org/">AsyncDisplayKit</a> . ASDK ‚Äî   ,            UI            UI,   .       ASDK    ,       ,    .        <code>UILabel</code>    <a href="http://asyncdisplaykit.org/docs/text-node.html">ASTextNode</a> .  ,      ,    .  ,  ,       ,    SDK. <code>ASTextNode</code>      : ,       ‚Äî     .         .          ,         ,              ,  <code>UILabel</code> ( ,        CoreText). <br><br>        ASDK       .               ,     ,    ,    <code>ASTextNode</code>     UILabel   . <br><br>      ,   ,       Time Profiler, ‚Äî  ,      xib. ,      ,      Interface Builder   . ,     ‚Äî   ?            xib   . ,   ,  ,       ,    .       2010    <a href="http://www.cocoawithlove.com/2010/03/load-from-nib-or-construct-views-in.html">Cocoa with Love</a> . ,     ,    ,       . <br><br>  ,   xib,        , ‚Äî    <code>UINib</code>  .   <code>UINib</code>         ,       . <br><br>     ,           ,     Time Profiler      .        ,  keychain-,  Touch ID,  Pasteboard,     :     ,  . ,   ,              ‚Äî    UI. <br><br>                   <code>application:didFinishLaunchingWithOptions:</code> .     , ,        ,            UI. <br><br>        Core Data     SQLite-,  ,               Core Data   .     ,     UI,      ,    ,        .   ‚Äî            . <br><br>    Swift   ?        Objective-C.   Swift                .   Swift     rebase/bind      ,     Objective-C.   ,  Swift         .         Swift- (        ‚Äî    ).  ,     Swift    ,     ABI. <br><br><a name="9"></a><h1>   </h1><br>          ,       .    ,         . <br><br><ul><li>    . <br><br></li><li>     :   ,    (      :       ,  - ,      ). <br><br></li><li>     ‚Äî  ,     . </li></ul><br><img src="https://habrastorage.org/files/7e2/32e/d5d/7e232ed5d61d40eca131c67316153e23.png"><img src="https://habrastorage.org/files/cfb/c2c/420/cfbc2c4200d84d92a0e02a474eb202d7.png"><br><br><img src="https://habrastorage.org/files/633/945/6f8/6339456f87c743dc8570fa1f32aca498.png"><img src="https://habrastorage.org/files/e7c/bd7/c26/e7cbd7c268d34bdc82288b5ac67ab589.png"><br><br>   ,      . <br><br><ul><li> -        <a href="https://developer.apple.com/ios/human-interface-guidelines/graphics/launch-screen/">iOS Human Interface Guidelines</a> : ¬´  ‚Äî     .     ,             ¬ª.        Mail.Ru,         HIG   . <br><br></li><li>      .  <a href="http://mercury.io/blog/the-psychology-of-waiting-loading-animations-and-facebook"> </a> ,       . <br><br></li><li>          .   ,              UI,              .      ‚Äî  ,       ,    ,         . </li></ul><br><a name="10"></a><h1>   </h1><br>            ,        .        ,      . ,          ,       .    ,      ,       ,        . <br><br>        ,    ,        . <br><br>      Jenkins,     ,    CI.       iPhone.        :   jailbreak  .           jailbreak,       . <br><br><ul><li>       USB     Jenkins,         .       ssh. <br><br></li><li>   Jenkins      ,    . <br><br></li><li>   Jenkins     ,       USB. <br><br></li><li>        . </li></ul><br>    jailbreak      .    ,   jailbreak      .   xcodebuild     App Store Release     . <code>ENABLE_TIME_LOGGER</code>    ,           . <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$XCODEBUILD</span></span> -project MRMail.xcodeproj -target <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TARGET</span></span></span><span class="hljs-string">"</span></span> -configuration <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CONFIGURATION</span></span></span><span class="hljs-string">"</span></span> \ -destination <span class="hljs-string"><span class="hljs-string">"platform=iOS"</span></span> -parallelizeTargets -<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> 4 \ CODE_SIGN_IDENTITY=<span class="hljs-string"><span class="hljs-string">"iPhone Developer"</span></span> \ MAIN_INFOPLIST_FILE=<span class="hljs-string"><span class="hljs-string">"tools/profiler/Info.plist"</span></span> \ GCC_PREPROCESSOR_DEFINITIONS=<span class="hljs-string"><span class="hljs-string">'$GCC_PREPROCESSOR_DEFINITIONS ENABLE_TIME_LOGGER=1 DISABLE_FLURRY=1'</span></span></code> </pre><br>  <code>Info.plist</code>   ,   iTunes File Sharing:      jailbreak  -   Documents.  Flurry      :         ,  Flurry    ,             ,      .       jailbreak     <a href="https://github.com/phonegap/ios-deploy">ios-deploy</a> : <br><br><pre> <code class="bash hljs">APP_BUNDLE=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PROJECT_ROOT</span></span></span><span class="hljs-string">/build/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CONFIGURATION}</span></span></span><span class="hljs-string">-iphoneos/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PRODUCT</span></span></span><span class="hljs-string">.app"</span></span> <span class="hljs-variable"><span class="hljs-variable">$IOS_DEPLOY</span></span> --bundle <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APP_BUNDLE</span></span></span><span class="hljs-string">"</span></span> --id <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEVICE_ID</span></span></span><span class="hljs-string">"</span></span> \ --noninteractive --justlaunch</code> </pre><br>    jailbreak    <code>.app</code>  <code>.ipa</code>    ssh   (  ‚Äî <code>localhost</code> ,   ssh   ).       ipainstaller  Cydia. <br><br><pre> <code class="bash hljs">APP_BUNDLE=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PROJECT_ROOT</span></span></span><span class="hljs-string">/build/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CONFIGURATION}</span></span></span><span class="hljs-string">-iphoneos/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PRODUCT</span></span></span><span class="hljs-string">.app"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PROJECT_ROOT</span></span></span><span class="hljs-string">/build"</span></span> rm -rf Payload; mkdir -p Payload cp -a <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APP_BUNDLE</span></span></span><span class="hljs-string">"</span></span> Payload/ rm -f MRMail.ipa; zip -r MRMail.ipa Payload SCP_TO_DEVICE MRMail.ipa root@localhost: SSH_TO_DEVICE ipainstaller MRMail.ipa</code> </pre><br>         ,        ,     .  ,          ,       . <br><br>      .    -        .       jailbreak   <a href="https://github.com/libimobiledevice/libimobiledevice">idevicedebug</a> ,      USB ‚Äî  <a href="https://github.com/libimobiledevice/ifuse">ifuse</a> . <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 <span class="hljs-variable"><span class="hljs-variable">$NUMBER_OF_RUNS</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-variable"><span class="hljs-variable">$IDEVICEDEBUG</span></span> --udid <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEVICE_ID</span></span></span><span class="hljs-string">"</span></span> run <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUNDLE_ID</span></span></span><span class="hljs-string">"</span></span> &gt;/dev/null 2&gt;/dev/null &amp; COMPLETION_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$COMPLETION_INDICATOR</span></span></span><span class="hljs-string">"</span></span> LOG_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_NAME</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 5) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sleep <span class="hljs-variable"><span class="hljs-variable">$MOUNT_SECONDS_PEDIOD</span></span> <span class="hljs-variable"><span class="hljs-variable">$UMOUNT</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">"</span></span> 2&gt;/dev/null || <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-variable"><span class="hljs-variable">$MKDIR</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$IFUSE</span></span> --documents <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUNDLE_ID</span></span></span><span class="hljs-string">"</span></span> --udid <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEVICE_ID</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">"</span></span> sleep <span class="hljs-variable"><span class="hljs-variable">$AFTER_MOUNT_SECONDS_PEDIOD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$COMPLETION_PATH</span></span></span><span class="hljs-string">"</span></span> ] &amp;&amp; [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_PATH</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> RESULT_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOGS_FOLDER_PATH</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(date +"%d-%m-%Y-%H-%M-%S")</span></span></span><span class="hljs-string">.csv"</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> -x; cp <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_PATH</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RESULT_PATH</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$UMOUNT</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MOUNTPOINT_PATH</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>    jailbreak   .      open  Cydia,    ssh. <br><br><pre> <code class="bash hljs">SANDBOX_PATH=`SSH_TO_DEVICE ipainstaller -i <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUNDLE_ID</span></span></span><span class="hljs-string">"</span></span> | grep <span class="hljs-string"><span class="hljs-string">'^Data: '</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span>` SANDBOX_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SANDBOX_PATH//[$'\t\r\n ']}</span></span></span><span class="hljs-string">"</span></span> COMPLETION_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SANDBOX_PATH</span></span></span><span class="hljs-string">/Documents/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$COMPLETION_INDICATOR</span></span></span><span class="hljs-string">"</span></span> LOG_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SANDBOX_PATH</span></span></span><span class="hljs-string">/Documents/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_NAME</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 <span class="hljs-variable"><span class="hljs-variable">$NUMBER_OF_RUNS</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> SSH_TO_DEVICE open <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUNDLE_ID</span></span></span><span class="hljs-string">"</span></span> sleep <span class="hljs-variable"><span class="hljs-variable">$MOUNT_SECONDS_PEDIOD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 5) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SSH_TO_DEVICE <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$COMPLETION_PATH</span></span></span><span class="hljs-string">"</span></span> &amp;&amp; \ SSH_TO_DEVICE <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_PATH</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> sleep <span class="hljs-variable"><span class="hljs-variable">$AFTER_MOUNT_SECONDS_PEDIOD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> RESULT_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOGS_FOLDER_PATH</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(date +"%d-%m-%Y-%H-%M-%S")</span></span></span><span class="hljs-string">.csv"</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> -x; SCP_TO_DEVICE root@localhost:<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$LOG_PATH</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RESULT_PATH</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>      Ruby    ,       ( ,  , , , )      <a href="https://github.com/influxdata/influxdb">Influxdb</a> ,      <a href="https://github.com/grafana/grafana">Grafana</a>  . <br><br>       .    ,       ?       <a href="http://baguzin.ru/wp/%3Fp%3D5746">   </a> ,           (, 10000).     ‚Äî  270,      10 ,    ,           . <br><br> ,   CI,    - ,                - iOS.           ,     .            . <br><br><img src="https://habrastorage.org/files/269/5a1/d15/2695a1d154f24f8db02e569c44cb4924.png"><br>  <sup><i>Statistics</i></sup> <br><br><a name="11"></a><h1>  results </h1><br>                    ,     .     ‚Äî   ,        . </div><p>Source: <a href="https://habr.com/ru/post/307778/">https://habr.com/ru/post/307778/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307766/index.html">Adobe AIR + Starling + rasterizing vector graphics</a></li>
<li><a href="../307768/index.html">The tale of virtualization-clustering and storage Fujitsu</a></li>
<li><a href="../307770/index.html">Secrets of cloud PBX: a few words about recording conversations</a></li>
<li><a href="../307774/index.html">Android application traffic analysis: certificate pinning bypass without reverse engineering</a></li>
<li><a href="../307776/index.html">Basics of game design: 20 board games. Part Six: Nuclear War, Paranoia, Call of Cthulhu</a></li>
<li><a href="../307780/index.html">Breaking Equation Group: Stuxnet, Duqu and Flame creator files are sold at auction</a></li>
<li><a href="../307782/index.html">Integration of Ultima 2C and Ebay. Personal experience</a></li>
<li><a href="../307784/index.html">How to check website availability online? Service overview HostTracker. Part 2</a></li>
<li><a href="../307786/index.html">Waiting for Linux version: checking the code of the graphical editor Inkscape</a></li>
<li><a href="../307788/index.html">The killer bug. Figak, figak and Therac-25</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>