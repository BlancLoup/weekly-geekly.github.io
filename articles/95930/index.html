<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About implicit ads, backwards compatibility and ABI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baseline : C, gcc4.4, x86, GNU / Linux 

 struct.h : 


 struct S { int * a; int * b; }; 
 ac : 


 #include <stdio.h> #include "struct.h" struct S f ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About implicit ads, backwards compatibility and ABI</h1><div class="post__text post__text-html js-mediator-article">  <b><u>Baseline</u></b> : C, gcc4.4, x86, GNU / Linux <br><br>  <b><u>struct.h</u></b> : <br><pre> struct S
 {
     int * a;
     int * b;
 };
</pre><br>  <b><u>ac</u></b> : <br><pre> #include &lt;stdio.h&gt;
 #include "struct.h"

 struct S f (struct S v)
 {
     printf ("va =% d, vb =% d \ n", * va, * vb);
     return v;
 }
</pre><br>  <b><u>bc</u></b> : <br><pre> #include &lt;stdio.h&gt;
 #include "struct.h"

 int main ()
 {
     int a = 1, b = 2;
     struct S v = {&amp; a, &amp; b};
     f (v);
     printf ("a =% d, b =% d \ n", a, b);
     return 0;
 }
</pre><br>  <b><u>makefile</u></b> : <br><pre> all: test
         ./test

 test: ac bc struct.h
         gcc ac bc -g -o test
</pre><br><br>  <b><u>Question</u></b> : What will be printed at runtime?  Think at least a minute.  And better take a debugger and walk around this simple program. <br><a name="habracut"></a><br>  <b><u>Answer</u></b> : it is not known in advance, and this is all due to the fact that its prototype is not available at the f function call point.  <i>In this case, the passed parameters correspond exactly to what the called function expects</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On my system, for example, the output is: <br><pre> va = 2, vb = 0
 a = 8559808, b = -2398008
</pre><br>  Of course, the absence of a prototype at the point of its challenge is visible to the naked eye, but why does the usually innocuous ‚Äúimplicit declaration of function‚Äù have such grave consequences in this case? <br><br>  All thanks to <a href="http://sco.com/developers/devspecs/abi386-4.pdf">ABI</a> , which follows gcc. <br>  The ABI defines many aspects of what the standard language refers to as ‚Äúimplementation specific‚Äù or is taken for granted.  In particular, the i386 ABI determines the appearance of the machine stack when calling a function.  For functions that return structures / unions, the following is prescribed: <br><br><pre> Position After Call After Returning Position

 4n + 4 (% esp) |  word n ‚Äã‚Äã|  |  word n ‚Äã‚Äã|  4n-4 (% esp)       
            |  ... | |  |  ... | |
    8 (% esp) |  word 1 |  |  word 1 |  0 (% esp)
            | ------------ |  | -------------- |
    4 (% esp) |  address |  |  not defined |
            |  result |  |  |
            | ------------ |  |  |
    0 (% esp) |  address |  |  |
            |  return |  |  |
            | ------------ |  | -------------- |

</pre><br><br>  As you can see, in comparison with a normal call, one more parameter is added that removes the called function from the stack ‚Äî the address at which the return value will be written. <br><br>  What happens in the case in question (drawn, that the calling function placed on the stack, what the callee thinks about it and what is on the stack after the return): <br><pre>
             Calling Immediately
             function function after return
                            (expected)
   16 (% esp) |  local |  |  |  |  local |
            |  |  | ------------ |  |  |
   12 (% esp) |  variables |  |  vb |  |  variables |
            | ============ |  |  |  | -------------- |
    8 (% esp) |  vb |  |  va |  |  vb |  0 (% esp)
            | ------------ |  | ------------ |  | ============== |
    4 (% esp) |  va |  |  address |  |  not defined |
            |  |  |  result |  |  |
            | ============ |  | ------------ |  |  |
    0 (% esp) |  address |  |  address |  |  |
            |  return |  |  return |  |  |
            | ------------ |  | ------------ |  | -------------- |
</pre><br><br>  The following anomalies are present: <br><ul><li>  the called function sees the parameters with a shift of 1 (va "inside" = vb "outside"); </li><li>  the called function overwrites with its return value the memory at the address numerically equal to the value of the first argument (garbage in va); </li><li>  after returning the stack pointer is shifted 1 word back.  Too bad, considering that the compiler expects to find it unchanged, find the parameters that it put on the stack, can access local variables at offsets from esp and try to clean up by adding to esp 8. </li></ul><br>  Here is a story. <br><br>  <u><b>Instead of concluding</b></u> : <br><br>  Compiler warnings may be more important than they are thought of. <br>  ABI's knowledge of its platform sometimes makes life much easier. <br><br>  And in x86_64 there is no such effect. <br><br>  Have a nice day (: </div><p>Source: <a href="https://habr.com/ru/post/95930/">https://habr.com/ru/post/95930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../95924/index.html">SDK: creating an application in 3 steps</a></li>
<li><a href="../95925/index.html">Create a simple usb device to communicate with your program</a></li>
<li><a href="../95926/index.html">Mini fraud to the maximum</a></li>
<li><a href="../95928/index.html">Mortal Kombat: Rebirth</a></li>
<li><a href="../95929/index.html">Who do you work for?</a></li>
<li><a href="../95931/index.html">Meet, QMMP - music player</a></li>
<li><a href="../95934/index.html">Turn off the monitor from the keyboard</a></li>
<li><a href="../95935/index.html">How you can easily and easily implement options in Ruby on Rails</a></li>
<li><a href="../95938/index.html">Tungstene recognizes Photoshop</a></li>
<li><a href="../95939/index.html">We lift FreshTel in Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>