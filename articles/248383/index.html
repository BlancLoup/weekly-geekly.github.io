<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gnuplot on homepage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for? 
 When developing an accessible online database for storing the results of calculations, there was an overwhelming desire to present informa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gnuplot on homepage</h1><div class="post__text post__text-html js-mediator-article"><h2>  What for? </h2><br><img src="https://habrastorage.org/files/587/773/57e/58777357ee79410ba7feee0f1adda5fb.png" width="200" align="right">  When developing an accessible online database for storing the results of calculations, there was an overwhelming desire to present information not only in tabular form, but also in the form of graphs.  You can go in different ways, for example, to draw curves in PHP, but more correctly (in the sense of the UNIX-way) you will use an external program that already knows how to build graphs, such as <a href="http://www.gnuplot.info/">Gnuplot</a> . <br><br>  Particularly intriguing is the possibility of displaying graphs in the form of a set of JS commands for drawing on an HTML5 canvas, which we will do. <br><a name="habracut"></a><br>  About Gnuplot wrote a lot, including on Habr√© ( <a href="http://habrahabr.ru/post/204254/">1</a> , <a href="http://habrahabr.ru/post/165855/">2</a> ), so there is no need for a detailed description of its syntax. <br><br>  To my surprise, I did not find a good tutorial on how to link the output of gnuplot with a dynamically configured page.  Perhaps this is due to a lack of knowledge about Java Script and in fact, everything is obvious, but nevertheless, there is hope that this article will be useful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Gnuplot HTML5 Canvas output </h2><br>  To get an idea of ‚Äã‚Äãthe capabilities of this mode, let's create a minimal script that draws a piece of a sinusoid in the output.html file: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/gnuplot set terminal canvas set output "output.html" plot sin(x) with lines</span></span></code> </pre> <br>  Here, the first line specifies the command interpreter, the second - sets the output format to canvas.  For particularly successful graphs, it would be possible to replace the canvas with pdf and immediately insert the result into an article for, say, Nature.  The third line indicates the file name for the record, if it is not there, the stream will be sent to stdout, which we will use when generating the html page.  The last line contains the actual command to build a sine graph. <br><br>  Opening the generated file output.html, you can see the graph: <br><br><img src="https://habrastorage.org/files/275/78d/39d/27578d39d0b0496e8b0ac138d55e8f3a.jpg"><br><br>  Well, but such a result could be obtained by inserting pictures obtained by the terminal png, but I would like interactivity!  To do this, just specify the parameters of the terminal <b>enhanced mousing</b> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> terminal canvas enhanced mousing <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> output <span class="hljs-string"><span class="hljs-string">"output.html"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> xlabel <span class="hljs-string"><span class="hljs-string">'Time'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ylabel <span class="hljs-string"><span class="hljs-string">'Energy'</span></span> plot sin(4*x)/x with lines linewidth 2</code> </pre><br>  As a result, a panel will appear with control buttons, the ability to put points and zoom in on the area of ‚Äã‚Äãinterest: <br><br><img src="https://habrastorage.org/files/8d8/029/bb4/8d8029bb4c3846d0bac05fa1c6ddffcc.jpg"><br><br>  Already more similar to the <a href="http://gnuplot.sourceforge.net/demo_canvas/">examples from the developers site</a> , but from a remote computer will not work, since for supporting JS-scripts there is a call to the local file system, since the generated file contains lines like: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/usr/share/gnuplot/gnuplot/4.6/js/gnuplot_common.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  That is, you need to place the files from /usr/share/gnuplot/gnuplot/4.6/js on your site by copying them or creating a link.  To work, it is enough to have the files canvastext.js, gnuplot_common.js, gnuplot_mouse.js, gnuplot_mouse.css and png-icons.  You must also specify the path to these files in the terminal parameters: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> terminal canvas enhanced mousing jsdir <span class="hljs-string"><span class="hljs-string">'js'</span></span></code> </pre><br><br><h2>  PHP and gnuplot interaction </h2><br>  So, there is a path to the calculation folder, you need to build a graph according to the selected items on the html-page. <br>  We divide the task into several parts, as shown in the diagram: <br><br><img src="https://habrastorage.org/files/5ac/bbc/0cc/5acbbc0cc7f54e768c7732284935a856.png"><br><br>  Such a scheme may be redundant, and all the functionality can be implemented in php, but this separation splits the code according to its functions and access rights: <br><ul><li>  The shell script has access to the files on the disk and the launch of gnuplot, but should not be accessible from the outside, </li><li>  php and html - on the contrary, are accessible from the outside and should not have access to files outside the site, </li><li>  a separate .gp file allows you to repeat the construction of the graph, but in a more convenient for publication format by choosing pdf or png terminals. </li></ul><br><br><h4>  PHP / HTML </h4><br>  The html form and the php script are combined into one <b>plot_calc.php</b> file: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//     : $path = $_GET['path']; // user-friendly , $fullpath = "/srv/calculations/".$path."/"; //      $nSites = $_GET['nsites']; //   -  '' $fSite = 1; //  '' if (isset($_POST["fSite"])) { $fSite = $_POST["fSite"]; } //      echo '&lt;a href=index.html&gt;Back&lt;/a&gt;'; echo '&lt;h1&gt;Plot Calculation Data&lt;/h1&gt;'; echo '&lt;form id="form_plots" method="post" action=plot_calc.php?path='.$path.'&amp;nsites='.$nSites.'&gt;'; echo ' &lt;input id="plotProb" type="submit" name="plotProb" value="Prob" /&gt;'; echo ' &lt;input id="plotEnergy" type="submit" name="plotEnergy" value="Energy" /&gt;'; // ... echo ' &lt;label&gt;Site number to plot&lt;/label&gt;'; echo ' &lt;input id="fSite" name="fSite" type="text" value='.$fSite.' /&gt;'; echo '&lt;/form&gt;'; if (isset($_POST["plotProb"])) { //    plotProb $input='./plot_calc.sh'.' '.'p '.$nSites.' '.$fullpath.' '.$fSite; echo "Probability plot for Site #".$fSite; } if (isset($_POST["plotEnergy"])) { //    plotEnergy $input='./plot_calc.sh'.' '.'E '.$nSites.' '.$fullpath.' '.$fSite; echo "Energy plot for Site #".$fSite; } // ... $output = shell_exec($input); //    echo $output; //     echo '&lt;/body&gt;'; echo '&lt;/html&gt;'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  As noted in the comments, calling <b>shell_exec</b> in this form is a dangerous undertaking, so at least you should filter the data using the <a href="http://php.net/manual/ru/function.filter-input.php">filter_input</a> function. <br><br><h4>  SHELL </h4><br>  The <b>plot_calc.sh</b> script <b>task</b> is to form commands for gnuplot according to the specified external parameters.  The script creates a file in the temporary directory / tmp, the contents of which is transferred to gnuplot, and the result of the execution is returned, where it is already waiting for a php script. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # : # 1 -  # 2 -   # 3 -  # 4 -    (  p) # -------------- #   # E energy # p probaility # .... #------------------------------# #      : TFILE="/tmp/$(basename $0).$$.gp" #     gnuplot: echo "# Automatically generated Gnuplot script " &gt; $TFILE echo "set terminal canvas enhanced mousing jsdir 'js'" &gt;&gt; $TFILE ### Probability ### if [ $1 == 'p' ] then echo "set xlabel 'Time'"&gt;&gt;$TFILE echo "set ylabel 'Probability'"&gt;&gt;$TFILE let icol=$4+1 echo "plot '$3prob.res' u 1:$icol wi li"&gt;&gt;$TFILE fi # ... ### Energy ### if [ $1 == 'E' ] then let col=$4*2 let col1=$4*2+1 echo "set xlabel 'Time'"&gt;&gt;$TFILE echo "set ylabel 'Energy'"&gt;&gt;$TFILE echo "plot '$3Energ.res' u 1:$col:$col1 wi err"&gt;&gt;$TFILE fi /usr/bin/gnuplot $TFILE</span></span></code> </pre><br>  This file will require execution rights: <pre> <code class="bash hljs"> chmod +x plot_calc.sh</code> </pre> <br><h4>  Gnuplot </h4><br>  The shell script generates an output file whose name contains the name of the calling script and a random number, the inside of it looks something like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Automatically generated Gnuplot script set terminal canvas enhanced mousing jsdir 'js' set xlabel 'Time' set ylabel 'Probability' plot '/srv/calculations/GoodCalc/prob.res' u 1:6 wi li</span></span></code> </pre><br>  You can check the work by sending a browser to the address http: //servername/plot_calc.php? Path = GoodCalc &amp; nsites = 10. <br>  As a result, it will be possible to build graphs based on the data from the prob.res and Energy.res files, and you should get a page similar to: <br><br><img src="//habrastorage.org/files/eed/eda/8af/eededa8af7844150a26ad8082b1f18d1.jpg"><br><br>  Generated files in / tmp should be cleaned from time to time, for this the cron task (as root) will fit: <br><br><pre> <code class="bash hljs">crontab -e</code> </pre><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">0</span></span> *<span class="hljs-regexp"><span class="hljs-regexp">/1 * * * rm -v /tmp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/plot*.gp &gt;&gt; /var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/log/rmplotgp</span></span>.log</code> </pre><br><br><h2>  Conclusion </h2><br><ol><li>  Testing and demonstration were done on Debian Jessie, but should work on other systems; </li><li>  The gnuplot JS files must be accessible from the external network; </li><li>  It is possible to generate not only html-pages, but also js-scripts, managed by user code. </li><li>  Issues of load and safety are not considered here and will require additional attention ... </li></ol></div><p>Source: <a href="https://habr.com/ru/post/248383/">https://habr.com/ru/post/248383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248371/index.html">Unity3D - crossfade, the basics of working with sound (lesson)</a></li>
<li><a href="../248373/index.html">Android launchers. Three developer mistakes</a></li>
<li><a href="../248377/index.html">Handling custom gestures for Leap Motion. Part 1</a></li>
<li><a href="../248379/index.html">Simple "iron" terminal</a></li>
<li><a href="../248381/index.html">Volumetric planets in 2D via shader</a></li>
<li><a href="../248385/index.html">Named Function Arguments in C</a></li>
<li><a href="../248387/index.html">OAuth using JWT on salesforce</a></li>
<li><a href="../248391/index.html">Fighting 2D physics in Unity with the example of an endless game</a></li>
<li><a href="../248393/index.html">Another program PWM or rehabilitation Attiny13a with Zen</a></li>
<li><a href="../248395/index.html">How to get started in Kaggle: a guide for beginners in Data Science</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>