<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Architectural solutions for mobile games. Part 1: Model</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Epigraph: 
 - How do I appreciate it if you do not know what to do? 
 - Well, there will be small screens and buttons. 
 - Dima, you have now describe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Architectural solutions for mobile games. Part 1: Model</h1><div class="post__text post__text-html js-mediator-article">  <i>Epigraph:</i> <i><br></i>  <i>- How do I appreciate it if you do not know what to do?</i> <i><br></i>  <i>- Well, there will be small screens and buttons.</i> <i><br></i>  <i>- Dima, you have now described my whole life in three words!</i> <i><br></i>  <i>(c) Real dialogue at the rally in the gaming company</i> <br><br><img src="https://habrastorage.org/webt/zp/ab/js/zpabjszvfb5gcancgd76i5trlz8.jpeg"><br><br>  The set of needs and the solutions that meet them, which I will talk about in this article, was formed during my participation in about a dozen major projects, first on Flash, and later on Unity.  The largest of the projects had more than 200000 DAU and added new original challenges to my piggy bank.  On the other hand, the relevance and necessity of previous finds was confirmed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our harsh reality, everyone who has ever architectured a large project at least in his thoughts has his own ideas about how to do it, and is often ready to defend his ideas to the last drop of blood.  For others, this causes a smile, and the management often looks at all this as a huge black box that no one has rested against.  But what if I tell you that the right solutions will help reduce the creation of a new functionality by 2-3 times, find errors in the old 5-10 times, and allow you to do many new and important things that were previously not available at all?  It is enough just to let architecture into your heart! <br>  <a href="https://habr.com/post/435704/">Architectural solutions for mobile games.</a>  <a href="https://habr.com/post/435704/">Part 2: Command and their queues</a> <br>  <a href="https://habr.com/post/436060/">Architectural solutions for mobile games.</a>  <a href="https://habr.com/post/436060/">Part 3: View on jet propulsion</a> <br><a name="habracut"></a><br><br><h2>  Model </h2><br><h3>  Field access </h3><br>  Most programmers recognize the importance of using something like MVC.  Few people use pure MVC from the book of the gang of four, but all solutions from normal offices are somehow similar to this pattern in spirit.  Today we will talk about the first of the letters in this abbreviation.  Because a large part of the work of programmers in a mobile game is a new feature in a metagame, implemented as model manipulations, and hooking thousands of interfaces to these features.  And the convenience of the model plays a key role in this lesson. <br><br>  I don‚Äôt cite the full code, because it's a bit dofig, and in general it's not about him.  I will illustrate my reasoning with the simplest example: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory; <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } }</code> </pre> <br>  This option doesn‚Äôt suit us at all, because the model does not send events about the changes occurring in it.  If the information about which fields were affected by the changes and which are not, and which need to be redrawn, and which are not, the programmer will indicate manually in one form or another - that is what will become the main source of errors and time-consuming.  And just do not have to do surprised eyes. In most of the large offices in which I worked, the programmer himself sent all sorts of InventoryUpdatedEvent, and in some cases also manually filled them.  Some of these offices earned millions, do you think, thanks to or contrary to? <br><br>  We will use some of our ReactiveProperty &lt;T&gt; class, which will hide under the hood all the manipulations on sending messages that we need.  It turns out like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;InventoryModel&gt; inventory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;InventoryModel&gt;(); <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money.Value = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.Value.capacity.Value++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ money.SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  This is the first version of the model.  This option is already a dream for many programmers, but I still don‚Äôt like it.  The first thing I don‚Äôt like is that addressing values ‚Äã‚Äãis complicated.  I managed to get confused while writing this example, having forgotten in one place Value. And it‚Äôs these data manipulations that make up the lion‚Äôs share of everything that is done and confused with the model.  If you are using the 4.x version of the language, you can do this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;();</code> </pre> <br>  but this does not solve all problems.  I would like to write simply: inventory.capacity ++;  Suppose we try to do get for each field of the model;  set;  But in order to subscribe to events, we also need access to the ReactiveProperty itself.  A clear inconvenience and source for confusion.  With that, we only need to specify which field we are going to follow.  And here I came up with a cunning maneuver that I liked. <br><br>  See if you like it. <br><br>  It is not the ReactiveProperty itself that is inserted into the specific model that the programmer writes the rules, but his static PValue descriptor, the heir to the more general Property, identifies the field, and inside it, the creation and storage of the desired type of ReactiveProperty is hidden.  Not the most successful name, but it happened, then rename it. <br><br>  In code, it looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; MONEY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MONEY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { MONEY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Get(MONEY).SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  This is the second option.  The common ancestor of the Model, of course, was complicated by the creation and acquisition of a real ReactiveProperty from its descriptor, but this can be done very quickly and without reflection, or rather, using reflection only once during the class initialization stage.  And this is work that is done once by the creator of the engine, and then it will be used by everyone.  In addition, this design allows you to avoid accidental attempts to manipulate the ReactiveProperty itself instead of the values ‚Äã‚Äãstored in it.  The creation of the field itself is cluttered up, but in all cases it is exactly the same, and it can be created with a template. <br><br>  At the end of the article there is a poll which option you like more. <br>  Everything that is described further can be implemented in both versions. <br><br><h3>  Transactions </h3><br>  I want programmers to be able to change the model fields only when it is allowed by the restrictions adopted in the engine, that is, within the command, and never again.  To do this, the setter must go somewhere and check whether the transaction-command is currently open, and only then allow it to edit the information in the model.  This is very necessary, because the users of the engine regularly try to do something strange bypassing the typical process, breaking the logic of the engine and causing subtle errors.  I saw this more than once or twice. <br><br>  There is a belief that if you make a separate interface for reading data from the model and for writing, it will somehow help.  In reality, the model is overgrown with additional files and tedious additional operations.  These restrictions are finite. Programmers are forced, firstly, to know and constantly think about them: ‚Äúwhat should each particular function, model or its interface give,‚Äù and secondly, situations also arise when these restrictions must be circumvented, so that at the exit, we have d'Artagnan, who invented it all in white, and a lot of users of his engine, who are bad guardsmen of the Project Manager, and, despite the constant abuse, nothing works as expected.  Therefore, I prefer to just tightly block the possibility of making such a mistake.  Reduce the dose of conventions, so to speak. <br><br>  The ReactiveProperty setter should have a link to the place where the current state of the transaction is checked.  Suppose this place is classModelRoot.  The simplest option is to pass it to the model constructor explicitly.  The second version of the code when calling RProperty receives a link to this explicitly, and can get all the necessary information from there.  For the first variant of the code, you will have to reflex all fields of type ReactiveProperty in the constructor and distribute a reference to this for further manipulations.  A slight inconvenience is the need to create in each model an explicit constructor with a parameter, something like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot gamestate)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gamestate)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  But for other features of the models, it is very useful for the model to have a reference to the parent model, forming a doubly connected construction.  In our example, this will be player.inventory.Parent == player.  And then this constructor can be avoided.  Any model will be able to receive and cache a link to a magical place from its parent, and that one from its parent, and so on until the next parent turns out to be that very magical place.  As a result, at the level of declarations, all this will look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Model Parent { get; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ModelRoot Root { get; } }</code> </pre> <br>  All this beauty will be filled automatically when the model is hit in the gamestate tree.  Yes, the newly created model, which has not yet got there, will not be able to learn about the transaction and block manipulations with itself, but if this is not allowed by the state of the transaction, she will not be able to go to the state after that, the future parent‚Äôs setter will not allow it, so that the inviolability of the gamestat will not be affected.  Yes, it will require additional work at the programming stage of the engine, but the programmer using the engine will completely eliminate the need to know and think about it until he tries to do something wrong and doesn‚Äôt catch it. <br><br>  Since the conversation about transactness has already started, messages about changes should not be processed immediately after the change is made, but only when all the manipulations with the model within the current team are completed.  There are two reasons for this, the first is data consistency. Not all data states are internally consistent. Perhaps you should not try to draw it.  Or if you were impatient, for example, sort an array or change some model variable in a loop.  You should not receive hundreds of change messages. <br><br>  This can be done in two ways.  The first is to subscribe to updates of a variable, use a clever function that adds a stream of transaction endings to the variable change flow, and the messages will only be skipped after them.  This is fairly easy to do if you are using UniRX, for example.  But this option has many flaws, in particular, it generates a lot of unnecessary moving things.  Personally, I like the other option. <br><br>  Each ReactiveProperty will remember its state before the start of the transaction and its current state.  A message about the change and fixation of the changes will be made only at the end of the transaction.  In the case when the object of the change was some collection, this will allow to include information about the changes in the sent message explicitly. For example, such two elements in the list were added, and these two were removed.  Instead of just saying that something has changed, and forcing the recipient to analyze the list itself with a length of a thousand elements in search of information that needs to be redrawn. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatchChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command transaction)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RevertChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br>  The option is more time consuming at the stage of creating the engine, but then it costs less to use.  And most importantly, it opens up the possibility for the next improvement. <br><br><h3>  Information about changes made to the model </h3><br>  I want more from the model.  At any moment I want to easily and conveniently see what has changed in the state of the model as a result of my actions.  For example, in this form: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>}}}</code> </pre> <br>  Most often, it is useful for the programmer to see the diff between the state of the model before and after the start of the command, or at some point within the command.  Some for this clone the entire gamestate before the start of the team, and then compare.  This partially solves the problem at the debugging stage, but it is absolutely impossible to launch this in the sale.  What is cloning a state, what is the calculation of a slight difference between two lists is a monstrously expensive operation to do with any sneeze. <br><br>  Therefore, ReactiveProperty must keep not only its current state, but also the previous one.  This gives rise to a whole group of extremely useful features.  Firstly, the extraction of the difference in such a situation happens quickly, and we can calmly dump it all in the prod.  Secondly, you can get not a cumbersome diff, but a compact hash from changes, and compare it with a hash of changes in another one of the same game stack.  If you do not agree - you have a problem.  Thirdly, if the execution of the command fell with an exept, you can always undo the changes and find out about the unspoiled state at the time of the start of the transaction.  Together with the command applied to the state, this information is invaluable, because you can easily reproduce the situation exactly.  Of course, for this you need to have ready-made functionality for convenient serialization and deserialization of the gamestat, but in any case you will need it. <br><br><h3>  Serialization of changes made in the model </h3><br>  The engine provides serialization and binary, and in json - and this is not accidental.  Of course, binary serialization takes up much less space and runs much faster, which is important, especially during the initial load.  But this is not a human-readable format, and here we are praying for debugging convenience.  In addition, there is another underwater rock.  When your game goes to the prod, you will need to constantly switch from version to version.  If your programmers follow some simple precautions and do not erase anything unnecessarily from the gamestate, you will not feel this transition.  But for obvious reasons, in binary format string field names, you will have to read the binary of the old version of the state, export to something more informative, for example, in the same json, and then import it into the new, write, and only after all this work on as usual.  As a result, in some projects, configs are written into binaries because of their cyclopean sizes, and the state already prefers to drag it back and forth in the form of json.  Estimate the overhead and choose you. <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    ,    } /**    */ public partial class Model { public bool GetHashCode(ExportMode mode, out int code); public bool Import(BinaryReader binarySerialization); public bool Import(JSONReader json); public void ExportAll(ExportMode mode, BinaryWriter binarySerialization); public void ExportAll(ExportMode mode, JSONWriter json); public bool Export(ExportMode mode, out Dictionary&lt;string, object&gt; data); }</span></span></code> </pre> <br>  The signature of the Export method (ExportMode mode, out Dictionary &lt;string, object&gt; data) is somewhat alarming.  And the thing is this: When you serialize an entire tree, you can write directly to the stream, or in our case, JSONWriter, which is a simple superstructure over StringWriter.  But when you export changes is not so simple, because when you go deep into a tree, go into one of the branches and you still don‚Äôt know if you need to export anything from it at all.  Therefore, at this stage I came up with two solutions, one simpler, the second more difficult and more economical.  The simpler thing is that by exporting only changes you turn all changes into a tree from Dictionary &lt;string, object&gt; and List &lt;object&gt;.  And then what happened was feeding your favorite serializer.  This is a simple approach that does not require dancing with a tambourine.  But its disadvantage is that in the process of exporting changes in the heap there will be allocated a place for disposable collections.  In fact, there is not so much space, because this full export gives a big tree, and a typical team leaves very little change in the tree. <br><br>  However, many people believe that feeding the Garbage Collector as a troll is not necessary unless absolutely necessary.  For them, and to calm my conscience, I prepared a more complex solution: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newModel = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Stack&lt;Model&gt; ierarchyChanged = null)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, Queue&lt;Model&gt; ierarchyChanges = null)</span></span></span></span>; }</code> </pre> <br>  The essence of this method is to pass through the tree twice.  For the first time, view all models that have changed themselves, or have changes in child models, and write them all in the Queue &lt;Model&gt; ierarchyChanges exactly in the order in which they are found in the tree in its current state.  Not a lot of changes, the queue will not be long.  In addition, nothing prevents to keep Stack &lt;Model&gt; and Queue &lt;Model&gt; between calls and then there will be very few allocations in the call process. <br><br>  And already passing the second time through the tree, it will be possible to look at the top of the queue each time, and to understand whether you need to go into a given branch of the tree or immediately go on.  This allows JSONWriter to write immediately without returning any other intermediate results. <br><br>  It is very likely that this complication is not really necessary, because later you will see that you only need to export changes in the tree for debugging or when falling from Exception.  During normal operation, everything is limited to GetHashCode (ExportMode mode, out int code) to which all these delights are deeply alien. <br><br>  Before we continue to complicate our model, let's talk about this. <br><br><h2>  Why is it so important </h2><br>  All programmers say that this is terribly important, but nobody usually believes them.  Why? <br><br>  Firstly, because all programmers say that you need to throw out the old and write a new one.  Absolutely everything, regardless of qualifications.  There is no managerial way to find out if this is true or not, and experiments, as a rule, cost too much.  The manager will have to choose one programmer and trust his judgment.  The problem is that such an adviser is, as a rule, the one with whom the management has been working for a long time and evaluates him on whether he was able to realize his ideas. And all his best ideas have already been translated into reality.  So this, too, is not at all an ideal way to find out how good others are and not similar ideas. <br><br>  Secondly, 80% of all mobile games bring in their entire life less than $ 500.  Therefore, at the beginning of the project, management has other problems, more important than the architecture.  But the decisions taken at the very beginning of the project take people hostage and do not release from six months to three years.  The process of refactoring and switching to other ideas in an already working project, which also has customers, is a very difficult, expensive and risky business.  If for the project, at the very beginning, investing three person-months in a normal architecture seems an unaffordable luxury, then what can you say about the cost of postponing an update with new features for a couple of months? <br><br>  Thirdly, even if the idea ‚Äúhow it should be‚Äù is in itself a good one and the perfect one does not know how long its implementation will take.  The dependence of the time spent on the programmer's coolness is very nonlinear.  The simple task of the senier will not make much faster than the junior.  One and a half times, perhaps.  But each programmer has his own ‚Äúlimit of complexity‚Äù, beyond which his effectiveness dramatically decreases.  I had a case in my life when I needed to implement a rather complex architectural task, and even a full concentration on the task of turning off the Internet in the house and ordering ready-made food for a month did not help. But two years later, after reading interesting books and pecking on related tasks I solved this problem in three days.  I am sure everyone will remember something in their careers.  And here lies the trick!  The fact is that if a brilliant idea came to you in your head, as it should be, then, most likely, this new idea is somewhere at your personal limit of complexity, and maybe even a little bit behind it.  Management, having repeatedly burned himself on such, begins to blow on any new ideas.  And if you make a game for yourself, the result may be even worse, because there will be no one to stop you. <br><br>  But how, with all this, does anyone even manage to use good solutions?  There are several ways. <br><br>  Firstly, each company wants to hire a ready-made person who has already done this with the previous employer.  This is the most common way to shift the burden of experimentation to someone else. <br><br>  Secondly, companies or people who have made their first successful game, swallowed, and starting the next project are ready for the changes. <br><br> -,   ,     -   ,     . ,     . <br><br> -,      ,   ,     ,   ,    ,  -       . <br><br>  ,      :     .           ,     .  :          ,   1  1000,   QA   ,      200     .       ,   ,         ,   ?  , , 10 . <br><br><h2>  Model </h2><br><h3>   </h3><br>     .   -       .   ‚Äì      ,   .     ,          ModelRoot. ,        ,           .   ,     ModelProperty             .      : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PModel</span></span></span><span class="hljs-class">&lt;T&gt; :</span></span> Property&lt;T&gt; where T:Model {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } }</code> </pre> <br>   ?           Parent   ,    ,   ,  Parent null.    ,     .  ‚Äì ,    ,  .   ,     ,   : <br><br><ol><li>  PValue ,      ,           , ,       ,    . , ,runtime ,        ,   . </li><li>   PModel       Parent  -  ,       .     .        ,  . </li></ol><br>     ,           ,       ,       ‚Äì     .        . <br><br>              ,       ‚Äì   ,       ModelRoot .     ,      ,      . ,           ,        ,      .    : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelPath</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Property[] properties; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object[] indexes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Model </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelPath path)</span></span></span></span>; }</code> </pre> <br>  , ,       ,      ?    ,      JSON-,       ,     .        ,       . .      .      .     : <br><br>  ,   ,     ,           .                ,           .      ,       ,         ,  , ,  .            PPersistent.      Persistent: Model.       : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persistent</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextFreePersistentId { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NEXT_FREE_PERSISTENT_ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { NEXT_FREE_PERSISTENT_ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; NEXT_FREE_PERSISTENT_ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt; PERSISTENT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt;      Id-. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;(int localId) where PersistentT : Persistent, new(); /// &lt;summary&gt; C    Id. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;() where PersistentT : Persistent, new(); }</span></span></code> </pre> <br>  ,    .   ,  Persistent     ModelRoot,    ,          ModelRoot. <br><br>       ,   ,      ,       ? <br><br>   ,     ,   ,  .    ,  ,   ? <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{}, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} } }</code> </pre> <br>            : <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>      . <br><br><h3>     </h3><br>              .   ,    ,      ,          .   . <br><br>      Dictionary ‚Äî  ,               .    Model   ,         ,               .     ,      . ,  ,   ‚Äì  .  ,          .        Property ( )  ,    ‚Äì  ,  ,           .  ,               ,   . <br><br>      : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> :</span></span> IModelInternals { <span class="hljs-meta"><span class="hljs-meta">#region Properties protected static Dictionary</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Type, Property[]&gt; propertiesDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected static Dictionary&lt;Type, Property[]&gt; propertiesForBinarySerializationDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected Property[] _properties, _propertiesForBinarySerialization; protected BaseStorage[] _storages; public Model() { Type targetType = GetType(); if (!propertiesDictionary.ContainsKey(targetType)) RegisterModelsProperties(targetType, new List&lt;Property&gt;(), new List&lt;Property&gt;()); _properties = propertiesDictionary[targetType]; _storages = new BaseStorage[_properties.Length]; for (var i = 0; i &lt; _storages.Length; i++) _storages[i] = _properties[i].CreateStorage(); } private void RegisterModelsProperties(Type target, List&lt;Property&gt; registered, List&lt;Property&gt; registeredForBinary) { if (!propertiesDictionary.ContainsKey(target)) { if (target.BaseType != typeof(Model) &amp;&amp; typeof(Model).IsAssignableFrom(target.BaseType)) RegisterModelsProperties(target.BaseType, registered, registeredForBinary); var fields = target.GetFields(BindingFlags.Public | BindingFlags.Static); // | BindingFlags.DeclaredOnly List&lt;Property&gt; alphabeticSorted = new List&lt;Property&gt;(); for (int i = 0; i &lt; fields.Length; i++) { var field = fields[i]; if (typeof(Property).IsAssignableFrom(field.FieldType)) { var prop = field.GetValue(this) as Property; prop.Name = field.Name; prop.Parent = target; prop.storageIndex = registered.Count; registered.Add(prop); alphabeticSorted.Add(prop); } } alphabeticSorted.Sort((p1, p2) =&gt; String.Compare(p1.Name, p2.Name)); registeredForBinary.AddRange(alphabeticSorted); Property[] properties = new Property[registered.Count]; for (int i = 0; i &lt; registered.Count; i++) properties[i] = registered[i]; propertiesDictionary.Add(target, properties); properties = new Property[registered.Count]; for (int i = 0; i &lt; registeredForBinary.Count; i++) properties[i] = registeredForBinary[i]; propertiesForBinarySerializationDictionary.Add(target, properties); } else { registered.AddRange(propertiesDictionary[target]); registeredForBinary.AddRange(propertiesForBinarySerializationDictionary[target]); } } CastType IModelInternals.GetStorage&lt;CastType&gt;(Property property) { try { return (CastType)_storages[property.storageIndex]; } catch { UnityEngine.Debug.LogError(string.Format("{0}.GetStorage&lt;{1}&gt;({2})",GetType().Name, typeof(CastType).Name, property.ToString())); return null; } } #endregion }</span></span></span></span></code> </pre> <br>  -  ,     ,     ,      ,      Type.GetFields()  .   ,       ,   . <br><br><h3>   </h3><br>         ,    : PDictionaryModel&lt;int, Persistent&gt; ‚Äì   ,    . ,        ,    ,           .      -   I.    , ,      ,  diff     .  ,        ,   ,  ,    .  ,    ,  ,    ,     ‚Äì       .   ‚Äì  ,     . ,  Set     .       .      diff-,   , ,  ,   .     : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictionaryStorage</span></span></span><span class="hljs-class">&lt;TKey, TValues&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; removed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; changedValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HashSet&lt;TKey&gt; newKeys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;TKey&gt;(); }</code> </pre> <br>      List-    ,     ,   .   ,     diff-. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListStorage</span></span></span><span class="hljs-class">&lt;TValue&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; previouse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-comment"><span class="hljs-comment">//        public List&lt;int&gt; order = new List&lt;int&gt;(); //       . }</span></span></code> </pre> <br><h2>  Total </h2><br>   ,     ,         .        ,    ,       ,    .  ,             . ,     .     . <br><br>        ,      .            ,    .                     .  Thanks in advance for the answers. <br><br> PS            . </div><p>Source: <a href="https://habr.com/ru/post/434582/">https://habr.com/ru/post/434582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434570/index.html">Minimalistic online simulator of linear DC and AC circuits</a></li>
<li><a href="../434574/index.html">Pure CSS Underline Link Animation</a></li>
<li><a href="../434576/index.html">Using the KOMPAS-3D API ‚Üí Lesson 14 ‚Üí Multiline Text</a></li>
<li><a href="../434578/index.html">Digital hygiene: rules of the game</a></li>
<li><a href="../434580/index.html">Toaster statistics for 2018</a></li>
<li><a href="../434584/index.html">The data is funny (and here are some examples)</a></li>
<li><a href="../434586/index.html">Personal aircraft. Understand and wait</a></li>
<li><a href="../434588/index.html">Summing up the year 2018 on "My Circle"</a></li>
<li><a href="../434590/index.html">$ ls -l / home / avitotech / new_year</a></li>
<li><a href="../434592/index.html">Ilon Mask promises to cover Europe with Tesla Supercharger network next year.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>