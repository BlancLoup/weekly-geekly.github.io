<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we test interaction with Facebook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 Hi, good! For quite a while now, I wanted to write an article about how testing automation is organized in Badoo. I wanted to write ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we test interaction with Facebook</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/60f/6f6/103/60f6f6103d384160ad9f007dfb77456a.png" width="810"></div><br><br>  <b>Introduction</b> <br><br>  Hi, good!  For quite a while now, I wanted to write an article about how testing automation is organized in Badoo.  I wanted to write about something interesting and, at the same time, useful.  Share experiences that can be easily integrated into almost any system.  And now, such a topic has matured ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As many of you know, Badoo is a social network focused on finding new friends and acquaintances.  One of the most important tasks is user verification.  After all, we all want the attractive girl with whom we have an appointment not to be Uncle Kolya from Tver. <br><br>  We have many different ways to verify users.  Some of them are quite familiar, such as verification by phone number.  There is a more unusual - verification of the photo.  But the easiest and fastest is verification via social networks. <br><br>  This method of profile verification is possible immediately at the time of its creation - registration through a social network.  First, it is fast, just one click and no additional manipulations with the phone or webcam.  Secondly, it is convenient, because if you wish, you can import photos and information about yourself, instead of entering them manually. <br><br>  Today I‚Äôll talk about how Badoo does registration and verification through Facebook and how we taught selenium tests to check it. <br><br><a name="habracut"></a><br><br><img src="https://habrastorage.org/files/6e7/559/13c/6e755913c5b14d5582b2f6d021de6acf.png" align="right" height="300"><br><br>  So, imagine that you are a new user of the Badoo service.  You go to the site and see this form of registration.  Fill all these fields or click on the registration button via Facebook?  For me, this is never a question.  I would fill in all the fields manually and would not bind my account.  Why?  Because I'm a little paranoid, I hope this is not contagious.  :) <br><br>  In fact, Badoo will never place any information from a third-party source without the user's consent, so we calmly click on the dark blue button and register on the site.  One click, 10-15 seconds, and we have our verified Badoo profile.  Hooray! <br><br><img src="https://habrastorage.org/files/080/319/c68/080319c6863741b3a37144ed61b1eacd.png" width="350"><br><br>  What would a real QA engineer do after creating a profile on a service so simply and quickly?  That's right, I would try to create another one.  How will the service respond if you try to register another profile on the same FB account? <br><br>  Open the registration page again and click on the FB icon.  Nothing unexpected happened, Badoo ‚Äúrecognized‚Äù the FB-account and instead of registering it immediately authorized it.  Everything is good. <br><br>  <b>The first selenium registration test</b> <br><br>  Now imagine that you are a QA engineer at Badoo.  Your task is to automate the flow of registration and authorization through an FB account.  At first glance, the task is simple, this is what you need: <br><br><ul><li>  FB account; </li><li>  FB button locator on the registration page; </li><li>  the method that waits for the authorization cookie (to make sure that the test is logged into the site); </li><li>  locator sign out buttons to log in; </li><li>  the method that waits for the authentication cookie to disappear. </li></ul><br><br>  After the necessary methods have been written, we compile a script: <br><br><ul><li>  Open the start page; </li><li>  Click the Facebook icon; </li><li>  In the opened tab, log in to Facebook; </li><li>  Wait for authorization on Badoo; </li><li>  Get the user id (let it be first_user_id); </li><li>  Log out; </li><li>  Open the start page; </li><li>  Click the Facebook icon; </li><li>  Wait for authorization on Badoo; </li><li>  Get the user id (let it be second_user_id); </li><li>  Make sure that first_user_id and second_user_id match. </li></ul><br><br>  So, the script is ready, you run the test and it passed.  Everything is fine.  It's time to insert a cat into the article: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f29/b39/5f6/f29b395f6f1f4b55904d4d2489a24ec1.png" width="260"></div><br><br>  We commit the test code to the branch, throw the task on the review and go to drink coffee.  However, you did not have time to reach the kitchen, when a notification comes - the task did not pass the review, the test does not work.  Something went wrong‚Ä¶ <br><br>  After restarting the test, it becomes clear that the problem is as follows - this FB account already has a profile on Badoo.  Instead of registering the test immediately logged in.  There is nothing to do, it is necessary to delete the profile at the end of the test.  Thank God, we have an amazing thing - QaApi! <br><br>  A few years ago I told you how it is integrated with our autotests.  The report was called ‚ÄúSelenium tests.  From RC and one user to WebDriver, Page Object and user pool, you can find it here - <a href="https://habrahabr.ru/company/badoo/blog/216255/">habrahabr.ru/company/badoo/blog/216255</a> . <br><br>  In short, this is an internal api, to which from the test you can send a request and perform some manipulations on the side of the application.  It is called quite simply: <br><br><pre><code class="php hljs">QaApiHelper::deleteUser(user_id);</code> </pre> <br><br>  Of course, QaApi can work only with test users and is available only through the internal network. <br><br>  When the test learned to remove the user for himself, he began to work stably and perfectly.  But it was not so long. <br><br>  <b>Badoo testing stages</b> <br><br>  We tell about what stages of testing exist in our company at almost every conference.  Here I will briefly list those that are interesting from the point of view of selenium tests: <br><ul><li>  Testing on the dev-environment.  Devel is a copy of production with its bases and internal services. </li><li>  Shot testing.  A shot is a production environment that is accessible from the internal network at a specific urla and is the merge of the master code and the task being tested. </li><li>  Testing on staging.  Staging, traditionally - this is the result of the merge of the release branch and the wizard. </li><li>  Production Testing. </li></ul><br><br>  Initially, we drove the tests on the environment-setting and staging.  However, over time, they came to the conclusion that tests need to be able to drive on shots.  The reason is quite simple - the dev does not always copy production perfectly, and it‚Äôs bad to catch a bug on staging and roll back the task from the release.  This means that the task in this release will not fall and will leave later than planned. <br><br>  <b>Second selenium registration test</b> <br><br>  Let's return to our test.  Imagine that you are still the same QA engineer who now faces the task of teaching the registration test to work in parallel on several shots and rating. <br><br>  Let me remind you that the shots work in a combat environment, that is, they have one user base.  It is quite obvious that in the current implementation it will not be possible to run tests in parallel.  If you run these two tests with a difference of a couple of seconds on different shots, the second one will try to create a profile on Badoo when it‚Äôs already created by the first one, and will inevitably break: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f52/dd5/23f/f52dd523f0f94e5bb84b0e9e45c70c8b.png" height="210"></div><br><br>  How to solve our problem?  How to make the test always has a fresh FB user? <br><br>  At first, I tried to solve the problem as minimally as possible.  I created a mysql tablet, into which I added some FB-users created by hands and put statuses on them - they are free.  The test took the user from this plate, changing his status to ‚Äúbusy‚Äù.  If there was no free user, the test fell with the appropriate message. <br><br>  This system had several obvious drawbacks.  First of all, if too many test instances were running at the same time, there were not enough accounts and there was nowhere to take them.  Also, the test could for some reason not free the user at the end (for example, if he was stopped by pressing ‚ÄúCtrl + C‚Äù).  None of this made us happy in the morning, when there was less than an hour before the release. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/770/0c1/756/7700c1756fc943fa82a59d5cd4bd573c.jpeg" width="250"></div><br><br>  Pretty quickly tired of unstable crashes and uncontrolled states of FB accounts, I began to look for a better solution ... <br><br>  <b>The Graph API</b> <br><br>  Facebook has a great api that allows you to create test users and manipulate them - <a href="https://developers.facebook.com/docs/graph-api">developers.facebook.com/docs/graph-api</a> .  It is organized quite simply: we form the necessary request and send it to the FB server, the answer is returned in json format. <br><br>  An example of a request that will register a test user with the name Alex: <br><br> <code>https://graph.facebook.com/{APP_ID}/accounts/test-users?name=Alex&amp;access_token={APP_ID}|{SECRET} <br></code> <br><br>  We receive the application id and secret by registering our application on the FB (for details, see <a href="https://developers.facebook.com/docs/facebook-login/overview">developers.facebook.com/docs/facebook-login/overview</a> ). <br><br>  <b>This pool of Facebook users</b> <br><br>  Well, let's create users!  :) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d7d/485/c1f/d7d485c1fa714a8cb7284eae5720cf89.png" height="200"></div><br><br>  Having carefully studied the graph-api and its features, we have compiled a list of nuances: <br><br><ul><li>  The number of registrations per application is limited.  Quote: "For each application, you can create up to 2000 test users.". <br>  <i>Conclusion: you need to keep records of created users.</i> </li><li>  The newly created test user can only interact with a single application.  In this case, the application is the domain on which the service is located.  In Badoo, staging and shots are on different domains. <br>  <i>Conclusion: keeping track of users, you need to separate them by app id.</i> </li><li>  User logs in rather slowly.  On average from 2 to 5 seconds. <br>  <i>Conclusion: it is more convenient to have a previously created FB user so that the test does not waste time creating it.</i> </li><li>  The test must deal with an account that is probably not used in any other test to avoid the fluctuation race condition. <br>  <i>This item is important as part of the test described here.</i> </li></ul><br><br>  Total: it would be cool to have a custom pool of FB users that would fit our ‚ÄúWishlist‚Äù.  In fact, it should be a sign that will contain the following information: <br><ul><li>  User ID; </li><li>  Email; </li><li>  Password; </li><li>  App id; </li><li>  App Secret; </li><li>  User status - busy test or not; </li><li>  Timestamp creating user. </li></ul><br><br>  In addition to this tablet, we needed several scripts. <br><br>  The first is looking for users in our pool who are busy for more than N minutes and marks them as free.  This is done so that users can be used not only in the test (where you can register a guaranteed user unlock upon completion of the work), but also for manual testing. <br><br>  The second solves the problem of a long user creation on the side of facebook.  It looks like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/fef/a27/264/fefa2726468346788d3826665036658f.png" height="350"></div><br><br>  We wrapped the receiving FB user into a special QaApi method.  The test refers to him for a free user.  If not, a special task is created.  As part of this task, the script sends a curl request to graph-api, waits for a response, and writes down a new user to the nameplate.  The test receives an answer - ‚Äúmust wait‚Äù, closes the connection and makes another attempt after a few seconds.  So we solved two problems.  First, the logic of working with graph-api is separated from the logic of tests.  Secondly, the tests do not keep long connections to third-party services, which greatly facilitates the debug of any problems associated with an increase in the time to pass the tests. <br><br>  Next, we rewrote the necessary tests for a new system for obtaining FB accounts and left the tests to run overnight with our CI server (we use Teamcity).  By morning, the result was ready.  There were exactly as many users as needed for use in tests. <br><br>  The pool has a fairly user-friendly method interface.  It allows at any time to get the ratio of free users to total for each application, to get the number of users created by date.  This helps control the pool balance when adding a new test using FB accounts. <br><br>  <b>Is there such a convenient API for other social networks?</b> <br><br>  I was interested in the guys from VKontakte: <br><img src="https://habrastorage.org/files/770/a83/8cc/770a838cc45f4ddbaaa43f891493e14d.png" width="600"><br><br>  And the guys from Odnoklassniki: <br><img src="https://habrastorage.org/files/35e/8e7/1cf/35e8e71cf40e45f6b34610745b8ea3a5.png" width="600"><br><br>  <b>Total</b> <br><br>  At the moment, the pool is an integral part of our system.  New scripts and new methods have appeared around him.  Due to its flexibility and simplicity, the system is convenient to develop and control. <br><br>  A little about what happened in the end: <br><br><ul><li>  A handy tool for manual and automated interaction of Badoo with Facebook; </li><li>  More than 20 unique tests using the facebook account pool: registration / authorization, verification, uploading photos from an FB account, searching for friends on Badoo, sharing of awards, and so on; </li><li>  In the pool, there are 9 different applications that use a total of approximately 1.5k active users; </li><li>  QaApi-methods can create FB-accounts, make them friends, upload a photo to them, associate FB-accounts with our test users; </li><li>  The system itself supports the required number of FB-accounts and most often does not require any manual intervention. </li></ul><br><br>  For more than a year of use, api worked stably.  Only once there was a problem with user tokens, but facebook developers fixed it pretty quickly.  Who is interested in more details - <a href="https://developers.facebook.com/bugs/1662068220677444/">developers.facebook.com/bugs/1662068220677444</a> . <br><br>  In conclusion, I would like to thank our guys from the design for their invaluable help in creating the whole system.  You are great! <br><br>  Thanks for attention! <br><br>  <i>Vitaly Kotov, QA-automation engineer.</i> </div><p>Source: <a href="https://habr.com/ru/post/305736/">https://habr.com/ru/post/305736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305722/index.html">How to write a good text for a site or email-letter: WIIFM technology</a></li>
<li><a href="../305724/index.html">Features of the choice of solid-state drives (SSD) for servers and RAID-arrays</a></li>
<li><a href="../305726/index.html">Kerio Connect 9.1 - helps small and medium-sized companies work more productively</a></li>
<li><a href="../305728/index.html">Computer vision for blind people. Intel Edison Application</a></li>
<li><a href="../305730/index.html">Analysis of obfuscated virus detection by mobile antivirus applications on the Android platform</a></li>
<li><a href="../305738/index.html">What is big data, part 1</a></li>
<li><a href="../305740/index.html">Lepton Free Format Compresses JPEG Files by 22% Lossless</a></li>
<li><a href="../305742/index.html">Top performances by the WGDF</a></li>
<li><a href="../305746/index.html">Mail server gateway</a></li>
<li><a href="../305748/index.html">Trust Principle in HTTPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>