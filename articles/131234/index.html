<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Preparing your Linux based on Gentoo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people love Gentoo for its versatility. Using portezhi, you can make a tool for any task. And let you not be confused by the fact that the secret...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Preparing your Linux based on Gentoo</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/73db6bee/3286f7ea/0b29ba60/5ec7d575.png"><br><br>  Many people love Gentoo for its versatility.  Using portezhi, you can make a tool for any task.  And let you not be confused by the fact that the secretary will never compile Firefox - God forbid her to give the opportunity to put the software!  What can be better than a distribution kit, having established that you will not need to do anything with it!  Imagine - 5-10 minutes of time and you get a system with the necessary set of software, assembled, configured and optimized according to your preferences. <a name="habracut"></a><br><br>  In this article I will describe the process of creating my own version of the distribution based on Gentoo using Calculate 2.2 utilities.  At the output, you will receive a hybrid ISO disk for recording on CD / DVD or USB-Flash, fully compatible with Gentoo, supporting installation on USB-HDD, USB-Flash, HDD with support for LVM and Raid, ext4, ext3, ext2, reiserfs file system , btrfs, xfs, jfs, nilfs2 or fat32. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The article is primarily addressed to all fans of Gentoo, system administrators, teachers of computer classes in schools and universities, as well as all fans of Linux.  All operations are performed with root user privileges from the console. <br><br><h4>  1. What we need </h4><br>  Of course, you should already have Gentoo installed, or any Gentoo-based distribution kit and Internet access configured.  All the operations I performed from Calculate Linux Desktop 11.9 KDE 64 bits. <br><br>  First, install the packages calculate-assemble and calculate-builder.  In Gentoo, for this you need to connect a Calculate overlay: <br><br> <code>emerge layman <br> layman -a calculate <br> emerge calculate-assemble calculate-builder</code> <br> <br>  Now decide what system you want to build.  Here is a selection of basic images: <br><ol><li>  Gentoo Stage3 - a living wage to start building the system; </li><li>  Calculate Scratch Server (CSS) is essentially the same Gentoo Stage3 with the kernel, drivers, bootloader, portage and Calculate utilities. </li><li>  Calculate Linux Scratch (CLS) - CSS + Xorg + wireless. </li><li>  Calculate Linux Desktop with a KDE, Gnome or XFCE desktop (CLD, CLDG, CLDX) or Calculate Directory Server (CDS). </li></ol><br><br>  Depending on the task, download the latest Gentoo Stage archive or Calculate Stage image and place in the / var / calculate / remote / stages and / var / calculate / linux directories respectively: <br><br> <code><a href=""></a> cd /var/calculate/remote/stages <br> wget mirror.yandex.ru/gentoo-distfiles/releases/x86/current-stage3/stage3-i686-20111018.tar.bz2</code> <br> <br>  or <br><br> <code><a href=""></a> cd /var/calculate/linux <br> wget mirror.cnet.kz/calculate/CLDX/stages/i686/cldx-20111024-i686.iso</code> <br> <br>  Stage Calculate Linux image includes Portage tree.  In fact, this is one of the main differences between the Calculate image and the Gentoo Stage4.  When building a system from Gentoo Stage, you will also need to download portage to the / var / calculate / remote / snapshots directory: <br><br> <code><a href=""></a> cd /var/calculate/remote/snapshots <br> wget mirror.yandex.ru/gentoo-distfiles/snapshots/portage-20111024.tar.bz2</code> <br> <br>  Please note that file versions are constantly updated. <br>  In this article, I will choose CLDX 32 bits for the following reasons: <br><br><ul><li>  The distribution already contains most of the necessary programs; </li><li>  No binding to Gnome / KDE; </li><li>  XFCE includes several small packages and, if desired, is quickly removed. </li></ul><br><br><h4>  2. Prepare the system for assembly </h4><br>  The cl-assemble utility is used to prepare the system for assembly.  You can use any of the available profiles.  In the Calculate Linux profiles, the flags are selected based on the desktop used.  CLD is optimized using Qt / KDE, CLDG - Gtk / Gnome, XFCE - Gtk.  The CLDX profile is perfect if you don‚Äôt want to use either KDE or Gnome. <br><br>  If you specify ‚ÄúCLDX‚Äù as a profile, the program will ask you to enter its name more precisely: <br><br><img src="https://habrastorage.org/storage1/b85ca96e/2e016dd4/ba10c902/e2198fc2.png"><br><br>  You will also need to specify a section for installation.  This can be either a hard disk partition (10-15 GB) or a directory.  In the case of using the directory, additional time will be spent on deleting old files.  By default, the utility uses the Gentoo Stage3 image and fresh Portage: <br><br><img src="https://habrastorage.org/storage1/4e9b3c47/4f24d2a9/233c584e/34e46ff1.png"><br><br>  We point out that we want to take a 32-bit CLDX image, the latest version of which can be downloaded from here <a href="http://mirror.cnet.kz/calculate/CLDX/stages/i686/">mirror.cnet.kz/calculate/CLDX/stages/i686</a> .  To do this, you will need to specify the profile correctly and, if we are working in a 64-bit system, indicate that we want to use the i686 architecture: <br><br> <code>cl-assemble -p desktop/CLDX/x86/binary -d /dev/sda2 --source=CLDX --march=i686</code> <br> <br>  On my car, all the preparation took less than 10 minutes: <br><br><img src="https://habrastorage.org/storage1/8ae8b6b5/f1999e0a/68f7d616/1aa84854.png"><br><br><h4>  3. Update the system </h4><br>  To build the system, use the cl-make utility.  Pay attention to several parameters.  If you want to build a system from Stage3 - use the build option "-m" (or "--make"), if from the Calculate image you can use the system update option "-u", (or "--update").  Note the "-V" (or "--withvideo") option for copying proprietary video drivers.  Copying without installation prevents the violation of the GPL license, while you still have the choice of a proprietary video driver that will be installed into the system during the download process. <br><br> <code>cl-make -u -V</code> <br> <br>  Perform the update: <br><br><img src="https://habrastorage.org/storage1/e5b25d4f/1be64eca/208da989/dd2d706f.png"><br><br>  In the example above, I did not specify the profile to be collected.  It should be entered in case you put several systems on the assembly at the same time.  For example, 32 and 64 bit versions.  In this case, the profile can be entered as "-p amd64" and "-p x86".  By comparing the collected versions, the program will try to determine the desired profile. <br><br>  In my case, it took about 40 packages to be updated. <br><br>  Calculate utilities write their actions to the /etc/calculate/assemble.env file: <br><br><img src="https://habrastorage.org/storage1/872f7e59/5cd55401/72f2766e/508849fa.png"><br><br>  Some values, such as the rsync portage server, available partitions can be entered into utility variables.  Example from a real build server: <br><br><img src="https://habrastorage.org/storage1/a430ccaf/e30df1a4/00c61230/1a5fdd8e.png"><br><br>  After specifying the available sections, it is no longer necessary to pass the parameter of the assembly section. <br><br>  I managed to write this text while the system is being updated.  I came under the update immediately gtk with python, I wish I took today's image.  Despite the fact that I chose a binary profile, the compilation comes from source.  I'll go pour some coffee :) <br><br><h4>  4. Make changes </h4><br>  Finally got to the most interesting.  What we can change: <br><br><ul><li>  package composition; </li><li>  build flags; </li><li>  program settings; </li><li>  user desktop settings; </li><li>  themes, etc. </li></ul><br><br>  As you can see, the image is deployed to the / mnt / calculate-desktop-CLDX-x86-binary / directory.  Use this path to make changes.  In the screenshots you can see that with the deployed system, some adjustment is made.  Actually all the configuration templates can be viewed in the / usr / share / calculate / templates / assemble / directory.  It is important to make changes so as not to cause a configuration conflict.  Somewhere you can create your own change patterns, somewhere use alternative files.  We now consider in more detail. <br><br><h5>  4.1.  Build flags </h5><br>  Managing package building parameters is done via USE flags.  By trimming dependencies, you can achieve several advantages: <br><br><ul><li>  speed up program execution; </li><li>  increase the security of the system; </li><li>  get rid of extra dependencies; </li><li>  reduce disk space requirements. </li></ul><br><br>  Let's look at the contents of the USE variable.  To do this, you need to run the following command in the assembled system: <br><br> <code>linux32 chroot /mnt/calculate-desktop-CLDX-x86-binary /bin/bash -c "emerge --info"</code> <br> <br>  Please note that I used the chroot call through the linux32 utility, since  I am assembling a 32-bit system from under a 64-bit one.  Otherwise, the linux32 utility is not necessary. <br><br>  Flags will be a great many.  You can learn more about them by reading the following descriptions: general - /usr/portage/profiles/use.desc and individual - /usr/portage/profiles/use.local.desc. <br><br>  For making changes to the flags for all packages, the make.conf file is immediately used.  During the build process, the contents of the /etc/make.conf file will be overwritten, so for changes, we recommend using an alternative path, /etc/portage/make.conf. <br><br>  As an example, let's exclude the support of ipv6 addressing in all packages. To do this, add the following line to the /mnt/calculate-desktop-CLDX-x86-binary/etc/portage/make.conf file: <br><br> <code>USE="-ipv6"</code> <br> <br>  Let's see what happens.  This time, run the update with the "-U" flag, instead of "-u".  This will save time on portage synchronization.  Run 'cl-make -U -V': <br><br><img src="https://habrastorage.org/storage1/3731e9e9/3689113a/39ed1ce2/8f3afae5.png"><br><br>  Note.  Since the Xorg server was rebuilt when updating packages, at the end the program will rebuild its modules.  If you run several builds in a row, analyzing the emerge.log file, the program will rebuild the Xorg-server drivers each time.  To prevent this from happening, you can delete the var / log / emerge.log file in the directory of the system you are building.  While packing the system into an image, this file will be deleted anyway. <br><br><h5>  4.2.  Flags and packet masks </h5><br>  To change flags and masks, use the following paths: etc / portage / package.use, etc / portage / package.keywords, etc / portage / package.mask, etc / portage / package.unmask.  The emerge 2.2 package manager can unmask dependencies. <br><br>  Consider the unmasking of packages by the example of the Firefox browser.  To begin, change the root directory: <br><br> <code>linux32 chroot /mnt/calculate-desktop-CLDX-x86-binary <br> env-update &amp;&amp; source /etc/profile</code> <br> <br>  Determine the correct name of the firefox package and find out the list of available versions: <br><br> <code>eix firefox <br> * www-client/firefox <br> Available versions: *3.6.12 3.6.20 ~3.6.21 ~3.6.22 ~7.0.1-r1</code> <br> <br>  Stable version of the package 3.6.20.  Let's unmask version 7.0.1-r1: <br><br><img src="https://habrastorage.org/storage1/51bf9f6c/bda04e54/66585f68/d9abf0fd.png"><br><br>  To update the settings, we use the dispatch-conf utility instead of etc-update: <br><br><img src="https://habrastorage.org/storage1/ddf102f3/dd418d22/54a2543a/e7941bc5.png"><br><br>  The utility will update the masks and USE-flags.  In both cases, press ‚Äúu‚Äù to accept the changes. <br><br><img src="https://habrastorage.org/storage1/88c2a8ab/9dec56ac/cc8da0d0/a55bb0e6.png"><br><br>  Here you can check and write out the names of other packages required for assembly.  At the end, to check all dependencies, run: <br><br> <code>emerge -p 1 2 ..</code> <br> <br><h5>  4.3.  Adding Packages </h5><br>  All installed packages, with the exception of dependencies, are written in the 'world' file.  If you install a package, it is installed into the system along with the dependent libraries.  If any libraries are no longer needed by the package, the 'emerge --depclean' command will remove them.  Therefore, it is important that all packages (without dependencies) that you have additionally installed are registered in the 'world' file.  You can remove them again with the 'emerge --unmerge' command with the indication of the package (s) or manually, by editing the file and executing the 'emerge --depclean'. <br><br>  To build a dependency tree, Calculate utilizes meta-packages based on app-misc / calculate-meta.  Using the USE flags, the entire dependency tree is built.  Since during the build process you could install software for testing, the var / lib / portage / world file will contain only this meta package before packing. <br><br>  In order to add your packages to the distribution, portage has a great tool - sets.  With the help of sets you can prepare your thematic collections of programs.  The sets support attachments, which is also very convenient.  You can edit your list of packages, use the custom set, located in the / etc / portage / sets / custom @ file, by typing in it the line: <br><br> <code>www-client/firefox</code> <br> <br>  Or create a new set with a different name, for example, 'web', by writing a package into it, and in the 'custom' file specify a link to it: <br><br> <code>@web</code> <br> <br>  Thus, a set can contain both nested sets and packages. <br><br>  During the system update, the programs from the set will be installed, since  The set is registered in its world file located in / var / lib / portage / world_sets. <br><br><h5>  4.4.  Removing packages </h5><br>  If you clear the world file and execute 'emerge --depclean', we get a Stage3 image.  Those.  the cost of living is still there and it is called 'system'.  You can update it with the 'emerge system' command, or using the 'emerge <a href="https://habrahabr.ru/users/system/" class="user_link">system</a> ' set.  Meta-package calculate-meta builds dependencies based on the selected profile.  Using the USE flags calculate_nowireless, calculate_nonetwork, calculate_noxfce, etc., you can eliminate some of the dependencies.  A complete list of flags can be found in the /var/lib/layman/calculate/profiles/desc/calculate.desc file.  For example, let's turn off support for wireless devices.  To do this, edit the file /etc/portage/make.conf, writing in it: <br><br> <code>CALCULATE="nowireless"</code> <br> <br><h4>  5. Save changes </h4><br>  We added the firefox browser, removed the support for wireless devices, let's update the image now: <br><br> <code>cl-make -U -V</code> <br> <br>  The firefox package will be installed, and the extra dependencies removed: <br><br><img src="https://habrastorage.org/storage1/39a2351a/c2a63143/fd08db63/1dd88544.png"><br><br><h4>  5. Create a new image. </h4><br>  To create an image, use the cl-image utility: <br><br> <code>cl-image --live iso</code> <br> <br><img src="https://habrastorage.org/storage1/a482217d/3a0f53c5/5beada5b/2aa837a8.png"><br><br>  The "--live" option will allow you to win a few seconds when booting from a LiveCD or USB-Flash.  Use this option if you are using the fresh Calcuge Linux Stage image. <br><br><h4>  6. Completion of assembly </h4><br>  If necessary, or upon completion of the installation, you can interrupt the assembly by running: <br><br> <code>cl-make --break</code> <br> <br><img src="https://habrastorage.org/storage1/4c9f02be/9c1bfb22/2f02b9cc/e5f53b63.png"><br><br><h4>  7. Summary </h4><br>  For the experiment, I chose the Calculate Linux Desktop XFCE distribution and used the CLDX binary profile.  I will execute all further system updates taking into account my USE flags, with the command 'emerge -uDNa world'.  If the flags match exactly, the package will be installed from the binary repository, if there are differences, the package will be assembled on my machine. <br><br>  I received an image with the necessary set of software.  Not all of the features I described involved.  For example, in the distribution kit, you can prepare templates for customizing the user's desktop (see <a href="http://habrahabr.ru/blogs/linux/129658/">habrahabr.ru/blogs/linux/129658</a> ). <br><br>  In the next article, if there is enough interest, I will describe how to get the same result more clearly and without using a hard disk ;-) </div><p>Source: <a href="https://habr.com/ru/post/131234/">https://habr.com/ru/post/131234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131226/index.html">10 years of Windows XP</a></li>
<li><a href="../131228/index.html">We put Windows 3.1</a></li>
<li><a href="../131229/index.html">Using a memory card / sdcard / Android applications</a></li>
<li><a href="../131230/index.html">What version control system are you using? (in real work, most of all)</a></li>
<li><a href="../131231/index.html">Installer Miranda for corporate Jabber'a on NSIS</a></li>
<li><a href="../131235/index.html">GeminiLi Brothers - Apple iPhone 4S and iPhone 4. Video Analysis and Comparison</a></li>
<li><a href="../131236/index.html">Announcement of the largest and most interesting promotional article (70 sheets) about static code analysis</a></li>
<li><a href="../131238/index.html">Today, Nokia should show the first WindowsPhone smartphones</a></li>
<li><a href="../131239/index.html">Ubuntu, email client for MS Exchange 2007</a></li>
<li><a href="../131240/index.html">Using HSQLDB + DBUnit for Unit-testing Java code that works with databases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>