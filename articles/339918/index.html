<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to gather a chat chat bot from scrap materials in a day and a half</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We start talking about some projects of our hackathon. Today is the bot issuing several popular tweets to our student in FB with the word just taken i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to gather a chat chat bot from scrap materials in a day and a half</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/df/1e/59df1e4984d0d012903130.jpeg"><br><br>  We start talking about some projects of our hackathon.  Today is the bot issuing several popular tweets to our student in FB with the word just taken into study.  It turned out a kind of micro-tutorial on Chatfuel, a convenient and simple tool for assembling such bots from the "cubes". <br><a name="habracut"></a><br>  Let's start with the disclaimer: this text is not about the finished service of the Skyeng school, but about the <a href="http://www.messenger.com/t/skyengtweets">prototype</a> assembled on the knee in a day and a half.  We hope that, perhaps, this story will be useful to someone, and simply entertain someone.  Or maybe someone will inspire, and he will bring it to mind - we will only be happy, it falls into our concept of the ‚Äúouter contour‚Äù of the ecosystem.  As practice shows, immediately after the <a href="https://habrahabr.ru/company/skyeng/blog/339248/">hackathon,</a> all its participants are eager to finish their projects, but then the everyday routine rushes in, and these desires disappear somewhere ... <br><br><h3>  Idea </h3><br>  In our dictionary there are examples of the use of words, but they are all artificial - they were prepared by our methodologists, these are academic ‚Äúcorrect‚Äù examples.  In reality, people do whatever they like with words, so an idea emerged to show examples of such real use from ‚Äúwildlife‚Äù.  For example, from Twitter - there people write whatever they want and in any way, they need to write a short message there immediately, as it is painful.  Therefore, they are living, people do not think about the structure of phrases, and in general it is the text format that is closest to life. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, we conceived a small project that, with the help of our <a href="https://habrahabr.ru/company/skyeng/blog/330456/">open Skyeng API, would</a> track the words added by our student for study, and give him in the messenger popular tweets containing them.  We wanted our product to work in the messenger, and not on any separate site or in a separate application, so that the user does not have to go anywhere and install anything;  I needed a point that he works all the time and will be able to tug at it independently. <br><br>  The team consisted of two server programmers and an analyst with experience in front-end development.  And the project itself, respectively, of two parts - a small server application and chat bot.  The general mood was - let's not break up and collect something simple;  In the end, this is a hackathon combined with a corporate party, you must not forget about your own pleasure. <br><br><h3>  Twitter </h3><br>  Twitter has a search, you can go to the site, type in words and see the tweets that contain them.  This search is done both as a Twitter interface and as <a href="https://developer.twitter.com/en/docs/tweets/search/api-reference/get-search-tweets">an API</a> .  The search engine is smart enough, almost like Google: it understands word forms and compound expressions;  for example, if you drive cut down, he will find tweets like I will cut this monstrosity down, where the words themselves are spaced.  To implement our plan, it was enough for us to pull the Twitter API, transfer to it the words that the student added to the study, take tweets from the issue and drop them somewhere in the messenger. <br><br>  Obviously, there will be one hundred million tweets with such words, and somehow we need to select good ones.  The API has a set of query parameters, including the result type (result_type) - either the most recent, or the most popular, or all in a row.  We used the popular ones: it doesn't matter to us that the tweet is old, it is important to us that the readers liked it.  The count parameter defaults to 15, we used 100 to add variety. <br><br>  Of these, we chose three in the parameter favorites_count, i.e.  by the number of likes (Twitter‚Äôs popularity calculation mechanism is closed, but in any case it takes into account many criteria that are not very useful to us, such as the number of author‚Äôs subscribers, retweets, etc.).  Since there was little time on the Hackathon, we decided to fix our parameters in this way, there was simply no time to invent something particularly clever and advanced.  If you wish, you can change them in the future, add custom settings, etc. <br><br><h3>  Server </h3><br>  We took a typical server project template using the Yii 2 PHP framework and made three methods in it. <br><br>  1. When registering a user (receiving an e-mail address and a token from a chatbot), a simple table is created into which a list of word meanings taken for study is copied.  This table is needed due to the fact that our external API does not pass the time when a student has added a value to his dictionary.  Therefore: <br><br>  2. the second method once a half hour goes to the dictionary server and compares the local list of user values ‚Äã‚Äãwith what is stored there.  If it detects added values, this method sends them further;  if there are more than three new words, three are randomly selected. <br><br>  3. The third method is sent to the Twitter API to search for three tweets for each word using the algorithm described above and sends the search results to the chat bot API. <br><br><h3>  Bot </h3><br>  Initially, we considered options for sending tweets to Facebook, Twitter or Telegram.  However, in order to tweet, we would have to create a website where the student could give permission to send tweets to him.  This is a Twitter requirement, everything is done using an SDK that needs to be embedded somewhere, in general, this was too much for MVP.  They started to deal with the docks of Telegram, they realized that Telegram-bot had to be programmed from scratch, there were no ready-made solutions, it would have to be tested, bugs would have gotten ... We decided to stop at the FB-messenger.  We decided on the architecture, agreed on the structure of the base and the semantics of the API methods, after which the programmers went to make their services, and the analyst got busy with the bot itself. <br><br>  <a href="http://chatfuel.com/">Chatfuel was</a> used - a thing that allows us to assemble a bot for an FB messenger without programming (there was an alternative in the form of <a href="https://www.onsequel.com/">Sequel</a> , but it didn‚Äôt work for us, because it does not allow using third-party API).  It has a visual interface in which the functionality is represented by blocks, within which individual actions look like cards processed in turn.  Chatfuel has internal variables that matter to us. <br><br>  The first two blocks that the user sees when creating a new bot are the default greeting message and the reply to the user's reply, to which the answer is not provided.  The same text was entered here - a suggestion to enter the e-mail that was used to register with Skyeng. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1f200a636848991759.png"><br><br>  Our first custom block is email input.  The first card of this block is User input.  It has built-in validation, in this case it checks whether it‚Äôs really an address or something completely different, after which the address is saved to an internal variable, and we go to the second Go to block card, which in turn takes us to the next block Send token. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1f4c4239e243681362.png"><br><br>  This block calls our external API, which sends the token to the student's e-mail.  The first card is ‚Äútapping‚Äù for three seconds; it shows the bot's activity to the user while the request is being executed.  In parallel with it, a request card is launched ‚Äî the JSON API, which calls the <a href="https://words.skyeng.ru/api/doc/external">method of our external API</a> and sends it the student's e-mail from a variable. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1f7988a3a137874766.png"><br><br>  The third card is to enter a token without validation, while saving it to a variable;  the fourth is the transition to the next block. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1fa676f7b345971517.png"><br><br>  The third block is Subscribe, it subscribes the user to the feed.  Here again the ‚Äútapping‚Äù card (since there is again a request that takes time), followed by the JSON API, where we send our request to the new server with an e-mail, token and chat ID {chatfuel user ID} associating the student with this channel.  This ID will be required to call Chatfuela's <a href="https://blog.chatfuel.com/help/facebook-messenger/broadcasting/broadcasting-api/">Broadcasting API</a> directly from our new server.  Upon receiving this request, the server retrieves identifiers of the word values ‚Äã‚Äãthat the student has studied using a <a href="https://words.skyeng.ru/api/doc/external">different method of our external API</a> , for each of them <a href="https://dictionary.skyeng.ru/doc/api/external">retrieves a word from our dictionary</a> , hangs on its schedule a regular check for updates, and then, if available, sends itself tweets in FB via Broadcasting API. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1fe4bf5be909853361.png"><br><br>  The last block displays these tweets when received.  The server pulls the Chatfuel API, sends the values ‚Äã‚Äãof the variables {tweet_word} and {tweet_text}, and the bot, having received them, immediately sends a message to the user. <br><img src="https://habrastorage.org/webt/59/df/1f/59df1ff36a141539533240.png"><br><br><h3>  Shoals (where without them) </h3><br>  None of us had dealt with Chatfuel before, we did not know that it has a Broadcasting API.  Therefore, they first tried to use the RSS block, and the bot structure was different - there was a block in it that subscribes the bot to our RSS and a block that picks up entries from the RSS.  It was planned to make for each user a unique address on our server, on which to spread tweets in the form of RSS feeds, and then import them from there to pick up and shove in the chat. <br><br>  We ditched half a day to do this, hooked up with some kind of server-side PHP library that can build an RSS feed, but it did not climb.  At the same time, everything worked perfectly with the news RSS feed from vc.ru (they took it for tests), but the same tape, in exactly the same form, in the same XML format and with HTTP headers, transmitted through our server, not displayed.  Why - it remains a mystery, maybe our server is not https, maybe there is something else like a list of trusted sites, but nothing happened.  As a result, we found in the docks about the Broadcasting API, and we suffered insight: why bother with XML, when you can simply pass the text as a parameter.  As a result, everything was quickly collected, but the traces of our RSS-torments remained in the server code. <br><br>  Quite a lot of time spent on setting up the server.  At first they raised it on a free service, but it turned out that he did not let the API address stand outside.  I had to ask our admins to give Amazon a place in our cloud.  But in the end, we pretty quickly prepared the MVP and managed for two days to rest and have fun. <br><br><h3>  What is not implemented, the groundwork for the future </h3><br>  We agreed not to sit at night, but to make the minimum working version.  Naturally, a lot of everything remained for later: <br><br>  - you need to play with the settings to give the most useful tweets.  Initially, we wanted to make a smart filter: tried to cut retweets, tried to cut tweets with links (because this is most likely an explanation for something, not a complete record), but we didn‚Äôt have time to bring it to mind: often Twitter gave too few results, therefore, not all words were able to find the right amount of tweets. <br><br>  - it is possible to simplify the logic of calculating new words, if we add to the external API Words time when the meaning of the word was taken for study; <br><br>  - the school has its own service, which for each word gives the level of knowledge of the language;  if you add it to the external API, you can use it to parse each tweet in order to understand if all or not all the words correspond to this level, and to offer the student only those tweets where he will most likely understand all the words; <br><br>  - it was possible to take into account other vocabulary from the student‚Äôs dictionary.  This would allow for more useful tweets.  In the search for Twitter, you can even feed three words, and he will give something.  There are two options for implementation: or make all possible combinations of three words from the student‚Äôs dictionary and throw them into Twitter search, after which you can see which set works best;  or search for words one by one, and then choose the most relevant among the results; <br><br>  - there is a subtlety related to the fact that our bot does not know the meaning of the word used on Twitter, as a result of which the student learns the word cap as ‚Äúcap‚Äù and receives a tweet about Captain Obvious;  With this for two days we could not do anything.  The <a href="https://habrahabr.ru/company/skyeng/blog/326802/">browser extension</a> team has some groundwork for context analysis, they can be used in the future. <br><br>  The current version of the bot can be felt here: <a href="https://m.me/skyengtweets">m.me/skyengtweets</a> . <br><br>  We will continue to talk a little about projects hackathon, but for now we remind you that <a href="https://moikrug.ru/companies/skyeng/vacancies">we are actively looking for cool people</a> who are ready to join our team! <br><img src="https://habrastorage.org/getpro/habr/post_images/b79/8f4/ce7/b798f4ce7359fd815df4bdf76503b295.gif"><img src="https://habrastorage.org/getpro/habr/post_images/563/98e/76b/56398e76be6355ad5999b262208a17c9.gif"><img src="https://habrastorage.org/getpro/habr/post_images/df3/e56/7d6/df3e567d6f16d040326c7a0ea29a4f41.gif"><img src="https://habrastorage.org/getpro/habr/post_images/d89/746/888/d89746888da2d9510b64a9f031eaecd5.gif"></div><p>Source: <a href="https://habr.com/ru/post/339918/">https://habr.com/ru/post/339918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339908/index.html">Killer feature Vim</a></li>
<li><a href="../339910/index.html">We break the modified AES-256</a></li>
<li><a href="../339912/index.html">Zoia.js: another web framework on Node</a></li>
<li><a href="../339914/index.html">Jupyter Widgets for implementing the Turing UI machine</a></li>
<li><a href="../339916/index.html">SLA philosophy: what is escalation and why is it needed?</a></li>
<li><a href="../339920/index.html">Zabbix conference 2017: how was the second day</a></li>
<li><a href="../339924/index.html">Check Point R80.10 API. Management through CLI, scripts and not only</a></li>
<li><a href="../339926/index.html">A practical guide to analyzing application performance</a></li>
<li><a href="../339928/index.html">How to maintain a Telegram channel with 20,000 subscribers? Interview with the creator of All-in-One Person</a></li>
<li><a href="../339930/index.html">Development for Sailfish OS: displaying graphs using D3.js and QML Canvas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>