<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Intel Edison in IoT: securely connecting the touch node to the Internet using MQTT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We already wrote about the MQTT broker and how to assemble a touch node based on Intel Edison . The device contains a button, motion sensors, temperat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Intel Edison in IoT: securely connecting the touch node to the Internet using MQTT</h1><div class="post__text post__text-html js-mediator-article">  We already wrote about the <a href="https://habrahabr.ru/company/intel/blog/275083/">MQTT broker</a> and <a href="https://habrahabr.ru/company/intel/blog/283328/">how to assemble a touch node based on Intel Edison</a> .  The device contains a button, motion sensors, temperature and light.  Today we will connect all this to the Mosquitto MQTT-server, we will establish two-way communication, we will make our design a full-fledged part of the Internet of things. <br><br> <a href="https://habrahabr.ru/company/intel/blog/283440/"><img src="https://habrastorage.org/files/aa1/349/33c/aa134933cb3c4d6fbcabcef6c8cd9647.jpg"></a> <br><a name="habracut"></a><br><h1>  <font color="#0071c5">MQTT</font> </h1><br><h2>  <font color="#0071c5">Model publisher-subscriber in MQTT</font> </h2><br>  MQTT is one of the popular protocols for the organization of machine-to-machine communication (M2M, Machine to Machine).  It works on the ‚Äúpublisher-subscriber‚Äù principle and is based on TCP / IP.  The two main components of the MQTT are the client and the broker.  MQTT-clients publish messages on a specific topic (topic), or subscribe to messages and listen to them.  The MQTT broker receives all messages published by publishers and forwards relevant messages to subscribers.  Subscribers and publishers should not know about each other, only the topics of the messages and the messages themselves play a role.  For the organization of normal interaction publishers and subscribers should use the common names of topics and message format. <br><br>  To post messages, or subscribe to messages of a particular topic, you need an MQTT client.  In the Mosquitto MQTT distribution, the client publishing messages is called mosquitto_pub, and the client subscribing to messages is called mosquitto_sub. <br>  This is what messaging looks like, which we'll talk about below.  The red window shows the work of the client-subscriber, in black - the client-publisher.  Commands are tagged, it will allow you to refer to them conveniently. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93e/83a/8d5/93e83a8d59efceefeded3e98569ebd29.jpg"></div><br>  <i><font color="#999999">Subscriber / Publisher Interaction</font></i> <br><br>  The minimum set of arguments required for subscribers-subscribers is the broker's IP address and the name of the message subject, and for the publisher customers, the message text.  Provided that the MQTT broker is available at 127.0.0.1 (localhost), the command shown below will listen to all messages published with the theme ‚Äúedison / hello‚Äù. <br><br><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> 3&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mosquitto_sub</span></span></span><span class="hljs-function"> ‚Äì</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">localhost</span></span></span><span class="hljs-function"> ‚Äì</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edison</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span></span></code> </pre> <br>  But how can you post a message with the theme "edison / hello". <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">pub</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>&gt; mosquitto_pub ‚Äìh localhost ‚Äìt edison/hello ‚Äìm <span class="hljs-string"><span class="hljs-string">"Message#1: Hello World!"</span></span></code> </pre> <br>  When the MQTT broker receives a message ‚ÄúMessage # 1: Hello World‚Äù from the publishing client (pub 3), published with the topic ‚Äúedison / hello‚Äù, the broker looks at the list of customers who are subscribed to the topic ‚Äúedison / hello‚Äù.  Upon finding that the subscriber client (sub 3) is subscribed to the specified topic, the MQTT broker forwards the message to this client. <br><br>  When a subscriber receives a message, he displays it in a terminal window.  In the commands of the subscriber sub 3 and publisher pub 3, the MQTT port number is implicitly given by default (1833), so it is not specified on the command line.  In the sub 4 and pub 4 commands the port number is specified.  In the sub 5 and pub 5 commands, the key ‚Äú-v‚Äù has been added to the arguments to the subscription.  This allows you to display in the terminal window not only the message, but also the name of the topic.  This will be useful when subscribing to several topics using templates.  A subscriber once created is not automatically destroyed, so additional messages published with the theme ‚Äúedison / hello‚Äù, for example, using the pub 6 command, will be redirected to this subscriber. <br><br>  The standard behavior of the MQTT broker is that it discards the message immediately after it is delivered to the clients.  The pub 7 client publishes a message with a new theme, ‚Äúedison / hello1‚Äù, but the subscriber client sub 5 is waiting for messages with the theme ‚Äúedison / hello‚Äù, so he will not receive messages from pub 7.  Then the subscriber client, sub 6, subscribes to the edison / hello1 topic, but he also will not receive a previously sent message with this topic, since it has already been dropped.  He will receive only the following messages published with this topic, for example, published in the pub 8 line. <br><br>  There are additional parameters that instruct the MQTT broker to save the last message published with a certain topic.  There are directives that allow you to customize the quality of service (Quality of Service, QoS), which affect how the broker will deliver messages.  Details on these features can be found in the <a href="https://github.com/mqtt/mqtt.github.io/wiki">MQTT Wiki</a> . <br>  Depending on the port configuration, additional arguments may be needed.  We will return to this question later. <br><br><h2>  <font color="#0071c5">Subscribe to several topics</font> </h2><br>  Usually in practice, MQTT clients are used, which are subscribed to several topics and perform different actions depending on the messages received.  Let's talk about MQTT topics. <br><br>  MQTT topics are organized in a hierarchical structure.  The symbol "/" is used to highlight the logical levels of topics.  This is what a logically constructed topic space might look like. <br><br><pre> <code class="hljs">Temperature/Building1/Room1/Location1 Temperature/Building1/Room1/Location2 Temperature/Building2/Room2 Temperature/Outdoor/West Temperature/Outdoor/East Temperature/Average</code> </pre> <br>  A subscriber can subscribe to a specific topic, say, ‚ÄúTemperature / Outdoor / West‚Äù, or several using a template. <br><br>  There are two wildcard characters in MQTT: ‚Äú+‚Äù and ‚Äú#‚Äù.  The ‚Äú+‚Äù symbol is used to subscribe to topics that are at the same hierarchy level.  The ‚Äú#‚Äù symbol is used to subscribe to all subsections of a given topic. <br><br>  For example, a subscription to the topic ‚ÄúTemperature / #‚Äù will deliver a message to the client with any of the topics shown in the example.  By subscribing to Temperature / +, the client will receive only messages with the subject Temperature / Average, since all other topics are at a lower hierarchical level.  Details on the organization of MQTT theme spaces can be found on the <a href="http://mqtt.org/wiki">MQTT Wiki site</a> . <br><br><h2>  <font color="#0071c5">Setting up a safe broker Mosquitto</font> </h2><br>  The MQTT client can be connected to the Mosquitto server in four main ways. <br><br><ol><li>  Through the open port, that is, without protection.  This is useful when developing and testing MQTT devices before practical use.  Data between the broker and the client are transmitted in plain text, without encryption.  As a result, they are easy to intercept. <br><br></li><li>  Using a username and password.  With this method, the broker can verify the authenticity of the client.  However, data is not encrypted during transmission. <br><br></li><li>  Using TLS-PSK encryption.  The client and the broker have a shared secret key, which is used when establishing a secure connection.  This feature is available starting from Mosquitto 1.3.5. <br><br></li><li>  Using SSL encryption.  This is the most advanced encryption and authentication scheme available in the Mosquitto MQTT.  When using SSL, you must obtain a server certificate from a trusted certificate authority (Certificate Authority, CA), among such centers - Verisign and Equifax.  Often, for testing, they create a self-generated certificate that can be used to sign the server certificate.  SSL allows you to achieve a high level of security, but to implement such a scheme of work is more difficult than others.  The fact is that when using SSL you need to provide all the client devices with the appropriate certificates.  In addition, it is necessary to develop an update mechanism to maintain compliance of certificates of clients and broker during the operation of the system. <br></li></ol><br>  To configure the Mosquitto MQTT secure broker, use the following configuration directives.  Here a self-generated certificate is used that is suitable for test purposes.  Such certificates should not be used on production servers. <br><br><pre> <code class="hljs 1c">port <span class="hljs-number"><span class="hljs-number">1883</span></span> password_file /home/mosquitto/conf/pwdfile.txt log_type debug log_type error log_type warning log_type information log_type notice user root pid_file /home/mosquitto/logs/mosquitto.pid persistence true persistence_location /home/mosquitto/db/ log_dest file /home/mosquitto/logs/mosquitto.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> listener <span class="hljs-number"><span class="hljs-number">1995</span></span> <span class="hljs-meta"><span class="hljs-meta">#  1995    TLS-PSK, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  #  --psk-identity  --psk psk_file /home/mosquitto/conf/pskfile.txt #   psk_hint, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  1995 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">    psk_hint hint listener 1994 #  1994   SSL-, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  #  ,   , #   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">, , ca.crt cafile /home/mosquitto/certs/ca.crt certfile /home/mosquitto/certs/server.crt keyfile /home/mosquitto/certs/server.key</span></span></code> </pre> <br>  The <i>pwdfile.txt</i> file in this example is a password file, encrypted in the same way as the Linux password file.  It can be created using the <i>mosquitto_passwd</i> utility that comes with Mosquitto.  The <i>pskfile.txt</i> file is a password file that is pre-hosted on clients and on the server.  It is used to establish a connection using TLS-PSK.  This is a plain text file, each line of which contains one pair of ‚Äúuser: password‚Äù type.  Passwords that are used for TLS-PSK are not case sensitive and can contain only hexadecimal characters.  Here are some examples of the password file and the .psk file. <br><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/*    Mosquitto */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>:<span class="hljs-meta"><span class="hljs-meta">$6</span></span>$Su4WZkkQ0LmqeD/X$Q57AYfcu27McE14/MojWgto7fmloRyrZ7BpTtKOkME8UZzJZ5hGXpOea81RlgcXttJbeRFY9s0f+UTY2dO5xdg== <span class="hljs-comment"><span class="hljs-comment">/*  PSK- Mosquitto */</span></span> user1:deadbeef user2:DEADBEEF0123456789ABCDEF0123456789abcdef0123456789abcdef0123456789abcdef &lt;h1&gt; MQTT   &lt;/h1&gt;</code> </pre><br>  Since Intel Edison is a Linux system that can run a program (sketch) for Arduino as one of its processes, you can use the Mosquitto MQTT package that we have already prepared.  Linux programming tools are available within the sketch to call <i>mosquitto_sub</i> and <i>mosquitto_pub</i> .  There are several advantages to this approach. <br><br><ol><li>  No need to rewrite MQTT clients for Arduino.  The Mosquitto MQTT package is a well-known and well-tested code.  We only need to create a wrapper class in order to be able to use it in the Arduino-sketch. <br><br></li><li>  Mosquitto MQTT clients support secure SSL connections.  At the same time, a low-power microcontroller in a regular Arduino does not meet the computational requirements of SSL. <br><br></li><li>  If a more advanced MQTT packet is found or a new version of what is already in use is released, most of the existing code can be reused, adding new support for it. <br></li></ol><br><h2>  <font color="#0071c5">MQTTClient class</font> </h2><br>  Since Intel Edison is running a full-featured Linux OS, the Arduino program is available for all Linux development tools.  Create a wrapper class, MQTTClient, which will be used in the sketch.  In the MQTTClietn methods, we use Linux system calls to call <i>mosquitto_sub</i> and <i>mosquitto_pub</i> , which, in turn, will deal with communication tasks using the MQTT protocol.  Here is the MQTTClent class description, limited by the minimum required features. <br><br><pre> <code class="hljs lua">// : MQTTClient.h /*  MQTT-,  mosquitto_sub  mosquitto_pub   ,   Mosquitto MQTT   mosquitto_pub/<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>      */ #ifndef __MQTTClient_H__ #define __MQTTClient_H__ #include &lt;Arduino.h&gt; #include &lt;stdio.h&gt; enum security_mode {OPEN = <span class="hljs-number"><span class="hljs-number">0</span></span>, SSL = <span class="hljs-number"><span class="hljs-number">1</span></span>, PSK = <span class="hljs-number"><span class="hljs-number">2</span></span>}; class MQTTClient { public:   MQTTClient();   ~MQTTClient();   void    begin(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * broker, int port, security_mode mode,                 <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* certificate_file, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *psk_identity, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *psk);   boolean publish(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *message);   boolean subscribe(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, void (*callback)(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* message));   boolean loop();   boolean available();   void    <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); private:   void           parseDataBuffer();   FILE*          spipe;   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           mqtt_broker[<span class="hljs-number"><span class="hljs-number">32</span></span>];   security_mode  mode;   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           topicString[<span class="hljs-number"><span class="hljs-number">64</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           certificate_file[<span class="hljs-number"><span class="hljs-number">64</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           psk_identity[<span class="hljs-number"><span class="hljs-number">32</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           psk_password[<span class="hljs-number"><span class="hljs-number">32</span></span>];   int            serverPort;   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           *topic;   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           *message;   boolean         retain_flag;   void           (*callback_function)(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* message);   <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>           dataBuffer[<span class="hljs-number"><span class="hljs-number">256</span></span>]; }; #endif</code> </pre> <br>  To use this class, you need to start by creating an MQTTClient object, then call <i>MQTTClient :: begin ()</i> to initialize the various variables that will use <i>MQTTClient :: subscribe ()</i> and <i>MQTTClient :: publish ()</i> to connect to the MQTT broker .  Here is a description of these variables. <br><br><ul><li>  <i>mqtt_broker</i> : the name of the MQTT broker.  This can be an IP address or DNS name.  In this case, we use ‚Äúlocalhost‚Äù as the broker works on the same Intel Edison board as the sketch.  If Edison is configured to use a static IP address, you can use it instead of ‚Äúlocalhost‚Äù. <br><br></li><li>  <i>serverPort</i> : used port.  We assigned the Mosquitto broker three different ports, each with its own security policy: <br><br></li><li>  1883 is the default MQTT port, it is open to all clients. <br><br></li><li>  1994 is configured as a secure SSL port.  Clients that connect to this port must have SSL certificates issued by a certification authority that issued the server certificate. <br><br></li><li>  1995 is the secure TLS-PSK port.  To access it, you need a username and password, which is known in advance by both the client and server parts of the system. <br><br></li><li>  <i>mode</i> : the security mode to use.  In this example, there are three modes: OPEN, SSL and PSK.  Depending on the selected security mode, in other method arguments, a certificate or user name and password are passed.  Arguments that are not used in the selected security mode are ignored. <br></li></ul><br>  In order to subscribe to a topic, call the <i>MQTTClient: subscribe ()</i> method with the name of the topic and the callback function that will be launched when a new message arrives.  To post a message with a topic, call <i>MQTTClient: publish ()</i> with the name of the topic and the message. <br><br>  Both in the message subscription method and in the publication method, the corresponding command is formed, which calls either <i>mosquitto_sub</i> or <i>mosquitto_pub</i> and uses argument methods and saved parameters.  Then the Linux channel opens, the command is executed, the results are returned via the channel to the sketch. <br><br>  When publishing, the channel closes immediately after the message is sent.  When you subscribe, the channel must be kept open so that new data can be obtained through it.  The <i>MQTTClient: loop ()</i> method was created to periodically check for data in the channel and call callback functions to process new messages.  Since the Linux channel will be blocked, if nothing happens, we made the channels non-blocking.  Thus, if when checking in the <i>MQTTClient: loop ()</i> method that the channel is empty, an immediate return from the method will occur.  The pseudo-code below shows a typical use of the MQTTClient class. <br><br><pre> <code class="hljs lua">#include &lt;MQTTClient.h&gt; #define SAMPLING_PERIOD   <span class="hljs-number"><span class="hljs-number">100</span></span> #define PUBLISH_INTERVAL  <span class="hljs-number"><span class="hljs-number">30000</span></span> MQTTClient mqttClient; void setup() {  mqttClient.begin(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>,<span class="hljs-number"><span class="hljs-number">1833</span></span>,PSK,NULL,<span class="hljs-string"><span class="hljs-string">"psk_user"</span></span>,<span class="hljs-string"><span class="hljs-string">"psk_password"</span></span>);  mqttClient.subscribe(<span class="hljs-string"><span class="hljs-string">"edison/#"</span></span>,myCallBack); } void myCallBack(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* message) {  //    , ,   } unsigned long publishTime = millis(); void loop() {  mqttClient.loop();        //       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() &gt; publishTime) {      publishTime = millis() + PUBLISH_INTERVAL;      mqttClient.publish(<span class="hljs-string"><span class="hljs-string">"edison/sensor1"</span></span>,<span class="hljs-string"><span class="hljs-string">"sensor1value"</span></span>);      mqttClient.publish(<span class="hljs-string"><span class="hljs-string">"edison/sensor2"</span></span>,<span class="hljs-string"><span class="hljs-string">"sensor2value"</span></span>);  }  delay(SAMPLING_PERIOD); }</code> </pre> <br>  The variable " <i>SAMPLING_PERIOD</i> " sets the frequency with which new messages will be checked.  The value of this variable should be chosen so that the messages that should trigger any actions by the Arduino program arrive not too late and do not lose their meaning. <br><br>  Most of the working time, the <i>MQTTClietn: loop ()</i> method will end very quickly, so frequently invoking this method will create a very small load on the system.  The interval with which messages are published is set using the variable ‚Äú <i>PUBLISH_INTERVAL</i> ‚Äù.  The duration of the interval should correspond to the frequency with which the sensors publish data.  For example, a temperature sensor may publish room temperature information once a minute, if its indicators are used for informational purposes.  But the smoke detector makes sense to publish data every few seconds so that the subscriber, who is waiting for his messages, in the event of the sensor triggered, has a chance to do something before it is too late. <br><br>  Here is the implementation of the MQTTClient class. <br><br><pre> <code class="hljs lua">// : MQTTClient.cpp #include <span class="hljs-string"><span class="hljs-string">"MQTTClient.h"</span></span> #include &lt;fcntl.h&gt; /*====================================================================== / ========================================================================*/ MQTTClient::MQTTClient() { } MQTTClient::~MQTTClient() { <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); } void MQTTClient::<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spipe) {   fclose(spipe); } } /*======================================================================== .             ==========================================================================*/ void MQTTClient::begin(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *broker, int port, security_mode smode,                      <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* cafile, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *user, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *psk) { strcpy(mqtt_broker, broker); serverPort = port; mode = smode; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == SSL) {   strcpy(certificate_file, cafile); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == PSK) {   strcpy(psk_identity, user);   strcpy(psk_password, psk); } Serial.println(<span class="hljs-string"><span class="hljs-string">"MQTTClient initialized"</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Broker: "</span></span>); Serial.println(mqtt_broker); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Port:   "</span></span>); Serial.println(serverPort); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Mode:   "</span></span>); Serial.println(mode); } /*=======================================================================   , (*callback)  ,   ,    . =========================================================================*/ boolean MQTTClient::subscribe(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic,                             void (*callback)(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* message)) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> cmdString[<span class="hljs-number"><span class="hljs-number">256</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mqtt_broker == NULL) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic == NULL) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } callback_function = callback; switch(mode) {   case OPEN:     sprintf(cmdString,             <span class="hljs-string"><span class="hljs-string">"mosquitto_sub -h %s -p %d -t %s -v"</span></span>,             mqtt_broker, serverPort, topic);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   case SSL:     sprintf(cmdString,             <span class="hljs-string"><span class="hljs-string">"mosquitto_sub -h %s -p %d -t %s -v --cafile %s"</span></span>,              mqtt_broker, serverPort, topic, certificate_file);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   case PSK:     sprintf(cmdString,             <span class="hljs-string"><span class="hljs-string">"mosquitto_sub -h %s -p %d -t %s -v --psk-identity %s --psk %s"</span></span>,             mqtt_broker, serverPort, topic, psk_identity, psk_password);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   default:     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((spipe = (FILE*)<span class="hljs-built_in"><span class="hljs-built_in">popen</span></span>(cmdString, <span class="hljs-string"><span class="hljs-string">"r"</span></span>)) != NULL) {   //         int fd    = fileno(spipe);   int flags = fcntl(fd, F_GETFL, <span class="hljs-number"><span class="hljs-number">0</span></span>);   flags |= O_NONBLOCK;   fcntl(fd, F_SETFL, flags);   strcpy(topicString, topic);   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } /*==================================================================== ,     ,  ,         .  ,   . ======================================================================*/ boolean MQTTClient::loop() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fgets(dataBuffer, sizeof(dataBuffer), spipe)) {      parseDataBuffer();      callback_function(topic, message); } } /*====================================================================     . ======================================================================*/ boolean MQTTClient::publish(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *topic, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *message) { FILE*   ppipe; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>    cmdString[<span class="hljs-number"><span class="hljs-number">256</span></span>]; boolean retval = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this-&gt;mqtt_broker == NULL) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic == NULL) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } switch (this-&gt;mode) {   case OPEN:     sprintf(cmdString,             <span class="hljs-string"><span class="hljs-string">"mosquitto_pub -h %s -p %d -t %s -m \"%s\" %s"</span></span>,             mqtt_broker, serverPort, topic, message, retain_flag?<span class="hljs-string"><span class="hljs-string">"-r"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   case SSL:     sprintf(cmdString,             <span class="hljs-string"><span class="hljs-string">"mosquitto_pub -h %s -p %d --cafile %s -t %s -m \"%s\" %s"</span></span>,              mqtt_broker, serverPort, certificate_file,              topic, message, retain_flag?<span class="hljs-string"><span class="hljs-string">"-r"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   case PSK:     sprintf(cmdString,         <span class="hljs-string"><span class="hljs-string">"mosquitto_pub -h %s -p %d --psk-identity %s --psk %s -t %s -m \"%s\" %s"</span></span>,             mqtt_broker, serverPort, psk_identity, psk_password,             topic, message, retain_flag?<span class="hljs-string"><span class="hljs-string">"-r"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(ppipe = (FILE *)<span class="hljs-built_in"><span class="hljs-built_in">popen</span></span>(cmdString, <span class="hljs-string"><span class="hljs-string">"w"</span></span>))) {   retval = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fputs(cmdString, ppipe) != EOF) {   retval = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   retval = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } fclose(ppipe); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retval; } /*======================================================================    ,        .    .         , ,         NULL ========================================================================*/ void MQTTClient::parseDataBuffer() { topic   = dataBuffer; message = dataBuffer; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>((*message) != <span class="hljs-number"><span class="hljs-number">0</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*message) == <span class="hljs-number"><span class="hljs-number">0x20</span></span>) {     //     NULL     (*message) = <span class="hljs-number"><span class="hljs-number">0</span></span>;     message++;     <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;   }   <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     message++;   } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen(message) == <span class="hljs-number"><span class="hljs-number">0</span></span>) {   topic   = NULL;   message = dataBuffer; } } &lt;h2&gt; &lt;/h2&gt;</code> </pre><br>  In one of the previous publications we talked about the assembly of a sensor node with sensors and actuators.  Namely, this is what the device consists of, which then turned out to be created: <br><br><ol><li>  Motion sensor for motion detection. <br></li><li>  Temperature sensor that allows you to measure the ambient temperature. <br></li><li>  Light sensor that measures light. <br></li><li>  Command button that allows you to recognize targeted user actions.  In this case - pressing the button. <br></li><li>  Red LED that turns on and off in response to button presses. <br></li><li>  Green LED that turns on when a motion sensor is triggered. <br></li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aa5/2a5/366/aa52a5366e299d73a8cd54614f895b0b.jpg"></div><br>  <i><font color="#999999">Intel Edison Touch Node</font></i> <br><br>  Using MQTT, we will periodically publish indicators of various sensors, transmitting messages to the Mosquitto broker, which runs on the same Intel Edison system.  Subscribe to all topics, that is, to "edison / #".  In addition, we will make some changes in the logic of the sensor node: <br><br><ol><li>  The command button will no longer turn on and off the red LED.  Now clicking on it will serve as a signal to change the value of the logical variable that will be transmitted to the subscribers of MQTT. <br><br></li><li>  The red LED will turn on and off using MQTT messages.  Such a mechanism can play the role of an access module for a lighting device that can be controlled via the Internet. <br><br></li><li>  The behavior of the green LED can be configured using MQTT.  Namely, it will be possible to make it turn on when the motion sensor is triggered, or stay off all the time. <br></li></ol><br>  Here is the main sketch code. <br><br><pre> <code class="hljs markdown">// : MQTT<span class="hljs-emphasis"><span class="hljs-emphasis">_IoT_</span></span>Sensor.ino /<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">***       ,    Intel Edison **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">*/ #include &lt;stdio.h&gt; #include &lt;Arduino.h&gt; #include "sensors.h" #include "MQTTClient.h" //   unsigned long          updateTime = 0; //    volatile unsigned long activityMeasure; volatile unsigned long activityStart; volatile boolean       motionLED = true; unsigned long          resetActivityCounterTime; //   boolean                toggleLED = false; volatile unsigned long previousEdgeTime = 0; volatile unsigned long count = 0; volatile boolean       arm_alarm = false; // MQTT- #define SECURE_MODE     2 MQTTClient              mqttClient; char                    fmtString[256];     //   char                    topicString[64];    //    char                    msgString[64];      //  /*</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">*  *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**/ void setup() { Serial.begin(115200); delay(3000); Serial.println("Ready"); pinMode(RED_LED,    OUTPUT); pinMode(GREEN_LED,  OUTPUT); pinMode(BUTTON,     INPUT_PULLUP); pinMode(PIR_SENSOR, INPUT); //  .      attachInterrupt(BUTTON,     buttonISR, RISING);  //   .        attachInterrupt(PIR_SENSOR, pirISR,    CHANGE); digitalWrite(RED_LED,  HIGH); digitalWrite(GREEN_LED,LOW); resetActivityCounterTime = 0; //  MQTTClient #if ( SECURE_MODE == 0 ) Serial.println("No security"); mqttClient.begin("localhost", 1883, OPEN, NULL, NULL, NULL); #elif ( SECURE_MODE == 1 ) Serial.println("SSL security"); mqttClient.begin("localhost", 1994, SSL,                  "/home/mosquitto/certs/ca.crt", NULL, NULL); #elif ( SECURE_MODE == 2 ) Serial.println("TLS-PSK security"); mqttClient.begin("localhost", 1995, PSK, NULL, "user", "deadbeef"); #endif //      edison mqttClient.subscribe("edison/#", mqttCallback); mqttClient.publish("edison/bootMsg","Booted"); digitalWrite(RED_LED, LOW); } /**</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**    MQTT **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**/ void mqttCallback(char* topic, char* message) { sprintf(fmtString, "mqttCallback(), topic: %s, message: %s",topic,message); Serial.print(fmtString); //   if (strcmp(topic,"edison/LED") == 0) {   //       if (message[0] == 'H') {     digitalWrite(RED_LED, HIGH);     toggleLED = false;   }   else if (message[0] == 'L') {     digitalWrite(RED_LED, LOW);     toggleLED = false;   }   else if (message[0] == 'B') {     toggleLED = true;   } } if (strcmp(topic, "edison/motionLED") == 0) {   //    ,         //   .   //  strncmp  ,       if (strncmp(message, "OFF", 3) == 0) {     digitalWrite(GREEN_LED, LOW);     motionLED = false;   }   else if (strncmp(message, "ON", 2) == 0) {     motionLED = true;   } } } /**</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">****   **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">***</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">*/ void loop() {   // ,      mqtt_sub   mqttClient.loop();     if (millis() &gt; resetActivityCounterTime) {     resetActivityCounterTime = millis() + 60000;     //    ,        sprintf(msgString,"%.0f",100.0*</span></span>activityMeasure/60000.0);     mqttClient.publish("edison/ActivityLevel",msgString);     activityMeasure = 0;   }   if (millis() &gt; updateTime) {     updateTime = millis() + 10000;        //         sprintf(msgString,"%.1f",readTemperature(TEMP<span class="hljs-emphasis"><span class="hljs-emphasis">_SENSOR));     mqttClient.publish("edison/Temperature",msgString);         //         sprintf(msgString,"%d",readLightSensor(LIGHT_</span></span>SENSOR));     mqttClient.publish("edison/LightSensor",msgString);         //  arm<span class="hljs-emphasis"><span class="hljs-emphasis">_alarm     sprintf(msgString,"%s", (arm_</span></span>alarm == true)? "ARMED"  : "NOTARMED");     mqttClient.publish("edison/alarm<span class="hljs-emphasis"><span class="hljs-emphasis">_status", msgString);   }     if (toggleLED == true) {     digitalWrite(RED_</span></span>LED, digitalRead(RED_LED) ^ 1);   }   delay(100); }</code> </pre> <br>        . ,     ,    ,   , <i>sensor.h</i>  <i>sensor.cpp</i> . <br><br>   <i>SECURE_MODE</i>  Arduino-     .   , <i>mqttCallback(),</i>   ,      MQTT-. ,    ,   ,    .     ,  ,         ,   . <br><br>    ‚Äì   ,   IoT- .       ¬´edison/LED¬ª       ,         .    ¬´edison/motionLED¬ª      .       ,     . <br><br><pre> <code class="hljs pgsql">// : sensors.h // #define USE_TMP036     <span class="hljs-number"><span class="hljs-number">0</span></span> #define RED_LED       <span class="hljs-number"><span class="hljs-number">10</span></span>            //   #define GREEN_LED     <span class="hljs-number"><span class="hljs-number">11</span></span>            //   #define BUTTON        <span class="hljs-number"><span class="hljs-number">13</span></span>            //       <span class="hljs-number"><span class="hljs-number">10</span></span>K #define PIR_SENSOR    <span class="hljs-number"><span class="hljs-number">12</span></span>            //    #define LIGHT_SENSOR  A0            //   #define TEMP_SENSOR   A1            //   TMP36  LM35 #define MIN_PULSE_SEPARATION     <span class="hljs-number"><span class="hljs-number">200</span></span>   //     #define ADC_STEPSIZE             <span class="hljs-number"><span class="hljs-number">4.61</span></span>  //  ,     . #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (USE_TMP036 == <span class="hljs-number"><span class="hljs-number">1</span></span>) #define TEMP_SENSOR_OFFSET_VOLTAGE       <span class="hljs-number"><span class="hljs-number">750</span></span> #define TEMP_SENSOR_OFFSET_TEMPERATURE   <span class="hljs-number"><span class="hljs-number">25</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> // LM35 temperature sensor #define TEMP_SENSOR_OFFSET_VOLTAGE        <span class="hljs-number"><span class="hljs-number">0</span></span> #define TEMP_SENSOR_OFFSET_TEMPERATURE    <span class="hljs-number"><span class="hljs-number">0</span></span> #endif //   extern unsigned long          updateTime; //    extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> unsigned long activityMeasure; extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> unsigned long activityStart; extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">boolean</span></span>       motionLED; extern unsigned long          resetActivityCounterTime; //   extern <span class="hljs-type"><span class="hljs-type">boolean</span></span>                toggleLED; extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> unsigned long previousEdgeTime; extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> unsigned long count; extern <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">boolean</span></span>       arm_alarm; <span class="hljs-type"><span class="hljs-type">float</span></span> readTemperature(<span class="hljs-type"><span class="hljs-type">int</span></span> analogPin); <span class="hljs-type"><span class="hljs-type">int</span></span>   readLightSensor(<span class="hljs-type"><span class="hljs-type">int</span></span> analogPin); <span class="hljs-type"><span class="hljs-type">void</span></span>  buttonISR(); <span class="hljs-type"><span class="hljs-type">void</span></span>  pirISR(); // : sensors.cpp #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;Arduino.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "sensors.h" <span class="hljs-comment"><span class="hljs-comment">/***********************************************************************************    ,    ,     HIGH      ,   .   ,     HIGH  2-3 ,     LOW.        HIGH,       .               ************************************************************************************/</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> pirISR() { <span class="hljs-type"><span class="hljs-type">int</span></span> pirReading; unsigned long <span class="hljs-type"><span class="hljs-type">timestamp</span></span>; <span class="hljs-type"><span class="hljs-type">timestamp</span></span> = millis(); pirReading = digitalRead(PIR_SENSOR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pirReading == <span class="hljs-number"><span class="hljs-number">1</span></span>) {   //      activityStart = <span class="hljs-type"><span class="hljs-type">timestamp</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {   <span class="hljs-type"><span class="hljs-type">int</span></span> pulseWidth = <span class="hljs-type"><span class="hljs-type">timestamp</span></span>-activityStart;   activityMeasure += pulseWidth; } //   ,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (motionLED == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) {   digitalWrite(GREEN_LED, pirReading); } } <span class="hljs-comment"><span class="hljs-comment">/************************************************************************     ************************************************************************/</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> readLightSensor(<span class="hljs-type"><span class="hljs-type">int</span></span> sensorPin) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> analogRead(sensorPin); } <span class="hljs-comment"><span class="hljs-comment">/***********************************************************************        ***********************************************************************/</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> readTemperature(<span class="hljs-type"><span class="hljs-type">int</span></span> sensorPin) { <span class="hljs-type"><span class="hljs-type">int</span></span>   sensorReading; <span class="hljs-type"><span class="hljs-type">float</span></span> temperature; sensorReading = analogRead(sensorPin); //    temperature = sensorReading * ADC_STEPSIZE; //   LM35,  TMP036,   : // <span class="hljs-number"><span class="hljs-number">10</span></span>     //    LM35 ‚Äì <span class="hljs-number"><span class="hljs-number">0</span></span> ,  TMP036 - <span class="hljs-number"><span class="hljs-number">750</span></span>  //    LM35 ‚Äì <span class="hljs-number"><span class="hljs-number">0</span></span>  ,  TMP036 ‚Äì <span class="hljs-number"><span class="hljs-number">25</span></span> . temperature = (temperature - TEMP_SENSOR_OFFSET_VOLTAGE)/<span class="hljs-number"><span class="hljs-number">10.0</span></span> +                TEMP_SENSOR_OFFSET_TEMPERATURE; //     temperature = temperature * <span class="hljs-number"><span class="hljs-number">1.8</span></span> + <span class="hljs-number"><span class="hljs-number">32.0</span></span>;        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temperature; } <span class="hljs-comment"><span class="hljs-comment">/*************************************************************************     **************************************************************************/</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> buttonISR() { //        ,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis()-previousEdgeTime) &gt;= MIN_PULSE_SEPARATION) {   arm_alarm = !arm_alarm;   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("Alarm is: ");   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arm_alarm == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) {     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("ARMED");   }   <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("NOT ARMED");   }   count++;   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("Count: "); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(count); } previousEdgeTime=millis(); }</code> </pre> <br><h2> <font color="#0071c5"></font> </h2><br>    ,        ,   MQTT-    ,     ,     ‚Äì   ,     . <br><br>  Edison    SSH    <i>mosquitto_sub/pub</i>          .     -,     Mosquitto. <br> ,      . <br><br>  ,    ,    : <br><br><pre> <code class="hljs ruby">$&gt; mosquitto_sub ‚Äìh ipaddr ‚Äìp <span class="hljs-number"><span class="hljs-number">1883</span></span> ‚Äìt edison/<span class="hljs-comment"><span class="hljs-comment"># -v</span></span></code> </pre> <br>  <i>ipaddr</i> ‚Äì  IP-  Intel Edison.      Edison,    IP-   ¬´localhost¬ª.          , 1883.     1994,   SSL-.     1995,   PSK,      .      ¬´edison/#¬ª            ,    . <br><br>  ,    ,     ¬´edison/LED¬ª,     ,    ¬´edison/motionLED¬ª,         . <br><br><pre> <code class="hljs pgsql">$&gt; mosquitto_pub ‚Äìh ipaddr ‚Äìp <span class="hljs-number"><span class="hljs-number">1883</span></span> ‚Äìt Edison/LED ‚Äìm {H, L, B} $&gt; mosquitto_pub ‚Äìh ipaddr ‚Äìp <span class="hljs-number"><span class="hljs-number">1883</span></span> ‚Äìt Edison/motionLED ‚Äìm {<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>}</code> </pre> <br>        (H, L, B)  ,   . <br>  ,    ,  ,       ,   ON  OFF. <br><br>   <a href=""></a> ,     . <br><br><h2>  <font color="#0071c5">findings</font> </h2><br>    ,      , Mosquitto MQTT,             Linux   Intel Edison.         ,    Arduino      .  Linux, ,   ,    Arduino-,       ,   Linux. </div><p>Source: <a href="https://habr.com/ru/post/283440/">https://habr.com/ru/post/283440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283424/index.html">Introduction to OAuth (in simple words)</a></li>
<li><a href="../283428/index.html">Come to the meetings of the IT communities in your cities</a></li>
<li><a href="../283430/index.html">All-Russian Engineering Olympiad for high school students: BigData and Intelligent Energy Systems</a></li>
<li><a href="../283432/index.html">Autodocumenting Perfect Server</a></li>
<li><a href="../283436/index.html">Connect to the webinar: "SQL Server 2016 Data Management Platform." Beginning May 13 at 11:00 (Moscow time)</a></li>
<li><a href="../283442/index.html">Google I / O Extended 2016</a></li>
<li><a href="../283444/index.html">Who and how earns on public public financial data?</a></li>
<li><a href="../283446/index.html">Back to the future: Megamind returns to Habrahabr</a></li>
<li><a href="../283448/index.html">Antivirus as a threat</a></li>
<li><a href="../283450/index.html">Functional Rust: Cooking Beef</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>