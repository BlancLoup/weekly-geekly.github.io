<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx + PHP-FPM vs. Apache2 Prefork + mod_php</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with this topic on the forum , when many seriously began to argue, they say, nginx is not at all faster than Apache, and even the trans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx + PHP-FPM vs. Apache2 Prefork + mod_php</h1><div class="post__text post__text-html js-mediator-article"> It all started with <a href="http://forum.searchengines.ru/showthread.php%3Ft%3D438004">this topic on the forum</a> , when many seriously began to argue, they say, nginx is not at all faster than Apache, and even the translation of documentation from the official site was not convincing.  As you know, there is nothing more enjoyable than testing and displaying a graph to attract attention.  For example, the graph for the total load on the server, try to guess where is the Nginx testing stage, and where is Apache. <br><img src="http://pix.org.ua/userimages/registered/1_1261689194_313_localhost.localdomain-load-day.png" alt="image"><br>  Well, before you find out the right answer - a little about the server and the testing mechanism. <br>  In order to eliminate any suspicion of ‚Äúspinning up‚Äù their VDS, the test was conducted on a third-party server, which was kindly provided to me by one of the forum participants for this test in this configuration: <br>  <b>AMD Athlon X2 5600+ 4 GB DDR2 2 √ó 400 GB HDD</b> with Linux Debian in minimal install.  All software was installed in a standard way - via apt-get.  Both PHP and Apache were set in minimal mode. <br>  For the test object, I set up a very light blog, Moscquito, which works without MySQL, writing a couple of posts and comments there. <br><a name="habracut"></a><br>  First of all I want to say that before starting the benchmark Nginx and Apache, I restarted the server.  The network subsystem was a little twisted up for faster work: <br> <code>sysctl -w net.core.rmem_max=16777216 <br> sysctl -w net.core.wmem_max=16777216 <br> sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216" <br> sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216" <br> sysctl -w sysctl net.ipv4.tcp_window_scaling=1 <br> sysctl -w sysctl net.ipv4.tcp_timestamps=1 <br> sysctl -w sysctl net.ipv4.tcp_sack=1 <br> sysctl -w net.ipv4.tcp_no_metrics_save=1 <br> sysctl -w net.ipv4.tcp_moderate_rcvbuf=1 <br> sysctl -w net.core.netdev_max_backlog=1000 <br> sysctl -w net.ipv4.tcp_congestion_control=htcp <br> sysctl -w net.core.somaxconn=1000 <br> ifconfig eth0 txqueuelen 1000 <br></code> <br>  And the limits were raised for the correct operation of the tested and benchmarks themselves: <br> <code>ulimit -s unlimited <br> ulimit -n 1024000 <br></code> <br>  For both web servers, the timeout was set to 300 seconds (standard for Apache, it is less in Nginx). <br><br><h5>  PHP-FPM </h5><br>  The processes were tied to a TCP socket, two pools were created with 4 processes each in a static mode. <br><br><h5>  nginx </h5><br>  Two workers on 10240 connections each, php is connected as upstream: <br> <code>upstream php { <br> server 127.0.0.1:9000 max_fails=1 fail_timeout=60s; <br> server 127.0.0.1:9001 max_fails=1 fail_timeout=60s; <br> } <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Apache </h5><br>  Keepalive is disabled, and MaxClients and ServerLimit are set to 10240 <br><br><h4>  Now about the benchmark </h4><br>  I tried to create a site situation under a DDOS attack, when 20k bots were hammering into the main page, and 5,000 legal users walk through the site. <br>  An improvised DDOS attack can be easily done with ab.  But for users it was necessary to generate <a href="http://www.xml-sitemaps.com/download/213.239.211.15/urllist.txt">a site map</a> and set siege on it. <br><br>  Testing took an hour and the site availability record was logged using ab.  Here are the two commands that I launched in parallel in the screen: <br> <code><a href="http://213.239.211.15/"></a> while true; do ab -r -t 300 -n 20000 -c 20000 213.239.211.15 &gt;&gt; nginx.log; sleep 5; done <br> <br> while true; do siege -i -f urllist.txt -c 5000 -b -t1M ; sleep 5; done</code> <br> <br>  Naturally, for a benchmark with an apache, the log was written in apache.log <br><br><h5>  Go to the charts </h5><br><br><img src="http://pix.org.ua/userimages/registered/1_1261689194_50_localhost.localdomain-processes-day.png" alt="image"><br>  As you can see, the number of processes changed only while Apache was running, well, it was not for nothing that MPM was called Prefork.  Nginx and PHP-FPM are static, which is a big plus. <br><br><img src="http://pix.org.ua/userimages/registered/1_1261689194_680_localhost.localdomain-memory-day.png" alt="image"><br>  Unfortunately, the memory graph turned out to be not very beautiful, but if you look closely, Apache consumes more memory. <br><br><img src="http://pix.org.ua/userimages/registered/1_1261689194_714_localhost.localdomain-interrupts-day.png" alt="image"><br><img src="http://pix.org.ua/userimages/registered/1_1261689194_30_localhost.localdomain-forks-day.png" alt="image"><br>  The graphs of switching between processes and their forks correlate very interestingly among themselves. <br><br><img src="http://pix.org.ua/userimages/registered/1_1261689194_677_localhost.localdomain-cpu-day.png" alt="image"><br>  The layout for recycling CPU is also clearly not in favor of Apache. <br><br><h4>  Break through the logs </h4><br><h5>  Nginx: </h5><br><pre> # grep -c Failed nginx.log 
 38
 # grep Failed nginx.log |  grep -v 'Failed requests: 0'
 Failed requests: 10629
</pre><br><br>  Decryption - in an hour of work, a bunch of Nginx + PHP-FPM managed to go through 38 iterations and fill up one of them - 10,629 erroneous requests.  This was due to the inaccessibility of upstream - siege tried, running most of the requests to the main page. <br><br><h5>  Apache: </h5><br><pre> # grep -c Failed apache.log 
 23
 # grep Failed apache.log |  grep -v 'Failed requests: 0'
 Failed requests: 8730
 Failed requests: 2124
 Failed requests: 10539
 Failed requests: 7599
 Failed requests: 6027
 Failed requests: 1986
 Failed requests: 7578
 Failed requests: 270
 Failed requests: 9819
 Failed requests: 60
 Failed requests: 9369
 Failed requests: 8193
 Failed requests: 10248
 Failed requests: 684
 Failed requests: 7968
</pre><br><br>  But with Apache everything is bad - even if we cross out 2 ‚Äúsuccessful‚Äù siege hits, there are still errors + in the allotted time fewer requests were made. <br><br>  Thus, according to the test results, the Nginx + PHP-FPM bundle defeats Apache with a score of 38:23 </div><p>Source: <a href="https://habr.com/ru/post/79225/">https://habr.com/ru/post/79225/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../79217/index.html">byfly lowered the price for unlimited internet</a></li>
<li><a href="../79218/index.html">pkaÃ∂vlÃ∂inÃ∂yÃ∂ DHL, speak?</a></li>
<li><a href="../79219/index.html">Secret experiences of Wasserman-2 or Again advertising</a></li>
<li><a href="../79220/index.html">Application for reading habr offline</a></li>
<li><a href="../79222/index.html">Your dream computer</a></li>
<li><a href="../79227/index.html">Smashing book</a></li>
<li><a href="../79228/index.html">Install and configure Perl on IIS 7.x</a></li>
<li><a href="../79231/index.html">Using the capabilities of the Windows platform in PHP</a></li>
<li><a href="../79232/index.html">Unusual videos-Chariot Skates</a></li>
<li><a href="../79233/index.html">Compiling a 64-bit version of Qt for windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>