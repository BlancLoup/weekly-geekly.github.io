<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby integration into Nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a long time there is a well-known bundle of Nginx + Lua, including a number of articles here. But time does not stand still. About a year ago, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby integration into Nginx</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3ef/1d4/f86/3ef1d4f8653041ab3baa2c4a1f419065.png"><br><br>  For a long time there is a well-known bundle of Nginx + Lua, including a number of articles here.  But time does not stand still.  About a year ago, the first version of the module that integrates Ruby into Nginx appeared. <br><a name="habracut"></a><br><h4>  MRuby </h4><br>  For the integration, not a full-fledged Ruby was chosen, but its subset, which is intended to be embedded in other applications, devices, and so on.  It has some limitations, but otherwise full-featured Ruby.  The project is called <a href="http://mruby.org/">MRuby</a> .  Currently it has version 1.0.0, i.e.  considered stable. <br>  MRuby does not allow other files to be connected at runtime, so the entire program must be in one file.  At the same time, it is possible to convert the program into bytecode and execute it already, which has a positive effect on performance. <br>  Since  there is no possibility to load other files, then existing gems are not suitable for it.  To extend the functionality, its own format is used, which is both C code and Ruby in places.  These modules are assembled with the library itself at compile time and are an integral part of it.  There are binding to various databases, to work with files, network, and so on.  The full list is available on the website. <br>  Also there is a module that allows you to integrate this engine in Nginx, which is particularly interested. <br><br><h4>  ngx_mruby </h4><br>  So, get acquainted: <a href="http://ngx.mruby.org/">ngx_mruby</a> .  A module for connecting ruby ‚Äã‚Äãscripts to nginx.  It has similar functionality with the Lua version.  Allows you to perform operations at various stages of processing a request. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The module is going quite simply, there is a detailed instruction on the site.  Who does not want to bother with the assembly, can download the finished package: <br>  <a href="">http://mruby.ajieks.ru/st/nginx_1.4.4-1~mruby~precise_amd64.deb</a> <br>  MRuby in this assembly contains the following additional modules: <br><ul><li>  <a href="https://github.com/iij/mruby-io">github.com/iij/mruby-io</a> </li><li>  <a href="https://github.com/iij/mruby-env">github.com/iij/mruby-env</a> </li><li>  <a href="https://github.com/iij/mruby-dir">github.com/iij/mruby-dir</a> </li><li>  <a href="https://github.com/iij/mruby-process">github.com/iij/mruby-process</a> </li><li>  <a href="https://github.com/iij/mruby-pack">github.com/iij/mruby-pack</a> </li><li>  <a href="https://github.com/iij/mruby-digest">github.com/iij/mruby-digest</a> </li><li>  <a href="https://github.com/mattn/mruby-json">github.com/mattn/mruby-json</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-redis">github.com/matsumoto-r/mruby-redis</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-vedis">github.com/matsumoto-r/mruby-vedis</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-sleep">github.com/matsumoto-r/mruby-sleep</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-userdata">github.com/matsumoto-r/mruby-userdata</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-uname">github.com/matsumoto-r/mruby-uname</a> </li><li>  <a href="https://github.com/mattn/mruby-onig-regexp">github.com/mattn/mruby-onig-regexp</a> </li><li>  <a href="https://github.com/matsumoto-r/mruby-discount">github.com/matsumoto-r/mruby-discount</a> </li></ul><br>  As you can see, there is almost everything you need for work.  The only thing that was not found in the API of this module is the ability to make a request out.  Most likely, you will need to implement it as an extension and make a binding around the nginx API. <br><br>  The author shows a beautiful graph with tests, but he did not find the environment configuration.  So just put it for beauty: <br><img src="https://habrastorage.org/getpro/habr/post_images/375/69a/3c1/37569a3c16a3794c7a84efd106f6a4dc.png" alt="image"><br><br><h4>  Let's try to use </h4><br>  So, the server is already installed.  Everything functions, static is given.  Add a little to this dynamics. <br>  As an example, I chose the task of parsing Markdown markup and return it to HTML without an additional server application.  As well as line numbers in the source code for Ruby. <br>  For this, a sinatra clone repository was made and nginx was configured to solve the problem. <br><br><h5>  Markdown </h5><br>  To handle the markup, we use the mruby-discount module that is connected to the assembly.  It provides a simple class for working with markup.  It is based on the C library of the same name, so I think it will not be a question of productivity. <br>  To begin with, we will write a program that will read the requested file from the disk, process it and give it to the user. <br><pre><code class="ruby hljs">r = Nginx::Request.new m = Discount.new(<span class="hljs-string"><span class="hljs-string">"/st/style.css"</span></span>, <span class="hljs-string"><span class="hljs-string">"README"</span></span>) filename = r.filename filename = File.join(filename, <span class="hljs-string"><span class="hljs-string">'README.md'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> filename.end_with?(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) markdown = File.exists?(filename) ? File.read(filename) : <span class="hljs-string"><span class="hljs-string">''</span></span> Nginx.rputs m.header Nginx.rputs m.md2html(markdown) Nginx.rputs m.footer</code> </pre> <br>  The first line is an instance of the request object, containing all the necessary information, including the requested file, headers, URLs, URIs, etc. <br>  The next line creates an instance of the Discount class, indicating the style file and the page title. <br>  This code does not handle 404 errors, so even if there is no file, there will always be a 200 return code. <br>  Now we connect all this <br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.md$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Type text/html; <span class="hljs-attribute"><span class="hljs-attribute">mruby_content_handler</span></span> <span class="hljs-string"><span class="hljs-string">"/opt/app/parse_md.rb"</span></span> cache; }</code> </pre><br>  Result: <br>  <a href="http://mruby.ajieks.ru/sinatra/">mruby.ajieks.ru/sinatra</a> <br>  <a href="">mruby.ajieks.ru/sinatra/README.ru.md</a> <br><br><h5>  Ruby files </h5><br>  Originally I planned to do more than just numbering, as well as coloring the code using the once written code <a href="https://github.com/fuCtor/chalks">https://github.com/fuCtor/chalks</a> .  However, after all the adaptations made, problems arose in his work.  The code, it seems, worked, but at a certain stage fell from the Segmentation fault.  The initial suspicion was the lack of memory allocated, but even after reducing its consumption, the problem did not disappear.  After removing the code associated with the coloring, everything worked, but not as beautiful as we wanted. <br><div class="spoiler">  <b class="spoiler_title">Result of change</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TABLE_FOR_ESCAPE_HTML__</span></span></span><span class="hljs-class"> = {"&amp;"=&gt;"&amp;", '"'=&gt;""", "&lt;"=&gt;"&lt;", "&gt;"=&gt;"&gt;"} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">escapeHTML</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gsub</span></span></span><span class="hljs-class">(/[&amp;\"&lt;&gt;]/) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ch</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TABLE_FOR_ESCAPE_HTML__</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ch</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ord</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bytes</span></span></span><span class="hljs-class">[0] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chalk</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">COMMENT_START_CHARS</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ruby</span></span></span><span class="hljs-class">: /</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#./, cpp: /\/\*|\/\//, c: /\/\// } COMMENT_END_CHARS = { cpp: /\*\/|.\n/, ruby: /.\n/, c: /.\n/, } STRING_SEP = %w(' ") SEPARATORS = " @(){}[],.:;\"\'`&lt;&gt;=+-*/\t\n\\?|&amp;#" SEPARATORS_RX = /[@\(\)\{\}\[\],\.\:;"'`\&lt;\&gt;=\+\-\*\/\t\n\\\?\|\&amp;#]/ def initialize(file) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@filename</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = file </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = File.new(file) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rnd</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Random.new(file.hash) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@tokens</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = {} reset end def parse &amp;block reset() </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.read.each_char do |char| </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple = ((</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple.size &lt; 2) ? </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple : </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple[1]) + char case(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment">) when :source if start_comment?(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = :comment elsif STRING_SEP.include?(char) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@string</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_started_with = char </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = :string else process_entity(&amp;block) if (</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.length == 1 &amp;&amp; SEPARATORS.index(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment">)) || SEPARATORS.index(char) end when :comment process_entity(:source, &amp;block) if end_comment?(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple) when :string if (STRING_SEP.include?(char) &amp;&amp; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@string</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_started_with == char) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> += char process_entity(:source, &amp;block) char = '' elsif char == '\\' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = :escaped_char else end when :escaped_char </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = :string end </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> += char end end def to_html(&amp;block) html = '' if block block.call( '&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;pre&gt;' ) else html = '&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;pre&gt;' end line_n = 1 </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.readlines.each do if block block.call( "&lt;a href='#'&gt;&lt;b&gt;#{line_n}&lt;/b&gt;&lt;/a&gt;\n" ) else html += "&lt;a href='#'&gt;&lt;b&gt;#{line_n}&lt;/b&gt;&lt;/a&gt;\n" end line_n += 1 end </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = File.open(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@filename</span></span></span></span><span class="hljs-class"><span class="hljs-comment">) if block block.call( '&lt;/pre&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;' ) else html += '&lt;/pre&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;' end parse do |entity, type| entity = entity.gsub("\t", ' ') if block block.call( entity ) #block.call(highlight( entity , type)) else html += entity #html += highlight( entity , type) end end if block block.call( '&lt;/pre&gt;&lt;td&gt;&lt;/tr&gt;&lt;/table&gt;' ) else html + '&lt;/pre&gt;&lt;td&gt;&lt;/tr&gt;&lt;/table&gt;' end end def language </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@language</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> ||= case(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.path.to_s.split('.').last.to_sym) when :rb :ruby when :cpp, :hpp :cpp when :c, :h :c when :py :python else </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.path.to_s.split('.').last.to_s end end private def process_entity(new_state = nil, &amp;block) block.call </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment">, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> if block </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = '' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = new_state if new_state end def reset </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = File.open(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@filename</span></span></span></span><span class="hljs-class"><span class="hljs-comment">) if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@state</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = :source </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@string</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_started_with = '' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@entity</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = '' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_couple = '' end def color(entity) entity = entity.strip entity.gsub! SEPARATORS_RX, '' token = '' return token if entity.empty? #return token if token = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@tokens</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[entity] return '' if entity[0].ord &gt;= 128 rgb = [ </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rnd</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.rand(150) + 100, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rnd</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.rand(150) + 100, </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rnd</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.rand(150) + 100 ] token = String.sprintf("#%02X%02X%02X", rgb[0], rgb[1], rgb[2]) #token = "#%02X%02X%02X" % rgb #</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@tokens</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[entity] = token return token end def highlight(entity, type) esc_entity = CGI.escapeHTML( entity ) case type when :string, :comment "&lt;span class='#{type}'&gt;#{esc_entity}&lt;/span&gt;" else rgb = color(entity) if rgb.empty? esc_entity else "&lt;span rel='t#{rgb.hash}' style='color: #{rgb}' &gt;#{esc_entity}&lt;/span&gt;" end end end def start_comment?(char) rx = COMMENT_START_CHARS[language] char.match rx if rx end def end_comment?(char) rx = COMMENT_END_CHARS[language] char.match rx if rx end end</span></span></span></span></code> </pre><br></div></div><br>  And the actual code that reads the file and numbering: <br><pre> <code class="ruby hljs">r = Nginx::Request.new Nginx.rputs <span class="hljs-string"><span class="hljs-string">'&lt;html&gt;&lt;link rel="stylesheet" href="/st/code.css" type="text/css" /&gt;&lt;body&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ch = Chalk.new(r.filename) data = ch.to_html Nginx.rputs data <span class="hljs-keyword"><span class="hljs-keyword">rescue</span></span> =&gt; e Nginx.rputs e.message <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> Nginx.rputs <span class="hljs-string"><span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span></span></code> </pre><br>  We connect everything.  Since  class Chalk is used constantly, we will load it in advance: <br>  mruby_init '/opt/app/init.rb'; <br>  This line is added before the server section in the settings.  Next, we specify our handler: <br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.rb$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Type text/html; <span class="hljs-attribute"><span class="hljs-attribute">mruby_content_handler</span></span> <span class="hljs-string"><span class="hljs-string">"/opt/app/parse_code.rb"</span></span> cache; }</code> </pre><br>  Everything, now it is possible to look at result: <a href="">mruby.ajieks.ru/sinatra/lib/sinatra/main.rb</a> <br><br><h4>  Conclusion </h4><br>  Thus, it is possible to implement advanced query processing, filtering, and caching using another one of the languages.  Whether this module is ready for use in combat conditions, I do not know.  While testing, there have been hangs of the entire server, but there is a probability of curvature of the hands, or, nevertheless, not everything has been completely modified.  I will follow the development of the project. <br><br>  Those interested can drive on the performance of the scripts in the article on the links above. <br>  The server is deployed on DigitalOcean on the simplest machine, Ubuntu 12.04 x64.  Number of processes 2, connections 1024. No additional settings were made.  In case of server hangup, I restarted nginx every 10 minutes. </div><p>Source: <a href="https://habr.com/ru/post/225313/">https://habr.com/ru/post/225313/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225301/index.html">Russian Robotics Olympiad - hurry to take part!</a></li>
<li><a href="../225303/index.html">DevConf :: Ruby - June 14 - the program is generated</a></li>
<li><a href="../225305/index.html">Accelerate the development process with Vagrant</a></li>
<li><a href="../225307/index.html">EFF souvenirs for Tor owners</a></li>
<li><a href="../225309/index.html">Maxmertkit Perfect css framework</a></li>
<li><a href="../225323/index.html">HipHop: Popcorn Time analogue for music</a></li>
<li><a href="../225325/index.html">The history of the gaming market, part 1</a></li>
<li><a href="../225329/index.html">Levin took the oath on a digital copy of the US Constitution</a></li>
<li><a href="../225331/index.html">Extortionist for Android encrypts files on the device</a></li>
<li><a href="../225335/index.html">Intel introduced a prototype of a laptop with wireless charging, WiGig and passive cooling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>