<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C # / WPF + Pascal + Assembler: how I restored my first game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I rumbled once in my source code of school times, and found the following there: 


- A game on QBasic about a spacecraft shooting asteroids. Creepy c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C # / WPF + Pascal + Assembler: how I restored my first game</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1a8/644/5a2/1a86445a2214e7b61946ec364bfa20a4.gif"><br><br>  I rumbled once in my source code of school times, and found the following there: <br><ul><li>  A game on QBasic about a spacecraft shooting asteroids.  Creepy code under dos, but sprites are animated in 3ds max. </li><li>  Pascal / Assembler graphic library with good speed </li><li>  Licensed TMT Pascal compiler that can build Win32 code </li></ul><br>  Do not disappear the same good!  Next is the story of all this, a bit of nostalgia, and the details of the implementation of the ‚Äúmodern‚Äù version of the game using old sprites and graphics code. <br><a name="habracut"></a><br><h4>  A bit of history </h4><br><h5>  Basic </h5><br>  I first encountered programming at the school where we were taught <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25BE%25D0%25B3%25D0%25BE_(%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Logo</a> , then Basic, and then Pascal. <br><br>  It was on Basic that an interest in development came to me, and of course, I wanted to write my own game!  A screenshot of it is posted at the beginning of the post.  640x480, 256 colors, all sprites are animated (rotate in pseudo-3d), sound.  The Future library is used (you can still google on qbasic future).  The source code is preserved - 1552 lines, 19 uses of the GOTO operator.  The game was called Lander, by analogy with the classic game, where you need to land a spaceship on the planet.  But it‚Äôs boring to land a ship, you want to shoot and explode, so before landing you have to break through the asteroid belt with two types of weapons on board. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sprites drew himself in 3DS Max (asteroids are spheres with Fractal Noise, the rest are combinations of simple shapes, explosions through Combustion).  Unfortunately, the original max files are somehow lost, but the rendered sprites are preserved. <br><br><h5>  Pascal </h5><br>  The next step was Pascal and Assembler embedded in it.  At school, we were engaged in 386 machines, and there was felt the full power of micro-optimizations in assembly inserts.  Sprite output via REP MOWSW worked much faster than Pascal cycles.  Code alignment, shift multiplication, maximum work in registers and minimum in memory. <br><br><h5>  Protected Mode </h5><br>  All of this was terribly interesting and fun, I wrote some demos, I studied <a href="http://en.wikipedia.org/wiki/Ralf_Brown%27s_Interrupt_List">Ralf Brown's Interrupt List</a> , experimented with SVGA graphics modes, suffered with <a href="https://www.google.ru/search%3Fq%3DVESA%2Bbank%2Bswitching">bank switching</a> . <br><br>  And then the computer science teacher (thanks to him very much), who saw all these entertainments, introduced me to his friend, who worked in the PC assembly department in a large network of computer shops in the city.  He needed software under DOS with a graphical interface, preparing the hard disk of the assembled computers in a certain way.  A real job as a programmer!  The first task was to make the window graphics with buttons, text fields and so on.  Surely such solutions already existed, but I did not even think about it and was eager to write my own bicycle. <br><br>  First of all, I improved the existing module for drawing primitives, sprite output and text.  All on assembly inserts.  Then, having a little experience picking with Visual Basic 6 under Windows, I implemented windows and controls on Pascal in the same way, and after some time presented the result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e4/736/697/6e4736697d8b0e640a210c35ef8a63dd.png"><br><br>  Everything works, windows are dragged, controls respond to MouseOver.  Instead of the Windows approach with drawing dirty regions, it went ahead and redrawed everything - it worked fast enough thanks to the assembler. <br><br>  In response, I heard that 320x200 is not good, and you need to make all the elements look like in the new Windows XP at the time.  There are problems with large resolutions in <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2580%25D0%25B5%25D0%25B6%25D0%25B8%25D0%25BC">real mode</a> , since it is possible to address linearly no more than 64 kilobytes, to output pictures with higher resolution, you need to switch <a href="http://en.wikipedia.org/wiki/VESA_BIOS_Extensions">memory banks</a> , and in general there is little memory (the notorious 640 kilobytes).  Therefore, the Borland compiler has been replaced by <a href="http://www.frameworkpascal.com/download.htm">TMT Pascal</a> , which can handle 32 bits out of the box and protected mode via dos4gw.  This solved the problems with memory and graphics, the interface was redrawn, the business logic was run and the project was completed.  I do not go into details, since this is already a deviation from the topic. <br><img src="https://habrastorage.org/getpro/habr/post_images/c11/1bf/3fc/c111bf3fc6d5fab437a1f3bea5bb203b.png"><br><br><h4>  Our days </h4><br>  Sorting backups, I came across my old code.  Took DOSBox, started, brushed away a tear.  After many years, C # again wanted to feel "closer to the gland."  So I drew a plan - to take an assembler code to draw graphics in memory, then output the result in WPF.  TMT Pascal knows how to build Win32 dll, it took only minor changes (throw out too much, add stdcall to signatures). <br><br>  For example, this is the code for outputting a sprite with transparency (pixels of the color TransparentColor are not displayed): <br><br><div class="spoiler">  <b class="spoiler_title">Without a glass you will not understand, original comments</b> <div class="spoiler_text"><pre><code class="hljs coffeescript">Procedure tPut32 conv arg_stdcall (X,Y,TransparentColor:DWord;Arr:Pointer);Assembler; {Transparent PUT} Var IMSX, IMSY :DWord; Asm Cmp Arr, <span class="hljs-number"><span class="hljs-number">0</span></span> Je @ExitSub {Check ON-SCREEN POS} Mov Eax, ScreenSY; Mov Ebx, ScreenSX Cmp Y, Eax; Jl @PUT1; Jmp @ExitSub; @PUT1: Cmp X, Ebx; Jl @PUT2; Jmp @ExitSub; @PUT2: {--------} Mov Edi, LFBMem {Set Destination Loct} {Get Sizes} Mov Esi, Arr LodsD; Mov IMSX, Eax LodsD; Mov IMSY, Eax Add Esi, SizeOfSprite<span class="hljs-number"><span class="hljs-number">-8</span></span> {Check ON-SCREEN POS} Mov Eax, IMSY; Neg Eax; Cmp Eax, Y; Jl @PUT3; Jmp @ExitSub; @PUT3: Mov Eax, IMSX; Neg Eax; Cmp Eax, X; Jl @PUT4; Jmp @ExitSub; @PUT4: {VERTICAL Clipping} Mov Eax, Y {Clipping Bottom} Add Eax, IMSY Cmp Eax, ScreenSY Jl @SkipClipYB Sub Eax, ScreenSY Cmp Eax, IMSY Jl @DoClipYB Jmp @ExitSub @DoClipYB: Sub IMSY, Eax @SkipClipYB: Cmp Y, <span class="hljs-number"><span class="hljs-number">-1</span></span> {Clipping Top} Jg @SkipClipYT Xor Eax, Eax Sub Eax, Y Cmp Eax, IMSY Jl @DoClipYT Jmp @ExitSub @DoClipYT: Sub IMSY, Eax Add Y, Eax Mov Ebx, IMSX Mul Ebx Shl Eax, <span class="hljs-number"><span class="hljs-number">2</span></span> {&lt;&gt;} Add Esi, Eax @SkipClipYT: {End Clipping} {Calculate Destination MemLocation} Mov Eax, Y; Mov Ebx, ScreenSX; Mul Ebx Add Eax, X Shl Eax, <span class="hljs-number"><span class="hljs-number">2</span></span> {&lt;&gt;} Add Edi, Eax Mov Ecx, IMSY {Size Y} Mov Ebx, IMSX {Size X} Mov Edx, ScreenSX Sub Edx, Ebx {HORIZ.CLIPPING} Push Edx Xor Eax, Eax {RIGHT} Sub Edx, X Cmp Edx, <span class="hljs-number"><span class="hljs-number">0</span></span> Jge @NoClip1 {IF EDX&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> THEN JUMP} Mov Eax, Edx; Neg Eax; Sub Ebx, Eax @NoClip1: Pop Edx {LEFT} Cmp X, <span class="hljs-number"><span class="hljs-number">0</span></span> Jge @NoClip2 Sub Edi, X; Sub Esi, X <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> \ Sub Edi, X; Sub Esi, X <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> \ Sub Edi, X; Sub Esi, X <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> bit!!! Sub Edi, X; Sub Esi, X <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> / Sub Eax, X; Sub Ebx, Eax @NoClip2: {bitshifts} Shl Eax, <span class="hljs-number"><span class="hljs-number">2</span></span> {&lt;&gt;} Shl Edx, <span class="hljs-number"><span class="hljs-number">2</span></span> {&lt;&gt;} ALIGN <span class="hljs-number"><span class="hljs-number">4</span></span> @PutLn: {DRAW!!!!!} Push Ecx; Push Eax; Mov Ecx, Ebx ALIGN <span class="hljs-number"><span class="hljs-number">4</span></span> @PutDot: LodsD; Cmp Eax, TransparentColor <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Test Al, Al Je @NextDot {<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Al==<span class="hljs-number"><span class="hljs-number">0</span></span>} StosD; Sub Edi, <span class="hljs-number"><span class="hljs-number">4</span></span> {&lt;&gt;} @NextDot: Add Edi, <span class="hljs-number"><span class="hljs-number">4</span></span> {&lt;&gt;} Dec Ecx; Jnz @PutDot {Looping <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> SLOW} Pop Eax; Add Esi, Eax Add Edi, Edx; Add Edi, Eax Pop Ecx Dec Ecx; Jnz @PutLn {Looping <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> SLOW} @ExitSub: End;</code> </pre> <br></div></div><br><br>  The rest of the code is here: <a href="">code.google.com/p/lander-net/source/browse/trunk/tmt_pascal/TG_32bit.pas</a> <br><br><h5>  C # </h5><br>  Further nostalgia ends and implementation details go.  You can skip and go directly to the gameplay video and download link at the end of the post. <br><br>  Google Code project page: <a href="https://code.google.com/p/lander-net/">code.google.com/p/lander-net</a> <br><br>  Functions are imported as standard via DllImport <br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TPSGRAPH"</span></span></span><span class="hljs-meta">, CallingConvention = CallingConvention.StdCall)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tPut32</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> transparentColor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> spritePtr</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><br>  Memory for sprites is allocated and released on the unmanaged side, the same can be done through Marshal.AllocHGlobal.  The sprite is the following structure (ha, the source tag on the habr does not support Pascal - we write Delphi): <br><br><pre> <code class="delphi hljs"> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> TSprite = <span class="hljs-keyword"><span class="hljs-keyword">Packed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> W : DWord; H : DWord; Bpp : DWord; RESERVED : <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">6</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> DWORD; <span class="hljs-keyword"><span class="hljs-keyword">End</span></span>;</code> </pre><br><br>  The Unmanaged function InitSprite allocates memory and fills the header, then using FormatConvertedBitmap and memcpy copy pixels in the required format (see <a href="">code.google.com/p/lander-net/source/browse/trunk/csharp/TpsGraphNet/Sprite.cs</a> ). <br><br>  So, now we can draw the ‚Äúscene‚Äù in the frame buffer.  Here I was waiting for plugging with performance.  FPS rendering of several hundred sprites in memory was measured in thousands, but to quickly display the result on the Windows window was not so easy.  I tried WriteableBitmap, I tried DirectX (via SlimDX), the fastest was through InteropBitmap: <a href="">Sprite.GetOrUpdateBitmapSource</a> <br><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> unsafe BitmapSource GetOrUpdateBitmapSource() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_bitmapSourcePtr == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { var stride = Width*<span class="hljs-number"><span class="hljs-number">4</span></span>; // Size <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> "horizontal row" var section = NativeMethods.CreateFileMapping(NativeMethods.INVALID_HANDLE_VALUE, IntPtr.Zero, (<span class="hljs-type"><span class="hljs-type">int</span></span>) NativeMethods.PAGE_READWRITE, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-type"><span class="hljs-type">int</span></span>) _sizeInBytes, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _bitmapSource = Imaging.CreateBitmapSourceFromMemorySection(section, (<span class="hljs-type"><span class="hljs-type">int</span></span>) Width, (<span class="hljs-type"><span class="hljs-type">int</span></span>) Height, PixelFormats.Bgr32, (<span class="hljs-type"><span class="hljs-type">int</span></span>) stride, <span class="hljs-number"><span class="hljs-number">0</span></span>); _bitmapSourcePtr = (uint)NativeMethods.MapViewOfFile(section, NativeMethods.FILE_MAP_ALL_ACCESS, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _sizeInBytes).ToPointer(); NativeMethods.CloseHandle(section); NativeMethods.UnmapViewOfFile(section); } CopyPixelsTo((uint) _bitmapSourcePtr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _bitmapSource; }</code> </pre><br><br>  As you can see, dark magic with FileMapping is called only once, and then we have a direct pointer to the piece of memory that is displayed on the window.  You can update it from any stream, in the UI stream you only need to call InteropBitmap.Invalidate (). <br><br>  The way from the well-known <a href="https://habrahabr.ru/users/lincoln6echo/" class="user_link">Lincoln6Echo</a> <a href="http://habrahabr.ru/post/164705/">WPF</a> post <a href="http://habrahabr.ru/post/164705/">, WinForms: draw a Bitmap with&gt; 15000 FPS,</a> in fact, produces only 120 fps, if you expand the window to full screen on a full-hd monitor.  InteropBitmap in the same conditions gives ~ 800 fps.  The game itself on the same machine (core i5) in an expanded window gives about 300 fps, if you remove the sync by CompositionTarget.Rendering. <br><br>  To avoid screen tearing, unnecessary load on the processor, and to attach to the standard 60 frames per second in WPF, use the CompositionTarget.Rendering event.  Rendering takes place in a background thread, so as not to load the main stream and let WPF do its job with <a href="">GameViewModel.RunGameLoop ()</a> . <br><br>  Game information (health, weapons, glasses) is easily and pleasantly displayed on top of the game picture using WPF: <a href="">MainWindow.xaml</a> .  In the screenshot you can also notice the additive imposition of explosions, implemented using <a href="http://en.wikipedia.org/wiki/MMX_(instruction_set)">MMX</a> ( <a href="http://x86.renejeschke.de/html/file_module_x86_id_229.html">PADDUSB</a> instruction) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce6/437/bbf/ce6437bbf1763acc1228af7dc72678a1.png"><br><br>  All game logic is made in C #.  He left only shooting at the asteroids, from a horizontal one he converted into a vertical scroller.  SlimDX is used only for sound. <br><br><h4>  Total </h4><br>  The game, as such, did not complete it - interest was lost, trivial tasks remained, and who would play it.  It was nice to breathe new life into old crafts.  ‚ÄúCloser to the hardware‚Äù - the whole rendering does not depend on any frameworks, is performed in a separate thread, rests mainly on the speed of working with memory (from the profiler: 40% of the render time is spent on cleaning the framebuffer and 40% on copying it into InteropBitmap) . <br><br>  GitHub: <a href="https://github.com/kefir0/LanderNet">github.com/kefir0/LanderNet</a> <br>  Google Code: <a href="https://code.google.com/p/lander-net/">code.google.com/p/lander-net</a> <br>  <a href="http://ge.tt/1YvTlAh1/v/0">Compiled</a> binaries (win32): <a href="http://ge.tt/1YvTlAh1/v/0">ge.tt/1YvTlAh1/v/0</a> <br><br>  Video gameplay: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/NnJjX9xUB7c%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhivHosACrVI2U-E0vaKf9gb_IsOqg" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/211801/">https://habr.com/ru/post/211801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211787/index.html">Workplace Popcorn: How to become Super-productive working for yourself</a></li>
<li><a href="../211789/index.html">Visualization of floor plans or geographic information systems (GIS) in real estate</a></li>
<li><a href="../211793/index.html">Veeam Backup & Replication - Migrating Virtual Machines from Hyper-V 2008 R2 to 2012 R2</a></li>
<li><a href="../211797/index.html">Competition "Native Speech" - a week before the start!</a></li>
<li><a href="../211799/index.html">Ciklum Speakers' Corner "Tables - salt of the language of Lua", February 13</a></li>
<li><a href="../211805/index.html">10 of my favorite CodeRush features for .NET development in Visual Studio</a></li>
<li><a href="../211809/index.html">Bitcoin exchange Btc-e.com suspended the input and output of rubles, and MtGox.com temporarily stopped the withdrawal of funds in dollars</a></li>
<li><a href="../211813/index.html">As a team of techies created his studio. The experience of the first months. Achievements, feil, inference ...</a></li>
<li><a href="../211815/index.html">Erlang for the little ones. Chapter 3: Basic Function Syntax</a></li>
<li><a href="../211817/index.html">Life is like an 8-bit game: Manual</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>