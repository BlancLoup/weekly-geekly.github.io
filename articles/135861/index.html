<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse development of a commercial program: keygen for Zuma Deluxe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  Hello, Habraludi. 
 Judging by the latest articles in the Assembler blog, the topic of keygens is becoming very popular here. Well, I'll...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse development of a commercial program: keygen for Zuma Deluxe</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/0d1/b86/73e/0d1b8673e83c2baaf845a41b4bcbfdfc.jpg"><br><br><br><h4>  Introduction </h4>  Hello, Habraludi. <br>  Judging by the latest articles in the <a href="http://habrahabr.ru/blogs/asm/">Assembler</a> blog, the topic of keygens is becoming very popular here.  Well, I'll bring in my five kopecks. <br>  Our today's test subject is the Zuma Deluxe game, which I couldn‚Äôt go on trying to get rid of my keygen (don‚Äôt think that I‚Äôm a gamer: Comrade <a href="http://habrahabr.ru/users/k_d/" class="user_link">k_d</a> inspired me with his <a href="http://habrahabr.ru/blogs/asm/125623/">self-playing</a> <a href="http://habrahabr.ru/users/k_d/" class="user_link">game</a> <a href="http://habrahabr.ru/blogs/asm/125623/">for Zuma</a> ).  And immediately a disclaimer: this hacking from the beginning to the end is done for educational purposes and is not intended to incur losses for PopCap Games. <br><a name="habracut"></a>  So, google <a href="http://www.playzuma.ru/game-10.html">the Zuma distribution</a> , download it, bring <a href="http://ollydbg.de/">OllyDBG</a> into battle, and start parsing. <br>  Yes, I will make a reservation in advance - for some time I have become a Linux user, so all this joy will be launched from under WINE.  However, looking ahead, I note that this task has its advantages, such as, for example, the ease of editing records and tracking changes in the WINE registry, due to its storage in a regular text file. <br><br><br><h4>  Part 1: The Cunning Flash </h4>  In general, we start the game, play longer than expected (or immediately climb into the HKLM / Software / PopCap / Zuma registry branch and set zeros in the TimesExecuted and TimesPlayed keys) - and voila: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/81c/a53/90c/81ca5390c06b0d94a5ad06475797937c.jpg"><br><br>  Great, choose ‚ÄúBuy Now‚Äù, close the pop-up window of the browser with an offer to buy <nobr>such a</nobr> game for a measly 16.99 euros, and click ‚ÄúEnter the Registration Key Manually‚Äù. <br><br><img src="https://habrastorage.org/storage2/bec/f66/c92/becf66c9249cf6e05e114877dee00fdb.jpg"><br><br>  So-s, input field.  Already from something you can dance.  We try to enter some kind of abracadabra, expectedly we get ‚ÄúPlease enter a valid key‚Äù, and go to figure out what's what.  The first thing that is alarming during a thoughtful inspection is the presence in the folder, right next to the game binaries, two files hinting at the use of Flash technology in the program: Actually, Flash.ocx and drm.swf ... Apparently, it was possible to delay the closure of the browser.  Okay, open this very drm.swf - and what we see: <br><br><img src="https://habrastorage.org/storage2/f3b/b7a/477/f3bb7a477a649e8c9ca45abc875b6dee.jpg"><br><br>  The whole glamorous shell for registering the key, as it turned out, is executed in that very .SWF file.  Maybe the verification code itself is in the same place?  Let's get a look.  We take any ActionScript decompiler (I, for example, used <a href="http://www.nowrap.de/flare.html">Flare</a> ) and remove the source code from drm.swf. <br>  We look, that at us there it was compiled.  Is it too early, is it too late to stumble upon such an interesting line: <br><br><pre><code class="cpp hljs">gFrameLabels[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">'RegFailed'</span></span>;</code> </pre> <br>  We look for ‚ÄúRegFailed‚Äù and exit to this block of code: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_root.RegCodeEdit.text.length &gt;= <span class="hljs-number"><span class="hljs-number">23</span></span> &amp;&amp; _root.validate_regkey(_root.RegCodeEdit.text)) { _root.APError.text = <span class="hljs-string"><span class="hljs-string">''; gRegFailedHeader = gHeader_RegFail; gRegFailedMessage = gMessage_RegFail; gRegFailedRetryLocation = '</span></span>APScreen'; fscommand(<span class="hljs-string"><span class="hljs-string">'Register'</span></span>, _root.RegCodeEdit.text); }</code> </pre> <br>  Here it is.  The correct key is 23 characters long (no longer simply allows you to enter the text field itself) and causes <i>validate_regkey () to</i> return <i>True</i> .  The fact that in the same block of code initialization of such ‚Äúscary‚Äù values ‚Äã‚Äãas <i>gRegFailedMessage occurs</i> can be ignored, since  here, regardless of them, data from the flash object is transferred to the parent process via the <i>fscommand ()</i> . <br>  Now it's time to do the actual function <i>validate_regkey ()</i> .  Here it is: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_regkey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.substr(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-string"><span class="hljs-string">'-'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.substr(<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-string"><span class="hljs-string">'-'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.substr(<span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-string"><span class="hljs-string">'-'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Array(); k = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (k &lt;= <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.slice(k, k + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'0'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'1'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'2'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'3'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'4'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'5'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'6'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'7'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'8'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'9'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'A'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'B'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'C'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'D'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'E'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'F'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'G'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'H'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'I'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'J'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'K'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'L'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'M'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'N'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'O'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'P'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'Q'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'R'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'S'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'T'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'U'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'V'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'W'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'X'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'Y'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'Z'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'a'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'b'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'c'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'d'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'e'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'f'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'g'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'h'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'i'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'j'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'k'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'l'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'m'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'n'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'o'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'p'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'q'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'r'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'s'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'t'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'u'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'v'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'w'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'x'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'y'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'z'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">'-'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> == <span class="hljs-string"><span class="hljs-string">' '</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k == <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) { result = <span class="hljs-string"><span class="hljs-string">'Thank you for submitting !'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result = <span class="hljs-string"><span class="hljs-string">'Unauthorized character '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ++k; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result = <span class="hljs-string"><span class="hljs-string">'Error in delimiters'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  Well, the central check is an unequivocal masterpiece.  It is necessary, probably, to post it on <a href="http://govnokod.ru/">govnokod.ru</a> , but oh well, we have not gathered a bit of a bitch here.  The main thing is that this function gave us the structure of the license key: <br><br>  ##### - ##### - ##### - ##### <br>  where # is a character from the alphabet "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz- <nobr>&nbsp;</nobr>  ". <br>  Exactly 23 characters. <br><br>  Again, looking ahead, I will say that the set of correct characters within the program itself will be somewhat reduced.  But so far we have no difference.  We launch OllyDBG and load our experimental into it.  Run (F9) and wait for the main window to be drawn. <br>  Where to dig further? <br>  Do you remember the <i>fscommand ()</i> call we found with the first parameter equal to the string ‚ÄúRegister‚Äù? <br>  Therefore, open the Memory Map (Alt + M) and look for the entry of this string (Ctrl + B).  And here it is, it lies to itself at the address <i>0x4417D0</i> : <br><br><img src="http://habrastorage.org/storage2/33f/084/1f6/33f0841f6030528235c102d5cd10e77c.png"><br><br>  Put a break point on it on reading (selection ‚Üí Shift + F3).  Next, in the verification window, go to the link below ‚ÄúAlready purchased this game?‚Äù ‚Üí ‚ÄúEnter the Registration Key Manually‚Äù, and enter in the field for the key any alphanumeric stub, divided by 4 hyphens in 5 characters.  Click "Register". <br><br><br><h4>  Part 2: we need to go deeper </h4>  So we finally got inside the verification algorithm.  Go to the list of control points for memory and delete <i>0x4417D0</i> (Alt + Y ‚Üí Del), execute (Ctrl + F9) until the end of the function, since  there is nothing interesting for us, only the comparison cycle, then we return to the calling function (F8), and we see there the check of the returned result.  Again, we skip everything until the end of the function and return to the caller: <br><br><img src="http://habrastorage.org/storage2/07a/5ff/86c/07a5ff86c5a4d20b25b96ccf81075911.png"><br><br>  Aha  And now we are in the heart of the license key analyzer.  In order not to forget this place, set (F2) the control point at <i>0x04066CA</i> and look around.  Just below ( <i>0x406757</i> and <i>0x4067A8</i> ) function calls with very interesting string parameters ‚ÄúRegSucceeded‚Äù and ‚ÄúRegFailed‚Äù are visible.  And higher ( <i>0x406748</i> ) is a branch, which transfers control to the desired function.  This branch is tied to a comparison ( <i>0x40672D</i> ) of the AL and BL registers.  It seems that the function <i>0x404260</i> , called by two more commands earlier, is exactly what we were looking for, i.e.  The Most Important Check Function. <br><br>  First, check your guess: change the comparison so that it turns out to be true with incorrect source data.  Bring the selection to <i>0x406748</i> and <i>press the</i> spacebar.  The ‚ÄúAssemble‚Äù window will open.  Replace the transition by equality, JE, to the transition by inequality - JNE.  Run (F9) ... <br><br><img src="http://habrastorage.org/storage2/a59/2d3/1c7/a592d31c75e3d9ff8625c77a20fb6d84.jpg"><br><br>  Hurray, the first bastion is taken! <br>  But now we are writing not just a crack, but a very keygen.  And this means that it‚Äôs too early to stop at what has been accomplished, and you have to restart the program (Ctrl + F2) and delve into the depths of the <i>0x404260</i> function. <br><br>  Now our task is to understand how the AL and BL registers behave inside this function, and where exactly is the piece of code responsible for their equality or inequality. <br>  Go to the ‚Äútail‚Äù of the function, closer to the exit point, RETN, and turn on the BL register highlight (context menu ‚Üí Highlight register ‚Üí EBX). <br><br><img src="http://habrastorage.org/storage2/c83/25e/47a/c8325e47aaf045c968237019d3e45b3f.png"><br><br>  As you can see, the contents of the AL register for almost the entire ‚Äútail‚Äù are stored in BL, and just before the output is copied back, with further restoration of the original EBX value from the stack. <br>  Moreover, the AL value itself is taken from the function in the picture above marked with a selection. <br>  Go inside this function - and what we see: <br><br><img src="http://habrastorage.org/storage2/dbb/cad/781/dbbcad7817002165d2e3a61312403f44.png"><br><br>  This function has only two possible output values ‚Äã‚Äã- 0 and 1. The first is generated when the string is bytes, the pointer to the structure with which is passed as a function parameter, does not match the string whose pointer is at [ECX + 8].  The second (the one we need) - in the opposite situation, i.e.  when the strings are identical. <br><br><br><h4>  Part 3: MD5, RSA and all-all </h4>  Let's go back to the parent function and see where the values ‚Äã‚Äãfrom [ECX + 8] and [ARG.1 + 8] come from. <br>  To do this, put (selection ‚Üí Shift + F5) ‚Äúhardware‚Äù checkpoint points for two addresses in the stack where these lines should be placed.  For different configurations of machines and operating systems, these addresses are likely to differ.  So, in my case, this is <i>0x33E624</i> and <i>0x33E660</i> (in general, I recommend having an additional window on my side that shows the state of the stack, independent of the position of its top, ESP, <a href="">as in the picture</a> ). <br>  These checkpoints must be hardware, because  other types of control points, being stacked, will either lead to a program crash, or will not be saved between runs.  So far, these points need to be made inactive (context menu ‚Üí Breakpoint ‚Üí Hardware disable). <br><br>  Now restart the program and stop at the entrance to our main check function ( <i>0x404260</i> ).  Put a checkpoint there and start tracing the function line by line (F8), following the state of our two hardware breakpoints.  Tracing indicates that before line <i>0x404546</i> both values ‚Äã‚Äãremain unchanged.  But further already curious. <br><br>  A function that is directly called from <i>0x404546</i> is a ‚Äúspringboard‚Äù for starting the function <i>0x41E320</i> , so there is nothing interesting in it.  Put a breakpoint at <i>0x41E320</i> and hit F9. <br>  At the moment, in the stack you can see a line consisting of strange, but nevertheless printable characters (for example, I have A ..... 6..O6NBBO .... E4GXF3O0 ..), a line feed and postfix zuma.  We trace further, and we <i>get</i> on <i>0x41E37F</i> : <br><br><img src="http://habrastorage.org/storage2/76c/bf2/9f2/76cbf29f258f1c82f9d532a1975acede.png"><br><br>  So-so-so ... yes these are the same initialization vectors for <a href="http://ru.wikipedia.org/wiki/MD5">the MD5 algorithm</a> ! <br>  MD5.  That's better.  Now the analysis of the rest of the function code is easy and carefree: <br><ul><li>  <i>0x41E320</i> - <i>0x41E397</i> : initialization of data and memory allocation for the result </li><li>  <i>0x41E39B</i> - <i>0x41E3C3</i> : calculation of the MD5 hash from the above line and preparation of the structure (hereinafter, I will call it a ‚Äúframe‚Äù), which will contain a reference to the result </li><li>  <i>0x41E3C5</i> - <i>0x41E408</i> : a loop that rebuilds bytes as a result backwards </li><li>  <i>0x41E40A</i> - <i>0x41E424</i> : a check that, by virtue of the fixedness of the fourth parameter of the function (0x5E), always turns out to be true </li><li>  <i>0x41E426</i> - <i>0x41E474</i> : code that, by virtue of a previous check, is never executed </li><li>  <i>0x41E476</i> - <i>0x41E4B5</i> : functions of ‚Äútrimming‚Äù 128-bit MD5 hash to 96 bits;  exit function </li></ul><br>  Now let's look at the first of our hardware checkpoints: <br><br><img src="http://habrastorage.org/storage2/db6/5b7/8d0/db65b78d0fcf2bc68247faf899acc2fc.png"><br><br>  Such a structure of five values, as I said, will later be called a "frame." <br><ul><li>  The first DWORD never changes, and is always <i>0x44543C</i> </li><li>  The second DWORD has an unclear purpose (yes, in general, it is not particularly important, as practice will show further) </li><li>  The third DWORD is the address in memory where the byte string is stored. </li><li>  The fourth DWORD sets its ‚Äúeffective‚Äù length in WORD `s (i.e. how many WORD` s from the string will be used in further calculations) </li><li>  The fifth DWORD sets its ‚Äútotal‚Äù length in WORD `s (i.e. how many WORD` s were initially allocated to accommodate the string) </li></ul><br>  So, after the procedure we have just traced, the first of the frames is already filled.  That is, we already have one of the strings, let's call it conditionally ‚Äúreference‚Äù, which will undergo a comparison with the one that we have yet to calculate at <i>0x40454F</i> - <i>0x40458C</i> . <br><br>  Now let's take a <i>closer</i> look at line <i>0x404560</i> , from where the function <i>0x41E5A0</i> is <i>called</i> . <br>  The function is very long and very scary, however, we are here to make the long and scary simple and understandable.  This function processes the registration key string we entered, and recalculates it into a number. <br><ul><li>  <i>0x41E5A0</i> - <i>0x41E608</i> : initialization, memory allocation, installation of an exception handler </li><li>  <i>0x41E60B</i> - <i>0x41E6EF</i> : a loop that converts the letters of a string to uppercase, and replaces the characters "1" with "L", and "O" and "0" - with "Q" </li><li>  <i>0x41E6F5</i> - <i>0x41E70A</i> : preparation for the second cycle </li><li>  <i>0x41E710</i> - <i>0x41E7E4</i> : the second cycle that builds a number from a string based on the principle of converting it from a 28-digit number system (the first character is a low-order bit, the last is a high-order number), with the character set ‚Äú234679ACDEFGHJKLMNPQRTUVWXYZ‚Äù ignoring hyphens, and giving an error when there is no current character in set </li><li>  <i>0x41E7EA</i> - <i>0x41E844</i> : copy result, free temporary buffers, exit </li><li>  <i>0x41E845</i> - <i>0x41E874</i> : ‚Äútail‚Äù, executed if the second cycle gave an error </li></ul><br>  Great, the string is recalculated into a number, and now we are doing something with it. <br><br>  Until the cherished moment, when it can be said that the reverse is done, there is only one function left, <i>0x41E100</i> (call from <i>0x40458C</i> ). <br><br>  Well, here I will not torture you by reading and decoding assembly lists, because one good friend, by the time I just started to disassemble it, threw a piece of the source code PopCap  ªovskogo framework, which contains in itself if not the implementation specified functions, but at least its name.  In general, the <a href="http://www.mechanism8.com/popcap/docs/html/_sexy_app_8cpp-source.html">drum roll ...</a> the function that we are going to launch into a frontal attack is called <i>aSignature.ModPow (e, n)</i> . <br>  Those who are interested can proceed to line 00069 and find out the striking similarity of the <i>bool SexyApp :: Validate ()</i> function (SexyApp - they called it; I'm fucking off without a button accordion, gracious gentlemen) with ours, who has already become so dear, <i>0x404260</i> . <br><br>  Also, I recommend to pay attention to <i>e</i> and <i>n</i> themselves: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">BigInt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"42BF94023BBA6D040C8B81D9"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BigInt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"11"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;</code> </pre> <br>  or, in an assembly representation, <br><br><img src="http://habrastorage.org/storage2/8b5/b8c/f95/8b5b8cf956e912a73372e7a209a57a37.png"><br><br>  As the name suggests, <i>ModPow ()</i> means exponentiation modulo. <br>  And the comment on line 00478 <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Public RSA stuff BigInt n("D99BC76AB7B2578738E606F7"); BigInt e("11"); BigInt aHash = HashData(aFileData, aFileDataPos, 94); delete aFileData; BigInt aSignature(aSigStr); BigInt aHashTest = aSignature.ModPow(e, n);</span></span></code> </pre> <br>  finally clarifies the situation: the algorithm we are dealing with is <a href="http://ru.wikipedia.org/wiki/RSA">RSA</a> . <br><br><br><h4>  Part 4: Key Generator </h4>  Well, we have almost all the source data to start writing keygen.  The only thing left to do is to factor the public module <i>0x42BF94023BBA6D040C8B81D9</i> and calculate the private exponent.  Well, we take into the hands of the <a href="http://sourceforge.net/projects/msieve/">MSieve</a> + <a href="http://rghost.ru/private/35801073/ef95611176f4f0df531490c4f0f8363d">TMG RSA Tool</a> , and get at the output <i>0x03AE5465C52D0C4C0A8FE303D</i> . <br>  Everything, it remains to write (or stole the finished, he-he) implementation of long arithmetic.  We have the algorithm for key generation: <br><ol><li>  calculate MD5 from the NAME OF USER, 0Ah, ZUMA </li><li>  throw out the last DWORD, and write down the remaining byte order </li><li>  WORD-ovo walk through the result, and apply (chit .: kopipastit to keygen) shift;  see <i>0x41D280</i> </li><li>  change the byte order again </li><li>  calculate the function ModPow (D, N), where D = 0x3AE5465C52D0C4C0A8FE303D, N = 0x42BF94023BBA6D040C8B81D9, E = 0x11 </li><li>  by dividing by 28, substituting the residuals according to the table ‚Äú234679ACDEFGHJKLMNPQRTUVWXYZ‚Äù, reveal from the calculated license key </li></ol><br>  Here I deliberately dropped a few hours of research on what the most cherished line ‚ÄúA ..... 6..O6NBBO .... E4GXF3O0 ..‚Äù is, which I took for granted as an analysis, and in the above algorithm designated as a user name.  It turns out that it is generated on the basis of the computer's iron, in particular, the number of network adapters on the computer is responsible for its length. <br>  The code of this generation, in my opinion, was written by some paranoid addicts.  Here, for example, is the real situation: at any given time in my computer there may be three or four network adapters ( <i>lo</i> back-up, <i>eth0</i> Ethernet interface, <i>wlan0</i> WiFi interface, as well as a mobile phone connected via a USB port and playing the role of a GPRS modem , <i>ppp0</i> ).  As soon as I connect a mobile phone, they become 4. As I disconnect - 3. These two states, according to the generator, correspond to different lines.  Therefore, in one of them, registration Zuma, bought for, sorry, ‚Ç¨ 16.99, just fly. <br><br>  In general, based on the foregoing, the code that generates this dirty trick, I decided not to copy-paste keygen, but it‚Äôs banal to steal a ready-made line from the memory of the game using <i>ReadProcessMemory ()</i> .  As a small hooliganism, I also added the ability to write something of my <i>own</i> in the name string (using <i>WriteProcessMemory ()</i> , as you can easily guess).  But, unfortunately, such a trick only works on WINE (that is, it retains the validity of registration), but not on ‚Äúreal‚Äù Windows. <br><br>  The rest - please love and favor: <a href="http://rghost.ru/private/35800841/31f7d5ba12e471aa0eda245f31dedddb">Zuma keygen, proof-of-concept</a> . <br>  The writing language is assembler.  The MD5 algorithm is copied from the game's binary, and slightly modified by the file.  96-bit arithmetic - authentic =) <br><br>  Keigen was checked not only on the version of Zuma, which is discussed in the article, but also on others, earlier or later (I did not understand).  Despite the fact that the addresses with the user name have differed, the license key itself has been suitable for all of them, which indicates that the algorithm has not changed since 2003. <br><br><br><h4>  Afterword and references used </h4>  This article would have been impossible without the help of several literate guys from the <a href="http://wasm.ru/forum">WASM.RU Forum</a> , who had guided me on the <a href="http://wasm.ru/forum">right</a> path <a href="http://wasm.ru/forum/viewtopic.php%3Fid%3D42450">in this topic</a> . <br>  Also, the <a href="http://rghost.ru/private/35801073/ef95611176f4f0df531490c4f0f8363d">RSA Tool</a> utility from the TMG hacker team and the online RSA calculator <a href="http://nmichaels.org/rsa.py">http://nmichaels.org/rsa.py</a> helped me a lot. <br>  The Wikipedia articles on <a href="http://ru.wikipedia.org/wiki/RSA">RSA</a> and <a href="http://ru.wikipedia.org/wiki/MD5">MD5</a> also gave me a lot to understand the essence of what is happening in the depths of the game. <br>  If someone is interested, I post the <a href="http://rghost.ru/private/35801169/486ea47ec5fa55e0ee884c06dd3d03d7">.UDD file for OllyDBG</a> with all comments and control points. <br><br>  PS If someone can advise a more reliable file sharing service from which files are not deleted after 30 days of inactivity - I will be extremely grateful. <br><br>  PPS What was my surprise when, after hacking, I discovered that <i>Zuma.exe</i> from the package in <i>question</i> is just a wrapper, an archive that unpacks the real binary from Zuma, called <i>popcapgame1.exe</i> , using its license key ... <br><br>  [UPDATE:] transferred images to Habrastorage. <br></div><p>Source: <a href="https://habr.com/ru/post/135861/">https://habr.com/ru/post/135861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135855/index.html">Errrr - Simplest Error Recorder</a></li>
<li><a href="../135856/index.html">Improved Android NDK (Native Development Kit)</a></li>
<li><a href="../135857/index.html">Python, scipy.weave and openMP - overclocking the code</a></li>
<li><a href="../135858/index.html">Opening a cloud to new customers</a></li>
<li><a href="../135859/index.html">How future computer programmers taught physics</a></li>
<li><a href="../135862/index.html">Simple Restful implementation for Yii</a></li>
<li><a href="../135863/index.html">How to write an add-on for GIMP in Python</a></li>
<li><a href="../135865/index.html">Coder vs. Developer vs. Engineer - what's your Job Title,% username%?</a></li>
<li><a href="../135866/index.html">My view on icon design</a></li>
<li><a href="../135870/index.html">In response to the article: ‚ÄúWho teaches whom: a teacher of a student or a student of a teacher?‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>