<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Designing a system for reading data from input devices (Part One)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you work on a game engine, you want to design it right away right away - so that you don‚Äôt waste time on painful refactoring. When I was developi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Designing a system for reading data from input devices (Part One)</h1><div class="post__text post__text-html js-mediator-article">  When you work on a game engine, you want to design it right away right away - so that you don‚Äôt waste time on painful refactoring.  When I was developing my own engine, in search of inspiration I looked through the sources of other game engines and came to a specific implementation (you can read it at the link at the end of the article).  In the article I would like to offer a solution to the problem of designing a system that reads data from input devices. <br><br>  It would seem that there is something difficult: I read the data from the mouse, keyboard, joystick and called it in the right place.  So it is, and most often the similarity of such code can be found in game engines: <br><br><pre><code class="actionscript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     cotrols-&gt;Update() ... void Player::Move() { if (controls-&gt;MouseButonPressed(0)) { ... } if (controls-&gt;KeyPressed(KEY_SPACE)) { ... } if (controls-&gt;JoystickButtonPressed(0)) { ... } }</span></span></code> </pre> <br>  What does not suit me in this approach?  First, if we want to read data from a specific device, such as a joystick, then we use methods that receive data from a specific device.  Secondly, in the code we get a hardcode, i.e.  right in the game code is a survey of a particular key and a specific device.  This is not good, because later, in order to make the redefinition of keys through the game menu, it will be necessary to clean everything like that and make some kind of re-mapping subsystem, with the ability to redefine the binding of keys on the fly.  Thus, the simplest implementation is not so good. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What can be offered to solve the problem? <br><a name="habracut"></a><br>  The solution is simple: when querying input devices, use abstract names - aliases, which are written in a separate configuration file and whose names originate from the action, and not from the name of the keys to which the action is blocked, for example: "ACTION_JUMP", "ACTION_SHOOT".  In order not to work with the alias names themselves, let's add a method to get the alias identifier: <br><br><pre> <code class="actionscript hljs">int GetAlias(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name);</code> </pre><br>  The survey of states itself is reduced to just two methods: <br><br><pre> <code class="actionscript hljs">enum AliasAction { Active, Activated }; bool GetAliasState(int alias, AliasAction action); float GetAliasValue(int alias, bool delta);</code> </pre><br>  Let me explain why we use two methods.  When querying the state of keys, the Boolean value is more than enough, but when querying the state of the stick, the joystick will need to get a numeric value.  Therefore, two methods have been added.  In the case of a state, in the second parameter we pass the type of action.  There are only two of them: Active (the alias is active, for example, the key is clamped) or Activated (the alias has switched to the active state).  For example, we need to handle the key throwing grenades.  This is not a permanent action, such as walking, so you need to determine the very fact that the throwing key of the grenade was pressed, and if the key is still in the pressed state, do not react to it.  When polling the numeric value of the alias, we pass the second parameter to the boolean flag, which says whether we need the value itself or the difference between the current value and the value from the previous frame. <br><br>  I will give an example of code implementing the camera control: <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FreeCamera::Init() { proj.BuildProjection(<span class="hljs-number"><span class="hljs-number">45.0</span></span>f * RADIAN, <span class="hljs-number"><span class="hljs-number">600.0</span></span>f / <span class="hljs-number"><span class="hljs-number">800.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1000.0</span></span>f); angles = Vector2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>f, <span class="hljs-number"><span class="hljs-number">-0.5</span></span>f); pos = Vector(<span class="hljs-number"><span class="hljs-number">0.0</span></span>f, <span class="hljs-number"><span class="hljs-number">6.0</span></span>f, <span class="hljs-number"><span class="hljs-number">0.0</span></span>f); alias_forward = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_FORWARD"</span></span>); alias_strafe = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_STRAFE"</span></span>); alias_fast = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_FAST"</span></span>); alias_rotate_active = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_ACTIVE"</span></span>); alias_rotate_x = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_X"</span></span>); alias_rotate_y = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_Y"</span></span>); alias_reset_view = controls.GetAlias(<span class="hljs-string"><span class="hljs-string">"FreeCamera.RESET_VIEW"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FreeCamera::Update(float dt) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controls.GetAliasState(alias_reset_view)) { angles = Vector2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>f, <span class="hljs-number"><span class="hljs-number">-0.5</span></span>f); pos = Vector(<span class="hljs-number"><span class="hljs-number">0.0</span></span>f, <span class="hljs-number"><span class="hljs-number">6.0</span></span>f, <span class="hljs-number"><span class="hljs-number">0.0</span></span>f); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controls.GetAliasState(alias_rotate_active, Controls::Active)) { angles.x -= controls.GetAliasValue(alias_rotate_x, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span>f; angles.y -= controls.GetAliasValue(alias_rotate_y, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span>f; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (angles.y &gt; HALF_PI) { angles.y = HALF_PI; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (angles.y &lt; -HALF_PI) { angles.y = -HALF_PI; } } float forward = controls.GetAliasValue(alias_forward, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); float strafe = controls.GetAliasValue(alias_strafe, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); float fast = controls.GetAliasValue(alias_fast, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); float speed = (<span class="hljs-number"><span class="hljs-number">3.0</span></span>f + <span class="hljs-number"><span class="hljs-number">12.0</span></span>f * fast) * dt; Vector dir = Vector(cosf(angles.x), sinf(angles.y), sinf(angles.x)); pos += dir * speed * forward; Vector dir_strafe = Vector(dir.z, <span class="hljs-number"><span class="hljs-number">0</span></span>,-dir.x); pos += dir_strafe * speed * strafe; view.BuildView(pos, pos + Vector(cosf(angles.x), sinf(angles.y), sinf(angles.x)), Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); render.SetTransform(Render::View, view); proj.BuildProjection(<span class="hljs-number"><span class="hljs-number">45.0</span></span>f * RADIAN, (float)render.GetDevice()-&gt;GetHeight() / (float)render.GetDevice()-&gt;GetWidth(), <span class="hljs-number"><span class="hljs-number">1.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1000.0</span></span>f); render.SetTransform(Render::Projection, proj); }</code> </pre><br>  Please note that the alias name uses the prefix FreeCamera.  This is done in order to adhere to a certain rule of naming, which allows you to understand which object the alias belongs to.  If this is not done, as the further development proceeds, the number of aliases will increase, and over time, you can get a bunch of aliases that refer to each other, and all this will not be controlled, since  Finding an erroneous task will be very difficult and will take a lot of time.  Therefore, the introduction of the rule of naming is necessary. <br><br>  Let us turn to the most interesting part - setting up the aliases themselves.  They will be stored in the json file.  The file that describes the aliases for the camera looks like this: <br><br><pre> <code class="actionscript hljs">{ <span class="hljs-string"><span class="hljs-string">"Aliases"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_FORWARD"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_W"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_I"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_S"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">-1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_K"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">-1.0</span></span> } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_STRAFE"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_A"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">-1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_J"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">-1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_D"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">1.0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_L"</span></span>], <span class="hljs-string"><span class="hljs-string">"modifier"</span></span> : <span class="hljs-number"><span class="hljs-number">1.0</span></span> } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.MOVE_FAST"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_LSHIFT"</span></span>] } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_ACTIVE"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"MS_BTN1"</span></span>] } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_X"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"MS_X"</span></span>] } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.ROTATE_Y"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"MS_Y"</span></span>] } ]}, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"FreeCamera.RESET_VIEW"</span></span>, <span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"names"</span></span> : [<span class="hljs-string"><span class="hljs-string">"KEY_R"</span></span>, <span class="hljs-string"><span class="hljs-string">"KEY_LCONTROL"</span></span>] } ]} ] }</code> </pre><br>  Aliases are described quite simply: we give the name an alias (the name parameter) and an array of references to the aliases (the AliasesRef parameter).  For each alias reference, you can set the modificator parameter ‚Äî this parameter is used as a multiplier that is applied to the value that is obtained by calling the GetAliasValue method.  The MOVE_FORWARD and MOVE_STRAFE aliases use this parameter to simulate the operation of the stick of the joystick, since  it is the stick of the joystick that gives the value in the range [-1..1] for each of the two axes.  So that you can specify a key combination, i.e.  hotkeys, the names parameter is an array of names.  The RESET_VIEW Alias ‚Äã‚Äãis an example of setting the hot key combination LCTRL + R. <br><br>  Consider in more detail the occurring names in the references to aliases, for example, KEY_W, MS_BTN1.  The fact is that in the work one way or another, references to specific keys are needed, such links are called hardware aliases.  Thus, in our system there will be two types of aliases: custom (we work with them in the code) and hardware aliases.  The methods themselves are: <br><br><pre> <code class="actionscript hljs">bool GetAliasState(int alias, bool exclusive, AliasAction action); float GetAliasValue(int alias, bool delta);</code> </pre><br>  Input methods accept indifiers of user aliases obtained by calling the GetAlias ‚Äã‚Äãmethod.  This restriction was introduced in order to avoid the temptation to use hardware aliases directly and always use only custom ones. <br><br>  If you need to insert a debug hotkey that includes something debugging, use one of two methods: <br><br><pre> <code class="actionscript hljs">bool DebugKeyPressed(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name, AliasAction action); bool DebugHotKeyPressed(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name2, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name3);</code> </pre><br>  Both methods take the name of hardware aliases as input.  Thus, processing debazh hotkeys uses one of two methods, so there is no difficulty in adding a setting that disables the processing of all debazh hotkeys, i.e.  You do not need a separate code that disables the processing of the hot keys, since  the system will turn them off.  Thus, no debugging functionality will be included in the release build. <br><br>  Let us turn to a more detailed description of the implementation.  Only the code logic will be described below.  I used DirectInput to work with the keyboard and mouse, so the code for working with DirectInput will be skipped. <br><br>  Let's start with a description of the structure of hardware aliases: <br><br><pre> <code class="actionscript hljs">enum Device { Keyboard, Mouse, Joystick }; struct HardwareAlias { std::string name; Device device; int index; float value; };</code> </pre><br>  Now we will describe the alias structure: <br><br><pre> <code class="actionscript hljs">struct AliasRefState { std::string name; int aliasIndex = <span class="hljs-number"><span class="hljs-number">-1</span></span>; bool refer2hardware = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; struct AliasRef { float modifier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>f; std::vector&lt;AliasRefState&gt; refs; }; struct Alias { std::string name; bool visited = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; std::vector&lt;AliasRef&gt; aliasesRef; };</code> </pre><br>  And now we will start implementation of methods.  Let's start with the initialization method: <br><br><pre> <code class="actionscript hljs">bool Controls::Init(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name_haliases, bool allowDebugKeys) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;allowDebugKeys = allowDebugKeys; <span class="hljs-comment"><span class="hljs-comment">//Init input devices and related stuff JSONReader* reader = new JSONReader(); if (reader-&gt;Parse(name_haliases)) { while (reader-&gt;EnterBlock("keyboard")) { haliases.push_back(HardwareAlias()); HardwareAlias&amp; halias = haliases[haliases.size() - 1]; halias.device = Keyboard; reader-&gt;Read("name", halias.name); reader-&gt;Read("index", halias.index); debeugMap[halias.name] = (int)haliases.size() - 1; reader-&gt;LeaveBlock(); } while (reader-&gt;EnterBlock("mouse")) { haliases.push_back(HardwareAlias()); HardwareAlias&amp; halias = haliases[(int)haliases.size() - 1]; halias.device = Mouse; reader-&gt;Read("name", halias.name); reader-&gt;Read("index", halias.index); debeugMap[halias.name] = (int)haliases.size() - 1; reader-&gt;LeaveBlock(); } } reader-&gt;Release(); return true; }</span></span></code> </pre><br>  To load custom aliases, we describe the LoadAliases method.  The same method is used if a file that describes aliases has been changed, for example, the user in the settings has redefined control: <br><br><pre> <code class="actionscript hljs">bool Controls::LoadAliases(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name_aliases) { JSONReader* reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONReader(); bool res = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader-&gt;Parse(name_aliases)) { res = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (reader-&gt;EnterBlock(<span class="hljs-string"><span class="hljs-string">"Aliases"</span></span>)) { std::string name; reader-&gt;Read(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, name); int index = GetAlias(name.c_str()); Alias* alias; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { aliases.push_back(Alias()); alias = &amp;aliases.back(); alias-&gt;name = name; aliasesMap[name] = (int)aliases.size() - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { alias = &amp;aliases[index]; alias-&gt;aliasesRef.clear(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (reader-&gt;EnterBlock(<span class="hljs-string"><span class="hljs-string">"AliasesRef"</span></span>)) { alias-&gt;aliasesRef.push_back(AliasRef()); AliasRef&amp; aliasRef = alias-&gt;aliasesRef.back(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (reader-&gt;EnterBlock(<span class="hljs-string"><span class="hljs-string">"names"</span></span>)) { aliasRef.refs.push_back(AliasRefState()); AliasRefState&amp; ref = aliasRef.refs.back(); reader-&gt;Read(<span class="hljs-string"><span class="hljs-string">""</span></span>, ref.name); reader-&gt;LeaveBlock(); } reader-&gt;Read(<span class="hljs-string"><span class="hljs-string">"modifier"</span></span>, aliasRef.modifier); reader-&gt;LeaveBlock(); } reader-&gt;LeaveBlock(); } ResolveAliases(); } reader-&gt;Release(); }</code> </pre><br>  ResolveAliases () method is found in the loading code.  In this method, linking of loaded aliases occurs.  The link code looks like this: <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Controls::ResolveAliases() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; alias : aliases) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; aliasRef : alias.aliasesRef) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; ref : aliasRef.refs) { int index = GetAlias(ref.name.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { ref.aliasIndex = index; ref.refer2hardware = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int l = <span class="hljs-number"><span class="hljs-number">0</span></span>; l &lt; haliases.size(); l++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringUtils::IsEqual(haliases[l].name.c_str(), ref.name.c_str())) { ref.aliasIndex = l; ref.refer2hardware = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { printf(<span class="hljs-string"><span class="hljs-string">"alias %s has invalid reference %s"</span></span>, alias.name.c_str(), ref.name.c_str()); } } } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; alias : aliases) { CheckDeadEnds(alias); } }</code> </pre><br>  In the linking code, there is the CheckDeadEnds method.  The purpose of the method is to identify circular references, since  such links cannot be processed and protection against them is needed. <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Controls::CheckDeadEnds(Alias&amp; alias) { alias.visited = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; aliasRef : alias.aliasesRef) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; ref : aliasRef.refs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.aliasIndex != <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; !ref.refer2hardware) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aliases[ref.aliasIndex].visited) { ref.aliasIndex = <span class="hljs-number"><span class="hljs-number">-1</span></span>; printf(<span class="hljs-string"><span class="hljs-string">"alias %s has circular reference %s"</span></span>, alias.name.c_str(), ref.name.c_str()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CheckDeadEnds(aliases[ref.aliasIndex]); } } } } alias.visited = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  Now we go to the method of polling the state of hardwired aliases: <br><br><pre> <code class="actionscript hljs">bool Controls::GetHardwareAliasState(int index, AliasAction action) { HardwareAlias&amp; halias = haliases[index]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (halias.device) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Keyboard: { <span class="hljs-comment"><span class="hljs-comment">//code that access to state of keyboard break; } case Mouse: { //code that access to state of mouse break; } } return false; } bool Controls::GetHardwareAliasValue(int index, bool delta) { HardwareAlias&amp; halias = haliases[index]; switch (halias.device) { case Keyboard: { //code that access to state of keyboard break; } case Mouse: { //code that access to state of mouse break; } } return 0.0f; }</span></span></code> </pre><br>  Now the polling code for the aliases themselves: <br><br><pre> <code class="actionscript hljs">bool Controls::GetAliasState(int index, AliasAction action) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-number"><span class="hljs-number">-1</span></span> || index &gt;= aliases.size()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>f; } Alias&amp; alias = aliases[index]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; aliasRef : alias.aliasesRef) { bool val = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; ref : aliasRef.refs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.aliasIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.refer2hardware) { val &amp;= GetHardwareAliasState(ref.aliasIndex, Active); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { val &amp;= GetAliasState(ref.aliasIndex, Active); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action == Activated &amp;&amp; val) { val = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; ref : aliasRef.refs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.aliasIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.refer2hardware) { val |= GetHardwareAliasState(ref.aliasIndex, Activated); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { val |= GetAliasState(ref.aliasIndex, Activated); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } float Controls::GetAliasValue(int index, bool delta) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-number"><span class="hljs-number">-1</span></span> || index &gt;= aliases.size()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>f; } Alias&amp; alias = aliases[index]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; aliasRef : alias.aliasesRef) { float val = <span class="hljs-number"><span class="hljs-number">0.0</span></span>f; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto&amp; ref : aliasRef.refs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.aliasIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.refer2hardware) { val = GetHardwareAliasValue(ref.aliasIndex, delta); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { val = GetAliasValue(ref.aliasIndex, delta); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fabs(val) &gt; <span class="hljs-number"><span class="hljs-number">0.01</span></span>f) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val * aliasRef.modifier; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>f; }</code> </pre><br>  And the last thing is a poll of debugging keys: <br><br><pre> <code class="actionscript hljs">bool Controls::DebugKeyPressed(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name, AliasAction action) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!allowDebugKeys || !name) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (debeugMap.find(name) == debeugMap.end()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetHardwareAliasState(debeugMap[name], action); } bool Controls::DebugHotKeyPressed(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name2, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char* name3) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!allowDebugKeys) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } bool active = DebugKeyPressed(name, Active) &amp; DebugKeyPressed(name2, Active); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name3) { active &amp;= DebugKeyPressed(name3, Active); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (active) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DebugKeyPressed(name) | DebugKeyPressed(name2) | DebugKeyPressed(name3)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  There is still a function to update the states: <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Controls::Update(float dt) { <span class="hljs-comment"><span class="hljs-comment">//update state of input devices }</span></span></code> </pre><br>  That's all.  The system turned out quite simple, with a minimum amount of code.  At the same time, it effectively solves the problem of polling the states of input devices. <br><br>  <a href="https://github.com/ENgineE777/Controls">Link to the example of using a working system</a> <br><br>  Also, this system was written for an engine called Atum.  <a href="https://github.com/ENgineE777/Atum">The repository of all the sources of the engine</a> - they have a lot of interesting things. </div><p>Source: <a href="https://habr.com/ru/post/343258/">https://habr.com/ru/post/343258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343248/index.html">Dagger 2 for novice Android developers - Introduction</a></li>
<li><a href="../343250/index.html">Dagger 2 for novice Android developers. The introduction of dependencies. Part 1</a></li>
<li><a href="../343252/index.html">Review of music software code defects. Part 5. Steinberg SDKs</a></li>
<li><a href="../343254/index.html">Azure Stack: A bit of theory</a></li>
<li><a href="../343256/index.html">Configure Powershell API Connection to the Azure Pack Infrastructure Cloud</a></li>
<li><a href="../343264/index.html">Cross pollination: manage Linux from under Windows, and vice versa</a></li>
<li><a href="../343266/index.html">Reliable infrastructure for a cloudy b2b startup</a></li>
<li><a href="../343268/index.html">"Automatic Spam Detector". Or "What were Hemingway, Huxley, and Postman warned about?"</a></li>
<li><a href="../343270/index.html">Continuous integration, continuous delivery, continuous deployment: just a nested doll</a></li>
<li><a href="../343272/index.html">Contracts are like debugging.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>