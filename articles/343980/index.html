<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DNS tunnel, PsExec, keylogger: parse the scheme and technical tools of attack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article " One quarter in the life of SOC. Three incidents without bills "very actively plowed, so we decided to tell about another interesting att...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DNS tunnel, PsExec, keylogger: parse the scheme and technical tools of attack</h1><div class="post__text post__text-html js-mediator-article">  The article " <a href="https://habrahabr.ru/company/solarsecurity/blog/333816/">One quarter in the life of SOC.</a>  <a href="https://habrahabr.ru/company/solarsecurity/blog/333816/">Three incidents without bills</a> "very actively plowed, so we decided to tell about another interesting attack, the investigation of which we recently engaged. <br><br>  There is an opinion that international corporations and large companies, which keep up with the times in providing services to their clients, also precisely build processes in all areas of their activities, including information security.  Unfortunately, this is not always the case. <br><br>  Some time ago, a large company with a developed infrastructure turned to us for help.  The problem was strange events in the infrastructure of the company: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Workstations and servers suddenly went to reboot and were removed from the domain. </li><li>  Users found that their account is locked. </li><li>  Computers of some employees began to "slow down" for no apparent reason. </li></ol><br><img src="https://habrastorage.org/webt/eu/kn/ec/euknecun9xazfqvydvixn5brbiq.jpeg"><br><a name="habracut"></a><br>  To analyze the situation, we connected the main infrastructure sources to the SIEM system located in the Solar JSOC cloud.  To do this, we placed a collector server to collect logs at the customer‚Äôs site and built a site-to-site between the sites.  In parallel, the company was sent instructions on how to set up the required level of audit, as well as a detailed description of the preparatory work for connecting the source. <br><br>  At the first stage, we connected firewalls and proxies, antivirus, logs of domain controllers and DNS.  By the evening of the next day we had logs of all the necessary systems. <br><br>  The first thing that could be detected was an appeal from 12 workstations to Corkow / Metel management servers.  It turned out that for more than two years, the client parts of one of the modifications of the Win32 / Corkow virus remained unnoticed by anyone in the company's infrastructure, despite the presence of anti-virus software.  The malware sent telemetry to the long-shut down management servers (the domain names of the servers were named after two great Russian artists and are widely known to security analysts).  The anti-virus vendor, whose software was used in the company, did not add the known signatures to its databases, therefore, it could not detect the virus. <br><br>  But the matter turned out to be not in this, albeit a sensational, but no longer a dangerous virus.  Literally after several hours of monitoring, for the first time in the actual practice of Solar JSOC, a full-fledged, non-test, DNS tunnel was sent, sending information from several hosts of the company's infrastructure. <br><blockquote>  DNS-tunnels can be called delights in the daily life of a security guard.  They are used quite rarely, but recently they have been highlighted in a number of high-profile cases of international scope as a channel for displaying information outside the company's perimeter. <br><br>  But the danger of DNS tunnels lies not only in the fact that they can stealthily steal data from the infrastructure.  DNS tunnels allow you to build a reverse shell with an end host, which allows you to control its actions remotely. <br><br>  Despite the fact that DNS tunnels are a very old topic, and all IPS and NGFW solutions must detect them, in practice this is far from the case.  The slightest change of parameters (for example, the transfer of payload in the key field or another field of the standard DNS format, or outside the standard fields of the DNS query) makes it easy to bypass the standard signatures. <br></blockquote>  First of all, measures were taken to block external addresses on all edge network devices. <br><br>  Immediately after the discovery of the company, a request was sent to investigate the detected sources of DNS tunnels.  Several machines were connected at the local log level, and the process of taking images was started for further research. <br><br>  When connecting the hosts, Solar JSOC specialists encountered the first difficulty - the Security Log was empty on all machines.  At the same time, the image was investigated, and then a second difficulty arose - USN (Update Sequence Number) and MFT (Master File Table) did not contain any significant information, the latter - due to frequent planned defragmentation of disks. <br><br>  The first essential information was found in the logs of the domain controllers - access to the hosts under the domain administrator account was detected there.  Log in with logon type 3 - network input. <br><br>  Further, analyzing on all potentially compromised System Log hosts that have not been cleared, we discovered the installation of the <b>it_helpdesk</b> service.  After analyzing the MD5 sums, it became clear that this is the renamed PsExec utility.  The company's IT department confirmed that this software is not a corporate standard of administration and is not used by employees. <br><blockquote>  PsExec is part of PsTools, a free utility package developed by Sysinternals and then acquired by Microsoft.  They are designed to simplify the administration of Microsoft Windows operating systems.  The PsExec utility itself allows you to remotely execute processes. <br><br>  PsExec allows you to redirect input and output data of a remotely executed executable program by using SMB and the hidden $ ADMIN share on a remote system.  Using this resource, PsExec uses the Windows Service control Manager API to start the PsExecsvc service on a remote system, which creates a named pipe, which PsExec runs on. <br></blockquote><br>  After that, the information security department of the company, using the centralized infrastructure management system, identified all the hosts on which the service had ever been launched.  The total number of such hosts has exceeded 40 units. <br><br>  Now back to the study of images of workstations.  An analysis of the current state of the file system of one of the machines and the reproduction of the infection under laboratory conditions gave a clear chronology of the infection: <br><br>  <b>Stage I</b> <b><br></b> <br><ul><li>  Rename the original system_dll.dll library to system_dll2 and create the system_dll.dll malicious object.  In doing so, system_dll.dll calls system_dll2 for functions that are not defined in its code.  system_dll.dll is a malicious object of the PE type, which serves to load the _________. dll library. </li><li>  Creating _________. Dll - is a malicious object of PE type, which is used to establish connection with arbitrary servers using the DNS protocol and execute various commands.  This library is loaded by the malicious object system_dll.dll. </li><li>  The last time it-helpdesk was started on the machine, the C: \ Windows \ system32 \ shutdown.exe object is supposedly launched to initiate the operating system reboot.  This reboot is required for the System Service to load the System_dll.dll malicious library into its address space. </li></ul><br>  <b>Stage II</b> <b><br></b> <br><ul><li>  After the operating system has been restarted, error events of the rezolv of the domain random symbols.xxxxx.su appear, which may indicate the functioning of the hidden data channel using the DNS protocol (arbitrary data is transmitted in the domain name of the 3rd level). </li><li>  Creation of the Windows / System32 / malware_dll.dll library, which is a malicious object of the PE type, used to intercept data entered from the keyboard.  The intercepted data is stored in the% USER% / AppData / LocalLow / NTUSER.DAT file.  The data in the file is encoded using byte-coding with subtraction of byte 10H. </li><li>  Creation on the attacked host of a malicious object jusched.exe, which serves to reload the malware_dll.dll library.  At the same time, the jusched.exe object is registered in the autoload (HKLM \ Software \ Microsoft \ Windows \ CurrentVersion \ Run registry key), this means that the system will load this object at the start of the session from any user. </li></ul><br>  <b>Stage III</b> <b><br></b> <br><ul><li>  At the subsequent creation of a user session, his profile is loaded, the keylogger is started, the LocalLow / NTUSER.DAT file is created and the keylogger results are recorded in it for the entire user session. </li><li>  Also at this stage, the archiver is launched from the rar.exe command line in order to create the archive C: \ ProgrammData \ 0.0.  This archive contains a shadow copy of the SAM file and the registry branch HKLM \ SYSTEM.  This file bundle can be used to extract account hashes from a SAM file. </li><li>  In some cases, this stage is accompanied by multiple operating system reloads, execution of the wevtutil, gpscript, nslookup, cmdkey, etc. commands, as well as clearing the Application log. </li><li>  On one of the studied machines, the creation and multiple launches of the tvnserver.exe object were recorded while the malicious users.exe object appeared on the machine and the keys 000 and 001 were written to the HKLM \ Software \ Corporation registry key with the malware configuration. </li></ul><br>  The general pattern of infection is as follows: <br><br><img src="https://habrastorage.org/webt/gv/fs/6y/gvfs6yhhy_6okzoadmc9tysvabe.png"><br><br><h3>  Description of the tools used to implement the attack <br></h3><br>  The following malware components were used to launch an attack on the images of workstations and servers studied: <br><br><table border="1"><tbody><tr><td width="151"><p>  <b>Component name</b> <br></p></td><td width="435"><p>  <b>Component assignment</b> <br></p></td></tr><tr><td width="151"><p>  Malware_dll.dll <br></p></td><td width="435"><p>  Keylogger (32-bit version) <br></p></td></tr><tr><td width="151"><p>  Malware_dll64.dll <br></p></td><td width="435"><p>  Keylogger (64-bit version) <br></p></td></tr><tr><td width="151"><p>  Bach.dll <br></p></td><td width="435"><p>  Renamed the original System_dll.dll library, which is a SystemService service <br></p></td></tr><tr><td width="151"><p>  System_dll.dll <br></p></td><td width="435"><p>  A library that, when the System_Service service starts, is swapped into svchost.exe.  System_dll.dll supports the same calls as system_dll2.dll by redirecting all these functions to system_dll2.dll.  Pulls up _________. Dll.  Is a 32-bit version <br></p></td></tr><tr><td width="151"><p>  System_dll.dll_ <br></p></td><td width="435"><p>  64-bit version of System_dll.dll <br></p></td></tr><tr><td width="151"><p>  _________. dll <br></p></td><td width="435"><p>  BackDoor, 32-bit version <br></p></td></tr><tr><td width="151"><p>  _________. dll_ver2 <br></p></td><td width="435"><p>  64-bit version _________. Dll <br></p></td></tr><tr><td width="151"><p>  S64 <br></p></td><td width="435"><p>  Analogue System_dll.dll for x64 architecture <br></p></td></tr><tr><td width="151"><p>  P64 <br></p></td><td width="435"><p>  Analog _________. Dll for x64 architecture <br></p></td></tr><tr><td width="151"><p>  It_helpdesk.exe <br></p></td><td width="435"><p>  Renamed PsExesvc.exe (a PSExec component that is created and launched on a remote machine in order to perform specified actions <br></p></td></tr><tr><td width="151"><p>  Users.exe <br></p></td><td width="435"><p>  BackDoor.  The functionality is similar to _________. Dll, but disguised as jusched.exe - ‚ÄúJava Update Scheduler‚Äù <br></p></td></tr></tbody></table><br><h3>  Malicious activity </h3><br><ol><li>  <b>Malware_dll.dll:</b> <br><ul><li>  Creating the file "\% APPDATA% \ LocalLow \ NTUSER.DAT". </li><li>  Creating mutex "mbowefvncwiomcowermg32". </li><li>  Sets the keystroke capture on the keyboard. </li><li>  Encrypt the data and then write to the file from the first paragraph. </li></ul><br></li><li>  <b>System_dll.dll:</b> <br><ul><li>  Autorun via System Service. </li><li>  Download _________. Dll. </li></ul><br></li><li>  <b>_________. dll and users.exe:</b> <br><ul><li>  Sending DNS addresses to rezolv: <br>  - <a href="http://www.gf8ealht9d22________________.com/">www.gf8ealht9d22________________.com</a> <br>  - 832v1hda31sqfcl5bh81lmqk74z.xxxxxxxxx.com <br>  - 13bmvqdr1ju64dqm6n8877hbo0z.xxxxxxxxx.com </li><li>  Sending DNS packets to the management server (xxxxx.su). </li><li>  Execution of commands received from the management server. </li><li>  It is possible to create registry keys for storing data between process restarts in HKLM or HKCU branches: <br>  - \ Software \ Corporation \ 000 <br>  - \ Software \ Corporation \ 001 <br>  - \ Software \ Corporation \ 002 </li></ul></li></ol><br><h3>  Client communication with the server <br></h3><br>  All server communication with the client is encrypted.  Encryption key: 25 d9 01 4c 21 c9 ed 89 86 14 8d 05 _________ <br><br>  The virus sends DNS-packets to the management server for a resolv.  The DNS name, starting with the third subdomain, is encoded data. <br><br>  Packets of the form &lt;27 symbols&gt; .xxxxx.su are sent to the server.  The sequence may be more than 27 characters, but the minimum batch of 27 characters.  A sequence of 27 characters is the encrypted data that the client sends to the server.  This package does not carry any information other than pseudo-random numbers and the hash-sum of the package.  Pseudo-ordinal numbers are needed so that after all the transformations the packages do not look like each other.  A packet of 27 characters tells the server that it is ready to accept the command for processing.  An example of such a package: <br><br><img src="https://habrastorage.org/webt/jb/ot/jm/jbotjmvqrp4bzabjgvf4drvf60y.jpeg"><br><br>  In response, a command comes in the form of 6 ipv4 addresses - 24 bytes of data.  These addresses are written sequentially and sorted by the low octet.  Rejecting the lower octets, we get a sequence of 18 bytes. <br><br>  The first byte is the amount of unused data (n = 1-3). <br>  The last n bytes are pseudorand and are not used further. <br>  The remaining bytes are encrypted data with the key above. <br>  The first three bytes are a pseudo-random number and a hash-sum of the packet, which makes one and the same command from the server visually different, which is why ip-addresses seem random.  The rest is the team. <br><br><h3>  Next Steps and Mitigation <br></h3><br>  At the first stage of the search for indicators, images of four workstations from which active DNS tunnels were recorded were analyzed. <br><br>  After identifying the host and network indicators, as well as the general scheme of actions of the attackers, it was necessary to check the entire infrastructure both to identify the source of infection and to search for all compromised nodes. <br><br>  The overall picture of the search for compromise indicators was as follows: <br><br><img src="https://habrastorage.org/webt/rk/sj/mc/rksjmcgc8jv0ep3n-cksdy__xdo.png"><br><br>  The search was carried out both by Solar JSOC specialists and by company employees.  It took a total of 3 days to search.  Scope of infected systems grew to 64, the number of compromised accounts potentially increased to the total number of company employees, since one of the compromised machines was a domain controller. <br><br>  At the second stage, several more machines were chosen for the search for additional indicators of compromise.  Images, dumps were removed, and it was possible to begin the process of "reloading" compromised hosts. <br><br>  In the case of the discovery of such a massive, prolonged and deep infection, the process of cleaning out ‚Äútails‚Äù is very difficult and long.  The sequence of actions was as follows: <br><br><ol><li>  Work with accounts: <br><ul><li>  Change passwords for all specified compromised accounts, including accounts from business applications. </li><li>  The privileges of service accounts were limited, a ban was imposed on the use of accounts with domain administrator rights for the operation of services. </li></ul>  The total duration of this stage was about two weeks, primarily due to technological accounts. </li><li>  At the time of working with accounts, a moratorium was imposed on the use of remote access by employees, with the exception of IT administrators.  In parallel, a second authentication factor was launched for them. </li><li>  Typical gaps of organizations with developed infrastructure are closed: <br><ul><li>  Direct access to the Internet bypassing the proxy. </li><li>  Removed software classified as not-a-virus and actively using the Internet. </li><li>  The profile of open ports on the perimeter was assembled, the excess was verified and closed for a hot one, since the incident that took place allowed it. </li></ul></li><li>  Administrators of application systems strengthened control over actions and transactions performed in critical business applications, especially those related to financial transactions, transactions within bonus programs and loyalty programs, access to client and partner databases, etc. </li><li>  For IT administrators, a total ban was imposed on working with critical business applications from local accounts on their AWPs.  Everything was transferred to domain accounts with limited privileges under the control of the monitoring system. </li></ol><br><h3>  Key recommendations and monitoring measures <br></h3><br>  Attackers always reserve their access to the infrastructure, therefore, in parallel, full-fledged monitoring of incidents and the profiling of all activities were carried out. <br><br>  There was a separate difficulty with the latter, since, having collected a profile in two weeks, it is impossible to call it legitimate with complete certainty, because intruders could still be in the infrastructure.  Therefore, it was necessary to coordinate all the collected activities with the company and, later on, to fix the collected profiles.  General recommendations for identifying backup accesses were as follows: <br><br><ol><li>  To audit the software installed on workstations and servers in order to identify remote management tools and illegitimate software. </li><li>  Control the launch of programs on critical computers and company servers, enter ‚Äúwhite lists‚Äù of allowed software, especially with regard to remote management tools. </li></ol><br>  At the same time, Solar JSOC monitored activity on critical servers and workstations in the following areas: <br><br><ul><li>  Network requests to known dangerous and malicious resources, as well as attempts to DNS requests to malicious domains. </li><li>  Privileged account activity - reports are daily sent to responsible employees and account holders for verification of actions. </li><li>  Changes to privileged user groups. </li><li>  Running processes on critical servers and workstations. </li><li>  Changes in system directories and critical registry branches for illegitimate executables, libraries and parameters. </li><li>  Use of remote control systems. </li><li>  Anomalies in DNS traffic. </li><li>  Virus activity on critical hosts. </li><li>  Malicious mailings. </li><li>  Anomalies in connection profiles to critical servers. </li><li>  Misuse of service accounts. </li></ul><br><h3>  Key findings and results of the incident investigation <br></h3><br>  After the adoption of operational measures to block the threat, there was time for the information on the full report of the incident: <br><br><ul><li>  The channel of entry of malware to infected machines was an account already compromised at the time of the infection, with domain administrator privileges, which was used from several machines on the company's LAN. </li><li>  The PsExec tool was used to transfer malicious files to the machine, execute remote control commands and terminate the infection of machines with the keylogger. </li><li>  Traces of other remote control software found on the infected machines under investigation were found several years ago.  Among the RAT were TIghtVNC, WinVNC, Pointdev. </li><li>  As a result of the keylogger, as a rule, the user's credentials from the OS and a number of business applications, his email correspondence, critical password information files from the servers of key business applications, and passport data of employees were compromised. </li><li>  A channel for further remote control and transmission of information to attackers was a DNS tunnel. </li></ul><br>  As a final thought, I would like to note that the detection of similar incidents is the task of the Security Operations Center, but even without it, something can be done if we organize the work with the company's ordinary employees and constantly increase their Security Awareness. <br><br>  Attackers often try to hide their activity from the information security service and IT administrators, since these categories of employees are competent in the field of information security and understand that various anomalies can be caused by external influences.  At the same time, hackers often neglect to hide their actions from ordinary users.  Increased load on the computer, strange actions on the system, suddenly opened or closed applications, the emergence of new files, icons, installed applications that the user notices can serve as an indicator of the system being compromised.  Therefore, security officers need to be attentive to incoming requests, complaints from company personnel and to motivate employees to inform those responsible for the anomalies noted. </div><p>Source: <a href="https://habr.com/ru/post/343980/">https://habr.com/ru/post/343980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343970/index.html">On the way to seizing the world. Vivaldi for ARM</a></li>
<li><a href="../343972/index.html">My Body Gadget (Part # 1)</a></li>
<li><a href="../343974/index.html">Performance as Perception: Managing Patience</a></li>
<li><a href="../343976/index.html">CRM system or Help Desk? What is the fundamental difference, where does the confusion come from, and what is on the Help Desk market?</a></li>
<li><a href="../343978/index.html">RAIDIX and Intel Luster: how to make a chandelier on a lot of light bulbs</a></li>
<li><a href="../343982/index.html">IBM Connections and Verse cloud services: feature overview</a></li>
<li><a href="../343984/index.html">What you need to know about chat bots?</a></li>
<li><a href="../343988/index.html">Dart: how to start acquaintance with the language?</a></li>
<li><a href="../343992/index.html">Report from mitapa Autumn Postgres in Raiffeisenbank</a></li>
<li><a href="../343994/index.html">How we decided to introduce Tomato in the company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>