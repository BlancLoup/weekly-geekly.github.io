<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Undocumented features of undocumented features: Transfer ref to another stream</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I never had a question: ‚Äú how can I save / transfer to another stream a link to a field? ‚Äù? The logical assumption would be ‚Äúpass the ref to the metho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Undocumented features of undocumented features: Transfer ref to another stream</h1><div class="post__text post__text-html js-mediator-article">  I never had a question: ‚Äú <a href="https://www.google.com.ua/search%3Fq%3Dstore%2Breference%2Bc%2523">how can I save / transfer to another stream a link to a field?</a> ‚Äù?  The logical assumption would be ‚Äúpass the ref to the method and save.  Stop, oh shi ~. ‚Äù  Yes, <b>refs are</b> not saved (and yet, you cannot use closures on them, so creating a function inside such a method and creating a stream from it will not work either).  But you can turn the <b>ref</b> into a <a href="http://msdn.microsoft.com/en-us/library/system.typedreference.aspx">TypedReference</a> using the undocumented keyword <a href="http://stackoverflow.com/questions/9033/hidden-features-of-c">__makeref</a> .  Alas, <b>TypedReference</b> cannot be directly stored in the field and <b><i>does not inherit</i></b> from <b>System.Object</b> , so caste is also impossible using conventional methods (and indeed there are a whole bunch of restrictions imposed on their use).  It would seem a dead end.  But that's not all - there is also a <a href="http://msdn.microsoft.com/en-us/library/system.runtimeargumenthandle.aspx">RuntimeArgumentHandle</a> , which has <b>TypedReference</b> properties, with one exception - after a tricky cast in <b>System.Object</b> , you can still use it as long as the stack frame in which it was created is alive.  About this post. <br><a name="habracut"></a><br><br><h4>  TypedReference </h4><br>  <b>TypedReference</b> itself is the <b>most</b> amazing thing - you can wrap <b>ref</b> in it and transfer another method (that is, from a method, one of whose parameters is <b>ref</b> 'om).  However, the methods of this structure do not allow us to set the value - <b>NotSupportedException</b> expects us to call the appropriate methods.  But it does not matter - there is the keyword <b>__refvalue</b> , which allows not only to get the value, but also to set it.  But it looks rather strange: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Out</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> someInt</span></span></span><span class="hljs-function">)</span></span> { Input(__makeref(someInt)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Input</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TypedReference @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> val = __refvalue(@<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>);<span class="hljs-comment"><span class="hljs-comment">//  __refvalue(@ref, int) = 0;//   someInt }</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Given that the type is set by handles, it will not work, for example, <b>int</b> in <b>string</b> - the test of belonging to a type is still carried out. <br>  At the same time, <b>TypedReference</b> cannot be used in closures either - so in order to create something with a closure on TypedReference, it also will not work. <br><br><h4>  RuntimeArgumentHandle </h4><br>  It is nothing but <b>params</b> , only in profile.  In fact, it represents a kind of <b>TypedReference</b> 's list (access to which is made by constructing <a href="http://msdn.microsoft.com/en-us/library/system.argiterator.aspx">ArgIterator</a> ' a), but it also creates ... I don‚Äôt even know how to describe it: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Out</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> something</span></span></span><span class="hljs-function">)</span></span> { Input(__arglist(something)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Input</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">__arglist</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgIterator(__arglist); }</code> </pre><br><br>  At the same time, the <b>__arglist</b> keyword cannot be used in delegates when they are advertised.  But <b>RuntimeArgumentHandle</b> can be (but only as parameters, <b>TypedReference</b> and <b>RuntimeArgumentHandle</b> cannot be returned from methods).  <b>__arglist ()</b> also cannot be used as an argument to call a delegate, but <b>__arglist is</b> possible.  The meaning of this somewhat vague formulation is better supported by an example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ArgWarrior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RuntimeArgumentHandle argh</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Out</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> something</span></span></span><span class="hljs-function">)</span></span> { (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgWarrior(u =&gt; { } ))(__arglist(someting));<span class="hljs-comment"><span class="hljs-comment">//  Input(new ArgWarrior(u =&gt; { } ), __arglist(someting); } void Input(ArgWarrior argh, __arglist) { argh(__arglist);//   }</span></span></code> </pre><br><br>  So I got to the key point of this Marlezonsky ballet: delegates. <br><br><h4>  Manipulations of _methodPtrAux as a way of exquisite bullying of delegates </h4><br><img src="https://habrastorage.org/storage3/76c/32c/572/76c32c5722e2d59daa338aed61515e63.jpg" align="left">  <b>_methodPtrAux</b> is the fourth field in any delegated type that will play a key role here.  What is the point?  The bottom line is that <b>_methodPtrAux</b> stores a pointer to an already jit method.  By writing arbitrary unmanaged code by that pointer, this unmanaged code can be executed in this way.  But this is not the point.  The delegate remains usable even after replacing the <b>_methodPtrAux</b> value, and when you call it, control will go exactly where the value of this field indicates.  Thus, having two delegates with different input parameters, I can replace the pointer from delegate <b>a</b> with the pointer from delegate <b>b</b> .  Even if they have a different set of arguments, everything will work.  The key point will be the fact that even if the types of the corresponding arguments are different, clr will not forget the alarm - the int will be empty in string, <s>all desires will be fulfilled, no one will go offended</s> , or ... <b>RuntimeArgumentHandle</b> will be converted to <b>System.Object</b> : <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Encast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RuntimeArgumentHandle @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Uncast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseWith</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Encast en, __arglist</span></span></span><span class="hljs-function">)</span></span> { en(__arglist); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> m_storedRef; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Engage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span></span><span class="hljs-function">)</span></span> { Encast en = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Encast(@<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> =&gt; { }); Uncast un = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uncast(o =&gt; { m_storedRef = o;<span class="hljs-comment"><span class="hljs-comment">//     &lt;b&gt;en&lt;/b&gt;. }); typeof(Encast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[3].SetValue(en, typeof(Uncast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[3].GetValue(un));//   en UseWith(en, __arglist(__makeref(@object))); // }</span></span></code> </pre><br><br>  As you can see from the lambda, I immediately save the resulting value in a static field.  Yes, there is one incomprehensible limitation - if you store <b>o</b> in a non-static field, then you can drop clr (read-write protected memory).  Even if the target field is not a field, but an object field that is stored in a static field (for example, Dictionary) everything should go smoothly.  The lambda argument in the debugger looks somewhat strange: you can only see "{object}" (without quotes) when viewing it and nothing more.  Attempting to retrieve a type or result in a <b>String</b> does not bode well (you can drop clr) <div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  But if you turn this trick with <b>TypedReference</b> , you can see something else interesting (I leave it to readers for self-study. You can try to play <b>int</b> , which is also curious). </div></div><br>  The inverse transform is similar.  The same stack frame is saved using monitors: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> m_locker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//... Monitor.Enter(m_locker); Monitor.Exit(m_locker);</span></span></code> </pre><br><br>  <b>m_locker is</b> already pre-locked from another thread, so execution stops, so  <b>RuntimeArgumentHandle</b> remains on the stack without being destroyed. <br>  The full program code looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ThreadJiggler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Encast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RuntimeArgumentHandle @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Uncast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> m_storedRef; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> m_locker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> m_useFlag; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> @v = <span class="hljs-string"><span class="hljs-string">"means \"vendetta\""</span></span>; Victim1(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> @v); Console.WriteLine(@v); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseWith</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Encast en, __arglist</span></span></span><span class="hljs-function">)</span></span> { en(__arglist); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Thread m_someThread; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Victim1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span></span><span class="hljs-function">)</span></span> { Thread t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { Monitor.Enter(m_locker); { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; !m_useFlag; ) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>); } Encast en = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Encast(@<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> =&gt; { TypedReference tr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgIterator(@<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>).GetNextArg(); __refvalue( tr, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>; }); Uncast un = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uncast(o =&gt; { m_storedRef = o; }); <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Uncast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[<span class="hljs-number"><span class="hljs-number">3</span></span>].SetValue(un, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Encast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[<span class="hljs-number"><span class="hljs-number">3</span></span>].GetValue(en)); un(m_storedRef); } Monitor.Exit(m_locker); }); t.IsBackground = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; t.Start(); { Encast en = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Encast(@<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> =&gt; { }); Uncast un = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uncast(o =&gt; { m_storedRef = o; m_useFlag = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Monitor.Enter(m_locker); Monitor.Exit(m_locker); }); <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Encast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[<span class="hljs-number"><span class="hljs-number">3</span></span>].SetValue(en, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Uncast).GetFields(System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)[<span class="hljs-number"><span class="hljs-number">3</span></span>].GetValue(un)); UseWith(en, __arglist(__makeref(@<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>))); } } } }</code> </pre><br><br>  At the end of <b>Main,</b> you can see that the <b>@v</b> value <b>has</b> changed to 0. </div><p>Source: <a href="https://habr.com/ru/post/192140/">https://habr.com/ru/post/192140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192126/index.html">OS / 2 Death: Killing or Self-Shot?</a></li>
<li><a href="../192128/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ72 (August 24 - 31, 2013)</a></li>
<li><a href="../192130/index.html">foreach</a></li>
<li><a href="../192134/index.html">We get the source code VM / 370</a></li>
<li><a href="../192136/index.html">Building a provider network on Cisco switches using Option 82 and Dynamic ARP Inspection</a></li>
<li><a href="../192144/index.html">CLR Exception Filters</a></li>
<li><a href="../192146/index.html">Copy works in the public domain? National Indian hut to help you</a></li>
<li><a href="../192150/index.html">Installation Guide and Guide for Web Deploy in Windows Server 2008 R2</a></li>
<li><a href="../192152/index.html">The digest of news from the world of mobile development for the last week ‚Ññ22 (August 26 - September 1, 2013)</a></li>
<li><a href="../192160/index.html">NNM-Club is under the threat of blocking and preparing for it, and the Rutor and Opensharing are illegally detained in the Registry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>