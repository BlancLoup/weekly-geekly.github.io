<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to reactive programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. In this article I will run a gallop across Europe, namely, I will tell you what they mean by reactive programming, introduce you to actors, rea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to reactive programming</h1><div class="post__text post__text-html js-mediator-article">  Hello.  In this article I will run a gallop across Europe, namely, I will tell you what they mean by reactive programming, introduce you to actors, reactive streams, and finally, using reactive streams, we will recognize mouse gestures, like in the old Opera and its spiritual heir - Vivaldi . <br><br>  The goal is to introduce the basic concepts of reactive programming and show that everything is not as difficult and scary as it may seem at first glance. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c6/858/157/0c68581574002383d90367c3e6b996c9.jpg" alt="image"><br>  <i><a href="https://www.flickr.com/photos/spacex/25254688767">A source</a></i> <br><a name="habracut"></a><br><h2>  What is reactive programming? </h2><br>  To answer this question, we turn to the <a href="https://www.reactivemanifesto.org/">site</a> .  It has a beautiful picture, which shows 4 main criteria that must be met by reactive applications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/6e5/092/390/6e5092390fa27e7843b59d57da94b8b3.svg" alt="image"><br><br>  The application must be fast, fault tolerant and well scaled. <br>  Looks like "we are for all the good against all the bad," right? <br><br>  What is meant by these words: <br><br><ol><li>  <b>Responsiveness</b> <br><br>  The application should give the user the result in half a second.  This also includes the principle of fail fast - that is, when something goes wrong, it is better to return to the user an error message like ‚ÄúSorry, there was a problem.  Try later "than to make the sea wait for the weather.  If the operation is long, we show the user a progress bar.  If it‚Äôs very long, ‚Äúyour request will be completed on or about March 18, 2042.  We will send you a notification by mail. ‚Äù </li><li>  <b>Scalability</b> is a way to ensure responsiveness under load.  Imagine the life cycle of a relatively successful service: <br><ol><li>  Starting - the request flow is small, the service is spinning on a virtual machine with one core. </li><li>  The request flow increases - virtual kernels have added kernels and requests are processed in several threads. </li><li>  Even more loading - we connect batching - requests to base and to the hard disk are grouped. </li><li>  Even more load - you need to raise more servers and ensure the work in the cluster. <br>  Ideally, the system should scale up or down depending on the load. </li></ol></li><li>  <b>fault tolerance</b> <br><br>  We accept that we live in an imperfect world and anything happens.  In case something goes wrong with our system, we need to provide error handling and ways to restore functionality. </li><li>  Finally, we are encouraged to do all this with a system based on messaging ( <b>message-driven</b> ). </li></ol><br>  Before continuing, I want to dwell on the difference between event-driven systems and message-driven systems. <br><br>  <b>Event-driven:</b> <br><br><ul><li>  Event - the system reports that it has reached a certain state. </li><li>  Subscribers to the event can be many. </li><li>  The chain of events is usually short, and event handlers are near (both physically and in code) with the source. </li><li>  The source of the event and its handlers usually have a common state (physically, they use the same section of RAM for the exchange of information). </li></ul><br>  <b>In contrast to the event-driven, in a message-driven system:</b> <br><br><ul><li>  Each message has only one addressee. </li><li>  Messages are immutable: you can not change something in the received message so that the sender learned about it and was able to read the information. </li><li>  Elements of the system react (or do not react) to receive messages and can send messages to other elements of the system. </li></ul><br>  All this offers us <br><br><h1>  Actor model </h1><br>  Milestones of development: <br><br><ul><li>  The first mention of the actors is in the scientific work of 1973 - Carl Hewitt, Peter Bishop, and Richard Steiger, ‚ÄúA universal modular ACTOR formalism for artificial intelligence,‚Äù </li><li>  1986 - Erlang appeared.  Ericson needed a language for telecommunications equipment that would provide fault tolerance and non-proliferation.  In the context of this article - its main features: <br><br><ul><li>  Everything is a process </li><li>  Messages are the only way to communicate (Erlang is a functional language, and the messages in it are immutable). </li></ul></li><li>  .. </li><li>  2004 - the first version of the Scala language.  Its features are: <ul><li>  Powered by JVM, </li><li>  Functional, </li><li>  For multithreading, an actor model is chosen. </li></ul><br></li><li>  2009 - the implementation of actors separated into a separate library - Akka </li><li>  2014 - Akka.net - it was ported to .Net. </li></ul><br><h1>  What can actors do? </h1><br>  Actors are the same objects, but: <br><br><ul><li>  Unlike ordinary objects, actors cannot call each other's methods. </li><li>  Actors can transmit information <b>only through unchangeable messages</b> . </li><li>  Upon receipt of a message, the actor may <br><ul><li>  Create new actors (they will be lower in the hierarchy), </li><li>  Send messages to other actors </li><li>  Stop actors lower in the hierarchy and yourself. </li></ul></li></ul><br>  Consider an example. <br><br><img src="https://habrastorage.org/webt/ql/wj/cj/qlwjcjyygaw5s7iub_mshc1rbry.jpeg" alt="image"><br><br>  Actor A wants to send a message to actor B. All he has is ActorRef (some address).  Actor B can be anywhere. <br>  Actor A sends letter B through the system (ActorSystem).  The system puts the letter in the mailbox of actor B and the actor B. awakens it. Actor B takes the letter from the mailbox and does something. <br><br>  Compared to calling other methods, it looks unnecessarily difficult, but the model of actors fits perfectly with the real world, if you imagine that actors are people who are trained to do something in response to certain stimuli. <br><br>  Imagine a father and son: <br><br><img src="https://habrastorage.org/webt/gk/o9/s5/gko9s5syabkkpdkg0_v_aimwwis.jpeg"><br><br>  The father sends SMS to the son ‚ÄúClean the room‚Äù and continues to go about his business.  Son reads SMSku and begins cleaning.  Father plays poker in the meantime.  The son finishes cleaning and sends SMS "Finish".  It looks easy, right? <br><br>  Now imagine that father and son are not actors, but ordinary objects that can pull methods from each other.  The father pulls the son for the ‚Äúclean the room‚Äù method and follows him on the heels, waiting until the son finishes cleaning and transfers control back to his father.  Father cannot play poker at this time.  In this context, the model of actors becomes more attractive. <br><br>  Now move on to <br><br><h1>  Akka.NET </h1><br>  Everything that is written below is true for the original Akka for the JVM, but for me C # is closer than Java, so I‚Äôll use the example of Akka.NET. <br><br><h3>  So what advantages does Akka have? </h3><br><ul><li>  Multithreading through messaging.  You no longer have to suffer with all sorts of locks, semaphores, mutexes and other delights characteristic of classical multithreading with shared memory. </li><li>  Transparent communication between the system and its components.  No need to worry about the complex network code - the system will find the recipient of the message and guarantee the delivery of the message (here you can insert a joke about UDP vs TCP). </li><li>  A resilient architecture that can automatically scale up or down.  For example, under load, the system can raise additional nodes of the cluster and evenly distribute the load. </li></ul><br>  But the topic of scaling is very extensive and worthy of a separate publication.  Therefore, I will tell you more about the feature that will be useful in all projects: <br><br><h2>  Error processing </h2><br>  Actors have a hierarchy - it can be represented as a tree.  Each actor has a parent and can be "children." <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99e/57e/919/99e57e919cbea8e6761b75537c3f507a.png" alt="image"><br>  <i><a href="https://getakka.net/articles/concepts/supervision.html">Akka.NET documentation</a> Copyright 2013-2018 Akka.NET project</i> <br><br>  For each actor, you can install the Supervision strategy - what to do if something went wrong with the ‚Äúchildren‚Äù.  For example, ‚Äúnail down‚Äù an actor who has problems, and then create a new actor of the same type and charge him with the same work. <br><br>  For example, I made an application on Akka.net CRUD, in which the layer of "business logic" is implemented on actors.  The task of this project was to find out whether it is worth using actors in unscalable systems - whether they will make life better or add more pain. <br><br>  How built-in error handling in Akka can help: <br><br><div class="spoiler">  <b class="spoiler_title">Gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1f/oz/ou/1fozoulh0ufwzuyufofz4n8pvbi.gif"><br></div></div><br><ol><li>  everything is good, the application is working, </li><li>  something happened to the repository, and now it gives the result only 1 time out of 5, </li><li>  I set up Supervision strategy to "try 10 times in a second", </li><li>  the application is working again (albeit more slowly), and I have time to figure out what's wrong. </li></ol><br>  Then there is a temptation to say: ‚ÄúWell, I will write such error handling myself, why should any actors be fenced?‚Äù.  Fair remark, but only if the points of failure are few. <br><br>  And some code.  This is how the initialization of the system of actors in the IoC container looks like: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Container</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { system = ActorSystem.Create(<span class="hljs-string"><span class="hljs-string">"MySystem"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> echo = system.ActorOf&lt;EchoActor&gt;(<span class="hljs-string"><span class="hljs-string">"Echo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//stop initialization if something is wrong with actor system var alive = echo.Ask&lt;bool&gt;(true, TimeSpan.FromMilliseconds(100)).Result; container = new WindsorContainer(); //search for dependencies //register controllers //register ActorSystem propsResolver = new WindsorDependencyResolver(container, (ActorSystem)system); system.AddDependencyResolver(propsResolver); actorSystemWrapper = new ActorSystemWrapper(system, propsResolver); container.Register(Component.For&lt;IActorRefFactory&gt;().Instance(actorSystemWrapper)); container.Register(Component.For&lt;IDependencyResolver&gt;().Instance(propsResolver)); }</span></span></code> </pre> <br>  EchoActor is the simplest actor that returns a value to the sender: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EchoActor</span></span> : <span class="hljs-title"><span class="hljs-title">ReceiveActor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EchoActor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Receive&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(flag =&gt; { Sender.Tell(flag); }); } }</code> </pre><br>  To associate actors with a ‚Äúnormal‚Äù code, use the Ask command: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ViewBag.Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CrudActorRef.Ask&lt;IEnumerable&lt;Model&gt;&gt;(DataMessage.GetAll&lt;Model&gt;(), maxDelay); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(res); }</code> </pre> <br><h3>  Total </h3><br>  Pokhimich with actors, I can say: <br><br><ul><li>  Look at them if you need scalability. </li><li>  For complex business logic, it is better not to use them because <ul><li>  Strange Dependency Injection.  To initialize the actor with the necessary dependencies, you must first create a Props object, then give it to the ActorSystem to create the actor of the desired type.  To create Props using IoC containers (for example, Castle Windsor or Autofac) there are ready-made wrappers ‚Äî DependencyResolvers.  But I was faced with the fact that the IoC container was trying to control the lifetime of the dependencies, and after a while the system fell off quietly. <br><br>  * Perhaps, instead of injecting a dependency into an object, this dependency should be issued as a child actor. </li><li>  problems with typing.  ActorRef knows nothing about the type of actor it refers to.  That is, during compilation it is not known whether the actor can process a message of this type or not. </li></ul></li></ul><br><h1>  Part 2: Reactive Streams </h1><br>  And now let's move on to a more popular and useful topic - jet streams.  If you can never meet actors in the course of work, then Rx streams will be useful both in the frontend and in the backend.  Their implementation is in almost all modern programming languages.  I will give examples on RxJs, because nowadays even backend programmers sometimes have to do something in JavaScript. <br><br><img src="https://habrastorage.org/webt/ru/yn/g9/ruyng9clvfa1gh8bd5ai3lpnc5m.jpeg"><br>  <i>Rx-streams are for all popular programming languages</i> <br><br>  <i>‚Äú <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">Introduction to Reactive Programming you've been missing</a> ‚Äù by <a href="https://gist.github.com/staltz">Andre Staltz</a> , under license CC BY-NC 4.0</i> <br><br>  To explain what a jet stream is, I'll start with Pull and Push collections. <br><table><tbody><tr><th></th><th>  Single return value </th><th>  Multiple return values </th></tr><tr><td>  Pull <br>  Synchronized <br>  Interactive </td><td>  T </td><td>  IEnumerable &lt;T&gt; </td></tr><tr><td>  Push <br>  Asynchronous <br>  Reactive </td><td>  Task &lt;T&gt; </td><td>  IObservable &lt;T&gt; </td></tr></tbody></table><br>  Pull collections are what we are all used to in programming.  The most striking example is the array. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> arr = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>];</code> </pre> <br>  It already has data, it will not change this data, but it can give it on request. <br><br><pre> <code class="javascript hljs">arr.forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  Also, before you do something with the data, you can somehow handle them. <br><br><pre> <code class="javascript hljs">arr.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> =&gt;</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span>).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">I</span></span></span><span class="hljs-function"> =&gt;</span></span> ‚Äúmy number is ‚Äù+i).forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  And now let's imagine that initially there is no data in the collection, but it will definitely inform you that they have appeared (Push).  And at the same time, we still can apply the necessary transformations to this collection. <br><br>  For example: <br><br><pre> <code class="javascript hljs">source.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> =&gt;</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span>).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">I</span></span></span><span class="hljs-function"> =&gt;</span></span> ‚Äúmy number is ‚Äù+i).forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  When a value appears in the source, for example, 1, console.log will display ‚Äúmy number is 1‚Äù. <br><br>  How it works: <br><br>  A new entity appears - Subject (or Observable): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> observable = Rx.Observable.create(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">observer</span></span></span><span class="hljs-function">) </span></span>{ observer.next(<span class="hljs-number"><span class="hljs-number">1</span></span>); observer.next(<span class="hljs-number"><span class="hljs-number">2</span></span>); observer.next(<span class="hljs-number"><span class="hljs-number">3</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { observer.next(<span class="hljs-number"><span class="hljs-number">4</span></span>); observer.complete(); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); });</code> </pre> <br>  This is a push-collection that will send notifications about changes in its state. <br><br>  In this case, numbers 1, 2 and 3 will appear in it immediately, 4 seconds later, and then the collection will ‚Äúend‚Äù.  This is such a special type of event. <br><br>  The second entity is the Observer.  He can subscribe to Subject events and do something with the received data.  For example: <br><br><pre> <code class="javascript hljs">observable.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(x)); observable.subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'got value '</span></span> + x), <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(<span class="hljs-string"><span class="hljs-string">'something wrong occurred: '</span></span> + err), <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>), }); observable .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'This is '</span></span> + x) .subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(x));</code> </pre> <br>  Here you can see that one Subject can have many subscribers. <br><br>  It looks easy, but it is not entirely clear why this is needed.  I will give 2 more definitions that need to be known when working with jet streams, and then I will show in practice how they work and in what situations their full potential is revealed. <br><br><h4>  Cold observables </h4><br><ul><li>  Notify about events when someone subscribes to them. </li><li>  The entire data stream is sent anew to each subscriber regardless of the time of the subscription. </li><li>  Data is copied for each subscriber. </li></ul><br>  What this means: let's say the company (Subject) decided to arrange the distribution of gifts.  Each employee (Observer) comes to work and receives his copy of the gift.  No one is left out. <br><br><h4>  Hot observables </h4><br><ul><li>  Try to notify about the event regardless of the presence of subscribers.  If at the time of the event there were no subscribers - the data is lost. </li></ul><br>  Example: in the morning, hot patties are brought to the company for employees.  When they are brought, all the larks fly to the smell and dismantle the pies for breakfast.  And the owls, who came later, no longer get the pies. <br><br><h4>  What situations to use jet streams? </h4><br>  When there is a data stream distributed in time.  For example, user input.  Or logs from any service.  In one of the projects, I saw a samopinny logger who collected events in N seconds and then recorded the whole pack at a time.  The battery code occupied the page.  If Rx streams were used, this would be much simpler: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6e/b1a/396/b6eb1a3960bd8b422c01b6c0a5dd97f0.png" alt="image"><br>  <i>‚Äú <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html">RxJs Reference / Observable</a> , documentation licensed under CC BY 4.0</i> . <br>  <i>(there are many examples and pictures explaining what various operations with jet streams do)</i> <br><br><pre> <code class="javascript hljs">source.bufferTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>).subsribe(doThings);</code> </pre> <br>  And finally, an example of use. <br><br><h2>  Recognize mouse gestures using Rx streams </h2><br>  In the old Opera or its spiritual heir - Vivaldi - it was browser control using mouse gestures. <br><br><div class="spoiler">  <b class="spoiler_title">Gif - mouse gestures in Vivaldi</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xs/ok/eq/xsokeqelkjbtvgrcurbv-wffmog.gif"><br></div></div><br>  That is, you need to recognize the movement of the mouse up / down, right / left and their combinations.  This can be written without Rx streams, but the code will be complex and difficult to maintain. <br><br><h4>  And this is what it looks like with Rx streams: </h4><br>  I will start from the end - I will ask what data and in what format I will look for in the original sequence: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//gestures to look for const gestures = Rx.Observable.from([ { name: "Left", sequence: Rx.Observable.from([{ x: -1, y: 0 }]) }, { name: "Right", sequence: Rx.Observable.from([{ x: 1, y: 0 }]) }, { name: "Up", sequence: Rx.Observable.from([{ x: 0, y: -1 }]) }, { name: "Down", sequence: Rx.Observable.from([{ x: 0, y: 1 }]) }, { name: "Down+Up", sequence: Rx.Observable.from([{ x: 0, y: 1 }, { x: 0, y: -1 }]) }, { name: "Up+Right", sequence: Rx.Observable.from([{ x: 0, y: -1 }, { x: 1, y: 0 }]) } ]);</span></span></code> </pre> <br>  These are single vectors and their combinations. <br><br>  Next, you need to convert mouse events to Rx streams.  All Rx libraries have built-in tools for turning standard events into Observables. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseMoves = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>), mouseDowns = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mousedown'</span></span>), mouseUps = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mouseup'</span></span>);</code> </pre> <br>  Next, I group the mouse coordinates by 2 and find their difference, getting the mouse offset. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseDiffs = mouseMoves .map(getOffset) .pairwise() .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pair</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: pair[<span class="hljs-number"><span class="hljs-number">1</span></span>].x-pair[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: pair[<span class="hljs-number"><span class="hljs-number">1</span></span>].y-pair[<span class="hljs-number"><span class="hljs-number">0</span></span>].y } });</code> </pre> <br>  And I group these movements using the 'mousedown' and 'mouseup' events. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseGestures = mouseDiffs .bufferToggle(mouseDowns, x =&gt; mouseUps) .map(concat);</code> </pre> <br>  The concat function cuts out too short movements and groups movements that roughly match in direction. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-comment"><span class="hljs-comment">//summarize move in same direction return values.reduce((a, v) =&gt; { if (!a.length) { a.push(v); } else { const last = a[a.length - 1]; const lastAngle = Math.atan2(last.x, last.y); const angle = Math.atan2(vx, vy); const angleDiff = normalizeAngle(angle - lastAngle); const dist = Math.hypot(vx, vy); if (dist &lt; 1) return a;//move is too short ‚Äì ignore //moving in same direction =&gt; adding vectors if (Math.abs(angleDiff) &lt;= maxAngleDiff) { last.x += vx; last.y += vy; } else { a.push(v); } } return a; }, []); }</span></span></code> </pre> <br>  If the movement along the X or Y axis is too short, it is reset.  And then only the sign remains from the received offset coordinates.  Thus, we obtain the unit vectors that we were looking for. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> normalizedMouseGestures = mouseGestures.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arr</span></span></span><span class="hljs-function"> =&gt;</span></span> arr.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dist = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.hypot(vx, vy);<span class="hljs-comment"><span class="hljs-comment">//length of vector vx = Math.abs(vx) &gt; minMove &amp;&amp; Math.abs(vx) * treshold &gt; dist ? vx : 0; vy = Math.abs(vy) &gt; minMove &amp;&amp; Math.abs(vy) * treshold &gt; dist ? vy : 0; return v; }) ).map(arr =&gt; arr .map(v =&gt; { return { x: Math.sign(vx), y: Math.sign(vy) }; }) .filter(v =&gt; Math.hypot(vx, vy) &gt; 0) );</span></span></code> </pre> <br>  Result: <br><br><pre> <code class="javascript hljs">gestures.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gesture</span></span></span><span class="hljs-function"> =&gt;</span></span> normalizedMouseGestures.mergeMap( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moves</span></span></span><span class="hljs-function"> =&gt;</span></span> Rx.Observable.from(moves) .sequenceEqual(gesture.sequence, comparer) ).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> x).mapTo(gesture.name) ).mergeAll().subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gestureName</span></span></span><span class="hljs-function"> =&gt;</span></span> actions[gestureName]());</code> </pre> <br>  With the help of sequenceEqual, you can compare the received movements with the original ones and, if there is a match, perform a specific action. <br><br><div class="spoiler">  <b class="spoiler_title">Gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lp/bx/fe/lpbxfeq_bq-mdfybskn0v7wwen8.gif"><br></div></div><br>  ‚Üí <a href="https://jsfiddle.net/conKORD/tg8xw90b/7/">Play with gestures here</a> <br><br>  Please note that, besides gesture recognition, there is also a drawing of both the initial and normalized mouse movements on the HTML canvas.  The readability of the code does not suffer from this. <br><br>  From which follows another advantage - the functionality written with the help of Rx streams can be easily supplemented and expanded. <br><br><h2>  Total </h2><br><ul><li>  Libraries with Rx streams are available for almost all programming languages. </li><li>  Rx streams should be used when there is a stream of events stretched in time (for example, user input). </li><li>  The functionality written using Rx streams can be easily extended and expanded. </li><li>  I did not find significant shortcomings. </li></ul><br><div class="spoiler">  <b class="spoiler_title">useful links</b> <div class="spoiler_text">  <a href="http://www.introtorx.com/">www.introtorx.com</a> <br>  <a href="https://getakka.net/articles/intro/what-is-akka.html">getakka.net/articles/intro/what-is-akka.html</a> <br>  <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html">reactivex.io/rxjs/class/es6/Observable.js~Observable.html</a> <br>  <a href="http://reactivex.io/languages.html">reactivex.io/languages.html</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/432004/">https://habr.com/ru/post/432004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431992/index.html">Biometrics: how is it with us, and with "them"</a></li>
<li><a href="../431994/index.html">Discussion of a free PVS-Studio license for projects hosted on GitHub</a></li>
<li><a href="../431996/index.html">Scientific corporate Smart Engines (or as we went to ICMV 2018)</a></li>
<li><a href="../431998/index.html">We meet Yandex. Phone - now officially</a></li>
<li><a href="../432002/index.html">Microsoft is developing a browser based on Chromium, which will be supplied by default instead of Edge</a></li>
<li><a href="../432006/index.html">The tale of how I was brought to the topic of women's health</a></li>
<li><a href="../432008/index.html">In pursuit of web standards</a></li>
<li><a href="../432012/index.html">How to test smart contracts</a></li>
<li><a href="../432014/index.html">Kali Linux for beginners</a></li>
<li><a href="../432016/index.html">How music and drawing taught me how to program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>