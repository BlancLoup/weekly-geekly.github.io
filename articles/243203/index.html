<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeBSD, dhcp, ip unnumbered and everything is all all ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our small company connects subscribers to the Internet using vlan-per-user technology. 
 So historically, there are both pluses and minuses in this, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeBSD, dhcp, ip unnumbered and everything is all all ...</h1><div class="post__text post__text-html js-mediator-article">  Our small company connects subscribers to the Internet using vlan-per-user technology. <br>  So historically, there are both pluses and minuses in this, but the conversation is not about that now. <br>  Usually, a network of gray addresses is allocated to each vlan, which is then released via NAT to the big world.  But sometimes subscribers want a real white address, and until recently they were given a / 30 network.  That in the realities of the present is very wasteful and subscribers with real addresses are transferred to the connection using SuperVLAN technology (RFC 3069). <br><br><a name="habracut"></a><br><br>  All addresses - both gray and white are given out to subscribers via DHCP.  The DHCP, NAT, and shaper services run on the same server running FreeBSD 9.3.  Iron server is quite normal - Core i7, 8Gb RAM, Intel E1G42ET. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Task:</b> <br><br>  To give each subscriber the address of the same real address that he had, but no longer with a mask / 30, but with a new, general for all mask / 24 and gateway xxx1.  Ensure the inability of the subscriber to work with someone else's real address. <br>  Subscribers with gray addresses continue to issue a network to the subscriber. <br><br>  <b>Building a SuperVlan ala FreeBSD</b> <br><br>  Vlan9 is a technological vlan, nothing is connected to it, traffic will go there for real addresses not yet given out to subscribers. <br>  Vlan10 - subscriber with gray address <br>  Vlan11 and vlan12 are two subscribers with real addresses. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ifconfig</span></span> vlan9 inet <span class="hljs-number"><span class="hljs-number">1.1.1.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ifconfig vlan10 inet <span class="hljs-number"><span class="hljs-number">192.168.10.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ifconfig vlan11 inet <span class="hljs-number"><span class="hljs-number">1.1.1.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> route add <span class="hljs-number"><span class="hljs-number">1.1.1.11</span></span> ‚Äìiface vlan11 ifconfig vlan12 inet <span class="hljs-number"><span class="hljs-number">1.1.1.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> route add <span class="hljs-number"><span class="hljs-number">1.1.1.12</span></span> ‚Äìiface vlan12</code> </pre> <br><br>  We put on the client vlan11 with hands the address 1.1.1.11/24, gw 1.1.1.1 - the Internet client works. <br><br>  If you want traffic to go between clients with real addresses, turn on ProxyARP <br><br><pre> <code class="hljs pgsql">sysctl net.link.ether.inet.proxyall=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br>  (Bridge from private sticky vlan (man bridge) did not work in this case, the reasons will be discussed below) <br><br>  Now let's do the most interesting <br><br>  <b>Distribution of addresses through DHCP</b> <br><br>  Specifically ISC-DHCPD ver 4.3 <br><br>  Addresses must be issued based on the interface from which the request came. <br>  Unfortunately, the authors of isc-dhcpd are firmly convinced that they definitely know better what a sysadmin needs than a sysadmin himself.  And they do not allow him to shoot himself in the leg, chopping off the system administrator's index finger to the very elbow. <br><br>  As a result, you can specify a list of interfaces on which I would like to listen to requests from clients, but if in the dhcpd.conf config not specify a subnet to which the address on this interface falls, then it will be ignored. <br>  And if the same addresses are specified on several interfaces, then DHCPREQ requests will be processed in one subnet. <br>  And you can not register in dhcpd.conf neither subnet, nor pool, nor host, which would be tightly bound to a specific interface. <br><br>  This is a dream, in fact it does not work: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">subnet</span></span> <span class="hljs-number"><span class="hljs-number">1.1.1.11</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255.255.255</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> routers <span class="hljs-number"><span class="hljs-number">1.1.1.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">range</span></span> <span class="hljs-number"><span class="hljs-number">1.1.1.11</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">interface</span></span> vlan11; }</code> </pre><br><br>  Well, well ... There is a DHCP relay.  We start the relay on the necessary ports, which will add Option 82 Agent Circuit ID, and give the dhcpd request. <br><br>  <b>Attempt 1:</b> <br><br>  Since the dhcp interface categorically does not want to listen to the loopback interface, we start an additional vlan5 <br><br>  rc.conf: <br><pre> <code class="hljs pgsql">ifconfig_vlan5=‚Äù<span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>‚Äù dhcrelay_flags =‚Äù-a‚Äù dhcrelay_servers =‚Äù<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>‚Äù dhcrelay_ifaces =‚Äùvlan11 vlan12‚Äù dhcpd_ifaces =‚Äùvlan5 vlan10‚Äù</code> </pre><br><br>  Starting - does not start ... <br>  dhcpd reports that it cannot bind socket. <br>  Although different interfaces for the relay and for the daemon are directly indicated, both of them just in case want to bind the fallback socket to the address *: 67 <br>  what they report here with this line when starting ‚ÄúSending on Socket / fallback‚Äù. <br><br>  Naturally the one who starts the second system says: ‚ÄúBusy!‚Äù <br>  How can I disable this fallback socket I could not find. <br><br>  <b>Attempt 2:</b> <br><br>  Alternative programs are dhcprelya and dhcprelay. <br>  Again they report that they cannot make a bind socket.  We look into the code and understand their fundamental difference from isc-creations.  ISC uses device bpf and snatches its packets from the system almost at the very beginning of the network stack, even before the firewall and other excesses ... Alternators use the standard socket mechanism, but since we have the same address on several interfaces, the second bind is addressed to 1.1.1.1 : 67 the system again reports: ‚ÄúBusy!‚Äù <br><br>  <b>Attempt 3:</b> <br><br>  And let dhcrelay listen to ALL interfaces and forward requests to dhcpd, which will be nailed only to the address 192.168.5.1 <br>  We rebuild dhcpd so that it does not use BPF, but would connect via socket. <br>  To do this, we quickly fix the isc-dhcp43-server port Makefile <br>  Add to it: <br>  CONFIGURE_ARGS + = - enable-use-sockets <br>  We collect, we start - it was launched, but does not work.  Dhcpd logs that it has assigned an address to the client, but the client does not receive a response from dhcpd. <br><br>  We look tcpdump as the client on vlan10, that with gray addresses tries to receive the address. <br>  tcpdump ‚Äìi vlan10 - The request from the client is - there is no response from the server. <br>  tcpdump ‚Äìi vlan5 - silence <br>  tcpdump ‚Äìi lo0 - and here it is interesting: <br>  see udp packet from relay to daemon from address 192.168.5.1 to address 192.168.5.1 <br>  see udp response from the daemon to the relay from the address 192.168.5.1 to the address 192.168.10.1 <br><br>  And here it becomes clear that since dhcrelay listens only through BPF - then the packets that pass through the internal interface lo0 he just does not see, there is no sense in rebuilding dhcrelay to use sockets, then we will return to the situation ‚ÄúAttempt 2‚Äù <br><br>  <b>Attempt 4:</b> <br><br>  We distribute dhcrelay and dhcpd to SEPARATE servers. <br><br>  Server dhcpd rc.conf: <br><pre> <code class="hljs pgsql">ifconfig_vlan5=‚Äù<span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>‚Äù</code> </pre><br><br>  Server dhcrelay rc.conf: <br><br><pre> <code class="hljs pgsql">ifconfig_vlan5=‚Äù<span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>‚Äù dhcrelay_flags =‚Äù-a‚Äù dhcrelay_servers =‚Äù<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>‚Äù</code> </pre><br><br>  Does not work. <br>  Oh yes‚Ä¶. <br>  Recalls tcpdump from ‚ÄúAttempt 3‚Äù, write to dhcpd server <br>  route add 192.168.10.0/24 192.168.5.2 <br>  route add 1.1.1.0/24 192.168.5.2 <br><br>  It works now.  Addresses to the client in vlan10 gives. <br>  Now add to the dhcpd information about customers with real addresses. <br>  The Internet is full of examples with classes in which substrings are cut out from agent id and circuit-id, create subclasses so that several addresses can be allocated to the connection port. <br><br>  One address is enough for me, so it‚Äôs enough to describe the host with this line inside: <br>  host-identifier option agent.circuit-id "vlan11" <br><br>  If you compile SuperVLAN using bridge, then dhcrelay will forward requests from all interfaces connected to the bridge with agent.circuit-id = "bridge0", so that only interfaces with the same addresses and forced routing. <br><br>  <b>Total:</b> <br><br>  Advantages of the solution - the client will automatically receive the new settings, while he will have his old address. <br>  Disadvantages - Second server required <br>  ToDo: Check how the situation with the change of the MAC address of the client is handled.  Whether dhcpd will issue the same real address from the host if it has not yet expired on the previous poppy. <br><br>  And returning to the caring and direct authors isc-dhcpd. <br>  In order for dhcpd to intercept bpf requests that come to the interface, it is necessary to register in the dhcpd.conf config section of the subnet which includes the address on this interface. <br>  At the same time, there is no need to specify which subnet to use for issuing responses through the relay - it searches for matches in all. <br><br>  Here is the dhcpd.conf config <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span> "example.org"; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>, <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">600</span></span>; max-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">7200</span></span>; one-lease-per-client <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; stash-agent-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">conflict</span></span>-detection <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; authoritative; <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-facility local7; subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { } subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } subnet <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> realip1 { <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; host client11 { host-identifier <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> agent.circuit-id "vlan11"; fixed-address <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>; } host client12 { host-identifier <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> agent.circuit-id "vlan12"; fixed-address <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span>; } host client28 { host-identifier <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> agent.circuit-id "vlan28"; fixed-address <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span>; } }</code> </pre><br><br>  PS: Unexpected rake and solution: <br><blockquote>  if anyone needs to raise isc dhcrelay on 8k interfaces <br>  need to change <br>  FD_SETSIZE value in files <br>  /usr/src/sys/sys/select.h <br>  /usr/include/sys/select.h <br><br>  with <br>  #define FD_SETSIZE 1024U <br>  on <br>  #define FD_SETSIZE 16384U <br><br>  Reassemble isc-dhcrelay or isc-dhcpd <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/243203/">https://habr.com/ru/post/243203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243193/index.html">Payler - LIVE!</a></li>
<li><a href="../243195/index.html">Rakes, which I stepped on when crossing CRM with Google Calendar</a></li>
<li><a href="../243197/index.html">DEV Labs 2014 - online conference for Oracle developers</a></li>
<li><a href="../243199/index.html">Haxe: convert source code</a></li>
<li><a href="../243201/index.html">The smartest marketers in the world. Learn from Amazon</a></li>
<li><a href="../243205/index.html">Finger Trees (Part 2. Operations)</a></li>
<li><a href="../243207/index.html">Python implementation of the event-driven paradigm using coroutines</a></li>
<li><a href="../243209/index.html">Are you a pirate? Are you a pirate?</a></li>
<li><a href="../243211/index.html">Oil Rows in R</a></li>
<li><a href="../243213/index.html">Asterisk + Lua + regular update of DEF codes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>