<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>It fell by itself, or the consequence are the cones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here we are apps, and, as the correct and experienced developers, do not forget to insert a crash reporter into it. We get the first reports, open the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>It fell by itself, or the consequence are the cones</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/i3/9a/kz/i39akzyr0q8jkcvylrli-27dlhc.jpeg"></div><br>  Here we are apps, and, as the correct and experienced developers, do not forget to insert a crash reporter into it.  We get the first reports, open the stack, look at the environment, try to reproduce, break off and ask the question ‚Äú <s>What did you say?</s>  But how did it happen? ‚ÄùWhat did the user do that the application collapsed? <br><a name="habracut"></a><br>  And here we‚Äôd really appreciate the application‚Äôs debug logs, or at least the logs of the last user actions that opened, where they were pointing, etc.  The following discussion focuses on logging user actions in a WinForms application and including this log in crash report. <br><br>  The first thing that comes to mind is the naive approach: enter handlers for each user action and add a record to the log.  But this is a lot of work and stupid code.  Okay, then we can do the basic form / control, where we subscribe to the necessary events for everyone who lies inside?  Oh, and it turns out they are able to add and delete, the application is leak-ing and all this is still slowing down because of our code.  But how would we write the same thing, only without the basic forms, tracking changes on the form, subscribing to a bunch of events, and not to slow down? <br><br>  It turns out that everything has already been invented before us - the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms632589(v%3Dvs.85).aspx">hooks</a> !  But, excuse me, what kind of WinForms is this, is this the very same Win32 API ?!  And what to do, <s>you want to live - do not you stir up so checkered</s> , or go? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we are interested in what the user did to fill up the application.  That is, where and how to poke the mouse, what keys I pressed, what I entered, what windows I opened, how the focus moved.  Enough for a start. <br><br>  Mouse hooks, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644988(v%3Dvs.85).aspx">normal</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644986(v%3Dvs.85).aspx">low-level</a> , are responsible for the mouse.  For the keyboard, respectively, keyboard, also <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644984(v%3Dvs.85).aspx">normal</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644985(v%3Dvs.85).aspx">low-level</a> .  We need to monitor input in only one application, so global low-level hooks for us, perhaps, are brute force. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  But low-level hooks are the most for specific tasks, such as adding mouse controls to a console application, which is not a thing of the mouse about a mouse.  Moreover, not just in the console, but in DOS-ovskoe.  Once upon a time, the author, when he was a <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25B4%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2582">fidoshnik,</a> taught <a href="https://ru.wikipedia.org/wiki/GoldED">Golded</a> mouse input precisely with the help of a low-level mouse hook.  As it turned out, it worked in many other dos programs. <br></div></div><br>  And since the usual hooks are enough for us, then you can immediately hang up on the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644981(v%3Dvs.85).aspx">message hooks</a> , there will be a mouse and a keyboard, in one bottle.  Activating windows and moving the focus is convenient to catch in the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644977(v%3Dvs.85).aspx">CBT-hook</a> . <br><br>  Where to dig is clear <br><br><div class="spoiler">  <b class="spoiler_title">Go!</b> <div class="spoiler_text">  We describe Interopes. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HookProc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ncode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, ExactSpelling = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, CharSet = CharSet.Auto)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrentThreadId</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"USER32.dll"</span></span>, CharSet = CharSet.Auto)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetWindowsHookEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idHook, HookProc lpfn, IntPtr hMod, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwThreadId</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"USER32.dll"</span></span>, CharSet = CharSet.Auto)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallNextHookEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hhk, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nCode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"USER32.dll"</span></span>, CharSet = CharSet.Auto)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnhookWindowsHookEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hhk</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  Subscribe: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> WH_GETMESSAGE = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> WH_CBT = <span class="hljs-number"><span class="hljs-number">5</span></span>; IntPtr getMsgHookHandle = SetWindowsHookEx(WH_GETMESSAGE, GetMsgProc, IntPtr.Zero, threadId); IntPtr cbtHookHandle = SetWindowsHookEx(WH_CBT, CbtProc, IntPtr.Zero, threadId) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMsgProc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nCode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CallNextHookEx(IntPtr.Zero, nCode, wParam, lParam); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CbtProc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nCode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CallNextHookEx(IntPtr.Zero, nCode, wParam, lParam); }</code> </pre><br>  For each thread you need to put your hook (see threadId), so we‚Äôll get a dictionary <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, HookInfo&gt; hooks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, HookInfo&gt;();</code> </pre> <br>  Where <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HookInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> IntPtr GetMsgHookHandle; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> IntPtr CbtHookHandle; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> InHook; }</code> </pre> <br>  When you subscribe to the dictionary, we add the entry, when we unsubscribe, we remove, all the orders are chinar. <br></div></div><br>  Hrenak, hrenak, and in production!  Yeah, shch, this is .NET, baby.  It falls, if not immediately, then after 1-2 subscriptions / unsubscribing of hooks, right on the call to CallNextHookEx.  It is intuitively clear that we have a dangling pointer, but with a quick glance at the code it is not clear, but why?  Let's look carefully at <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644990%2528v%3Dvs.85%2529.aspx">SetWindowsHookEx</a> .  The second parameter is a pointer to a handler function.  That is, the address of the handler, in terms of C # it will be IntPtr.  Soooo, what if I replace HookProc lpfn with IntPtr lpfn?  Then you have to use <a href="https://msdn.microsoft.com/en-us/library/at4fb09f(v%3Dvs.110).aspx">Marshal.</a>  <a href="https://msdn.microsoft.com/en-us/library/at4fb09f(v%3Dvs.110).aspx">GetFunctionPointerForDelegate</a> to get the address from the delegate.  We look at the initial code - we don‚Äôt create a delegate explicitly.  We look with <a href="http://ilspy.net/">ilspy</a> : <br><br><pre> <code class="cs hljs">SetWindowsHookEx(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HookProc(Win32HookManagerBase.GetMsgProc), IntPtr.Zero, threadId);</code> </pre> <br>  So here you are, reindeer!  Thank you, syntactic sugar, you hid an important thing from us - an intermediate delegate object is created containing an address that is successfully passed to the unmanaged code.  After that, the delegate object is successfully nailed by the garbage collector and the unmanaged code begins to crash when trying to transfer control to nowhere. <br><br>  Ok, explicitly save the delegates: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HookProc procGetMsg = Win32HookManager.GetMsgProc; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HookProc procCbt = Win32HookManager.CbtProc; SetWindowsHookEx(WH_GETMESSAGE, procGetMsg, IntPtr.Zero, threadId); SetWindowsHookEx(WH_CBT, procCbt, IntPtr.Zero, threadId);</code> </pre> <br>  Compile, check - works. <br><br>  Half the battle done, event notifications learned how to receive.  Now we need to collect and record information that will allow us to show events in a form that is understandable and readable by humans. <br><br>  Take for example <br><br><div class="spoiler">  <b class="spoiler_title">Mouse messages</b> <div class="spoiler_text"><pre> <code class="cs hljs">Win32.WindowsMessages message = (Win32.WindowsMessages)m.Msg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_LBUTTONUP) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Left, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_RBUTTONUP) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Right, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_MBUTTONUP) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Middle, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_LBUTTONDOWN) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Left, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_RBUTTONDOWN) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Right, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_MBUTTONDOWN) ProcessMouseMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, MouseButtons.Middle, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessMouseMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m, MouseButtons button, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp</span></span></span><span class="hljs-function">)</span></span> { Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); data[<span class="hljs-string"><span class="hljs-string">"mouseButton"</span></span>] = button.ToString(); data[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = isUp ? <span class="hljs-string"><span class="hljs-string">"up"</span></span> : <span class="hljs-string"><span class="hljs-string">"down"</span></span>; Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = isUp ? BreadcrumbEvent.MouseUp : BreadcrumbEvent.MouseDown; item.CustomData = data; AddBreadcrumb(item); }</code> </pre> <br></div></div><br>  Then we will make a simple application in which we will enable the recording of user actions and drop the application in the handler of one of the buttons so that the crash report with ‚Äústeps for playback‚Äù is sent to the system. <br><br><img src="https://habrastorage.org/webt/nz/sc/op/nzscopkp1exvadka0wv4rh8fr1s.png"><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { LogifyAlert client = LogifyAlert.Instance; client.ApiKey = <span class="hljs-string"><span class="hljs-string">"&lt;my-api-key&gt;"</span></span>; client.CollectBreadcrumbs = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; client.StartExceptionsHandling(); <span class="hljs-comment"><span class="hljs-comment">// etc } void showMessageButton_Click(object sender, EventArgs e) { MessageBox.Show(this, "text"); } void crashMeButton_ClickEvent(object sender, EventArgs e) { object o = null; o.ToString(); }</span></span></code> </pre><br>  On the server side, we generate descriptions of user actions based on the information collected, something like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateMouseEventMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Breadcrumb breadcrumb</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"mouseButton"</span></span>) + <span class="hljs-string"><span class="hljs-string">" mouse button"</span></span> + GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"action"</span></span>); }</code> </pre><br>  We open and look at the <a href="https://logify.devexpress.com/AlertPublic/r/d/zNrGnyns4tNi0n0LYvAVFbVgRJKdqfE0bJk_8sFdEOmOs1dLsL8XFgc2hnBhgAOE0/Y_2CkVKUNfv_MPl8xP9t_jDmBymS3EACy96rU1gewjA1/1/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">sent records</a> . <br><br><img src="https://habrastorage.org/webt/5n/x0/m5/5nx0m5vcwtgbu_ubx_6eidp22oi.png"><br><br>  It is clear that nothing is clear.  Yes, the user poked with the mouse, but where exactly?  And this we did not write and did not send.  What we have there interesting in mouse messages is?  Oh, <a href="https://msdn.microsoft.com/en-US/library/system.windows.forms.message.hwnd(v%3Dvs.110).aspx">hWnd</a> , that is necessary. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWindowText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd, StringBuilder lpString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nMaxCount</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWindowText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m</span></span></span><span class="hljs-function">)</span></span> { StringBuilder windowText = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-number"><span class="hljs-number">1024</span></span>); GetWindowText(m.Hwnd, windowText, <span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> windowText.ToString(); }</code> </pre><br>  At the same time, let's write to the log what keys the user pressed. <br><br><div class="spoiler">  <b class="spoiler_title">Customer</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_KEYDOWN) ProcessKeyMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_KEYUP) ProcessKeyMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == Win32.WindowsMessages.WM_CHAR) ProcessKeyCharMessage(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessKeyMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp</span></span></span><span class="hljs-function">)</span></span> { Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); data[<span class="hljs-string"><span class="hljs-string">"key"</span></span>] = ((Keys)m.WParam).ToString(); data[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = isUp ? <span class="hljs-string"><span class="hljs-string">"up"</span></span> : <span class="hljs-string"><span class="hljs-string">"down"</span></span>; data[<span class="hljs-string"><span class="hljs-string">"windowCaption"</span></span>] = GetWindowText(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m); Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = isUp ? BreadcrumbEvent.KeyUp : BreadcrumbEvent.KeyDown; item.CustomData = data; AddBreadcrumb(item); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessKeyCharMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m</span></span></span><span class="hljs-function">)</span></span> { Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); data[<span class="hljs-string"><span class="hljs-string">"char"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)m.WParam, <span class="hljs-number"><span class="hljs-number">1</span></span>); data[<span class="hljs-string"><span class="hljs-string">"action"</span></span>] = <span class="hljs-string"><span class="hljs-string">"press"</span></span>; data[<span class="hljs-string"><span class="hljs-string">"windowCaption"</span></span>] = GetWindowText(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m); Breadcrumb item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Breadcrumb(); item.Event = BreadcrumbEvent.KeyPress; item.CustomData = data; AddBreadcrumb(item); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Server</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateMouseEventMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Breadcrumb breadcrumb</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"mouseButton"</span></span>) + <span class="hljs-string"><span class="hljs-string">" mouse button"</span></span> + GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"action"</span></span>) + <span class="hljs-string"><span class="hljs-string">" over "</span></span> + GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"windowCaption"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateKeyEventMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Breadcrumb breadcrumb</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"key"</span></span>) + GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"action"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateKeyCharEventMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Breadcrumb breadcrumb</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> character = GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"char"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!String.IsNullOrEmpty(character)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Type "</span></span> + character; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetBreadcrumbCustomField(breadcrumb, <span class="hljs-string"><span class="hljs-string">"key"</span></span>) + <span class="hljs-string"><span class="hljs-string">" press"</span></span>; }</code> </pre> <br></div></div><br>  Reassemble, launch, generate and view new crash report. <br><br><img src="https://habrastorage.org/webt/pg/qj/84/pgqj84vuy8cwz4htjypx_jimeoi.png"><br><br>  Already not bad.  And keystrokes adequately seemed, you can begin to collect passwords.  Speaking of birds, passwords.  It is probably not good to send private information without the explicit consent of the user.  Perhaps, <br><br><div class="spoiler">  <b class="spoiler_title">Replace with asterisks</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessKeyMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> key = ((Keys)m.WParam).ToString(); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> maskKey = IsPasswordBox(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maskKey) key = Keys.Multiply.ToString(); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); data[<span class="hljs-string"><span class="hljs-string">"key"</span></span>] = key; <span class="hljs-comment"><span class="hljs-comment">// etc } bool ProcessKeyCharMessage(ref Message m) { char @char = (char)m.WParam; bool maskKey = IsPasswordBox(ref m); if (maskKey) @char = '*'; Dictionary&lt;string, string&gt; data = new Dictionary&lt;string, string&gt;(); data["char"] = new string(@char, 1); // etc }</span></span></code> </pre><br></div></div><br>  Now you need to implement the IsPasswordBox method, and it will be quite good.  What is the difference between the usual input field and the password input field?  Again we recall WinAPI memories from the depths of our memory, we find <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh298434(v%3Dvs.85).aspx">this</a> example.  From it we see that we need an edit control with the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb775464(v%3Dvs.85).aspx">ES_PASSWORD</a> style, which has a non-zero <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb761653(v%3Dvs.85).aspx">password char</a> .  We realize: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"USER32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWindowLong</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hwnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"USER32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Msg, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsPasswordBox</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ES_PASSWORD = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> style = GetWindowLong(hWnd, GWL_STYLE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((style &amp; ES_PASSWORD) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = SendMessage(hWnd, EM_GETPASSWORDCHAR, IntPtr.Zero, IntPtr.Zero); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result != <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  We get: <br><br><img src="https://habrastorage.org/webt/h9/xp/zl/h9xpzlcjz2bbjmtr2nopfspwjpo.png"><br><br>  With buttons and input fields, everything works fine.  And if you complicate the puzzle?  We build in a demo application with complex controls, grids and ribbons. <br><br><img src="https://habrastorage.org/webt/6v/mu/v9/6vmuv9jqxz1punlinwuj3t2ccga.png"><br><br>  Run, poke in the grid and buttons on the ribbon, look at the result: <br><br><img src="https://habrastorage.org/webt/5a/eq/ql/5aeqqlgxm0b5qld411wzaiem1fa.png"><br><br>  A sad sight.  For the whole ribbon we have one single hWnd, and as many as two on the grid, one for the grid itself and the other for the active editor.  And what do we do with all this good?  Digging into the guts of specific controls is not an option - there are too many of them from different vendors, and the insides can change quite regularly for themselves.  We recall <a href="https://www.section508.gov/">Section 508</a> , and begin to find out what it is and what it is eaten with.  As a result, we will learn about <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd318466(v%3Dvs.85).aspx">IAccessible,</a> and after a while, and about the methods <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd317978(v%3Dvs.85).aspx">AccessibleObjectFromWindow</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd317977(v%3Dvs.85).aspx">AccessibleObjectFromPoint</a> .  The first method is just suitable for keyboard events, and the second for mouse events. <br><br><div class="spoiler">  <b class="spoiler_title">Another bit of code</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">return: MarshalAs(UnmanagedType.Bool)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClientToScreen</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hwnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> POINT point</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"oleacc.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AccessibleObjectFromPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">POINT pt, [Out, MarshalAs(UnmanagedType.Interface</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> IAccessible accObj, [Out] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> ChildID)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"oleacc.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AccessibleObjectFromWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hwnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Guid iid, [In, Out, MarshalAs(UnmanagedType.IUnknown</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ref</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> ppvObject)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAccessible </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAccessibleObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd</span></span></span><span class="hljs-function">)</span></span> { Guid guid = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-string"><span class="hljs-string">"618736e0-3c3d-11cf-810c-00aa00389b71"</span></span>); Object instance = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OBJID_WINDOW = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hResult = AccessibleObjectFromWindow(hWnd, OBJID_WINDOW, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> guid, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> instance); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hResult != <span class="hljs-number"><span class="hljs-number">0</span></span> || instance == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IAccessible; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAccessible </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAccessibleObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd, Point point</span></span></span><span class="hljs-function">)</span></span> { IAccessible accObj; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); POINT pt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> POINT(); pt.X = point.X; pt.Y = point.Y; ClientToScreen(hWnd, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> pt); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AccessibleObjectFromPoint(pt, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> accObj, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> obj) != IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (accObj == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> accObj; }</code> </pre><br></div></div><br>  Next is a matter of technology.  If we get a non-zero IAccessible, then we analyze the <a href="https://msdn.microsoft.com/en-US/library/system.windows.forms.accessiblerole(v%3Dvs.110).aspx">AccessibleRole</a> , and write the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd318483(v%3Dvs.85).aspx">accName of the</a> control and its parent, if necessary. <br><br><div class="spoiler">  <b class="spoiler_title">And again the lyrics</b> <div class="spoiler_text">  There is at least one more way to find out what the user poked with the mouse.  More precisely, even this way: what text the user poked into.  But the way is so unconventional that the author will refrain from using it, so as not to be deservedly accused of perrectal <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D0%25BD%25D0%25B7%25D0%25B8%25D0%25BB%25D0%25BB%25D1%258D%25D0%25BA%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B8%25D1%258F">tonsillectomy</a> .  The essence of the method is as follows.  Learning to intercept WinAPI text rendering functions, for <a href="https://www.codeproject.com/Articles/21414/Powerful-x-x-Mini-Hook-Engine">example</a> .  Further, when we need to figure out the text under the arm, turn on the interception and begin to write in a separate notebook, what text and where it was drawn.  Then we force the window under the arm to redraw and turn off the interception.  Then calmly read the notebook and determine the text that was drawn directly under the arm.  According to indirect data (and not only indirectly), this is how the <a href="http://lingvo.helpmax.net/en/translation-and-search/quick-lookup">Quick Lookup</a> feature works for the guys from the Abbyy <a href="http://www.lingvo.ru/">Lingvo</a> team. <br></div></div><br>  Next, we finish the server part and get the following picture: <br><br><img src="https://habrastorage.org/webt/-o/kz/aq/-okzaqwntcisdqwf8k3yrxhgi1o.png"><br><br>  It has become much more informative, it is quite clear to which control (or which part of it) each record belongs.  It is already possible to work, but now I wanted to see the same user actions, but in an even more compact form.  Than further and do. <br><br>  <b>PS:</b> <br><br>  ‚Üí WinForms client <a href="">sources</a> <br><br>  If anyone is interested, <a href="https://logify.devexpress.com/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">the</a> project <a href="https://logify.devexpress.com/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">site</a> and <a href="https://logify.devexpress.com/Alert/Documentation/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">documentation</a> . <br>  Also introductory <a href="https://habrahabr.ru/company/devexpress/blog/342620/">article</a> about Logify here, on Habr√©. <br>  Collect user activity under other platforms: <a href="https://habrahabr.ru/company/devexpress/blog/343358/">WPF</a> , <a href="https://habrahabr.ru/company/devexpress/blog/343816/">JavaScript, ASP.NET</a> </div><p>Source: <a href="https://habr.com/ru/post/342530/">https://habr.com/ru/post/342530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342516/index.html">Key announcements Connect (); 2017</a></li>
<li><a href="../342518/index.html">Why programmers don't get jobs: four horror stories</a></li>
<li><a href="../342524/index.html">Experience developing low power devices on the STM32L</a></li>
<li><a href="../342526/index.html">Service Oriented Architecture (SOA)</a></li>
<li><a href="../342528/index.html">Video of reports from the Agile Kitchen conference in M.Video</a></li>
<li><a href="../342532/index.html">51% attack or pocket guide for the Chinese government</a></li>
<li><a href="../342534/index.html">Dive into ICO</a></li>
<li><a href="../342536/index.html">Container Management Tools</a></li>
<li><a href="../342540/index.html">How PacketZoom Mobile Expresslane Increases Application Performance</a></li>
<li><a href="../342542/index.html">Technopark, Technosphere, Technotrek: Alumni Projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>