<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The system for preparing video for streaming on the platform ivi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order to prepare video for streaming on a large number of device types, you need to take several steps - from preparing metadata to packaging in di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The system for preparing video for streaming on the platform ivi</h1><div class="post__text post__text-html js-mediator-article">  In order to prepare video for streaming on a large number of device types, you need to take several steps - from preparing metadata to packaging in different containers (MP4, DASH, HLS) with different bitrates.  Ivi.ru built a flexible system with priorities that takes into account the needs of business in the speed of video preparation and is able to work with five DRM systems.  The architectural solution is based on juggling Docker-containers and includes both hardware for video encoding and software.  The whole process and all the details of working with video were explained in detail by the expert and technical director of ivi, Evgeny Rossinsky.  Under the cut - interpretation of his report with <a href="http://backendconf.ru/2017">Backend Conf 2017</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/08d/8ac/747/08d8ac747ebb1d6be90d21b47cfcc552.jpg"><br><a name="habracut"></a><br>  <i><b>About speaker</b></i> <i><b><img src="https://habrastorage.org/getpro/habr/post_images/172/5b5/77f/1725b577fb602a1dec00f4329f7a28ab.jpg" align="left"></b> <br></i>  <i>Evgeny Rossinsky - since 2012, CTO ivi has been working to this day.</i>  <i>He led the company on the development of high-loaded projects Netstream, the fruits of which were projects related to online broadcasting and video (smotri.com, ivi).</i>  <i>Since 2012, Netstream, along with the entire team, has been absorbed by ivi.</i> <i><br><br></i>  <i>Since 2006 he has been teaching at MSTU.</i>  <i>Bauman author's course "Technologies for team development software"</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today I‚Äôll tell you how we gnawed a cactus and cried with mice on how to make a coding system and then upload it to OnDemand video. <br><br>  First, I will briefly introduce you to our service, so that you understand the context, and then we turn to animal-assorted humor and various details. <br><br><div class="spoiler">  <b class="spoiler_title">Little about IVI</b> <div class="spoiler_text"><ul><li>  "Ivi" shows legal video. <br></li><li>  We have a lot of different client applications: we play on the Web, iOS, coffee makers, TVs.  Recently launched the XBOX app. <br></li><li>  This is a highload project with a multimillion audience - 33 million! <br></li><li>  A few years ago, they built their CDN: 30 cities in Russia and 3 DCs in Moscow with a ring of 150 Gbps. <br></li><li>  We have fun with such a load as 70 thousand requests per second. <br></li></ul><br></div></div><br><br>  Now let's go directly to what I would like to talk about - how the video from the copyright holder reaches the end user. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d20/b84/eed/d20b84eedd3340c1e41967727b22e7d9.png"><br><br>  <b>1. The right holder</b> sends us either a link or (in 10% of cases, this system is automated) using a special protocol, we retrieve links to the original files from their FTP. <br><br>  2. The special department <b>Ingest</b> (the term is taken from television) is engaged in preparing the video for transmission to the Coding System. <br><br>  What is this job?  It is necessary to check what the copyright holder sent, if it is suitable for viewing at all, including: see the bitrate, in which codecs, perhaps, somewhere cut off the beginning or end, display the sound level, make color correction and other miscellaneous interesting things. <br><br>  The Ingest department was reorganized two years ago, when we started all this and identified two types of specialists: <br><br><ul><li>  people who really understand video coding - and for them the words GOP and keyframe are not empty characters. <br></li><li>  queuing system operators called Coding System.  They have a sheep, they throw it into the queuing system, on the other hand they get two sticks of sausage.  Sniffing sausage - normal?  - lei on prod. <br></li></ul><br>  Our task was to ensure that with the growth of the company the number of professionals who understand the video does not grow much.  It was necessary to increase the number of those who "throws a sheep and gets two sticks of sausage." <br><br>  3. From the magical department Ingest video falls into <b>the coding system</b> .  This is our patrimony, which I will tell you about. <br><br>  4. After encoding the video goes to the server. <br><br>  5. Next, the standard scheme - the video is decomposed (using magic or independently) on the <b>CDN</b> and sent to the <b>end user.</b> <br><br>  This is a simple classic content distribution scheme, starting from the origin servers and ending with the CDN. <br><br>  But we will be interested in the coding system itself, about which I will tell you further, and you will ask vile questions. <br><br><h2>  What were our problems? </h2><br>  Or why two years ago we came to the conclusion that we need to change something and make the world a better place and not worse. <br><br><ul><li>  We had just many kilometers of instructions on how to create a production environment for encoding. <br></li></ul><br>  We love ffmpeg, mp4box and more.  Developer: ‚ÄúOh, a new version has come out, a class!  Now I quickly collect it in my place!  Damn, the bitrate fell by 5%!  Generally fire!  It is necessary to arrest! ". <br>  And here the fun begins - the classic DevOps problem: the developer has one infrastructure, the production servers have another.  Begins pain, sodomy, throwing poop, hatred between the departments of development and operation. <br><br><blockquote>  You can talk a lot - yes, you need DevOps, etc. But in reality, no - people always have people, they hate each other.  Therefore, we must first give a technological platform that will remove the opposition. </blockquote><br><ul><li>  The second big problem is that we really had to greatly reduce the requirements for the level of entry of coding system operators. <br></li></ul><br>  In fact, try it - look in the market for people who are well versed in video encoding, and so that there are many more, since about 10 thousand units of content arrive. <br><br>  For example, a year ago we took the Indian series on trial - we had to dump 10,000 TIPs quickly.  All of them are in different bitrates, some copyright holders themselves downloaded from the torrent - complete sodomy.  And all this had to be somehow processed. <br><br>  When you have a system that requires a very intelligent and understanding person, you can‚Äôt handle 10 thousand TIPs so that the quality is normal.  Therefore, we have taken a number of steps. <br><br><ul><li>  The next problem - in order to prepare the video for streaming, you need to go through a large number of stages, which means that at each stage you can screw it up - make a mistake. <br></li></ul><br>  The queuing system needs to be brought to life and either restart this very task, either correct and restart it, or say: ‚ÄúOK, we cannot encode it in principle‚Äù. <br><br><ul><li>  The next story is <b>R &amp; D.</b> <br></li></ul><br>  These are generally funny guys who wake up around the night and start to be creative. <br>  Some article like ‚ÄúIsraeli startup released a new codec that allows you to reduce the vidos bitrate by 10%‚Äù came to TechCrunch. Of course, we must try!  And suddenly it turns out: ‚ÄúSo, OK, we are in contact now with an Israeli startup, we make a concept out of g * vna and sticks, and now we need to start all this in production!‚Äù. <br><br>  And here we return to the first problem, when another consumer appears in the food chain, and this is very unpleasant. <br><br><ul><li>  Next is the zoo of containers, codecs and DRM. <br></li></ul><br>  In fact, the codecs are not very large zoo, but with containers and DRM is really huge.  Since we are a legal service, we cannot just take and give away a great Dash or HLS, because we are simply not allowed to do this.  The rightholder says, for example: "Guys, the movie" Star Wars "you can give only on such a platform and only in such a DRM." <br><br>  DRM is Digital rights management - a thing that seems to protect against downloading and the ability to steal audio and video content.  These systems are actually several.  We are almost all popular implemented.  This is true pain and suffering. <br><br>  Why?  Because in a good way, you should not know how DRM works - after all, it is a protection system.  You do not have the right to engage in reverse engineering, but if you do not, this nonsense does not work.  Therefore, how to test and debug DRM work is generally a separate song. <br><br>  As a result, we have 52 different configurations of encoding and packaging video streams. <br><br>  For example, there is an old LG TV, which has a very specific picture of HLS.  If you give him an honest, good, cool HLS, which passes by all standards, he will not be able to play him, although he says in the dock that he can.  In general, he has nothing but MP4 to play - with the corresponding minuses for the user: start time, buffering, etc. <br><br>  Therefore, in order to play on the largest possible number of devices, we had to learn either to generate these formats in advance, or to do it on the fly.  Here the money is decided - where it is profitable for us and where it is not.  I will tell about it a little later. <br><br><ul><li>  The next pain - we needed to be able to save the history of coding parameters in order to further understand what can be done with these video files and what cannot. <br></li></ul><br>  For example, you need to find all vidos with keyframe in two seconds.  Why it may be necessary, I can tell. <br><br>  For example, you need to conduct a test on how much a change in chunk length affects the load on a CDN and how this is related to caching algorithms.  This information is needed.  This is not a vital history, without which it is impossible to exist, but very useful if you want to make the operation of your service somewhat more cost-effective. <br><br>  So that you understand: our cost is six to seven times cheaper than the commercial offers of any CDN.  There are horse prices are laid.  But this is a business, and it should lay a normal margin.  Therefore, the coding system for us is not an empty sound. <br><br><ul><li>  As in the case of DevOps, there are big problems with testing systems. <br></li></ul><br>  The first one who looks at any features before we roll this onto a prod is a QA engineer.  He must first read the multi-kilometer instruction and then pick it up in his cluster. <br>  In general, the coding features are the most complex because they require a lot of time.  The tester is also a man: he launched something coded and went to drink tea cheerfully.  At this point, his context was lost.  He returned - everything fell - it is necessary to understand that.  There are many such iterations. <br><br><blockquote>  Two years ago, on average, it took us two weeks to test one new feature.  It was very painful. </blockquote><br>  With that on the same Web or on the backend we drive 15-20 releases per day.  This is normal. <br><br>  In the case of a coding system, it takes a lot of time to wait for the video to be encoded.  Processing a test file, even if it is all black, there are no scene changes, it still requires a certain time. <br><br><ul><li>  Standard problems with the system of mass service for a large number of consumers. <br></li></ul><br>  We have several departments using a coding system.  This is a section of content that is taken away from the copyright holder, and there are still funny guys called ‚ÄúAdvertising‚Äù. <br>  Since we are proud and independent, in order not to sit on other people's pills and needles, we have launched our advertising twister.  Advertisers need to be able to quickly roll out one or another advertising material to our user. <br><br><h2>  Who is a coding operator </h2><br>  In such an intensive mode, we simply could not recruit people in the right quantity, who know about coding. <br><br>  What did <b>business</b> want?  Business wanted cheap professionals who can do everything and are delighted with the routine work of the same type - just come from it! <br><br>  What did the <b>technical department</b> expect from the coding specialist?  Skills: ‚ÄúWell, please, do it like in the picture!‚Äù. <br><br>  <b>What were we going to?</b> <br><ul><li>  They wanted to create a low-entry system for operators. <br></li><li>  In order to be able to use cheap low-skilled employees, which on demand can be connected and disconnected. <br></li><li>  In order not to increase the number of expensive professionals, the use of so many highly qualified people is not so justified. <br></li></ul><br><h2>  Video preparation stages </h2><br><h3>  Stage # 1 </h3><br>  When a video arrives to our system <b>, the original itself is checked</b> first - since even great guys who understand how to properly encode video can make mistakes. <br><br><ul><li>  <b>Bitrate</b> <br></li></ul><br>  According to the statistics of the previous version of the system, there were very frequent cases when, for example, the original came in the bit rate of 1 Mbit, and the coding operator asked me to the system: ‚ÄúPlease, make me Full HD from this‚Äù. <br><br>  This is possible - upscale has not been canceled.  The system takes and does this thing.  The output is: 1 large square runs after another large square, and the third large square looks at all this.  Video quality control engineers look at this and say: ‚ÄúGuys, this is g * out!‚Äù. <br><br>  After the n-th number of requests from video-stream quality control experts, we added a bitrate check. <br><br><ul><li>  <b>Proportions.</b> <br></li></ul><br>  In our practice, there were two ridiculous cases when the copyright holder sent a video of 2 x 480 in size, and these two strips randomly laid out on prod.  Actually, after these two strips, we had a human quality control department, and we are still looking at the proportions at the first stage so that the video stream can at least fit in 9:16 or at least 3: 4.  In the extreme, 1:20 - but not 1: 480. <br><br><ul><li>  <b>FPS.</b> <br></li></ul><br>  We introduced the FPS check (Frame per second - the number of frames per second in a video stream) about six months ago, when we began to experiment with HLS generation on the fly. <br><br>  FPS control is needed so that there is always a reference frame at the beginning of each chunk.  If the chunk is four or two seconds, and the FPS is fractional, one way or another, the reference frame from the beginning of the chunk will go somewhere. <br><br>  Of course, you can customize, make unequal chunks and so on.  But when you do adaptive streaming, you need to somehow synchronize it.  Therefore, simpler rules give rise to simpler operation and understanding how it all works. <br><br>  7-10% of our content live with fractional FPS, and this video cannot be streamed to arbitrary containers.  Now we have a system that allows you to slice MP4 in HLS on the fly, in Dash, also to encode it all. <br><br><blockquote>  Fractional FPS is bad.  Why?  Because at the moment of switching to another stream, adaptive streaming begins to work.  The user blunted the channel, it is necessary to quickly switch to another chunk.  It switches to another chunk, and there is no reference frame.  Then for some time the user may fall apart a picture and a black screen will appear.  It all depends on how the codec is implemented on the client side. </blockquote><br><ul><li>  <b>Sound tracks.</b> <br></li></ul><br>  Often the video comes without any sound at all, or the sound is marked with another language, or something else. <br><br><ul><li>  <b>Other</b> <br></li></ul><br>  A standard set of checks, including checking the size of files. <br><br><h3>  Stage # 2 </h3><br>  After we decided that the original is suitable for further processing, it is <b>encoded into the desired bitrate</b> from one file to another.  The resulting file is MP4. <br><br><h3>  Stage # 3 </h3><br>  Next, <b>packaging</b> and <b>, possibly, encryption</b> is done - if for any reason we want to pre-pack the video stream in one container or another, then send the original-static data from the servers.  Statics are always cheaper to give on load, but it is more expensive to store an extra copy of the bitrate. <br><br><h3>  Stages # 4-5 </h3><br>  Then <b>the originals</b> are <b>sent to the servers</b> , where specially trained people who come to <b>control the quality</b> of what has already arrived. <br>  Quality control consists of two parts: <br><ul><li>  A trivial check, is it normal if we even brought the content file to the originals server? <br></li></ul><br>  In fact, we are stupidly checking the MD5 from the stream, that everything was normal copied.  About once a year I see a story in the logs that they reported bad news - that is, this is not a fictional case. <br><ul><li>  Next, a specially trained person looks in the built-in player (first in the admin panel), how it all looks, whether what we encoded is consistent with the current quality. <br></li></ul><br><h3>  Stage # 6 </h3><br>  After that, since we are still a service of withdrawing money from people, we mark out the places where we need to show advertisements, if this video will work according to the model with an advertisement demonstration. <br>  And what is good for the user is a caption label with notification of the next series and other things. <br><br><h3>  Stage # 7 </h3><br>  Finally, a specially trained person pulls the switch and the content goes to the end user: Backend servers begin to distribute links to this particular video stream. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/314/f9f/0a9/314f9f0a9de3cc3c5cb9c787b65340f2.png"><br><br><h2>  What do we encode? </h2><br>  The largest cluster we have is ffmpeg plus various software.  Two types can be distinguished: Hardware and Software. <br><br>  We take ffmpeg and MP4, HLS and other boxes, and this closes 95% of all coding tasks that we perform.  However, to save time and conduct experiments a year and a half ago, we bought a pair of servichkov from Elemental. <br><br>  This is not an advertisement, they are really nice guys.  These servers are more expensive than all our pieces of hardware put together, but they have one plus.  If it is difficult for you to cook something with ffmpeg or open source software, you can always contact support and say: ‚ÄúGuys, my Smooth Streaming does not work, make it work!‚Äù. <br><br>  They send it to you, and then, if you want to scale it, you just stupidly copy what they sent and either insert it into the software solution, or say: ‚ÄúOK, let it spin on Elemental‚Äù. <br><br>  Now in our production Elemental is only used for one piece.  We do content with DRM PlayReady, which we give to HSS.  HSS is just Smooth Streaming - Microsoft's crap, which is now not supported by such a large number of devices.  But, for example, Philips TVs, like the old Samsung and LG, are very fond of it. <br><br>  All other platforms are catching up a bit faster.  On Smart TV, there is generally a problem with updating firmware.  They very often throw old TV sets both on iron and in everything.  There with support trouble. <br><br>  But there are people who want to watch movies on old models, and our task is to somehow make friends with a hedgehog. <br><br>  As a result, approximately 95% is spent on software coding and 5% on encoding and packaging using Elemental.  And a very large piece is associated with R &amp; D, which is also carried out on Elemental.  There, however, the speed is somewhat higher, because the GPU is crammed. <br><br>  For example, we first wrote down stories with 4K and HDR on a hardware solution. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16a/bcf/712/16abcf712275c8345de40c8c4a70f015.png"><br><br><h2>  How does all this work inside and how we come to this </h2><br>  Remembering the first problem, when the developers mopped up the operation, and the exploitation of the developer's weed, we did a pretty simple thing: we took the docker-container and stuffed everything related to coding, removing all the difficulties with setting up the infrastructure, building ffmpeg, versions, and so on. . <br><br>  We have done: <br><br><ul><li>  API; <br></li><li>  admin panel for the developer, with which they can deal with complex cases; <br></li><li>  admin panel for coding operators; <br></li><li>  container management; <br></li><li>  very primitive orchestration. <br></li></ul><br>  Then I will tell you a little bit about which of the orchestration systems we tried and why we decided to dwell on trivial and primitive solutions for this particular story. <br><br><h2>  How it works (on fingers) </h2><br>  Suppose we want to launch a new server and make it part of a cloud that deals with video encoding. <br><br><ul><li>  We upload the entire configuration via Puppet; <br></li><li>  Install Cron, which checks once a minute if there is free space to launch another container; <br></li><li>  Further this container rises, looks, whether there are for it tasks for coding, and carries out them.  On the server there is a shared daddy, where he puts his results, and, having successfully completed the task, he dies, while sharing the logs with the coding history.  Everything is very simple. <br></li><li>  Then, on Cron, a new thing wakes up, looks, is there anything to do.  If there is, then runs there. <br></li></ul><br>  Works armor-piercing. <br><br><h2>  What's inside the container? </h2><br>  Each container sequentially requests several types of tasks: <br><br><ul><li>  At first he says: ‚ÄúFriends, is there anything to do exactly by the video itself?  Do I need to overtake it in some other bitrate? ‚ÄùAnd MP4 does. <br></li><li>  Having re-coded MP4, he says: ‚ÄúFriends, I made MP4, everything is fine.  Or maybe you need to pack in HLS? ‚ÄùActually, this is not necessarily the same MP4 - it can be absolutely any other MP4 with a different bit rate. <br></li></ul><br><ul><li>  Next comes a similar story with DASH and then with HDS. <br></li></ul><br>  Having tried to perform one task of each type, the container, having successfully added up the results of its work, dies off. <br><br>  Inside the container: <br><br><ul><li>  Ubuntu <br></li><li>  ffmpeg <br></li><li>  ffprobe, <br></li><li>  mp4box <br></li></ul><br>  Running these magical things wrapped Django, because it was easier at that time - you could write Shell scripts or wrap it all in Djangov teams. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/57a/e9b/072/57ae9b07257a0dae488db5bb688810a8.png"><br><br><h2>  Integration with external services </h2><br>  Then the question arose - how to connect external services to all this good? <br>  Pretty simple too.  In fact, the container has another separate type - send the puzzle somewhere else.  He stupidly climbs on Elemental on SSH and looks at whether he has a resource there to: <br><br><ol><li>  download file; <br></li><li>  run the puzzle. <br></li></ol><br>  If there is - fine, he extorts the file, puts the puzzle on encoding, and asynchronously leaves to wait. <br><br>  Then, in a cycle, he periodically asks Elemental: ‚ÄúIs there anything ready?‚Äù.  If it‚Äôs ready, again wget will download the coding results back into the shared daddy. <br>  Thus, we connected several different, very simple RPC services (or not very simple ones) to integrate it into the coding system. <br><br><h2>  Priorities </h2><br>  What's next?  And then it all rolled out in operation and began to receive the first funny reviews. <br><br>  Thus, such an interesting system of priorities appeared.  This is all taken from the real requests that various departments sent us.  The highest priority is the priority "Sudden." <br><br><img src="https://habrastorage.org/getpro/habr/post_images/077/ac4/eb9/077ac4eb9cadab2790516d4d776ffaba.png"><br><br>  The author of this classification, Volodya Prohod, methodically wrote it all out and now we really have such a prioritization system.  And they perfectly understand this!  They know that ‚ÄúI need yesterday‚Äù is much more important than ‚ÄúSuper urgent‚Äù, ‚ÄúSuper urgent‚Äù for some reason more important than ‚ÄúMegas urgent‚Äù. <br><br>  Actually, what users, such and requests. <br><br>  The priorities are more or less clear, but they were not enough.  Why?  Because everyone, of course, began to wet "Suddenly" - because my task is the most important!  And if another business is trying to hang a KPI of the type ‚ÄúYou have to recode 20 vidos per hour!‚Äù, And you think: ‚ÄúYes, of course, I also need!  Suddenly!  Come on!  Pot, boil! ". <br><br>  All definitely appeared "Suddenly"! <br><br>  What did it lead to?  To the fact that the really important tasks were stupidly waiting for resources.  In fact, it was quite possible to calmly place the video, which is needed only after 4 months for production, with the usual priority.  It would still be codified overnight.  But while people are sitting in the office, they also need to turn the skewers and say that you have burned. <br>  Therefore, we have routes. <br><br><h2>  Routes </h2><br>  What it is?  In fact, we have fenced off in our computing facilities a space where only a certain department can go. <br><br>  There are some really urgent tasks: <br><br><ul><li>  trailers, <br></li><li>  advertising, <br></li><li>  hot premiere <br></li></ul><br>  This year we quite often lay out serials up to the air (catch-forward).  The people are screwing up our support - when is the next series of ‚ÄúHotel Ellion !?‚Äù  I can‚Äôt wait! ‚ÄùThere really is time!  You will laugh, but it is true.  I'm not talking about the popularity of the series "Matchmakers-6". <br><br>  Therefore, hot premieres, especially catch-forward or catch-up (right after the TV broadcast), need to be unloaded quickly. <br><br>  With advertisers it is even worse, because you can calculate how much it costs half an hour or an hour with so many users.  This money is the lost profit of the company. <br><br>  As soon as a loot arises in a dispute between different divisions, people cease to be human beings and take the ax of war ‚Äî blood, tears and snot. <br><br>  Therefore, we made reservations, where you can go and where you can not go, and called them routes. <br><br>  In fact, there are really not very many urgent tasks.  If several super hot premieres and 20 commercials come in a day, then one piece of iron handles this.  They, in principle, do not conflict with each other.  And all the basic things can be solved calmly priorities. <br><br>  By separating the content department for prime ministers and trailers with a separate pen, and for advertisers, a separate story, we achieved that they were able to more or less agree and communicate.  It seems to me, but they may think differently. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b68/97b/b55/b6897bb552c950804c0d88546ec7635b.png"><br><br>  The service of exploitation, when someone comes to her with something new, always meets it with hostility, because her motto is ‚ÄúDon't touch the equipment and she won't let you down!‚Äù <br><br>  As soon as something new comes in, it means that you need to change.  Changes always happen through pain - humanity has not yet come up with another. <br><br>  Therefore, we wanted stories with virtualization, with dockers to run a little wider than just a coding system.  Let's go in two ways: <br><br><ol><li>  We tried to implement Kubernetes so that test clusters for our QA engineers work on it. <br></li><li>  We needed orchestration. <br></li></ol><br>  It was two years ago.  For half a year we fiercely beat our heads against the wall, trying to solve the problems that ‚Äú... just about, in three months, now we are releasing and everything will be fine!‚Äù.  I'm talking about the engineers at Kubernetes. <br><br>  Preparing for the report, I looked at the changes that took place there in two years.  Yes, indeed, about 70% of our problems are closed.  Now we can probably use all of them, but we have already killed half a year, and the next round, I think, will be in half a year or a year. <br><br><blockquote>  But at the same time, we really liked the story just with the Docker-containers - the simplicity with which you can wrap the configuration you need, and absolutely without conflict between the operations department and the development department. <br></blockquote><br>  We have special DevOps engineers who help people cross the grass with the hedgehog.  Although in principle, using the Docker container is pretty straightforward. <br><br>  But Kubernetes dokus us.  The person who introduced it is depressed, and six months later he quit because you are doing, you are doing, it seems, everything is good according to the documentation, and you have the right thoughts, and the direction is the same, but the pot does not cook! <br><br>  A month after we decided that we would not do Kubernetes, one of our developers wrote a very simple orchestration system, just to solve the local problem of raising a test cluster for testers. <br><br>  Kubernetes still solves more global problems - how to do it all in production, and not just in a test cluster.  Yes, I had a dream to rush into production with this, but at first there was the idea of ‚Äã‚Äãthe first step - to make a test infrastructure. <br><br>  It turned out that the test infrastructure is much easier to do without the help of a complex orchestration system, although I by no means criticize the path of Kubernetes.  It is correct, just at the time when we started, it was still very damp. <br><br><h2>  What have we managed to achieve? </h2><br><ul><li>  First, really easy to operate. <br></li></ul><br>  Docker-containers are assembled quite quickly - in a few seconds. <br><ul><li>  We got very good scalability. <br></li></ul><br>  There is computational power - you lift everything you need there with Puppet, and everything works quickly. <br><br><ul><li>  It is very important for us to have detailed logging of all stages of video processing. <br></li></ul><br>  The number of calls from the Ingest department to the development department has decreased.  It is important for me that the developers are engaged in development, and not support.  Now, probably, a maximum of two times a month, one of the programmers looks at what has happened to one or another puzzle, what is going wrong.  In this case, as a rule, they do not climb into the code, but use a special admin panel. <br><br>  As a technical director, it has become somewhat calmer to live, because people do not shift papers from one box to another, but do good, bright, eternal ... or not. <br><ul><li>  Opportunities to connect external services <br></li></ul><br>  We tried using the example of Elemental and, for example, the apple packer in HLS to connect external services. <br><br><ul><li>  For 2016, several times (4, 5, 6 - I do not remember exactly) recoded the entire catalog. <br></li></ul><br>  This is necessary just to optimize the performance of the CDN, so that adaptive streaming will screw better.  Before the creation of this system, the question of recoding the entire catalog could take from six months to a year.  We really have a lot of videos! <br><br>  Now, I think, on those capacities that are, you can cope in a month or two.  The only question is: why? <br><br>  At the same time, you can easily rent a cloud, the main thing is that this cloud was somewhere near you, because somehow Amazon came to us and said: <br><br>  <i>- See, the classic task - let's raise with us ...</i> <i><br></i>  <i>- Do you have anything in Russia?</i> <i><br></i>  <i>- So, to close to you, no.</i> <i><br></i>  <i>- See, we have two Pb originals.</i>  <i>We need, relatively speaking, to overtake them there, and then pick them up.</i>  <i>How much will we pay for the traffic?</i> <i><br></i>  <i>- Well, yes ... In Russia we will rise, we will come.</i> <br><br>  By the time, if you drive somewhere far away, the distance has a very significant impact on the choice of a partner, where you can, for example, raise external computing power. <br><br><ul><li>  QA is now able to test in principle. <br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indeed, two weeks for testing and checking the quality of any new feature in the coding system that I described earlier is adodomy. </font><font style="vertical-align: inherit;">Just in the bud he cuts out all the desire to get some features from this system. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now a day or two, if hemorrhoids are completely - three or four. </font><font style="vertical-align: inherit;">Plus - it is clear how to do it. </font><font style="vertical-align: inherit;">The tester does not deal with infrastructure problems. </font><font style="vertical-align: inherit;">He does not walk around the devopser, does not say: ‚ÄúDamn, the same thing doesn‚Äôt work for me, why?‚Äù. </font><font style="vertical-align: inherit;">Now (at least I hope so), testers are no longer afraid to take on the tasks of controlling the quality of the coding system.</font></font><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Answers to questions after the report often contain the most interesting pieces and interesting details, so we collected them here. </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under the spoiler</font></font></b> <div class="spoiler_text"> <b>‚Äî ,     ,   2 Pb  ‚Äì      ,       ‚Äì     ?</b> <br><br> ‚Äî   HTTP. <br><br> <b>‚Äî  ,        ‚Äì    ?   ?</b> <br><br> ‚Äî       .    .  ,      . ,        . <br><br> <b>‚Äî     GPU.     GPU?</b> <br><br> ‚Äî ,     . 95%    .         Elemental ‚Äì  GPU.        ,    . <br><br>   ,     GPU     .           ‚Äì ,    - ,  .    ,     ‚Äì ,  ,        . <br><br>  , ,    .       Nvidia,          ,  ,   . ,     ‚Ä¶ ,  GPU , ‚Äì   .        ,       . <br><br> <b>‚Äî  Elemental ‚Äì     ,     .      ?</b> <br><br>  - Yes.   . <br><br> <b>‚Äî           ?      HLS, DASH?</b> <br><br> ‚Äî ,      Elemental, ‚Äì  HSS. <br><br> <b>‚Äî        ,     ?</b> <br><br> ‚Äî   .  ,   ,  , ,    ,   ‚Äì   ,   ‚Äì ,    . <br><br> <b>‚Äî   .    ,      DRM‚Ä¶</b> <br><br> ‚Äî    . <br><br> <b>‚Äî .  ,         ,    , , -    .  -  ,        ?</b> <br><br> ‚Äî        . <br><br> <b>‚Äî  ,    Kubernetes ‚Ä¶</b> <br><br> ‚Äî    Kubernetes,  ,        . <br><br> <b>‚Äî   ,     Mesos + Marathon,     ?</b> <br><br> ‚Äî .       .        , .  Mesos  Marathon          ‚Äì ,    ,     . <br><br>     ,    ,   - ‚Äì  .  ,         .   ,     ‚Äì     ‚Äì  ,     .  ,  ,     Kubernetes. <br><br>     . <br><br> <b>‚Äî  ,    ?</b> <br><br> ‚Äî    , ,     ‚Äî   ,     ,        *,  . <br><br> <b>‚Äî   .     Pb? - ?</b> <br><br> ‚Äî     ,     ,    .      ,     . <br><br>        ,      -,     .     ‚Äì     CDN,   .    ,   ,         .    . <br><br> <b>‚Äî   ,  .  ,  ?   ?</b> <br><br> ‚Äî Kibana. <br><br> <b>‚Äî ,       .  ‚Äì             ?</b> <br><br> ‚Äî       52 .     ,  52 ‚Äì    ,     DRM,   .         .        .     ‚Äì  ,        .         HLS ‚Äì   Verimatrix, PlayReady,    .     DASH. <br><br>   , ,     WDW     ,  ,          .    ‚Äì   ,         CDN-,      DRM. <br><br>  , , 18. <br><br> <b>‚Äî    ,       .      ,   ?</b> <br><br> ‚Äî      .    ,     ,  ,     .    ,        ,         -  . <br><br>      ,    .    ‚Äì .   ,  ‚Äì Kubernetes,         ‚Äì     ?      .       ,    .  ,   . <br><br> <b>‚Äî   ‚Äì  -, , .            ?</b> <br><br> ‚Äî  ,   ,  ,   .      ,     .   ,   ,      - . <br> ,        . -,  ,    .       .       .     ,       : ¬´,     -  ,  ,  ¬ª.    DevOps-. <br><br>    .   ‚Äì  ,  .        ,     .    ,     . <br><br> <b>‚Äî     .  ,  4,    ..  QUIK   , ,  , , ?</b> <br><br> ‚Äî  ,    . <br><br>   ,  ,    ,   CDN.     .     ,     . -,     ,  ,      ‚Ä¶     CDN      .    ,  . <br>    ,          ,   ,   ,   ,   . <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also opened </font></font><a href="https://www.youtube.com/playlist%3Flist%3DPLH-XmS0lSi_ydBLdhv1Er29fTs86B49_I"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">access to all videos of performances with Backend Conf 2017</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://www.youtube.com/playlist%3Flist%3DPLH-XmS0lSi_wxonvwmLqy5B6nLVNgIWwI"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++ Junior</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We invite experts and professionals to become speakers at the May RIT ++ conference festival. </font><font style="vertical-align: inherit;">If you have an interesting development experience and you are ready to share it, </font></font><a href="http://speakers.ritfest.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leave a request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for our program committee.</font></font></div><p>Source: <a href="https://habr.com/ru/post/345738/">https://habr.com/ru/post/345738/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345728/index.html">Employees and business: and not a friend, and not an enemy, but how?</a></li>
<li><a href="../345730/index.html">Useful to the designer - issue number 3. Needed community news to improve your workflow</a></li>
<li><a href="../345732/index.html">Git: Newbies Tips - Part 1</a></li>
<li><a href="../345734/index.html">Bloomberg: in search of new markets, high-frequency traders master cryptocurrency</a></li>
<li><a href="../345736/index.html">IL2CPP: generalized implementation</a></li>
<li><a href="../345740/index.html">What is Hashing? Under the hood of the blockchain</a></li>
<li><a href="../345742/index.html">How not to write on Habr: Antireyting 2017</a></li>
<li><a href="../345744/index.html">New release Oh, my code! How I became a VKontakte developer at 16</a></li>
<li><a href="../345746/index.html">Eat three donuts from UWP and not choke</a></li>
<li><a href="../345748/index.html">How to write in assembler in 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>