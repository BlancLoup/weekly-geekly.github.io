<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TDD for Oracle stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On one of our recent projects, we are faced with a serious problem. The web application that we developed was supposed to use the internal database of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TDD for Oracle stored procedures</h1><div class="post__text post__text-html js-mediator-article"><p>  On one of our recent projects, we are faced with a serious problem.  The web application that we developed was supposed to use the internal database of the financial organization.  For security reasons, access was very limited: any changes needed to be made with the help of stored procedures, and data read only with the help of views.  Thus, the application had to perform complex data manipulations, without having any idea about their structure.  The main snag for us was that our application fell into dependence on large and complex procedures for which there were no automated tests. </p><br><p>  Googling a bit, we found that in the regular Oracle SQL Developer toolkit [1] there is a functional for creating automated tests.  We immediately began to study it.  And although tests for the most complex procedure had to be created after it was written, this toolkit still helped us eliminate a few errors, and also greatly simplified the process of functional expansion and refactoring.  Below I will give an example of using TDD to build stored procedures, and also share my experience in working with the toolkit. </p><a name="habracut"></a><br><h4>  Usage example </h4><br><p>  Suppose a customer has an existing application that allows his clients to send SMS messages.  Another team is developing a new application that will have to work in parallel with the existing one, so it would be nice to have a common place for business logic. </p><br><h4>  Data structure </h4><br><p>  The application uses the following data structure: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> CLIENTS( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR2</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, BALANCE <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(*,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, IS_ACTIVE <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, IS_PREPAY <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> MESSAGE_QUEUE( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ID_CLIENT <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, SENDER VARCHAR2(<span class="hljs-number"><span class="hljs-number">20</span></span>), RECIPIENT <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR2</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, QUEUED_ON <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>, SEND_ON <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, SENT_ON <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> TRANSACTIONS( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ID_CLIENT <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(*,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, TRANSACTION_TIME <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> );</code> </pre> <br><p>  For brevity, the definitions of primary and foreign keys are omitted. </p><br><h4>  Setting up the environment </h4><br><p>  Unit testing in SQL Developer uses a database to store tests, their settings, library, and execution results.  For this purpose, it is strongly recommended to create a user for testing, then create a repository in its database.  This process is described in more detail in the unit testing documentation [2]. </p><br><h4>  Oracle Testing Terminology </h4><br><p>  The testing terminology that Oracle uses is somewhat different from the common xUnit terminology [3]: </p><br><table><thead><tr><th>  xUnit </th><th>  SQL Developer </th><th>  SQL Developer Comment </th></tr></thead><tbody><tr><td>  Test suite </td><td>  Test suite </td><td>  May include other test suites and / or scripts. </td></tr><tr><td>  Test script </td><td>  Test </td><td>  Can test only one function or procedure. </td></tr><tr><td>  Test </td><td>  Test implementation </td><td></td></tr><tr><td>  Context setup (setup) </td><td>  Startup process </td><td>  Available at test level and test suite </td></tr><tr><td>  Tear down </td><td>  Teardown process </td><td>  see above </td></tr></tbody></table><br><p>  Further in the text I will use the Russian version of the terminology xUnit. </p><br><h4>  Surprises </h4><br><p>  Working with the application, we found that it does not always work as we expected: </p><br><ul><li>  Sometimes, all the unit-testing menu items turned off.  In such cases, click the menu item <strong>View ‚Üí Unit Test</strong> </li><li>  All tests inside the script use a common set of settings and reset the context, which is quite logical.  But because they are edited through the test tab, it creates the feeling that they can be personalized for each test separately. </li></ul><br><h4>  Development by testing </h4><br><p>  Before we can start, you need to create an empty procedure, otherwise you will not be able to create a test.  And although the argument list can be left empty, there is no need for that. </p><br><p>  Initially, we can assume that in order to send a message, we will need a client identifier, a sender, a recipient, as well as the body of the message itself.  Also, we need to signal the result of the execution, say, through the output parameter.  With the help of the create procedure dialog you can get a perfectly suitable definition: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> QUEUE_MESSAGE( V_ID_CLIENT <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, V_SENDER <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, V_RECIPIENT <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, V_MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR2</span></span>, V_IS_QUEUED <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> QUEUE_MESSAGE;</code> </pre> <br><p>  In the case of Oracle, it makes sense to set the prefix for variables whose name may coincide with the field name, as in the case of ambiguity, the famous DBMS will resolve the dispute in favor of the field.  And in order to avoid confusion, it is easier to prefix all variables without exception. </p><br><blockquote>  Note <br><br>  If the parameters of the procedure have changed, then each test script must be updated manually by clicking the <strong>Synchronize Test</strong> context menu item <strong>...</strong> </blockquote><br><h4>  The first script </h4><br><p>  To simplify our example, let's assume that the cost of one message is <code>0.03</code> some money.  And, oddly enough, Gherkin is quite suitable for describing the scenario: </p><br><pre> <code class="hljs erlang">:  -  :    :   ,       ,   ,    .</code> </pre> <br><p>  The fastest way to create a test is to right-click on a procedure in the object tree, then select the menu item <strong>Create Unit Test ....</strong>  In the window that appears, you can immediately click <strong>Finish</strong> .  The <strong>QUEUE_MESSAGE</strong> script with a single test should appear in the <strong>Unit Test</strong> panel. </p><br><h5>  Context setting </h5><br><p>  First, we will need to fill the database with the necessary data.  For us, the most convenient was the use of PL / SQL mode for setting and resetting the context.  However, any of the options are easy to reuse using publish to the library.  To copy an existing step from the library, just select it from the drop-down list, then click the <strong>Copy</strong> button.  And if you want to use it without changes, but instead of the <strong>Copy</strong> button, you must click the <strong>Subscribe</strong> checkbox. </p><br><blockquote>  <strong>Caution!</strong> <br><br>  The idea of ‚Äã‚Äãusing an existing database for testing may seem attractive.  It would seem that it saved the data in the configuration, and restored it when the context was reset ... However, it should be borne in mind that if an unexpected error occurred at any stage during the execution of the tests, the database will appear as it was during the error, and the context will not be reset.  Therefore, it is best to use a clean database, which is not terrible and easy to completely re-create in case of damage to the structure or data. </blockquote><br><p>  Assuming that we are working with an empty database, for setting the context, we will need only one insert of the post-paid client record.  It can be immediately stored in the library, calling the <em>post-paid client</em> . </p><br><h5>  Context reset </h5><br><p>  To be able to rerun the tests, you need to clear the added data.  Odnadko, in our case, you can simply clear all the tables affected by the tests.  This step also needs to be saved to the library for future use. </p><br><h5>  Call </h5><br><p>  The test execution itself is determined by setting the parameters of the stored procedure.  The values ‚Äã‚Äãof the output parameters for verification are also set here.  Checking the output parameters can be disabled using the <strong>Test Result</strong> checkbox.  It refers to the parameters specified in the table as well as dynamically. </p><br><blockquote>  <strong>Caution!</strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In appearance, it may seem that setting the parameters with a mouse in the table is very convenient, however, you must bear in mind that this table is not copyable.  This is especially important for procedures with a large number of arguments, since to create the next test, all of them will have to be re-set manually, especially when the new test differs from the current one only by one value.  Dynamic query (Dynamic Value Query), in contrast to the table, can be saved in the library, and then can be either reused or copied. </blockquote><br><p>  As stated above, a dynamic query is more convenient to use.  It is also worth noting that the name of the output parameters in the request must be supplemented with a <code>$</code> sign at the end of the name: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V_ID_CLIENT, <span class="hljs-string"><span class="hljs-string">'79052222222'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V_SENDER, <span class="hljs-string"><span class="hljs-string">'79161111111'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V_RECIPIENT, <span class="hljs-string"><span class="hljs-string">' !'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> V_MESSAGE, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V_IS_QUEUED$ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> DUAL</code> </pre> <br><blockquote>  Note <br><br>  To return from the dynamic query mode to the table one, it is necessary to completely clear the dynamic query value. </blockquote><br><p>  Since we specified the check of the output parameter, it is already possible to run the script and see the failure.  If done correctly, the system should report an error.  Any other failure at this stage means incorrect configuration. </p><br><p>  The easiest way to calm the test down is to write <code>1</code> into the output parameter in the procedure body: <code>SELECT 1 INTO IS_QUEUED FROM DUAL;</code> </p><br><h5>  Statements </h5><br><p>  The test is green again, but we have not checked all the necessary conditions.  They can be checked in other tests of the same script.  Before you create a new test, you should rename the existing one from the default "Test Implementation 1" to "Positive result", and the entire scenario - to "Active post-pay client sends a message." </p><br><blockquote>  <strong>Important</strong> <br><br>  It is easy to assume that each test is performed inside a transaction.  However, it turned out to be wrong.  In the event of an unexpected error, the database may be in an undefined state.  Expected errors this behavior does not apply. </blockquote><br><p>  Our next test will be placed in a separate test to get more subtle feedback, however, it is worth remembering that each new test will take time to set up and reset the context, and each test failure will be provided with a clear message about its cause.  We will divide the checks according to different tests in this scenario, and then combine all the checks into one test in the next scenario. </p><br><blockquote>  <strong>Note</strong> <br><br>  SQL Developer does not allow you to view two tests at the same time.  When moving to another test in the tree, the current test is replaced by a new one in the same panel.  In addition, it is impossible to split this panel into two independently scrollable areas.  However, it is very convenient to open the source code of the procedure in parallel with the test window for a quick transition between two panels. </blockquote><br><p>  The following test should verify that the message has been queued.  Since the setting and resetting the context are already specified, we need to use a dynamic query from the library, and set the approval check.  After we have copied the dynamic query, it may seem that checking the already checked output parameter is useless, and you can reset the <em>Test Result</em> checkbox.  However, if you run tests in this state, it will be seen that one of the tests is ignored.  For me personally, the ignored test is a symbol of unfinished work, so the checkbox will have to be put in place. </p><br><p>  There are several ways to validate assertions.  The first item on the list is a boolean function.  When creating a Boolean function, the dialog provides a quite suitable template: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Please replace this code with either a boolean -- expression like this: -- RETURN FALSE; -- or else a code block which returns a boolean value -- similar to the following: DECLARE l_count NUMBER; BEGIN SELECT count(*) INTO l_count FROM dual; IF l_count &lt;&gt; 0 THEN RETURN TRUE; ELSE RETURN FALSE; END IF; END;</span></span></code> </pre> <br><p>  For our validation, we can use this template by replacing <code>dual</code> with <code>MESSAGE_QUEUE</code> , then applying the necessary filters.  The condition also has to be changed from <code>l_count &lt;&gt; 0</code> to <code>l_count = 1</code> for better accuracy.  After that, you can safely save the function in the library for future use. </p><br><blockquote>  <strong>Note</strong> <br><br>  All records in the library are saved according to their type.  This means that if you later need to use, for example, an approval check, you will need to remember not only its name, but also the type.  This can be very uncomfortable very quickly, especially in large projects. </blockquote><br><p>  When running the tests, we should see an error.  It is very easy to fix: </p><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> MESSAGE_QUEUE(ID_CLIENT, SENDER, RECIPIENT, MESSAGE) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span>(V_ID_CLIENT, V_SENDER, V_RECIPIENT, V_MESSAGE);</code> </pre> <br><p>  Now you can make sure that all tests pass with success. </p><br><blockquote>  <strong>Note</strong> <br><br>  When working with tests, the repository is blocked, so after work is finished, you must either close SQL Developer or close the repository (Deselect Repository). </blockquote><br><p>  And finally, let's check the transaction record.  To do this, select the following type of validation - Compare Query Results.  As the name implies, it works very simply: you need to specify two queries, the results of which match.  Since the exact date and time cannot be known, you can be content with any value within 10 seconds: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Source query SELECT 1 AS ID_CLIENT, 0.03 AS SUM_VALUE FROM DUAL -- Target query SELECT ID_CLIENT, SUM(VALUE) FROM TRANSACTIONS WHERE TRANSACTION_TIME BETWEEN CURRENT_TIMESTAMP AND (CURRENT_TIMESTAMP - 1/24/6) GROUP BY ID_CLIENT;</span></span></code> </pre> <br><p>  After running the tests, we see a vague error <code>Validation   : Compare query results check found differences</code> .  Where "one recent transaction" is the name of our last check in the library.  And although this option is already a valuable tool, it would be great if it could show what exactly the results differ from. </p><br><p>  Add the necessary functionality to our procedure: </p><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> TRANSACTIONS(ID_CLIENT, <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span>(V_ID_CLIENT, <span class="hljs-number"><span class="hljs-number">0.03</span></span>);</code> </pre> <br><h5>  Debugging </h5><br><p>  After the next test run, it suddenly turns out that the error has not gone away.  You, probably, have already noticed an error in the code above, however, in real conditions, the situations are much more complicated.  Since the tool does not show the difference, you will have to figure out the cause manually.  Unfortunately, SQL Developer's debugging functionality is not able to help here.  This means that we will have to run the test without performing a reset.  To do this, you can create another script - debug.  Or rather two: one - without a reset, but with the same dynamic query as in the non-working test - in order to understand what is going on;  and the second - without setting the context, but with a reset - to remove after the first. </p><br><p>  After running the first script, you can view the contents of the table, and check with the verification request.  Now it is clearly visible that the problem was precisely the verification request.  Do not forget to run the second script to clear the data, correct the test conditions, and arrange a rerun.  Now everything is all right.  Debugging scripts can be left for the future, and the first completed script can be put into a new test suite. </p><br><h4>  Second script </h4><br><p>  Now that we have a successful message sending script, we can try a failed send script.  For example, when a post-paid client is inactive: </p><br><pre> <code class="hljs 1c">:  -  :    :   ,   <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,     .</code> </pre> <br><p>  You need to create a new script.  We also have to tweak the context setting and dynamic query slightly, but this is much easier than creating new ones from scratch. </p><br><p>  To set the context, copy the PL / SQL step "Active post-pay client", in which we replace <code>1</code> with <code>0</code> and publish it in a library called "Inactive post-pay client".  Repeat the same for a dynamic query, calling the new query "Unsent message."  To reset the context, use the existing step. </p><br><p>  After running the test should show an error.  It is very easy to fix.  Replace <code>SELECT 1 INTO V_IS_QUEUED FROM DUAL</code> with <code>SELECT IS_ACTIVE INTO V_IS_QUEUED FROM CLIENTS WHERE ID=V_ID_CLIENT</code> - and everything works again. </p><br><p>  Then you need to check that the transaction is not saved.  To do this, use the following type of verification - comparison tables (Compare tables).  At first, it may seem that there is nothing to compare with, however, in the context setting, it is possible to copy an existing table into a temporary one.  This is perfect for us - you can copy transactions into a temporary table, and after calling the procedure, compare the results.  The main thing - do not forget to delete this table when you reset the context.  There are two options - restore, then delete, and just delete.  Since we have nothing to restore - choose the second option.  Please note that as in the case of query comparison, the only feedback option is whether there is a match or not. </p><br><p>  After admiring the error after running the tests, you can think about the solution.  For example, you can wrap an insert into a condition using the newly updated V_IS_QUEUED: </p><br><pre> <code class="sql hljs">IF V_IS_QUEUED = 1 THEN <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> TRANSACTIONS (ID_CLIENT, <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (V_ID_CLIENT, <span class="hljs-number"><span class="hljs-number">0.03</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>;</code> </pre> <br><p>  We compile the procedure, run the tests - everything works. </p><br><p>  Finally, we need to check that the message queue has remained unchanged.  And although the hands were itching to immediately place the message insertion inside the condition next to the insertion of the transaction, this would be an encouragement to a breach of discipline.  Therefore, we first create an additional check for this statement.  The next type of check is a query that returns no rows (Query returning no rows).  Since we completely clear all the data after each test, it suffices to specify <code>SELECT * FROM MESSAGE_QUEUE</code> as such a query. </p><br><p>  The test run shows an error that we can easily fix by putting the inset inside the condition.  And this ends our second scenario. </p><br><h4>  findings </h4><br><p>  SQL Developer can be used to develop stored procedures using the TDD method.  Despite numerous shortcomings, this package provides a platform for developing stored procedures, allowing developers to easily and confidently change and extend the functionality of existing procedures. </p><br><p>  Unfortunately, a test repository can be created only in Oracle DBMS.  In addition, attempts to use third-party DBMSs such as PostgreSQL or even MySQL as a database for testing end in the failure of the test subsystem.  It also turned out that the use of SQL Developer in continuous integration systems causes a lot of problems, but this is another story. </p><br><hr><br><p>  [1] Oracle SQL Developer (Eng.) - <a href="http://www.oracle.com/technetwork/developer-tools/sql-developer/overview/index.html">http://www.oracle.com/technetwork/developer-tools/sql-developer/overview/index.html</a> <br>  [2] Oracle SQL Developer Help: Unit Testing Repository (English) - <a href="https://docs.oracle.com/cd/E15846_01/doc.21/e15222/unit_testing.htm">https://docs.oracle.com/cd/E15846_01/doc.21/e15222/unit_testing.htm#RPTUG45067</a> <br>  [3] xUnit - <a href="https://ru.wikipedia.org/wiki/XUnit">https://ru.wikipedia.org/wiki/XUnit</a> </p></div><p>Source: <a href="https://habr.com/ru/post/304888/">https://habr.com/ru/post/304888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304850/index.html">Basics of game design: 20 board games. Part Three: Pente, Colonialists, Puerto Rico</a></li>
<li><a href="../304856/index.html">JavaFX visual creation of a simple application and native packaging in Eclipse</a></li>
<li><a href="../304866/index.html">Testing reactivity - how to write unit tests for RxSwift</a></li>
<li><a href="../304868/index.html">Windows PC as an ARP flood generator</a></li>
<li><a href="../304870/index.html">What the developer needs to know about application localization</a></li>
<li><a href="../304904/index.html">Purchase history of a single ticket on the Russian Railways website</a></li>
<li><a href="../304906/index.html">Applications for the VIII Summer School of High-Performance Computing in the Field of Computer Vision have been opened</a></li>
<li><a href="../304908/index.html">How to start developing a large, atypical project. Practical guide</a></li>
<li><a href="../304918/index.html">Take a technical interview</a></li>
<li><a href="../304924/index.html">USB mass storage device and libopencm3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>