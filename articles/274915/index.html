<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic control of the lifetime of common C ++ - QML objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The discussion deals with objects used in C ++ and QML at the same time, the top of which inheritance hierarchy is QObject. As far as I know, there is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic control of the lifetime of common C ++ - QML objects</h1><div class="post__text post__text-html js-mediator-article">  The discussion deals with objects used in C ++ and QML at the same time, the top of which inheritance hierarchy is QObject.  As far as I know, there is no implementation of the mechanism for automatic control of the lifetime of such objects at the library level.  Such a mechanism would eliminate the difficulties arising from the manual control of the lifetime of objects, as well as potential bugs, memory leaks and application crashes.  In this article I will describe the stages of the implementation of this mechanism, as well as the problems considered in the process of researching this problem. <br><a name="habracut"></a><br>  Intelligent pointers are used for C ++ objects separately.  However, in this case, accessing these objects from QML will be incorrect, since  after being destroyed by their smart pointers, the objects will become invalid.  In QML, the lifetime of objects is controlled by the garbage collector, but provided that the QQmlEngine :: JavaScriptOwnership option is set to <a href="http://doc.qt.io/qt-5/qtqml-cppintegration-data.html">ownership of the</a> object, an object that does not have references in the code will collapse when the garbage collector first triggers and will be accessed by C ++. to adverse effects. <br><br>  The problem is that each side does not assume ownership of the object at the moment when the other side is going to delete the object, since  The first does not receive notification of this. <br><br>  This problem can be solved with the help of a class that would give ownership of the side in which you plan to use the object in the future.  The idea is that this class refines the standard intellectual pointer, and for the universality of its use, our class will expand the smart pointer, which we indicate to it with a template parameter.  The initial class skeleton looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class">&lt;class&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Container&lt;QObject&gt; { };</code> </pre> <br>  The transfer of ownership must be immediately before attempting to remove an object with a side on which it will not be used further.  To do this, the corresponding party must call a kollbek, inside which, in fact, there will be a switch of ownership. <br><br>  Called on the C ++ side, the callback is quite simple to implement, for example, it can be a custom Deleter, passed as a parameter to the constructor of the base class.  To call a callback from the QML side, we would need a signal that QML is going to destroy the object, however, such a signal is not currently implemented in Qt.  The only signal that at first glance deserves attention is the signal destroyed of the QObject class, but it does not suit us, since  this signal is already being called in the process of deleting an object, and at this point the transfer of ownership can lead to an indefinite application behavior. <br><br>  After some thought and a couple of experiments, it turned out that we didn‚Äôt need a signal notifying that the garbage collector was going to destroy the object. <br><br>  According to the documentation, ownership can also be controlled by specifying the parent object (parent ownership semantics). <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Object, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Container&lt;Object&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> : Container&lt;Object&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::bind(&amp;QmlCppSmartPtr::deleteObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::placeholders::_1))</span></span></span><span class="hljs-function"> </span></span>{ object-&gt;setParent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QObject()); QQmlEngine::setObjectOwnership(object, QQmlEngine::JavaScriptOwnership); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ object-&gt;parent()-&gt;deleteLater(); object-&gt;setParent(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); } };</code> </pre><br>  By setting the object to the QQmlEngine :: JavaScriptOwnership option, we commit the garbage collector to keep an eye on the object, but not to delete it as long as it has a parent.  After the object became an ‚Äúorphan‚Äù, the garbage collector continues to monitor it, and from that time it was possible to remove it.  He will do this at the first actuation, <b>even if the object has no references in the QML / JS code</b> .  The last statement is logical, because by changing the option to QQmlEngine :: JavaScriptOwnership, the user of the framework should not and cannot know whether this object is still used on the Qml side.  QQmlEngine is required to process ownership change requests while the object is in memory.  Apparently, the Qt developers took care of this. <br><br>  Considering the assertion that the garbage collector assumes the obligation to control an object during its lifetime, regardless of whether the reference count for this object has been reset, it has been assumed that the transfer of ownership can be implemented without parental ownership semantics: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Object, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Container&lt;Object&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> : Container&lt;Object&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::bind(&amp;QmlCppSmartPtr::deleteObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::placeholders::_1))</span></span></span><span class="hljs-function"> </span></span>{ QQmlEngine::setObjectOwnership(object, QQmlEngine::CppOwnership); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ QQmlEngine::setObjectOwnership(object, QQmlEngine::JavaScriptOwnership); } };</code> </pre><br>  After some improvements of the mechanism, the implementation of the form turned out <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleOwnershipPolicy</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ QQmlEngine::setObjectOwnership(object, QQmlEngine::CppOwnership); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ QQmlEngine::setObjectOwnership(object, QQmlEngine::JavaScriptOwnership); } }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParentOwnershipPolicy</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ object-&gt;setParent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QObject()); QQmlEngine::setObjectOwnership(object, QQmlEngine::JavaScriptOwnership); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ object-&gt;parent()-&gt;deleteLater(); object-&gt;setParent(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Object, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">...&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SmartPointer</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = Container&lt;Object&gt;; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Object&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SmartPointer</span></span></span><span class="hljs-class">&lt;Object, std::unique_ptr&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;Object, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(Object*)&gt;&gt;; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Object, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">...&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OwnershipPolicy</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleOwnershipPolicy</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SmartPointer&lt;Object, Container&gt;::type { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QmlCppSmartPtr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object, OwnershipPolicy&lt;Object&gt; &amp;&amp; ownershipPolicy = OwnershipPolicy&lt;Object&gt;())</span></span></span><span class="hljs-function"> : SmartPointer&lt;Object, Container&gt;::</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::bind(&amp;QmlCppSmartPtr::deleteObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::placeholders::_1))</span></span></span><span class="hljs-function"> , </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m_ownershipPolicy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::move(ownershipPolicy))</span></span></span><span class="hljs-function"> </span></span>{ m_ownershipPolicy.init(object); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object* object)</span></span></span><span class="hljs-function"> </span></span>{ m_ownershipPolicy.destroy(object); } OwnershipPolicy&lt;Object&gt; m_ownershipPolicy; };</code> </pre><br>  I took the methods of property management into strategies for completeness, leaving both approaches in mind.  The SimpleOwnershipPolicy strategy code is more productive, but the ParentOwnershipPolicy, in my opinion, is less susceptible to possible changes within Qt itself, and the documentation gives more guarantees for the correct operation of this method. <br><div class="spoiler">  <b class="spoiler_title">An example of using this class:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeObject</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject <span class="hljs-comment"><span class="hljs-comment">//  C++-QML  { Q_OBJECT public: Q_PROPERTY(QString name READ name WRITE setName NOTIFY nameChanged) Q_PROPERTY(int value READ value WRITE setValue NOTIFY valueChanged) SomeObject(QString const&amp; name, int val); virtual ~SomeObject() override; explicit SomeObject(QObject *parent = 0); QString name() const; void setName(QString const&amp; name); int value() const; void setValue(int val); signals: void valueChanged(); void nameChanged(); private: QString m_name; int m_val; }; class QmlObjectProvider : public QObject { Q_OBJECT public: Q_INVOKABLE SomeObject* createObject(QString const&amp; name, int value) { m_cppObjects.emplace_back(new SomeObject(name, value)); return m_cppObjects.back().data(); } Q_INVOKABLE void removeObjectsFromCppSide() { m_cppObjects.clear(); } private: std::vector&lt;QmlCppSmartPtr&lt;SomeObject, QSharedPointer, ParentOwnershipPolicy&gt;&gt; m_cppObjects; }; ... //    QML qmlRegisterType&lt;QmlObjectProvider&gt;("com.provider", 1, 0, "QmlObjectProvider"); qmlRegisterType&lt;SomeObject&gt;("com.provider", 1, 0, "SomeObject"); engine.rootContext()-&gt;setContextProperty("qmlObjectProvider", &amp;qmlObjectProvider);</span></span></code> </pre><br>  QML code: <br><pre> <code class="javascript hljs">... import com.provider <span class="hljs-number"><span class="hljs-number">1.0</span></span> Button { <span class="hljs-attr"><span class="hljs-attr">onClicked</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = qmlObjectProvider.createObject(<span class="hljs-string"><span class="hljs-string">"SomeObjectName"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>); qmlObjectProvider.removeObjectsFromCppSide(); <span class="hljs-comment"><span class="hljs-comment">//    C++  text = obj.name; //   QML    ,        gc } }</span></span></code> </pre><br>  You can instantiate a class and export a class object to QML as follows: <br><pre> <code class="cpp hljs">QmlCppSmartPtr&lt;SomeObject&gt; object; <span class="hljs-comment"><span class="hljs-comment">//  unique_ptr  SimpleOwnershipPolicy    . ... QmlCppSmartPtr&lt;SomeObject, std::shared_ptr&gt; object; //  shared_ptr ... return object.get();</span></span></code> </pre><br></div></div><br><br>  PS: Code tested with Qt 5.5, gcc 4.9.1 </div><p>Source: <a href="https://habr.com/ru/post/274915/">https://habr.com/ru/post/274915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274905/index.html">Java and time: part two</a></li>
<li><a href="../274907/index.html">–ï–ì–ê–ò–° - increase of information security of workplaces</a></li>
<li><a href="../274909/index.html">Dolphin Smalltalk 7 is dedicated to Open Sourse</a></li>
<li><a href="../274911/index.html">Calculation of binomial coefficients ... still programmatically</a></li>
<li><a href="../274913/index.html">Call service via video site with 3CX</a></li>
<li><a href="../274917/index.html">Gif inside</a></li>
<li><a href="../274919/index.html">Asterisk: ngrep, sipgrep, sngrep, protocol diagram</a></li>
<li><a href="../274921/index.html">Beeline Data School, holidays are over</a></li>
<li><a href="../274923/index.html">Farm IIS and Application Request Routing</a></li>
<li><a href="../274925/index.html">ActiveRecord's inheritance describing one table (single table inheritance pattern) in Yii2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>