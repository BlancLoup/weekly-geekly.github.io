<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We talk with Rails-application through XMPP (Jabber)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will tell you how to receive messages from your Rails application via XMPP (Jabber) and vice versa, manage the application by sending comm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We talk with Rails-application through XMPP (Jabber)</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage/habraeffect/11/11/11110f778cd0695899fa114387a11c93.png"><br>  The article will tell you how to receive messages from your Rails application via XMPP (Jabber) and vice versa, manage the application by sending commands via XMPP. <br><br><a name="habracut"></a><br><br><h4>  A bit of theory </h4><br>  <b>XMPP</b> (Extensible Messaging and Presence Protocol), previously known as Jabber, is an XML-based, open, free-to-use protocol for instant messaging in near real-time mode.  Originally designed to be easily extensible, the protocol, in addition to sending text messages, supports voice, video and file transmission over the network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unlike commercial instant messaging systems such as AIM, ICQ, WLM and Yahoo, XMPP is a decentralized, extensible and open system.  Anyone can open their instant messaging server, register users on it and interact with other XMPP servers.  Based on the XMPP protocol, many private and corporate XMPP servers are already open.  Among them are quite large projects, such as Facebook, Google Talk, Yandex, VKontakte and LiveJournal. <br><br>  If you do not have a jabber account (I will call XMPP Jabber, in the old-fashioned way), you can quickly start it on <a href="http://reg.jabber.ru/xreg/">Jabber.ru</a> or use <a href="http://www.google.com/talk/intl/ru/">Google Talk</a> .  There will be no problems with the client for the jabber, almost any ‚Äúasechny‚Äù will suit, for example, <a href="http://www.miranda-im.org/download/">Miranda</a> or <a href="http://qip.ru/download_infium_ru">QIP</a> . <br><br><h4>  What is it for? </h4><br>  I am using message sending: <br>  - To search for broken links.  When a user on my site hits a 404 page, I receive a message with the address of this page and the address of the page from which this transition was made. <br>  - For instant information about ordering goods, payment, etc. <br>  - To receive messages from users who do not require a response.  For example, when filling out the "wish form". <br><br>  I give commands to the Rails application: <br>  - To restart the application.  This is much faster than climbing the server via ssh and reloading the rails with a long command. <br>  - To add / remove rows in the database.  I was too lazy to write a full-fledged interface to work with the database, which very rarely needs to add / delete several records. <br><br>  Well, you can use a bunch of Rails + XMPP for these and any bolder tasks.  For example, uploading files and other content to the server, chatting with users, etc. <br><br><h4>  What do we need? </h4><br>  We need the <a href="https://github.com/ln/xmpp4r">XMPP4R</a> gem.  Install: <br><blockquote>  <b>gem install xmpp4r</b> </blockquote><br>  Immediately, I note that the heme is very unstable behaves under windows, so it is better to work with it on Linux. <br><br>  Next, we need a jabber account for our Rails application, i.e.  the address from which it will send you messages and receive commands from you.  Register an account. <br><br><h4>  Sending messages </h4><br>  Connection and authentication of the robot (I will call the part of our Rails application responsible for communication). <br><blockquote><pre><code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"xmpp4r"</span></span> robot = Jabber::Client::new(Jabber::JID::new(<span class="hljs-string"><span class="hljs-string">"robot@xmpp.ru"</span></span>)) robot.connect robot.auth(<span class="hljs-string"><span class="hljs-string">"password"</span></span>)</code> </pre> </blockquote><br>  I think everything is clear here, <i>robot@xmpp.ru</i> is the address of the jabber account you registered for the application, <i>password</i> is the password to it.  Now send the message. <br><br><blockquote><pre> <code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">message</span></span> = Jabber::<span class="hljs-keyword"><span class="hljs-keyword">Message</span></span>::new(<span class="hljs-string"><span class="hljs-string">"you@xmpp.ru"</span></span>, <span class="hljs-string"><span class="hljs-string">", !"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>.set_type(:chat) robot.send <span class="hljs-keyword"><span class="hljs-keyword">message</span></span></code> </pre> </blockquote><br>  Where <i>you@xmpp.ru</i> is your jabber address.  That's all.  The message has already emerged from your tray. <br><br><h4>  Feedback </h4><br>  Now the most interesting thing is that we will send commands to the robot (via the jabber client).  To do this, first connect the robot and make it declare its presence and willingness to communicate.  Those.  the robot will be online, the green bar in the jabber client will be on. <br><blockquote><pre> <code class="hljs ruby">robot = Jabber::Client::new(Jabber::JID::new(<span class="hljs-string"><span class="hljs-string">"robot@xmpp.ru"</span></span>)) robot.connect robot.auth(<span class="hljs-string"><span class="hljs-string">"password"</span></span>) robot.send(Jabber::Presence.new.set_show(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>))</code> </pre> </blockquote><br>  Now, turn on the waiting cycle for incoming messages.  In doing so, we will check that the messages come from the correct address, i.e.  the robot is not trying to command an attacker. <br><blockquote><pre> <code class="hljs pgsql">robot.add_message_callback <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |message| #  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>.to_s.scan("you@xmpp.ru").count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> message.body #     <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> "hello" message = Jabber::Message::<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>("you@xmpp.ru", "  !") message.set_type(:chat) robot.send message <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> "restart" File.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(Rails.root.to_s + "/tmp/restart.txt", "a+") <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> #    message = Jabber::Message::<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>("you@xmpp.ru", "   !") message.set_type(:chat) robot.send message <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre></blockquote><br>  Having received the message <i>‚Äúhello‚Äù</i> , the robot will respond with greetings to us, and receiving <i>‚Äúrestart‚Äù will</i> restart the Rails application (if it works via Passenger). <br><br><h4>  Final class </h4><br>  In the previous example, the robot received a command to restart the application from us and ... died.  It must be revived again by running the appropriate script.  Of course, I don‚Äôt want to do this every time after reloading the application.  Therefore, I propose to run the robot with the application.  I wrote a daemon that includes a class that makes it easier to work with XMPP, and also allows the robot to live, regardless of the reboot. <br><br>  We will <i>arrange</i> this class in a separate Ruby file, for example, <i>‚Äúxmpp_daemon.rb‚Äù</i> , and put it in the <i>‚Äúconfig / initializers‚Äù</i> folder, which will allow it to run along with the rails. <br><blockquote><pre> <code class="hljs scala">#coding: utf<span class="hljs-number"><span class="hljs-number">-8</span></span> require <span class="hljs-string"><span class="hljs-string">"xmpp4r"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Xmpp</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">#</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@@my_xmpp_address</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-string"><span class="hljs-string">"you@xmpp.ru"</span></span> # - @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>_xmpp_address = <span class="hljs-string"><span class="hljs-string">"robot@xmpp.ru"</span></span> #-  @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>_xmpp_password = <span class="hljs-string"><span class="hljs-string">"password"</span></span> #  -  @<span class="hljs-meta"><span class="hljs-meta">@site</span></span>_name = <span class="hljs-string"><span class="hljs-string">"sitename.ru"</span></span> # ,     #    xmpp- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">@@robot</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Jabber</span></span>::<span class="hljs-type"><span class="hljs-type">Client</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(<span class="hljs-type"><span class="hljs-type">Jabber</span></span>::<span class="hljs-type"><span class="hljs-type">JID</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(@<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>_xmpp_address)) @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>.connect @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>.auth(@<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>_xmpp_password) end #  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span></span>(text) self.connect message = <span class="hljs-type"><span class="hljs-type">Jabber</span></span>::<span class="hljs-type"><span class="hljs-type">Message</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(@<span class="hljs-meta"><span class="hljs-meta">@my</span></span>_xmpp_address, <span class="hljs-string"><span class="hljs-string">"[#{@@site_name}]\n#{text}"</span></span>) message.set_type(:chat) @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>.send message end #  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listen</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">@@robot</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span></span>(<span class="hljs-type"><span class="hljs-type">Jabber</span></span>::<span class="hljs-type"><span class="hljs-type">Presence</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>.set_show(nil)) @<span class="hljs-meta"><span class="hljs-meta">@robot</span></span>.add_message_callback do |message| #  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message.from.to_s.scan(@<span class="hljs-meta"><span class="hljs-meta">@my</span></span>_xmpp_address).count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> message.body #     when <span class="hljs-string"><span class="hljs-string">"hello"</span></span> <span class="hljs-type"><span class="hljs-type">Xmpp</span></span>.message <span class="hljs-string"><span class="hljs-string">"  !"</span></span> when <span class="hljs-string"><span class="hljs-string">"restart"</span></span> <span class="hljs-type"><span class="hljs-type">Xmpp</span></span>.message <span class="hljs-string"><span class="hljs-string">"..."</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>.open(<span class="hljs-type"><span class="hljs-type">Rails</span></span>.root.to_s + <span class="hljs-string"><span class="hljs-string">"/tmp/restart.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"a+"</span></span>) end <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> #    <span class="hljs-type"><span class="hljs-type">Xmpp</span></span>.message <span class="hljs-string"><span class="hljs-string">"   !"</span></span> end end end end <span class="hljs-type"><span class="hljs-type">Xmpp</span></span>.listen</code> </pre></blockquote><br>  Now, from any Rails application controller, we can easily send a message. <br><blockquote><pre> <code class="hljs cmake">Xmpp.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-string"><span class="hljs-string">", !"</span></span></code> </pre></blockquote><br>  Thank you for your attention, I hope this will be useful to someone. <br><br>  <a href="http://manageru.net/">Manageru</a> - <a href="http://zakgo.ru/">Zakgo</a> - <a href="http://enspe.com/">Ensp√©</a> </div><p>Source: <a href="https://habr.com/ru/post/119567/">https://habr.com/ru/post/119567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119561/index.html">Facebook application registration is open</a></li>
<li><a href="../119562/index.html">On-line broadcast forum Positive Hack Days</a></li>
<li><a href="../119563/index.html">Apple gadgets can evoke feelings comparable to religious ones.</a></li>
<li><a href="../119565/index.html">Bitcoin generation in the browser</a></li>
<li><a href="../119566/index.html">How to attract users to your startup</a></li>
<li><a href="../119569/index.html">Signed with the investor</a></li>
<li><a href="../119570/index.html">Read me, touch me ...</a></li>
<li><a href="../119571/index.html">Almost all modern browsers suffer from memory leaks (except IE9, Opera)</a></li>
<li><a href="../119574/index.html">Illuminations plugin for Firebug</a></li>
<li><a href="../119576/index.html">Inside an elephant: Evernote has a tech blog</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>