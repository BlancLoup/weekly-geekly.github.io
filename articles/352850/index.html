<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are preparing an iOS client for GraphQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am sure that each of us at least once had problems with the REST API. Eternal battles with back-up for the desired format of the API, several reques...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are preparing an iOS client for GraphQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/37d/2dc/2d0/37d2dc2d077d4b21a3d852ff59055994.png" alt="image"><br><br>  I am sure that each of us at least once had problems with the REST API.  Eternal battles with back-up for the desired format of the API, several requests for the screen and so on.  Agree that this is not uncommon, but a daily routine.  And recently, Tribuna Digital launched a new project - Betting Insider.  Initially, the project was implemented on iOS and Android, and later the development of the web version began.  The existing API was very inconvenient for the web.  This all led to the fact that we decided to arrange an experiment and try GraphQL with the client from Apollo.  If you want to get acquainted with this technology in iOS closer, then welcome under the cat! <br><a name="habracut"></a><br><h2>  A little bit about GraphQL </h2><br>  GraphQL - (Graph Query Language) is a query language and an instance for handling these queries.  To put it simply, this is an interlayer between our servers and the client, which gives the client what he needs from the server.  Communication with this layer occurs directly in GraphQL.  If you want to read in more detail directly about GraphQL Language and so on, or do not know anything at all, then we read <a href="https://habrahabr.ru/post/326986/">here</a> and <a href="https://habrahabr.ru/post/335050/">here</a> .  There, everything is quite detailed and with pictures. <br><br><h2>  What do we need? </h2><br>  For further work, we need <a href="https://nodejs.org/en/download/package-manager/">NodeJS</a> , <a href="https://www.npmjs.com/get-npm%3Futm_source%3Dhouse%26utm_medium%3Dhomepage%26utm_campaign%3Dfree%2520orgs%26utm_term%3DInstall%2520npm">Node Package Manager</a> , <a href="https://guides.cocoapods.org/using/getting-started.html">CocoaPods</a> . <br>  If you want to highlight graphql queries, then install this <a href="https://github.com/apollographql/xcode-graphql">plugin</a> .  You also need to download a pre-prepared <a href="https://github.com/loringit/GraphQL-Swift-Tutorial">project</a> .  And the most important is to get your personal key.  Here is the instruction, and we are requesting such an OSP: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  user </li><li>  repo </li></ul><br><br><h2>  What do we do? </h2><br>  We will write a small client for github in which we can find the top 20 repositories for any keyword.  To get a feel for the Github API and GraphQL, you can play <a href="https://developer.github.com/v4/explorer/">around here</a> . <br><br><h2>  Project Setup </h2><br>  Before you start writing code, install some packages and set up a project. <br>  The Apollo library uses code that is generated by their apollo-codegen tool.  Install it using npm: <br><br><pre><code class="bash hljs">npm install -g apollo-codegen</code> </pre> <br>  Next, go to the folder with the project and open the Source.  Download the diagram of your GraphQL server, and instead of &lt;token&gt; insert your personal key, which you should have done above: <br><br><pre> <code class="bash hljs">apollo-codegen download-schema https://api.github.com/graphql --output schema.json --header <span class="hljs-string"><span class="hljs-string">"Authorization: Bearer &lt;token&gt;"</span></span></code> </pre> <br>  Create a GraphQL folder in the Source folder. <br><br>  Next, you need to register a script for our code generator: <br><br><pre> <code class="bash hljs">APOLLO_FRAMEWORK_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(eval find $FRAMEWORK_SEARCH_PATHS -name "Apollo.framework" -maxdepth 1)</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APOLLO_FRAMEWORK_PATH</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"error: Couldn't find Apollo.framework in FRAMEWORK_SEARCH_PATHS; make sure to add the framework to your project."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SRCROOT}</span></span></span><span class="hljs-string">/Source"</span></span> <span class="hljs-variable"><span class="hljs-variable">$APOLLO_FRAMEWORK_PATH</span></span>/check-and-run-apollo-codegen.sh generate $(find . -name <span class="hljs-string"><span class="hljs-string">'*.graphql'</span></span>) --schema schema.json --output GraphQL/API.swift</code> </pre> <br><img src="https://habrastorage.org/webt/g2/i7/p0/g2i7p0hjrgr7h-xrwpw2pc0osj0.png"><br><br><img src="https://habrastorage.org/webt/fs/iw/ft/fsiwftqoosceq_fayqyv7jfz_ck.png"><br><br>  When you first start a project build, this script will create an API.swift file that will contain the necessary code to work with your requests, and will be updated with each build.  At the moment, Xcode will generate an error at the build stage, as we are missing something. <br><br><h2>  Requests </h2><br>  The code generator for creating an API needs a file, where all queries in GraphQL will be written.  Create a new empty file in the Source / GraphQL folder (at the bottom of the file list) with the name github.graphql.  Next, let's write a query to this file, which will give us the first 20 repositories for the search query, and also immediately determine the fragment for the repository. <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">query</span></span> <span class="hljs-type"><span class="hljs-type">SearchRepos</span></span>($searchText: <span class="hljs-type"><span class="hljs-type">String</span></span>!) { search(first: <span class="hljs-number"><span class="hljs-number">20</span></span>, query: $searchText, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">REPOSITORY</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nodes</span></span></span><span class="hljs-class"> { ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Repository</span></span></span><span class="hljs-class"> { ...</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RepositoryDetail</span></span></span><span class="hljs-class"> } } } } fragment </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RepositoryDetail</span></span></span><span class="hljs-class"> on </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Repository</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nameWithOwner</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewerHasStarred</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stargazers</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">totalCount</span></span></span><span class="hljs-class"> } }</span></span></code> </pre><br>  Next, build the project so that the code we need is generated.  Add the resulting API.swift file to the project. <br><br>  <b>IMPORTANT: If you added a new code to * .graphql, first build the project and only then begin to write a new code!</b> <br><br><h2>  Customer </h2><br>  You need to create an Apollo client.  Create it in AppDelegate.swift above the AppDelegate declaration.  Since communication with github requires authorization, you need to add a header to all our requests.  We get just such a thing: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> apollo: ApolloClient = { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> configuration = URLSessionConfiguration.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> configuration.httpAdditionalHeaders = [<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>: <span class="hljs-string"><span class="hljs-string">"bearer &lt;your token&gt;"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> url = URL(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>: <span class="hljs-string"><span class="hljs-string">"https://api.github.com/graphql"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApolloClient(networkTransport: HTTPNetworkTransport(url: url, configuration: configuration)) }()</code> </pre> <br><h2>  Search query </h2><br>  Now you need to make sure that when you click on the Search button, we send a request to the server.  Create a file ReposListViewModel.swift, but ReposListViewModel.  This will be the class that will send our requests to the server, as well as manage the status of existing requests. <br><br>  To begin, import Apollo, and then create a variable of type Cancellable and call it currentSearchCancellable: <br><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Apollo</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReposListViewModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentSearchCancellable: <span class="hljs-type"><span class="hljs-type">Cancellable</span></span>? }</code> </pre> <br>  Next, create a function that will accept the text for the search, and in the callback we will transfer the resulting array.  Finally go directly to sending the request!  First you need to create a query.  Our code generator generated a query for us, which corresponds to the name we gave it in the graphql file: SearchReposQuery, and we will initialize it with the help of search text.  Next, to get a response, we call the fetch function in the Apollo client, to which we will transfer our query, and also select the main execution queue and the corresponding caching policy.  In callback fetch gives our optional result and error.  For the time being we will not think about the error handling, but simply print it in case of occurrence.  Let's pull out of the result the RepositoryDetail, which also generated the code generator to us and pass them to the search callback function.  Such function will turn out <br>  : <br><pre> <code class="hljs markdown">func search(for text: String, completion: @escaping ([<span class="hljs-string"><span class="hljs-string">RepositoryDetail</span></span>]) -&gt; Void) { currentSearchCancellable?.cancel() let query = SearchReposQuery(searchText: text) currentSearchCancellable = apollo.fetch(query: query, cachePolicy: .returnCacheDataAndFetch, queue: .main, resultHandler: { (result, error) in if let result = result, let data = result.data { let repositoryDetails = (data.search.nodes ?? [<span class="hljs-string"><span class="hljs-string">SearchReposQuery.Data.Search.Node?</span></span>](<span class="hljs-link"></span><span class="hljs-link"></span>)).map{$0?.asRepository}.filter{$0 != nil}.map{($0?.fragments.repositoryDetail)!} completion(repositoryDetails) } else { print(error as Any) completion([<span class="hljs-string"><span class="hljs-string">RepositoryDetail</span></span>](<span class="hljs-link"></span><span class="hljs-link"></span>)) } }) }</code> </pre> <br>  Now we will create the viewModel as the ReposListViewController parameter, as well as an array for storing the RepositoryDetail: <br><br><pre> <code class="hljs markdown">let viewModel = ReposListViewModel() var repositoryDetails = [<span class="hljs-string"><span class="hljs-string">RepositoryDetail</span></span>](<span class="hljs-link"></span><span class="hljs-link"></span>)</code> </pre> <br>  Next, change the numberOfRowsInSection to: <br><br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tableView: UITableView, numberOfRowsInSection section: Int)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repositoryDetails.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> }</code> </pre> <br>  Also need to update ReposListCell: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReposListCell</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewCell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repoName: <span class="hljs-type"><span class="hljs-type">UILabel!</span></span> <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> starCount: <span class="hljs-type"><span class="hljs-type">UILabel!</span></span> <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> starButton: <span class="hljs-type"><span class="hljs-type">UIButton!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repositoryDetail: <span class="hljs-type"><span class="hljs-type">RepositoryDetail!</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">didSet</span></span> { repoName.text = repositoryDetail.nameWithOwner starCount.text = <span class="hljs-string"><span class="hljs-string">"\(repositoryDetail.stargazers.totalCount)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> repositoryDetail.viewerHasStarred { starButton.setImage( imageLiteral(resourceName: <span class="hljs-string"><span class="hljs-string">"ic_full_star"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: .normal) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { starButton.setImage( imageLiteral(resourceName: <span class="hljs-string"><span class="hljs-string">"ic_empty_star"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: .normal) } } } }</code> </pre> <br>  And cellForRow will take this form: <br><br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UITableViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="hljs-string"><span class="hljs-string">"ReposListCell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">ReposListCell</span></span> cell.repositoryDetail = repositoryDetails[indexPath.row] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }</code> </pre> <br>  It remains to ask the viewModel for the data we need on click: <br><br><pre> <code class="hljs swift"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchBarSearchButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> searchBar: UISearchBar)</span></span></span></span> { viewModel.search(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: searchBar.text ?? <span class="hljs-string"><span class="hljs-string">""</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] repositoryDetails <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.repositoryDetails = repositoryDetails <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tableView.reloadData() } }</code> </pre> <br>  Done!  Compile and look for the top 20 repositories for your request! <br><br><h2>  Put the stars </h2><br>  As you already understood, the star in the layout of the cell is not just.  Let's add this functionality to our application.  To do this, you need to create a new mutation request, but before that let's get your ID <a href="https://caius.github.io/github_id/">here</a> .  Now you can insert a search query with the appropriate clientMutationID and build the project: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">mutation </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddStar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> $repositoryId: ID!</span></span></span><span class="hljs-function">)</span></span> { addStar(input: {clientMutationId: ‚Äú&lt;your ID&gt;‚Äù, starrableId: $repositoryId}) { starrable { ... <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Repository { ...RepositoryDetail } } } } <span class="hljs-function"><span class="hljs-function">mutation </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveStar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$repositoryId: ID!</span></span></span><span class="hljs-function">)</span></span> { removeStar(input: {clientMutationId: ‚Äú&lt;your ID&gt;‚Äù, starrableId: $repositoryId}) { starrable { ... <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Repository { ...RepositoryDetail } } } }</code> </pre> <br>  Add the execution of these requests to the ViewModel.  The logic is the same as with query, but instead of fetch, we now call perform: <br><br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addStar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repositoryID: String, completion: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(RepositoryDetail?)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span> ) { currentAddStarCancellable?.cancel() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mutation = <span class="hljs-type"><span class="hljs-type">AddStarMutation</span></span>(repositoryId: repositoryID) currentAddStarCancellable = apollo.perform(mutation: mutation, queue: .main, resultHandler: { (result, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = result, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> data = result.data { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> repositoryDetails = data.addStar?.starrable.asRepository?.fragments.repositoryDetail completion(repositoryDetails) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">Any</span></span>) completion(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>) } }) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeStar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repositoryID: String, completion: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(RepositoryDetail?)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span> ) { currentRemoveStarCancellable?.cancel() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mutation = <span class="hljs-type"><span class="hljs-type">RemoveStarMutation</span></span>(repositoryId: repositoryID) currentAddStarCancellable = apollo.perform(mutation: mutation, queue: .main, resultHandler: { (result, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = result, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> data = result.data { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> repositoryDetails = data.removeStar?.starrable.asRepository?.fragments.repositoryDetail completion(repositoryDetails) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">Any</span></span>) completion(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>) } }) }</code> </pre> <br>  Now we need to let the ViewController know that we pressed the button.  Make it a cell delegate.  To do this, create a protocol and add it to the ReposListCell.swift file: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReposListCellDelegate</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">starTapped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cell: ReposListCell)</span></span></span></span> }</code> </pre><br>  Add a new cell class parameter and a star click handling: <br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delegate: <span class="hljs-type"><span class="hljs-type">ReposListCellDelegate?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">awakeFromNib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.awakeFromNib() starButton.addTarget(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, action: #selector(starTapped), <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: .touchUpInside) } <span class="hljs-meta"><span class="hljs-meta">@objc</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">starTapped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { delegate?.starTapped(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) }</code> </pre> <br>  Now let's set the controller as delegate to cellForRow: <br><br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UITableViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="hljs-string"><span class="hljs-string">"ReposListCell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">ReposListCell</span></span> cell.repositoryDetail = repositoryDetails[indexPath.row] cell.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }</code> </pre> <br>  Add a function that will update the data in the table: <br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateTableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newDetail: RepositoryDetail?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> repositoryDetail = newDetail { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (index, detail) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> repositoryDetails.enumerated() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> detail.id == repositoryDetail.id { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.repositoryDetails[index] = repositoryDetail <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> visibleCell <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tableView.visibleCells { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (visibleCell <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">ReposListCell</span></span>).repositoryDetail.id == repositoryDetail.id { (visibleCell <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">ReposListCell</span></span>).repositoryDetail = repositoryDetail } } } } } }</code> </pre> <br>  And it remains to expand the controller for the previously created controller: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReposListViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReposListCellDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">starTapped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cell: ReposListCell)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cell.repositoryDetail.viewerHasStarred { viewModel.removeStar(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: cell.repositoryDetail.id) { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] repositoryDetail <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.updateTableView(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: repositoryDetail) } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { viewModel.addStar(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: cell.repositoryDetail.id) { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] repositoryDetail <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.updateTableView(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: repositoryDetail) } } } }</code> </pre> <br>  Done!  We can run the application, search for the top 20 repositories and put / remove asterisks! <br><br>  This is not all.  Interesting is the use of this library in the amount of RxSwift, the solution to the problem of pagination, and Apollo also supports caching, but about everything next time! <br><br>  If you want to solve such problems with us - join us!  Questions and resumes can be sent to mail jobs@tribuna.digital. <br><br>  More vacancies <a href="http://careers.tribuna.digital/">here!</a> </div><p>Source: <a href="https://habr.com/ru/post/352850/">https://habr.com/ru/post/352850/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352840/index.html">News from Go, or what's new in GoLand 2018.1</a></li>
<li><a href="../352842/index.html">Arrested the leader of the cyber group, who stole more than 1 billion euros from banks around the world</a></li>
<li><a href="../352844/index.html">We write a simple plugin for VirtualDub</a></li>
<li><a href="../352846/index.html">Distrust of authority and economy: main trends of millenial investment activity according to Robinhood service statistics</a></li>
<li><a href="../352848/index.html">Backend United # 1. The vinaigrette. Announcement</a></li>
<li><a href="../352852/index.html">Excel-calculator of complex wave resistance transformation on waveguide line segments</a></li>
<li><a href="../352854/index.html">We keep the design of the system under control using isolated unit testing</a></li>
<li><a href="../352856/index.html">AWS framework for serverless applications</a></li>
<li><a href="../352858/index.html">Tehnostrim. Learning to build the Internet</a></li>
<li><a href="../352860/index.html">DANOS: First Open Network Operating System Presented</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>