<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why large databases do not work as you want, or about the unfulfilled dreams of SQL queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the operation team, they thought that our experience with Microsoft SQL in a loaded environment can no longer be hidden, and therefore this article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why large databases do not work as you want, or about the unfulfilled dreams of SQL queries</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/ac8/f27/bb4/ac8f27bb48ad49bd837cafec3c5188b9.png" alt="image"></p><br><p>  In the operation team, they thought that our experience with Microsoft SQL in a loaded environment can no longer be hidden, and therefore this article was born.  In it, I will talk about the nuances of working with this DBMS from practice. </p><br><p>  Microsoft SQL Server has long found its place in the Yandex.Money product family and successfully solves the problem of collecting scattered information about all operations from a variety of individual services.  Without such an assembly together it would be impossible to track the payment, collect statistics or solve a problem. </p><br><p>  All of the above will be useful to administrators of large databases - those who care about the fast and accurate work of Microsoft SQL Server 2012-2014 analytics. </p><br><p>  <strong>If the information turns out to be useful and interesting for you, be sure to let us know in the comments so that the author does not relax.</strong> <a name="habracut"></a></p><br><div class="spoiler">  <b class="spoiler_title">Why I am telling all this, or a brief description of the author.</b> <div class="spoiler_text"><p>  My name is Slava, I am the head of the group for administering Microsoft SQL servers in Yandex.Money. </p><br><p>  I have been working with this DBMS since version 6.5, on MS SQL 7-2000 I created <a href="http://www.sql.ru/forum/51712/tool-vy-znaete-chto-tvoritsya-na-vashih-10-30-serverah">a monitoring system</a> for 20-30 servers;  After the release of MS SQL 2005 and the transition from DMO to SMO, <a href="https://sites.google.com/site/simba07%26sa%3DD%26ust%3D1492086098482000%26usg%3DAFQjCNG7IlOxywVoGpkVDDk2rRs4dNv1Ow">monitoring was</a> completely <a href="https://sites.google.com/site/simba07%26sa%3DD%26ust%3D1492086098482000%26usg%3DAFQjCNG7IlOxywVoGpkVDDk2rRs4dNv1Ow">rewritten</a> . </p><br><p>  In the team Yandex. Money - from the end of 2012. </p></div></div><br><p>  For further understanding, I will say a few words about the architecture of our storage system.  Each component of the Yandex.Money payment system knows only its own piece of information about the payment, so you need to somehow regularly collect information from all components, aggregate it, and identify relationships. </p><br><p>  From this data, cubes with hundreds of dimensions are built daily, reports and registers are generated, and reconciliations take place.  After that, ‚Äúcombed‚Äù data is given to users and financial systems for further work.  Microsoft SQL Server with its powerful <strong>Integration Services</strong> and the <strong>ETL</strong> (Extract - Transform - Load) process was a great fit for these tasks. </p><br><p>  We also actively use <strong>Analysis Services</strong> to build <strong>OLAP cubes</strong> .  They provide data in a multi-dimensional form with any cut, simple for analysts, financiers, product managers and management. </p><br><h1 id="pochemu-minutnye-zaprosy-mogut-rabotat-chas">  Why minute requests can work an hour </h1><br><p>  The most common reason for this is outdated statistics (information about the state of the table columns) and, as a result, not optimal plans. </p><br><p><img src="https://habrastorage.org/files/bf5/839/b82/bf5839b8288f4231b1845212def220c0.png" alt="image alt text"></p><br><div class="spoiler">  <b class="spoiler_title">A small reminder of the statistics, plans and how it all relates.</b> <div class="spoiler_text"><p>  When executing any query to the database, the execution plan is built from a sorted list of operations performed.  Choosing a specific operation, a separate component ‚Äúquery optimizer‚Äù selects among the important input data statistics that describes the distribution of values ‚Äã‚Äãfor the columns of the database table. </p><br><p>  This estimate of the number of elements allows the query optimizer to build more or less optimal execution plans.  Therefore, outdated statistics spoils the whole thing. </p><br><p>  An incorrect estimate can lead to redundant disk I / O operations due to a lack of memory allocated for transfer to TempDB.  In addition, a DBMS can choose a sequential execution plan instead of a parallel one ‚Äî these are just some of the possible consequences. </p></div></div><br><p>  On Habr√© there are already <a href="https://habrahabr.ru/post/209816/">articles on automating the updating of statistics</a> , so I will not dwell on this point in detail.  But updating statistics can be time consuming and loading, and the result is unstable due to the fact that the data in the table changes faster than updating statistics.  In such cases, I simply globally turn on the trace flag, which changes the 20% threshold for updating statistics to a dynamically changing percentage of table changes: </p><br><pre><code class="sql hljs">DBCC TRACEON (2371,-1)</code> </pre> <br><p>  If the statistics flag is on, they will be updated more frequently with an increase in the number of lines. </p><br><p>  It helps a lot, but on tables with a billion rows and more, the process can be extremely slow, despite the normal design. </p><br><p>  In this case, the inclusion of asynchronous statistics updates helps: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> dbName <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> AUTO_UPDATE_STATISTICS_ASYNC <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span></code> </pre><br><p>  During the update, SQL statistics will continue to work without waiting for the process to complete.  According to our tests, queries to the database without enabling this option are very unstable.  Try this experiment yourself. </p><br><p>  But even with good plans and up-to-date statistics, there may be unexplained delays in executing requests.  In my experience, the most frequent reason for this (after incorrect plans) was demanding of server memory requests, which were in the queue for execution due to a formal lack of requested resources. </p><br><p>  When simultaneously running five or more requests, voracious to memory, and also if there is a limit "in one hand" by default of 25% - the first four are given all the memory.  All other requests can only queue up with the <strong>RESOURCE_SEMAPHORE</strong> indicator, waiting for the memory to be freed. </p><br><p>  About half of the available server RAM is used to make requests.  In systems where RAM is more than 128 GB, 25% is very significant. </p><br><p>  According to my observations, from 20 to 80% of the allocated memory, the request simply does not use - it is perfectly visible if you run the command while the requests are running: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_query_memory_grants</code> </pre><br><p>  After executing the command, you will see currently processed queries in the database with the expectations of resources, if they occurred during the work. </p><br><p><img src="https://habrastorage.org/files/8a5/2a2/e72/8a52a2e7202d46e8b02a28be560cab9e.png" alt="image alt text"></p><br><p>  <em>The result of processing the query on one of our test databases.</em> </p><br><p>  Request requested and received 9 GB, but used only 10%.  Pay attention to the <strong>ideal_memory_kb</strong> field - it contains unfulfilled dreams of requests. </p><br><blockquote>  Effectively deal with irrational memory consumption when executing requests with the help of the <a href="https://msdn.microsoft.com/ru-ru/library/bb933866(v%3Dsql.130).aspx">Resource Governor</a> .  It allows you to set restrictions on CPU usage and memory usage. <br>  I also recommend using the <a href="https://habrahabr.ru/post/136481/">stored procedure <strong>sp_WhoIsActive</strong></a> .  It collects server status information through dynamic views (DMV).  Very simple and powerful tool. </blockquote><p>  I use the sp_WhoIsActive procedure with this set of parameters: </p><br><pre> <code class="sql hljs">sp_whoisactive @not_filter = 'ReportServer', @not_filter_type = 'database', @get_plans=1, @find_block_leaders = 1, @get_task_info = 2, @get_additional_info=1<span class="hljs-comment"><span class="hljs-comment">--, @get_locks = 1</span></span></code> </pre><br><p>  Such requests can be identified by simply observing active requests at the time of excessive load.  You can also create a task that will run the query <strong>select * from sys.dm_exec_query_memory_grants</strong> once every 5-10 minutes, saving the results in a table.  The resulting values ‚Äã‚Äãcan be analyzed and find problematic requests for the difference between <strong>granted_memory_kb</strong> and <strong>max_used_memory_kb</strong> . </p><br><p>  Next, you need to identify the connections that take the memory beyond the required, and redirect them using ResourceGovernor to the group where the memory is issued with a margin of 10-20% instead of 80%. </p><br><p>  The value for the REQUEST_MAX_MEMORY_GRANT_PERCENT parameter (specified as a percentage of the available memory) can be calculated using the following script: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> res.name, sem.target_memory_kb /<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> target_memory_Mb, sem.available_memory_kb / <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> available_memory_MB, sem.granted_memory_kb/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> granted_memory_Mb, sem.used_memory_kb / <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> used_memory_Mb, sem.grantee_count, sem.waiter_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_exec_query_resource_semaphores sem <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.resource_governor_workload_groups res <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sem.pool_id = res.pool_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> sem.resource_semaphore_id =<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><p>  As a result, you can determine how much memory for requests the server has and each group that you add or configure. </p><br><p>  After all the above manipulations, the memory allocation between requests will become more efficient, with a minimum of situations where requests are just waiting for memory allocation and do nothing. </p><br><h1 id="alwayson-v-nagruzhennyh-bazah-dannyh">  AlwaysON in loaded databases </h1><br><p>  About the pros and cons of <a href="https://msdn.microsoft.com/ru-ru/library/ff877884.aspx">AlwaysON</a> , the environment of high availability for the database, did not write just lazy.  However, information about the practical use of this technology for terabyte databases is not so much.  When back in 2013 we introduced high-availability groups in Yandex.Money, there was no information even about actual operation in combat environments.  Our main database at that time was just about 4 TB, so many things had to be reached on our own. </p><br><div class="spoiler">  <b class="spoiler_title">Typical cluster node configuration.</b> <div class="spoiler_text"><p>  The high availability cluster consisted of two nodes with the following characteristics: 192 GB of memory, 2 ‚Äúshelves‚Äù with SAS disks per server and a separate shelf for backup with SATA drives, a network of 4 Gigabit interfaces in TEAM. </p></div></div><br><p>  Over four years, the volume of this database grew to 20 TB, so the servers hardly coped with the new load, and the optimization of the indices caused additional problems, which are discussed below.  The performance of the database during the processing of cubes on the network was such that traffic interfered with other components in the network until the cluster was transferred to a separate powerful switch. </p><br><p>  In peaks, it reached the point that nodes lost each other and the database on the second node was disconnected (hello to cluster quorum).  But with this figured out the addition of new network cards;  and in the new machines they simply put 10 GB cards right away. </p><br><p>  Excluding the listed architectural problems, the overall impression of the AlwaysON technology is positive: </p><br><ul><li><p>  Traffic between nodes is compressed to 80-90%. </p><br></li><li><p>  Read-Only (RO) replicas are quickly synchronized and returned to service after a long shutdown. </p><br></li><li><p>  To clone a database into a test environment, you can use <strong>log shipping</strong> (delivery of transaction logs) in manual mode. </p><br></li><li>  AlwaysON is very reliable, but Windows Server Failover Clustering (WSFC) sometimes crashes and pulls AlwaysON groups along. </li></ul><br><p>  To minimize the number of unreasonable clustering service solutions to extinguish a cluster in a two-node configuration, we developed a solution with a forced voiding of the secondary node: </p><br><pre> <code class="hljs perl">Import-Module FailoverClusters $node = <span class="hljs-string"><span class="hljs-string">"Srv1"</span></span> (Get-ClusterNode $node).NodeWeight = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><p>  With such parameters, it becomes calmer when working on secondary nodes. </p><br><h1 id="rassinhronizacii-v-gruppah-alwayson">  Out of sync in groups AlwaysON </h1><br><p>  During operation of large databases with load distribution in groups of AlwaysON, out-of-synchronization of the main and secondary nodes may occur.  If a long SELECT operation is performed on the RO node to a table that is updated at the same time on the main node, the change log chain (LSN) will be blocked.  Desynchronization will affect all tables and will hold for as long as the query is running - at this time the data in the database on the replica will become irrelevant. </p><br><p>  There are usually no obvious signs of desynchronization, but on the Read-Only nodes a new process appears, launched on behalf of <strong>sa.</strong>  Also, cascade locks often occur, which can be quickly detected using the sp_whoisactive procedure described above. </p><br><p>  The reason is in a Select running with an isolation level of READ COMMITTED (that is, with a default value). </p><br><p>  As a solution, you can use the <strong>WITH (NOLOCK)</strong> parameter in the query itself or change the isolation level for the database or session on <strong>SNAPSHOT</strong> to isolate with long queries to the tables. </p><br><p>  To find out about out of sync before users, we use a script to monitor.  Once every 5 minutes, he checks the synchronization status and sends an e-mail in case of a problem. </p><br><div class="spoiler">  <b class="spoiler_title">An example of a script for monitoring an unknown author from the Internet</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @Delay <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @Delay = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpag_availability_groups from master.sys.availability_groups select group_id, replica_id,replica_server_name,availability_mode into #tmpdbr_availability_replicas from master.sys.availability_replicas select replica_id,group_database_id,database_name,is_database_joined,is_failover_ready into #tmpdbr_database_replica_cluster_states from master.sys.dm_hadr_database_replica_cluster_states select * into #tmpdbr_database_replica_states from master.sys.dm_hadr_database_replica_states select replica_id,role,is_local into #tmpdbr_availability_replica_states from master.sys.dm_hadr_availability_replica_states select ars.role, drs.database_id, drs.replica_id, drs.last_commit_time into #tmpdbr_database_replica_states_primary_LCT from #tmpdbr_database_replica_states as drs left join #tmpdbr_availability_replica_states ars on drs.replica_id = ars.replica_id where ars.role = 1 SELECT --'&lt;tr&gt;&lt;td align="center"&gt;' + AR.replica_server_name + '- ' + AG.name + ' ' + dbcs.database_name + '&lt;/td&gt;' AS SRV_AG_DB, AR.replica_server_name + '- ' + AG.name + ' ' + dbcs.database_name AS SRV_AG_DB, --CASE dbcs.is_failover_ready WHEN 1 THEN 0 ELSE ISNULL(DATEDIFF(ss, dbr.last_commit_time, dbrp.last_commit_time), 0) END AS [EstimatedDataLoss], --'&lt;td align="center"&gt;' + Cast(ISNULL(dbr.last_redone_time, 0) AS varchar(50)) + '&lt;/td&gt;' As LastRedoneTime , Cast(ISNULL(dbr.last_redone_time, 0) AS varchar(50)) As LastRedoneTime , --'&lt;td align="center"&gt;' + Cast((CASE dbcs.is_failover_ready WHEN 1 THEN 0 ELSE ISNULL(DATEDIFF(ss, dbr.last_commit_time, dbrp.last_commit_time), 0) END)as nvarchar(10)) + '&lt;/td&gt;' AS [EstimatedDataLoss2], Cast((CASE dbcs.is_failover_ready WHEN 1 THEN 0 ELSE ISNULL(DATEDIFF(ss, dbr.last_commit_time, dbrp.last_commit_time), 0) END)as nvarchar(10)) AS [EstimatedDataLoss2], --'&lt;td align="center"&gt;' + Cast(ROUND(ISNULL(CASE dbr.redo_rate WHEN 0 THEN -1 ELSE CAST(dbr.redo_queue_size AS float) / dbr.redo_rate END, -1),-1) as nvarchar(10)) + '&lt;/td&gt; &lt;/tr&gt;' AS [EstimatedRecoveryTime] Cast(ROUND(ISNULL(CASE dbr.redo_rate WHEN 0 THEN -1 ELSE CAST(dbr.redo_queue_size AS float) / dbr.redo_rate END, -1),-1) as nvarchar(10)) AS [EstimatedRecoveryTime] INTO #tt FROM #tmpag_availability_groups AS AG INNER JOIN #tmpdbr_availability_replicas AS AR ON AR.group_id=AG.group_id INNER JOIN #tmpdbr_database_replica_cluster_states AS dbcs ON dbcs.replica_id = AR.replica_id LEFT OUTER JOIN #tmpdbr_database_replica_states AS dbr ON dbcs.replica_id = dbr.replica_id AND dbcs.group_database_id = dbr.group_database_id LEFT OUTER JOIN #tmpdbr_database_replica_states_primary_LCT AS dbrp ON dbr.database_id = dbrp.database_id INNER JOIN #tmpdbr_availability_replica_states AS arstates ON arstates.replica_id = AR.replica_id WHERE --(AG.name='Nastro') and ISNULL(CASE dbr.redo_rate WHEN 0 THEN -1 ELSE CAST(dbr.redo_queue_size AS float) / dbr.redo_rate END, -1) &gt; @Delay --(AG.name=@AGN) and ISNULL(CASE dbr.redo_rate WHEN 0 THEN -1 ELSE CAST(dbr.redo_queue_size AS float) / dbr.redo_rate END, -1) &gt; @Delay IF EXISTS (SELECT * from #tt) BEGIN declare @tableHTML nvarchar(max) set @tableHTML =N'&lt;H3&gt;&lt;FONT SIZE="3" FACE="Tahoma"&gt;AlwaysOn Status &lt;/FONT&gt;&lt;/H3&gt;' set @tableHTML = @tableHTML +N'&lt;table border="1" bgcolor=D7D1F8&gt;' + -- change the background color if you want N'&lt;FONT SIZE="2" FACE="Calibri"&gt;' + N'&lt;tr&gt;&lt;th align="center"&gt;Server Group DB&lt;/th&gt;' + N'&lt;th align="center"&gt;LastRedoneTime&lt;/th&gt;' + N'&lt;th align="center"&gt;EstimatedDataLoss&lt;/th&gt;' + N'&lt;th align="center"&gt;EstimatedRecoveryTime&lt;/th&gt;' + N'&lt;/tr&gt;' + ISNULL(CAST ( ( SELECT * from #tt FOR XML PATH('tr'), TYPE ) AS NVARCHAR(MAX) ),'') + N'&lt;/FONT&gt;' + N'&lt;/table&gt;' ; --send email EXEC msdb.dbo.sp_send_dbmail @profile_name = 'mail', -- change here !! @recipients='Admin1@yandex.ru;Admin2@yandex.ru', -- change here !! @subject = 'AlwaysON Report', @body = @tableHTML, @body_format = 'HTML' ; END DROP TABLE #tmpdbr_availability_replicas DROP TABLE #tmpdbr_database_replica_cluster_states DROP TABLE #tmpdbr_database_replica_states DROP TABLE #tmpdbr_database_replica_states_primary_LCT DROP TABLE #tmpdbr_availability_replica_states drop table #tmpag_availability_groups SELECT * from #tt drop table #tt</span></span></code> </pre></div></div><br><p>  Another common cause of out of sync is the maintenance of the indices.  For example, in the reorganization of the cluster index in the table with a capacity of 500 GB, we observed out of sync for 10 hours. </p><br><p>  The easiest way to minimize this time is to use the MAXDOP option when creating or rebuilding indexes.  I usually put the value "2" for indexes from 10-20 GB, and for smaller ones - "4". </p><br><h1 id="marshrutizaciya-read-only-zaprosov">  Routing Read-Only Requests </h1><br><p>  The nuance with read requests from Read-Only database replicas is that it is not enough to set the parameter ApplicationIntent = ReadOnly in the connection string - you will need to <a href="https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/configure-read-only-routing-for-an-availability-group-sql-server">configure the routing as well</a> .  Of course, this setting applies to those who, once set up, no longer touch, but His Majesty Chance broke and not such schemes.  For example, in the course of work it may be necessary to redirect requests from the RO replica to the main one. </p><br><p>  For this, we used to use the settings of the replica itself, simply banning requests to the RO.  But the approach had to be changed after several unpleasant situations due to the following features of switching by replica settings: </p><br><ul><li><p>  The switch was tough, current requests to the RO were lost, which is not very cool. </p><br></li><li>  When returning traffic to RO, blocking of all requests with the <strong>hadr_sync_commit</strong> indicator for each of them often occurred.  And now it was not at all fun, because, while they are hanging, the commit does not occur.  It was necessary to change the addresses of connections in client applications until the replica normalizes. </li></ul><br><p>  Later it turned out that it is more correct to redirect RO requests through a change of routing. </p><br><p>  Here is an example for a configuration with a distributed load of 2 nodes: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVAILABILITY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> [AGGroupName] <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> REPLICA <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> N<span class="hljs-string"><span class="hljs-string">'PrimaryDB01‚Ä≤ WITH (PRIMARY_ROLE (READ_ONLY_ROUTING_LIST=('</span></span>SecondaryDB01<span class="hljs-string"><span class="hljs-string">','</span></span>PrimaryDB01<span class="hljs-string"><span class="hljs-string">'))); -- ,  RO       SecondaryDB01         ALTER AVAILABILITY GROUP [AGGroupName] MODIFY REPLICA ON N'</span></span>PrimaryDB01‚Ä≤ <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PRIMARY_ROLE (READ_ONLY_ROUTING_LIST=(<span class="hljs-string"><span class="hljs-string">'PrimaryDB01'</span></span>))); <span class="hljs-comment"><span class="hljs-comment">--          PrimaryDB01;</span></span></code> </pre><br><p>  In the process of changing the routing requests are regularly completed, and the following go immediately to the main replica. </p><br><p>  Over the 4 years of the system‚Äôs operation, there was once a failure on the RO replica.  One of the sections with CRC error in the data file fell.  The main node continued to work, but the base on the RO replica is not. </p><br><p>  Fault handling at the base of the RO node and automatic switching of traffic to the main node can be implemented using the same routing: </p><br><ol><li><p>  create a task with a request to any table in the database; </p><br></li><li><p>  if the request fails, check the database on the main node in the same way; </p><br></li><li>  If everything is fine on the main node, then we switch traffic to it.  On weekends or at night, this will allow you to sleep well and deal with the problem with a fresh mind. </li></ol><br><p>  As for restoring the database after such a failure, it is easier to remove a large database from the availability group (on the main node it will continue to work even through the Listener) and restore the backup on the Read-Only node in no-recovery mode.  Then it is enough to add the restored database to the accessibility group in the <strong>Join Only</strong> mode. </p><br><p>  Addition: <br>  <a href="http://www.queryprocessor.ru/fast-in-ssms-slow-in-app-part1/">Slow in the app, fast in SSMS ...</a> - Thanks for the link <a href="https://habrahabr.ru/users/alandenton/" class="user_link">AlanDenton</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326436/">https://habr.com/ru/post/326436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326424/index.html">Playstation VR games that can already be played</a></li>
<li><a href="../326428/index.html">node.js beats binary data when working on http because of the default encoding - we treat and hate</a></li>
<li><a href="../326430/index.html">Two vacancies for the price of one in April on My Circle</a></li>
<li><a href="../326432/index.html">Windows 10 Creators Update: What's new in Bash / WSL and Windows Console</a></li>
<li><a href="../326434/index.html">PHDays Online Contests: Yes CTF</a></li>
<li><a href="../326438/index.html">Moscow Workshops ACM ICPC: how Fiztech created an international camp</a></li>
<li><a href="../326440/index.html">Failover Evolution in PostgreSQL: Replication Phase</a></li>
<li><a href="../326442/index.html">Asynchronous functions 101</a></li>
<li><a href="../326444/index.html">Customer service: people are better than robots</a></li>
<li><a href="../326446/index.html">Recruitment marketing guide for dummies (and not only)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>