<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP linux server incoming / outgoing traffic balancer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As I found out some time ago on my own experience, there are still providers left to receive an unlimited tariff from which it is required to withstan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP linux server incoming / outgoing traffic balancer</h1><div class="post__text post__text-html js-mediator-article">  As I found out some time ago on my own experience, there are still providers left to receive an unlimited tariff from which it is required to withstand a certain ratio of incoming and outgoing traffic. <br>  In my case, when hosting a server for colocation in one Moscow data center, the outgoing should have been at least 4 times more than the incoming one (sorry for such a turn).  The ratio is calculated both per day and total per month.  Violation of any of them is a fine. <br><br>  By itself, the ratio was not maintained due to periodic volume uploads of backups to the server.  Manually (gig sent, 4 gig downloaded) - tired. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then I remembered that once upon a time a primitive script was seen on some site in a couple of lines on a sh-script that did this balancing itself.  Then I did not save, now I could not find it.  I had to write myself.  Result and expose for everyone to see - maybe someone will come in handy. <br><br>  The script was tested only under Ubuntu, but also under other Linux should work. <br><br>  Unlike the primitive on sh, my script is able to withstand both daily and monthly ratios, logs, and is carefully encrypted from its detection (fake traffic is done by transferring files of random size via SSH, spacing of random length is done between stuffing).  Another difference (but already with a minus sign) is required response node with unlimited traffic, to which you can raise the ssh connection by key.  I use my home channel and router on it. <br><br>  Put your values ‚Äã‚Äãin the $ interface, $ logfile and $ server variables. <br>  The $ server variable actually specifies the parameters for the ssh command. <br>  That is, in my case, running ‚Äússh my-host.no-ip.org -p 1022 -i /home/user/.ssh/my-key‚Äù in the console, I connect without entering a password to my response node (these are conditional , of course). <br>  Calling this script must be done at system startup (for example from /etc/rc.local) or configured as a service. <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $interface=<span class="hljs-string"><span class="hljs-string">"eth0"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    $server="my-host.no-ip.org -p 1022 -i /home/user/.ssh/my-key"; //    $logfile="/usr/local/logs/trafic-balancer.log"; //       ,   logrotate   $curdate=0; function echolog($str) { global $logfile; file_put_contents($logfile, $str, FILE_APPEND); echo($str); } echolog("\n".date('r')." \t\n"); while(true) { $f=@fopen("/proc/net/dev", "r"); $stat=null; while($str=fgets($f)) { if(strpos($str, $interface)!==false) { $stat=$str; break; } } fclose($f); if($stat) { $stat=preg_replace("/\s+/", " ", $stat); $nums=explode(" ", $stat); //       $rx_g=round($nums[2]/1024/1024); $tx_g=round($nums[10]/1024/1024); $delta_g=$rx_g*4-$tx_g; //   if($curdate!=date('j')) //    { if($curdate) echolog("\n".date('r')." \t  $curdate : RX:$rx_d Mb, TX:$tx_d Mb, : $delta_d Mb\n"); $curdate=date('j'); $rx_d=0; $tx_d=0; $rx_s=$rx_g; $tx_s=$tx_g; } $rx_d=$rx_g-$rx_s; $tx_d=$tx_g-$tx_s; $delta_d=$rx_d*4-$tx_d; $delta=max($delta_g, $delta_d); if(($delta&gt;0)&amp;&amp;(date('G')&gt;8)) { if($delta&gt;1000) //   1,     $size=round(rand(1000, min($delta/2, 5000))); //       ,     else $size=round(rand($delta*2, $delta*3)); //          echolog("\n".date('r')." \t:  : $delta_g Mb,  : $delta_d Mb,  $size Mb\n"); passthru("dd if=/dev/zero bs=1M count=$size | ssh $server 'cat &gt; /dev/null'"); } else echolog('.'); } else echolog("\n".date('r')." \t  !\n"); sleep(round(rand(10, 600))); } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/140697/">https://habr.com/ru/post/140697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140691/index.html">Applicants for new gTLDs are waiting for the last moment to apply</a></li>
<li><a href="../140692/index.html">We write a simple Windows application on Tcl / Tk using SQLite</a></li>
<li><a href="../140694/index.html">"Big Georgian Brother" will be dismantled on the bones on PHDays</a></li>
<li><a href="../140695/index.html">Thanks for the HTML5 File API or read the ID3 tag and fill out the form without loading an MP3 file.</a></li>
<li><a href="../140696/index.html">Where do ontologies begin</a></li>
<li><a href="../140698/index.html">DevConf 2012 - will be held on June 9 (Saturday) in Moscow - 33 applications for reports have already been submitted</a></li>
<li><a href="../140699/index.html">A note on move semantics with a return statement in C ++ 11</a></li>
<li><a href="../140700/index.html">Review of new features in playframework v2</a></li>
<li><a href="../140701/index.html">Authorization on the site through Mail.ru (oAuth 2.0)</a></li>
<li><a href="../140702/index.html">Ruby on Rails I18n: developer - develops, client - fills. The rest will be taken care of by the service.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>