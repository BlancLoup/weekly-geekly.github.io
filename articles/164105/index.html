<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electric Imp - Making a WiFi Thermometer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of you are familiar with the announcement of the Electric Imp, which was not so long ago on Habr√© , moreover , first impressions of its use are b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electric Imp - Making a WiFi Thermometer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/0c4/9bb/049/0c49bb0494f47039031e6eb6e619c130.jpg" align="left">  Many of you are familiar with the announcement of the Electric Imp, which was not so long ago <a href="http://habrahabr.ru/post/148119/">on Habr√©</a> , moreover <a href="http://habrahabr.ru/post/163751/">,</a> first impressions of its use are beginning <a href="http://habrahabr.ru/post/163751/">to appear</a> .  Since this device seemed to me promising and quite interesting, when I first went on sale the developer edition I ordered myself to play a bit and appreciate the possibilities. <br><a name="habracut"></a><br><br><h2>  We collect </h2><br>  Electric Imp itself at the time of purchase cost <a href="https://www.sparkfun.com/products/11395">$ 29.95</a> , but in order to start using it, you will have to purchase a fee, which was estimated at $ 19.95 (now the price has decreased to <a href="https://www.sparkfun.com/products/11400">$ 12.95</a> ). <br><img src="https://habrastorage.org/storage2/aae/304/a24/aae304a245d2372eef81f948a019ca93.jpg"><br><br>  After the kit arrived, instead of the usual <s>‚ÄúHello, world!‚Äù</s> LED blinking, I decided to do something more useful.  Having a little thought over and <a href="http://devwiki.electricimp.com/doku.php%3Fid%3Dworkedexamples">looking at the examples I</a> stopped at the temperature sensor.  I rummaged in the bins and found a 10Km thermistor and DS18B20.  With the DS18B20 it didn‚Äôt work out as the current API for Electric Imp <a href="http://forums.electricimp.com/discussion/323">lacks OneWire support</a> . <br>  The thermistor connection is very simple. <br><img src="https://habrastorage.org/storage2/607/4a6/171/6074a6171d2226d4e00dd656a070fae5.png"><br>  <i>Thermistor connection diagram ( <a href="http://playground.arduino.cc/ComponentLib/Thermistor">source</a> )</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to get rid of the wires, I connected the battery to 750mAh, while on the board itself you need to set the battery power supply with a jumper.  It turned out very compact device. <br><img src="https://habrastorage.org/storage2/a30/2a5/e72/a302a5e72358b85bff8015d89114c84c.jpg"><br><img src="https://habrastorage.org/storage2/59b/4a4/9be/59b4a49bec70fd8ac5f8c9f7361b57ec.jpg"><br><img src="https://habrastorage.org/storage2/2e7/305/447/2e7305447e8728e972653df3638aeb8d.jpg"><br><br>  For a visual display of the temperature, I took the Raspberry Pi and the 16x2 LCD indicator from some Chinese set that was lying around idle. <br><img src="https://habrastorage.org/storage2/7e7/ea6/6ea/7e7ea66ea84b4a9378fea0df84d81151.png"><br>  <i>Wiring diagram LCD 16x2 indicator to Raspberry Pi ( <a href="http://learn.adafruit.com/drive-a-16x2-lcd-directly-with-a-raspberry-pi/wiring">source</a> )</i> <br><br>  I had to suffer a bit because I came across some kind of intermediate revision of the raspberry and the code did not start on the fly.  It turned out that the Raspberry Pi board changed the purpose of several legs, one of them was just needed to connect the LCD. <br><br><h2>  We program </h2><br>  The code for working with a thermistor is quite simple, everything works fine and the result can be seen in the glider on the electricimp website.  Now you need to send the result to where I need, since the API has the ability to send HTTP requests, but there are some nuances.  First of all, I tried to send the result within my local network, and received nothing.  After debriefing, it turned out that the Imp request is not sent directly, but through its server.  There are two exits, or to forward the port on the router inside the local network, or send to your external server, and the local server periodically tighten the latest readings from there.  Port forwarding imposes certain restrictions on use, so I decided to raise a server with a simple API on App Engine, simultaneously making it draw graphics, which turned out to be very useful. <br><div class="spoiler">  <b class="spoiler_title">main.py</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import webapp2 import json import logging import utils import time import os import datetime from google.appengine.ext.webapp import template from google.appengine.ext import db class Sensor(db.Model): temperature = db.FloatProperty(required = True) battery = db.FloatProperty(required = True) added = db.DateTimeProperty(auto_now_add = True, indexed=True) class SensorRequestHandler(webapp2.RequestHandler): def post(self): data = json.loads(self.request.body) params = json.loads(data['value']) temp = params['temp'] battery = params['battery'] sensor = Sensor(temperature = temp, battery = battery) sensor.put() self.response.out.write('OK') def get(self): sensors_data = Sensor.all().order('added').fetch(None) temperature_data = [] battery_data = [] for item in sensors_data: temperature_data.append([int(time.mktime(item.added.timetuple()))*1000 ,round(item.temperature, 1)]) battery_data.append([int(time.mktime(item.added.timetuple()))*1000, round(item.battery, 2)]) path = os.path.join(os.path.dirname(__file__), 'templates/charts.html') self.response.out.write(template.render(path, { 'temperature_data' : utils.GqlEncoder().encode(temperature_data), 'battery_data' : utils.GqlEncoder().encode(battery_data) })) class LastRequestHandler(webapp2.RequestHandler): def get(self): ordered_list = db.GqlQuery('select * from Sensor order by added desc limit 1') last = ordered_list.get() self.response.headers['Content-Type'] = 'application/json' self.response.out.write(utils.GqlEncoder().encode(last)) class CleanRequestHandler(webapp2.RequestHandler): def get(self, bulk = 'old'): logging.debug("bulk: %s", bulk) try: while True: q = Sensor.all() if bulk != 'all': q.filter('added &lt;', datetime.date.today() - datetime.timedelta(days=60)) assert q.count() db.delete(q.fetch(200)) time.sleep(0.5) except Exception, e: self.response.out.write(repr(e)+'\n') pass app = webapp2.WSGIApplication([ ('/sensor', SensorRequestHandler), ('/sensor/last', LastRequestHandler), ('/sensor/clean/?(all)?', CleanRequestHandler) ], debug=True)</span></span></code> </pre> <br></div></div><br>  As a result, the result looks like this: <br>  - Imp sends a temperature reading to an external server every 10 minutes <br>  - Server saves this value <br>  - Raspberry Pi every few minutes tightens the temperature readings and displays it on the LCD display. <br>  In parallel with the temperature, I decided to collect battery voltage readings, but it turned out that the function from the API returns the voltage from the board itself (~ 3.25V). <br>  Unfortunately, the current ability to execute an HTTP request is severely limited, so we had to pervert and pack the data into JSON, which in turn is packaged a second time into JSON already inside the HTTPRequest node. <br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Termistor</span></span></span><span class="hljs-class"> </span></span>{ pin_num = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(pin){ pin_num = pin hardware[<span class="hljs-string"><span class="hljs-string">"pin"</span></span> + pin_num].configure(ANALOG_IN); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hardware[<span class="hljs-string"><span class="hljs-string">"pin"</span></span> + pin_num].read(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ local temp = math.log(((<span class="hljs-number"><span class="hljs-number">655350000</span></span>/read()) - <span class="hljs-number"><span class="hljs-number">10000</span></span>)); temp = <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-number"><span class="hljs-number">0.001129148</span></span> + (<span class="hljs-number"><span class="hljs-number">0.000234125</span></span> + (<span class="hljs-number"><span class="hljs-number">0.0000000876741</span></span> * temp * temp ))* temp ); temp = temp - <span class="hljs-number"><span class="hljs-number">273.15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temp; } } local sensor = Termistor(<span class="hljs-number"><span class="hljs-number">9</span></span>); local output = OutputPort(<span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-string"><span class="hljs-string">"string"</span></span>); imp.configure(<span class="hljs-string"><span class="hljs-string">"Termistor 10K"</span></span>, [], [output]); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">capture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ imp.wakeup(<span class="hljs-number"><span class="hljs-number">600.0</span></span>, capture); local temp = sensor.getTemperature(); local jsonOut = <span class="hljs-string"><span class="hljs-string">"{\"temp\":"</span></span>+temp+<span class="hljs-string"><span class="hljs-string">", \"battery\":"</span></span>+hardware.voltage()+<span class="hljs-string"><span class="hljs-string">"}"</span></span>; output.set(jsonOut); server.show(format(<span class="hljs-string"><span class="hljs-string">"%1.1f¬∫C"</span></span>, temp)); } capture(); imp.sleep(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) server.sleepfor(<span class="hljs-number"><span class="hljs-number">600.0</span></span>)</code> </pre><br><br><h2>  Reap the rewards </h2><br>  The graphs are stably constructed, look like this: <br><img src="https://habrastorage.org/storage2/bcf/896/bc9/bcf896bc9acec853862f9fd55c06ff89.png"><br><br>  Raspberry Pi derives temperature <br><img src="https://habrastorage.org/storage2/861/ad8/307/861ad830785fa4271f9ad0d402ad49fc.jpg"><br><br>  For a more visual demonstration, I made a small video (I recommend watching it in 720p and full screen): <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9VXV8oFREfw%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700258&amp;usg=ALkJrhgbEOppgP7gQfiOmAS0u4OrT2jmSA" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  Energy saving </h2><br>  Imp can run in three modes. <br><br><h3>  Disabled powersave mode (default) </h3><br>  In this mode, the WiFi module is always on.  This contributes to low mains power but leads to high current consumption of ~ 60-80mA for 3.3V <br><br><h3>  Enabled powersave mode </h3><br>  In this mode, the consumption drops to 5mA at times when there is no transmission over WiFi, but the delay before transmission increases accordingly and it can be more than 250ms. <br><br><h3>  Deep dream </h3><br>  In this mode, Imp is disconnected from the WiFi network, stops executing code, loses context (except for data in a special nv table) and switches to very low power consumption mode (~ 6 ŒºA).  Bring out of sleep can either a pre-cocked timer, or a wake-up pin.  Starting and connecting to a WiFi network takes about 2s. <br><br>  I have to admit that my experiences with powersave mode have failed.  What with the enabled mode, that with the Imp turned off, I lonely lived for three days.  In principle, you can come to the conclusion that for some reason this very powersave mode was always on for me because the average consumption was out <br><br>  750/24 * 3 ~ 10 mA, which corresponds to the powersave enabled mode. <br><br>  In deep sleep mode, the Imp temperature sensor has been working for a month already, and the voltage dropped from 4.2 to 3.68, that is, the LiPo battery for 750mAh should last for about a month and a half, which is good news. <br><br><h2>  Plans </h2><br>  Add an honest battery voltage meter (which is especially important for LiPo batteries), screw up the solar battery and, while there are no special plans, use it as a local temperature sensor in one of the enthusiastic weather projects.  It is also possible to add a Geiger counter. <br><br><h2>  Conclusion </h2><br>  The device came out very interesting and promising, but at the moment the application is tightly bound to its own Electric Imp servers and the paucity of the API.  If we assume that these defects will be corrected, then Imp is ideally suited for use in conjunction with various sensors in smart home systems. <br><br><h2>  useful links </h2><br>  1. <a href="https://github.com/azhurb/temperature-sensor">Source code on github</a> <br>  1. <a href="http://playground.arduino.cc/ComponentLib/Thermistor">Arduino + termistor</a> <br>  2. <a href="http://devwiki.electricimp.com/doku.php">Electric Imp Wiki</a> <br>  3. <a href="http://learn.adafruit.com/drive-a-16x2-lcd-directly-with-a-raspberry-pi/overview">Drive a 16x2 LCD with the Raspberry Pi</a> </div><p>Source: <a href="https://habr.com/ru/post/164105/">https://habr.com/ru/post/164105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164091/index.html">Practical use of the Racc - LALR generator (1) parser for Ruby</a></li>
<li><a href="../164093/index.html">Warm lamp phone</a></li>
<li><a href="../164095/index.html">Installing mercurial-server over ssh from source</a></li>
<li><a href="../164101/index.html">Java weather for beginners and older</a></li>
<li><a href="../164103/index.html">Google plans to attract 90% of MS Office users to Google Apps</a></li>
<li><a href="../164107/index.html">3D live wallpaper and OpenGL ES</a></li>
<li><a href="../164109/index.html">US authorities retain the right to read "abandoned" e-mail without a court order</a></li>
<li><a href="../164111/index.html">Commentary of the day: Christmas leapfrog</a></li>
<li><a href="../164113/index.html">Aruba Networks - Part 2: Building a secure wireless infrastructure</a></li>
<li><a href="../164115/index.html">Nodal accounting in the treatise "Kotso-Pets" (Chincha Indians, 4th century AD)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>