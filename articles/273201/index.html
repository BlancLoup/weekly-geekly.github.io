<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing the VNC server, and setting it up over SSH</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yes, for some reason, not all clients want to work in such a convenient and black terminal, the panel does not fully satisfy their aesthetic needs, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing the VNC server, and setting it up over SSH</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a13/7bf/79c/a137bf79cd924f7d9f5a47eab7faf671.png"><br>  Yes, for some reason, not all clients want to work in such a convenient and black terminal, the panel does not fully satisfy their aesthetic needs, and in general - ‚Äúwhere is my favorite and convenient VNC?‚Äù. <br>  <s>matter of habit and taste</s> <br><br>  This article will look at an example of installing and configuring a <a href="https://ru.wikipedia.org/wiki/Virtual_Network_Computing">VNC server</a> and a graphical shell ( <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D1%2584%25D0%25B5%25D0%25B9%25D1%2581_%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258F">GUI</a> ) using the example of Debian 8 jessie OC. <br><br><a name="habracut"></a><br>  <b>Introductory:</b> on hand there is a clean Debian 8 and a burning desire to get protected vnc access to the server at the output. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Let's get started </h4><br>  Update the list of available packages. <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get update</span></span></code> </pre> <br>  If the system is freshly installed, it is worth upgrading. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get -y upgrade</span></span></code> </pre><br>  <i>(!) It is not worthwhile to run this command mindlessly on a freshly installed server, it is fraught with broken dependencies and the prospect of working with a file.</i> <br><br>  Install <a href="https://wiki.archlinux.org/index.php/Xfce_(%25D0%25A0%25D1%2583%25D1%2581%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9)">Xfce</a> and <a href="https://ru.wikipedia.org/wiki/Virtual_Network_Computing">VNC server</a> (fans of <a href="https://ru.wikipedia.org/wiki/GNOME">GNOME</a> , <a href="https://ru.wikipedia.org/wiki/KDE">KDE</a> , <a href="https://ru.wikipedia.org/wiki/LXDE">LXDE</a> , etc. set the shell to your liking). <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install xfce4 xfce4-goodies tightvncserver</span></span></code> </pre><br>  We create the user from which we will start vnc the server. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># adduser vnc</span></span></code> </pre><br>  Install sudo (in Debian, this package is not installed by default). <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install sudo</span></span></code> </pre><br>  Add the user vnc to the sudo group. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># gpasswd -a vnc sudo</span></span></code> </pre><br>  We pass under the user of vnc. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># su - vnc</span></span></code> </pre><br>  We start vnc the server. <br><pre> <code class="bash hljs">$ vncserver</code> </pre><br>  If this is the first launch of the vnc server, a config file will be created and some parameters will be requested: <br><pre> <code class="bash hljs">$ vncserver You will require a password to access your desktops. Password: Verify: Would you like to enter a view-only password (y/n)? n xauth: file /home/vnc/.Xauthority does not exist New <span class="hljs-string"><span class="hljs-string">'X'</span></span> desktop is my.server:1 Creating default startup script /home/vnc/.vnc/xstartup Starting applications specified <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /home/vnc/.vnc/xstartup Log file is /home/vnc/.vnc/my.server:1.log</code> </pre><br>  <i>By default, the server vnc port will be 5901, the port of each subsequent display will increase by 1 (5902,5903, ...).</i> <br><br>  Check whether the VNC server is running and on which port you can listen to with the following command. <br><pre> <code class="bash hljs">$ netstat -nltp Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:5901 0.0.0.0:* LISTEN 1054/Xtightvnc</code> </pre><br>  You can kill a specific display like this: <br><pre> <code class="bash hljs">$ vncserver -<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> :1 Killing Xtightvnc process ID 3246</code> </pre><br>  <i>: 1 - which display should be killed.</i> <br><br><h4>  Creating a script autostart vnc server. </h4><br><br>  First, kill the running display: 1 (if it is running). <br><pre> <code class="bash hljs">$ vncserver -<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> :1</code> </pre><br>  create startup script <br><pre> <code class="bash hljs">$ sudo nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc</code> </pre><br>  Add the following lines to the file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH="$PATH:/usr/bin/" DISPLAY="1" DEPTH="16" GEOMETRY="1024x768" OPTIONS="-depth ${DEPTH} -geometry ${GEOMETRY} :${DISPLAY}" case "$1" in start) /usr/bin/vncserver ${OPTIONS} ;; stop) /usr/bin/vncserver -kill :${DISPLAY} ;; restart) $0 stop $0 start ;; esac exit 0</span></span></code> </pre><br>  <i>if required - in the script, you can change the color depth or screen resolution.</i> <br><br>  Making the file executable. <br><pre> <code class="bash hljs">$ sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc</code> </pre><br><h3>  use of the script created by us: </h3><br><br><pre> <code class="bash hljs">$ myvnc start <span class="hljs-comment"><span class="hljs-comment">### vnc  $ myvnc stop ### vnc  $ myvnc restart ### vnc </span></span></code> </pre><br><br>  Now you need to take care that the vnc we configured is started after the server is loaded (planned and not so). <br>  To do this, create a file in the following path. <br><pre> <code class="bash hljs">$ sudo nano /lib/systemd/system/myvnc.service</code> </pre><br><br>  Add the following text to the file: <br><pre> <code class="bash hljs">[Unit] Description=MyVnc [Service] Type=forking ExecStart=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc start ExecStop=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc stop ExecReload=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc restart User=vnc [Install] WantedBy=multi-user.target</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Explanation</b> <div class="spoiler_text">  [Unit] - we specify the description of the script (you can also specify the required dependencies and the order of launch at boot). <br>  [Service] - specify which commands to start the service, by what user, and the type of service. <br>  [Install] - we indicate at what level the script should run (runlevel 3 - multi-user mode without graphics). <br><br></div></div><br><br>  We include a unit in autoload at system startup. <br><pre> <code class="bash hljs">$ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> myvnc.service Created symlink from /etc/systemd/system/multi-user.target.wants/myvnc.service to /lib/systemd/system/myvnc.service.</code> </pre><br><br>  We look at the status of the unit created by us. <br><pre> <code class="bash hljs">$ sudo systemctl -l status myvnc.service ? myvnc.service - MyVnc Loaded: loaded (/lib/systemd/system/myvnc.service; enabled) Active: inactive (dead)</code> </pre><br><br>  We pull systemd to search for new or modified units. <br><pre> <code class="bash hljs">$ sudo systemctl daemon-reload</code> </pre><br><br><h3>  Traffic encryption </h3><br>  Naked VNC does not encrypt traffic, and leave it in this form is not worth it. <br>  In addition, if bots from China come to your IP and start knocking on ports, even if the password is set really high (note that the password for the vnc session is limited to 8 characters) and it will not be cracked, it will be difficult to get to the server via VNC for a constant error on the number of incorrect authorization attempts. <br><br><div class="spoiler">  <b class="spoiler_title">vncpasswd</b> <div class="spoiler_text">  $ vncpasswd <br><br>  Using password file /home/vnc/.vnc/passwd <br><br>  Password: <br><br>  Warning: password truncated to the length of 8. <br><br>  Verify: <br><br>  Would you like to enter a view-only password (y / n)?  n <br></div></div><br><br><img src="https://habrastorage.org/files/a74/0c7/1ee/a740c71ee4ce460abf06c3235d94aba5.png"><br><br><h4>  We let VNC over SSH: </h4><br><pre> <code class="bash hljs">$ sudo nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/myvnc</code> </pre><br>  Change the string: <br><pre> <code class="bash hljs">OPTIONS=<span class="hljs-string"><span class="hljs-string">"-depth </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEPTH}</span></span></span><span class="hljs-string"> -geometry </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${GEOMETRY}</span></span></span><span class="hljs-string"> :</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DISPLAY}</span></span></span><span class="hljs-string">"</span></span>  OPTIONS=<span class="hljs-string"><span class="hljs-string">"-depth </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEPTH}</span></span></span><span class="hljs-string"> -geometry </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${GEOMETRY}</span></span></span><span class="hljs-string"> :</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DISPLAY}</span></span></span><span class="hljs-string"> -localhost"</span></span></code> </pre><br><br>  Now to connect to the server, you first need to create a tunnel. <br><br><h5>  Under * nix: </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ssh vnc@xxx.xxx.xxx.xxx -L 5901:localhost:5901</span></span></code> </pre><br>  Now it is possible to connect using a vnc client, instead of specifying the remote server‚Äôs IP as <b>localhost</b> and the port on which the vnc-server is listening. <br><br>  # vncviewer <b>localhost: 5901</b> <br><br><h4>  When using Windows and putty agent: </h4><br><br>  After running putty, go to <b>Connection</b> -&gt; <b>SSH</b> -&gt; <b>Tunnels</b> . <br>  In the <b>Source Port</b> field we drive in the port on which the VNC server is listening - 5901, in the <b>Destination</b> field we enter - <b>localhost: 5901</b> and click the <b>Add</b> button. <br>  <i>It should turn out as in the picture.</i> <br><br><img src="https://habrastorage.org/files/826/14f/ea4/82614fea4ec248f7aab78af8544b32b4.png"><br><br>  Now we return to the <b>Session</b> tab, enter the server's IP and port 22 (you can also save the connection configuration right there), click <b>Open</b> . <br><img src="https://habrastorage.org/files/6e4/f07/a01/6e4f07a014c54be6a2d960d76797255d.png"><br><br><img src="https://habrastorage.org/files/655/e15/720/655e15720ab841cdbacc014cace30942.png"><br><br>  <s>paranoia is never enough</s> . Caution needs to be taught right away, although now it is impossible to get to our server via VNC from the outside (first you need to log in via ssh and create a tunnel), you still need to think about additional security of ssh connections . <br><br>  Install and configure <a href="http://www.fail2ban.org/wiki/index.php/Main_Page">fail2ban</a> . <br>  By default, brute-force protection for SSH is enabled, which is what we actually need. <br>  <i>when a specified number of unsuccessful password entries are exceeded in a row (by default - 6), an IP ban from which attempts were made for a given time (by default - 600 seconds).</i> <br><br>  Install the package from the repository. <br><pre> <code class="bash hljs">$ sudo apt-get install fail2ban</code> </pre><br>  The main configuration file we are interested in is located along the path /etc/fail2ban/jail.conf <br><br>  Settings block for ssh connection: <br><pre> <code class="bash hljs">[ssh] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> port = ssh filter = sshd logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/auth.log maxretry = 6</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Syntax</b> <div class="spoiler_text">  <b>ignoreip</b> - IP addresses that should not be blocked.  You can specify a list of IP addresses separated by spaces, a subnet mask, or the name of a DNS server. <br><br>  <b>bantime</b> - ban time in seconds, after which the IP address is removed from the blocked list. <br><br>  <b>maxretry</b> - the number of suspicious matches after which the rule applies.  In the context of ssh, this is the number of failed login attempts after which blocking occurs. <br><br>  <b>enabled</b> - the value true indicates that the given jail is active, false turns off the action of the isolator. <br><br>  <b>port</b> - indicates which port or ports the target service is running on.  The standard port of the SSH server is 22, or its literal name is ssh. <br><br>  <b>filter</b> is the name of the filter with regular expressions that are searched for ‚Äúsuspicious matches‚Äù in service logs.  The sshd filter matches the /etc/fail2ban/filter.d/sshd.conf file. <br><br>  <b>logpath</b> is the path to the log file that Fail2ban will process using the previously specified filter.  The entire history of successful and unsuccessful logins, including SSH, is by default written to the log file /var/log/auth.log. <br><br></div></div><br><br>  The default setting satisfies our requirements (6 incorrect authorization attempts by shh and IP flies to the bank for 600 seconds), but I would advise you to add your IP to the trusted list. <br>  <i>It will be a shame to wait almost two hours, in case of a six-fold error in entering a password from your IP (the chance of this case is not zero).</i> <br><br>  Open the config file. <br><pre> <code class="bash hljs">$ sudo nano /etc/fail2ban/jail.conf</code> </pre><br><br>  In the line ignoreip = 127.0.0.1/8, 127.0.0.1/8 address is replaced with our IP. <br><br><pre> <code class="bash hljs">ignoreip = Your.IP</code> </pre><br><br>  Exit the nano editor ( <b>ctrl + x</b> , answer <b>y</b> to the question of saving the changes made). <br><br>  We overload the service to apply changes to the rules. <br><pre> <code class="bash hljs">$ sudo service fail2ban restart</code> </pre><br><br>  If a ban is triggered in fail2ban logs, you may notice a warning line: <br><pre> <code class="bash hljs">$ sudo tail -100 /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/fail2ban.log | less 2015-12-17 09:08:54,894 fail2ban.actions[7496]: WARNING [ssh] Ban</code> </pre><br><br>  And attempts to connect from this address will be repulsed by the server automatically before the expiration of the ban. <br><pre> <code class="bash hljs">bash-3.2<span class="hljs-comment"><span class="hljs-comment"># ssh my.vnc -l vnc ssh: connect to host 37.48.90.203 port 22: Connection refused</span></span></code> </pre><br><br>  Done, the VNC server setup is complete. </div><p>Source: <a href="https://habr.com/ru/post/273201/">https://habr.com/ru/post/273201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273189/index.html">XML, XQuery and Triple Grief with Performance</a></li>
<li><a href="../273191/index.html">Test the theory of six handshakes</a></li>
<li><a href="../273193/index.html">Introducing Kerio Control 9</a></li>
<li><a href="../273197/index.html">Give the youth</a></li>
<li><a href="../273199/index.html">Apply machine learning to improve PostgreSQL performance.</a></li>
<li><a href="../273205/index.html">3 business projects that improve the data center industry</a></li>
<li><a href="../273209/index.html">Update Windows 10 SDK - build 10586</a></li>
<li><a href="../273213/index.html">Critical 0-day vulnerability detected in CMS Joomla</a></li>
<li><a href="../273217/index.html">HTML5 Mastery: Fragments</a></li>
<li><a href="../273219/index.html">How we made ABBYY FineReader, or a story that happened 20 years ago</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>