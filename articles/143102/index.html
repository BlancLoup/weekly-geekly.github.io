<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We recognize the image from the token using the camera</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In an organization where I work in my spare time, there are very high safety requirements. Wherever possible, tokens are used to authenticate users. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We recognize the image from the token using the camera</h1><div class="post__text post__text-html js-mediator-article">  In an organization where I work in my spare time, there are very high safety requirements.  Wherever possible, <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D0%25BA%25D0%25B5%25D0%25BD_(%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8)">tokens</a> are used to authenticate users.  I was given just such a thing: <br><img src="https://habrastorage.org/storage2/0c0/503/267/0c05032679888cdf5ccbe1fa00a58260.jpg"><br>  and said: press the button, look at the numbers, enter the password and rejoice.  ‚ÄúSecurity, of course, is paramount, but we shouldn‚Äôt forget about comfort,‚Äù I thought about that and conducted an audit of my electronic junk. <br><a name="habracut"></a><br>  (Honestly, I have long wanted to distract from programming and dig deeper into hardware, so my laziness is not the only motivator in this whole venture). <br><br><h3>  Analysis of technical specifications and selection of components </h3><br><br>  The first thing I came across was an old Logitech QuickCam 3000 webcam, which went to the ‚Äútrash‚Äù in connection with the purchase of a laptop with an integrated webcam.  The plan matured instantly: we remove the token from the camera with a camera, we recognize them on a computer and ... Profit!  Then a servo was found (well, don‚Äôt press the button on the token each time with your hands, right?), An old USB hub (there are only two USB ports in my laptop, and one of them is constantly occupied by a USB-Ethernet adapter), and the Arduino board, it is not known how I found myself.  As a case for my device, I decided to use the Lego designer, which I bought for use by my one-year-old son (it seems, now I understand why my wife grinned sarcastically with the purchase). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, I don‚Äôt have safe and sound photos of donor devices, so I can only ‚Äúbrag‚Äù about the device as an assembly: <br><br><img src="https://habrastorage.org/storage2/aa6/45a/e32/aa645ae32944c1ccc4c4c49de01b859f.jpg"><br><br><h3>  Schematic diagram and firmware microcontroller </h3><br><br>  Actually, everything is ridiculously simple (I will not even draw a scheme): a USB hub to which a webcam and an arduin are connected.  A servo drive is connected to the arduine (via PWM).  That's all. The source code of the program that is poured into the Arduin is trivial: <a href="">github.com/dreadatour/lazy/blob/master/servo.ino</a> <br>  Arduin is waiting for the letter 'G' on the com port, and when it arrives, it pulls the servu back and forth.  The delay (500ms) and the angle of the servo were selected experimentally. <br><br><h3>  Selection of programming language and analysis of existing libraries of "computer vision" </h3><br><br>  <i>The only programming language</i> to which I would entrust such a difficult task as ‚Äúcomputer vision‚Äù is the blessed Python.  <i>The benefit</i> in it, almost out of the box, is the bindings to such a <i>glorious</i> library as <a href="http://opencv.willowgarage.com/">OpenCV</a> .  Actually, this will stop. <br><br><h3>  Token code recognition algorithm </h3><br><br>  I will provide links to pieces of code that are responsible for the described functionality - in my opinion this is the optimal format for submitting information.  All the code can be viewed <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">on the githaba</a> . <br><br>  First <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">we take the image from the camera</a> : <br><img src="https://habrastorage.org/storage2/fd1/96b/fcc/fd196bfcc3ebd74b1fd70a998a820442.png"><br><br>  We make the task easier: the camera is fixed relative to the base, the token can move in its tray quite slightly, so we find the boundaries of the possible positions of the token, <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">crop the frame</a> from the camera and (only for our convenience) <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">rotate the image</a> by 90Àö: <br><img src="https://habrastorage.org/storage2/551/c98/398/551c9839809cead4552bd43385f83730.png"><br><br>  Then <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">we do some transformations</a> : convert the resulting image to grayscale and find the borders using <a href="http://en.wikipedia.org/wiki/Canny_edge_detector">the Canny border detector</a> - these will be the borders of the LCD screen of the token: <br><img src="https://habrastorage.org/storage2/ec6/a86/0f8/ec6a860f842f8dab763c7aa5d098a425.png"><br><br>  <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">We find the contours</a> on the resulting image.  A contour is an array of lines ‚Äî we drop lines smaller than a certain length: <br><img src="https://habrastorage.org/storage2/8ea/655/b16/8ea655b1640151e29377262bb4995627.png"><br><br>  Using a blunt algorithm, we <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">define four lines</a> that limit our LCD display: <br><img src="https://habrastorage.org/storage2/bcf/45d/dbc/bcf45ddbcca38733e27addba60fc3707.png"><br><br>  Find the <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">points of persection of</a> these lines and perform several checks: <br><ul><li>  <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">check</a> that the length of the vertical and horizontal lines approximately coincides with each other and that the length of the lines approximately coincides with the size of the LCD display (which we calculated experimentally) </li><li>  <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">check</a> that the diagonals are approximately equal (we need a rectangle - LCD display) </li></ul><br>  <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">Next,</a> we find the angle to which our token is turned, rotate the image to this angle, and cut out the LCD image: <br><img src="https://habrastorage.org/storage2/ee7/338/1ad/ee73381ad99f82fb5de5f14d4c7911e7.png"><br><br>  The hardest thing behind.  Now we need to increase the contrast of the resulting image.  To do this, we <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">memorize the</a> image of the empty LCD screen (before pressing the token button), and simply ‚Äú <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">subtract</a> ‚Äù this image from the picture with numbers (after <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">pressing</a> the button): <br><img src="https://habrastorage.org/storage2/65d/cbf/1a1/65dcbf1a1735763c6a5671a6a84e35d7.png"><br><br>  We get a black and white image.  To do this, with the help of another <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">blunt algorithm,</a> we find the optimal threshold that will divide all the pixels in the image into ‚Äúblack‚Äù and ‚Äúwhite‚Äù, convert the image into B / W and <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">cut out the</a> characters: <br><img src="https://habrastorage.org/storage2/9d0/984/f3e/9d0984f3e3f55fbc525ed18f5ec87ff5.png"><br><br>  Well, then just recognize the numbers.  It makes no sense to suffer with neural networks and other things, because  we have a seven-segment indicator: there are seven ‚Äúpoints‚Äù by which each digit is uniquely <a href="https://github.com/dreadatour/lazy/blob/master/lazy.py">determined</a> : <br><img src="https://habrastorage.org/storage2/210/e90/15c/210e9015c9e44d497df4a18ec8ba4224.png"><br><br>  Just in case, we recognize the numbers from several frames: if three frames in a row we got the same result - we believe that the recognition was successful, we output the result using the program ‚Äúgrowlnotify‚Äù to the user and copy the resulting code to the clipboard. <br><br><h3>  Video of the device </h3><br>  Caution sound! <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Gv8sViHpX5o%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhZvobGMUrRmeCCD0WaftX2EE1zFw" frameborder="0" allowfullscreen=""></iframe><br><br>  <a href="https://github.com/dreadatour/lazy">Whole source code</a> </div><p>Source: <a href="https://habr.com/ru/post/143102/">https://habr.com/ru/post/143102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143094/index.html">The technology of building 3D-models of objects on a set of images</a></li>
<li><a href="../143095/index.html">"Children's" gamedev or "How I played an indie developer"</a></li>
<li><a href="../143096/index.html">How to make using Remember The Milk in Chrome / Firefox more convenient?</a></li>
<li><a href="../143099/index.html">New technology for fully eco-friendly electricity generation</a></li>
<li><a href="../143100/index.html">Add support for Windows Live Writer (Meta Weblog API) to a blog on Django</a></li>
<li><a href="../143103/index.html">Add sugar to XSLT</a></li>
<li><a href="../143105/index.html">In Chrome Canary earned new units of measurement CSS - vh, vw and vmin</a></li>
<li><a href="../143106/index.html">On KickStarter, online community members expose fraudsters</a></li>
<li><a href="../143108/index.html">Video review gaming laptop MSI GT60</a></li>
<li><a href="../143111/index.html">Nothing else belongs to you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>