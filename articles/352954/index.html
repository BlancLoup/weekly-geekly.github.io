<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spring Boot. Background tasks and not only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In this tutorial, I want to give an example of an application for sending emails to users based on the date of their birth (for example...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spring Boot. Background tasks and not only</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  In this tutorial, I want to give an example of an application for sending emails to users based on the date of their birth (for example, with congratulations), using the Scheduled annotation.  I decided to give this example, in my opinion, it includes quite a few things, such as working with a database (in our case it is PostgreSQL), Spring Data JPA, new java 8 time api, email service, creating background tasks and small business logic while remaining compact.  Today, the Internet is replete with a huge variety of tutorials that usually come down to how to inherit from CrudRepository, JpaRepository, and so on.  Tutorial is designed for the fact that you have already watched at least some of them and have an idea of ‚Äã‚Äãwhat Spring Boot is.  I will try to show an example of an application that shows its capabilities more extensively and how to work with it. <br><br><h3>  Project creation </h3><br>  Go to the <a href="http://start.spring.io/">Spring Initializr</a> . <br><br>  Add dependencies: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. PosgreSQL - as a database <br>  2. JPA - access to the database <br>  3. Lombok - for convenience and getting rid of the boilerplate code (you do not have to write getters, setters, etc. by yourself), read more <a href="https://projectlombok.org/">here</a> <br>  4. Mail - actually for work and sending emails, <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/integration.html">of.</a>  <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/integration.html">documentation</a> <br><br>  Specify the group and the artifact, for example, com.application and task.  Download and unpack the project, then open it in the development environment, I have this Intellij IDEA. <br><br><h3>  Database </h3><br>  Now set yourself <a href="https://www.postgresql.org/download/">PostgreSQL</a> .  Next, create a database with user and password.  You can do this directly from IDEA, in the database tab, you can use the command line if you have Linux, with the following commands: <br><br><pre><code class="hljs pgsql">sudo -u postgres createuser &lt;username&gt; sudo -u postgres <span class="hljs-keyword"><span class="hljs-keyword">createdb</span></span> &lt;dbname&gt; $ sudo -u postgres psql psql=# <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &lt;username&gt; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encrypted</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span>; psql=# <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">privileges</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> &lt;dbname&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> &lt;username&gt; ;</code> </pre> <br>  Also on windows this can be done using <a href="https://www.pgadmin.org/">pgAdmin</a> or its alternatives. <br><a name="habracut"></a><br><h3>  Start </h3><br>  We open our project and we can start writing the code. <br><br>  Now we have only one java-file in the project.  It looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskApplication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(TaskApplication.class, args); } }</code> </pre> <br>  The class name may be different depending on the artifact name you gave when creating the project. <br><br>  This class is the launch point of the application.  The <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-using-springbootapplication-annotation.html">@SpringBootApplication annotation</a> means that this is a Spring Boot application and is equivalent to using @Configuration, @EnableAutoConfiguration and @ComponentScan. <br><br><h3>  Creating a model </h3><br>  First we divide the directory in which our class lies to run the entire application and divide it into three directories: model, repository, service. <br><br>  Next in the model folder we create the User class: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@ToString</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocalDate birthday; }</code> </pre> <br>  So, we have created a class with the minimum number of fields that we need: user id, his name, email and date of birth. <br><br>  Lets go over the annotations: The first 4 above the class are the lombok annotations that generate getters, setters, the toString method, and the constructor with no arguments. <br><br>  <a href="https://habrahabr.ru/users/entity/" class="user_link">Entity</a> indicates to Hibernate that this class is an entity. <br>  <a href="https://habrahabr.ru/users/table/" class="user_link">Table</a> - the name corresponds to the table in the database. <br>  <a href="https://habrahabr.ru/users/id/" class="user_link">Id</a> - points to the primary key of this class. <br>  @GeneratedValue - used with <a href="https://habrahabr.ru/users/id/" class="user_link">Id</a> and defines the strategy and generator pameters. <br>  @Column - indicates the name of the column that is displayed in the property of the entity, also using nullable = false, we indicate that the field is required. <br>  <a href="https://habrahabr.ru/users/email/" class="user_link">Email</a> - the string must be a valid email address (javax.validation.constraints package is used instead of org.hibernate.validator.constraints, that annotation is outdated in the latter). <br><br><h3>  Repository </h3><br>  Next in the repository folder we create the UserRepository interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{}</code> </pre> <br>  Inheritance from JpaRepository gives us the opportunity to use its methods for working with databases such as delete, save, findAll and many others.  In addition, if you wish, we can create our own methods, according to the principle ‚Äúwe write what we need.‚Äù  T e if we need to find all users with the same name, then our method will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span></span>;</code> </pre> <br>  This method will eventually create a SQL query like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = ?;</code> </pre> <br>  Or for example: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByBirthdayAfter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalDate date)</span></span></span></span>;</code> </pre> <br>  Allows you to select all users born after a certain date. <br><br>  In general, this is quite an extensive topic, on which quite a lot of articles and videos.  Like <a href="https://www.youtube.com/watch%3Fv%3DnwM7A4TwU3M">this one</a> . <br>  It is also possible to write your sql queries using the JPA annotation <a href="https://habrahabr.ru/users/query/" class="user_link">Query</a> directly above the method body. <br>  There is an opportunity to use two types of syntax: <a href="https://docs.oracle.com/html/E13946_01/ejb3_langref.html">JPQL</a> (JPA query language, similar to SQL using instead of tables and columns ‚Äî entities, attributes, etc.) or SQL itself used by us (then the nativeQuery = true property is added).  Example with JPQL: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(value = <span class="hljs-string"><span class="hljs-string">"SELECT u from User u where u.name = ?1"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span></span>;</code> </pre><br>  To specify the name of the request parameter, you can use the JPA <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/">@Param</a> annotation: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(value = <span class="hljs-string"><span class="hljs-string">"SELECT u from User u where u.name = :name"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name)</span></span>;</code> </pre><br>  If we want to use pure SQL, then: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(value = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM users WHERE name = :name"</span></span>, nativeQuery = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name)</span></span>;</code> </pre><br>  We will create a method that will take from the database of all users whose email is not null, and in which the month and birthday will correspond to those that we will send there.  Now our repository will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Repository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(value = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM users "</span></span> + <span class="hljs-string"><span class="hljs-string">"WHERE email IS NOT NULL "</span></span> + <span class="hljs-string"><span class="hljs-string">"AND extract(MONTH FROM birthday) = :m "</span></span> + <span class="hljs-string"><span class="hljs-string">"AND extract(DAY FROM birthday) = :d"</span></span>, nativeQuery = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByMatchMonthAndMatchDay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"m"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> month, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Param</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> day)</span></span>; }</code> </pre><br>  <b>A couple of repository features</b> <br><br>  The first parameter of the generic should be the entity with which we will work, and the second corresponds to the type of its primary key. <br>  Also, the types of methods must correspond to the first parameter (if you do not use your own mapping). <br>  If suddenly you have a question, why this directory is called repository, and not dao, then this is a good tone rule in Spring Boot, you are not obliged to do the same, just so accepted. <br><br><h3>  Services </h3><br>  First, create the UserRepositoryService interface in the service directory: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepositoryService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> month, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> day)</span></span></span></span>; }</code> </pre> <br>  Further, here we create another impl directory and in it an implementation class for our service: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepositoryServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepositoryService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserRepository repository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserRepositoryServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository repository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = repository; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> month, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> day)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.findByMatchMonthAndMatchDay(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> month, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> day); } }</code> </pre> <br>  Now let's look at our class: <br>  Annotation <a href="https://habrahabr.ru/users/service/" class="user_link">Service</a> shows the spring that this is a service. <br>  Next, we declare a variable of type UserRepository and initialize it in the constructor, having previously marked its annotations @Autowired. <br>  (You can put annotations directly above the repository field, but it is preferable to create a constructor or setter) <br>  @Autowired - the spring finds the desired bin and substitutes its value in the property marked with annotation. <br>  It is possible to create an autowired constructor using the annotation of a chunk above the class: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span>(onConstructor = @__(<span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>))</code> </pre> <br>  After the constructor, we implement the method of our interface and in it return the method from the repository. <br>  Go ahead: create the EmailService in the service directory: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String to, String title, String body)</span></span></span></span>; }</code> </pre> <br>  And its implementation of EmailServiceImpl in impl: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span>(onConstructor = @__(<span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JavaMailSender emailSender; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String to, String subject, String text)</span></span></span><span class="hljs-function"> </span></span>{ MimeMessage message = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.emailSender.createMimeMessage(); MimeMessageHelper helper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MimeMessageHelper(message); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { helper.setTo(to); helper.setSubject(subject); helper.setText(text); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.emailSender.send(message); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MessagingException messageException) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(messageException); } } }</code> </pre> <br>  I will not delve into the description, here <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/integration.html">OD</a> . <br><br>  Now in service we will create our last and main class with a scheduler and business logic, let's call it for example SchedulerService. <br><br>  Immediately define the following fields in it: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span>(onConstructor = @__(<span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SchedulerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserRepositoryService userService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EmailService emailService; }</code> </pre> <br>  So, we initialized the logger (also the @ Slf4j breakup annotations), user and email services in the constructor (@RequiredArgsConstructor (onConstructor = @__ (@ Autowired))). <br><br>  Next, create a void method sendMailToUsers and above it we specify an annotation: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(cron = <span class="hljs-string"><span class="hljs-string">"*/10 * * * * *"</span></span>)</code> </pre> <br>  This annotation allows you to specify when our method will work.  We use the cron parameter, which allows you to specify a schedule for specific hours and dates.  There are also parameters such as fixedRate (determines the interval between method calls), fixedDelay (determines the interval since the last method call ended and the next one started), initialDelay (the number of milliseconds to delay before the first execution of fixedRate or fixedDelay) and <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/Scheduled.html">a couple more</a> . <br><br>  Each asterisk in the cron line means seconds, minutes, hours, days, months, and days of the week.  Here are <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/support/CronSequenceGenerator.html">more details</a> .  Now the value means that the test will take place every 10 seconds, this is done for example, in the future we will change it. <br><br>  For convenience, the cron value can be put into a constant: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CRON = <span class="hljs-string"><span class="hljs-string">"*/10 * * * * *"</span></span>;</code> </pre> <br>  In the method, we will create a variable with the current date (java date and time api), variables for the month and day, which are taken from the date, a user list, which is initialized by a method from our service and checking if it is empty: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(cron = CRON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMailToUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LocalDate date = LocalDate.now(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> month = date.getMonthValue(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> day = date.getDayOfMonth(); List&lt;User&gt; list = userService.getUsersByBirthday(month, day); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!list.isEmpty()) { } }</code> </pre><br>  Now let's go through it and for each user, create a variable for the message and call the send method from EmailService, and pass the user's email, header and our message to it.  At the end we wrap everything in try / catch to avoid exceptions.  Everything, our method is ready. <br><br>  We look at the whole class: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span>(onConstructor = @__(<span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SchedulerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CRON = <span class="hljs-string"><span class="hljs-string">"*/10 * * * * *"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserRepositoryService userService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EmailService emailService; <span class="hljs-meta"><span class="hljs-meta">@Scheduled</span></span>(cron = CRON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMailToUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LocalDate date = LocalDate.now(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> month = date.getMonthValue(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> day = date.getDayOfMonth(); List&lt;User&gt; list = userService.getUsersByBirthday(month, day); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!list.isEmpty()) { list.forEach(user -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String message = <span class="hljs-string"><span class="hljs-string">"Happy Birthday dear "</span></span> + user.getName() + <span class="hljs-string"><span class="hljs-string">"!"</span></span>; emailService.send(user.getEmail(), <span class="hljs-string"><span class="hljs-string">"Happy Birthday!"</span></span>, message); log.info(<span class="hljs-string"><span class="hljs-string">"Email have been sent. User id: {}, Date: {}"</span></span>, user.getId(), date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { log.error(<span class="hljs-string"><span class="hljs-string">"Email can't be sent.User's id: {}, Error: {}"</span></span>, user.getId(), e.getMessage()); log.error(<span class="hljs-string"><span class="hljs-string">"Email can't be sent"</span></span>, e); } }); } } }</code> </pre><br>  Now, to be able to run the background tasks, add the @EnableScheduling annotation to our TaskApplication directly above the @SpringBootApplication so that it looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EnableScheduling</span></span> <span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskApplication</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(TaskApplication.class, args); } }</code> </pre> <br>  This completes the work with the java code, we only need to specify configs in the application.properties file in the resources directory. <br><br><h3>  Configuration </h3><br><pre> <code class="hljs pgsql">#   .   ,      <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.port=<span class="hljs-number"><span class="hljs-number">7373</span></span> #   spring.jpa.<span class="hljs-keyword"><span class="hljs-keyword">database</span></span>=POSTGRESQL spring.jpa.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> spring.datasource.platform=postgres spring.jpa.generate-ddl=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> spring.jpa.hibernate.ddl-auto=<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> spring.datasource.driver-<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>=org.postgresql.Driver spring.datasource.url=jdbc:postgresql://localhost:<span class="hljs-number"><span class="hljs-number">5432</span></span>/your_database?stringtype=unspecified spring.datasource.username=your_database_username spring.datasource.<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=your_database_password #  logging.<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>.org.hibernate=<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> logging.<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>.org.springframework.<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> #      jpa  postgreSQL spring.jpa.properties.hibernate.<span class="hljs-keyword"><span class="hljs-keyword">temp</span></span>.use_jdbc_metadata_defaults = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect # email-a spring.mail.host=smtp.gmail.com spring.mail.port=<span class="hljs-number"><span class="hljs-number">587</span></span> spring.mail.username=your_email@gmail.com spring.mail.<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=your_password spring.mail.properties.mail.smtp.auth=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> spring.mail.properties.mail.smtp.starttls.<span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> spring.mail.properties.mail.smtp.starttls.required=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre><br>  A couple of explanations: <br><pre> <code class="hljs pgsql">spring.jpa.generate-ddl=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> spring.jpa.hibernate.ddl-auto=<span class="hljs-keyword"><span class="hljs-keyword">update</span></span></code> </pre> <br>  They are used to automatically create / update the table in the database, using our entity. (In production, it is better to change the values ‚Äã‚Äãto false and none) <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">spring</span></span>.datasource.url=jdbc:postgresql:<span class="hljs-comment"><span class="hljs-comment">//localhost:5432/your_database?stringtype=unspecified spring.datasource.username=your_database_username spring.datasource.password=your_database_password</span></span></code> </pre> <br>  Here you can see the name of your database, login and password. <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">spring</span></span>.mail.username=your_email@gmail.com <span class="hljs-keyword"><span class="hljs-keyword">spring</span></span>.mail.password=your_password</code> </pre> <br>  Your or test email and password from it.  There may be errors in access to gmail, for this you just need to allow unreliable applications in the security and login tab in its settings. <br><br><h3>  Launch </h3><br>  We go to our TaskApplication and run the application.  If everything is done correctly, then you should have similar logs every 10 seconds: <br><br><pre> <code class="hljs pgsql">Hibernate: <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> users0_.id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id1_0_, users0_.birthday <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> birthday2_0_, users0_.email <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> email3_0_, users0_.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> name4_0_ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> users users0_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (users0_.birthday <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (users0_.email <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)</code> </pre> <br>  Meaning that our method at least takes a list of users from the database.  Now, if we open our database (I do this directly in IDEA. In the database tab, usually in the upper right corner, we can connect to the database we need), we will see that there appeared a table users with the corresponding fields.  Let's create a new record and, as a birthday, we will enter the current date, and as our own email-a.  After committing changes, every 10 seconds our log should appear informing you that email has been successfully sent.  We check email and if everything is done correctly, then there should be one or several birthday greetings (depending on how many times the method has been worked out).  We stop our application and change the CRON value to ‚Äú0 0 10 * * *‚Äù which means that now the check will not take place every 10 seconds, but every day at 10 am, which guarantees us sending only one greeting. <br><br><h3>  Conclusion </h3><br>  Based on this example, you can create and solve a variety of tasks related, in particular, to background processes; the main thing is not to be afraid to experiment.  I hope today I was able to help someone better understand how to work with Spring Boot, databases and java.  If someone is interested, then I can write the second part of the article, with the addition of a controller (so that, for example, if you wish, you can turn off email sending) testing and security. <br><br>  Constructive criticism and comments on the topic are welcome. <br>  Special thanks for the comments: <a href="https://habrahabr.ru/users/stanislavl/" class="user_link">StanislavL</a> , <a href="https://habrahabr.ru/users/elegorod/" class="user_link">elegorod</a> , <a href="https://habrahabr.ru/users/apxeolog/" class="user_link">APXEOLOG</a> , <a href="https://habrahabr.ru/users/singaporian/" class="user_link">Singaporian</a> <br><br><h3>  Links </h3><br>  Github source code <br>  Spring Boot Official <a href="https://projects.spring.io/spring-boot/">Documentation</a> </div><p>Source: <a href="https://habr.com/ru/post/352954/">https://habr.com/ru/post/352954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352942/index.html">Conference DEFCON 23. "How I knocked down the annoying drone of a neighbor's child." Michael robinson</a></li>
<li><a href="../352944/index.html">Splunk - Installing agents to collect Windows and Linux logs</a></li>
<li><a href="../352948/index.html">Macro for Autodesk Revit that trim walls</a></li>
<li><a href="../352950/index.html">Be careful with copy-paste: fingerprinting text with unprintable characters</a></li>
<li><a href="../352952/index.html">System Shock source code is publicly available under the GPL</a></li>
<li><a href="../352958/index.html">MBO, OKR, PPR: mix but not shake</a></li>
<li><a href="../352962/index.html">Learn OpenGL. Lesson 4.10 - Instancing</a></li>
<li><a href="../352964/index.html">Issue # 17: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../352966/index.html">Program less, think more ... incrementally</a></li>
<li><a href="../352968/index.html">Conference DEFCON 22. ‚ÄúArming Your Pets. Fighting Kitty and Dog for denial of service. " Jen Brensfield</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>