<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing automatic restarting of failed tests in the current build and overcoming attendant troubles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will discuss the use of the testNG framework, and specifically about the interfaces implemented in it and quite rarely used: IRetryAnalyz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing automatic restarting of failed tests in the current build and overcoming attendant troubles</h1><div class="post__text post__text-html js-mediator-article">  This article will discuss the use of the testNG framework, and specifically about the interfaces implemented in it and quite rarely used: IRetryAnalyzer, ITestListener, IReporter.  But first things first. <br><br>  The eternal problem of every tester when running autotests is the ‚Äúfall‚Äù of individual scenarios from launch to launch randomly.  And this is not about the failure of our tests for objective reasons (i.e., there is indeed an error in the operation of the tested functionality, or the test itself is not written correctly), but just about cases where, after a restart, the previously failed tests pass by a miracle.  The reasons for such a random drop can be mass: the Internet has fallen off, CPU overload / lack of free RAM on the device, timeout, etc. The question is how to eliminate or at least reduce the number of such non-objectively failed tests? <br><br>  For me, this challenge came about under the following circumstances: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1) the</b> current autotest application was decided to be placed on the server (CI); <br>  <b>2) the</b> implementation of multi-threading in the project turned from desire to mustHave (in view of the need to reduce the time of regression testing of the service). <br><br>  I personally was very pleased with the second point, because I believe that any process that can take less time is sure to do it this way (whether it is passing the auto test or a queue at the checkout in the supermarket: the faster we can complete these processes, the we have more time to do something really interesting).  So, by placing our tests on the server (here the admins and their knowledge of jenkins helped us) and running them in streams (here our assiduity and experiments with testng.xml already helped), we got a reduction in the test passing time from 100 minutes to 18, but at the same time we received an increase in failed tests&gt; 2 times.  Therefore, the following were added to the first two points (in fact, the Challenge itself, to which this article is devoted): <br><a name="habracut"></a><br>  <b>3)</b> implement the restart of failed tests in a single build process. <br><br>  The volume of the third point and the requirements for it gradually grew, but then again, about everything in order. <br><br>  To implement the restart of the failed test, testng allows out of the box, thanks to the <a href="http://testng.org/javadoc/org/testng/IRetryAnalyzer.html">IRetryAnalyzer</a> interface.  This interface provides us with the boolean-method retry, which is responsible for restarting the test, in the case of returning true, or the lack of restart when false.  To transfer to this method, we need the result of our test (ITestResult result). <br><br>  Now the failed tests started to restart, but the following unpleasant feature was revealed: all failed attempts to pass the test inevitably fall into the report books (because your test, even the same one, passes several times in a row - it receives the same number of results that honestly get into the report).  Probably, this problem may seem far-fetched to some testers (especially if you don‚Äôt show the report to anyone, do not provide it to technicals, managers and customers).  In this case, indeed, you can use the maven-surefire-report-plugin and periodically get angry, breaking your eyes to see if your test fails or not. <br><br>  The perspective of a crooked report obviously did not suit me, because the search for solutions was continued. <br><br>  Considered options for parsing an html report to remove duplicate failed tests.  Also suggested mergit results of several reports in the final one.  Thinking that the crutch solutions might haunt us when the structure of their html / xml reports was changed with the next update of the report plug-ins, it was decided to implement the creation of our own custom report.  The only disadvantage of such a solution is the time for its development and testing.  I saw a lot more advantages, and the main one is flexibility.  Report can be generated as you need or like.  You can always add additional parameters, fields, metrics. <br><br>  So, it was clear where the failed tests would be added to the report - this is a block of the retry method, in which the number of attempts to restart the tests has already been exhausted.  Then we decided on where to put the successful ones.  <a href="http://testng.org/javadoc/org/testng/ITestListener.html">ITestListener</a> interface.  Of the seven methods of this interface, onTestSuccess ideally suited us.  successful tests always enter this method.  In total, we have two points in our application, from where successful and failed tests will be added to our report. <br><br>  The next question is: at what point should we pull our report so that by this time all the tests have been completed.  Here comes the following interface - <a href="http://testng.org/javadoc/org/testng/IReporter.html">IReporter</a> and its generateReport method. <br><br>  So now we have: <br><br>  - the method from which we will put successful tests into the report; <br>  - a similar method, only for failed tests; <br>  - a method that knows when all tests are completed and can ‚Äúpull‚Äù our report generator itself (which is not yet available). <br><br>  To work with html in java library <a href="https://code.google.com/p/gagawa/">gagawa</a> was chosen.  Here you can create a report in any way you like, starting from both the parameters you have and the metrics you require at your discretion.  After - connect to the project a simple css-ku for better visualization of our report and work with styles. <br><br>  Now directly about the implementation of these features from me (comments for readability). <br><br><h5>  RetryAnalyzer: </h5><br>  The variables retryCount and retryMaxCount allow you to control the number of restarts required in the event of a test failure.  For the rest, I think the code is quite readable. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RetryAnalyzer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRetryAnalyzer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retryCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retryMaxCount = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ,     @Override public boolean retry(ITestResult testResult) { boolean result = false; if (testResult.getAttributeNames().contains("retry") == false) { System.out.println("retry count = " + retryCount + "\n" +"max retry count = " + retryMaxCount); if(retryCount &lt; retryMaxCount){ System.out.println("Retrying " + testResult.getName() + " with status " + testResult.getStatus() + " for the try " + (retryCount+1) + " of " + retryMaxCount + " max times."); retryCount++; result = true; }else if (retryCount == retryMaxCount){ //        //      String testName = testResult.getName(); String className = testResult.getTestClass().toString(); String resultOfTest = resultOfTest(testResult); String stackTrace = testResult.getThrowable().fillInStackTrace().toString(); System.out.println(stackTrace); //      ReportCreator.addTestInfo(testName, className, resultOfTest, stackTrace); } } return result; } //        saccess / failure public String resultOfTest (ITestResult testResult) { int status = testResult.getStatus(); if (status == 1) { String TR = "Success"; return TR; } if (status == 2) { String TR = "Failure"; return TR; } else { String unknownResult = "not interested for other results"; return unknownResult; } } }</span></span></code> </pre> <br><h5>  TestListener </h5><br>  Here we catch successful tests, as you already know. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestListenerAdapter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     onSuccess   @Override public void onTestSuccess(ITestResult testResult) { System.out.println("on success"); //        ,    String testName = testResult.getName(); String className = testResult.getTestClass().toString(); String resultOfTest = resultOfTest(testResult); String stackTrace = ""; ReportCreator.addTestInfo(testName, className, resultOfTest, stackTrace); } //  1        saccess / failure public String resultOfTest (ITestResult testResult) { int status = testResult.getStatus(); if (status == 1) { String TR = "Success"; return TR; } if (status == 2) { String TR = "Failure"; return TR; } else { String unknownResult = "not interested for other results"; return unknownResult; } } }</span></span></code> </pre><br><h5>  Reporter </h5><br>  We pull our report, because  we understand that all tests have been completed. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reporter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IReporter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,          getReport   html  string @Override public void generateReport(List&lt;XmlSuite&gt; xmlSuites, List&lt;ISuite&gt; suites, String outputDirectory) { PrintWriter saver = null; try { saver = new PrintWriter(new File("report.html")); saver.write(ReportCreator.getReport()); } catch (FileNotFoundException e) { e.printStackTrace(); } finally { if (saver != null) { saver.close(); } } } }</span></span></code> </pre><br><h5>  ReportCreator </h5><br>  The generator of our html report. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReportCreator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Document document; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Body body; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ArrayList&lt;TestData&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;TestData&gt;(); <span class="hljs-comment"><span class="hljs-comment">//     public static void headerImage (){ Img headerImage = new Img("", "src/main/resources/baad.jpeg"); headerImage.setCSSClass("headerImage"); body.appendChild(headerImage); } //    (  :  + ) public static void addTestReport(String className, String testName, String status) { if (status == "Failure"){ Div failedDiv = new Div().setCSSClass("AllTestsFailed"); Div classNameDiv = new Div().appendText(className); Div testNameDiv = new Div().appendText(testName); Div resultDiv = new Div().appendText(status); failedDiv.appendChild(classNameDiv); failedDiv.appendChild(testNameDiv); failedDiv.appendChild(resultDiv); body.appendChild(failedDiv); }else{ Div successDiv = new Div().setCSSClass("AllTestsSuccess"); Div classNameDiv = new Div().appendText(className); Div testNameDiv = new Div().appendText(testName); Div resultDiv = new Div().appendText(status); successDiv.appendChild(classNameDiv); successDiv.appendChild(testNameDiv); successDiv.appendChild(resultDiv); body.appendChild(successDiv); } } //        ( - , -    ) public static void addCommonRunMetrics (int totalCount, int successCount, int failureCount) { Div total = new Div().setCSSClass("HeaderTable"); total.appendText("Total tests count: " + totalCount); Div success = new Div().setCSSClass("HeaderTable"); success.appendText("Passed tests: " + successCount); Div failure = new Div().setCSSClass("HeaderTable"); failure.appendText("Failed tests: " + failureCount); body.appendChild(total); body.appendChild(success); body.appendChild(failure); } //             public static void addFailedTestsBlock (String className, String testName, String status) { Div failed = new Div().setCSSClass("AfterHeader"); Div classTestDiv = new Div().appendText(className); Div testNameDiv = new Div().appendText(testName); Div statusTestDiv = new Div().appendText(status); failed.appendChild(classTestDiv); failed.appendChild(testNameDiv); failed.appendChild(statusTestDiv); body.appendChild(failed); } //            public static void addfailedWithStacktraces (String className, String testName, String status, String stackTrace) { Div failedWithStackTraces = new Div().setCSSClass("Lowest"); failedWithStackTraces.appendText(className + " " + testName + " " + status + "\n"); Div stackTraceDiv = new Div(); stackTraceDiv.appendText(stackTrace); body.appendChild(failedWithStackTraces); body.appendChild(stackTraceDiv); } //    arraylist        public static void addTestInfo(String testName, String className, String status, String stackTrace) { TestData testData = new TestData(); testData.setTestName(testName); testData.setClassName(className); testData.setTestResult(status); testData.setStackTrace(stackTrace); list.add(testData); } //  ,         html- public static String getReport() { document = new Document(DocumentType.XHTMLTransitional); Head head = document.head; Link cssStyle= new Link().setType("text/css").setRel("stylesheet").setHref("src/main/resources/site.css"); head.appendChild(cssStyle); body = document.body; //    -  int totalCount = list.size(); //      ArrayList failedCountArray = new ArrayList(); for (int f=0; f &lt; list.size(); f++) { if (list.get(f).getTestResult() == "Failure") { failedCountArray.add(f); } } int failedCount = failedCountArray.size(); //  -   int successCount = totalCount - failedCount; //   html     headerImage(); //   html   addCommonRunMetrics(totalCount, successCount, failedCount); //   html   for (int s = 0; s &lt; list.size(); s++){ if (list.get(s).getTestResult() == "Failure"){ addFailedTestsBlock(list.get(s).getClassName(), list.get(s).getTestName(), list.get(s).getTestResult()); } } // ,         if(list.isEmpty()){ System.out.println("ERROR: TEST LIST IS EMPTY"); return ""; } //        (   ) +    html String currentTestClass = ""; ArrayList constructedClasses = new ArrayList(); for(int i=0; i &lt; list.size();i++){ currentTestClass = list.get(i).getClassName(); //        boolean isClassConstructed=false; for(int j=0;j&lt;constructedClasses.size();j++){ if(currentTestClass.equals(constructedClasses.get(j))){ isClassConstructed=true; } } if(!isClassConstructed){ for (int k=0;k&lt;list.size();k++){ if(currentTestClass.equals(list.get(k).getClassName())){ addTestReport(list.get(k).getClassName(), list.get(k).getTestName(),list.get(k).getTestResult()); } } constructedClasses.add(currentTestClass); } } //      +    html for (int z = 0; z &lt; list.size(); z++){ if (list.get(z).getTestResult() == "Failure"){ addfailedWithStacktraces(list.get(z).getClassName(), list.get(z).getTestName(), list.get(z).getTestResult(), list.get(z).getStackTrace()); } } return document.write(); } //         + getter' / setter' public static class TestData{ String testName; String className; String testResult; String stackTrace; public TestData() {} public String getTestName() { return testName; } public String getClassName() { return className; } public String getTestResult() { return testResult; } public String getStackTrace() { return stackTrace; } public void setTestName(String testName) { this.testName = testName; } public void setClassName(String className) { this.className = className; } public void setTestResult(String testResult) { this.testResult = testResult; } public void setStackTrace(String stackTrace) { this.stackTrace = stackTrace; } } }</span></span></code> </pre><br><h5>  Class itself with tests </h5><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(TestListener.class) <span class="hljs-comment"><span class="hljs-comment">//       ,    TestListener public class Test { private static WebDriver driver; @BeforeClass public static void init () { driver = new FirefoxDriver(); driver.get("http://www.last.fm/ru/"); } @AfterClass public static void close () { driver.close(); } @org.testng.annotations.Test (retryAnalyzer = RetryAnalyzer.class) //      RetryAnalyzer    public void findLive () { driver.findElement(By.cssSelector("[href=\"/ru/dashboard\"]")).click(); } }</span></span></code> </pre><br>  You also need to add the following tag to the testng.xml file with the path to the Reporter class: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listeners</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listener</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class-name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"retry.Reporter"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listeners</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The visualization of the final result remains entirely at your discretion.  For example, the report that you see in the code above looks like this: <br><br><img src="https://habrastorage.org/files/2fc/578/dbe/2fc578dbe7284250965081c66f8a6031.png" alt="image"><br><br>  In conclusion, I want to say that, faced with a rather trivial, at first glance, problem, the solution to the output we got is far from trivial. <br><br>  Perhaps not elegant enough or simple - in such a welcome criticism in the comments.  For myself, the main advantage of this set I see is universality: it will be possible to re-use the development on any java + testng project in the future. <br><br>  My <a href="https://github.com/dkravchenko11/">github</a> with this project. </div><p>Source: <a href="https://habr.com/ru/post/272643/">https://habr.com/ru/post/272643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272631/index.html">The test from Rostelecom to test knowledge in the field of system administration and user support</a></li>
<li><a href="../272633/index.html">Free hosting control panels. "Coin"</a></li>
<li><a href="../272635/index.html">Heavy armor sound design for the InSomnia project</a></li>
<li><a href="../272639/index.html">Video of Badoo reports from the Highload 2015 conference</a></li>
<li><a href="../272641/index.html">FireEye Specialists Discover New Bootkit</a></li>
<li><a href="../272645/index.html">How Cloud Foundry is Developed</a></li>
<li><a href="../272647/index.html">IBM cloud service translates applications into 9 languages</a></li>
<li><a href="../272649/index.html">Photoshop for coder (programmer)</a></li>
<li><a href="../272651/index.html">MongoDB as a monitoring tool for LOG files</a></li>
<li><a href="../272653/index.html">On the other side of the game: an open course on game design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>