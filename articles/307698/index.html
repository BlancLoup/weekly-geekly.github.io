<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In the wake of "spammer" or Oracle DB + UTL_SMTP + SSL / TLS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing this article encouraged me to read the publication ‚ÄúHow I Spam Spam‚Äù from user Nike01 . The management has set me a similar task of distributi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In the wake of "spammer" or Oracle DB + UTL_SMTP + SSL / TLS</h1><div class="post__text post__text-html js-mediator-article">  Writing this article encouraged me to read the publication <a href="https://habrahabr.ru/post/130105/">‚ÄúHow I Spam Spam‚Äù</a> from user <a href="https://habrahabr.ru/users/nike01/" class="user_link">Nike01</a> .  The management has set me a similar task of distributing user credentials using the Oracle database.  The SMTP relay was supposed to be a Yandex outgoing server using SSL for authorization. <br><br><img src="https://habrastorage.org/files/61a/3c4/143/61a3c41433094d4081115584390a6d9b.jpg"><br><a name="habracut"></a><br><h3>  Collection of information </h3><br>  Like <a href="https://habrahabr.ru/users/nike01/" class="user_link">Nike01</a> , I first began to look in the direction of the UTL_MAIL package.  This package, in fact, is a ‚Äúwrapper‚Äù over UTL_SMTP and UTL_TCP and is intended mainly for sending simple mail messages, allowing the user not to go into the details of the SMTP protocol.  Unfortunately, UTL_MAIL has a number of limitations, including the lack of support for SMTP authentication and, therefore, it does not suit my task. <br><br>  Next, I turned to the documentation on the UTL_SMTP package, as it turned out - it is quite a powerful and flexible tool that allows you to use almost all the commands of the SMTP protocol, including SMTP authorization support, and since the version of DB 11.2.0.2 it can also STARTTLS.  What you need! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Go to the mail server.  From the help on using <b>smtp.yandex.ru</b> we learn that the service is listening to port 465: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3b6/6ca/9e3/3b66ca9e33d847b0ba132c2344f890c9.PNG"></div><br>  OK.  We are trying to establish a connection: <br><br><pre><code class="bash hljs">[oracle@ora_db ~]<span class="hljs-variable"><span class="hljs-variable">$openssl</span></span> s_client -connect smtp.yandex.ru:465 CONNECTED(00000003) depth=2 C = PL, O = Unizeto Technologies SA, OU = Certum Certification Authority, CN = Certum Trusted Network CA verify <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>:1 depth=1 C = RU, O = Yandex LLC, OU = Yandex Certification Authority, CN = Yandex CA verify <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>:1 depth=0 C = RU, O = Yandex LLC, OU = ITO, L = Moscow, ST = Russian Federation, CN = smtp.yandex.ru, emailAddress = pki@yandex-team.ru verify <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>:1 --- Certificate chain 0 s:/C=RU/O=Yandex LLC/OU=ITO/L=Moscow/ST=Russian Federation/CN=smtp.yandex.ru/emailAddress=pki@yandex-team.ru i:/C=RU/O=Yandex LLC/OU=Yandex Certification Authority/CN=Yandex CA 1 s:/C=RU/O=Yandex LLC/OU=Yandex Certification Authority/CN=Yandex CA i:/C=PL/O=Unizeto Technologies SA/OU=Certum Certification Authority/CN=Certum Trusted Network CA --- Server certificate -----BEGIN CERTIFICATE----- MIIGtzCCBZ+gAwIBAgIQeNdVGMktXbH0GDaX1lgg9TANBgkqhkiG9w0BAQsFADBf MQswCQYDVQQGEwJSVTETMBEGA1UEChMKWWFuZGV4IExMQzEnMCUGA1UECxMeWWFu ZGV4IENlcnRpZmljYXRpb24gQXV0aG9yaXR5MRIwEAYDVQQDEwlZYW5kZXggQ0Ew HhcNMTUxMDEyMTI0MTI0WhcNMTcxMDExMTI0MTI0WjCBmjELMAkGA1UEBhMCUlUx EzARBgNVBAoMCllhbmRleCBMTEMxDDAKBgNVBAsMA0lUTzEPMA0GA1UEBwwGTW9z Y293MRswGQYDVQQIDBJSdXNzaWFuIEZlZGVyYXRpb24xFzAVBgNVBAMMDnNtdHAu eWFuZGV4LnJ1MSEwHwYJKoZIhvcNAQkBFhJwa2lAeWFuZGV4LXRlYW0ucnUwggEi MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDfdYJIwjSdhSwHdNxNJ+2TH8jc l2Skm4k6Z9UTDcxCMbe8rvkEg3bu7EUPnftNmBGxB3KXNj73irZ6PLRu3bO7psi3 hbWNRVDzQlcdQZmW/Iucd8IQlvN1gwDZ79eu1fWmRMThmNmiiKK1AjtZNTc+Dq/9 kTl4TkRzdge6KpkOn3lJFwiTozixxKKfawxQSlFpRadzLuYt2Cj88Huo3R5frwwH 8nTMDITtHZVSSYw1cYNIWj+y5G3D1TA1pKcyIPI8WHqJeHIekI3t4uK9JQNEaJI0 clabA3fn1wdJ4jCWajdLcssJ9PJ6eJB+l4HZFt3EDhe8XiQ/69gZjQVIVrcpAgMB AAGjggMxMIIDLTAMBgNVHRMBAf8EAjAAMGkGA1UdHwRiMGAwL6AtoCuGKWh0dHA6 Ly9jcmxzLnlhbmRleC5uZXQvY2VydHVtL3ljYXNoYTIuY3JsMC2gK6AphidodHRw Oi8veWFuZGV4LmNybC5jZXJ0dW0ucGwveWNhc2hhMi5jcmwwcQYIKwYBBQUHAQEE ZTBjMCwGCCsGAQUFBzABhiBodHRwOi8veWFuZGV4Lm9jc3AtcmVzcG9uZGVyLmNv bTAzBggrBgEFBQcwAoYnaHR0cDovL3JlcG9zaXRvcnkuY2VydHVtLnBsL3ljYXNo YTIuY2VyMB8GA1UdIwQYMBaAFDdc4xngso6hqE7Sz6vQ3OMLXDVNMB0GA1UdDgQW BBQYy748oNmcZPHfTrybOrdqeu/mTDAOBgNVHQ8BAf8EBAMCBaAwggE/BgNVHSAE ggE2MIIBMjCCAS4GDCqEaAGG9ncCBQEKAjCCARwwJQYIKwYBBQUHAgEWGWh0dHBz Oi8vd3d3LmNlcnR1bS5wbC9DUFMwgfIGCCsGAQUFBwICMIHlMCAWGVVuaXpldG8g VGVjaG5vbG9naWVzIFMuQS4wAwIBAhqBwFVzYWdlIG9mIHRoaXMgY2VydGlmaWNh dGUgaXMgc3RyaWN0bHkgc3ViamVjdGVkIHRvIHRoZSBDRVJUVU0gQ2VydGlmaWNh dGlvbiBQcmFjdGljZSBTdGF0ZW1lbnQgKENQUykgaW5jb3Jwb3JhdGVkIGJ5IHJl ZmVyZW5jZSBoZXJlaW4gYW5kIGluIHRoZSByZXBvc2l0b3J5IGF0IGh0dHBzOi8v d3d3LmNlcnR1bS5wbC9yZXBvc2l0b3J5LjAdBgNVHSUEFjAUBggrBgEFBQcDAQYI KwYBBQUHAwIwEQYJYIZIAYb4QgEBBAQDAgbAMHoGA1UdEQRzMHGCDnNtdHAueWFu ZGV4LmJ5gg5zbXRwLnlhbmRleC5reoIPc210cC55YW5kZXguY29tgg5zbXRwLnlh bmRleC51YYISc210cC55YW5kZXguY29tLnRyggpzbXRwLnlhLnJ1gg5zbXRwLnlh bmRleC5ydTANBgkqhkiG9w0BAQsFAAOCAQEAoVcDTfHCdx1N6IF0rBtZTxJBu2Tf WcSYGu/Uif6EqqVsy44kQ8Yxresaqb8bR0FkJxSP1HXDwQuXm18sdZDb4f/ealF4 Hb6ZmF5ilP0SNUccka4wI0DDTuMuBDstGbCvLJPxTjHTWP9HYrYoAJsUnux92blR Uc11XnKQE9ltWEpKys9RQhTLDqPNrALa423zvN5jLKqMK6vVzuTIOnrOQFZMDxmQ KVVUtvGS7ZBmL8Z8ripEDBUFywAcxHC9DJpTUwxZUs2ceJbuN6J0qKjP2F/aKJZR GTgW095M/H1tEGjouYfSj21cy9ZDNiUqN1Yutg0+nGNexiRDghg44yWMeQ== -----END CERTIFICATE----- subject=/C=RU/O=Yandex LLC/OU=ITO/L=Moscow/ST=Russian Federation/CN=smtp.yandex.ru/emailAddress=pki@yandex-team.ru issuer=/C=RU/O=Yandex LLC/OU=Yandex Certification Authority/CN=Yandex CA --- No client certificate CA names sent Server Temp Key: ECDH, prime256v1, 256 bits --- SSL handshake has <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> 3581 bytes and written 373 bytes --- New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES128-GCM-SHA256 Server public key is 2048 bit Secure Renegotiation IS supported Compression: NONE Expansion: NONE SSL-Session: Protocol : TLSv1.2 Cipher : ECDHE-RSA-AES128-GCM-SHA256 Session-ID: C64B0AE4863B7F1A44ED0981E29F4D1E796F98F7FB0EF950A7A1588232F11ABC Session-ID-ctx: Master-Key: F704953E4A95AD4A1C06BBDF1425F4E5B1E2B8BE5EE5214484AC0DF9219E7185ABB38573904FA3CFD0B88A8FF3185061 Key-Arg : None Krb5 Principal: None PSK identity: None PSK identity hint: None TLS session ticket lifetime hint: 300 (seconds) TLS session ticket: 0000 - b3 08 e7 79 5b 86 ba 5a-7e 71 bf f8 5f ad 66 4a ...y[..Z~q.._.fJ 0010 - 5b 4b c6 fe e4 ae 95 21-6e 60 b8 84 bd 09 8e 91 [K.....!n`...... 0020 - ba a4 1e 29 b8 <span class="hljs-built_in"><span class="hljs-built_in">fc</span></span> 7c 5b-72 16 ae 7e f6 f7 a9 e5 ...)..|[r..~.... 0030 - 69 0a 4e 41 03 cc 79 3a-b4 f7 6d 99 81 a6 a2 ef i.NA..y:..m..... 0040 - c8 27 02 50 1d 68 0b 70-1f d1 d4 1a b7 d9 99 b8 .<span class="hljs-string"><span class="hljs-string">'.Php....... 0050 - b0 6d 47 ee 89 7d 5d 37-bd ab 89 a7 d2 d2 3d 1d .mG..}]7......=. 0060 - 2f e1 4b 85 ae eb ab de-3a f7 e2 18 ce 55 48 3b /.K.....:....UH; 0070 - 15 14 8f 69 45 bc 8a a4-77 b1 a0 8f 41 96 ea c7 ...iE...w...A... 0080 - f2 2d be e2 26 26 5a 06-1f f3 c0 fe 6b f7 de ab .-..&amp;&amp;Z.....k... 0090 - ab 04 f8 74 e5 b3 c9 25-c6 24 ba 88 44 50 3b 57 ...t...%.$..DP;W Start Time: 1470992045 Timeout : 300 (sec) Verify return code: 0 (ok) --- 220 smtp2h.mail.yandex.net ESMTP (Want to use Yandex.Mail for your domain? Visit http://pdd.yandex.ru)</span></span></code> </pre> <br>  Great, we'll need the certificates from the output later. <br><br><h3>  Implementation </h3><br>  To begin with, we will create an Oracle wallet, in which we will store trusted mail server certificates.  Certificates can be taken <a href="https://ssl-tools.net/subjects/bb542b95ee906e2d1d90c813743643cee7da4cfa">here</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/20d/608/528/20d608528fb548be93c225d0c418da0f.PNG"></div><br>  We start Oracle Wallet Manager with the <b>ovm</b> command, create a new wallet / set the password: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/230/116/b26/230116b26265401eab9de3b5b9b0b0c9.PNG"></div><br>  Import trusted certificates, <b>Operations&gt; Import Trusted Certificate.</b>  : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/624/f61/02f/624f6102f6794bddb2448d5c361f1869.PNG"></div><br>  Save, by default the wallet is stored here <b><code>$ORACLE_HOME/owm/wallets/oracle/</code></b> .  Next, you need to give rights to execute the UTL_SMTP package: <br><br><pre> <code class="bash hljs">GRANT EXECUTE on UTL_SMTP to SMTP_USER;</code> </pre> <br>  We create ACL, we grant the rights to connect: <br><br><pre> <code class="bash hljs">begin DBMS_NETWORK_ACL_ADMIN.CREATE_ACL ( acl =&gt; <span class="hljs-string"><span class="hljs-string">'smtp_acl.xml'</span></span>, principal =&gt; <span class="hljs-string"><span class="hljs-string">'SMTP_USER'</span></span>, is_grant =&gt; TRUE, privilege =&gt; <span class="hljs-string"><span class="hljs-string">'connect'</span></span>, ); end; /</code> </pre> <br>  To access Yandex SMTP: <br><br><pre> <code class="bash hljs">begin DBMS_NETWORK_ACL_ADMIN.ASSIGN_ACL ( acl =&gt; <span class="hljs-string"><span class="hljs-string">'smtp_acl.xml'</span></span>, host =&gt; <span class="hljs-string"><span class="hljs-string">'smtp.yandex.ru'</span></span>, lower_port =&gt; 1, upper_port =&gt; 1024 ); end; /</code> </pre> <br>  To use a wallet: <br><br><pre> <code class="bash hljs">begin DBMS_NETWORK_ACL_ADMIN.ADD_PRIVILEGE ( acl =&gt; <span class="hljs-string"><span class="hljs-string">'smtp_acl.xml'</span></span>, principal =&gt; <span class="hljs-string"><span class="hljs-string">'SMTP_USER'</span></span>, is_grant =&gt; TRUE, privilege =&gt; <span class="hljs-string"><span class="hljs-string">'use-client-certificates'</span></span> ); end; /</code> </pre> <br>  Set the path to the wallet: <br><br><pre> <code class="bash hljs">begin DBMS_NETWORK_ACL_ADMIN.ASSIGN_WALLET_ACL ( acl =&gt; <span class="hljs-string"><span class="hljs-string">'smtp_acl.xml'</span></span>, wallet_path =&gt; <span class="hljs-string"><span class="hljs-string">'file:/oracle_home/owm/wallets/oracle/'</span></span> ); end; /</code> </pre> <br>  We also need to convert the credentials for access to the mailbox (login, password) to base64: <br><br><pre> <code class="bash hljs">select UTL_RAW.cast_to_varchar2 ( UTL_ENCODE.base64_encode (UTL_RAW.cast_to_raw (<span class="hljs-string"><span class="hljs-string">'user@yandex.ru'</span></span>))) as username, UTL_RAW.cast_to_varchar2 ( UTL_ENCODE.base64_encode (UTL_RAW.cast_to_raw (<span class="hljs-string"><span class="hljs-string">'password'</span></span>))) as password from dual;</code> </pre> <br>  The resulting hashes will be used for SMTP authentication. <br><br><h3>  We are testing! </h3><br><pre> <code class="bash hljs">DECLARE c utl_smtp.connection; l_mailhost VARCHAR2 (64) := <span class="hljs-string"><span class="hljs-string">'smtp.yandex.ru'</span></span>; l_from VARCHAR2 (64) := <span class="hljs-string"><span class="hljs-string">'user@yandex.ru'</span></span>; l_to VARCHAR2 (64) := <span class="hljs-string"><span class="hljs-string">'user@gmail.com'</span></span>; l_subject VARCHAR2 (64) := <span class="hljs-string"><span class="hljs-string">'utl_smtp test'</span></span>; crlf varchar2(2) := UTL_TCP.CRLF; BEGIN c := utl_smtp.open_connection( host =&gt; l_mailhost, port =&gt; 465, wallet_path =&gt; <span class="hljs-string"><span class="hljs-string">'file:/oracle_home/owm/wallets/oracle/'</span></span>, wallet_password =&gt; <span class="hljs-string"><span class="hljs-string">'password'</span></span>, secure_connection_before_smtp =&gt; FALSE); UTL_SMTP.STARTTLS(c); UTL_SMTP.EHLO(c, <span class="hljs-string"><span class="hljs-string">'oracle'</span></span>); utl_smtp.command( c, <span class="hljs-string"><span class="hljs-string">'AUTH LOGIN'</span></span>); utl_smtp.command( c, <span class="hljs-string"><span class="hljs-string">'  '</span></span>); utl_smtp.command( c, <span class="hljs-string"><span class="hljs-string">'  '</span></span>); UTL_SMTP.mail (c, l_from); UTL_SMTP.rcpt (c, l_to); UTL_SMTP.open_data (c); UTL_SMTP.write_data (c, <span class="hljs-string"><span class="hljs-string">'Date: '</span></span> || TO_CHAR (SYSDATE, <span class="hljs-string"><span class="hljs-string">'DD-MON-YYYY HH24:MI:SS'</span></span>) || crlf); UTL_SMTP.write_data (c, <span class="hljs-string"><span class="hljs-string">'From: '</span></span> || l_from || crlf); UTL_SMTP.write_data (c, <span class="hljs-string"><span class="hljs-string">'Subject: '</span></span> || l_subject || crlf); UTL_SMTP.write_data (c, <span class="hljs-string"><span class="hljs-string">'To: '</span></span> || l_to || crlf); UTL_SMTP.write_data (c, <span class="hljs-string"><span class="hljs-string">'message test'</span></span> || crlf); UTL_SMTP.close_data (c); UTL_SMTP.quit (c); END; / PL/SQL procedure successfully completed.</code> </pre> <br>  The message was successfully delivered to gmail.com.  Clause 4.c is implemented. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/307698/">https://habr.com/ru/post/307698/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307688/index.html">How different are sales directors and founders of IT companies?</a></li>
<li><a href="../307690/index.html">Routing in the CleverStyle Framework</a></li>
<li><a href="../307692/index.html">Creating a WebView application based on AWS ApiGateway and AWS Lambda</a></li>
<li><a href="../307694/index.html">Progressive loading of a web application using code sharing</a></li>
<li><a href="../307696/index.html">Juniper Hardware Architecture</a></li>
<li><a href="../307700/index.html">The digest of interesting materials for the mobile # 166 developer (on August 8-14)</a></li>
<li><a href="../307702/index.html">How a variable may not equal its own value.</a></li>
<li><a href="../307704/index.html">New 3CX Client clients for Mac and iOS, and a tip for setting up a Gmail server for 3CX Phone System</a></li>
<li><a href="../307706/index.html">Puns typing functions in C</a></li>
<li><a href="../307708/index.html">A little introduction to parallel programming on R</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>