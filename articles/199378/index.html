<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Aspect-oriented programming: study and do it yourself!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article was born from the fact that I needed a convenient and simple interception mechanism for some tasks, which is easily implemented by AOP tec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Aspect-oriented programming: study and do it yourself!</h1><div class="post__text post__text-html js-mediator-article">  The article was born from the fact that I needed a convenient and simple interception mechanism for some tasks, which is easily implemented by AOP technicians.  There are quite a few interceptors (Casle.net, Spring.net, LinFu, etc.) that require you to embed dynamic child classes in the IL code at run time and almost always lead to the same restrictions imposed on the classes being intercepted: not static, not sealed, methods and properties must be virtual, etc ... <br><br>  Other interception mechanisms required changes to the build process or license purchase.  I could not afford either of them ... <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  AOP - Aspect-Oriented Programming.  I think everyone is familiar with what OP means, so you need to figure out what an <b>Aspect is</b> .  Do not worry about this in the article later. <br><br>  I will try to write this article at novice level.  The only requirement for further reading is knowledge of the concept of Object Oriented Programming. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It seems to me that understanding the concept will allow you to better understand the implementation.  But I also understand that the article is quite large, because if you get bored or tired, then still see the part with the implementation.  You can always go back to theory. <br><br><h4>  Experienced developers, read! </h4><br>  If you're already familiar with AOP, don't leave! <br>  Let me tell you right here and now what is in this article ... <br><br>  I will talk about the interception technique, which will allow to intercept: <br>  ‚Ä¢ Any class (including sealed, static, meaningful type) <br>  ‚Ä¢ Constructors <br>  ‚Ä¢ Type Initializers <br>  ‚Ä¢ Methods, properties, and event instances (even if they are not marked as virtual) <br>  ‚Ä¢ Static methods, properties and events <br><br>  Without: <br>  ‚Ä¢ Redrawing your code and assemblies <br>  ‚Ä¢ Embedding in IL-code <br>  ‚Ä¢ Dynamic creation of something <br>  ‚Ä¢ Target class changes <br>  ‚Ä¢ The need for a weaver to implement something (for example, MarshalByRef) <br><br>  In general, the talk will be about pure managed code that can be run on .Net 1.1 (in general, I use a little Linq, but you can easily get rid of it) and intercept everything that comes into your head. <br><br>  Clarify finally.  With the help of this technique: <br>  ‚Ä¢ You can intercept constructs such as System.DateTime.Now and System.IO.File! <br>  ‚Ä¢ You will not have the usual restrictions specific to all popular interception libraries. <br>  Still in doubt?  Then read on! <br><br><h4>  Principles of AOP </h4><br><h4>  Introductory </h4><br>  Some may think that their path of knowledge of Object Oriented Programming is not yet complete, and does it make sense to switch from OOP to AOP, abandoning all the practices studied during the years of hard learning?  The answer is simple: do not switch.  No opposition to the PLO and AOP!  AOP is a concept whose name, in my opinion, is misleading.  Understanding the principles of AOP requires you to work with classes, objects, inheritance, polymorphism, abstractions, etc., because you can‚Äôt manage to lose everything that you use in OOP. <br><br>  In ancient times, when the Internet consisted of yellow pages, bulletin boards, and juznet, it was best to read books to study something (a note for a new generation: a book is a thing consisting of stitched together paper sheets containing text).  And almost all of these books constantly reminded you of the following OOP rules: <br>  ‚Ä¢ Rule # 1: Encapsulation of data and code is necessary. <br>  ‚Ä¢ Rule number 2: never break Rule number 1 <br><br>  Encapsulation was the main purpose for which OOP appeared in 3rd generation languages ‚Äã‚Äã(3GL). <br><br>  From wiki: <br><blockquote>  Encapsulation is used to support two similar, but different, requirements and, sometimes, to their combination: <br>  ‚Ä¢ Restriction of access to some components of the object. <br>  ‚Ä¢ A language construct that makes it easy to combine data with methods (or other functions) that work with this data. <br></blockquote><br><br>  AOP, in general, argues that sometimes a language construct is required that facilitates combining methods (or other functions) that work with encapsulated data without this data. <br><br>  Got it?  Actually, this is all you need from theory.  Fine! <br><br>  Now, let's move on to the two questions that have appeared: <br>  ‚Ä¢ When is it ‚Äúsometimes‚Äù? <br>  ‚Ä¢ Why is this needed? <br><br><h4>  About the benefits of AOP ... some scenarios </h4><br><h5>  Scenario A </h5><br>  You are a developer in a bank.  The bank works fine system.  Business is stable.  The government issues a decree requiring more transparency from banks.  With any movement of funds to or from the bank, this action must be recorded.  Also in the government they say that this is only the first step on the path to transparency, there will be more. <br><br><h5>  Scenario B </h5><br>  Your web application is issued to the tester team.  All functional tests passed, and the application broke down on the load test.  There is a non-functional requirement saying that no page can be processed on the server for more than 500 ms.  After analyzing, you found dozens of queries to the database, which can be avoided by caching the results. <br><br><h5>  Scenario B </h5><br>  You have been building a domain model for two years into an ideal library containing 200+ classes.  Later, you will learn that a new front-end is being written for the application and you need to associate all your objects with the UI.  But to solve the problem, it is necessary that all classes implement INotifyPropertyChanged. <br><br>  These examples demonstrate where AOP can be a salvation.  All of these scenarios are similar in the following: <br><br><h5>  Cross-cutting concern </h5><br>  When is it "sometimes"? <br><br>  Some classes (banking system, data access services, domain-model) need to get functionality, which, in general, is not ‚Äútheir business‚Äù. <br><br>  ‚Ä¢ The business of the banking system is to transfer money.  Logging operations wants the government. <br>  ‚Ä¢ A data access service is needed to get data.  Data caching is a non-functional requirement. <br>  ‚Ä¢ Classes of the domain model implement the business logic of your company.  Notifying the UI of a property change is required only by the UI <br><br>  In general, we are talking about situations when you need to write code for various classes to solve problems not related to these classes.  Speaking in the AOP dialect, action is needed. <br><br>  Understanding the actions being implemented is key to AOP.  There are no actions to implement - there is no need for AOP. <br><br>  Why do you need it? <br>  Let's take a closer look at Scenario B. <br><br>  The problem is that you have, say, an average of 5 properties in each class.  Having 200+ classes, you have to implement (copy) more than 1000 sample pieces of code to turn something like this: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  Something like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> : <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanged</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> PropertyChangedEventHandler PropertyChanged; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Name; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != _Name) { _Name = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; SignalPropertyChanged(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignalPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propertyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pcEvent = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PropertyChanged; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pcEvent != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pcEvent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedEventArgs(propertyName)); } }</code> </pre><br><br>  Wow!  And this is only one property!  By the way, do you know?  Intern retired a couple of days ago <br><br>  It is necessary ‚Äúto combine methods (or other functions) working with encapsulated data, without this data‚Äù.  In other words: implement the implementation of INotifyPropertyChanged actions without changing or with minimal changes to the classes of the domain model of the type Customer. <br><br>  If we can do this, then we will get: <br>  ‚Ä¢ Clear separation of actions <br>  ‚Ä¢ Avoid code repetition and speed up development <br>  ‚Ä¢ We will not hide domain classes under tons of sample code. <br><br>  Great.  But how to do all this? <br><br><h5>  Theoretical answer </h5><br>  We have an injected action that must be performed in several classes (hereinafter referred to as the goals).  An implementation (code that implements logging, caching, or something else) is called an AOP action. <br><br>  Next, we need to attach (embed, embed, select your word) action (I will repeat, because it is important: the action is the implementation of the action being implemented) at any place we want the goal.  And we should be able to choose any of the following target locations for the implementation of the action: <br>  ‚Ä¢ Static initializers <br>  ‚Ä¢ Constructors <br>  ‚Ä¢ Reading and writing static properties <br>  ‚Ä¢ Reading and writing instance properties <br>  ‚Ä¢ Static methods <br>  ‚Ä¢ instance methods <br>  ‚Ä¢ Destructors <br><br>  In ideal AOP, we should be able to inject an action into any line of the goal code. <br>  Great, but if we need to attach an action, do we need an interceptor in the target?  Yes, CEP! <br><br>  In AOP, the description of the interceptor (the place where the action will be performed) has the name: pointcut.  And the place where the code actually binds: the junction point. <br><br>  Clear?  Maybe not ... Here is a bit of pseudocode, which I hope will explain: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  class BankAccount { public string AccountNumber {get;} public int Balance {get; set;} void Withdraw(int AmountToWithdraw) { :public pointcut1; //  ( ,   -    ) Balance -= AmountToWithdraw; } } //   concern LoggingConcern { void LogWithdraw(int AmountToWithdraw) { //   ,     //  'this' ‚Äì    BankAccount. Console.WriteLine(this.AccountNumber + " withdrawal on-going..."); } } class Program { void Main() { //        pointcut = typeof(Bank).GetPointcut("pointcut1"); //     LoggingConcern.Join(cutpoint, LogWithdraw); //        , //    LoggingConcern   pointcut1  } }</span></span></code> </pre><br>  Would it be cool to have such a mechanism in C # right out of the box ??? <br><br><h5>  Some more concepts </h5><br>  Before we go further to our implementation, we will give a few more concepts ... <br><br>  What is an Aspect? <br>  This is a combination of action, cut and point of connection. <br><br>  Ponder this for a minute, and, I hope, everything will fall into place: there is a logging mechanism (action) that registers its logging method for execution (connection point) in the specified location (section) of my application.  All this together is an aspect of my application. <br><br>  But just a minute ... What should and can the action do after implementation? <br><br>  Actions are divided into two categories: <br><br>  Side effects. <br>  A side effect is an action that does not change the action of the code in the slice.  A side effect is simply adding a certain command to execute. <br>  The logging action is a good side effect.  When the environment executes the target method (for example, Bank.Withdraw (int Amount)), the LoggingConcern.LogWithdraw (int Amount) method will be executed and the Bank.Withdraw (int Amount) method will continue its execution. <br><br>  Tips. <br>  Tips - actions that can change the method input / output. <br>  Action caching is a great example.  When the target method is executed (for example, CustomerService.GetById (int Id)), the method CachingConcern.TryGetCustomerById (int Id) is executed and returns the value found in the cache, or continues execution if it is not present. <br><br>  Advice can be: <br>  ‚Ä¢ Check the parameters in the cut of the goal and the ability to change them if necessary <br>  ‚Ä¢ Cancel target methods and replace them with a different implementation. <br>  ‚Ä¢ Check the return value of the target method and change or replace them. <br><br>  Are you still reading?  Bravo!  Parce que vous le valez bien ... <br><br>  This concludes with the concepts and concepts of AOP.  Let's take a closer look at C #. <br><br><h4>  Our implementation </h4><br><h5>  Show me the code u je tue le chien! </h5><br><h6>  Actions (concern) </h6><br>  The action must implement the magic of this, which refers to the type of our goal. <br>  No problemo! <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IConcern</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { T This { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//  ,   ? }</span></span></code> </pre><br><br><h6>  Pointcuts </h6><br>  There is no easy way to get cuts for each line of code.  But one by one, we can still get it and it's pretty simple using the System.Reflection.MethodBase class.  MSDN is not verbose about it: Provides information about methods and constructors. <br><br>  Between us, using MethodBase to get links to slices is the most powerful possible tool in our task. <br>  You can get access to slices of constructors, methods, properties and events, because practically everything that you declare in .Net ultimately comes down to the method ... <br><br>  See for yourself: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;EventArgs&gt; NameChanged; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newName</span></span></span><span class="hljs-function">)</span></span> { Name = newName; NameChanged(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EventArgs.Empty); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Customer); <span class="hljs-comment"><span class="hljs-comment">//  (  ) var pointcut1 = t.GetConstructor(new Type[] { }); //  ChangeName var pointcut2 = t.GetMethod("ChangeName"); //  Name var nameProperty = t.GetProperty("Name"); var pointcut3 = nameProperty.GetGetMethod(); var pointcut4 = nameProperty.GetSetMethod(); //     NameChanged var NameChangedEvent = t.GetEvent("NameChanged"); var pointcut5 = NameChangedEvent.GetRaiseMethod(); var pointcut6 = NameChangedEvent.GetAddMethod(); var pointcut7 = NameChangedEvent.GetRemoveMethod(); } }</span></span></code> </pre><br><br><h6>  Join points </h6><br>  Writing the connection code is really simple.  Look at this code: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Join</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Reflection.MethodBase pointcutMethod, System.Reflection.MethodBase concernMethod</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  We can add it to something like the registry, which we will do later, and we can start writing code like this !!! <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoYourOwnBusiness</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { System.Diagnostics.Trace.WriteLine(Name + <span class="hljs-string"><span class="hljs-string">"   "</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoggingConcern</span></span> : <span class="hljs-title"><span class="hljs-title">IConcern</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Customer</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Customer This { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { System.Diagnostics.Trace.WriteLine(This.Name + <span class="hljs-string"><span class="hljs-string">"    "</span></span>); This.DoYourOwnBusiness(); System.Diagnostics.Trace.WriteLine(This.Name + <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)h</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    Customer.DoSomething(); var pointcut1 = typeof(Customer).GetMethod("DoSomething"); var concernMethod = typeof(LoggingConcern).GetMethod("DoSomething"); //   AOP.Registry.Join(pointcut1, concernMethod); } }</span></span></code> </pre><br>  How far have we got from our pseudocode?  In my opinion, not very ... <br>  So what next? <br><br><h5>  Putting it all together ... </h5><br>  This is where problems and fun begin at the same time! <br>  But let's start with a simple <br><br><h6>  Registry </h6><br>  The registry will keep records of our connection points.  We take the list-singleton for connection points.  Connection point - simple structure: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Joinpoint { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> MethodBase PointcutMethod; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> MethodBase ConcernMethod; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Joinpoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodBase pointcutMethod, MethodBase concernMethod</span></span></span><span class="hljs-function">)</span></span> { PointcutMethod = pointcutMethod; ConcernMethod = concernMethod; } <span class="hljs-comment"><span class="hljs-comment">//       public static Joinpoint Create(MethodBase pointcutMethod, MethodBase concernMethod) { return new Joinpoint (pointcutMethod, concernMethod); } }</span></span></code> </pre><br>  Nothing special ... He also needs to implement IEquatable, but to make the code shorter, I removed it. <br><br>  And the registry.  The class is called AOP and is singleton.  It provides access to its unique instance through a static property called Registry: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AOP</span></span> : <span class="hljs-title"><span class="hljs-title">List</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Joinpoint</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AOP _registry; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AOP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _registry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AOP(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AOP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AOP Registry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _registry; } } [MethodImpl(MethodImplOptions.Synchronized)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Join</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodBase pointcutMethod, MethodBase concernMethod</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> joinPoint = Joinpoint.Create(pointcutMethod, concernMethod); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Contains(joinPoint)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Add(joinPoint); } }</code> </pre><br><br>  Using the AOP class, you can write the following structure: <br><pre> <code class="cs hljs">AOP.Registry.Join(pointcut, concernMethod);</code> </pre><br><br><h6>  Houston, we have problems </h6><br>  Here we are faced with an obvious and big problem with which to do something.  If the developer writes like this <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer {Name=<span class="hljs-string"><span class="hljs-string">"test"</span></span>}; customer.DoYourOwnBusiness();</code> </pre><br>  there is no reason why you need to access our registry, and our LoggingConcern.DoSomething () method will not start. <br><br>  The trouble is that .Net does not provide us with an easy way to intercept such calls. <br>  Once there is no built-in mechanism, you need to make your own.  The capabilities of your mechanism will determine the capabilities of your AOP implementation. <br>  The purpose of this article is not to discuss all possible interception techniques.  Just note that the interception method is the key difference between AOP implementations. <br><br>  The SharpCrafters site (PostSharp owners) provide some clear information on two main techniques: <br>  ‚Ä¢ Embedding at compile time <br>  ‚Ä¢ Embedding at runtime <br><br><h6>  Our implementation - Proxy </h6><br>  In general, it is no secret that there are three options for intercepting: <br>  ‚Ä¢ Create your own language and compiler to get .net assemblies: when compiling, you can embed anything anywhere. <br>  ‚Ä¢ Implement a solution that changes the behavior of assemblies during execution. <br>  ‚Ä¢ Put between the client and the proxy target that intercepts calls. <br><br>  Note for advanced guys: I deliberately do not consider the features of the debugger and profiler API, as their use is not viable in production. <br><br>  A note for the most advanced: the hybrid of the first and second variants, used in the Raslyn API, can be implemented, but, as I know, is still being done.  A bon entendeur ... <br><br>  Moreover, if you do not need to be able to cut in any line of code, the first two options are too complicated. <br><br>  Let's move on to the third option.  There are two news about the proxy: good and bad. <br>  Bad - during the execution you need to substitute the target for a copy of the gasket.  If you want to intercept constructors, then you have to delegate the creation of instances of target classes to the factory, this implementation cannot embed such actions.  If there is an instance of the target class, you must explicitly request a replacement.  For <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BD%25D1%2582%25D1%2580%25D0%25BE%25D0%25BB%25D1%258F">control inversion</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BD%25D0%25B5%25D0%25B4%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B7%25D0%25B0%25D0%25B2%25D0%25B8%25D1%2581%25D0%25B8%25D0%25BC%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">dependency injection</a> masters, this is not even a task.  For the rest, this means that you have to use the factory to provide all the possibilities in our interception technique.  But do not worry, we will build this factory. <br><br>  The good news is that you don't need to do anything to implement a proxy.  The System.Runtime.Remoting.Proxies.RealProxy class builds it in an optimal way. <br>  In my opinion, the class name does not reflect its purpose.  This class is not a proxy, but an interceptor.  Nevertheless, he will make us a proxy by calling his method GetTransparentProxy (), and this is what we actually need from him. <br><br>  Here is the fish interceptor: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Interceptor</span></span> : <span class="hljs-title"><span class="hljs-title">RealProxy</span></span>, <span class="hljs-title"><span class="hljs-title">IRemotingTypeInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> theTarget { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Interceptor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params">(MarshalByRefObject</span></span></span><span class="hljs-function">))</span></span> { theTarget = target; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> System.Runtime.Remoting.Messaging.<span class="hljs-function"><span class="hljs-function">IMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Runtime.Remoting.Messaging.IMessage msg</span></span></span><span class="hljs-function">)</span></span> { IMethodCallMessage methodMessage = (IMethodCallMessage) msg; MethodBase method = methodMessage.MethodBase; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] arguments = methodMessage.Args; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> returnValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> //     ,  AOP.Registry //     MethodBase,   "method"... //      ,     //   "theTarget"   ... ;-) return new ReturnMessage(returnValue, methodMessage.Args, methodMessage.ArgCount, methodMessage.LogicalCallContext, methodMessage); } #region IRemotingTypeInfo public string TypeName { get; set; } public bool CanCastTo(Type fromType, object o) { return true; } #endregion }</span></span></code> </pre><br>  Some explanations, because  we got to the very heart of realization ... <br><br>  The RealProxy class is designed to intercept calls from remote objects and organize target objects.  Remote should be understood as truly remote: objects from another application, another application domain, another server, etc.).  Without going into details, there are two ways to organize remote objects in the .Net infrastructure: by reference and by value.  Therefore, you can order deleted objects only if they inherit MarshalByRef or implement ISerializable.  We are not going to use the capabilities of remote objects, but nevertheless we need the RealProxy class to think that the target supports remote control.  Because of this, we pass typeof (MarshalByRef) to the constructor RealProxy. <br><br>  RealProxy receives all calls through a transparent proxy using the Invoke method (System.Runtime.Remoting.Messaging.IMessage msg).  It is here that we implement the essence of the substitution of methods.  See comments in the code above. <br><br>  Regarding the implementation of IRemotingTypeInfo: in a real remote environment, the client will request an object from the server.  The client application may not know anything about the type of the object being received.  Accordingly, when a client application calls a public object GetTransparentProxy (), the environment can the returned object (transparent proxy) match the application's contract.  By implementing IRemotingTypeInfo, we give a hint to the client environment which cast is permissible and which is not. <br><br>  Now marvel at the trick we use here. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CanCastTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type fromType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> o</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  All our implementation of AOP is possible solely due to the possibility to write these two words for a remote object: return true.  Which means that we can bring the object returned by GetTransparentProxy () to any interface <b>without any check by the environment !!!!</b> <br><br>  The environment just gives us a go-ahead for any actions! <br>  You can fix this code and return something more reasonable than true for any type ... But you can also imagine how to benefit from the behavior provided by the <a href="http://haacked.com/archive/2009/08/25/method-missing-csharp-4.aspx">Non-Existent Method</a> or intercept the entire interface ... In general, there is quite a lot of space for fantasy ... <br><br>  Now we already have a decent interception mechanism for our target instance.  But we still have no interception of constructors and transparent proxies.  This is a task for the factory ... <br><br><h5>  Factory </h5><br>  To say nothing special.  Here is a fish class. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Create&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] constructorArgs) { T target; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> //   typeof(T)   constructorArgs (-   ) //    ,         //   ,    -     //     ‚Äútarget‚Äù ()   //   GetProxy return GetProxyFor&lt;T&gt;(target); } public static object GetProxyFor&lt;T&gt;(object target = null) { //         // (    ,  ) //        return new Interceptor(target).GetTransparentProxy(); } }</span></span></code> </pre><br>  Note that the Factory class always returns an object of type object.  We cannot return an object of type T simply because a transparent proxy is not of type T, it is of type System.Runtime.Remoting.Proxies .__ TransparentProxy.  But remember the resolution of the given environment, <b>we can bring the returned object to any interface without checking!</b> <br><br>  We will plant the Factory class into our AOP class with the hope that we will pass on a neat code to our customers.  You can see this in the Usage section. <br><br><h5>  Last notes on implementation </h5><br>  If you've read this far, then you are a hero!  Bravissimo!  Kudos! <br><br>  To keep the article concise and understandable (and what's funny?), I will not go into boring arguments about the details of the implementation of the get and switch methods.  This is nothing interesting.  But if you are still interested: download the code and see - it is fully working!  The names of classes and methods may differ slightly, because  I ruled it in parallel, but there should be no special changes. <br><br><blockquote>  <b>Attention!</b>  Before using the code in your project, carefully read the <a href="http://en.wiktionary.org/wiki/paenultimus">paenultimus</a> .  And if you do not know what paenultimus means, click on the link. </blockquote><br><br><h5>  Using </h5><br>  I have already written a lot of things, but still have not shown what to do with all this.  And here it is the moment of truth! <br><br><h6>  What is in the archive ( <a href="">download</a> ) </h6><br>  The archive includes 5 examples demonstrating the implementation of the following aspects: <br>  ‚Ä¢ Interception Designer <br>  ‚Ä¢ Interception of methods and properties <br>  ‚Ä¢ Interception of events <br>  ‚Ä¢ Interception of initialization of types <br>  ‚Ä¢ Interception File.ReadAllText (string path) <br><br>  And here I will demonstrate two of the five: the most and the least obvious. <br><br><h6>  Interception of methods and properties </h6><br>  First, we need a domain model.  Nothing special. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IActor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Act</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Actor</span></span> : <span class="hljs-title"><span class="hljs-title">IActor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Act</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"My name is '{0}'. I am such a good actor!"</span></span>, Name); } }</code> </pre><br><br>  Now we need an action <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TheConcern</span></span> : <span class="hljs-title"><span class="hljs-title">IConcern</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Actor</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Actor This { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { This.Name = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> + <span class="hljs-string"><span class="hljs-string">". Hi, "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> + <span class="hljs-string"><span class="hljs-string">" you've been hacked"</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Act</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { This.Act(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"You think so...!"</span></span>); } }</code> </pre><br><br>  When we initialize the application, we inform the registry about our connection points. <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Weave the Name property setter AOP.Registry.Join ( typeof(Actor).GetProperty("Name").GetSetMethod(), typeof(TheConcern).GetProperty("Name").GetSetMethod() ); // Weave the Act method AOP.Registry.Join ( typeof(Actor).GetMethod("Act"), typeof(TheConcern).GetMethod("Act") );</span></span></code> </pre><br><br>  And finally, we create an object in the factory. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actor1 = (IActor) AOP.Factory.Create&lt;Actor&gt;(); actor1.Name = <span class="hljs-string"><span class="hljs-string">"the Dude"</span></span>; actor1.Act();</code> </pre><br>  Please note that we have requested the creation of the class Actor, but we can bring the result to the interface, therefore we will lead to the IActor, since  the class implements it. <br><br>  If you run all this in a console application, we get: <br> <code>My name is 'the Dude. Hi, the Dude you've been hacked'. I am such a good actor! <br> You think so...! <br></code> <br><br><h6>  Interception File.ReadAllText (string path) </h6><br>  Here are two minor problems: <br>  ‚Ä¢ File class static <br>  ‚Ä¢ and does not implement any interfaces <br><br>  Remember the "good"?  The medium does not check the type returned by the proxy and its correspondence to the interface. <br>  So we can create any interface.  No one realizes it neither the goal nor the action.  In general, we use the interface as a contract. <br>  Let's create an interface that pretends to be a static File class. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IFile</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadAllLines</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br>  Our action <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TheConcern</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadAllLines</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> File.ReadAllLines(path).Select(x =&gt; x + <span class="hljs-string"><span class="hljs-string">" hacked..."</span></span>).ToArray(); } }</code> </pre><br><br>  Registration of connection points <br><pre> <code class="cs hljs">AOP.Registry.Join ( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(File).GetMethods().Where(x =&gt; x.Name == <span class="hljs-string"><span class="hljs-string">"ReadAllLines"</span></span> &amp;&amp; x.GetParameters().Count() == <span class="hljs-number"><span class="hljs-number">1</span></span>).First(), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TheConcern).GetMethod(<span class="hljs-string"><span class="hljs-string">"ReadAllLines"</span></span>) );</code> </pre><br><br>  And finally, the execution of the program <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = Path.Combine(Environment.CurrentDirectory, <span class="hljs-string"><span class="hljs-string">"Examples"</span></span>, <span class="hljs-string"><span class="hljs-string">"data.txt"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = (IFile) AOP.Factory.Create(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(File)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> file.ReadAllLines(path)) Console.WriteLine(s);</code> </pre><br><br>  In this example, note that we cannot use the Factory.Create method, since  static types cannot be used as arguments. <br><br><h4>  Links </h4><br>  Without any special order. <br>  ‚Ä¢ <a href="http://www.qi4j.org/ten-minutes-intro.html">Tutorials from Qi4j</a> <br>  ‚Ä¢ <a href="http://msdn.microsoft.com/en-us/library/vstudio/scx1w94y(v%3Dvs.100).aspx">Extending RealProxy</a> <br>  ‚Ä¢ <a href="http://kozmic.pl/dynamic-proxy-tutorial/">Dynamic Proxy Tutorial (Castle.net)</a> <br>  ‚Ä¢ <a href="http://www.codeproject.com/Articles/20884/Introducing-the-LinFu-Framework-Part-I-LinFu-Dynam">LinFu.DynamicProxy: A Lightweight Proxy Generator</a> <br>  ‚Ä¢ <a href="http://www.codeproject.com/Articles/114178/Add-Aspects-to-Object-Using-Dynamic-Decorator">Add aspects using Dynamic Decorator</a> <br>  ‚Ä¢ <a href="http://www.dolittle.com/blogs/einar/archive/2008/02/10/implementing-a-clr-profiler-to-act-as-an-aop-interceptor-part-1.aspx">Implementing a CLR Profiler to act as an AOP interceptor</a> <br>  ‚Ä¢ <a href="http://geekswithblogs.net/imilovanovic/archive/2004/09/23/11589.aspx">Intercepting the .Net</a> <br>  ‚Ä¢ <a href="http://www.codeproject.com/Articles/42474/AspectF-Fluent-Way-to-Add-Aspects-for-Cleaner-Main">AspectF Fluent Way To Add Aspects for Cleaner Maintainable Code</a> <br><br><h4>  What's next? </h4><br>  We were able to achieve the main goal of AOP: to realize the aspect and register it for execution.  TinyAOP was born.  But your path in the lands of AOP is not finished yet, and you may want to go deeper. <br><br>  <b>Reason 1:</b> Who wants to register connection points the way we do now?  Not to me for sure!  It is a little analysis and you can make it more practical and similar to a real AOP library.  AOP is needed to simplify life, not create a headache. <br><br>  <b>Reason 2: The</b> themes of <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BC%25D0%25B5%25D1%2581%25D1%258C_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">impurities</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B3%25D1%2580%25D0%25B5%25D0%25B3%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">aggregation</a> are not disclosed at all, and from them you can expect a lot of good things. <br><br>  <b>Reason 3:</b> We need performance and stability.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the code is just a proof of the concept's performance. </font><font style="vertical-align: inherit;">It is rather slow and can be made very fast. </font><font style="vertical-align: inherit;">Error checking also does not hurt. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reason 4:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We intercept almost all classes, but what about intercepting interfaces? </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reason 5:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You still have few reasons?</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have a good and compact prototype that demonstrates the technical feasibility of implementing AOP in a clean, managed code without stitching, etc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you know about AOP, you can write your own implementation.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here the translator is introduced and begins to carry gag </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although I fully agree with the author about this section. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sites like habahabr.ru, codeproject.com and the like exist only because different people publish articles on them. </font><font style="vertical-align: inherit;">It doesn't matter why they do it, but this work is being done. </font><font style="vertical-align: inherit;">Please do not neglect the authors. </font><font style="vertical-align: inherit;">If you do not like the article, explain in the comments what is wrong. </font><font style="vertical-align: inherit;">If you just minus, no one will know how to do better. </font><font style="vertical-align: inherit;">If you like, also do not be silent!</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And now for sure the gag of the translator </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, to my surprise, it was impossible to translate many words from AOP, so I propose in the comments to propose good and understandable Russian words for the following terms: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Ä¢ Aspect (it‚Äôs understandable here, but still) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Ä¢ Concern </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Ä¢ Joinpoint </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Ä¢ Cross-cutting </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Ä¢ Weaving ( viver - nothing, but it would be better to find the Russian word) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Author: </font></font><a href="http://www.codeproject.com/Articles/479302/Aspect-Oriented-Programming-learn-step-by-step-and"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guirec Le Bars</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/199378/">https://habr.com/ru/post/199378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199368/index.html">How does a robot vacuum cleaner?</a></li>
<li><a href="../199370/index.html">How we made friends with PayPal</a></li>
<li><a href="../199372/index.html">Events that influenced your childhood development</a></li>
<li><a href="../199374/index.html">What is Hackspace?</a></li>
<li><a href="../199376/index.html">IPv4 inventory depletion: what's really going on and how does REG.RU do it</a></li>
<li><a href="../199380/index.html">What's new in Direct3D 11.2</a></li>
<li><a href="../199384/index.html">Data Lab</a></li>
<li><a href="../199386/index.html">What is missing from COLT / JS to start using it?</a></li>
<li><a href="../199388/index.html">Ubuntu gaming performance is almost on par with Windows 8.1</a></li>
<li><a href="../199392/index.html">ICAgile Certified Professional certification class in Kiev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>