<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grid implementation for working with large tables. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A table (grid) with a vertical scroll bar is the most common user interface element for working with data from a relational database. However, the dif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grid implementation for working with large tables. Part 1</h1><div class="post__text post__text-html js-mediator-article">  A table (grid) with a vertical scroll bar is the most common user interface element for working with data from a relational database.  However, the difficulties are encountered that are encountered when the table contains so many entries that the tactics of their complete reading and storage in the operational memory becomes unreasonable. <br><br>  Some applications on large tables are not calculated and ‚Äúfreeze‚Äù when you try to open a table with millions of records for viewing / editing.  Others refuse to use the vertical scroll bar in favor of paging or offer the user only the illusion that you can quickly jump to the desired (at least to the latest) entry with the scroll bar. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/96f/a46/da1/96fa46da1a724434b1b5aa2c32853d68.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will talk about one of the possible methods for implementing a tabular control that has the properties of Log (N) -fast 1) initial display 2) scrolling over the entire range of records 3) switching to a record with a given unique key.  All this - with two restrictions: 1) records can be sorted only by the indexed set of fields and 2) the database collation rules should be known to the algorithm. <br><br>  The principles outlined in the article were implemented by the author in a project with his participation in the Java language. <br><br><a name="habracut"></a><br><br><h3>  The basic principle </h3><br><br>  The two key functionalities of the table control (grid) are <br><ol><li>  <b>scroll</b> - Displays entries corresponding to the position of the scroll bar, </li><li>  <b>Jump</b> to the record specified by the combination of key fields. </li></ol><br>  First, we consider the simplest approaches to their implementation and show why they are unsuitable in the case of a large number of records. <br><br>  The most straightforward approach is to read all the records into the RAM (or at least their primary keys), after which the scrolling is done by selecting the array segment, and the positioning is done by searching the record in the array.  But with a large number of records, firstly, the process of initial loading of the array takes too much time and, as a result, the display of the grid on the screen is delayed, and secondly, these tables start to take up memory, which reduces the overall speed. <br><br>  Another approach is to ‚Äúshift‚Äù the calculations to the DBMS: the selection of records for display in the scrolling window is carried out using the constructions like <a href="http://www.postgresql.org/docs/current/static/queries-limit.html">select ... limit ... offset ...</a> , positioning - reduce to select ... and count (*).  However, both offset and count (*) are associated with enumerating the records inside the server, they generally have O (N) execution speed, and therefore are inefficient with a large number of records.  Calling them often leads to an overload of the database server. <br><br>  So, we need to implement a system that would not require the full downloading of data into memory and at the same time would not overload the server with inefficiently running queries.  To do this, we understand which queries are effective and which are not. <br><br>  Provided that an index is built across the <b>k</b> field, the following queries are fast (they use the index lookup and are executed during Log (N)): <br><ol><li>  <b>Query A.</b> Find the first and last entry in the dataset: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> k [<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li><li>  <b>Request B.</b> Find the h of the first entries with a key greater than or equal to the given value of K: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> k &gt;= K <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> h</code> </pre> </li></ol>  A remarkable property of query <b>B</b> is that, as a parameter, it does not have to substitute the key for an existing record in the database: it equally quickly finds both the record by its primary key and the record closest to the specified key.  We will actively use this. <br><br>  The following queries are not fast: <br><ol><li>  <b>Query C</b> Calculate the total number of records in the dataset: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) ...</code> </pre> </li><li>  <b>Request D.</b> Count the number of records preceding the record with a key greater than or equal to this one: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> &lt; K</code> </pre> </li></ol>  Requests <b>B</b> and <b>D</b> can be generalized to the case of sorting by a set of several fields order by k1, k2, k3 ... provided that a composite index is built on these fields.  The condition k&gt; = K should be generalized to a logical condition for comparing several values ‚Äã‚Äãin the <a href="https://en.wikipedia.org/wiki/Lexicographical_order">lexicographical order</a> : <pre> <code class="sql hljs">where k1 &gt;= K1 and (k1 &gt; K1 or (k2 &gt;= K_2 and (k2 &gt; K2 or ...)))</code> </pre>  <b>The basic principle is that in procedures that require a quick response for the user, only quick queries to the database are dispensed with.</b> <b><br></b> <br><br><h3>  "Guessing" the dependence of the primary key on the record number </h3><br><br>  For the time being, imagine that the primary key of our table has only one integer field (hereinafter, we will remove this restriction). <br><br>  Let each position of the scroll bar correspond to an integer from 0 to <img src="http://tex.s2cms.ru/svg/%5Cinline%20N-h">  where <img src="http://tex.s2cms.ru/svg/%5Cinline%20N">  - total number of records in the table, <img src="http://tex.s2cms.ru/svg/%5Cinline%20h">  - the number of lines that fit on one page in the grid.  If the scroll bar is set to <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  then this means that when drawing the grid you should skip <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  first entries in the table and then output <img src="http://tex.s2cms.ru/svg/%5Cinline%20h">  records.  This is exactly what the keywords offset and limit in PostgreSQL are responsible for, and with a large number of records we cannot use them.  But if in some ‚Äúmagic‚Äù way we could be able to calculate the function <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%3Df%28k%29">  and its inverse function <img src="http://tex.s2cms.ru/svg/%5Cinline%20k%3Df%5E%7B-1%7D%28%5Clambda%29">  that connects the primary key and the number of records with a key smaller than this one, then using query <b>B</b> , substituting the value <img src="http://tex.s2cms.ru/svg/%5Cinline%20f%5E%7B-1%7D%28%5Clambda%29">  , we could quickly get a set of records to display to the user.  The task of moving to the desired record would be solved in the following way: since the primary key is known in advance, it can immediately be used as a parameter of quick query <b>B</b> , and the scroll bar should be set to <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%3Df%28k%29">  .  The task would be solved! <br><br>  (Note that the query <b>D</b> , called with the parameter k, just returns the value <img src="http://tex.s2cms.ru/svg/%5Cinlinef%28k%29">  but 1) it is slow and 2) we need to be able to calculate how <img src="http://tex.s2cms.ru/svg/%5Cinlinef%28k%29">  , and the opposite to her.) <br><br>  Naturally, the function <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  completely determined by the data in the table, therefore, in order to accurately restore the interdependence of key values ‚Äã‚Äãand record numbers, it is necessary to read all the keys from the database into main memory <u>through one</u> : for a correct response of query <b>B</b> at intermediate points, we can assume that <img src="http://tex.s2cms.ru/svg/%5Cinline%20f%5E%7B-1%7D%282n%2B1%29%20%3D%20f%5E%7B-1%7D%282n%29%2B1">  (recall the remarkable property of query <b>B</b> ).  This is better than remembering all keys in a row, but still not good enough, because it requires O (N) time and RAM to initially display the table.  Fortunately, you can get by with a much smaller value of exactly known points for the function <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  and in order to understand this, we will need a small combinatorial analysis of possible values <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  . <br><br>  Let us execute the query <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(k), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(k), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foo</code> </pre>  and got the results: 0, 60, 7. That is, we now know that there are only 7 records in our table (and this means the maximum value <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  equal to 6), the first of the entries has the key 0, and the last - the key 60. With one such query, we actually learned the values <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  <u>in three points</u> : <img src="http://tex.s2cms.ru/svg/%5Cinline%20f%280%29%20%3D%200">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20f%281%29%20%3D%201">  and <img src="http://tex.s2cms.ru/svg/%5Cinline%20f%2860%29%3D6">  .  And that's not all, because from the definition itself <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  follows that: <br><ol><li><img src="http://tex.s2cms.ru/svg/%5Cinline%20f%28k%29">  monotonously grows </li><li>  while increasing <img src="http://tex.s2cms.ru/svg/%5Cinline%20k">  per unit <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  increases by one or not increases, so the function graph <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  except point <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%2C%200%29">  , entirely in parallelogram <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%20%2B%201%2C%201%29">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%2B%5Clambda_%7B%5Cmax%7D%2C%20%5Clambda_%7B%5Cmax%7D%29">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmax%7D%2C%20%5Clambda_%7B%5Cmax%7D%29">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmax%7D%20-%20%5Clambda_%7B%5Cmax%7D%20%2B%201%2C%201%29">  , </li><li>  total number of possible functions <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  equal to the <a href="https://en.wikipedia.org/wiki/Combination">number of distribution methods</a> <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda_%7B%5Cmax%7D%20-%201">  records by <img src="http://tex.s2cms.ru/svg/%5Cinline%20k_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%201">  key values ‚Äã‚Äã(the positions of the first and last entries are fixed), i.e. <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%20%5Clabel%7Beq%3Atotalfuncnum%7DF%20%3D%20%5Cbinom%7Bk_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%201%7D%7B%5Clambda_%7B%5Cmax%7D%20-%201%7D"></div><br></li><li>  number of possible functions <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  which are at <img src="http://tex.s2cms.ru/svg/%5Cinline%20k">  take on meaning <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  , is determined by the product of the number of combinations of records with a key less than <img src="http://tex.s2cms.ru/svg/%5Cinline%20k">  and greater or equal <img src="http://tex.s2cms.ru/svg/%5Cinline%20k">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/F_%7Bk%2C%5Clambda%7D%3D%5Cbinom%7Bk%20-%20k_%7B%5Cmin%7D%20-%201%7D%7B%5Clambda%20-%201%7D%5Cbinom%7Bk_%7B%5Cmax%7D%20-%20%28k%20-%20k_%7B%5Cmin%7D%29%7D%7B%20%5Clambda_%7B%5Cmax%7D%20-%20%5Clambda%7D"></div><br></li></ol><br><br>  Thus, if each of the possible options is considered equiprobable, then the probability that for a given value <img src="http://tex.s2cms.ru/svg/%5Cinline%20k" alt="inline_formula">  there is exactly <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda" alt="inline_formula">  records with a key strictly smaller <img src="http://tex.s2cms.ru/svg/%5Cinline%20k" alt="inline_formula">  given by the relationship <img src="http://tex.s2cms.ru/svg/%5Cinline%20F_%7Bk%2C%5Clambda%7D%2FF" alt="inline_formula">  known as the <b><a href="https://en.wikipedia.org/wiki/Hypergeometric_distribution">hypergeometric distribution</a></b> .  For <img src="http://tex.s2cms.ru/svg/%5Cinline%20k_%7B%5Cmax%7D%3D60" alt="inline_formula">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda_%7B%5Cmax%7D%3D6" alt="inline_formula">  the picture looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d16/dad/f02/d16dadf022d24ceeb94462df891ccf05.png"></div><br><br>  The properties of the hypergeometric distribution are well known.  When <img src="http://tex.s2cms.ru/svg/%5Cinline%20k%3Dk_%7B%5Cmin%7D" alt="inline_formula">  is always <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%20%3D%200" alt="inline_formula">  and in the segment <img src="http://tex.s2cms.ru/svg/%5Cinline%20k%3D%28k_%7B%5Cmin%7D%20%2B%201%29%5Cldots%20k_%7B%5Cmax%7D" alt="inline_formula">  average value <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda" alt="inline_formula">  linearly dependent on k: <br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%5Coverline%7B%5Clambda%7D%20%3D%20%5Cfrac%7B%28%5Clambda_%7B%5Cmax%7D%20-%201%29%28k%20-%20k_%7B%5Cmin%7D%20-%201%29%7D%7Bk_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%201%7D%20%2B%201%0A"></div><br><br>  Value variance <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  has the shape of an inverted parabola with zeros at the edges of the segment <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%20%2B%201%29%5Cldots%20k_%7B%5Cmax%7D">  and maximum in the middle <br><div class="spoiler">  <b class="spoiler_title">ugly formula</b> <div class="spoiler_text"><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0AD_%5Clambda%20%3D%20%5Cfrac%7B%28%5Clambda_%7B%5Cmax%7D%20-%201%29%28k%20-%20k_%7B%5Cmin%7D%20-%201%29%28k_%7B%5Cmax%7D%20-%20k%29%28k_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%20%5Clambda_%7B%5Cmax%7D%29%7D%7B%28k_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%201%29%5E2%28k_%7B%5Cmax%7D%20-%20k_%7B%5Cmin%7D%20-%202%29%7D%20%0A"></div><br></div></div>  (It can be roughly considered that the average error is less than <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Cfrac%7B1%7D%7B2%7D%5Csqrt%7B%5Clambda_%7B%5Cmax%7D-1%7D" alt="inline_formula">  .) <br><br>  The calculation of the values ‚Äã‚Äãfor the above formulas for <img src="http://tex.s2cms.ru/svg/%5Cinline%20k_%7B%5Cmax%7D%3D60">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda_%7B%5Cmax%7D%3D6">  shows such a picture for possible minimum and maximum (red lines), average (blue line) values <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  , as well as the limits of the standard deviation (gray area): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d6b/5df/a31/d6b5dfa3161848f6911da3f689d76d39.png" width="500"></div><br><br>  So, the <b>polyline, built between the points</b> <b><img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%2C%200%29"></b>  <b>,</b> <b><img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmin%7D%20%2B%201%2C%201%29"></b>  <b>and</b> <b><img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k_%7B%5Cmax%7D%2C%20%5Clambda_%7B%5Cmax%7D%29"></b>  <b>is a statistically valid approximation for calculating a function</b> <b><img src="http://tex.s2cms.ru/svg/%5Cinline%20f"></b>  <b>and reverse</b> <b><img src="http://tex.s2cms.ru/svg/%5Cinline%20f%5E%7B-1%7D"></b>  , and this approximation allows us to quite accurately ‚Äúguess‚Äù the values ‚Äã‚Äãof a function, even if all we know about it is its values ‚Äã‚Äãat three points, obtained with a single query.  In fact, we, for "guessing", perform the first iteration of the <a href="https://en.wikipedia.org/wiki/Interpolation_search">interpolation search</a> algorithm, only by accurately determining the boundary values. <br><br>  If now for some <img src="http://tex.s2cms.ru/svg/%5Cinline%20k%27">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20k_%7B%5Cmin%7D%20%3C%20k%27%20%3C%20k_%7B%5Cmax%7D">  new exact value will be known <img src="http://tex.s2cms.ru/svg/%5Cinline%200%20%3C%20%5Clambda%27%20%3C%20%5Clambda_%7B%5Cmax%7D">  we can add a couple <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28k%27%2C%20%5Clambda%27%29">  to the interpolation table and using piecewise interpolation to obtain a refined calculation of the value <img src="http://tex.s2cms.ru/svg/%5Cinline%20k%28%5Clambda%29">  to solve the scrolling problem, and applying the inverse piecewise interpolation, calculate the refined value <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%28k%29">  in solving the problem of positioning.  With each accumulated point, the range of possible discrepancies will be narrowed, and we will get an increasingly accurate picture for the function <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  . <br><br><h3>  If there are several key fields and data types are not INT </h3><br><br>  In practice, the case is not limited to a single integer field for sorting the data set.  First, the data type can be different: string, date, and so on.  Secondly, there can be several sortable fields.  This difficulty is eliminated if we are able to calculate <br><br><ol><li>  numbering function <img src="http://tex.s2cms.ru/svg/%5Cinline%20g%28K_1%2C%5Cldots%20K_n%29%3D%5Ckappa" alt="inline_formula">  which translates a set of field values ‚Äã‚Äãof arbitrary types into a natural number, </li><li>  inverse function <img src="http://tex.s2cms.ru/svg/%5Cinline%20g%5E%7B-1%7D%28%5Ckappa%29%3D%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  which takes the natural number back to the set of field values, <img src="http://tex.s2cms.ru/svg/%5Cinline%20g%5E%7B-1%7Dg%28K_1%2C%5Cldots%20K_n%29%3D%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  . </li></ol><br>  The numbering function must have the property that if the set <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  less set <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K%27_1%2C%5Cldots%20K%27_n%29" alt="inline_formula">  in the sense of a lexicographic order, then it should be <img src="http://tex.s2cms.ru/svg/%5Cinline%20g%28K_1%2C%5Cldots%20K_n%29%20%3C%20g%28K%27_1%2C%5Cldots%20K%27_n%29">  . <br><br>  Speaking the language of mathematics, bijection <img src="http://tex.s2cms.ru/svg/%5Cinline%20g" alt="inline_formula">  must establish <a href="https://en.wikipedia.org/wiki/Order_isomorphism">an order isomorphism</a> between the set of possible values ‚Äã‚Äãof sets of fields and the set of natural numbers.  Note: in order for the search task to be suitable <img src="http://tex.s2cms.ru/svg/%5Cinline%20g" alt="inline_formula">  was mathematically solvable, it is important that the sets of possible field values <img src="http://tex.s2cms.ru/svg/%5Cinline%20K_i" alt="inline_formula">  were finite.  For example, it is impossible to construct an order isomorphism between the set of all lexicographically ordered pairs of natural (pairs of real) numbers and the set of natural (real) numbers.  Of course, the set of all possible values ‚Äã‚Äãof any machine data type is finite, although very large. <br><br>  To represent values <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa" alt="inline_formula">  standard 32-bit and 64-bit integer types are not suitable: so that one can count only various possible 10-byte strings, a 64-bit (8-byte) integer is not enough.  In our implementation, we used the <a href="https://docs.oracle.com/javase/8/docs/api/java/math/BigInteger.html">java.math.BigInteger</a> class, which is capable of representing integers of arbitrary size.  At the same time, the amount of RAM occupied by the value <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa" alt="inline_formula">  , approximately equal to the volume occupied by the set of values <img src="http://tex.s2cms.ru/svg/%5Cinline%20K_1%2C%5Cldots%20K_n">  . <br><br>  With a reversible numbering function <img src="http://tex.s2cms.ru/svg/%5Cinline%20g" alt="inline_formula">  and reversible interpolator function <img src="http://tex.s2cms.ru/svg/%5Cinline%20f" alt="inline_formula">  , <br><br><ul><li>  <b>scrolling the</b> grid is reduced to calculating the values ‚Äã‚Äãof key fields <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29%3Dg%5E%7B-1%7D%28f%5E%7B-1%7D%28%5Clambda%29%29" alt="inline_formula">  where <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda" alt="inline_formula">  - the position of the vertical scroll bar, after which a quick query to the database finds <img src="http://tex.s2cms.ru/svg/%5Cinline%20h" alt="inline_formula">  first records, greater or equal <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  , </li><li>  <b>positioning</b> is reduced to reading <img src="http://tex.s2cms.ru/svg/%5Cinline%20h" alt="inline_formula">  the first records from the database by the previously known values <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  , and to calculate the position of the scroll bar <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%20%3D%20f%28g%28K_1%2C%5Cldots%20K_n%29%29" alt="inline_formula">  . </li></ul><br><br><h3>  Procedure Interaction Scheme </h3><br><br>  At this stage, we can escape from mathematics and deal with the algorithmic part itself.  The general scheme of interaction between the procedures of the system is shown in the figure below.  The ‚Äúapproximate UML Activity‚Äù notation is used, with a solid arrow showing the sequence of procedures, and a dotted arrow - an asynchronous call in a separate execution thread: <br><br><img width="70%" src="https://habrastorage.org/files/a99/713/301/a997133015eb44d78f71ad666c478a34.png"><br><br>  Assume that the user has changed the position of the slider for the vertical scroll bar (see the lower left corner of the chart).  Interpolator calculates the value of the number of combinations of the values ‚Äã‚Äãof key fields ( <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa%3Df%5E%7B-1%7D%28%5Clambda%29">  ) with type BigInteger.  Based on this value, the numerator restores the combination of key fields. <img src="http://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29%3Dg%5E%7B-1%7D%28%5Ckappa%29">  . <br><br>  Here it is important to understand that at this stage in the fields <img src="http://tex.s2cms.ru/svg/%5Cinline%20K_1%2C%5Cldots%20K_n">  there will not necessarily be values ‚Äã‚Äãthat are actually present in the database: there will only be approximations.  In string fields, for example, there will be a meaningless set of characters.  However, due to the remarkable property of query <b>B</b> , the output from the database <img src="http://tex.s2cms.ru/svg/%5Cinline%20h">  strings with keys greater than or equal to the set <img src="http://tex.s2cms.ru/svg/%5Cinline%20K_1%2C%5Cldots%20K_n">  , will be approximately the right result for a given position of the scroll bar. <br><br>  If the user released the scroll bar and did not touch it for some time, asynchronously (in a separate execution thread), query <b>D is</b> run, which determines the sequence number of the record, and hence the exact position of the scroll bar, which corresponds to what is displayed to the user.  When the query is completed, an interpolation table will be filled up based on the data received.  If at this moment the user has not started to scroll the table again, the vertical slider will ‚Äúbounce‚Äù to a new, refined position. <br><br>  When you go to the record, the sequence of procedure calls is reversed.  Since the values ‚Äã‚Äãof the key fields are already known, for the user, the request <b>B</b> immediately extracts data from the database.  The numerator calculates <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa%20%20%3D%20g%28K_1%2C%5Cldots%20K_n%29">  , and then the interpolator determines the approximate position of the scrollbar as <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda%20%3D%20f%28%5Ckappa%29">  .  In parallel, in the asynchronous execution flow, a lookup is performed, according to the results of which a new point is added to the interpolation table.  After a second or two, the scroll bar will ‚Äúbounce‚Äù to a new, specified position. <br><br>  The more the user will ‚Äúwander‚Äù according to the vertical slider, the more points will be collected in the interpolation table and the less will be the ‚Äúbounces‚Äù.  Practice shows that only 4-5 successful points in the interpolation table are enough for the ‚Äúbounces‚Äù to become very small. <br><br>  An instance of an interpolator class must hold intermediate points of a monotonously growing function between a set of 32-bit integers (record numbers in a table) and a set of objects of type BigInteger (sequence numbers of combinations of values ‚Äã‚Äãof key fields). <br><br>  Immediately after the grid is initialized, you need to request the total number of records in the table in a separate execution flow in order to get the correct value. <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda_%7B%5Cmax%7D">  .  Until this value is obtained using a query running in a parallel thread, you can use some default value (for example, 1000) - this will not affect the correctness of the work. <br><br>  The interpolator must be able to calculate the value of one or the other in a fast way by the number of interpolation points.  However, we note that more often it is necessary to calculate the value of the sequence number of a combination by the number of the record: such calculations are performed many times per second during the user scrolling the grid.  Therefore, the basis of the implementation of the interpolator module is convenient to take a dictionary based on a binary tree, the keys of which are the record numbers, and the values ‚Äã‚Äãare the sequence numbers of the combinations (the TreeMap &lt;Integer, BigInteger&gt; class in the Java language). <br><br>  It is clear that by a given number <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  such a dictionary for logarithmic time finds two points ( <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Cunderline%7B%5Clambda%7D%20%5Cleq%20%5Clambda%20%5Cleq%20%5Coverline%7B%5Clambda%7D">  ) between which builds direct interpolation of the function <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  .  But the fact that <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  grows monotonously, allows for a reverse calculation in a fast time.  Indeed: if given a combination number <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa">  , <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa_%7B%5Cmin%7D%20%5Cleq%20%5Ckappa%20%5Cleq%20%5Ckappa_%7B%5Cmax%7D">  , search for piecewise segment in which lies <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa">  can be produced in the dictionary by the dichotomy method.  Having found the desired segment, we perform the inverse interpolation <img src="http://tex.s2cms.ru/svg/%5Cinline%20f">  and find the number <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Clambda">  corresponding to <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa">  . <br><br>  When replenishing the dictionary with interpolation points, it is necessary to ensure that the interpolated function remains monotonous.  Since other users can delete and add entries to the table being viewed, the relevance of interpolation points known to the dictionary may be lost, and the newly added point may break the monotony.  Therefore, the method of adding a new interpolation point should verify that the ‚Äúpoint to the left‚Äù of the newly added one corresponds to a smaller one, and to the ‚Äúpoint to the right‚Äù is a larger value.  If it turns out that this is not the case, one should proceed from the assumption that the last point added corresponds to the current state of affairs, and some of the old points have lost their relevance.  In relation to the newly added point, all points on the left that contain the larger value and all points on the right that contain the smaller value should be deleted.  The process of "cutting out the outgoing point" is shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/44f/7c0/128/44f7c01286b64e4296d8895f1b9fb8df.png"></div><br><br>  Also, the interpolator must contain a mechanism in order to save memory protecting the dictionary from overflowing with unnecessary points, and discarding the least significant of them (as we remember, it does not make sense to store all the points in a row - it is enough only through one). <br><br><h3>  Conclusion to the first part </h3><br>  So, we figured out how our system works in general: its main parts are the <i>interpolator</i> and the <i>numerator</i> , and we also fully discussed the implementation of the interpolator.  To complete the solution of the problem, it is now necessary to implement a <i>numerator</i> - a bijection <img src="http://tex.s2cms.ru/svg/%5Cinline%20g%28K_1%2C%5Cldots%20K_n%29" alt="inline_formula">  , associating sets of key field values, possibly consisting of dates, strings, sorted using Unicode collation rules, etc., with numbers growing in the same order. <br><br>  This is the <a href="https://habrahabr.ru/post/279083/"><b>second part of the article</b></a> . <br><br>  I am also preparing a scientific publication, and you can also familiarize yourself with the <a href="http://arxiv.org/pdf/1603.01102v1.pdf">preprint of the scientific version of this article at arxiv.org</a> . </div><p>Source: <a href="https://habr.com/ru/post/278773/">https://habr.com/ru/post/278773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278763/index.html">KTV. New JSON</a></li>
<li><a href="../278765/index.html">AutoCAD & RTree</a></li>
<li><a href="../278767/index.html">Microsoft announced Linux version of SQL Server</a></li>
<li><a href="../278769/index.html">Extensible Android application code with MVP</a></li>
<li><a href="../278771/index.html">Import substitution successes or entertaining statistics based on the Register of Federal State Information Systems</a></li>
<li><a href="../278775/index.html">We write on D for Raspberry Pi</a></li>
<li><a href="../278777/index.html">The digest of interesting materials for the mobile developer # 143 (February 29 - March 8)</a></li>
<li><a href="../278779/index.html">Why is ownership / borrowing in Rust so complicated?</a></li>
<li><a href="../278781/index.html">Adaptive Split View Controller and Popover in iOS 9 (Swift). Part 2</a></li>
<li><a href="../278783/index.html">Google fixed Android vulnerabilities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>