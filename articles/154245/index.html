<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP SQL query generator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somewhere a year and a half ago, I began to engage in web development. Started with functional programming. About half a year ago, I switched to OOP a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP SQL query generator</h1><div class="post__text post__text-html js-mediator-article">  Somewhere a year and a half ago, I began to engage in web development.  Started with functional programming.  About half a year ago, I switched to OOP and began using the MVC design architecture.  Recently there was a task to optimize work with the database, since all communication and work with the database was carried out through one class.  This was inconvenient because all the time you had to manually write SQL queries. <a name="habracut"></a>  The task was divided into 2 stages: <br><br><ol><li>  Write a class to connect to the database </li><li>  Write a model class for working with data </li></ol><br>  The first task was solved very quickly.  To implement it, I used the Singleton design pattern. <br>  For the implementation of the second task, it took me a little more time.  It was based on a simple news management module on the site.  The duties of this module included a standard set of functions: sampling, creating, deleting and updating records.  The model class inherits the DataBase class, which actually creates a connection to the database.  Also this class is responsible for generating sql code for <a href="http://ru.wikipedia.org/wiki/DML">DML operations</a> .  The DataBase class is abstract, which obliges us to implement DML methods in all child classes. <br>  Below is a set of abstract methods that are responsible for managing the News module. <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  abstract public function getRecords($what='*',$where=NULL, $limit=NULL, $order=NULL,$join=NULL,$debug=false); //  abstract function addRecord($data=array(),$debug=false); // (-) abstract function deleteRecords($table, $where=NULL,$debug=false); // (-) abstract function setRecords($table,$what,$where,$debug=false); //  abstract function query($sql);</span></span></code> </pre> <br>  Now more about each abstract method.  The implementation of these methods will be presented below when I describe the class of the News model. <br>  Some input parameters are repeated, so I will not re-describe them except for the cases when it is really required. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  GetRecords method </h5><br>  This method allows you to get a set of records that fit our SQL condition. <br><a name="params"></a><br><ul><li><a name="what"></a>  $ what - passes an array of fields to choose from the table </li><li><a name="where"></a>  $ where - passes an associative array of keys in the form array ('Field' =&gt; array ('sign', 'value')).  This allows us to use the WHERE predicate more flexibly. </li><li>  $ limit - passes an associative key array in the form of array ('initial entry', 'number of entries').  This structure allows us to implement paginated output or output of a limited number of records. </li><li>  $ order is an associative array array ('field' =&gt; 'sort type').  Gives you the ability to sort by any number of columns. </li><li><a name="join"></a>  $ join is an associative array array ('Connection type', array ('Table1', 'Table2'), array ('Alias1', 'Alias2'), array ('field1', 'field2')).  Connection type: LEFT, INNER, RIGHT, OUTER;  Table1 and Table2: tables between which the connection is established;  Allias1 and Allias2 - aliases for the table;  Pole1 and Pole2 is acc.  PK and FK tables </li><li>  $ degub - this parameter is needed to save the already created sql query in the class properties, as well as the parameters that are needed if we use the prepare statement in the PDO </li></ul><br><h5>  AddRecord method </h5><br>  This method allows you to add an entry to the table. <br><ul><li>  $ data - an associative array of parameters in the form: 'field' =&gt; 'value' that will be inserted into the table </li></ul><br><h5>  DeleteRecords method </h5><br>  This method allows you to remove the record (s) from the table. <br><ul><li>  $ table - the name of the table from which data will be deleted </li></ul><br><h5>  SetRecords method </h5><br>  This method allows you to update the record (s) in the table for a given condition. <br><ul><li>  $ what - In this case, this parameter passes an array in the form: 'field' =&gt; 'value', which will be used with the SET statement </li></ul><br><h5>  Query method </h5><br>  This method allows you to perform non-standard queries.  To do this, simply pass the required sql query as a parameter to the method. <br><ul><li>  $ sql - sql query to execute </li></ul><br>  I think many people know that the DML type of queries consists of 4 types: SELECT, INSERT, UPDATE, DELETE.  To generate these queries, we need to divide them conditionally into several parts. <br>  1) SELECT query is divided into: WHAT, JOIN, WHERE, ORDER, LIMIT, GROUP, HAVING. <br>  2) INSERT query: WHAT <br>  3) UPDATE query: WHAT, WHERE <br>  4) DELETE query: WHERE. <br>  It turns out we just need to separately generate these parts of the request, and then glue them together.  To generate these parts in the DataBase class, methods were created that are uniform not only for the News module, as in our case, but for any other module. <br><br>  Consider these methods in more detail. <br><br><h5>  CheckWhat method </h5><br>  The only input parameter to this method is an associative array of values ‚Äã‚Äãthat either need to be selected using SELECT or need to be updated using UPDATE. <br>  The $ what parameter is described <a href="https://habr.com/ru/post/154245/">here</a> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkWhat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($what)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($what)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($what <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k=&gt;$v) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_numeric($k)) <span class="hljs-comment"><span class="hljs-comment">//      .  ,   prepare statement,   ,        SELECT  { $result['column'][]=$k."=?"; $result['params'][]=$v; } else { $result['column'][]=$v; } } $result['column']=implode(",",$result['column']); } return $result; }</span></span></code> </pre><br>  I think everything is pretty clear here.  Checking on an array, traversing all elements of an array, and building part of the query string <br><br><h5>  CheckJoin method </h5><br>  The $ join parameter is described <a href="https://habr.com/ru/post/154245/">here</a> .  There is also a situation where you need to join more than two tables, then the $ join parameter can be represented as an array ($ join1, $ join2, ....., $ joinN) <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">//  Join  . protected function checkJoin($join) { if (is_array($join) &amp;&amp; count($join)&gt;0) { if (!is_array($join[0])) //   ,     join { $res[]=$this-&gt;addJoin($join[0],$join[1],$join[2],$join[3]); } else { //    ,    join $res=$this-&gt;addJoinArray($join); } return implode(" ",$res); } else { return false; } } // join protected function addJoin($type=' INNER ',$tables,$pseudoName,$rows) { if ($type!=='' &amp;&amp; is_array($tables) &amp;&amp; is_array($rows)) { $t0=$tables[0]; $t1=$tables[1]; if (is_array($pseudoName) &amp;&amp; count($pseudoName)&gt;0) //   ,    { $t0=$pseudoName[0]; $t1=$pseudoName[1]; } return $type." JOIN `".$tables[1]."` `".$pseudoName[1]."` ON `".$t0."`.`".$rows[0]."`=`".$t1."`.`".$rows[1]."`"; } else { return false; } } //   join` protected function addJoinArray($join) { if (is_array($join)) { foreach ($join as $j) { $res[]=$this-&gt;addJoin($j[0],$j[1],$j[2],$j[3]); } } return $res; }</span></span></code> </pre><br><br><h5>  CheckWhere method </h5><br>  The method checks the presence of parameters for the WHERE part of the query.  The $ where parameter is described <a href="https://habr.com/ru/post/154245/">here.</a> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkWhere</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($where)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_null($where) &amp;&amp; is_array($where)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($where <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k=&gt;$v) { $part=$k.$v[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//     ''  '' if (!is_array($v[1])) //  ,   prepare statement { $part.="?"; $params[]=$v[1]; //     } else { //  ,     IN (array) $part.="(".implode(",",$v[1]).")"; } $res[]=$part; } $result['column']="WHERE ".implode(" AND ",$res); $result['params']=$params; } return $result; }</span></span></code> </pre><br><br><h5>  CheckLimit method </h5><br>  Generate predicates LIMIT query.  It's all pretty simple. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkLimit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($limit)</span></span></span><span class="hljs-function"> </span></span>{ $res=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($limit) &amp;&amp; count($limit)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { $res=<span class="hljs-string"><span class="hljs-string">" LIMIT "</span></span>.$limit[<span class="hljs-string"><span class="hljs-string">'start'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($limit[<span class="hljs-string"><span class="hljs-string">'count'</span></span>]) &amp;&amp; $limit[<span class="hljs-string"><span class="hljs-string">'count'</span></span>]!==<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-comment"><span class="hljs-comment">//        { $res.=", ".$limit['count']; } } return $res; }</span></span></code> </pre><br><br><h5>  CheckOrder method </h5><br>  Generation predicates ORDER. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($order)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($order) &amp;&amp; count($order)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($order <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$dir) { $res[]=$row.<span class="hljs-string"><span class="hljs-string">" "</span></span>.$dir; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"ORDER BY "</span></span>.implode(<span class="hljs-string"><span class="hljs-string">","</span></span>,$res); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre><br>  Here are all the methods that are needed to generate the main parts of the request.  But since  we use the prepare statement in such parts of the query as WHERE and WHAT, then we need to combine the parameters of these parts in order to pass to the PDO.  For this task, I wrote another method <br><br><h5>  CheckParams method </h5><br>  Input parameters are two arrays.  Array of WHAT and WHERE parameters. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkParams</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($what,$where)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($what) || !is_array($what)) { $params=$where; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($where) &amp;&amp; !is_array($where)) { $params=$what; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $params=array_merge($what,$where); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $params; }</code> </pre><br><br>  The next step in building SQL queries is the final generation of sql code.  For this, I created 4 methods: prepareSelectSQL, prepareInsertSQL, prepareDeleteSQL, prepareUpdateSQL <br>  Consider these methods in more detail. <br><br><h5>  PrepareSelectSQL method </h5><br>  The parameters of this method are the same as the parameters of the getRecords method.  These are $ what, $ where, $ limit, $ order, $ join, $ debug.  These parameters are described <a href="https://habr.com/ru/post/154245/">here.</a> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareSelectSQL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($what=array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'*'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params">,$where=NULL, $limit=NULL, $order=NULL,$join=NULL,$debug=false)</span></span></span><span class="hljs-function"> </span></span>{ $what=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkWhat($what); $where=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkWhere($where); $limit=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkLimit($limit); $order=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkOrder($order); $j=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkJoin($join); $sql=<span class="hljs-string"><span class="hljs-string">"SELECT "</span></span>.$what[<span class="hljs-string"><span class="hljs-string">'column'</span></span>].<span class="hljs-string"><span class="hljs-string">" FROM `"</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;table.<span class="hljs-string"><span class="hljs-string">"` `tb` "</span></span>.$j.<span class="hljs-string"><span class="hljs-string">" "</span></span>.$where[<span class="hljs-string"><span class="hljs-string">'column'</span></span>].<span class="hljs-string"><span class="hljs-string">" "</span></span>.$order.<span class="hljs-string"><span class="hljs-string">" "</span></span>.$limit; $params=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkParams($what[<span class="hljs-string"><span class="hljs-string">'params'</span></span>],$where[<span class="hljs-string"><span class="hljs-string">'params'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($debug) <span class="hljs-comment"><span class="hljs-comment">//  true,   sql      . { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); //   sql   . }</span></span></code> </pre><br><br><h5>  PrepareInsertSQL method </h5><br>  This method is simpler, because  uses a limited set of predicates and parameters <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareInsertSQL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data,$table,$debug=false)</span></span></span><span class="hljs-function"> </span></span>{ $params=$values=$column=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $c=&gt;$p) { $column[]=$c; <span class="hljs-comment"><span class="hljs-comment">//    $values[]="?"; //   prepare statement $params[]=$p; //    } $sql=" INSERT INTO `".$table."` (".implode(",",$column).") VALUES (".implode(',',$values).")"; if ($debug) { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); }</span></span></code> </pre><br><br><h5>  PrepareDeleteSQL method </h5><br>  Request to delete records.  Use the table name and parameter set for the WHERE predicates. <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareDeleteSQL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($table,$where,$debug=false)</span></span></span><span class="hljs-function"> </span></span>{ $where=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkWhere($where); $sql=<span class="hljs-string"><span class="hljs-string">"DELETE FROM `"</span></span>.$table.<span class="hljs-string"><span class="hljs-string">"` "</span></span>.$where[<span class="hljs-string"><span class="hljs-string">'column'</span></span>]; $params=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkParams($what,$where[<span class="hljs-string"><span class="hljs-string">'params'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($debug) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sql=$sql; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;params=$params; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'sql'</span></span>=&gt;$sql,<span class="hljs-string"><span class="hljs-string">'params'</span></span>=&gt;$params); }</code> </pre><br><br><h5>  PrepareUpdateSQL method </h5><br>  We generate sql query to update the records in the table. <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareUpdateSQL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($table,$what,$where,$debug=false)</span></span></span><span class="hljs-function"> </span></span>{ $what=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkWhat($what); $where=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkWhere($where); $sql=<span class="hljs-string"><span class="hljs-string">"UPDATE `"</span></span>.$table.<span class="hljs-string"><span class="hljs-string">"` SET "</span></span>.$what[<span class="hljs-string"><span class="hljs-string">'column'</span></span>].<span class="hljs-string"><span class="hljs-string">" "</span></span>.$where[<span class="hljs-string"><span class="hljs-string">'column'</span></span>]; $params=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkParams($what[<span class="hljs-string"><span class="hljs-string">'params'</span></span>],$where[<span class="hljs-string"><span class="hljs-string">'params'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($debug) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sql=$sql; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;params=$params; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'sql'</span></span>=&gt;$sql,<span class="hljs-string"><span class="hljs-string">'params'</span></span>=&gt;$params); }</code> </pre><br><br>  Above, the DataBase class was described, which is responsible for connecting to the database and generating DML sql queries.  Below is the complete code for this class. <br><div class="spoiler">  <b class="spoiler_title">Abstract class DataBase</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_db=<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $sql=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $params=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/* *  __construct  __clone  , *        new. * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__clone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//  abstract public function getRecords($what='*',$where=NULL, $limit=NULL, $order=NULL,$join=NULL,$debug=false); //  abstract function addRecord($data=array(),$debug=false); // (-) abstract function deleteRecords($table, $where=NULL,$debug=false); // (-) abstract function setRecords($table,$what,$where,$debug=false); //  abstract function query($sql); /* *     .    , *     ,  , *       . *     PDOChild * */ public static function getInstance($registry) { if (is_null(self::$_db)) { self::$_db=new PDOchild($registry); } return self::$_db; } /* *  join  . * type -   join * tables -      * pseudoName -    * row -      * */ protected function addJoin($type=' INNER ',$tables,$pseudoName,$rows) { if ($type!=='' &amp;&amp; is_array($tables) &amp;&amp; is_array($rows)) { $t0=$tables[0]; $t1=$tables[1]; if (is_array($pseudoName) &amp;&amp; count($pseudoName)&gt;0) { $t0=$pseudoName[0]; $t1=$pseudoName[1]; } return $type." JOIN `".$tables[1]."` `".$pseudoName[1]."` ON `".$t0."`.`".$rows[0]."`=`".$t1."`.`".$rows[1]."`"; } else { return false; } } /* *   join   * join -   join array(join,join) * */ protected function addJoinArray($join) { if (is_array($join)) { foreach ($join as $j) { $res[]=$this-&gt;addJoin($j[0],$j[1],$j[2],$j[3]); } } return $res; } /* *  SELECT sql * what-        * where-      array(=&gt;array(=,)) * limit-     array( , ) * order-  array (=&gt;) * join-  join * debug-  true     sql   sql     params   * */ protected function prepareSelectSQL($what=array('*'),$where=NULL, $limit=NULL, $order=NULL,$join=NULL,$debug=false) { $what=$this-&gt;checkWhat($what); $where=$this-&gt;checkWhere($where); $limit=$this-&gt;checkLimit($limit); $order=$this-&gt;checkOrder($order); $j=$this-&gt;checkJoin($join); $sql="SELECT ".$what['column']." FROM `".$this-&gt;table."` `tb` ".$j." ".$where['column']." ".$order." ".$limit; $params=$this-&gt;checkParams($what['params'],$where['params']); if ($debug) { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); } /* *  Insert sql * data-   -   * table-     * debug-  true     sql   sql     params   * */ protected function prepareInsertSQL($data,$table,$debug=false) { foreach ($data as $c=&gt;$p) { $column[]=$c; $values[]="?"; $params[]=$p; } $sql=" INSERT INTO `".$table."` (".implode(",",$column).") VALUES (".implode(',',$values).")"; if ($debug) { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); } /* *  Delete sql * where-    * table-      * debug-  true     sql   sql     params   * */ protected function prepareDeleteSQL($table,$where,$debug=false) { $where=$this-&gt;checkWhere($where); $sql="DELETE FROM `".$table."` ".$where['column']; $params=$this-&gt;checkParams($what,$where['params']); if ($debug) { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); } /* *  Update sql * table-      * what -      * where-    * debug-  true     sql   sql     params   */ protected function prepareUpdateSQL($table,$what,$where,$debug=false) { $what=$this-&gt;checkWhat($what); $where=$this-&gt;checkWhere($where); $sql="UPDATE `".$table."` SET ".$what['column']." ".$where['column']; $params=$this-&gt;checkParams($what['params'],$where['params']); if ($debug) { $this-&gt;sql=$sql; $this-&gt;params=$params; } return array('sql'=&gt;$sql,'params'=&gt;$params); } /* *    join *   ,      ,    addJoin *  ,  addJoinArray *  join ,     * */ protected function checkJoin($join) { if (is_array($join) &amp;&amp; count($join)&gt;0) { if (!is_array($join[0])) { $res[]=$this-&gt;addJoin($join[0],$join[1],$join[2],$join[3]); } else { $res=$this-&gt;addJoinArray($join); } return implode(" ",$res); } else { return false; } } /* *    what *    . , *    =&gt;?     prepare SQL * */ protected function checkWhat($what) { if (is_array($what)) { foreach ($what as $k=&gt;$v) { if (!is_numeric($k)) { $result['column'][]=$k."=?"; $result['params'][]=$v; } else { $result['column'][]=$v; } } $result['column']=implode(",",$result['column']); } return $result; } /* *    Where *     , *    =&gt;?     prepare SQL *  v[0](sign)= IN   value  ,    IN (array); *     LIKE,   . *       sql * */ protected function checkWhere($where) { if (!is_null($where) &amp;&amp; is_array($where)) { foreach ($where as $k=&gt;$v) { $part=$k.$v[0]; if (!is_array($v[1])) { $part.="?"; $params[]=$v[1]; } else { $part.="(".implode(",",$v[1]).")"; } $res[]=$part; } $result['column']="WHERE ".implode(" AND ",$res); $result['params']=$params; } return $result; } /* *    Limit *     , *   LIMIT  SQL *   LIMIT        * */ protected function checkLimit($limit) { if (is_array($limit) &amp;&amp; count($limit)&gt;0) { $res=" LIMIT ".$limit['start']; if (isset($limit['count']) &amp;&amp; $limit['count']!=='') { $res.=", ".$limit['count']; } } return $res; } /* *    Order *     , *   ORDER  SQL *   ORDER * */ protected function checkOrder($order) { if (is_array($order) &amp;&amp; count($order)&gt;0) { foreach ($order as $row=&gt;$dir) { $res[]=$row." ".$dir; } return "ORDER BY ".implode(",",$res); } else { return ''; } } /* *     prepare sql *      WHAT    WHERE. *    ,  prepare sql *    update, select, delete, insert *    what  where * */ protected function checkParams($what,$where) { if (!isset($what) || !is_array($what)) { $params=$where; } else if (!isset($where) &amp;&amp; !is_array($where)) { $params=$what; } else { $params=array_merge($what,$where); } return $params; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br></div></div><br>  Now it‚Äôs time to describe the News model class.  This class implements all the abstract methods of the DataBase parent class and the getObject static method.  This method returns an instance of the object of this class.  This method was created to eliminate the need to create an object of the class News by using the keyword new.  Here's what it looks like: <br><pre> <code class="php hljs">$news=News::getObject()-&gt;getRecords(params);</code> </pre><br>  Each method of this class calls the sql query generator it needs and passes the final query and parameters to the PDO to execute the query.  Below is the complete class code for the News model. <br><div class="spoiler">  <b class="spoiler_title">class News</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">News</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $table=<span class="hljs-string"><span class="hljs-string">'news'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $id_row='id'; // primary key public function __construct() { $registry=new Registry(); //     $this-&gt;db=parent::getInstance($registry); } //        public static function getObject() { return new News(); } //    . public function getRecords($what=array('*'),$where=NULL, $limit=NULL, $order=NULL,$join=NULL,$debug=false) { $data=$this-&gt;prepareSelectSQL($what,$where, $limit, $order,$join,$debug); $res=$this-&gt;db-&gt;prepare($data['sql']); $res-&gt;execute($data['params']); $result=$query-&gt;fetchAll(PDO::FETCH_OBJ); return $result; } public function addRecord($data=array(),$debug=false) { $data=$this-&gt;prepareInsertSQL($data,$this-&gt;table,$debug); $query=$this-&gt;db-&gt;prepare($data['sql']); return $query-&gt;execute($data['params'])); } public function deleteRecords($table, $where=NULL,$debug=false) { $data=$this-&gt;prepareDeleteSQL($table,$where,$debug); $query=$this-&gt;db-&gt;prepare($data['sql']); $result=$query-&gt;execute($data['params']); return $result; } public function setRecords($table,$what,$where,$debug=false) { $data=$this-&gt;prepareUpdateSQL($table,$what,$where,$debug); $query=$this-&gt;db-&gt;prepare($data['sql']); $result=$query-&gt;execute($data['params']); return $result; } public function query($sql) { $query=$this-&gt;db-&gt;prepare($sql); $query-&gt;execute(); $result=$query-&gt;fetchAll(PDO::FETCH_OBJ); return $result; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br></div></div><br>  In principle, this can be completed.  Of course, you could also add the generation of predicates GROUP BY and HAVING, but I decided not to do this.  I think that the principle of constructing queries I stated clearly and there will be no problems with use.  As a result, we got a mechanism for building sql queries, which is not tied to a specific table structure in the database and can be applied to different types of DML SQL queries.  If necessary, I can create a repository on github. <br>  I will be glad to hear criticism and suggestions for improving the method. </div><p>Source: <a href="https://habr.com/ru/post/154245/">https://habr.com/ru/post/154245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154229/index.html">How one-time passwords work</a></li>
<li><a href="../154231/index.html">Why share experiences or Why write articles on Habr?</a></li>
<li><a href="../154235/index.html">How to measure disk performance</a></li>
<li><a href="../154239/index.html">Ascetic reader for 9.90 euros</a></li>
<li><a href="../154241/index.html">Presentation of the Personal Thermograph team</a></li>
<li><a href="../154247/index.html">Yota launched real 4G: LTE Advanced</a></li>
<li><a href="../154249/index.html">The global problems of the Internet, the second time collapses connectivity between Europe and America</a></li>
<li><a href="../154255/index.html">Bitbucket - big update</a></li>
<li><a href="../154259/index.html">Humble eBook Bundle</a></li>
<li><a href="../154261/index.html">Service for the exchange of requests between suppliers of goods and online stores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>