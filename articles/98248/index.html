<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>USB bootloader for AVR microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article describes how to quickly launch a USB bootloader for an ATmega32 microcontroller using the example of an usbasploader bootloader from Obje...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>USB bootloader for AVR microcontrollers</h1><div class="post__text post__text-html js-mediator-article"> The article describes how to quickly launch a <b>USB</b> bootloader for an ATmega32 microcontroller using the example of an <b>usbasploader</b> bootloader from Objective Development. <a name="habracut"></a><br><br>  The USB bootloader technology provides a single opportunity - no need for a special programmer to replace the software ( <b>firmware</b> ) in the device - just connect to a computer via USB.  There is no need to carry a programmer with you anymore, as a computer and USB are everywhere.  If your breadboard model is equipped with a bootloader, you can save money on buying a programmer or time to make it - this is important for beginners. <br><br>  A lot of bootloaders have been made for AVR - see [ <a href="http://microsin.ru/content/view/1079/44/">1</a> ].  For the article, I chose usbasploader [ <a href="http://www.obdev.at/products/vusb/usbasploader.html">2</a> ] because it is compatible with the very popular <b>USBasp</b> programmer.  This allows you to reflash the firmware both under Linux and under Windows using popular programs (see [3]) avrdude, eXtreme Burner - AVR, Khazama AVR Programmer and even from the BASCOM-AVR programming environment (the BASCOM-AVR programming system - a small miracle worthy of a separate article).  In addition, usbasploader comes with all sources, is well documented and easily adapts to the needs of the user (more on this later). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The usbasploader loader works very simply - when connected to a USB, it pretends to be a USBasp programmer.  Therefore, all programs that support it will overwrite the firmware in your device, as if they are using a USBasp programmer.  The bootloader is located in the higher addresses of the flash memory of the microcontroller's programs, and writes the user program to lower addresses (usually starting at address 0), that is, when the microcontroller is reflashed, the bootloader does not overwrite.  After the end of the recording, the bootloader transfers control to the user program.  Now in more detail, how it works with ATmega microcontrollers, on the example of <b>ATmega32</b> . <br><br>  For ATmega32 usbasploader compiled so that it is located in flash from the address 7000h (recall that the address space of ATmega32 program memory is 0000h..7FFFh, and the command address is a multiple of two bytes, i.e. the command addresses are in the range 0000h..37FFh) .  For the user program, the space is 0000h..6FFFh (28672 bytes).  The usbasploader loader uses the ability of the ATmega32 microcontroller to start from the address located in the higher memory addresses of programs (several fixed addresses are available that are selected by jumpers - fuses, see [ <a href="http://www.engbedded.com/fusecalc/">4</a> ]).  So that when power is turned on and reset, control is always transferred to the address 0x7000, you must program the jumpers (fuses, fuse-bits) <b>BOOTSZ0</b> and <b>BOOTSZ1</b> to the appropriate state (4000h bytes or 2048 words of the program code should be allocated to the bootloader), and also program the jumper <b>BOOTRST</b> .  After this, the code when resetting or turning on will start not from address 0, but from address 3800h in the words of AVR commands, or from address 7000h in flash bytes (recall that the minimum size of an AVR command is two bytes). <br><br>  Having received control after a reset, the usbasploader code checks the condition of its activation, that is, the signal by which it should start working as a USBasp programmer.  Usually such a signal is the closure of some legs to the ground.  For the prototyping board, I chose the ATmega32 <b>PB5</b> microcontroller as such a foot.  This leg is also the MOSI signal outputted to the connector, so the jumper between pins 4 and 6 of the U1 ISP connector is very convenient to send a log to PB5.  0. So, the usbasploader code checks the level on the PB5 port, and if there is a log.  0 (the jumper between legs 4 and 6 of the U1 ISP connector is installed), then work begins as a USBasp programmer.  That is, when the jumper is installed, the bootloader is activated when the power is turned on, and if it is connected to a computer, a USB USB device will appear on the computer.  If there is no jumper at the time of power-on (the logger 1 is read by the microcontroller on the PB5), usbasploader immediately transfers control to the user program (to address 0).  Here is a simple startup algorithm. <br><br>  In usbasploader it is possible to change the behavior of the bootloader, for this it is enough to edit three functions (they are very simple and are in the bootloaderconfig.h file) - <b>bootLoaderInit</b> , <b>bootLoaderCondition</b> , <b>bootLoaderExit</b> .  The function assignment is almost obvious by name.  The bootLoaderInit function is intended to configure the environment in which the condition for activating the bootloader can be monitored: <br><blockquote> <code><code><font color="black"><font color="#0000ff">static</font> inline <font color="#0000ff">void</font> bootLoaderInit( <font color="#0000ff">void</font> ) &lt;br&gt;{&lt;br&gt;    DDRB |= (1 &lt;&lt; PB0); <font color="#008000">//   </font> &lt;br&gt; <font color="#008000">// PB5 (MOSI,  4  U1 ISP)  pull-up   </font> &lt;br&gt;    PORTB |= (1 &lt;&lt; PB5)|(1 &lt;&lt; PB0);  &lt;br&gt;}</font></code></code> </blockquote> <br>  The code is very simple - it only connects the pull-up internal pull-up resistor on the PB5 leg to determine if there is a jumper between pins 4 and 6 of the U1 ISP connector, and lights the red LED on the layout.  The bootLoaderCondition function is designed to check whether or not there is a jumper between pins 4 and 6: <br><blockquote> <code><code><font color="black"><font color="#0000ff">static</font> inline uint8_t bootLoaderCondition() &lt;br&gt;{&lt;br&gt; <font color="#0000ff">if</font> (!(PINB &amp; (1 &lt;&lt; PB5))) &lt;br&gt;    {&lt;br&gt; <font color="#0000ff">return</font> 1;&lt;br&gt;    } &lt;br&gt; <font color="#0000ff">else</font> &lt;br&gt;    {&lt;br&gt; <font color="#008000">// no boot loader</font> &lt;br&gt; <font color="#0000ff">return</font> 0;&lt;br&gt;    }&lt;br&gt;}</font></code></code> </blockquote>  If the jumper is, then PB5 leg reads like a log.  0, and the bootLoaderCondition function returns 1 (which means the bootloader is working).  If there is no jumper, the function will return 0, which means inactivity for the bootloader (control is immediately transferred to the address 0 - to the user program).  The bootLoaderExit function does not do anything for me, only turns off the red LED of the layout: <br><blockquote> <code><code><font color="black"><font color="#0000ff">static</font> inline <font color="#0000ff">void</font> bootLoaderExit( <font color="#0000ff">void</font> ) &lt;br&gt;{&lt;br&gt;    PORTB &amp;= ~(1 &lt;&lt; PB0); <font color="#008000">// </font> &lt;br&gt;}</font></code></code> </blockquote> <br>  The code for the bootLoaderInit, bootLoaderCondition, bootLoaderExit functions can be considered as an example - they can and should be altered to suit your needs, and then usbasploader will work exactly as you want.  In conclusion, I will describe the process step by step on the Windows platform (it is assumed that you have already installed AVRStudio and WinAVR environment. If not, read the instructions on how to install them, refer to [ <a href="http://microsin.ru/content/view/613/44/">6</a> ]). <br><br>  [ <b>How to embed usbasploader into your project</b> ] <br><br>  <b>1</b> .  You need to download the latest version of usbasploader (see [ <a href="http://www.obdev.at/products/vusb/usbasploader.html">2</a> ]), for example <a href="">USBaspLoader 2009-03-20.zip</a> .  If you have a prototype AVR-USB-MEGA16 card, then I suggest downloading the version from the link [ <a href="http://depositfiles.com/files/3n716p8fs">5</a> ] - everything is ready there, and you can skip steps 2, 3, 4.  You unpack in any convenient folder. <br><br>  <b>2</b>  Edit the settings in the Makefile.  There you need to change: <br>  a) the definition of F_CPU is the frequency in Hz at which the microcontroller operates.  Domostimy frequencies are 12, 15, 16, 16.5 and 20 MHz. <br>  b) determining DEVICE for your type of microcontroller. <br>  c) address (format hexadecimal, units in bytes) download code usbasploader BOOTLOADER_ADDRESS. <br>  d) (optional, if you are flashing a chip from a non-Makefile), check and, if necessary, correct the definitions of FUSEOPT and LOCKOPT, as well as the definition of AVRDUDE. <br><br>  <b>3</b>  Edit bootloaderconfig.h.  There you need to check and, if necessary, change: <br>  a) USB_CFG_IOPORTNAME macro - the letter of the name of the port to which the USB signals D- and D + are connected. <br>  b) USB_CFG_DMINUS_BIT and USB_CFG_DPLUS_BIT macros are the numbers of the ports with which the D- and D + signals are connected.  The D + signal must be connected to the INT0 interrupt leg. <br>  c) the function code bootLoaderInit, bootLoaderExit and the bootLoaderCondition macro. <br><br>  <b>4</b>  Recompile the project, to do this, type make.  At the command prompt, you will see something like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e51/c47/31f/e51c4731f5afef003e0877c97140ed2e.png" alt="image"><br><br>  After successful compilation, you will receive the main.bin and main.hex files in the project root folder - ready firmware for usbasploader.  By the way, in the folder hexfiles there are already several compiled versions of firmware for crystals ATmega8, ATmega88, ATmega168, on different frequencies of quartz. <br><br>  <b>5</b>  It is necessary using the programmer to flash usbasploader code into the chip, install the fyuse correctly.  The meaning of this operation is that the usbasploader code must be put in the upper memory area (at BOOTLOADER_ADDRESS), and the fyuzas are installed in such a way that the bootloader code started running (when I reset or turned on) (I already wrote about this).  For details on fusion, see link [ <a href="http://www.engbedded.com/fusecalc/">4</a> ] and datasheet to your microcontroller.  For an ATmega32 microcontroller, for example, fuses should be set as follows: <br>  <b>LOW FUSE BYTE</b> : 0x <b>CF</b> <br>  <b>HIGH FUSE BYTE</b> : 0x <b>D8</b> (you can also 0x98 to enable JTAG debugging) <br>  <b>LOCKOPT BYTE</b> : 0x <b>EF</b> <br><br>  The AVR-USB-MEGA16 development board can be purchased with usbasploader already stitched and fused, so steps 1, 2, 3, 4, 5 need not be done. <br><br>  <b>6</b>  It is necessary to connect the flashed prototype board to the computer via USB.  If nothing is messed up, the layout will be defined in the system as a new device and Windows will ask for a driver.  The driver can be downloaded from the page [ <a href="http://www.obdev.at/products/vusb/usbasploader.html">2</a> ], or taken from the archive by reference [ <a href="http://depositfiles.com/files/3n716p8fs">5</a> ].  For Linux, the driver is not needed. <br><br>  <b>7</b>  We need one of the programs that work with the USBasp programmer (see references [3]).  For Linux users, avrdude is suitable, and for Windows users, the choice is very wide.  I recommend Khazama AVR Programmer with a very simple and user-friendly interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb0/b16/429/fb0b1642913c4c4ae51267c55e540b19.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c9/950/4c5/0c99504c5980766d1979cfc2138cc916.png" alt="image"><br><br>  [ <b>How to work with usbasploader using the example of the AVR-USB-MEGA16 and Khazama AVR Programmer layout</b> ] <br><br>  <b>1</b> .  Place a jumper between legs 4 and 6 of the U1 ISP connector. <br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/f8e/e99/dddf8ee99b8d6f0f20cac9c9f454950a.jpg" alt="image"><br><br>  <b>2</b>  Connect the mockup to the computer via USB.  A red LED will light up on the layout, and a USBasp programmer will be detected in the Windows system. <br><br>  <b>3</b>  Run the Khazama AVR Programmer.  In the settings, remove the option to clear the crystal memory (Command -&gt; Program Options -&gt; uncheck the Erase Chip checkbox).  Select your chip from the drop-down list.  Download the hex file of the firmware (via the menu File -&gt; Load FLASH file to Buffer).  Press the large Auto Program button that starts programming.  A crystal is programmed very quickly, in a few seconds. <br><img src="https://habrastorage.org/getpro/habr/post_images/84b/793/145/84b793145b4c798738a25ff55c2c9de0.png" alt="image"><br>  After programming, the red LED goes out, and your program starts from address 0 (which you have just recorded). <br><br>  <b>4</b>  Remove the jumper between legs 4 and 6 of the U1 ISP connector. <br><img src="https://habrastorage.org/getpro/habr/post_images/327/d78/2f2/327d782f2c2236e65594b02fea6c0c4e.jpg" alt="image"><br><br>  <b>UPD100711</b> : <a href="http://microsin.ru/content/view/1188/44/">wrote an article about another USB bootloader</a> - <b>BootloadHID</b> .  The source code and style of work is very similar to USBASPloader.  It differs in that it requires a special program on the computer, but it is easier to integrate it into younger chips (starting with ATmega8), since the requirements for the size of the bootloader section are reduced. <br><br>  [ <b>Links</b> ] <br><br>  <b>1</b> .  <a href="http://microsin.ru/content/view/1079/44/">Boot loaders for AVR microcontrollers</a> . <br>  <b>2</b>  <a href="http://www.obdev.at/products/vusb/usbasploader.html">Home page of usbasploader</a> . <br>  <b>3</b>  Programs for working with the USBasp programmer - <a href="http://download.savannah.gnu.org/releases/avrdude/">AVRDUDE</a> , <a href="http://www.mcselec.com/">BASCOM-AVR</a> , <a href="http://khazama.com/project/programmer/">Khazama AVR Programmer</a> , <a href="http://extremeelectronics.co.in/avr-tutorials/gui-software-for-usbasp-based-usb-avr-programmers/">eXtreme Burner-AVR</a> . <br>  <b>4</b>  <a href="http://www.engbedded.com/fusecalc/">Engbedded Atmel AVR¬Æ Fuse Calculator</a> - AVR jumper calculator. <br>  <b>5</b>  <a href="http://depositfiles.com/files/3n716p8fs">My version is usbasploader, sharpened for a AVR-USB-MEGA16 mock-up board with an ATmega32 microcontroller</a> (a project for AVRStudio with sources and compiled versions for 12 MHz, 16 MHz quartz). <br>  <b>6</b>  <a href="http://microsin.ru/content/view/613/44/">USB device development - how to get started with AVR USB (V-USB) and libusb libraries</a> . <br>  <b>7</b>  <a href="http://microsin.net/programming/AVR/usbasp-bootloader-with-xor-crypt.html">USBasp bootloader with XOR-encryption</a> . </div><p>Source: <a href="https://habr.com/ru/post/98248/">https://habr.com/ru/post/98248/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98239/index.html">Fractal migration of a virtualized data center</a></li>
<li><a href="../98240/index.html">Life is not fair</a></li>
<li><a href="../98241/index.html">Razor - a new presentation engine in ASP.NET</a></li>
<li><a href="../98242/index.html">CEE-SECR 2010 seeks talent</a></li>
<li><a href="../98247/index.html">Mobile Applications</a></li>
<li><a href="../98249/index.html">New corporate identity</a></li>
<li><a href="../98252/index.html">iPad and Kindle vs PC and books</a></li>
<li><a href="../98253/index.html">Be kind, a glass of farmville vanilla</a></li>
<li><a href="../98257/index.html">ICF ITMO - innovative magistracy</a></li>
<li><a href="../98258/index.html">Extreme Summit X650</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>