<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we built the constructor of Telegram bots in 24 hours, and then threw half of them and rewrote</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started on June 20, when I saw this tweet on Twitter of a popular blogger Varlamov: 


 At the same time, I thought: after all, the messenger i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we built the constructor of Telegram bots in 24 hours, and then threw half of them and rewrote</h1><div class="post__text post__text-html js-mediator-article">  It all started on June 20, when I saw this tweet on Twitter of a popular blogger Varlamov: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/768/0bf/08d/7680bf08d79139bdc14fbbb8e6632f36.jpg" alt="image" width="50%" align="right"><br>  At the same time, I thought: after all, the messenger in general, and Telegram in particular, is an ideal way to interact with the client.  Why do we need an application to deliver the latest news if it can just send them to the chat? <br><br>  Why do you need an application for ordering a taxi, when you can chat with your favorite taxi operator ‚ÄúI want a taxi to Domodedovo from metro station Yuzhnoye in 35 minutes‚Äù - and the taxi has been ordered.  Why do you need an application for ordering from a cafe, when you can write to the chat ‚ÄúI want a double espresso and a bagel with a sturgeon‚Äù - and it remains only to send your address.  Such examples of the use of chat can be a huge variety. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the same day, I wrote a small post in the TJournal club news community, where I offered to write a product and create a demo bot within the upcoming hackathon <a href="http://angelhack.moscow/">AngelHack</a> : to subscribe to news and notifications from this community.  Four days later, Pavel Durov officially launched support for bots, and two weeks later we won the <a href="http://angelhack.moscow/">AngelHack</a> nomination from IBM with the Leecero project.  Under the cut a big story ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f7c/7b9/8dc/f7c7b98dccbc45539c96f729e55a6d1c.jpg" width="80%"></div><br><a name="habracut"></a><br><h4>  Prologue: What did we do about this? </h4><br>  Leecero is a product that makes it easy to create a Telegram bot using a script presented as a state machine, support for natural language and third-party REST APIs.  In a nutshell: designer bots. <br><br>  Here is an example of a simple bot script that sends currency rates on demand: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dc7/4aa/b04/dc74aab04045477ea927f7a87fdaa9bd.PNG" width="80%"></div><br><br>  Leecero is a web application built on the basis of ASP.NET MVC Web API, MSSQL and deployed in Azure.  Initially, we planned to build it, and built it, based on the Azure Storage Queue and WebJobs.  In this we are terribly wrong, why - I will tell later. <br><br>  As part of the hackathon, we not only developed a product, but also several demo bots: a currency bot, a news bot, a bot that demonstrates food orders from cafes, and a bot that demonstrates customer support for the bank. <br><br><img src="https://habrastorage.org/files/ae3/c20/ec9/ae3c20ec9c154031aa9bf5775ee44aa1.jpg" width="50%" align="left"><br>  All the bots were written in different YAPs: we had a python, server-side JS, C # - communication with the server takes place through the REST API, and thanks to IBM Bluemix it was not a problem to get rid of them.  At their core, ‚Äúbots‚Äù are simply a set of endpoints that are called at the right moment from Leecero.  The "bot" itself, its script is on the server. <br><br>  One bot was without any code at all, only the script: this is a bot simulating banking support: <br><br><img src="https://habrastorage.org/files/432/dc5/fc7/432dc5fc75f741639b6441c59a38ec84.PNG"><br><br><h4>  Act 1: Oh, what plans </h4><br>  It is necessary to prepare for hackathons.  At least with the technologies used there should be no problems.  Of course, in the framework of the hackathon, you can try to learn something fundamentally new, but you shouldn‚Äôt get better - it will be a shame to lose in the fight against the crookedly connected library.  At that moment I was working with ASP.NET WebAPI, as well as Azure Storage - I decided to use them to create Leecero.  I designed it this way: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9a6/402/c37/9a6402c372ac489ea219e306c38852f3.png" width="60%"></div><br><br>  The idea was that if the load on the service grows, some messages, for example from a large client, are allocated to a separate webjob and are processed by an independent queue - such obvious load balancing, as we thought.  In addition, webjobs are free. <br><br>  At first it was necessary to write or find a ready client Telegram Bot Api.  Fortunately, last year I participated in the Pavel Durov contest for the creation of a Telegram on Android.  I used Xamarin and C #, so I have some things left.  It was quite easy to turn them into the client library for Telegram Bot Api.  I decided to open its code under GPLv3: <a href="https://github.com/xakpc/TelegramBot.Client">TelegramBot.Client</a> <br><br>  WebJob is either a console application that runs on an Azure web app server on a schedule, or a function that can be triggered by an event from Azure Storage.  We were interested in the second option. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[QueueTrigger(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"telegram-messages"</span></span></span></span></span><span class="hljs-function">)] TelegramMessage update, TextWriter logger, CancellationToken token)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.Update.Message.Text == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBotApiClient(update.Token); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = update.Update.Message; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.SendChatAction(message.Chat.Id, <span class="hljs-string"><span class="hljs-string">"typing"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ProcessTelegramMessage(update, client, recognizeResult, logger); }</code> </pre> <br><br>  <code>[QueueTrigger("telegram-messages")]</code> is a key attribute.  Azure takes over most of the work, and when new <i>messages</i> appear in the <i>telegram-messages</i> queue, the ProcessMessage function will be called and executed.  Our task in the future only put the message in the queue. <br><br>  Messages from Telegram bot can be received either through a server poll, or using a webhook.  A webhook requires a link with <i>https</i> , i.e.  with a secure certificate.  Moreover, self-signed certificates are not suitable, we need a certificate from the certification authority.  Fortunately, <i>* .azurewebsites.com</i> is protected by a certificate, so a webhook is created in a couple of minutes: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">// POST: api/Message/token [Route(@"api/Message/{tokenf}/{tokens}")] public async Task&lt;HttpResponseMessage&gt; Post(string tokenf, string tokens, [FromBody]Update value) { var token = string.Concat(tokenf, ":", tokens); System.Diagnostics.Debug.WriteLine("Message from {0}: {1}", token, value.Message.Text); // Create a message and add it to the queue. var tm = new TelegramMessage { Token = token, Update = value }; var message = new CloudQueueMessage(JsonConvert.SerializeObject(tm)); await _queue.AddMessageAsync(message); return new HttpResponseMessage(HttpStatusCode.OK); }</span></span></code> </pre><br>  I will not go into the details of ASP.NET WebApi, I can only say that it is very powerful, flexible and convenient, but at the same time quite confusing - since it is almost entirely based on internal naming conventions, call sequences, etc.  Without knowing them, you can think for a long time that it does not work for you.  However, most of them can be redefined.  In this case, we created a POST method that accepts a url of the form <code>leecero.com/api/Message/{tokenf}/{tokens}</code> with the body Update, serialized as JSON.  Or XML.  What kind of message and how to deserialize it will determine ASP.NET itself based on the headers.  And the line <code>await _queue.AddMessageAsync(message);</code>  put our message in the queue for processing. <br><br>  As you can see, building a work product with Azure has proven relatively simple.  I even took the time to wander around the small part of Mail.ru that is accessible to us and pofotkat, as well as sleep an hour. <br><br><img src="https://habrastorage.org/files/e5f/f8e/109/e5ff8e109d3a4f5abb7a213ccb6140bb.jpg" align="left" width="48%"><img width="48%" src="https://habrastorage.org/files/1c0/d9c/892/1c0d9c892f3e4fa0bca00c5627e6ea20.jpg"><br><br>  The fun itself began in the morning when we finished writing bots and began actively preparing for the demonstration.  After lengthy testing, we found out that the bots have been thinking for quite a long time - then we hung all the time with stopwatches trying to find a bottleneck. <br><br><pre> <code class="bash hljs">2015-07-20T18:48:20 PID[3016] Verbose ChatStateController.NextState - GetCurrentState: 00:00:00.9852497 2015-07-20T18:48:22 PID[3016] Verbose ChatStateController.NextState - DbQuery: 00:00:01.2952876 2015-07-20T18:48:22 PID[3016] Verbose CurrentState: Pretty, input: /start, class: Unknown 2015-07-20T18:48:22 PID[3016] Verbose CurrentState after Pretty, action 2015-07-20T18:48:22 PID[3016] Verbose ChatStateController.NextState - Save state: 00:00:00.3723358 2015-07-20T18:48:22 PID[3016] Verbose Process text message: 00:00:02.7199401 2015-07-20T18:48:22 PID[3016] Verbose Processing 111111:TOKEN/C_ID with message /start 2015-07-20T18:48:22 PID[3016] Verbose Action:   , Term: 2015-07-20T18:48:22 PID[3016] Verbose Send simple message without action: 00:00:00.1108038 2015-07-20T18:48:22 PID[3016] Verbose Sucessfully sent message    from bot to C_ID</code> </pre><br>  At first we thought that Telegram continues to be under DDOS and therefore everything slows down.  Then we thought that the reason for accessing the database (where we store the script) or to Azure Table Storage (where the key-value storage is the current chat state) - however, thanks to caching, all requests after the first were executed in a split second.  In the end, we decided to abandon the attempts to speed up the service, as a new problem arose: the web job, which was launched in the continuous mode, fell asleep after some time of inactivity and it took minutes to wake up!  Imagine what would happen if he fell asleep during a speech. <br><br><img src="https://habrastorage.org/files/a03/91c/937/a0391c9379b0434ea12f2d5e754cda2a.jpg" align="right" width="20%"><br><br>  In general, I had to customize the service, spamming bots all the time while the performance was going on - so that they would not relax. <br><br><h4>  Intermedia - NLP, it‚Äôs a natural language processing </h4><br>  I am writing above about natural language support.  And it really is in Leecero - thanks to the publicly available NLP-as-Service.  In Russia, I personally consider Yandex to be the largest specialist in natural languages.  For example, you can recall the long-standing project <a href="http://aot.ru/">Automatic Text Processing</a> available via the LGPL.  Today, as I understand it, the authors work in Yandex.  But for a hackathon, connecting to an ASP.NET COM library application is too difficult. <br><br><img src="https://habrastorage.org/files/335/161/83e/33516183e6434250b62496f53e425fdf.PNG" width="50%" align="left"><br><br>  Therefore, my choice fell on the service Yandex SpeechKit Cloud.  Many have heard that he is able to recognize the voice, but how many people know that he has a module for the selection of semantic objects from the text?  The module is able to identify the date and time from the entered phrase (for example, ‚Äútomorrow‚Äù), first name, last name and address - which means that Leecero can do it too!  In addition, it has a built-in stemmer and a morphological analyzer that highlights parts of a sentence: verbs, nouns, etc.  One problem - for such tasks is expensive, $ 5 per 1000 requests.  Therefore, a call to SpeechKit Cloud is the second stage of processing a phrase, first it is used by a stemmer from the guys from Stfordford, since it is available via GPLv2. <br><br>  However, the English language remained not covered!  Today SpeechKit Cloud supports Russian, Ukrainian, Turkish.  Therefore, for the analysis of English phrases, we connected AlchemyApi from IBM.  AlchemyApi is a company that has been doing natural language processing with machine learning since 2009.  She lived quietly, and in 2015 was bought by IBM, integrated into Watson and became part of the IBM-IBM Bluemix solution.  And what is most beautiful is available along with other Watson services through a public API <br><img src="https://habrastorage.org/files/f00/a17/169/f00a171698844c1487c10cd25651986a.PNG"><br><br>  AlchemyApi has great capabilities.  Of course, 24 hours on the hackathon is not enough to study them all.  Here is a small example that we managed to implement - the selection of the order of key entities from the phrase: the actual products that must be ordered. <br><br><img src="https://habrastorage.org/files/0e5/67e/e2a/0e567ee2a39a43aeb9c629abd3c5d240" width="40%" align="left"><br><br>  As you can see, the service parses the offer, extracts keywords from it and gives them a list in the form of xml.  This is enough to find products in the database for these keywords and place an order.  However, I noticed that AlchemyApi works better on large texts than on short phrases.  But, as I understand it, these are all questions of learning - questions that are clearly beyond the scope of this long-running article. <br><br>  Using AlchemyApi in the program is very simple - they have a <a href="https://github.com/AlchemyAPI/alchemyapi_csharp">beta version of C # api</a> v 0.10, in fact there is the usual REST. <br>  Use trivial <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Create an AlchemyAPI object. AlchemyAPI.AlchemyAPI alchemyObj = new AlchemyAPI.AlchemyAPI(); // Load an API key alchemyObj.SetAPIKey("KEY"); string order = "I want to order one Margarita Pizza, two small colas and Ham Pizza"; var xml = alchemyObj.TextGetRankedNamedEntities(order); System.Diagnostics.Debug.WriteLine(xml); var xml2 = alchemyObj.TextGetRankedKeywords(order); System.Diagnostics.Debug.WriteLine(xml2);</span></span></code> </pre><br>  The output keywords from the phrase <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">results</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">status</span></span></span><span class="hljs-tag">&gt;</span></span>OK<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">status</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span>By accessing AlchemyAPI or using information generated by AlchemyAPI, you are agreeing to be bound by the AlchemyAPI Terms of Use: http://www.alchemyapi.com/company/terms.html<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usage</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">totalTransactions</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">totalTransactions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">language</span></span></span><span class="hljs-tag">&gt;</span></span>english<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">language</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keywords</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span>0.926847<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span>Margarita Pizza<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span>0.820088<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span>Ham Pizza<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span>0.642818<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relevance</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span>small colas<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keyword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">keywords</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">results</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h4>  Act 2: One day after </h4><br>  Having rejoiced at the victory and having slept off a bit, I looked into the code that we wrote.  First, I immediately found the cause of the bots' brakes - it turns out that WebJob works with the queue using the polling method with a minimum interval of 2 seconds.  Those.  less than the interval can not be put. <br><br>  The interval is set when creating a job: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// HACK:  CS   JobHostConfiguration configuration = new JobHostConfiguration("cs"); configuration.Queues.MaxPollingInterval = TimeSpan.FromSeconds(2); var host = new JobHost(configuration); host.RunAndBlock(); }</span></span></code> </pre><br>  The second problem (falling asleep WebJob) was solved by installing a daw in the web service settings. <br><br><img src="https://habrastorage.org/files/2fb/b93/e9a/2fbb93e9a84242548249b35745996bb3.PNG"><br><br>  Maybe.  I did not check.  When I realized this, I threw out everything related to WebJob and Azure Queue and rewrote everything in good old TPL Dataflow.  And I immediately added a DI-container and fixed half the services.  In general, my personal hackathon lasted one more night. <br><br>  <b>TPL.Dataflow</b> is a library designed to implement a Data Flow design pattern or processing pipeline. <br><br>  In a nutshell, the library allows you to build a pipeline consisting of blocks for storing or processing data, linking them according to some condition.  Thus, I build a pipeline, where the user‚Äôs input is sent to the input, and the output is answered according to a scenario, which can include inside of me, including  and calls to third-party web api.  Dataflow gives me simple, possibly parallel execution of any blocks, filtering and queue management.  And unlike the Azure Queue, everything is in memory and very fast.  As I understood, Azure queues are only suitable for converting images. <br><br>  I started with a very simple conveyor: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">// setup TPL dataflow _messageBuffer = new BufferBlock&lt;TelegramMessage&gt;(); var messageProcessor = new ActionBlock&lt;TelegramMessage&gt;(async message =&gt; { try { await _processor.ProcessMessage(message); } catch (Exception ex) { Container.GetInstance&lt;ILogger&gt;().Log(ex.ToString()); } }); _messageBuffer.LinkTo(messageProcessor);</span></span></code> </pre><br><br>  The message is put there directly from WebHook, just like it was with the Azure queue.  It showed itself quite well, but I want to expand it by adding several stages of processing the message, including: language classification, morphological analysis, calling third-party API functions, the answer itself.  Now I am designing this scheme, and at the same time I am adding support for media files and English morphology. <br><br><h4>  Epilogue: So what was the result? </h4><br>  I am sure that many people will find thousands of uses for Telegram bots and bots.  Already today, Aviasales made a bot to search for air tickets, Meduza made a bot that is looking for news with the / cat tag, and blogger Ilya Varlamov sends notifications about all his posts directly to Telegram. </div><p>Source: <a href="https://habr.com/ru/post/262967/">https://habr.com/ru/post/262967/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262943/index.html">Insert in the middle: ArrayList vs. LinkedList</a></li>
<li><a href="../262951/index.html">The first ever ReactOS Hackfest</a></li>
<li><a href="../262953/index.html">Creating plug-ins for AutoCAD using the .NET API (part 6 - finding and changing objects in a drawing)</a></li>
<li><a href="../262957/index.html">The magic of tensor algebra: Part 10 - Get the angular velocity vector. We work on the shortcomings</a></li>
<li><a href="../262963/index.html">Emmett Shire: How to conduct interviews with users</a></li>
<li><a href="../262969/index.html">Results of the Summer Hola JS Programming Contest</a></li>
<li><a href="../262971/index.html">Thinking about error handling</a></li>
<li><a href="../262977/index.html">Message broker for ZMQ-based service architecture - or developer‚Äôs leisure</a></li>
<li><a href="../262979/index.html">The subtleties of working with PassportJs</a></li>
<li><a href="../262983/index.html">Personal web server on Wolfram Language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>