<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Audit of one ‚Äúslow‚Äù application in one large concern</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In general, I just wanted to respond to this comment and, as an example, cite the unexpected results of one audit of a web application I did, but the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Audit of one ‚Äúslow‚Äù application in one large concern</h1><div class="post__text post__text-html js-mediator-article">  In general, I just wanted to respond to <a href="https://habr.com/post/256793/">this</a> comment and, as an example, cite the unexpected results of one audit of a web application I did, but the answer was very cumbersome. <br>  So this article was born. <br><br><h4>  Introduction </h4><br>  The idea was that sometimes in the corporate sector, hiding behind far-fetched standards or imposed standards from security, completely unjustified and sometimes completely wild implementations of the latter occur, often bordering on impossible work conditions.  For example, CIO and others like it (either careless or just lazy performers), guided by such politicians, might have overdone it, and often did not find (or did not look for) a better solution. <br><br>  As a result, we have antiviruses on servers, with all the consequences, <i>because it just has to be on every computer</i> .  Employees are forced to work under the administrator (aka MakeMeAdmin), <i>because creating an admin account (tech-user) is stupid for scripts, restarting and debugging services, well, not at all possible (well, all the same, there is the same antivirus)</i> .  The policies allow you to run the executable file from anywhere (network, temporary directory, etc.), <i>because some kind of update service does not know how else (no big deal - again, the antivirus as an argument).</i>  Etc.  etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, I clearly understand where such requirements grow from.  Quite often, these are really the conditions of customers-customers, the requirements of the parent company or partner company, or de facto industry standards that you just need to meet.  Well, that is  stupidly not going anywhere. <br>  But, the fact is that technically just some things, with regard to security, are completely unjustified, worse than that, in reality, they are not at all secure, and moreover, they hinder both the development and the productive work of the same client. <br>  And if you cover your fifth point (using false "standards"), you decide to meet the security requirement of the evil one, then do it at least including your head so that it does not affect (or minimally influence) the company's productivity. <br><br>  Example: somehow they fought with one well-known anti-virus (provably large, probably somewhere in the area of ‚Äã‚Äãanalytics and real-time scanning queues) - with a very large server load (32 cores&gt; = 50% cpu load): <ul><li>  the antivirus blocks (from several milliseconds to 30 seconds!) access to files, after renaming them - as a result, a multi-threaded pipeline (asynchronous job queue) periodically crashes with access denied when accessing, for example, temporary, newly created and then renamed files from another flow, reporting the end of the work.  Given that the working folder seems to be <u>completely excluded</u> from real time scanning. </li><li>  or worse, puts the child processes to sleep (suspended) and forgets to ‚Äúwake up‚Äù them, and the stream in the ancestor waits endlessly for the end of the sleeping child. </li></ul>  And in fact, it <i>is not possible to</i> disable it in production on servers (even temporarily as evidence, since they usually cover one place with such an antivirus). <br><br>  For example, that it is necessary to divide the same network and insert the same antivirus behind the NAT.  Or at least check for such sores and replace with another, more reliable one.  Compare this cost with, say, man-hour * 25,000 employees, every day, minute by minute, spending on stupid waiting for an application to respond. <br>  As a result, the number of bikes of type ‚Äúsafe_rename‚Äù, ‚Äúreal_delete‚Äù or ‚Äústart_process_with_observe‚Äù around projects grows.  The same CIO would quickly reconsider its position if he (his subdivision) were collectively invoiced for the total time of ‚Äúidleness‚Äù (waiting) of all employees. <br><a name="habracut"></a><br><h4>  Audit </h4><br>  I somehow had to do an audit of one more or less large application in one very large concern.  Web application on a company intranet.  It is rumored that, it seems, did not shine with speed before.  And after some release there, everything became very, very slowly. <br>  The manufacturer claimed that everything was all right with them - ostensibly according to the logs it was not visible that the application was overloaded, but it was impossible to simulate such a load test as in production.  In general, the client's patience is over - well, the audit itself ... <br><br>  It all started with writing analyzers of the logs sent (thank God, the protocols in the application, more precisely, in the app-server, you could pretty much detail).  As a result, huge logs are reduced to a more or less readable form.  An example of a cropped protocol after the analyzer (and set up as a habraparser), who is suddenly interested, can be seen under the spoiler below - I‚Äôll just say that the logs did not show anything obvious.  Those.  servers (application) well, yes - not fast (somewhere SQL slows down, somewhere - storage or NAS), but in general they could, in principle, cope with the load that exceeds the analyzed one ten times. <br><br><div class="spoiler">  <b class="spoiler_title">An example of an analysis protocol ...</b> <div class="spoiler_text"><table border="1"><tbody><tr><td>  <b>Analyze:</b> </td></tr><tr><td>  Analyze-Time </td><td>  9338645 <br>  (155,644 min) </td><td>  07:45:09 - 10:20:48 </td></tr><tr><td>  Idle (ms) </td><td>  6069160 (101,153 min) </td><td>  Idle-avg: </td><td>  735.66 </td><td rowspan="2">  Count: </td><td rowspan="2">  8250 </td></tr><tr><td>  Busy (ms) </td><td>  3269485 (54,491 min) </td><td>  Busy-AVG: </td><td>  396.3 </td></tr><tr><td>  Total (ms) </td><td>  4536133 (75,602 min) </td><td></td></tr><tr><td>  AVG (ms) </td><td>  285.6 </td><td></td></tr><tr><td>  Requests </td><td>  15883 </td><td></td><td></td><td></td><td></td></tr><tr><td>  Users </td><td>  106 </td><td>  Avg (ms) </td><td>  Min (ms) </td><td>  Max (ms) </td></tr><tr><td>  WorkTime (ms) </td><td>  521217468 (8.686,958 min) </td><td>  4917145 (81.952 min) </td><td>  344 (0,006 min) </td><td>  9322426 (155,374 min) </td></tr><tr><td>  ServerTime (ms) </td><td>  4536133 (75,602 min) </td><td>  42793 (0.713 min) </td><td>  142 (0.002 min) </td><td>  298511 (4.975 min) </td></tr><tr><td>  Name </td><td>  /app/mailbox.htm </td><td>  /app/docmain.htm </td><td>  /port/result.htm </td><td>  /app/tree.htm </td><td>  /app/view.htm </td><td>  /app/docnavi.htm </td><td>  /port/docview.htm </td><td>  /app/result.htm </td><td>  /port/report2.htm </td><td>  /port/search.htm </td><td>  /port/pdfview.htm </td><td>  /app/action.htm </td><td>  ... </td><td>  /app/empty.htm </td></tr><tr><td>  Time (ms) </td><td>  1135731 (18,929 min) </td><td>  770339 (12,839 min) </td><td>  616371 (10,273 min) </td><td>  606983 (10,116 min) </td><td>  286,304 (4,772 min) </td><td>  255469 (4.258 min) </td><td>  173729 (2.895 min) </td><td>  135370 (2.256 min) </td><td>  109145 (1,819 min) </td><td>  72917 (1.215 min) </td><td>  34346 (0.572 min) </td><td>  32499 (0.542 min) </td><td>  ... </td><td>  0 (0.000 min) </td></tr><tr><td>  AVG (ms) </td><td>  1.108.03 </td><td>  514.59 </td><td>  1.064.54 </td><td>  211.35 </td><td>  239.79 </td><td>  222.73 </td><td>  622.68 </td><td>  474.98 </td><td>  5.457.25 </td><td>  197.07 </td><td>  602,56 </td><td>  172.87 </td><td>  ... </td><td>  0 </td></tr><tr><td>  Count </td><td>  1025 </td><td>  1497 </td><td>  579 </td><td>  2872 </td><td>  1194 </td><td>  1147 </td><td>  279 </td><td>  285 </td><td>  20 </td><td>  370 </td><td>  57 </td><td>  188 </td><td>  ... </td><td>  one </td></tr><tr><td>  <b>User-Times:</b> </td></tr><tr><td>  UID </td><td colspan="4">  net \ u101165 </td><td colspan="4">  net \ u144102 </td><td colspan="4">  net \ u193619 </td><td colspan="4">  ... </td></tr><tr><td>  Time (ms) </td><td colspan="4">  298511 (4.975 min) </td><td colspan="4">  238661 (3.978 min) </td><td colspan="4">  168190 (2.803 min) </td><td colspan="4">  ... </td></tr><tr><td>  AVG (ms) </td><td colspan="4">  2.446.81 </td><td colspan="4">  269.07 </td><td colspan="4">  282.2 </td><td colspan="4">  ... </td></tr><tr><td>  Count </td><td colspan="4">  122 </td><td colspan="4">  887 </td><td colspan="4">  596 </td><td colspan="4">  ... </td></tr><tr><td>  Worktime </td><td colspan="4">  131,818 min 07: 55: 26-10: 07: 16 </td><td colspan="4">  117.066 min 08: 23: 28-10: 20: 32 </td><td colspan="4">  150,534 min 07: 46: 35-10: 17: 07 </td><td colspan="4">  ... </td></tr><tr><td rowspan="6">  Requests </td><td>  Name </td><td>  Time (ms) </td><td>  AVG (ms) </td><td>  Count </td><td>  Name </td><td>  Time (ms) </td><td>  AVG (ms) </td><td>  Count </td><td>  Name </td><td>  Time (ms) </td><td>  AVG (ms) </td><td>  Count </td><td>  ... </td></tr><tr><td>  /port/result.htm </td><td>  280962 (4.683 min) </td><td>  12.771.00 </td><td>  22 </td><td>  /app/docmain.htm </td><td>  89560 (1,493 min) </td><td>  621.94 </td><td>  144 </td><td>  /app/mailbox.htm </td><td>  53689 (0.895 min) </td><td>  1.677.78 </td><td>  32 </td><td>  ... </td></tr><tr><td>  /port/docview.htm </td><td>  11938 (0.199 min) </td><td>  746.13 </td><td>  sixteen </td><td>  /app/tree.htm </td><td>  55327 (0.922 min) </td><td>  278.03 </td><td>  199 </td><td>  /app/docmain.htm </td><td>  39019 (0.650 min) </td><td>  750,37 </td><td>  52 </td><td>  ... </td></tr><tr><td>  /port/search.htm </td><td>  3750 (0.063 min) </td><td>  250 </td><td>  15 </td><td>  /app/docnavi.htm </td><td>  42245 (0.704 min) </td><td>  291.34 </td><td>  145 </td><td>  /app/tree.htm </td><td>  22122 (0.369 min) </td><td>  254.28 </td><td>  87 </td><td>  ... </td></tr><tr><td>  /port/tree.htm </td><td>  797 (0.013 min) </td><td>  88.56 </td><td>  9 </td><td>  /app/view.htm </td><td>  22986 (0.383 min) </td><td>  247.16 </td><td>  93 </td><td>  /app/view.htm </td><td>  15830 (0.264 min) </td><td>  316.6 </td><td>  50 </td><td>  ... </td></tr><tr><td>  /port/view.htm </td><td>  640 (0.011 min) </td><td>  40 </td><td>  sixteen </td><td>  /app/mailbox.htm </td><td>  16126 (0.269 min) </td><td>  1.466.00 </td><td>  eleven </td><td>  /port/result.htm </td><td>  9622 (0.160 min) </td><td>  253.21 </td><td>  38 </td><td>  ... </td></tr></tbody></table><br></div></div> Roughly speaking, even the total reduced idle-time of all server workers (101,153 min out of 155,644 min) reports this. <br><br>  I will not load the reader, with what else I had to face in search of the malicious type, which pulled the handbrake. <br>  After fortune telling on the coffee grounds, everything was supposed to be from the same antivirus (where it would be without it) and balancer problems, to a stupid swap on the client or any browser extensions or slow javascript agony in the browser, in some asynchronous calls. <br>  It all went to the point that hell code audit would be ahead.  In the meantime, I decided to check on the spot how it behaves everything. <br><br>  They show the work of the application - everything is really very slow.  The browser creaks sluggishly, the pages after the click open frame by frame and slowly as a modem.  There is no swap - nothing is eaten away at all. <br><br>  And having spent just an hour searching, I was, as a result, in silent horror <s>(there is actually another word)</s> . <br><br>  But in order: first I squeezed my proxy, with accesslog enabled, between the browser and the server, worn out with MITM with the substitution of NTLM-credential (the proxy also worked under the user account), and with the substitution of absolute URLs for another port, etc.  I was expecting to see in the logs that the application had nothing to do with it - it was either an antivirus, or something with a browser (scripts are there, etc.). <br>  And after making a few clicks in the application, I unexpectedly found in the log file a good hundred mini-requests from the browser for each invoked request (for each click).  <b>All statics</b> , i.e.  icons, static scripts and styles were processed again and again <b>with each click</b> - i.e.  we have one or two large requests 200 and many (very many) small 304 (Not Modified). <br><br>  However, the application, as expected, sent the correct headers for caching (Cache-Control, Expires, etc.) for statics. <br>  In short, it turned out - the browser's cache was just stupidly ‚Äúturned off‚Äù (by politicians)! <br>  <b>In the whole concern !!!</b> <br>  Well, that is  The checkmark ‚ÄúCheck for newer version‚Äù was checked in ‚ÄúEvery time I visit the webpage‚Äù. <br><br>  Add to the whole NTLM from above (with a handshake back and forth and a request-response to the PDC from both) and given that we have a lot of applications in the company on the web architecture, multiply the number of employees of the entire group and Voila!  You can go to the server room and admire the red glow of the red-hot extremely network equipment. <br>  Those.  The browser not only sends and receives a bunch of small request-responses, but also waits for confirmation from the last resource in the page - I am unchanged to complete the rendering and show the page.  It seems to me that the anti-virus, constantly bombarded by additional requests, has contributed to the big picture (although I don‚Äôt know its reaction to the same script, which returned from 304, for example). <br>  Well, and as a bonus from above - a stupid, utterly stupid network - about how a huge mass of mini-packets can brighten up the life of the entire network segment as a whole and of a particular router in particular, network administrators can tell long stories (usually obscenely). <br><br>  By the way, I was lucky to say the least with the search (and the client) - the accesslog for statics was turned on in my proxy settings, although it was usually turned off (I just tested 304 and their ilk and did not correct the configuration back).  Well, no one expected (the administrators present there, too, went blotched) that the staff responsible for the policies (in this case, the browser settings) are so incompetent.  So much so that just borders, IMHO, with the basis for dismissal from work. <br><br>  According to rumors, the cache was ‚Äúturned off‚Äù because in a completely different project, some kind of major version of some SAP components there was something else she couldn‚Äôt do otherwise (maybe Cache-Control, Expires, etc. were not put down there). d. or incorrectly implemented If-Modified-Since).  The point is that the testers did not find it, and the performers who rolled out the major release in production could not roll back and did not find anything better than stupidly ‚Äúturn off‚Äù the expires and cache-control checks.  Once again - in the whole concern!  That is, for all applications and surfing as such. <br>  They could, for example, put something proxying in front of the application to change the headers only for specifically these URLs, or for example, crash into the application server for "rewrite" in it directly.  You can come up with a dozen solutions better. <br>  By the way, instead of recognizing the file - according to rumors, they argued with foaming at the mouth that it was necessary and good, and that even Microsoft recommends these settings for IE.  As a result, your humble servant had, as an attachment to the progress report, to write also a ‚Äúdissertation‚Äù on the topic ‚ÄúWhy is bad - this is not good.‚Äù <br><br>  And from the ordinary users of that company, I had the reputation of a wizard who had solved a problem in an hour that local IT specialists could not find for months (or even years). <br>  Can you imagine, suddenly not only the application, but everything else in the company suddenly began to work much faster!  Up to the last network printer ... <br><br>  In return, I ask you not to kick with words like ‚ÄúProgrammers also make mistakes,‚Äù and with the hope that there may still be responsible persons (as well as performers) will listen to us and at least sometimes will turn on our head ... It helps a lot. </div><p>Source: <a href="https://habr.com/ru/post/256975/">https://habr.com/ru/post/256975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256961/index.html">How Virtuozzo Improves Docker Security for Service Providers</a></li>
<li><a href="../256963/index.html">Frameworks spoil development</a></li>
<li><a href="../256965/index.html">What is Virtual DOM?</a></li>
<li><a href="../256967/index.html">Apple is investing $ 1.9 billion in EU infrastructure. What is it, expansion to Europe or escape from the USA?</a></li>
<li><a href="../256971/index.html">Waski loader is used to distribute the banker Dyreza Trojan</a></li>
<li><a href="../256977/index.html">Step-by-Step: Preparing Mac OS Installation Packages. Part one</a></li>
<li><a href="../256979/index.html">Create an isomorphic application on React and Flummox</a></li>
<li><a href="../256981/index.html">The use of STM32 in industrial machines on the example of the blow molding machine CHODOS (Czech Republic)</a></li>
<li><a href="../256985/index.html">Step-by-Step: Preparing Mac OS Installation Packages. Part two. Package Creation in Package Maker</a></li>
<li><a href="../256987/index.html">Chatbot on neural networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>