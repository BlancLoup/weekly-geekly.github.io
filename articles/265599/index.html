<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Server and deployment configuration: rvm, rails, puma, nginx, mina</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 I was pushed to create this article by a recent post about deploe . The following article describes how to deploy a project based on rben...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Server and deployment configuration: rvm, rails, puma, nginx, mina</h1><div class="post__text post__text-html js-mediator-article"><h2>  Prehistory </h2><br>  I was pushed to create this article by a recent <a href="http://habrahabr.ru/post/265459/">post about deploe</a> .  The following article describes how to deploy a project based on rbenv, but I will describe the situation with rvm and setting upstart. <br><br><h2>  Tasks and requirements </h2><br>  So, given: the simplest RubyOnRails application.  In the case of the deployment of my project, I set myself the following tasks: <br><ul><li>  OS Ubuntu LTS 14.04; </li><li>  Nginx web server; </li><li>  Puma application server; </li><li>  Using RVM to install the required version of ruby; </li><li>  Automatic launch of the application when starting the VPS server, the ability to manage the application as a service; </li><li>  Automate the deployment process using mina; </li></ul><br>  <b>Why Ubuntu?</b> <br>  I just got used to it (more precisely, to its derivative - Linux Mint). <br><br>  <b>Why puma, and not unicorn or passenger?</b> <br>  I heard quite good reviews about puma, and unicron has a ugly site.  Passenger, in my opinion, violates the principle of a single duty - I want to have a web server and an application server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Why RVM?</b> <br>  I got used to it - I have it installed on the local machine, I want to see it in production. <br><br>  <b>Why mina?</b> <br>  It really is easier than capistrano and faster.  The speed is achieved due to the fact that for each task capistrano creates a separate ssh connection.  Mina forms the shell script and executes it within one connection. <br><br>  In this case, the task is easily divided into 3 stages: <br><ol><li>  Make sure that the application starts correctly (without automation); </li><li>  Configure the server so that our rails application works as a full service; </li><li>  Based on this, configure automated deployment using mina. </li></ol><br><a name="habracut"></a><br><h2>  First start </h2><br>  A webapp user has been created on the server, on behalf of which our application will run.  Installed rvm (in this example, only for the user webapp), ruby ‚Äã‚Äãversion we need, nginx and so on.  The following line is present in the Gemfile: <br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># ... gem 'puma', group: :production # ...</span></span></code> </pre> <br>  <b>Preset mina</b> <br><br>  Add the following line to the Gemfile: <br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'mina'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:development</span></span></code> </pre><br>  Then we generate the configuration file with the command: <br><pre> <code class="bash hljs">mina init</code> </pre> <br>  Then we will bring the created file config / deploy.rb to the following form: <br><div class="spoiler">  <b class="spoiler_title">config / deploy.rb</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/bundler'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/rails'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/git'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:domain</span></span>, <span class="hljs-string"><span class="hljs-string">'awesome_address'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-string"><span class="hljs-string">'webapp'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:deploy_to</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/webapp/awesome'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:repository</span></span>, <span class="hljs-string"><span class="hljs-string">'https://github.com/awesome_user/awesome.git'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:branch</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:shared_paths</span></span>, [<span class="hljs-string"><span class="hljs-string">'config/database.yml'</span></span>, <span class="hljs-string"><span class="hljs-string">'config/secrets.yml'</span></span>, <span class="hljs-string"><span class="hljs-string">'config/puma.rb'</span></span>, <span class="hljs-string"><span class="hljs-string">'log'</span></span>] task <span class="hljs-symbol"><span class="hljs-symbol">:setup</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:environment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/log"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/log"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/puma"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/puma"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/database.yml"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/secrets.yml"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/puma.rb"]</span></span> queue <span class="hljs-string"><span class="hljs-string">%[echo "-----&gt; Be sure to edit '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/database.yml', 'secrets.yml' and puma.rb."]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> desc <span class="hljs-string"><span class="hljs-string">"Deploys the current version to the server."</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:deploy</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:environment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> deploy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment"># Put things that will set up an empty directory into a fully set-up # instance of your project. invoke :'git:clone' invoke :'deploy:link_shared_paths' invoke :'bundle:install' #invoke :'rails:db_migrate' #invoke :'rails:assets_precompile' #invoke :'deploy:cleanup' end end</span></span></code> </pre><br></div></div><br>  This file commented out the lines of code responsible for the implementation of routine operations for the deployment of the project.  For the time being, we will carry out these actions manually. <br><br>  I also want to note that I do not add the mina configuration file to the version control. <br><br>  Then run the command: <br><pre> <code class="bash hljs">mina setup</code> </pre> <br>  And we get the necessary folder structure on the server, as well as configuration files that must be filled with correct data.  It is assumed that these files will not be added to version control, but stored exclusively on the server.  Below is an example of the minimum configuration for puma. <br><div class="spoiler">  <b class="spoiler_title">puma.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs">environment <span class="hljs-string"><span class="hljs-string">"production"</span></span> bind <span class="hljs-string"><span class="hljs-string">"unix:///home/webapp/awesome/shared/puma/puma.sock"</span></span> pidfile <span class="hljs-string"><span class="hljs-string">"/home/webapp/awesome/shared/puma/puma.pid"</span></span> state_path <span class="hljs-string"><span class="hljs-string">"/home/webapp/awesome/shared/puma/puma.state"</span></span> activate_control_app</code> </pre><br></div></div><br>  Also, I do not purposely store the puma.rb file in version control, since  I believe that the server startup configuration can be individual as well as the database settings. <br><br>  For a note, it is enough to create a file config / puma.sample.rb with an example in the application. <br><br>  Now let's launch the deployment of our application: <br><pre> <code class="bash hljs">mina deploy</code> </pre> <br>  After executing this command, a symbolic link / home / webapp / awesome / current will appear on the server with the code of our project on the server. <br><br>  <b>Nginx configuration</b> <br>  Create the / etc / nginx / sites-available / awesome file with the following contents: <br><div class="spoiler">  <b class="spoiler_title">awesome</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> awesome { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:///home/webapp/awesome/shared/puma/puma.sock; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> default_server; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> default_server ipv6only=<span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/webapp/awesome/current/public; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> localhost; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://awesome; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* ^/assets/</span></span> { <span class="hljs-comment"><span class="hljs-comment"># Per RFC2616 - 1 year maximum expiry expires 1y; add_header Cache-Control public; # Some browsers still send conditional-GET requests if there's a # Last-Modified header or an ETag header even if they haven't # reached the expiry date sent in the Expires header. add_header Last-Modified ""; add_header ETag ""; break; } }</span></span></code> </pre></div></div><br>  Then create a symbolic link: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/nginx/sites-enabled/ ln -s ../sites-available/awesome awesome</code> </pre> <br>  And restart nginx: <br><pre> <code class="bash hljs">service nginx restart</code> </pre> <br>  <b>Manual application launch</b> <br>  Now we will prepare and launch our project. <br>  We prepare: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/webapp/awesome/current bash --login rvm use ruby-2.2.1 bundle install --without development:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --path ./vendor/bundle --deployment RAILS_ENV=production bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rake db:migrate RAILS_ENV=production bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rake assets:precompile</code> </pre> <br>  Run: <br><pre> <code class="bash hljs">bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> puma -C config/puma.rb</code> </pre> <br>  We open the project in the browser - everything should work. <br><br><h3>  Application as a service </h3><br>  In order for the application to work as a service and run when the system starts / reboots, you need to create an init.d script or upstart configuration. <br><br>  I chose upstart, because the resulting file is much shorter and easier to read. <br><br>  In order to correctly make friends upstart and rvm, <a href="https://rvm.io/deployment/init-d">create a wrapper</a> for the executable files of our gems: <br><pre> <code class="bash hljs">rvm <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> create awesome ruby-2.2.1@default</code> </pre> <br>  Then create the upstart configuration /etc/init/awesome.conf: <br><div class="spoiler">  <b class="spoiler_title">awesome.conf</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">description "Awesome puma service" # This starts upon bootup <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stops <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> shutdown <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [<span class="hljs-number"><span class="hljs-number">2345</span></span>] stop <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [<span class="hljs-number"><span class="hljs-number">06</span></span>] setuid webapp setgid webapp respawn respawn <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> script cd /home/webapp/awesome/<span class="hljs-keyword"><span class="hljs-keyword">current</span></span> /home/webapp/.rvm/wrappers/awesome/bundle exec puma -C config/puma.rb <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> script</code> </pre></div></div><br>  And now we can do this: <br><pre> <code class="bash hljs">start awesome stop awesome restart awesome status awesome</code> </pre> <br><br><h3>  Final automation </h3><br>  Since the deployment will occur on behalf of the user webapp, and to restart the service, we need superuser rights, we add the appropriate line in sudoers. <br><br>  Run the command: <br><pre> <code class="bash hljs">visudo</code> </pre> <br>  Add: <br><pre> <code class="hljs pgsql">webapp <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>) NOPASSWD: /sbin/<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> awesome, /sbin/stop awesome, /sbin/<span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> awesome, /sbin/status awesome</code> </pre><br>  And save. <br><br>  <b>Mina again</b> <br>  In such cases, mina offers to use our own mina / rvm module, however, rvm gives us the ability to create aliases for the ruby ‚Äã‚Äãand gemset versions - wrappers. <br><br>  In order for the wrappera bundler to start at a delay, you need to add the following line: <br><pre> <code class="ruby hljs">set <span class="hljs-symbol"><span class="hljs-symbol">:bundle_bin</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/webapp/.rvm/wrappers/awesome/bundle'</span></span></code> </pre><br>  Also add a task to restart the server: <br><pre> <code class="ruby hljs">desc <span class="hljs-string"><span class="hljs-string">"Restart the puma web server."</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:restart</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> queue <span class="hljs-string"><span class="hljs-string">'sudo restart awesome'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Adding all this and uncommenting the necessary lines in the deploy task, we get the following: <br><div class="spoiler">  <b class="spoiler_title">deploy.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/bundler'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/rails'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'mina/git'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:domain</span></span>, <span class="hljs-string"><span class="hljs-string">'awesome_address'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-string"><span class="hljs-string">'webapp'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:deploy_to</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/webapp/awesome'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:repository</span></span>, <span class="hljs-string"><span class="hljs-string">'https://github.com/awesome_user/awesome.git'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:branch</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:bundle_bin</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/webapp/.rvm/wrappers/awesome/bundle'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:shared_paths</span></span>, [<span class="hljs-string"><span class="hljs-string">'config/database.yml'</span></span>, <span class="hljs-string"><span class="hljs-string">'config/secrets.yml'</span></span>, <span class="hljs-string"><span class="hljs-string">'config/puma.rb'</span></span>, <span class="hljs-string"><span class="hljs-string">'log'</span></span>] task <span class="hljs-symbol"><span class="hljs-symbol">:setup</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:environment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/log"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/log"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[mkdir -p "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/puma"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[chmod g+rx,u+rwx "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/puma"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/database.yml"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/secrets.yml"]</span></span> queue! <span class="hljs-string"><span class="hljs-string">%[touch "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/puma.rb"]</span></span> queue <span class="hljs-string"><span class="hljs-string">%[echo "-----&gt; Be sure to edit '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/database.yml', 'secrets.yml' and puma.rb."]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> desc <span class="hljs-string"><span class="hljs-string">"Deploys the current version to the server."</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:deploy</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:environment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> deploy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment"># Put things that will set up an empty directory into a fully set-up # instance of your project. invoke :'git:clone' invoke :'deploy:link_shared_paths' invoke :'bundle:install' invoke :'rails:db_migrate' invoke :'rails:assets_precompile' invoke :'deploy:cleanup' to :launch do invoke :'restart' end end end desc "Restart the puma web server." task :restart do queue 'sudo restart awesome' end</span></span></code> </pre></div></div><br><br>  <b>All is ready!</b> <br>  Now we can launch the project again and look at the result: <br><pre> <code class="bash hljs">mina deploy</code> </pre> <br><br><h2>  Alternatives </h2><br>  Alternatively, <a href="https://github.com/puma/puma/tree/master/tools/jungle">puma-jungle</a> can be considered. <br>  These are the upstart and init.d templates of scripts that correctly work with rbenv, rvm and other version managers. <br><br>  In the case of rvm, you need to make sure that the version of ruby ‚Äã‚Äãand gemset is correctly identified, if it is used, for this you can use .ruby-version and .ruby-gemset files. <br><br>  You can put them in version control, or you can create them during deployment through mina.  You will also need to use the mina / rvm library and create a task to install the correct version of ruby ‚Äã‚Äãand gemset. <br><br>  All together may look like this: <br><div class="spoiler">  <b class="spoiler_title">deploy.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># ... # Rvm ruby version and gemset rvm = { ruby_version: 'ruby-2.2.1', ruby_gemset: 'default' } task :environment do invoke :"rvm:use[#{rvm[:ruby_version]}@#{rvm[:ruby_gemset]}]" end # ... desc "Creates appropriate .ruby-version and .ruby-gemset files." task :'rvm:dot_files' do queue! %[echo "#{rvm[:ruby_version]}" &gt; .ruby-version] queue! %[echo "#{rvm[:ruby_gemset]}" &gt; .ruby-gemset] end task :setup =&gt; :environment do # ... end task :deploy =&gt; :environment do deploy do invoke :'git:clone' invoke :'rvm:dot_files' # ... end end # ...</span></span></code> </pre><br></div></div><br><h2>  the end </h2><br>  This is where my publication ends.  I hope it was interesting and useful. </div><p>Source: <a href="https://habr.com/ru/post/265599/">https://habr.com/ru/post/265599/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265589/index.html">The state of the Common Lisp ecosystem for 2015</a></li>
<li><a href="../265591/index.html">Java Spring application in PaaS-platform Heroku in 14 minutes</a></li>
<li><a href="../265593/index.html">MySQL Balancing</a></li>
<li><a href="../265595/index.html">Algorithmic and automated trading: 13 books on the subject</a></li>
<li><a href="../265597/index.html">Fuga Framework - A Small Java Web Framework</a></li>
<li><a href="../265601/index.html">Easily go to the vector image format instead of cutting under different screen densities in Android 4.0+. Part 1 of 2</a></li>
<li><a href="../265603/index.html">Easily go to the vector image format instead of cutting under different screen densities in Android 4.0+. Part 2 of 2</a></li>
<li><a href="../265605/index.html">Cloud for development companies: Jelastic as an example solution from the Azure Marketplace</a></li>
<li><a href="../265607/index.html">Minimalism in cryptography, or the Even ‚Äì Mansour scheme</a></li>
<li><a href="../265609/index.html">Billing issues: What can go wrong with self-written software?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>