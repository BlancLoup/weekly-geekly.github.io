<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CQRS Types</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CQRS is a fairly well-studied pattern. You can often hear that you either follow the CQRS or not, bearing in mind that this is something like a binary...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CQRS Types</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://martinfowler.com/bliki/CQRS.html">CQRS</a> is a fairly well-studied pattern.  You can often hear that you either follow the CQRS or not, bearing in mind that this is something like a binary choice.  In this article I would like to show that there is a range of variations of this concept, as well as how different types of CQRS may look in practice. <br><a name="habracut"></a><br><h2>  Type 0: no CQRS </h2><br>  With this type, you do not use the CQRS pattern at all.  This means that your domain model uses domain classes to service both commands (commands) and queries (queries). <br><br>  Consider the Customer class as an example: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyList&lt;Order&gt; Orders { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddOrder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Order order</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/* Other methods */</span></span> }</code> </pre> <br>  With CQRS type zero, you work with the CustomerRepository class, which looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerRepository</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Customer customer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Customer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;Customer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Search</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }</code> </pre><br>  The Search method here is a query.  It is used to fetch data on customers from the database and return this data to the client (which may be a UI or a separate application that accesses your application via the API).  Note that this method returns a list of domain objects. <br><br>  The advantage of this approach is that there is no overhead projector in terms of the amount of code.  In other words, you have a single model that you can use for commands and queries, and you don‚Äôt have to duplicate code. <br><br>  The disadvantage here is that this single model is not optimized for reading operations.  If you need to show a list of customers on the UI, you usually do not need to display their orders (Orders).  Instead, in most cases, you will want to show only brief information, such as id, name, and number of orders. <br><br>  Using domain classes to transport data leads to the fact that all sub-objects (such as Orders) of customers are loaded into memory from the database.  This leads to serious overhead, because  The UI only needs the number of orders, not the orders themselves. <br><br>  This type of CQRS is good for applications with little (or no) performance requirements.  For other types of applications, we must use the following types of CQRS. <br><br><h2>  Type 1: Separate Class Hierarchy </h2><br>  With this type of CQRS, your class structure is divided into read and write services.  This means that you create a set of DTO classes for transporting data loaded from the database. <br><br>  DTO for the Customer class might look like this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerDto</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderCount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  The Search method in the repository returns a list of DTO instead of a list of domain objects: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerRepository</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Customer customer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Customer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;CustomerDto&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Search</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }</code> </pre><br>  Search can use either ORM or regular ADO.NET to fetch the necessary data.  This should be determined by performance requirements in each case.  There is no need to roll back to ADO.NET if the performance of the method is satisfactory. <br><br>  DTO adds some duplication in the sense that we now need to create two classes instead of one: once for commands in the form of a domain object and once for requests in the DTO format.  At the same time, they allow us to create clean and clear data structures that clearly fall on the need for our read operations, since  they contain only what is needed when displaying.  And the more clearly we express our intentions in code, the better. <br><br>  In my opinion, this type of CQRS is sufficient for most enterprise applications, since  it gives a pretty good balance between simplicity and code performance.  Also, with this approach, we have some flexibility in which tool to choose for queries.  If the performance of the method is not critical, we can use the ORM and save developer time.  Otherwise, we can use ADO.NET directly (or lightweight ORM such as Dapper) and write complex and optimized queries manually. <br><br><h2>  Type 2: individual models </h2><br><br>  This type of CQRS involves the use of separate models and a set of APIs to serve read and write requests. <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/getpro/habr/post_images/2f9/414/362/2f94143622658042e27b4dc67971d1bc.png" alt="image"></div><br><br>  This means that in addition to the DTO, we retrieve all the reads from our model.  Repositories now contain only methods that are related to commands: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomerRepository</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Customer customer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Customer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }</code> </pre><br>  And the search logic is in a separate class: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SearchCustomerQueryHandler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;CustomerDto&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SearchCustomerQuery query</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }</code> </pre><br>  This approach adds more overhead in comparison with the previous one in the amount of code needed to process requests, but this is a good solution in case you have large loads on reading data. <br><br>  In addition to the ability to write optimized requests, type 2 allows us to easily wrap the part of the API related to requests into a caching mechanism, or even move this API to a separate server or server group with a configured load server.  This solution is great for applications with a big difference in read and write loads, because  allows to scale read operations well. <br><br>  If you need an even greater increase in performance in terms of reading operations, you need to move towards type 3. <br><br><h2>  Type 3: Separate Storage </h2><br>  This is the type that many consider to be the ‚Äútrue‚Äù CQRS.  To scale read operations even more, we can use a separate storage optimized for our system requests.  Often, a similar storage is NoSQL DB, for example, MongoDB, or a set of replicas from several instances: <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/getpro/habr/post_images/2ce/2f5/b08/2ce2f5b0862ee2ed1c30c61d0e6c1ca4.png" alt="image"></div><br><br>  Synchronization takes place here in the background and may take some time.  Such storages are called ‚Äúconsistent in the long run‚Äù (eventually consistent). <br><br>  A good example is indexing customer data with Elastic Search.  Often we don‚Äôt want to use the full text search built into SQL Server, because  it doesn't scale well.  Instead, we can use non-relational data warehouses that are optimized for searching for customers. <br><br>  Together with the best scalability in reading operations, this type of CQRS carries the largest overhead projector.  We not only share our reading and writing model logically, i.e.  we use separate classes and even builds for this, but we also share the database itself. <br><br><h2>  Conclusion </h2><br>  There are different gradations of the CQRS pattern that you can use in your application.  There is nothing wrong with sticking with type 1 and not moving towards types 2 and 3 if type 1 meets the performance requirements of your application. <br><br>  I would like to emphasize this point: CQRS is not a binary choice.  There are various variations between not separating read and write operations in general (type 0) and their complete separation (type 3). <br><br>  There should be a balance between the degree of segregation and the complexity that this segregation introduces.  The balance should be sought in each particular case separately, often with the use of several iterations.  The CQRS pattern should not be applied simply because ‚Äúwe can‚Äù. <br><br>  English version of the article: <a href="http://enterprisecraftsmanship.com/2015/04/20/types-of-cqrs/">Types of CQRS</a> </div><p>Source: <a href="https://habr.com/ru/post/268627/">https://habr.com/ru/post/268627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268617/index.html">Create a REST service on Rust. Part 4: go to the REST API</a></li>
<li><a href="../268619/index.html">Ode to a good vendor: choose a platform for launching a VoIP SaaS project</a></li>
<li><a href="../268621/index.html">Server clustering of markers on the map. From theory to practice</a></li>
<li><a href="../268623/index.html">Email Privacy Notice: Not a Good Idea</a></li>
<li><a href="../268625/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ180 (October 5 - 11, 2015)</a></li>
<li><a href="../268629/index.html">Social network aggregator uniava.com</a></li>
<li><a href="../268631/index.html">PostgreSQL features not found in MySQL, and vice versa</a></li>
<li><a href="../268633/index.html">California now has the best digital data protection law in the country (translation of WIRED article)</a></li>
<li><a href="../268635/index.html">Thinstation, connect to Linux terminal server via XDMCP</a></li>
<li><a href="../268637/index.html">UX in messengers: 2005 - 2015. Part II. Years 2008-2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>