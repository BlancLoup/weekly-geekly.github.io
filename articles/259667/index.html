<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing OpenStreetMap Nominatim to find latitude and longitude at the address entered</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to tell my story about installing the Nominatim geocoder on a dedicated server. Initially it was assumed that this task would take me abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing OpenStreetMap Nominatim to find latitude and longitude at the address entered</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f7d/08a/b25/f7d08ab25cb93acc895991018a821e69.jpg" alt="image"><br><br>  I would like to tell my story about installing the Nominatim geocoder on a dedicated server.  Initially it was assumed that this task would take me about 5-7 hours, but it was not there ... Therefore, it was decided to write an article c describing how Nominatim was deployed to the server until the site was fully operational.  But first things first. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  There are many services with geocoders, I will not list them all here, I note that there are good articles on Habr√© on this subject: <a href="http://habrahabr.ru/post/31424/">"Geocoding with PHP and the Google Maps API"</a> , and also <a href="http://habrahabr.ru/post/154581/">"Yandex Maps: Search for arbitrary objects"</a> . <br><br>  For those who do not know: <b>Geocoding</b> is the process of finding the latitude and longitude at the entered address. <br>  My choice fell on Nominatim, since it can be deployed on my server and not limited to the number of requests, and I also already had experience with OSM maps and I would like to use it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Documentation </h4><br>  A site with an already working map can be found at the link: <a href="http://nominatim.openstreetmap.org/">OpenStreetMap Nominatim</a> <br>  And here is a link to sample requests: <a href="http://wiki.openstreetmap.org/wiki/Nominatim">Wiki nominatim</a> <br>  There is also a link to the installation of Nominatim <a href="http://wiki.openstreetmap.org/wiki/Nominatim/Installation">Installation</a> .  But this documentation is a bit outdated, for installation it is for this article that you need to dance a bit with a tambourine.  Everything described below will refer to this article on installation, only without the participation of a tambourine. <br>  And there is also a docker container <a href="https://registry.hub.docker.com/u/nicopace/nominatim-docker/">nominatim docker</a> .  For some reason, most likely due to outdated installation packages, this container did not start with me. <br><br><h4>  Step 1: Create a Virtual Machine </h4><br>  The machine was based on a standart D2 Microsoft Azure cloud with features: 2 cores, 7 GB RAM, 100 GB SSD.  It is on this machine that Nominatim will be installed.  100GB is actually more than necessary for my task, since the map of Ukraine is not so big.  After installing all the necessary components left free 70%. <br><br><h4>  Step 2: Install the necessary packages </h4><br><pre><code class="bash hljs">sudo apt-get update sudo apt-get -y install wget sudo apt-get -y install build-essential automake sudo apt-get -y install libxml2-dev sudo apt-get -y install libgeos-dev sudo apt-get -y install libpq-dev sudo apt-get -y install libbz2-dev sudo apt-get -y install libtool libproj-dev sudo apt-get -y install libgeos++-dev sudo apt-get -y install gcc proj-bin libgeos-c1 git osmosis sudo apt-get -y install php5 php-pear php5-pgsql php5-json sudo apt-get -y install bc sudo apt-get -y install postgresql-9.4 postgresql-9.4-postgis-2.1 postgresql-contrib-9.4 postgresql-server-dev-9.4 sudo apt-get -y install libboost-chrono1.55-dev libboost-thread1.55-dev libboost-filesystem1.55-dev sudo apt-get -y install python-software-properties &amp;&amp; add-apt-repository -y ppa:kakrueger/openstreetmap &amp;&amp; apt-get update &amp;&amp; apt-get --no-install-recommends install -y osm2pgsql</code> </pre> <br><h4>  Step 3: Setup </h4><br><pre> <code class="bash hljs">sudo -i pear install DB sudo -u username sudo mkdir -p /app/nominatim sudo -i useradd -m -p password1234 -d /app/nominatim nominatim chown nominatim: /app/nominatim <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /app/nominatim wget http://www.nominatim.org/release/Nominatim-2.4.0.tar.bz2 tar xvf Nominatim-2.4.0.tar.bz2 rm Nominatim-2.4.0.tar.bz2 mv Nominatim-2.4.0/* . rm Nominatim-2.4.0/ sudo -u nominatim ./autogen.sh ./configure &amp;&amp; make</code> </pre><br>  I think it‚Äôs not difficult to figure out these command lines.  In the event that an error occurs in obtaining access rights, we will set read and write access rights for all users and <i>chmod -R 755 / app</i> groups.  I would like to note that sometimes there was a problem when executing the <i>make command</i> .  if you have this problem, use <i>sudo make clean</i> , and then <i>./configure &amp;&amp; make</i> . <br><br><h4>  Step 4: PostgreSQL </h4><br>  Initially, postgres is not configured for a combat server, so you need to configure it here from the nominatim documentation wiki: <br><blockquote>  Ubuntu location /etc/postgresql/9.x/main/postgresql.conf <br>  CentOS location /var/lib/pgsql/data/postgresql.conf <br><br>  shared_buffers (4GB) <br>  maintenance_work_mem (10GB) <br>  work_mem (50MB) <br>  effective_cache_size (24GB) <br>  synchronous_commit = off <br>  checkpoint_segments = 100 <br>  checkpoint_timeout = 10min <br>  checkpoint_completion_target = 0.9 <br>  For 32GB RAM machine <br></blockquote><br><pre> <code class="bash hljs">sudo passwd postgres sudo usermod -a -G sudo postgres service postgresql start &amp;&amp; pg_dropcluster --stop 9.4 main service postgresql start &amp;&amp; pg_createcluster --start -e UTF-8 9.4 main service postgresql start &amp;&amp; sudo -u postgres psql postgres -tAc <span class="hljs-string"><span class="hljs-string">"SELECT 1 FROM pg_roles WHERE rolname='nominatim'"</span></span> | grep -q 1 || sudo -u postgres createuser -s nominatim &amp;&amp; sudo -u postgres psql postgres -tAc <span class="hljs-string"><span class="hljs-string">"SELECT 1 FROM pg_roles WHERE rolname='www-data'"</span></span> | grep -q 1 || sudo -u postgres createuser -SDR www-data &amp;&amp; sudo -u postgres psql postgres -c <span class="hljs-string"><span class="hljs-string">"DROP DATABASE IF EXISTS nominatim"</span></span></code> </pre><br>  This is the easiest part of the installation work.  And now hardcore begins, because further actions are not always performed correctly.  And after such an incorrect end, unfortunately, sometimes you have to perform actions anew on a new virtual machine. <br><br><h4>  Step 5: Download and install osm cards </h4><br>  At the beginning, you need to download the map from the site in the * .pbf format: <a href="http://download.geofabrik.de/">OpenStreetMap Data Extracts</a> .  As an example, I load the map of Ukraine and rename it to data.pbf. <br><br><pre> <code class="bash hljs">wget --output-document=data.pbf http://download.geofabrik.de/europe/ukraine-latest.osm.pbf chown nominatim: data.pbf touch local.php /app/nominatim/settings/local.php nano /app/nominatim/settings/local.php</code> </pre><br>  The last command opens the nominatim installation configuration file.  In the file local.php you need to enter the code which is described below. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// Paths @define('CONST_Postgresql_Version', '9.4'); @define('CONST_Postgis_Version', '2.1'); // Website settings @define('CONST_Website_BaseURL', 'http://geocoder.cloudapp.net/'); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  As BaseURL, you must enter the address of the site from which nominatim will be launched. <br><br>  Now run the installation command nominatim.  This operation takes quite a long time, for example, with a map of Ukraine, the installation lasted about 7 hours.  Due to the fact that I executed all the commands via ssh, and am prone to alternate disconnection of the Internet, the installation command is executed in the <a href="http://help.ubuntu.ru/wiki/screen">screenshot</a> . <br><br><pre> <code class="bash hljs">screen service postgresql start &amp;&amp; sudo -u nominatim -- ./utils/setup.php --osm-file /app/nominatim/data.pbf --all --threads 2 2&gt;&amp;1; sudo -u nominatim -- ./utils/setup.php --index --create-search-indices</code> </pre><br>  To exit the screen you need to type the combination Ctrl + A then Ctrl + D.  The <i>screen -r</i> command returns the screen. <br><br>  Now we will launch the website in a quick way: <br><br><pre> <code class="bash hljs">./utils/setup.php --create-website /var/www/html rm /var/www/html/index.html /etc/init.d/apache2 restart</code> </pre><br>  I did without apache settings or working with nginx, since you can easily read about this in other articles on Habr√©.  Yes, and without setting the site works great. <br><br><h4>  Testing the site </h4><br>  As a result, we should see something similar, as in my screenshot: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f7/451/63f/7f745163f30ca2cc2003442aca8663b7.jpg" alt="image"><br><br>  Check how api works by making a request: <br>  <a href="http://geocoder.cloudapp.net/%3Fformat%3Djson%26addressdetails%3D1%26q%3DOdessa%26format%3Djson%26limit%3D1">http://geocoder.cloudapp.net/?format=json&amp;addressdetails=1&amp;q=Odessa&amp;format=json&amp;limit=1</a> <br>  Response: <br><br><pre> <code class="javascript hljs">[{<span class="hljs-string"><span class="hljs-string">"place_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"1145869"</span></span>,<span class="hljs-string"><span class="hljs-string">"licence"</span></span>:<span class="hljs-string"><span class="hljs-string">"Data ¬© OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright"</span></span>,<span class="hljs-string"><span class="hljs-string">"osm_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"relation"</span></span>,<span class="hljs-string"><span class="hljs-string">"osm_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"1413934"</span></span>,<span class="hljs-string"><span class="hljs-string">"boundingbox"</span></span>:[<span class="hljs-string"><span class="hljs-string">"46.342707"</span></span>,<span class="hljs-string"><span class="hljs-string">"46.6291187"</span></span>,<span class="hljs-string"><span class="hljs-string">"30.6114013"</span></span>,<span class="hljs-string"><span class="hljs-string">"30.8313753"</span></span>],<span class="hljs-string"><span class="hljs-string">"lat"</span></span>:<span class="hljs-string"><span class="hljs-string">"46.4858883"</span></span>,<span class="hljs-string"><span class="hljs-string">"lon"</span></span>:<span class="hljs-string"><span class="hljs-string">"30.68365101101"</span></span>,<span class="hljs-string"><span class="hljs-string">"display_name"</span></span>:<span class="hljs-string"><span class="hljs-string">",  , "</span></span>,<span class="hljs-string"><span class="hljs-string">"class"</span></span>:<span class="hljs-string"><span class="hljs-string">"place"</span></span>,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"city"</span></span>,<span class="hljs-string"><span class="hljs-string">"importance"</span></span>:<span class="hljs-number"><span class="hljs-number">0.45</span></span>,<span class="hljs-string"><span class="hljs-string">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"http:\/\/geocoder.cloudapp.net\/images\/mapicons\/poi_place_city.p.20.png"</span></span>,<span class="hljs-string"><span class="hljs-string">"address"</span></span>:{<span class="hljs-string"><span class="hljs-string">"city"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"county"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">" "</span></span>,<span class="hljs-string"><span class="hljs-string">"country"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"country_code"</span></span>:<span class="hljs-string"><span class="hljs-string">"ua"</span></span>}}]</code> </pre><br><h4>  findings </h4><br>  In the end, I would like to note that to download a map of the Earth, you need a server that is more powerful than the D2 series, if you don‚Äôt want to wait * a week for the download.  This problem can also be solved by temporarily scaling the server to the D14 series (16 cores, 112 GB of memory).  But the time to fulfill a search query is very good: on average, a search in Ukraine takes only 300 ms. <br><br>  I hope this article will help other developers spend less time deploying Nominatim and see if you need it.  Maybe you should take it ready and use? <br><br>  If someone from the Hub community will need a working Docker container with Nominatim, or other ideas - write, always happy to talk. </div><p>Source: <a href="https://habr.com/ru/post/259667/">https://habr.com/ru/post/259667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259651/index.html">SaaS, PaaS, IaaS, or your hardware: What do domestic IT companies use?</a></li>
<li><a href="../259653/index.html">Restore databases using Veeam Explorer for Microsoft SQL Server</a></li>
<li><a href="../259655/index.html">We write chat for the local network using C ++ Builder. Client part</a></li>
<li><a href="../259657/index.html">Why in Russia there are so few committers in large open source projects</a></li>
<li><a href="../259663/index.html">Online store trump card: online shopping usability study</a></li>
<li><a href="../259671/index.html">Fast security-oriented fuzzing with AFL</a></li>
<li><a href="../259675/index.html">Ruby and C. Part 4. We are on friendly terms with the accelerometer, gyroscope and range finder with Raphael.js</a></li>
<li><a href="../259677/index.html">Autopilot system for radio-controlled helicopter. Part 1: The Idea</a></li>
<li><a href="../259679/index.html">Native OmniDirectional shadows implementation in DirectX11</a></li>
<li><a href="../259683/index.html">Autopilot system for radio-controlled helicopter. Part 2: Takeover</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>