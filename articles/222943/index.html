<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caesar III Reverse Engineering (Part 2, Drawing the City)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I hope that the previous post Back-engineering of Caesar III , where the algorithm for obtaining textures from the resources of the original game was ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caesar III Reverse Engineering (Part 2, Drawing the City)</h1><div class="post__text post__text-html js-mediator-article">  I hope that the previous post <a href="http://habrahabr.ru/post/221913/">Back-engineering of Caesar III</a> , where the algorithm for obtaining textures from the resources of the original game was described, was favorably received by the masters.  In this article I will describe the format of the maps, the selection algorithm and the order of the tiles to draw, the formation of the final texture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/548/fe9/4ac/548fe94ac86b7849c40361db95020a48.jpg"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you know what a tile is, then you can skip the next section. <br>  <b>Tiles</b> <br>  A tile is a fixed-size picture, formed so that when drawing next to other tiles, a solid image without ‚Äúseams‚Äù is obtained.  Here is an example of grass textures from the game Caesar III <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e8f/450/88f/e8f45088f7bb8264022f0802336b5d9d.png"><img src="https://habrastorage.org/getpro/habr/post_images/c99/835/a7a/c99835a7a20b3f0872735f134d8a41d4.png"><img src="https://habrastorage.org/getpro/habr/post_images/f1c/94f/913/f1c94f9131045f295f86d72a04878b6d.png"><img src="https://habrastorage.org/getpro/habr/post_images/19c/06a/c2a/19c06ac2ad3ae9ff69ecc30baa3094b1.png"><img src="https://habrastorage.org/getpro/habr/post_images/282/ddc/401/282ddc4010aa32acdf6975db0c8a9d8c.png"><img src="https://habrastorage.org/getpro/habr/post_images/898/1ed/981/8981ed98141138e25dff8f61cc334adb.png"><img src="https://habrastorage.org/getpro/habr/post_images/39e/314/2b1/39e3142b195ee7697b31ef8d9a0ca03c.png"><img src="https://habrastorage.org/getpro/habr/post_images/1dd/ce8/acb/1ddce8acb76df6b15dda8734264ad1c0.png"><br><br>  If you draw them side by side in a certain order and add some textures with trees, you will get some area of ‚Äã‚Äãearth. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0be/746/318/0be7463187f6e117ba00ea8a75071324.png"><img src="https://habrastorage.org/getpro/habr/post_images/5b7/c92/d96/5b7c92d96959fcaadf311b2e2180a683.png"><br><br>  You probably noticed that the presented images are not square, but diamond-shaped.  This is done in order to give the image a sense of volume (depth).  Such a tile looks rotated by one angle to the viewer and, as it were, going deep, the two-dimensional picture acquired a third dimension.  To create a volume effect, the width should be less than about half the length.  The base of the tile in the game Caesar III is 58x30 pixels, this is the minimum size of the tile with which the game engine operates.  At the first stages of the development of the remake, one unpleasant effect was obtained, the textures in the game were created without taking into account transparency and their output to the screen without additional processing led to the following result. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f4/cb2/f94/1f4cb2f94ffecfc0020eac3920a8f44f.png"><br><br>  The way out of this situation is the following: either use a mask, for example, the color of the leftmost character is assumed to be transparent, or textures are complemented with an alpha channel.  In the original game, the first version was used, the second version is used in the remake: textures are prepared at the stage of loading resources. <br><br>  <b>Map</b> <br>  A map is an array defining the position of tiles on a layer and their parameters.  In the simplest case, the map is an MxN matrix, where each of its elements contains an identifier (number, number) from the conditional ‚Äútile palette‚Äù.  Tiles do not necessarily have a sequential sequence number, tile numbers are divided into several intervals and named spaces.  For example, the tiles of land, trees, water, rifts and grass have indices from land1a_00001 to land1a_00303.  In the game Caesar III, it is allowed to use square maps of sizes from 30x30 to 160x160 tiles.  The tile is located on the map so that its upper boundary is "north." <br><br><img src="https://habrastorage.org/getpro/habr/post_images/944/b06/59b/944b0659be7c1fab7fa7e6cbc97cf0df.jpg"><br><br>  In order to draw the tiles on the screen, you need to consider the distance to it, if you just draw the tiles in the order of their placement on the map, you get an abracadabra, as part of the tiles was not drawn in due time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/32b/59e/214/32b59e2147d77ccf20016b142d02c4ce.png"><br><br>  In what sequence to draw the tiles shows the following image. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/8a9/a62/bd78a9a62a648a5a6e05897025db0a48.jpg"><br><br>  1. The first figure shows the order of drawing tiles on a 2D map, to create a depth effect. <br>  2. In the second figure, the order of drawing tiles on a 2.5D map is shown, given that the higher the tile is located, the earlier it should be drawn. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de7/4db/c49/de74dbc49c4eada6dfc703e7c95d7075.png"><br><br>  This image is made up of the following tiles drawn in the correct order. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/694/cc1/2ca/694cc12cad6be63938768f7e79e92046.png"><br><br>  In the general case, the code for generating indexes of tiles for drawing will be as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Look</b> <div class="spoiler_text"><pre><code class="hljs perl">//   <span class="hljs-string"><span class="hljs-string">""</span></span>  tilemap <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  tilearray tiles; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">y</span></span> &lt; map_size; j++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( t=<span class="hljs-number"><span class="hljs-number">0</span></span>; t &lt;= j; t++ ) { tiles.append( <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[ t , map_size - <span class="hljs-number"><span class="hljs-number">1</span></span> - ( j - t ) ]; } } //   <span class="hljs-string"><span class="hljs-string">""</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i=<span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; map_size; i++ ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t=<span class="hljs-number"><span class="hljs-number">0</span></span>; t &lt; map_size-i; t++ ) { tiles.append( <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[ i + t, t ] ); } }</code> </pre> </div></div><br><br>  <b>Drawing city</b> <br>  Additional conditions that arise when drawing a city. <br>  1. The map contains not only static tiles of earth, grass, buildings, but also mobile objects (people, animals, animation) <br>  2. There are objects through which you can pass (arch, gate, barn) <br>  3. Additional animation of tiles and objects <br>  4. Non-square objects <br><br>  These conditions complicate the drawing process and generate additional drawing rules. <br>  1. Moving characters on an isometric map is not just.  The map is rotated ‚Äúinwards‚Äù and its absolute vertical size does not coincide with the horizontal size.  Therefore, ‚Äúwalking up‚Äù any walking object should move accordingly, in the simplest case, two steps to the side are one step deep. <br>  2. The moving object can be located in different parts of the tile and is drawn after the main image of the tile is displayed, which can cause display artifacts, for example: a chariot travels over the gate.  It costs drawing additional sprites that will be shown after drawing moving objects. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc7/6d4/41f/cc76d441fc7ba1e5adee5222446c3034.png">  + <img src="https://habrastorage.org/getpro/habr/post_images/1d0/9a9/34b/1d09a934b57a38342cc77b123fe3b5ea.png">  = <img src="https://habrastorage.org/getpro/habr/post_images/58b/5f3/872/58b5f38729c5982b2548c0a715d5483c.png"><br><br>  3. Animation can go beyond the size of the main image, here you should take into account such a feature that it (animation) can go up and to the right, but not down and to the left, otherwise it will be covered by the following tiles. <br>  4. For the most part, square objects are used in the game, but there are also extended ones, in order to simplify the drawing algorithm, they are beaten into smaller (square) parts, for example, a hippodrome. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2e0/66e/fcd/2e066efcdd9d5db9422ec5ed6ae5d006.png">  = <img src="https://habrastorage.org/getpro/habr/post_images/61a/6c4/667/61a6c466740f1f46540c6172a980514a.png">  + <img src="https://habrastorage.org/getpro/habr/post_images/ec7/bb7/244/ec7bb7244b3d743a8990789d894e039c.png">  + <img src="https://habrastorage.org/getpro/habr/post_images/93c/02e/83a/93c02e83a0684d8fe134f13d1fbd3f2b.png"><br><br>  <b>How to draw</b> <br>  1. For the first pass, ‚Äúflat‚Äù tiles and moving objects on them are drawn. <br>  2. For the second pass, tiles are drawn, whose images may extend beyond the base of the tile. <br>  3. Additional animation is drawn for tiles that have such a flag. <br>  <i>Anticipating possible questions.</i>  <i>This algorithm was restored from the original game, as far as I could understand it, maybe it will be changed in later versions.</i>  <i>Tips on organizing a rendering cycle are welcome.</i> <br><br>  <b>Caesar III Game Card Format</b> <br>  Directly to the objects that will be displayed in the city, the first five data blocks are in the * .map file.  We read from the beginning of the file, read the data one after another without gaps. <br><br>  <b>short tile_id [26244]</b> - contains the identifiers of the elements, each identifier corresponds to its own texture.  For example, the group of identifiers 246-548, corresponds to the textures land1a_00001-land1a_00303, these are the textures of the earth, trees, etc., which were described above. <br>  <b>byte edge_data [26244]</b> - the array contains information about the size of the object for which the texture is selected in the tile_id array <br>  <b>short terrain_info [26244]</b> - the array contains surface characteristics for a particular tile, ground, water, road, wall, etc. ( <a href="http://pecunia.nerdcamp.net/projects/citybuilding/caesar3-terrain">full information on these flags</a> ) <br>  <b>byte minimap_info [26244]</b> - basic information for constructing a minimap, also participates in some calculations during the game, speaking a sort of an array of "random numbers". <br>  <b>byte height_info [26244]</b> - this array describes the height of the tile above the surface, 0 for the ground, 1 - 15 pixels, 2 - 30 pixels, and so on. <br><br>  <b>Practical use</b> <br>  More information about the game Caesar III and the development of the remake can be found in our <a href="https://bitbucket.org/dalerank/caesaria/wiki/Home">wiki at bitbucket.org</a> . <br>  Special thanks to <a href="http://caesar.biancavanschaik.nl/">Bianca van Schaik</a> for the help in writing the article and the materials provided. <br><br>  And finally, a small test screenshot, Etruscan spearmen rampant in the city of fountains: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/609/80b/50a/60980b50a1c7fdcc61d8ef6576475ff6.jpg"></div><p>Source: <a href="https://habr.com/ru/post/222943/">https://habr.com/ru/post/222943/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222931/index.html">How to poison a cat? Detective story with a happy ending</a></li>
<li><a href="../222933/index.html">Poll - Open data of the Ministry of Finance</a></li>
<li><a href="../222935/index.html">Create music from anything</a></li>
<li><a href="../222939/index.html">From Imagine Cup to a startup</a></li>
<li><a href="../222941/index.html">Ruby 2.1 in detail (Part 1)</a></li>
<li><a href="../222945/index.html">As we developed "Spetskor" - a super-custom mobile application for civilian reporters</a></li>
<li><a href="../222947/index.html">Update on the popularity of CMS-systems, analytics systems and online consultants in RuNet for the 2nd quarter</a></li>
<li><a href="../222951/index.html">Joint experiment of Yandex.Mail and Nginx teams: does SPDY really speed up the Internet?</a></li>
<li><a href="../222953/index.html">Experience one engineering investigation</a></li>
<li><a href="../222955/index.html">Brainstorming is not as effective as it seems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>