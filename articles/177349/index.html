<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Budget solution for backup of the whole office</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the articles in our blog are written by developers. We decided to correct this injustice and add some DevOps. Today we will talk about the imp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Budget solution for backup of the whole office</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b3b/6b4/320/b3b6b4320e1071864d84ce663fde1117.gif"><br><br>  Most of the articles in our blog are written by developers.  We decided to correct this injustice and add some DevOps.  Today we will talk about the important thing - about backups. <br>  Since Badoo is actively developing and the number of employees is constantly increasing, we came to the conclusion that centralized backup is much more convenient than partial copying and storage of information in various places. <br>  In this article, we will look at how to ‚Äúsave up‚Äù quite a large number of workstations using one storage facility in various ways, without resorting to serious investments and avoiding cumbersome implementation. <br>  We make a reservation in advance that the backup does not cover 100% of employees, since not all of them store their data on local machines, so we didn‚Äôt have a goal to make a backup necessarily-forced. <br>  One of the main difficulties of centralized backup was the fact that employees use different operating systems. <br><br>  How could we gather all on one server? <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sample statistics based on the use of our system: <br>  Mac OS ~ 66%; <br>  Linux ~ 27%; <br>  Windows ~ 7%. <br><br>  And now, in more detail, what is hidden behind these three operating systems and how we will customize them with the user. <br>  1) Mac OS - via <a href="http://en.wikipedia.org/wiki/Time_Machine_(Mac_OS)">Time Machine</a> (in recent versions, Mac OS is supported out of the box, below 10.6 we simply do not have), on the server side - <a href="http://netatalk.sourceforge.net/">Netatalk</a> ; <br>  2) Windows - standard tools through ‚ÄúBackup and restore‚Äù ( <a href="http://en.wikipedia.org/wiki/Backup_and_Restore">Backup and restore</a> ), on the server side - <a href="http://www.samba.org/">Samba</a> ; <br>  3) Linux - several options: samba, rsync (password access);  full ssh disabled as unnecessary and for security purposes. <br><br>  Let's go ahead and show how the user management interface that needs to be backed up will look like: <br><br><img src="https://habrastorage.org/storage2/afe/bf5/e06/afebf5e060ac3dedf5805effb35ac2fa.png"><br><br>  The administrator must select an existing account or create a new one, generate a password and specify the type of operating system. <br><br><h4>  Hardware </h4><br>  A server with 24 3.5-inch and 3 TB disks was assembled as storage, a large amount for small money. <br>  Each disk is mounted separately, RAID or LVM is not used - if one of the disks fails, it can be quickly replaced;  It also solves the problem of lack of free space: we squeeze out the maximum volume from all the disks. <br>  ‚ÄúWhat will happen if one of the disks on which users were backed up dies?‚Äù - you ask.  Ask for backup again after replacing the disk.  The probability that one of the 24 drives will die with the employee‚Äôs laptop is really small.  In extreme cases, we will try to recover the lost information. <br>  The main function of the server is to store information, so it makes no sense to describe the CPU and memory, any modern processors will cope with this task. <br><br><h4>  Cooking discs </h4><br>  We format and mount each disk: <br><pre><code class="bash hljs">parted /dev/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> -s mklabel gpt parted /dev/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> mkpart primary 0GB 2996GB mkfs.ext3 /dev/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>1</code> </pre> <br>  We delete the reserved space of the superuser: <br><pre> <code class="bash hljs">tune2fs -m 0 /dev/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>1</code> </pre><br>  In / etc / fstab for each section we register <br><pre> <code class="bash hljs">UUID=<span class="hljs-variable"><span class="hljs-variable">${UUID}</span></span> /storage/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>1 ext3 noatime,acl,user_xattr,usrquota 0 0</code> </pre><br>  As a result, we obtain disks mounted to the <b>/ storage / sd $ {i}</b> directory, where <b>$ {i}</b> is one of the letters of our disk. <br><br>  It is better to mount disks with a UUID reference, since  ‚Äúmixing‚Äù the disks is not excluded, and with so many devices we will have to restore the correct paths for a long time after a sudden reboot of the server. <br>  We will limit all users with quota in the file system using standard Linux tools, therefore we will prepare disks for this: <br><pre> <code class="bash hljs">quotacheck -cu /storage/sd<span class="hljs-variable"><span class="hljs-variable">${i}</span></span></code> </pre><br><br><h4>  Software part </h4><br><h6>  Netatalk </h6><br>  In this solution, the most difficult is Mac OS X, so let's start with the afp setting. <br>  Install the necessary packages: <br><pre> <code class="bash hljs">rpm -Uvh libdb-4_8-4.8.30-18.6.x86_64.rpm rpm -Uvh db-utils-4.8.30-18.6.x86_64.rpm rpm -Uvh netatalk-2.2.4-3.7.x86_64.rpm rpm -Uvh netatalk-devel-2.2.4-3.7.x86_64.rpm</code> </pre><br><br>  Netatalk will use version 2. *, because  version 3. * does not support the use of variables in path indications ( <a href="http://netatalk.sourceforge.net/3.0/htmldocs/afp.conf.5.html">http://netatalk.sourceforge.net/3.0/htmldocs/afp.conf.5.html</a> , section <b>VARIABLE SUBSTITUTIONS</b> : ). <br><br>  It is worth noting that we collected the Netatalk package with the following flags: <br><pre> <code class="bash hljs">--with-cracklib --with-bdb --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-tcp-wrappers --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-zeroconf</code> </pre><br><br>  Add the line to <b>/etc/netatalk/AppleVolumes.default</b> <br><br><pre> <code class="bash hljs">~/TimeMachine <span class="hljs-string"><span class="hljs-string">"BackupMachine"</span></span> allow:@backupuser cnidscheme:dbd options:usedots,upriv,tm volsizelimit:250000 dbpath:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/netatalk/db/<span class="hljs-variable"><span class="hljs-variable">$u</span></span></code> </pre><br>  wherein: <br><br>  <code>allow:@backupuser</code> - allows users who are in the backupuser group to connect; <br>  <code>BackupMachine</code> - the name that will be displayed as a mounted drive physically mounted in ~ / TimeMachine relative to the user; <br>  <code>volsizelimit:250000</code> - will limit the user to a quota of 250 GB, but only if the user is not assigned a system quota.  Since  in our case, we use system quotas, this option is useless; <br>  <code>tm</code> - a mandatory option, allows TimeMachine on the client side to recognize the allocated resource as valid for the backup; <br>  <code>dbpath:/local/netatalk/db/$u</code> - path to information on user metadata.  It is necessary in the case when a list of directories and files that we backed up is built.  It will be more practical if it is put on a separate disk, for example, on an SSD; <br>  the <code>$u</code> variable substitutes the user name, which we need and does not work in the third version. <br><br>  Enable afpd logging. <br>  Add a line to <code>/etc/nettalk/afpd.conf</code> <br><pre> <code class="bash hljs"> -setuplog <span class="hljs-string"><span class="hljs-string">"default log_info /var/log/afpd.log"</span></span> -keepsessions -transall -savepassword</code> </pre><br>  wherein: <br>  <code>keepsessions</code> - saves sessions when you turn off afpd; <br>  <code>transall</code> - includes both protocols - AFP-over-Appletalk and AFP-over-TCP; <br>  <code>savepassword</code> - allows you to remember the user's password in the local keychain (without this option, TimeMachine on Mac OS 10.8 does not work). <br><br>  In <code>/etc/netatalk/netatalk.conf</code> <br>  increase the maximum number of users to 100 <br><pre> <code class="bash hljs">AFPD_MAX_CLIENTS=100</code> </pre><br><br>  With netatalk finished.  You can connect with the standard Time Machine application, using the address of the form <code>afp://%SERVERNAME%/</code> <br><br><h6>  Samba </h6><br>  Samba will be used to connect in both Windows and Linux. <br>  The setup is quite simple: add to <code>/etc/samba/smb.conf</code> <br><br><pre> <code class="bash hljs">[global] security = user workgroup = Badoo netbios name = BadooBackup <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> master = no domain master = no preferred master = no socket options = TCP_NODELAY IPTOS_LOWDELAY SO_KEEPALIVE SO_RCVBUF=8192 SO_SNDBUF=8192 [homes] comment = Home Directories valid users = %S writable = yes create mask = 0700 directory mask = 0700 browseable = No <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> only = No</code> </pre><br><br>  At this setting is over.  In Windows, you can connect through the "Explorer", in Linux - automatically mount when you log into the system. <br><br><h4>  Access control </h4><br>  So, we are done with the hardware and applications.  It remains to figure out how to provide users with several ways to access. <br>  <a href="http://habrahabr.ru/company/badoo/blog/142708/">We already have a user management system</a> , which means that we will use the familiar Puppet manifests. <br><br>  User data will be stored in an intuitive MySQL table: <br><pre> <code class="sql hljs">| backupusers | <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`backupusers`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`uid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`backup_username`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`backup_server`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'backupmsk'</span></span>, <span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`password_smb`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`shell`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'/bin/false'</span></span>, <span class="hljs-string"><span class="hljs-string">`map_drive`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'sdc'</span></span>, <span class="hljs-string"><span class="hljs-string">`quota`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'250'</span></span>, <span class="hljs-string"><span class="hljs-string">`sftp`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`isactive`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`os`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_unicode_ci |</code> </pre><br><br>  The framework writes data to this table. <br>  Several features: <br>  The <code>`map_drive`</code> field is the name of the server and drive that will be used for the current user.  It is not set by the administrator; it is automatically distributed depending on the space occupied in this or that section and on the server.  If there is not enough space for someone, the data will be transferred to another section; <br>  The <code>`isactive`</code> field indicates whether the employee is allowed to use the server for backup.  If all OSes are inactive, it will go to the value 0. The user data will not be deleted (useful, for example, if the laptop is lost); <br>  The <code>`sftp`</code> field allows the user to use rsync (more on this below).  This method will allow ‚Äúadvanced‚Äù colleagues to back up their data using self-written scripts. <br><br>  After updating the table, a script is launched that generates a manifest with data for each user. <br><br>  In order to conveniently manage user directories, add a function to our manifest: <br><br><pre> <code class="ruby hljs"> define backupuser_dirs($name,$map_drive,$home=<span class="hljs-string"><span class="hljs-string">"/home/${name}"</span></span>) { file { <span class="hljs-string"><span class="hljs-string">"$home"</span></span>: owner =&gt; $name, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; symlink, target =&gt; <span class="hljs-string"><span class="hljs-string">"/storage/${map_drive}/${name}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; File[<span class="hljs-string"><span class="hljs-string">"/storage/${map_drive}/${name}"</span></span>]; <span class="hljs-string"><span class="hljs-string">"/storage/${map_drive}/${name}"</span></span>: owner =&gt; $name, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; directory, backup =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>, mode =&gt; <span class="hljs-number"><span class="hljs-number">0711</span></span>; <span class="hljs-string"><span class="hljs-string">"$home/TimeMachine"</span></span>: owner =&gt; $name, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; directory, backup =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>, mode =&gt; <span class="hljs-number"><span class="hljs-number">0711</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; File[<span class="hljs-string"><span class="hljs-string">"$home"</span></span>]; } }</code> </pre><br><br>  And here is a snippet of the manifest for Puppet of one of the users: <br><br><pre> <code class="ruby hljs"> @user { <span class="hljs-string"><span class="hljs-string">"i.ableev"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; $hostname ? { <span class="hljs-regexp"><span class="hljs-regexp">/^%servername%$/</span></span> =&gt; present, <span class="hljs-comment"><span class="hljs-comment">#       ,     default =&gt; absent, #     ,     ,  }, home =&gt; "/home/i.ableev", #   ; (!)    /storage/$map_drive/$name uid =&gt; "1217", groups =&gt; ['backupuser'], # ,      password =&gt; 'V2UgYXJlIGhpcmluZyEgaHR0cDovL2NvcnAuYmFkb28uY29tL2pvYnMvCg==', #     Netatalk  rsync shell =&gt; "/bin/false", #   shell,     ssh } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@backupuser</span></span></span><span class="hljs-comment">_dirs { "i.ableev": name =&gt; "i.ableev", map_drive =&gt;"sdh", # ,         /storage/$map_drive/$name require =&gt; User["i.ableev"]; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@exec</span></span></span><span class="hljs-comment"> { "i.ableev_quota": command =&gt; "/usr/sbin/setquota -u i.ableev 262144000 262144000 0 0 -a", #   250  ‚Ä¶ path =&gt; "/usr/sbin", onlyif =&gt; "/usr/bin/test `/usr/sbin/repquota -ua | /usr/bin/egrep '^i.ableev\s*' | /usr/bin/awk {'print \$4'}` -ne \"262144000\"", # ‚Ä¶      ,     250 . } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@line</span></span></span><span class="hljs-comment"> { "i.ableev_smb": #    /etc/samba/smbpasswd  : # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@user</span></span></span><span class="hljs-comment">:$uid:$hash file =&gt; '/etc/samba/smbpasswd', line =&gt; 'i.ableev:1217:XXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">5CDA711BBD899465D8F57D12BDF2BF68:[U ]:LCT-5058462B:', #         }</span></span></code> </pre><br><br>  Users now have the ability to connect to the server using Mac OS, Windows or Linux. <br><br><h6>  rsync </h6><br>  To provide access through rsync (but not ssh), we will use chroot plus a limited shell.  The manifesto and function in this case will look somewhat different: <br><br><pre> <code class="ruby hljs"> define backupuser_dirs_sftp($name,$map_drive,$home) { file { <span class="hljs-string"><span class="hljs-string">"/home/${name}"</span></span>: owner =&gt; $name, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; symlink, target =&gt; <span class="hljs-string"><span class="hljs-string">"${home}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; File[<span class="hljs-string"><span class="hljs-string">"$home"</span></span>]; <span class="hljs-string"><span class="hljs-string">"$home"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; directory, owner =&gt; root, mode =&gt; <span class="hljs-number"><span class="hljs-number">0755</span></span>; <span class="hljs-string"><span class="hljs-string">"$home/sftp"</span></span>: owner =&gt; $name, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; directory, backup =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>, mode =&gt; <span class="hljs-number"><span class="hljs-number">0711</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; File[<span class="hljs-string"><span class="hljs-string">"$home"</span></span>]; } } @user { <span class="hljs-string"><span class="hljs-string">"i.ableev"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; $hostname ? { <span class="hljs-regexp"><span class="hljs-regexp">/^backupmsk$/</span></span> =&gt; present, default =&gt; absent, }, home =&gt; <span class="hljs-string"><span class="hljs-string">"/storage/sdh/i.ableev"</span></span>, uid =&gt; <span class="hljs-string"><span class="hljs-string">"1217"</span></span>, groups =&gt; [<span class="hljs-string"><span class="hljs-string">'backupuser'</span></span>], password =&gt; <span class="hljs-string"><span class="hljs-string">'V2UgYXJlIGhpcmluZyEgaHR0cDovL2NvcnAuYmFkb28uY29tL2pvYnMvCg=='</span></span>, <span class="hljs-comment"><span class="hljs-comment">#     shell =&gt; "/bin/badooshell", #  shell    rsync } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@backupuser</span></span></span><span class="hljs-comment">_dirs_sftp { "i.ableev": name =&gt; "i.ableev", map_drive =&gt;"sdh", home =&gt; "/storage/sdh/i.ableev", #    ~/sftp ‚Äï     require =&gt; User["i.ableev"]; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> { "/storage/sdh/i.ableev/bin": #   chroot' ‚Äï     badooshell ensure =&gt; directory, recurse =&gt; true, purge =&gt; true, force =&gt; true, backup =&gt; false, owner =&gt; root, group =&gt; root, source =&gt; "puppet:///modules/officebackup/bin/"; #    } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> { "/storage/sdh/i.ableev/lib64": #   ,    rsync: ld-linux-x86-64.so.2 libc.so.6 libpopt.so.0 ensure =&gt; directory, recurse =&gt; true, purge =&gt; true, force =&gt; true, backup =&gt; false, owner =&gt; root, group =&gt; root, source =&gt; "puppet:///modules/officebackup/lib64/"; }</span></span></code> </pre><br><br>  All manifestos are ready. <br><br><h4>  results </h4><br>  What we got in the end: <br><ul><li>  inexpensive server with 72 terabytes of useful data; </li><li>  on one server are backups of all types of user operating systems; </li><li>  access is granted to anyone who wants to make backups. </li></ul><br>  Enjoy! <br><br>  <i>Ilya Ableyev, <a href="https://habrahabr.ru/users/ableev/" class="user_link">ableev</a> , maintenance officer, Badoo Development</i> <br><br>  <i>Original comic: <a href="http://dilbert.com/strips/comic/2007-11-21/">dilbert.com/strips/comic/2007-11-21</a></i> </div><p>Source: <a href="https://habr.com/ru/post/177349/">https://habr.com/ru/post/177349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177333/index.html">Is there life in the world of PostPC? Part 2: daily work in iOS</a></li>
<li><a href="../177335/index.html">Dropcam Review: HD Monitoring with iOS, Android and Web</a></li>
<li><a href="../177337/index.html">Talk about a startup</a></li>
<li><a href="../177343/index.html">How we built cellular communications in Cambodia: part 2, about people</a></li>
<li><a href="../177347/index.html">Keyboard do it yourself</a></li>
<li><a href="../177351/index.html">RigidBot, a budget 3D printer not inferior to the leaders</a></li>
<li><a href="../177355/index.html">The secret visual information sharing scheme</a></li>
<li><a href="../177357/index.html">Uninterrupted operation (HA) for OpenStack MySQL + rabbitMQ services</a></li>
<li><a href="../177359/index.html">The digest of interesting news and materials from the world of ayti for the last week No. 53 (April 13 - 19, 2013)</a></li>
<li><a href="../177365/index.html">A brainwave gadget that blocks phone calls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>