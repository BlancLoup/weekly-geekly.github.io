<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of implementing caching in a small project with a strong social component</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the experience of implementing caching with memcached on my site. The text will be useful to beginners in web development, who are won...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of implementing caching in a small project with a strong social component</h1><div class="post__text post__text-html js-mediator-article">  I want to share the experience of implementing caching with memcached on my site.  The text will be useful to beginners in web development, who are wondering "how to put into practice those 100,500 caching articles that are easily found in search engines."  I do not pretend to the truth, just telling how it happened with me. <br><br>  Initial data: <br>  The site is spinning on one dedicated server, but due to the likelihood of further growth in the future, memcached is selected for caching; <br>  Daily attendance: ~ 23,000 unique visitors and ~ 300,000 page views; <br>  80% of visitors are authorized users; <br>  The main content: the text (books that authors write and publish on the site by chapters, like samizdat). <br>  Services: personalized news, reading texts, divided into chapters, comments, profiles, blogs, ratings, subscriptions, tags, bookmarks, private messages, counters, email notifications ... <br>  User activity: more than 10,000 actions, leading to a change in content, per day. <br><br>  Difficulty implementing caching: the vast majority of pages contain personalized data.  Somewhere everything is unique, right down to requests to the database, somewhere you can divide requests into general and unique, somewhere it is impossible, somewhere personal user settings are applied to the data after they have been selected from the database. <br><a name="habracut"></a><br><h4>  Introduction and Lyrics </h4><br>  I have a bicycle - a favorite tricycle, written nine years ago.  Since then, he corresponded many times, but since I didn‚Äôt work on web development or programming professionally, the project remained technologically very low and the principle of ‚Äúdo not touch while working‚Äù reigns in work on it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, the project was written in PHP naked, without frameworks, without OOP, without the use of third-party libraries, without template engines and without templates at all.  The database, by itself, MySQL, tablets, by itself, MyISAM, the server, by itself, Apache (later nginx stood before it), on the front end, by itself, jQuery and quite a lot of AJAX. <br><br>  Time passed, users arrived, I was entertained by thinking of how to make the site even more convenient for authors and readers (the two main roles that users of the site share), authors and readers liked and called friends.  Over time, the site has accumulated a lot of various settings, checkboxes and functions.  And so, when in the evenings the server began to show suspicious 3-4 la, and phpmyadmin told me about 89 requests per second and 48 Gb / h of network traffic, I found it useful to look for information on caching. <br><br><h4>  Preparation - analyze what to cache </h4><br>  I reached into liveinternet, took statistics on the pages for the last month and made a sign with the distribution of views on the sections of the site. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49f/2d9/3aa/49f2d93aa2aa5702f7cfa5d4a3fff93c.png"><br><br>  You can clearly see that first of all, you need to cache two sections (3, read), which together account for almost 60% of all page views and for which there are many requests to the database and a lot of data formatting.  Then it is necessary to cache main &amp; news, well, everything else is already insofar as it is to clear your conscience and in the hope of a multiple increase in attendance. <br><br><h4>  Scene one - we cache the texts of books </h4><br>  Section - read. <br>  The easiest part and the most important resource saving.  So, the texts of books are stored in the database in the form of a single tablet, where the entry is the chapter of the book.  The text of the chapter and the meta-information are stored together, and the text is stored in raw form - it must also be processed before output.  Why is raw text stored?  - It happened historically, from the database, the text can be displayed in many places: on the reading page, in the simple editor to the author, in the visual editor to the author, in the script for creating the fb2 version.  In an amicable way, it is long overdue that the database should be redone and the option ready for output should be stored next to the raw text, but this still remains the basis for further optimization. <br><br>  A separate chapter or all chapters can be displayed on the page at once.  Therefore, it was decided to cache the following to save memory: <br>  1. An array with a list of chapters (one-dimensional array containing sequence numbers of chapters).  The key is "f123". <br>  2. For each chapter - an array containing meta-information about the chapter and prepared for the conclusion of the text of the chapter.  The key is ‚Äúf123c1‚Äù. <br>  <i>Why is not stored html-ka at once with the whole chapter - because when displaying all the chapters and outputting one chapter, the formatting of the chapter name is different.</i> <br><br>  A minor complication is that for the author of the book and the administrator, the output must go past the cache, since it will also contain unpublished chapters. <br><br>  The script algorithm is simple: <br>  1. Chapter requested. <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($is_author || $is_admin) { <span class="hljs-comment"><span class="hljs-comment">//    ,    } else { $data = cache_get('f'.$id.'c'.$cid); // $id - id , $cid -     ,      $_GET if(!$data) { //       } else { //   } }</span></span></code> </pre> <br>  2. All chapters requested. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($is_author || $is_admin) { <span class="hljs-comment"><span class="hljs-comment">//     ,    } else { $data = cache_get('f'.$id.'conarr'); // $id - id     $_GET if(!$data) { //       .      ,     ,  ,   ,   ,           .     } else { $data = unserialize($data); foreach($data as $tmp) { $tmp_data = cache_get('f'.$id.'c'.$tmp['cid']); if(!$tmp_data) { //    ,     } else { //   } } } }</span></span></code> </pre><br><h6>  Cache reset </h6><br>  The cache of chapters and content is created indefinitely, its resetting should be managed. <br>  1. In the admin there is a function of resetting all entries in the cache for a particular book. <br>  2. When the author publishes a new chapter, the chapter list cache is deleted. <br>  3. When the author makes changes to the chapter, the cache of the changed chapter is deleted. <br><br><h4>  Scene two - we cache the contents of the book. </h4><br>  The content of the book is displayed in two sections (3 and read), but they are displayed differently, you have to make two versions of the cache. <br>  The difficulty of caching content: <br>  1. In the read section in the case of viewing a specific chapter, the content is marked on which chapter we are currently located. <br>  2. Section 3 may display links to load the audio version of a particular chapter, if that audio version exists. <br>  3. In section 3, if a particular chapter is published today, a picture is displayed after it NEW. <br>  4. In both sections of the content can be displayed bookmarks, if the reader has previously read this book and noted some places.  There can be a maximum of five bookmarks in one book and one user, but each chapter can have several bookmarks (at least all five in one chapter). <br><br>  Decision: <br>  The cache will save the template content with anchors for additional information. <br>  1. The note about being on a specific chapter is a special character that appears before the chapter name (in the future I will make it a special class for li, but nothing will change for the described algorithm).  The anchor has the form {Nar}, where N is the ordinal number of the chapter.  Accordingly, at the conclusion: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      . $cid -    ,    $_GET $contents_list = str_replace('{'.$cid.'ar}', '&lt;span class="red"&gt;&gt;&lt;/span&gt;', $contents_list); //      $contents_list = preg_replace('/{\d+ar}/', '', $contents_list);</span></span></code> </pre><br>  2. With audio versions, everything is simple.  In the version of the cache that is intended for section 3, there are links to audio versions of the chapters, and in the version for the read section, they are not. <br>  3. To display the picture NEW, after the title of each chapter in the template, anchors of the form {dmY} with the publication dates of each chapter are inserted, and in the output: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       $tmp = date('dmY'); $contents_list = str_replace('{'.$tmp.'}', ' &lt;img src="/images/new.png"&gt;', $contents_list); //      $contents_list = preg_replace('/{\d+.\d+.\d+}/', '', $contents_list);</span></span></code> </pre><br>  4. Here, first I had to implement the caching of each user's bookmarks.  Briefly: a cache is created with an array of bookmarks of a particular user in a particular book, a key of the form ‚Äúu90000f123bm‚Äù, where 90000 is the user id, and 123 is the book id.  If the user does not have bookmarks in this book, the cache is still created, the value is indicated by ‚Äúno‚Äù (this is necessary not to request the database every time, if the cache does not contain data using the required key).  The cache is created indefinitely, each time a bookmark is added or deleted, an attempt is made to delete the cache for the book that owns the bookmark being created / deleted.  In the case of the existence of bookmarks, an array is stored in the cache, each entry of which contains meta-information of the bookmark and the sequence number of the chapter in the book to which the bookmark belongs. <br>  In the content template, after the title of each chapter, an anchor of the form {Nbm} is retained, where N is the sequence number of the chapter.  When withdrawing: <br><pre> <code class="php hljs">$bm = LibMember_bm($id); <span class="hljs-comment"><span class="hljs-comment">//          $id,    ,   if($bm != 'no') { $bm = unserialize($bm); foreach($bm as $tmp) { $contents_list = str_replace('{'.$tmp['cid'].'bm}', $tmp[' '].'{'.$tmp['cid'].'bm}', $contents_list); // ,    ,         } } //     $contents_list = preg_replace('/{\d+bm}/', '', $contents_list);</span></span></code> </pre><br><br><h6>  Cache reset </h6><br>  The content cache is created indefinitely.  Need to manage manually. <br>  The content cache is deleted when the author publishes new chapters or when old ones change (the chapter name may change). <br><br><h4>  Bye all </h4><br>  These two points and some other little things are for the time being and all my steps towards caching in a working project.  Further will be more if the article is of interest, I will describe new techniques that will be invented for caching data in the remaining sections of the site. <br>  Already, we managed to reduce the evening la server to 0.8-1.5 and the phpmyadmin readings to 59 requests per second and 4.6 Gb / h of network traffic (although this readings a day after the server is restarted - the traffic figure per hour will drop due to the cache filling). <br>  Let me remind you that the initial figures were as follows: <br><blockquote>  3-4 la, and phpmyadmin told me about 89 requests per second and 48 Gb / h of network traffic </blockquote></div><p>Source: <a href="https://habr.com/ru/post/211478/">https://habr.com/ru/post/211478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211468/index.html">VLC stereo player</a></li>
<li><a href="../211470/index.html">How to run a program without an operating system: part 5. Accessing the BIOS from the OS</a></li>
<li><a href="../211472/index.html">Basics of creating a 2D character in Unity 3D 4.3. Part 1: character preparation and animation of rest</a></li>
<li><a href="../211474/index.html">The easiest cross-platform server with ssl support</a></li>
<li><a href="../211476/index.html">About liberties in the links or the simplest messaging</a></li>
<li><a href="../211480/index.html">Playing MIDI sounds in JAVA</a></li>
<li><a href="../211482/index.html">Unity3D WWW Wrapper</a></li>
<li><a href="../211486/index.html">Olympic widgets for your site: live broadcast from social media</a></li>
<li><a href="../211488/index.html">Flexible cms for bold projects</a></li>
<li><a href="../211490/index.html">Python guard wallet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>