<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Accumulated some information from Ineta on circuitry, controllers, various examples. As confirmation of my small developing project, I decided to writ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home automation</h1><div class="post__text post__text-html js-mediator-article">  Accumulated some information from Ineta on circuitry, controllers, various examples.  As confirmation of my small developing project, I decided to write this article ... <br><br>  <b>So we have:</b> <br>  The dir-320 router (with dd-wrt, the installation process is described on our personal blog, if necessary, I will add links to the blog), ATmega8535 controller, a small control circuit on the opto driver, control object (desk lamp, sound amplifier, home water heater), a little wires, soldering iron, free time. <br>  What I would like to receive: software power management of objects that are powered from a network of ~ 220 V. <br><br>  On Habr√© there was a whole cycle of articles about "how to turn on the LPT desk lamp" and so on ... BUT!  It offers a more or less advanced, secure and autonomous management system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the limitless - under the cut of the picture. <br><a name="habracut"></a><br>  <b>The object itself is managed as follows:</b> <br><br>  Mobile phone-&gt; mobile browser-&gt; wifi (mobile) -&gt; wifi (dir-320 router) -&gt; installed lightpd-&gt; handler for perl-&gt; uart (router) -&gt; uart (mega8535 controller) -&gt; control signal (+ 5v controller) -&gt; control signal (+ 5V optodriver) -&gt; controlled signal (~ 220V optodriver) -&gt; control object. <br>  In this scheme, you can replace ‚ÄúMobile phone-&gt; mobile browser-&gt; wifi (mobile) -&gt;‚Äù with a laptop, a working PC, and so on. <br><br>  It is also possible to control through the wan port connected to the Internet network, again by referring to lightpd. <br><br>  <b>Which + of this control scheme:</b> <br><br><ul><li>  You do not need to get out of bed to turn on the light off, as the control is either from the laptop or from the mobile. </li><li>  It is possible to save energy by turning off / on the water heater, even if you are not at home - via the Internet. </li><li>  Integrated on / off devices (coming to the house, you can turn on for example the light wherever you need, including an electric kettle before coming) </li><li>  I often forget to disconnect the device from the network before leaving.  it becomes possible at any moment. </li></ul><br><br>  <b>Which - this control scheme:</b> <br><br><ul><li>  Perhaps it will not be enough to get or hold a mobile phone in your hand each time to turn on / off the light.  But this is solved by parallel switching on the opto driver with a physical switch.  But again it will not turn off remotely if the switch is on. </li><li>  Each device has an additional wire and a device on the opto driver.  Wires need to somehow be fixed to the wall or hidden in the wall, which entails changing the wallpaper))))) The opto driver must be hidden in the outlet, God forbid if there is enough space) </li><li>  The exceptional situation is when the mobile has sat down, the laptop does not turn on, and the computer has broken.  Solved only by the parallel inclusion of physical controls. </li></ul><br>  <b>What are the possibilities to supplement this control scheme:</b> <br><ul><li>  Put motion sensors to turn on the light.  On the controller, make an adjustable shutdown delay (3-5 minutes at discretion). </li><li>  Wireless control via toshiba microcircuits, but will have to be supplemented with a power circuit from ~ 220v. </li></ul><br><br>  <b>Well, actually in practice we will do the following:</b> <br><br>  First you need to decide on the router software. <br>  Since we have linux on board the dir-320, working with physical ports does not cause any problems - the software is full, you can install and use. <br>  Our UART interface of the router hangs from / dev / tts / 0 from a software point of view. <br>  In it, we will write data that will be transmitted to the controller. <br>  In general, I am not a coder and write programs on the PC for working with devices, IMHO there are regular tools.  For example, redirecting output to the shell: <br><br> <code>echo ¬´¬ª &gt; /dev/tts/0</code> <br> <br>  The team itself will send the string to the port, which is what we need. <br>  Before using the port, it must be configured.  (stop bits, transmission control, speed) <br>  In this case, 8 data bits, 1 stop bit, 300 baud will be used (and we don‚Äôt need more). <br><br> <code>stty -crtscts 300 &lt; /dev/tts/0</code> <br> <br>  A simple protocol was developed for management: <br><br>  The line begins with the symbol!, Then the word port goes, then the controller port is indicated (in this case, mega8535 has 4 of them - A, B, C, D).  Then the pin number (there are 8 of them, from 0 to 7).  Then byte n or f (n - respectively submit + 5v to pin, f - not submit to pin + 5V) <br><br>  Note: <br><br>  ! porta1n - will turn on the second pin of port A on the controller. <br>  ! ports4f - disables the fifth pin of port C on the controller. <br>  !  - the symbol means the start of the command, those controller will wait for the start of the command only with the symbol! <br>  port - for ‚Äúdata control‚Äù, is it not enough what kind of interference will be (although it is very unlikely). <br><br>  To do this, a small script was written on the form: <br><br> <code>#!/opt/usr/bin/perl <br> $cmd=$ARGV[0]; <br> `echo !port$cmd &gt; /dev/tts/0`;</code> <br> <br>  It is launched in the format ‚Äúdo.pl a1n‚Äù, which will enable pin 1 of port A on the controller. <br>  lighttpd will run the do.pl script <br><br>  <b>We put lighttpd:</b> <br><br> <code>ipkg-opt update <br> ipkg-opt install lighttpd <br> ipkg-opt install mod-fastcgi</code> <br> <br>  Next, edit /opt/etc/lighttpd/lighttpd.conf <br>  We set the port setting - 8080 (you can choose at your discretion). <br>  !!!  CHANGING <br>  # server.event-handler = "freebsd-kqueue" # needed on OS X <br>  on <br>  server.event-handler = "poll" # needed on OS X <br>  otherwise it will swear at startup. <br><br> <code>/opt/etc/init.d/S80lighttpd start</code> <br> <br>  The root directory will be / opt / share / www.  We write a script on php to run the perl script with parameters.  (It is very resource-intensive, and I would even say ‚Äústupid‚Äù to use such investments of pearl in php, but the example is still working.) <br><br> <code>&lt;?php <br> $do=$_GET['do']; <br> if (!isset($do)) { print "no command"; exit(0);} <br> passthru("/opt/bin/perl /opt/home/do.pl do"); <br> ?&gt;</code> <br> <br>  ATTENTION!!!  I want to note that using these examples is a blow to security ... IMHO you will need to check the variable do. <br><br>  Now, referring to the address http: //: 8080 / test.php? Do = a1n - send data to the controller. The second pin of port A. will turn on. <br><br>  <b>Now consider the physical connection of the router with the controller.</b> <br><br><img src="http://habrastorage.org/storage1/6a001e32/ae6b5098/7fc25de9/4fc378e3.jpg"><br><br>  As you can see from the image - Uart is at the bottom - 5 extreme conclusions - the receiver and transmitter are second ground 3.3V, but we do not need it. <br><img src="http://habrastorage.org/storage1/8e54f260/1342b203/33eaf220/1751143f.gif"><br><br>  In the controller, ports 14 and 15 are used for receiving / transmitting. <br>  Accordingly, we connect the RX router and the TX controller, and vice versa the TX router with the RX controller. <br>  If you power the controller from the power source of the router (the router is powered by 5 V), then you only need 2 wires.  BUT!  if you power the controller from other sources, you need to connect GND with the third wire !!! <br>  As a result, I got the following. <br><br><img src="http://habrastorage.org/storage1/554c7612/ba3ee56f/d9fb36db/8fe5631c.jpg"><br><br>  By the way, the router from the MTS, white)) <br>  As you can see, the controller is on top, 4 holes D = 1mm for wires, 2-uart, 2-controller power are made in the cover.  (5V router power, who prevents to take us power for the controller directly from the router port :)) <br>  Convenient for upgrading the controller firmware, the controller on the socket. <br>  Also, the pins of the controller pins are connected to an additional board with terminal blocks (blue ones), from where the control current to the opto drivers comes from. <br><br>  <b>So the controller.</b> <br><br>  Actually there is only firmware.  Everything was written in CodeVisionStudio. <br>  An example of firmware on Syah. <br>  In the code generator, we include all the ports for output. <br>  In the UART panel we include an interrupt, a buffer of 8 characters.  300 baud rate, 8 data bits, 1 stop. <br><br>  Part of the program: <br><br> <code>int port(char port,char num,char is) <br> { <br> <br> if (port=='a') <br> { <br> putchar('A'); <br> if (num=='0') {if ( (PINA.0==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+1;} if ( (PINA.0==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-1;} } <br> if (num=='1') {if ( (PINA.1==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+2;} if ( (PINA.1==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-2;} } <br> if (num=='2') {if ( (PINA.2==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+4;} if ( (PINA.2==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-4;} } <br> if (num=='3') {if ( (PINA.3==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+8;} if ( (PINA.3==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-8;} } <br> if (num=='4') {if ( (PINA.4==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+16;} if ( (PINA.4==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-16;} } <br> if (num=='5') {if ( (PINA.5==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+32;} if ( (PINA.5==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-32;} } <br> if (num=='6') {if ( (PINA.6==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+64;} if ( (PINA.6==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-64;} } <br> if (num=='7') {if ( (PINA.7==0) &amp;&amp; (is=='n') ) {putchar('N'); PORTA=PORTA+128;} if ( (PINA.7==1) &amp;&amp; (is=='f') ) {putchar('F'); PORTA=PORTA-128;} } <br> } <br> <br> return 0; <br> }</code> <br> <br>  For other ports by analogy. <br><br>  In the main function: <br><br> <code>while (1) <br> { <br> k = getchar(); <br> if (k=='!') <br> { <br> for (i=0;i&lt;=6;i++) <br> { <br> buf[i]=getchar(); <br> } <br> if ( (buf[0]=='p') &amp;&amp; (buf[1]=='o') &amp;&amp; (buf[2]=='r') &amp;&amp; (buf[3]=='t') ) <br> { <br> port(buf[4],buf[5],buf[6]); <br> } <br> } <br> }</code> <br> <br>  At this stage we have the ability to manage the findings through the web of the router !!! <br>  Now we need to somehow manage the load ~ 220 V by means of 5V, which the controller gives us. <br>  Of course, it would be possible to use a relay for such purposes + transistor, since the output current of the pins of the controller is not able to control the relay.  Again, it would be necessary to use an additional power source for the transistor ‚Äì relay circuit.  Yes and relyushki durable. <br>  Due to these circumstances, we had to stop at the opto driver. <br><br>  Benefits: <br><br><ul><li>  No need for extra power. </li><li>  Contact between circuits 220 and 5 exclusively through light (diode + photo sensor) </li><li>  Noiselessness </li><li>  High current </li></ul><br><br>  Disadvantages: <br><br><ul><li>  A bit more expensive than a relay </li><li>  Triac heats up, need additional radiator </li><li>  Making it longer and more difficult, but not much </li></ul><br><br>  <b>So Optodriver.</b> <br><br><img src="http://habrastorage.org/storage1/e2893a78/be5413e3/6b6fc198/8e4e0e3f.jpg"><br><br>  We will need: <br><br><ul><li>  380 ohm resistor </li><li>  330 ohm resistor </li><li>  39 ohm resistor </li><li>  1 kŒ© resistor </li><li>  Ceramic capacitor 0.01 microfarad !!!  volt so on 500-600, but not less than 300 !! </li><li>  Triac BT139 </li><li>  MOC3041 </li></ul><br><br>  As a result, it should turn out something like these boards. <br><br><img src="http://habrastorage.org/storage1/3f683b4f/2d3c50cf/e0ff27e1/5ca94390.jpg"><br><br>  This circuit can withstand current up to 16 amps, which corresponds to 3 kilowatts of load. <br>  Considering the fact that my water heater is the most consumed device in an apartment, and that consumption is going on - 2 kilowatts. !!!  But with a load above a kilowatt, you need to put the radiator on the triac, as it is heated. <br><br>  In general, in fact, you can use any device in which there is a UART, and it is in almost all types of routers.  The only difference is how to program it. <br><br>  ps: Questions, suggestions? <br>  pps: people, do not write comments like "here if it were not hands from the experience ..." and the like, it‚Äôs all the easier way;) <br><br>  ppps: I read the comments, I want to make a small economic review in view of comparing the cost with finished products such as Arduin. <br><br><ul><li>  The router was purchased in the MTS for 1500 p </li><li>  The controller for 150-200r. </li><li>  Each circuit on the triac costs 100 rubles. </li><li>  Wires for wiring if the store - 5-10 p.  per meter. </li><li>  Other stuff - 100 p. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/123933/">https://habr.com/ru/post/123933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123925/index.html">Midnight Commander 4.8.0 File Manager Release</a></li>
<li><a href="../123926/index.html">Payoneer cards - not just for freelancers</a></li>
<li><a href="../123927/index.html">Google will finance the Internet Institute in Berlin</a></li>
<li><a href="../123930/index.html">Wordpress.com now has over 50 million sites.</a></li>
<li><a href="../123932/index.html">Social network as a tool of scientific work</a></li>
<li><a href="../123934/index.html">Using the graph as a basis for creating a rubricator</a></li>
<li><a href="../123935/index.html">Measurement of structural deformation by photogrammetry</a></li>
<li><a href="../123936/index.html">Save your data safely: p2p file system with encryption in the cloud</a></li>
<li><a href="../123937/index.html">Asynchronous loading of images in a hidden iframe: pitfalls</a></li>
<li><a href="../123939/index.html">ISO prepares a cloud security standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>