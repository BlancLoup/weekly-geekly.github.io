<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Audit users in AD through VBS, listed in SharePoint using PowerShell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon ufo watchers 
 I wanted to describe how I collected information about users from AD and then placed information on SharePoint for reada...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Audit users in AD through VBS, listed in SharePoint using PowerShell</h1><div class="post__text post__text-html js-mediator-article"><h5>  Good afternoon ufo watchers </h5><br>  I wanted to describe how I collected information about users from AD and then placed information on SharePoint for readability and at any time to look at that, or another user, the necessary information for us. <br>  I will describe simply because it was all ... <br><a name="habracut"></a><br>  The task is to collect from AD information about users that you can pull out and certain of their goals. <br>  From what was available: VBS was chosen to collect information about users via LDAP, we collect everything into a simple text file (since the collection takes place in several segments separated among themselves), the files are collected in one place and then using PowerShell we place on a prepared SharePoint site . <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> oQuery <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> objConnection <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> objCommand <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> objRecordSet <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> strMember <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> strAC <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> arrMember <span class="hljs-comment"><span class="hljs-comment">'       logfile = "users-lvs.txt" Set objFSO = CreateObject("Scripting.FileSystemObject") oQuery = "&lt;LDAP://dc=my,dc=site&gt;;" &amp; _ "(objectCategory=user)" &amp; _ ";distinguishedName,name,sAMAccountname,mail,memberOf,userAccountControl,description;subtree" '            Set objConnection = CreateObject("ADODB.Connection") Set objCommand = CreateObject("ADODB.Command") objConnection.Open "Provider=ADsDSOObject;" objCommand.ActiveConnection = objConnection objCommand.CommandText = oQuery Set objRecordSet = objCommand.Execute '    - ,   -  if objFSO.FileExists(logfile) then Set objFile = objFSO.OpenTextFile(logfile, 2) objFile.Write "" else Set objFile = objFSO.CreateTextFile(logfile) objFile.Close Set objFile = objFSO.OpenTextFile(logfile, 2) objFile.Write "" end if objFile.Close '  ,     While Not objRecordSet.EOF strMember = objRecordSet.Fields("memberOf") strStr = "" For i = 0 To UBound(strMember) '        liluka = InStr(2, strMember(i), ",", vbTextCompare) '       strStr = strStr &amp; Right(Left(strMember(i), liluka - 1), liluka - 4) &amp; ", " Next arrOpis = objRecordSet.Fields("description") strOpis = "" For i = 0 To UBound(arrOpis) strOpis = strOpis &amp; arrOpis(i) &amp; ", " Next '      Select Case objRecordSet.Fields("userAccountControl") Case 512 strAC = "" Case 514 strAC = "" Case 66048 strAC = "" Case 66050 strAC = "" End Select '      Set objFile = objFSO.OpenTextFile(logfile, 8) objFile.WriteLine objRecordSet.Fields("sAMAccountname") &amp; ";1" &amp; _ objRecordSet.Fields("name") &amp; ";2" &amp; _ objRecordSet.Fields("mail") &amp; ";3" &amp; _ strStr &amp; ";4" &amp; strAC &amp; ";5" &amp; strOpis &amp; ";6" objFile.Close objRecordSet.MoveNext Wend objConnection.Close</span></span></code> </pre> <br><br>  From the code it is clear that at the end of the line it is added "; 6LWs", as we already said above, we have several segments and this is the first LAN.  With the sign that the user is turned off, he didn‚Äôt think long and took the 4 values ‚Äã‚Äãwe have, if you make life difficult and dig, you can read the variable bits by bit ... <br>  What would the PowerShell script understand where what information is located, did not come up with anything better than how to put a number indicating the index of certain information through a semicolon. <br>  Not a professional, but just a lover of code I, both programming and analysis / parsing. <br>  Actually the PowerShell code itself: <br><pre> <code class="cpp hljs">#          ,  write-host open Sharepoint from USERS <span class="hljs-meta"><span class="hljs-meta"># sharepoint $env:SPpath = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"${env:CommonProgramFiles}\Microsoft Shared\web server extensions\12\" [System.Reflection.Assembly]::LoadFrom("</span></span></span><span class="hljs-meta">$env:SPPath\ISAPI\Microsoft.SharePoint.dll</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">") write-host open web #  web $nsite="</span></span></span><span class="hljs-meta">http:</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//my_site/sites/MonitorUser" $SpSite = New-Object -TypeName "Microsoft.SharePoint.SPSite" -ArgumentList $nsite; $spweb=$spsite.OpenWeb(); write-host open Sharepoint list #   $nlist="http://my_site/sites/MonitorUser/Lists/List5/AllItems.aspx" $splist=$spweb.getlist($nlist); #   write-host clearing list... $iCnt = $splist.Items.Count; #$icnt; for ($jj=1; $jj -le $iCnt; $jj++){ $splist.Items.Delete(0); } write-host clearing list Done #      ,     write-host Processing log files... foreach ($file in $(get-childitem 'D:\scripts\work\' -include users*.txt -recurse)) { $hostout = $file.FullName + "..." Write-Host $hostout $fl = get-content $file.FullName; # $fl; for ($i=1; $i -lt $fl.Count; $i++) { $st1 =$fl[$i]; #       $ind1 = $st1.IndexOf(";1") $ind2 = $st1.IndexOf(";2") $ind3 = $st1.IndexOf(";3") $ind4 = $st1.IndexOf(";4") $ind5 = $st1.IndexOf(";5") $ind6 = $st1.IndexOf(";6") $stLogin = $st1.substring(0,$ind1) $stUserName = $st1.substring($ind1+2,$ind2-$ind1-2) $stMail = $st1.substring($ind2+2,$ind3-$ind2-2) $ind7 = $ind4-$ind3 if ($ind7 -eq 2) { $stGroup = " " } else { $stGroup = $st1.substring($ind3+2,$ind4-$ind3-4) } $ind7 = $ind6-$ind5 if ($ind7 -eq 2) { $stOpis = "" } else { $stOpis = $st1.substring($ind5+2,$ind6-$ind5-4) } $stBlock = $st1.substring($ind4+2,$ind5-$ind4-2) $stSeg = $st1.substring($ind6+2,3) #         $NewItem = $SpList.Items.Add(); $NewItem[""] = $stLogin; $NewItem[" "] = $stUserName; $NewItem["e-mail"] = $stMail; $NewItem[""] = $stGroup; $NewItem[""] = $stBlock; $NewItem[""] = $stSeg; $NewItem[""] = $stOpis; $NewItem.Update(); } } write-host Processing log files DONE $spweb.Dispose(); $spsite.Dispose(); write-host Program END</span></span></span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now after we have assembled tht in one place, run the batch file <br><pre> <code class="hljs mel">cscript users-lvs.vbs %SystemRoot%\system32\WindowsPowerShell\v1<span class="hljs-number"><span class="hljs-number">.0</span></span>\powershell.exe <span class="hljs-string"><span class="hljs-string">"&amp; 'D:\scripts\work\users.ps1'"</span></span> %SystemRoot%\system32\WindowsPowerShell\v1<span class="hljs-number"><span class="hljs-number">.0</span></span>\powershell.exe <span class="hljs-string"><span class="hljs-string">"&amp; 'D:\scripts \work\pk.ps1'"</span></span></code> </pre><br>  Since our site is running in the LAN segment, the information on these users is updated as well.  And as you can see, the working script collects information on computers (OS, version, pack, description, when turned on), but there everything is similar to how users are. <br>  The longest that it takes in everything is the cleansing of the information page (approximately 2-3 minutes).  If the pages are clean, then the collection and processing of several files in total takes no more than 30 seconds, 700-800 records. <br>  In fact, there is a lot of information in LDAP and added its own working script with the fact that it looks when the user came in last, as well as when he changed the password last time.  In WMI there is a ‚Äúdirectory \ LDAP‚Äù and in principle you can find a lot of interesting information. <br><br>  PS I quickly sketched my hand, I will be glad to any criticism, but better advice on how to improve, where some moments do not like and why, arguing this ... </div><p>Source: <a href="https://habr.com/ru/post/158183/">https://habr.com/ru/post/158183/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158165/index.html">Text Mining Framework (Java)</a></li>
<li><a href="../158167/index.html">jQuery File Upload. Upload and add images to the database</a></li>
<li><a href="../158169/index.html">Running Gadgets: From Simple to Very Simple</a></li>
<li><a href="../158171/index.html">We make from the old ‚Äústupid‚Äù TV - new and ‚Äúsmart‚Äù and that ‚Äúbeautiful‚Äù was</a></li>
<li><a href="../158177/index.html">Ethernet physics for the smallest</a></li>
<li><a href="../158185/index.html">Web development on node.js and express. Chapter 2 - Testing the Application</a></li>
<li><a href="../158187/index.html">Completing the patent war between Apple and HTC</a></li>
<li><a href="../158189/index.html">FileCorrupter utility for testing products on broken input data</a></li>
<li><a href="../158193/index.html">Crash test of electric lamps at low temperatures (up to -145 degrees Celsius)</a></li>
<li><a href="../158195/index.html">Canonical launches new Ubuntu 13.04 Raring Ringtail builds every day.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>