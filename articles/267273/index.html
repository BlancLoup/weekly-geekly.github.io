<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux in a device based on the Altera SoC FPGA chip: restore lost functionality</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, the DE0-Nano-SoC developer kit, built on the basis of the Altera Cyclone V chip, came into my hands. For each of these tasks, a scheme ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux in a device based on the Altera SoC FPGA chip: restore lost functionality</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/267273/"><img src="https://habrastorage.org/files/878/c5b/06c/878c5b06c4b14fe88135f09a53de8a35.jpg" alt="Terasic DE0-Nano-SoC"></a> <br><br>  Some time ago, the DE0-Nano-SoC developer kit, built on the basis of the Altera Cyclone V chip, came into my hands.  For each of these tasks, a scheme is created for the FPGA and a program is written for the HPS.  The schema for the FPGA is created in the Quartus II environment and, during the development process, is downloaded to the FPGA via the JTAG interface via a USB blaster.  When the circuit is finally debugged, it is recorded on the SD card as a firmware file.  Then, when you need to use a board for one purpose or another, the necessary firmware is taken, loaded into the FPGA by a command like <br><pre><code class="bash hljs">cat hardware.rbf &gt; /dev/fpga0</code> </pre>  and then the desired program starts. <br><br>  Everything went on as usual, but one day I updated the Linux kernel in the board - what I was talking about in <a href="http://habrahabr.ru/post/264515/">this article</a> .  And now, after a while, it turned out that the FPGA manager, which allowed the firmware to be loaded into the FPGA in a similar way, disappeared from the list of drivers.  The first thought was that I forgot to include the driver in the configuration when building the kernel.  However, to my surprise, it was soon discovered that among the sources of the kernel, this driver is not in principle!  Of course, it would be possible to load the firmware into the FPGA in other ways, of which there are at least three more.  But this method was the most operational and convenient for me, which is why it was decided to restore the lost functionality.  If you are interested in how this was done - welcome under cat. <br><a name="habracut"></a><br><h2>  Small lyrical digression </h2><br>  To solve the problem, first of all it was necessary to find the source code of the FPGA manager.  Naturally, the first thing was examined repositories Altera.  And again, I was surprised that this driver was not in them.  I had to search all over the githab and as a result, the source code was found in the Terrasica repositories.  And here again the rake was formed: Terasik has not published anything on the githaba for a long time and the freshest kernel was version 3.12.  As a result, the source codes of the FPGA manager taken from this repository refused to be compiled for new kernels due to the fact that they used some ‚Äúobsolete‚Äù structures that were simply eliminated from the new versions.  To remake the driver for new realities, something did not bother me.  Therefore, the search was continued and in the end it ended with success - there were adapted driver source codes in the repository of a certain Mr. from Canada with the nickname <b><a href="https://github.com/xaxaxa">xaxaxa</a></b> .  For that he bowed low. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  So let's start </h2><br>  Details of the kernel assembly can be viewed in my <a href="http://habrahabr.ru/post/264515/">previous article</a> - further, in order not to repeat, I will refer to it from time to time.  All further narration will be built on the assumption that the entire kernel build process, described in that article, has already been completed and all the kernel sources are in the same place safe and sound. <br><br>  1. Run the terminalka and enter the root-mode - in order not to type sudo command every time: <br><pre> <code class="bash hljs">sudo -i</code> </pre><br>  At the same time / root will be our home directory - we will do everything in it. <br><br>  2. Download the source code of the FPGA manager <a href="https://github.com/xaxaxa/linux-3.13-socfpga-vserver-aufs/tree/socfpga-3.13/drivers/fpga">from here</a> and put it in the /root/linux-socfpga-4.1/drivers/fpga/ directory <br><br>  We also take away <a href="https://github.com/xaxaxa/linux-3.13-socfpga-vserver-aufs/tree/socfpga-3.13/include/linux">from here the</a> fpga.h header and write it to the /root/linux-socfpga-4.1/include/linux/ directory <br><br>  3. Edit the file /root/linux-socfpga-4.1/drivers/Kconfig - add one line to it: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"drivers/fpga/Kconfig"</span></span></code> </pre><br>  Where exactly to add it - does not matter.  The main thing is that it should not be the very first or the very last line of the file.  I added it right after the first line.  It turned out like this: <br><pre> <code class="bash hljs">menu <span class="hljs-string"><span class="hljs-string">"Device Drivers"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"drivers/fpga/Kconfig"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"drivers/amba/Kconfig"</span></span> ...</code> </pre><br>  4. Edit the file /root/linux-socfpga-4.1/drivers/Makefile - add one line to it: <br><pre> <code class="bash hljs">obj-$(CONFIG_FPGA) += fpga/</code> </pre><br>  Where exactly to add it - again, does not matter.  I added it immediately after the initial comments.  It turned out like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Makefile for the Linux kernel device drivers. # # 15 Sep 2000, Christoph Hellwig &lt;hch@infradead.org&gt; # Rewritten to use lists instead of if-statements. # obj-$(CONFIG_FPGA) += fpga/ obj-y += irqchip/ ...</span></span></code> </pre><br>  5. Run the alter script, which will launch a new BASH and tweak some environment variables in it (for example, PATH).  All compilation actions will be carried out without leaving this BASH: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/altera/15.0/embedded ./embedded_command_shell.sh</code> </pre><br>  6. Create several environment variables: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ARCH=arm <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CROSS_COMPILE=arm-linux-gnueabihf- <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LOADADDR=0x8000</code> </pre><br>  7. Go to the directory with the kernel sources and add the FPGA manager driver to the kernel configuration: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/linux-socfpga-4.1 make menuconfig</code> </pre><br>  This will open a pseudographic window with menus.  Go to the submenu <b>Device Drivers</b> .  Here we will see that in the first place there is a new submenu of <b>FPGA devices</b> - we go into it.  Inside there will be an <b>FPGA Framework</b> driver - we add it to the kernel: press the space on it twice - at the same time, an asterisk appears in front of it, indicating that this driver will be built into the kernel.  Immediately after performing these actions, another <b>Altera</b> driver will appear in the list - we turn it on too: double click on it: <br><br><img src="https://habrastorage.org/files/715/bba/d75/715bbad750b546c59beee4c8029fa36a.gif"><br><br>  Since we did not reset the configuration to the initial state with the <b>make socfpga_defconfig command</b> , the rest of the settings should remain in the same state - as we set them in the <a href="http://habrahabr.ru/post/264515/">process of building the kernel</a> . <br><br>  Exit the menu - press <b>Exit</b> until we <b>exit</b> .  To the question - whether it is necessary to save the configuration - we answer <b>Yes</b> . <br><br>  8. Compile the kernel: <br><pre> <code class="bash hljs">make uImage</code> </pre><br>  Since the kernel was compiled by us earlier, now it will take very little time to rebuild it with new drivers. <br><br>  9. Add information about FPGA-manager to the device tree. <br>  To do this, add the following lines to the /root/linux-socfpga-4.1/arch/arm/boot/dts/socfpga.dtsi file: <br><pre> <code class="bash hljs"> fpgamgr: fpgamgr@0xff706000 { compatible = <span class="hljs-string"><span class="hljs-string">"altr,fpga-mgr-1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"altr,fpga-mgr"</span></span>; transport = <span class="hljs-string"><span class="hljs-string">"mmio"</span></span>; reg = &lt;0xFF706000 0x1000 0xFFB90000 0x1000&gt;; interrupts = &lt;0 175 4&gt;; };</code> </pre><br>  These lines can be added to the <b>soc</b> block. <br><div class="spoiler">  <b class="spoiler_title">For example, here.</b> <div class="spoiler_text"><pre> <code class="bash hljs">... qspi_clk: qspi_clk { <span class="hljs-comment"><span class="hljs-comment">#clock-cells = &lt;0&gt;; compatible = "altr,socfpga-gate-clk"; clocks = &lt;&amp;f2s_periph_ref_clk&gt;, &lt;&amp;main_qspi_clk&gt;, &lt;&amp;per_qspi_clk&gt;; clk-gate = &lt;0xa0 11&gt;; }; }; }; fpgamgr: fpgamgr@0xff706000 { compatible = "altr,fpga-mgr-1.0", "altr,fpga-mgr"; transport = "mmio"; reg = &lt;0xFF706000 0x1000 0xFFB90000 0x1000&gt;; interrupts = &lt;0 175 4&gt;; }; gmac0: ethernet@ff700000 { compatible = "altr,socfpga-stmmac", "snps,dwmac-3.70a", "snps,dwmac"; altr,sysmgr-syscon = &lt;&amp;sysmgr 0x60 0&gt;; reg = &lt;0xff700000 0x2000&gt;; interrupts = &lt;0 115 4&gt;; ...</span></span></code> </pre><br></div></div><br>  10. Convert the device tree file into a binary format: <br><pre> <code class="bash hljs">make socfpga_cyclone5_sockit.dtb</code> </pre><br>  11. Copy the kernel and .dtb-file to the card in the FAT32 partition.  I will not repeat: on how to do this, described in detail in subsection 13 of the <b>kernel assembly</b> section <b>of</b> <a href="http://habrahabr.ru/post/264515/">this article</a> . <br><br>  That's all - the kernel build process with the FPGA manager driver is complete. <br><br><h2>  Health check </h2><br>  We put the SD-card in the board, boot and check operation. <br>  To do this, first look at the contents of the / dev directory - the <b>fpga0</b> driver file should appear in it: <br><br><img src="https://habrastorage.org/files/bc6/aa6/e78/bc6aa6e787d24cd7be69f7d77c96ed13.gif"><br><br>  Well, at the end of the download some firmware in the FPGA: <br><br><img src="https://habrastorage.org/files/e35/06e/a18/e3506ea1807646d8be526f8065e9d537.gif"><br><br>  Voila!  Everything works as expected. <br><br>  Thank you all for your attention! </div><p>Source: <a href="https://habr.com/ru/post/267273/">https://habr.com/ru/post/267273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267253/index.html">In the Chinese AppStore, 39 infected applications were detected due to a modified version of Xcode.</a></li>
<li><a href="../267257/index.html">New PHP, Part 1: Return types</a></li>
<li><a href="../267265/index.html">The digest of interesting materials for the mobile developer # 121 (September 14-20)</a></li>
<li><a href="../267269/index.html">Monitoring delays during online video broadcasts and teleconferences</a></li>
<li><a href="../267271/index.html">It's harder for Chinese data center operators to use freecooling.</a></li>
<li><a href="../267277/index.html">How to write test code</a></li>
<li><a href="../267279/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 177 (September 14 - 20, 2015)</a></li>
<li><a href="../267281/index.html">PHP Digest number 70 - interesting news, materials and tools (September 6 - 20, 2015)</a></li>
<li><a href="../267283/index.html">We count working days from Moment.js</a></li>
<li><a href="../267289/index.html">Overview of opportunities for working with Microsoft for startups</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>