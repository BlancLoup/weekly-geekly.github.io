<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data Mining: Primary data processing using DBMS. Part 3 (Pivot Tables)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This series is devoted to the analysis of data for the search for patterns. As an example, one of the training tasks of the Kaggle sports data analysi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data Mining: Primary data processing using DBMS. Part 3 (Pivot Tables)</h1><div class="post__text post__text-html js-mediator-article">  This series is devoted to the analysis of data for the search for patterns.  As an example, one of the training tasks of the Kaggle sports data analysis community is used.  Although the data sizes for the task are not large, the processing methods that will be considered are quite applicable for large amounts of data. <br>  After completing <a href="http://habrahabr.ru/post/165001/">Part 1</a> and <a href="http://habrahabr.ru/post/165281/">Part 2</a> , two tables were generated containing the converted data. <br>  titanik_test_3 and titanik_train_3. <br><a name="habracut"></a><br>  The structure of the fields they differ in one field - survived, the value of which we have to determine for the test data set.  Here is the code describing the structure of the table titanik_train_3 <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> titanik_train_3 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, survived <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, pclass <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), sex <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), age <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, sibsp <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, parch <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ticket <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), fare <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, cabin <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), embarked <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), cabin_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, cabin_type <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, ticket_type <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, ticket_number <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, cabin_people_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> )</code> </pre> <br>  In fact, the task is to turn a table with character-numeric data into a table with only a numeric representation.  The creation of data dictionaries and pivot tables will help us in this.  To do this, transfer the numeric data in the same form in which they were, and encode the character data. <br>  The most important condition for using dictionaries is full coverage of values.  Therefore, it is optimal at this stage (although in principle it is possible earlier) to merge the tables into one.  And in the missing field to put NULL. <br>  Given that one and the same sequence is used to create a primary key, there should be no problems.  This is done using the UNION operator. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> a.* <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> titanik_full_1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_train_3 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> survived, pclass, <span class="hljs-string"><span class="hljs-string">"name"</span></span>, sex , age , sibsp , parch, ticket,fare,cabin,embarked,cabin_cnt,cabin_type,ticket_type,ticket_number, cabin_people_cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_test_3 ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a;</code> </pre><br>  Now we get one table that contains both test and training data sets. <br>  Remove all fields except numeric: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> a.* <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> titanik_full_2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, survived, pclass::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, age::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, sibsp::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, parch::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, fare::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, cabin_cnt::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(ticket_number <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ticket_number, cabin_people_cnt::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_full_1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ticket_number != <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, survived, pclass, age, sibsp, parch, fare, cabin_cnt, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ticket_number, cabin_people_cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_full_1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ticket_number = <span class="hljs-string"><span class="hljs-string">''</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a;</code> </pre><br>  We get the table titanik_full_2, which looks like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> titanik_full_2 ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, survived <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, pclass <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, age <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, sibsp <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, parch <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, fare <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, cabin_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, ticket_number <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, cabin_people_cnt <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> )</code> </pre><br>  Now in this table we will add a field that will mean that this or that value has a property for this row.  Such tables are called pivot tables (pivot tables), only a little different from the usual, the field-values ‚Äã‚Äãwill take either 0 or 1. Schematically, this is shown in the figure: <br><img src="https://habrastorage.org/storage2/cbd/5bc/816/cbd5bc8166a75053f873cf03443fbd45.png"><br>  Those.  the table is now larger, the number of fields will be equal to the number of unique values.  In principle, all these values ‚Äã‚Äãcan be made manually by requests.  But it is better to write a small function in PL / PGSQL, which will automatically expand the fields. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> sparse_matrix_generator( tablename_source <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, tablename_dest <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, field_name <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> pgst_object REFCURSOR; unival character varying; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> pgst_object <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'select distinct '</span></span>||field_name ||<span class="hljs-string"><span class="hljs-string">' from '</span></span>||tablename_source ||<span class="hljs-string"><span class="hljs-string">' where '</span></span> || field_name ||<span class="hljs-string"><span class="hljs-string">' NOTNULL'</span></span>; LOOP FETCH pgst_object INTO unival; EXIT WHEN NOT FOUND; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span>|| tablename_dest ||<span class="hljs-string"><span class="hljs-string">' ADD COLUMN "'</span></span>|| field_name||unival ||<span class="hljs-string"><span class="hljs-string">'" smallint NOT NULL DEFAULT 0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'UPDATE '</span></span>||tablename_dest||<span class="hljs-string"><span class="hljs-string">' SET "'</span></span>||field_name||unival|| <span class="hljs-string"><span class="hljs-string">'"= 1 FROM '</span></span> ||tablename_source|| <span class="hljs-string"><span class="hljs-string">' WHERE '</span></span>||tablename_dest||<span class="hljs-string"><span class="hljs-string">'.id = '</span></span>||tablename_source||<span class="hljs-string"><span class="hljs-string">'.id and '</span></span>||field_name||<span class="hljs-string"><span class="hljs-string">' = '''</span></span>||unival||<span class="hljs-string"><span class="hljs-string">''''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN 0; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE 'plpgsql';</code> </pre><br>  This function is applied like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sparse_matrix_generator(<span class="hljs-string"><span class="hljs-string">'titanik_full_1'</span></span>, <span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'cabin_type'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sparse_matrix_generator(<span class="hljs-string"><span class="hljs-string">'titanik_full_1'</span></span>, <span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ticket_type'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sparse_matrix_generator(<span class="hljs-string"><span class="hljs-string">'titanik_full_1'</span></span>, <span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'embarked'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sparse_matrix_generator(<span class="hljs-string"><span class="hljs-string">'titanik_full_1'</span></span>, <span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'sex'</span></span>);</code> </pre><br>  Thus, we now have a sparse matrix with a dimension of 58 columns.  It is necessary to normalize it and separate the test and training samples for the field survived. <br>  There are different ways of rationing.  There are different sampling requirements for different data analysis methods.  We use one of the most simple, minimax rationing.  The bottom line is this: the minimum will be 0, the maximum: 1, and everything else is proportionally distributed between them.  To do this, we write the function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> minmax_normalizer(tablename_source <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, field_name <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> pgst_object REFCURSOR; maxval float; minval float; C RECORD; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'select min("'</span></span>||field_name ||<span class="hljs-string"><span class="hljs-string">'") as minval, max("'</span></span>||field_name ||<span class="hljs-string"><span class="hljs-string">'") as maxval from '</span></span>|| tablename_source <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> C; maxval := C.maxval; minval := C.minval; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'UPDATE '</span></span>||tablename_source||<span class="hljs-string"><span class="hljs-string">' SET "'</span></span>||field_name||<span class="hljs-string"><span class="hljs-string">'"=("'</span></span>||field_name||<span class="hljs-string"><span class="hljs-string">'"-$1)/($2-$1)'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> minval, maxval; RETURN 0; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ LANGUAGE plpgsql VOLATILE COST 100;</code> </pre><br>  And apply it to the table fields that need to be normalized: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'pclass'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'sibsp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'parch'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'fare'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'cabin_cnt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ticket_number'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> minmax_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_full_2'</span></span>, <span class="hljs-string"><span class="hljs-string">'cabin_people_cnt'</span></span>);</code> </pre><br>  As a result, we obtain a table with only numerical values ‚Äã‚Äãin the range from zero to one. <br>  Choose a test and training sample: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> titanik_test_final <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_full_2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> survived <span class="hljs-keyword"><span class="hljs-keyword">isnull</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> titanik_test_final <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> survived;</code> </pre><br>  for the test sample and accordingly: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> titanik_train_final <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> titanik_full_2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> survived <span class="hljs-keyword"><span class="hljs-keyword">notnull</span></span>;</code> </pre><br>  for training. <br>  This table has empty values.  They can be replaced, for example with an average value.  To do this, also use the function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> null_normalizer(tablename_source <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> pgst_object REFCURSOR; fieldval character varying; count_null integer; field_avg float; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> pgst_object <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'select column_name from information_schema.columns where'</span></span>|| <span class="hljs-string"><span class="hljs-string">' table_name='''</span></span>||tablename_source||<span class="hljs-string"><span class="hljs-string">''''</span></span>; LOOP FETCH pgst_object INTO fieldval; EXIT WHEN NOT FOUND; count_null := 0; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'select count(id) from '</span></span>||tablename_source||<span class="hljs-string"><span class="hljs-string">' where "'</span></span>||fieldval||<span class="hljs-string"><span class="hljs-string">'" isnull'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> count_null; IF count_null &gt; 0 THEN raise notice 'field: %', fieldval; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'select avg('</span></span>||fieldval||<span class="hljs-string"><span class="hljs-string">') from '</span></span>||tablename_source <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> field_avg; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'UPDATE '</span></span>||tablename_source||<span class="hljs-string"><span class="hljs-string">' set '</span></span>||fieldval||<span class="hljs-string"><span class="hljs-string">'= $1 where '</span></span>||fieldval||<span class="hljs-string"><span class="hljs-string">' isnull'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> field_avg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN 0; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ LANGUAGE plpgsql VOLATILE COST 100;</code> </pre><br>  The function works as follows: Select all field names for the table, count the number of non-zero elements in the field, and if the number is greater than zero, start the search for the average value and update the empty values ‚Äã‚Äãto the average. <br>  The function is called this way: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> null_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_test_final'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> null_normalizer(<span class="hljs-string"><span class="hljs-string">'titanik_train_final'</span></span>);</code> </pre><br>  The resulting table was quite large and sparse: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> titanik_test_final ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, pclass <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, age <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, sibsp <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, parch <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, fare <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, cabin_cnt <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, ticket_number <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, cabin_people_cnt <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeF"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeB"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeG"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeT"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeD"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeE"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"cabin_typeA"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSW/PP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typePC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeAQ/3."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC/A.3"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.OC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.O./PP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC/AH"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSOTON/O2"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeC.A."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeW/C"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.C./A.4."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeFa"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeLP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSCO/W"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeF.C."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeA.5."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC/AH Basle"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC/A4"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.C./PARIS"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.OP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeLINE"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSO/C"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeP/PP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeAQ/4"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeW.EP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSOTON/OQ"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeA/4"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeSC/PARIS"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeA. 2."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeF.CC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeS.P."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typePP"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"ticket_typeC.A./SOTON"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"embarkedC"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"embarkedQ"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-string"><span class="hljs-string">"embarkedS"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, sexfemale <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, sexmale <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> )</code> </pre><br>  To output to text files use the script: <br><pre> <code class="sql hljs">COPY titanik_train_final to '/tmp/titanik_train_final.csv'; COPY titanik_test_final to '/tmp/titanik_test_final.csv';</code> </pre><br>  Actually, the data is ready.  Now we can try to find patterns. <br>  To reduce the size of the now sparse table, you can use an autoencoder, or linear PCA.  Continued in the next part.  It is planned to apply the auto-encoder and the decisive forest and look at the result that will turn out in the standings. <br><br>  <b>UPD: <a href="http://habrahabr.ru/post/173819">Part Four</a></b> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/165283/">https://habr.com/ru/post/165283/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165269/index.html">Mouse Wheel Speed ‚Äã‚ÄãCounter</a></li>
<li><a href="../165273/index.html">Seven years of WPF: what has changed?</a></li>
<li><a href="../165275/index.html">The key difference between AngularJS and Knockout</a></li>
<li><a href="../165277/index.html">Latest news from KickStarter: the best of 2012 (in the form of infographics)</a></li>
<li><a href="../165279/index.html">A bit about creating demos, part 1</a></li>
<li><a href="../165285/index.html">How we ported the Silverlight application to Windows 8</a></li>
<li><a href="../165289/index.html">The course of the young soldier "Sell services web designer." Part 2 "The client is always wrong"</a></li>
<li><a href="../165293/index.html">VM Depot launched - a repository of virtual machine images on Linux for the Windows Azure community</a></li>
<li><a href="../165295/index.html">Catalana numbers</a></li>
<li><a href="../165297/index.html">Writing a bot for the game of Balls 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>