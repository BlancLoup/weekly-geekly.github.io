<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Neuroculture part 2: about the bot that posts photos</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The simplest working solution for reporting real-time events in a chicken coop. And a little more chatter about why you need to take on tasks and lear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Neuroculture part 2: about the bot that posts photos</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d7c/50c/495/d7c50c495247c4658f84c8359a7b396b.png" alt="image"><br><br>  The simplest working solution for reporting real-time events in a chicken coop.  And a little more chatter about why you need to take on tasks and learning new things, even if you do not have enough knowledge. <br><br>  <b>Articles about neurocooler</b> <br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><ol><li>  <b><a href="https://habrahabr.ru/post/328138/">Intro</a> to learning about neural networks</b> </li><li>  <b><a href="https://habrahabr.ru/post/327978/">Iron, software and config</a> for monitoring chickens</b> </li><li>  <a href="https://habrahabr.ru/post/328940/"><b>A bot</b></a> that posts events from the life of chickens - without a neural network </li><li>  Dataset markup </li><li>  A working <a href="https://habrahabr.ru/post/330738/"><b>model</b></a> for the recognition of chickens in the hen house </li><li>  The result - a working bot that recognizes chickens in the hen house </li></ol><br></div></div><a name="habracut"></a><br><cut>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Mom, messenger, bot, chickens </h3><br><p>  First, a little about the Python script from the previous <a href="http://spark-in.me/post/neuro-chicken-coop">article</a> .  The script has undergone changes, for example, we abandoned the contours completely, corrected some bugs related to the movement counter, which was ignored, and related to the time of the aplode.  But all these things are simple and easily corrected if desired. </p><br><p>  Earlier, I mentioned how I run this script.  I did it with the help of perpetual ssh-sessions, but here‚Äôs the problem: I need to leave and take a laptop with me, for this time I can‚Äôt support an ssh-session.  The obvious solution is to make the demon in the background, where it will work independently. </p><br><p>  It turned out that simply sending the process to the background is not enough, when the session dies, the process also dies.  In order to make a full-fledged daemon, the process must be untied from the terminal-player.  There are several ways to do this, and <a href="https://superuser.com/questions/178587/how-do-i-detach-a-process-from-terminal-entirely">here</a> is a selection of methods and additional information. </p><br><p>  The second problem was the virtual environment.  I needed a python from a virtual environment to run the script.  The solution turned out to be incredibly simple; it is enough just to set the path to the virtual environment when calling.  As a result, to turn my process into a daemon, it was enough to run it like this: </p><br><pre><code class="bash hljs">/home/sshuser/.virtualenvs/cv/bin/python3 /home/sshuser/chickencoop/pi_surveillance_mod2.py --conf /home/sshuser/chickencoop/conf.json &lt;/dev/null &amp;&gt;/dev/null &amp;</code> </pre> <br><p>  Now, about the <a href="https://t.me/snakers4/915">bot</a> that spam my mom with photos of hens from a chicken coop in real time.  There are no analytics and recognitions there yet, and the bot will just post photos on motion detection.  And there is still a crookedly hanging camera, and solid tails are observed instead of chicken heads. </p><br><p>  Bot inconspicuous and simple.  Upon the file creation event on the server, its extension and home directory are checked, and if successful, the Python script is called, which makes a request to the messenger API (upload a photo to the channel) and writes logs to a plain text file (you can parse the response and add it to the database, but no need). </p><br><p>  To make such a bot in Telegram, you need: </p><br><ol><li>  Create your channel </li><li>  Create a bot in telegrams using BotFather (this is also a bot in the telegraph), you will need a bot token in order to post messages and photos. </li><li>  Make a bot script and demonize it. </li></ol><br><p>  With the first two points everything is simple, the third is also simple to boring given the fact that the telegram has a well-documented API and you need only one method. </p><br><p>  To track the file creation event, I use a bash script, the event listens to inotify-tools.  The send script is not called immediately, but after a 10-second wait.  This is done because the file is loaded for some time after creation, and given the excellent speed of the Internet in the chicken coop, it has been empirically established that 10 seconds is the most. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh DIR="/your/directory" inotifywait -m -r -e create --format '%w%f' "$DIR" | while read f do PARDIR="$(dirname $f)" PARFOLD="$(basename $PARDIR)" FBASENAME="$(basename $f)" FILEEXT="${FBASENAME##*.}" EXT="jpg" FOLD="resized" if [ $FILEEXT = $EXT ]; then if [ $PARFOLD = $FOLD ]; then # sleep til file is uploaded sleep 10 python3 /your/directory/bot_request.py --params /your/directory/params_public.json -f $f fi fi done</span></span></code> </pre> <br><p>  bot_request.py: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings <span class="hljs-comment"><span class="hljs-comment"># construct the argument parser and parse the arguments ap = argparse.ArgumentParser() ap.add_argument("-p", "--params", required=True, help="params json. chat, token") ap.add_argument("-f", "--file", required=True, help="file path") args = vars(ap.parse_args()) # filter warnings, load the configuration and check if we are going to use server warnings.filterwarnings("ignore") params = json.load(open(args["params"])) # set url and post data payload = {"chat_id": params["chat"], "caption": "motion detected {ts}".format(ts=datetime.datetime.now().strftime("%A-%d-%B-%Y-%I:%M:%S%p"))} url = "https://api.telegram.org/bot" + params["token"] + "/sendPhoto" files = {'photo': open(args["file"], "rb")} # post request request = requests.post(url, files=files, data=payload) # log the output with open("/path/to/your/botlogs/{dt}-{chat}.txt".format(dt=datetime.datetime.now().strftime("%d-%B-%Y"), chat=params["type"]), "a") as logfile: logfile.write("\n" + request.text)</span></span></code> </pre> <br><p>  params_public.json: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"chat"</span></span>: <span class="hljs-string"><span class="hljs-string">"@your_chat"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token"</span></span>: <span class="hljs-string"><span class="hljs-string">"your_tocken"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"public"</span></span> }</code> </pre> <br><p>  That is, in fact, everything, the most simple and working solution is ready. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/032/172/6fe/0321726fe4691d4ed4d9d46da01fe8f4.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Honestly and truthfully: why do I often find myself stupid / stupid</b> <div class="spoiler_text"><p>  A bit of chatter.  Someone thinks nagging - go ahead and do whatever you want.  The main message of this part of the article is that if someone criticizes you, without offering in return at least a direction in which to look for an answer, do not be discouraged.  No, you can make prototypes and solve problems, you can get experience without knowing everything and everyone.  Man cannot know everything.  I do not believe that there are people who are not mistaken, and by whom knowledge descends in the form of revelations from heaven. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/9de/b2d/39c/9deb2d39c8409a9f9af76070b512b6df.jpg" alt="image">  <i>I don‚Äôt know who they are whispering to them there ...</i> <br><p>  I will briefly tell you what I think about this.  It should be added that I am simply sharing my opinion, not imposing on anyone, not urging anyone to take it at face value. </p><br><p>  To begin, perhaps, with the fact that I am not a developer.  Maybe I'll be to them someday, who knows?  Due to the fact that I am not a developer, I mostly use programming languages ‚Äã‚Äãas a tool for prototyping and solving problems for which there is no need to implement a robust system that goes through many iterations of development, support, fouling with any state tracking tool, reports and analytics and etc.  In general, I rarely have to think about architecture.  The simplest example: you need to clean a particular dataset.  It's easier to do it in python, do it once and throw the code in the trash. </p><br><p>  Therefore, when I write code, I always really don't want to put it in public.  Because I know that I did something wrong, not according to the canon.  And, most importantly, I always know that there will be criticism.  There is at least one person who knows how to do it, but he will not propose a solution, will not give any key to understanding, he will simply say something from the category ‚ÄúYou have everything wrong, everything does not work, you are a worthless person (and I D'Artagnan, but I will not say why, and I will not offer anything in return for your sloppy written article, because I do not want). ‚Äù </p><br><p>  From my code, which actually got into a fight, it is possible to select only the stored procedures of the database and the system for sending analytical reports to the company by krone.  It was written in php, and there was some sort of architecture. </p><br><p>  Now, when the proud java of the falcon closed the article, php primates, and I among them, scratched their low sloping forehead (at this moment the article was also closed), I will continue. </p><br><p>  It is necessary to read documentation, articles, books, but this will not help without solving real problems.  And if you solve every problem according to the canon, you will never even make a working prototype.  Seriously.  Never. </p><br><p>  Do not forget that all complex systems began with a simple.  And when they introduced something else, they knew WHY they entered it.  If you are trying to study a system that has already acquired such innovations so that complexity goes off scale, you often don‚Äôt know why it contains certain phenomena, processes, or functionality.  These are black boxes, and at times their study resembles cramming worse than humanitarian subjects.  And all because you do not know why.  You do not see the logic. </p><br><p>  If you are told that it is you who are stupid, you do not understand what's what, you have not understood this elementary region, everything is clear there (seers and prophets, as I call them), do not worry.  You are not a prophet, you can‚Äôt know what people got into the head, who wrote this system, what crutches (a departure from the canons in the name of a working functional) they put in there and why.  If there is also no documentation (adequate documentation, and not three words about the fact that there is such a method at best), as is often the case, then it is impossible to understand anything without going through buckets of slops that the prophets will pour on you in response for each of your questions (instead of useful information).  I do not know why, but for some reason in IT it is a rule with rare exceptions. </p><br><p>  The neurocooler is an example of a system that is born as a prototype and will never become a complete system and a complete product.  This is just a hobby, learning on a real task, which has no monetized application.  It will not scale. </p><br><p>  I do not know Python.  I just use it in this case, recognizing in passing.  Similarly, I can‚Äôt write bash scripts.  But if I take seriously the comments that I don‚Äôt need to write code, I don‚Äôt need to do anything like that, I will never learn anything. </p><br><br></div></div></cut></div><p>Source: <a href="https://habr.com/ru/post/328940/">https://habr.com/ru/post/328940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328928/index.html">In response to the Ukrainian (and not only) prohibitions: the decentralized EmerDNS system against site blocking</a></li>
<li><a href="../328932/index.html">WannaCry vs. Adylkuzz: who is ahead of whom?</a></li>
<li><a href="../328934/index.html">Anonymous business logic data: separation from personal data</a></li>
<li><a href="../328936/index.html">How to simplify writing articles in Habrahabr for 2 clicks?</a></li>
<li><a href="../328938/index.html">GitLab PostgreSQL postmortem</a></li>
<li><a href="../328942/index.html">Ruby on Rails agreement. Part 2</a></li>
<li><a href="../328946/index.html">Kotlin is the official development language for Android. We understand the intricacies of the language on Stepik</a></li>
<li><a href="../328952/index.html">Implementing drag & drop functionality in an iOS application</a></li>
<li><a href="../328954/index.html">Creating a Web API application using. NET Core + MongoDB. NET Driver</a></li>
<li><a href="../328956/index.html">Register for the webinar "From WannaCry to WannaSaveU". Attack visibility and recovery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>