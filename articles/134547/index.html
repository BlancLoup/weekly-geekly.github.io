<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate OpenMP in Visual C ++ 2010</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most popular and cheap means of implementing multi-thread computing in C ++ is OpenMP . 

 The advantages of technology are obvious: simpli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate OpenMP in Visual C ++ 2010</h1><div class="post__text post__text-html js-mediator-article">  One of the most popular and cheap means of implementing multi-thread computing in C ++ is <a href="http://ru.wikipedia.org/wiki/OpenMP">OpenMP</a> . <br><br>  The advantages of technology are obvious: simplicity;  small and easily switchable code changes;  support from the authors of the most popular compilers: <ul><li>  Visual c ++ </li><li>  GCC 4.2 </li><li>  Intel C ++ Compiler </li></ul>  The battle check is successful, and now the parallelized code penetrates into the most secluded corners of the project, beats all performance records, producing smart statistics confirming the success of the release. <br><br>  A couple of years pass, you successfully migrate to Visual Studio 2010, ... and you find yourself sitting in a puddle.  If yesterday the processing of large amounts of data on machines with multi-core processors took place in a matter of seconds, then today the presence of any background application that occupies one or more cores with its own computations practically hangs up the application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why is this happening, and how to deal with it? <br><br><a name="habracut"></a><br>  In the new OpenMP implementation, before you exit the active area to the Idle state, your program will wait for the completion of I / O operations, and wait using the active SpinWait. <br><br>  Those.  if we created N threads using OMP (1 per core), and we suddenly found out that one of the cores is occupied by another application, then 2 or more threads will be executed on one core with a high probability, switching between which will be interleaved with 200-ms pauses . <br><br>  But in the calculation programs, we do not want any additional synchronization! <br>  Intel developers are aware of this, and offer the user to take care of additional restrictions with the help of the kmp_set_blocktime () option.  Unfortunately, their colleagues from Microsoft decided not to confuse users with unnecessary settings. <br><br>  If you rewrite the program for honest threading pool laziness or does not allow religion - I suggest using my experience ... OpenMP downgrade to the original version from Microsoft Visual Studio 2005. Also, the instruction is suitable for Visual Studio 2008 with minimal changes. <br><br>  First, copy to a separate folder vcomp.lib, vcompd.lib from the Visual C ++ 2005 set (you can refer directly to the installed distribution, but this is not so convenient).  Go to the properties of using OpenMP projects, and add our directory to the Additional Library Directories.  Voila - now the project is linked with the ‚Äúcorrect‚Äù, fast-running version of OpenMP. <br><br>  But that is not all.  Replace the inclusion of &lt;omp.h&gt; with the following header file: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;omp.h&gt; #ifndef __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX #define __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX "Microsoft.VC80" #endif #ifndef _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN #define _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "1fc8b3b9a1e18e3b" #endif #ifndef __OMP_CRT_ASSEMBLY_VERSION #define __OMP_CRT_ASSEMBLY_VERSION "8.0.50727.762" #endif #if defined(_DEBUG) #if defined(_M_IX86) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".DebugOpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='x86' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #elif defined(_M_AMD64) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".DebugOpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='amd64' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #elif defined(_M_IA64) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".DebugOpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='ia64' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #endif #else // _DEBUG #if defined(_M_IX86) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".OpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='x86' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #elif defined(_M_AMD64) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".OpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='amd64' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #elif defined(_M_IA64) #pragma comment(linker,"/manifestdependency:\"type='win32' " \ "name='" __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX ".OpenMP' " \ "version='" __OMP_CRT_ASSEMBLY_VERSION "' " \ "processorArchitecture='ia64' " \ "publicKeyToken='" _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN "'\"") #endif #endif // _DEBUG</span></span></span></span></code> </pre> <br><br>  This is necessary for correct loading of the manifest in executable and .dll files.  Do not forget that even if OpenMP is used in loadable .dll files, you must also register the manifest for the executable file! <br><br>  The values ‚Äã‚Äãof __OMP_LIBRARIES_ASSEMBLY_NAME_PREFIX, _OMP_VC_ASSEMBLY_PUBLICKEYTOKEN and __OMP_CRT_ASSEMBLY_VERSION are taken from &lt;crtassem.h&gt; included in the Visual C ++ 2005 shipment. <br><br>  The project is still not going to - now the studio is outraged to the limit by the fact that the symbol __You_must_link_with_Microsoft_OpenMP_library is not defined. <br><br>  Yes, it was a very subtle hint from the compiler. <br><br>  Let's look at the contents of the generated .obj file.  In my opinion, the <a href="">objconv</a> utility in disassembler mode is best suited for this. <br><br>  We find out that we need to define a byte size variable with the specified name.  Unfortunately, in C and C ++ we will not be able to accurately recreate the imported character, so we will have to use MASM32. <br><br>  Add a meaningless variable: <br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">PUBLIC</span></span> __You_must_link_with_Microsoft_OpenMP_library <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> segment __You_must_link_with_Microsoft_OpenMP_library db 1 </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> ends end</span></span></code> </pre><br><br>  compile: <br><pre> <code class="hljs swift">ml /<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> antiomp.asm</code> </pre><br><br>  and we add the antiomp.obj output to the Additional Input of projects using OpenMP. <br><br>  All - we should have a working code.  You can check the OpenMP version in two ways: <br><ol><li>  run the application, pick up a debugger and find the OpenMP library in the list of loaded modules (Debug | Windows | Modules) </li><li>  try to find in the executable files the substring vcomp100.  If everything is done according to the instructions, then this line should not be </li></ol><br><br>  Have a nice parallel programming! <br><br></div><p>Source: <a href="https://habr.com/ru/post/134547/">https://habr.com/ru/post/134547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134542/index.html">Return Pidgin and Skype to the top GNOME Shell panel</a></li>
<li><a href="../134543/index.html">Order Delivery: How to Work with Amazon Fulfillment Network</a></li>
<li><a href="../134544/index.html">PyCharm 2.0 release</a></li>
<li><a href="../134545/index.html">Uploaded additional builds Android-x86 4.0 for x86</a></li>
<li><a href="../134546/index.html">Spring Framework 3.1 GA released</a></li>
<li><a href="../134548/index.html">Droider Chart. Issue 82, public</a></li>
<li><a href="../134549/index.html">Sketch - 100 seconds about the history of the smartphone</a></li>
<li><a href="../134551/index.html">Creating a 1k / 4k intro for Linux, part 1</a></li>
<li><a href="../134552/index.html">What would YouTube, Facebook and Google+ look like in 1997</a></li>
<li><a href="../134554/index.html">Humble Indie Bundle # 4 has started - pay what you want for 5 great indie games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>