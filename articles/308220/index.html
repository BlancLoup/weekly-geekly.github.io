<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>2D magic in detail. Part Four. Water</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- I've been drinking water for the project. 
 - Oh, cool! Why is it flat? Give waves! 
 ... 
 - Listen, you then talked about the waves, remember? Che...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>2D magic in detail. Part Four. Water</h1><div class="post__text post__text-html js-mediator-article"><iframe width="560" height="315" src="https://www.youtube.com/embed/12ibOr3G2Sg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><blockquote>  - I've been drinking water for the project. <br>  - Oh, cool!  Why is it flat?  Give waves! <br>  ... <br>  - Listen, you then talked about the waves, remember?  Check it out! <br>  - Yes, good waves, but you have not done the refraction and caustic yet? <br>  ... <br>  - Hi, I was playing with Unity here all night, see what reflections and caustics are coded! <br>  - Darova, and really good!  And when your water is boiling, reflections are not buggy? <br>  ... <br>  - Hai, finally realized a boil, like nothing? <br>  - Oh, just right!  Listen, count how cool if you freeze a boiling wave? <br>  ... <br>  - Catch the picture, the ice seems to come up with nothing? <br>  - Norm, listen, and your ice freezes, does it increase in volume?  And by the way, when will you start to do game play? <br>  <em>Variations on the log with a friend.</em> </blockquote><p>  Yes, you already understood, finally I will tell you about the implementation of water in the project.  Let's start? </p><a name="habracut"></a><br><h2 id="img-srchttpshabrastorageorgfiles72ebdae8c72ebdae8c77d4805b8f4a43a4eed84b8png-predyduschie-stati"><img src="https://habrastorage.org/files/72e/bda/e8c/72ebdae8c77d4805b8f4a43a4eed84b8.png">  Previous articles </h2><br><p>  <a href="https://habrahabr.ru/post/305252">Part one.</a>  <a href="https://habrahabr.ru/post/305252">Shine.</a> <br>  <a href="https://habrahabr.ru/post/312046">Part two.</a>  <a href="https://habrahabr.ru/post/312046">Structure.</a> <br>  <a href="https://habrahabr.ru/post/313776">Part Three</a>  <a href="https://habrahabr.ru/post/313776">Global coverage.</a> <br>  <b>Part Four.</b>  <b>Water</b> </p><br><h2 id="img-srchttpshabrastorageorgfiles72ebdae8c72ebdae8c77d4805b8f4a43a4eed84b8png--oglavlenie"><img src="https://habrastorage.org/files/72e/bda/e8c/72ebdae8c77d4805b8f4a43a4eed84b8.png">  Table of contents </h2><br><ol><li>  3D peeping </li><li>  Wishlist </li><li>  First damn lump </li><li>  Statics </li><li>  Water generation </li><li>  Dynamics </li><li>  Temperature </li><li>  Conclusion and intrigue </li></ol><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png-podglyadyvanie-za-3d"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  3D peeping </h2><br><p>  To begin with, let's see how the "adult guys" make water from all sorts of large 3D projects. <br>  In general, dragging ideas from 3D is a great plan, in 2D cool algorithms are noticeably less. </p><br><p>  So, from the simplest to the more complex: </p><br><ul><li><p>  <strong>Flat water without physics.</strong>  They threw a polygon to the level and rejoice.  Because fps does not sag and looks good (the artists tried and collected a beautiful shader).  You can not interact, you say?  So we have a racing game, water is visible only on the horizon! </p><br></li><li><p>  <strong>Polygonal water without physics.</strong>  Planned a map with bad weather, and the water is flat, like a mirror?  Add polygons, recall the sines and now, storm waves are piling up on the horizon.  If you do not accidentally drive into the water, it is not even noticeable that the water is not real. </p><br></li><li><p>  <strong>Flat water with physics.</strong>  With the races finished, do Skyrim.  Flat water with beautiful effects, several checks in the physics engine and on the water you can swim.  No storms and waves to you, but to whom are they needed in rpg, when dragons are flying across the sky, and fus-ro knocks passers-by down? </p><br></li><li><p>  <strong>Polygonal water with physics.</strong>  Tied up with fantasy and started doing GTA.  And there are already realistic waves, and even with the physics of water transport (as in <a href="https://habrahabr.ru/post/307362/">this excellent article</a> ).  Good water, can you still complicate it? </p><br></li><li>  <strong>Particle system</strong>  Even as you can!  If you're the guys from Dark Energy Digital, and once made Hydrophobia with "honest" water that can flow, splash and flood.  And if you have a powerful video card (or two) and a processor that can calculate all this. </li></ul><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--hotelki"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  Wishlist </h2><br><p>  Now, when we have references from large projects, we dream what we would like to implement in our project. </p><br><blockquote>  Remember the joking entry at the beginning of the article?  This is not at all a joke - every time I threw screenshots or videos from another demo to a friend, he suggested some completely insane ideas.  And this is great, because most of these ideas were implemented, making the project even more interesting from the point of view of development.  Therefore, the list below was compiled iteratively, without the mailstone and plan. </blockquote><p>  Here is the list of women: </p><br><ol><li>  The ability to add new volumes of water in realtime or "evaporate" existing ones. </li><li>  Waves on the surface of the water. </li><li>  Temperature, the possibility of freezing and boiling water. </li><li>  Interaction with other modules: wind, physical bodies, weather. </li><li>  Close interaction with the lighting system: caustic, light scattering, reflection. </li><li>  Ability to customize the editor. </li></ol><br><blockquote>  And about interactions with modules - the topic is almost endless.  See for yourself - in the article about the light, I told you that the project has the ability to turn on god rays - rays of light visible due to dust in the air.  And now, when I completed the boiling water, nothing prevents to generate steam particles, above which these god rays will be visible!  But the wind can interact with the particles, which means that the vapor above the hot water will dissipate nicely.  And there are so many such interactions that you do not have time to write down, let alone prototype. </blockquote><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--pervyy-blin-komom"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  First damn lump </h2><br><p>  We will not go through the team that made Hydrophobia to "honestly" model a liquid - this method is too demanding of resources.  Need to simplify.  If pixelart is in the project, all planes are either horizontal or vertical.  And empty space at the level is represented as a set of rectangles.  We will work with them. <br>  In preprocessing at the beginning of the level: </p><br><ol><li>  We divide all empty space at the level into rectangular non-intersecting volumes. </li><li>  We find the relationship of the volumes with each other and build a graph of "flows" of water. </li></ol><br><p>  In real time: </p><br><ol><li>  For each volume, we separately calculate the waves on the surface (ignoring the fact that with the help of waves, water can flow from volume to volume). </li><li>  Calculate the flow of water using the graph. </li></ol><br><img src="https://habrastorage.org/files/3e1/744/e07/3e1744e0771944609df8c9c3cf61bf7d.png"><br><p>  <em>Water volume graph</em> </p><br><p>  But to tell you the truth, nothing happened.  Pitfalls so much that you can build a couple of five-story building.  For example: you need to synchronize waves, deal with pressure in communicating vessels, etc.  But every cloud has a silver lining - the implementation of the region tree, which is used throughout the project, was once written to implement this method. </p><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--statika"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  Statics </h2><br><p>  Since the dynamic water did not work out at all, let's simplify our life for ourselves - we will adjust the water in the editor, and leave the waves in for the illusion of dynamics.  In fact, we turn to option number 3 from the list of options. </p><br><p>  Water is a very controversial thing, because it can flow: you can‚Äôt say "there will be water at these points," place meshes for the liquid and get a good picture.  Well, okay, let the level designers (we will in the future) place some key points where the water should be exactly, and the engine will pour it out of its reserves, and exactly to the level of key points.  Of course, you can put one ‚Äúanchor‚Äù under another, but this is not a problem of the engine, but of those designers who are unknown to us: our code will accurately fill the level to the highest key point with water. </p><br><p> Another feature is the individual anchors for creating bubbles.  If the algorithm finds such an anchor, it will try not to fill it with water, leaving a neat cavern with air. </p><br><p>  Now that we have an understanding of what results we will get, it's time to develop an algorithm, is it not? </p><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--generaciya-vody"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  Water generation </h2><br><p>  In general, water can fill the entire level.  Since the walls are made up of rectangular pieces and can be located anywhere, the water volume is a non-convex rectangular polygon with holes.  What a muck.  Let's break into simpler shapes. </p><br><blockquote>  A small spoiler to make it clearer.  As a result of preprocessing, we must get some water volumes, in which we simply count the waves.  In fact, one water volume is a set of water columns with a thickness of one pixel. </blockquote><p>  Let's deal with the empty space in which there can be a liquid.  Great region tree, about which I told in past articles, will help a lot.  Using it, we will get all rectangular volumes not occupied by walls: </p><br><ol><li>  Starting from the bottom (initially left) corner of the tree, we are looking for the first empty area above. </li><li>  Starting with the found empty region, we are looking for the first non-empty region above. </li><li>  Add the resulting segment to the list. </li><li>  If you have reached the top (in a geometrical sense) of the tree border, move 1 pixel to the right. </li><li>  If you have not reached the right boundary of the tree, go to pt.1. </li><li>  We collect rectangles from the list of segments (and they are rather well sorted). </li><li>  We build connections between adjacent rectangles. </li></ol><br><img src="https://habrastorage.org/files/a0b/ea1/b4d/a0bea1b4dd2e456dbd8203689c3c27eb.gif"><br><p>  <em>Instead of a thousand words</em> </p><br><blockquote>  Most likely, you can get these rectangles in a much more beautiful way.  I would be glad to comment on this topic. </blockquote><p>  In fact, rectangles are not the best choice.  Due to the large number of parts (for example, the teeth on the towers), rectangular water volumes will be very large.  This will reduce productivity.  Calm water is flat, and the shape of the bottom is not important to us, therefore we combine adjacent rectangles in this way: </p><br><p><code>   A     (  B),    B -     (  A) -      .</code> </p> <br><p>  After this stage, a small amount of water volumes with a ribbed bottom will remain; this is clearly seen in the figure below. </p><br><img src="https://habrastorage.org/files/cb6/36f/a3c/cb636fa3c7ac479a8a3fb9bbb00fc58f.png"><br><p>  <em>Marking white space on the map (with links)</em> </p><br><p>  Now you need to find all the marks left on the map by the designers and "trim" our blanks according to their level.  An algorithm like this will cope with this: </p><br><ol><li>  We collect all the labels of the water level ( <img src="https://habrastorage.org/files/3a2/1eb/ec0/3a21ebec05fa44a7925d2a9074a07ccf.png">  ), sort them by y-coordinate in descending order. </li><li>  For each tag: <br>  2.1.  Find the rectangle that owns the label. <br>  2.2.  If the rectangle is not found, the label is in the wall, ignore it and go to Fri.  2 <br>  2.2.  Reduce the height of the rectangle to the level of the label. <br>  2.3.  If the height of the rectangle has become equal to zero - delete the rectangle. <br>  2.4.  Find all adjacent rectangles, the bottom edge of which is higher than the mark and delete them. <br>  2.5.  Find all the other adjacent rectangles, go to Fri.  2.3 (recursively cut all rectangles by water level). </li><li>  Collect all marks of air bubbles ( <img src="https://habrastorage.org/files/cce/12a/0ae/cce12a0ae9bd4f0f81acb98992414d8b.png">  ), sort them by y-coordinate in descending order. </li><li>  For each tag: <br>  4.1.  Find the rectangle that owns the label. <br>  4.2.  If the rectangle is not found, the label is in the wall, ignore it and go to Fri.  four. <br>  4.2.  Reduce the height of the rectangle to the level of the label. <br>  4.3.  If the height of the rectangle has become equal to zero - delete the rectangle. <br>  4.4.  Find all adjacent rectangles, the bottom edge of which is higher than the mark and delete them. <br>  4.5.  Find all the other adjacent rectangles whose top edge is <strong>above the level of the label</strong> , go to <strong>step</strong> 4.3 (recursively cut all the rectangles by the level of the air bubble). </li></ol><br><p>  As you can see, the difference between water marks and air bubbles marks is that the first pass through all neighbors recursively, and the second stop when the neighbor is completely below the bubble level. </p><br><p>  And now in the pictures: </p><br><img src="https://habrastorage.org/files/0d4/d4e/edc/0d4d4eedca3c4d209dae4c82ded83309.png"><br><p>  <em>Added water markers to the map</em> </p><br><img src="https://habrastorage.org/files/be0/db1/d54/be0db1d54125440587a924e35513bc69.png"><br><p>  <em>Same thing but with connections</em> </p><br><img src="https://habrastorage.org/files/9b7/3df/c9c/9b73dfc9c0f243ea893219ad8006a9b8.png"><br><p>  <em>Cut the rectangles on the water level</em> </p><br><img src="https://habrastorage.org/files/132/95a/d1a/13295ad1a3bd498bbf0fd6ac81ff489a.png"><br><p>  <em>Removed unnecessary links and rectangles</em> </p><br><img src="https://habrastorage.org/files/da7/390/403/da7390403db34307b387e38627e69134.png"><br><p>  <em>Debase visualization of water volumes obtained</em> </p><br><div class="spoiler">  <b class="spoiler_title">A small but important note</b> <div class="spoiler_text"><p>  Despite the fact that we cut the rectangles by the level of labels, in each of them we keep an array of initial heights (the y-coordinate of the ceiling above the water).  In the future, these heights will be needed to limit the waves - otherwise the waves will be able to pass through the walls. </p></div></div><br><p>  It's time to see what it looks like in the editor: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/tV1UwKjNKKI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--dinamika"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  Dynamics </h2><br><p>  Since we have abandoned the current water in real time, let's make some beautiful waves.  After the generation of water, we get something like this manager for water: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NewEngine.Core.Water</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WaterManager</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     // ... WaterPolygon[] waters; CombineInstance[] combineInstances = null; Mesh mesh; public void Generate() { if (tree == null) return; waters = WaterGenerator.Generate(tree, waveCeil); Debug.Log("Regenerate water"); } void FixedUpdate() { if (waters == null) return; var viewportRect = cameraManager.ViewRect; WaterPolygon.Update(waters, ref combineInstances, viewportRect, /*   ,      ,    */); mesh.Clear(); mesh.CombineMeshes(combineInstances); } } }</span></span></code> </pre> <br><p>  So far, from all this code, we ( <em>well, or me, as a narrator</em> ) are only interested in <em>WaterPolygon</em> .  These are the very minimal pieces of water for which you can build waves.  And these elements are connected with each other (information about the graph remains available in these landfills).  If you miss the unimportant details, this class looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">Great piece of code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NewEngine.Core.Water</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WaterPolygon</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  "" -       //    (   y, ),   (,  ) class Line { public int min; // y-    public int max; // y-    public int target; // y-   ,     public int height; // y-     (,    MAX_WAVE_HEIGHT,  ) public float speed; float lastDelta; public void Add(float additionalWater); public void Sleep(); public void Update(float tension, float dampening, float foamThreshold, float foamForce, float foamDampening, float airTemperature, float airTranscalency, float verticalTranscalency, float minBoilTemperature, float minBoilBubble, float maxBoilBubble, float boilFrequency); } //   y   Line,    ,         x int x; //   ;      WaterPolygon[] left; WaterPolygon[] right; //   "" Line[] lines; //      bool sleeping; int sleepingFrames; //      AABB int minWaterY; float maxWaterY; //    UnityEngine Mesh mesh; //     ,      ,  :) public static void Update(WaterPolygon[] water, ref CombineInstance[] combineInstances, Geom.IntRect viewportRect, int outsideCameraSleepOffset, float heightSleepThreshold, float speedSleepThreshold, float tension, float dampening, float spread, int steps, float foamThreshold, float foamForce, float foamDampening, float airTemperature, float airTranscalency, float verticalTranscalency, float horisontalTranscalency, float minBoilTemperature, float minBoilBubble, float maxBoilBubble, float boilFrequency, int sleepingUpdateFrames); //  AABB    offset public bool IsOutside(Geom.IntRect viewportRect, int offset); //    - ,        lines void UpdateFirst(Geom.IntRect viewportRect, int outsideCameraSleepOffset, float tension, float dampening, int steps, float foamThreshold, float foamForce, float foamDampening, float airTemperature, float airTranscalency, float verticalTranscalency, float minBoilTemperature, float minBoilBubble, float maxBoilBubble, float boilFrequency, int sleepingUpdateFrames); //    -     ,       (left  right) void UpdateSecond(float heightSleepThreshold, float speedSleepThreshold, float spread, int steps, float foamThreshold, float foamForce, float foamDampening, float horisontalTranscalency, float airTemperature, float minBoilTemperature); //        void Sleep(bool withClear); //      (    ),    void FindLine(bool isRight, out Line line, out WaterPolygon water); //       public void CreateMesh(ref CombineInstance combineInstance); } }</span></span></code> </pre> </div></div><br><blockquote>  I will not talk about the physics of fluid, because I made waves in <a href="https://gamedevelopment.tutsplus.com/tutorials/make-a-splash-with-dynamic-2d-water-effects--gamedev-236">one good tutorial</a> .  If in a nutshell: we represent water in the form of connected springs, where the spring is known for the current height, speed and optimum height.  The springs oscillate and transmit vibrations to neighbors.  The width of the spring in the project - one pixel. </blockquote><p>  But there is one important addition.  In the tutorial there is only one "water testing ground" while we have a whole graph of them.  And you need to synchronize the waves correctly.  The example is clearer: </p><br><img src="https://habrastorage.org/files/f69/2ad/b06/f692adb06370403eac015034a0c8311e.png"><br><p>  <em>Let's say we have this level</em> </p><br><img src="https://habrastorage.org/files/efe/84d/4d9/efe84d4d9e8e41f5ba526791746a18fb.png"><br><p>  <em>It will consist of three water ranges.</em> </p><br><img src="https://habrastorage.org/files/ead/945/26d/ead94526df204b9fb4fa09c469e348fd.png"><br><p>  <em>At some point, a wave appears in the blue polygon.</em> </p><br><img src="https://habrastorage.org/files/e88/739/885/e887398852eb4d58a84e34a340a6467f.png"><br><p>  <em>The algorithm finds a suitable neighbor based on the height of the left column and synchronizes the wave.</em> </p><br><img src="https://habrastorage.org/files/503/242/32f/50324232fe9648088895ed1d09fecc0d.png"><br><p>  <em>For very large waves, the algorithm will choose another neighbor.</em> </p><br><p>  Minute optimizations.  It makes no sense to count the waves for: </p><br><ol><li>  Polygons off-screen. </li><li>  Polygons with no waves. </li></ol><br><p>  At the next calculation of the waves, a check is made - whether all the waves were less than the threshold value, and if yes - bed time!  If the polygon is entirely outside the screen, the threshold value is slightly higher.  Accordingly, a connected test site or the influence of other modules (physics, wind, etc.) can wake up water. </p><br><p>  So far, water has no reason to hesitate.  Nothing can disturb her peace, nor the battles of battle mages, nor a banal hurricane.  Cold as the heart of Morra.  Time to melt the ice. </p><br><h2 id="img-srchttpshabrastorageorgfilesa69c76c4aa69c76c4a66744b3943e200c1cccd740png--temperatura"><img src="https://habrastorage.org/files/a69/c76/c4a/a69c76c4a66744b3943e200c1cccd740.png">  Temperature </h2><br><p>  Despite the somewhat manic elaboration of useless little things, I don‚Äôt really want to spend another six months on realistic thermodynamics.  So simplify utterly.  And a little bit more. </p><br><p>  Let's start with the weather manager.  Someday there will be both storms and calmness, but for now, only this: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NewEngine.Core.Weather</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WeatherManager</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { [SerializeField, Range(<span class="hljs-number"><span class="hljs-number">-100</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> airTemperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> AirTemperature { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> airTemperature; } } } }</code> </pre> <br><p>  The concept is: </p><br><ol><li>  The temperature of the water is initially equal to the air temperature. </li><li>  At temperatures below 0 ¬∞ C water freezes. </li><li>  At a temperature of 100 ¬∞ C water boils. </li><li>  Water volumes exchange temperature with each other. </li><li>  Water volumes exchange temperature with the atmosphere, taking into account the volume (in a geometric sense) of the atmosphere. </li><li>  Optimization and deoptimization: <br>  6.1 Boiling water never sleeps. <br>  6.2.  When the water is "awakened", a simplified calculation of changes in the temperature of the liquid during sleep occurs. </li></ol><br><p>  The temperature for <em>WaterPoligon.Line</em> will be stored only for the upper and lower ends of the water column. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Line</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> min; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> max; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> minTemperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> maxTemperature; ... }</code> </pre> <br><p>  Extremely inaccurate way - after all, all the pillars have different heights, but we will do. </p><br><blockquote>  At first there was the idea of ‚Äã‚Äãbreaking the pillars into a certain number of pieces and counting the transfer of heat between these pieces (both in one column and between neighboring ones).  In this case, one could make ‚Äúlayered water‚Äù - ice / water / ice, which is impossible in the current implementation. </blockquote><p>  The transfer of temperature is carried out in three different "directions".  The first and most obvious - between the edges of the water column: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { ... <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> avgTemperature = (maxTemperature + minTemperature) * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ratioTranscalency = verticalTranscalency / length; maxTemperature = maxTemperature + (avgTemperature - maxTemperature) * ratioTranscalency; minTemperature = minTemperature + (avgTemperature - minTemperature) * ratioTranscalency; }</code> </pre> <br><p>  The second is more interesting.  Heat transfer between the air and the top edge of the pillar.  When generating water, we received the <em>height</em> , in fact, the coordinate of the ceiling.  So, at any time we can get the height of the air gap above the water.  The more air above the water, the faster the heat exchange takes place.  Controversial statement.  But in the open air the water will cool / warm up faster than in low caves: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> length = height - min; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (height &lt; max) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> airVolume = Mathf.Min(max - height, MAX_AIR_VOLUME); maxTemperature = maxTemperature + (airTemperature - maxTemperature) * Mathf.Clamp01(airTranscalency * airVolume); } ... }</code> </pre> <br><p>  There remains a heat exchange between adjacent columns.  Since temperature information is stored only at the edges of the pillars, linear interpolation enters the scene. </p><br><img src="https://habrastorage.org/files/14f/ac5/3f7/14fac53f710a4aa4a2703b03582c9e14.png"><br><p>  <em>For lovers of pictures</em> </p><br><div class="spoiler">  <b class="spoiler_title">For lovers of code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateTemperatureDelta</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> horisontalTranscalency, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] minTemperatureDelta, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] maxTemperatureDelta, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, Line line, Line other</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (line.height &lt;= line.min || other.height &lt;= other.min) { minTemperatureDelta[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; maxTemperatureDelta[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> height = line.height - line.min; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> otherHeight = other.height - other.min; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mathf.Max(line.height, other.height) - Mathf.Min(line.min, other.min) &gt;= height + otherHeight) { minTemperatureDelta[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; maxTemperatureDelta[i] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> minY = Mathf.Max(line.min, other.min); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> maxY = Mathf.Min(line.height, other.height); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> minT = (minY - line.min) / height; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> maxT = (maxY - line.min) / height; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> otherMinT = (minY - other.min) / otherHeight; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> otherMaxT = (maxY - other.min) / otherHeight; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> minTemperature = Mathf.Lerp(line.minTemperature, line.maxTemperature, minT); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> maxTemperature = Mathf.Lerp(line.minTemperature, line.maxTemperature, maxT); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> otherMinTemperature = Mathf.Lerp(other.minTemperature, other.maxTemperature, otherMinT); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> otherMaxTemperature = Mathf.Lerp(other.minTemperature, other.maxTemperature, otherMaxT); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ratio = horisontalTranscalency * Mathf.Clamp01(height / otherHeight); minTemperatureDelta[i] = ratio * (minTemperature - otherMinTemperature); maxTemperatureDelta[i] = ratio * (maxTemperature - otherMaxTemperature); }</code> </pre> </div></div><br><p>  The temperature exchange is similar in structure to wave exchange, but the wave is transmitted only to one adjacent <em>WaterPolygon</em> 'on each side, and the heat to each of its neighbors. </p><br><p>  And the final touch - boiling and freezing of water.  If the temperature is higher than or equal to 100 ¬∞ C, we add a random spring velocity to the liquid column, and the higher the temperature, the greater the velocity spread (in fact, not exactly 100 ¬∞ C, water begins to bubble a little earlier). </p><br><p>  Well, if the temperature is below or equal to 0 ¬∞ C - we keep the spring speed equal to zero and stop responding to the transmission of speeds from the adjacent spring columns. </p><br><p>  Or in other words: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (height &lt; max) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxTemperature &gt;= minBoilTemperature) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> depth = target - min; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ratio = Mathf.Clamp01((maxTemperature - minBoilTemperature) / (<span class="hljs-number"><span class="hljs-number">100</span></span> - minBoilTemperature)); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> heightValue = Mathf.Min(depth * <span class="hljs-number"><span class="hljs-number">2</span></span>, Mathf.Max(minBoilBubble, ratio * maxBoilBubble)); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> frequency = Mathf.Lerp(<span class="hljs-number"><span class="hljs-number">0</span></span>, boilFrequency, ratio * ratio); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Random.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> - frequency) height += Random.Range(-heightValue, heightValue); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxTemperature &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { speed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br><iframe width="560" height="315" src="https://www.youtube.com/embed/poNCBUpkbPc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>Gradual boiling water</em> </p><br><h2 id="img-srchttpshabrastorageorgfiles72ebdae8c72ebdae8c77d4805b8f4a43a4eed84b8png---zaklyuchenie-i-intriga"><img src="https://habrastorage.org/files/72e/bda/e8c/72ebdae8c77d4805b8f4a43a4eed84b8.png">  Conclusion and intrigue </h2><br><p>  After all of the above, the project has water that can be "poured" to the level in the editor.  Exciting, boiling, hardening in the cold, life-giving moisture! </p><br><p>  It would be a shame to get an ugly picture by writing so much code.  Reflections, refractions, caustics - our everything!  So, again, thick shaders, interaction with the lighting system, render texture and all that. </p><br><p>  But about this - in the next article.  :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308220/">https://habr.com/ru/post/308220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308208/index.html">Container Management with LXD</a></li>
<li><a href="../308212/index.html">At the request of readers, check the LDAP server code ReOpenLDAP</a></li>
<li><a href="../308214/index.html">Faster fast or deep optimization Median filtering for Nvidia GPUs</a></li>
<li><a href="../308216/index.html">1C, Linux, Excel, Word, OpenXML, ADO and Net Core</a></li>
<li><a href="../308218/index.html">You dissect the corpse using SOLID</a></li>
<li><a href="../308224/index.html">HPE Synergy Pro Part I - Intro</a></li>
<li><a href="../308226/index.html">Who are you, Professor Malan?</a></li>
<li><a href="../308228/index.html">How Clojure helps speed up the writing of Selenium tests</a></li>
<li><a href="../308232/index.html">How it works and what the ‚Äúdeep‚Äù integration of ‚ÄúBitrix24‚Äù and the UniSender email newsletter service can do</a></li>
<li><a href="../308234/index.html">What is lead</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>