<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>16 Tons. How I saved a dying WordPress site with very superficial knowledge of this CMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will be short and messy - I am writing it with the purpose of passing a couple of hours before starting to roll back the site to the previ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>16 Tons. How I saved a dying WordPress site with very superficial knowledge of this CMS</h1><div class="post__text post__text-html js-mediator-article">  The article will be short and messy - I am writing it with the purpose of passing a couple of hours before starting to roll back the site to the previous ‚Äúnormal‚Äù state. <br><br>  This story began five hours ago.  I was approached by the owner of one thematic news site.  Subject - sporting events.  The site has two problems.  First, at the moments of large and highly anticipated contests, the number of visitors to the site increases by an order of magnitude.  The second problem - it is made on WordPress, and rather casually.  I think that initially it was a normal WP-site.  But then he repeatedly ‚Äúworked out‚Äù: wherever different ad units stuck, they entered new ‚Äúsolutions‚Äù, put all sorts of plugins for ‚Äúoptimization‚Äù and expansion of opportunities.  In addition, every day, for several years, about a dozen posts appeared.  The database size is several gigabytes, the 'upload' goes to tens of gigabytes.  Over time, the site turned into something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/680/d7b/d62/680d7bd62a2b52fba127670a0e8eda5b.jpg" alt="image"><br><a name="habracut"></a><br>  And here, somewhere in 0.00 in Moscow, the site begins to fall under the influx of sports enthusiasts.  The main page then gives the code 500, then it loads for more than a minute.  I suspect that the periods of such ‚Äúraids‚Äù of visitors are the most bread time for such resources: clicks, bets and all that.  The owner is nervous, which, in general, is understandable.  And so it turns out that of those who are awake this Saturday night and understand something in web development, the owner has only me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And then the next problem.  I, to put it mildly, do not really like WordPress.  And, worst of all, I don‚Äôt know much about it.  Perhaps, therefore, I do not like, because I do not know how to cook it correctly.  But the fact remains that up to this point I have never dealt with any major projects that are based on it.  Of course, I met with personal blogs and websites of small offices on WP, where several hundred visitors a day are a blessing.  There he coped well, no problem.  But there were no special reasons to find out how it works with resources and how to ensure its normal performance was not there.  Works and works. <br><br>  But in this situation, you need to solve the problem of its performance.  And very quickly.  There is no time for reading manuals, there is no special knowledge and skills either.  What to do?  Then I start to get nervous - the mood of the site owner is transmitted. <br><br>  Of course, the first thought is to follow the path of least resistance.  Those.  just switch to the older, more ‚Äúpowerful‚Äù fare.  The site is hosted on VDS.  And here it turns out that this method will not work: the transition to large resources - <b>only on request</b> in those.  hosting support.  Deadline - from a few hours.  Hoster explains this with KVM virtualization.  Ok, this option is not suitable.  Simultaneous calls in support and reading the site host takes about five minutes. <br><br>  The next version that goes through my head: ‚ÄúWordPress is famous for its plugins.  I even remember the names of two plugins for caching: WP Super Cache and WP Fastest Cache. ‚Äù  As I learn later, both are included in all sorts of lists like "Top 10 caching plugins for WP", etc.  I suspect that installing plugins on a constantly falling site is a very unpleasant task.  Therefore, the site for about five minutes only works for me.  I quickly put the first plugin, run over the settings - everything seems ok.  I include the site for all visitors.  The result is ... Zero.  Perhaps something has improved, but it is like a dead poultice - improving imperceptibly with the naked eye.  The site stubbornly continues to fall.  Bad choice of plugin?  Even faster, I press the buttons and put the second plugin.  The result ... Yes, the same.  Worn down and this plugin.  All these manipulations take me almost fifteen minutes. <br><br>  I suspect these plugins work fine.  They have thousands and thousands of users and most of them are obviously happy.  But my patient does not respond to them.  Perhaps the reason is in its neglected internal state.  In any case, this option is rejected - to understand what and why there does not work once. <br><br>  The owner continues to send nerve letters.  I am already going to answer that, despite all the efforts, it will not be possible to save the patient today and I will go on a date with a pillow.  Unless, of course, it has not yet captured his wife.  And here one more thought comes to mind. <br><br>  Hands begin to search and download a clean distribution of WP, and the head to think.  Before my eyes stands the image of an uncle, who often (and rather mischievously) loved to tell me during my youth: ‚ÄúKnowledge of a few principles often replaces knowledge of many facts.‚Äù  And that's what I thought: <br><br><ol><li>  All requests for the issuance of pages of the site, most likely, pass through some single "entry point", the router.  There it is determined (or begins to be determined) what and in what order will be further connected / reckoned / withdrawn. </li><li>  Then, in fact, everything connects, counts and, unfortunately, is displayed.  It is here, most likely, there is a devouring of resources.  On endless queries to the database and other horrors. </li><li>  The horrors end, and the results at some "exit point" are given to the user. </li></ol><br>  And if this is at least something like this, then you can apply a caching system, which I call the "Ax".  In addition, on this site, all visitors are given the same page in appearance.  Those.  A specific URL corresponds to a page that will look the same for any user.  Well, except for those that are logged in to the admin.  WP panels, but they do not count.  Now it's just me. <br><br>  Now you need to find the above-mentioned point "entry" and "exit".  The ‚Äúlogin‚Äù is found in the /index.php file.  In which it is honestly written: "This file doesn‚Äôt do anything, but loads ...".  Wonderful.  The ‚Äúexit point‚Äù is harder, but I remember that I heard something about the ‚Äúshutdown‚Äù event in WP that runs after everything.  A quick search for a clean distribution I find the ‚Äúshutdown_action_hook‚Äù function in /wp-includes/load.php.  Even faster, by writing an echo inside it, I check where in the page it will output ‚ÄúGoldenAxe!‚Äù.  In the end.  Fine!  The sought points were found, it all took about 10 minutes.  Now you need to somehow implement a very simple logic: <br><br><ol><li>  When you first access the page, it is generated as usual.  After all the output is generated, it will need to be written to a separate file.  It should happen at the "exit point".  The file will need to be written to the / _cache / folder.  The file name will look like this: md5-hash URL of the page (without parameters), which is requested.  Since  this is the only parameter on which the appearance of the displayed page depends, this is quite enough. </li><li>  During the second access to the page at the ‚Äúentry point‚Äù, we will check if the necessary folder in the folder with the cache files is available (with the corresponding requested URL md5-name).  If there is - immediately read from it and display the result. </li></ol><br>  Everything.  Whole system.  It remains only to figure out how to collect the output.  As many know, WP templates are a hell of a mixture of HTML and PHP.  Those.  they always contain constructions like: <br><br><pre><code class="html hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">if</span></span></span><span class="php">($Some==</span><span class="hljs-number"><span class="php"><span class="hljs-number">1</span></span></span><span class="php">) </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">echo</span></span></span><span class="php"> </span><span class="hljs-string"><span class="php"><span class="hljs-string">'&lt;div class="novost"&gt;'</span></span></span><span class="php">; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">else</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">echo</span></span></span><span class="php"> </span><span class="hljs-string"><span class="php"><span class="hljs-string">'&lt;div class="statya"&gt;'</span></span></span><span class="php">; </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  I think it's terrible.  But so it is.  Thus, we do not have some $ Content variable in which the entire content of the page would be collected before output and only then displayed once using the same ‚Äúecho‚Äù.  We have hundreds of these ‚Äúecho‚Äù in the templates.  And they need to somehow collect.  Once upon a time, when I read the manual for PHP, I encountered the function ‚Äúob_get_contents ()‚Äù there.  I never used it, but here it was useful.  It returns the contents of the output buffer and goes to companies with the functions ‚Äúob_start ()‚Äù and ‚Äúob_end_clean ()‚Äù.  The first turns on buffering, the second turns off and clears the buffer.  All this I instantly google.  Five more minutes passed.  As a result, what code I put in the ‚Äúentry point‚Äù and ‚Äúexit point‚Äù: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ¬´ ¬ª: $URL_WO_QS = strtok($_SERVER["REQUEST_URI"], '?'); $CacheFile = $_SERVER["DOCUMENT_ROOT"].'/_cache/'.md5($URL_WO_QS).'.cache'; if(file_exists($CacheFile) &amp;&amp; intval($_REQUEST['test'])!=1){ echo file_get_contents($CacheFile); exit(); } ob_start(); // .... // .... // .... // ¬´ ¬ª: $Result = ob_get_contents(); ob_end_clean(); $URL_WO_QS = strtok($_SERVER["REQUEST_URI"], '?'); $CacheFile = $_SERVER["DOCUMENT_ROOT"].'/_cache/'.md5($URL_WO_QS).'.cache'; file_put_contents($CacheFile, $Result); echo $Result; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Well, then it remained only to check the result.  I deliberately left to myself the opportunity to request a page generated in a standard way (passing the ‚Äútest‚Äù parameter for $ _REQUEST to the ‚Äúentry point‚Äù in the URL).  Having received the page output after caching with ‚ÄúAx‚Äù, I compared it with the ‚Äústandard‚Äù page output.  I found a small difference - one js-script did not get into the cached version.  The one that was responsible for loading additional posts to the list when clicking on the "show more posts" button.  There was no time to figure out why it doesn‚Äôt fall into the output, so I just added the script call to the template.  And it all worked. <br><br>  Of course, the solution has a lot of flaws: if you add through the admin.  panel new post, it will not be displayed in some lists.  In those that are not loaded on this site using AJAX.  For some reason, the count of post views has been incorrectly triggered.  But all this stuff that you can survive a few hours. <br><br>  And plus one, but big: the site has ceased to give the code 500 or wait for a response and the issuance of the page for a half minutes  Now the output itself (page response) takes about 40 ms instead of 1.5 m and all users, without exception, can click on an advertisement.  Of course, full page load takes more time: numerous non-optimized images, advertising scripts and other fonts do their job.  But the eye is invisible.  The site is fast. <br><br>  On all the introduction of my "Ax" took no more than half an hour.  Now I will go to shoot it and return the site to its original state.  Sports competition is over, fans, and with them, and I, go to sleep. <br><br>  Do not judge my decision too harshly.  Remember that I took it under tight time constraints and without serious WordPress knowledge.  Perhaps there was a more elegant and correct solution.  If you know him - write in the comments.  I can say that I felt like a veterinarian who had to operate on a person.  Well, or vice versa.  Good weather, friends! <br><br>  <b>Update</b> .  Reading the comments on the article, I realized that I could not clearly state the reason for its writing and draw the main idea.  As a result, it seems to me, there was some misunderstanding between me and the readers.  My fault.  In my defense I will say that I wrote it already in a very salutary state. <br><br>  This article is not about finding a truly correct solution under general conditions.  It is about finding the optimal solution in the face of severe constraints: by time, by result and by knowledge.  By knowledge, I mean not only my personal knowledge in the field of WP, which, I admit, is very superficial, but also information provided at my disposal.  By ‚Äúinformation‚Äù I mean, for example, various accesses.  I had access to the files of the site itself and to the personal account on the site of the hoster.  It mainly addresses the issues of payment and tariffs.  At the same time I did not have access to the control panel by the server itself.  With all that it implies.  I didn‚Äôt come across this hoster before, so the order and features of its work were also a mystery to me. <br><br>  Undoubtedly, the correct solution to the problem of this site in general looks like this: ‚Äúwe are looking for the causes of poor performance with the help of various tools and techniques.  We prepare a local copy of the site.  For a cup of tea we think about solutions, check them out.  We update the working copy.  We analyze its work and the effectiveness of updates.  If necessary, make edits.  Everything!". <br><br>  In reality, I had an hour of time, a site losing visitors at the most unnecessary moment and a nervous owner.  I did not have time to create a backup and a local copy (and, in fact, the very possibility of this).  From here one more moment - I desperately did not want to hurt and break.  This, as you know, would be a disaster.  Therefore, another security requirement was his safety.  Solutions such as removing already integrated plug-ins, in my opinion, do not meet this criterion.  Even the installation of new ones, in general, did not arouse my delight. <br><br>  Some of the commentators blame my curvature.  Like, I could not put in the right places a tick in the settings of the WordPress plugin.  With a 90% probability, this is not the reason.  As I learned later, by comparing the net distribution of the same version of WP with the fact that there is on the site, even those WP files were corrected, which, as I understand it, are ‚Äúsystem‚Äù.  And they ruled very extensively.  That, in theory, is completely unacceptable.  Thus, the likelihood of full-time work of the system, which we call ‚ÄúWordPress‚Äù, is sharply reduced.  Including the probability that it will regularly interact with caching plugins.  In fact, in this case, we have a ‚Äúblack box‚Äù, some <b>custom</b> project based on WP. <br><br>  My decision is a <b>crutch</b> .  I am fully aware of this, as well as the fact that this decision is not something new or breakthrough and has certain disadvantages.  At the same time, it was simple, safe and provided the necessary result: the availability of the site, its content and functionality for users at the time of peak loads.  In addition, the crutch (due to simplicity) was easily and completely removed.  I also acknowledge that having the opportunity and time to think and some additional information, I could have made another decision. <br><br>  In general, the article is not so much about a specific technical solution, but about the situation itself.  So I ask you to treat her.  How to search for a fast, secure and satisfying solution in extreme conditions.  And (I would like this) as an illustration on the theme ‚ÄúKnowledge of few principles often replaces knowledge of many facts.‚Äù </div><p>Source: <a href="https://habr.com/ru/post/347134/">https://habr.com/ru/post/347134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347124/index.html">How dtraceasm works in JMH</a></li>
<li><a href="../347126/index.html">Reactive forms (reactive forms) Angular 5 (2+). Part 2</a></li>
<li><a href="../347128/index.html">JUndo - undo library for Java</a></li>
<li><a href="../347130/index.html">7 types of office loafers - part one</a></li>
<li><a href="../347132/index.html">We comprehend C deeper using assembler. Part 3</a></li>
<li><a href="../347138/index.html">Making games in Python 3 and Pygame: Part 1</a></li>
<li><a href="../347140/index.html">How to cook AR on android</a></li>
<li><a href="../347144/index.html">CoffeeMiner: hacking WiFi to embed a crypto miner in HTML pages</a></li>
<li><a href="../347146/index.html">Query Profiler in Phoenix. And a little bit about how stacktrace works in Elixir / Erlang</a></li>
<li><a href="../347148/index.html">The digest of interesting materials for the mobile # 237 developer (January 15-21)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>