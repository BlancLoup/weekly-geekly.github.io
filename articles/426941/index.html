<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>To the question of speed and its measurement in Arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This problem arose in the study of the speed of the work of Arduino when executing various commands (more on this in a separate post). In the process ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>To the question of speed and its measurement in Arduino</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/kx/oe/cl/kxoecl7ngezzej1ftzcleeswzde.jpeg"><br><br>  This problem arose in the study of the speed of the work of Arduino when executing various commands (more on this in a separate post).  In the process of research, doubts arose regarding the constancy of the operation time of individual teams when the value of the operands changed (as it turned out, not unreasonable) and it was decided to try to estimate the execution time of a particular command.  For this, a small program was written (who said the sketch was to leave the class), which, at first glance, confirmed the hypothesis.  In the output, you can observe the values ‚Äã‚Äãof 16 and 20, but sometimes there are also 28 and even 32 ms.  If you multiply the data by 16 (clock frequency MK), we get the execution time in clock ticks MK (from 256 to 512).  Unfortunately, the repeated run of the main program cycle (with the same initial data), while maintaining the overall picture, gives a different distribution of the execution time, so that the time variations that actually take place are not related to the original data.  The original hypothesis has been refuted, but it becomes interesting, and with what exactly is such a significant scatter associated. <br><a name="habracut"></a><br>  The necessary note - I understand perfectly well that to measure the execution time of commands you should use more complex programs, but for a rough estimate it is quite enough and such that will be demonstrated later. <br><br>  So, time is changing, and very significantly, looking for the causes of this phenomenon.  First of all, we pay attention to the multiplicity of the obtained values, look at the description of the work with the time library and see that 4 microsect is a measurement quantum, so it‚Äôs better to go over to the quanta and understand that we get 4 or 5 (quite often) and 6 or 7 or 8 (very rarely) units of measurement.  With the first half, everything is easy - if the measured value lies between 4 and 5 units, then the spread becomes inevitable.  Moreover, considering the counts to be independent, we can increase the measurement accuracy using statistical methods, which we do, obtaining acceptable results. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But with the second half (6,7,8) things are worse.  We found that the spread does not correlate with the initial data, which means that this is a manifestation of other processes that affect the execution time of commands.  Note that the emissions are quite rare and are not significant for the calculated average value.  It would be possible to ignore them altogether, but this is not our style.  In general, over the years in engineering, I realized that one should not leave misunderstandings, no matter how insignificant they might seem, since they have the disgusting tendency to beat in the back (well, or else where they can reach) at the most inopportune moment. <br><br>  We begin to put forward <b>hypothesis 1</b> - the most convenient (in terms of convenience and versatility, it is second only to the direct intervention of the Creator) - software glitches, of course, not mine, my programs never buggy, but plug-in libraries (compiler, operating system, browser, etc.) - substitute the necessary one).  Moreover, since I run the program in the emulator on <a href="http://www.tinkercad.com/">www.tinkercad.com</a> , I can still refer to the emulator bugs and close the topic, because the source code is not available to us.  Cons of this hypothesis: <br><br><ol><li>  From cycle to cycle, the location of deviations varies, which hints. </li><li>  This site still supports AutoDesk, although the argument is weak. </li><li>  ‚ÄúWe have accepted the postulate that what is happening is not a hallucination, otherwise it would be just not interesting.‚Äù </li></ol><br>  The following assumption is the effect of some background processes on the measurement result.  It seems to be doing nothing, except as we believe, although ... we also output the results to Serial.  There is a <b>hypothesis 2</b> - the time of withdrawal is sometimes (strange as it is ... but everything happens) is added to the command execution time.  Although it is doubtful how much of that output is there, but all the same - we add Flush and it did not help, we add a delay to the conclusion of the output and it didn‚Äôt help, we generally bring the output out of the cycle - still time jumps - this is definitely not Serial. <br><br>  Okay, what remains is the organization of the cycle itself (with what a fright it is to change its duration, it is not clear) and that‚Äôs all ... although micros () remained.  I meant that the execution time of the first call of this function and the second one is the same when subtracting these two values, I get zero, but if this assumption is wrong? <br><br>  Hypothesis 3 - sometimes the second time reference is performed longer than the first one, or the actions related to time measurement sometimes affect the result.  We look at the source code of the function of working with time (arduino-1.8.4 \ hardware \ arduino \ avr \ cores \ arduino \ wiring.c - I have repeatedly expressed my attitude to such things, I will not repeat) and see that 1 time out of 256 hardware increment cycles of the lower part of the counter are interrupted to increment the higher part of the counter. <br><br>  Our cycle execution time is from 4 to 5, so you can expect 170 * (4..5) / 256 = from three to four anomalous values ‚Äã‚Äãin the interval from 170 measurements.  We look - it is very similar, there are really 4 of them.  To separate the first and second causes, we make calculations with a critical section with forbidden interrupts.  The result does not change much, outliers still take place, which means that extra time introduces a call to micros ().  Here we can not do anything, although the source code is available, but we cannot change it - libraries are included in binary.  Of course, we can write our own functions of working with time and watch their behavior, but there is an easier way. <br><br>  If the possible reason for the increase in duration is the "long" interrupt processing, we exclude the possibility of its occurrence in the measurement process.  To do this, wait for its manifestation, and only then do a measurement cycle.  Since an interrupt occurs much less frequently than our measurement cycle lasts, its absence can be guaranteed.  We write the corresponding program fragment (using <s>dirty hacks</s> information extracted from the source code) and ‚Äúthis is such street magic‚Äù, everything becomes normal - we measure the execution time of 4 and 5 quanta with the average value of the execution time of the addition operation with PT in 166 cycles, corresponds to the previously measured value.  The hypothesis can be considered confirmed. <br><br>  One more question remains - what is being done in interruptions for so long, what does it take <br>  (7.8) - (5) ~ 2 quantum = * 4 = 8 Œºs * 16 = 128 processor cycles?  We turn to the source code (that is, the assembler code generated by the compiler on godbolt.com) and see that the interrupt itself executes approximately 70 cycles, of which 60 are permanent, and when reading there are additional costs of 10 cycles, totaling 70 when hit on interruption - less than received, but close enough.  The difference is attributed to the difference between compilers or modes of their use. <br><br>  Well, now we can measure the actual execution time of the PT addition command with various arguments and make sure that it really changes dramatically when the arguments change: from 136 cycles for 0.0 to 190 for 0.63 (magic number), and it is only 162 for 10.63.  With a probability of 99.9%, this is due to the need for alignment and the peculiarities of its implementation in this particular library, but this study clearly goes beyond the limits of the problem under consideration. <br><br><div class="spoiler">  <b class="spoiler_title">The application is the text of the program:</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> setup() { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> t; //   <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-type"><span class="hljs-type">int</span></span> d[<span class="hljs-number"><span class="hljs-number">170</span></span>]; unsigned long <span class="hljs-type"><span class="hljs-type">time</span></span>,time1; <span class="hljs-type"><span class="hljs-type">float</span></span> dt=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">170.</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { { //       time1=micros(); long time2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { time2=micros(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((time2 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>) == (time1 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }; <span class="hljs-comment"><span class="hljs-comment">/**/</span></span> time1=micros(); //   <span class="hljs-comment"><span class="hljs-comment">/* cli(); //       -   */</span></span> t=<span class="hljs-number"><span class="hljs-number">10.63</span></span>; //     t=t+dt; //   <span class="hljs-comment"><span class="hljs-comment">/* sei(); //    */</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> = micros(); //   time1=<span class="hljs-type"><span class="hljs-type">time</span></span>-time1; d[i]=time1/<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Serial.print(time1); //      Serial.flush(); //     Delay(20); //    */</span></span> }; //   ,     <span class="hljs-type"><span class="hljs-type">float</span></span> sum=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { sum+=d[i]; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(d[i]); }; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println((sum/<span class="hljs-number"><span class="hljs-number">170</span></span><span class="hljs-number"><span class="hljs-number">-2.11</span></span>)*<span class="hljs-number"><span class="hljs-number">4</span></span>*<span class="hljs-number"><span class="hljs-number">16</span></span>); //<span class="hljs-number"><span class="hljs-number">2.11</span></span> ‚Äì     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.flush(); //    ,     }</code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/426941/">https://habr.com/ru/post/426941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426931/index.html">How to go to work on the Cote d'Azur and get a French passport for 3 years</a></li>
<li><a href="../426933/index.html">Frontend design</a></li>
<li><a href="../426935/index.html">+10 clean code rules from Angular developer</a></li>
<li><a href="../426937/index.html">Bionic limbs learn to open beer</a></li>
<li><a href="../426939/index.html">Graduate student solved the problem of confirming quantum computing</a></li>
<li><a href="../426943/index.html">The most comprehensive Russian translation of the Harvard CS50 2015 Programming Course, free on YouTube</a></li>
<li><a href="../426945/index.html">What I liked about Paul Allen</a></li>
<li><a href="../426947/index.html">"The devil pulled me to go to work in the office" - 10 questions to the programmer, 9 release</a></li>
<li><a href="../426949/index.html">Recreating Sound Deep Note from THX</a></li>
<li><a href="../426951/index.html">Altium Designer: what to do if the project has become difficult?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>