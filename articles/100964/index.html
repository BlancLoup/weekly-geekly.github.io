<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A convenient way to do mailings on the basis of the site (with an example for Django)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will tell you about the experience of using Your MailingList Provider (YMLP) service for organizing the distribution of one of our projects. 

 Actu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A convenient way to do mailings on the basis of the site (with an example for Django)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/5d3/f6b/861/5d3f6b8616d42e0b21ec78254f75ab6f.gif" align="left"><br>  I will tell you about the experience of using <a href="http://www.yourmailinglistprovider.com/">Your MailingList Provider</a> (YMLP) service for organizing the distribution of one of our projects. <br><br>  Actually, the problem is simple and fairly common - there is a user base of the site, the task is to organize the mailing list correctly and conveniently.  Users should be able to unsubscribe from our list, we should send it out, and also (very desirable) to sample profile fields (for example, to distribute only to women older than 30) and to track statistics (for example, how many people opened the letter). <br><br>  I note that, in view of the fact that our project is international, there were two services in our field of view that allow us to do such things - this is the already mentioned <a href="http://www.yourmailinglistprovider.com/">YMLP</a> and <a href="https://www.netatlantic.com/">NetAtlantic</a> .  The second service is noticeably less flexible and convenient, so we settled on its main competitor - YMLP (in fact, not so long ago NetAtlantic had a big plus - the presence of an API, but it also appeared with YMLP, so everything became clear as day). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, YMLP allows you to do all of the above, plus more.  Free account allows you to do newsletters on the basis of up to 1000 people  You can create groups.  You can store mailing templates.  You can add arbitrary fields and sample them.  You can create custom forms.  There is an official implementation for working with API in PHP, but the mechanism of its work is so simple that it makes no difficulty to use any other programming language, for example, Python. <br><br>  A very important feature is that you can make any number of subaccounts and customize their rights. <br><br>  We have been using the service since last November, there are no complaints.  Highly recommend. <br><br>  So, the promised example for Django is a working script for integrating the user base of this framework with YMLP.  Called by cron, synchronizing the base of the site with the base YMLP: <br><a name="habracut"></a><br> <code><a href="https://www.ymlp.com/api/%2522"></a> <font color="#808080">#!/usr/bin/env python2.6</font> &lt;br/&gt; <br> <font color="#ff7700">import</font> <font color="#dc143c">os</font> , <font color="#dc143c">sys</font> , <font color="#dc143c">urllib</font> &lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">random</font> <font color="#ff7700">import</font> randint&lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">datetime</font> <font color="#ff7700">import</font> <font color="#dc143c">datetime</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>path</font> . <font>append</font> <font>(</font> <font color="#483d8b">'/home/www-data/university'</font> <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">os</font> . <font>environ</font> <font>[</font> <font color="#483d8b">'DJANGO_SETTINGS_MODULE'</font> <font>]</font> = <font color="#483d8b">'settings'</font> &lt;br/&gt; <br> &lt;br/&gt; <br> API_URL = <font color="#483d8b">"www.ymlp.com/api/"</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> <font color="#ff7700">from</font> django. <font>utils</font> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> <font color="#ff7700">except</font> <font color="#008000">ImportError</font> :&lt;br/&gt; <br> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">from</font> accounts. <font>models</font> <font color="#ff7700">import</font> UserProfile&lt;br/&gt; <br> <font color="#ff7700">from</font> settings <font color="#ff7700">import</font> ROOT, YMLP_API_KEY, YMLP_USERNAME, YMLP_GROUP_NAME&lt;br/&gt; <br> &lt;br/&gt; <br> _groups = <font color="#008000">None</font> &lt;br/&gt; <br> _fields = <font color="#008000">None</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">class</font> YMLPException <font>(</font> <font color="#008000">Exception</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _search_id <font>(</font> dicts, search_key, search_value <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">for</font> d <font color="#ff7700">in</font> dicts:&lt;br/&gt; <br> <font color="#ff7700">if</font> d. <font>get</font> <font>(</font> search_key, <font color="#483d8b">""</font> <font>)</font> . <font>lower</font> <font>(</font> <font>)</font> == search_value. <font>lower</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> d. <font>get</font> <font>(</font> <font color="#483d8b">"ID"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_fields_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _fields <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Fields.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _fields = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_groups_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _groups <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Groups.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _groups = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> add_contact <font>(</font> <font color="#dc143c">email</font> , group_name, fields, overrule_unsubscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> fields_list = get_fields_list <font>(</font> <font>)</font> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> name,value <font color="#ff7700">in</font> fields. <font>items</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> field_id = _search_id <font>(</font> fields_list, <font color="#483d8b">"FieldName"</font> , name <font>)</font> <font color="#ff7700">or</font> _search_id <font>(</font> fields_list, <font color="#483d8b">"Alias"</font> , name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> field_id <font color="#ff7700">is</font> <font color="#ff7700">not</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> value <font>)</font> <font color="#ff7700">is</font> <font color="#008000">unicode</font> :&lt;br/&gt; <br> value = value. <font>encode</font> <font>(</font> <font color="#483d8b">"utf-8"</font> <font>)</font> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"Field"</font> +field_id <font>]</font> = value&lt;br/&gt; <br> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"OverruleUnsubscribedBounced"</font> <font>]</font> = <font color="#483d8b">"1"</font> <font color="#ff7700">if</font> overrule_unsubscribed <font color="#ff7700">else</font> <font color="#483d8b">"0"</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Add"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> unsubscribe_contact <font>(</font> <font color="#dc143c">email</font> <font>)</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Unsubscribe"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> delete_contact <font>(</font> <font color="#dc143c">email</font> , group_name <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Delete"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> __name__ == <font color="#483d8b">"__main__"</font> :&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#dc143c">datetime</font> . <font>now</font> <font>(</font> <font>)</font> . <font>isoformat</font> <font>(</font> <font color="#483d8b">" "</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Exporting..."</font> &lt;br/&gt; <br> count = <font color="#ff4500">0</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> count, YMLP_GROUP_NAME&lt;br/&gt; <br> add_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME, fields <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font>[</font> <font color="#483d8b">"o"</font> , <font color="#483d8b">"O"</font> <font>]</font> <font>[</font> randint <font>(</font> <font color="#ff4500">0</font> , <font color="#ff4500">1</font> <font>)</font> <font>]</font> ,&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>stdout</font> . <font>flush</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> count += <font color="#ff4500">1</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> <font color="#dc143c">profile</font> <font color="#ff7700">in</font> UserProfile. <font>objects</font> . <font color="#008000">filter</font> <font>(</font> subscription_accepted= <font color="#008000">True</font> , subscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>filled</font> :&lt;br/&gt; <br> fields = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"name"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>first_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"lastname"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>last_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"sex"</font> : <font color="#dc143c">profile</font> . <font>gender</font> ,&lt;br/&gt; <br> <font color="#483d8b">"city"</font> : <font color="#dc143c">profile</font> . <font>city</font> ,&lt;br/&gt; <br> <font color="#483d8b">"country"</font> : <font color="#dc143c">profile</font> . <font>country</font> ,&lt;br/&gt; <br> <font color="#483d8b">"reference"</font> : <font color="#dc143c">profile</font> . <font>reference</font> ,&lt;br/&gt; <br> <font color="#483d8b">"year"</font> : <font color="#ff4500">0</font> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>birth_date</font> == <font color="#008000">None</font> <font color="#ff7700">else</font> <font color="#dc143c">profile</font> . <font>birth_date</font> . <font>year</font> &lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> fields = <font>{</font> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> done = <font color="#008000">False</font> &lt;br/&gt; <br> first_try = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">while</font> <font color="#ff7700">not</font> done:&lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException <font color="#ff7700">as</font> inst:&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#66cc66">&gt;&gt;</font> <font color="#dc143c">sys</font> . <font>stderr</font> , <font color="#483d8b">"Error #%s while adding contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> . The error was: %s"</font> <font color="#66cc66">%</font> <font>(</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> , <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#ff7700">not</font> first_try:&lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"1"</font> <font color="#ff7700">and</font> inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> == <font color="#008000">None</font> : <font color="#808080"># contact already exists, let's update</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> already exists, trying to update"</font> <font color="#66cc66">%</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> delete_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException:&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> first_try = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"3"</font> : <font color="#808080"># "Email address already in selected groups"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Setting the 'Subscribed' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"4"</font> : <font color="#808080"># "This email address has previously unsubscribed"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Removing the 'Subscription Accepted' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscription_accepted</font> = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> <font color="#ff7700">in</font> <font>[</font> <font color="#483d8b">"2"</font> , <font color="#483d8b">"100"</font> , <font color="#483d8b">"101"</font> , <font color="#483d8b">"102"</font> <font>]</font> :&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>exit</font> <font>(</font> - <font color="#ff4500">1</font> <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">" <font color="#000099">\n</font> Done. Contacts added: %d, total users number: %d. Bye."</font> <font color="#66cc66">%</font> <font>(</font> count, UserProfile. <font>objects</font> . <font color="#008000">all</font> <font>(</font> <font>)</font> . <font>count</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">""</font> . <font>zfill</font> <font>(</font> <font color="#ff4500">80</font> <font>)</font> . <font>replace</font> <font>(</font> <font color="#483d8b">"0"</font> , <font color="#483d8b">"-"</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> &lt;br/&gt; <br> <br></code> <blockquote> <code><a href="https://www.ymlp.com/api/%2522"></a> <font color="#808080">#!/usr/bin/env python2.6</font> &lt;br/&gt; <br> <font color="#ff7700">import</font> <font color="#dc143c">os</font> , <font color="#dc143c">sys</font> , <font color="#dc143c">urllib</font> &lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">random</font> <font color="#ff7700">import</font> randint&lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">datetime</font> <font color="#ff7700">import</font> <font color="#dc143c">datetime</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>path</font> . <font>append</font> <font>(</font> <font color="#483d8b">'/home/www-data/university'</font> <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">os</font> . <font>environ</font> <font>[</font> <font color="#483d8b">'DJANGO_SETTINGS_MODULE'</font> <font>]</font> = <font color="#483d8b">'settings'</font> &lt;br/&gt; <br> &lt;br/&gt; <br> API_URL = <font color="#483d8b">"www.ymlp.com/api/"</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> <font color="#ff7700">from</font> django. <font>utils</font> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> <font color="#ff7700">except</font> <font color="#008000">ImportError</font> :&lt;br/&gt; <br> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">from</font> accounts. <font>models</font> <font color="#ff7700">import</font> UserProfile&lt;br/&gt; <br> <font color="#ff7700">from</font> settings <font color="#ff7700">import</font> ROOT, YMLP_API_KEY, YMLP_USERNAME, YMLP_GROUP_NAME&lt;br/&gt; <br> &lt;br/&gt; <br> _groups = <font color="#008000">None</font> &lt;br/&gt; <br> _fields = <font color="#008000">None</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">class</font> YMLPException <font>(</font> <font color="#008000">Exception</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _search_id <font>(</font> dicts, search_key, search_value <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">for</font> d <font color="#ff7700">in</font> dicts:&lt;br/&gt; <br> <font color="#ff7700">if</font> d. <font>get</font> <font>(</font> search_key, <font color="#483d8b">""</font> <font>)</font> . <font>lower</font> <font>(</font> <font>)</font> == search_value. <font>lower</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> d. <font>get</font> <font>(</font> <font color="#483d8b">"ID"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_fields_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _fields <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Fields.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _fields = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_groups_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _groups <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Groups.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _groups = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> add_contact <font>(</font> <font color="#dc143c">email</font> , group_name, fields, overrule_unsubscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> fields_list = get_fields_list <font>(</font> <font>)</font> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> name,value <font color="#ff7700">in</font> fields. <font>items</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> field_id = _search_id <font>(</font> fields_list, <font color="#483d8b">"FieldName"</font> , name <font>)</font> <font color="#ff7700">or</font> _search_id <font>(</font> fields_list, <font color="#483d8b">"Alias"</font> , name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> field_id <font color="#ff7700">is</font> <font color="#ff7700">not</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> value <font>)</font> <font color="#ff7700">is</font> <font color="#008000">unicode</font> :&lt;br/&gt; <br> value = value. <font>encode</font> <font>(</font> <font color="#483d8b">"utf-8"</font> <font>)</font> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"Field"</font> +field_id <font>]</font> = value&lt;br/&gt; <br> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"OverruleUnsubscribedBounced"</font> <font>]</font> = <font color="#483d8b">"1"</font> <font color="#ff7700">if</font> overrule_unsubscribed <font color="#ff7700">else</font> <font color="#483d8b">"0"</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Add"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> unsubscribe_contact <font>(</font> <font color="#dc143c">email</font> <font>)</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Unsubscribe"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> delete_contact <font>(</font> <font color="#dc143c">email</font> , group_name <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Delete"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> __name__ == <font color="#483d8b">"__main__"</font> :&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#dc143c">datetime</font> . <font>now</font> <font>(</font> <font>)</font> . <font>isoformat</font> <font>(</font> <font color="#483d8b">" "</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Exporting..."</font> &lt;br/&gt; <br> count = <font color="#ff4500">0</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> count, YMLP_GROUP_NAME&lt;br/&gt; <br> add_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME, fields <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font>[</font> <font color="#483d8b">"o"</font> , <font color="#483d8b">"O"</font> <font>]</font> <font>[</font> randint <font>(</font> <font color="#ff4500">0</font> , <font color="#ff4500">1</font> <font>)</font> <font>]</font> ,&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>stdout</font> . <font>flush</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> count += <font color="#ff4500">1</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> <font color="#dc143c">profile</font> <font color="#ff7700">in</font> UserProfile. <font>objects</font> . <font color="#008000">filter</font> <font>(</font> subscription_accepted= <font color="#008000">True</font> , subscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>filled</font> :&lt;br/&gt; <br> fields = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"name"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>first_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"lastname"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>last_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"sex"</font> : <font color="#dc143c">profile</font> . <font>gender</font> ,&lt;br/&gt; <br> <font color="#483d8b">"city"</font> : <font color="#dc143c">profile</font> . <font>city</font> ,&lt;br/&gt; <br> <font color="#483d8b">"country"</font> : <font color="#dc143c">profile</font> . <font>country</font> ,&lt;br/&gt; <br> <font color="#483d8b">"reference"</font> : <font color="#dc143c">profile</font> . <font>reference</font> ,&lt;br/&gt; <br> <font color="#483d8b">"year"</font> : <font color="#ff4500">0</font> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>birth_date</font> == <font color="#008000">None</font> <font color="#ff7700">else</font> <font color="#dc143c">profile</font> . <font>birth_date</font> . <font>year</font> &lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> fields = <font>{</font> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> done = <font color="#008000">False</font> &lt;br/&gt; <br> first_try = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">while</font> <font color="#ff7700">not</font> done:&lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException <font color="#ff7700">as</font> inst:&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#66cc66">&gt;&gt;</font> <font color="#dc143c">sys</font> . <font>stderr</font> , <font color="#483d8b">"Error #%s while adding contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> . The error was: %s"</font> <font color="#66cc66">%</font> <font>(</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> , <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#ff7700">not</font> first_try:&lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"1"</font> <font color="#ff7700">and</font> inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> == <font color="#008000">None</font> : <font color="#808080"># contact already exists, let's update</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> already exists, trying to update"</font> <font color="#66cc66">%</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> delete_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException:&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> first_try = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"3"</font> : <font color="#808080"># "Email address already in selected groups"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Setting the 'Subscribed' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"4"</font> : <font color="#808080"># "This email address has previously unsubscribed"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Removing the 'Subscription Accepted' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscription_accepted</font> = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> <font color="#ff7700">in</font> <font>[</font> <font color="#483d8b">"2"</font> , <font color="#483d8b">"100"</font> , <font color="#483d8b">"101"</font> , <font color="#483d8b">"102"</font> <font>]</font> :&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>exit</font> <font>(</font> - <font color="#ff4500">1</font> <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">" <font color="#000099">\n</font> Done. Contacts added: %d, total users number: %d. Bye."</font> <font color="#66cc66">%</font> <font>(</font> count, UserProfile. <font>objects</font> . <font color="#008000">all</font> <font>(</font> <font>)</font> . <font>count</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">""</font> . <font>zfill</font> <font>(</font> <font color="#ff4500">80</font> <font>)</font> . <font>replace</font> <font>(</font> <font color="#483d8b">"0"</font> , <font color="#483d8b">"-"</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> &lt;br/&gt; <br> <br></code> </blockquote> <code><a href="https://www.ymlp.com/api/%2522"></a> <font color="#808080">#!/usr/bin/env python2.6</font> &lt;br/&gt; <br> <font color="#ff7700">import</font> <font color="#dc143c">os</font> , <font color="#dc143c">sys</font> , <font color="#dc143c">urllib</font> &lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">random</font> <font color="#ff7700">import</font> randint&lt;br/&gt; <br> <font color="#ff7700">from</font> <font color="#dc143c">datetime</font> <font color="#ff7700">import</font> <font color="#dc143c">datetime</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>path</font> . <font>append</font> <font>(</font> <font color="#483d8b">'/home/www-data/university'</font> <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">os</font> . <font>environ</font> <font>[</font> <font color="#483d8b">'DJANGO_SETTINGS_MODULE'</font> <font>]</font> = <font color="#483d8b">'settings'</font> &lt;br/&gt; <br> &lt;br/&gt; <br> API_URL = <font color="#483d8b">"www.ymlp.com/api/"</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> <font color="#ff7700">from</font> django. <font>utils</font> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> <font color="#ff7700">except</font> <font color="#008000">ImportError</font> :&lt;br/&gt; <br> <font color="#ff7700">import</font> simplejson <font color="#ff7700">as</font> json&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">from</font> accounts. <font>models</font> <font color="#ff7700">import</font> UserProfile&lt;br/&gt; <br> <font color="#ff7700">from</font> settings <font color="#ff7700">import</font> ROOT, YMLP_API_KEY, YMLP_USERNAME, YMLP_GROUP_NAME&lt;br/&gt; <br> &lt;br/&gt; <br> _groups = <font color="#008000">None</font> &lt;br/&gt; <br> _fields = <font color="#008000">None</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">class</font> YMLPException <font>(</font> <font color="#008000">Exception</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _search_id <font>(</font> dicts, search_key, search_value <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">for</font> d <font color="#ff7700">in</font> dicts:&lt;br/&gt; <br> <font color="#ff7700">if</font> d. <font>get</font> <font>(</font> search_key, <font color="#483d8b">""</font> <font>)</font> . <font>lower</font> <font>(</font> <font>)</font> == search_value. <font>lower</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> d. <font>get</font> <font>(</font> <font color="#483d8b">"ID"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_fields_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _fields <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Fields.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _fields = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _fields&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> get_groups_list <font>(</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> _groups <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Groups.GetList"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> <font color="#ff7700">and</font> result. <font>has_key</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result <font>[</font> <font color="#483d8b">"Code"</font> <font>]</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> _groups = result&lt;br/&gt; <br> <font color="#ff7700">return</font> _groups&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> add_contact <font>(</font> <font color="#dc143c">email</font> , group_name, fields, overrule_unsubscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> fields_list = get_fields_list <font>(</font> <font>)</font> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> name,value <font color="#ff7700">in</font> fields. <font>items</font> <font>(</font> <font>)</font> :&lt;br/&gt; <br> field_id = _search_id <font>(</font> fields_list, <font color="#483d8b">"FieldName"</font> , name <font>)</font> <font color="#ff7700">or</font> _search_id <font>(</font> fields_list, <font color="#483d8b">"Alias"</font> , name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> field_id <font color="#ff7700">is</font> <font color="#ff7700">not</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> value <font>)</font> <font color="#ff7700">is</font> <font color="#008000">unicode</font> :&lt;br/&gt; <br> value = value. <font>encode</font> <font>(</font> <font color="#483d8b">"utf-8"</font> <font>)</font> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"Field"</font> +field_id <font>]</font> = value&lt;br/&gt; <br> &lt;br/&gt; <br> params <font>[</font> <font color="#483d8b">"OverruleUnsubscribedBounced"</font> <font>]</font> = <font color="#483d8b">"1"</font> <font color="#ff7700">if</font> overrule_unsubscribed <font color="#ff7700">else</font> <font color="#483d8b">"0"</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Add"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> unsubscribe_contact <font>(</font> <font color="#dc143c">email</font> <font>)</font> :&lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Unsubscribe"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> delete_contact <font>(</font> <font color="#dc143c">email</font> , group_name <font>)</font> :&lt;br/&gt; <br> groups_list = get_groups_list <font>(</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> group_id = _search_id <font>(</font> groups_list, <font color="#483d8b">"GroupName"</font> , group_name <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> group_id <font color="#ff7700">is</font> <font color="#008000">None</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">"Invalid group name"</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> params = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"Email"</font> : <font color="#dc143c">email</font> ,&lt;br/&gt; <br> <font color="#483d8b">"GroupID"</font> : group_id,&lt;br/&gt; <br> <font color="#483d8b">"Key"</font> : YMLP_API_KEY,&lt;br/&gt; <br> <font color="#483d8b">"Username"</font> : YMLP_USERNAME,&lt;br/&gt; <br> <font color="#483d8b">"Output"</font> : <font color="#483d8b">"JSON"</font> ,&lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> f = <font color="#dc143c">urllib</font> . <font>urlopen</font> <font>(</font> <font color="#483d8b">"%s%s?%s"</font> <font color="#66cc66">%</font> <font>(</font> API_URL, <font color="#483d8b">"Contacts.Delete"</font> , <font color="#dc143c">urllib</font> . <font>urlencode</font> <font>(</font> params <font>)</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> result = json. <font>loads</font> <font>(</font> f. <font>read</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#008000">type</font> <font>(</font> result <font>)</font> <font color="#ff7700">is</font> <font color="#008000">dict</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> == <font color="#483d8b">"0"</font> :&lt;br/&gt; <br> <font color="#ff7700">return</font> <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> result. <font>get</font> <font>(</font> <font color="#483d8b">"Code"</font> <font>)</font> , result. <font>get</font> <font>(</font> <font color="#483d8b">"Output"</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">raise</font> YMLPException <font>(</font> <font color="#008000">None</font> , <font color="#483d8b">""</font> <font>)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">if</font> __name__ == <font color="#483d8b">"__main__"</font> :&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#dc143c">datetime</font> . <font>now</font> <font>(</font> <font>)</font> . <font>isoformat</font> <font>(</font> <font color="#483d8b">" "</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Exporting..."</font> &lt;br/&gt; <br> count = <font color="#ff4500">0</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">def</font> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">global</font> count, YMLP_GROUP_NAME&lt;br/&gt; <br> add_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME, fields <font>)</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font>[</font> <font color="#483d8b">"o"</font> , <font color="#483d8b">"O"</font> <font>]</font> <font>[</font> randint <font>(</font> <font color="#ff4500">0</font> , <font color="#ff4500">1</font> <font>)</font> <font>]</font> ,&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>stdout</font> . <font>flush</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> count += <font color="#ff4500">1</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">for</font> <font color="#dc143c">profile</font> <font color="#ff7700">in</font> UserProfile. <font>objects</font> . <font color="#008000">filter</font> <font>(</font> subscription_accepted= <font color="#008000">True</font> , subscribed= <font color="#008000">False</font> <font>)</font> :&lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>filled</font> :&lt;br/&gt; <br> fields = <font>{</font> &lt;br/&gt; <br> <font color="#483d8b">"name"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>first_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"lastname"</font> : <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font>last_name</font> ,&lt;br/&gt; <br> <font color="#483d8b">"sex"</font> : <font color="#dc143c">profile</font> . <font>gender</font> ,&lt;br/&gt; <br> <font color="#483d8b">"city"</font> : <font color="#dc143c">profile</font> . <font>city</font> ,&lt;br/&gt; <br> <font color="#483d8b">"country"</font> : <font color="#dc143c">profile</font> . <font>country</font> ,&lt;br/&gt; <br> <font color="#483d8b">"reference"</font> : <font color="#dc143c">profile</font> . <font>reference</font> ,&lt;br/&gt; <br> <font color="#483d8b">"year"</font> : <font color="#ff4500">0</font> <font color="#ff7700">if</font> <font color="#dc143c">profile</font> . <font>birth_date</font> == <font color="#008000">None</font> <font color="#ff7700">else</font> <font color="#dc143c">profile</font> . <font>birth_date</font> . <font>year</font> &lt;br/&gt; <br> <font>}</font> &lt;br/&gt; <br> <font color="#ff7700">else</font> :&lt;br/&gt; <br> fields = <font>{</font> <font>}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> done = <font color="#008000">False</font> &lt;br/&gt; <br> first_try = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">while</font> <font color="#ff7700">not</font> done:&lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> _subscribe_profile <font>(</font> <font color="#dc143c">profile</font> , fields <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException <font color="#ff7700">as</font> inst:&lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#66cc66">&gt;&gt;</font> <font color="#dc143c">sys</font> . <font>stderr</font> , <font color="#483d8b">"Error #%s while adding contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> . The error was: %s"</font> <font color="#66cc66">%</font> <font>(</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> , <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> <font color="#ff7700">not</font> first_try:&lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">if</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"1"</font> <font color="#ff7700">and</font> inst <font>[</font> <font color="#ff4500">1</font> <font>]</font> == <font color="#008000">None</font> : <font color="#808080"># contact already exists, let's update</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Contact <font color="#000099">\"</font> %s <font color="#000099">\"</font> already exists, trying to update"</font> <font color="#66cc66">%</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> &lt;br/&gt; <br> <font color="#ff7700">try</font> :&lt;br/&gt; <br> delete_contact <font>(</font> <font color="#dc143c">profile</font> . <font color="#dc143c">user</font> . <font color="#dc143c">email</font> , YMLP_GROUP_NAME <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">except</font> YMLPException:&lt;br/&gt; <br> <font color="#ff7700">pass</font> &lt;br/&gt; <br> first_try = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#ff7700">continue</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"3"</font> : <font color="#808080"># "Email address already in selected groups"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Setting the 'Subscribed' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscribed</font> = <font color="#008000">True</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> == <font color="#483d8b">"4"</font> : <font color="#808080"># "This email address has previously unsubscribed"</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">"Removing the 'Subscription Accepted' flag..."</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>subscription_accepted</font> = <font color="#008000">False</font> &lt;br/&gt; <br> <font color="#dc143c">profile</font> . <font>save</font> <font>(</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">elif</font> inst <font>[</font> <font color="#ff4500">0</font> <font>]</font> <font color="#ff7700">in</font> <font>[</font> <font color="#483d8b">"2"</font> , <font color="#483d8b">"100"</font> , <font color="#483d8b">"101"</font> , <font color="#483d8b">"102"</font> <font>]</font> :&lt;br/&gt; <br> <font color="#dc143c">sys</font> . <font>exit</font> <font>(</font> - <font color="#ff4500">1</font> <font>)</font> &lt;br/&gt; <br> done = <font color="#008000">True</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">" <font color="#000099">\n</font> Done. Contacts added: %d, total users number: %d. Bye."</font> <font color="#66cc66">%</font> <font>(</font> count, UserProfile. <font>objects</font> . <font color="#008000">all</font> <font>(</font> <font>)</font> . <font>count</font> <font>(</font> <font>)</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> <font color="#483d8b">""</font> . <font>zfill</font> <font>(</font> <font color="#ff4500">80</font> <font>)</font> . <font>replace</font> <font>(</font> <font color="#483d8b">"0"</font> , <font color="#483d8b">"-"</font> <font>)</font> &lt;br/&gt; <br> <font color="#ff7700">print</font> &lt;br/&gt; <br> <br></code> <br><br>  Successful to you mailings!  :-) <br></div><p>Source: <a href="https://habr.com/ru/post/100964/">https://habr.com/ru/post/100964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../100959/index.html">Ten tips for novice programmers</a></li>
<li><a href="../100960/index.html">Harumambu.Ru is looking for a new owner</a></li>
<li><a href="../100961/index.html">Vulnerability of PHP + nginx bundle with a curved config</a></li>
<li><a href="../100962/index.html">Habra-image-hosting - where is he? (not to be confused with habreffect.ru)</a></li>
<li><a href="../100963/index.html">Working with GMail bookmarks</a></li>
<li><a href="../100965/index.html">Online store large advertising</a></li>
<li><a href="../100966/index.html">Let's talk about the tests?</a></li>
<li><a href="../100967/index.html">Human testing of the prosthesis of the arm, which is directly controlled by the brain, begins.</a></li>
<li><a href="../100973/index.html">The second life of a DVD player or cooling pad for a laptop</a></li>
<li><a href="../100975/index.html">Debugging Web Applications in IIS Express</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>