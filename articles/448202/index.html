<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage generator or fight against ADC in STM32F030</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I somehow did not develop historically with the STM32F030 family, 5 years ago I tried to work with them and for a long time was surprised at the clums...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage generator or fight against ADC in STM32F030</h1><div class="post__text post__text-html js-mediator-article">  I somehow did not develop historically with the STM32F030 family, 5 years ago I tried to work with them and for a long time was surprised at the clumsiness of the work of most of the periphery, and then scored on them.  And the other day I still had to return to this series, it was necessary to measure for minimal money the constant voltage on the lead battery (or assembly up to 4 pieces in series) from 8 to 60V with an accuracy of no less than ¬± 0.1 V with a small polling frequency. <br><br>  Solving the problem "in the forehead" allowed me to accurately measure the voltage only when the input value of the ADC is greater than 1.5 ... 1.6 V, that is, only in the second half of the range, which meant 30 ... 60 V instead of the required 8 for me .. .60B.  The main problem was in the range of 0 ... 1.6 V, it looked as if my voltage divider was ‚Äúfloating‚Äù or the reference voltage for the ADC (V <sub>ref</sub> ) was extremely unstable. <br><br>  It was necessary to quickly solve the problem, albeit not in the most elegant way, but at least without obvious crutches.  To do this, it was necessary to first study the problem and understand where the "legs grow", and then eliminate this problem.  If it does not work out, then at least somehow get around it in order to finally get a working device and send it to the customer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/4u/fa/6z/4ufa6zj7pfysphxs0dye2xapd5a.jpeg"><br><a name="habracut"></a><br><h2>  The essence of the task </h2><br>  Generally, I‚Äôm not trying to get involved in such a small thing for a long time, but then a relative came to me, and a good person who also works in a subject close to me ‚Äî collects some SES somewhere in the suburbs.  I didn‚Äôt want to refuse, and at that moment this task seemed to me ‚Äúa couple of hours of iron + a couple of hours of code‚Äù.  The project in Altium Designer really took me a couple of hours, but the fight against the ADC ate the whole evening, so I decided to share the information so that others would not waste time. <br><br>  <u>The device itself is extremely simple, the algorithm works as follows:</u> <br><br><ul><li>  measure the voltage on the assembly of 1 ... 4 consecutively connected lead batteries; </li><li>  if the voltage is less than the ‚Äúlower threshold‚Äù, then we close the relay and it turns on the generator that charges our batteries; </li><li>  if the voltage rises above the ‚Äúlower threshold + hysteresis‚Äù, that is, the batteries are charged to the set threshold, then turn off the generator; </li><li>  if the voltage is above the "upper threshold", then we prohibit to turn on the generator, just in case. </li></ul><br>  Everything!  Example: there is one battery for 12V and it is powered by an inverter.  If the voltage falls below the "lower threshold", the default is 10.2V, then turn on the generator.  If the voltage on the battery has grown to "the lower threshold + hysteresis", then turn off.  By default, the hysteresis is set to 2V and is needed so that the gasoline generator is not cut down as soon as the battery slightly charges to 10.3V.  From constant on / off, the generator will simply die.  Well, just in case protection: if the voltage on the battery is higher than 14.4V, then the generator does not exactly turn on. <br><br>  The algorithm is simple and clear, in addition it was necessary to make a small menu so that you can change three variables: ‚Äúlower threshold‚Äù, ‚Äúhysteresis‚Äù, ‚Äúupper threshold‚Äù.  Nothing complicated, but the devil is in the details. <br><br>  Initially, the company where the relative works, used a Chinese device with similar functionality.  Of the minor drawbacks - it was impossible to change the hysteresis, for powering needed an additional source of 5V and measurement of up to 30V, that is, for 1 or 2 batteries.  Of the <b>big</b> drawbacks - the Chinese device sometimes hung up and rebooted at the time of starting the gasoline generator, which was controlled.  The last "feature" just became the reason for trying to abandon the Chinese solution. <br><br>  From me they wanted to eliminate all these disadvantages and that the price of the device was like that of the Chinese, that is, $ 10.  ‚ÄúDevil's trifle‚Äù in this case was that they wanted to buy from me a ready-made device for $ 10 in batches of only 20-30 pieces, although it is stable and quite often.  That is, I had to make the device much better in a small series and much cheaper than the Chinese, I also need to make money in the future.  Yeah, I, too, was funny in the first 10 minutes, but by the time I realized this situation, I already said ‚ÄúYES‚Äù, that is, beyond the Volga, there was no land for me ... <br><br><h2>  Iron problem solving </h2><br>  As I wrote above, the main problem is the unstable operation of the device during generator start-up.  As a result, a Chinese device with an aliexpress was purchased for testing and research.  The main reason for the demolition of the head was not in the generator, but in the relay :)) At the time of switching over the power supply, a 3.3V bus passed a pulse with an amplitude of about 25V, which seemed to hint ... Also, interference went to the signal circuits.  In the Chinese scheme to deal with such a problem were diodes LL4148, which type blocked the way to interference.  It turned out to be enough for the device to work normally on the table, but not in the conditions of a heap of external additional noise such as a generator and other equipment.  In order to permanently get rid of the above, I decided to apply <b>galvanic isolation</b> through the ‚Äúoptocoupler + dc / dc‚Äù connection, which made it possible to completely eliminate the electrical contact and the path of interference between the control winding of the relay and the rest of the circuit. <br><br><img src="https://habrastorage.org/webt/l0/4r/cr/l04rcre8uydqsnfhozzzaejo0mq.png"><br><br>  An alternative to this solution was the use of protective TVS diodes together with the common-mode choke, as well as the complication of the filter on the power supply.  But why such a collective farm?  Putting dc / dc is easier, but in practice it turned out to be even cheaper - the Chinese Mornsun B0505S-1WR2 module cost me $ 0.4, while the cost of one common-mode choke for a small batch is about $ 0.32. <br><br>  As a result, after such a solution and prototype testing, the device began to work as a Kalashnikov assault rifle and the problems with the restart were gone.  In general, I am a little surprised that the relay + sensitive generator still forced stm to reboot, Chinese developers basically did everything well: 10 kOhm + 0.1 ŒºF to reset blocking capacitors for power, ferrite beads, everything was there, but it still turned out few. <br><br>  The second minus of the ‚ÄúChinese‚Äù was the need for additional power, apparently saving on dc / dc.  I solved the problem in the forehead - I took power from the input signal, right from one connector.  To do this, you just had to put dc / dc, which digests at least 4 * 14.4V, that is 57.6V.  My choice fell on the LMR16010PDDAR.  First, it is Texas and that says it all.  Secondly, the Asian comrades offered me this chip very cheaply. <br><br>  The previous item comprehensively decided the third minus - the ability to connect up to 4 batteries in series.  DC / DC easily digests 60V, begins to try to burn only at 72 ... 73V, so the maximum 57.6V is definitely not scary for it.  The voltage divider doesn‚Äôt care how much the input is, so everything was decided with minimal effort. <br><br>  You can see how all this is implemented in the diagram here - <a href="https://drive.google.com/open%3Fid%3D10QW6e33vyXX9vDFlJeadf0s_98k1R3hY">PDF</a> .  The scheme is quite large, so the picture did not fill.  By the way, in pdf-ke you can also see the dimensions with the printed circuit board, but there is nothing supernatural. <br><br>  As a result, components for 10 devices were ordered for the first test batch, and after assembly it turned out like this: <br><br><img src="https://habrastorage.org/webt/0e/ve/st/0evestpmuht21eg31ku7odxxdtk.jpeg"><br><br>  It was not without incident - when I created a component for the dc / dc module I confused 1 and 2 legs in some places, I had to tinker a bit.  Although on subsequent boards I did it more carefully, so that no one noticed, and the board in the photo remained in my quality of debugging, just in case or for software modifications, if the customer comes up with something during testing. <br><br><h2>  Fight with ADC accuracy </h2><br>  We now turn to the main part of the article.  As I wrote at the beginning of the article - the F030 ADC was inaccurate, that is, up to a voltage of 30 ... 32V at the device input, the readings floated with a deviation of up to 15 ... 20%, and then the error smoothly disappeared.  One thing pleased me - at first glance, the deviations had some sort of regularity, which means it was not a random error and can be traced and tried to be corrected. <br><br>  Let's get a little more detail about the error ... after the conversion is complete, the ADC sends the raw data to the <i>DR</i> register, which contains a value from 0 to 4095 (2 <sup>12</sup> ).  To recalculate this value in the voltage you need to multiply it by the quantization step.  In my case, the voltage at the VDDA pin, from which the ADC takes support, was 3.3072V and, accordingly, the step is 3.3072V / 4096 = 0.000807V, I rounded it to 0.0008.  To get the voltage at the input of the device, the resulting voltage must be multiplied by the voltage divider coefficient, in my case the resistor in the upper arm is 100 kŒ© and in the lower arm is 4.7 kŒ©, which is given by the divider 22.2765.  Based on this, the voltage at the input of the device, that is, the voltage of the battery, is found using the formula: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> voltageReference = <span class="hljs-number"><span class="hljs-number">0.0008</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> voltageDivider = <span class="hljs-number"><span class="hljs-number">22.2765</span></span>; adcVoltageResult = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)adcData * voltageReference * voltageDivider;</code> </pre> <br>  It turns out that after reading the data <i>ADC1-&gt; DR</i> , they are reduced to the type <i>float</i> and simply multiplied by the coefficients, which are constants, and we get the result in the usual volts.  In practice, it turned out that everything is very bad with accuracy. <br><br>  Recalling Hanlon's razor, I began to look for a place where I made a mistake.  At first, I checked the voltage on the VDDA leg, I thought that it somehow floated and depends on the input voltage, for example, the LDO is faulty.  Armed with a benchtop multimeter, I monitored the voltage on the VDDA and changed the input voltage from 8 to 60V, while the voltage on the leg of the VDDA was dead at 3.3072V, only the next 2 characters floated, which is very good for a linear operator for 10 cents. <br><br>  The next place of potential error was the voltage divider.  Although it seemed to me strange that the resistors from Bourns by ¬± 0.1% float so that the data has an error of up to 20% and this error is non-linear.  Carried out the same experiment: a multimeter measured the voltage after the divider, and the input voltage changed in steps of 0.5V and as a result, the divider coefficient was also tightly fixed at 22.2768. <br><br>  At this point, the beginning to become interesting.  There remained one component in which I could doubt - this is an operational amplifier LMV611MFX.  This OU is included as a voltage follower.  The voltage BEFORE and AFTER it was the same up to 4 decimal places.  Strange ... According to the datasheet, it is not bad and it is all the same TI, he doubted, but decided to check, because  This particular OS has never been used.  Just in case, my favorite and tested in a heap of projects OPA320, which I have in coils, soldered in its place and it showed the same result. <br><br>  There remained the last component - MK, namely its ADC.  Over the years, the use of STM, I used to trust their products, the more I take only the originals, so I thought the last thing at MK.  The first thing I thought I forgot to do the calibration or did wrong.  Got into the reference manual, they demanded not only cutting the ADC by writing zero to the <i>ADEN</i> bit, but also <i>setting</i> 1 to the <i>ADDIS</i> bit and 0 to the <i>DMAEN</i> bit.  The last 2 steps were not taken, I usually cut down the ADC and everything works well, eventually corrected a piece of code with calibration: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* disable ADC */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ADC1-&gt;CR &amp; ADC_CR_ADEN) { ADC1-&gt;CR |= ADC_CR_ADDIS; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ADC1-&gt;CR &amp; ADC_CR_ADEN) {} } <span class="hljs-comment"><span class="hljs-comment">/* calibrate ADC */</span></span> ADC1-&gt;CR |= ADC_CR_ADCAL; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(ADC1-&gt;CR &amp; ADC_CR_ADCAL) {} <span class="hljs-comment"><span class="hljs-comment">/* reset configuration */</span></span> ADC1-&gt;CFGR2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* enable device */</span></span> ADC1-&gt;CR = ADC_CR_ADEN; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!(ADC1-&gt;ISR &amp; ADC_ISR_ADRDY));</code> </pre><br>  Unfortunately it did not help and decided to conduct the following experiment ... The coefficients have already been checked and they are 100% correct, so I will apply voltage from the laboratory power supply to the input, change it and output the raw ADC measurement results to the seven-segment indicator, and then compare it with what should there to be with what really measured.  As a result, I obtained the following results: <br><br><img src="https://habrastorage.org/webt/ib/it/nr/ibitnrlbtgj1s7n1dafdlqv5wwc.png"><br><br>  As you can see the theoretical graph has excellent linearity, since  not tied to the gland.  The graph based on real data is also almost linear with minimal deviations.  In fact, a graph with real data can be combined with a theoretical graph by parallel transfer to a certain constant.  If you speak the language of electronics - <b>the ADC has an offset!</b> <br><br>  According to the data on the basis of which the graphs were built, I found out that the ADC has an offset at different points of 71 ... 73 steps.  This was the problem, and the ‚Äúnonlinearity‚Äù seemed to me because the shift to 71 steps at 10V is about 14%, and at 30V it is already 4%.  That is, if we plot the deviations in%, the dependence will have an exponential form, but such a graph is not interesting. <br><br>  It was decided that in order to refine the results, try to enter into the formula another variable that will shift my values ‚Äã‚Äãupwards and have the following form: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> offsetVoltage = <span class="hljs-number"><span class="hljs-number">72</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> voltageReference = <span class="hljs-number"><span class="hljs-number">0.0008</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> voltageDivider = <span class="hljs-number"><span class="hljs-number">22.2765</span></span>; adcVoltageResult = ((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(adcData+offsetVoltage))*voltageReference*voltageDivider;</code> </pre><br>  After these simple manipulations, my device began to accurately measure the voltage and the data stopped floating.  Until that moment, it was lying at <i>72 * 0.0008V * 22.2768 = 1.28V</i> , which in the case of monitoring one battery is very critical.  Of course, a lead battery does not explode like Li-ion, but it still quickly fails, especially if it is not constantly discharged to 10.2V, but to 8.92V. <br><br>  Here is such a small story about a small piece of iron.  I hope someone this material will be useful, or at least it will be just interesting to read.  Be careful with all these ADCs and other filth :)) <br><br>  <b>UPD.</b>  <a href="https://habr.com/ru/users/olartamonov/" class="user_link">olartamonov</a> very diligently asked not to fool the people and use the calibration code from the reference manual - he made the change with pleasure.  Unfortunately, in my case this did not change the situation and the displacement did not disappear anywhere.  Probably a problem in the chip itself.  <s>on instructions from the State Department threw counterfeit products</s> <br><br><h2>  Competition </h2><br>  <a href="https://www.pcbway.com/">PCBway</a> comrades <a href="https://www.pcbway.com/">have</a> a <a href="https://www.pcbway.com/project/icansolder.html">competition among technical projects</a> , anyone can take part.  The rules are simple.  Printed circuit boards for your project will do for free.  And the most important prizes!  These are a few green notes with American gentlemen on your paypal + virtual currency to which you can order printed circuit boards + honor and respect + the opportunity to get a job offer somewhere outside the CIS :)) I especially recommend students to participate, the technical level is not too high Although there are very strong projects from the experience of past competitions, so a ‚Äústrong‚Äù DIY-box can easily get into winners! <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sp/jl/pd/spjlpdnbj4-ymwvgchsdtzzmlk4.png"></div></div><p>Source: <a href="https://habr.com/ru/post/448202/">https://habr.com/ru/post/448202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448188/index.html">Time Capsule: HP iPaq h1940 out of the box. What does a PDA from the 2000s do?</a></li>
<li><a href="../448190/index.html">Visual logic editor for Unity3d. Part 1</a></li>
<li><a href="../448192/index.html">Why do we need the production of AR and VR</a></li>
<li><a href="../448194/index.html">The candidate's experience in recruiting software developers. Part 2</a></li>
<li><a href="../448196/index.html">The future (or secret present) of plasma engines or how to achieve 27 max moves in the atmosphere</a></li>
<li><a href="../448206/index.html">Modular development or the way there, not back</a></li>
<li><a href="../448208/index.html">20, 100, 3, 19 - InoThings in numbers</a></li>
<li><a href="../448210/index.html">A satellite cannon, a blaster and a sun-walker: funny and paradoxical projects</a></li>
<li><a href="../448212/index.html">Chinese AIBUS protocol and laboratory chemical reactor</a></li>
<li><a href="../448218/index.html">New MFP security level: imageRUNNER ADVANCE III</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>