<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Device and mechanism of work of Prometheus Operator in Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is based on our internal documentation for DevOps engineers, explaining how Prometheus works under the control of Prometheus Operator in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Device and mechanism of work of Prometheus Operator in Kubernetes</h1><div class="post__text post__text-html js-mediator-article">  This article is based on our internal documentation for DevOps engineers, explaining how Prometheus works under the control of Prometheus Operator in deployed and maintained Kubernetes clusters. <br><br><img src="https://habrastorage.org/webt/59/ed/da/59eddad4b755b207850583.png" alt="image"><br><br>  At first glance, <a href="https://prometheus.io/">Prometheus</a> may seem like a rather complicated product, but, like any well-designed system, it consists of explicit functional components and actually does three things: a) collects metrics, b) executes the rules, c) saves the result to the base data time series (time series).  The article is devoted not so much to Prometheus itself, as to the integration of this system with Kubernetes, for which we actively use an auxiliary tool called <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a> .  But it‚Äôs still necessary to start from Prometheus itself ... <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Prometheus: what is he doing? </h2><br>  So, if you dwell more on the first two functions of Prometheus, then they work as follows: <br><br><ul><li>  For each monitoring <i>target (target)</i> , each <code>scrape_interval</code> , an HTTP request is made to this target.  In response, you get metrics in <a href="">your own format</a> , which are saved to the database. </li><li>  Each <code>evaluation_interval</code> rules are processed, based on which: <ul><li>  or send alerts, </li><li>  or new metrics are written (to themselves in the database) (the result of the rule execution). </li></ul></li></ul><br><h2>  Prometheus: how is it configured? </h2><br>  The Prometheus server has <i>config</i> and <i>rule files</i> ( <i>rule files</i> ). <br><br>  The <i>config</i> has the following sections: <br><br><ul><li>  <code>scrape_configs</code> - settings for finding targets for monitoring (for more details, see the next section); </li><li>  <code>rule_files</code> - the list of directories where the rules are to be loaded: <br><br><pre> <code class="plaintext hljs">rule_files: - /etc/prometheus/rules/rules-0/* - /etc/prometheus/rules/rules-1/*</code> </pre> </li><li>  <code>alerting</code> - <code>alerting</code> search settings to which alerts are sent.  The section is very similar to <code>scrape_configs</code> with the difference that the result of its work is a list of <i>endpoints</i> to which Prometheus will send alerts. </li></ul><br><h2>  Prometheus: where does the list of goals come from? </h2><br>  The general algorithm of Prometheus operation is as follows: <br><br><img src="https://habrastorage.org/webt/3c/d9/0i/3cd90i6ri2r8dwzluwj8xlnoxxu.png"><br><br><ol><li>  Prometheus reads the <code>scrape_configs</code> section, according to which it configures its internal <i>Service Discovery</i> mechanism. </li><li>  The <i>Service Discovery</i> mechanism interacts with the Kubernetes API (mainly to obtain <i>endpoints</i> ). </li><li>  Based on data from Kubernetes, the <i>Service Discovery</i> engine updates <i>Targets</i> (list of targets). </li></ol><br>  In <code>scrape_configs</code> is a list of <i>scrape</i> <code>scrape_configs</code> (this is an internal concept of Prometheus), each of which is defined as follows: <br><br><pre> <code class="plaintext hljs">scrape_configs: #   - job_name: kube-prometheus/custom/0 #   scrape job' #    Service Discovery scrape_interval: 30s #     scrape_timeout: 10s #    metrics_path: /metrics # path,   scheme: http # http  https #  Service Discovery kubernetes_sd_configs: # ,  targets    Kubernetes - api_server: null #   API-   #  (    ) role: endpoints # targets   endpoints namespaces: names: #  endpoints    namespaces - foo - baz #  "" ( enpoints ,  ‚Äî )  "" # (     ‚Äî    ) relabel_configs: #     prometheus_custom_target, #   service,   endpoint - source_labels: [__meta_kubernetes_service_label_prometheus_custom_target] regex: .+ #      action: keep #     - source_labels: [__meta_kubernetes_endpoint_port_name] regex: http-metrics # ,    http-metrics action: keep #   job,    prometheus_custom_target #  service,     "custom-" # #  job ‚Äî   Prometheus.    , #     target   targets,     #   ,    targets (    #   rules  dashboards) - source_labels: [__meta_kubernetes_service_label_prometheus_custom_target] regex: (.*) target_label: job replacement: custom-$1 action: replace #   namespace - source_labels: [__meta_kubernetes_namespace] regex: (.*) target_label: namespace replacement: $1 action: replace #   service - source_labels: [__meta_kubernetes_service_name] regex: (.*) target_label: service replacement: $1 action: replace #   instance (    ) - source_labels: [__meta_kubernetes_pod_name] regex: (.*) target_label: instance replacement: $1 action: replace</code> </pre> <br>  Thus, Prometheus itself tracks: <br><br><ul><li>  adding and deleting <b>pods</b> (when adding / removing pods Kubernetes changes endpoints, and Prometheus sees and adds / deletes targets); </li><li>  adding and removing <b>services</b> (more precisely, endpoints) in the specified namespaces <i>(namespaces)</i> . </li></ul><br>  <b>Changing the config</b> is required in the following cases: <br><br><ul><li>  you need to add a new <i>scrape config</i> (usually this is a new kind of services that need to be monitored); </li><li>  need to change the list of namespaces. </li></ul><br>  Having dealt with the basics of Prometheus, we turn to its ‚Äúoperator‚Äù - a special auxiliary component for Kubernetes, which simplifies the deployment and operation of Prometheus in the realities of the cluster. <br><br><h2>  Prometheus Operator: what is he doing? </h2><br>  For the notorious ‚Äúsimplification‚Äù, firstly, in Prometheus Operator, using CRD ( <a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/">Custom Resource Definitions</a> ), three resources are defined: <br><br><ol><li>  <a href=""><code>prometheus</code></a> - defines the installation (cluster) of Prometheus; </li><li>  <a href=""><code>servicemonitor</code></a> - defines how to monitor a set of services (ie, collect their metrics); </li><li>  <a href=""><code>alertmanager</code></a> - defines a cluster of Alertmanagers (we do not use them, because we send metrics directly to our notification system, which receives, aggregates and ranks data from a variety of sources - including, integrates with Slack and Telegram). </li></ol><br>  Secondly, the operator monitors the <code>prometheus</code> resources and generates for each of them: <br><br><ol><li>  <i>StatefulSet</i> (with Prometheus itself); </li><li>  <i>Secret</i> with <code>prometheus.yaml</code> (Prometheus config) and <code>configmaps.json</code> (config for <code>prometheus-config-reloader</code> ). </li></ol><br>  Finally, the operator also monitors the <code>servicemonitor</code> resources and <i>ConfigMaps</i> with the rules, and on their basis updates the configs <code>prometheus.yaml</code> and <code>configmaps.json</code> (they are kept secret). <br><br><h3>  What is it with Prometheus? </h3><br>  Pod consists of two containers: <br><br><ol><li>  <code>prometheus</code> - Prometheus itself; </li><li>  <code>prometheus-config-reloader</code> is a <a href="https://github.com/coreos/prometheus-operator/tree/master/contrib/prometheus-config-reloader">binding</a> that monitors changes to <code>prometheus.yaml</code> and, if necessary, causes a reload of the Prometheus configuration (with a special HTTP request ‚Äî see below for details), and also monitors <i>ConfigMaps</i> with the rules (they are specified in <code>configmaps.json</code> ‚Äî see more below) and downloads them as needed and restarts Prometheus. </li></ol><br><img src="https://habrastorage.org/webt/4r/yz/0d/4ryz0dyh-w5sci9tvdosvmheruw.png"><br><br>  Pod uses three volumes <i>(volumes)</i> : <br><br><ol><li>  <code>config</code> - the mounted secret (two files: <code>prometheus.yaml</code> and <code>configmaps.json</code> ).  Connected to both containers; </li><li>  <code>rules</code> - <code>emptyDir</code> , which fills <code>prometheus-config-reloader</code> , and reads <code>prometheus</code> .  Connected to both containers, but in <code>prometheus</code> - in read-only mode; </li><li>  <code>data</code> - Prometheus data.  Mounted only in <code>prometheus</code> . </li></ol><br><h2>  How are Service Monitors handled? </h2><br><img src="https://habrastorage.org/webt/jt/e3/6l/jte36lgije_r-o9sne-jyiddklm.png"><br><br><ol><li>  Prometheus Operator reads <i>Service Monitors</i> (and also monitors their addition / deletion / modification).  Which <i>Service Monitors</i> are specified in the <code>prometheus</code> resource <code>prometheus</code> (see the <a href="">documentation</a> for details). </li><li>  For each <i>Service Monitor</i> , if it <b>does not</b> specify a specific list of namespaces (that is, it specifies <code>any: true</code> ), Prometheus Operator computes (referring to the Kubernetes API) a list of namespaces in which there are Services matching the labels specified in the <i>Service Monitor</i> . </li><li>  Based on the read <code>servicemonitor</code> resources (see the <a href="">documentation</a> ) and on the basis of the calculated namespaces, Prometheus Operator generates a part of the config (section <code>scrape_configs</code> ) and saves the config to the appropriate secret. </li><li>  By the standard means of Kubernetes, the data from the secret comes in under (the file <code>prometheus.yaml</code> updated). </li><li>  The change in the file is noticed by <code>prometheus-config-reloader</code> , which via HTTP sends a request to Prometheus to reboot. </li><li>  Prometheus re-reads the config and sees changes in <code>scrape_configs</code> , which it processes already according to its work logic (see details above). </li></ol><br><h2>  How are ConfigMaps handled with the rules? </h2><br><img src="https://habrastorage.org/webt/uu/_i/ih/uu_iih7jsxvvgxyorfzejiqu2qm.png"><br><br><ol><li>  Prometheus Operator monitors <i>ConfigMaps</i> matching the <code>ruleSelector</code> specified in the <code>prometheus</code> resource. </li><li>  If a new (or existing) <i>ConfigMap has appeared</i> , Prometheus Operator updates <code>prometheus.yaml</code> , after which the logic exactly corresponding to the <i>Service Monitors</i> processing (see above) is triggered. </li><li>  As in the case of adding / removing <i>ConfigMap</i> , and when changing the contents of <i>ConfigMap</i> , Prometheus Operator updates the file <code>configmaps.json</code> (it contains a list of <i>ConfigMaps</i> and their checksums). </li><li>  By the standard means of Kubernetes, the data from the secret comes in under (the file <code>configmaps.json</code> updated). </li><li>  A file change is noticed by <code>prometheus-config-reloader</code> , which downloads the changed <i>ConfigMaps</i> to the <code>rules</code> directory (this is <code>emptyDir</code> ). </li><li>  The same <code>prometheus-config-reloader</code> sends an HTTP request to Prometheus to reboot. </li><li>  Prometheus rereads the config and sees the changed rules. </li></ol><br><h2>  That's all! </h2><br>  In more detail about how we use Prometheus (and not only) for monitoring in Kubernetes, I <a href="http://rootconf.ru/moscow-rit/2018/abstracts/3507">plan to tell</a> at the <a href="http://rootconf.ru/moscow-rit/2018">RootConf 2018</a> conference what will be held on May 28 and 29 in Moscow - come to listen and talk. <br><br><h2>  PS </h2><br>  Read also in our blog: <br><br><ul><li>  ‚Äú <a href="https://habr.com/company/flant/blog/412901/">Monitoring and Kubernetes (review and video of the report)</a> ‚Äù; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/326414/">Operators for Kubernetes: how to run stateful applications</a> ‚Äù; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/340728/">Monitoring with Prometheus at Kubernetes in 15 minutes</a> ‚Äù; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/339724/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/339724/">Part 4: SoundCloud (by Prometheus)</a> ‚Äù; </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/341386/">Introducing loghouse - an open source system for working with logs in Kubernetes</a> ‚Äù; </li><li>  " <a href="https://habrahabr.ru/company/flant/blog/331188/">Our experience with Kubernetes in small projects</a> " <i>(video of the report, which includes an introduction to the technical device Kubernetes)</i> ; </li><li>  " <a href="https://habrahabr.ru/company/flant/blog/341760/">Infrastructure with Kubernetes as an affordable service</a> ." </li></ul></div><p>Source: <a href="https://habr.com/ru/post/353410/">https://habr.com/ru/post/353410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353400/index.html">Internship retrospective</a></li>
<li><a href="../353402/index.html">Flappy Bird: - Let's go</a></li>
<li><a href="../353404/index.html">The book "C ++ 17 STL. Standard Template Library ¬ª</a></li>
<li><a href="../353406/index.html">How I pumped the skills of personal effectiveness</a></li>
<li><a href="../353408/index.html">Scientific programming: part 1</a></li>
<li><a href="../353412/index.html">What is frozen on feature freeze</a></li>
<li><a href="../353414/index.html">Analysis of the main concepts of concurrency</a></li>
<li><a href="../353416/index.html">NumPy in Python. Part 2</a></li>
<li><a href="../353418/index.html">Improving performance through access control</a></li>
<li><a href="../353422/index.html">Three-dimensional engine on Excel formulas for dummies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>