<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB Replication on Amazon EC2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="system.indexes 


- Foreword 
- Configure Amazon EC2 
- Install MongoDB 
- Replication setup 
- What to read 
 local.abstract 
 In this article, I wil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB Replication on Amazon EC2</h1><div class="post__text post__text-html js-mediator-article"><h4>  system.indexes </h4><br><ul><li>  Foreword </li><li>  Configure Amazon EC2 </li><li>  Install MongoDB </li><li>  Replication setup </li><li>  What to read </li></ul><br><h4>  local.abstract </h4><br>  In this article, I will talk about how to organize MongoDB replication based on Amazon EC2 as painlessly as possible.  Undoubtedly, there is excellent documentation on how to work with Amazon EC2, and how to configure MongoDB in general, and replication in particular.  But, as you know, the devil lives in trifles.  And in this article, I will highlight those "little things" that most bothered me. <br><a name="habracut"></a><br><h4>  {step: 1, title: "Amazon EC2 configure", devilCount: 2} </h4><br>  Let's start from the beginning - setting up the instances. <br><br>  First of all, you need to create two privacy groups: for web-instances and for database instances. <br>  For web instances, let's open access for SSH, HTTP and HTTPS: <br><img src="https://habrastorage.org/getpro/habr/post_images/678/3b0/762/6783b07620791accf7a44f6fe8701790.png"><br><br>  For db-instances we will open all the same access via SSH, plus access to port 27017 for web and db privacy groups: <br><img src="https://habrastorage.org/getpro/habr/post_images/f91/36e/18f/f9136e18f24190cae86c65b14d4cbb98.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now we can run the instances themselves: one small-instance for the web-application, two large-and one micro-instance for the database.  I chose Ubuntu Server 12 as Amazon Machine Image (AMI). Important: for MongoDB replication to work, a prerequisite is an odd number of instances.  To this end, we will use the 3rd - micro instance - as an arbitrator.  About what the arbitrator, I will tell below.  Of course, we could just run 5, 7, or 2n + 1 large instances.  But with this example, I want to show a good version of how to minimize the cost of Amazon EC2, and once again focus on the fact that there must be an odd number of instances in replication. <br><br>  There is one more unobvious, but significant enough nuance - the dynamic IP addresses of the instances.  Accordingly, tied to them when setting up replication is not the most ideal option.  It is better for these purposes to use aliases that are configured in the / etc / hosts file.  On each instance we will bring the hosts file to something like this: <br><pre><code class="bash hljs">127.0.0.1 db1 localhost 10.40.120.30 db1 10.40.120.31 db2 10.40.120.32 db3</code> </pre> <br>  Now we have ready-to-use instances. <br><br><h4>  {step: 2, title: "MongoDB install", devilCount: 1} </h4><br>  Let's start installing MongoDB.  The installation process is perfectly described in the official MongoDB manual, so we follow its instructions clearly.  Create the mongo_install.bash file and write the following script into it: <br><pre> <code class="bash hljs">apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen"</span></span> | tee -a /etc/apt/sources.list.d/10gen.list apt-get -y update apt-get -y install mongodb-10gen</code> </pre><br>  We execute our script: <pre> <code class="bash hljs">sudo bash ./mongo_install.bash</code> </pre><br>  If everything went well, we will see the PID of the MongoDB running: <pre> <code class="bash hljs">mongodb start/running, process 2368</code> </pre><br>  It now remains to run the mongod process: <pre> <code class="bash hljs">sudo service mongodb start</code> </pre><br>  A little trick at last: in order not to go through such an agonizing and monotonous way of installing software on each instance, you can use the functionality of Amazon EC2 Images. <br><br><h4>  {step: 3, title: "Replication", devilCount: 2} </h4><br>  Here we come to the main point - setting up replication.  First, in the configuration files (/etc/mongodb.conf) on all db instances, we define the replSet parameter.  This parameter should contain the replication name: <pre> <code class="bash hljs">replSet = myproject</code> </pre><br>  After that, restart the service: <pre> <code class="bash hljs">sudo service mongodb restart</code> </pre><br>  Next, connect to the Monge team <pre> <code class="bash hljs">mongo</code> </pre><br>  We initiate a remark: <pre> <code class="bash hljs">rs.initiate()</code> </pre><br>  Add the second instance to our replication: <pre> <code class="bash hljs">rs.add(<span class="hljs-string"><span class="hljs-string">"db2:27017"</span></span>)</code> </pre><br>  The third instance, and this is important, is added as an arbitrator: <pre> <code class="bash hljs">rs.addArb(<span class="hljs-string"><span class="hljs-string">"db3:27017"</span></span>)</code> </pre><br>  The arbitrator does not keep his copy of the database.  He does not participate in writing or reading data.  Designed exclusively for voting for Primary.  This is the reason for the fact that we can run the arbiter on the minimum hardware. <br><br>  Let's see the current status of the replica: <br><pre> <code class="bash hljs">mydb:PRIMARY&gt; rs.<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>() { <span class="hljs-string"><span class="hljs-string">"set"</span></span> : <span class="hljs-string"><span class="hljs-string">"myproject"</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-04T12:17:42Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"myState"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"members"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 0, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"db1:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"health"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"stateStr"</span></span> : <span class="hljs-string"><span class="hljs-string">"PRIMARY"</span></span>, <span class="hljs-string"><span class="hljs-string">"uptime"</span></span> : 1139012, <span class="hljs-string"><span class="hljs-string">"optime"</span></span> : Timestamp(1359738450000, 12), <span class="hljs-string"><span class="hljs-string">"optimeDate"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-01T17:07:30Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"self"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"db2:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"health"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"stateStr"</span></span> : <span class="hljs-string"><span class="hljs-string">"SECONDARY"</span></span>, <span class="hljs-string"><span class="hljs-string">"uptime"</span></span> : 1138953, <span class="hljs-string"><span class="hljs-string">"optime"</span></span> : Timestamp(1359738450000, 12), <span class="hljs-string"><span class="hljs-string">"optimeDate"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-01T17:07:30Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"lastHeartbeat"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-04T12:17:42Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"pingMs"</span></span> : 0 }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"db3:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"health"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"state"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"stateStr"</span></span> : <span class="hljs-string"><span class="hljs-string">"SECONDARY"</span></span>, <span class="hljs-string"><span class="hljs-string">"uptime"</span></span> : 442498, <span class="hljs-string"><span class="hljs-string">"optime"</span></span> : Timestamp(1359738450000, 12), <span class="hljs-string"><span class="hljs-string">"optimeDate"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-01T17:07:30Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"lastHeartbeat"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2013-02-04T12:17:40Z"</span></span>), <span class="hljs-string"><span class="hljs-string">"pingMs"</span></span> : 0 } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : 1 }</code> </pre><br>  You can find out which field is responsible for what here: <a href="http://docs.mongodb.org/manual/reference/replica-status/">docs.mongodb.org/manual/reference/replica-status/#fields</a> <br><br>  Check the config: <br><pre> <code class="bash hljs">mydb:PRIMARY&gt; rs.<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span></span>() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"myproject"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span> : 12, <span class="hljs-string"><span class="hljs-string">"members"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 0, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db1:27017"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db2:27017"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db3:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"arbiterOnly"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ] }</code> </pre><br>  We see that everything looks exactly as we conceived.  Hooray! <br><br>  And for dessert, one more thing.  In the settings of the replica, each participant, among others, has a priority property.  By default, it is 1 and, as the default value, is not displayed in the config.  This value affects the likelihood that a member will be elected Primary.  Let's make db1 be guaranteed Primary (well, for example, it has more memory): <br><pre> <code class="bash hljs">config = rs.config() config.members[0].priority = 2 rs.reconfig(config)</code> </pre><br>  Now the config will look like this: <br><pre> <code class="bash hljs">mydb:PRIMARY&gt; rs.<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span></span>() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"myproject"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span> : 12, <span class="hljs-string"><span class="hljs-string">"members"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 0, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db1:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"priority"</span></span> : 2 }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 1, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db2:27017"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : 2, <span class="hljs-string"><span class="hljs-string">"host"</span></span> : <span class="hljs-string"><span class="hljs-string">"db3:27017"</span></span>, <span class="hljs-string"><span class="hljs-string">"arbiterOnly"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ] }</code> </pre><br>  <a href="http://habrahabr.ru/post/168691/">A very important note</a> from <a href="http://habrahabr.ru/users/stampit/" class="user_link">StamPit</a> : <br>  Problem: The size of the oplog is not specified.  For 64bit systems, the default is 5% of the available disk space, but not less than 1Gb.  If the disk is large and the average activity of insert / update is to limit the size in the config, 2000Mb is enough: <br><pre> <code class="bash hljs">oplogSize = 2000</code> </pre><br>  If there is not much data, and the number of insert / update is not too large, you can slightly reduce disk activity as follows: <br>  1) Disable preallocate noprealloc = true <br>  2) Reduce the size of the files (both data files and log files will decrease) smallfiles = true <br><br>  Perhaps this and all that is needed in order to set up replication Mongi based on Amazon EC2.  If necessary, you can easily add new instances to this configuration. <br><br><h4>  local.links </h4><br><ol><li>  Amazon EC2 <a href="http://aws.amazon.com/documentation/ec2">aws.amazon.com/documentation/ec2</a> </li><li>  MongoDb Installation <a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu/">docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu</a> </li><li>  MongoDB <a href="http://docs.mongodb.org/manual/tutorial/getting-started">docs.mongodb.org/manual/tutorial/getting-started</a> </li><li>  MongoDb Replication <a href="http://docs.mongodb.org/manual/replication">docs.mongodb.org/manual/replication</a> </li><li>  MongoDb Replica Set Arbiters <a href="http://docs.mongodb.org/manual/administration/replica-sets/">docs.mongodb.org/manual/administration/replica-sets/#replica-set-arbiters</a> </li><li>  MongoDb Replica Set Configuration <a href="http://docs.mongodb.org/manual/reference/replica-configuration/">docs.mongodb.org/manual/reference/replica-configuration</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/168691/">https://habr.com/ru/post/168691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168681/index.html">Interactive infographics with CSS and SVG animations</a></li>
<li><a href="../168683/index.html">The next zero-day vulnerabilities in various routers</a></li>
<li><a href="../168685/index.html">Security and Huawei</a></li>
<li><a href="../168687/index.html">LibreOffice 4.0.0</a></li>
<li><a href="../168689/index.html">dot42 - C # compiler for Dalvik Runtime</a></li>
<li><a href="../168693/index.html">Opening of the IT-club MODX in Yekaterinburg</a></li>
<li><a href="../168695/index.html">IOS 6.1.1 beta released</a></li>
<li><a href="../168697/index.html">Setting up Inkscape to work with black and white graphics</a></li>
<li><a href="../168699/index.html">How to: AD + MSSQL to SSRS</a></li>
<li><a href="../168701/index.html">Review of the ASUS Zenbook UX31A Touch Ultrabook Touch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>