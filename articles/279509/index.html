<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programmatic process lookup by name in QNX 6.5.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Periodically, when developing applications in QNX OS 6.5 QNX OS, the problem arises to find the process knowing only its symbolic name, or find out an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programmatic process lookup by name in QNX 6.5.0</h1><div class="post__text post__text-html js-mediator-article">  Periodically, when developing applications in QNX OS 6.5 QNX OS, the problem arises to find the process knowing only its symbolic name, or find out any information about the process, or collect some statistics about the process.  This may be needed for a wide range of tasks. <br><br><img src="http://www.adzuna.ru/blog/wp-content/uploads/2014/08/24.04.jpg" alt="image"><br><br>  This task is platform-specific and a single cross-platform solution is available only in the form of third-party libraries. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we are implementing a small ‚Äúwrapper‚Äù class that allows you to get information about the process, knowing only its name.  We will use YaP C ++. <br><a name="habracut"></a><br>  To perform the task, you can use the system call ‚Äúsystem‚Äù, calling the utility for working with the processes ‚Äúpidin‚Äù, processing the output of this utility.  But, this decision interests us a little. <br><br>  So let's start with the fact that in QNX the primary organizational structure (as opposed to, for example, Linux) is the flow.  The kernel deals exclusively with the layout of threads.  Processes are containers containing one or more threads.  All work with the processes submitted to the process manager procnto. <br><br>  This resource manager creates a virtual directory / proc /.  Let's try to display the contents of this directory. <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ls /proc/ total 41 dr-xr-xr-x 2 root root 1 Sep 04 22:37 1 dr-xr-xr-x 2 root root 1 Sep 04 22:37 110611 dr-xr-xr-x 2 root root 1 Sep 04 22:37 126996 dr-xr-xr-x 2 root root 1 Sep 04 22:37 2 dr-xr-xr-x 2 root root 1 Sep 04 22:37 20489 drwxr-xr-x 2 root root 50 Jul 09 2010 boot nrw------- 1 root root 0 Sep 04 18:15 dumper dr-xr-xr-x 4 root root 1 Sep 04 22:37 self</span></span></code> </pre> <br>  I have slightly reduced the output of the utility, to save space.  You may notice that there are in the output: <br><br>  1) PID directories of running processes <br>  2) Virtual directory "boot", which stores the files "compiled" in the OS image. <br>  3) The dumper file used by the core dump utility <br>  4) The ‚Äúself‚Äù directory is similar to directories with a PID, but provides data for the current process (in our case ls). <br><br>  In directories with a PID, there is a single file called ‚Äúas‚Äù that cannot be read or written by regular QNX utilities working with files.  But, on the other hand, these files (in fact, the procnto manager) can be accessed using the devctl system call.  Full details of working with the procnto manager are presented <a href="http://www.qnx.com/developers/docs/6.5.0_sp1/index.jsp%3Ftopic%3D%252Fcom.qnx.doc.neutrino_cookbook%252Fs3_procfs.html">here</a> . <br><br>  We will try to use this in the class we are developing.  As you can see, the name is obtained separately from the rest of the devctl information.  Therefore, we define two private fields in the class - a field that stores the process name and system information (system information about the process is stored in a structure of the type ‚Äúdebug_process_t‚Äù). <br><br>  So, for the beginning we will define the public interface of our class.  Let us have information about a specific process stored in a separate class QNXProcInfo.  Since this class corresponds to one specific process, it is quite logical that its constructor takes in the pid of the process (unlike the name, pid is unique for each process launched in the system).  To begin, let him learn to give us the name of the process to which he corresponds and print out in a text form the flow of information about himself. <br><br>  Then the heading of our class will look something like this: <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QNXProcInfo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: QNXProcInfo(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pid); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrintInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::ostream &amp;out = </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">cout</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">debug_process_t</span></span> GetInfo(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>* name; <span class="hljs-keyword"><span class="hljs-keyword">debug_process_t</span></span> info; };</code> </pre><br>  To search for a process, we define another class QNXProcMgr.  It is required to search for processes by name and by the transferred function to the comparator. <br><br>  The title of this class will look something like this: <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QNXProcMgr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> QNXProcInfo* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pname)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> QNXProcInfo* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*comparator)(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">debug_process_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> info))</span></span></span></span>; };</code> </pre><br>  We proceed to the implementation. <br><br>  To obtain information about the process name, we use a custom name structure, which contains the procfs_debuginfo structure and a free buffer in which the process name will be written. <br><br>  The code will look something like this: <br><br><pre> <code class="cpp hljs">QNXProcInfo::QNXProcInfo(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pid) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> paths[PATH_MAX]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> procfs_debuginfo info; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buff [PATH_MAX]; } name; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(paths, <span class="hljs-string"><span class="hljs-string">"/proc/%d/as"</span></span>, pid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((fd = open (paths, O_RDONLY)) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> Add error handler here } devctl(fd, DCMD_PROC_MAPDEBUG_BASE, &amp;name, sizeof(name), 0); this-&gt;name = new string(name.info.path); devctl(fd, DCMD_PROC_INFO, &amp;info, sizeof(info), 0); close (fd); }</span></span></code> </pre><br>  As you can see, to get the name, we use the devctl command DCMD_PROC_MAPDEBUG_BASE, upon receipt of which the procnto fills the structure passed to it and writes the name to the path buffer. <br><br>  For other information, the devctl command DCMD_PROC_INFO is used, upon receipt of which the procnto fills in the info structure, which we pass to it as a parameter. <br><br>  The functions of receiving the name and displaying information about the process look quite trivial and will not be described.  It is only necessary to note that information about the fields of the structure debug_process_t can be found <a href="http://www.qnx.com/developers/docs/6.5.0_sp1/index.jsp%3Ftopic%3D%252Fcom.qnx.doc.neutrino_cookbook%252Fs3_procfs.html">here</a> . <br><br>  Let us consider the functionality of the class responsible for finding the process. <br><br>  Here is the code responsible for finding the process by name: <br><br><pre> <code class="cpp hljs"> QNXProcInfo* QNXProcMgr::Find(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pname) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirent</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirent</span></span></span><span class="hljs-class">;</span></span> DIR *dir; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pid; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name; QNXProcInfo *info; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(dir = opendir (<span class="hljs-string"><span class="hljs-string">"/proc"</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> QNXProcException(<span class="hljs-string"><span class="hljs-string">"couldn't open /proc"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((dirent = readdir(dir))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isdigit</span></span>(*dirent-&gt;d_name)) { pid = atoi(dirent-&gt;d_name); info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QNXProcInfo(pid); name = info-&gt;GetName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name == pname) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> info; } } closedir (dir); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> QNXProcException(<span class="hljs-string"><span class="hljs-string">"Process not found"</span></span>); }</code> </pre><br>  As you can see, a simple search of files in the / proc directory is used, for each of the found files (if it is a PID), a new ProcInfo object is created, which is checked for compliance with the condition, and is deleted if it is not. <br><br>  It looks like the function to search for the comparator function: <br><br><pre> <code class="cpp hljs">QNXProcInfo* QNXProcMgr::Find(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> (*comparator)(<span class="hljs-keyword"><span class="hljs-keyword">debug_process_t</span></span> info)) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirent</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirent</span></span></span><span class="hljs-class">;</span></span> DIR *dir; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pid; QNXProcInfo *info; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(dir = opendir (<span class="hljs-string"><span class="hljs-string">"/proc"</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> QNXProcException(<span class="hljs-string"><span class="hljs-string">"couldn't open /proc"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((dirent = readdir(dir))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">isdigit</span></span>(*dirent-&gt;d_name)) { pid = atoi(dirent-&gt;d_name); info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QNXProcInfo(pid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comparator(info-&gt;GetInfo())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> info; } } closedir (dir); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> QNXProcException(<span class="hljs-string"><span class="hljs-string">"Process not found"</span></span>); }</code> </pre><br>  That's all.  If necessary, the reader can expand and supplement the specified classes in accordance with their needs. <br><br>  Also, it should be noted that the code does not claim to be complete.  It does not handle some types of errors, the search algorithm is not optimally built, the search function should be able to give several QNXProcInfo objects (since several processes can correspond to one name) and much more.  But, I am sure that the reader will cope with it completely.  This article was intended only to show the direction of activity. <br><br>  Full source code available on the <a href="https://drive.google.com/file/d/0B17GYS6mQTHbeDE3VlhwNl9WZ1k/view%3Fusp%3Dsharing">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/279509/">https://habr.com/ru/post/279509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279499/index.html">My bike or how I saved my nerve cells</a></li>
<li><a href="../279501/index.html">Multi-exclusion or Want to share one interesting architectural trick</a></li>
<li><a href="../279503/index.html">Critical vulnerabilities of the BIND DNS server allow you to remotely disable it and conduct DoS attacks</a></li>
<li><a href="../279505/index.html">Setting up a repository server based on SCM-Manager under Debian</a></li>
<li><a href="../279507/index.html">Entertaining analysis of one expression with square brackets</a></li>
<li><a href="../279511/index.html">How to write an email to IT professionals: 5 tips</a></li>
<li><a href="../279513/index.html">Quick start a new application on React using nwb</a></li>
<li><a href="../279515/index.html">Use highcharts.js to create server side charts</a></li>
<li><a href="../279517/index.html">We write VoIP iOS chat on CORE AUDIO for VK Mobile Challenge contest</a></li>
<li><a href="../279519/index.html">We make beautifully "broken" pictures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>