<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home Internet: routing two (and more) providers based on Bird Routing Daemon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, many home Internet users have come across how to parallelize two or more Internet channels on a home network. 
 This problem can be solved b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home Internet: routing two (and more) providers based on Bird Routing Daemon</h1><div class="post__text post__text-html js-mediator-article">  Probably, many home Internet users have come across how to parallelize two or more Internet channels on a home network. <br>  This problem can be solved both hardware (using any cheap or expensive equipment) and software. <br>  What is the routing model to choose?  You can immediately drop RIP / OSPF / BGP, since this is the home Internet and is more than confident (in my case, it has been verified) that you will not want to do support on the provider side for free. <br>  I opted for the <a href="http://bird.network.cz/">bird</a> . <br><br>  So, the starting position: <br><ul><li>  Home router with Debian GNU / Linux 6.0.5 (squeeze) on board </li><li>  2 internet channels (ISP1 and ISP2) </li><li>  2 straight arms </li><li>  a cup of coffee </li></ul><br><a name="habracut"></a><br>  My network configuration: <br><ul><li>  eth0 - ISP1 provider: <br><ul><li>  IP: 10.10.10.106 </li><li>  Netmask: 255.255.255.0 </li><li>  Gateway: 10.10.10.1 </li></ul><br></li><li>  eth1 - Local Area Network: <br><ul><li>  IP: 192.168.254.254 </li><li>  Netmask: 255.255.255.0 </li></ul><br></li><li>  eth2 - ISP2 provider: <br><ul><li>  IP: 172.17.5.105 </li><li>  Netmask: 255.255.255.0 </li><li>  Gateway: 172.17.5.1 </li></ul><br></li></ul><br><br>  I am a fan of apt, but as it turned out, the apte is a rather outdated version of bird (1.2.5-1) and there is no multipath support. <br>  We'll have to collect it by hand.  I deliberately omit any flame beforehand, how not to turn debian into slackware. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir -p /usr/local/src/bird &amp;&amp; cd /usr/local/src/bird # wget ftp://bird.network.cz/pub/bird/bird-1.3.8.tar.gz # tar xf bird-1.3.8.tar.gz # cd bird-1.3.8 # ./configure --prefix=/usr --sysconfdir=/etc/bird --localstatedir=/var # make # make install</span></span></code> </pre> <br><br>  As it turned out, there is no startup script in Debian for sorts. <br>  We generate a start-up script (brazenly taken from the same obsolete package to the apt-e and slightly corrected) <i>/etc/init.d/bird</i> with the following content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh ### BEGIN INIT INFO # Provides: bird # Required-Start: $remote_fs $syslog # Required-Stop: $remote_fs $syslog # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 ### END INIT INFO # Author: Ond≈ôej Sur√Ω &lt;ondrej@sury.org&gt; # # PATH should only include /usr/* if it runs after the mountnfs.sh script PATH=/sbin:/usr/sbin:/bin:/usr/bin DESC="Internet routing daemon" NAME=bird DAEMON=/usr/sbin/$NAME DAEMON_ARGS="-c /etc/bird/bird.conf" #PIDFILE=/var/run/$NAME.pid SCRIPTNAME=/etc/init.d/$NAME # Exit if the package is not installed [ -x "$DAEMON" ] || exit 0 # Load the VERBOSE setting and other rcS variables . /lib/init/vars.sh # Define LSB log_* functions. # Depend on lsb-base (&gt;= 3.0-6) to ensure that this file is present. . /lib/lsb/init-functions # # Function that starts the daemon/service # do_start() { # Return # 0 if daemon has been started # 1 if daemon was already running # 2 if daemon could not be started start-stop-daemon --start --quiet --name $NAME --exec $DAEMON --test &gt; /dev/null \ || return 1 start-stop-daemon --start --quiet --name $NAME --exec $DAEMON -- \ $DAEMON_ARGS \ || return 2 # Add code here, if necessary, that waits for the process to be ready # to handle requests from services started subsequently which depend # on this one. As a last resort, sleep for some time. } # # Function that stops the daemon/service # do_stop() { # Return # 0 if daemon has been stopped # 1 if daemon was already stopped # 2 if daemon could not be stopped # other if a failure occurred start-stop-daemon --stop --quiet --retry=TERM/30/KILL/5 --name $NAME --exec $DAEMON RETVAL="$?" [ "$RETVAL" = 2 ] &amp;&amp; return 2 # Wait for children to finish too if this is a daemon that forks # and if the daemon is only ever run from this initscript. start-stop-daemon --stop --quiet --oknodo --retry=0/30/KILL/5 --name $NAME --exec $DAEMON [ "$?" = 2 ] &amp;&amp; return 2 return "$RETVAL" } # # Function that sends a SIGHUP to the daemon/service # do_reload() { # # If the daemon can reload its configuration without # restarting (for example, when it is sent a SIGHUP), # then implement that here. # start-stop-daemon --stop --signal 1 --quiet --name $NAME --exec $DAEMON return 0 } case "$1" in start) [ "$VERBOSE" != no ] &amp;&amp; log_daemon_msg "Starting $DESC" "$NAME" do_start case "$?" in 0|1) [ "$VERBOSE" != no ] &amp;&amp; log_end_msg 0 ;; 2) [ "$VERBOSE" != no ] &amp;&amp; log_end_msg 1 ;; esac ;; stop) [ "$VERBOSE" != no ] &amp;&amp; log_daemon_msg "Stopping $DESC" "$NAME" do_stop case "$?" in 0|1) [ "$VERBOSE" != no ] &amp;&amp; log_end_msg 0 ;; 2) [ "$VERBOSE" != no ] &amp;&amp; log_end_msg 1 ;; esac ;; reload|force-reload) # # If do_reload() is not implemented then leave this commented out # and leave 'force-reload' as an alias for 'restart'. # log_daemon_msg "Reloading $DESC" "$NAME" do_reload log_end_msg $? ;; restart) log_daemon_msg "Restarting $DESC" "$NAME" do_stop case "$?" in 0|1) do_start case "$?" in 0) log_end_msg 0 ;; 1) log_end_msg 1 ;; # Old process is still running *) log_end_msg 1 ;; # Failed to start esac ;; *) # Failed to stop log_end_msg 1 ;; esac ;; *) echo "Usage: $SCRIPTNAME {start|stop|restart|reload|force-reload}" &gt;&amp;2 exit 3 ;; esac</span></span></code> </pre><br><br>  The startup script is ready, we add to the auto-launch: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /etc/init.d/bird # update-rc.d bird enable update-rc.d: using dependency based boot sequencing</span></span></code> </pre><br><br>  Create a directory for the log file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /var/log/bird</span></span></code> </pre><br><br>  Now we proceed to configuring the bird itself. <br><br>  To get started, backup the original config and create a new one: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /etc/bird # mv bird.conf bird-orig.conf # :&gt; bird.conf</span></span></code> </pre><br><br>  Then open it for editing: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Logging # #  . # all  { debug, trace, info, remote, warning, error, auth, fatal, bug } # ,    2      (  ,     ): # log "/var/log/bird/debug.log" { debug }; # log "/var/log/bird/warning.log" { warning }; log "/var/log/bird/bird.log" all; # Router ID: #   IP-   ,      ( !) . router id 192.168.254.254; # # Debugging # #  : # all | off | { states, routes, filters, interfaces, events, packets } debug protocols { routes, interfaces }; # # Protocols # #  ,        (   -  eth0  eth2) protocol direct { interface "eth0", "eth2"; } # # Tables # #    #   ISP1  ISP2: table ISP_ISP1; table ISP_ISP2; #  "": table other; #  "master" -    (main). ,  main ! table master; # # Protocol 'static' # protocol static { table ISP_ISP1; description "Home internet ISP1"; check link on; preference 100; route 0.0.0.0/0 via 10.10.10.1; } protocol static { table ISP_ISP2; description "Home internet ISP2"; check link on; preference 150; route 0.0.0.0/0 via 172.17.5.1; } protocol static { table other; description "Other custom static routes"; preference 200; #    (   )  /etc/bird/static_route.d/ include "/etc/bird/static_route.d/*.conf"; } protocol static { table master; description "Common Table"; #   ,    default- route 0.0.0.0/0 multipath via 10.10.10.1 via 172.17.5.1; } # # Protocol 'kernel' # #      'debug all'.        . #    'all'  .   ,  -    ,    . # #  'persist' -   bird  ,  ,   (  "") bird. #  'learn' - ,  bird  ""  ,      #   10/11/254 (  ,   10, 11, 254). # protocol kernel { table ISP_ISP1; persist; learn; scan time 20; kernel table 10; export all; # debug all; } protocol kernel { table ISP_ISP2; persist; learn; scan time 20; kernel table 11; export all; # debug all; } protocol kernel { table master; persist; learn; scan time 20; kernel table 254; export all; # debug all; } # # Protocol 'pipe. # #   (default). #   ,     master    ,    ,   ISP_ISP1, ISP_ISP2  other. protocol pipe { table master; peer table ISP_ISP1; peer table ISP_ISP2; peer table other; import all; # debug all; }</span></span></code> </pre><br><br>  Now we create a directory for manual config files and, for example, add some routes: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /etc/bird/static_route.d/ # cat &lt;&lt; EOF &gt;/etc/bird/static_route.d/ISP1_LAN.conf route 10.0.5.0/24 via 10.10.10.1; route 175.5.25.0/27 via 10.10.10.1; #   " ", ,     IP  ISP1 EOF # cat &lt;&lt; EOF &gt;/etc/bird/static_route.d/ISP2_LAN.conf route 194.22.253.23/27 via 172.17.5.1; #   " ", ,     IP  ISP2 route 5.9.0.0/16 via 172.17.5.1; #   " ", ,     IP  ISP2 EOF</span></span></code> </pre><br><br>  That's all, bird setup is over. <br>  Now go to setting up the routing tables. <br><br>  Add tables to / etc / iproute2 / rt_tables: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat &lt;&lt; EOF &gt;&gt;/etc/iproute2/rt_tables 10 ISP1 11 ISP2 EOF</span></span></code> </pre><br><br>  Now you need to make sure that when you request from the ISP1 network - the packets go back to ISP1, and not on a different interface. <br>  To do this, add ip rule (s): <br>  To do this, create scripts iprules: <br><br>  Code /etc/network/if-up.d/iprules: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ISP1_NETWORKS="10.0.5.0/24 175.5.25.0/27" ISP2_NETWORKS="194.22.253.23/27 5.9.0.0/16" if [ "${LOGICAL}" = "eth0" ]; then for NET in ${ISP1_NETWORKS}; do ip ru a from ${NET} table ISP1 2&gt;/dev/null 1&gt;/dev/null done fi if [ "${LOGICAL}" = "eth2" ]; then for NET in ${ISP2_NETWORKS}; do ip ru a from ${NET} table ISP2 2&gt;/dev/null 1&gt;/dev/null done fi</span></span></code> </pre><br><br>  Code /etc/network/if-down.d/iprules: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ISP1_NETWORKS="10.0.5.0/24 175.5.25.0/27" ISP2_NETWORKS="194.22.253.23/27 5.9.0.0/16" if [ "${LOGICAL}" = "eth0" ]; then for NET in ${ISP1_NETWORKS}; do ip ru d from ${NET} table ISP1 2&gt;/dev/null 1&gt;/dev/null done fi if [ "${LOGICAL}" = "eth2" ]; then for NET in ${ISP2_NETWORKS}; do ip ru d from ${NET} table ISP2 2&gt;/dev/null 1&gt;/dev/null done fi</span></span></code> </pre><br><br>  Put a flag + x: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /etc/network/if-{up,down}.d/iprules</span></span></code> </pre><br><br>  Now we <s>rebuild</s> everything: <br><br>  In order not to copy the team, let's make it smarter: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># LOGICAL=eth0 /etc/network/if-up.d/iprules # LOGICAL=eth2 /etc/network/if-up.d/iprules</span></span></code> </pre><br><br>  Run the bird: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># invoke-rc.d bird start</span></span></code> </pre><br><br>  Checking: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ip r 10.0.5.0/24 via 10.10.10.1 dev eth0 proto bird 175.5.25.0/27 via 10.10.10.1 dev eth0 proto bird 194.22.253.23/27 via 172.17.5.1 dev eth2 proto bird 5.9.0.0/16 via 172.17.5.1 dev eth2 proto bird 10.10.10.0/24 dev eth0 proto kernel scope link src 10.10.10.106 172.17.5.0/24 dev eth2 proto kernel scope link src 172.17.5.105 192.168.254.0/24 dev eth1 proto kernel scope link src 192.168.254.254 default proto bird nexthop via 10.10.10.1 dev eth0 weight 1 nexthop via 172.17.5.1 dev eth2 weight 1</span></span></code> </pre><br><br>  Now <s>pull out the cord,</s> disconnect the network cable from ISP1 (eth0), see what has changed: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ip r | grep -E "(default|nexthop)" default proto bird nexthop via 10.10.10.1 dev eth0 weight 1 dead nexthop via 172.17.5.1 dev eth2 weight 1</span></span></code> </pre><br><br>  That is, if one of the providers is accidentally disconnected, the traffic will go through the other, the disabled provider will be monitored every 20 seconds (see the scan time 20 option in the kernel protocols) and will automatically remove the 'dead' when it appears. <br><br>  In conclusion: in the same way, you can add 10 providers. </div><p>Source: <a href="https://habr.com/ru/post/160047/">https://habr.com/ru/post/160047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160033/index.html">New search in Gmail</a></li>
<li><a href="../160035/index.html">Behind the Scenes of Android: Something You May Not Know</a></li>
<li><a href="../160037/index.html">Plugins for ReSharper 7.1</a></li>
<li><a href="../160039/index.html">20 years to the first smartphone in history</a></li>
<li><a href="../160043/index.html">"Lyapi" when using photos for website design</a></li>
<li><a href="../160049/index.html">JVM options. How it works</a></li>
<li><a href="../16005/index.html">Subtleties of pronunciation: Linuh or Linax</a></li>
<li><a href="../160051/index.html">Room maps appear on Google Maps</a></li>
<li><a href="../160053/index.html">I do not want to be part of your (damn) ecosystem</a></li>
<li><a href="../160057/index.html">Hayaku - write CSS faster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>