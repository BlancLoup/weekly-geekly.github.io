<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make two applications from one. Tinkoff Junior Experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, my name is Andrew and I are working on Tinkoff and Tinkoff Junior apps for the Android platform. I want to talk about how we collect two similar a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make two applications from one. Tinkoff Junior Experience</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, my name is Andrew and I are working on Tinkoff and Tinkoff Junior apps for the Android platform.  I want to talk about how we collect two similar applications from the same code base. </p><br><p><code>  ‚Äî    ,   ÃÜ  14 .       ,       (,  ),  , ,  (, ).</code> </p> <br><p><img src="https://habrastorage.org/webt/-1/po/-k/-1po-kymjlvzoyqyoe3y99fw08a.png" width="200">  . <img src="https://habrastorage.org/webt/ip/yp/ko/ipypko5-iq8wsxowwzs9v7r7n6k.png" width="200"><img src="https://habrastorage.org/webt/pa/7y/5v/pa7y5volewp8xuxjv9znokv1fqi.png" width="200"></p><br><p>  At the start of the project, we considered various options for its implementation and made a number of decisions.  It immediately became apparent that the two applications (Tinkoff and Tinkoff Junior) would have a significant portion of the common code.  We did not want to fork from the old application, and then copy the bug fixes and the new common functionality.  To work with two applications at once, we considered three options: Gradle Flavors, Git Submodules, Gradle Modules. </p><a name="habracut"></a><br><h3 id="gradle-flavors">  Gradle flavors </h3><br><p>  Many of our developers have already tried using Flavors, plus we could apply multi-dimensional (multi-dimensional flavors) for use with existing flavors. <br>  However, Flavors have one fatal flaw.  Android Studio considers the code only the code of the active flavor - that is, what lies in the main folder and in the flavor folder.  The rest of the code is considered text along with comments.  This imposes restrictions on some studio tools: search for code usage, refactoring, and others. </p><br><h3 id="git-submodules">  Git submodules </h3><br><p>  Another implementation of our idea is to use the GIT submodules: put the common code into a separate repository and connect it as a submodule to two repositories with the code of a specific application. </p><br><p>  This approach increases the complexity of working with project source code.  Also, developers would still have to work with all three repositories to make edits when changing the API of a common module. </p><br><h3 id="mnogomodulnaya-arhitektura">  Multi-module architecture </h3><br><p>  The last option is to switch to multi-module architecture.  This approach is devoid of the disadvantages that the other two have.  However, the transition to a multi-module architecture requires time spent on refactoring. </p><br><p>  At the time we started working on Tinkoff Junior, we had two modules: a small API module describing working with the server, and a large monolithic application module that focused the main part of the project code. </p><br><p><img src="https://habrastorage.org/webt/jn/wu/at/jnwuat-2xwkuarvovw0cy-hyte0.png" alt="drawing" height="300" width="300"><img src="https://habrastorage.org/webt/iv/ci/0s/ivci0s379lazzwffmjbmpbpcw4a.png" alt="drawing" height="400" width="400"><br>  As a result, we wanted to get two application modules: <em>adult</em> and <em>junior,</em> and a kind of common <em>core-</em> module.  We have identified two options: </p><br><ul><li>  Deliver the common code to the common common module.  This approach is ‚Äúmore correct‚Äù, but it takes more time.  We estimated code reuse volumes at approximately 80%. <br><img src="https://habrastorage.org/webt/03/xq/da/03xqdaunybaqagt_eoawvjyfpea.png" alt="drawing" height="400" width="400"></li><li>  Converting an application module to a library and connecting this library to thin <em>adult</em> and <em>junior</em> modules.  This option is faster, however, it will bring code to Tinkoff Junior that will never be executed. <br><img src="https://habrastorage.org/webt/_1/jw/pw/_1jwpw2tzdjv6wf1o4jm6tbqmeg.png" alt="drawing" height="300" width="300"></li></ul><br><p>  We had time in stock, and we decided to start developing the first version ( <em>common</em> module) with the condition to go to the quick version, when we‚Äôre out of time for refactoring. <br>  In the end, what happened: we moved part of the project to the <em>common</em> module, and then turned the remaining <em>application</em> module into a library.  As a result, we now have the following project structure: </p><br><img src="https://habrastorage.org/webt/eb/_g/h_/eb_gh_twasummele8nn9vwqe4a8.png" alt="drawing" height="400"><br><p>  We have modules with features, which allows us to distinguish between "adult", common or "child" code.  However, the <em>application</em> module is still quite large, and now about half of the project is stored there. </p><br><h3 id="prevraschaem-prilozhenie-v-biblioteku">  We turn application into library </h3><br><p>  In the documentation there is a simple <a href="https://developer.android.com/studio/projects/android-library.html">instruction</a> on <a href="https://developer.android.com/studio/projects/android-library.html">how</a> to turn an application into a library.  It contains four simple points and, it would seem, there should be no difficulties: </p><br><ol><li>  Open module <code>build.gradle</code> file </li><li>  Remove <code>applicationId</code> from module configuration </li><li>  At the beginning of the file, replace <code>apply plugin: 'com.android.application'</code> with <code>apply plugin: 'com.android.library'</code> </li><li>  Save changes and sync project in Android Studio ( <strong>File&gt; Sync Project with Gradle Files</strong> ) </li></ol><br><p>  However, the conversion took several days and the final diff was: </p><br><ul><li>  183 files changed </li><li>  1601 insertions (+) </li><li>  1920 deletions (-) </li></ul><br><h5 id="chto-zhe-poshlo-ne-tak">  What went wrong? </h5><br><p>  First of all, in libraries, resource identifiers are <a href="http://tools.android.com/tips/non-constant-fields">not constants</a> .  In libraries, as in applications, the <em>R.java</em> file is <em>generated</em> with a list of resource identifiers.  And in libraries, identifier values ‚Äã‚Äãare not constant.  Java does not allow making a switch by non-constant values, and all switches should be replaced with if-else. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Application int id = view.getId(); switch(id) { case R.id.button1: action1(); break; case R.id.button2: action2(); break; } // Library int id = view.getId(); if (id == R.id.button1) { action1(); } else if (id == R.id.button2) { action2(); }</span></span></code> </pre> <br><p>  Next, we encountered a packet collision. <br>  Suppose you have a library with package = <em>com.example</em> , and an application with package = <em>com.example.app</em> depends on this library.  Then in the library the class <em>com.example.R</em> will be generated, and in the application, respectively, <em>com.example.app.R</em> .  Now we will create <em>com.example.MainActivity</em> in the application, in which we will try to access the R-class.  Without an explicit import, the R-class of the library will be used, in which the application resources are not specified, but only the library resources.  However, Android Studio does not highlight the error, and when you try to go from the code to the resource, everything will be okay. </p><br><h3 id="dagger">  Dagger </h3><br><p>  We use Dagger as a framework for dependency injection. <br>  In each module containing activites, fragments and services, we have the usual interfaces, which describe <em>inject-</em> methods for these entities.  In the application modules ( <em>adult</em> and <em>junor</em> ), the <em>dagger</em> component interfaces are inherited from these interfaces.  In modules, we bring the components to the interfaces required for this module. </p><br><h4 id="multibindingi">  Multibinding </h4><br><p>  The development of our project greatly simplifies the use of multi-combining. <br>  In one of the common modules, we define the interface.  In each module of the application ( <em>adult</em> , <em>junior</em> ) we describe the implementation of this interface.  Using the <code>@Binds</code> annotation, <code>@Binds</code> indicate to Dagger that every time, instead of an interface, it is necessary to inject its concrete implementation for a child or adult application.  We also often collect a collection of interface implementations (Set or Map), while such implementations are described in different application modules. </p><br><h4 id="fleyvory">  Flavors </h4><br><p>  For different purposes, we collect several variants of the application.  The flavors described in the base module must also be described in the dependent modules.  Also, for Android Studio to work correctly, you need to select compatible build options in all modules of the project. </p><br><h3 id="vyvody">  findings </h3><br><p>  In a short time we have implemented a new application.  Now we ship the new functionality in two applications, writing it once. </p><br><p>  At the same time, we spent some time refactoring, simultaneously reducing technical debt, and switched to multi-module architecture.  Along the way, we faced restrictions from the Android SDK and Android Studio, which we successfully coped with. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/454128/">https://habr.com/ru/post/454128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454106/index.html">With me - 15 ideas that can change your life, with you - 5 minutes of attention</a></li>
<li><a href="../454110/index.html">Development of an online store to preserve the nature of Kamchatka</a></li>
<li><a href="../454112/index.html">The history of the design levels Duke Nukem (with sketches of Levelrord)</a></li>
<li><a href="../454124/index.html">The book "Learning to code in JavaScript"</a></li>
<li><a href="../454126/index.html">From daily accidents to stability: Informatica 10 through the eyes of the admin</a></li>
<li><a href="../454130/index.html">C-V2X with 5G NR support: a new paradigm of data exchange between vehicles</a></li>
<li><a href="../454132/index.html">Video surveillance on orange pi zero - cheap and not at all angry</a></li>
<li><a href="../454136/index.html">The most beautiful theorem of mathematics: Euler's identity</a></li>
<li><a href="../454138/index.html">June 10, Deworkacy - Q High-quality communication.</a></li>
<li><a href="../454140/index.html">From lawyer to tester in Yandex. The history of my internship</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>