<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made friends in bank infrastructure using ManageIQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of years ago, the main trends were automation, DevOps practices and the acceleration of the delivery of values ‚Äã‚Äãto the market. Home Credit B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made friends in bank infrastructure using ManageIQ</h1><div class="post__text post__text-html js-mediator-article"><p>  A couple of years ago, the main trends were automation, DevOps practices and the acceleration of the delivery of values ‚Äã‚Äãto the market.  Home Credit Bank decided to keep up and took a course on the development of technologies, all the more so as the open whispered whisper of users who were tired of waiting a few days to wait for new resources for their important projects rang louder on the open space. </p><br><p>  We decided to start with the process of approving applications by departments, which, as in many large companies, required time and effort.  As the first task, we chose the process of creating a virtual machine regardless of the virtualization environment.  Making a list of tasks, we realized that it would be necessary to integrate with other systems used in the infrastructure of our bank, for example, via API. </p><br><p><img src="https://habrastorage.org/webt/tt/h7/br/tth7br6euodgo1dklwgmaqhdxu4.png" alt="image"></p><a name="habracut"></a><br><p>  The most suitable solution was <a href="http://manageiq.org/">ManageIQ</a> .  This is a project that Red Hat acquired in 2012 and based on it created the commercial <a href="https://www.redhat.com/en/technologies/management/cloudforms">Red Hat CloudForms product</a> .  At the same time, ManageIQ remained in the status of an open-source product and is developing in parallel with CloudForms. </p><br><p>  ManageIQ is written in Ruby and supports a large number of different providers of virtualization, public clouds and containerization.  At the moment, we are using a version of Gaprindashvili in the High-Availability configuration in Home. </p><br><h2>  How the process has changed </h2><br><p>  Previously, each team required separate settings in its area of ‚Äã‚Äãresponsibility.  After preliminary preparation, all data was collected and sent to the administrator, who deployed and configured the virtual machine.  Then it was necessary to inform, for example, the monitoring team that a new host had appeared that needed to be added to the monitoring.  Delays in communication, workload of specialists, errors caused by the human factor, could stretch this process to several days. </p><br><p>  Having fit the whole process into ManageIQ, we got the following results: </p><br><div class="scrollable-table"><table><thead><tr><th>  Virtual resource type </th><th>  Before introducing ManageIQ </th><th>  After implementing ManageIQ </th></tr></thead><tbody><tr><td>  Linux virtual machine in VMware / oVirt </td><td>  To one </td><td>  ~ 10 minutes </td></tr><tr><td>  Rancher virtual machine environment </td><td>  working </td><td>  ~ 15 minutes </td></tr><tr><td>  Windows Virtual Machine in VMware </td><td>  weeks </td><td>  ~ 25 minutes </td></tr></tbody></table></div><br><p>  The time difference is due to the fact that in the second case, additional time is required to prepare the host for working with Docker, download and tegrate images for infrastructure containers from Artifactory, because at this stage there is still no access to the Docker Hub.  In the case of Windows, the difference is achieved due to the fact that, firstly, the creation time of a Linux VM without customization is approximately 2 minutes, and that of a Windows VM is 6 minutes.  Secondly, customizing Windows itself takes about 10 minutes, versus 2 minutes for Linux. </p><br><p>  10 minutes is not so fast, considering that approximately 2-3 minutes are spent directly on the process of creating a VM.  For the remaining time, ManageIQ manages to do the following: </p><br><ol><li>  The system collects the parameters specified by the user in the order form and decomposes them into variables. </li><li>  A new change request is created in the incident management system, which displays data about the new resource. </li><li>  The ManageIQ Resource Name Query System sends a value for a new resource. </li><li>  The IP address management system issues a new address based on the entered parameters. </li><li>  A new DNS record is registered on the local DNS server. </li><li>  Based on the parameters, environment and resource load, the type of virtualization and cluster for placement are selected. </li><li>  Next, the process of creating a virtual machine with the specified parameters. </li><li>  When the virtual machine is deployed from the template, you need to run scripts that will make the final settings: <br><ul><li>  expanding the drive to a specified size, </li><li>  generating a new root password, changing it on a Linux host and writing to a password manager, </li><li>  creating a configuration YAML file for Puppet in GitLab, </li><li>  run runbooks that bring the necessary settings and updates for Windows VMs or </li><li>  launch Puppet, which will update and configure Linux machines. </li></ul></li><li>  After all this, the change request created in step 2 is closed.  Fresh data is added to it, such as the IP address and host name. </li><li>  A new unit is registered in the Compute Resource Management Base (CMDB). </li><li>  The virtual machine is registered in Zabbix and added to monitoring. </li><li>  The customer and other interested parties receive an e-mail with information about the new unit created using ManageIQ. </li></ol><br><h2 id="chto-vnutri">  What's inside </h2><br><p>  Let's delve into the technical details of the product.  By default, ManageIQ can create a virtual machine from a template.  How does this differ from what we do, for example, in vCenter?  The correct answer is nothing.  ManageIQ uses the same methods as virtualization systems, but does it from a single place.  In addition to this, you can add your own scripts that do not fit into the standard set of features.  Thus, if you have resources, for example, in public Azure, in vCenter, which is deployed on your own hardware, plus the Kubernetes cluster is spinning somewhere else, then all this can be conveniently managed from ManageIQ. </p><br><p>  In addition to a wide variety of providers for integration, ManageIQ has convenient tools for customization.  This, for example, creating convenient forms for solving your problem: </p><br><p><img src="https://habrastorage.org/webt/ku/7y/l3/ku7yl3xi9trq-9wndv-ad_vlpvu.png"></p><br><p>  Thanks to this, it was possible to construct a full-fledged interface for ordering a virtual machine, fitting all the necessary parameters into it: </p><br><p><img src="https://habrastorage.org/webt/v7/ey/tf/v7eytf_hbcxxjcpw4hvrzuwyzve.png"></p><br><p>  We select the amount of computing resources, OS, fill in all the additional information that is needed for integration with external systems.  Further, using internal mechanisms (about them a little later), the system chooses where new resources will be placed: the data center, cluster, host and datastore are selected depending on all the parameters entered and the resources are loaded. </p><br><p>  Do not forget that people can order too many resources or not at all what they really need.  Here the system of requests and confirmations comes into play: </p><br><p><img src="https://habrastorage.org/webt/mj/yv/28/mjyv28hsy0ggf6t68jjdkgc8mwc.png"></p><br><p>  Any resources ordered by the user must be approved by the responsible person.  In Home, a group of architects does this. </p><br><h2 id="struktura-avtomatizacii">  Automation structure </h2><br><p>  If you decompose all the automation processes in ManageIQ into small parts, you will notice a certain structure. </p><br><h3 id="automate-domain">  Automate Domain </h3><br><img align="right" src="https://habrastorage.org/webt/xy/ea/c_/xyeac_nx3if-e4txuiuriic4h0w.png"><br><p>  Datastore hosts all the domains that ManageIQ has. </p><br><p>  By default, there is a ManageIQ domain that is locked and is something like a reference model.  If you need to make changes, another domain is created, into which elements from the ManageIQ domain are copied and changed for your own tasks. </p><br><h3 id="automate-namespace">  Automate Namespace </h3><br><img align="right" src="https://habrastorage.org/webt/yf/e1/t3/yfe1t3kjxb4rhvenndkfkwtsad4.png"><br><p>  Inside, the domains are divided into parts that are responsible for individual processes: this may be the section responsible for managing the infrastructure (Infrastructure) or for working with services (Service).  We have our own Namespace, which contains everything related to the bank's systems. </p><br><p>  Consider the structure in more detail using the example of the provisioning process for a new virtual machine.  It is described in the Automate Class called <em>VMProvision_VM</em> . </p><br><h3 id="automate-class">  Automate Class </h3><br><p>  The class has a structure that includes <strong>Instances</strong> , <strong>Methods</strong> , <strong>Properties,</strong> and <strong>Schema</strong> .  From the point of view of automation, Schema is of most interest: <br><img src="https://habrastorage.org/webt/vm/jt/lf/vmjtlfd9qpyrqpdpemtxfw2yczs.png"></p><br><p>  The layout is similar to pipeline in CI / CD systems.  It describes the steps that will be performed during the automation process. </p><br><h3 id="automate-instance">  Automate Instance </h3><br><img align="right" src="https://habrastorage.org/webt/ie/wj/fj/iewjfjuzq9rplkcszwsh7wemsqu.png"><br><p>  The class described above has two Automate Instance.  Each of them inherits from the circuit the stages for which the <em>Default Value</em> is set.  Stages that have null values ‚Äã‚Äãare described in the instance. </p><br><p><img src="https://habrastorage.org/webt/wy/sl/5c/wysl5c2zze_9_sfplsnykplbf_m.png"></p><br><p>  In the instance, values ‚Äã‚Äãappeared for the steps that were empty in the schema description.  It is also visible who and when made the last change. </p><br><p>  Let's see what one of the Value values ‚Äã‚Äãrepresents: <br><img src="https://habrastorage.org/webt/rd/j_/v7/rdj_v7hc3wgt7dty2zckjltiacg.png"></p><br><p>  This is an Automate Class called Methods, which has one Automate Instance.  Its scheme describes the <em>ipam_base_uri</em> attribute and the <em>execute</em> method.  The execute method, in turn, calls the Automate Method <em>acquire_ip</em> . </p><br><h3 id="automate-method">  Automate Method </h3><br><p> This is a Ruby script that allows a virtual machine to communicate via REST API with other systems.  For example, as is the case with the IPAM address space management system.  In IPAM we get the address, mask, subnet and VLAN for the VM.  The difficulty is that the machine can be deployed in a test environment or productive, for applications or databases.  Or maybe the security service decided to place it in the PCI-DSS loop.  All this information is collected at the stage of creating the VM or transmitted in the parameters of the called instance (in the screenshot above you can see that the parameter contains the uri by which the method will access IPAM): </p><br><div class="spoiler">  <b class="spoiler_title">Here is some Ruby code</b> <div class="spoiler_text"><pre><code class="ruby hljs">base_uri = $evm.object[<span class="hljs-string"><span class="hljs-string">'ipam_base_uri'</span></span>] prov = $evm.root[<span class="hljs-string"><span class="hljs-string">"miq_provision"</span></span>] site = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:site</span></span>) app = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_list_information_system</span></span>) crq = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:crq</span></span>) descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_textarea_box_usernotes</span></span>) owner = $evm.root[<span class="hljs-string"><span class="hljs-string">'user'</span></span>].name scope = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_scope</span></span>) environment = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:landscape</span></span>)</code> </pre> <br><p>  <em>$ evm.root</em> is a method that returns everything that can be stored in ManageIQ.  This can be information about the user, environment, variables, the current request ('miq_request'), etc.  We are interested in the current provision process. <br><img src="https://habrastorage.org/webt/4m/hz/lm/4mhzlmb6p_lvkagsl7apu41mpdm.png"></p><br><p>  Next, we can pick up the necessary values: <em>get_option (: site)</em> picks up the value that was transferred at one of the previous stages, and, for example, <em>get_option (: dialog_dropdown_list_information_system)</em> picks up from the form that the user fills when ordering new resources. <br>  All received values ‚Äã‚Äãare transmitted by variables in the request body in JSON format: </p><br><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">body:</span></span> { <span class="hljs-string"><span class="hljs-string">"site"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{site}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"env"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{env}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"app"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{app}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"scope"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{scope}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"role"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{role}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"crq"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{crq}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{descr}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"owner"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{owner}</span></span></span><span class="hljs-string">"</span></span>, }.to_json, }</code> </pre> <br><p>  Using this set of parameters, IPAM will unambiguously determine in which VLAN the virtual machine should be located, and will return the network parameters. </p></div></div><br><p>  In addition to receiving data for the correct VM configuration, ManageIQ can also generate additional information in order to make some settings at the stage of the so-called post provisioning (after the virtual machine is deployed and launched).  In Home, we use Puppet to manage Linux host configurations.  For each computing unit, create a YAML file in GitLab with a set of groups: </p><br><div class="spoiler">  <b class="spoiler_title">Some more Ruby code</b> <div class="spoiler_text"><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Private-Token"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{api_token}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, } body = { <span class="hljs-string"><span class="hljs-string">"branch"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{branch}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"email@your.domain"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ManageIQ Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"commit_message"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"New host created by ManageIQ"</span></span>, } descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:long_description</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) &amp;&amp; descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n - user-devops-UDCR"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{$is_id}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Groups depend on the type of virtual machine, the environment in which it is created, and the information system. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1i/hv/ig/1ihvigmykpbqlihq2l8oturxxk0.png"></div><br><p>  After successful completion of the procedure, the user receives an email with information: <br><img src="https://habrastorage.org/webt/qf/j-/br/qfj-brpfqe1ukkcvrw_jdtdpigm.png"></p><br><p>  The text of the letter can also be adjusted by adding the necessary information. <br>  In the event that an error occurs at any of the critical stages of the process, you can add a condition in which it will be explicitly stated that the process should be interrupted.  If the error does not have fatal consequences, also indicate what can be continued, despite the problem. </p><br><h2 id="logirovanie">  Logging </h2><br><p>  ManageIQ writes logs of everything that can be tracked.  The automation process is written in automation.log.  In addition there are API logs, various cloud providers, security logs, even the output of the top command is logged. </p><br><p>  For each event in the circuit, you can configure a log entry of their start and end: <br><img src="https://habrastorage.org/webt/tv/z0/yy/tvz0yyygspvyltb6d_x4ja00hpg.png"></p><br><p>  In addition, you can write your messages in the logs: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Call job status uri: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{item_uri}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{job_id}</span></span></span><span class="hljs-string">/api/json"</span></span>)</code> </pre> <br><p>  This is very useful when accessing systems by API to understand why something went wrong.  Or, to track the current status of a lengthy process, such as running a Jenkins job or SCCM Runbook: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"acquire_osname --- naming jobStatus: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{jobStatus}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> jobStatus.to_s == <span class="hljs-string"><span class="hljs-string">"Completed"</span></span></code> </pre> <br><p>  You can use the standard functions for exceptions to write to the logs: </p><br><pre> <code class="ruby hljs">raise ‚ÄúVM <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> specified‚Äù <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vm.<span class="hljs-literal"><span class="hljs-literal">nil</span></span>?</code> </pre> <br><p>  By default, all logs are stored in the / var / log / manageiq / * section, but from my own experience I can say that looking for a problem through tail and grep is not a convenient solution.  Given that ManageIQ writes a lot of different logs, you should take care to redirect logs, for example, to the ELK stack. </p><br><h2 id="manageiq-api">  ManageIQ API </h2><br><p>  In addition to a user-friendly web interface, ManageIQ has a functional API.  With it, for example, we solved the problem of dynamically determining the identifier of the template to be specified </p><br><div class="spoiler">  <b class="spoiler_title">when creating a VM:</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vendor, os, ems)</span></span></span></span> user = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">'</span></span> pass = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">'</span></span> options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Accept"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"*/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"accept-encoding"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"gzip, deflate"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">basic_auth:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">"</span></span> }, } response = HTTParty.get(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{host}</span></span></span><span class="hljs-string">/api/templates?filter[]=vendor=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{vendor}</span></span></span><span class="hljs-string">%27&amp;filter[]=name=%27%2A</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{os}</span></span></span><span class="hljs-string">%2A%27&amp;filter[]=ems_id=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{ems}</span></span></span><span class="hljs-string">%27"</span></span>, options).to_s link = JSON.parse(response) link[<span class="hljs-string"><span class="hljs-string">"resources"</span></span>].each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|r|</span></span> $url = r[<span class="hljs-string"><span class="hljs-string">"href"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> response = HTTParty.get($url,options).to_s template = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'id'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>+<span class="hljs-string"><span class="hljs-string">", "</span></span>+<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'name'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Using a POST request and specifying filters for the search, we get the desired template. <br>  In addition to solving internal problems, you can create new API methods for use by external systems.  At the beginning of the article, the process of ordering a new virtual machine using the web interface was shown.  And this is how it looks if you do it with </p><br><div class="spoiler">  <b class="spoiler_title">POST request:</b> <div class="spoiler_text"><pre> <code class="ruby hljs">curl -X POST \ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/Manageiq.hostname/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/service_catalogs/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>/service_templates/<span class="hljs-number"><span class="hljs-number">31</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Authorization: Basic Token-Value'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{ "action": "order", "resource": { "radio_button_vcpu": "a_2", "radio_button_vram": "a_2", "hdd_size": "40", "dropdown_os": "CentOS", "text_box_filter": "dns", "dropdown_list_information_system": "DNS ", "text_box_validator": "OK (DNS )", "textarea_box_usernotes": " ", "dropdown_env": "production", "date_control_retirement_dt": "2022-05-21", "dropdown_scope": "-" } }'</span></span></code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclusion </h2><br><h3 id="plyusy">  Pros: </h3><br><ul><li>  Incredible flexibility: ManageIQ not only allows you to customize the automation process as you need it, but also makes it possible to change its visual part by adding additional buttons, fields, etc. </li><li>  Built-in code editor with syntax highlighting and code validation.  It seemed to me a very good solution, if you need to quickly fix something. </li><li>  A large number of sources that the system can work with.  Clouds: Amazon EC2, Google Compute Engine, Azure, OpenStack, VMware vCloud.  Infrastructure: Microsoft SCVMM, OpenStack Platform Director, Red Hat Virtualization, VMware vCenter.  Containers: Kubernetes, OpenShift. </li></ul><br><h3 id="minusy">  Minuses: </h3><br><ul><li>  The great capabilities of the tool also carry a negative point.  Not all documentation is well structured, and sometimes it‚Äôs hard to figure out where to look for what you need.  However, it is worth noting that the situation is changing for the better, the documentation is supplemented and improved. </li><li>  Small community.  If you encounter some very specific problem, you may not be able to quickly ‚Äúgoogle‚Äù the answer.  Or not succeed at all. </li><li>  A paragraph that follows from the previous two.  Some basic things, settings and scripts can be found in the documentation or on the Internet, but more specific and narrow questions required a lot of time to comprehend and study, including the method of scientific poking: smile :. </li></ul><br><h3 id="kak-u-nas-seychas">  As we have now: </h3><br><p>  Due to the fact that ManageIQ can take full advantage of the Ruby language, we were able to integrate it to work with the following APIs: </p><br><ul><li>  Password Manager  It generates a root password in accordance with the requirements of the security service, writes it to its database, and ManageIQ uses it inside the OS; </li><li>  Service Center Orchestration services for managing DNS records and host names; </li><li>  BMC Remedy.  The whole process is recorded as comments on the request.  After successful execution, the request is closed; </li><li>  CMDB  Information about new configuration units is created in the database with all the necessary data. </li><li>  Zabbix  Depending on the affiliation with the information system and environment, hosts are added to the corresponding monitoring groups. </li><li>  Rancher.  Created the creation of new environments, the installation of agents and registration of hosts in existing environments. </li><li>  Jenkins  Jenkins runs jobs to configure VMs in oVirt; </li><li>  LDAP  Creating new groups that are used to control access in Rancher environments and to configure policies in Vault; </li><li>  Vault  In Home, the integration of this product into banking processes has just begun, but we have already made methods for creating new groups, policies and sections for storage; </li><li>  Puppet and IPAM were mentioned earlier. </li></ul><br><p>  The functionality and capabilities of the system are very extensive, and I got acquainted with many of them and continue to get acquainted in the process of implementing the system. <br>  For example, I did not mention that the system has the ability to create your own dashboards with statistics, billing settings or buttons, to which you can attach individual scripts or entire scripts.  You can add your own fields to record additional information about services and virtual machines, etc. </p><br><h3 id="k-chemu-stremitsya-houm">  What Home strives for: </h3><br><ul><li>  An upgrade to the Hammer version, in which in HA mode you can try to work with the built-in Ansible. </li><li>  The transition from coordination for each unit of virtual resources to management.  Teams will be able to receive new VMs even faster if the quota is not exhausted. </li><li>  Development of new methods for further provision to external systems. </li><li>  For example, various SaaS like jenkins, logstash, etc. </li><li>  Implementation of new API methods in an existing portal for owners of information systems.  Users will not need to think about how to integrate with a new infrastructure element, they will just use it as a service to obtain new resources or change existing ones. </li></ul><br><p>  <em>At the very end, I would like to remind you that tools are great, but do not forget about the importance of interaction between different teams.</em>  <em>The changes described in the article would not have been possible without well-established communication and constant interaction on emerging issues of all interested parties.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/461891/">https://habr.com/ru/post/461891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46188/index.html">Large HDD</a></li>
<li><a href="../461881/index.html">Node.js Logging Guide</a></li>
<li><a href="../461885/index.html">EDS is another type of fraud</a></li>
<li><a href="../461887/index.html">Entering Aeronet Episode 2: Homing Drone</a></li>
<li><a href="../46189/index.html">Chinese netbook with a Chinese processor at the "Chinese" price</a></li>
<li><a href="../461895/index.html">Learn While Travel - how we drove on 1st European Business Analysis Day</a></li>
<li><a href="../461899/index.html">Event Generation, CQRS and Laravel</a></li>
<li><a href="../4619/index.html">Public key cryptography is 30 years old</a></li>
<li><a href="../46190/index.html">Photos of paper "AMERO" which will replace the dollar with the spring!</a></li>
<li><a href="../461901/index.html">Three years of autotests: how to increase speed and not only</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>