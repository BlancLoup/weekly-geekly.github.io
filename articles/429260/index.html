<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our way to the centralized storage of logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all! I work as a system engineer in the company "Onlanta . " On one of our projects I was involved in the implementation and maintenance ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our way to the centralized storage of logs</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all!  I work as a system engineer in the company <a href="https://www.onlanta.ru/">"Onlanta</a> . <a href="https://www.onlanta.ru/">"</a>  On one of our projects I was involved in the implementation and maintenance of the Elastic Stack.  We have gone all the way from collecting logs to a centralized, automated process.  For two years now we have practically not changed the solution architecture and plan to use a convenient tool in other projects.  I share with you our history of its implementation, as well as some strengths and weaknesses in this post. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23f/a8d/39d/23fa8d39daef5063c297e7cff9f3bbdc.png"></div>  <a href="">A source</a> <br><a name="habracut"></a><br>  At the beginning of 2016, the logs of our administrators and developers were, as they say, ‚Äúat their fingertips‚Äù, that is, the engineer to work with them was connected using SSH to the host where the service of interest was located, uncovered a universal set of tail / grep / sed / awk and hoped that the necessary data can be found on this particular host. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2b5/8cb/c53/2b58cbc53de559d692a6a0295f7fde4e.png"></div>  <a href="">A source</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We also had a separate server, where all directories with logs from all servers were mounted via NFS, and which sometimes took a long time to reflect on what everyone wanted to do with it.  Well, tmux with several panels with running tail to some actively updated logs looked very impressive to outsiders on a large monitor and created an exciting atmosphere of participation in the sacraments of production. <br><br>  All of this even worked, but exactly until a large amount of data was required to be quickly processed, and this was most often required at times when something had already collapsed during the sale. <br><br>  Sometimes it was a very indecent time to investigate incidents.  A significant part of it was spent on manual aggregation of logs, launching <s>crutches of</s> various scripts in Bash and Python, waiting for logs to be downloaded somewhere for analysis, etc. <br><br>  In a word, all this was very slow, casting gloom and unequivocally hinting that it was time to attend to the centralized storage of logs. <br><br>  To be honest, there was no complicated process of selecting candidates for the role of the technological stack, which we could provide, then: the ELK bundle at that time was already popular, had good documentation, there were a large number of articles on all components on the Internet.  The decision was immediate: you need to try. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ce1/6aa/c04/ce16aac040da82a959333b390b8fe04b.png"></div>  <a href="">A source</a> <br><br>  The very first installation of the stack was made after viewing the ‚ÄúLogstash: 0-60 in 60‚Äù webinar on three virtual machines, each running a copy of Elasticsearch, Logstash and Kibana. <br><br>  Next, we encountered some problems with logging from end hosts to Logstash servers.  The fact is that at that time Filebeat (a standard stack solution for delivering logs from text files) worked much worse with large and quickly updated files, regularly flowed into RAM, and in our case as a whole did not cope with its task. <br><br>  To this was added the need to find a way to deliver application server logs from machines running IBM AIX: most of the applications we then ran in WebSphere Application Server, which worked under this OS.  Filebeat was written in Go, a more or less workable Go compiler for AIX in 2016 did not exist, and I really didn‚Äôt want to use Logstash as an agent for delivery. <br><br>  We tested several log shipping agents: Filebeat, logstash-forwarder-java, <a href="https://github.com/driskell/log-courier">log-courier</a> , python-beaver, and NXLog.  We expected agents to have high performance, low system resource consumption, easy integration with Logstash, and the ability to perform basic manipulations with the data provided by the agent (for example, building multi-line events). <br><br>  About the assembly of multiline (multiline) events should be said separately.  Effectively, it can be performed only on the side of the agent that reads a specific file.  Despite the fact that Logstash once had a multiline filter, but now it has a multiline codec, all our attempts to combine event balancing across multiple Logstash servers with multiline processing on them failed.  This configuration makes the effective balancing of events almost impossible, so for us almost the most important factor in choosing agents was multiline support. <br><br>  The winners were distributed as follows: log-courier for machines with Linux, NXLog for machines with AIX.  With this configuration, we lived for almost a year without any problems: the logs were delivered, the agents did not fall (well, almost), everyone was happy. <br><br>  In October 2016, the fifth version of the Elastic Stack components, including the Beats 5.0, was released.  In this version, a lot of work has been done on all the Beats agents, and we were able to replace log-courier (which by that time had its problems) with Filebeat, which we are still using. <br><br>  In the transition to version 5.0, we began to collect not only logs, but also some metrics: Packetbeat we began to be used here and there as an alternative to writing logs of HTTP requests to files, and Metricbeat collected system metrics and metrics of some services. <br><br>  At this point, the work of our engineers with logs has become much simpler: now you didn‚Äôt need to know which server to go to to see the log you were interested in, the exchange of the information found was simplified to simply sending a link to Kibana in chat rooms or mail, and the reports that were previously built in a few hours, they began to be created in a few seconds.  It cannot be said that it was just a matter of comfort: we noticed changes in the quality of our work, in the quantity and quality of closed tasks, in the speed of response to problems at our stands. <br><br>  At some point, we started using the ElastAlert utility from Yelp to send alerts to engineers.  And then they thought: why not integrate it with our Zabbix, so that all the alerts have a standard format and are sent centrally?  The solution was found quite quickly: ElastAlert allows, instead of sending, actually, notifications to execute any commands that we used. <br><br>  Now, our ElastAlert rules, when triggered, execute a bash script for several lines, to which the arguments are passed the necessary data from the event that triggered the rule, and from the script, in turn, zabbix_sender is called, which sends the data to Zabbix for the desired node. <br><br>  Since all the information about who generated the event and where, in Elasticsearch, is always there, there were no difficulties with integration.  For example, we had a mechanism for automatic detection of WAS application servers before, and in the events they generate, the server name, cluster, cell, etc. are always recorded.  This allowed us to use the query_key option in the ElastAlert rules so that the conditions of the rules are processed for each server separately.  The script with zabbix_sender then leaves the exact "coordinates" of the server and the data is sent to Zabbix for the corresponding node. <br><br>  Another solution, which we like very much and which was made possible by the centralized collection of logs, is a script for automatic establishment of tasks in JIRA: once a day, it scoops up all errors from the logs and, if there are no tasks for them, gets them.  At the same time, from different indexes, by a unique request ID, all information that might be useful during an investigation is pulled up in a task.  The result is such a standard blank with the necessary minimum of information, which then engineers can add if necessary. <br><br>  Of course, we faced the issue of monitoring the stack itself.  This is partially implemented using Zabbix, partly using the same ElastAlert, and we get the main performance metrics for Elasticsearch, Logstash and Kibana using standard monitoring integrated into the stack (Monitoring component in the X-Pack).  We also installed <a href="https://github.com/netdata/netdata">netdata</a> from Firehol on the servers with stack services themselves.  It is useful when you need to see what is happening with a particular node right now, in real time and in high resolution. <br><br>  Once the module for monitoring Elasticsearch was a little broken in it, we found it, repaired it, added all sorts of useful metrics and made a pull-request.  So now netdata can monitor the latest versions of Elasticsearch, including basic JVM metrics, indexing performance, search performance, transaction log statistics, index segments, and so on.  We like Netdata, and we are pleased that we were able to make a small contribution to it. <br><br>  Today, after almost three years, our Elastic Stack looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b0b/fc6/ab5/b0bfc6ab50dede8cdb09d80e22f90f07.png"></div><br>  Engineers work with the stack in three main ways: <br><br><ul><li>  viewing and analyzing logs and metrics in Kibana; </li><li>  Dashboards in Grafana and Kibana; </li><li>  direct queries to Elasticsearch using SQL or embedded query DSL. </li></ul><br>  In total, all of these resources are allocated: 146 CPU, 484GB RAM, 17TB allocated for Elasticsearch data storage. <br><br>  In total, we have 13 virtual machines in our Elastic Stack: 4 machines for ‚Äúhot‚Äù Elasticsearch nodes, 4 for ‚Äúwarm‚Äù, 4 machines with Logstash and one balancer machine.  On each hot node, Elasticsearch runs a Kibana instance.  It happened from the very beginning, and so far we have not had to move Kibana to separate cars. <br><br>  But the decision to bring Logstash to individual machines turned out to be one of the most correct and effective during the operation of the stack: the high competition for processor time between JVM Elasticsearch and Logstash led to not very pleasant special effects during load spikes.  Garbage collectors suffered the most. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d15/1cb/e24/d151cbe24f19860ee8f88e6ff4d86fd6.jpg"></div>  <a href="">A source</a> <br><br>  We store data in the cluster for the last 30 days: now it is about 12 billion events.  Per day, ‚Äúhot‚Äù nodes write to the disk 400-500GB of new data with the maximum degree of compression (including shard-replica data).  Our Elasticsearch cluster has hot / warm architecture, but we switched to it relatively recently, so less data is stored on the ‚Äúwarm‚Äù nodes than on the ‚Äúhot‚Äù ones. <br><br>  Our typical workload load is: <br><br><ul><li>  indexing - an average of 13,000 rps with peaks up to 30,000 (excluding indexation into shards-replicas); </li><li>  search - 5200 rps. </li></ul><br>  We try to maintain a 40-50% CPU margin on hot Elasticsearch nodes, so that we can easily experience sudden surges in the number of indexed events and heavy requests from Kibana / Grafana or external monitoring systems.  About 50% of RAM on hosts with Elasticsearch nodes is always available for page cache and off-heap JVM needs. <br><br>  During the time since the launch of the first cluster, we have managed to identify for ourselves some of the positive and negative sides of the Elastic Stack as a means of log aggregation and a search and analysis platform. <br><br>  <b>What we especially like about the stack:</b> <br><br><ul><li>  A single ecosystem of products well integrated with each other, in which there is almost everything needed.  The Beats were once not very good, but now we have no complaints against them. </li><li>  Logstash, for all its monstrosity, is a very flexible and powerful preprocessor and allows you to do a lot with raw data (and if it doesn't allow something, you can always write a Ruby snippet). </li><li>  Elasticsearch with plugins (and more recently out of the box) supports SQL as a query language, which makes it easy to integrate with other software and people to whom SQL is closer as a query language. </li><li>  High-quality documentation that allows you to quickly introduce new employees on the project to stay informed.  Operation of the stack, therefore, does not become a matter for one person who has some specific experience and ‚Äúsecret knowledge‚Äù. </li><li>  No need to know in advance about the structure of the received data much to start collecting them: you can start to aggregate events as they are, and then, as you understand what useful information you can extract from them, change the approach to processing them without losing backward compatibility.  There are many convenient tools for this in the stack: field aliases in indexes, scripted fields, etc. </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dcc/e5b/075/dcce5b0751ee3394dd2426b878c24169.png"></div>  <a href="">A source</a> <br><br>  <b>What we don't like:</b> <br><br><ul><li>  X-Pack components are distributed only on the subscription model and nothing else: if from Gold, for example, only RBAC support or PDF reports, then you will have to pay for everything in Gold.  This is especially frustrating when, for example, only Graph is needed from Platinum, and in the appendix you can buy Machine Learning and another package of other functionality that you may not really need.  Our attempts about a year ago to communicate with the Elastic sales department about licensing individual components of the X-Pack have come to naught, but perhaps something has changed since then. </li><li>  Quite frequent releases, in which in some way (every time new) break backward compatibility.  You have to read the changelog very carefully and prepare for updates in advance.  Every time you need to choose: stay on the old version, which works stably or try to upgrade for the sake of new features and performance gains. </li></ul><br>  In general, we are very pleased with the choice made in 2016, and we plan to transfer the operating experience of the Elastic Stack to our other projects: the tools provided by the stack were very tightly incorporated into our workflow and it would be very difficult to abandon them now. <br><br><div class="spoiler">  <b class="spoiler_title">And in our company a number of vacancies are open.</b> <div class="spoiler_text"><ul><li>  <a href="https://job.lanit.ru/vacancy/Pages/%25D0%259E-84.aspx%3Futm_source%3Dhabr%26utm_medium%3Dpost-2018-11-13%26utm_campaign%3Donlanta">Expert Team Leader</a> </li><li>  <a href="https://job.lanit.ru/vacancy/Pages/O-100.aspx%3Futm_source%3Dhabr%26utm_medium%3Dpost-2018-11-13%26utm_campaign%3Donlanta">Expert Team Leader (Windows)</a> </li><li>  <a href="https://job.lanit.ru/vacancy/Pages/O-97.aspx%3Futm_source%3Dhabr%26utm_medium%3Dpost-2018-11-13%26utm_campaign%3Donlanta">Network Information Security Engineer</a> </li><li>  <a href="https://job.lanit.ru/vacancy/Pages/O-90.aspx%3Futm_source%3Dhabr%26utm_medium%3Dpost-2018-11-13%26utm_campaign%3Donlanta">Presale Manager (Cloud Services)</a> </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/429260/">https://habr.com/ru/post/429260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429250/index.html">One hundred digital accounting recipes</a></li>
<li><a href="../429252/index.html">Static analysis of mobile applications</a></li>
<li><a href="../429254/index.html">On the question of Bezier curves and speed Arduino, part two</a></li>
<li><a href="../429256/index.html">How to grow a forest on Actionscript3 / Flash in a few * lines of code</a></li>
<li><a href="../429258/index.html">How to create a reliable game mechanics, using only Excel: modeling and optimization solutions</a></li>
<li><a href="../429262/index.html">We invite you to the autumn DIYorDIE Meetup November 17</a></li>
<li><a href="../429264/index.html">Lithium-Ion UPS Time: Fire Hazard or a Safe Step into the Future?</a></li>
<li><a href="../429266/index.html">What salaries for IT specialists are offered by My Circle employers, data for May-October 2018</a></li>
<li><a href="../429268/index.html">Giant spider and minotaur on the streets of toulouse</a></li>
<li><a href="../429270/index.html">Adult journalism: from Russia to the Kremlin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>