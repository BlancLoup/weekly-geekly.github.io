<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What are you, a closure in javascript?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will try to disassemble the mechanism for implementing closures in JavaScript. For this, I will use the Chrome browser. 

 Let's sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What are you, a closure in javascript?</h1><div class="post__text post__text-html js-mediator-article">  In this article I will try to disassemble the mechanism for implementing closures in JavaScript.  For this, I will use the Chrome browser. <br><br>  Let's start with the definition: <br><blockquote>  <b>Closures</b> are functions that refer to independent (free) variables.  In other words, the function defined in the closure ‚Äúremembers‚Äù the environment in which it was created. </blockquote>  <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Closures">MDN</a> <br><br>  If something is not clear to you in this definition, it is not scary.  Just read on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I am deeply convinced that to understand something easier and faster with concrete examples. <br><br>  Therefore, I propose to take a code snippet and walk along it along with the interpreter from beginning to end, in steps and understand what is happening. <br><br>  So let's get started: <br><br><img src="https://habrastorage.org/webt/o_/pi/wo/o_piwoknty0bjixs4sv8ohsw9am.png"><br>  <i>Picture 1</i> <br><a name="habracut"></a><br>  We are in the global context of the call, it is Global (also known as the Window in the browser) and we see that the main function already lies in the current context and is ready to work. <br><br><img src="https://habrastorage.org/webt/-i/2i/vv/-i2ivvoyp8qo-f0hq0xf1oezoqu.png"><br>  <i>Figure 2</i> <br><br>  This happens because all Function Declaration (hereinafter FD) always go up in any context, they are immediately initialized and ready to go.  The same thing happens with variables declared via var, only their values ‚Äã‚Äãare initialized as undefined. <br><br>  It is also important to understand that JavaScript also ‚Äúraises‚Äù variables declared via let and const.  The only difference is that it does not initialize them as var or as FD.  Therefore, when we try to access them before initialization, we get a Reference Error. <br><br>  Also in main, we see the internally hidden property <b>[[Scopes]]</b> - this is a list of external contexts to which main has access.  In our case, Global is there, since main is running in a global context. <br><br>  The fact that in JavaScript initialization of references to the external environment occurs at the moment of creating the function, and not at the moment of execution, says that JS is a language with a static scope.  And this is important. <br><br>  Go ahead: <br><br><img src="https://habrastorage.org/webt/_h/0w/qx/_h0wqxn3kdigr1j-mry8pvdt2fm.png"><br>  <i>Figure 3</i> <br><cut></cut><br>  We go into the main function and the first thing that catches the eye is the Local object (in the specification, localEnv).  There we see <b>a</b> , since this variable is declared via <b>var</b> and it 'floated up', well, and by tradition we see all 3 FD (foo, bar, baz).  Now let's see where it all came from. <br><br>  When you run any context, the abstract operation <a href="http://es5.javascript.ru/x10.html">NewDeclarativeEnvironment is started</a> , which allows you to initialize <b>LexicalEnvironment</b> (hereafter LE) and <b>VariableEnvironment</b> .  Also, <b>NewDeclarativeEnvironment</b> takes 1 argument ‚Äî an external LE, in order to create the [[Scopes]] that we talked about above.  LE is an API that allows us to define the relationship between identifiers and individual variables, functions.  LE consists of 2 components: <br><br><ol><li>  <b>Record Environment</b> - a recording of the environment, which allows to determine the relationship between identifiers and what is available to us in the current context of the call </li><li>  Link to external LE.  Each function has an internal property <b>[[Scopes]]</b> at creation </li></ol><br>  VariableEnvironment - most often it is the same as LE.  The difference between them is that the value of the VariableEnvironment never changes, and the LE can change during the execution of the code.  To simplify further understanding, I propose combining these components into one - LE. <br><br>  Also in the current Local, there is this due to the fact that the <b>ThisBinding</b> call <b>occurred</b> - this is also an abstract method that initializes this in the current context. <br><br>  Of course, each FD immediately received [[Scopes]]: <br><br><img src="https://habrastorage.org/webt/nz/_t/ap/nz_tapg-wc5fulmh7wtsviyxus8.png"><br><a name="pic4"></a>  <i>Figure 4</i> <br><br>  We see that all FD received in [[Scopes]] an array of [Closure main, Global], which is logical. <br><cut></cut><br>  Also in the picture we see <b>Call Stack</b> - this is a data structure that works on the principle of LIFO - last in first out.  Since JavaScript is single-threaded, only one context can be executed at a time.  In our case, this is the context of the main function.  Each new function call creates a new context, which is added to the stack. <br><br>  At the top of the stack is always the current execution context.  After the function has completed its execution and the interpreter has left it, the context of the call is removed from the stack.  That's all we need to know about the call stack in this article :) <br><br>  We summarize what happened in the current context: <br><br><ul><li>  During creation, main got [[Scopes]] with links to the external environment. </li><li>  The interpreter entered the main function body </li><li>  The call stack has the execution context main </li><li>  This has been initialized </li><li>  LE initialization occurred </li></ul><br>  In fact, the hard part is over.  Go to the next step in the code: <br><br>  Now we need to call baz to get the result. <br><br><img src="https://habrastorage.org/webt/m4/0x/-i/m40x-if0h9mshfrsqxqv27wgbaw.png"><br><a name="pic5"></a>  <i>Figure 5</i> <br><br>  A new baz call context has been added to the Call Stack.  We see that a new Closure object has appeared.  Here comes what is available to us from [[Scopes]].  So we got to the point.  This is the closure.  As you can see in <a href="https://habr.com/ru/post/459166/">Figure 4,</a> Closure (main) goes first on the baz list of 'backup' contexts.  Again, no magic. <br><br>  Let's call foo: <br><br><img src="https://habrastorage.org/webt/ln/nd/yg/lnndygmqufofzebonalpko5ro3s.png"><br>  <i>Figure 6</i> <br><br>  It is important to know that no matter what place we call foo, it will always go after its unidentified identifiers in its [[Scopes]] chain.  Namely, in main and then in Global, if not found in main. <br><br>  After executing foo, it returned a value, and its context was dropped from the Call Stack. <br>  Go to the function call bar.  In the execution context, bar has a variable with the same name as the variable in LE foo - <b>a</b> .  But, as you may have guessed, it does not affect anything.  foo will still take the value from its [[Scopes]]. <br><br><img src="https://habrastorage.org/webt/lx/oe/er/lxoeer85v0udg9ivlztvi6qr8yw.png"><br>  <i>Figure 7</i> <br><br>  As a result, baz will return 300 and will be thrown out of the call stack.  Then the same will happen with the context context, our code fragment will finish executing. <br><br>  We summarize: <br><br><ul><li>  During the creation of the function is set <b>[[Scopes]]</b> .  This is very important for understanding closures, because when searching for values, the interpreter immediately follows these links. </li><li>  Then, when this function is called, an active execution context is created, which is placed in the Call Stack. </li><li>  ThisBinding is performed and this is set for the current context. </li><li>  LE initialization is performed, and all function arguments, variables declared through var and FD become available.  Further, if there are variables declared via let or const, they are also added to LE </li><li>  If the interpreter does not find any identifier in the current context, then <b>[[Scopes]] is</b> used for further search, which are sorted out, in turn.  If the value is found, then the link to it falls into a special Closure object.  At the same time, for each context that the current closes to, a separate <b>Closure</b> is created with the necessary variables. </li><li>  If no value is found in any Scopes, including Global, the ReferenceError is returned. </li></ul><br>  That's all! <br><br>  I hope this article was useful to you and now you understand how the closure mechanism works in JavaScript. <br><br>  Bye everyone :) And until we meet again.  Like and subscribe to my channel :) </div><p>Source: <a href="https://habr.com/ru/post/459166/">https://habr.com/ru/post/459166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459152/index.html">Fill documents in Microsoft Word using Python. Part 2</a></li>
<li><a href="../459154/index.html">Network for small businesses on Cisco equipment. Part 1</a></li>
<li><a href="../459156/index.html">VNIITE planet of the whole: how in the USSR the system of ‚Äúsmart home‚Äù was invented</a></li>
<li><a href="../459158/index.html">How Artifact was Valve's biggest failure</a></li>
<li><a href="../459162/index.html">"To win the championships, the team must breathe in unison." Interview with Moscow Workshops ICPC coach</a></li>
<li><a href="../459168/index.html">Bypassing Windows Defender cheap and cheerful: meterpreter session through python</a></li>
<li><a href="../459172/index.html">Top 13 Scala libraries for data analysis</a></li>
<li><a href="../459174/index.html">Rx Event Source Reference</a></li>
<li><a href="../459176/index.html">Stable high voltage source to power the PMT</a></li>
<li><a href="../459180/index.html">TheOutloud - voice and share your favorite articles and stories. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>