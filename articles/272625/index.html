<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write a JS library in ScalaJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Scala.js opens up a huge world of front-end technologies for Scala developers. Usually, projects using Scala.js are web or nodejs applications, but th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write a JS library in ScalaJS</h1><div class="post__text post__text-html js-mediator-article">  Scala.js opens up a huge world of front-end technologies for Scala developers.  Usually, projects using Scala.js are web or nodejs applications, but there are times when you just need to create a JavaScript library. <br><br>  There are some subtleties in writing such a Scala.js library, but they will seem familiar to JS developers.  In this article, we will create a simple Scala.js library ( <a href="https://github.com/vpavkin/scalajs-library-tips">code</a> ) to work with the <a href="https://developer.github.com/">Github API</a> and focus on the idiomatic JS API. <br><br>  But first, you probably want to ask why you might even need to do such a library?  For example, if you already have a client application written in JavaScript and it communicates with the Scala backend. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is unlikely that you will be able to write it from scratch using Scala.js, but you can write a library for interaction between you and the front-end developers, which will allow you to: <br><ul><li>  hide complex or non-obvious client-side logic in it and provide a convenient API; </li><li>  in the library you can work with models from the backend application; </li><li>  isomorphic code out of the box and you can forget about protocol synchronization problems; </li><li>  You will have a public API for developers like Facebook's Parse. </li></ul><br>  It is also a great choice for developing the Javascript API SDK, thanks to all these benefits. <br><br>  Recently, I was faced with the fact that our REST JSON API has two different browser clients, so developing an isomorphic library was a good choice. <br><a name="habracut"></a><br>  <b>Let's start the library creation</b> <br><br>  Requirements: as Scala developers, we want to write in a functional style and use all Scala chips.  In turn, the library API should be easy to understand for JS developers. <br><br>  <b>Let's start with the directory structure</b> , it is no different from the usual structure for a Scala application: <br><pre><code class="scala hljs">+-- build.sbt +-- project ¬¶ +-- build.properties ¬¶ <span class="hljs-type"><span class="hljs-type">L</span></span>-- plugins.sbt +-- src ¬¶ <span class="hljs-type"><span class="hljs-type">L</span></span>-- main ¬¶ +-- resources ¬¶ ¬¶ +-- demo.js ¬¶ ¬¶ <span class="hljs-type"><span class="hljs-type">L</span></span>-- index-fastopt.html ¬¶ <span class="hljs-type"><span class="hljs-type">L</span></span>-- scala <span class="hljs-type"><span class="hljs-type">L</span></span>-- version.sbt</code> </pre> <br><br>  <code>resources/index-fastopt.html</code> - the page will only load our library and the <code>resources/demo.js</code> file to check the API <br><br>  <b>API</b> <br><br>  The goal is to simplify interaction with the Github API.  To begin, we will make only one feature - the download of users and their repositories.  So this is a public method and a pair of models with response results.  Let's start with the model. <br><br>  <b>Model</b> <br><br>  Define our classes like this: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, avatarUrl: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, repos: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Repo</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sealed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">description</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stargazersCount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">homepage</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fork</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, description: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, stargazersCount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, homepage: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Origin</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, description: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, stargazersCount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, homepage: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">], forksCount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span></span></code> </pre><br><br>  Nothing complicated, <code>User</code> has several repositories, and the repository can be an original or fork, how can we export it for JS developers? <br><br>  <i>For a complete description of the functionality, see <a href="http://www.scala-js.org/doc/export-to-javascript.html">Export Scala.js APIs to Javascript</a> .</i> <br><br>  <b>API for creating objects.</b> <br>  Let's see how it works, a simple solution to export a constructor. <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fork</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, /*...*/</span></span></span><span class="hljs-class">)]</span></span></code> </pre><br>  But it won't work, you don't have an exported <code>Option</code> constructor, so you can't create a <code>homepage</code> parameter.  There are other restrictions for case classes, you cannot export constructors with inheritance, such code will not even compile <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">a: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@JSExport</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">b: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">12</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@JSExport</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Github</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFork</span></span></span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>, description: <span class="hljs-type"><span class="hljs-type">String</span></span>, stargazersCount: <span class="hljs-type"><span class="hljs-type">Int</span></span>, homepage: <span class="hljs-type"><span class="hljs-type">UndefOr</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>]): <span class="hljs-type"><span class="hljs-type">Fork</span></span> = <span class="hljs-type"><span class="hljs-type">Fork</span></span>(name, description, stargazersCount, homepage.toOption) }</code> </pre><br>  Here, using <code>js.UndefOr</code> we process an optional parameter in the JS style: you can pass a <code>String</code> or you can do without it at all: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// JS var homelessFork = Github().createFork("bar-fork", "Bar", 1); var fork = Github().createFork("bar-fork", "Bar", 1, "http://foo.bar");</span></span></code> </pre><br>  <b>A note regarding caching Scala objects:</b> <br><br>  Making a <code>Github()</code> call every time is not the best idea, if you don‚Äôt need laziness, you can cache them at startup: <br><pre> <code class="javascript hljs">&lt;!--index-fastopt.html--&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="xml"><span class="actionscript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="actionscript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="actionscript"> Github = Github()</span></span></span></span></code> </pre><br><br>  If we now try to get the name of the fork, we get <code>undefined</code> .  Everything is correct, it was not exported, let's export the model properties. <br><br>  There are no problems with native types such as <code>String</code> , <code>Boolean</code> or <code>Int</code> , you can export them like this: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br><br>  The case field of a class can be exported using the <code>@(JSExport@field)</code> annotation.  Example for <code>forks</code> property: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Origin</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, description: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, stargazersCount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, homepage: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">], @(</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">JSExport</span></span></span></span><span class="hljs-class"><span class="hljs-params">@field</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forks</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-type"><span class="hljs-type">Repo</span></span></code> </pre><br><br>  <b>Option</b> <br><br>  But you guessed it there is a problem with <code>homepage: Option[String]</code> .  We can export it too, but it is useless to get the value from <code>Option</code> , js the developer will have to call some method, but for <code>Option</code> nothing is exported. <br><br>  On the other hand, we would like to save <code>Option</code> so that our Scala code remains simple and straightforward.  A simple solution is to export a special js getter: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.scalajs.js.<span class="hljs-type"><span class="hljs-type">JSConverters</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... //  ,      JS def homepage: Option[String] @JSExport("homepage") def homepageJS: js.UndefOr[String] = homepage.orUndefined }</span></span></code> </pre><br><br>  Let's try: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"fork.name: "</span></span> + fork.name); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"fork.homepage: "</span></span> + fork.homepage);</code> </pre><br><br>  We left our favorite <code>Option</code> and made a clean beautiful JS API.  Hooray! <br><br>  <b>List</b> <br><br>  <code>User.repos</code> is a <code>List</code> and has difficulty exporting it.  The solution is the same, just export it as a JS array: <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span>(<span class="hljs-string"><span class="hljs-string">"repos"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reposJS</span></span></span></span>: js.<span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Repo</span></span>] = repos.toJSArray <span class="hljs-comment"><span class="hljs-comment">// JS user.repos.map(function (repo) { return repo.name; });</span></span></code> </pre><br><br>  <b>Subtypes</b> <br><br>  There is still one problem with the <code>Repo</code> trait.  Since we do not export constructors, the JS developer will not be able to figure out which subtype of <code>Repo</code> he is dealing with. <br><br>  there is no pattern matching in Javascript (pattern matching) and the use of inheritance is not so popular (and sometimes controversial), so we have several options: <br><br><ul><li>  Create <code>isFork: Boolean</code> or <code>hasForks: Boolean</code> methods.  This is normal, but not generalized enough. </li><li>  Add the <code>type: String</code> property for all subtypes. </li></ul><br><br>  I choose the 2 way, it is easy to abstract and use it in the whole project, let's declare mixin which exports the <code>type</code> property: <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Typed</span></span></span><span class="hljs-class"> </span></span>{ self =&gt; <span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span>(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typ</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = self.getClass.getSimpleName } &lt;/code&gt;    ,   &lt;code&gt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;/code&gt;</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scala</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;source</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang=</span></span></span><span class="hljs-class">"</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scala</span></span></span><span class="hljs-class">"</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&gt;</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sealed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Typed</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br><br>  ... and use it: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// JS fork.type // "Fork"</span></span></code> </pre><br><br>  You can make a little safer by storing constants (here the compiler will help us): <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeNameConstant</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassTag</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span>(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typ</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = classTag[<span class="hljs-type"><span class="hljs-type">T</span></span>].runtimeClass.getSimpleName }</code> </pre><br><br>  With this helper, we can declare the necessary constants in the <code>GitHub</code> object: <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSExportAll</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Github</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... val Fork = new TypeNameConstant[model.Fork] val Origin = new TypeNameConstant[model.Origin] }</span></span></code> </pre><br><br>  This will allow us to avoid javascript strings, an example <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// JS function isFork(repo) { return repo.type == Github.Fork.type }</span></span></code> </pre><br><br>  This is how we work with subtypes. <br><br>  <b>What if I can't change the object I want to export?</b> <br><br>  In this case, you may be exporting your cross-compiled model classes or objects from imported libraries.  The methods are the same for <code>Option</code> and for <code>List</code> , with one difference ‚Äî you need to implement the JS acceptable wrapper and conversion classes yourself. <br><br>  Here it is important to use js replacements for export only ( <code>Scala =&gt; JS</code> ) and for creating instances ( <code>JS =&gt; Scala</code> ) All business logic should be implemented only by pure Scala classes. <br><br>  Suppose we have a class <code>Commit</code> , which we can not change. <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Commit</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">hash: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre><br><br>  Here's how to export it: <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommitJS</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromCommit</span></span></span></span>(c: <span class="hljs-type"><span class="hljs-type">Commit</span></span>): <span class="hljs-type"><span class="hljs-type">CommitJS</span></span> = <span class="hljs-type"><span class="hljs-type">CommitJS</span></span>(c.hash) } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommitJS</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">@(</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">JSExport</span></span></span></span><span class="hljs-class"><span class="hljs-params">@field</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hash</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toCommit</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Commit</span></span> = <span class="hljs-type"><span class="hljs-type">Commit</span></span>(hash) }</code> </pre><br><br>  Then, for example, the <code>Branch</code> class from the code we manage will look like this: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Branch</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">initial: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Commit</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span>(<span class="hljs-string"><span class="hljs-string">"initial"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialJS</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">CommitJS</span></span> = <span class="hljs-type"><span class="hljs-type">CommitJS</span></span>.fromCommit(initial) }</code> </pre><br><br>  Since in the JS environment, commits are represented as <code>CommitJS</code> objects, the factory method for <code>Branch</code> will be: <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSExport</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBranch</span></span></span></span>(initial: <span class="hljs-type"><span class="hljs-type">CommitJS</span></span>) = <span class="hljs-type"><span class="hljs-type">Branch</span></span>(initial.toCommit)</code> </pre><br><br>  Of course, this is not a super method, but it is checked by the compiler.  That is why I prefer to look at such a library not only as a proxy for value-classes, but as a facade that hides unnecessary details and simplifies the API. <br><br>  <b>AJAX</b> <br><br>  <b>Implementation</b> <br><br>  For simplicity, we will use the <a href="https://github.com/scala-js/scala-js-dom">scalajs-dom</a> <code>Ajax</code> library <a href="https://github.com/scala-js/scala-js-dom">extension</a> for network requests.  Let's digress from the export and just implement the API. <br><br>  In order not to complicate things, we will put everything related to AJAX into the <code>API</code> object, it will have two methods: to load the user and load the repository. <br><br>  We will also make a DTO layer to separate the API from the model.  The result of the method will be <code>Future[String \/ DTO]</code> , where <code>DTO</code> is the type of data requested, and <code>String</code> will represent an error. Here is the code itself: <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">API</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDTO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, avatar_url: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepoDTO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, description: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, stargazers_count: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, homepage: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">], forks: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, fork: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">login: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) (</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit ec: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span> \/ <span class="hljs-type"><span class="hljs-type">UserDTO</span></span>] = load(login, <span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$BASE_URL</span></span></span><span class="hljs-string">/users/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$login</span></span></span><span class="hljs-string">"</span></span>, jsonToUserDTO) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">repos</span></span></span></span>(login: <span class="hljs-type"><span class="hljs-type">String</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> ec: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span> \/ <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">RepoDTO</span></span>]] = load(login, <span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$BASE_URL</span></span></span><span class="hljs-string">/users/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$login</span></span></span><span class="hljs-string">/repos"</span></span>, arrayToRepos) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](login: <span class="hljs-type"><span class="hljs-type">String</span></span>, url: <span class="hljs-type"><span class="hljs-type">String</span></span>, parser: js.<span class="hljs-type"><span class="hljs-type">Any</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]) (<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> ec: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span> \/ <span class="hljs-type"><span class="hljs-type">T</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (login.isEmpty) <span class="hljs-type"><span class="hljs-type">Future</span></span>.successful(<span class="hljs-string"><span class="hljs-string">"Error: login can't be empty"</span></span>.left) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-type"><span class="hljs-type">Ajax</span></span>.get(url).map(xhr =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xhr.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { parser(js.<span class="hljs-type"><span class="hljs-type">JSON</span></span>.parse(xhr.responseText)) .map(_.right) .getOrElse(<span class="hljs-string"><span class="hljs-string">"Request failed: can't deserialize result"</span></span>.left) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-string"><span class="hljs-string">s"Request failed with response code </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${xhr.status}</span></span></span><span class="hljs-string">"</span></span>.left } ) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">BASE_URL</span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"https://api.github.com"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jsonToUserDTO</span></span></span></span>(json: js.<span class="hljs-type"><span class="hljs-type">Any</span></span>): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">UserDTO</span></span>] = <span class="hljs-comment"><span class="hljs-comment">//... private def arrayToRepos(json: js.Any): Option[List[RepoDTO]] = //... }</span></span></code> </pre><br><br>  Code deserialization is hidden, it is not interesting to us, the <code>load</code> method returns an error string if the code is not 200, otherwise it converts the answer into JSON, and then into DTO <br><br>  Now we can convert the API response to the model. <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.scalajs.concurrent.<span class="hljs-type"><span class="hljs-type">JSExecutionContext</span></span>.<span class="hljs-type"><span class="hljs-type">Implicits</span></span>.queue <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Github</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... def loadUser(login: String): Future[String \/ User] = { for { userDTO &lt;- EitherT(API.user(login)) repoDTO &lt;- EitherT(API.repos(login)) } yield userFromDTO(userDTO, repoDTO) }.run private def userFromDTO(dto: API.UserDTO, repos: List[API.RepoDTO]): User = //.. }</span></span></code> </pre><br><br>  Here we use monad transformer to work with <code>Future[\/[..]]</code> , and then convert the DTO into a model. <br><br>  Great, it looks like a functional Scala code, nice to look at.  Now let's move on to exporting the <code>loadUser</code> method for users of our library. <br><br>  <b>Share the Future</b> <br><br>  Now we have a question, what is the standard way to work with asynchronous calls in Javascript?  I can already hear the laughter of the js developers, because it does not exist.  Callbacks, event emitters, promises, fibers, generators, async / await, this is all used, what should we choose?  I think promises are the closest implementation to Scala Future.  Promises are very popular and are already supported out of the box <a href="http://caniuse.com/">by many</a> modern browsers, we will take them.  First you need to tell our code about promises.  this is called ‚ÄúTyped Facade‚Äù.  we can easily do it ourselves, but there is already an implementation in scalajs-dom.  Here is an example for those who want to do the implementation themselves: <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JSName</span></span>(<span class="hljs-string"><span class="hljs-string">"catch"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recover</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span> &gt;: <span class="hljs-type"><span class="hljs-type">A</span></span>]( onRejected: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>]): <span class="hljs-type"><span class="hljs-type">Promise</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>] = js.native <span class="hljs-meta"><span class="hljs-meta">@JSName</span></span>(<span class="hljs-string"><span class="hljs-string">"then"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">andThen</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>]( onFulfilled: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>]): <span class="hljs-type"><span class="hljs-type">Promise</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>] = js.native <span class="hljs-meta"><span class="hljs-meta">@JSName</span></span>(<span class="hljs-string"><span class="hljs-string">"then"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">andThen</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>]( onFulfilled: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>], onRejected: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>]): <span class="hljs-type"><span class="hljs-type">Promise</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>] = js.native }</code> </pre><br><br>  Well, companion object with methods like <code>Promise.all</code> .  Now we just need to expand this trait: <br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@JSName</span></span>(<span class="hljs-string"><span class="hljs-string">"Promise"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> executor: js.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Function2</span></span></span></span><span class="hljs-class"><span class="hljs-params">[js.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Function1</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">R</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-class"><span class="hljs-params">], js.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Function1</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-class"><span class="hljs-params">], </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Any</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scalajs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dom</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raw</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">]</span></span></code> </pre><br><br>  So, now we just need to convert <code>Future</code> to <code>Promise</code> .  We do this with the implicit class: <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">promise</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSFutureOps</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">E</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassTag</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">f: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Future</span></span></span></span><span class="hljs-class"><span class="hljs-params">[\/[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">E</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">R</span></span></span></span><span class="hljs-class"><span class="hljs-params">]]</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toPromise</span></span></span></span>(recovery: <span class="hljs-type"><span class="hljs-type">Throwable</span></span> =&gt; js.<span class="hljs-type"><span class="hljs-type">Any</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> ectx: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Promise</span></span>[<span class="hljs-type"><span class="hljs-type">R</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Promise</span></span>[<span class="hljs-type"><span class="hljs-type">R</span></span>]((resolve: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[<span class="hljs-type"><span class="hljs-type">R</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>], reject: js.<span class="hljs-type"><span class="hljs-type">Function1</span></span>[js.<span class="hljs-type"><span class="hljs-type">Any</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>]) =&gt; { f.onSuccess({ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> \/-(f: <span class="hljs-type"><span class="hljs-type">R</span></span>) =&gt; resolve(f) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> -\/(e: <span class="hljs-type"><span class="hljs-type">E</span></span>) =&gt; reject(e.asInstanceOf[js.<span class="hljs-type"><span class="hljs-type">Any</span></span>]) }) f.onFailure { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> e: <span class="hljs-type"><span class="hljs-type">Throwable</span></span> =&gt; reject(recovery(e)) } }) } }</code> </pre><br><br>  The recovery function turns the ‚Äúfallen‚Äù <code>Future</code> into the ‚Äúfallen‚Äù <code>Promise</code> .  The left side of the disjunction also ‚Äúdrops‚Äù the promise. <br><br>  So now let's share our promise with front-end friends, as usual we add it to the <code>Github</code> object next to the original method: <br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUser</span></span></span></span>(login: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span> \/ <span class="hljs-type"><span class="hljs-type">User</span></span>] = <span class="hljs-comment"><span class="hljs-comment">//... @JSExport("loadUser") def loadUserJS(login: String): Promise[User] = loadUser(login).toPromise(_.getMessage)</span></span></code> </pre><br>  Here, in case of an error, we drop the promise with an error from the exception.  Everything, now we can test API. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// JS Github.loadUser("vpavkin") .then(function (result) { console.log("Name: ", result.name); }, function (error) { console.log("Error occured:", error) }); // Name: Vladimir Pavkin</span></span></code> </pre><br><br>  Great, now we can use Future and everything we are used to - and still export it as an idiomatic JS API. <br><br>  <b>Conclusion Here are some tips on writing a Javascript library using Scala.js</b> <br><ul><li>  Cache exported objects on startup; </li><li>  Export <a href="http://www.scala-js.org/doc/js-interoperability.html">seamless</a> types as is; </li><li>  Do not export <code>Option</code> , <code>List</code> and other Scala items.  Use a getter that converts to <code>js.UndefOr</code> and <code>js.Array</code> ; </li><li>  Do not export constructors.  Use JS-friendly factories; </li><li>  JS-friendly means accepting <code>js.*</code> Types and convert them to standard Scala types; </li><li>  Mix the <code>type</code> string field into a sums type; </li><li>  Export <code>Future</code> as <code>JS Promise</code> ; </li><li>  First of all write to Scala.  Do not limit yourself in self-expression as a Scala-developer, use the full potential of the language. </li></ul><br>  Now you know that all this can be exported. <br><br>  Sample code can be found on GitHub: <a href="https://github.com/vpavkin/scalajs-library-tips">https://github.com/vpavkin/scalajs-library-tips</a> <br><br><img src="https://habrastorage.org/files/b0d/e05/84d/b0de0584d4f84eaeb5909f2f7316217a.png" align="left" width="100" height="100"><br>  <b>Vladimir Pavkin</b> <br>  Scala ‚Äì Developer </div><p>Source: <a href="https://habr.com/ru/post/272625/">https://habr.com/ru/post/272625/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272615/index.html">Top 10 largest campuses "cloud" data centers</a></li>
<li><a href="../272617/index.html">Learning to program is harder than it sounds.</a></li>
<li><a href="../272619/index.html">Self-modifying code</a></li>
<li><a href="../272621/index.html">Material Design Competition: Winners Announced</a></li>
<li><a href="../272623/index.html">Simple but useful plugin for Redmine</a></li>
<li><a href="../272627/index.html">Installing a virtual environment and agent program on the example of antivirus</a></li>
<li><a href="../272629/index.html">Calibrate Kinect v2 with OpenCV in Python</a></li>
<li><a href="../272631/index.html">The test from Rostelecom to test knowledge in the field of system administration and user support</a></li>
<li><a href="../272633/index.html">Free hosting control panels. "Coin"</a></li>
<li><a href="../272635/index.html">Heavy armor sound design for the InSomnia project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>