<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Portable RWLock for Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RWLock is such a synchronization primitive that allows simultaneous reading and exclusive writing. Those. reading blocks the record, but does not bloc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Portable RWLock for Windows</h1><div class="post__text post__text-html js-mediator-article">  RWLock is such a synchronization primitive that allows simultaneous reading and exclusive writing.  Those.  reading blocks the record, but does not block reading other threads, and the record blocks everything. <br><a name="habracut"></a><br>  So, this very useful primitive is available in posix threads and in Windows from Vista and beyond.  For Windows XP / 2003, you have to make it from two critical sections and events (UPD, in general, there is a better option, see UPD at the end of the article). <br><br>  Let's show how it looks (code courtesy of StackOverflow and slightly translated from C to C ++): <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLockXP</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XP</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: RWLockXP() : countsLock(), writerLock(), noReaders(), readerCount(<span class="hljs-number"><span class="hljs-number">0</span></span>), waitingWriter(FALSE) { InitializeCriticalSection(&amp;writerLock); InitializeCriticalSection(&amp;countsLock); <span class="hljs-comment"><span class="hljs-comment">/* * Could use a semaphore as well. There can only be one waiter ever, * so I'm showing an auto-reset event here. */</span></span> noReaders = CreateEvent (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, FALSE, FALSE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } ~RWLockXP() { DeleteCriticalSection(&amp;writerLock); DeleteCriticalSection(&amp;countsLock); CloseHandle(noReaders); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * We need to lock the writerLock too, otherwise a writer could * do the whole of rwlock_wrlock after the readerCount changed * from 0 to 1, but before the event was reset. */</span></span> EnterCriticalSection(&amp;writerLock); EnterCriticalSection(&amp;countsLock); ++readerCount; LeaveCriticalSection(&amp;countsLock); LeaveCriticalSection(&amp;writerLock); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ EnterCriticalSection(&amp;countsLock); assert (readerCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--readerCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitingWriter) { <span class="hljs-comment"><span class="hljs-comment">/* * Clear waitingWriter here to avoid taking countsLock * again in wrlock. */</span></span> waitingWriter = FALSE; SetEvent(noReaders); } } LeaveCriticalSection(&amp;countsLock); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ EnterCriticalSection(&amp;writerLock); <span class="hljs-comment"><span class="hljs-comment">/* * readerCount cannot become non-zero within the writerLock CS, * but it can become zero... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readerCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { EnterCriticalSection(&amp;countsLock); <span class="hljs-comment"><span class="hljs-comment">/* ... so test it again. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readerCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { waitingWriter = TRUE; LeaveCriticalSection(&amp;countsLock); WaitForSingleObject(noReaders, INFINITE); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* How lucky, no need to wait. */</span></span> LeaveCriticalSection(&amp;countsLock); } } <span class="hljs-comment"><span class="hljs-comment">/* writerLock remains locked. */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LeaveCriticalSection(&amp;writerLock); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: CRITICAL_SECTION countsLock; CRITICAL_SECTION writerLock; HANDLE noReaders; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> readerCount; BOOL waitingWriter; };</code> </pre> <br>  But how could this beauty look like when using only Vista + systems: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLockSRW</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">For</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Vista</span></span></span><span class="hljs-class">+ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">based</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Slim</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLock</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: RWLockSRW() : srwLock() { InitializeSRWLock(&amp;srwLock); } ~RWLockSRW() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AcquireSRWLockShared(&amp;srwLock); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ReleaseSRWLockShared(&amp;srwLock); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AcquireSRWLockExclusive(&amp;srwLock); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ReleaseSRWLockExclusive(&amp;srwLock); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: RTL_SRWLOCK srwLock; };</code> </pre><br>  Not only does it look outrageously simple, it also works an order of magnitude faster.  But, there is one thing, but, as always ... When trying to launch an application containing this code (of course, we are smart guys, we made the definition of the version and for XP we want to use the first option, and for the new systems - the second), we get a message like: ‚Äúoh, but InitializeSRWLock function was not found in kernel32, after which our application would be kindly nailed. <br><br>  The solution is to load the Slim RWLock functions dynamically using LoadLibrary, function pointers and all this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__stdcall *SRWLock_fptr)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PSRWLOCK)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLockSRW</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">For</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Vista</span></span></span><span class="hljs-class">+ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">based</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Slim</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLock</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: RWLockSRW() : hGetProcIDDLL(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), AcquireSRWLockShared_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), ReleaseSRWLockShared_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), AcquireSRWLockExclusive_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), ReleaseSRWLockExclusive_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), srwLock() { <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> path[MAX_PATH] = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; GetSystemDirectory(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring dllPath = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring(path) + <span class="hljs-string"><span class="hljs-string">L"\\kernel32.dll"</span></span>; HINSTANCE hGetProcIDDLL = LoadLibrary(dllPath.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hGetProcIDDLL) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading kernel32.dll"</span></span>); } AcquireSRWLockShared_func = (SRWLock_fptr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"AcquireSRWLockShared"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AcquireSRWLockShared_func) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading AcquireSRWLockShared"</span></span>); } ReleaseSRWLockShared_func = (SRWLock_fptr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"ReleaseSRWLockShared"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ReleaseSRWLockShared_func) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading ReleaseSRWLockShared"</span></span>); } AcquireSRWLockExclusive_func = (SRWLock_fptr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"AcquireSRWLockExclusive"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!AcquireSRWLockExclusive_func) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading AcquireSRWLockExclusive"</span></span>); } ReleaseSRWLockExclusive_func = (SRWLock_fptr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"ReleaseSRWLockExclusive"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ReleaseSRWLockExclusive_func) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading ReleaseSRWLockExclusive"</span></span>); } SRWLock_fptr InitializeSRWLock_func = (SRWLock_fptr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"InitializeSRWLock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!InitializeSRWLock_func) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception(<span class="hljs-string"><span class="hljs-string">"SRWLock Error loading InitializeSRWLock"</span></span>); } InitializeSRWLock_func(&amp;srwLock); } ~RWLockSRW() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hGetProcIDDLL) { FreeLibrary(hGetProcIDDLL); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AcquireSRWLockShared_func) { AcquireSRWLockShared_func(&amp;srwLock); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReleaseSRWLockShared_func) { ReleaseSRWLockShared_func(&amp;srwLock); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AcquireSRWLockExclusive_func) { AcquireSRWLockExclusive_func(&amp;srwLock); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReleaseSRWLockExclusive_func) { ReleaseSRWLockExclusive_func(&amp;srwLock); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HINSTANCE hGetProcIDDLL; SRWLock_fptr AcquireSRWLockShared_func; SRWLock_fptr ReleaseSRWLockShared_func; SRWLock_fptr AcquireSRWLockExclusive_func; SRWLock_fptr ReleaseSRWLockExclusive_func; RTL_SRWLOCK srwLock; };</code> </pre><br>  Looks curly, but it became portable.  It remains to make the wrapper automatically select the desired option depending on the version of Windows: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLock</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wrapper</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: RWLock() : rwLockXP(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), rwLockSRW(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), isVistaPlus(IsWindowsVistaOrGreater()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { rwLockSRW = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RWLockSRW(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rwLockXP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RWLockXP(); } } ~RWLock() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> rwLockSRW; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> rwLockXP; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { rwLockSRW-&gt;readLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rwLockXP-&gt;readLock(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { rwLockSRW-&gt;readUnLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rwLockXP-&gt;readUnLock(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { rwLockSRW-&gt;writeLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rwLockXP-&gt;writeLock(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isVistaPlus) { rwLockSRW-&gt;writeUnLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rwLockXP-&gt;writeUnLock(); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: RWLockXP *rwLockXP; RWLockSRW *rwLockSRW; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isVistaPlus; };</code> </pre><br>  And at the end of the autolocher: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScopedRWLock</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ScopedRWLock(RWLock *lc_, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> write_ = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) : lc(*lc_), write(write_) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (write) { lc.writeLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { lc.readLock(); } } ~ScopedRWLock() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (write) { lc.writeUnLock(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { lc.readUnLock(); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: RWLock &amp;lc; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> write; <span class="hljs-comment"><span class="hljs-comment">// Non copyable! static void *operator new(size_t); static void operator delete(void *); ScopedRWLock(const ScopedRWLock&amp;); void operator=(const ScopedRWLock&amp;); };</span></span></code> </pre><br>  An implementation using pthread is no different from the first version of SRWLock, with the exception of other names of called functions. <br><br>  UPD: <br>  <a href="https://habrahabr.ru/post/317958/">They</a> suggested that there are wonderful undocumented functions (they are present even with Windows 2000 and they still exist (as of January 31, 2017 in Windows 10 they have not gone away)), they work better than crutches from the event and mutexes. <br>  I give an option with their use (I recommend using it): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RTL_RWLOCK</span></span></span><span class="hljs-class"> {</span></span> RTL_CRITICAL_SECTION rtlCS; HANDLE hSharedReleaseSemaphore; UINT uSharedWaiters; HANDLE hExclusiveReleaseSemaphore; UINT uExclusiveWaiters; INT iNumberActive; HANDLE hOwningThreadId; DWORD dwTimeoutBoost; PVOID pDebugInfo; } RTL_RWLOCK, *LPRTL_RWLOCK; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__stdcall *RtlManagePtr)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LPRTL_RWLOCK)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__stdcall *RtlOperatePtr)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LPRTL_RWLOCK, BYTE)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RWLockXP</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XP</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: RWLockXP() : hGetProcIDDLL(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), RtlDeleteResource_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), RtlReleaseResource_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), RtlAcquireResourceExclusive_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), RtlAcquireResourceShared_func(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), rtlRWLock() { <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> path[MAX_PATH] = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; GetSystemDirectory(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path)); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring dllPath = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring(path) + <span class="hljs-string"><span class="hljs-string">L"\\ntdll.dll"</span></span>; HINSTANCE hGetProcIDDLL = LoadLibrary(dllPath.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hGetProcIDDLL) { RtlDeleteResource_func = (RtlManagePtr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"RtlDeleteResource"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!RtlDeleteResource_func) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } RtlReleaseResource_func = (RtlManagePtr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"RtlReleaseResource"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!RtlReleaseResource_func) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } RtlAcquireResourceExclusive_func = (RtlOperatePtr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"RtlAcquireResourceExclusive"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!RtlAcquireResourceExclusive_func) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } RtlAcquireResourceShared_func = (RtlOperatePtr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"RtlAcquireResourceShared"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!RtlAcquireResourceShared_func) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } RtlManagePtr RtlInitializeResource_func = (RtlManagePtr)GetProcAddress(hGetProcIDDLL, <span class="hljs-string"><span class="hljs-string">"RtlInitializeResource"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlInitializeResource_func) { RtlInitializeResource_func(&amp;rtlRWLock); } } } ~RWLockXP() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlDeleteResource_func) { RtlDeleteResource_func(&amp;rtlRWLock); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hGetProcIDDLL) { FreeLibrary(hGetProcIDDLL); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlAcquireResourceShared_func) { RtlAcquireResourceShared_func(&amp;rtlRWLock, TRUE); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlReleaseResource_func) { RtlReleaseResource_func(&amp;rtlRWLock); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlAcquireResourceExclusive_func) { RtlAcquireResourceExclusive_func(&amp;rtlRWLock, TRUE); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeUnLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RtlReleaseResource_func) { RtlReleaseResource_func(&amp;rtlRWLock); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HINSTANCE hGetProcIDDLL; RtlManagePtr RtlDeleteResource_func; RtlManagePtr RtlReleaseResource_func; RtlOperatePtr RtlAcquireResourceExclusive_func; RtlOperatePtr RtlAcquireResourceShared_func; RTL_RWLOCK rtlRWLock; };</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/317958/">https://habr.com/ru/post/317958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317948/index.html">Five reasons not to create a startup, but to remain a hired employee</a></li>
<li><a href="../317950/index.html">Yii2: Making a module for managing modules</a></li>
<li><a href="../317952/index.html">The release of Veeam Agent for Linux 1.0 (Free, Workstation, Server Edition)</a></li>
<li><a href="../317954/index.html">"Shrekaton", or How is the hackathon in MobileUp</a></li>
<li><a href="../317956/index.html">RUVDS introduced the Light and Dark Admin. Which side are you on?</a></li>
<li><a href="../317962/index.html">Business ONE: ERP for small business exists. And he too</a></li>
<li><a href="../317964/index.html">What do mobile QA and octopus have in common?</a></li>
<li><a href="../317966/index.html">UniFi Mesh - less compromise</a></li>
<li><a href="../317968/index.html">How to sell if your product group is not on Yandex.Market?</a></li>
<li><a href="../317970/index.html">How not to write too much</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>