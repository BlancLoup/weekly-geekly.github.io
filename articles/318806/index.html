<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How not to distribute prohibited content, but still feel the effect of 139-FZ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story will tell you how your Internet resource, especially if you are worried about security and using SSL on the site, may suddenly become unava...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How not to distribute prohibited content, but still feel the effect of 139-FZ</h1><div class="post__text post__text-html js-mediator-article">  This story will tell you how your Internet resource, especially if you are worried about security and using SSL on the site, may suddenly become unavailable for visitors from Russia, ostensibly at the behest of Roskomnadzor.  You can try for as long as you want to find a reason for yourself, but it turns out that nothing depends on you and either you are lucky and everything is resolved on its own, or there is a long and stubborn struggle for the purity of your IP address.  Well, you can still refuse SSL, which is hardly a good idea. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/516/b23/08a516b2303f7fe223ba8ddb17b3f512.jpg" alt="Magic"></div><a name="habracut"></a><br>  It all started on the evening of December 28th.  In the chat of our support flashed a discussion of a pair of tickets in which users complained about the inaccessibility of their sites.  There were no notifications that their IPs did not like the protection system against attacks, so the support service was asked to take clients through the standard diagnostic system: pings, traces, and so on. <br><br>  On the morning of December 29, there were already a dozen such complaints, which gave cause for concern.  Yes, and I myself had something wrong: via HTTP I could go to our resources, but via HTTPS - not.  I tried to track the logs of nginx to see if there was any abuse of calls, but I didn‚Äôt see a single login on behalf of my IP address. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Viewing the headers during the opening of the site via HTTP showed that requests began to pass through the provider proxy server with the addition of X-Cache type headers: MISS from zapret.  Yes, we were overgrown. <br><br><div class="spoiler">  <b class="spoiler_title">An example of an attempt to reach our IP using curl</b> <div class="spoiler_text"><code>kemko@dell-work: ~ $ curl --insecure --resolve 'testtest.test:443:185.129.101.243' -I https://testtest.test <br> curl: (7) Failed to connect to testtest.test port 443: Connection refused <br> <br> kemko@dell-work: ~ $ curl --resolve 'testtest.test:80:185.129.101.243' -I http://testtest.test <br> HTTP/1.1 404 Not Found <br> Server: nginx <br> Date: Fri, 30 Dec 2016 08:09:41 GMT <br> Content-Type: text/html; charset=utf-8 <br> Status: 404 Not Found <br> X-UA-Compatible: IE=Edge,chrome=1 <br> Cache-Control: no-cache <br> Set-Cookie: request_method=GET; path=/ <br> Set-Cookie: first_current_location=%2F; path=/; expires=Sat, 30-Dec-2017 08:09:41 GMT <br> Set-Cookie: first_referer=; path=/; expires=Sat, 30-Dec-2017 08:09:41 GMT <br> Set-Cookie: referer=; path=/; expires=Sat, 30-Dec-2017 08:09:41 GMT <br> Set-Cookie: current_location=%2F; path=/; expires=Sat, 30-Dec-2017 08:09:41 GMT <br> X-Request-Id: d16e4994ddeae80bec73120545035e75 <br> X-Runtime: 0.025788 <br> <b>X-Cache: MISS from zapret <br> Via: 1.1 zapret (squid/3.5.19)</b> <br> Connection: keep-alive <br></code> <br></div></div><br>  But what for?  I tried to take a fresh dump of unloading from one of the registry mirrors, pulled out blocked domains, compared it with our database, but did not find a single match. <br><br>  Then I remembered that, actually, I am at home now and feel the blocking charms directly on myself.  And I am connected to the provider, in technical support of which I once worked and some contacts from that time still exist.  I was lucky and after I was able to clearly explain what is wrong with us and what kind of help I need, the administrator of the provider dug out the domain for me, because of which our IP got blocked. <br><br>  The reason for this was the domain telzakaz.ru, but the situation did not become clearer, because judging by the <a href="https://reestr.rublacklist.net/rec/133344/">mirrors of the registry</a> , only 193.150.0.212 should be blocked. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b63/812/023/b6381202390e1bfb003be7cd653c4d69.png" alt="Extract from the registry"></div><br>  Rezolvim this domain and see a wonderful picture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e18/87f/660/e1887f660540b69e13a7b529a4597630.png" alt=":("></div><br><br>  Well, well, it is resolved now including on our IP.  But in the unloading of Roskomnadzor, this domain has only one IP address listed, and it is not ours! <br><br>  I asked what software my provider uses for blocking, because earlier he obviously used other mechanisms.  As it turned out, this year they implemented a solution from <a href="http://zapretservice.ru/">ZapretService</a> .  The site showed a rather interesting paragraph: <br><blockquote>  ZapretService by dns-requests calculates the ip-address of the server, where the listed url-address in the registry </blockquote><br>  It turns out that this software works in advance: the system independently resolves all the domains contained in the download, collects the received IP into a table and works on it.  Far from the fact that all the providers use this software, for whose clients we were unavailable.  But it was my provider who used it. <br><br>  You cannot reach each provider in a reasonable time, all the more so that such behavior had already been noticed even by TTC and Runnet, so I wrote a letter to the domain owner asking to exclude our IP, and at the same time began to communicate with the hosting service whose DNS he used. <br><br>  The owner was silent, his DNS hosting in every way did not want, at our request, to delete the A-record from our IP (and did it right, but this is not easier for us).  And at some point, the domain simply lost all 14 A-records.  Since the support of the DNS-hosting said that it was not them - apparently, it was the reaction of the domain owner to someone's appeal.  Whether on ours, or on the owner of some of the 13 remaining IP. <br><br><h3>  Total </h3><br>  Your site at any time may be unavailable from a large number of providers, including major highways.  For this you don‚Äôt even need to host something forbidden, it‚Äôs enough that it‚Äôs your IP that will accidentally fall into the hands of any blocked domain owner. <br><br>  This raises a number of questions and thoughts. <br><br>  First, of course, the question arises: can the producers of such software and providers themselves be legally able to take and expand the list of IPs that need to be blocked according to their additional heuristics?  I, I repent, have not thoroughly studied the law, but apparently they can.  Most likely, the law clearly does not spell out the opposite, but it is done for reinsurance: here comes the commission tomorrow, will try to check if you have a blocked site, and it will take and open, because its owner has changed IP, but Roskomnadzor has not yet had time to update the addresses in lists.  But you and I understand the possible reasons, and it may be so difficult to reach the inspectors that you have to challenge their findings in court. <br><br>  Secondly, if the law really allows providers to do this, then the law needs to be changed.  Because it should not be important whether the domain and / or IP is in the registry, but whether it contains information that is prohibited for distribution.  So, the courts must state the exact reasons for the blocking, and the Roskomnadzor, before listing the next IP of the blocked site, should check whether there is still content blocking. <br><br>  But in the third - until this bright future comes - what to do then?  At any moment (I think I'm starting to repeat) something can happen to you, with which, without the goodwill of a person with a blocked domain, nothing can be done at all. <br><br>  For ourselves at the moment, we have decided that we need to make a monster who will periodically receive the actual unloading in order to: <br><br><ol><li>  Do not give attach to the sites on our engine blocked domains; </li><li>  Rezolvit blocked domains and check if some of them started returning our IP; </li><li>  Just in case, also parse the nginx logs in search of visits to the blocked domains (well, you never know!). </li></ol><br>  And then, this monster will help us only quickly find out about the problem and its cause.  And the question of how to fix it is not relying on a miracle remains open. </div><p>Source: <a href="https://habr.com/ru/post/318806/">https://habr.com/ru/post/318806/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318796/index.html">Sending a GPS track via SMS</a></li>
<li><a href="../318798/index.html">We want to give you a New Year's gift, but we need your help.</a></li>
<li><a href="../318800/index.html">Creating music interfaces</a></li>
<li><a href="../318802/index.html">20 harmful tips on developing games on Unity</a></li>
<li><a href="../318804/index.html">How IT professionals work. Dmitry Kravchuk - CTO and co-founder of LinguaTrip</a></li>
<li><a href="../318808/index.html">Drupal and WordPress - comparison, analogies, similarities, differences</a></li>
<li><a href="../318810/index.html">iOS: work with the gallery (Photos framework)</a></li>
<li><a href="../318812/index.html">Mobile terminal client, how the idea was born</a></li>
<li><a href="../318814/index.html">VulnHub: IMF parsing 1 and another buffer overflow</a></li>
<li><a href="../318816/index.html">On the question of "lost time"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>