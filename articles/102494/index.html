<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>6 Ways to Kill Your Servers - Understanding Scalability in a Difficult Way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Learning how to scale your application without having any experience is very difficult. Now there are many sites devoted to these issues, but, unfortu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>6 Ways to Kill Your Servers - Understanding Scalability in a Difficult Way</h1><div class="post__text post__text-html js-mediator-article">  Learning how to scale your application without having any experience is very difficult.  Now there are many sites devoted to these issues, but, unfortunately, there is no solution that is suitable for all cases.  You still need to find solutions yourself that fit your requirements.  Just like me. <br><br>  A few years ago, my boss came to me and said: ‚ÄúWe have a new project for you.  This is the transfer of a site that already has 1 million visitors per month.  You need to move it and make sure that attendance can grow in the future without any problems. ‚ÄùI was already an experienced programmer, but had no experience in scalability.  And I had to learn scalability in a difficult way. <br><a name="habracut"></a><br>  The site's software was a CMS in PHP, using MySQL and Smarty.  The first thing was found a hosting company that had the experience of high-load projects.  We gave them our required configuration: <br><ul><li>  Load balancing (with margin) </li><li>  2 web servers </li><li>  MySQL server (with stock) </li><li>  development machine </li></ul><br>  What we got (the hoster said that this will be enough): <br><ul><li>  Load balancing - Single core, 1 GB RAM, <a href="http://en.wikipedia.org/wiki/Pound_%2528networking%2529">Pound</a> </li><li>  2 web servers - Dual core, 4 GB RAM, Apache </li><li>  MySQL server - Quad core, 8 GB RAM </li><li>  development machine - Single core, 1 GB RAM </li></ul><br>  For file synchronization, the hoster has installed <a href="http://en.wikipedia.org/wiki/DRBD">DRBD</a> in the active-active configuration. <br><br>  Finally, the transfer time has come.  Early in the morning we switched the domain to new IP and started monitoring our scripts.  We received the traffic almost immediately and it seemed that everything was working well.  Pages loaded quickly, MySQL handled a bunch of requests and everyone was happy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then, unexpectedly, the phone rang: ‚ÄúWe cannot go to the website, what is going on ?!‚Äù We looked into our monitoring software and saw that the servers had crashed and the site was not working.  Of course, the first thing we called the hoster and said: ‚Äúall of our servers have fallen.  What is happening ?! ‚ÄùThey promised to check the servers and call back after that.  Some time later they called: ‚ÄúYour file system is hopelessly corrupted.  What did you do ?! ‚ÄùThey stopped the balancer and told me to look at one of the web servers.  Having opened index.php, I was shocked.  It contained incomprehensible chunks of C code, error messages, and something similar to log files.  After a brief investigation, we determined that our DRBD was the cause. <br><br><h5>  Lesson number 1 </h5><br>  <i>Put the Smarty cache in an active-active DRBD cluster under high load and your site will crash.</i> <br><br>  While the hoster was restoring the web server, I rewrote part of the CMS so that the Smarty cache files were stored in the local file system.  The problem was found and fixed and we returned online. <br><br>  Now it was the beginning of the day.  Usually the peak of attendance was at the end of the day and until the early evening.  There were almost no visitors at night.  We again began to observe the system.  The site was loading, but as the peak time approached, the load increased and the responses slowed down.  I increased the Smarty cache life time, hoping that it would help, but it did not help.  Soon the servers started to generate timeout errors or blank pages.  Two web servers could not handle the load. <br><br>  Our client was nervous, but he understood that the move usually brings with it some problems. <br><br>  We needed to somehow reduce the load and we discussed this with the hoster.  One of their admins suggested a good idea: ‚ÄúYour servers are now on Apache + mod_php.  Can translate to Lighttpd?  This is a small project, but even Wikipedia uses it. ‚ÄùWe agreed. <br><br><h5>  Lesson number 2 </h5><br>  <i>Install an out-of-the-box web server on your servers, do not configure anything and your site will crash.</i> <br><br>  The administrator has reconfigured our servers as quickly as possible.  He abandoned Apache and switched to Lighttpd + FastCGI + Xcache configuration.  How many servers are stretched this time? <br><br>  Surprisingly, the servers worked well.  The load was significantly less than before, and the average response time was good.  After that, we decided to go home and rest - it was too late and we agreed that while we had nothing else to do. <br><br>  On the following days, the servers handled the load relatively well, but at peak times they were close to a fall.  We found that the bottleneck is MySQL and again called the hoster.  They advised master-slave replication of MySQL from a slave on each web server. <br><br><h5>  Lesson number 3 </h5><br>  <i>Even a productive database server has limitations - and when they are reached, your site will crash.</i> <br><br>  This problem was not so easy to fix.  CMS was very simple in this regard and there was no built-in ability to separate SQL queries.  The modification of this took some time, but the result was worthwhile. <br><br>  MySQL replication has truly done a miracle and the site has finally been stable.  Over the following weeks, the site began to gain popularity and the number of users began to grow.  And it was only a matter of time when the traffic would again exceed our resources. <br><br><h5>  Lesson number 4 </h5><br>  <i>Do not plan anything in advance and your site will fall sooner or later.</i> <br><br>  Fortunately, we continued to observe and plan.  We optimized the code, reduced the number of SQL queries, and unexpectedly learned about MemCached.  To begin with, I added MemCached to some of the main functions that were the most difficult.  When we deployed our changes to production, we could not believe the results - as if we had found the Holy Grail.  We reduced the number of requests per second by at least 50%.  Instead of buying another web server, we decided that it is better to use MemCached. <br><br><h5>  Lesson number 5 </h5><br>  <i>Do not cache anything and spend money on new hardware or your site will fall.</i> <br><br>  MemCached helped us reduce the load on MySQL by 70-80%, which resulted in a huge performance increase.  The page loaded even faster. <br><br>  Finally, our configuration seemed perfect.  Even at peak times, we didn‚Äôt have to worry about possible drops or long response times.  But suddenly one of the webservers started bringing us problems - error messages, blank pages, etc.  With the load, everything was fine and in most cases the server worked fine, but only in ‚Äúmost cases‚Äù. <br><br><h5>  Lesson number 6 </h5><br>  <i>Put a few hundred thousand small files in one directory, forget about the inode and your site will fall.</i> <br><br>  Yes it is.  We were so busy optimizing MySQL, PHP and web servers that we didn‚Äôt pay enough attention to the file system.  The cache smarty was stored in the local filesystem in the same directory.  The solution was to transfer Smarty to a separate partition from <a href="http://en.wikipedia.org/wiki/ReiserFS">ReiserFS</a> .  We also enabled the Smarty 'use_subdirs' option. <br><br>  Over the next years, we continued to optimize.  We put the Smarty cache in memcached, installed Varnish to reduce the load on the I / O system, switched to Nginx (Lighttpd randomly generated error 500), bought the best hardware and so on. <br><br><h5>  Conclusion </h5><br>  Website scaling is a never ending process.  As soon as you fix one bottleneck, you will most likely stumble upon the next.  Never think "That's it, we are done."  This will ruin your servers and possibly your business.  Optimization is an ongoing process.  If you are unable to do the work yourself due to lack of experience / resources - find a competent partner for collaboration.  Never stop discussing with your team and partners current problems and problems that may arise in the future. <br><br>  <i>About the author - Steffen Konerow, author of <a href="http://www.nrg-media.de/">High Performance Blog</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/102494/">https://habr.com/ru/post/102494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102482/index.html">Internship at Google 2 (Part 1)</a></li>
<li><a href="../102483/index.html">IE9 will support opacity</a></li>
<li><a href="../102484/index.html">Future culture</a></li>
<li><a href="../102486/index.html">Oracle BPEL - experience as a workflow engine</a></li>
<li><a href="../102487/index.html">JVC PICSIO - POCKET VIDEO CAMERA WITH THE POSSIBILITY OF INTERACTIVE ENTERTAINMENT, SIMPLE CONTROL AND HIGH-DOWNLOAD VIDEO</a></li>
<li><a href="../102495/index.html">Google made ukrainian doodle</a></li>
<li><a href="../102497/index.html">Apple patented touch technology for iMac</a></li>
<li><a href="../102499/index.html">Cisco CCNA / ICND1 for every self-respecting system administrator</a></li>
<li><a href="../102500/index.html">Open project work process</a></li>
<li><a href="../102501/index.html">Magazine "The Economist" called Yota breakthrough</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>