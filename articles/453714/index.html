<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Test client TON (Telegram Open Network) and new language Fift for smart contracts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More than a year ago it became known about the plans of the Telegram messenger to release its own decentralized network Telegram Open Network . Then a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Test client TON (Telegram Open Network) and new language Fift for smart contracts</h1><div class="post__text post__text-html js-mediator-article"><p>  More than a year ago it became known about the plans of the Telegram messenger to release its own decentralized network <strong>Telegram Open Network</strong> .  Then a voluminous technical document became available that was supposedly written by Nikolai Durov and described the structure of the future network.  For those who missed it, I recommend that you familiarize yourself with my retelling of this document ( <a href="https://habr.com/ru/post/354366/">part 1</a> , <a href="https://habr.com/ru/post/354568/">part 2</a> ; the third part, alas, is still gathering dust in drafts). </p><br><p>  Since then, there has been no significant news about the development status of TON until a couple of days ago (in one of the <a href="https://t.me/Tgram/171">unofficial channels</a> ) there was a link to the page <a href="https://test.ton.org/download.html">https://test.ton.org/download.html</a> , where the following is posted: </p><br><p>  ‚ó¶ <a href="">ton-test-liteclient-full.tar.xz</a> - light client sources for the TON test network; <br>  ‚ó¶ <a href="">ton-lite-client-test1.config.json</a> - configuration file for connecting to the test network; <br>  ‚ó¶ <a href="https://test.ton.org/README.txt">README</a> - information about building and running the client; <br>  ‚ó¶ <a href="https://test.ton.org/HOWTO.txt">HOWTO</a> - step-by-step instructions on creating a smart contract using a client; <br>  ‚ó¶ <a href="https://test.ton.org/ton.pdf">ton.pdf</a> is an updated document (dated March 2, 2019) with a technical review of the TON network; <br>  ‚ó¶ <a href="https://test.ton.org/tvm.pdf">tvm.pdf</a> - technical description of TVM (TON Virtual Machine, TON virtual machine); <br>  ‚ó¶ <a href="https://test.ton.org/tblkch.pdf">tblkch.pdf</a> - technical description of the blockchain TON; <br>  ‚ó¶ <a href="https://test.ton.org/fiftbase.pdf">fiftbase.pdf</a> - description of the new language Fift, designed to create smart contracts in TON. </p><br><p>  I repeat, there was no official confirmation of the page and all these documents by the Telegram, but the volume of these materials makes them quite plausible.  Launch a published client <strong>at your own risk</strong> . </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta">  Build a test client </h2><br><p>  To begin with, we will try to build and run a test client - the benefit, the <a href="https://test.ton.org/README.txt">README</a> describes this simple process in detail.  I will do this on the example of macOS 10.14.5, I can not vouch for the success of the assembly on other systems. </p><br><ol><li><p>  Download and unpack the <a href="">archive with source code</a> .  It is important to download the latest version, since backward compatibility is not guaranteed at this stage. </p><br></li><li><p>  Make sure that the latest versions of make, cmake (version 3.0.2 or higher), OpenSSL (including the C header files), g ++ or clang are installed on the system.  I did not have to reinstall anything, everything gathered right away. </p><br></li><li><p> Suppose the sources are unpacked into the <code>~/lite-client</code> folder.  Separately from it, we create an empty folder for the assembled project (for example, <code>~/liteclient-build</code> ), and from it ( <code>cd ~/liteclient-build</code> ) we call the following commands: </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="Successful customer build"><br><br>  To build the Fift interpreter for smart contracts (see below), also call </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p>  Download the current <a href="">configuration file</a> to connect to the test network and put it in the folder with the assembled client. </p><br></li><li><p>  <strong>Done</strong> , you can run the client: </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p>  If everything is done correctly, then you should see something like this: </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="Client launch"></p><br><p>  Available commands, as you can see, are few: </p><br><p>  ‚ó¶ <strong><code>help</code></strong> - display this list of commands; <br>  ‚ó¶ <strong><code>quit</code></strong> - exit; <br>  ‚ó¶ <strong><code>time</code></strong> - show the current time on the server; <br>  ‚ó¶ <strong><code>status</code></strong> ‚Äî show connection status and local database; <br>  ‚ó¶ <strong><code>last</code></strong> - update the blockchain status (load the last block).  This command is important to perform before any requests, to be sure that you see exactly the current state of the network. <br>  ‚ó¶ <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> - upload local file to TON network.  This is how the interaction with the network takes place, including, for example, the creation of new smart contracts and requests to transfer funds between accounts; <br>  ‚ó¶ <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> - show the current (at the time of the <strong><code>last</code></strong> command) the status of the account with the specified address; <br>  ‚ó¶ <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> - load a private key from a local file. </p><br><p>  If, when the client starts, you transfer the folder to it using the <code>-D</code> option, then it will add the last master unit block into it: </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p>  Now we can move on to more interesting things - learn the Fift language, try to compile a smart contract (for example, create a test wallet), upload it to the network and try transferring funds between accounts. </p><br><h2 id="yazyk-fift">  Fift language </h2><br><p>  From the document <a href="https://test.ton.org/fiftbase.pdf">fiftbase.pdf</a> you can find out that to create smart contracts, the Telegram team created a new stack language <strong>Fift</strong> (apparently, from the numeral <em>fifth</em> , by analogy with Forth, a language with which Fift has a lot in common). </p><br><p>  The document is quite lengthy, on 87 pages, and I will not begin to retell in detail its content within the framework of this article (at least, because I did not finish reading it :).  I‚Äôll dwell on the main points and give a couple of code examples in this language. </p><br><p>  At a basic level, the Fift syntax is quite simple: its code consists of <em>words</em> , usually separated by spaces or line breaks (a special case: some words do not require a separator after themselves).  Any <em>word</em> is a case-sensitive sequence of characters, to which some <em>definition</em> corresponds (roughly speaking, what the interpreter should do when it encounters this word).  If the word is not defined, the interpreter tries to parse it as a number and put it on the stack.  By the way, the numbers here are - suddenly - 257-bit integers, but there are no fractional ones at all - more precisely, they immediately turn into a pair of integers that form the numerator and denominator of a rational fraction. </p><br><p>  Words usually interact with the values ‚Äã‚Äãat the top of the stack.  A separate type of words - <em>prefix</em> - does not use the stack, but the characters following it from the source file.  For example, string literals are implemented this way - the character "quotation mark" ( <code>"</code> ) is a prefix word that searches for the next (closing) quotation mark and puts a string between them on the stack. Single-line ( <code>//</code> ) and multi-line ( <code>/*</code> ) behave in the same way. comments. </p><br><p>  At this almost all the internal structure of the language ends.  Everything else (including control constructs) is defined as words (either internal, such as arithmetic operations and the definition of new words; or defined in the ‚Äústandard library‚Äù <code>Fift.fif</code> , which lies in the <code>crypto/fift</code> in the source). </p><br><p>  A simple example of a program on Fift: </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p>  The first line defines the new word <code>setxy</code> (note the prefix <code>{</code> , which creates a block before the closing <code>}</code> and the prefix <code>:</code> which actually defines the word).  <code>setxy</code> takes a number from the top of the stack, defines (or redefines) it as a global <em>constant</em> <code>x</code> , and the square of this number - as a constant <code>y</code> (given that constant values ‚Äã‚Äãcan be redefined, I would rather call them variables, but I follow the naming in the language). </p><br><p>  In the next two lines, a number is put on the stack, <code>setxy</code> is <code>setxy</code> , then the values ‚Äã‚Äãof the <code>x</code> , <code>y</code> constants are output (the word is used for output <code>.</code> ), Both constants are placed on the stack, added up, and the result is also output.  As a result, we will see: </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  (The ‚Äúok‚Äù line is displayed by the interpreter when it finishes processing the current line in interactive input mode) </p><br><p>  Well, a full sample code: </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p>  This scary looking file is designed to create a smart contract - it will be placed in the <code>new-wallet-query.boc</code> after execution.  Please note that another one is used here, the assembler language for the TON Virtual Machine (I will not dwell on it in detail), whose instructions will be placed on the blockchain. </p><br><p>  Thus, the assembler for TVM is written in Fift - the sources of this assembler are in the <code>crypto/fift/Asm.fif</code> and are connected at the beginning of the above code snippet. </p><br><p>  What can I say, apparently, Nikolai Durov just loves to create new programming languages ‚Äã‚Äã:) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton">  Creating a smart contract and interacting with TON </h2><br><p>  So, suppose we assembled the TON client and the Fift interpreter, as described above, and got to know the language.  How to create a smart contract now?  This is covered in the <a href="https://test.ton.org/HOWTO.txt">HOWTO</a> file attached to the sources. </p><br><h3 id="akkaunty-v-ton">  TON accounts </h3><br><p>  As I described in <a href="https://habr.com/ru/post/354568/">the TON review</a> , this network contains more than one blockchain - there is one common, so-called.  ‚ÄúMaster‚Äù, as well as an arbitrary number of additional ‚Äúworkers‚Äù, identified by a 32-bit number.  The masterchain has the identifier -1, except that it can also use the ‚Äúbase‚Äù workpiece with the identifier 0. Each workpiece can have its own configuration.  Internally, each workpiece splits into shardchains, but this is already a part of the implementation, which need not be kept in mind. </p><br><p>  Within one workplace there are a lot of accounts that have their account_id identifiers.  For master and zero workflow, they are 256 bits long.  Thus, the account identifier is written, for example, as follows: </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  This is the ‚Äúraw‚Äù format: first the workflow ID, then the colon, and the account ID in hexadecimal. </p><br><p>  In addition, there is a shortened format - the workman number and the address of the account are encoded in binary form, the checksum is added to them and all of this is encoded in Base64: </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p>  Knowing this record format, we can request the current state of an account through a test client using the command </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  We get something like this: </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp: <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> for -1: 8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355): F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296: 1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  We see the structure that is stored in the DHT of the specified workman.  For example, the current balance of the account is in the <code>storage.state.code</code> , the smart contract code in <code>storage.state.data</code> and its current data in <code>storage.state.data</code> .  Please note that the TON data storage cell, the cells, is tree-like; each cell can have its own data as well as child cells.  This is shown as indents in the last lines. </p><br><h3 id="sborka-smart-kontrakta">  Build a smart contract </h3><br><p>  Now let's create such a structure ourselves (it is called BOC - <em>bag of cells</em> ) using the Fift language.  Fortunately, you will not have to write a smart contract yourself - in the <code>crypto/block</code> folder from the archive with source codes there is a file <code>new-wallet.fif</code> , which will help us create a new wallet.  Copy it to the folder with the client ( <code>~/liteclient-build</code> , if you acted according to the instructions above).  I cited its contents above as an example of code on Fift. </p><br><p>  Execute this file as follows: </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p>  Here, <code>&lt;source-directory&gt;</code> must be replaced with the path to the unpacked sources (the "~" symbol here, unfortunately, cannot be used, the full path is needed).  Instead of using the <code>-I</code> you can define the <code>FIFTPATH</code> environment <code>FIFTPATH</code> and put this path in it. </p><br><p>  Since we started Fift with the file name <code>new-wallet.fif</code> , it will execute it and finish.  If you omit the file name, you can play with the interpreter in interactive mode. </p><br><p>  After execution, something like this should be displayed in the console: </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p>  This means that the wallet with the identifier <code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> (or, which is the same, <code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code>  The corresponding code will be in the file <code>new-wallet-query.boc</code> , its address will be in <code>new-wallet.addr</code> , and the private key will be in <code>new-wallet.pk</code> (be careful, re-running the script will overwrite these files). </p><br><p>  Of course, the TON network does not know about this wallet yet, it is stored only in the form of these files.  Now you need to upload it to the network.  True, the problem is that to create a smart contract you need to pay a commission, and the balance of your account is still zero. </p><br><p>  In operation, this problem will be solved by buying grams on the exchange (or transfer from another wallet).  Well, in the current test mode, a special smart contract has been established, from which you can ask for up to 20 grams just like that. </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu">  Forming a request to someone else's smart contract </h3><br><p>  Request to the smart contract, distributing grams to the left and right, do so.  In the same <code>crypto/block</code> folder we find the file <code>testgiver.fif</code> : </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p>  We will also save it in the folder with the collected client, but we will fix the fifth line - before the line " <code>constant dest_addr</code> ".  Replace it with the address of the wallet that you created before (full, not abbreviated).  "-1:" does not need to be written at the beginning; instead, put "0x" at the beginning. </p><br><p>  You can also change the line <code>6.666 Gram*/ constant amount</code> - this is the amount in grams that you request (no more than 20).  Even if you specify an integer, leave a decimal point. </p><br><p>  Finally, you need to correct the line <code>0x00000011 constant seqno</code> .  The first number here is the current sequence number, which is stored in the account issuing the grams.  Where to get it from?  As mentioned above, launch the client and execute: </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  At the very end in the data of the smart contract will be </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  The number 0000000D (you will have more) is the sequence number, which should be substituted into <code>testgiver.fif</code> . </p><br><p>  Everything, save the file and run ( <code>./crypto/fift testgiver.fif</code> ).  At the output we get the file <code>wallet-query.boc</code> .  This is the generated <em>message</em> to someone else's smart contract - the request ‚Äútransfer so many grams to such an account‚Äù. </p><br><p>  With the help of the client, we upload it to the network: </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p>  If we now call <code>last</code> , and then again request the status of the account from which we asked for grams, then we should see that his sequence number increased by one, which means that he sent money to our account. </p><br><p>  The last step remains - load the code of our wallet (its balance has already been replenished, but without the smart contract code we cannot manage it).  <code>sendfile new-wallet-query.boc</code> - and that‚Äôs it, you have your own wallet on the TON network (albeit only a test one for now). </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy">  Create outbound transactions </h3><br><p>  To transfer money from the balance of the created account, there is a file <code>crypto/block/wallet.fif</code> , which also needs to be placed in the folder with the collected client. </p><br><p>  Similar to the previous steps, you need to correct the amount you transfer, the destination address (dest_addr), and seqno of your wallet (it is 1 after the wallet initialization and increases by 1 after each outgoing transaction - you can see it by requesting your account status) .  For tests, you can use, for example, my wallet - <code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> . </p><br><p>  When running ( <code>./crypto/fift wallet.fif</code> ), the script will take the address of your wallet (from where you are transferring) and its private key from the files <code>new-wallet.addr</code> and <code>new-wallet.pk</code> , and write the received message to <code>new-wallet-query.boc</code> . </p><br><p>  As before, to directly execute a transaction, call <code>sendfile new-wallet-query.boc</code> in the client.  After that, do not forget to update the state of the blockchain ( <code>last</code> ) and check that the balance and seqno of our wallet have changed ( <code>getaccount &lt;account_id&gt;</code> ). </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="Account Description"></p><br><p>  That's all, now we are able to create smart contracts in TON and send requests to them.  As you can see, the current functionality is already enough to, for example, make a more friendly wallet with a graphical interface (however, it is expected that it will already be available as part of the messenger). </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/453714/">https://habr.com/ru/post/453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45370/index.html">HolyWar: ‚Äã‚ÄãTemplate engines. Do they need? Are they wealthy? Forum.</a></li>
<li><a href="../453700/index.html">SDL 2 Tutorials: Lesson 1 - Hello, SDL 2</a></li>
<li><a href="../453706/index.html">How I passed the Google Cloud Professional Data Engineer certification exam</a></li>
<li><a href="../453708/index.html">Real-time OS AQUA RTOS for AVR MK in BASCOM AVR environment</a></li>
<li><a href="../453712/index.html">How eBay did a barcode scanner on WebAssembly</a></li>
<li><a href="../45372/index.html">Our VoIP startup Octopus</a></li>
<li><a href="../453720/index.html">Subtleties of Lambda Expressions in C #</a></li>
<li><a href="../453722/index.html">On the study of non-stationary processes</a></li>
<li><a href="../453728/index.html">Battle of Hyperstar</a></li>
<li><a href="../45373/index.html">HollyWar: ‚Äã‚ÄãTemplate engines. Do they need?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>