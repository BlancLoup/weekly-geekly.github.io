<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The long-awaited check CryEngine V</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In May 2016, the German company Crytek decided to publish the source code for the CryEngine V game engine on Github. The game engine is written in C +...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The long-awaited check CryEngine V</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6e5/628/6c9/6e56286c94cff2ee229e425b5d930d92.png" align="left">  In May 2016, the German company Crytek decided to publish the source code for the CryEngine V game engine on Github. The game engine is written in C ++ and immediately attracted the attention of both the open-source developer community and the PVS-Studio static analyzer development team that checks the quality of the open code projects.  Many different games from different game studios have been made on CryEngine of different versions, and now the engine has become available to even more developers.  The article contains an overview of errors detected using a static code analyzer. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  <a href="https://www.cryengine.com/">CryEngine</a> is a game engine created by the German company <a href="http://www.crytek.com/">Crytek</a> in 2002 and originally used in the first-person shooter Far Cry.  At CryEngine of different versions, many excellent games were made from different game studios that licensed the engine: Far Cry, Crysis, Entropia Universe, Blue Mars, Warface, Homefront: The Revolution, Sniper: Ghost Warrior, Armored Warfare, Evolve and <a href="https://en.wikipedia.org/wiki/List_of_CryEngine_games">many others</a> .  In March 2016, Crytek announced the release of its new engine, the CryEngine V, and soon published the source code on <a href="https://github.com/CRYTEK-CRYENGINE/CRYENGINE">Github</a> . <br><br>  To check the open source code, the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static analyzer version 6.05 was used.  It is a tool for detecting errors in the source code of programs written in C, C ++ and C # languages.  The only correct way to use the static analysis methodology is to <b>regularly</b> check the code on the developers' computers and the build server.  But to demonstrate the capabilities of the PVS-Studio analyzer, we perform one-time <a href="http://www.viva64.com/ru/a/0084/">checks of open-source projects</a> and write review articles describing the errors found.  However, if the project seemed interesting to us, after the coming of one or two years, we can check it again.  In essence, such repeated checks are no different from one-time checks, since many changes accumulate in the code. <br><br>  Both well-known and popular projects, as well as those proposed by readers by e-mail, are selected for verification.  Therefore, among the game engines CryEngine V is not the first.  The following engines were tested: <ul><li>  Unreal Engine 4 ( <a href="http://www.viva64.com/ru/b/0249/">first check</a> , <a href="http://www.viva64.com/ru/b/0330/">second check</a> , <a href="http://www.viva64.com/ru/b/0356/">third check</a> ) </li><li>  <a href="http://www.viva64.com/ru/b/0321/">Godot Engine Check</a> </li><li>  <a href="http://www.viva64.com/ru/b/0384/">Serious Engine Check</a> </li><li>  <a href="http://www.viva64.com/ru/b/0405/">Check X-Ray Engine</a> </li><li>  <a href="http://www.viva64.com/en/b/0379/">Check Xenko Engine</a> </li></ul><br>  Also once was tested <a href="http://www.viva64.com/ru/b/0240/">CryEngine 3 SDK</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I want to pay special attention to checking the <a href="https://www.unrealengine.com/what-is-unreal-engine-4">Unreal Engine 4</a> game engine.  Using this project as an example, we were able to tell in detail about the correct application of the static analysis methodology on a real project: from introducing an analyzer into a project to reducing the number of warnings to zero, followed by monitoring for errors in the new code.  Our work with the Unreal Engine 4 project resulted in cooperation with Epic Games, in which PVS-Studio team fixed all the warnings of the analyzer in the engine source code, and a joint article was written about the work done, which was published in the <a href="https://www.unrealengine.com/blog/how-pvs-studio-team-improved-unreal-engines-code">Unreal Engine Blog</a> ( <a href="http://www.viva64.com/ru/b/0330/">link to Russian translation</a> ).  Epic Games also acquired a PVS-Studio license for independent control of the quality of the code.  We are ready for a similar cooperation with Crytek. <br><br><h2>  Analyzer report structure </h2><br>  In this article I want to answer several frequently asked questions related to the number of warnings and false positives.  For example, - ‚ÄúHow many percent are false alarms?‚Äù - or - ‚ÄúWhy are there so few errors in such a large project?‚Äù. <br><br>  To begin with, all the warnings of the PVS-Studio analyzer are divided into three levels of importance: <i>High</i> , <i>Medium</i> and <i>Low</i> .  For <i>example, the High</i> level contains high-critical warnings, which are most likely to be real errors, and the <i>Low</i> level contains warnings with low criticality, or warnings with a very high probability of a false positive response.  It should be remembered that a specific error code does not necessarily bind it to a certain level of importance, and the distribution of messages into groups strongly depends on the context in which they were generated. <br><br>  In the CryEngine V project, general analyzer warnings (General Analysis) are distributed by severity levels as follows: <ul><li>  High: 576 warnings; </li><li>  Medium: 814 warnings </li><li>  Low: 2942 warnings. </li></ul><br>  Figure 1 shows the distribution of warnings by severity level in a pie chart. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/248/f2c/9e3/248f2c9e31113f41c7d59d6491645217.png"></div><br><br>  <font color="#999999"><i>Figure 1 - Distribution of warnings by level of importance in percentage</i></font> <br><br>  It is impossible to fit the description of all warnings into the article and to show the corresponding code fragments.  Usually the article contains 10-40 examples of errors with the description.  Some suspicious code points are simply a list.  Most warnings remain pending.  At best, after notifying the developers, they ask for a full analyzer report for detailed study.  The bitter truth is that in most of the projects we check, the article is more than enough after viewing only <i>High</i> level alerts.  And the CryEngine V game engine is no exception.  Figure 2 shows the structure of <i>High</i> level alerts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/62d/ba1/085/62dba10852bfa226004d14a9034687e1.png"></div><br><br>  <font color="#999999"><i>Figure 2 - Description of High Level Warnings</i></font> <br><br>  Now in more detail about the sectors of the presented pie chart: <ul><li>  Described in the article (6%) - analyzer messages given in the article with code snippets and descriptions. </li><li>  Presented list (46%) - analyzer messages listed in the article list.  Such warnings are very similar to any case that has already been described in detail in the article, so the information about the warning is simply indicated. </li><li>  False Positive (8%) - a certain percentage of false positives were written out to refine the analyzer in the future. </li><li>  Skipped (40%) - all other analyzer messages.  They include warnings that could not be accommodated in an article that are not critical, not very interesting, or that were encountered on code sections that are difficult for a person not from the development team of the project to check.  As the work with the Unreal Engine 4 showed, in practice such code ‚Äúsmells‚Äù and all warnings are corrected anyway. </li></ul><br><h2>  Test results </h2><br><h3>  Offensive copy-paste </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cef/4e6/c7a/cef4e6c7a2a84e472fbe60b2c3220651.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions to the left and to the right of the operator: q2.vz - q2.vz entitynode.cpp 93 <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareRotation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Quat&amp; q1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Quat&amp; q2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epsilon)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (fabs_tpl(q1.vx - q2.vx) &lt;= epsilon) &amp;&amp; (fabs_tpl(q1.vy - q2.vy) &lt;= epsilon) &amp;&amp; (fabs_tpl(q2.vz - q2.vz) &lt;= epsilon) <span class="hljs-comment"><span class="hljs-comment">// &lt;= &amp;&amp; (fabs_tpl(q1.w - q2.w) &lt;= epsilon); }</span></span></code> </pre> <br>  A typo in one digit is perhaps one of the most offensive typos a programmer can make.  In this function, the analyzer detected a suspicious expression <i>(q2.vz - q2.vz)</i> , in which the variables <i>q1</i> and <i>q2 are</i> likely to be confused. <br><br>  V501 There are identical sub-expressions '(m_eTFSrc == eTF_BC6UH)' to the left and to the right of the '||'  operator.  texturestreaming.cpp 919 <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//! Texture formats. enum ETEX_Format : uint8 { .... eTF_BC4U, //!&lt; 3Dc+. eTF_BC4S, eTF_BC5U, //!&lt; 3Dc. eTF_BC5S, eTF_BC6UH, eTF_BC6SH, eTF_BC7, eTF_R9G9B9E5, .... }; bool CTexture::StreamPrepare(CImageFile* pIM) { .... if ((m_eTFSrc == eTF_R9G9B9E5) || (m_eTFSrc == eTF_BC6UH) || // &lt;= (m_eTFSrc == eTF_BC6UH)) // &lt;= { m_cMinColor /= m_cMaxColor.a; m_cMaxColor /= m_cMaxColor.a; } .... }</span></span></code> </pre> <br>  Another type of typos associated with copying constants.  In this case, the <i>m_eTFSrc</i> variable is compared twice with the <i>eTF_BC6UH</i> constant, in the place of which any other should be, for example, distinguished by just one letter - the <i>eTF_BC6SH</i> constant. <br><br>  Two more similar places in the project: <ul><li>  V501 There are identical sub-expressions '(td.m_eTF == eTF_BC6UH)' to the left and to the right of the '||'  operator.  texture.cpp 1214 </li><li>  V501 There are identical sub-expressions "geom_colltype_solid"  operator.  attachmentmanager.cpp 1004 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 266, 268. d3dhwshader.cpp 266 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SD3DShader::Release(EHWShaderClass eSHClass, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nSize) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eSHClass == eHWSC_Pixel) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((ID3D11PixelShader*)pHandle)-&gt;Release(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eSHClass == eHWSC_Vertex) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((ID3D11VertexShader*)pHandle)-&gt;Release(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eSHClass == eHWSC_Geometry) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return ((ID3D11GeometryShader*)pHandle)-&gt;Release(); // &lt;= else if (eSHClass == eHWSC_Geometry) // &lt;= return ((ID3D11GeometryShader*)pHandle)-&gt;Release(); // &lt;= else if (eSHClass == eHWSC_Hull) return ((ID3D11HullShader*)pHandle)-&gt;Release(); else if (eSHClass == eHWSC_Compute) return ((ID3D11ComputeShader*)pHandle)-&gt;Release(); else if (eSHClass == eHWSC_Domain) return ((ID3D11DomainShader*)pHandle)-&gt;Release() .... }</span></span></code> </pre> <br>  Here is an example of a lazy copy of a cascade of conditional statements, in one of the cases of which they forgot to make changes to the code. <br><br>  <a href="http://www.viva64.com/ru/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 970, 974. environmentalweapon.cpp 970 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CEnvironmentalWeapon::UpdateDebugOutput() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* attackStateName = <span class="hljs-string"><span class="hljs-string">"None"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_currentAttackState &amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= EAttackStateType_EnactingPrimaryAttack) // &lt;= { attackStateName = "Primary Attack"; } else if(m_currentAttackState &amp; // &lt;= EAttackStateType_EnactingPrimaryAttack) // &lt;= { attackStateName = "Charged Throw"; } .... }</span></span></code> </pre> <br>  In the previous code, there was at least some chance that the extra condition was the result of too many copies of the code and one check was simply superfluous.  In this code snippet, due to identical conditional expressions, the variable <i>attackStateName</i> will never take the value ‚ÄúCharged Throw‚Äù. <br><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'BlendFactor [2]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 1265, 1266. ccrydxgldevicecontext.cpp 1266 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CCryDXGLDeviceContext:: OMGetBlendState(...., FLOAT BlendFactor[<span class="hljs-number"><span class="hljs-number">4</span></span>], ....) { CCryDXGLBlendState::ToInterface(ppBlendState, m_spBlendState); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*ppBlendState) != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) (*ppBlendState)-&gt;AddRef(); BlendFactor[<span class="hljs-number"><span class="hljs-number">0</span></span>] = m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">0</span></span>]; BlendFactor[<span class="hljs-number"><span class="hljs-number">1</span></span>] = m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">1</span></span>]; BlendFactor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= BlendFactor[2] = m_auBlendFactor[3]; // &lt;= *pSampleMask = m_uSampleMask; }</span></span></code> </pre> <br>  In the project code, there was such a function, in which, because of a typo in the index, the filling of the element with the index three is <i>missing</i> : <i>BlendFactor [3]</i> .  This place would be just one of the interesting places with a typo, if the analyzer did not find another 2 fragments, where they copied the code with a typo: <br><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'm_auBlendFactor [2]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 904, 905. ccrydxgldevicecontext.cpp 905 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CCryDXGLDeviceContext:: OMSetBlendState(....<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FLOAT BlendFactor[<span class="hljs-number"><span class="hljs-number">4</span></span>], ....) { .... m_uSampleMask = SampleMask; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BlendFactor == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; m_auBlendFactor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= m_auBlendFactor[2] = 1.0f; // &lt;= } else { m_auBlendFactor[0] = BlendFactor[0]; m_auBlendFactor[1] = BlendFactor[1]; m_auBlendFactor[2] = BlendFactor[2]; // &lt;= m_auBlendFactor[2] = BlendFactor[3]; // &lt;= } m_pContext-&gt;SetBlendColor(m_auBlendFactor[0], m_auBlendFactor[1], m_auBlendFactor[2], m_auBlendFactor[3]); m_pContext-&gt;SetSampleMask(m_uSampleMask); .... }</span></span></code> </pre> <br>  This is the place where they continue to skip filling the element with the index '3'.  For a moment, I even thought that this made some sense, but this thought quickly left me, when at the end of the function I saw an appeal to all four elements of the <i>m_auBlendFactor</i> array.  It looks like in the file <i>ccrydxgldevicecontext.cpp</i> just made a few copies of the code with a typo. <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  d3dshadows.cpp 1410 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CD3D9Renderer::ConfigShadowTexgen(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((pFr-&gt;m_Flags &amp; DLF_DIRECTIONAL) || (!(pFr-&gt;bUseHWShadowMap) &amp;&amp; !(pFr-&gt;bHWPCFCompare))) { <span class="hljs-comment"><span class="hljs-comment">//linearized shadows are used for any kind of directional //lights and for non-hw point lights m_cEF.m_TempVecs[2][Num] = 1.f / (pFr-&gt;fFarDist); } else { //hw point lights sources have non-linear depth for now m_cEF.m_TempVecs[2][Num] = 1.f / (pFr-&gt;fFarDist); } .... }</span></span></code> </pre> <br>  At the end of the section on copy-paste I provide a description of another interesting error.  Regardless of the result of the conditional expression, the value of <i>m_cEF.m_TempVecs [2] [Num] is</i> always calculated using a single formula.  Judging by the adjacent code of this fragment, there is no typo in the index, in this condition they want to fill in exactly the element with the index '2'.  But the calculation formula most likely wanted to use a different one, but after copying the string, they forgot to change the code. <br><br><h3>  Initialization issues </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e4/ef0/cc8/1e4ef0cc86cc6f94c2c37c1cca716381.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0136/">V546</a> Member of a class is initialized by itself: 'eConfigMax (eConfigMax)'.  particleparams.h 1013 <br><pre> <code class="cpp hljs">ParticleParams() : .... fSphericalApproximation(<span class="hljs-number"><span class="hljs-number">1.f</span></span>), fVolumeThickness(<span class="hljs-number"><span class="hljs-number">1.0f</span></span>), fSoundFXParam(<span class="hljs-number"><span class="hljs-number">1.f</span></span>), eConfigMax(eConfigMax.VeryHigh), <span class="hljs-comment"><span class="hljs-comment">// &lt;= fFadeAtViewCosAngle(0.f) {}</span></span></code> </pre> <br>  The analyzer detected a possible typo when the class field is initialized using its own value. <br><br>  <a href="http://www.viva64.com/ru/d/0215/">V603</a> The object was not used.  If you wish to call the constructor, 'this-&gt; SRenderingPassInfo :: SRenderingPassInfo (....)' should be used.  i3dengine.h 2589 <br><pre> <code class="cpp hljs">SRenderingPassInfo() : pShadowGenMask(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) , nShadowSide(<span class="hljs-number"><span class="hljs-number">0</span></span>) , nShadowLod(<span class="hljs-number"><span class="hljs-number">0</span></span>) , nShadowFrustumId(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_bAuxWindow(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_nRenderStackLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_eShadowMapRendering(<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;uint8&gt;(SHADOW_MAP_NONE)) , m_bCameraUnderWater(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_nRenderingFlags(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_fZoomFactor(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>) , m_pCamera(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) , m_nZoomInProgress(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_nZoomMode(<span class="hljs-number"><span class="hljs-number">0</span></span>) , m_pJobState(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { threadID nThreadID = <span class="hljs-number"><span class="hljs-number">0</span></span>; gEnv-&gt;pRenderer-&gt;EF_Query(EFQ_MainThreadList, nThreadID); m_nThreadID = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;uint8&gt;(nThreadID); m_nRenderFrameID = gEnv-&gt;pRenderer-&gt;GetFrameID(); m_nRenderMainFrameID = gEnv-&gt;pRenderer-&gt;GetFrameID(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } SRenderingPassInfo(threadID id) { SRenderingPassInfo(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= SetThreadID(id); }</span></span></code> </pre> <br>  Here the analyzer has detected a misuse of the constructor  The programmer probably thought that calling the constructor in such a way without parameters inside another constructor would initialize the class fields, but this is not so. <br><br>  In this code, the following will occur: a new unnamed object of type <i>SRenderingPassInfo</i> will be created and immediately destroyed.  As a result, the class fields remain uninitialized.  One way to correct an error would be to write a separate initialization function and call it from different constructors. <br><br>  <a href="http://www.viva64.com/ru/d/0322/">V688</a> The c m_cNewGeomMML variable variable variable variable conf conf conf conf conf conf confusion.  terrain_node.cpp 344 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CTerrainNode::Init(....) { .... m_nOriginX = m_nOriginY = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// sector origin m_nLastTimeUsed = 0; // basically last time rendered uint8 m_cNewGeomMML = m_cCurrGeomMML = m_cNewGeomMML_Min .... m_pLeafData = 0; m_nTreeLevel = 0; .... }</span></span></code> </pre> <br>  The analyzer found the local variable <i>name cNewGeomMML matches</i> the class field.  Often such code is not an error, but here it looks very suspicious against the background of initialization of other fields of the class. <br><br>  <a href="http://www.viva64.com/ru/d/0175/">V575</a> The 'memset' function processes '0' elements.  Inspect the third argument.  crythreadutil_win32.h 294 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnableFloatExceptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... CONTEXT ctx; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;ctx, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ctx), <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  With the help of the analyzer a very interesting error was found.  When the <i>memset ()</i> function was called, the passed arguments were confused, and as a result, the function was called to fill 0 bytes of memory.  Here is the function prototype: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memset</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> num )</span></span></span></span>;</code> </pre> <br>  The third argument should be the size of the buffer, and the second is the value that needs to be filled. <br><br>  Corrected version: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnableFloatExceptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... CONTEXT ctx; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;ctx, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ctx)); .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0247/">V630</a> The '_alloca' function is used to allocate memory constructors.  command_buffer.cpp 62 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CBuffer::Execute() { .... QuatT * pJointsTemp = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;QuatT*&gt;( alloca(m_state.m_jointCount * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(QuatT))); .... }</code> </pre> <br>  In the project code, there are places where, using the <i>alloca ()</i> function, allocate memory for an array of objects.  In the above code, with this method of allocating memory to objects of the <i>QuatT</i> class, neither the constructor nor the destructor will call.  Such code can lead to working with uninitialized variables and other errors. <br><br>  The entire list of suspicious places: <ul><li>  V630 The '_alloca' function is used to allocate memory constructors.  command_buffer.cpp 67 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  posematching.cpp 144 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  characterinstance.cpp 280 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  characterinstance.cpp 282 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  scriptbind_entity.cpp 6252 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  jobmanager.cpp 1016 </li><li>  V630 The '_alloca' function is used to allocate memory constructors.  driverd3d.cpp 5859 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0186/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: -1.8f.  posealignerc3.cpp 330 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">ILINE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializePoseAlignerPinger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... chainDesc.offsetMin = Vec3(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.0f</span></span>, bIsMP ? <span class="hljs-number"><span class="hljs-number">-1.8f</span></span> : <span class="hljs-number"><span class="hljs-number">-1.8f</span></span>); chainDesc.offsetMax = Vec3(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.0f</span></span>, bIsMP ? +<span class="hljs-number"><span class="hljs-number">0.75f</span></span> : +<span class="hljs-number"><span class="hljs-number">1.f</span></span>); .... }</code> </pre> <br>  In the project code there are cases when the ternary operator <i>?:</i> Returns the same value.  Perhaps, in the previous case, so written for the beauty of the code, but why did they do it in this fragment? <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> predictDelta = inputSpeed &lt; <span class="hljs-number"><span class="hljs-number">0.0f</span></span> ? <span class="hljs-number"><span class="hljs-number">0.1f</span></span> : <span class="hljs-number"><span class="hljs-number">0.1f</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= float dict = angle + predictDelta * ( angle - m_prevAngle) / dt ;</span></span></code> </pre> <br>  All such places found in the project: <ul><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: -1.8f.  posealignerc3.cpp 313 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: -2.f.  posealignerc3.cpp 347 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: D3D11_RTV_DIMENSION_TEXTURE2DARRAY.  d3dtexture.cpp 2277 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: 255U.  renderer.cpp 3389 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: D3D12_RESOURCE_STATE_GENERIC_READ.  dx12device.cpp 151 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: 0.1f.  vehiclemovementstdboat.cpp 720 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0168/">V570</a> The 'runtimeData.entityId' variable is assigned to itself.  behaviortreenodes_ai.cpp 1771 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteEnterScript</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RuntimeData&amp; runtimeData)</span></span></span><span class="hljs-function"> </span></span>{ ExecuteScript(m_enterScriptFunction, runtimeData.entityId); runtimeData.entityId = runtimeData.entityId; <span class="hljs-comment"><span class="hljs-comment">// &lt;= runtimeData.executeExitScriptIfDestructed = true; }</span></span></code> </pre> <br>  Suspicious assignment of a variable to itself.  Developers should check out this place. <br><br><h3>  Priorities for operations </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/242/a62/50e/242a6250e8d7ef934322d6aa28db5ce7.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a lower limit than the '+' operator.  gpuparticlefeaturespawn.cpp 79 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasDuration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_useDuration; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFeatureSpawnRate::SpawnParticles(....) { .... SSpawnData&amp; spawn = pRuntime-&gt;GetSpawnData(i); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> amount = spawn.amount; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> spawnedBefore = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(spawn.spawned); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> endTime = spawn.delay + HasDuration() ? spawn.duration : fHUGE; .... }</code> </pre> <br>  It seems that in this function time is incorrectly measured.  The priority of the addition operator is higher than that of the ternary <i>?:</i> Operator, so the value <i>0</i> or <i>1 is</i> first added to <i>spawn.delay</i> , and the value <i>spawn.duration</i> or <i>fHUGE is</i> always written to the <i>endTime</i> <i>variable</i> .  This is a fairly common mistake.  I described the interesting error patterns in the priorities of operations found in the PVS-Studio error database in the article: <a href="http://www.viva64.com/ru/b/0390/">Logical expressions in C / C ++.</a>  <a href="http://www.viva64.com/ru/b/0390/">How wrong are the professionals</a> . <br><br>  <a href="http://www.viva64.com/ru/d/0251/">V634</a> The operation of the operation is higher than that of the operation.  It's possible that parentheses should not be used in the expression.  model.cpp 336 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> joint_flags { angle0_locked = <span class="hljs-number"><span class="hljs-number">1</span></span>, .... }; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CDefaultSkeleton::SetupPhysicalProxies(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... ; j++) { <span class="hljs-comment"><span class="hljs-comment">// lock axes with 0 limits range m_arrModelJoints[i]....flags |= (....) * angle0_locked &lt;&lt; j; } .... }</span></span></code> </pre> <br>  Another very interesting error related to the priority of multiply and bit-shift operations.  The latter has lower execution priority, so the entire expression at each iteration is multiplied by one (the constant <i>angle0_locked</i> is equal to one), which looks very strange. <br><br>  Most likely they wanted to write this: <br><pre> <code class="cpp hljs">m_arrModelJoints[i]....flags |= (....) * (angle0_locked &lt;&lt; j);</code> </pre> <br>  A list of 35 suspicious places with the priority of shift operators is given in the <a href="http://www.viva64.com/external-pictures/CryEngine5_V634.txt">CryEngine5_V634.txt</a> file. <br><br><h3>  Undefined behavior </h3><br>  Undefined behavior is a property of some programming languages ‚Äã‚Äãin certain situations to produce a result that depends on random factors, such as a memory state or an interrupt.  In other words, the specification does not define the behavior of the language in any possible situations.  It is considered an error to allow such a situation in the program, even if the program is successfully executed on some compiler, it will not be cross-platform and may fail on another machine, in another OS and even on other compiler settings. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cab/f72/33e/cabf7233ee6d64dc0d34307a9df0122e.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0225/">V610</a> Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  physicalplaceholder.h 25 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> physicalplaceholder_h #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> physicalplaceholder_h #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once .... const int NO_GRID_REG = -1&lt;&lt;14; const int GRID_REG_PENDING = NO_GRID_REG+1; ....</span></span></code> </pre> <br>  According to the current C ++ standard, a left-shift of a negative number leads to undefined behavior.  In addition, there are several more such places in the CryEngine V code: <ul><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '~ (TFragSeqStorage (0))' is negative.  udpdatagramsocket.cpp 757 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  tetrlattice.cpp 324 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  tetrlattice.cpp 350 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  tetrlattice.cpp 617 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '-1' is negative.  tetrlattice.cpp 622 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '(~ (0xF))' is negative.  d3ddeferredrender.cpp 876 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '(~ (0xF))' is negative.  d3ddeferredshading.cpp 791 </li><li>  V610 Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '(~ (1 &lt;&lt; 0))' is negative.  d3dsprites.cpp 1038 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0162/">V567</a> Undefined behavior.  The variable "m_current" variable  operatorqueue.cpp 105 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> COperatorQueue::Prepare(....) { ++m_current &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span>; m_ops[m_current].clear(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  The analyzer detected an expression that leads to undefined program behavior.  A variable is repeatedly used between two points of sequence, and its value changes.  As a result, it is impossible to predict the result of such an expression. <br><br>  More suspicious places: <ul><li>  V567 Undefined behavior.  The variable is variable.  trimesh.cpp 3101 </li><li>  V567 Undefined behavior.  The variable is variable.  trimesh.cpp 3108 </li><li>  V567 Undefined behavior.  I'tvtx variable  boolean3d.cpp 1194 </li><li>  V567 Undefined behavior.  I'tvtx variable  boolean3d.cpp 1202 </li><li>  V567 Undefined behavior.  I'tvtx variable  boolean3d.cpp 1220 </li><li>  V567 Undefined behavior.  The 'm_commandBufferIndex' variable is modified while being used between sequence points.  xconsole.cpp 180 </li><li>  V567 Undefined behavior.  The m_FrameFenceCursor variable is modified.  ccrydx12devicecontext.cpp 952 </li><li>  V567 Undefined behavior.  The m_iNextAnimIndex variable is modified.  hitdeathreactionsdefs.cpp 192 </li></ul><br><h3>  Different errors in conditions </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/308/652/a60/308652a60382ede7690daa37cb77c815.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0181/">V579</a>  It is possibly a mistake.  Inspect the third argument.  graphicspipelinestateset.h 58 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>==(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SComputePipelineStateDescription&amp; other) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;other, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  The equality operator made a mistake in calling the <i>memcmp ()</i> function, passing the pointer size to it, and not the size of the object.  Now objects are compared by the first few bytes. <br><br>  Corrected version: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, &amp;other, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>));</code> </pre> <br>  Unfortunately, there are three more such places in the project that are worth checking out: <ul><li>  V579  It is possibly a mistake.  Inspect the third argument.  geomcacherendernode.cpp 286 </li><li>  V579  It is possibly a mistake.  Inspect the second argument.  clipvolumemanager.cpp 145 </li><li>  V579  It is possibly a mistake.  Inspect the third argument.  graphicspipelinestateset.h 34 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0258/">V640</a> The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  livingentity.cpp 181 <br><pre> <code class="cpp hljs">CLivingEntity::~CLivingEntity() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;m_nParts;i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_parts[i].pPhysGeom || ....) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[] m_parts[i].pMatMapping; m_parts[i].pMatMapping=<span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  In the game engine code, I noticed a lot of places where developers write several operators per line.  Often, these are not even ordinary assignments, but cycles, conditions, function calls, and sometimes all this mixed up (Figure 3). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d22/7d8/b00/d227d8b00ccb8594ac8aa329223d70a1.png"></div><br><br>  <font color="#999999"><i>Figure 3 - Bad code formatting</i></font> <br><br>  With such a programming style, it is almost impossible to avoid errors on a large scale.  Thus, in the case under consideration, it was planned, under certain conditions, to free up memory from under an array of objects and to reset the pointer.  But due to incorrect formatting, the <i>m_parts [i] .pMatMapping pointer</i> is reset to each iteration of the loop.  What negative consequences this may have, I cannot predict, but the code is unequivocally alarming. <br><br>  A few more places with suspicious formatting: <ul><li>  V640 The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  physicalworld.cpp 2449 </li><li>  V640 The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  articulatedentity.cpp 1723 </li><li>  V640 The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  articulatedentity.cpp 1726 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0332/">V695</a> Range intersections are possible within conditional expressions.  Example: if (A &lt;5) {...} else if (A &lt;2) {...}.  Check lines: 538, 540. statobjrend.cpp 540 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CStatObj::RenderDebugInfo(....) { .... <span class="hljs-function"><span class="hljs-function">ColorB </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats == <span class="hljs-number"><span class="hljs-number">1</span></span>) clr = ColorB(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats == <span class="hljs-number"><span class="hljs-number">2</span></span>) clr = ColorB(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats == <span class="hljs-number"><span class="hljs-number">3</span></span>) clr = ColorB(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats == <span class="hljs-number"><span class="hljs-number">4</span></span>) clr = ColorB(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats == <span class="hljs-number"><span class="hljs-number">5</span></span>) clr = ColorB(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRenderMats &gt;= <span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= clr = ColorB(255, 0, 0, 255); else if (nRenderMats &gt;= 11) // &lt;= clr = ColorB(255, 255, 255, 255); .... }</span></span></code> </pre> <br>  In this code, the programmer made a mistake due to which the color <i>ColorB (255, 255, 255, 255)</i> will never be selected.  First, the values ‚Äã‚Äãof <i>nRenderMats are</i> compared in order with numbers from 1 to 5, but when the developer switched to working with a range of values, he did not take into account that values ‚Äã‚Äãgreater than 11 already fall into a range greater than 6, therefore, the latter condition is never satisfied. <br><br>  This cascade of conditions was completely copied to one more place: <ul><li>  V695 Range intersections are possible within conditional expressions.  Example: if (A &lt;5) {...} else if (A &lt;2) {...}.  Check lines: 338, 340. modelmesh_debugpc.cpp 340 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0332/">V695</a> Range intersections are possible within conditional expressions.  Example: if (A &lt;5) {...} else if (A &lt;2) {...}.  Check lines: 393, 399. xmlcpb_nodelivewriter.cpp 399 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> eNodeConstants { .... CHILDBLOCKS_MAX_DIST_FOR_8BITS = BIT(<span class="hljs-number"><span class="hljs-number">7</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">// 127 CHILDBLOCKS_MAX_DIST_FOR_16BITS = BIT(6) - 1, // 63 .... }; void CNodeLiveWriter::Compact() { .... if (dist &lt;= CHILDBLOCKS_MAX_DIST_FOR_8BITS) // dist &lt;= 127 { uint8 byteDist = dist; writeBuffer.AddData(&amp;byteDist, sizeof(byteDist)); isChildBlockSaved = true; } else if (dist &lt;= CHILDBLOCKS_MAX_DIST_FOR_16BITS) // dist &lt;= 63 { uint8 byteHigh = CHILDBLOCKS_USING_MORE_THAN_8BITS | ....); uint8 byteLow = dist &amp; 255; writeBuffer.AddData(&amp;byteHigh, sizeof(byteHigh)); writeBuffer.AddData(&amp;byteLow, sizeof(byteLow)); isChildBlockSaved = true; } .... }</span></span></code> </pre> <br>  A similar error in the condition was made in this code fragment, only now a rather large code fragment does not receive control.  The values ‚Äã‚Äãof the <i>CHILDBLOCKS_MAX_DIST_FOR_8BITS</i> and <i>CHILDBLOCKS_MAX_DIST_FOR_16BITS constants</i> have values ‚Äã‚Äãsuch that the second condition will never be true. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'pszScript [iSrcBufPos]! =' == '' is always true.  The value range of char type: [-128, 127].  luadbg.cpp 716 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CLUADbg::LoadFile(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pszFile, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bForceReload) { FILE* hFile = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pszScript = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, * pszFormattedScript = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pszScript[iSrcBufPos] != <span class="hljs-string"><span class="hljs-string">' '</span></span> &amp;&amp; .... pszScript[iSrcBufPos] != <span class="hljs-string"><span class="hljs-string">'='</span></span> &amp;&amp; pszScript[iSrcBufPos] != <span class="hljs-string"><span class="hljs-string">'=='</span></span> &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= pszScript[iSrcBufPos] != '*' &amp;&amp; pszScript[iSrcBufPos] != '+' &amp;&amp; pszScript[iSrcBufPos] != '/' &amp;&amp; pszScript[iSrcBufPos] != '~' &amp;&amp; pszScript[iSrcBufPos] != '"') {} .... }</span></span></code> </pre> <br>  In a large conditional expression, there is a subexpression that is always true.  The literal '==' will be of type <i>int</i> and will be equal to 15677. The <i>pszScript</i> array consists of elements of type <i>char</i> .  A value of type <i>char</i> cannot be 15677. That is why the expression <i>pszScript [iSrcBufPos]! = '==' is</i> always true. <br><br>  <a href="http://www.viva64.com/ru/d/0417/">V734</a> An excessive expression.  Examine the substrings "_ddn" and "_ddna".  texture.cpp 4212 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CTexture::PrepareLowResSystemCopy(byte* pTexData, ....) { .... <span class="hljs-comment"><span class="hljs-comment">// make sure we skip non diffuse textures if (strstr(GetName(), "_ddn") // &lt;= || strstr(GetName(), "_ddna") // &lt;= || strstr(GetName(), "_mask") || strstr(GetName(), "_spec.") || strstr(GetName(), "_gloss") || strstr(GetName(), "_displ") || strstr(GetName(), "characters") || strstr(GetName(), "$") ) return; .... }</span></span></code> </pre> <br>  The <i>strstr ()</i> function <i>searches</i> for the first occurrence of the specified substring in another string and returns a pointer to the first occurrence of the substring or a null pointer.  The first one looks for the substring "_ddn", and then "_ddna", which means that the condition will be met if a shorter substring is found.  Perhaps the code does not work as planned by the programmer.  Well, or at least the expression is redundant and can be simplified by removing the extra check. <br><br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting this expression.  The expression is misprint.  goalop_crysis2.cpp 3779 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> COPCrysis2FlightFireWeapons::ParseParam(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!paused &amp;&amp; (m_State == eFP_PAUSED) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= (m_State != eFP_PAUSED_OVERRIDE)) // &lt;= .... }</span></span></code> </pre> <br>  The conditional expression in the <i>ParseParam ()</i> function is written in such a way that the result does not depend on the subexpression ( <i>m_State! = EFP_PAUSED_OVERRIDE</i> ). <br><br>  Consider a simplified example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( err == code1 &amp;&amp; err != code2) { .... }</code> </pre> <br>  The result of the entire conditional expression does not depend on the result of the subexpression <i>(err! = Code2)</i> , which is clearly seen when building the truth table for this example (Figure 4) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3b1/379/ba5/3b1379ba5e37c89594fcf928bff7f8bf.png"></div><br><br>  <font color="#999999"><i>Figure 4 - Truth Table for Boolean Expression</i></font> <br><h3>  Comparing unsigned numbers with zero </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f9/550/2e4/3f95502e4e60f0842a9424ded0945100.png"></div><br><br>  In checked projects, there are often comparisons of unsigned numbers with zero, the result of which is always either true or false.  This code does not always contain a serious error.  Often this is the result of excessive caution, or the test remains after changing the type of variable from signed to unsigned.  In any case, such comparisons should be carefully checked. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'm_socket &lt;0' is always false.  Unsigned type value is never &lt;0. servicenetwork.cpp 585 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> SOCKET CRYSOCKET; <span class="hljs-comment"><span class="hljs-comment">// Internal socket data CRYSOCKET m_socket; bool CServiceNetworkConnection::TryReconnect() { .... // Create new socket if needed if (m_socket == 0) { m_socket = CrySock::socketinet(); if (m_socket &lt; 0) { .... return false; } } .... }</span></span></code> </pre> <br>      <i>SOCKET</i> ,         ,             ,     . <br><br>         0  -1,       .  CryEngine V   ,  -   , : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_socket == CRY_INVALID_SOCKET)</code> </pre> <br>          . <br><br> 47 ,       ,    <a href="http://www.viva64.com/external-pictures/CryEngine5_V547.txt">CryEngine5_V547.txt</a> .     . <br><br><h3>   </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f71/b68/5de/f71b685de1469b8a39287131b43d4271.png"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The diagnostic rule </font></font><a href="http://www.viva64.com/ru/d/0205/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> finds in the code dereferencing of pointers, the validity check of which is performed below the code, i.e. </font><font style="vertical-align: inherit;">after using the pointer. </font><font style="vertical-align: inherit;">In practice, this diagnosis is very steep errors. </font><font style="vertical-align: inherit;">A small number of false positives occur because the pointer check is performed indirectly, i.e. </font><font style="vertical-align: inherit;">through one or more other variables, but agree that it will be very difficult for a person to understand this code. </font><font style="vertical-align: inherit;">I will give three examples of how this diagnostic works, which is particularly surprising how this code works, the rest can be found in the </font></font><a href="http://www.viva64.com/external-pictures/CryEngine5_V595.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryEngine5_V595.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">.</font></font><br><br><h4>  Example 1 </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 The 'm_pPartManager' pointer has been verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 1441, 1442. 3denginerender.cpp 1441</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> C3DEngine::RenderInternal(....) { .... m_pPartManager-&gt;GetLightProfileCounts().ResetFrameTicks(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (passInfo.IsGeneralPass() &amp;&amp; m_pPartManager) m_pPartManager-&gt;Update(); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dereferencing and checking the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_pPartManager</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><font style="vertical-align: inherit;">.</font></font><br><br><h4>  Example 2 </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 The 'gEnv-&gt; p3DEngine' pointer was used against nullptr. </font><font style="vertical-align: inherit;">Check lines: 1477, 1480. gameserialize.cpp 1477</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CGameSerialize::LoadLevel(....) { .... <span class="hljs-comment"><span class="hljs-comment">// can quick-load if (!gEnv-&gt;p3DEngine-&gt;RestoreTerrainFromDisk()) return false; if (gEnv-&gt;p3DEngine) { gEnv-&gt;p3DEngine-&gt;ResetPostEffects(); } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dereferencing and checking the pointer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gEnv-&gt; p3DEngine</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Example 3 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 The 'pSpline' pointer was used before it was verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 158, 161. facechankeycleanup.cpp 158</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FaceChannel::CleanupKeys(....) { <span class="hljs-function"><span class="hljs-function">CFacialAnimChannelInterpolator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">backupSpline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pSpline)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create the key entries array. int numKeys = (pSpline ? pSpline-&gt;num_keys() : 0); .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dereferencing and checking the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pSpline</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><font style="vertical-align: inherit;">.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Miscellaneous Warnings </font></font></h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fa/0f3/b57/5fa0f3b57093b2fda5a9c1d8ec231f45.png"></div><br><br> <a href="http://www.viva64.com/ru/d/0239/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V622</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider inspecting the 'switch' statement. </font><font style="vertical-align: inherit;">It's possible that the operator is missing. </font><font style="vertical-align: inherit;">mergedmeshrendernode.cpp 999</font></font><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtractSphereSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (statusPos.pGeom-&gt;GetType()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GEOM_CAPSULE: statusPos.pGeom-&gt;GetPrimitive(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;cylinder); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GEOM_CYLINDER: statusPos.pGeom-&gt;GetPrimitive(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;cylinder); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; ....; ++i) { .... } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps this code fragment is the strangest of all that occurred in the project CryEngine V. The choice of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">case</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> label </font><font style="vertical-align: inherit;">does not depend on the conditional </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , even if there </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is (false)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executes an unconditional jump to a label if it satisfies the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expression </font><font style="vertical-align: inherit;">. Without the use of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">break</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> statement </font><font style="vertical-align: inherit;">, using such a code, it is possible to ‚Äúbypass‚Äù the execution of unnecessary statements, but again, not all developers can easily accompany such non-obvious code. And why </font><font style="vertical-align: inherit;">is the same code executed </font><font style="vertical-align: inherit;">when going to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GEOM_CAPSULE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GEOM_CYLINDER</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> labels </font><font style="vertical-align: inherit;">? </font></font><br><br> <a href="http://www.viva64.com/ru/d/0099/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V510</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The 'LogError' function is not expected to receive a class-type variable as the second actual argument. behaviortreenodes_action.cpp 143</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> CryStringT&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>; <span class="hljs-comment"><span class="hljs-comment">// The actual fragment name. string m_fragName; //! cast to C string. const value_type* c_str() const { return m_str; } const value_type* data() const { return m_str; }; void LogError(const char* format, ...) const { .... } void QueueAction(const UpdateContext&amp; context) { .... ErrorReporter(*this, context).LogError("....'%s'", m_fragName); .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If in the function description it is impossible to specify the number and types of all valid parameters, then the list of formal parameters is completed with an ellipsis (...), which means: ‚Äúand, possibly, some more arguments‚Äù. </font><font style="vertical-align: inherit;">Only POD (Plain Old Data) types can act as an actual parameter for an ellipse. </font><font style="vertical-align: inherit;">If the ellipse of the function is passed as a parameter to a class object, it almost always indicates the presence of an error in the program. </font><font style="vertical-align: inherit;">Instead of a pointer to a string, the contents of the object get into the stack </font><font style="vertical-align: inherit;">Such a code will lead to the formation of ‚Äúabracadabra‚Äù in the buffer or to the emergency termination of the program. </font><font style="vertical-align: inherit;">The CryEngine V code uses its own string class, and it already has a suitable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c_str ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">.</font></font><br><br>  Corrected version: <br><pre> <code class="cpp hljs">LogError(<span class="hljs-string"><span class="hljs-string">"....'%s'"</span></span>, m_fragName.c_str();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A few more suspicious places: </font></font><ul><li> V510 The 'LogError' function is not expected to receive class-type variable as second actual argument. behaviortreenodes_core.cpp 1339 </li><li> V510 The 'Format' function is not expected to receive class-type variable as second actual argument. behaviortreenodes_core.cpp 2648 </li><li> V510 The 'CryWarning' function is not expected to receive class-type variable as sixth actual argument. crypak.cpp 3324 </li><li> V510 The 'CryWarning' function is not expected to receive class-type variable as fifth actual argument. crypak.cpp 3333 </li><li> V510 The 'CryWarning' function is not expected to receive class-type variable as fifth actual argument. shaderfxparsebin.cpp 4864 </li><li> V510 The 'CryWarning' function is not expected to receive class-type variable as fifth actual argument. shaderfxparsebin.cpp 4931 </li><li> V510 The 'Format' function is not expected to receive class-type variable as third actual argument. featuretester.cpp 1727 </li></ul><br> <a href="http://www.viva64.com/ru/d/0118/">V529</a> Odd semicolon ';' after 'for' operator. boolean3d.cpp 1314 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CTriMesh::Slice(....) { .... bop_meshupdate *pmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bop_meshupdate, *pmd0; pmd-&gt;pMesh[<span class="hljs-number"><span class="hljs-number">0</span></span>]=pmd-&gt;pMesh[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; AddRef();AddRef(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(pmd0=m_pMeshUpdate; pmd0-&gt;next; pmd0=pmd0-&gt;next); <span class="hljs-comment"><span class="hljs-comment">// &lt;= pmd0-&gt;next = pmd; .... }</span></span></code> </pre> <br>    .   <i>for</i>    ,         . <br><br> <a href="http://www.viva64.com/ru/d/0124/">V535</a> The variable 'j' is being used for this loop and for the outer loop. Check lines: 3447, 3490. physicalworld.cpp 3490 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPhysicalWorld::SimulateExplosion(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(j=<span class="hljs-number"><span class="hljs-number">0</span></span>;j&lt;pmd-&gt;nIslands;j++) <span class="hljs-comment"><span class="hljs-comment">// &lt;= line 3447 { .... for(j=0;j&lt;pcontacts[ncont].nborderpt;j++) // &lt;= line 3490 { .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The project code is also full of other dangerous code, for example, using one counter in nested and external cycles. </font><font style="vertical-align: inherit;">Large files with source code contain confusing formatting and changing of some variables in different places - static analysis is indispensable here! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few more suspicious cycles:</font></font><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 The variable 'i' is being used for the loop. </font><font style="vertical-align: inherit;">Check lines: 1630, 1683. entity.cpp 1683</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 The variable 'i1' is being used for this loop. </font><font style="vertical-align: inherit;">Check lines: 1521, 1576. softentity.cpp 1576</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 The variable 'i' is being used for the loop. </font><font style="vertical-align: inherit;">Check lines: 2315, 2316. physicalentity.cpp 2316</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 The variable 'i' is being used for the loop. </font><font style="vertical-align: inherit;">Check lines: 1288, 1303. shadercache.cpp 1303</font></font></li></ul><br> <a href="http://www.viva64.com/ru/d/0128/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V539</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider inspecting iterators which are being passed as arguments to function 'erase'. </font><font style="vertical-align: inherit;">frameprofilerender.cpp 1090</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> CFrameProfileSystem::RenderPeaks() { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;SPeakRecord&gt;&amp; rPeaks = m_peaks; <span class="hljs-comment"><span class="hljs-comment">// Go through all peaks. for (int i = 0; i &lt; (int)rPeaks.size(); i++) { .... if (age &gt; fHotToColdTime) { rPeaks.erase(m_peaks.begin() + i); // &lt;= i--; } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer considered that an iterator from another container is passed to the function that performs the action with the container. </font><font style="vertical-align: inherit;">This is not the case in this code snippet and there is no error. </font><font style="vertical-align: inherit;">The variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rPeaks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a reference to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_peaks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">However, such a code can be misleading not only for the code analyzer, but also for the people who will accompany the code. </font><font style="vertical-align: inherit;">Do not write like that. </font></font><br><br> <a href="http://www.viva64.com/ru/d/0354/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V713</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The pointer was used against it. </font><font style="vertical-align: inherit;">actiongame.cpp 4235</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CActionGame::OnCollisionImmediate(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EventPhys* pEvent) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pMat-&gt;GetBreakability() == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; pCollision-&gt;idmat[<span class="hljs-number"><span class="hljs-number">0</span></span>] != pCollision-&gt;idmat[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp;&amp; (energy = pMat-&gt;GetBreakEnergy()) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; pCollision-&gt;mass[<span class="hljs-number"><span class="hljs-number">0</span></span>] * <span class="hljs-number"><span class="hljs-number">2</span></span> &gt; energy &amp;&amp; .... pMat-&gt;GetHitpoints() &lt;= FtoI(min(<span class="hljs-number"><span class="hljs-number">1E6</span></span>f, hitenergy / energy)) &amp;&amp; pCollision) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return 0; .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains a rather large conditional expression in which the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pCollision</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer is </font><i><font style="vertical-align: inherit;">accessed everywhere</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The error is that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pCollision</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><i><font style="vertical-align: inherit;">is</font></i><font style="vertical-align: inherit;"> checked </font><font style="vertical-align: inherit;">for equality to zero </font><font style="vertical-align: inherit;">most recently, i.e. </font><font style="vertical-align: inherit;">after repeated dereferencing. </font></font><br><br> <a href="http://www.viva64.com/ru/d/0513/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V758</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'commandList' link becomes a reference. </font><font style="vertical-align: inherit;">renderitemdrawer.cpp 274</font></font><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;....&gt; CDeviceGraphicsCommandListPtr; CDeviceGraphicsCommandListPtr CDeviceObjectFactory::GetCoreGraphicsCommandList() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_pCoreCommandList; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CRenderItemDrawer::DrawCompiledRenderItems(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; RESTRICT_REFERENCE commandList = *CCryDeviceWrapper:: GetObjectFactory().GetCoreGraphicsCommandList(); passContext....-&gt;PrepareRenderPassForUse(commandList); } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A </font><font style="vertical-align: inherit;">reference to the value stored in the smart pointer is stored in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commandList</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When the object is destroyed by a smart pointer, the link becomes invalid. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few more places like this:</font></font><ul><li> V758 The 'commandList' reference becomes invalid when smart pointer returned by a function is destroyed. renderitemdrawer.cpp 384 </li><li> V758 The 'commandList' reference becomes invalid when smart pointer returned by a function is destroyed. renderitemdrawer.cpp 368 </li><li> V758 The 'commandList' reference becomes invalid when smart pointer returned by a function is destroyed. renderitemdrawer.cpp 485 </li><li> V758 The 'commandList' reference becomes invalid when smart pointer returned by a function is destroyed. renderitemdrawer.cpp 553 </li></ul><br><h2>  Conclusion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correction of errors at the time of writing the code is almost worthless, in contrast to those that are at the stage of the testers, and errors in the released product already incur enormous costs. Regardless of the analyzer used, the static code analysis methodology itself has long been proven to be a very effective way to control the quality of the code and the software as a whole. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collaboration with Epic Games has demonstrated the benefits of introducing a static analyzer into the </font></font><a href="https://www.unrealengine.com/blog/how-pvs-studio-team-improved-unreal-engines-code"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unreal Engine 4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We helped the developers in all the integration issues of the analyzer and even fixed the errors found so that they could regularly check the new project code. We are ready for a similar cooperation with Crytek. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I suggest everyone to try </font></font><a href="http://www.viva64.com/ru/pvs-studio/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on their C / C ++ / C # projects. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The developers of CryEngineV were notified in advance about the verification of the project, so some errors may already be corrected.</font></font></b> <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0417/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov. <a href="http://www.viva64.com/en/b/0417/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I awaited the Check-Long of the CryEngine the V</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/307046/">https://habr.com/ru/post/307046/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307034/index.html">Conditional dependency injection in ASP.NET Core. Part 2</a></li>
<li><a href="../307038/index.html">Activity tracking using the phone and MATLAB</a></li>
<li><a href="../307040/index.html">Why OOP is not encapsulation, inheritance and polymorphism, or how I learned not to worry and fell in love with markup</a></li>
<li><a href="../307042/index.html">Five practices for organizing lifelong learning in a team</a></li>
<li><a href="../307044/index.html">PYCONRU-2016: video of all reports and presentations</a></li>
<li><a href="../307048/index.html">Overview of the two courses ‚ÄúMachine Learning‚Äù from Coursera</a></li>
<li><a href="../307050/index.html">Competent site security audit</a></li>
<li><a href="../307052/index.html">IT student with a thirst for travel? It's time to master</a></li>
<li><a href="../307054/index.html">Generator configurations for network equipment and not only</a></li>
<li><a href="../307056/index.html">Scorocode Cloud Service Development: Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>