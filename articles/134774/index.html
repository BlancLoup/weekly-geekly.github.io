<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with EXIF ‚Äã‚Äãgeotagging in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After I finished the program for geotagging, I had the idea to write this article - so that fewer people attacked the same rake, since there is not so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with EXIF ‚Äã‚Äãgeotagging in C #</h1><div class="post__text post__text-html js-mediator-article">  After I finished the program for geotagging, I had the idea to write this article - so that fewer people attacked the same rake, since there is not so much sensible information on these issues. <br>  So, I am not going to tell you what <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B5%25D0%25BE%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B8%25D0%25BD%25D0%25B3">geotagging</a> or <a href="http://ru.wikipedia.org/wiki/EXIF">EXIF is</a> , you can read about it in Wikipedia.  But how to make a program in C #, which would read and write data to EXIF ‚Äã‚Äãand I'm going to tell. <a name="habracut"></a>  We will work with photo metadata, as, in my opinion, by the simplest method - via <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.jpegbitmapdecoder.aspx">JpegBitmapDecoder</a> , for this you will need to connect several modules <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.Globalization; <br> <font color="#0000ff">using</font> System.Windows.Media.Imaging;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  To get started, just open the photo file: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#2B91AF">FileStream</font> Foto = <font color="#2B91AF">File</font> .Open(s, <font color="#2B91AF">FileMode</font> .Open, FileAccess.Read); <font color="#008000">//     s  </font> <br> BitmapDecoder decoder = JpegBitmapDecoder.Create(Foto, BitmapCreateOptions.IgnoreColorProfile, BitmapCacheOption.Default); <font color="#008000">//""     decoder</font> <br> BitmapMetadata TmpImgEXIF = (BitmapMetadata)decoder.Frames[0].Metadata.Clone(); //   </font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  It is often necessary to get the date and time of the shot.  If you look at <a href="http://www.exif.org/Exif2-2.PDF">the EXIF ‚Äã‚Äãspecification</a> , then there are several dates (the date and time of taking a picture, creating a file, digitizing, GPS, etc.), and it is still unknown exactly which one of them was recorded by the camera, and which one was ignored.  But it does not stand on this especially zamorachivatsya - everything is simple.  <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.bitmapmetadata.aspx">Bitmapmetadata</a> <br>  contains properties for obtaining the date and time of shooting, as well as some other parameters (for example, the camera model). <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#2B91AF">DateTime</font> DateOfShot = <font color="#2B91AF">Convert</font> .ToDateTime(TmpImgEXIF.DateTaken);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now let's go directly to the geotag record.  To work with any metadata (not only with EXIF), BitmapMetadata contains the <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.bitmapmetadata.setquery.aspx">SetQuery</a> and <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.bitmapmetadata.getquery.aspx">GetQuery methods</a> .  They take as a parameter a query string that determines which metadata field to read or write.  There are also <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.bitmapmetadata.removequery.aspx">RemoveQuery</a> to remove the field.  Let's start with a simple one: add to EXIF ‚Äã‚Äãa note that we have a northern latitude.  In EXIF, it corresponds to the GPS section field with ID = 1, and in C #, the query "/ app1 / ifd / gps / {ushort = 1}" (where to get these queries from then on) and the data type string.  If the northern latitude is written down ‚ÄúN‚Äù, and the southern one - ‚ÄúS‚Äù: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=1}"</font> , <font color="#A31515">"N"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Similarly with longitude: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=3}"</font> , <font color="#A31515">"E"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And the version should be 2.2.0.0: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=0}"</font> , <font color="#A31515">"2.2.0.0"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now it's more complicated: add altitude above sea level - this is an optional parameter, but using its example, consider working with the <b>Rational</b> type.  If you open <a href="http://www.exif.org/Exif2-2.PDF">the EXIF ‚Äã‚Äãspecification</a> , you can see there that the altitude is stored in the Rational format.  This type expresses real numbers as a simple fraction, so the number 182.053 will be written as 182053/1000 (or 1820530/10000).  To work with this type in C #, you can select the <a href="http://msdn.microsoft.com/en-us/site/system.uint64">ulong</a> type and use 4 low bytes to store the numerator, and 4 high bytes for the denominator.  Here is the function for converting double type to Rational: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">ulong</font> rational( <font color="#0000ff">double</font> a) <br> { <br> <font color="#0000ff">uint</font> denom = 1000; <br> <font color="#0000ff">uint</font> num = ( <font color="#0000ff">uint</font> )(a * denom); <br> <font color="#0000ff">ulong</font> tmp; <br> tmp = ( <font color="#0000ff">ulong</font> )denom &lt;&lt; 32; <br> tmp |= ( <font color="#0000ff">ulong</font> )num; <br> <font color="#0000ff">return</font> tmp; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  We write down the height of 95.3m (in EXIF ‚Äã‚Äãthe height above sea level is stored in meters, for example, in contrast to the track .plt, where it is stored in feet). <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=2}"</font> , rational(95.3));</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Well, now add latitude and longitude.  It is stored in the form of three Rational, which express degrees, minutes, seconds and fractions of a second.  Degrees and minutes are stored in integers (that is, the denominator is 1, but this is not a prerequisite), and seconds are real.  Example: 50‚Å∞30'12.345 ‚Ä≥.  In C #, these three numbers need to be combined into an array.  Here is an example of recording latitude: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">ulong</font> [] t = { rational(50), rational(30), rational(12.345) }; <br> TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=2}"</font> , t);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  and longitude: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TmpImgEXIF.SetQuery( <font color="#A31515">"/app1/ifd/gps/{ushort=4}"</font> , t);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Well, perhaps that's all.  Sometimes it is necessary to translate coordinates from the format of degrees and fractions of a degree obtained from the track file, label, some Internet service and others, since such a format is more convenient for work, but I think that there shouldn't be any problems with such conversion.  Just in case, here are the translation formulas: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Degree = <font color="#2B91AF">Math</font> .Floor( <font color="#0000ff">value</font> ); <br> Minute = <font color="#2B91AF">Math</font> .Floor((( <font color="#0000ff">value</font> - <font color="#2B91AF">Math</font> .Floor( <font color="#0000ff">value</font> )) * 60.0)); <br> Second = ((( <font color="#0000ff">value</font> - <font color="#2B91AF">Math</font> .Floor( <font color="#0000ff">value</font> )) * 60.0) - <font color="#2B91AF">Math</font> .Floor((( <font color="#0000ff">value</font> - <font color="#2B91AF">Math</font> .Floor( <font color="#0000ff">value</font> )) * 60.0))) * 60;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  So, we have a BitmapMetadata object with new entries added (if there was already something recorded before us, it should automatically be replaced with new values).  Now we will create a new snapshot file, into which we will transfer everything, except for metadata, from the first file, and take the metadata for those that we have changed. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">JpegBitmapEncoder Encoder = <font color="#0000ff">new</font> JpegBitmapEncoder(); <font color="#008000">//    Jpeg</font> <br> Encoder.Frames.Add(BitmapFrame.Create(decoder.Frames[0], decoder.Frames[0].Thumbnail, TmpImgEXIF, decoder.Frames[0].ColorContexts)); <font color="#008000">//    (   )   </font> <br> <font color="#0000ff">string</font> NewFileName = s + <font color="#A31515">"+GeoTag.jpg"</font> ; <font color="#008000">//   +GeoTag.jpg</font> <br> <font color="#0000ff">using</font> ( <font color="#2B91AF">Stream</font> jpegStreamOut = <font color="#2B91AF">File</font> .Open(NewFileName, <font color="#2B91AF">FileMode</font> .CreateNew, FileAccess.ReadWrite)) <font color="#008000">//  </font> <br> { <br> Encoder.Save(jpegStreamOut); <font color="#008000">//  </font> <br> } <br> Foto.Close(); <font color="#008000">//   </font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now we have a new jpeg-file, but already with a geotag.  Please note that the size of the original file and the new one may differ significantly, this is due to the different ways and parameters of image compression.  You can work with any EXIF ‚Äã‚Äãfields (tags) using the SetQuery and GetQuery methods.  GetQuery works in a similar way - accepts a query string, returns a value, what type - look in <a href="http://www.exif.org/Exif2-2.PDF">the EXIF ‚Äã‚Äãspecification</a> .  What request, what parameter answers can be found <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ee872003(v%3DVS.85).aspx">here</a> .  For example, the function of reading the date: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">GetQuery( <font color="#A31515">"/app1/ifd/exif:{uint=36867}"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  You can use your own queries as shown <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.media.imaging.bitmapmetadata.setquery.aspx">in this example</a> . </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/134774/">https://habr.com/ru/post/134774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134769/index.html">Chinese users of the Weibos service must register under real names</a></li>
<li><a href="../134770/index.html">The best gamer - lizard!</a></li>
<li><a href="../134771/index.html">AngryBirds Tournament: how to do it</a></li>
<li><a href="../134772/index.html">A brief overview of modern tools for a novice developer Drupal</a></li>
<li><a href="../134773/index.html">iPhone. "Printing simulator"</a></li>
<li><a href="../134775/index.html">Time-lapse rendering based on individual frames</a></li>
<li><a href="../134777/index.html">My first steps in SWT: A simple tabbed notebook</a></li>
<li><a href="../134778/index.html">Grand Theft Auto 3 is already available on Android and iOS</a></li>
<li><a href="../134780/index.html">The world will not see smartphones based on BlackBerry 10 until the end of 2012</a></li>
<li><a href="../134781/index.html">Scanning in 3D with a camera or 123D Catch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>