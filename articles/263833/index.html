<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CHECK CONSTRAINT in MS SQL - Rakes we walked through</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be about how one friendly web development team, without having an experienced SQL developer, added Check Constraint to the table and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CHECK CONSTRAINT in MS SQL - Rakes we walked through</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/68a/7fc/178/68a7fc1788ad4f86a5f354af64385720.jpg" align="left"><br>  This article will be about how one friendly web development team, without having an experienced SQL developer, added Check Constraint to the table and walked through several simple but not immediately obvious rakes.  The features of T-SQL syntax will be analyzed, as well as the nuances of restrictions (CONSTRAINT), without knowing which, you can spend a lot of time trying to understand why something is wrong.  The feature of <a href="http://habrahabr.ru/company/infopulse/blog/256653/">SSDT</a> will also be affected, namely how the migration script is generated, add or change restrictions (CONSTRAINTs) if necessary. <br><br>  In order for the reader to quickly understand whether it is worth reading the article or not, I will first consider an abstract problem, during the solution of which the questions ‚ÄúWhy is that?‚Äù Will be asked.  If you immediately know the answer, feel free to stop reading and go to the next article. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Develop harem? </h4><br>  "Harem" - a system that will allow to keep records of people in the "temple of love." <br>  For ease of development, let's take the following: <br><ul><li>  guests are prohibited in the harem and, accordingly, are not stored in the database, i.e. only the ‚Äúowners‚Äù and their wives are kept </li><li>  wives and their ‚Äúmaster‚Äù surname match </li><li>  by surname, you can uniquely identify each harem, that is, the same surname in different harems cannot meet. </li></ul><br>  For storing people, a Persons table is created: <br><img src="https://habrastorage.org/files/646/c06/a91/646c06a918b34ae2b3fb36df3751b341"><br><br>  At the last moment, insight comes that at the level of the base scheme we do not guarantee the existence of only one man in the harem.  We solve this by adding a check constraint (check constraint): <br><img src="https://habrastorage.org/files/350/1ff/e63/3501ffe6375645cda4a347a0a028b0f6"><br><br>  based on scalar user-defined function (scalar-valued Function): <br><img src="https://habrastorage.org/files/75c/57c/5bc/75c57c5bc2cf4456be4e43807da2c139"><br><br><h4>  ‚ÄúWhy so?‚Äù ‚Ññ1. </h4><br>  When trying to insert absolutely valid data (both women and men), we understand that we broke everything.  Insert crashes with the following error: <br><img src="https://habrastorage.org/files/b8c/2e5/48e/b8c2e548ed6c4803bf0f59256aab0e42"><br><br><h4>  ‚ÄúWhy so?‚Äù ‚Ññ2. </h4><br>  After we have overcome the problem of data insertion, we decide to go into the QA environment.  Create a migration script using SSDT, quickly review it.  We find some not very clear line (highlighted with a red frame). <br><img src="https://habrastorage.org/files/97e/bd2/f24/97ebd2f247ea489cb375ebc03a774c8d"><br><br>  From the comment in the PRINT instruction, it seems that this is the start of checking the restriction on already existing strings.  But when creating the restriction, we indicated that the existing strings do not need to be checked ( <i>‚ÄúCheck Existing Data On Creation Or Re-Enabling‚Äù</i> was set to <i>‚ÄúNo‚Äù</i> ).  Therefore, we start to google and find a <a href="http://dba.stackexchange.com/questions/24297/alter-table-check-constraint">"useful" post</a> .  After reading the answer and all the comments to it, we gain a deep confidence that this instruction includes checking when inserting new lines, rather than validating existing ones, that is, we definitely need to leave this line, otherwise the restriction will never be checked at all. <br>  With pride for the work done, we are sending a script, waiting ... After X hours, a report arrives that our migration script has failed successfully.  We look at the report. <br><br><img src="https://habrastorage.org/files/976/7ae/f50/9767aef509a441cda24e2903cc956d78"><br><br>  We understand that it was a suspicious instruction that failed migration. <br><br><h4>  ‚ÄúWhy so?‚Äù ‚Ññ1 - Explanation. </h4><br>  It's all very simple.  We have forgotten that the checking of the conditions of the CHECK CONSTRAINT occurs after inserting the row into the table and at the time of inserting the first man into the harem, the equality of one, and not zero, is the right condition.  As a result, the function was rewritten much easier. <br><img src="https://habrastorage.org/files/adb/b50/08c/adbb5008cb0f45269c00f9cceb51df35"><br><br><div class="spoiler">  <b class="spoiler_title">Computed columns</b> <div class="spoiler_text">  You can use calculated columns in a constraint expression, but only if they are physically stored, i.e.  their IsPersited property is set to Yes.  During the validation phase, all calculated columns will have the correct values ‚Äã‚Äãand if you update the values ‚Äã‚Äãon which the calculated value depends, the converted values ‚Äã‚Äãwill be transferred to the CHECK CONSTRAINT expression. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Justification</b> <div class="spoiler_text">  In order to somehow justify such carelessness, I would say that in our case the conditions for checking the restriction were much more ornate, and not all were related to the number of rows in the updated table.  And the data was inserted into the table only as a result of launching a complex script, which was extremely difficult to figure out. <br></div></div><br><br><h4>  ‚ÄúWhy so?‚Äù No. 2 - Explanation. </h4><br>  Here everything was not so transparent.  First, I had to understand the true purpose of the fallen instruction.  And, to our great surprise, we realized that she does exactly what is said in the commentary, and not what is described in the found ‚Äúuseful‚Äù post (the syntax will be analyzed below). <br>  Having learned this, it was logical to assume that when creating the migration script, a base was selected in which, on CK_Persons, the value of ‚ÄúCheck Existing Data On Creation Or Reabling‚Äù was ‚ÄúYes‚Äù, not ‚ÄúNo‚Äù.  But this theory has failed.  Changing this value and generating a new script, it became clear that SSDT, generally ignore this value.  Began to sin on the presence of a bug in the SSDT. <br>  The next stage of the search brought us to the <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/dcc5e62f-8af9-4f8e-8490-591435581d69/ssdt-ignoring-with-no-check-option-on-foreign-keys-when-createnewdatabase-option-is-true%3Fforum%3Dssdt">next post</a> , from which we already understood that this is "a feature, not a bug." <br>  According to the design of SSDT, when creating a script, a constraint is always created, which is enabled, i.e.  checked for all future INSERT / UPDATE.  The first ALTER instruction in our migration script is responsible for this. <br>  The second ALTER instruction (highlighted in red) is responsible for validating existing data and is optional.  Whether this instruction will be added to the migration script is answered by a special script generation option: <br><img src="https://habrastorage.org/files/2e8/c92/76c/2e8c9276c2c34598a693c230d55e6a16"><br><br>  By including it, for each new migration script we activate validation of existing data, i.e.  An optional instruction will be inserted (second ALTER).  Otherwise, the instruction is simply missing and no validation is performed on existing data.  Sadly, it turns out, but SSDT generates a migration script on the principle of all or nothing.  You can either enable all newly added restrictions to check for existing data, or skip it for all.  To fine tune the behavior, you will have to edit the script manually. <br><br><h4>  Constraints in MS SQL </h4><br>  As mentioned above, this article is left to deal with the wisdom of the syntax for creating and updating verification constraints.  But before we start, let's recall for the sake of completeness a bit of general information about the limitations in MS SQL Server. <br>  <i>Restrictions</i> - a mechanism that allows you to set a set of rules aimed at maintaining data integrity.  Rules can be set both at the column level in the table, and at the level of the entire table. <br>  MS SQL Server supports the following types of restrictions: <br><ul><li>  <i>NULL / NOT NULL</i> restriction - is set at the level of a column and determines whether a NULL value can be stored in a column. </li><li>  <i>UNIQUE</i> constraint - allows you to ensure the uniqueness of values ‚Äã‚Äãin one or more columns. </li><li>  <i>PRIMARY KEY</i> constraint is practically the same as the UNIQUE constraint, but unlike it, PRIMARY KEY does not allow storing NULL. </li><li>  <i>CHECK</i> restriction - allows you to specify some logical condition that must be true (TRUE) when inserting or updating data in the table.  It can be set both at the level of a single column and at the level of a table. </li><li>  <i>FOREIGN KEY</i> constraint - allows you to provide referential connectivity of two tables.  When you insert a value into a column (or columns) with a FOREIGN KEY constraint, it will be checked to see if the same value in the table that FOREIGN KEY points to.  If there is no value, the update or insertion of the line fails.  An exception can only be a NULL value, if the column is not set to NOT NULL.  In addition, you can only refer to a column with unique values, i.e.  with UNIQUE or PRIMARY KEY restriction.  You can also set the behavior in case of updating or deleting a row in the ‚Äúfather‚Äù table: <br><ul><li>  <i>NO ACTION</i> - it is forbidden to change the father table </li><li>  <i>CASCADE</i> - subordinate rows will be updated or deleted, depending on what is performed by the action on the father's table </li><li>  <i>SET NULL</i> - the value in the subordinate table will be set to NULL </li><li>  <i>SET DEFAULT</i> - the value in the subordinate table will be set to the default value. </li></ul><br></li></ul><br>  Now a little more about CHECK CONSTRAINT.  Consider the constraint that was mentioned above.  Below is the properties window of this restriction in Management Studio: <br><img src="https://habrastorage.org/files/34a/095/6f3/34a0956f3a814bd5b07c7dab181b65d1"><br><br>  The main properties are: <br><ul><li>  <i>Expression</i> - any valid T-SQL expression in which you can refer to the values ‚Äã‚Äãin the checked row by column name </li><li>  <i>Name</i> is a name that uniquely identifies the constraint within the database. </li><li>  <i>Check Existing Data On Creation Or Re-Enabling</i> - if a restriction is created on an already existing table, then this value ‚ÄúNo‚Äù allows not to miss the validation of existing rows;  Since the existing check can be temporarily turned off, this property also determines whether the existing strings will be validated when the limit is enabled. </li><li>  <i>Enforce For INSERTs And UPDATEs</i> - enables (Yes) or disables (No) restriction </li><li>  <i>Enforce For Replication</i> - allows you to skip checking when a replication agent inserts or updates strings </li></ul><br>  All this information is also available to us from the system view (view) <a href="https://msdn.microsoft.com/en-us/library/ms187388.aspx">sys.check_constraints</a> .  It contains one line for each CHECK CONSTRAINT in the database.  We sometimes use it in migration scripts when we need to be convinced of the existence or absence of any restriction. <br><br><h5>  Sys.check_constraints usage examples </h5><br><img src="https://habrastorage.org/files/f36/ecf/d21/f36ecfd214e54912b08cabb74572c562"><br><div class="spoiler">  <b class="spoiler_title">Sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) = <span class="hljs-string"><span class="hljs-string">'CK_Persons'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_not_trusted] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'No'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> Existing <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_disabled] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'No'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Enabled], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_not_for_replication] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'NO'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'YES'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Enforce <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Replication</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[check_constraints] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span></code> </pre> <br></div></div><br>  You can get the answer in a more familiar format using the UNPIVOT operator: <br><img src="https://habrastorage.org/files/03d/996/27e/03d99627e7184ac4a0a2b5729ae291b5"><br><div class="spoiler">  <b class="spoiler_title">Sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) = <span class="hljs-string"><span class="hljs-string">'CK_Persons'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Properties], [<span class="hljs-keyword"><span class="hljs-keyword">Values</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>([definition] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Expression], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_not_trusted] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'No'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> Existing <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Creation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> Re-Enabling], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_disabled] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'No'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Enforce <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> INSERTs <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> UPDATEs], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [is_not_for_replication] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'NO'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'YES'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Enforce <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Replication</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>([create_date] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Created], <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>([modify_date] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Modified] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>].[check_constraints] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) p <span class="hljs-keyword"><span class="hljs-keyword">UNPIVOT</span></span> ( [<span class="hljs-keyword"><span class="hljs-keyword">Values</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [Properties] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( [Expression], [<span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> Existing <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Creation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> Re-Enabling] , [Enforce <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> INSERTs <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> UPDATEs], [Enforce <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Replication</span></span>], [Created], [Modified] ) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> unpvt;</code> </pre><br></div></div><br><br><h5>  Features of CHECK CONSTRAINT: </h5><br><ul><li>  It works only for INSERT and UPDATE operations; if DELETE is performed, the condition is not checked </li><li>  If the test condition is NULL, then it is considered that the CHECK CONSTRAINT is not violated. </li></ul><br><br><h4>  Syntax CHECK CONSTRAINT </h4><br>  The check constraint has a number of properties that must be set at creation.  Some of them can be set only at creation, and some are available for change, only on the constraint already created.  The table below shows these features. <br><table><tbody><tr><th></th><th>  ‚Äú‚Ä¶ ADD CONSTRAINT ...‚Äù <br>  (creature) <br></th><th>  ‚ÄúALTER ... CONSTRAINT ...‚Äù <br>  (change) <br></th></tr><tr><td>  <i>Name</i> <br></td><td>  + <br></td><td>  - <br></td></tr><tr><td>  <i>Expression</i> <br></td><td>  + <br></td><td>  - <br></td></tr><tr><td>  <i>Check Existing Data On Creation Or Re-Enabling</i> <br></td><td>  + <br></td><td>  + <br></td></tr><tr><td>  <i>Enforce for INSERTs and UPDATEs</i> <br></td><td>  - <br></td><td>  + <br></td></tr><tr><td>  <i>Enforce for replication</i> <br></td><td>  + <br></td><td>  - <br></td></tr></tbody></table><br><br><h4>  Adding a new CHECK CONSTRAINT </h4><br><div class="spoiler">  <b class="spoiler_title">Basics of T-SQL Template Syntax</b> <div class="spoiler_text"><ul><li>  <i>In square brackets "[]"</i> - optional constructions are indicated and can be omitted from the final expression </li><li>  <i>In curly brackets "{}"</i> - indicate a list of possible structures, from which you must choose one </li><li>  <i>The vertical bar "|"</i> - separates the elements in curly brackets, among which you must select a single element </li></ul></div></div><br><img src="https://habrastorage.org/files/630/0a4/c83/6300a4c83c1b43dfb56cb519e9f18c28"><br><img src="https://habrastorage.org/files/661/e22/9d9/661e229d909f4df6a6929e23b3d2b6c3"><br><br>  <u>Optional sections:</u> <br><ol><li>  <i>[WITH {CHECK |</i>  <i>NOCHECK}]</i> - if absent, the value WITH CHECK is used </li><li>  <i>[NOT FOR REPLICATION]</i> - if the construction is specified, the restriction is not checked when inserting or updating data at the time of replication;  if the construction is omitted, the constraint is checked. </li></ol><br><br>  <i>Note: the</i> template is shown for the case of creating a constraint on an existing table.  You can also create a constraint at the time of creating the table, then the command will begin with the word CREATE and the description of the columns of the table will go to the word WITH. <br><br>  <u>Examples:</u> <br><div class="spoiler">  <b class="spoiler_title">Table for examples</b> <div class="spoiler_text">  Examples of commands will be given for the simplest table Employees, which looks like this: <br><img src="https://habrastorage.org/files/71b/b0a/69f/71bb0a69f4db4831b6cbc0921f925623"><br></div></div><br><img src="https://habrastorage.org/files/e61/30c/f50/e6130cf50fb9496cb4216c65ac901daf"><br><br><h4>  Change existing CHECK CONSTRAINT </h4><br>  The ALTER TABLE construct is used to update the existing check constraint.  Only the following properties are available for editing: <br><ul><li>  Check Existing Data On Creation Or Re-Enabling </li><li>  Enforce for INSERTs and UPDATEs </li></ul><br><img src="https://habrastorage.org/files/607/0ca/d96/6070cad962064c2d9b71aa6efdb84ec8"><br><img src="https://habrastorage.org/files/c8d/b5c/855/c8db5c8556e24a5b85ce3f6a347c2ac4"><br>  <u>Optional sections:</u> <br><ol><li>  <i>[WITH {CHECK |</i>  <i>NOCHECK}]</i> - in case of absence, WITH NOCHECK value is used </li><li>  <i>[, ... n]</i> - allows you to specify the name of more than one constraint to which the changes will be applied;  the use of the word ALL changes applies to all test constraints on the table </li></ol><br>  <i>Note 1</i> : although the name cannot be renamed using the ALTER TABLE syntax, it is still possible to do this using the sp_rename system stored procedure. <br>  <i>Note 2</i> : if you need to change the properties of "Expression" or "Enforce For Replication", you must first remove the existing constraint, and then re-create it with the necessary values ‚Äã‚Äãof these properties. <br><br>  <u>Examples:</u> <br><img src="https://habrastorage.org/files/76e/d0b/693/76ed0b6934a842529dec8343ed139c0d"><br><br><h4>  Undocumented behavior </h4><br>  There are a number of cases where the execution of commands leads to unexpected results.  And I could not find an explanation on the site msdn. <br>  In order to see this, it is necessary to consider all possible combinations of states in combination with all possible variants of commands.  Then it will be seen that in 5 cases, the resulting value of the ‚ÄúCheck Existing Data‚Äù property does not meet expectations. <br><br><table><tbody><tr><th colspan="2">  State before command execution </th><th rowspan="2">  T-SQL command </th><th colspan="2">  Status after command execution </th></tr><tr><th>  Check Existing Data </th><th>  Enforce for INSERTs and UPDATEs </th><th>  Check Existing Data </th><th>  Enforce for INSERTs and UPDATEs </th></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68"></td><td width="93"></td><td width="251"></td><td width="76"></td><td width="95"></td></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  CHECK </td><td width="76">  No </td><td width="95">  Yes </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  CHECK </td><td width="76">  No </td><td width="95">  Yes </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  CHECK </td><td width="76">  <b>Yes *</b> </td><td width="95">  Yes </td></tr><tr><td width="68"></td><td width="93"></td><td width="251"></td><td width="76"></td><td width="95"></td></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  WITH NOCHECK NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  WITH NOCHECK NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  WITH NOCHECK NOCHECK </td><td width="76">  No </td><td width="95">  No </td></tr><tr><td width="68"></td><td width="93"></td><td width="251"></td><td width="76"></td><td width="95"></td></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  WITH NOCHECK CHECK </td><td width="76">  No </td><td width="95">  Yes </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  WITH NOCHECK CHECK </td><td width="76">  No </td><td width="95">  Yes </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  WITH NOCHECK CHECK </td><td width="76">  <b>Yes *</b> </td><td width="95">  Yes </td></tr><tr><td width="68"></td><td width="93"></td><td width="251"></td><td width="76"></td><td width="95"></td></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  WITH CHECK NOCHECK </td><td width="76">  <b>No **</b> </td><td width="95">  No </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  WITH CHECK NOCHECK </td><td width="76">  <b>No **</b> </td><td width="95">  No </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  WITH CHECK NOCHECK </td><td width="76">  <b>No **</b> </td><td width="95">  No </td></tr><tr><td width="68"></td><td width="93"></td><td width="251"></td><td width="76"></td><td width="95"></td></tr><tr><td width="68">  No </td><td width="93">  No </td><td width="251">  WITH CHECK CHECK </td><td width="76">  Yes </td><td width="95">  Yes </td></tr><tr><td width="68">  No </td><td width="93">  Yes </td><td width="251">  WITH CHECK CHECK </td><td width="76">  Yes </td><td width="95">  Yes </td></tr><tr><td width="68">  Yes </td><td width="93">  Yes </td><td width="251">  WITH CHECK CHECK </td><td width="76">  Yes </td><td width="95">  Yes </td></tr></tbody></table><br>  (*) The value of the ‚ÄúCheck Existing Data‚Äù property can be translated from ‚ÄúYes‚Äù to ‚ÄúNo‚Äù, only if the current value of the ‚ÄúEnforce For INSERTs And UPDATEs‚Äù property differs from the one specified in the command. <br><br>  (**) ‚ÄúCheck Existing Data‚Äù can be ‚ÄúYes‚Äù only if the restriction is enabled (Enforce For INSERTs And UPDATEs = ‚ÄúYes‚Äù).  That is, in the WITH CHECK NOCHECK command, the WITH CHECK part will be ignored and ‚ÄúCheck Existing Data‚Äù will not be set to ‚ÄúYes‚Äù.  It also explains why there are only 3 options for each command as the initial states (and not 4). <br><br><h4>  Deleting an existing CHECK CONSTRAINT </h4><br>  The command is very simple and does not require additional explanations.  Another pattern: <br><img src="https://habrastorage.org/files/3a7/85c/bb2/3a785cbb247e4b8996114cdef4d64742"><br><br><h4>  Conclusion </h4><br>  I sincerely hope that after reading this article, you will not go over the rake, stuffed us a couple of unpleasant cones.  And also you can comfortably create and maintain migration scripts, in which there is logic to work with CHECK CONSTRAINT.  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/263833/">https://habr.com/ru/post/263833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263821/index.html">Django ORM. Add sugar</a></li>
<li><a href="../263823/index.html">Implementing a search engine with Python rankings (Part 1)</a></li>
<li><a href="../263825/index.html">RailsClub Moscow 2015, we start</a></li>
<li><a href="../263827/index.html">How configuration affects the architecture of the application</a></li>
<li><a href="../263831/index.html">How to avoid becoming a bot in Bittorrent DHT and other P2P networks</a></li>
<li><a href="../263835/index.html">Viewing statistics on the number of errors in a project, or ‚ÄúWow, graphics have appeared in PVS-Studio!‚Äù</a></li>
<li><a href="../263837/index.html">Corporate Cisco Jabber: Version 11 is very pleased</a></li>
<li><a href="../263839/index.html">Bartle's Psychotypes and Audience Balancing</a></li>
<li><a href="../263841/index.html">Google Chrome for Windows switched to using the AppContainer sandbox</a></li>
<li><a href="../263843/index.html">Acceleration of image processing in Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>