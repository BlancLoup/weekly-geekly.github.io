<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An article on how CommVault makes PostgreSQL backups.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will look at our experience using CommVault for PostgreSQL backup. To do this, we will analyze a small part of one of our past pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An article on how CommVault makes PostgreSQL backups.</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will look at our experience using CommVault for PostgreSQL backup.  To do this, we will analyze a small part of one of our past projects, where we set up a backup of the PostgreSQL database from the client. <br><br><img src="https://habrastorage.org/webt/zl/io/gr/zliogravp0udjmycafd9nm6yrow.jpeg"><a name="habracut"></a><br><br><h4>  <font color="#2e74b5">About CommVault</font> </h4><br>  CommVault is a single, scalable platform that provides integrated data protection and content management.  The platform supports software modules with backup and recovery functions, their archiving, deduplication, replication, hierarchical media distribution and encryption.  Platform modules work with corporate content from different sources and provide end-to-end information retrieval in the corporate environment and its constant availability even from archives due to the uniform intellectual indexing of documents in virtual storage.  The platform is also equipped with advanced analytics tools that generate reports on user and application activity and infrastructure operation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CommVault protects, restores and manages data and access to it in physical and virtual environments. <br><br><h4>  <font color="#2e74b5">About PostgreSQL Backup</font> </h4><br>  To perform a PostgreSQL database backup, an agent (iDataAgent) is used, which is installed on the server where this database is running.  The agent is designed to effectively manage and protect sensitive business data in PostgreSQL databases.  You can use this agent to back up and restore the entire PostgreSQL server or individual databases.  If necessary, you can also restore individual tables. <br><br><h4>  <font color="#2e74b5">Key features:</font> </h4><br>  PostgreSQL iDataAgent provides the flexibility to back up databases in various modes and restore them in minimum time.  You can perform a full backup or backup of the entire PostgreSQL server, individual databases or archive logs at any time. <br><br>  Backup and restore capabilities that can be performed in different modes: <br><br><ul><li>  iDataAgent provides the ability to restore the entire PostgreSQL server.  All databases located on the source server can be restored on the destination server. </li><li>  Define a separate database or group of databases as subclient data and perform backup and recovery. </li><li>  Back up only logs on the PostgreSQL server.  These log files can be used to recover database transactions lost due to an operating system or disk failure. </li><li>  Recover the entire PostgreSQL server to a specific point in time for file system based backup (File System Based Backup). </li><li>  View and check the status of backup and restore operations from the Job Controller and Event Viewer in the CommCell console.  Track the status of work using reports (Reports) that you can save and distribute. </li><li>  Use block-level backups as a faster way to back up data, because backups are performed only for extents (or modified parts of the database), and not for the entire PostgreSQL database. </li><li>  Block-Level Deduplication.  Deduplication provides a smarter way to store data by identifying and removing duplicates in data protection operations. </li></ul><br><h4>  <font color="#2e74b5">Architecture</font> </h4><br>  <font color="#2e74b5"><b>Scheme</b></font> <br><br><img src="https://habrastorage.org/webt/ys/ji/ct/ysjict_mkf-7kcsciptlw7du77y.png"><br><br>  <font color="#2e74b5"><b>How does it work:</b></font> <br><br>  The CommVault platform is deployed in the network as part of the CommServe managing server and a separate MediaAgent server (it is recommended to use a physical server). <br><br>  An agent (iDataAgent) is installed on the PostgreSQL database server and its backup policies are configured as required.  iDataAgent collects the necessary data, compresses, deduplicates, encrypts, if necessary, and sends them to the MediaAgent. <br><br>  Further, the data is placed on the storage system, tape library or cloud storage. <br>  For recovery, data is retrieved from the repository and copied to the server with PostgreSQL. <br><br>  <font color="#2e74b5"><b>Setup in the CommVault console</b></font> <br><br>  Now consider how to do this in the management console. <br><br>  1. To start database backup at the moment, in the CommCell Browser you need to select: <br><br>  Client Computers |  |  PostgreSQL |  |  DumpBasedBackupSet. <br><br>  Right click on the <b>default</b> folder in the <b>subclient</b> and select <b>Backup</b> . <br><br><img src="https://habrastorage.org/webt/q5/nm/uj/q5nmujdizcusqcmygdyfz_5xdtq.png"><br><br>  2. Select <b>Full</b> as the backup type and select <b>Immediate</b> . <br><br>  3. Click <b>OK</b> .  <b>PostgreSQL</b> backup will start. <br><br><img src="https://habrastorage.org/webt/zi/cn/ea/zicneazi3vlxtzvxq0nlth7whda.png"><br><br>  4. During the execution of a job, its status can be monitored by their <b>CommCell</b> <b>Job Controller</b> windows. <br><br><img src="https://habrastorage.org/webt/dp/wm/cl/dpwmcly1yjwuwkdthl5fdg8kom4.png"><br><br>  5. Once the task is completed, it will be possible to see the details of the task performed from the <b>Backup History</b> window.  Select the <b>default</b> folder in the <b>subclient</b> and select <b>Backup History</b> . <br><br><img src="https://habrastorage.org/webt/f8/ye/ju/f8yeju8l0lihgvro3kowl5ntgza.png"><br><br>  6. In the <b>Backup History</b> window, you can view the following data on completed tasks: <br><br>  - Backup errors during the execution of the task; <br>  - Items backed up successfully; <br>  - job details; <br>  - Developments; <br>  - Log files; <br>  - Media on which data is stored. <br><br>  <font color="#2e74b5"><b>What can backup be created for?</b></font> <br><br>  Backup based dump (Dump Based Backup): <br><br><ul><li>  PostgreSQL system databases; </li><li>  PostgreSQL user databases; </li><li>  Backup file system (File System Based Backup). </li></ul><br>  PostgreSQL databases (data and logs) (data and logs): <br><br><ul><li>  Log files. </li></ul><br>  What is not copied: <br><br><ul><li>  PostgreSQL application files (application files); </li><li>  Operating system data </li></ul><br>  Use File System iDataAgent to back up the above components. <br><br><h4>  <font color="#2e74b5">Task</font> </h4><br>  The client needed to deploy a CommVault platform to back up its services.  One of the services was the PostgreSQL database, which was deployed in a cluster configuration of 2 nodes: Master and Standby.  Both worked on physical servers. <br><br>  <font color="#2e74b5"><b>PostgreSQL client configuration details</b></font> <br><br>  PostgreSQL cluster configuration was selected to provide fault tolerance for the database server. <br><br>  The PostgreSQL client did backups of the database using pg_dump. <br><br>  The scheme of work is presented in the figure below: <br><br><img src="https://habrastorage.org/webt/2q/cw/li/2qcwlitdhowursvmsnpc4jak7ec.png"><br><br><h4>  <font color="#2e74b5">Backup Configuration with CommVault</font> </h4><br>  To unify the backup platform and take advantage of the backup storage advantages, we decided to use CommVault to back up the PostgreSQL database. <br><br>  Since  the client used the PostgreSQL cluster configuration, for backup we decided to use the File System Based Backup file backup option.  At the same time, it was necessary to abandon the use of block backup (Block Level Backup), since  the version of the Linux kernel used, on which PostgreSQL is deployed, turned out to be higher than the officially supported CommVault.  Due to the fact that the service is critical for the organization, the backup schedule was decided according to the table: <br><table><tbody><tr><th><br></th><th>  Full copy <br></th><th>  Transaction logs <br></th></tr><tr><td>  Schedule <br></td><td>  Once a day, at 23 o'clock <br></td><td>  Every hour for 24 hours </td></tr><tr><td>  Copy retention period <br></td><td>  7 days <br></td><td>  1 day <br></td></tr></tbody></table><br>  The total database size was more than 1.5 TB and, in order to meet the required RTO and RPO, a separate LAN network was used for backup with a speed of 10 Gbit / s. <br><br>  Backup was performed according to the scheme below: <br><br><img src="https://habrastorage.org/webt/b4/j-/mv/b4j-mvywwwqd0c8_1qpr9rg6-hq.png"><br><br>  Backup copies were taken from a PostgreSQL standby server and stored on a server with MediaAgent installed.  Further, once a month, full copies were placed in the Amazon cloud with a shelf life of one year. <br><br>  All necessary settings were made and the backup was successful. <br><br>  <font color="#2e74b5"><b>Features of PostgreSQL Backup Configuration</b></font> <br><br>  When installing and setting up a backup, we encountered some difficulties, which are listed below.  I think it would be useful to take these features into account when performing similar projects and when configuring PostgreSQL DB administrators. <br><br><ol><li>  Check that the same PostgreSQL service settings are set on the Master and Standby nodes according to the CommVault documentation: <br>  <a href="https://documentation.commvault.com/commvault/v11_sp14/article%3Fp%3D21491.htm">documentation.commvault.com/commvault/v11_sp14/article?p=21491.htm</a> </li><li>  Check that the parameters specified in Backup Troubleshooting are consistent with those indicated by the links: <br>  <a href="https://documentation.commvault.com/commvault/v11_sp14/article%3Fp%3D21723.htm">documentation.commvault.com/commvault/v11_sp14/article?p=21723.htm</a> <br>  <a href="https://documentation.commvault.com/commvault/v11_sp14/article%3Fp%3D21518.htm">documentation.commvault.com/commvault/v11_sp14/article?p=21518.htm</a> </li><li>  Make sure that the access rights to the database server and databases were set according to the following requirements: <br>  <a href="https://documentation.commvault.com/commvault/v11_sp14/article%3Fp%3D21523.htm">documentation.commvault.com/commvault/v11_sp14/article?p=21523.htm</a> </li></ol><br>  <font color="#2e74b5"><b>Recovery</b></font> <br><br>  Backup is good.  Naturally, we are interested not only in the process of its creation, but also in recovery.  For what it is all done. <br><br>  In this situation, the restoration, based on our experience, the client may need in 2 cases: <br><br><ol><li>  To restore the database to a specific point in time in order to gain access to data that, for example, could be deleted from the database; </li><li>  In case of loss of the entire cluster of the PostgreSQL database. </li></ol><br>  To restore the database, it is enough to read the documentation at this link: <a href="https://documentation.commvault.com/commvault/v11_sp14/article%3Fp%3D21502.htm">documentation.commvault.com/commvault/v11_sp14/article?p=21502.htm</a> <br><br>  We would also focus your attention on the following features and steps when restoring: <br><br><ol><li>  ALWAYS perform the recovery procedure together with the PostgreSQL DBA.  This will help you avoid wrong actions and quickly solve problems arising during the recovery process; </li><li>  Recovery must be performed on the node with the role of Master; </li><li>  When restoring, be sure to check that PostgreSQL services do not start after the end of the operation; </li><li>  In the restored node, change the settings for the Master role, since  in our case, we backed up the Standby nodes; </li><li>  On the Standby node, disable the services, on the Master node enable them, then enable on the Standby node and configure replication again. </li></ol><br><h4>  <font color="#2e74b5">Conclusion</font> </h4><br>  In this article, we did not take into account the backup of the Linux OS and other systems themselves.  It should be done separately.  CommVault documentation describes this in detail.  If our article is of interest, and there will be many wishes, we will definitely describe how to back up other systems.  Write in the comments, what systems would be interesting to you. <br><br>  We hope our experience will help you in setting up a backup by the PostgreSQL database administrator. <br><br>  The authors: <br>  Sergey Alexandrov, Backup Team Leader, Softline <br>  Artyom Khmelenko, Lead Engineer, Softline </div><p>Source: <a href="https://habr.com/ru/post/442760/">https://habr.com/ru/post/442760/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442746/index.html">Fool app for Windows Store</a></li>
<li><a href="../442748/index.html">The point: the top 10 reports of Heisenbug 2018 Moscow</a></li>
<li><a href="../442750/index.html">Virtual Djinn on March 8 - or how to surprise your female employees on the very spring day</a></li>
<li><a href="../442754/index.html">Operational vs analytical databases: column vs row-by-line data storage</a></li>
<li><a href="../442758/index.html">5 lifehacks optimize SQL queries in Greenplum</a></li>
<li><a href="../442764/index.html">Product Management Digest. What worries productologists and marketers in 2019</a></li>
<li><a href="../442772/index.html">Math for Data Scientist: Required Chapters</a></li>
<li><a href="../442784/index.html">BGP hijacking by adding the victim's AS to the attacker's AS-SET</a></li>
<li><a href="../442788/index.html">Why do you need a monitoring system on a chip</a></li>
<li><a href="../442790/index.html">Registration for Allure Server Meetup in St. Petersburg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>