<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic code compilation in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using a compiler from C # code is quite simple. But why - this is another question :). 

 Hello world 
 Let's write the first simple example. Create a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic code compilation in C #</h1><div class="post__text post__text-html js-mediator-article">  Using a compiler from C # code is quite simple.  But why - this is another question :). <br><br><h4>  Hello world </h4><br>  Let's write the first simple example.  Create a console application and write the following code: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System;&lt;br&gt; <font color="#0000ff">using</font> System.CodeDom.Compiler;&lt;br&gt; <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ;&lt;br&gt; <font color="#0000ff">using</font> Microsoft.CSharp;&lt;br&gt;&lt;br&gt; <font color="#0000ff">namespace</font> ConsoleCompiler&lt;br&gt;{&lt;br&gt; <font color="#0000ff">internal</font> <font color="#0000ff">class</font> Program&lt;br&gt;  {&lt;br&gt; <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main( <font color="#0000ff">string</font> [] args)&lt;br&gt;    {&lt;br&gt; <font color="#008000">// Source code  </font> &lt;br&gt; <font color="#0000ff">string</font> source =&lt;br&gt; <font color="#A31515">@"&lt;br&gt;namespace Foo&lt;br&gt;{&lt;br&gt;  public class Bar&lt;br&gt;  {&lt;br&gt;    static void Main(string[] args)&lt;br&gt;    {&lt;br&gt;      Bar.SayHello();&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    public static void SayHello()&lt;br&gt;    {&lt;br&gt;      System.Console.WriteLine("</font> <font color="#A31515">"Hello World"</font> <font color="#A31515">");&lt;br&gt;    }&lt;br&gt;  }&lt;br&gt;}&lt;br&gt;      "</font> ;&lt;br&gt;&lt;br&gt; <font color="#008000">//  </font> &lt;br&gt;      Dictionary&lt; <font color="#0000ff">string</font> , <font color="#0000ff">string</font> &gt; providerOptions = <font color="#0000ff">new</font> Dictionary&lt; <font color="#0000ff">string</font> , <font color="#0000ff">string</font> &gt;&lt;br&gt;        {&lt;br&gt;          { <font color="#A31515">"CompilerVersion"</font> , <font color="#A31515">"v3.5"</font> }&lt;br&gt;        };&lt;br&gt;      CSharpCodeProvider provider = <font color="#0000ff">new</font> CSharpCodeProvider(providerOptions);&lt;br&gt;&lt;br&gt;      CompilerParameters compilerParams = <font color="#0000ff">new</font> CompilerParameters&lt;br&gt;        {OutputAssembly = <font color="#A31515">"D:\\Foo.EXE"</font> , GenerateExecutable = <font color="#0000ff">true</font> };&lt;br&gt;&lt;br&gt; <font color="#008000">// </font> &lt;br&gt;      CompilerResults results = provider.CompileAssemblyFromSource(compilerParams, source);&lt;br&gt;&lt;br&gt; <font color="#008000">//    </font> &lt;br&gt; <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Number of Errors: {0}"</font> , results.Errors.Count);&lt;br&gt; <font color="#0000ff">foreach</font> (CompilerError err <font color="#0000ff">in</font> results.Errors)&lt;br&gt;      {&lt;br&gt; <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"ERROR {0}"</font> , err.ErrorText);&lt;br&gt;      }&lt;br&gt;    }&lt;br&gt;  }&lt;br&gt;}</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  We start and check: <br><img title="First Sample" alt="First Sample" src="https://habrastorage.org/getpro/habr/post_images/031/629/601/0316296011e62df604a039c1caa80b1c.png" width="678" height="222"><br>  The first thing you should pay attention to is the use of two namespaces (namespace): <ul><li>  Microsoft.CSharp </li><li>  System.CodeDom.Compiler </li></ul>  These classes contain the key to the ability to compile.  In our example, we specify that we will compile under the .NET Framework 3.5, as well as indicate what we want to get at the output - Foo.exe, with the ability to run this application. <a name="habracut"></a><br><br><h4>  The example is more difficult, we use Linq </h4><br>  Now let's complicate our example, add Linq to the compiled code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> source = <font color="#A31515">@"&lt;br&gt; <font color="#FF0000">using System.Collections.Generic;&lt;br&gt;using System.Linq;</font> &lt;br&gt;&lt;br&gt;namespace Foo&lt;br&gt;{&lt;br&gt;  public class Bar&lt;br&gt;  {&lt;br&gt;    static void Main(string[] args)&lt;br&gt;    {&lt;br&gt;      Bar.SayHello();&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    public static void SayHello()&lt;br&gt;    {&lt;br&gt;      System.Console.WriteLine("</font> <font color="#A31515">"Hello World"</font> <font color="#A31515">");&lt;br&gt; <font color="#FF0000">System.Console.WriteLine( string.Join("</font></font> <font color="#FF0000">","</font> <font color="#A31515"><font color="#FF0000">", Enumerable.Range(0,10).Select(n=&gt;n.ToString()).ToArray() ) );</font> &lt;br&gt;    }&lt;br&gt;  }&lt;br&gt;}"</font> ;</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Added lines are marked in red, if we try to run the previous example with modified compiled code, then we will see compilation errors: <br><img title="Compiler error" alt="Compiler Error" src="https://habrastorage.org/getpro/habr/post_images/f26/248/0e8/f262480e8de2d6c028aac41ce431fb6d.png" width="681" height="225"><br>  For the compilation to succeed, you need to add a link to the System.Core.dll assembly in the compilation options. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">compilerParams.ReferencedAssemblies.Add( <font color="#A31515">"System.Core.Dll"</font> );</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And now everything will work: <br><img title="Linq Sample" alt="Linq Sample" src="https://habrastorage.org/getpro/habr/post_images/cc7/cc2/477/cc7cc247792290a0ac76ae12ea26557b.png" width="678" height="224"><br><h4>  We use the created assembly in the code </h4><br>  Now we will try to compile the Foo.dll assembly instead of the executable file, as well as immediately after compilation, download and use the compiled method.  We will change the compiled code, we will make it easier: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">stringsource = <font color="#A31515">@"&lt;br&gt;using System.Collections.Generic;&lt;br&gt;using System.Linq;&lt;br&gt;&lt;br&gt;namespace Foo&lt;br&gt;{&lt;br&gt;  public class Bar&lt;br&gt;  {&lt;br&gt;    public static void SayHello()&lt;br&gt;    {&lt;br&gt;      System.Console.WriteLine("</font> <font color="#A31515">"Hello World"</font> <font color="#A31515">");&lt;br&gt;      System.Console.WriteLine( string.Join("</font> <font color="#A31515">","</font> <font color="#A31515">", Enumerable.Range(0,10).Select(n=&gt;n.ToString()).ToArray() ) );&lt;br&gt;    }&lt;br&gt;  }&lt;br&gt;}"</font> ;</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Change the compiler settings, now we will build the dll file: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">const</font> <font color="#0000ff">string</font> outputAssembly = <font color="#A31515">"D:\\Foo.dll"</font> ;&lt;br&gt;CompilerParameters compilerParams = <font color="#0000ff">new</font> CompilerParameters {OutputAssembly = outputAssembly, GenerateExecutable = <font color="#0000ff">false</font> };</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  After compiling and checking errors using Reflection (don't forget to connect the namespace - using System.Reflection) we call the Foo.Bar.SayHello () method compiled dll: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Try Assembly:"</font> );&lt;br&gt; <font color="#2B91AF">Assembly</font> assembly = <font color="#2B91AF">Assembly</font> .LoadFile(outputAssembly);&lt;br&gt;Type type = assembly.GetType( <font color="#A31515">"Foo.Bar"</font> );&lt;br&gt;MethodInfo method = type.GetMethod( <font color="#A31515">"SayHello"</font> );&lt;br&gt;method.Invoke( <font color="#0000ff">null</font> , <font color="#0000ff">null</font> );</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Result: <br><img title="Final result" alt="Final Result" src="https://habrastorage.org/getpro/habr/post_images/dc5/a41/404/dc5a414046330ac5c6727c9c58fe334b.png" width="679" height="224"><br>  The final example can be downloaded from <a href="">mydrive.live.com</a> . <br>  Information about dynamic compilation and the main examples I took from here: <a href="http://blogs.msdn.com/saveenr/archive/2009/08/11/a-walkthrough-of-dynamically-compiling-c-code.aspx">Saveen Reddy's blog - A Walkthrough of Dynamically Compiling C # code</a> (English). <br> <a href="http://progg.ru/outcoldman-%25D0%2594%25D0%25B8%25D0%25BD%25D0%25B0%25D0%25BC%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F-%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D0%25B8%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B0-%25D0%25B2-C"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F33779.html"></a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/67431/">https://habr.com/ru/post/67431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../67421/index.html">ADSL modem loses connection before rebooting? No problem!</a></li>
<li><a href="../67424/index.html">BBC experiments with HTML5 video</a></li>
<li><a href="../67428/index.html">Tele2 starts selling modems</a></li>
<li><a href="../67429/index.html">Corporate Web 2.0 in Russia</a></li>
<li><a href="../67430/index.html">How many returns should there be in a function / method?</a></li>
<li><a href="../67433/index.html">How a baby programmer cradles</a></li>
<li><a href="../67434/index.html">Enthusiastic Project Part 1: People</a></li>
<li><a href="../67436/index.html">Bit-torrent tracker Demonoid blocked by Russian</a></li>
<li><a href="../67437/index.html">A little bit about BlizzCon 2009</a></li>
<li><a href="../67440/index.html">STALKER Offline</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>