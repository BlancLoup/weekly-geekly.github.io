<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Image Quantization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quantization - reducing the color of the image ( wiki ). Of course, now very few people need it, but the task itself is interesting. 


 Quantized Len...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Image Quantization</h1><div class="post__text post__text-html js-mediator-article">  Quantization - reducing the color of the image ( <a href="https://en.wikipedia.org/wiki/Color_quantization">wiki</a> ).  Of course, now very few people need it, but the task itself is interesting. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/469/4b9/630/4694b96305f64f1287f6e8b4dee40a8a.gif"></div><br>  <i>Quantized <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B5%25D0%25BD%25D0%25B0_(%25D0%25B8%25D0%25B7%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5)">Lena</a> draws attention</i> <br><br>  For example, the good old GIF format uses a palette of up to 256 colors.  If you want to save a series of your selfies as gif-animation (who would need it), then the first thing that you, or rather the program that you will use for this, will have to do is create a palette.  You can use a static palette, such as <a href="https://websafecolors.info/">web-safe colors</a> , the quantization algorithm is very simple and fast, but the result will be ‚Äúnot very‚Äù.  You can create an optimal palette based on the colors of the image, which will give the result most visually similar to the original. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several algorithms for creating an optimal palette; each has its own pros and cons.  I will not bother the reader with tedious theory and formulas, firstly I‚Äôm lazy, secondly most aren‚Äôt interested - the article is just flipped through, looking at the pictures. <br><br>  Next you will <s>find a boring and incomprehensible</s> narration about the method of the median section, the Floyd-Steinberg error-dissipation algorithm (noise quantization) (and not only), the features of the color perception of the human eye, as well as a little <s>shit</s> code. <a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Prehistory</b> <div class="spoiler_text">  Once upon a time, when Nokia <s>was warm and lamp</s> dominated the smartphone market, and the owners of smartphones proudly called themselves ‚Äúsmartphones‚Äù, in those ancient times I wrote simple python programs for series60.  One of them the other day stumbled upon digging in the archives.  GifTool - a program for creating gif-animations from a set of images.  In it, I implemented quantization using the median section method, the LZW compression algorithm, the entire file structure was created independently, for the pixels that did not change on the next slide, transparency was used to reduce the final file size.  I wanted to refresh my memory, to see how it worked.  Opened the code and ... This feeling, when you can not figure out your govnokode ten years ago.  I did not know about PEP8 then, so the readability of the code was a little less than none (then I liked minimalism, like many novice programmers).  I shed tears, spat, refactored into PyCharm, figured out how to implement the method of the median section, quickly put in a ‚Äúdirty‚Äù script.  Works!  The palette is created, the image at the output is tolerable.  And then I ate - if I could achieve better results, so that the picture was visually as close as possible to the original. <br></div></div><br>  So - the method of median section.  He is simple to ugliness.  The first step is to make an RGB cube from all the unique colors of the image.  Next, cut it along the longest side.  For example, we have a red range from 7 to 231 (length 231-7 = 224), green from 32 to 170 (length 170-32 = 138), blue from 12 to 250 (length 250-12 = 238), then we will "Cut" the cube on the blue side.  The resulting segments also cut along the long side, etc.  until we get 256 segments.  For each segment, calculate the average color - so we get a palette. <br><br><div class="spoiler">  <b class="spoiler_title">A couple of pictures almost in the subject, for clarity</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/91c/698/ce6/91c698ce6ce2437e9056d364588b5fdb.jpg"><img src="https://habrastorage.org/files/131/7fd/c1c/1317fdc1ce8c489dafe201474e9f9d95.gif"><br></div></div><br>  What can be improved here?  The first thing that comes to mind is to calculate the average color without stupidly adding all the colors and dividing them by the amount [sum (color) / count (color)], and taking into account how many times each color is found in the image.  That is, we multiply each color by the number of its occurrences in the image, we add the obtained values, divide the result by the number of occurrences in the image of all the colors of this segment [sum (color * total) / sum (total)].  As a result, the most common colors take precedence in the calculation, but rare colors make their own adjustments, so the palette is better, the visual deviation of colors is smaller.  For best results, it is desirable to take into account the gamma, but I left it for later.  The second is not so obvious - the median section does not take into account the peculiarities of color perception by the human eye at all.  We perceive shades of green much better than shades of blue.  I decided to correct this misunderstanding and ‚Äúflattened‚Äù the cube - I multiplied the lengths of the sides by the coefficients from <a href="https://habrahabr.ru/post/304210/">this article</a> .  As a result, the green and red sides of the sections became larger, the blue one less.  I have never seen such a solution anywhere (I may have been looking badly), but the result is obvious. <br><br>  Now we have an optimal palette, not ideal of course (I know that it can be further improved), but quite good.  The next step is to index the colors of the image.  The easiest option - in which segment is the color, such and index.  Quick and easy.  But there is one thing, and not even one, so we‚Äôll go back to this step. <br><br>  There is another way to improve the quality of the resulting image - the dispersion of errors.  Here, too, everything is quite simple - from the indexed color we subtract the corresponding color of the palette, we get an error, we dissipate it by neighboring pixels in accordance with a certain formula (template), the most famous formula of Floyd-Steinberg, I used it.  When errors are scattered, sharp transitions between colors are blurred, and visually it seems that the image contains more shades (colors).  If it is interesting - you can read about error dissipation in detail and interestingly <a href="http://www.tannerhelland.com/4660/dithering-eleven-algorithms-source-code/">here</a> .  I also decided to finish this algorithm by multiplying the error with all the same coefficients, as it turned out, it was a very good idea - as there were fewer sections across the blue range, it produced a significant error, and without correcting the error, the dispersion coefficients made a lot of noise ". <br><br>  Now you can go back to indexing.  By scattering errors, we change the colors of the pixels and get those that are not in our RGB-cube (remember, it is composed solely of the colors of the image).  Now you can not just see which segment is the color to assign an index.  The solution was found immediately - <a href="http://algolist.manual.ru/graphics/find_col.php">search for the nearest color in the palette</a> .  In this formula, I substituted all the same factors.  Comparing the results of matching the color of the palette by the index of the segment which includes the original color and the search results for the nearest color, I clearly saw that the closest color often appears in the neighboring segment.  If the source color is closer to the center of the segment, then the segment index corresponds to the color index in the palette, but the closer the source color is to the edges of the segment, the more likely it is that the closest color will be in the adjacent segment.  In general, the only correct way to index - search for the nearest color in the palette.  But the search has a minus - it is slow, very slow.  Writing a pyramid on a python is a bad idea. <br><br>  Well, I wanted to explain in two words, but I got a whole bunch of incomprehensible writing.  I hope I write the code better than I explain, so here is a reference on <a href="https://github.com/DenisKanyshev/quantizer">github</a> .  The code was rewritten several times, the algorithm was first refined, until I was satisfied with the result, then it turned out that it was eating too many operatives when processing photos (first tested on small pictures), I had to transfer the RGB cube, median section and pixel map to the database ( sqlite).  The script works very slowly, but the result is better than quantization using PIL / Pillow and GIMP (this operation is called indexing). <br><br><div class="spoiler">  <b class="spoiler_title">Visual demonstration:</b> <div class="spoiler_text">  Original <br><img src="https://habrastorage.org/files/d4a/d1f/84d/d4ad1f84da954172bc23b23e4397c418.jpg"><br><br>  The result of quantization in GIMP, the optimal palette of 256 colors + color blurring according to Floyd-Stenberg (normal) <br><img src="https://habrastorage.org/files/28b/34c/47f/28b34c47f3574e79b41d812c3c509dc5.gif"><br><br>  PIL / Pillow quantization result <pre><code class="python hljs">image.convert(mode=<span class="hljs-string"><span class="hljs-string">'P'</span></span>, dither=PIL.Image.FLOYDSTEINBERG, palette=PIL.Image.ADAPTIVE, colors=<span class="hljs-number"><span class="hljs-number">256</span></span>)</code> </pre> <br><img src="https://habrastorage.org/files/e43/8d3/e04/e438d3e04587486ea8287aee1c5ecd08.gif"><br><br>  Quantization result by my code <br><img src="https://habrastorage.org/files/d07/a09/177/d07a0917719f4681b8f9e261edc863ae.gif"><br><br>  What to look for: dispersing an error in GIMP makes a lot of noise, PIL / Pillow creates a not very optimal palette and practically does not dispel errors (sharp transitions between colors). <br>  If you don‚Äôt see the difference, check out other examples on <a href="https://github.com/DenisKanyshev/quantizer">github</a> . <br></div></div><br>  <b>PS:</b> there is a wonderful program <a href="http://x128.ho.ua/color-quantizer.html">Color Quantizer</a> , which copes with this task better and faster, so my script has no practical sense, it is made solely from the "sports" interest. <br>  <b>UPD:</b> updated the project on <a href="https://github.com/DenisKanyshev/quantizer">github</a> .  Added Octree (octree) quantization algorithm, popular error dispersion formulas, search for the nearest color by the average red value. </div><p>Source: <a href="https://habr.com/ru/post/315490/">https://habr.com/ru/post/315490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315480/index.html">Managing the robot at Arduino from the application on Node.js</a></li>
<li><a href="../315482/index.html">What is the strength of the affiliate network, why does power become weak as it progresses, and what to do about it</a></li>
<li><a href="../315484/index.html">Artificial intelligence, challenges and risks - through the eyes of an engineer</a></li>
<li><a href="../315486/index.html">One of the vulnerabilities of WPS technology</a></li>
<li><a href="../315488/index.html">We make a motor control loop with a current reference</a></li>
<li><a href="../315492/index.html">Files in the clouds. Choose a storage service for the business environment</a></li>
<li><a href="../315496/index.html">The first bug on Mars</a></li>
<li><a href="../315500/index.html">Domain name resolution from Docker containers in complex cases</a></li>
<li><a href="../315502/index.html">The second mitap of the Rust lovers community at Kaspersky Lab</a></li>
<li><a href="../315504/index.html">How IT professionals work. Viktor Tarnavsky, Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>