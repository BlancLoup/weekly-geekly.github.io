<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fiber Channel Basics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to broadcast on clarifying the basic ideas about FC SAN. In the comments to the first post I was reproached with the fact that I didn‚Äôt dig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fiber Channel Basics</h1><div class="post__text post__text-html js-mediator-article">  I continue to broadcast on clarifying the basic ideas about FC SAN.  In the comments to the <a href="http://habrahabr.ru/post/214289/">first post</a> I was reproached with the fact that I didn‚Äôt dig deep enough.  In particular, he said little about FC itself and said nothing about BB credits, IP and multipathing.  Multipathing and IP are topics for individual publications, but I‚Äôll continue to talk about FC.  Or I will begin how to look. <br><br>  For a start, a small terminological digression (inspired by a comment to the previous post). <br><br><blockquote>  Fiber or Fiber ?: Initially, Fiber Channel technology assumed support only for fiber-optic lines (fiber optic).  However, when copper support was added, it was decided to keep the name in principle, but to refer to the standard use the British word Fiber.  The US Fiber is preserved primarily for fiber optic. <br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text">  Fiber Channel was originally designed to support fiber optic cabling only.  In the case of the use of the English spelling (Fibre)  The US English spelling (Fiber) is retained when referring generically to fiber optics and cabling. </div></div></blockquote>  <i>IBM Redbook "Introduction to SAN and System Networking"</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Start </h4><br>  By analogy with the OSI network model, Fiber Channel consists of five levels.  Each level provides a specific set of functions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/123/b55/906/123b55906e161632cbc204f9ade9fc5d.png"><br><a name="habracut"></a><br>  <b><a href="https://habr.com/ru/post/216369/">FC-0</a></b> - the level of physical interfaces and media.  Describes the physical environment: cables, connectors, HBA, transceivers, electrical and optical parameters. <br><br>  <b><a href="https://habr.com/ru/post/216369/">FC-1</a></b> Transmission and Encoding Level.  It describes how the data will be encoded before transmission and decoded after.  At this level, three main functions are defined: <br><ul><li>  <a href="https://habr.com/ru/post/216369/">Encoding / decoding</a> </li><li>  <a href="https://habr.com/ru/post/216369/">Ordered sets</a> </li><li>  <a href="https://habr.com/ru/post/216369/">Link initialization</a> </li></ul><br>  <b><a href="https://habr.com/ru/post/216369/">FC-2</a></b> - the level of framing and signals.  Defines the structure and organization of the transmitted information, as well as control and management of its transmission.  Functions performed at this level: <br><ul><li>  <a href="https://habr.com/ru/post/216369/">Crop (frame / frame structure definition)</a> . </li><li>  <a href="https://habr.com/ru/post/216369/">Sequence management</a> </li><li>  <a href="https://habr.com/ru/post/216369/">Exchange Management</a> </li><li>  <a href="https://habr.com/ru/post/216369/">Class of Service</a> </li><li>  <a href="https://habr.com/ru/post/216369/">Flow control</a> </li></ul><br>  <b>FC-3</b> - basic services level.  The level is laid for new features that may be embedded in the Fiber Channel in the future.  At this level, data is encrypted and compressed before it is sent, as well as such things as splitting the data stream (striping) along several paths.  But I have not encountered such implementations yet. <br><br>  <b>FC-4</b> - protocol display level.  Describes the protocols that can use FC as a transport and, in fact, the order of use (mapping of these protocols to the lower levels of FC0-3).  For SAN, these can be: <br><ul><li>  Fiber Channel Protocol for SCSI-3 (SCSI-FCP) - SCSI forwarding </li><li>  Fiber Channel Link Encapsulation (FC-LE) - TCP / IP forwarding </li></ul><br><br>  And now more about these and other incomprehensible phrases.  In this article, we will consider only the lower three levels, as most significant in the creation and management of the FC SAN infrastructure. <br><a name="fc0"></a><br><h4>  FC-0 </h4><br>  I probably will not give complex tables of cable types, transmitters and their characteristics.  Firstly, because it‚Äôs inconvenient to insert tables here, secondly, because these tables are everywhere where at least something is written about FC ( <a href="http://ru.wikipedia.org/wiki/Fibre_Channel">Russian Wikipedia</a> , <a href="http://en.wikipedia.org/wiki/Fibre_Channel">non-Russian Wikipedia</a> ), thirdly (and key), in my opinion , the main thing is to understand the essence, and to find reference data is not a problem. <br>  And the point is that there are two types of fiber: multimode and single mode. <br>  <b><i>Multimode (Multimode Fiber, MMF)</i></b> - relatively wide in cross section (50-62.5 microns), designed for short-wave laser beams.  "Multimode" means that the light can pass through the channel in different ways - being reflected multiplely from the fiber walls.  This makes the cable less sensitive to bending, but reduces the strength and quality of the signal, which limits this type only to small distances - up to 500 m. <br>  <b><i>Singlemode (Singlemode Fiber, SMF)</i></b> - a fiber of small diameter (8-10 microns), the signal by which is transmitted by a long-wave laser, the light of which is not visible to the human eye.  Here, the light can move in the only way - in a straight line, respectively, the signal is transmitted faster and more accurately, but the equipment to provide such signals is much more expensive, so it is used mainly for communication over long distances (up to 50 km).  To bends and in general any distortions single-mode fiber is much more sensitive. <br>  <a href="http://habrahabr.ru/post/46818/">There is a more detailed article about fiber types here</a> . <br>  It should be borne in mind that two cables are used to connect two devices.  One is used for transmission, the other is for reception.  Therefore it is important to connect them correctly (Tx of one side to Rx of the other). <br><br>  Separately, I want to mention such a term as <b><i>dark optics</i></b> ( <b><i>dark fiber</i></b> ).  This term does not mean that it is somehow tinted in a special way.  These are simply dedicated optical communication lines, as a rule, for communication over long distances (between cities or distant buildings) that are rented and for which use no additional signal amplification equipment (provided by the owner) is required.  However, since this is just an optical cable, placed at your complete disposal, as long as you do not let your light signal through it, it remains "dark." <br><br>  A smooth transition from FC-0 to FC-1 and back provides <abbr title="Application Specific Integrated Circuits"><b>ASIC</b></abbr> - an element of devices such as HBAs, disk arrays and switches. <br>  From <a href="http://ru.wikipedia.org/wiki/ASIC">Wikipedia</a> : <br><blockquote>  <b><i>ASIC</i></b> (an abbreviation of the English. <i>Application-specific integrated circuit</i> , "special purpose integrated circuit") - an integrated circuit that is specialized for solving specific problems.  Unlike general-purpose integrated circuits, specialized integrated circuits are used in a specific device and perform strictly limited functions that are characteristic only for this device;  as a result, functions are performed faster and, ultimately, cheaper.  An example of an ASIC may be a chip designed exclusively for controlling a mobile phone, a chip for hardware encoding / decoding audio and video signals (signal processors). </blockquote><br>  In Fiber Channel equipment, the ASIC consists of the following functional elements: <br><ul><li>  Encoder / Decoder - Encodes every 8 bits of transmitted data into a 10-bit representation.  And decoding back the received data. </li><li>  SERDES (Serializer / Deserializer) - converts a parallel stream of 10-bit chunks of data into a serial stream of 10-bit chunks of data. </li><li>  Transceiver - converts electrical pulses into light signals. </li></ul><br>  <b>ASIC</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/402/ca5/ab4/402ca5ab458c4bba2d0d0e2570500513.png"><br><br>  <i>Transceivers, transceivers or SFPs</i> - in the case of FC switches, these are separate modules needed to connect the cable to the port.  They differ in short wave (Short Wave, SW, SX) and long wave (Long Wave, LW, LX).  LW transceivers are compatible with multimode and single mode fiber.  SW-transceivers - only with multimode.  And to those and other cable is connected to the connector LC. <br>  There is also <i>SFP xWDM</i> (Wavelenght Division Multiplexing), designed to transmit data from several sources over long distances in a single light beam.  To connect the cable to them, use the SC connector. <br><a name="fc1"></a><br><h4>  FC-1 </h4><br><a name="encoding"></a><h5>  8/10 and 64/66 </h5><br>  The first thing that happens at this level is encoding / decoding information.  This is a rather tricky process, during which every 8 bits of incoming information is converted into a 10-bit representation.  This is done in order to improve data integrity control, separation of data from service signals and the possibility of recovering the clock signal from the data stream (maintaining a balance of zeros and ones). <br>  This leads to a noticeable reduction in useful bandwidth, because as you can calculate, 20% of the data flow is redundant overhead information.  But among other things, a considerable part of this stream can be occupied by service traffic. <br>  However, the good news is that 8/10 coding is used in 1G, 2G, 4G and 8G equipment.  In terms of 10G implementations and starting from 16G, coding is carried out on the 64/66 principle, which significantly increases the payload (up to 97% versus 80% in the case of 8/10). <br><br><a name="ordered_sets"></a><h5>  Ordered sets </h5><br>  In Russian Wikipedia, this term is translated as ‚Äú <a href="http://ru.wikipedia.org/wiki/Fibre_Channel">ordered sets</a> ‚Äù.  While in my opinion, the word order here should be understood not in the meaning of ‚Äúorder‚Äù, but in the meaning of ‚Äúorder, command‚Äù. <br>  For a start, it is worth mentioning another term used in the context of FC - <b><i>transmission word</i></b> - the minimum portion of data for transmission, equal to 4 bytes.  If the transmitted information is smaller in volume, then the transmission word is supplemented with special fill bytes (fill bytes), which are cut out at the receiver. <br>  So, <b><i>ordered sets</i></b> are special service transmission words.  Divided into three categories: <br><ol><li>  Frame separators (Start-of-Frame, SOF and End-of-Frame, EOF). </li><li>  Two basic signals - IDLE (the port is ready to receive or transmit data) and R_RDY (receiver ready - the port freed the buffer to receive the next portion of data) </li><li>  Basic sequences (primitive sequences): <br><ul><li>  NOS (Not Operational) - port has detected a disconnect / no connection </li><li>  OLS (Offline State) - the port initiates connection establishment, or the port received NOS, or the port switches to off-line state </li><li>  LR (Link Reset) - initialization of the connection reset.  Dispatched in case of receiving OLS or some receive / transmit errors (usually at the Flow Control level).  The sending port clears its buffers and their counters. </li><li>  LRR (Link Reset Response) - the answer to the LR.  The sending port clears its buffers and their counters. </li></ul></li></ol><br><br><a name="link_init"></a><h5>  Link initialization </h5><br>  When a physical connection is established between ports A and B, the following "metabolism" occurs between them: <br><img src="https://habrastorage.org/getpro/habr/post_images/a05/1cf/2bc/a051cf2bc269ee156aba1ccf6bd72852.png"><br><a name="fc2"></a><br><h4>  FC-2 </h4><br><a name="frames"></a><h5>  Frames (Frames) </h5><br>  All data transmitted in the Fiber Channel environment is divided into frames (frames).  The frame structure is as follows: <br><ul><li>  SoF - 4 bytes (1 tw) - frame start identifier. </li><li>  Header - 24 bytes (6 tw) - header.  It contains such information as the source and destination address, frame type (FT-0 - control or FT-1 - data), sequence number and frame sequence number in it, and other service and control information. </li><li>  Data - 0-2112 bytes (0-528 tw) - the data itself (for example, SCSI commands). </li><li>  CRC - 4 bytes (1 tw) - checksum. </li><li>  EoF - 4 bytes (1 tw) - identifier of the end of the frame. </li></ul><br><br>  The intervals between the frames are filled with special ‚Äúfilling words‚Äù - fill word.  As a rule, this is IDLE, although starting with FC 8G, the use of ARB (FF) instead of IDLE has been standardized in order to reduce electrical interference in copper equipment (but by default, switches use IDLE by switches). <br><br><a name="sequences"></a><h5>  Sequences (Sequences) </h5><br>  Most often, the source tends to transmit much more information to the receiver than 2,112 bytes (the maximum amount of data per frame).  In this case, the information is divided into several frames, and the set of these frames is called a sequence.  So that something extra is not wedged into the logical sequence of frames during parallel transmission, the header of each frame has the fields SEQ_ID (sequence identifier) ‚Äã‚Äãand SEQ_CNT (frame number in the sequence). <br><br><a name="exchanges"></a><h5>  Exchange (Exchange) </h5><br>  One or several sequences responsible for some single operation is called exchange.  The source and receiver can have several parallel exchanges, but each exchange per unit of time can contain only one sequence.  Example exchange: the initiator requests data (sequence 1), the target returns data to the initiator (sequence 2) and then reports the status (sequence 3).  Any extraneous frame set cannot insert into this sequence set. <br>  To control this process, the header of each frame includes the OX_ID (Originator Exchange ID ‚Äî filled by the initiator of the exchange) and RX_ID fields (Responder Exchange ID ‚Äî filled by the recipient in the response frames, by copying the OX_ID value). <br><br><a name="cos"></a><h5>  Classes of Services </h5><br>  Different applications have different requirements for service level, delivery guarantee, connection duration and bandwidth.  Some applications require guaranteed bandwidth during their work (backup).  Others have variable activity and do not require constant guaranteed bandwidth, but they need confirmation in receiving each sent packet.  To meet these needs and provide flexibility, FC defines the following 6 classes of service. <br><br><h6>  Class 1 </h6><br>  For this class, a dedicated connection is established that reserves the maximum bandwidth between the two devices.  Requires confirmation of receipt.  Requires frames to be sent to the receiver in the same order as they came from the source.  Due to the fact that it does not allow other devices to use the transmission medium, it is used extremely rarely. <br><br><h6>  Class 2 </h6><br>  Without a permanent connection, but with delivery confirmation.  It does not require matching the order of sent and delivered frames, so that they can pass through the factory in different ways.  Less demanding on resources than class 1, but proof of delivery leads to increased bandwidth utilization. <br><br><h6>  Class 3 </h6><br>  Without a permanent connection and without confirmation of delivery.  The most optimal from the point of view of using the resources of the factory, but assumes that the protocols of the upper levels will be able to collect the frames in the necessary order and re-request the transfer of the missing frames.  Most commonly used. <br><br><h6>  Class 4 </h6><br>  It requires constant connection, confirmation and order of frames as well as class 1. The main difference is that it does not reserve all bandwidth, but only part of it.  This ensures certain QoS.  Suitable for multimedia and enterprise applications requiring guaranteed connection quality. <br><br><h6>  Class 5 </h6><br>  Not yet fully described and not included in the standard.  Previously, a class that does not require a connection, but requires immediate delivery of data as it appears, without buffering on devices. <br><br><h6>  Class 6 </h6><br>  Option class 1, but multicast.  That is, from one port to several sources. <br><br><h6>  Class f </h6><br>  Class F is defined in the FC-SW standard for use in inter-switch connections (Interswitch Link, ISL).  This is a service without a permanent connection with delivery failure notifications used to monitor, manage, and configure the factory.  The principle is similar to class 2, but it is used for interaction between N-ports (ports of nodes), and class F - for communication of E-ports (inter-switch). <br><br><a name="flow_control"></a><h5>  Flow control </h5><br>  In order to prevent a situation where the sender overloads the recipient with an excessive number of frames so that they begin to be discarded by the recipient, FC uses flow control mechanisms.  There are two of them - Buffer-to-Buffer flow control and End-to-End flow control.  Their use is governed by the class of service.  For example, class 1 uses only the End-to-End mechanism, class 3 uses Buffer-to-Buffer, and class 2 uses both of these mechanisms. <br><br><h6>  Buffer-to-Buffer flow control </h6><br>  The principle of technology - a <s>loan to every house.</s> Sending any frame must be secured by the availability of a credit for sending. <br>  All frames arriving at the port entrance are placed in a special queue - buffers.  The number of these buffers is determined by the physical characteristics of the port.  One buffer (place in the queue) corresponds to one loan.  Each port has two credit counters: <br>  TX BB_Credit - transfer credit counter.  After sending each frame, it decreases by 1. If the value of the counter becomes zero, transmission is impossible.  As soon as R_RDY is received from the receiving port, the counter is incremented by 1. <br>  RX BB_Credit - credit reception counter.  As soon as the frame is received and placed in the buffer, it is reduced by 1. When the frame is processed or forwarded, the counter is incremented by 1, and R_RDY is sent to the sender.  If the value of the counter drops to 0, then in principle, the reception of new frames should be terminated.  In practice, due to credit synchronization errors, a situation may arise that the source sent another one or a few frames already after RX BB_credit became zero.  This situation is called <i>buffer overflow</i> .  In most implementations, the port handles such situations "kindly" - due to backup buffers.  Although some equipment in such cases, it may take Link Reset. <br><br>  From here comes the strong effect of the distance between ports on performance.  The higher the distance and the greater the bandwidth, the more frames will be sent (read transfer credits spent) even before the recipient receives at least the first one.  The situation is facilitated by the feature of the FC switch architecture.  The fact is that the number of buffers is not fixed strictly for each port (except eight mandatory), but is common for all.  And in the case of the definition of ‚Äúdistant links‚Äù (automatically or manually), the number of buffers allocated by the switch for this port increases.  Another plus of shared memory is that you do not need to drive buffers from one port to another inside the switch. <br><br><h6>  End-to-End flow control </h6><br>  It is implemented by the EE_Credit counter, which defines the maximum frames that the source can send to the receiver without receiving confirmation (Acknowledge, ACK).  Unlike BB_Credit, it applies only to frames with data, and the exchange / accounting occurs between the end nodes. <br><br><h4>  the end </h4><br>  Initially it seemed to me that the article would be two times smaller, but in the course of writing many details surfaced, without which the happiness did not seem complete.  A lot of things that I would like to highlight had to be dropped so far - the writing process threatened to become endless.  If someone has any comments, suggestions and suggestions for what else it is worth writing, I will be grateful.  And thanks to everyone who read to this place. <br><br>  Were used materials from the following sources: <br>  <a href="http://www.redbooks.ibm.com/redbooks/pdfs/sg245470.pdf">IBM Redbook "Introduction to SAN and System Networking"</a> <br>  EMC "Network Storage Concepts and Protocols" <br>  Brocade "SAN Fabric Administration Best Practices Guide" </div><p>Source: <a href="https://habr.com/ru/post/216369/">https://habr.com/ru/post/216369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216355/index.html">Arduino: IR control of home appliances (use of the device)</a></li>
<li><a href="../216359/index.html">Sony Virtual Reality</a></li>
<li><a href="../216361/index.html">How I chose the smart watch: Omate TrueSmart vs ZGPAX S5</a></li>
<li><a href="../216363/index.html">Queue Server</a></li>
<li><a href="../216367/index.html">How we manage configurations in pics.io</a></li>
<li><a href="../216371/index.html">How to create cool products: two key principles from the company HubSpot</a></li>
<li><a href="../216373/index.html">Results and analysis of tasks online tour NeoQUEST-2014</a></li>
<li><a href="../216375/index.html">Responsive design. Reaction to the light level</a></li>
<li><a href="../216377/index.html">About megapixels, number 41 and Jacques Fresco / UPD: added a demo video with zoom and comparison with a soap box at the request of readers</a></li>
<li><a href="../216379/index.html">Autonomous solar power station for cellular transponder. Leap into the unknown and what came of it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>