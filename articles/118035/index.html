<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Polymorphic Associations and Devise in Ruby on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 Once upon a time I wrote an article about polymorphic associations in Ruby on Rails and, I remember, some were indignant: why, they say, writ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Polymorphic Associations and Devise in Ruby on Rails</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br>  Once upon a time I wrote an article about polymorphic associations in Ruby on Rails and, I remember, some were indignant: why, they say, write about Rails 2, if a new version is coming. <br><br>  Recently I had to deal with polymorphic associations in Rails 3, or rather, to figure out how to organize two types of users on the site: the customer and the performer.  This article will focus on polymorphic associations and Devise gems (for authentication) and CanCan (for authorization). <a name="habracut"></a><br><br>  The task was the following: there are two types of users, registration and login should be made from one form, when registering, the user indicates whether he wants to be a customer or a contractor. <br>  Accordingly, users had different roles in the project, could do different things. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, according to standard Devise documentation, I added it to the project.  In the migration that Devise created, I added the following fields: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">t. <font color="#0000ff">string</font> :name, : <font color="#0000ff">null</font> =&gt; <font color="#0000ff">false</font> t.references :character, :polymorphic =&gt; true</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> t. <font color="#0000ff">string</font> :name, : <font color="#0000ff">null</font> =&gt; <font color="#0000ff">false</font> t.references :character, :polymorphic =&gt; true <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> t. <font color="#0000ff">string</font> :name, : <font color="#0000ff">null</font> =&gt; <font color="#0000ff">false</font> t.references :character, :polymorphic =&gt; true <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">t. <font color="#0000ff">string</font> :name, : <font color="#0000ff">null</font> =&gt; <font color="#0000ff">false</font> t.references :character, :polymorphic =&gt; true</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In addition to the name, any other common properties of all types of users can be brought here: country, address, and so on.  I had only the name of this field. <br>  The second line, according to the documentation (http://apidock.com/rails/ActiveRecord/ConnectionAdapters/Table/references), will create two fields for us: character_id and character_type: in the first one the ‚Äúcharacter‚Äù id will be stored, and in the second - the class name where to look for this id. <br><br>  After that, run rake db: migrate and then add the user.rb model. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> User &lt;ActiveRecord :: Base </li><li>  # Include <font color="#0000ff">default</font> devise modules.  Others available are: </li><li>  #: token_authenticatable,: encryptable,: confirmable,: lockable,: timeoutable,: trackable and: omniauthable </li><li>  devise: database_authenticatable,: registerable,: recoverable,: rememberable,: validatable </li><li></li><li>  # Setup accessible (or <font color="#0000ff">protected</font> ) attributes <font color="#0000ff">for</font> your model </li><li>  attr_accessible: name,: email,: password,: remember_me,: character_id,: character_type,: character,: character_attributes </li><li></li><li>  # Validations </li><li>  validates_presence_of: name,: character_type </li><li>  validates_inclusion_of: character_type,: <font color="#0000ff">in</font> =&gt;% w (Customer Executive) </li><li></li><li>  # Associations </li><li>  belongs_to: character,: polymorphic =&gt; <font color="#0000ff">true</font> ,: dependent =&gt;: destroy </li><li></li><li>  # Nested attributes </li><li>  accepts_nested_attributes_for: character </li><li></li><li>  # Authorization helper methods </li><li>  def customer? </li><li>  character_type == <font color="#A31515">"Customer"</font> </li><li>  end </li><li></li><li>  def executive? </li><li>  character_type == <font color="#A31515">"Executive"</font> </li><li>  end </li><li>  end </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Here we added new fields to attr_accessible, added validations, registered associations, and added accepts_nested_attributes_for. <br>  Changes in attr_accessible are needed so that you can save data in "batches", rather than one by one. <br>  Validations are needed to make sure that the records we need are added (and their format also suits us). <br>  The polymorphic association kakbe hints to us that the user now has a character field that refers to either the customer or the performer.  In essence, this is an addition to our User model, which can be either of one type or another. <br>  assepts_nested_attributes_for are needed in order to be able to make nested forms (a form for the user in which the form for the character is embedded (that is, either for the customer or for the performer). <br>  Two methods at the end - just for convenience, so that you can easily and quickly determine in controllers and views, what type of user we have. <br><br>  After that we will create 2 models: Customer and Executive.  In migrations, you can register any data unique for each type of user (passwords, attendances, etc.), in both models you need to register this in order to communicate with the user: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  has_one: user,: <font color="#0000ff">as</font> =&gt;: character,: dependent =&gt;: destroy </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  I also added user_observer (rails g observer user), where I wrote this code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> UserObserver &lt;ActiveRecord :: Observer </li><li>  def before_create (user) </li><li>  build_character_for user </li><li>  end </li><li></li><li>  <font color="#0000ff">private</font> </li><li>  def build_character_for (user) </li><li>  user.character = user.character_type.classify.constantize.create! </li><li>  end </li><li>  end </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  After that, in the config / application.rb connected this observer: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  config.active_record.observers =: user_observer </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Remember, I said that when registering, the user must choose who he wants to be?  I have this radio, but you can easily make and select.  Depending on the type chosen, they must return either ‚ÄúCustomer‚Äù or ‚ÄúExecutive‚Äù.  And, accordingly, before creating each user, we create for him either a customer or a contractor.  The code above can be written in the form: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">if</font> user.character_type == ‚ÄúCustomer‚Äù </li><li>  user.character = Customer.create! </li><li>  <font color="#0000ff">else</font> </li><li>  user.character = Executive.create! </li><li>  end </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  but this is somehow long and inconvenient, agree. <br><br>  With Devise'om done, you can now go to CanCan.  It also needs to be installed according to the documentation, and then prescribe different rules for both types of users.  For example, something like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> ability </li><li>  include CanCan :: Ability </li><li></li><li>  def initialize (user) </li><li>  user || = User.  <font color="#0000ff">new</font> </li><li></li><li>  <font color="#0000ff">if</font> user.admin?  # Admin account </li><li>  can: manage,: all </li><li>  <font color="#0000ff">else</font> </li><li>  <font color="#0000ff">if</font> user.customer?  # Customer account </li><li>  # RESTful </li><li>  can: read, Document </li><li>  can: create, Document </li><li>  can: update, Document,: customer_id =&gt; user.character.id </li><li>  can: read, Comment </li><li></li><li>  # Collections </li><li>  can: personal, Document </li><li></li><li>  elsif user.executive?  # Executive account </li><li>  # RESTful </li><li>  can: read, Document </li><li>  can: read, Comment </li><li>  can: create, Comment </li><li>  can [: update,: destroy], Comment,: executive_id =&gt; user.character.id </li><li></li><li>  # Members </li><li>  can: join, Document </li><li>  can: leave, Document </li><li></li><li>  # Collections </li><li>  can: drafts, Comment </li><li>  can: archive, Comment </li><li>  end </li><li>  end </li><li>  end </li><li>  end </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Suppose something like that.  Thus, both customers and implementers have access to the same controllers / resources, but each is allowed different actions. <br><br>  Now in the view it is enough to check whether the current user can do this or that action, and life will seem like Paradise. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">if</font> can?  : join @document </li><li>  = link_to ‚ÄúJoin‚Äù, [: join, @document] </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Now the link "Join" see only those who are allowed in the rules above.  It is necessary to correct the controller a little more, but everything is according to standard documentation. <br><br>  Similarly, you can hide and show the various blocks on the site, and indeed anything. <br><br>  Now a few words about associations: most associations are now registered in customer and artist models, and not in the user model.  Thus, the greatest flexibility is achieved with further development. <br><br>  The result of the article is as follows: there are situations when polymorphic associations are really needed and greatly simplify life.  You shouldn't fanatically add them to every hole, but you should be aware of them and be able to apply. <br><br>  Related Links: <br>  <a href="https://github.com/plataformatec/devise">github.com/plataformatec/devise</a> <br>  <a href="https://github.com/ryanb/cancan">github.com/ryanb/cancan</a> <br>  <a href="http://habrahabr.ru/blogs/ror/79431/">habrahabr.ru/blogs/ror/79431</a> </div><p>Source: <a href="https://habr.com/ru/post/118035/">https://habr.com/ru/post/118035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118028/index.html">Cooking HTML5 video in VLC and serving with jPlayer</a></li>
<li><a href="../118029/index.html">HBO Go - HBO series on Android and iOS</a></li>
<li><a href="../118030/index.html">IE7 - browser for masochists</a></li>
<li><a href="../118031/index.html">New wave of spam on Facebook</a></li>
<li><a href="../118032/index.html">Wordrive understands himself and Apple reporting</a></li>
<li><a href="../118036/index.html">Tarantool Data and Protocol</a></li>
<li><a href="../118040/index.html">New Google Groups interface</a></li>
<li><a href="../118041/index.html">LINQ for Java: LambdaJ</a></li>
<li><a href="../118046/index.html">In Finland, Sony called for compensation for the removal of the OtherOS function from the PS3</a></li>
<li><a href="../118047/index.html">Ruby on RHS ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>