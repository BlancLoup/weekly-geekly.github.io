<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CloudFlare + nginx = we cache everything on a free plan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the free version of Cloudflare, everything is fine (by God, a fairy tale!), But the list of cached file formats is quite limited. 
 Fortunately, ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CloudFlare + nginx = we cache everything on a free plan</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/183/5b6/f40/1835b6f4038b41a8b5efe52c11664a35.png"><br>  In the free version of <a href="https://www.cloudflare.com/plans">Cloudflare,</a> everything is fine (by God, a fairy tale!), But the list of <a href="https://support.cloudflare.com/hc/en-us/articles/200172516-Which-file-extensions-does-CloudFlare-cache-for-static-content-">cached file</a> formats is quite limited. <br>  Fortunately, caching everything in a row (up to <a href="https://support.cloudflare.com/hc/en-us/articles/200394750-What-s-the-maximum-file-size-CloudFlare-will-cache-">512 MB</a> per file) can be configured in <s>one or</s> two steps. <br><br><a name="habracut"></a><br><br>  The first step is to create a Page rule for your CDN subdomain in the cloudflare panel. <br>  Below is an example of a rule for my subdomain.  It contains heavy static (up to 500MB per file) <br><img src="https://habrastorage.org/files/732/503/cec/732503cec6314865933a9e4e368b22b5.png"><br>  The most important line is <b>Cache everything</b> . <br>  TTL each puts on their choice.  In my case, this is static, <b>which never changes</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After that, <b>any</b> request from your subdomain will be cached. <br><br>  Example, in the form of an archive 7z more than 400 MB <br><img src="https://habrastorage.org/files/85d/e38/38f/85de3838faf54112b24f1ce6d287d5ef.png"><br><br>  And the second stage is nginx. <br><br>  2 lines should be added to <code>server {}</code> config for CDN: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$args</span></span> !~ ^$){ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 404; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request</span></span> ~* (^.*\?.*$)){ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 404; }</code> </pre><br>  The first <code>if</code> is a protection against <a href="http://habrahabr.ru/post/215233/">DDoS in the style of Google Spreadsheet</a> , as in the case of <b>Cache everything</b> when you request <code>archive.7z?ver=killemmall</code> CloudFlare, your channel will not fail (if you have not set bloodthirsty restrictions for CDN servers). <br>  For this purpose, in the case of requests for files with arguments ( <code>$args</code> ), this if condition is introduced. <br><br>  But that's not all! <br><br>  Second <code>if</code> : <code>archive.7z</code> <u><b>?</b></u>  <b>! =</b> <code>archive.7z</code> (for lovers of the classic <code>&lt;&gt;</code> , ‚Äúunequal!‚Äù) in the case of the <b>Cache everything</b> option in Page rules.  And this query easily skips past the first check, since <code>$args</code> empty!  It would seem okay that the 400 MB archive will be requested again once, it will not lose from the server. <br>  In fact, not once, but up to <b>42</b> ( <b>forty-two</b> ) times. <br>  I requested a file through servers in different countries and noticed that the file was cached for country # 1, and when requested from country # 2 it was cached using a new one. <br>  A support question was asked and an answer was received: ‚ÄúCloudFlare has 42 PoPs, 42 times.‚Äù <br>  Accordingly, the file with the parameter "?"  (Cache everything!) Can be requested 42 more times and the file itself 41 more times at least.  Total 83 requests.  Accordingly, a 400 MB file is converted into the maximum possible 33 GB of traffic <u>during your TTL</u> and the <b>load</b> on your channel from the CDN provider. <br><br>  Here that there were no additional <b>maximum possible</b> parasitic 42 requests and the second check is entered. <br>  Remarkable result: <br><img src="https://habrastorage.org/files/d73/26d/543/d7326d543dc64c8fae52ee9bc19b47e8.png"><br><br>  <b>What we get:</b> <br>  +28 data centers for our <b>universal</b> CDN <br>  + a <b>huge reduction in the</b> load on the channel <br>  + traffic saving <br><br>  <b>What we lose:</b> <br>  -the ability <s>to give</s> files on the CDN provider <b>more than 512 MB</b> (limit free tariff) <br>  files for which requests <b>contain</b> "?"  (in this case, the regular session in the second <code>if</code> must be reworked). <br><br>  <b>We receive, but with reservations:</b> <br>  + -Caching video files for distribution.  <b>You can play / share</b> files, but you can not <b>rewind</b> . <br><br>  <b>CloudFlare</b> , like any other CDN-caching and <u>proxying</u> CDN provider, is a very powerful tool, and in order ‚Äúwith this tool‚Äù to be better than ‚Äúwithout‚Äù, it is necessary to use it correctly, even if it is not described in the official documentation.  Otherwise, you risk getting a negative result (the Internet is replete with opinions of which CDN is bad). <br><br>  Successes to you and excellent uptime! </div><p>Source: <a href="https://habr.com/ru/post/245165/">https://habr.com/ru/post/245165/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245145/index.html">Expressive javascript: http</a></li>
<li><a href="../245153/index.html">Brief history of web design</a></li>
<li><a href="../245155/index.html">How we wrote helpdesk (part 2)</a></li>
<li><a href="../245157/index.html">Meeting on cross-platform development for Windows, iOS, Android - December 18, Moscow</a></li>
<li><a href="../245159/index.html">Hacker found a way to read files on Facebook servers</a></li>
<li><a href="../245171/index.html">Research software in universities in the UK</a></li>
<li><a href="../245175/index.html">C ++ 11/14/17 support summary table</a></li>
<li><a href="../245181/index.html">The digest of interesting materials for the mobile developer # 82 (December 1-7)</a></li>
<li><a href="../245183/index.html">How to make thin client from old Windows PC?</a></li>
<li><a href="../245185/index.html">International and national standards for information project management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>