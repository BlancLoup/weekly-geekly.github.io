<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>But about Sphinx 3.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here you all sit there and do not know anything, and we, meanwhile, are sawing little by little the mega-release of the search engine Sphinx number 3....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>But about Sphinx 3.0</h1><div class="post__text post__text-html js-mediator-article">  Here you all sit there and do not know anything, and we, meanwhile, are sawing little by little the mega-release of the <a href="http://sphinxsearch.com/">search engine Sphinx</a> number 3.0.  Coming a series of large alterations.  Some of them, as expected, have not even begun properly.  However, most are more likely ready than not.  And separately taken changes even leaked to the <a href="https://code.google.com/p/sphinxsearch/source/browse/">public branch 2.3</a> .  So, perhaps, it is time to start briefly telling what to expect in a bright future: I hope, not so remote.  Who is interested in reading, all under the cat;  To listen, come to <a href="http://www.meetup.com/SphinxSearch/events/222478387/">meetup this Saturday</a> .  In brief, then: farewell, the concept of the engine complementing the main base;  hello, document repository, total RT, replication, REST and a number of other well-known keywords. <br><a name="habracut"></a><br>  Let's start with the main, short list of planned <i>large</i> changes: <br><ul><li>  New format FT index: faster indexing, faster search, smaller size; </li><li>  New attribute format: goodbye, all foolish historical limitations; </li><li>  full transition to threads: bye bye, directive workers, hello, thread pool; </li><li>  full transition to RT indexes: with the indexer remaining, but the type directive is not very; </li><li>  online replication of RT indexes: gradually replace the hellish manual cluster with an automatic one; </li><li>  storage of original documents: farewell, concept of auxiliary index, hello, world, now we are also like a base; </li><li>  native attribute indexes: emulation with keywords somehow works, but indexes can be used; </li><li>  REST interface: API for bots, SQL for yourself, REST for people. </li></ul><br><br>  Two large internal changes are, of course, from all sides (both in the full-text and attribute parts) new index format, plus a forced transition to a strictly thread model of work and strictly RT indices.  Why and why is it all? <br><br>  The old format of the FT index has been conceptually stretched, it‚Äôs scary to think, since 2001.  Not, of course, certain changes and optimizations were made regularly in it, so the old man is still hearty.  However, there were no radical, conceptual changes, naturally, right from 2001.  How to store a pack of varint encoded deltas external docid, and store.  Moreover, being a rather low-level building block, the index format affects not only the actual storage of data, but also affects a number of pieces in the internal architecture, which then flow outwards: the requirement to provide external DocID, headaches with duplicate documents, a number of strange moments in performance, this is it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we can do better. <br><br>  In the new format there is no ‚Äúmagic‚Äù external unique attribute DocID, the internal numbering of documents is untied from the external one.  This change alone makes possible a bunch of pieces: suddenly, duplicate IDs can be poured into the index, or no numeric ID is required at all;  suddenly, if necessary, you can build compact bitmasks for a subset of index documents, rather than hefty ID lists;  suddenly, the actual full-text index data may be much more efficiently compressed with all sorts of group codecs such as PFD, Group Varint and others;  suddenly, when indexing, the boring sorting stage is not needed, the index can be built almost incrementally;  and so on.  The index becomes up to 1.5 times smaller, is built 2-3 times faster and, theoretically, it can also be searched up to 2-3 times faster, at least on individual queries.  Profit from all sides. <br><br>  The latter provokes the next minor revolution.  Since the new incremental indexing algorithm (which, roughly speaking, ‚Äúappends‚Äù 1 entry to the existing non-index in memory), was just 2-3 times faster than the current package indexing of disk indexes, then why bother to distinguish between disk indexes and RT indexes?  Great, down with disk indexes, down with type directive.  Since now we can make all indexes RT, and without loss of performance, rather even with acceleration, it means that we need to do it.  (Inside, all the same, there are still disk / RAM based options for implementing individual segments of the index, of course. The disk and memory do not differ in TTX and this cannot be remembered. However, this is a clear headache "how to do it effectively" for developers, and noticeable outside functional differences for users should not be.) <br><br>  What is interesting, while the indexer utility, in principle, does not disappear anywhere.  ETL tool for uploading data from the database and loading them into the search is still useful to have.  However, it used to build a disk index, and now it will build an RT index (either for direct downloading to the daemon, or for sticking a freshly indexed data packet to an existing index, this is no longer important). <br><br>  Since the format of the full-text part is still changing a lot, then at the same time we need to change the attribute storage format, walk for a walk (break compatibility, break) !!!  Now all columns of variable length (strings, MVA, JSON, and any other tricky types, if they are added in the future) for one document are stored in one large blob, and the pointer to this blob is also stored alone.  (Previously, each type had a separate file, and a separate column, ohh.) At the same time, the stupid youth mistake ‚Äú4 GB should be enough for everybody‚Äù is eliminated, plus everything can be uniformly updated, deleted, and so on.  Total fixed-length attributes are stored as before (only due to the transition to internal numbers, access to them is much faster), variable-length attributes eat somewhat less memory (8 bytes for all at once, and not 4 bytes for each), plus now there‚Äôs no way limited in size.  Plus other nice improvements: for example, the format now supports honest NULL.  Or the key compression is now done inside the JSON data. <br><br>  Switching to RT, in turn, means that fork / prefork is no longer just hard to maintain, but impossible.  However, here once and for all there is a solution ‚Äúboth quickly and well‚Äù, without these damned compromises: thread pool (already available in 2.3) works as energetically as possible in terms of search speed (see quickly), the basic model of parallel processing remains one, multi-threaded, not multiprocess (see good).  If even kreshy managed to affect only one thread, it would be generally ideal, but there is no ideal in life.  Therefore, to alleviate the pain of kresh, now the overwhelming part of the necessary data at the start is still mmap (), rather than being copied, due to which the launch (and restart), even with large indices, became quite fast. <br><br>  In addition to threads, due to forcing RT, replication becomes very, very necessary.  Once we declare the rejection of disk indexes, which at least somehow could be copied in the form of files back and forth, it means that at least some tools are needed for RT.  You can, of course, make a hot backup / restore, but this is boring.  Online replication of RT indexes is much more interesting.  Well, we do.  1 master, N dynamic replicas, automatic transfer of initial snapshot, replication of incoming changes, re-selection of the master, all these things.  The next step is all sorts of tools for building and managing the cluster, but first let replication heal completely. <br><br>  Replicating "just full-text indexes" is somehow small, plus giving the original documents to save, because they are regularly asked, plus to further speed up the snippets, you need to be able to save the blob with any strange stuffing, plus the format of the index untethered from the docid allows for any cleverly implemented.  Well, we do more and docstore, those.  disk storage of not only attributes, but also fields of indexed documents, as well as any associated meta information (for now, these are only document level indices for snippets).  A small step for the code, great for functionality: now you can add not only the full-text index to the Sphinx, but you can also completely use it as a base.  Weird, but the base. <br><br>  It would be nice to have indexes in the database not only for keywords, so at the same time you need to worry about indexes by attributes.  Well, this is so that the WHERE MATCH ('the who') AND author = 1234 is executed ‚Äúfrom the index‚Äù, the WHERE MATCH ('biggest rarity') AND gender = 'm' is executed from the ‚Äúsearch‚Äù, but both are automatically it was executed optimally, but not in such a way that in the calling PHP script it is necessary to implement an analogue SQL optimizer and a query generator of the WHERE MATCH type ('the who _author1234').  It is stupid to emulate attributes with a cloud of keywords, as it seems like (it seems) is still known where, too, of course, you can, but if you already do, so for the most !!! <br><br>  And finally, SQL is unfashionable, plus it is not convenient to call anywhere, so HTTP / REST access must be added.  A very basic initial implementation is already in 2.3, from there we will expand and deepen.  Nothing interesting, even boring. <br><br>  With all this, Sphinx 3.0 will try to fly. <br><br>  The series described, of course, is still under development and may not be included in the initial alphas.  However, the general plan is just that, plus, let's say, more than half of this plan has already been done.  Work left pretty, but turn back is too late! <br><br>  It is clear that for each individual big item you can write a separate good article with a bunch of technical details, but you need to start somewhere.  Here, I tried to make a small review of future changes.  I will tell the same thing in more detail in 3 days, <a href="http://www.meetup.com/SphinxSearch/events/222478387/">this Saturday at the meeting of Sphinx-gadflies</a> (Moscow, of course), who immediately had a million clarifying questions and there is no way to write them all in the comments, go to the light, try to answer .  As far as possible I will write here (and / or to the blog on the site) more articles about the coming mega-fiches. <br><br>  In general, Sphinx 3.0 is coming, a lot of rework is coming, I think it will be interesting. <br><br>  After all, there cannot be exactly ONE library in the world for full-text search, and that one on Godless Java? !!!  :-) </div><p>Source: <a href="https://habr.com/ru/post/257789/">https://habr.com/ru/post/257789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257775/index.html">Abstractions without overhead: types in Rust</a></li>
<li><a href="../257779/index.html">Programmable Wi-Fi night light bulb on ESP8266</a></li>
<li><a href="../257781/index.html">Vector replacement to sprites - we implant SVG in CSS</a></li>
<li><a href="../257783/index.html">IBM Introduces New Cyber ‚Äã‚ÄãAttack Solution</a></li>
<li><a href="../257787/index.html">Configuring a Pfsense based gateway. Part 1</a></li>
<li><a href="../257791/index.html">Cisco Company Development History: 1984-2000</a></li>
<li><a href="../257793/index.html">Format Analysis: Sound in some games on the Unreal Engine</a></li>
<li><a href="../257795/index.html">Bitrix24 CRM. Overview</a></li>
<li><a href="../257803/index.html">Another attempt to interest students</a></li>
<li><a href="../257809/index.html">The problem of the two sages. Computer program for solving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>