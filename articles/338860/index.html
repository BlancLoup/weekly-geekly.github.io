<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We attack DHCP part 2. DHCP + WiFi = MiTM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about another way to implement MiTM on a WiFi network , which is not the easiest, but it works. Before reading this articl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We attack DHCP part 2. DHCP + WiFi = MiTM</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/cb/f1/59cbf12c2e41d988534094.png" alt="LOGO"></p><br><p>  In this article I will talk about another way to implement <strong>MiTM on a WiFi network</strong> , which is not the easiest, but it works.  Before reading this article, I strongly recommend that you familiarize yourself with the <a href="https://habrahabr.ru/company/dsec/blog/333978/">first part</a> , in which I tried to explain how DHCP works and how to use it to attack clients and the server. </p><a name="habracut"></a><br><p>  As always, for the implementation of this attack there are a couple of restrictions: </p><br><ol><li>  We must be connected to the attacked access point. </li><li>  We should be able to listen to broadcast traffic on the network. </li></ol><br><p>  And so how does this work?  The attack is divided into several stages: </p><br><ol><li>  We make attack of DHCP Starvation; </li><li>  We send WiFi DeAuth packages; </li><li>  We intercept ARP requests from clients, respond to them in order to create an IP address conflict and force the client to send a DHCPDECLINE; </li><li>  We intercept DHCPDISCOVER and DHCPREQUEST requests, we answer them; </li><li>  Profit! </li></ol><br><p>  We will understand this scheme in more detail. </p><br><h2 id="dhcp-starvation">  DHCP Starvation </h2><br><p>  We connect to the attacked WiFi network and perform a <strong>DHCP Starvation</strong> attack in order to overflow the pool of free IP addresses. <br>  How it works: </p><br><ol><li><p>  We form and send a broadcast <strong>DHCPDISCOVER</strong> request, while introducing ourselves as the DHCP relay agent.  In the field <strong>giaddr</strong> (Relay agent IP) we specify our IP address <strong>192.168.1.172</strong> , in the field <strong>chaddr</strong> (Client MAC address) - random MAC <strong>00: 01: 96: E5: 26: FC</strong> , while at the data link layer in <strong>SRC MAC we</strong> set our MAC address: <strong>84: 16: F9: 1B: CF: F0</strong> . <br><img src="https://habrastorage.org/webt/59/cb/f2/59cbf2c43e2f3770480181.png" alt="DHCPDISCOVER"></p><br></li><li><p>  The server responds with a <strong>DHCPOFFER</strong> message to the relay agent (us), and offers the client with the MAC address <strong>00: 01: 96: E5: 26: FC the</strong> IP address <strong>192.168.1.156</strong> <br><img src="https://habrastorage.org/webt/59/cb/f2/59cbf2e153b66834304992.png" alt="DHCPOFFER"></p><br></li><li><p>  After receiving the DHCPOFFER, we send a broadcast <strong>DHCPREQUEST</strong> request, while in the DHCP option with code 50 ( <a href="https://tools.ietf.org/html/rfc2132">Requested IP address</a> ) we set up offers to the client the IP address <strong>192.168.1.156</strong> , in the option with code 12 ( <a href="https://tools.ietf.org/html/rfc2132">Host Name Option</a> ) - a random string <strong>dBDXnOnJ</strong> .  <strong>Important: the</strong> <strong>xid</strong> (Transaction ID) and <strong>chaddr</strong> (Client MAC address) fields in DHCPREQUEST and DHCPDISCOVER must be the same, otherwise the server will reject the request, because it will look like another transaction from the same client, or another client with the same transaction. <br><img src="https://habrastorage.org/webt/59/cb/f2/59cbf2fb484ad265669722.png" alt="DHCPREQUEST"></p><br></li><li>  The server sends a <strong>DHCPACK</strong> message to the relay agent.  From this point on, the IP address <strong>192.168.1.156</strong> is considered reserved for the client with the MAC address <strong>00: 01: 96: E5: 26: FC</strong> for <strong>12 hours</strong> (the default lease time). <br><img src="https://habrastorage.org/webt/59/cb/f3/59cbf3164ed4d692300539.png" alt="DHCPACK"><br><img src="https://habrastorage.org/webt/59/cb/f3/59cbf328269d9938571504.png" alt="DHCP clients"></li></ol><br><h2 id="wifi-deauth">  WiFi DeAuth </h2><br><p>  The next step is to make Wi-Fi Deauth.  This scheme works like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/278/808/590/2788085906046782b19584f3ac6396ba.svg" alt="WiFi DeAuth"></p><br><p>  We transfer the free wireless interface to the monitoring mode: </p><br><p><img src="https://habrastorage.org/webt/59/cb/f4/59cbf43d1d87b919191053.png" alt="Wlan1 set monitor mode"></p><br><p>  We send deauth packets in order to disconnect the attacked client <strong>84: 16: F9: 19: AD: 14</strong> WiFi networks ESSID: <strong>WiFi DHCP MiTM</strong> : </p><br><p><img src="https://habrastorage.org/webt/59/cb/f4/59cbf46170301411755340.png" alt="Send deauth packets"></p><br><h2 id="dhcpdecline">  DHCPDECLINE </h2><br><p>  After the client <strong>84: 16: F9: 19: AD: 14 ‚Äã‚Äãhas</strong> disconnected from the access point, most likely, he will try again to connect to the WiFi WiFi network <strong>MiTM WiFi</strong> and get the IP address via DHCP.  Since he had previously connected this network, only broadcast <strong>DHCPREQUEST</strong> will poison. <br><img src="https://habrastorage.org/webt/59/cb/f4/59cbf4a9dce8c416458319.png" alt="Send DHCPREQUEST after DeAuth"></p><br><p>  We intercept the client's request, but we will not have time to respond faster than the access point.  Therefore, the client receives the IP address from the DHCP server obtained earlier: <strong>192.168.1.102</strong> .  The client then uses the <strong>ARP</strong> protocol to try to detect <a href="https://tools.ietf.org/html/rfc5227">IP address conflicts on the network</a> : <br><img src="https://habrastorage.org/webt/59/cb/f4/59cbf4eebf7f0398207390.png" alt="Try detect IP address conflict"></p><br><p>  Naturally, such a request is broadcast, so we can intercept and respond to it: <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf502a41e6985208136.png" alt="IP address conflict detected"></p><br><p>  The client then fixes the IP address conflict and sends a <a href="https://ru.wikipedia.org/wiki/DHCP">DHCP reject</a> broadcast message - <strong>DHCPDECLINE</strong> : <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf536095ac440717159.png" alt="Send DHCPDECLINE"></p><br><h2 id="dhcpdiscover">  DHCPDISCOVER </h2><br><p>  And so, the last stage of the attack.  After sending a <strong>DHCPDECLINE, the</strong> client goes through the procedure of obtaining an IP address from the very beginning, namely, it sends a broadcast <strong>DHCPDISCOVER</strong> .  The legitimate DHCP server cannot respond to this request, since the free IP address pool is full after the <strong>DHCP starvation</strong> attack and therefore slows down noticeably, but we can respond to the DHCPDISCOVER - <strong>192.168.1.172</strong> . </p><br><p>  Client <strong>84: 16: F9: 19: AD: 14</strong> (Win10-desktop) sends a broadcast <strong>DHCPDISCOVER</strong> : <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf558d1774414756451.png" alt="DHCPDISCOVER"></p><br><p>  We <strong>respond DHCPOFFER</strong> : <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf56f71670393159864.png" alt="Attacker DHCPOFFER"></p><br><p>  In <strong>DHCPOFFER,</strong> we offered the client an IP address of <strong>192.168.1.2</strong> .  The client receiving this offer only sends a <strong>DHCPREQUEST</strong> from us, setting the value of the <strong>requested ip</strong> to <strong>192.168.1.2</strong> . </p><br><p>  Client <strong>84: 16: F9: 19: AD: 14</strong> (Win10-desktop) sends a broadcast <strong>DHCPREQUEST</strong> : <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf5a28cdee229406722.png" alt="DHCPREQUEST"></p><br><p>  <strong>DHCPACK</strong> Answer: <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf5b789b18512851461.png" alt="Attacker DHCPACK"></p><br><p>  The client accepts our DHCPACK and sets our IP address as <strong>the default gateway</strong> and <strong>DNS server</strong> : <strong>192.168.1.172</strong> , and simply ignores the DHCPNAK from the access point sent 2 seconds later. <br><img src="https://habrastorage.org/webt/59/cb/f5/59cbf5da19a7b491758698.png" alt="Client network settings"></p><br><p>  <strong>Question:</strong> Why did the access point send a DHCPOFFER and DHCPNAK for <strong>2 seconds later</strong> , and even offered the same IP address <strong>192.168.1.102</strong> , because the client refused it? <br><img src="https://habrastorage.org/webt/59/cb/f6/59cbf603da4b2963537378.png" alt="DHCPOFFER from AP"></p><br><p>  To answer this question, we will slightly change the filter in WireShark and see the ARP requests from the access point: <br><img src="https://habrastorage.org/webt/59/cb/f6/59cbf676699f5893846488.png" alt="Add ARP requests from AP"></p><br><p>  <strong>Answer:</strong> After the DHCP Starvation attack, the DHCP server did not have free IP addresses, besides, one of the clients refused: <strong>192.168.1.102</strong> .  Therefore, upon receiving a DHCPDISCOVER request, the DHCP server sends three ARP requests within 2 seconds to find out who is using the IP address: <strong>192.168.1.102</strong> , and after the server has made sure that this IP address is free, because no one did not answer, gives it to the client.  But it was too late for the attacker to respond quickly. </p><br><h2 id="rezultaty">  Results: </h2><br><p>  Thus, we can set any network parameters, namely: default gateway, DNS server and others - to any connected or new client in the attacked WiFi network, provided that we are already connected to it and can listen to broadcast traffic. </p><br><p>  Video of the attack on MacOS Siera and Windows 10: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/OBXol-o2PEU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="nu-i-konechno-zhe-pochttpsgithubcomvladimir-ivanov-gitraw-packet">  And of course <a href="https://github.com/Vladimir-Ivanov-Git/raw-packet">PoC</a> . </h2></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338860/">https://habr.com/ru/post/338860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338850/index.html">Strange character and hot announcements of the first days of Microsoft Ignite</a></li>
<li><a href="../338852/index.html">Why do business games and what have the ERA</a></li>
<li><a href="../338854/index.html">How we did design for bitcoin</a></li>
<li><a href="../338856/index.html">Become a hacker: from ‚ÄúTest lab‚Äù to ‚ÄúCorporate laboratories‚Äù</a></li>
<li><a href="../338858/index.html">How to make gif-animation for Behance and Dribbble?</a></li>
<li><a href="../338862/index.html">DPI-digest: information security, virtualization and regulation</a></li>
<li><a href="../338864/index.html">We attack DHCP part 3. DHCP + Apple = MiTM</a></li>
<li><a href="../338866/index.html">Deploying Magento 2 Development Applications</a></li>
<li><a href="../338868/index.html">Non-standard clustering 4: Self-Organizing Maps, subtleties, improvements, comparison with t-SNE</a></li>
<li><a href="../338870/index.html">Optimizing TensorFlow on modern Intel architectures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>