<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking foreign DHCP servers on the MikroTik CRS switch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The problem of the lack of the full DHCP-snooping function in MikroTik devices has already been said and written too much. And everywhere for catching...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking foreign DHCP servers on the MikroTik CRS switch</h1><div class="post__text post__text-html js-mediator-article">  The problem of the lack of the full DHCP-snooping function in MikroTik devices has already been said and written too much.  And everywhere for catching the villainous DHCP they offer to load the CPU.  I will tell you how to kill someone else's DHCP server using a switch chip integrated into MikroTik CRS switches. <br><a name="habracut"></a><br>  Common materials on the network relate to the work of MikroTik routers.  And they all use scant CPU resources to capture DHCP.  At the same time, a relatively fresh line of switches is chronically neglected.  By the way, completely in vain. <br><br>  So, the experimental device <b>CRS125-24G-1S is</b> installed on access.  For some time now, occasional IP addresses began to fall on user devices.  Naturally, the task ‚Äúto find and neutralize‚Äù arose.  In the standard RouterOS arsenal, there is a tool called ‚ÄúDHCP-server Alert‚Äù that can trigger some actions when it detects a third-party DHCP server on the network. <br><br>  Fine?  Perhaps.  Only a closer look at the tool was not very informative.  To understand why, consider the typical architecture of routing equipment MikroTik (picture from the wiki): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/4a5/7f0/21b/4a57f021bf5abea89dc4d21a31b18571.png" alt="image"><br><br>  In fact, the main part of the device is divided into two: <br><br>  1) software-configured switch, performing switching at maximum speed; <br>  2) CPU responsible for routing, filtering and also able to perform switching at the software level, slower and more resource-intensive. <br><br>  IP services on such a device, of course, hang at the top level.  On the master interface ascending to the CPU Routerboard or on the software bridge.  There lives a DHCP server and its alert service.  All the solutions I have seen before also had two drawbacks arising from this architecture: <br><br>  1) Traffic filtering from the villain was performed on the bridge, through the ‚Äúuse ip firewall‚Äù and took away the meager CPU resources; <br>  2) The villain connected to the switch continued to uncontrollably dirty the subscribers on the neighboring ports of this switch. <br><br>  For example, subscribers hanging on port2 and port3 still continued to receive bjaku arriving from port4.  But that all changed when MikroTik got the CRS line - the guys installed a more powerful and functional switch chip, which I decided to try to use, win and save CPU resources. <br><br><h3>  Step # 1 </h3><br>  We configure "DHCP-server Alert".  The setting itself is not complicated, almost everything is described in the vendor's wiki - we enable, set the interface on which to monitor (for example, bridge-local), specify our trusted DHCP.  We can add a script to call in case of anything.  Cheers - parameters are automatically transferred to the script: $ interface $ mac-address $ address of the detected villain!  Hooray?  So easy?  But here the first underwater rake is hidden.  And not alone. <br><br>  <b>First rake:</b> in $ interface, the interface name is passed on which the alert itself sits.  Therefore, even if the villain is connected to the ‚Äúport4‚Äù interface (see the picture above), the variable will still be ‚Äúbridge-local‚Äù.  In the log we see almost the same thing: <br><br><pre><code class="hljs css">"<span class="hljs-selector-tag"><span class="hljs-selector-tag">dhcp-alert</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">on</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge-local</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">discovered</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">unknown</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dhcp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mac</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xyz</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>"</code> </pre> <br>  Khm  How many ports do we have?  24?  Okay.  I'm going to look for ... <br><br><h3>  Step 2 </h3><br>  According to the rake.  It is necessary to search in a unicast-fdb switch, according to the variable $ mac-address.  And here the second rake was waiting for me.  Real underwater.  The script was called, but did not want to work.  Those who are engaged in script writing for MikroTik will confirm that debugging an automatically launched script is not a trivial task in itself.  Moreover, the on-error {} handler was silent for some reason.  It was experimentally discovered that the code <br><br><pre> <code class="hljs swift">:<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> portname [/interface ethernet <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> unicast-fdb <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> mac-address=$mac-address] port ]</code> </pre> <br>  works well on the terminal command line and only on it.  In the body of the script does not want.  The reason is a strange interpretation of the name by your own (defined by the vendor!) Variable $ mac-address. <br><br>  <b>Feature:</b> interpretation of commands in the script goes <s>through ... in a</s> different way.  For successful work, the name of the system variable must be escaped: <code>($"mac-address")</code> .  At the same time, tricks are not excluded in further use. <br><br>  I went another way, creating a local variable with a normally interpreted name: <br><br><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> smac ($"mac-address")</code> </pre> <br>  It became easier.  Now you can see the name of the real interface on the switch to which the pest is connected.  It remains to figure out how to kill him. <br><br>  As you know, a real Jedi uses power, and a real engineer uses a brain.  Therefore, the idea of ‚Äã‚Äãstupidly completely chopping off the found port was discarded by me - what if there are several users and / or devices sitting behind this port?  Fortunately, the switch chip in MikroTik CRS allows you to make a MAC-Based-Vlan.  The decision came immediately - to allocate traffic from the villain by MAC and wrap it in a separate unused Vlan.  As a result, we got a compact script that reliably disconnects another device from the network with a DHCP server raised on it. <br><br><pre> <code class="hljs vbscript">#dhcpsnooper - script <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> cut off rogue DHCP <span class="hljs-built_in"><span class="hljs-built_in">server</span></span> #stubvid - Stub Vlan Id <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> move rogue DHCP <span class="hljs-built_in"><span class="hljs-built_in">server</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> your own value according your vlan config :local stubvid <span class="hljs-number"><span class="hljs-number">666</span></span> :local smac ($<span class="hljs-string"><span class="hljs-string">"mac-address"</span></span>) :local portname [/<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> eth sw uni <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> [find mac-address=$smac] port ] :local imac [/<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> eth sw mac find src-mac-address=$smac] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> $imac]&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={/interface ethernet switch mac-based-vlan add <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-customer-vid=($stubvid) src-mac-address=($smac) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $imac <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={/interface ethernet switch mac-based-vlan <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> $i <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-customer-vid=($stubvid) src-mac-address=($smac) disabled=no } } /interface ethernet switch port <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> $portname allow-fdb-based-vlan-translate=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"DHCP found on PORT:"</span></span>.($<span class="hljs-string"><span class="hljs-string">"portname"</span></span>).<span class="hljs-string"><span class="hljs-string">" MAC:"</span></span>.($<span class="hljs-string"><span class="hljs-string">"mac-address"</span></span>).<span class="hljs-string"><span class="hljs-string">" IP:"</span></span>.($address))</code> </pre> <br>  The variable $ stubvid, as it should be clear from the name, is the number of the Vlan stub.  The $ imac variable is an array.  For some reason, MikroTik allows you to make several entries with the same MAC in the mac-based-vlan table, which caused a failure when trying to get a single value.  Warnings are simply written in log error, but nothing prevents you from adding more persistent information to the network administrator. <br><br>  The call of the alert and script is registered as follows: <br><br><pre> <code class="hljs pgsql">/ip dhcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> alert <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> disabled=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> interface=bridge-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-alert=dhcpsnooper <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>=MAC__DHCP</code> </pre> <br>  Thank you for reading to the end.  I hope you find it useful someday. </div><p>Source: <a href="https://habr.com/ru/post/310542/">https://habr.com/ru/post/310542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310532/index.html">Preview Rambler.iOS # 8</a></li>
<li><a href="../310534/index.html">Dynamic DNS in C # and Yandex.API</a></li>
<li><a href="../310536/index.html">Encryption mechanisms in modern ransomware</a></li>
<li><a href="../31054/index.html">The basics of .htaccess with examples</a></li>
<li><a href="../310540/index.html">Why Google bought Api.ai - a startup with Russian roots</a></li>
<li><a href="../310544/index.html">Layout: display custom content</a></li>
<li><a href="../310546/index.html">New in our big data program and three scholarships for training</a></li>
<li><a href="../310548/index.html">CCTV vulnerabilities allow hackers to create large-scale botnets</a></li>
<li><a href="../31055/index.html">AS2 and AS3 components in Flash CS3 Professional</a></li>
<li><a href="../310550/index.html">The free data of North Korea‚Äôs national DNS leaked to free access.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>