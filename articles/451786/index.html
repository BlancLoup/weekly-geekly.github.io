<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Run instrumental tests in the Firebase Test Lab. Part 1: iOS project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Dmitry, I work as a tester in the company MEL Science . Most recently, I finished exploring a relatively fresh feature from the Firebase Te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Run instrumental tests in the Firebase Test Lab. Part 1: iOS project</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ak/zz/ax/akzzax8yp7xdofbpono3dplmgrw.png" alt="image"><br><br>  My name is Dmitry, I work as a tester in the company <a href="https://melscience.com/RU-ru/">MEL Science</a> .  Most recently, I finished exploring a relatively fresh feature from the <a href="https://firebase.google.com/docs/test-lab">Firebase Test Lab</a> ‚Äî namely, instrumental testing of iOS applications using the native XCUITest testing framework. <br><br>  Before that, I already tried out the Firebase Test Lab for Android and I really enjoyed it, so I decided to try putting the test infrastructure of the iOS project on the same rails.  It was necessary to google a lot and not everything worked out the first time, so I decided to write an article-tutorial for those who still have it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, if you have UI tests on an iOS project, you can already try running them on real devices, kindly provided by the Good Corporation, today.  Interested - welcome under cat. <br><a name="habracut"></a><br>  In the story, I decided to build on some of the source data - a private repository on GitHub and the build system CircleCI.  The name of the application is AmazingApp, bundleID - com.company.amazingapp.  I cite these data immediately, to reduce the subsequent confusion. <br><br>  If you have implemented different decisions in your project differently - share your experience in the comments. <br><br><h2>  1. Sami tests </h2><br>  Create a new project branch for UI tests: <br><br><pre><code class="bash hljs">$ git checkout develop $ git pull $ git checkout -b ‚Äúfeature/add-ui-tests‚Äù</code> </pre> <br>  Open the project in Xcode and create a new Target with UI tests [Xcode -&gt; File -&gt; New -&gt; Target -&gt; iOS Testing Bundle], give it the talking name AmazingAppUITests. <br><br><img src="https://habrastorage.org/webt/lz/nv/wj/lznvwj2y7eup9jhvuo7tuuap0rk.png" alt="image"><br><br>  Go to the Build Phases section of the created Target and check for Target Dependencies - AmazingApp, in the Compile Sources - AmazingAppUITests.swift. <br><br>  A good practice is to highlight different build options into separate Schemes.  Create a schema for our UI tests [XCode -&gt; Product -&gt; Scheme -&gt; New Scheme] and give it the same name: AmazingAppUITests. <br><br>  Build the created schema should include Target of the main application - AmazingApp and Target UI tests - AmazingAppUITests - see screenshot <br><br><img src="https://habrastorage.org/webt/vm/iu/6y/vmiu6yivxbeeftzzpw6mtsjwmki.png" alt="image"><br><br>  Next, create a new build configuration for UI tests.  In XCode, click on the project file, go to the Info section.  Click on ‚Äú+‚Äù and create a new configuration, for example XCtest.  We will need this later in order to avoid dancing with a tambourine when it comes to code signing. <br><br><img src="https://habrastorage.org/webt/lv/at/h8/lvath8ca3apgpkkre6yo0lngxfm.png" alt="image"><br><br>  There are at least three Target in your project: the main application, unit tests (because they exist, aren‚Äôt they?) And the Target UI tests we created. <br><br>  Go to Target AmazingApp, Build Settings tab, section Code Signing Identity.  To configure XCtest, select iOS Developer.  In the Code Signing Style section, select Manual.  We have not yet generated the Provisioning profile, but we will definitely return to it later. <br><br>  For Target AmazingAppUITests we do the same, but in the column Product Bundle Identifier we enter com.company.amazingappuitests. <br><br><h2>  2. Setting up the project in the Apple Developer Program </h2><br>  Go to the Apple Developer Program page, go to the Certificates section, Identifiers &amp; Profiles and then in the App IDs column of the Identifiers item.  Create a new App ID named AmazingAppUITests and bundleID com.company.amazingappuitests. <br><br><img src="https://habrastorage.org/webt/-q/am/xp/-qamxpb7mzfaeko-yqesuahxsk4.png" alt="image"><br><br>  Now we have the opportunity to sign our tests with a separate certificate, but ... The build procedure for the build for testing involves building the application itself and building the test runner.  Accordingly, we are faced with the problem of signing two bundle IDs with one provisioning profile.  Fortunately, there is a simple and elegant solution - Wildcard App ID.  Repeat the procedure for creating a new App ID, but instead of Explicit App ID, select Wildcard App ID as in the screenshot. <br><br><img src="https://habrastorage.org/webt/hc/yo/uq/hcyouqxvbupjhehw9ywslmxrf-g.png" alt="image"><br><br>  At this stage, work with developer.apple.com is over, but we will not minimize the browser window.  We go to the <a href="https://docs.fastlane.tools/actions/match/">site with documentation on Fastlane</a> and read about the Match utility from cover to cover. <br><br>  The attentive reader noted that in order to use this utility we will need a private repository and an account that has access to both the Apple Developer Program and Github.  We create (if there is no such thing) an account of the type InfrastructureAccount@your.company.domain, create a powerful password, register it with developer.apple.com, assign it as the project administrator.  Next, give your account access to the github repository of your company and create a new private repository with a name like AmazingAppMatch. <br><br><h2>  3. Configure Fastlane and match utilities </h2><br>  Open the terminal, go to the folder with the project and initialize fastlane as indicated in the <a href="https://docs.fastlane.tools/">official manual</a> .  After entering the command <br><br><pre> <code class="bash hljs">$ fastlane init</code> </pre> <br>  you will be prompted to select available usage configurations.  Select the fourth item - manual configuration of the project. <br><br><img src="https://habrastorage.org/webt/p4/fx/ws/p4fxwszdhepxbhdhtw8zucmcwqy.png" alt="image"><br><br>  A new fastlane directory has appeared in the project, in which two files lie - Appfile and Fastfile.  In a nutshell - in Appfile we store service data, and in Fastfile we write jobs, in the terminology of Fastlane, called lanes.  I recommend reading the official documentation: <a href="https://docs.fastlane.tools/advanced/Fastfile/">one</a> , <a href="https://docs.fastlane.tools/advanced/Appfile/">two</a> . <br><br>  Open the Appfile in your favorite text editor and bring it to the following form: <br><br><pre> <code class="ruby hljs">app_identifier <span class="hljs-string"><span class="hljs-string">"com.company.amazingapp"</span></span> <span class="hljs-comment"><span class="hljs-comment"># Bundle ID apple_dev_portal_id "infrastructureaccount</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@your</span></span></span><span class="hljs-comment">.company.domain" #   ,     iOS   Apple Developer Program. team_id "LSDY3IFJAY9" # Your Developer Portal Team ID</span></span></code> </pre><br>  We return to the terminal and start setting up match according to the official manual. <br><br><pre> <code class="bash hljs">$ fastlane match init $ fastlane match development</code> </pre><br>  Next, enter the requested data - repository, account, password, etc. <br><br>  <b>Important:</b> when you first start the match utility will ask you to enter a password to decrypt the repository.  It is very important to keep this password, at the stage of setting up the CI server it will be useful to us! <br><br>  A new file has appeared in the fastlane folder - Matchfile.  Open in your favorite text editor and bring it to the form: <br><br><pre> <code class="ruby hljs">git_url(<span class="hljs-string"><span class="hljs-string">"https://github.com/YourCompany/AmazingAppMatch"</span></span>) <span class="hljs-comment"><span class="hljs-comment">#       . type("development") # The default type, can be: appstore, adhoc, enterprise or development app_identifier("com.company.amazingapp") username("infrastructureaccount</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@your</span></span></span><span class="hljs-comment">.company.domain") # Your Infrastructure account Apple Developer Portal username</span></span></code> </pre><br>  We fill it in this way if we want to use match in the future to sign builds for display in Crashlytics and / or the AppStore, that is, to sign the bundle ID of your application. <br><br>  But, as we remember, we created a special Wildcard ID to sign the test build.  Therefore, open the Fastfile and enter the new lane: <br><br><pre> <code class="ruby hljs">lane <span class="hljs-symbol"><span class="hljs-symbol">:testing_build_for_firebase</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match( <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">"development"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">readonly:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">app_identifier:</span></span> <span class="hljs-string"><span class="hljs-string">"com.company.*"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">git_branch:</span></span> <span class="hljs-string"><span class="hljs-string">"uitests"</span></span> <span class="hljs-comment"><span class="hljs-comment">#     development     . ) end</span></span></code> </pre><br>  We save, we enter into the terminal <br><br><pre> <code class="bash hljs">fastlane testing_build_for_firebase</code> </pre> <br>  and see how fastlane created a new certificate and put it in the repository.  Fine! <br><br>  Open Xcode.  Now we have the required provisioning profile of the Match Development com.company. * Type, which must be specified in the Provisioning profile section for AmazingApp and AmazingAppUITests. <br><br><img src="https://habrastorage.org/webt/l0/hq/dg/l0hqdgqi3w31ilkeo7emjo4n7ia.png" alt="image"><br><br>  It remains to add lane to build tests.  We go to the <a href="https://github.com/fastlane/fastlane-plugin-firebase_test_lab">repository</a> of the plugin project for fastlane, which facilitates the configuration of export to the Firebase Test Lab and follow the instructions. <br><br>  Copy-paste from the source example so that our lane testing_build_for_firebase looks like this: <br><br><pre> <code class="ruby hljs">lane <span class="hljs-symbol"><span class="hljs-symbol">:testing_build_for_firebase</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match( <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">"development"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">readonly:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">app_identifier:</span></span> <span class="hljs-string"><span class="hljs-string">"com.company.*"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">git_branch:</span></span> <span class="hljs-string"><span class="hljs-string">"uitests"</span></span> ) scan( <span class="hljs-symbol"><span class="hljs-symbol">scheme:</span></span> <span class="hljs-string"><span class="hljs-string">'AmazingAppUITests'</span></span>, <span class="hljs-comment"><span class="hljs-comment"># UI Test scheme clean: true, # Recommended: This would ensure the build would not include unnecessary files skip_detect_devices: true, # Required build_for_testing: true, # Required sdk: 'iphoneos', # Required should_zip_build_products: true, # Must be true to set the correct format for Firebase Test Lab ) firebase_test_lab_ios_xctest( gcp_project: 'AmazingAppUITests', # Your Google Cloud project name (    ) devices: [ # Device(s) to run tests on { ios_model_id: 'iphonex', # Device model ID, see gcloud command above ios_version_id: '12.0', # iOS version ID, see gcloud command above locale: 'en_US', # Optional: default to en_US if not set orientation: 'portrait' # Optional: default to portrait if not set } ] ) end</span></span></code> </pre><br>  For complete information on setting up fastlane in CircleCI, I recommend reading the official documentation <a href="https://docs.fastlane.tools/best-practices/continuous-integration/circle-ci/">once or</a> <a href="https://circleci.com/docs/2.0/testing-ios/">twice</a> . <br><br>  Do not forget to add our config.yml new task: <br><br><pre> <code class="ruby hljs">build-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-firebase-test-<span class="hljs-symbol"><span class="hljs-symbol">lab:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">macos:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">xcode:</span></span> <span class="hljs-string"><span class="hljs-string">"10.1.0"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">working_directory:</span></span> ~<span class="hljs-regexp"><span class="hljs-regexp">/project shell: /bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bash --login -o pipefail steps: - checkout - attach_workspace: at: ~/project</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">run:</span></span> sudo bundle install <span class="hljs-comment"><span class="hljs-comment">#   - run: name: install gcloud-sdk #  mac    gcloud command: | ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" &lt; /dev/null 2&gt; /dev/null ; brew install caskroom/cask/brew-cask 2&gt; /dev/null brew cask install google-cloud-sdk - run: name: build app for testing command: fastlane testing_build_for_firebase #  lane     firebase</span></span></code> </pre><br><h2>  4. What about our test bench?  Configure Firebase. </h2><br>  Let's proceed, in fact, to what the article was written for. <br><br>  Perhaps your application uses Firebase on a free tariff plan, perhaps it does not use it at all.  There is absolutely no fundamental difference, because for testing needs we can create a separate project with a year of free use (cool, right?) <br><br>  Login to our infrastructure account (or any other, without a difference), and go to <a href="https://console.firebase.google.com/">the Firebase console page</a> .  Create a new project named AmazingAppUITests. <br><br>  <b>Important:</b> In the previous step in the Fastfile in lane firebase_test_lab_ios_xctest, the gcp_project parameter must match the project name. <br><br><img src="https://habrastorage.org/webt/4g/2w/gg/4g2wggl51s6o5e44i9arfztz70s.png" alt="image"><br><br>  The default settings are fine with us. <br><br>  We do not close the tab, registering with <a href="https://console.cloud.google.com/">Gcloud</a> under the same account - this is a <a href="https://console.cloud.google.com/">necessary</a> measure, since communication with Firebase is performed using the gcloud console interface. <br><br>  Google gives $ 300 a year, which is equivalent to a year of free use of the service in the context of performing autotests.  Enter the payment data, wait for the test write-off of $ 1 and get $ 300 to the account.  After a year, the project will be automatically transferred to a free tariff plan, so it‚Äôs not worth worrying about losing money. <br><br>  Let's go back to the tab with the Firebase project and transfer it to the Blaze tariff plan - now we have something to pay if the limit is exceeded. <br><br>  In the gcloud interface, select our Firebase project, select the ‚ÄúCatalog‚Äù main menu item and add the Cloud Testing API and the Cloud Tools Result API. <br><br><img src="https://habrastorage.org/webt/ey/8x/7b/ey8x7bwmzkwdskvqiyoheco-icy.png" alt="image"><br><br>  Then go to the menu item "IAM and administration" -&gt; Service accounts -&gt; Create a service account.  We issue the rights to edit the project. <br><br><img src="https://habrastorage.org/webt/sw/2d/jg/sw2djgp6yn12gvsegbnpla2ki30.png" alt="image"><br><br>  Create API key in JSON format <br><br><img src="https://habrastorage.org/webt/-5/c4/mx/-5c4mx_pjsy0qbj770baix-qo8w.png" alt="image"><br><br>  We will need the downloaded JSON a bit later, but for now the Test Lab setup will be considered finished. <br><br><h2>  5. Setting CircleCI </h2><br>  A reasonable question is brewing - what to do with passwords?  Reliably save our passwords and other sensitive data will help us the mechanism of environment variables of our build machine.  In the CircleCI project settings, select Environment Variables. <br><br><img src="https://habrastorage.org/webt/nv/k8/tb/nvk8tbgrgycr_fnqdxxktcybgng.png" alt="image"><br>  And we get the following variables: <br><br><ul><li>  key: GOOGLE_APPLICATION_CREDENTIALS <br>  value: the contents of the json gcloud service account key file </li><li>  key: MATCH_PASSWORD <br>  value: password to decrypt github repository with certificates </li><li>  key: FASTLANE_PASSWORD <br>  value: Apple Developer Portal Infrastructure Account Password </li></ul><br>  Save the changes, create the PR and send it to the review of its team name. <br><br><h2>  Results </h2><br>  As a result, the implementation of these simple manipulations we got a good, stable working stand with the ability to record video on the device screen at the time of passing the test.  In the test case, I specified the iPhone X device model, but the farm provides a rich selection from a combination of different models and iOS versions. <br><br>  The second part will be devoted to the step-by-step configuration of the Firebase Test Lab for the Android project. </div><p>Source: <a href="https://habr.com/ru/post/451786/">https://habr.com/ru/post/451786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451778/index.html">Another monitoring system</a></li>
<li><a href="../45178/index.html">Illusion.net</a></li>
<li><a href="../451780/index.html">Audit in 60 minutes - free of charge, we check the resilience of employees to phishing attacks through Sophos Phish Threat</a></li>
<li><a href="../451782/index.html">Windows Subsystem for Linux (WSL) version 2: how will it be? (FAQ)</a></li>
<li><a href="../451784/index.html">Hybrid drives for Enterprise storage. Experience using Seagate EXOS</a></li>
<li><a href="../451790/index.html">Danger of in-game data collection</a></li>
<li><a href="../451792/index.html">Four JavaScript sniffer that lurk you in online stores</a></li>
<li><a href="../451794/index.html">Pixel padding in a texture scan</a></li>
<li><a href="../451796/index.html">Writing a secure browser extension</a></li>
<li><a href="../451798/index.html">Migrating data with mongoDB and Spring Boot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>