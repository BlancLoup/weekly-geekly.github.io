<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Loyalty cards. Google Pay API for Passes in ASP.NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bank card storage applications are rapidly entering our lives thanks to Apple Wallet and Google Pay. In addition to banking platforms, both platforms ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Loyalty cards. Google Pay API for Passes in ASP.NET</h1><div class="post__text post__text-html js-mediator-article"><p>  Bank card storage applications are rapidly entering our lives thanks to Apple Wallet and Google Pay.  In addition to banking platforms, both platforms also allow you to work with other types of cards - loyalty cards, gift cards, event tickets, boarding passes, etc. <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p>  Working in a company that services one rather big retail network, I had to integrate the loyalty cards of this network into Apple Wallet and Google Pay.  And if Apple Wallet had to tinker only because the integration layer was rather multifunctional, then with Google Pay most of the effort and nerve cells were spent on sorting out the documentation, finding the right tools and developing the first proof of concept.  Although overall the rest of the work went much faster than for the Apple Wallet, I spent the day trying to figure out how to start the service, so I wouldn't mind if someone wrote a similar article before me. <br><a name="habracut"></a><br></p><h2>  1. materiel </h2><br>  Loyalty cards are presented using two entities - Loyalty Class and Loyalty Object. <br><br><ul><li>  <i>Loyalty Class</i> is a kind of template for all loyalty cards.  It contains fields common to all cards, such as font color, links to asset icons, backgrounds, text fields, etc., a full description can be found here: <a href="https://developers.google.com/pay/passes/reference/v1/loyaltyclass">Loyaltyclass</a> <br></li><li>  <i>Loyalty Object</i> is an instance of LoyaltyClass.  It also contains data of a specific card of a specific client - card number, name, additional text fields.  Description here: <a href="https://developers.google.com/pay/passes/reference/v1/loyaltyobject">Loyaltyobject</a> <br></li></ul><br>  In order to receive a card, the user must follow the link format <br>  <i><a href="https://www.android.com/payapp/savetoandroidpay/">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> , where JWT is a token that holds JSON with LoyaltyClass data.  But since the length of the URL has limitations, it is recommended to first create the Loyalty Class, if its structure contains many characters. <br><br><p>  If you need to update the map due to changes in the template, styles, the need to add or change text fields, you can do this using the API.  It is only necessary to perform a POST request with the new version of the map, Google services themselves synchronize all the applications of users who have this map saved. <br></p><br><h2>  2. Tools and documentation </h2><br><p>  The problem was that all the examples in <a href="https://developers.google.com/pay/passes/guides/overview/basics/about-google-pay-api-for-passes">the Google Pay API for Passes documentation</a> were exclusively for Java, PHP, and Python, and the documentation itself strongly recommended ‚Äúusing client libraries to simplify the process‚Äù of working with the API. <br></p><br><p>  Following this advice, I happily went to nuget, but the library for Google Pay was not there.  Glory to Brin, the first line in google for the query google pay for passes dotnet produced the <a href="https://developers.google.com/pay/passes/support/libraries">Google Pay API for Passes utility libraries</a> page, which contained what I needed, though in the ZIP archive format in which the .net project from generated class, which is a wrapper for the Google Pay API - <a href="">Google Pay API for Passes Client library</a> . <br></p><br><p>  Judging by the presence of the <i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i> file in the project, the deployment of the nuget package was still included in the plans of the Google team.  Having opened this file in search of documentation, I did not find anything concrete, and some links that were in the description section were sent to non-existent pages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><h2>  3. Getting access token </h2><br><p>  To start working directly with Google Pay API for Passes, you need to get access token, for this you need: <br><br></p><ol><li>  Have a Google Merchant Account, which you can get <a href="https://support.google.com/pay/merchants/contact/instore_merchant_interest">here</a> <br></li><li>  Create a Service Account, get for it a file with credentials - json document with service account details, including ID, email, private key, etc.  As recommended by the documentation, you need to store this file in a protected place. <br></li><li>  Link Merchant Account and Service Account in Google Merchant Center <br></li></ol><br>  Using this file, you can log in using the <i>Google.Apis.Auth.OAuth2</i> library: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4. Creating a map </h2><br><p>  In order to create a loyalty card, you must first create a Loyalty Class.  Loyalty Class can be created using the API, or using the Google Merchant Center web interface.  Attention should be paid to the class name, as this name must be unique in the Google Pay infrastructure. <br><br>  After creating the Loyalty Class, you can create a Loyalty Object.  To do this, we will need the library that we added to the project earlier: create the request object, specify the OAuth token, transfer the created LoyaltyObject object, execute the request: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br>  <i>The GooglePayPassTemplate</i> in this example is the DTO, which stores the card template for the user, which is generated by a separate developed service. <br><br><h2>  5. Map update </h2><br><p>  Here the principle is the same as at creation: we generate a request, we transfer the updated LoyaltyObject object, we execute: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p>  After completing the request, the card in the applications of users who have it installed will be updated after a few seconds if the device is on the network and there is an Internet connection. </p><br><br><h2>  6. Generate JWT </h2><br><p>  To install the card, you need to redirect the user to the link <a href="https://www.android.com/payapp/savetoandroidpay">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b> .  Description of the token structure can be found at <a href="https://developers.google.com/pay/passes/reference/s2w-reference">this link</a> . <br></p><br><p>  The token is signed with the RSA-SHA256 signature, which can be generated using the same file with the Service Account credentials: <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2>  Conclusion </h2><br><p>  In this article, we walked through the basics of working with the Google Pay API for Passes: setting up accounts, connecting to an API, creating a Loyalty Class and Loyalty Object. <br><br>  If the UFO favors, I‚Äôll tell you separately about how to work with Apple Wallet (everything is more difficult in terms of implementation), how to make friends with Apple Wallet with Google Pay in one web service and not experience pain. <br></p><br><p></p><h3>  useful links </h3><br><ul><li>  <a href="https://support.google.com/pay/merchants/contact/instore_merchant_interest">Merchant Account Registration</a> <br></li><li>  <a href="https://developers.google.com/pay/passes/guides/overview/basics/about-google-pay-api-for-passes">Google Pay API for Passes documentation</a> <br></li><li>  <a href="https://developers.google.com/pay/passes/support/libraries">Client libraries for working with Google Pay API for Passes</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/434486/">https://habr.com/ru/post/434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434474/index.html">Green cat about space content</a></li>
<li><a href="../434476/index.html">ChatOps in GitLab will be available to everyone</a></li>
<li><a href="../434478/index.html">Faceless code will kill programming, and we won't do anything about it.</a></li>
<li><a href="../434480/index.html">New year, gadgets, fire</a></li>
<li><a href="../434482/index.html">Another year of our blog: the results of 2018</a></li>
<li><a href="../434490/index.html">How we cut the speakerphone with waterjet cutting</a></li>
<li><a href="../434492/index.html">Russia remained in the top ten countries with the cheapest mobile traffic</a></li>
<li><a href="../434494/index.html">What to read. List of Russian-language fiction for 2017 and 2018</a></li>
<li><a href="../434496/index.html">Two-phase commit and the future of distributed systems</a></li>
<li><a href="../434498/index.html">MVP and Dagger 2 - Skeleton Android Application - Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>