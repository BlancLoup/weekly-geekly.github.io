<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developer Cookbook: DDD Recipes (Part 3, Application Architecture)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 In previous articles, we highlighted the scope of the approach and examined the main methodological principles of Domain Driven Desig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developer Cookbook: DDD Recipes (Part 3, Application Architecture)</h1><div class="post__text post__text-html js-mediator-article"><h1 id="vvedenie">  Introduction </h1><br><p>  In previous articles, we highlighted the <a href="https://habr.com/post/426663/">scope of the</a> approach and examined the <a href="https://habr.com/post/428209/">main methodological principles of Domain Driven Design</a> . </p><br><p>  In this article, I would like to identify the main modern approaches to building an enterprise system architecture: Supple, Screaming, Clean and give them their clear interpretation in the form of a complete ready-made solution. </p><br><p><img src="https://habrastorage.org/webt/jw/jt/mr/jwjtmrixh99-s5hje6sn32l-0s4.jpeg" alt="WM"></p><br><p>  In the following, we will look at each design pattern in detail: let‚Äôs define the scope, provide code examples, and highlight recommended practices.  As a result, we will write a ready microservice. </p><a name="habracut"></a><br><h1 id="gibkaya-arhitektura">  Flexible architecture </h1><br><p>  In the <a href="https://habr.com/post/428209/">last article,</a> we dwelt on the fact that DDD includes the practice of implementation through the model.  The subject area should be described through your code.  Let's try to figure out how to do this. </p><br><p>  In his book, Eric Evans presents a number of design patterns recommended for use, and designates this approach as flexible: </p><br><blockquote>  In the name of architecture flexibility, many unnecessary constructs were piled up in programs.  Extra levels of abstraction and indirect references are more likely to interfere than help in this matter.  Look at the architecture that really inspires programmers involved in its refinement, and you will see, as a rule, something very simple.  But simple does not mean easy to perform.  To create such elements that can be assembled into complex systems and it is not difficult to understand, it is necessary to combine ‚Äúdevotion‚Äù to design according to a model with a rather strict architecture style.  A certain design skill is needed not only to create something, but even to use ready-made. <br><br>  Eric Evans, Domain-Driven Design: Tackling Complexity of the Heart of Software </blockquote><p>  The presented set of design patterns is not a strict architecture or a ready-made solution, but rather food for thought. </p><br><h1 id="krichaschaya-arhitektura">  Screaming architecture </h1><br><p>  Similar thoughts occurred in the minds of many developers and designers of complex systems. </p><br><p>  In 2011, there was an article by Robert Martin - <a href="https://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html">Screaming Architecture</a> , which says that your code should not just describe the subject area, but yell about it, preferably with a checkmate. </p><br><blockquote>  So what is your application scream?  The structure of the package;  do they scream: Health Care System, or Accounting System, or Inventory Management System?  Or do they scream: Rails, or Spring / Hibernate, or ASP? <br><br>  Robert C. Martin, September 30, 2011 </blockquote><p>  Robert says that the code of your application should reflect the activity of the application, instead of adjusting to the rules of the framework.  The framework structure should not limit your architecture.  The application, in turn, should not be tied to the database or http protocol, these are just storage and delivery mechanisms.  The bounding box is a tool.  You should not become an adept frame maker.  Tests of your application are tests of the logic of its operation, and not testing of the http protocol. </p><br><h1 id="chistaya-arhitektura">  Pure architecture </h1><br><p>  A year later, Robert Martin‚Äôs next article, <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a> .  In it, the author tells how to make the code scream.  Having studied several architectures, he outlines the basic principles: </p><br><ol><li>  Independence from the framework.  The architecture does not depend on any existing library.  This allows frameworks to be used as tools, not as constraints binding your hands. </li><li>  Testability  Business rules can be tested without a user interface, database, web server, or any other technical means. </li><li>  Independence from user interface.  The user interface can be easily changed without changing the rest of the system.  For example, you can replace the web interface with a console interface without changing the business logic. </li><li>  Independence from the database.  You can exchange Oracle or SQL Server for Mongo, BigTable, CouchDB or something else.  The logic of your application should not be tied to the database. </li><li>  Independence from the impact of the environment.  In fact, your business rules simply do not know anything about the outside world. </li></ol><br><p>  On Habr√© already published a very good article <a href="https://habr.com/company/mobileup/blog/335382/">Misconceptions Clean Architecture</a> .  Its author, <a href="https://habr.com/users/jeevuz/" class="user_link">Jeevuz</a> , <a href="https://habr.com/users/jeevuz/" class="user_link">chewed</a> very well the subtleties of understanding this approach.  I strongly recommend to get acquainted with it as well as with original materials. </p><br><h1 id="variativnaya-arhitektura">  Variable architecture </h1><br><p>  The description of the above approach does not look so unambiguous.  As part of the development of the architecture of a number of complex corporate systems, I and my colleagues developed a rather clear interpretation of the described approaches, which I am going to present below. </p><br><p>  Before the advent of computers and programming languages, paper workflow was used to build and manage systems with complex business logic.  The result of any process was a document that ultimately described a particular business object.  As a result, clerical work was reduced to three simple <em>actions</em> : </p><br><ol><li>  Document creation </li><li>  Document processing </li><li>  Work with the archive of documents </li><li>  Document presentation </li></ol><br><blockquote>  Document - recording information about the economic activity of a particular real business object. </blockquote><p>  Please note that the document itself is not a real business object, but only its <em>Model</em> .  At the moment, paper documents are being superseded by electronic ones.  A document can be a record in a table, a picture, a file, a sent letter, or any other piece of information. <br>  I would not like to use the word document in the future, since it will be more confusing, we will use the concept Entity from DDD terminology.  But you can imagine that now your entire system is an electronic document management system that performs four simple <em>Actions</em> . </p><br><ol><li>  Collecting </li><li>  Processing </li><li>  Storage </li><li>  Representation </li></ol><br><blockquote>  Action (Action) - the structural unit of the business model;  a relatively completed separate act of a perceived goal, arbitrariness and premeditation of the individual activity of a business object, distinguished by the end user. </blockquote><p>  A good example of <em>Dacevtia</em> is theatrical act.  Theater simulates events from real life.  The act is a meaningful part of the play.  But in order to make the story complete, you need to lose several acts in a strictly defined order.  Such an order in our architecture we will call <em>Mode</em> . </p><br><blockquote>  Mode (Conduction) - a set of <em>Actions</em> in a certain order, which has a complete meaning, bringing benefit to the end user. </blockquote><p><img src="https://habrastorage.org/webt/yp/i7/2z/ypi72zofhbqjsziq17lyis6odiw.png" alt="conduction"></p><br><p>  For these <em>Modes of</em> operation, a selective jig or Selector was invented.  More specifically, the " <a href="https://patents.google.com/patent/US2870278A/en">US2870278A</a> patent was obtained for the plurality of sequences of operations".  We know this device as a "twist" of a washing machine.  Architectural "twist" is given at the beginning of the article. </p><br><p>  The variability of the approach is manifested in the fact that with such an architecture you can choose any of the four <em>Modes</em> , passing which you will not perform unnecessary <em>Actions</em> . </p><br><p>  Starting the washing machine, you can select the mode: wash, rinse or spin.  If you choose to wash, then your machine will still rinse the laundry, and then it will wring out.  With rinsing included, you are sure to get a spin.  Spin - the final <em>action</em> in the process of washing it is the most "simple."  In our architecture, the simplest <em>Activity</em> - <em>Representation</em> , and begin with it. </p><br><h2 id="predstavlenie-representation">  Representation </h2><br><p>  If we talk about a pure representation without accessing the database or an external source, then we give out some static information: html-page, file, directory lying in the form of json'a.  We can even issue just a <em>Code response</em> - 200: </p><br><p>  Let's write the simplest "Health checker" </p><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Health</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Endpoints</span></span></span><span class="hljs-class"> &lt; Sinatra::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  In the most primitive form, our scheme will look like this: </p><br><p><img src="https://habrastorage.org/webt/-g/b4/ah/-gb4ahfzxvwn1zhxfrrqmoagzcm.png" alt="Representation"></p><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text"><p>  I ask you to note that in the Sinatra framework, the <em>Endpoints</em> class combines both <em>Router</em> and <em>Controller</em> in one class.  Does this not violate the principle of sole responsibility?  In fact, Endpoints is not a class, but a layer expressed through a class, and its area of ‚Äã‚Äãresponsibility is at a higher level. </p><br><p>  Ok, what about <em>Router</em> and <em>Controller</em> ?  They are not represented by a set of classes, but by the name and implementation of a function.  A static file is generally a file.  One class answers one responsibility, but don‚Äôt try to express every responsibility through a class.  Proceed from practicality, not from dogmatism. </p></div></div><br><h2 id="rabota-s-sistemoy-hraneniya-storage">  Work with the storage system (Storage) </h2><br><p>  Business is demanding on the availability of your application.  Why would someone need your service if we cannot use it at the right moment?  To ensure data integrity, we record a change in the state of a business object after each processing. </p><br><p>  To retrieve an object from the repository, no business logic is required.  Imagine that we are automating the activities of a hotel chain and we have a magazine of guests at the front desk.  We decided to look at the information about the visitor. </p><br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reception</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Endpoints</span></span></span><span class="hljs-class"> &lt; Sinatra::Base </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># Show item get '/residents/:id', provides: :json do resident = Repository::Residents.find params[:id] status 200 serialize(resident) end end end</span></span></span></span></code> </pre> <br><p>  <em>Working with the storage system</em> in the form of a graphic scheme: </p><br><p><img src="https://habrastorage.org/webt/dt/1c/ek/dt1cektbpcmlrvz76utwko6tbk4.png" alt="Storage"></p><br><p>  As we can see, the communication between the level responsible for <em>storage</em> and the level responsible for data presentation is implemented through the Response model.  This model does not belong to any of these layers.  In fact, this is a business object and it is located on the layer responsible for the business logic. </p><br><h2 id="obrabotka-processing">  Processing </h2><br><p>  If it comes to the fact that the object model changes based on its properties without adding new data, then we can directly access the <em>Interactor</em> layer.  The <em>Interactor</em> layer is the key in our application, it describes the entire business logic in the form of separate Use Cases, and it is here that the <em>Entities</em> are modified. </p><br><p>  Consider this use case.  In our hotel, the visitor is already registered, but we celebrate every visit or departure. </p><br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reception</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Endpoints</span></span></span><span class="hljs-class"> &lt; Sinatra::Base </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># Register resident arrival post '/residents/:uid/arrival', provides: :json do result = Interactors::Arrival.call(resident_id: params[:id]) check!(result) do status 201 serialize result.data end end # Register resident departure post '/residents/:uid/departure', provides: :json do result = Interactors::Departure.call(resident_id: params[:id]) check!(result) do status 201 serialize result.data end end end end</span></span></span></span></code> </pre> <br><p>  Let's stop a little.  Why not to do implementation by one method with <code>status</code> parameter?  <em>Interactors</em> <code>Arrival</code> and <code>Departure</code> are completely different.  If a guest has come to us, then we need to check whether the cleaning has ended, whether there have been any new messages for him, etc.  When he leaves, we, on the contrary, must initiate a cleaning if necessary.  In turn, we don‚Äôt even remember the messages, because if he were in a hotel, we would call him right away.  It is all this business logic that we prescribe on the <em>Interactor</em> layer. </p><br><p><img src="https://habrastorage.org/webt/of/hk/al/ofhkalijd4o2u3xrwtptgtzjko0.png" alt="Processing"></p><br><p>  But what should we do if we have data from the outside?  This is <em>where the Data Collect</em> action connects. </p><br><h3 id="sbor-dannyh-collecting">  Collecting data </h3><br><p>  During the first registration of a guest at a hotel, he fills out a registration form.  This form is verified.  If the data is correct, then a business process is registered.  The process returns data ‚Äî the created ‚ÄúResident‚Äù business model.  We present this model to the guest in a readable form: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reception</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Endpoints</span></span></span><span class="hljs-class"> &lt; Sinatra::Base </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># Register new resident post '/residents', provides: [:json] do form = Forms::Registration.new(params) complete! form do check! form.result do status 201 serialize form.result.data end end end end end</span></span></span></span></code> </pre> <br><p>  Schematically it looks like this: </p><br><p><img src="https://habrastorage.org/webt/fy/ci/dv/fycidvf5npkklovkk6quaatn3oi.png" alt="Collecting"></p><br><h1 id="pravila-igry-rules">  Rules of the game (Rules) </h1><br><ul><li>  Variable system in terms of processes is divided into <em>Actions</em> . </li><li>  The sequence of <em>Actions</em> is determined by the <em>Mode</em> . </li><li>  <em>Modes are</em> incremental. </li><li>  The more "complex" <em>mode</em> complements the more "simple" one for strictly one action. </li><li>  Each action takes place within the framework of one <em>Layer</em> . </li><li>  Each layer is represented by a <em>Class</em> . </li><li>  Inside a layer there can be <em>Classes-Layers</em> and <em>Classes-Responsibilities</em> . </li><li>  Communication takes place only between the <em>Layer</em> and the <em>Inner Layer Class</em> . </li><li>  <em>View Models</em> are exceptions. </li><li>  Error handling should occur at the <em>Class-Layer level</em> . </li></ul><br><p><img src="https://habrastorage.org/webt/mb/hz/xk/mbhzxk9rdmqlijg-xsmissqeu1w.png" alt="Tree"></p><br><h1 id="obschaya-shema">  General scheme </h1><br><p>  This approach has a high threshold of entry.  Its application requires a great experience from the designer for a clear understanding of the tasks to be solved.  Difficulty is also a variety of choice of the necessary tool.  But, despite the complexity of the structure, implementation at the code level is incredibly simple and expressive.  Although it contains a number of conventions and powers of attorney.  In the future, we analyze each design pattern separately, describe how to create it, test it, and designate the scope.  And in order not to get confused in their diversity, the full map is offered: <br><img src="https://habrastorage.org/webt/ln/co/g5/lncog5svcpzab3kc0su-q59aafu.png"></p><br><p>  <a href="">High Resolution Map</a> </p><br><hr><br><div class="spoiler">  <b class="spoiler_title">sources of inspiration</b> <div class="spoiler_text"><ul><li>  Problem-Oriented Design, Eric J. Evans </li><li>  Kate Matsudeira: Scalable Web Architecture and Distributed Systems </li><li>  <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html</a> </li><li>  <a href="https://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html">https://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html</a> </li><li>  <a href="https://habr.com/company/mobileup/blog/335382/">https://habr.com/company/mobileup/blog/335382/</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/429750/">https://habr.com/ru/post/429750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429732/index.html">You Gonna Hate This, or a Tale of How a Good Code Should Look</a></li>
<li><a href="../429734/index.html">Dream to fly with electrotechnical bias</a></li>
<li><a href="../429736/index.html">Hogweed Sosnowski. In MO introduced fines for distribution</a></li>
<li><a href="../429738/index.html">The optimal location of shards in a petabyte cluster Elasticsearch: linear programming</a></li>
<li><a href="../429744/index.html">Learn OpenGL. Lesson 6.4 - IBL. Mirror irradiance</a></li>
<li><a href="../429754/index.html">Fatal errors in hardware integration</a></li>
<li><a href="../429756/index.html">How to configure the setting of Nuxt.js environment variables in runtime, or How to do everything differently and do not regret</a></li>
<li><a href="../429758/index.html">Why SRE is important documentation. Part 1</a></li>
<li><a href="../429760/index.html">How to change your life by starting the development of the OpenSource project</a></li>
<li><a href="../429762/index.html">Streamer from MiniDV-camcorder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>