<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I wrote my chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 
 In the article I wrote about how I designed the chat. About its architecture and technical decisions taken during its development. 

 Chat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I wrote my chat</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br>  In the article I wrote about how I designed the chat.  About its architecture and technical decisions taken during its development. <br><br>  Chat is a client-server application with p2p elements. <br>  With support: <br><ul><li>  Private messages </li><li>  Rooms </li><li>  File transfer </li><li>  Voice chat. </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/767/f07/95a/767f0795a486d76147e5fc9e4ddca1bb.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Project Source Code: <a href="https://github.com/Nirklav/TCPChat">GitHub</a> <br><a name="habracut"></a><br>  So rushed. <br><br><hr><br><h4>  Model </h4><br><ol><li><h6>  Data and their synchronization. </h6></li><li><h6>  API. </h6></li><li><h6>  Record and play sound. </h6></li></ol><br><br><h5>  Data and their synchronization. </h5><br>  At the beginning when I wrote the first version, I immediately wrote an asynchronous version of the client and server.  But, for some reason, I completely forgot about the need to synchronize data.  And so, as the chat never experienced a serious load, I realized this only after introducing file transfer to the chat.  After that, everything was immediately remembered and a bunch of lockers were inserted everywhere.  What, of course, was not the best solution.  To be precise, it was just a little better than a program without synchronization. <br><br>  Now, on the client and on the server, a single data access mechanism is used.  The model is blocked completely.  I must say that this is not the best solution for the server. <br><br>  The idea is quite simple: there is a context that contains a model in a private static field.  In the constructor, it calls Monitor.Enter.  On the model itself, or on a separate synchronization object.  The context also implements the IDisposable interface and in the Dispose method it releases this model by calling the Monitor.Exit method. <br><br>  A generic class used for both server and client.  In the example, the model is not contained in the context itself, but in the class that creates it. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModelContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TModel</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> consts private const int TimeOut = 10000; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> fields private static object syncObject = new object(); protected TModel model; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> initialization protected ModelContext(TModel initialModel) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!Monitor.TryEnter(syncObject, TimeOut)) throw new InvalidOperationException("model lock timeout"); model = initialModel; } public void Dispose() { model = default(TModel); Monitor.Exit(syncObject); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> } }</span></span></code> </pre> <br></div></div><br><br>  As a result, if you want to access data, you do not want to block them, and you no longer think about synchronization.  The main thing to remember is to use the using construct.  For the server, this is not the best solution.  half of the teams work with the maximum of two users, and as a result, all are blocked. <br><br>  The context in the program can create only one entity (ServerModel - (unexpectedly) for the server, and ClientModel - for the client).  It is a class containing a static private model (itself), an API as well as a client connection and a peer - for a client model or a server for a server one.  (API, client, etc. are contained as static fields).  Also, the client model, in contrast to the server model, also contains events.  On which the user interface will be signed.  In general, these classes act as basic to access anything. <br>  As an example, I will give the server model (it is smaller).  Pay attention to the Get () method that creates the context. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerModel</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> static model private static ServerModel model; /// &lt;summary&gt; ///  API /// &lt;/summary&gt; public static IServerAPI API { get; private set; } /// &lt;summary&gt; ///  /// &lt;/summary&gt; public static AsyncServer Server { get; private set; } /// &lt;summary&gt; ///     using /// &lt;/summary&gt; /// &lt;example&gt;using (var server = SeeverModel.Get()) { ... }&lt;/example&gt; /// &lt;returns&gt;   .&lt;/returns&gt; public static ServerContext Get() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Interlocked.CompareExchange(ref model, null, null) == null) throw new ArgumentException("model do not inited yet"); return new ServerContext(model); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> consts public const string MainRoomName = "Main room"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> properties public Dictionary&lt;string, Room&gt; Rooms { get; private set; } public Dictionary&lt;string, User&gt; Users { get; private set; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> constructor public ServerModel() { Users = new Dictionary&lt;string, User&gt;(); Rooms = new Dictionary&lt;string, Room&gt;(); Rooms.Add(MainRoomName, new Room(null, MainRoomName)); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> static methods public static bool IsInited { get { return Interlocked.CompareExchange(ref model, null, null) != null; } } public static void Init(IServerAPI api) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Interlocked.CompareExchange(ref model, new ServerModel(), null) != null) throw new InvalidOperationException("model already inited"); Server = new AsyncServer("ServerErrors.log"); API = api; } public static void Reset() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Interlocked.Exchange(ref model, null) == null) throw new InvalidOperationException("model not yet inited"); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Server != null) { Server.Dispose(); Server = null; } API = null; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br></div></div><br><br><h5>  API </h5><br>  The API in this case is the chat logic.  It is a class that stores in itself commands that can be executed on our side, and a set of methods that send commands to the other side (to the Client, if we consider ourselves from the server side. For a client, this is a server or another feast).  The methods contain the most complex commands, or simply frequently used. <br><br>  The whole system works as follows: as soon as a client or server receives a data packet, it passes it to the API for analysis.  (The server accepts messages from its connection, and they, in turn, pull one method from the server, indicating that the data has been received).  The API simply reads the first two bytes of the message and looks for a command in the dictionary with the desired id, and returns it.  Or an empty command that does nothing if there is no such id.  Next, the received packet is transmitted to the command, and the id of the connection that sent it, and it is executed. <br><br>  API also has its own interface, it was not originally there.  Appeared after I decided to write another implementation of it, it was assumed that this would be a protected API.  But then I just became not interested, and I did not abandon the project for a long time.  Two months.  After returning to it, I no longer wanted to do all this, and I started implementing P2P. <br><br>  The client, by the way, knows how to choose the API that the server uses, and if there is no one, it disconnects from the server and says that it does not support the server API.  This is implemented quite simply - after the server accepts the connection, it immediately sends a string with the name of its API, and the client actually expects this string and sets the necessary interface.  Well, or does not install if this does not support.  After this action, there is already a request for registering a user on the server. <br><br>  Server method that processes received packets: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataReceivedEventArgs</span></span> : <span class="hljs-title"><span class="hljs-title">EventArgs</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] ReceivedData { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Error { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IServerAPICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServerCommandArgs args</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerCommandArgs</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataReceivedCallBack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, DataReceivedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Error != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e.Error; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isServerRunning) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; IServerAPICommand command = ServerModel.API.GetCommand(e.ReceivedData); ServerCommandArgs args = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServerCommandArgs { Message = e.ReceivedData, ConnectionId = ((ServerConnection)sender).Id, }; command.Run(args); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exc) { ServerModel.Logger.Write(exc); } }</code> </pre><br></div></div><br><br>  The full code of the API class (in this case, the server class): <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     API. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class StandardServerAPI : IServerAPI { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     API. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public const string API = "StandartAPI v2.0"; private Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ushort, IServerAPICommand&gt;</span></span></span><span class="hljs-comment"> commandDictionary = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ushort, IServerAPICommand&gt;</span></span></span><span class="hljs-comment">(); </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   API. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="host"&gt;</span></span></span><span class="hljs-comment">     API.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public StandardServerAPI() { commandDictionary.Add(ServerRegisterCommand.Id, new ServerRegisterCommand()); commandDictionary.Add(ServerUnregisterCommand.Id, new ServerUnregisterCommand()); commandDictionary.Add(ServerSendRoomMessageCommand.Id, new ServerSendRoomMessageCommand()); commandDictionary.Add(ServerSendPrivateMessageCommand.Id, new ServerSendPrivateMessageCommand()); commandDictionary.Add(ServerGetUserOpenKeyCommand.Id, new ServerGetUserOpenKeyCommand()); commandDictionary.Add(ServerCreateRoomCommand.Id, new ServerCreateRoomCommand()); commandDictionary.Add(ServerDeleteRoomCommand.Id, new ServerDeleteRoomCommand()); commandDictionary.Add(ServerInviteUsersCommand.Id, new ServerInviteUsersCommand()); commandDictionary.Add(ServerKickUsersCommand.Id, new ServerKickUsersCommand()); commandDictionary.Add(ServerExitFormRoomCommand.Id, new ServerExitFormRoomCommand()); commandDictionary.Add(ServerRefreshRoomCommand.Id, new ServerRefreshRoomCommand()); commandDictionary.Add(ServerSetRoomAdminCommand.Id, new ServerSetRoomAdminCommand()); commandDictionary.Add(ServerAddFileToRoomCommand.Id, new ServerAddFileToRoomCommand()); commandDictionary.Add(ServerRemoveFileFormRoomCommand.Id, new ServerRemoveFileFormRoomCommand()); commandDictionary.Add(ServerP2PConnectRequestCommand.Id, new ServerP2PConnectRequestCommand()); commandDictionary.Add(ServerP2PReadyAcceptCommand.Id, new ServerP2PReadyAcceptCommand()); commandDictionary.Add(ServerPingRequestCommand.Id, new ServerPingRequestCommand()); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     API. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public string Name { get { return API; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-comment"> ,        .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public IServerAPICommand GetCommand(byte[] message) { ushort id = BitConverter.ToUInt16(message, 0); IServerAPICommand command; if (commandDictionary.TryGetValue(id, out command)) return command; return ServerEmptyCommand.Empty; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="container"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void IntroduceConnections(string senderId, IPEndPoint senderPoint, string requestId, IPEndPoint requestPoint) { using (var context = ServerModel.Get()) { var content = new ClientWaitPeerConnectionCommand.MessageContent { RequestPoint = requestPoint, SenderPoint = senderPoint, RemoteInfo = context.Users[senderId], }; ServerModel.Server.SendMessage(requestId, ClientWaitPeerConnectionCommand.Id, content); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="nick"&gt;</span></span></span><span class="hljs-comment">  .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-comment">.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void SendSystemMessage(string nick, string message) { var sendingContent = new ClientOutSystemMessageCommand.MessageContent { Message = message }; ServerModel.Server.SendMessage(nick, ClientOutSystemMessageCommand.Id, sendingContent); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="nick"&gt;</span></span></span><span class="hljs-comment"> ,    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void CloseConnection(string nick) { ServerModel.Server.CloseConnection(nick); using (var server = ServerModel.Get()) { foreach (string roomName in server.Rooms.Keys) { Room room = server.Rooms[roomName]; if (!room.Users.Contains(nick)) continue; room.Remove(nick); server.Users.Remove(nick); var sendingContent = new ClientRoomRefreshedCommand.MessageContent { Room = room, Users = room.Users.Select(n =&gt; server.Users[n]).ToList() }; foreach (string user in room.Users) { if (user == null) continue; ServerModel.Server.SendMessage(user, ClientRoomRefreshedCommand.Id, sendingContent); } } } } }</span></span></code> </pre><br></div></div><br><br>  Each team implements the command interface.  For the IServerAPICommand server, for the IClientAPICommand client, at this stage they could be reduced to 1 interface, but I don‚Äôt want to do this for some reason.  It also contains its Id and data necessary for its execution, which is described by the MessageContent class.  However, the team may not need data.  And she herself is responsible for deserializing the set of bytes into an instance of the class. <br><br>  Sample command.  In this case, this is the command to add a file to the room: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IServerAPICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServerCommandArgs args</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerCommandArgs</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BaseCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T GetContentFormMessage&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] message) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (MemoryStream messageStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(message)) { messageStream.Position = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>); BinaryFormatter formatter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryFormatter(); T receivedContent = (T)formatter.Deserialize(messageStream); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receivedContent; } } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerAddFileToRoomCommand</span></span> : <span class="hljs-title"><span class="hljs-title">BaseServerCommand</span></span>, <span class="hljs-title"><span class="hljs-title">IServerAPICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServerCommandArgs args</span></span></span><span class="hljs-function">)</span></span> { MessageContent receivedContent = GetContentFormMessage&lt;MessageContent&gt;(args.Message); <span class="hljs-comment"><span class="hljs-comment">// . if (receivedContent.File == null) throw new ArgumentNullException("File"); if (string.IsNullOrEmpty(receivedContent.RoomName)) throw new ArgumentException("RoomName"); if (!RoomExists(receivedContent.RoomName, args.ConnectionId)) return; using (var context = ServerModel.Get()) //   ,    { Room room = context.Rooms[receivedContent.RoomName]; if (!room.Users.Contains(args.ConnectionId)) { ServerModel.API.SendSystemMessage(args.ConnectionId, "      ."); return; } if (room.Files.FirstOrDefault(file =&gt; file.Equals(receivedContent.File)) == null) room.Files.Add(receivedContent.File); var sendingContent = new ClientFilePostedCommand.MessageContent { File = receivedContent.File, RoomName = receivedContent.RoomName }; //      //           ,     foreach (string user in room.Users) ServerModel.Server.SendMessage(user, ClientFilePostedCommand.Id, sendingContent); } } [Serializable] public class MessageContent { string roomName; FileDescription file; public string RoomName { get { return roomName; } set { roomName = value; } } public FileDescription File { get { return file; } set { file = value; } } } public const ushort Id = (ushort)ServerCommand.AddFileToRoom; }</span></span></code> </pre><br></div></div><br><br><h5>  Record and play sound. </h5><br>  I recently started adding voice chat, maybe at the time of publishing it will still be in the demo version.  But already managed to tinker with playback and recording sound. <br><br>  The first option was the WinApi waveIn * waveOut * function.  It was the easiest option, so I started with it.  But it did not happen to them, because  on the version of framework 3.5, the marshaling on the x64 platform inadequately worked, and when it started up, the application simply fell without any exceptions.  When assembling under x86, everything was fine. <br><br>  Next was an attempt to connect DirectSound, but he had found his bug with a way to notify about the completion of playing a piece of data.  After googling this topic, it turned out that Mircosoft abandoned DirectSound long ago and are working with XAudio2.  Moreover, its use would lead to the need to compile 2 versions of x86 and x64. <br><br>  Since I didn‚Äôt want to write a wrapper for XAudio2 myself, I remembered OpenAL.  For which, in addition, there is a wrapper (OpenTK), also with open source.  From OpenTK, only the audio library itself was neatly cut out.  Which now works in the program. <br><br>  Since I had to work with OpenGL ES 2, I became friends immediately with OpenAL.  Especially if we consider that there are examples on it on the official OpenTK website. <br><br>  To write data, I use a fairly simple scheme from the example.  When you start recording, a timer is started, the response period of which is adjusted for the time over which the buffer should be filled to half.  After that, the data from it is read and sent by the ClientPlayVoiceCommand team to everyone who can listen to us. <br><br>  The code can be viewed in the <a href="https://github.com/Nirklav/TCPChat/tree/master/Engine/Audio/OpenAL">TCPChat \ Engine \ Audio \ OpenAL</a> branch. <br><br><hr><br><br><h4>  Network </h4><br>  Initially, the chat was one main room where all users were located.  Of the data transfer protocols, only TCP was used.  So - as it already provides the reliability of data transmission, it only remained to break its continuous stream into messages. <br><br>  This was done by simply adding the size of the message to its beginning. <br>  That is, the package is the following: <br>  The first 4 bytes are the size of the message. <br>  5-6 bytes - the command identifier. <br>  The remaining data is serialized by MessageContent. <br><br>  Further, in one forum I was offered to introduce file transfer and voice communication.  I coped with the files almost immediately, although in the first version the files were transmitted through the server, which was generally terrible.  After that, I thought about the fact that it would be good to transfer them to the line.  As you know with the NAT problem, this is not so easy to do. <br><br>  I was busy for a long time and tried to implement a NAT traversal using TCP, then I wouldn‚Äôt have to be soared about the unreliability of UDP.  With him, nothing happened.  After that, it was decided to use UDP and UDP hole punching technology. <br><br>  But first we had to solve the problems of reliability.  As usual, I started working on my protocol over UDP to ensure reliable message delivery to me.  And I did it all the same, but it worked only locally.  When testing it in real conditions, he apparently loaded the network so much that my computer completely hung up. <br><br>  After that, I began to look for already implemented libraries and came across satyu on Habr√©, where a similar problem was solved with the help of Lidgren.Network.  She was chosen. <br><br>  NAT traversal is implemented at the API level.  The scheme is simple, you just need the peers to find out the real addresses at which the server sees them.  After that, one feast should throw a message to another.  This message may not come, but it will create a rule on the router that messages from the address to which it was sent need to be delivered to this particular computer.  After that, with the help of the server, another feast learns that it is already possible for it to connect and, in fact, connects. <br><br>  And so, the sequence of actions: <br><ol><li>  Client 1 tells the server that it wants to connect to Client 2. (ServerP2PConnectRequestCommand command) </li><li>  The server delegates its task to the P2PService class. </li><li>  P2PService looks at whether such clients have already connected to it and whether it already knows their addresses.  If not, it asks for those who have not connected to connect (ClientConnectToP2PServiceCommand command) </li><li>  After they are connected, P2PService sends the command to wait for a connection to one of them.  In this case, this is Client 2. (ClientWaitPeerConnectionCommand) </li><li>  The client who received the command also receives the address that will be connected to it, and sends a message to it.  He starts to wait for a connection and sends a command to the server that he is ready to accept the connection.  (ServerP2PReadyAcceptCommand) </li><li>  After receiving the readiness command, the server tells the other client (Client 1) that it can connect.  (ClientConnectToPeerCommand) </li><li>  Communication between customers is established. </li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ea/c18/8ce/6eac188ce66bc50e9c31624874ba8203.png"><br><br>  Black arrows indicate sending commands.  Red initialization of Lidgren.Network connections. <br><br>  All this algorithm is hidden in AsyncPeer, and it is enough to call the SendMessage method, and if the client is not connected, it will connect and send a message.  Or immediately send if already connected. <br><br>  Voice commands initiate a connection a little differently.  When creating a voice room, the server creates a connection map in the room.  In which it is written where every user in the room should connect.  And voice playback commands are sent using the AsyncPeer.SendMessageIfConnected method, which simply throws out the message if there is no connection. <br><br><hr><br><br><h4>  User interface. </h4><br>  Finally, a little about the program interface. <br>  It is developed using WPF and MVVM pattern.  Very flexible technology, although in version 3.5 it‚Äôs a bit damp, but it nonetheless makes it possible to bypass damp places.  As an example, some Command properties are still not dependent, and for them I had to write a wrapper CommandReference. <br><br>  CommandReference in this case contains a real command - a dependent property on which you can hang the binding.  The wrapper itself is hosted in static resources.  And it is used in the right place, really causing the command to come. <br><br>  I also had to use AttachedProperty instead of wrappers, which in turn change the necessary ones. <br><br>  To notify the interface of changes, it was decided to use the event model, while all the necessary information is transmitted in the events to display the changes. <br><br>  In other matters, there is nothing more to write about interfaces, WPF as WPF. </div><p>Source: <a href="https://habr.com/ru/post/228021/">https://habr.com/ru/post/228021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228003/index.html">MiTCR is a platform for diagnosing a new type. Yandex Workshop</a></li>
<li><a href="../228005/index.html">Playing with Euclid</a></li>
<li><a href="../228009/index.html">Pizza delivery by drones in Syktyvkar was outlawed</a></li>
<li><a href="../228015/index.html">Pulse Habra</a></li>
<li><a href="../228019/index.html">The world's largest radio telescope completed and working at full capacity</a></li>
<li><a href="../228023/index.html">Work with geolocations in highload mode</a></li>
<li><a href="../228025/index.html">Discov3ry: extruder nozzle to a conventional 3D printer for working with ... chocolate cream, silicone, polyurethane, clay</a></li>
<li><a href="../228031/index.html">Variadic templates. Tuples, unpacking and more</a></li>
<li><a href="../228033/index.html">Westone Company History</a></li>
<li><a href="../228035/index.html">Astro Tracker Field Tests</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>