<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Office 365 authentication (some theory)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's always hard to start somewhere. After much deliberation, I decided to devote my first article on Habr√© to the topic I‚Äôm currently engaged in - Of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Office 365 authentication (some theory)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/7af/e75/c23/7afe75c23de880dfee665739820897c7.png" alt="Office 365 Logo" align="left">  It's always hard to start somewhere.  After much deliberation, I decided to devote my first article on Habr√© to the topic I‚Äôm currently engaged in - Office 365 in all its manifestations. <br><br>  The site has already had several articles describing certain components of this service.  They also wrote about <a href="http://habrahabr.ru/post/151632/">setting up authorization with ADFS</a> and <a href="http://habrahabr.ru/company/microsoft/blog/122913/">synchronization with Active Directory</a> , but in addition to practice, it would not hurt a bit of theory.  Of course, it‚Äôs impossible to tell everything, and it‚Äôs not interesting, but important, in my opinion, points worth noting. <br><br>  From my own experience, I can say that authentication in Office 365 is a rather complicated topic, for the seeming simplicity and obviousness of which often hides subtle nuances, the knowledge of which allows you to better deploy the system and reduce the time required to localize the problem.  I would like to talk about such nuances today. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  In Office 365, there are three types of identifiers used to authenticate your users in Exchange Online, Sharepoint Online, Lync Online, and even Office Pro Plus. <br><ol><li>  Microsoft Online ID is a regular Windows Azure Active Directory account.  This is similar to all of us familiar to Active Directory, but adapted to work with Microsoft cloud products (for example, in addition to Office 365, it is also used for MS Dynamics CRM Online).  Users are created manually using the administration portal or in bulk through a CSV file. </li><li>  Microsoft Online ID + DirSync - the same "cloud" users, but represent a copy of the accounts from your AD, created using the utility Microsoft Directory Synchronization or abbreviated DirSync.  Almost all basic attributes are transferred from the local AD, but user passwords are not transferred.  User management is carried out in part through AD, partly in the portal. </li><li>  Federated ID + DirSync - the system is based on the same principle of copying accounts from your AD, with the only difference that Active Directory Federation 2.0 is used for authorization.  User management is done through local AD. </li></ol><br><br>  Identifier type comparison <br><table><tbody><tr><td>  <b>Microsoft Online ID</b> </td><td>  <b>Microsoft Online ID + DirSync</b> </td><td>  <b>Federated ID + DirSync</b> </td></tr><tr><td>  <b>Lecture hall</b> <br><ul><li>  Small organizations without local Active Directory </li></ul><br></td><td>  <b>Lecture hall</b> <br><ul><li>  Medium organizations with local Active Directory </li></ul><br></td><td>  <b>Lecture hall</b> <br><ul><li>  Large organizations with local Active Directory </li></ul><br></td></tr><tr><td>  <b>"Behind"</b> <br><ul><li>  No local servers required </li></ul><br></td><td>  <b>"Behind"</b> <br><ul><li>  Local user and group management </li><li>  Coexistence scenarios </li></ul><br></td><td>  <b>"Behind"</b> <br><ul><li>  Corporate login topology with corporate details </li><li>  Local Identity Management </li><li>  Password policy is controlled locally </li><li>  Two-factor authentication possible </li><li>  Coexistence scenarios </li></ul><br></td></tr><tr><td>  <b>"Vs"</b> <br><ul><li>  Impossible single sign-on topology </li><li>  Two-factor authentication not possible </li><li>  Two sets of details with different password policies </li><li>  Cloud Identity Management </li></ul><br></td><td>  <b>"Vs"</b> <br><ul><li>  Impossible single sign-on topology </li><li>  Two-factor authentication not possible </li><li>  Two sets of details with different password policies </li><li>  Server deployment required </li></ul><br></td><td>  <b>"Vs"</b> <br><ul><li>  High availability server deployment required </li></ul><br></td></tr></tbody></table><br>  In practice, the third option is most often chosen.  this allows for uniformity of accounts and simplifies user management as much as possible while maintaining full control over access rights and password policies. <br><br>  If the first two options are rather obvious from the technical point of view, then there are difficulties with the implementation of authentication using ADFS. <br><br>  Before talking about the authentication mechanism, I‚Äôll give you a real life situation: in a company of 1000+ users, Office 365 was used with ADFS authentication.  On a not very beautiful morning, users began to complain that their Outlook could not connect to the mail, but access to Outlook Web Access, SharePoint, or Lync was preserved.  The reason for the failure was a change in server policies and, as a result, the fall of the ADFS Proxy service.  For localization of this problem several hours were spent, which could be saved, understanding a few simple things about authentication in Office 365. <br><br>  So, Office 365 uses two basic mechanisms (sometimes called profiles) for authentication: <br><br>  <b>Passive mechanism</b> - used for authorization in Office 365 services using a browser or single sign-on service. <br>  The principle of operation of this mechanism can be illustrated by the scheme: <br><img src="https://habrastorage.org/storage2/9b0/551/363/9b05513635001d3ce0d8de7e00dfe7a5.png" alt="image"><br><br><ol><li>  A user, using a browser or a Lync client, requests information from a SharePoint Online service, Exchange OWA, or a Lync server and receives a response asking to authenticate with the Authentication Platform </li><li>  The Authentication Platform, after receiving the request, determines that a federated identifier is used and requires that the User Source Id be submitted (confirming the user's validity in the local Active Directory), for which it forwards the request to the ADFS server URL. </li><li>  The ADFS server authenticates the user in the local AD and gives it a signed User Source ID. </li><li>  Armed with a kind of ‚Äúpassport‚Äù, the user once again turns to the Authentication Platform, from which this time receives a ‚Äúcloud ID‚Äù NET ID. </li><li>  This credential is further used to work with services. </li></ol><br><br>  <b>Active mechanism</b> - used for authorization in the e-mail service using Outlook or using the ActiveSync, IMAP, POP3 protocols. <br>  The scheme is very similar to the previous version: <br><img src="https://habrastorage.org/storage2/ab9/f39/e5b/ab9f39e5b27661e91c88002c4aeffea4.png" alt="image"><br>  The principle of operation of this authorization mechanism repeats all the steps, with the exception of one important detail - the user sends to the Exchange Online service his credentials explicitly (naturally protected by the HTTPS protocol).  Exchange Online, using the impersonalization mechanism, goes through all further steps on behalf of the user, including communicating with the ADFS server and obtaining the User Source ID. <br><br>  Therefore, you can identify several key points that are worth paying attention to - these are DNS, certificates, publication, and fault tolerance. <br><br>  <b>DNS</b> <br>  If you have problems, you need to always remember which DNS server the user is currently using when authorizing on a particular service. <br><br>  <b>Certificates</b> <br>  If all your users are in the corporate network and use only the browser and the Lync client to work with Office 365, then you can forget about this item and safely use your CA's self-signed certificate.  But as soon as you have external users, or you want to set up your favorite phone to receive corporate mail, you will need a valid certificate issued by a trusted certificate authority.  As a best practice, still at the stage of transition to Office 365, you should immediately plan a purchase if not a wildcard, then at least a regular one with a pair of SANs, not hoping that you have a unique situation and external users will never appear. <br><br>  <b>fault tolerance</b> <br>  It seems to be the most obvious thing of any IT system, in practice, it turns out to be the most painful.  Failover of the ADFS server is the most important and often overlooked step in setting up federated authentication.  Improving the reliability of ADFS is quite a simple task, consisting in the use of either a third-party NLB or a regular Windows Load Balancer (WNLNB).  I understand that I‚Äôm talking about obvious things, but, unfortunately, many administrators don‚Äôt devote to the topic of fault tolerance, trying ‚Äúsometime later‚Äù to deliver another server.  Without going into details, in practice, the lack of ADFS balancing is the most common cause of problems with Office 365. <br><br>  <b>Publication</b> <br>  As soon as Outlook or ActiveSync appears in your Office 365 usage scenario, the question arises whether ADFS is properly published outside.  There are several possibilities for this: <br><ul><li>  Putting the ADFS server out is the worst and insecure option used by administrators not from a good life. </li><li> Deploy ADFS Proxy ‚Äî you need two additional servers and load balancing between them (again using third-party NLB or WNLB).  Among the advantages worth noting the ease of configuration and administration.  There is almost nothing to break there. </li><li>  Publishing through Forefront TMG / UAG is more difficult to configure and maintain, but much more functional.  Allows you to extend the functionality of ADFS for external users and implement more complex Office 365 authorization scenarios. Some administrators manage to use the TMG and ADFS Proxy publication, which, in principle, is possible but fraught with many difficulties and instabilities that are difficult to localize. </li><li>  External Reverse Proxy - can be any solution / device that does not modify SAML requests / responses, for example, Citrix NetScaler or even a simple stunnel.  Requirements for reverse proxy can be found <a href="http://technet.microsoft.com/en-us/library/hh852618(v%3Dws.10).aspx">here.</a> </li></ul><br>  Office 365 authentication is a topic that you can write about for a very long time.  Today I tried to tell, in my opinion, the important points that often cause misunderstanding and mistakes.  For some, this article will be obvious, but I hope there will be those to whom it will save several unpleasant hours of problem localization and a kilogram of nerve cells. </div><p>Source: <a href="https://habr.com/ru/post/155187/">https://habr.com/ru/post/155187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155173/index.html">Periodic sending of messages</a></li>
<li><a href="../155179/index.html">Tale of how we ordered web development in India, and how Russian programmers saved us</a></li>
<li><a href="../155181/index.html">The largest US providers put into the work plan to combat the "pirates" on the Web</a></li>
<li><a href="../155183/index.html">In Google Play will add rubles and rupees</a></li>
<li><a href="../155185/index.html">Anonymous accessed BP, Shell, Exxon, Gazprom and Rosneft mail servers</a></li>
<li><a href="../155189/index.html">Again firmware: CM10 for Desire HD</a></li>
<li><a href="../155191/index.html">JSR 335 or lambda expressions in JAVA 8</a></li>
<li><a href="../155193/index.html">Treehouse for all</a></li>
<li><a href="../155197/index.html">Welcome post from Alconost</a></li>
<li><a href="../155201/index.html">Makefile for the smallest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>