<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What will happen if you mix nuts, Arduino, OpenCV and Delphi. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, habrovchanin. 

 The writer from me is not very, the teachers at school repeatedly pointed out to me after reading my writings. Not that the essen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What will happen if you mix nuts, Arduino, OpenCV and Delphi. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hi, habrovchanin. <br><br>  The writer from me is not very, the teachers at school repeatedly pointed out to me after reading my writings.  Not that the essence was not stated, I was reproached for the dryness and brevity of the story.  Then it seemed to me nagging, because conciseness is wonderful.  But not for the writer.  This time I will try to correct it, because since that time, tons of saifai have been read.  Such is the preamble, and it is possible that the person who has mastered this text will cry up to the end with a bloody tear, but I warned. <br><br>  It bothered me to live happily in a small town in central Ukraine.  The reasons for this are not known to me, but every autumn the collective farm market turns into a walnut exchange market, it is brought in from the whole region.  Everyone buys and sells both dressed and stripped nuts.  The excitement affects both professional dealers and retirees, for some reason I remember Dutch tulips.  But the story began in the summer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With my godfather we own a small computer store where he sells, and I do minor repairs and programming.  Once again, having arrived from a week-long rest with tents on the river bank, I had been sunburned and rybivshitsya and had something to solder in my office, which I affectionately called the "crypt" because of the abundance of dead iron and a constant ambient temperature. <br><br>  - They came to you. <br><br>  I came out of the crypt and met a little older boy named Andrei.  In the palm of his hand he had halves of walnut kernels, one dark brown, almost black, the other - light, almost beige.  Andrei offered a job, it was necessary to separate the first from the second programmatically.  This was the first mistake.  No, do not think badly, the error is not that he contacted me, but in the fact that he brought me so different examples.  I was given complete freedom in terms of platforms and implementations.  Although it was proposed to use cameras, I discarded them, in view of how it seemed to me then, the complexity of implementation and the resource intensity of such an approach.  The sensor <a href="http://www.dfrobot.com/wiki/index.php/TCS3200_Color_Sensor_(SKU:SEN0101)">tcs3200</a> was chosen as a sensor - a <a href="http://www.dfrobot.com/wiki/index.php/TCS3200_Color_Sensor_(SKU:SEN0101)">color-</a> &gt; frequency converter, which is often used in DIY projects for sorting something colored.  According to the datasheet, the sensor had good characteristics: it had 16 photodiodes of each color (R / G / B) plus 16 photodiodes for white color separately.  The depth of sensitivity of each channel was significantly higher than 8 bits per channel, which is offered by a household webcam.  The first version of the device was a cardboard tube of food foil with a cut out window for the sensor and the backlight.  Data with the highest possible speed was transferred to the Windows application.  It turned out about 600 measurements per second. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/c4d/b45/92e/c4db4592e41c98f0901ff1b2b88b78ac.jpg" alt="image" height="250" width="300"><img src="https://habrastorage.org/getpro/habr/post_images/142/ba8/67e/142ba867ee33f585124669d87b7f5893.jpg" alt="image" height="250" width="300"><br>  <i>Photos are not mine, taken from the network, photos of the first prototype, alas, no more.</i>  <i>The very same prototype was torn by children when they (and the prototype and children) were left unattended.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e20/df4/e1f/e20df4e1fd283a63331f1dfff5df3ed1.png"><br>  <i>In the screenshot of the application, graphics on a black background had to be drawn in Photoshop from memory.</i>  <i>Further, all the illustrations will be real.</i> <br><br>  Nuts slid by the piece on a pipe inclined by 45 degrees, and if the data from the sensor differed from the background (pre-calibrated), the nut and its weighted average color were recorded.  The nuts were sorted by this value, I admit, a rather primitive algorithm, however, it worked perfectly. <br><div class="spoiler">  <b class="spoiler_title">Sketch for Leonardo</b> <div class="spoiler_text"><pre><code class="hljs pgsql">const <span class="hljs-type"><span class="hljs-type">int</span></span> s0 = <span class="hljs-number"><span class="hljs-number">12</span></span>; // sensor pins const <span class="hljs-type"><span class="hljs-type">int</span></span> s1 = <span class="hljs-number"><span class="hljs-number">13</span></span>; const <span class="hljs-type"><span class="hljs-type">int</span></span> s2 = <span class="hljs-number"><span class="hljs-number">11</span></span>; const <span class="hljs-type"><span class="hljs-type">int</span></span> s3 = <span class="hljs-number"><span class="hljs-number">10</span></span>; const <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> = <span class="hljs-number"><span class="hljs-number">9</span></span>; // TCS230 output const <span class="hljs-type"><span class="hljs-type">int</span></span> ejector = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> red = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> green = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> blue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> white = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> comm = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> setup() { pinMode(s0, OUTPUT); pinMode(s1, OUTPUT); pinMode(s2, OUTPUT); pinMode(s3, OUTPUT); pinMode(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); pinMode(ejector, OUTPUT); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-type"><span class="hljs-type">Serial</span></span>) { ; // wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>. Needed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Leonardo <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> } digitalWrite(s0, HIGH); digitalWrite(s1, HIGH); //l } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">Serial</span></span>.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { comm = <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comm == <span class="hljs-number"><span class="hljs-number">65</span></span>) { getColor(); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(lowByte(red)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(highByte(red)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(lowByte(green)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(highByte(green)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(lowByte(blue)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(highByte(blue)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(lowByte(white)); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(highByte(white)); delayMicroseconds(<span class="hljs-number"><span class="hljs-number">25</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comm == <span class="hljs-number"><span class="hljs-number">66</span></span>) { digitalWrite(ejector, HIGH); delayMicroseconds(<span class="hljs-number"><span class="hljs-number">10000</span></span>); digitalWrite(ejector, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (comm == <span class="hljs-number"><span class="hljs-number">67</span></span>) { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-type"><span class="hljs-type">Serial</span></span>) { ; // wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>. Needed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Leonardo <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> } } } <span class="hljs-type"><span class="hljs-type">void</span></span> getColor() { digitalWrite(s2, LOW); digitalWrite(s3, LOW); red = pulseIn(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, digitalRead(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>) == HIGH ? LOW : HIGH); digitalWrite(s3, HIGH); blue = pulseIn(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, digitalRead(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>) == HIGH ? LOW : HIGH); digitalWrite(s2, HIGH); green = pulseIn(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, digitalRead(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>) == HIGH ? LOW : HIGH); digitalWrite(s3, LOW); white = pulseIn(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, digitalRead(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>) == HIGH ? LOW : HIGH); }</code> </pre> <br></div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/7b0/63b/1c0/7b063b1c086ce31722e33556ccb7933e.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/5b8/e96/2db/5b8e962dbfa8e626b608f0cf501bbfc2.jpg" alt="image"><br>  <i>Photos, where you can see the difference between the first and second nuts.</i> <br><br>  With those samples that Andrey gave me everything worked perfectly and separated the dark from the light nuts with an accuracy of 95%.  What was the epic file when the next time nuts were brought with less contrasting differences.  The craft refused to distinguish between nuts, because their weighted average color was almost the same.  An attempt was made to analyze the nuts according to the time / color saturation graphs, but this did not give the desired results; the sensor at such speeds was noisy.  As a result, it was decided to move to the camera. <br><br>  But this will be more interesting in the second and final part, I promise. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kKQSGC4c71s%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhj3BQfX9M0nIU52QeiWX8WusENwkw" frameborder="0" allowfullscreen=""></iframe><br><br>  PS: Added sketch <br><br>  <b>The promised <a href="http://habrahabr.ru/post/238783/">second</a> part.</b> </div><p>Source: <a href="https://habr.com/ru/post/238629/">https://habr.com/ru/post/238629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238619/index.html">Interception of calls of functions of native libraries in Android applications</a></li>
<li><a href="../238621/index.html">Ubuntu 14.04 on Asus X200MA</a></li>
<li><a href="../238623/index.html">The social network "Anti-Facebook" has a "viral" growth</a></li>
<li><a href="../238625/index.html">A universal method of circumventing the ban Yota to distribute the Internet from the phone or collect the Android kernel module</a></li>
<li><a href="../238627/index.html">It turns out that modern C ++ compilers support unicode identifiers.</a></li>
<li><a href="../238631/index.html">3D printing will form the basis of future data centers.</a></li>
<li><a href="../238635/index.html">Fundraising for the purchase of a Flir Lepton thermal imaging module.</a></li>
<li><a href="../238639/index.html">How tactile interfaces will change our gadgets</a></li>
<li><a href="../238641/index.html">Apple fixed Shellshock vulnerability in OS X</a></li>
<li><a href="../238643/index.html">TTT: jVuery text animation plugin from Contorra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>