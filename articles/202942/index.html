<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>252 characters minicraft</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the popular series of articles on the fact that 30 lines of javascript are sufficient for everyone , I offer you the translation of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>252 characters minicraft</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the <a href="http://habrahabr.ru/post/202736/">popular</a> series of articles on the fact that <a href="http://habrahabr.ru/search/%3Fq%3D%5B30%2520%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25BA%5D%26target_type%3Dposts">30 lines of javascript are sufficient for everyone</a> , I offer you the translation of the article by Matthew Henry P01 about his latest work: <br><br><div style="text-align:center;"><img title="Minicraft" src="https://habrastorage.org/getpro/habr/post_images/0f8/b6d/8e9/0f8b6d8e9059432a948ceef51482218d.png"></div><br><a name="habracut"></a><br>  (further text from the first person, all "I" refer to P01) <br><br><h4>  Motivation </h4><br>  About a year ago, <a href="https://mojang.com/notch/">Notch</a> wrote a fly- <a href="http://jsfiddle.net/uzMPU/embedded/result/">around on the world of minecrafter</a> with procedural textures, a camera and a fog effect with a total weight of only 4 kilograms on javascript. It looked cool and worked lively.  Its code is sharpened for speed  having spent a little effort, it was really possible to squeeze it down to 2 or even 1 kilobyte. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A month ago, I released <a href="http://www.p01.org/releases/wolfensteiny/">Wulfenstein</a> , and the community response was quite encouraging.  So I took the next step and moved to full 3D. <br><br><h4>  Sources </h4><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">setInterval(F</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">";t+=.1;Q=Math.cos;for(x=n=c.height=300;x-=4;)for(y=n;y-=4;d.fillRect(x,y,E,Z^z?4:E))for(D=0;(E=4-D/2)&amp;&amp;F&lt;F[(t+D*Q(T=x/n-.5+Q(t/9))&amp;7)*8|(Z=3.7+D*Q(T-8)&amp;7)*4|(6.5-D*y/nE)];z=Z)D+=1/8"</span></span></span><span class="hljs-tag">,</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">t</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">55),d</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">c.getContext(</span></span></span><span class="hljs-tag">'</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">2d</span></span></span><span class="hljs-tag">')&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">c</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Voila!  252 bytes of shamanism with voxel 3D world, camera and fog effect. <br><br><h4>  Version 248 for Ponte </h4><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">setInterval(F</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">";t+=.1;Q=Math.cos;for(x=n=c.height=300;x-=4;)for(y=n;y-=4;c.getContext('2d').fillRect(x,y,E,Z^z?4:E))for(D=0;(E=4-D/2)&amp;&amp;F&lt;F[(t+D*Q(T=x/n-.5+Q(t/9))&amp;7)*8|(Z=3.7+D*Q(T-8)&amp;7)*4|(6.5-D*y/nE)];z=Z)D+=1/8"</span></span></span><span class="hljs-tag">,</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">t</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">55)</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">c</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  A slightly <a href="http://www.p01.org/releases/minicraft/miniminicraft.htm">slower version of the Minicraft at 248 bytes</a> , because I can!  All the same, only works slower. <br><br><h4>  How ? </h4><br>  You are probably interested in how the 3D engine, the flight path of the camera and the three-dimensional world itself fit in 252 bytes of html and javascript.  This is a hell of a mixture of different beautiful and dirty tricks;  some of them will be discussed below. <br><br><h4>  Dwarf shoulders </h4><br>  In fact, Minicraft stands on the shoulders of its miniature predecessors - Wolfenstein, <a href="http://www.p01.org/releases/tea_storm/">Storm in a Glass</a> and <a href="http://www.p01.org/releases/MINI_DISTRICT/">Rayonchik</a> .  Many of the techniques used here have already been described earlier with these releases. <br><br><h4>  Drawing </h4><br>  Given the <a href="http://www.pouet.net/prodlist.php%3Ftype%5B%5D%3D256b%26platform%5B%5D%3DJavaScript%26page%3D1">size limit of</a> this demo, there was no space for beautiful rendering.  I had to use coarse ray tracing with a fixed pitch. <br><br>  If you are wondering what lies behind these abstruse words, then everything is quite simple.  The function representing the world you want to draw is actually calculated for each point in the space between the camera and the points you actually draw.  In other words, you call this fat function thousands, hundreds of thousands of times a frame, without any hint of speed optimization. <br><br><h4>  Resolution </h4><br>  The default resolution for the canvas element is 300x150.  Setting the width or height of the canvas clears it and resets its settings.  If you want the highest resolution at the lowest cost, the best way is to set the height to 300 in each frame. <br><br>  So, we have a canvas 300x300.  However, the selected drawing method is too slow for such a number of rays.  Therefore, dividing the resolution by 4, we will only trace 75x75 = 5.625 rays.  Passing the beam in 1/8 increments until an opaque block or distance of 8 units is reached, we get a maximum of 75x75x80 = 450,000 checks per frame. <br><br><h4>  World of the line </h4><br>  With this size, you have absolutely no place to generate, save or use a dynamic distance map as a world map, so you have to use the only available data: the source code. <br><br>  By placing the main loop code in the variable F, we get access to its string representation and use it as a map of transparent / opaque blocks in a 3D grid. <br><br>  Since the code is short, there was only enough data for the 8x8x8 world, using the first 64 characters of the main loop as information on 512 voxels.  Having studied the ASCII codes in this line, I decided to consider as an opaque block any character preceding a semicolon in the ASCII table, inclusive.  In other words, any of the symbols! "# $% &amp; '() * +, -. / 0123456789 :; means an opaque block. This choice allowed you to get a through hole in the map, which in turn simplified the camera's trajectory. <br><br>  Thus, checking the intersection in Minicraft looks very simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// F = the source code of the main loop ';' &lt; F[x + z * 4 + y * 8]</span></span></code> </pre><br>  Speaking of the semicolon, the attentive reader might have noticed one strange detail in the source: <br><br><img src="http://habrastorage.org/storage3/8dd/32a/e7b/8dd32ae7ba6e370f75d2ae7076d86d69.png"><br><br>  See, the main loop code starts with a semicolon?  This seemingly useless semicolon allows you to win an extra byte, reducing the already compact intersection check to: <br><br><pre> <code class="javascript hljs">F &lt; F[x + z * <span class="hljs-number"><span class="hljs-number">4</span></span> + y * <span class="hljs-number"><span class="hljs-number">8</span></span>]</code> </pre><br><h4>  Ray tracing and camera </h4><br>  As it was said above, in the 3D map we had a through opening, ideal for the passage of the camera.  Rays are thrown from the camera within the pyramid of visibility for each pixel, then we gradually check all points along the beam for intersection with the map until it is found, or the distance traveled does not exceed the allowable maximum.  The further we move along the beam, the brighter the shade of gray will be assigned to the corresponding pixel. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(x=n=c.height=<span class="hljs-number"><span class="hljs-number">300</span></span>;x-=<span class="hljs-number"><span class="hljs-number">4</span></span>;) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(y=n;y-=<span class="hljs-number"><span class="hljs-number">4</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*      x,y  D */</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(D=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*         X, Y, Z */</span></span>;z=Z) D+=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre><br>  The outer loops run over all x and y pixels and fill them with the resulting shade of gray D. The inner loop walks along the ray corresponding to the pixel at position x, y until an opaque block is found. <br><br>  The three-dimensional X, Y, Z coordinates of the current position on the beam are calculated as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  E=4-D/2 (t+D*Q(T=x/n-.5+Q(t/9))&amp;7)*8|(Z=3.7+D*Q(T-8)&amp;7)*4|(6.5-D*y/nE)</span></span></code> </pre><br>  What Y * 8 actually calculates |  Z * 4 |  X. If more, then: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    cA = Math.cos(t/9) //    rA = x / h - .5 + cA // D - ,      //       Y Y = D * Math.cos(rA) + t Z = D * Math.sin(rA) + 3.7 X = D * ( y / h - .5) + 2.5</span></span></code> </pre><br><h4>  Dithering, fog and grayscale </h4><br>  By default, canvas has a black fillStyle.  There is not enough space to change it, so you have to look for another way to implement the palette.  Shades of gray in Minicraft are obtained from rectangles with fractional width and height.  Sub-pixel dimensions cause <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B3%25D0%25BB%25D0%25B0%25D0%25B6%25D0%25B8%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">smoothing</a> , which makes the edges of the rectangles semi-transparent.  Just like that.  By drawing one rectangle for each pixel, we actually get some kind of dithering. <br><br>  Lighting in the demo uses the same trick as Rayonchik with the Wolfenstein.  To determine the direction of the surface normal to one or the other side, the whole parts of the Z coordinates of points on the ray are compared before and after intersection with an opaque block.  Remember the main loop? <br><br><pre> <code class="javascript hljs">;t+=<span class="hljs-number"><span class="hljs-number">.1</span></span>;Q=<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(x=n=c.height=<span class="hljs-number"><span class="hljs-number">300</span></span>;x-=<span class="hljs-number"><span class="hljs-number">4</span></span>;)<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(y=n;y-=<span class="hljs-number"><span class="hljs-number">4</span></span>;d.fillRect(x,y,E,Z^z?<span class="hljs-number"><span class="hljs-number">4</span></span>:E))<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(D=<span class="hljs-number"><span class="hljs-number">0</span></span>;(E=<span class="hljs-number"><span class="hljs-number">4</span></span>-D/<span class="hljs-number"><span class="hljs-number">2</span></span>)&amp;&amp;F&lt;F[(t+D*Q(T=x/n<span class="hljs-number"><span class="hljs-number">-.5</span></span>+Q(t/<span class="hljs-number"><span class="hljs-number">9</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">7</span></span>)*<span class="hljs-number"><span class="hljs-number">8</span></span>|(Z=<span class="hljs-number"><span class="hljs-number">3.7</span></span>+D*Q(T<span class="hljs-number"><span class="hljs-number">-8</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">7</span></span>)*<span class="hljs-number"><span class="hljs-number">4</span></span>|(<span class="hljs-number"><span class="hljs-number">6.5</span></span>-D*y/nE)];z=Z)D+=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre><br>  the code responsible for storing and comparing whole parts of the Z coordinates is in it in the expressions Z ^ z? 4 :, Z = and z = Z. <br><br><h4>  Magic numbers </h4><br>  We all know that floating-point numbers are not optimal for applications that require accurate representation of numbers.  IEEE-754 standards are based on binary notation and powers of two, which results in rounding errors of decimal numbers. <br><div style="text-align:center;"><img src="http://habrastorage.org/storage3/9a5/2cf/bcf/9a52cfbcf479439efe535f6a34a0e121.png"></div><br>  In javascript, as in many other programming languages, 0.1 + 0.2 = 0.30000000000000004.  This is inconvenient in many situations, however, when you are dealing exclusively with powers of two, IEEE 754 plays into your hands and allows you to perform a couple of tricks. <br><br>  For example, in the ray calculation cycles given above, <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(x=n=c.height=<span class="hljs-number"><span class="hljs-number">300</span></span>;x-=<span class="hljs-number"><span class="hljs-number">4</span></span>;) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(y=n;y-=<span class="hljs-number"><span class="hljs-number">4</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*      x,y  D */</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(D=<span class="hljs-number"><span class="hljs-number">0</span></span>;(E=<span class="hljs-number"><span class="hljs-number">4</span></span>-D/<span class="hljs-number"><span class="hljs-number">2</span></span>)&amp;&amp;F&lt;F[ ... ];z=Z) D+=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre><br>  we can easily notice that D has reached 8, because  the expression (E = 4-D / 2) goes to 0, which in turn is equivalent to false and stops the cycle. <br><br>  The value of E corresponds to the size of the rectangle that we draw for this ray, and at the same time serves to calculate the X coordinate for a point on the ray.  In general, this focus saves 3 bytes. <br><br><h4>  Dirty trigonometry </h4><br>  To win 4 bytes in the code that uses Math.cos and Math.sin, a link to Math.cos is created, and the ‚Äúsine‚Äù is obtained by adding 8 to the argument.  The error of such an approximation does not exceed 0.15 radians. <br><br><h4>  Reviews </h4><br>  Feedback and suggestions are collected on the <a href="http://pouet.net/prod.php%3Fwhich%3D62065">Minicraft page on Pouet.net</a> . </div><p>Source: <a href="https://habr.com/ru/post/202942/">https://habr.com/ru/post/202942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202924/index.html">Escape from the ‚ÄúOthers‚Äù column: local brands increase market share</a></li>
<li><a href="../202926/index.html">Microprocessor software simulation. Transmission</a></li>
<li><a href="../202928/index.html">TC MUK announced pre-holiday discount on the course VMware Vsphere Fast Track</a></li>
<li><a href="../202930/index.html">Watson Cookies</a></li>
<li><a href="../202934/index.html">Payoneer and Pond5: new opportunities for stockers</a></li>
<li><a href="../202944/index.html">Small Javascript programs: where to go</a></li>
<li><a href="../202946/index.html">Get message - a list of your email with a preview on the google search page</a></li>
<li><a href="../202948/index.html">[Translation] Arrays, slices (and lines): The mechanism of 'insertion'</a></li>
<li><a href="../202950/index.html">Melitopol - stratosphere - Tikhonovka</a></li>
<li><a href="../202952/index.html">ScienceHub # 07: Neurointelligence and Neuromorphic Systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>