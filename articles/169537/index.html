<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HOWTO: One of the possible implementation of the Model (MVC) in the Zend Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing an article inspired by habrahabr.ru/qa/34735 and habrahabr.ru/qa/32135 with questions, as answers to which I could not find complete and detai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HOWTO: One of the possible implementation of the Model (MVC) in the Zend Framework</h1><div class="post__text post__text-html js-mediator-article">  Writing an article inspired by <a href="http://habrahabr.ru/qa/34735/">habrahabr.ru/qa/34735</a> and <a href="http://habrahabr.ru/qa/32135/">habrahabr.ru/qa/32135</a> with questions, as answers to which I could not find complete and detailed information, which was much lacking.  I hope it will be useful to others. <br><br>  The project, whose share was chosen as ZF as the main framework, was the mobile version of the service (adaptive design with some nuances) + API for mobile applications. <br>  It was collectively made a political and technical decision to make a single API, through which both the site and applications will communicate. <br><br>  On this, I think, the prelude can be finished and go to the most interesting. <br><a name="habracut"></a><br>  Article for convenience divided into 2 parts.  <a href="https://habr.com/ru/post/169537/">The first part</a> contains a bit of theory, thoughts and references to various sources.  <a href="https://habr.com/ru/post/169537/">In the second part,</a> I tried in detail (with code examples) to show how I implemented my version of the architecture. <br><a name="theory"></a><br><h4>  Some theory </h4><br><h5>  Start </h5><br>  Zend Framework is not the easiest in terms of entry threshold.  I spent enough time to understand his ideology, but after that, each next step is expected, predictable and logical. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite a sufficient amount of <a href="http://framework.zend.com/manual/1.12/en/manual.html">official documentation</a> , in some places it is pretty hard (colleagues even delicately called it ‚ÄúTwi-style documentation‚Äù), and a lot has to be taken from studying the source code. <br><br>  I just want to draw attention to those who talk about the monstrosity of this miracle - yes, the Zend is quite a large, large-scale cannon, of which at first glance ... on sparrows there is nothing to it ... But after looking and studying its features even superficially, I can add that the caliber of this gun is very customizable.  There is a fairly good working autoloader, which allows you to connect a minimal set of classes. <br><br>  Having assembled the test application framework (quick start), I began the process of designing the architecture while actively exploring the possibilities, recommendations and best practices developed at ZF (I really liked the <a href="http://www.slideshare.net/weierophinney/playdoh-modelling-your-objects-1766001">presentation</a> , got a lot of thoughts from it, there will be more links to the text). <br><br><h5>  Model in MVC </h5><br>  Many people perceive and describe the model as a way to access data at the database level, but this is not entirely true.  A model is not a relational database, or even a table.  Data may come from different sources. <br>  I considered the model as a multilevel layer and selected 3 layers for myself: <br><ul><li>  Domain Model </li><li>  Data mapper </li><li>  Data Access Layer (DAL) </li></ul><br>  <b>Domain Model</b> - description of object metadata, including getters, setters, data validation and object behavior description (behavior).  <a href="http://msdn.microsoft.com/en-us/magazine/ee236415.aspx">Argued</a> that the description of the behavior can also be made in the layer DomainEvents, and this is something different from the <a href="http://design-pattern.ru/patterns/table-data-gateway.html">Table Data Gateway pattern</a> . <br>  This level in my implementation knows nothing about the methods (and locations) of data storage. <br><br>  <b>Data Mapper</b> is a layer designed to directly transfer data from the abstract description level to the low level. <br><br>  <b>DAL</b> contains direct requests to the storage source.  There you can find SQL code and other delights of life.  In ZF, the role of this level is performed by Zend_Db_Table and its derivatives. <br><br>  If you use an external ORM, for example Doctrine, then it completely replaces the last levels and makes the developer's life easier.  Since I set myself the goal of ‚Äúlearning with immersion,‚Äù I did not use third-party ORMs and decided to make <s>my</s> own implementation of <s>my bike</s> . <br><a name="examples"></a><br><h4>  Howto </h4><br><h6>  Project structure </h6><br>  The real picture is the following organization of the file structure: <br><br><pre><code class="hljs php">application/ controllers/ IndexController.php FooController.php models/ <span class="hljs-keyword"><span class="hljs-keyword">Abstract</span></span>/ AbstractMapper.php AbstractModel.php DBTable/ FooTable.php DeviceTable.php Mapper/ FooMapper.php DeviceMapper.php Foo.php Device.php services/ DeviceService.php FooService.php views/</code> </pre> <br><h5>  Some code in the examples. </h5><br>  I am a supporter of the approach when a thin controller is implemented, and the whole business is put into services and models.  This approach allows you to minimize the repeatability of the code, simplify testing and changes to the logic. <br>  I will give an example of a ‚Äúneutral and standard‚Äù controller, which is responsible for authorization, registration, and actions related to these processes. <br><br><div class="spoiler">  <b class="spoiler_title">Controller example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeviceapiController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Controller_Action</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_helper-&gt;viewRenderer-&gt;setNoRender(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Login user from API Request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@method</span></span></span><span class="hljs-comment"> POST * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> json rawBody {"data":{"login": "admin", "password": "password"}} * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string login in JSON * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string password in JSON * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string SecretKey * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> HTTP STATUS 200 if ok * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> HTTP STATUS 400 if fields doesn't valid * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> HTTP STATUS 409 if user already exist */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loginAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $request = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest(); $data = $request-&gt;getRawBody(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($data) { <span class="hljs-comment"><span class="hljs-comment">// decode from json params $params = Zend_Json::decode($data); $result = Application_Service_DeviceService::login($params); if (!is_null($result['secretKey'])) { $this-&gt;getResponse() -&gt;setHttpResponseCode(200) -&gt;setHeader('Content-type', 'application/json', true) -&gt;setBody(Zend_Json::encode($result)); $this-&gt;_setSecretKeyToCookies($result['secretKey']); return; } $this-&gt;getResponse() -&gt;setHttpResponseCode(401); return; } $this-&gt;getResponse() -&gt;setHttpResponseCode(405); return; } /** * Profile from API Request * * @method GET * @param Request Header Cookie secretKey * * @return json string {"id":"","email":"","realName":""} * @return HTTP STATUS 200 OK */ public function profileAction() { $cookies = $this-&gt;getRequest()-&gt;getCookie(); if (!isset($cookies['secretKey']) || (!Application_Service_DeviceService::isAuthenticated($cookies['secretKey']))) { $this-&gt;getResponse() -&gt;setHttpResponseCode(401) -&gt;setHeader('Content-Type', 'application/json') -&gt;setBody(Zend_Json::encode(array("message" =&gt; "Unauthorized"))); return; } $result = Application_Service_DeviceService::getProfile($cookies['secretKey'])-&gt;toArray(); unset($result['password']); unset($result['passwordSalt']); $this-&gt;getResponse() -&gt;setHttpResponseCode(200) -&gt;setHeader('Content-type', 'application/json', true) -&gt;setBody(Zend_Json::encode($result)); return; } /** * Logout from API Request * @method POST * @param Request Header Cookie secretKey * * @return HTTP STATUS 200 OK */ public function logoutAction() { $cookies = $this-&gt;getRequest()-&gt;getCookie(); if ($cookies['secretKey']) { $device = new Application_Model_Device(); $device-&gt;deleteByKey($cookies['secretKey']); $this-&gt;_setSecretKeyToCookies($cookies['secretKey'], -1); if(Zend_Auth::getInstance()-&gt;hasIdentity()) { Zend_Auth::getInstance()-&gt;clearIdentity(); } } $this-&gt;getResponse() -&gt;setHttpResponseCode(200); return; } /** * Signup user from API Request * @method POST * @param json string {"email": "", "password": "", ‚ÄúrealName‚Äù: ‚Äú‚Äù} * * @return string SecretKey * @return HTTP STATUS 201 Created * @return HTTP STATUS 400 Bad request * @return HTTP STATUS 409 Conflict - user already exist */ public function signupAction() { $request = $this-&gt;getRequest(); $data = $request-&gt;getRawBody(); // decode from json params $params = Zend_Json::decode($data); $email = $params['email']; $name = $params['realName']; $password = $params['password']; $err = array(); if (!isset($email) || !isset($name) || !isset($password) || (filter_var($email, FILTER_VALIDATE_EMAIL)==FALSE)) { if (!isset($email)) { $err['email'] = "Email is missing"; } if (!isset($name)) { $err['name'] = "Name is missing"; } if (!isset($password)) { $err['password'] = "Password are missing"; } if (filter_var($email, FILTER_VALIDATE_EMAIL)==FALSE) { $err['valid_email'] = "Email is not valid"; } } if (!empty($err)) { $this-&gt;getResponse() -&gt;setHttpResponseCode(400) -&gt;setBody(Zend_Json::encode(array ("invalid" =&gt; $err))); return; } $service = new Application_Service_DeviceService(); $params = array("email" =&gt; $email, "username" =&gt; $name, "password" =&gt; $password); try { $result = $service-&gt;signup($params); } catch (Zend_Exception_UserAlreadyExist $e) { $this-&gt;getResponse() -&gt;setHttpResponseCode(409) -&gt;setBody(Zend_Json::encode(array("message" =&gt; "User already exist"))); return; } $this-&gt;getResponse() -&gt;setHttpResponseCode(201) -&gt;setHeader('Content-type', 'application/json', true) -&gt;setBody(Zend_Json::encode($result)); $this-&gt;_setSecretKeyToCookies($result['secretKey']); return; } /** * Protected local method to set Secretkey to Cookies * @param string $secretKey * @param int | null $timeFlg */ protected function _setSecretKeyToCookies($secretKey,$timeFlg = 1) { $cookie = new Zend_Http_Header_SetCookie(); $cookie-&gt;setName('secretKey') -&gt;setValue($secretKey) -&gt;setPath('/') -&gt;setExpires(time() + (1* 365 * 24 * 60 * 60)*$timeFlg); $this-&gt;getResponse()-&gt;setRawHeader($cookie); return; } }</span></span></code> </pre><br></div></div><br>  Thus, the controller in this example performs the role of a preliminary validator of input data, a business router (calling certain services) and generating responses.  In my example, I needed to return data only through the API.  In more complex cases, when you need to work out the same logic, only depending on the type of request or other parameters, to give an answer in a different format, it is convenient to use the content switcher.  For example, this can be useful when the same request is used for simple interaction with the site, for processing Ajax calls, or when you need to give the same data in different formats (either in JSON or in XML, for example) depending from Content-Type request. <br>  In my opinion, this is the most efficient use of controllers, which makes it quite easy to expand the functionality. <br>  Such controllers are fairly easy to test.  At the same time, the tests really help to understand how the functionality works, how it should work.  In the development process, I did not use such techniques as TDD, so I wrote tests on ready-made controllers.  This helped to identify a couple of bottlenecks and potential bugs. <br>  In confirmation of my words about the easy testability of such controllers below I give an example of tests. <br><br><div class="spoiler">  <b class="spoiler_title">Tests for such a controller look like this</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Test_PHPUnit_ControllerTestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * Fixtures: * User with `email</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@example</span></span></span><span class="hljs-comment">.com` and `password` */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bootstrap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Application(APPLICATION_ENV, APPLICATION_PATH . <span class="hljs-string"><span class="hljs-string">'/configs/application.ini'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::setUp(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSuccessfulLoginAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $request = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest(); $email = <span class="hljs-string"><span class="hljs-string">'email@example.com'</span></span>; $request-&gt; setMethod(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>)-&gt; setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>)-&gt; setRawBody(Zend_Json::encode(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; $email, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'password'</span></span>, ))); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dispatch(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertNotRedirect(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertHeaderContains(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); $data = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getResponse()-&gt;getBody(); $data = Zend_Json::decode($data, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertArrayHasKey(<span class="hljs-string"><span class="hljs-string">'secretKey'</span></span>, $data); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;resetRequest() -&gt;resetResponse(); <span class="hljs-comment"><span class="hljs-comment">// Test logout $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json')-&gt; setCookie('secretKey', $data['secretKey']); $this-&gt;dispatch('/logout'); $this-&gt;assertResponseCode(200); $this-&gt;resetRequest() -&gt;resetResponse(); } public function testLoginWithEmptyParamsAction() { $request = $this-&gt;getRequest(); $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json')-&gt; setRawBody(Zend_Json::encode(array( 'email' =&gt; '', 'password' =&gt; '', ))); $this-&gt;dispatch('/login'); $this-&gt;assertResponseCode(401); $this-&gt;resetRequest() -&gt;resetResponse(); } public function testLoginWithoutParamsAction() { $request = $this-&gt;getRequest(); $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json'); $this-&gt;dispatch('/login'); $this-&gt;assertResponseCode(405); $this-&gt;resetRequest() -&gt;resetResponse(); } public function testSignupAction() { $request = $this-&gt;getRequest(); $email = "newemail_".substr(MD5(uniqid(rand(), true)), 0, 12)."@".substr(MD5(uniqid(rand(), true)), 0, 5).".com"; $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json')-&gt; setRawBody(Zend_Json::encode(array( 'email' =&gt; $email, 'password' =&gt; 'password', 'realName' =&gt; 'John Dow', ))); $this-&gt;dispatch('/signup'); $this-&gt;assertResponseCode(201); $this-&gt;assertHeaderContains('Content-Type', 'application/json'); $data = json_decode($this-&gt;getResponse()-&gt;outputBody(), true); $this-&gt;assertArrayHasKey('secretKey', $data); $secretKey = $data['secretKey']; $this-&gt;assertArrayHasKey('user', $data); $this-&gt;resetRequest() -&gt;resetResponse(); $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json')-&gt; setRawBody(json_encode(array( 'email' =&gt; '2', 'password' =&gt; '11', 'realName' =&gt; '23s', ))); $this-&gt;dispatch('/signup'); $this-&gt;assertResponseCode(400); $data = json_decode($this-&gt;getResponse()-&gt;outputBody(), true); $this-&gt;assertArrayHasKey('invalid', $data); $invalid = $data['invalid']; $this-&gt;assertArrayHasKey('email', $invalid); $this-&gt;assertArrayHasKey('password', $invalid); $this-&gt;resetRequest() -&gt;resetResponse(); } public function testAlreadyExistUserSignup() { $request = $this-&gt;getRequest(); $request-&gt; setMethod('POST')-&gt; setHeader('Content-Type', 'application/json')-&gt; setRawBody(Zend_Json::encode(array( 'email' =&gt; 'email@example.com', 'password' =&gt; 'password', 'realName' =&gt; 'John Dow', ))); $this-&gt;dispatch('/signup'); $this-&gt;assertResponseCode(409); $this-&gt;resetRequest() -&gt;resetResponse(); } }</span></span></code> </pre><br></div></div><br>  The services implemented the business itself.  I tried to do methods of services static.  This approach allowed me not to create the service object once more and to minimize the dependencies of services on the context and on each other, which also facilitates their testing, refactor, making changes, extending functionality. <br>  It is also worth noting that services return data in a context-independent format (for example, arrays), and the controller is already engaged in their packaging in a specific format.  Therefore, if tomorrow we need to change the format of the data transfer, we can change it with a <s>flick of the wrist</s> ‚Äúwithout excess blood‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Service example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Service_DeviceService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($params) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($params[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($params[<span class="hljs-string"><span class="hljs-string">'password'</span></span>])) { $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Model_User(); $device = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Model_Device(); $adapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Auth_Adapter_DbTable( Zend_Controller_Front::getInstance()-&gt;getParam(<span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span>)-&gt;getPluginResource(<span class="hljs-string"><span class="hljs-string">"db"</span></span>)-&gt;getDbAdapter(), <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'email'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'MD5(CONCAT(?, passwordSalt,"'</span></span> <span class="hljs-comment"><span class="hljs-comment">//MD5( +   +  ) . Zend_Controller_Front::getInstance()-&gt;getParam('bootstrap')-&gt;getOption('salt') . '"))' ); //  $adapter-&gt;setIdentity($params["email"]); //      Zend_Registry::get('authQuery') $adapter-&gt;setCredential($params["password"]); $auth = Zend_Auth::getInstance(); if ($auth-&gt;authenticate($adapter)-&gt;isValid()) //  { $id = $user-&gt;getCurrentUserId(); $secretKey = $user-&gt;generateSecretKey(); try { $device-&gt;userId = $id; $device-&gt;secretKey = $secretKey; $device-&gt;lastUsage = time(); $device-&gt;save(); } catch (Exception $e) { throw new Exception("Couldn't save with error ".$e); } $user-&gt;loadById($id); return array("secretKey" =&gt; $secretKey, "user" =&gt; array("email" =&gt; $user-&gt;{Application_Model_User::ATTRIBUTE_EMAIL}, "realName" =&gt; $user-&gt;{Application_Model_User::ATTRIBUTE_REALNAME}, "id" =&gt; $user-&gt;{Application_Model_User::ATTRIBUTE_ID})); } } return NULL; } public function signup (array $params) { //     $user = new Application_Model_User(); if ($user-&gt;findExistUserByEmail($params['email'])) { throw new Zend_Exception_UserAlreadyExist(); } $user-&gt;email = $params['email']; $user-&gt;realName = $params['username']; $user-&gt;passwordSalt = $user-&gt;generatePwdSalt(); $user-&gt;password = $user-&gt;generatePwd($params['password']); $user-&gt;save(); return $this-&gt;login($params); }</span></span></code> </pre><br></div></div><br>  As can be seen from the code, in the service, if necessary, the next level of data validation is performed, model objects are created, work is being done with their properties and methods. <br>  Next, consider an example of the model itself, which would describe our objects and their behavior. <br><br><div class="spoiler">  <b class="spoiler_title">Model class example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Model_Device</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Model_Abstract_AbstractModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ATTRIBUTE_ID = <span class="hljs-string"><span class="hljs-string">"id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ATTRIBUTE_USER_ID = <span class="hljs-string"><span class="hljs-string">"userId"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ATTRIBUTE_SECRET_KEY = <span class="hljs-string"><span class="hljs-string">"secretKey"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ATTRIBUTE_LAST_USAGE = <span class="hljs-string"><span class="hljs-string">"lastUsage"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_id, $_userId, $_secretKey, $_lastUsage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $options = null, $mapper = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// for future decorate if (is_null($mapper)) $this-&gt;_mapper = new Application_Model_DeviceMapper(); else $this-&gt;_mapper = $mapper; if (is_array($options)) { $this-&gt;setOptions($options); } } /** * Wrapper block */ public function fromProps() { return $data = array( self::ATTRIBUTE_USER_ID =&gt; $this-&gt;userId, self::ATTRIBUTE_SECRET_KEY =&gt; $this-&gt;secretKey, self::ATTRIBUTE_LAST_USAGE =&gt; $this-&gt;lastUsage, ); } /* * Start describe behaivors of object */ public function getDeviceByKey ($key) { return $this-&gt;_mapper-&gt;findByKey($key); } public function deleteByKey($key) { return $this-&gt;_mapper-&gt;deleteByCriteria('secretKey', $key); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">A more complex example of the model method</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Delete File in DB and unlink physical file * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($id)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Invalid id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $imageFile = UPLOAD_PATH.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;{<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ATTRIBUTE_REAL_NAME}; $thImageFile = THUMB_PATH.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;{<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ATTRIBUTE_TH_NAME}; <span class="hljs-comment"><span class="hljs-comment">//      $this-&gt;_mapper-&gt;deleteById($id); //    unlink($imageFile); unlink($thImageFile); }</span></span></code> </pre><br></div></div><br>  Thus, our immediate model includes the definition of metadata (object properties) and describes their behavior.  At the same time, the object's behavior is described at a rather abstract level and ends with a call to a specific method from the mapper, which is already responsible for interacting with the repository.  If you need to connect an additional data source, for example, tomorrow we decide to use an additional NoSQL database, or start using a cache, then it will be enough for us to decorate.  Once again I want to refer to the <a href="http://www.slideshare.net/weierophinney/playdoh-modelling-your-objects-1766001">presentation</a> , where all the advantages of this approach are very clearly demonstrated. <br>  Dive deeper. <br>  The next level in my implementation is mapper.  Its main purpose is to forward data or request from the model to the DAL level.  In other words, at this level we implement the Table Data Gateway pattern. <br><br><div class="spoiler">  <b class="spoiler_title">Mapper example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Model_DeviceMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Model_Abstract_AbstractMapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MODEL_TABLE = <span class="hljs-string"><span class="hljs-string">"Application_Model_DBTable_DeviceTable"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MODEL_CLASS = <span class="hljs-string"><span class="hljs-string">"Application_Model_Device"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get DBTable * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string $dbTable return current dbTable object */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDbTable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> === <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dbTable) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setDbTable(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MODEL_TABLE); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_dbTable; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application_Model_Device(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $data, $where)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// add a timestamp if (empty($data['updated'])) { $data['updated'] = time(); } return parent::update($data, $where); } /** * @param string $key * @throws Zend_Exception_Unauthtorize */ public function findByKey($key) { $result = $this-&gt;getDbTable()-&gt;fetchRow($this-&gt;getDbTable()-&gt;select()-&gt;where("secretKey = ?", $key)); if (0 == count($result)) { throw new Zend_Exception_Unauthtorize(); } return $result; } }</span></span></code> </pre><br></div></div><br>  As part of my task, I implemented only one mapper - working with MySql database, but already there is a task and a cache connection, and a potential thought to transfer a number of objects to NoSQL.  For me, this will only mean the need to decorate and write the minimum amount of code.  At the same time, tests will not have to be rewritten (except for writing new ones :)) <br>  As can be seen from the code, this mapper refers to the table class - DAL. <br>  For this layer, I did not invent anything new and used the standard classes that Zend provides. <br>  The class itself does not look very intricate: <br><br><div class="spoiler">  <b class="spoiler_title">Data Access Class (DAL Level)</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application_Model_DBTable_DeviceTable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Db_Table_Abstract</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_name = <span class="hljs-string"><span class="hljs-string">'deviceKey'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_primary = <span class="hljs-string"><span class="hljs-string">'id'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_referenceMap = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'Token'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'columns'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'userId'</span></span>, <span class="hljs-string"><span class="hljs-string">'refTableClass'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Application_Model_DBTable_UserTable'</span></span>, <span class="hljs-string"><span class="hljs-string">'refColumns'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'onDelete'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::CASCADE, <span class="hljs-string"><span class="hljs-string">'onUpdate'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::CASCADE, )); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_setAdapter(Zend_Db_Table::getDefaultAdapter()); <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct(); } }</code> </pre><br></div></div><br>  If you look into the Zend Framework manuals, it is easy to see that this (and only this level) is offered as an implementation model (see manuals + Quick Start). <br>  Additionally, I use abstract mapper methods and models, but their purpose, I hope, is obvious. <br>  In addition, I want to say that Zend_Db_Table returns values ‚Äã‚Äãeither in arrays or as an object of a corresponding type that does not correspond to the type of the object we need, from the context of which we call these methods. <br>  To bring data from data warehouses, as well as to validate them, we can use the methods specified at the model level (ORM). <br><br><h4>  Summary </h4><br>  With this article with enough code, I'm not trying to impose this approach on everyone, or say that you need to continue to use ZF1, and leave the second branch of the framework, more modern, for a brighter future.  Yes, we are evolving, growing and developing, but the general principles, including architectural ones, are always relevant, regardless of the tool used. <br><br>  At first glance, the solution I described above is more complex than that described in the manuals.  Inevitably, more objects are created and a deeper data is thrown inside. <br>  This, of course, cons. <br>  Now about the pros. <br><ul><li>  We get a more atomic code, which is more convenient to test, which means it will be easier to read, more qualitative and the probability of errors in it will be much less. </li><li>  Flexibility, extensibility.  To extend the functionality, you only need to decorate the existing code. </li><li>  The division of "areas of responsibility" between levels. </li></ul><br>  Each of us on a particular project decides for itself what architecture should be implemented.  I just described another option that works successfully and the number of advantages that far outweighs the number of minuses (I speak in the context of myself and my specific project).  <a href="http://stackoverflow.com/questions/1063664/zend-framework-orm-style-table-data-gateway-vs-extending-zend-db-table-abstract">Similar opinion</a> <br><br>  Hope this article with code examples was helpful to you. <br>  I will also be grateful for the criticism, advice and thanks. <br><br><h6>  PS </h6><br>  I understand that there is no perfect code and, almost always, you can do better. <br>  I also understand that third-party solutions can be used. <br>  And yes, I understand that there is ZF2, and it is better to start doing new projects on it. <br>  I also realize that there are other frameworks / programming languages ‚Äã‚Äãin which some things work faster / optimal / higher / stronger / look prettier and more. </div><p>Source: <a href="https://habr.com/ru/post/169537/">https://habr.com/ru/post/169537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169525/index.html">Fenom - yet another PHP template engine</a></li>
<li><a href="../169527/index.html">Again on the protection of personal data or preparing to check Roskomnadzor</a></li>
<li><a href="../169529/index.html">ASP.NET and client code compression</a></li>
<li><a href="../169533/index.html">Soap phone - sending notes from the phone to the "soap"</a></li>
<li><a href="../169535/index.html">Sports: If you do ...</a></li>
<li><a href="../169539/index.html">Consider a DAU track enough?</a></li>
<li><a href="../169543/index.html">Changes in AD Windows Server 2012. Part 2. Recycle AD, FGPP, gMSA, primary computers</a></li>
<li><a href="../169545/index.html">Meizu MX2 - subjective impressions after a month of use</a></li>
<li><a href="../169549/index.html">AzureHub.ru portal received an update: even more content, simplified structure</a></li>
<li><a href="../169553/index.html">The robot is made of gold. Vertu launches Android smartphone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>