<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bomberman Online and habra effect - 450 players on the same map. Report and details of the game engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised in the topic-announcement of our game , we post a report on the habraeffect and details of the game engine. 


 First of all, we want to t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bomberman Online and habra effect - 450 players on the same map. Report and details of the game engine</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/769/779/602/76977960285e4882989681e031ffba66.png"><br><br>  As promised in the <a href="http://habrahabr.ru/post/143699/">topic-announcement of</a> <b><a href="http://bombermine.ru/">our game</a></b> , we post a report on the habraeffect and details of the game engine. <br><a name="habracut"></a><br><br>  First of all, we want to thank everyone who participates (both with the game and with the practical suggestions and ideas) in our testing of the first and current versions of the engine and gameplay.  As practice has shown, <i>during the</i> habraeffekt bugs are and fix much faster :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h2>  Statistics for 3 weeks </h2><br>  Players registered: 4 663 <br>  Played rounds: 2 252 <br>  Number of players (including guests): 13 402 <br>  Number of frags: 469,534 <br>  Deaths: 545 957 <br>  Number of goals scored: 1,707 ( <a href="https://habr.com/ru/post/145505/">WTF</a> ?) <br><br>  <b>[during habraeffekta]</b> <br>  Online Players (Maximum): 453 <br>  CPU load (according to the munin schedule): 168% (16 cores - 1600%) <br>  Memory Usage: 1.65 GB <br>  Traffic (maximum): outgoing 24 Mbps |  incoming 9 Mbps <br><br>  <em>(The graphics are clickable)</em> <br><table><tbody><tr><td>  [Engine] Connections [ <a href="https://habr.com/ru/post/145505/">1</a> ] <br> <a href=""><img src="https://habrastorage.org/storage2/e66/674/410/e666744102175b75f430604e748ef15b.png"></a> <br></td><td>  [Engine] Main cycle time [ <a href="https://habr.com/ru/post/145505/">2</a> ] <br> <a href=""><img src="https://habrastorage.org/storage2/224/969/903/224969903be29ce4dd4ac90fe2d67ed5.png"></a> <br></td><td>  [Engine] Bytes per send [ <a href="https://habr.com/ru/post/145505/">3</a> ] <br> <a href=""><img src="https://habrastorage.org/storage2/a6e/021/e47/a6e021e479d973d94dee8f6f8c5b654d.png"></a> <br></td></tr><tr><td>  [Server] CPU usage <br> <a href=""><img src="https://habrastorage.org/storage2/fb8/ab9/36e/fb8ab936e0c1e99448367ab33c67240a.png"></a> <br></td><td>  [Server] Memory usage <br> <a href=""><img src="https://habrastorage.org/storage2/00a/0a4/9e9/00a0a49e92a3fc17f007f30c76b8f969.png"></a> <br></td></tr></tbody></table><br><h2>  TTX </h2><br>  Hosting: a dedicated server in the data center Vladimir (which courtesy of <a href="http://parking.ru/physical/dedic/">Parking.ru</a> for the time of habratestirovaniya) <br><br>  1. Java &amp; Jetty game engine <br>  2. HAProxy - proxying websockets <br>  3. Nginx - statics and proxying to the node <br>  4. Web functionality - Node.js (packages: express, mysql, request, nodemailer, validator, moment, forever) <br>  5. ClientSide - GWT, broadcast in javascript <br><br><br><h2>  Details of the game engine </h2><br>  <i>Next - from the face of <a href="http://habrahabr.ru/users/jedi_knight/" class="user_link">Jedi_Knight</a> (the author of the engine).</i> <br><blockquote>  Development of gaming applications on canvas is a promising direction in which many development teams are now moving, for example, the Estonian project <a href="http://mightyfingers.com/">mightyfingers.com</a> <br><br>  Some ideas are taken from the article <a href="http://www.html5rocks.com/en/tutorials/canvas/performance/">www.html5rocks.com/en/tutorials/canvas/performance</a> <br><br><h4>  HTML5 canvas Basics </h4><br>  Terminology: a tile is one square, for example 32 √ó 32;  chunk - 8 √ó 8 tiles. <br><br>  Consider the features of the tile engine.  Here is the model I came to: <br><br>  1) Subpixel drawing for tiles is simply not needed. <br><br>  2) Several transparent canvas-s located on top of each other are used.  If terrain was not modified, there was no scrolling, then you can not redraw it - this gives a small performance boost (compared to cache optimization). <br><br>  3) As in the game model, the whole field is divided into 8 √ó 8 chunks.  Since 64 drawImage calls for 32 √ó 32 images cost much more than a single call for 256 √ó 256, visible chunks are drawn into a cache consisting of two layers: under the player and above it. <br><br>  4) The cache is associative, that is, a pair of canvass is used by several chunks on the map: a chunk with coordinates (X, Y) uses a cache with coordinates (X mod A, Y mod B) where (A, B) is the cache size.  At the same time, cache sizes should be such that two chunks with a common cache do not appear on the screen at the same time, there will be a race. <br><br>  5) In addition to the canvass, cache numbers in the cache are stored in the cache, which are generated by the logical map.  By the number you can uniquely draw the tile. <br><br>  6) When changing the visible chunk, the corresponding object in the cache is marked as dirty, requiring redrawing.  At the same time, neighboring chunks can also be marked as dirty: you never know, suddenly a new shadow falls there, or there you have to draw a cut of the stone. <br><br>  7) In case if it is necessary to redraw a dirty or new chunk, the table 10 √ó 10 is put in the buffer and the surrounding tiles.  This buffer generates an array of tile numbers - it is already 8 √ó 8.  The tile number can also contain information about the shadow falling on this tile.  In those places where the tile number has changed since last, a redraw occurs. <br><br>  8) For tiles, it is more convenient to use not drawImage, but createPattern and fillRect.  fillRect is also more convenient because they can draw several identical tiles in a row, and this will be faster. <br>  This test reveals a strange effect: that for textures 32 √ó 32 there is a significant performance increase on the iPad 2.5 times: <br>  <a href="http://jsperf.com/canvas-texture-draw-vs-fill">jsperf.com/canvas-texture-draw-vs-fill</a> <br>  <a href="http://habrahabr.ru/post/145505/">Comments</a> with the addition of <a href="http://habrahabr.ru/users/theshock/" class="user_link">TheShock</a> <br><br><img src="https://habrastorage.org/storage2/eaa/bb0/eab/eaabb0eab39387260958df3219fe26e4.png" align="left">  9) And finally, why all this is necessary: ‚Äã‚Äãwhen scrolling instead of drawing a heap of small images 32 √ó 32, drawing from the cache takes place.  The drawImage call is much smaller, it seriously affects performance. <br><br>  Green, yellow, shadows - are drawn on the first layer, each 32 √ó 32 square can be drawn independently of the others, since the tile number contains information about the substrate, wall and shadow. <br>  The second layer is drawn in red, it is shifted 8 pixels up. <br><br><br><br><br><h4>  Found bugs </h4><br>  So, during the collective testing the following problems were discovered: <br><br>  1) On a large map of a certain size, the tile cache suddenly started up, which led to wild brakes that only chrome could handle.  The whole thing was in the periodic map: the card sizes (W, H) should be divided by the cache sizes (A, B). <br><br><img src="https://habrastorage.org/storage2/f6a/f82/8cc/f6af828ccd628d430deaac0a85412893.png"><br><br>  Let W, H = 7 A, B = 3, corner chunks fall on one cache position, and on a periodic map they fall on one screen, which leads to a race.  The same situation is observed throughout the ‚Äúseam‚Äù of the card. <br><br>  2) Client profiling revealed bottlenecks in code using java-collections.  In these places, the collections are replaced by samopisnye structures. <br><br>  3) Changing the network protocol and switching from utf8 to binary web-sites in those browsers where they are supported (Chrome, Firefox) allowed reducing the average client traffic to 12 Kbps.  The native ArrayBuffer is used, I note that Firefox does not implement the DataView class, so we manage with the usual Uint8Array. <br><br><br><h4>  The graphs at the beginning of the article show: </h4><br><a name="g1"></a>  [1] <b>Connections</b> - the number of active connections to the server. <br><br><a name="g2"></a>  [2] <b>Main cycle time</b> - how long the different stages of the main cycle occupy.  Tick ‚Äã‚Äãlasts 100ms, preprocess - checking commands from clients, tick - update game state, Observers - forming messages for clients.  Total - all together, plus the time it takes for messages to go to the network buffer.  It is measured in milliseconds within one second, so that when Total approaches the 1000 server badly, overhead starts to appear. <br><br><a name="g3"></a>  [3] <b>Bytes per send</b> ‚Äî net traffic sent to clients, without websocket frame headers, in bytes / sec. <br><br><br><a name="football"></a><h4>  Gameplay Changes </h4><br><img src="https://habrastorage.org/storage2/fd9/344/fd5/fd9344fd59ee8a7ae7f24683fdefe694.png" align="left">  Almost all the time it took to accelerate the engine, client and network protocol.  Serious work was done on optimization and refactoring, eliminated a lot of bugs. <br><br>  But I managed to do a little more by the gameplay: it became easier to lock up the enemy.  But most importantly - added a ball and gate!  Those who score receive a rescue shield.  Particularly agile collect 3 shields and run like superheroes :) <br></blockquote><br><br><br><h2>  New load habratesting.  The goal is 1000 players online on a single card. </h2><br>  For the first time, the server without problems and lags kept 350 players online.  Today it is ready for 1000. <br><br>  We invite everyone <b>on June 8, 9 and 10, from 17 to 22</b> to try to achieve a new bar of players online.  <b><a href="http://bombermine.ru/">Join us</a></b> , call friends / colleagues - we are waiting for you! <br>  <i>(if someone doesn‚Äôt have a domain, go directly: <a href="http://141.101.245.117/">141.101.245.117</a> - not everyone has updated their dns after the move)</i> <br><br>  Especially for habrayusers, we have prepared a <a href="http://bombermine.ru/habraeffect/">Habramonitor</a> , which shows graphs of the current load on the engine and server (with an interval of 5 minutes). <br><br><img src="https://habrastorage.org/storage2/6ed/879/926/6ed8799269954cadfddb70a7b714bdea.png">  <i>And may the Force and the Fan be with you.</i> </div><p>Source: <a href="https://habr.com/ru/post/145505/">https://habr.com/ru/post/145505/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145497/index.html">What means to provide responsive images should you use?</a></li>
<li><a href="../145498/index.html">Facebook has opened the App Center application directory</a></li>
<li><a href="../145499/index.html">We start Tomcat on OpenShift</a></li>
<li><a href="../145500/index.html">SurfPatrol. Test interface?</a></li>
<li><a href="../145504/index.html">Data Centers: Intel's Point of View</a></li>
<li><a href="../145506/index.html">.toster: Javascript supportato!</a></li>
<li><a href="../145507/index.html">What types of HTML5 input do you use?</a></li>
<li><a href="../145508/index.html">How to simplify work with the printing device</a></li>
<li><a href="../145510/index.html">7 myths about programming</a></li>
<li><a href="../145511/index.html">What awaits us in Joomla 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>