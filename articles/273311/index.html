<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NW + Edge.js + Fiddler or a tale about the dockability of the untangible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all. 
 Not so long ago, read the article What we should parse the site. Basics webdriver API and remembered that he had long been going to br...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NW + Edge.js + Fiddler or a tale about the dockability of the untangible</h1><div class="post__text post__text-html js-mediator-article">  Hello to all. <br>  Not so long ago, read the article <a href="http://habrahabr.ru/post/272105/">What we should parse the site.</a>  <a href="http://habrahabr.ru/post/272105/">Basics webdriver API</a> and remembered that he had long been going to bring at least one relatively funny idea to a relatively working state.  Hands still reached, which means it's time to tell what happened. <br>  There is such a great program - Fiddler, which allows you to intercept and modify http / https requests.  There is a wonderful thing called NW.js, also known as node-webkit, which allows you to ... parse various sites as well.  You are beautiful, I am beautiful - why don't we make friends? <br>  Actually, the idea is this: one could, of course, raise Fiddler separately, write logic in it and drive traffic through it from node-webkit-but this is not so interesting.  So, we will combine everything under the same roof, the benefit of Fiddler is a library in C # - FiddlerCore. <br>  Under the node there is an excellent module - <a href="https://github.com/tjanczuk/edge">Edge.js.</a>  This is such a tricky thing that allows you to execute C # code (and not only).  Is there a node?  Remarkably, you can get it under nw.js, there is even a manual ‚Äî <a href="https://github.com/frankhale/nw-edge-example">yes, there it is</a> ! <br><br><a name="habracut"></a><br>  So, let's skip a couple of hours of sekas for building this wonderful library (how many times to speak to yourself, read the manuals carefully! We need 13 studios, not 12 and not 15!) And get down to writing the code.  I will not dwell on the connection and loading of modules either, suppose that those who are interested in this article know how to read manuals (yes, I understood, I understood that manuals should be read carefully!). <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//#r "System.Windows.Forms.dll" //#r "fiddler/FiddlerCore.dll" using Fiddler; using System; using System.Windows.Forms; using System.Collections.Generic; using System.IO; using System.Net; using System.Threading; using System.Threading.Tasks; public class Startup { Func&lt;object, Task&lt;object&gt;&gt; _console; Func&lt;object, Task&lt;object&gt;&gt; _html; public async void _print(object text){ if(_console!=null) await _console(text); } public async void _getHtml(object html) { if (_html != null) await _html(html); } public async Task&lt;object&gt; Invoke(dynamic data) { _console = (Func&lt;object, Task&lt;object&gt;&gt;)data.console; _html = (Func&lt;object, Task&lt;object&gt;&gt;)data._html; _print("Started"); FiddlerApplication.Shutdown(); new FiddlerLogic { _beforeRequest = (oS) =&gt; { var proxy = oS.oRequest.headers["POverride"]; if (proxy != null) { oS["X-OverrideGateway"] = proxy; } }, _beforeResponse = (oS) =&gt; { var response = oS.GetResponseBodyAsString(); _html(response); } }._start(5000); return Task.FromResult("Done"); } } class FiddlerLogic { public Action&lt;Session&gt; _beforeRequest; public Action&lt;Session&gt; _beforeResponse; public void _start(int port=5555) { FiddlerApplication.BeforeRequest += (oS) =&gt; _beforeRequest(oS); FiddlerApplication.BeforeResponse += (oS) =&gt; _beforeResponse(oS); FiddlerApplication.Startup(port, false, true); } }</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So what happens here? <br>  These are the 2 lines here. <br>  // # r "System.Windows.Forms.dll" <br>  // # r "fiddler / FiddlerCore.dll" <br><br>  are a marker for edge.js, needed to connect libraries. <br>  The FiddlerLogic class is just a small wrapper over Fiddler, in which there was a code for connecting certificates, but then with the help of some street magic (most likely, I found the old version in the zagashnik, which did not require this) .  Now, this class, in fact, does not do anything special, but where now without legacy code?  Actually, in the constructor of the object, we specify 2 callbacks that will be called before / after sending the request, the port (if necessary) and that's it. <br>  Oh yes, in the FiddlerApplication.Startup 2 and 3 arguments are responsible for using the system proxy / intercept https requests, respectively.  Since I would like to intercept https-requests and see if you do not need to use the system proxy, the values ‚Äã‚Äãare false and true. <br><br>  Now about Startup.  This is such a fun class needed to work with edge.js (more on this module later).  Actually, Invoke is an entry point, console / _html - functions from js.  FiddlerApplication.Shutdown () is responsible for completing all previous fiddler instances.  In _beforeRequest, the proxy is changed when there is a POverride header in the request.  In _beforeResponse, nothing very useful happens, left for example.  The _print and _getHtml functions are simply wrappers that check for functions passed from js. <br><br>  Now consider the js part. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> edge = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'edge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gui = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'nw.gui'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'async'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'request'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr=[]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count=<span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prev=<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> proxyList = [<span class="hljs-string"><span class="hljs-string">'160.92.56.41:80'</span></span>]; _init(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;count; i++){ arr.push(<span class="hljs-string"><span class="hljs-string">'http://myip.ru/index_small.php'</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _node=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, c</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(url); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'POverride'</span></span>: proxyList[<span class="hljs-number"><span class="hljs-number">0</span></span>] } }; request(options, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, response, html</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j=_html(html); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Container:'</span></span>, j.find(<span class="hljs-string"><span class="hljs-string">'.network-info tbody&gt;:nth-child(2) td'</span></span>).text()); c(); }); }; <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>.map(arr, _node, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ms=<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now()-start; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(<span class="hljs-string"><span class="hljs-string">'Node parse got %f seconds. Mid time: %f. Mid page per second: %f'</span></span>, ms/<span class="hljs-number"><span class="hljs-number">1000</span></span>, ms/count, count*<span class="hljs-number"><span class="hljs-number">1000</span></span>/ms); } ); <span class="hljs-comment"><span class="hljs-comment">/***DEFINITIONS***/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_html</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $(<span class="hljs-string"><span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span></span>).html(html); }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ request=request.defaults({<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>:<span class="hljs-string"><span class="hljs-string">'http://localhost:5000'</span></span>}); gui.App.setProxyConfig(<span class="hljs-string"><span class="hljs-string">"http://localhost:5000"</span></span>); func = edge.func(<span class="hljs-string"><span class="hljs-string">"fiddler/Main.cs"</span></span>); func({ <span class="hljs-attr"><span class="hljs-attr">console</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(data); }, <span class="hljs-attr"><span class="hljs-attr">_html</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html, callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var container=_html(html); //console.log('Container:', container, container.find('.network-info tbody&gt;:nth-child(2) td')); } }); } catch(ex){ console.log(ex); } };</span></span></code> </pre><br><br>  First of all, you should pay attention to 2 functions from below - _html and _init.  The first deals with obscenity in the form of building a DOM from a string, 2 - the basic settings and the connection of C # code. <br>  Edge.func loads the contents of Main.cs (see the code above), and passes the arguments to the necessary functions as arguments.  Actually, the function argument func is the data from public async Task </div><p>Source: <a href="https://habr.com/ru/post/273311/">https://habr.com/ru/post/273311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273295/index.html">How to create software for a microtomograph for 5233 man-hours</a></li>
<li><a href="../273299/index.html">Unity's demo project The Blacksmith</a></li>
<li><a href="../273301/index.html">War, peace and ABBYY Compreno: the continuation of our affair with Tolstoy</a></li>
<li><a href="../273305/index.html">Evolution of data structures in Yandex. Metric</a></li>
<li><a href="../273307/index.html">Digital Data Layer - the heart of your tag-management system</a></li>
<li><a href="../273313/index.html">Predreliznoe testing has unexpectedly epic proportions</a></li>
<li><a href="../273319/index.html">Star Wars Universe Social Network</a></li>
<li><a href="../273323/index.html">Vivaldi Beta 2 browser release</a></li>
<li><a href="../273325/index.html">Santa Claus asks a question. Contest for Intel Blog Readers</a></li>
<li><a href="../273327/index.html">"War and Peace" - the test of time</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>