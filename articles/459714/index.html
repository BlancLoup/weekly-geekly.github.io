<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virtual machine on ESP8266 to run games</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VM, written by the uncertain hand of the humanities in the Arduino programming environment using bydlokod and bicycles. And then there is a compiler f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virtual machine on ESP8266 to run games</h1><div class="post__text post__text-html js-mediator-article">  VM, written by the uncertain hand of the humanities in the Arduino programming environment using bydlokod and bicycles.  And then there is a compiler for it from a C-like language, written in JavaScript using the same methods.  Yes.  You can already hurry in the comments, throwing stones.  Well, those who are still interested, I invite you to continue reading. <br><br><img src="https://habrastorage.org/webt/id/lf/6y/idlf6yqnyzplrex2cq3waeu0txc.png" alt="Trolleybus from the loaf"><br><a name="habracut"></a><br>  In general, my hand-made article was already a little illuminated by a respected <a href="https://habr.com/ru/users/tormozedison/" class="user_link">tormozedison</a> <a href="https://habr.com/ru/post/443918/">here</a> .  But at that time there was more likely a spherical prototype in a vacuum.  And now I have a device for the work of the RomanS, which he graciously provided me for the experiments completely free of charge.  This device is called ESPboy.  It differs from other handicrafts in compactness and expansion slot, using the chip MCP23017.  <a href="https://hackaday.io/project/164830-espboy-beyond-the-games-platform-with-wifi">Here</a> you can learn more about it. <br><br>  If anyone is interested in how I even had such a strange thought, like a virtual machine on a microcontroller, I can read it under the spoiler. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Prehistory</b> <div class="spoiler_text">  Once at school, I became interested in gamer from yoyogeyms, and, like many, riveted on him, do not understand what.  These crookedly written and poorly drawn demos could still boast to friends, but on the Internet they sank among similar ones.  I realized how hard it is to write even a simple game, let alone a serious one, in which it would be possible to rob the cows.  But the desire to write games is not lost.  When I got a mobile phone, I discovered Midlet Pascal and had fun with it for several years.  After all, I understood that writing a game for a weak device is easier than for its more powerful big brother.  At least, one could always speak not about curved hands, but about the limited capabilities of the platform.  However, the buttons were replaced by sensors. Another chance to conquer the world was missed.  Yet, at some point, I realized that I could revive my dreams using a microcontroller. <br><br>  I began by writing a game under the Arduino Uno, where without it.  Then she was my only one, and I was very worried about her performance.  I tried to flash as little as possible.  But the path of the rake goes in small steps.  Each small editing of the code made it necessary to flash again and again.  And I decided to write a stack virtual machine.  After all, onboard is a huge two kilobytes of RAM for code and data bytes.  But how slow she was, but for some reason she constantly lacked memory.  Probably, the thing is that all my bikes were with square wheels and drove slowly.  Then I decided to write a chip-8 emulator on the Arduino mega just come from China.  Of course, then I wanted to write for her the gameboy emulator, the first playback and some supercomputer easier.  As a result, I realized the main thing.  The chip-8 virtual machine was very simple, overly simple.  So much so that when writing my multiplication or division games you had to write a separate slow subroutine.  So you need to write your VM, getting rid of the fatal flaw.  At this time, several esp8266 arrived, with their space 160MHz. <br></div></div><br>  If it seems to you that the virtual machine is a waste of resources, then I also rewrote my chip-8 emulator for it.  It turned out a virtual machine in a virtual machine on a microcontroller.  Perhaps you can go further and write a turing machine on chip-8. <br><br><h4>  Technical characteristics of ESP Little Game Engine </h4><br>  The virtual machine contains 16 registers of 16 bits each, the null register is a stack pointer.  Each instruction is two-byte, some instructions contain two bytes of data after themselves.  64KB addressable memory.  In the case of the ESP8266, 20KB is available.  The program can be downloaded from SPIFFS and UART.  If desired, you can add a download from a memory card or via WiFi.  In addition to the usual arithmetic instructions and instructions for moving data, there are separate instructions for working with sprites, screen and sound.  The screen size is 128 by 128 pixels.  With 16 colors per pixel, the screen takes up 8KB of memory, and as many takes up the buffer for drawing sprites and particles.  Although the TFT_eSPI library used by me is capable of updating the screen more than 60 times per second, I had to limit myself to 20 frames per second.  Otherwise, there was not enough CPU time for the virtual machine.  You can draw tiles and 32 sprites up to 128x128 pixels in size with the possibility of rotation and mirroring.  To save memory, you can use single-bit images or RLE compression.  There is a simplified physics: collision detection sprites with sprites and tiles, collision resolution, gravity.  The screen is updated line by line only if the line has a pixel change.  The speed of a VM, depending on how many lines are drawn in a frame, varies from 100 thousand to 900 thousand operations per second.  You can use different color screens, there is a soft stretching of the image to the desired proportions. <br><br><img src="https://habrastorage.org/webt/jf/ai/mv/jfaimvgh6rbtnum5u-lpdsslpws.png"><br>  <i>Some of the games written by me, you can see <a href="https://corax89.github.io/esp8266Game/gamelist/index.html">here</a> .</i> <br><br>  Along with the VM for ESP8266, I wrote a JavaScript emulator for the browser.  In order not to edit the bytecode manually, a simple assembler was added, based on my experience with the assembler for MOS6502.  Then I decided to add a higher level language.  Yet my main task was to quickly write simple games, and not long debugging of the assembler code.  It seemed to me that it would be simpler to write the compiler, than to add LLVM.  And I wrote it in JavaScript, because I know it not as bad as other languages.  At the moment, it‚Äôs far from supporting C standards and when compiling it is easy to face an incomprehensible error in an incomprehensible place.  But he is fast, because it takes less than 2000 lines. <br><br>  And now to the question, why did I even write all this here?  Already, you can write and run games.  However, perfection is still far away.  If anyone wants to help me in the finalization of ESP LGE, or write my own game, then I will be very happy.  If you thought my idea was interesting, and you want to learn more, then I will be happy to answer your questions.  I warn you, the code for the Arduino is quite difficult to read.  Partly because I'm self-taught.  Partly due to the fact that I tried to reduce the number of function calls, to increase the speed of work.  As a result, many features contain huge footcloths code.  So do not let go of the screen for pregnant women and children.  Gradually, I will try to fix it and improve readability. <br><br>  And for those who read, an example of the game.  It takes less than one hundred lines and less than 1KB in compiled form. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stickCount; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> key,previouseKey,takenSticks; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-comment"><span class="hljs-comment">//   setcolor(2); //   for(i = 0; i &lt; stickCount; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //   setcolor(11); //  for(i = stickCount; i &lt; 15; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //     setcolor(1); //   delayredraw(); } void playersMove(){ //    ,     .  while(key == previouseKey){ key = getkey(); } while(key != KEY_LEFT &amp;&amp; key != KEY_DOWN &amp;&amp; key != KEY_RIGHT){ key = getkey(); } if(key &amp; KEY_LEFT){ takenSticks = 1; }else if(key &amp; KEY_DOWN){ takenSticks = 2; }else{ takenSticks = 3; } printf("%d, ", takenSticks); stickCount -= takenSticks; previouseKey = key; } void computersMove(){ if(stickCount % 4){ //   ,    takenSticks = stickCount % 4; }else{ //      takenSticks = 1 + random(1); } stickCount -= takenSticks; printf("%d, ", takenSticks); } void game(){ // stickCount = 15; clearscreen(); //       gotoxy(8,0); puts(""); gotoxy(2,1); puts(" 1,2  3 .  ,   . :\n"); // 27,25  26   printf(" %c 1 %c 2 %c 3", 27, 25, 26); gotoxy(0,12); redraw(); while(1){ playersMove(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } redraw(); computersMove(); redraw(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } } } void main(){ while(1){ game(); //  settimer(1,1000); while(gettimer(1)){} while(getkey() == 0){} previouseKey = key; } }</span></span></code> </pre> <br>  You can immediately and <a href="https://corax89.github.io/esp8266Game/index.html%3Fsrc%3D6ca18ff8b2718c059d07c93374145d36">test</a> .  Follow the link, then click compile, then run.  If you want to learn more about the possibilities of IDE you can read the <a href="https://corax89.github.io/esp8266Game/user_guide/index.html">tutorial</a> .  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/459714/">https://habr.com/ru/post/459714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../4597/index.html">Dancing Belarusian became a star of YouTube</a></li>
<li><a href="../459706/index.html">5 reasons why you should forget about Redux in React apps</a></li>
<li><a href="../459708/index.html">Design game interfaces. Brent Fox. What is this book about?</a></li>
<li><a href="../459710/index.html">Survive in a head-on collision, and why amnesia is not what you think</a></li>
<li><a href="../459712/index.html">"Mommies hackers" in official work: what do pentesters do</a></li>
<li><a href="../459716/index.html">Some aspects of optimizing LINQ queries in C # .NET for MS SQL Server</a></li>
<li><a href="../459718/index.html">10 tips to review a code that you don‚Äôt like</a></li>
<li><a href="../459726/index.html">7 pieces that just do not need to do when opening a circle of robotics. That does not have to do</a></li>
<li><a href="../459728/index.html">Smart phone with a breeze: a review of ZTE Red Magic 3</a></li>
<li><a href="../459730/index.html">Porting Qt to STM32</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>