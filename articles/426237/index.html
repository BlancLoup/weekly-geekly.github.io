<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to determine the minimum size required for a DFSR replication staging folder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[Approx. translator. The material of the article refers to Windows Server 2003 / 2003R2 / 2008 / 2008R2, but most of the above is true for later versi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to determine the minimum size required for a DFSR replication staging folder</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/post/426237/"><img src="https://habrastorage.org/webt/hz/tz/cl/hztzclkzrasylrgmbibfkje-wgk.jpeg"></a> <br><br>  <i>[Approx.</i>  <i>translator.</i>  <i>The material of the article refers to Windows Server 2003 / 2003R2 / 2008 / 2008R2, but most of the above is true for later versions of the OS]</i> <br><br>  <a href="https://blogs.technet.microsoft.com/b/askds/archive/tags/warren%2Bwilliams/">Warren</a> is here again.  This article is a quick reference guide on how to correctly calculate the minimum size of an intermediate folder required for normal DFSR operation.  Setting lower values ‚Äã‚Äãmay slow down replication or even stop it.  Keep in mind that these are only <i>minimal values</i> .  When deciding on the size of the intermediate folder, remember the following: the larger the size of the intermediate folder, the better, up to the size of the replicated folder itself.  For more information on how important it is to use the correct size of the intermediate folder, refer to the section ‚ÄúHow to determine if you have a problem with the intermediate folder‚Äù and posts from blogs, links to which are located at the end of this article. <br><a name="habracut"></a><br>  <b>Update:</b> Warren really knows how to convince!  Now there is a fix with which you can calculate the size of the intermediate folder. <br>  <a href="https://support.microsoft.com/kb/2607047">https://support.microsoft.com/kb/2607047</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Rules of thumb </h2><br>  <b>Windows Server 2003 R2</b> - the quota for the staging folder should be the same as the total size of the 9 largest files in the replicated folder. <br><br>  <b>Windows Server 2008 and 2008 R2</b> - the quota of the staging folder should be the same as the total size of the 32 largest files in the replicated folder <i>[Approx.</i>  <i>translator.</i>  <i>This number is also <a href="">valid</a> for Windows Server 2012 / 2012R2]</i> <br><br>  Primary replication uses much more space in the staging folder than regular daily replication.  If the size of disk space allows, it is strongly recommended to set a size larger than the required minimum before starting replication. <br><br><h2>  Where to get PowerShell? </h2><br>  PowerShell is included with Windows 2008 and above.  On Windows Server 2003, you will have to install it.  Download PowerShell for Windows 2003 <a href="https://support.microsoft.com/ru-ru/help/968930/windows-management-framework-core-package-windows-powershell-2-0-and-w">here</a> . <br><br><h2>  How to find these biggest files? </h2><br>  Use the PowerShell script to find the 32 or 9 largest files and determine how many gigabytes they occupy (thanks to Ned Pyle for the PowerShell commands).  I want to introduce you to three PowerShell scripts.  Each of them is useful in its own way, however, the 3rd is the most useful. <br><br><ol><li>  Run: <br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ChildItem c:\<span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> -recurse | Sort-<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> length -descending | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> -first <span class="hljs-number"><span class="hljs-number">32</span></span> | ft <span class="hljs-type"><span class="hljs-type">name</span></span>,length -wrap -auto</code> </pre> <br>  This command returns file names and their size in bytes.  Useful to find out which 32 files are the largest in the replicated folder, and visit their owners. <br></li><li>  Run: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ChildItem c:\<span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> -recurse | Sort-<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> length -descending | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> -first <span class="hljs-number"><span class="hljs-number">32</span></span> | measure-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> -property length ‚Äìsum</code> </pre><br>  This command returns the total number of bytes for the 32 largest files in a folder without specifying their names. <br></li><li>  Run: <br><br><pre> <code class="hljs sql">$big32 = Get-ChildItem c:\temp -recurse | Sort-Object length -descending | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> | measure-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> -property <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> ‚Äì<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> $big32.sum /<span class="hljs-number"><span class="hljs-number">1</span></span>gb</code> </pre><br>  This command gets the total number of bytes for the 32 largest files in a folder and converts them into gigabytes using mathematical calculations.  This command consists of two separate lines.  You can insert them at once into the PowerShell command shell, or run them one at a time. <br></li></ol><br><h2>  Manual analysis </h2><br>  To demonstrate the process and, if possible, deepen the understanding of what we are doing, go through each operation and do it manually. <br><br>  The 1st running command will return results similar to those shown below.  For brevity, in this example only 16 files are taken.  Always take into account 32 files for Windows 2008 and later operating systems and 9 for Windows 2003 R2. <br><br>  Sample data returned to PowerShell: <br><table><tbody><tr><th>  Name </th><th>  Length </th></tr><tr><td>  File5.zip </td><td>  10286089216 </td></tr><tr><td>  archive.zip </td><td>  6029853696 </td></tr><tr><td>  BACKUP.zip </td><td>  5751522304 </td></tr><tr><td>  file9.zip </td><td>  5472683008 </td></tr><tr><td>  MENTOS.zip </td><td>  5241586688 </td></tr><tr><td>  File7.zip </td><td>  4321264640 </td></tr><tr><td>  file2.zip </td><td>  4176765952 </td></tr><tr><td>  frd2.zip </td><td>  4176765952 </td></tr><tr><td>  BACKUP.zip </td><td>  4078994432 </td></tr><tr><td>  File44.zip </td><td>  4058424320 </td></tr><tr><td>  file11.zip </td><td>  3858056192 </td></tr><tr><td>  Backup2.zip </td><td>  3815138304 </td></tr><tr><td>  BACKUP3.zip </td><td>  3815138304 </td></tr><tr><td>  Current.zip </td><td>  3576931328 </td></tr><tr><td>  Backup8.zip </td><td>  3307488256 </td></tr><tr><td>  File999.zip </td><td>  3274982400 </td></tr></tbody></table><br>  How to use this data to determine the minimum size of an intermediate folder: <br><ul><li>  Name = file name </li><li>  Length = size in bytes </li><li>  One gigabyte = 1073741824 bytes </li></ul><br>  First you need to count the total number of bytes.  Then divide the resulting number by 1073741824. I recommend that you use Excel for these calculations, or another spreadsheet editor that you use. <br><br>  <b>Calculations based on an example</b> <br><br>  In the example above, the total number of bytes is 75241684992. To get the minimum required size of the intermediate quota, you need to divide 75241684992 by 1073741824. <br><br>  75241684992/1073741824 = 70.07 (GB) <br><br>  Based on the data, I would set the size of the intermediate folder to 71 GB, rounded up to the nearest whole number. <br><br><h2>  Practical use </h2><br>  Despite the fact that manual analysis is an interesting thing, it is not the best thing you can spend your time on.  To automate the process, use the 3rd command from the examples above.  The results will be something like this: <br><br><img src="https://habrastorage.org/webt/sv/jo/6w/svjo6w9wvcvphmzmcn1ox7ezhei.png"><br><br>  Using the command from the 3rd example, you can, without any calculations (not counting rounding), determine that the d: \ docs folder requires an intermediate quota of 6GB in size. <br><br><h2>  Do I need to restart the server or restart the service to apply the changes? </h2><br>  You do not need to restart the server or restart the service in order for the changes to be made to the quota of the intermediate folder to take effect.  To apply the changes, you will need to wait for the AD replication to complete and the polling cycle for DFSR objects in AD. <br><br><h2>  How to identify problems with intermediate folder </h2><br>  Problems with the staging folder are detected by tracking specific event codes in the DFSR server logs.  Here is a list of these events: 4202, 4204, 4206, 4208 and 4212. Descriptions for them are presented below.  It is important to understand the difference between events 4202 and 4204, as well as other events.  Events 4202 and 4204 can be recorded in large numbers and during normal operation.  Think of events 4202 and 4204 as something like the presence of a pulse, whereas 4206, 4208 and 4212 will be akin to chest pain.  Below I will explain how to interpret events 4202 and 4204. <br><br>  <b>Events related to the intermediate folder</b> <br><br>  <i>[Approx.</i>  <i>translator.</i>  <i>The log events described below are presented in the form in which they are present in the Russian localization of Windows Server 2012 R2.]</i> <br><br>  Code: <b>4202</b> <br>  Level: <b><font color="orange">Warning</font></b> <br>  DFS Replication Service found that the staging space used by the replicated folder with the local path &lt;path&gt; exceeded its upper limit.  The service will attempt to delete the oldest intermediate files.  This may affect performance. <br><br>  Code: <b>4204</b> <br>  Level: <b><font color="green">Information</font></b> <br>  DFS Replication Service successfully deleted the old intermediate files of the replicated folder with the local path &lt;path&gt;.  The intermediate space is now below the upper limit. <br><br>  Code: <b>4206</b> <br>  Level: <b><font color="indianred">Warning</font></b> <br>  DFS Replication Service was unable to clear the old intermediate files for the replicated folder in the local path &lt;path&gt;.  The service may not be able to replicate some large files and the replicated folder may become out of sync.  The service will automatically attempt to re-clean the intermediate space for &lt;X&gt; minutes.  The service may start cleaning earlier if it detects that some intermediate files have been unlocked. <br><br>  Code: <b>4208</b> <br>  Level: <b><font color="indianred">Warning</font></b> <br>  DFS Replication Service has detected that the use of staging space has exceeded the quota limit of the replicated folder in the local path &lt;path&gt;.  replicate some large files and the replicated folder may become out of sync.  The service will automatically attempt to re-purge the staging space. <br><br>  Code: <b>4212</b> <br>  Level: <b><font color="red">Error</font></b> <br>  DFS Replication Service could not replicate a replicated folder with a local path &lt;path&gt;, because the intermediate path is invalid or inaccessible. <br><br><h2>  What is the difference between events 4202 and 4208? </h2><br>  Events 4202 and 4208 have a similar description, i.e.  DFSR detects that the size occupied by the intermediate folder exceeds the limit.  The difference is that event 4202 is registered immediately after the cleaning process of the intermediate folder starts, while the intermediate quota is still exceeded.  Event 4202 is a sign of normal full-time work, while 4208 indicates a deviation from the norm and requires intervention. <br><br><h2>  How many 4202 and 4204 events are considered too large? </h2><br>  This question has no definite answer.  In contrast to the events 4206, 4208 and 4212, which always speak about the bad and indicate the need for action, the events 4202 and 4204 also occur during normal operation.  Frequent events 4202 and 4204 <i>may</i> indicate a problem.  Facts to consider: <br><br><ol><li>  Are events 4202 registered for a replicable folder (RF) during its primary replication?  If so, then events 4202 and 4204 are normal.  If during the initial synchronization you want to reduce the number of these events to a minimum, then this can be achieved by increasing the size of the intermediate folder. </li><li>  Just counting the total number of events 4202 is not enough.  You need to know how many of them apply to a particular RF.  If there were twenty 4202 events related to one folder in 24 hours, this is a lot.  But if you have 20 replicated folders and one event for each of them, then everything is fine. </li><li>  To identify trends, it is necessary to analyze the information collected over several days. </li></ol><br>  I usually advise customers to allow no more than one event 4202 per replicated folder during the day during normal operation.  ‚ÄúNormal‚Äù means that primary replication does not occur.  I justify this by the following reasoning: <br><br><ol><li>  The time spent clearing the intermediate folder is the time taken from file replication.  Replication is suspended while the intermediate folder is being cleared. </li><li>  DFSR works more efficiently if enough space is allocated for the intermediate one, using it for <a href="https://blogs.technet.microsoft.com/b/askds/archive/2010/08/20/friday-mail-sack-scooter-edition.aspx">RDC and cross-file RDC</a> , as well as for replicating identical files to other replication members. </li><li>  The more events 4202 and 4204 are logged, the more likely you are to encounter a situation where DFSR will not be able to clear the intermediate folder or will be forced to delete files from it prematurely. </li><li>  In my experience, events 4206, 4208 and 4212 have always been anticipated and accompanied by a large number of events 4202 and 4204. </li></ol><br>  Following the rule of ‚Äúno more than one event 4202 per day per each RF‚Äù will significantly reduce the likelihood of problems with the intermediate folder and help the DFSR server more efficiently use resources for a specific purpose - file replication. <br><br><h2>  Additional Information </h2><br>  <a href="https://blogs.technet.com/b/askds/archive/2010/03/31/tuning-replication-performance-in-dfsr-especially-on-win2008-r2.aspx">https://blogs.technet.com/b/askds/archive/2010/03/31/tuning-replication-performance-in-dfsr-especially-on-win2008-r2.aspx</a> <br>  <a href="https://blogs.technet.com/b/askds/archive/2007/10/05/top-10-common-causes-of-slow-replication-with-dfsr.aspx">https://blogs.technet.com/b/askds/archive/2007/10/05/top-10-common-causes-of-slow-replication-with-dfsr.aspx</a> <br><br>  Warren ‚ÄúWay over my Oud quota‚Äù Williams </div><p>Source: <a href="https://habr.com/ru/post/426237/">https://habr.com/ru/post/426237/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426227/index.html">How to farm Kaggle</a></li>
<li><a href="../426229/index.html">Code of Conduct: why Linux kernel developers threatened to delete their code - we understand the conflict</a></li>
<li><a href="../426231/index.html">Britain wants to regulate the Internet - what will affect the new laws</a></li>
<li><a href="../426233/index.html">Study: large wind power stations can heat up the soil, which affects climate</a></li>
<li><a href="../426235/index.html">Fiasco. The story of one homemade IoT</a></li>
<li><a href="../426241/index.html">Conference BLACK HAT USA. A botnet of a million browsers. Part 1</a></li>
<li><a href="../426243/index.html">How to get to Hell because of Helm, but grab onto a straw</a></li>
<li><a href="../426245/index.html">Improving online programs</a></li>
<li><a href="../426249/index.html">Bluetooth device control</a></li>
<li><a href="../426253/index.html">The principle of least action. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>