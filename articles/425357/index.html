<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we put together a 12-story technology stack and weren‚Äôt crazy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Appodeal is a company of ~ 100 people who work in Moscow, San Francisco, Barnaul, Lutsk, Kirov, Barcelona, ‚Äã‚Äãand since June 2018, also in Minsk. 

 We...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we put together a 12-story technology stack and weren‚Äôt crazy</h1><div class="post__text post__text-html js-mediator-article">  Appodeal is a company of ~ 100 people who work in Moscow, San Francisco, Barnaul, Lutsk, Kirov, Barcelona, ‚Äã‚Äãand since June 2018, also in Minsk. <br><br>  We are engaged in the monetization of mobile applications by showing ads to users.  We started with advertising mediation, but the technology stack is constantly growing, so other products from the Ad Tech industry were added to the mediation. <br><br><img src="https://habrastorage.org/webt/9x/iw/99/9xiw995blvp1eqlv6tc-hnfona0.jpeg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who are not yet familiar with Ad Tech - this is the area of ‚Äã‚Äãwork of technology companies that work in the field of advertising.  When you tell someone that you work in the field of mobile advertising, people often react skeptically - apparently, annoying ads ‚ÄúAzino Three Axes‚Äù come to mind.  In fact, this is only the tip of the iceberg, and all this ‚Äúwild‚Äù advertising has nothing to do with this advertising business. <a name="habracut"></a>  And the mobile segment, which we are engaged in, has long outgrown the segment of advertising on the web: <br><br><img src="https://habrastorage.org/webt/3-/h8/ep/3-h8epbkxfz3_k8zk_foglrsnym.png" alt="image"><br><br><h4>  Why do I need to integrate advertising in applications? </h4><br>  Of course, many resources are spent on creating applications ‚Äî and the creators / owners want the time and effort spent to pay off.  Owners of mobile applications that spread their application in the App store / Google Play are called publishers or publishers.  Publishers use different monetization models, from in-app purchases to monetizing through advertising.  But of all these methods, only the latter allows the user not to pay for the use of the application - and this gives the greatest audience reach. <br><br>  Yes, if there are too many advertisements, this will annoy everyone and negatively affect the user‚Äôs retention.  Which, of course, no one needs.  Therefore, advertising is always trying to integrate wisely, in order to earn maximum money on your application and at the same time not to take a penny from users. <br><br><h4>  How it works? </h4><br>  As soon as the publisher decides to monetize with the help of advertising, he comes to the company that can make this task as easy as possible for him.  How does this happen with Appodeal?  After registering on the site, we integrate its application with our service.  This is done through the client SDK, which connects the application with the server part and communicates with the server part via the API. <br><br>  If we reduce the details to a minimum, the goal of interaction is reduced to two stages: <br><br>  but.  Determine what kind of advertising you need to show right now; <br>  b.  Send information about which ad was shown and which was not, and display it in the statistics. <br><br>  At the moment, Appodeal serves several thousand active applications that carry approximately 400-450 million ad impressions per day, received in response to about 1 billion requests to advertising networks (which are advertising providers).  In order for all this to work, our servers in total serve about 125 thousand requests per second, i.e.  approximately 10.8 billion requests per day. <br><br><img src="https://habrastorage.org/webt/-j/ci/bq/-jcibqnsphakjli4w0tnq5h7mre.png" alt="image"><br><br><h4>  What is all this built on? </h4><br>  We use various technologies to provide speed, reliability and at the same time development and support flexibility.  At the moment we are writing code in the following languages: <br><br><ul><li>  / Ruby / Ruby on Rails + React.JS (front-end) /: Still a large part of the API and the entire web part that users and our employees see </li><li>  / GoLang /: Processing large amounts of data according to statistics and not only </li><li>  / Scala /: Realtime processing of requests for work with traffic exchange exchanges via RTB protocol (read more about it at the end of the article) </li><li>  / Elixir / Phoenix /: Rather, the experimental part.  Construction of some micro-services for processing part of the statistics and API. </li></ul><br><img src="https://habrastorage.org/webt/js/dj/qg/jsdjqgdn5x6skyabw52jkl7rokg.png" alt="image"><br><br><h4>  Why initially Ruby and Ruby on Rails? </h4><br>  Appodeal competes in its segment with very large players, so it is necessary to adapt to market changes quickly.  Often it feels like a car wheel change at a speed of 100 km / h.  Ruby on Rails allowed us to endure the race and gain a foothold in the market enough to be the leader in its segment.  The main advantages of Rails in our opinion: <br><br><ul><li>  A large number of skilled developers </li><li>  Great community.  A huge number of ready-made solutions and libraries </li><li>  The speed of the introduction of new features and change / delete old </li></ul><br><img src="https://habrastorage.org/webt/31/me/zl/31mezlqllshlsqmm0ultc0z7a7i.png" alt="image"><br><br>  Of the obvious cons: <br><br><ul><li>  Overall performance leaves much to be desired.  It also affects the lack of JIT (at the moment), the inability to parallelize the code (if you do not take into account the JRuby).  To some extent, this remains tolerable, because the database and cache, as a rule, become the bottleneck.  What we see in the picture from NewRelic: </li></ul><br><img src="https://habrastorage.org/webt/vz/uk/gh/vzukgh2_2ehcbmbf3mhikl-xsdc.png" alt="image"><br><br><ul><li>  The rail monolith is not sawn too well on microservices - a high degree of coherence of business logic and data access logic (ActiveRecord) affects. </li></ul><br><h4>  How is the data stored? </h4><br>  We have a lot of data.  Highly.  These are billions / tens / hundreds of billions of records.  Since the data is completely different, we store them in different ways.  You should never be limited in architecture to any one solution that is supposedly universal.  Practice shows that, firstly, in Highload there are practically no universal solutions.  Versatility means average (or significantly lower than average) data on access / read speed / storage size as payment for this versatility.  Secondly, you need to try something new all the time, experiment and look for non-trivial solutions for the tasks set.  Total: <br><br><ul><li>  / PostgreSQL /: We love Postgre.  We consider it the best at the moment OLTP storage solution.  Data about users, applications, advertising campaigns and so on is stored there.  We use Primary-Replica replication.  Backups are done only during the Christmas holidays, because this is for wimps (just kidding). </li><li>  / VerticaDB /: Column-oriented database.  We use to store billions of records in statistics.  In short, for some time Vertik was considered the best OLAP solution for analytics storage.  The main disadvantage is the huge (individual) license price. </li><li>  / ClickHouse /: Also column-oriented database.  Gradually move to it with VerticaDB.  We consider the best OLAP solution at the moment.  Not worth a penny.  It works very quickly and reliably.  The main disadvantage is that data cannot be deleted and updated (we will talk about this in a separate article if anyone is interested). </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14e/0af/ee0/14e0afee039b7303db9d70c2f2f3892a.gif" alt="image"></div><br><blockquote>  Nichosi!  How can this not delete and modify data ?! </blockquote><br><ul><li>  / Aerospike /: The fastest NoSQL key-value storage in our opinion.  There are a number of disadvantages, but in general we are satisfied.  For Aerospike, there is even a comparison table on their website for performance with other solutions: [When to use Aerospike NoSQL database vs.  Redis] (https://www.aerospike.com/when-to-use-aerospike-vs-redis/) </li><li>  / Redis /: About ‚ÄúRadishes‚Äù, I think, it makes no sense to tell separately.  Paradoxically, its main advantage is ease of use and single streaming, which allows to avoid race conditions, for example, when working with banal counters. </li><li>  / Druid /: We use for large data arrays in working with RTB exchanges.  In fact, for the most part, it plays on the same field with ClickHouse, but historically, we have not yet been able to switch to any one instrument. </li></ul><br><img src="https://habrastorage.org/webt/o0/6j/un/o06junbll0drckljvb8sten_hei.png" alt="image"><br><br>  Such a set may seem overloaded, but firstly, Appodeal is a large conglomerate of several development teams and several projects within one.  And secondly, these are the harsh realities of ad tech - we are far from being alone using a multi-storey stack within one company. <br><br><h4>  How do you follow this? </h4><br><br>  Since the data streams are large, in order to process them, the data must be added to the queue.  As a queue, we use Kafka.  This is a great reliable solution, written in Scala, which has never failed us. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-s/ph/sy/-sphsyrohftcyefndm9nuz5hluo.png" alt="image"></div><br><br>  The only requirement for the user in this case is that he has time to rake the constantly increasing queue faster than it grows.  Simple and obvious rule.  Therefore, for these purposes, we mainly use GoLang.  However, this does not negate the fact that there should be a lot of RAM on this server. <br><br>  To keep track of all this farming, you have to monitor and delegate literally everything.  For this we use: <br><br><ul><li>  / NewRelic /: A time-tested solution that integrates perfectly with Ruby on Rails and micro services on GoLang.  The only disadvantage of NewRelic is its price.  Therefore, NewRelic is not everywhere with us.  For the most part, we try to replace it with metrics we collect ourselves ‚Äî we put them in Grafana. </li><li>  / Statsd + Grafana /: Good stuff for collecting your metrics.  With the only drawback that you have to customize everything yourself and ‚Äúrepeat‚Äù the NewRelic functionality out of the box. </li><li>  / ElasticSearch + Fluentd + Kibana /: In the logs we add everything.  From slow PostgreSQL queries to some Rails system messages.  Actually, such a solution as Kibana based on ElasticSearch allows you to conveniently collect all the logs in one place and then search for the necessary messages. </li><li>  / Airbrake /: Mandatory in this all is the process of collecting errors along with stacktrace messages.  At the moment we are moving out of one of the free solutions with Airbrake.  For the reason, again, prices. </li></ul><br><img src="https://habrastorage.org/webt/0f/tx/e7/0ftxe7kzizutxsovtqcack5-bzs.png" alt="image"><br><br>  You need to understand that properly constructed monitoring is your eyes and ears.  Blind work impossible.  You need to see what happens on your servers at a particular point in time, so the stability and reliability of your product will depend largely on how well you build a system for collecting and displaying metrics. <br><br>  By the way, speaking of reliability, we keep several staging servers for pre-rolling out and checking releases, which we consistently keep under load, duplicating some of the real traffic there.  Every week we synchronize the databases between production and styling.  This gives us a kind of ‚Äúmirror‚Äù that allows us to test those things that cannot be tested locally, as well as to identify problems at the level of load testing. <br><br><h4>  Is it all so difficult? </h4><br>  It turns out that way.  As Ilon Musk wrote in his book: ‚ÄúThe best minds of my generation are engaged in how to get people to click on advertisements,‚Äù Jeff Hammerbacher, formerly an Facebook engineer, told me.  - The horror ... ".  A short list of what Appodeal does: <br><br><ul><li>  We are integrated with two dozen ad networks and agencies.  In the automatic mode, we register applications in these networks, and also configure various parameters so that these networks work with maximum performance.  Not every network has corresponding APIs, somewhere you have to do it with ‚Äúrobots‚Äù. </li><li>  Each network pays users the revenue for impressions, which must be obtained, broken down according to different parameters and processed.  This is done in non-stop mode.  Somewhere, again, by robots. </li><li>  To provide the user with the maximum income, we ‚Äúforce‚Äù the grids to compete with each other, building up the so-called ‚Äúwaterfall‚Äù of promotional offers.  The waterfall is based on various indicators, for example, eCPM (average price per 1000 impressions), which we predict in various ways.  The higher the promotional offer in a waterfall, the higher we predict the price for it.  A waterfall is offered on the device as often as required.  As you might have guessed, an advertisement that nobody pushes, and which will only annoy everyone, is of no interest to anyone.  The only exception is the so-called.  ‚ÄúBranded‚Äù banner ads from Coca-Cola, Pepsi and other corporate giants who used to talk about themselves always and everywhere. </li><li>  Some of this interaction is based on the so-called RTB protocol (Real-Time Bidding): </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dq/ma/fj/dqmafjo0twbm85ocp0p4vnnfkse.png" alt="image"></div><br><br>  In this case, the so-called bidders are traded with each other online at the auction for the right to show their ads on the selected device.  Very interesting moment worthy of a separate article.  Many exchanges, such as Google AdExchange, set a rigid framework for the server response time (for example, 50ms), which raises the question of performance.  In the case of disobedience - a fine of thousands of dollars.  This is exactly what makes the kernel written in Scala in conjunction with Druid. <br><br>  Every hunter wants to know where the pheasant sits, and our clients (like us) want to know who was shown the ads, when and why.  Therefore, the whole bunch of data that we have, we have to put in a queue (Kafka), gradually process and add to the OLAP database (ClickHouse).  Many people think that PostgreSQL will cope with this task as well as any other hipster solutions, but this is not true.  PostgreSQL is good, but the classic solution for building indexes for data access speed stops working when the number of fields for filtering and sorting exceeds 10, and the amount of stored data approaches 1 billion records.  You simply do not have enough memory to store all of these indexes, or there will be problems with updating these indexes.  In any case, you will not be able to achieve the same performance as column-oriented solutions for analytical queries. <br><br><h4>  Conclusion </h4><br>  In this article I tried to at least briefly tell what we are doing, how we store and process data.  Tell us in the comments which stack you use, ask questions and request new articles - we will be happy to share our experience. </div><p>Source: <a href="https://habr.com/ru/post/425357/">https://habr.com/ru/post/425357/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425347/index.html">Dumping Mask: Myth or Reality</a></li>
<li><a href="../425349/index.html">Positive Hack Days 9 Forum will take place on May 21 and 22 at Crocus Expo</a></li>
<li><a href="../425351/index.html">Programmers do their own jobs</a></li>
<li><a href="../425353/index.html">The whole truth about the RTOS. Article # 13. Task data structures and unsupported API calls</a></li>
<li><a href="../425355/index.html">ICO-projects security rating</a></li>
<li><a href="../425359/index.html">The Chinese used a microchip to control American computers.</a></li>
<li><a href="../425361/index.html">Content blocking, chromium browser extension</a></li>
<li><a href="../425363/index.html">Tips for student programmers</a></li>
<li><a href="../425367/index.html">Simplest Arduino Game with Display 1602 - Part # 2</a></li>
<li><a href="../425369/index.html">KTRU (Catalog of goods, works, services) or the death of IT public procurement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>