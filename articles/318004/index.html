<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing outgoing calls via GSM gateway</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our organization, Asterisk is used, and for outgoing calls, the Yeastar TG800 GSM gateway for 8 SIMs is connected to it. Every month we buy a packa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing outgoing calls via GSM gateway</h1><div class="post__text post__text-html js-mediator-article">  In our organization, Asterisk is used, and for outgoing calls, the Yeastar TG800 GSM gateway for 8 SIMs is connected to it.  Every month we buy a package of minutes for each SIM card. <br><br>  To make an outgoing call, it is usually used to iterate the SIMs in order until a free one is found: <br><br><pre><code class="hljs perl"><span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _X.,n,Dial(SIP/gsm1/${EXTEN},,tT) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _X.,n,Dial(SIP/gsm2/${EXTEN},,tT) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _X.,n,Dial(SIP/gsm3/${EXTEN},,tT)</code> </pre> <br>  etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this case, the most calls go through the first SIM card, and the least through the last one.  Therefore, by the middle of the month, the minutes at the first SIM cards end earlier than at the last ones, and a situation arises where you can make a call after 4 SIM cards out of 8, since the first four minutes have ended.  This is bad, as there are 4 outgoing lines instead of 8. <br><br>  To avoid this, you need to make calls not in the same order, but in accordance with the balance of minutes on the sim card. <br><a name="habracut"></a><br>  Along the way, I write down the remnants of minutes, relevance (how much was checked) and when the package was activated in the MySQL database. <br><br>  You can go to the page and quickly find out the remains: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b7/dfa/edf/1b7dfaedfb534ec9bdb07043fa0b477d.PNG" alt="image"></div><br>  To check balances, you need to enable the API on the gateway, to do this, go to the SMS section, then to the API settings.  Everything is clear there, you need to specify a login with a password and the allowed subnet for connection. <br><br>  We will check the balance every hour, for this we will add a script call to cron (I have every 53rd minute of an hour): <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">53</span></span> */<span class="hljs-number"><span class="hljs-number">1</span></span> * * * root php %<span class="hljs-type"><span class="hljs-type">path</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-script%/getbalance.php</code> </pre> <br>  Next, we need to create 8 text files (or how many sim cards you have) with names from nc2.txt to nc9.txt.  The numbers are such because the gateway numbers its ports in exactly this way, from 2 to 9. <br><br>  In each command file to the gateway.  Example for nc2.txt: <br><br><pre> <code class="hljs markdown">action: login username: <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* secret: *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* action: smscommand command: gsm send ussd 2 *</span></span>255*0# action: logoff</code> </pre> <br>  An example is given for Tele2.  Accordingly, in the file nc3.txt instead of "ussd 2" we write "ussd 3".  The script sends these commands to the gateway, in response, we receive files with the names from nc2out.txt to nc9out.txt. <br><br>  The answer will be (for Tele2): <br><br><pre> <code class="hljs sql">Asterisk <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> Manager/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Response: <span class="hljs-keyword"><span class="hljs-keyword">Success</span></span> Message: <span class="hljs-keyword"><span class="hljs-keyword">Authentication</span></span> accepted Response: <span class="hljs-keyword"><span class="hljs-keyword">Follows</span></span> Privilege: SMSCommand <span class="hljs-number"><span class="hljs-number">1</span></span>:Received USSD <span class="hljs-keyword"><span class="hljs-keyword">success</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> span: <span class="hljs-number"><span class="hljs-number">2</span></span> USSD Responses: <span class="hljs-number"><span class="hljs-number">2</span></span> USSD Code: <span class="hljs-number"><span class="hljs-number">64</span></span> USSD <span class="hljs-keyword"><span class="hljs-keyword">Len</span></span>: <span class="hljs-number"><span class="hljs-number">85</span></span> USSD Message: Ostatok v pakete: <span class="hljs-number"><span class="hljs-number">968</span></span> min./mes., <span class="hljs-number"><span class="hljs-number">5000</span></span> SMS/mes., <span class="hljs-number"><span class="hljs-number">20480</span></span> MB/mes. Parametry<span class="hljs-string"><span class="hljs-string">' tarifa *107# --END COMMAND-- Response: Goodbye Message: Thanks for all the fish.</span></span></code> </pre> <br>  Specification: it is necessary to switch the operator's answers to translit, otherwise we get the text in an inconvenient encoding. <br><br>  Next we pull out the number of remaining minutes, sort and write the call order in the files from out1.txt to out8.txt (this is already for an asterisk, so the numbering is normal).  That is, if the order of the call was 5, 4, 3, 2, 1, 7, 8, 6, then in the file out1.txt we write the number 5, in the file out2.txt we write 4, and so on. <br><br>  It remains to read these files in the dialplan and make calls in the correct order: <br><br><pre> <code class="hljs ruby">exten =&gt; _X.,n,set(SIMNUM1=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>1.php)}) exten =&gt; _X.,n,set(SIMNUM2=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>2.php)}) exten =&gt; _X.,n,set(SIMNUM3=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>3.php)}) exten =&gt; _X.,n,set(SIMNUM4=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>4.php)}) exten =&gt; _X.,n,set(SIMNUM5=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>5.php)}) exten =&gt; _X.,n,set(SIMNUM6=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>6.php)}) exten =&gt; _X.,n,set(SIMNUM7=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>7.php)}) exten =&gt; _X.,n,set(SIMNUM8=${SHELL(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php -f %pathtoscript%/getsim</span></span>8.php)}) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM1}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM2}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM3}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM4}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM5}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM6}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM7}/${EXTEN},,tT) exten =&gt; _X.,n,Dial(SIP/gsm${SIMNUM8}/${EXTEN},,tT)</code> </pre> <br>  Yes, I almost forgot, the file getsim1.php: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> $t = file_get_contents(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'%pathtoscript%/out1.txt'</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">echo</span></span></span><span class="php"> $t[</span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php">]; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">return</span></span></span><span class="php"> $t[</span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php">]; </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  Now actually the main script getbalance.php. <br><br>  IP gateway take 10.10.1.1. <br><br>  I know that I need to make a cycle instead of copy-paste, but I follow the golden rule of the admin: it works - do not touch :-) <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'/var/lib/asterisk/agi-bin/lib.php'</span></span>; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a2: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc2.txt &gt; %pathtoscript%/nc2out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc2out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text2 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a2; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a3: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc3.txt &gt; %pathtoscript%/nc3out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc3out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text3 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a3; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a4: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc4.txt &gt; %pathtoscript%/nc4out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc4out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text4 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a4; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a5: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc5.txt &gt; %pathtoscript%/nc5out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc5out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text5 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a5; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a6: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc6.txt &gt; %pathtoscript%/nc6out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc6out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text6 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a6; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a7: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc7.txt &gt; %pathtoscript%/nc7out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc7out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text7 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a7; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a8: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc8.txt &gt; %pathtoscript%/nc8out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc8out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text8 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a8; $s=<span class="hljs-number"><span class="hljs-number">0</span></span>; a9: $s++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($s&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; system(<span class="hljs-string"><span class="hljs-string">'nc 10.10.1.1 5038 &lt; %pathtoscript%/nc9.txt &gt; %pathtoscript%/nc9out.txt'</span></span>); $text = file_get_contents(<span class="hljs-string"><span class="hljs-string">'%pathtoscript%/nc9out.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(preg_match(<span class="hljs-string"><span class="hljs-string">'/te:\ (.*)\ min/'</span></span>,$text,$matches)) $text9 = $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> a9; $text10 = <span class="hljs-string"><span class="hljs-string">"0"</span></span>; system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.date(<span class="hljs-string"><span class="hljs-string">'l dS FY h:i:s A'</span></span>).<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text2.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text3.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text4.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text5.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text6.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text7.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text8.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$text9.<span class="hljs-string"><span class="hljs-string">'" &gt;&gt;%pathtoscript%/balance.txt'</span></span>); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"select minutes from `lines` where clid like '%2636'"</span></span>,$link); $row1 = mysql_fetch_assoc($row); $old1 = $row1[<span class="hljs-string"><span class="hljs-string">'minutes'</span></span>]+<span class="hljs-number"><span class="hljs-number">0</span></span>; $new1 = $text2+<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($old1 &lt; $new1) $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balancedate=NOW()"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text2.<span class="hljs-string"><span class="hljs-string">" where clid like '%2636'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text3.<span class="hljs-string"><span class="hljs-string">" where clid like '%4036'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text4.<span class="hljs-string"><span class="hljs-string">" where clid like '%4977'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text5.<span class="hljs-string"><span class="hljs-string">" where clid like '%2414'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text6.<span class="hljs-string"><span class="hljs-string">" where clid like '%2451'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text7.<span class="hljs-string"><span class="hljs-string">" where clid like '%2536'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text8.<span class="hljs-string"><span class="hljs-string">" where clid like '%2581'"</span></span>,$link); $row = mysql_query(<span class="hljs-string"><span class="hljs-string">"update `lines` set balance="</span></span>.$text10.<span class="hljs-string"><span class="hljs-string">", minutesdate=NOW(), minutes="</span></span>.$text9.<span class="hljs-string"><span class="hljs-string">" where clid like '%4056'"</span></span>,$link); $n[<span class="hljs-number"><span class="hljs-number">1</span></span>] = $text2+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">2</span></span>] = $text3+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">3</span></span>] = $text4+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">4</span></span>] = $text5+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">5</span></span>] = $text6+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">6</span></span>] = $text7+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">7</span></span>] = $text8+<span class="hljs-number"><span class="hljs-number">0</span></span>; $n[<span class="hljs-number"><span class="hljs-number">8</span></span>] = $text9+<span class="hljs-number"><span class="hljs-number">0</span></span>; $p[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; $p[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; $p[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>; $p[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">4</span></span>; $p[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">5</span></span>; $p[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">6</span></span>; $p[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">7</span></span>; $p[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">1</span></span>;$i&lt;=<span class="hljs-number"><span class="hljs-number">7</span></span>;$i++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($j=$i+<span class="hljs-number"><span class="hljs-number">1</span></span>;$j&lt;=<span class="hljs-number"><span class="hljs-number">8</span></span>;$j++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($n[$i]&lt;$n[$j]) { $t = $n[$i]; $n[$i] = $n[$j]; $n[$j] = $t; $t = $p[$i]; $p[$i] = $p[$j]; $p[$j] = $t; } system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out1.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">2</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out2.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">3</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out3.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">4</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out4.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">5</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out5.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">6</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out6.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">7</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out7.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'echo "'</span></span>.$p[<span class="hljs-number"><span class="hljs-number">8</span></span>].<span class="hljs-string"><span class="hljs-string">'" &gt;%pathtoscript%/out8.txt'</span></span>); system(<span class="hljs-string"><span class="hljs-string">'asterisk -rx "dialplan reload"'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  Content lib.php (there is a connection to MySQL): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dbuser = <span class="hljs-string"><span class="hljs-string">"*******"</span></span>; $dbpass = <span class="hljs-string"><span class="hljs-string">"*******"</span></span>; $dbserv = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; $dbname = <span class="hljs-string"><span class="hljs-string">"*******"</span></span>; $dbengn = <span class="hljs-string"><span class="hljs-string">"mysql"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($host, $login, $password, $dbname)</span></span></span><span class="hljs-function"> </span></span>{ $link = mysql_connect($host, $login, $password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mysql_select_db($dbname, $link); mysql_query(<span class="hljs-string"><span class="hljs-string">"SET NAMES cp1251"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $link; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query, $link)</span></span></span><span class="hljs-function"> </span></span>{ $res = mysql_query($query, $link); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_fetch_assoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mysql_fetch_assoc($result); } $link = sql_connect($dbserv, $dbuser, $dbpass, $dbname); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  Another small explanation. <br><br>  On each sim card, 10 attempts are made to check the balance (this is not always possible), if at least one failed, we exit and try in an hour. <br><br>  Why is text10 = "0"?  Previously used sims MTS, which returned the balance (in rubles).  In Tele2, a common account is used, we don‚Äôt put money on specific SIM cards, so there is always 0 there. <br><br>  Balances are also added to the file balance.txt, so that you can view the history and calculate the statistics of spending. <br><br>  Who cares how not to lose an incoming call on a SIM card, if they are already talking on it, ask in the comments (doesn't pull on an article). <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/318004/">https://habr.com/ru/post/318004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317994/index.html">A selection of machine learning frameworks</a></li>
<li><a href="../317996/index.html">Non-computable functions on the example of the Busy Beaver Game</a></li>
<li><a href="../317998/index.html">Bad advice for your startup</a></li>
<li><a href="../318000/index.html">Using Service Worker to create a botnet</a></li>
<li><a href="../318002/index.html">How we met with Agile & Scrum</a></li>
<li><a href="../318006/index.html">Development and publication of the first game for Android on Unity3D</a></li>
<li><a href="../318008/index.html">PHP 7 performance improvement</a></li>
<li><a href="../318010/index.html">Hello dear Megaphone</a></li>
<li><a href="../318012/index.html">Intel Software Guard Extensions tutorial. Part 3, Design for Intel SGX</a></li>
<li><a href="../318014/index.html">Huawei router + hypervisor in one package. Starting from scratch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>