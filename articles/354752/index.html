<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part XXII: Background Tasks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(edition 2018) 
 Miguel grinberg 



 There 


 This is the twenty-second part of the Mega-Tutorial, in which I will tell you how to create background...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part XXII: Background Tasks</h1><div class="post__text post__text-html js-mediator-article"><h2 id="izdanie-2018">  (edition 2018) </h2><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/354322/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  This is the twenty-second part of the Mega-Tutorial, in which I will tell you how to create background tasks that work independently of the web server. </p><a name="habracut"></a><br><p>  Under the spoiler is a list of all articles in the 2018 series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354322/"><strong>Chapter 21: User Notifications</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354752/"><strong>Chapter 22: Background Tasks</strong></a> (This article) </li><li>  [ <strong>Chapter 23: Application Programming Interfaces (API)</strong> ] ( <a href="https://habr.com/post/358152/">https://habr.com/post/358152/</a> ) </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work, or simply do not have the patience to wait for the article for a week, I (Miguel Greenberg) offer the full version of this manual (in English) in the form of an electronic book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  This chapter focuses on the implementation of long-running or complex processes that must be performed as part of an application.  These processes cannot be performed synchronously in the context of the request because they block the response to the client for the duration of the task.  I briefly touched on this topic in <a href="https://habrahabr.ru/post/348566/">Chapter 10</a> , moving the sending of e-mail messages to background threads so that the client does not have to wait for the 3-4 seconds that are required to send e-mail.  Although the use of flows for e-mail is acceptable, this solution does not scale well when the processes in question are much longer.  A common practice is to upload long tasks to a workflow, or, most likely, to a pool. </p><br><p>  To justify the need for lengthy tasks, I'm going to introduce the export function in Microblog, through which users will be able to request a data file with all of their blog posts.  When a user uses this option, the application should export all user messages to a JSON file, and then send it to the user by email.  While this is happening, the user will see a notification indicating the percent complete. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="vvedenie-v-ocheredi-zadach">  Introduction to Task Queues </h2><br><p>  <em>Task queues</em> provide the application with a convenient solution for requesting the task to be completed by a workflow.  Workflows run independently of the application and may even be located on another system.  Communication between the application and the handler is carried out through the <em>message queue</em> .  The application sends the job, and then tracks its execution, interacting with the queue.  The following diagram shows a typical implementation: </p><br><p><img src="https://habrastorage.org/webt/fy/rp/fp/fyrpfpqwurw2rb5y_cawd2wvpuu.png"></p><br><p>  The most popular task queue for Python is <a href="http://www.celeryproject.org/">Celery</a> .  This is a fairly complex package that has many options and supports multiple message queues.  Another popular version of the Python task queue is <a href="http://python-rq.org/">Redis Queue</a> or simply RQ, which only supports Redis Message Queuing, but is much easier to configure than Celery. </p><br><p>  Both Celery and RQ are quite suitable for supporting background tasks in a Flask application, so the simplicity of RQ will contribute to my choice for this application.  However, implementing the same functionality with Celery is not much more difficult.  If you are interested in Celery more than RQ, you can read the article <a href="https://blog.miguelgrinberg.com/post/using-celery-with-flask">Using Celery with Flask</a> , which I wrote on my blog. </p><br><h2 id="ispolzovanie-rq">  Using RQ </h2><br><p> RQ - standard Python package, which is installed via <code>pip</code> : </p><br><pre> <code class="hljs pgsql">(venv) $ pip install rq (venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> &gt; requirements.txt</code> </pre> <br><p>  As I mentioned earlier, the connection between the application and the RQ handler will be in the Redis message queue, so you need to start the Redis server.  There are many options for installing and running the Redis server in one click to download the source installers and compile it directly on your system.  If you are using Windows, then Microsoft supports installers <a href="https://github.com/MicrosoftArchive/redis/releases">here</a> .  In Linux, you can probably get it as a package through the package manager of your operating system.  Mac OS X users can start <code>brew install redis</code> , and then start the service manually using the <code>redis-server</code> command. </p><br><p>  You will not need to interact with Redis in everything except checking that the service is running and available for RQ. </p><br><h2 id="sozdanie-task-zadachi">  Creating a Task (Tasks) </h2><br><p>  I will show you how to accomplish a simple task through RQ so that you can familiarize yourself with it.  Task is nothing more than a Python function.  Here is an example of the task that I am going to implement in the new <em>app / tasks.py module</em> : </p><br><blockquote>  <strong>app / tasks.py</strong> : An example background task. </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(seconds)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Starting task'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(seconds): print(i) time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Task completed'</span></span>)</code> </pre> <br><p>  This task takes the number of seconds as an argument, and then waits for this time, printing the counter once per second. </p><br><h2 id="zapusk-rq-worker">  Run RQ Worker </h2><br><p>  Now that the task is ready, the handler can start.  This is done using the <code>rq worker</code> command: </p><br><pre> <code class="hljs cs">(venv) $ rq worker microblog-tasks <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> RQ worker <span class="hljs-string"><span class="hljs-string">'rq:worker:miguelsmac.90369'</span></span> started, version <span class="hljs-number"><span class="hljs-number">0.9</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> Cleaning registries <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> queue: microblog-tasks <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> *** Listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> microblog-tasks...</code> </pre> <br><p>  The workflow is now connected to Redis and keeps track of all tasks that can be assigned to it in a queue with the name <code>microblog-tasks</code> .  In cases where it is required that several handlers have more bandwidth, all you need to do is run more <code>rq worker</code> instances, all connected to the same queue.  Then, when the task appears in the queue, it will be selected by any of the available workflows.  In a <em>production environment</em> , you will probably need to have at least as many working processors as available in the CPU. </p><br><h2 id="vypolnenie-zadach">  Task Execution </h2><br><p>  Now open the second terminal window and activate the virtual environment in it.  I'm going to use a shell session to run the <code>example()</code> task in the worker: </p><br><pre> <code class="hljs pgsql">&gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> redis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Redis &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rq &gt;&gt;&gt; queue = rq.Queue(<span class="hljs-string"><span class="hljs-string">'microblog-tasks'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>=Redis.from_url(<span class="hljs-string"><span class="hljs-string">'redis://'</span></span>)) &gt;&gt;&gt; job = queue.enqueue(<span class="hljs-string"><span class="hljs-string">'app.tasks.example'</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>) &gt;&gt;&gt; job.get_id() <span class="hljs-string"><span class="hljs-string">'c651de7f-21a8-4068-afd5-8b982a6f6d32'</span></span></code> </pre> <br><p>  The <code>Queue</code> class from RQ represents the application queue of tasks.  It takes two arguments, the name of the queue and the <code>Redis</code> connection object, which in this case I initialize with the default URL.  If the Redis server is running on a different host or port, you must use a different URL. </p><br><p>  The <code>enqueue()</code> method is used to add a job to the queue.  The first argument is the name of the task you want to perform, specified directly as a function object or as an import string.  I find the string option to be much more convenient, since it makes it unnecessary to import a function on the application side.  All remaining arguments given to <code>enqueue()</code> will be passed to the function running in the worker. </p><br><p>  As soon as the <code>enqueue()</code> call is made, you will notice some activity in the first terminal window in which the worker RQ is running.  You will see that the <code>example()</code> function now works and prints a counter once per second.  At the same time, your other terminal is not locked, and you can continue evaluating the expressions in the shell.  In the example above, I called the <code>job.get_id()</code> method to get a unique task identifier.  Another interesting expression that you can try to use with the <code>job</code> object is to check whether the function has ended in the workplace: </p><br><pre> <code class="hljs ruby"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;</span></span>&gt; job.is_finished False</code> </pre> <br><p>  If you passed <code>23</code> as I did in my example above, then the function will work for about 23 seconds.  After this time, <code>job.is_finished</code> will become <code>True</code> .  Is not that great?!  I really like the simplicity of RQ! </p><br><p>  As soon as the function finishes, the <em>worker</em> ( <em>worker</em> ) returns to waiting for new jobs, so you can repeat the call to <code>enqueue()</code> with other arguments if you want to experiment more.  The data that is stored in the queue regarding the task will remain there for a while (by default, 500 seconds), but eventually will be deleted.  This is important, the task queue does not save the history of completed tasks. </p><br><h2 id="otchet-o-hode-vypolneniya-zadachi">  Task progress report </h2><br><p>  The example of the task that I used above is unrealistically simple.  Typically, during a lengthy task, you want some progress information to be available to the application, which, in turn, can show it to the user.  RQ supports this with the <code>meta</code> job object attribute.  Let me rewrite the <code>example()</code> task to record progress reports: </p><br><blockquote>  <strong>app / tasks.py</strong> : An example of a background task with a progress report. </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rq <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_current_job <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(seconds)</span></span></span><span class="hljs-function">:</span></span> job = get_current_job() print(<span class="hljs-string"><span class="hljs-string">'Starting task'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(seconds): job.meta[<span class="hljs-string"><span class="hljs-string">'progress'</span></span>] = <span class="hljs-number"><span class="hljs-number">100.0</span></span> * i / seconds job.save_meta() print(i) time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) job.meta[<span class="hljs-string"><span class="hljs-string">'progress'</span></span>] = <span class="hljs-number"><span class="hljs-number">100</span></span> job.save_meta() print(<span class="hljs-string"><span class="hljs-string">'Task completed'</span></span>)</code> </pre> <br><p>  This new version of <code>example()</code> uses the RQ <code>get_current_job()</code> function to get an instance of the task, similar to the one that is returned to the application when the task is sent.  The <code>meta</code> object object attribute is a dictionary in which the task can write any user data that it wants to transfer to the application.  In this example, for recording, I use the <code>progress</code> element, which represents the percentage of task completion.  Every time progress is updated, I call <code>job.save_meta()</code> to <code>job.save_meta()</code> RQ to write data to Redis where the application can find it. </p><br><p>  On the application side (currently only the Python shell), I can run this task and then track the progress as follows: </p><br><pre> <code class="hljs pgsql">&gt;&gt;&gt; job = queue.enqueue(<span class="hljs-string"><span class="hljs-string">'app.tasks.example'</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>) &gt;&gt;&gt; job.meta {} &gt;&gt;&gt; job.<span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span>() &gt;&gt;&gt; job.meta {<span class="hljs-string"><span class="hljs-string">'progress'</span></span>: <span class="hljs-number"><span class="hljs-number">13.043478260869565</span></span>} &gt;&gt;&gt; job.<span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span>() &gt;&gt;&gt; job.meta {<span class="hljs-string"><span class="hljs-string">'progress'</span></span>: <span class="hljs-number"><span class="hljs-number">69.56521739130434</span></span>} &gt;&gt;&gt; job.<span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span>() &gt;&gt;&gt; job.meta {<span class="hljs-string"><span class="hljs-string">'progress'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>} &gt;&gt;&gt; job.is_finished <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre> <br><p>  As you can see above, on this side, the <code>meta</code> attribute is readable.  To refresh the contents from Redis, you must call the <code>refresh()</code> method. </p><br><h2 id="predstavlenie-zadach-v-baze-dannyh">  Representation of tasks in the database </h2><br><p>  For the example above, it was enough to run the task and see how it is executed.  For a web application, things get a little more complicated, because as soon as one of these tasks starts as part of the request, this request is completed and the entire context for this task is lost.  Since I want the application to track which tasks each user performs, I need to use a database table to maintain some state.  Below you can see a new implementation of the <code>Task</code> model: </p><br><blockquote>  <strong>app / models.py</strong> : Task model. </blockquote><br><pre> <code class="hljs kotlin"># ... <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> redis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rq <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span></span>(UserMixin, db.Model): # ... tasks = db.relationship(<span class="hljs-string"><span class="hljs-string">'Task'</span></span>, backref=<span class="hljs-string"><span class="hljs-string">'user'</span></span>, lazy=<span class="hljs-string"><span class="hljs-string">'dynamic'</span></span>) # ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Task</span></span></span></span>(db.Model): id = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">36</span></span>), primary_key=True) name = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">128</span></span>), index=True) description = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">128</span></span>)) user_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) complete = db.Column(db.<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=False) def get_rq_job(self): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: rq_job = rq.job.Job.fetch(self.id, connection=current_app.redis) except (redis.exceptions.RedisError, rq.exceptions.NoSuchJobError): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> None <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rq_job def get_progress(self): job = self.get_rq_job() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> job.meta.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'progress'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> job <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> not None <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br><p>  An interesting difference of this model from the previous ones is that the primary key field <code>id</code> is a string, not an integer.  This is because for this model I am not going to rely on my own generation of the primary key by the database, but instead will use task identifiers created by RQ. </p><br><p>  The model will store the full name of the task (submitted to RQ), a description of the task suitable for display to users, a connection with the user who requested the task, and a logical value indicating whether the task is completed or not.  The purpose of the <code>complete</code> field is to separate completed tasks from tasks that are being actively executed, since the tasks that are being performed require special processing to display the progress of the updates. </p><br><p>  The <code>get_rq_job()</code> method is a helper method that loads an RQ <code>Job</code> instance from a given task identifier, which I can get from the model.  This is done using <code>Job.fetch()</code> , which loads an instance of a job from data that exists in Redis.  The <code>get_progress()</code> method builds on top of the <code>get_rq_job()</code> method and returns the percent completion of the task.  This method has some interesting assumptions.  If the job ID from the model does not exist in the RQ queue, this means that the job has already been completed, and the data has expired and has been removed from the queue, so in this case 100 percent is returned.  On the other hand, if the task exists, but there is no information associated with the <code>meta</code> attribute, then we can safely assume that the task is scheduled for execution, but it has not yet been possible to start, so 0 returns as progress in this situation. </p><br><p>  To apply the changes to the database schema, you must create a new migration and then update the database: </p><br><pre> <code class="hljs ruby">(venv) $ flask db migrate -m <span class="hljs-string"><span class="hljs-string">"tasks"</span></span> (venv) $ flask db upgrade</code> </pre> <br><p>  A new model can also be added to the shell context to make it available in shell sessions without the need to import it: </p><br><blockquote>  <strong>microblog.py</strong> : Add the task model to the shell context. </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_app, db, cli <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User, Post, Message, Notification, Task app = create_app() cli.register(app) @app.shell_context_processor <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_shell_context</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'db'</span></span>: db, <span class="hljs-string"><span class="hljs-string">'User'</span></span>: User, <span class="hljs-string"><span class="hljs-string">'Post'</span></span>: Post, <span class="hljs-string"><span class="hljs-string">'Message'</span></span>: Message, <span class="hljs-string"><span class="hljs-string">'Notification'</span></span>: Notification, <span class="hljs-string"><span class="hljs-string">'Task'</span></span>: Task}</code> </pre> <br><h2 id="integraciya-rq-s-prilozheniem-flask">  RQ integration with Flask </h2><br><p>  In the configuration, you must add the connection URL for the Redis service: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): # ... REDIS_URL = os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'REDIS_URL'</span></span>) or <span class="hljs-string"><span class="hljs-string">'redis://'</span></span></code> </pre> <br><p>  As always, the Redis connection URL will be obtained from the environment variable, and if the variable is not defined, the default URL will be used, which assumes that the service is running on the same host and port as the default. </p><br><p>  The application factory function will be responsible for initializing Redis and RQ: </p><br><blockquote>  <strong>app / _ <em>init_</em> .py</strong> : RQ integration. </blockquote><br><pre> <code class="hljs scala"># ... from redis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Redis</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rq # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_app</span></span></span></span>(config_class=<span class="hljs-type"><span class="hljs-type">Config</span></span>): # ... app.redis = <span class="hljs-type"><span class="hljs-type">Redis</span></span>.from_url(app.config[<span class="hljs-symbol"><span class="hljs-symbol">'REDIS_UR</span></span>L']) app.task_queue = rq.<span class="hljs-type"><span class="hljs-type">Queue</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">'microblog</span></span>-tasks', connection=app.redis) # ...</code> </pre> <br><p>  <code>app.task_queue</code> will be the queue in which tasks will be presented.  Having a queue attached to an application is convenient because I can use <code>current_app.task_queue</code> to access it anywhere on the application.  To facilitate sending or checking any part of an application, I can create several helper methods in the <code>User</code> model: </p><br><blockquote>  <strong>app / models.py</strong> : Helper methods of the task in the user model. </blockquote><br><pre> <code class="hljs scala"># ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UserMixin</span></span></span></span><span class="hljs-class"><span class="hljs-params">, db.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Model</span></span></span></span></span><span class="hljs-class">)</span></span>: # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launch_task</span></span></span></span>(self, name, description, *args, **kwargs): rq_job = current_app.task_queue.enqueue(<span class="hljs-symbol"><span class="hljs-symbol">'app</span></span>.tasks.' + name, self.id, *args, **kwargs) task = <span class="hljs-type"><span class="hljs-type">Task</span></span>(id=rq_job.get_id(), name=name, description=description, user=self) db.session.add(task) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_tasks_in_progress</span></span></span></span>(self): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Task</span></span>.query.filter_by(user=self, complete=<span class="hljs-type"><span class="hljs-type">False</span></span>).all() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_task_in_progress</span></span></span></span>(self, name): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Task</span></span>.query.filter_by(name=name, user=self, complete=<span class="hljs-type"><span class="hljs-type">False</span></span>).first()</code> </pre> <br><p>  The <code>launch_task()</code> method transfers the task to the RQ queue along with adding it to the database.  The <code>name</code> argument is the name of the function, as defined in <em>app / tasks.py</em> .  When sent to RQ, the function adds to <code>app.tasks</code> .  <code>name</code> to build the full name of the function.  The <code>description</code> argument is a clear description of the task that can be presented to users.  For the function of exporting a blog post, I will use the name <code>export_posts</code> and descriptions <code>Exporting posts...</code>  The remaining arguments are positional and key arguments that will be passed to the task.  The function starts by calling the <code>enqueue()</code> method of the queue to send the job.  The returned job object contains the task id assigned by the RQ, so I can use it to create the corresponding task object in my database. </p><br><p>  Note that <code>launch_task()</code> adds, but does not fix, a new <code>Task</code> object in the session.  In general, it is best to work with a database session in higher-level functions, since this allows you to combine several updates made by lower-level functions into a single transaction.  This is not a strict rule, and later in this chapter you will see an exception in which a commit is performed in a child function. </p><br><p>  The <code>get_tasks_in_progress()</code> method returns a complete list of functions that are <code>get_tasks_in_progress()</code> user.  Later you will see that I use this method to include information about the tasks performed on the pages that are displayed to the user. </p><br><p>  Finally, <code>get_task_in_progress()</code> is a simpler version of the previous one that returns a specific task.  I prohibit users from running two or more tasks of the same type at the same time, so before starting a task, I can use this method to find out if the previous task is currently being executed. </p><br><h2 id="otpravka-soobscheniy-elektronnoy-pochty-iz-rq-task">  Sending emails from RQ Task </h2><br><p>  This may seem like a departure from the main topic, but as I said above, with the completion of the background export task, an email will be sent to the user with a JSON file that contains all the messages.  The email functionality I introduced in <a href="https://habrahabr.ru/post/349060/">Chapter 11</a> needs to be extended in two ways.  First, I need to add file attachment support so that I can attach a JSON file.  Secondly, the <code>send_email()</code> function sends letters asynchronously using a background thread.  When I am going to send an email from a background task that is already asynchronous, having a second level background task based on a thread makes little sense, so I need to support both synchronous and asynchronous sending of email. </p><br><p>  Fortunately, Flask-Mail supports attachments, so all I need to do is extend the <code>send_email()</code> function to take them (attachments) into an additional argument, and then set them up in the <code>Message</code> object.  And in addition to send the letter as a priority task, I just need to add a boolean <code>sync</code> argument: </p><br><blockquote>  <strong>app / email.py</strong> : Sending emails with attachments. </blockquote><br><pre> <code class="hljs vhdl"># ... def send_email(subject, sender, recipients, text_body, html_body, attachments=None, sync=<span class="hljs-literal"><span class="hljs-literal">False</span></span>): msg = Message(subject, sender=sender, recipients=recipients) msg.<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> = text_body msg.html = html_body <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> attachments: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attachment <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attachments: msg.attach(*attachment) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sync: mail.send(msg) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: Thread(target=send_async_email, args=(current_app._get_current_object(), msg)).start()</code> </pre> <br><p>  The <code>attach()</code> method of the <code>Message</code> class takes three arguments that define the attachment: File name, Media type, and actual file data.  The file name is just the name that the recipient will see associated with the attachment; it should not be a real file.  The media type determines which type of attachment it is, which helps e-mail readers display it accordingly.  For example, if you send <code>jpg/png</code> as a media type, the email reader will know that the attachment is an image, in which case it can show it as such.  For the blog entry data file, I'm going to use the JSON format, which uses the <code>application/json</code> media type.  The third and last argument is a string or sequence of bytes with the contents of the attachment. </p><br><p>  To make it simple, the <code>attachments</code> argument to <code>send_email()</code> will be a list of tuples, and each tuple will have three elements that correspond to the three arguments to <code>attach()</code> .  Therefore, for each item in this list, you must send a tuple as an <code>attach()</code> argument.  In Python, if you have a list or a tuple with arguments that you want to send to a function, you can use <code>func(*args)</code> to expand this list to an actual argument list, instead of using a more tedious syntax, such as <code>func(args[0], args[1], args[2])</code> .  For example, if you have <code>args = [1, 'foo']</code> , the call will send two arguments, as if you called <code>func (1, 'foo')</code> .  Without <code>*</code> call would have a single argument that would be a list. </p><br><p>  As for the synchronous sending of email, I just had to return to the <code>mail.send(msg)</code> call directly when <code>sync</code> <em>is</em> <code>True</code> . </p><br><h2 id="task-helpers">  Task helpers </h2><br><p>  Although the <code>example()</code> task I used above was a simple standalone function, a function that exports blog posts will require some of the functions that I have in the application, like database access and email sending functions.  Since this will be done in a separate process, I need to initialize Flask-SQLAlchemy and Flask-Mail, which, in turn, need an instance of the Flask application from which to get their configuration.  So I'm going to add an instance of the Flask application and the application context at the top of the <em>app / tasks.py module</em> : </p><br><blockquote>  <strong>app / tasks.py</strong> : Application creation and context. </blockquote><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_app app = create_app() app.app_context().push()</code> </pre> <br><p>  The application is created in this module, since it is the only module that will import the RQ worker.  When using the <code>flask</code> command, the <em>microblog.py</em> module in the root directory creates an application, but the RQ worker does not know anything about it, so it needs to create its own instance of the application, if necessary for the task functions.  You have already seen the <code>app.app_context()</code> method in several places, pressing the context makes the application the ‚Äúcurrent‚Äù application instance, and this allows extensions such as Flask-SQLAlchemy to use <code>current_app.config</code> to get their configuration.  Without context, the expression <code>current_app</code> returns an error. </p><br><p>  Then I thought about how I would report on the progress of this function.  In addition to sending progress information through the <code>job.meta</code> dictionary, I would like to send notifications to the client so that the completion percentage can be dynamically updated without having to refresh the page.  To do this, I'm going to use notification mechanisms similar to the ones I created in <a href="https://habrahabr.ru/post/354322/">Chapter 21</a> .  Updates will work similarly to the unread message icon.  When the server displays the template, it will include the "static" progress information obtained from <code>job.meta</code> , but then, as soon as the page appears in the client browser, the notifications will dynamically update the percentage using notifications.  Because of the notifications, updating the progress of the running task will be a little more complicated than how I did it in the previous example, so I'm going to create a decorator function to update the progress: </p><br><blockquote>  <strong>app / tasks.py</strong> : Set task progress. </blockquote><br><pre> <code class="hljs scala">from rq <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_current_job from app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> db from app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Task</span></span> # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_set_task_progress</span></span></span></span>(progress): job = get_current_job() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> job: job.meta[<span class="hljs-symbol"><span class="hljs-symbol">'progres</span></span>s'] = progress job.save_meta() task = <span class="hljs-type"><span class="hljs-type">Task</span></span>.query.get(job.get_id()) task.user.add_notification(<span class="hljs-symbol"><span class="hljs-symbol">'task_progres</span></span>s', {<span class="hljs-symbol"><span class="hljs-symbol">'task_i</span></span>d': job.get_id(), <span class="hljs-symbol"><span class="hljs-symbol">'progres</span></span>s': progress}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> progress &gt;= <span class="hljs-number"><span class="hljs-number">100</span></span>: task.complete = <span class="hljs-type"><span class="hljs-type">True</span></span> db.session.commit()</code> </pre> <br><p>  The export task can call <code>_set_task_progress()</code> to record the percent complete.       <code>job.meta</code>     Redis,     task      <code>task.user</code>    ,  ,    <code>add_notification()</code> .    <code>task_progress</code> ,  ,   ,     ,        (progress number).     JavaScript,       . </p><br><p>  ,     ,   ,       <code>complete</code>      .     ,     ,  <code>add_notification()</code> ,      .        ,     ,    -  ,         . </p><br><h2 id="realizaciya-zadachi-eksporta">    </h2><br><p>          .         : </p><br><blockquote> <strong>app/tasks.py</strong> :    . </blockquote><br><pre> <code class="hljs python"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export_posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment">#       #      except: #   </span></span></code> </pre> <br><p>       try/except?  ,     ,    ,    Flask  ,    ,         ,     .  , ,     ,   RQ,   Flask, ,    ,   , RQ    ,       . ,      RQ worker      -,    ,   . </p><br><p>       ,     ,       : </p><br><blockquote> <strong>app/tasks.py</strong> :    . </blockquote><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export_posts</span></span></span></span>(user_id): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: # ... except: _set_task_progress(<span class="hljs-number"><span class="hljs-number">100</span></span>) app.logger.error(<span class="hljs-symbol"><span class="hljs-symbol">'Unhandled</span></span> exception', exc_info=sys.exc_info())</code> </pre> <br><p>  ,    ,      ,    100%,     logger   Flask      ,    <code>sys.exc_info()</code> .    ,    flask Application logger    ,      Flask    . ,  <a href="https://habrahabr.ru/post/346880/"> 7</a>         .    <code>app.logger</code>        . </p><br><p>     ,            ,    : </p><br><blockquote> <strong>app/tasks.py</strong> :      . </blockquote><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time from app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User, Post # ... def export_posts(user_id): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: user = User.query.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_id) _set_task_progress(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> = [] i = <span class="hljs-number"><span class="hljs-number">0</span></span> total_posts = user.posts.count() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> user.posts.order_by(Post.timestamp.asc()): <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.append({<span class="hljs-string"><span class="hljs-string">'body'</span></span>: post.body, <span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>: post.timestamp.isoformat() + <span class="hljs-string"><span class="hljs-string">'Z'</span></span>}) time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) i += <span class="hljs-number"><span class="hljs-number">1</span></span> _set_task_progress(<span class="hljs-number"><span class="hljs-number">100</span></span> * i <span class="hljs-comment"><span class="hljs-comment">// total_posts) #      except: # ...</span></span></code> </pre> <br><p>          ,      .      ISO 8601.  <code>datetime</code> Python,   ,    ,       ISO   "Z",    UTC. </p><br><p>    -   .    <code>i</code> ,         ,        <code>total_posts</code> ,    .   <code>i</code>  <code>total_posts</code>           0  100. </p><br><p> ,  ,      <code>time.sleep(5)</code>    .  ,     sleep,   ,            ,         . </p><br><p>       ,        ,   <code>data</code>   : </p><br><blockquote> <strong>app/tasks.py</strong> :     . </blockquote><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json from flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_template from app.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> send_email # ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export_posts</span></span></span></span>(user_id): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: # ... send_email('[<span class="hljs-type"><span class="hljs-type">Microblog</span></span>] <span class="hljs-type"><span class="hljs-type">Your</span></span> blog posts', sender=app.config[<span class="hljs-symbol"><span class="hljs-symbol">'ADMIN</span></span>S'][<span class="hljs-number"><span class="hljs-number">0</span></span>], recipients=[user.email], text_body=render_template(<span class="hljs-symbol"><span class="hljs-symbol">'email</span></span>/export_posts.txt', user=user), html_body=render_template(<span class="hljs-symbol"><span class="hljs-symbol">'email</span></span>/export_posts.html', user=user), attachments=[(<span class="hljs-symbol"><span class="hljs-symbol">'posts</span></span>.json', <span class="hljs-symbol"><span class="hljs-symbol">'application</span></span>/json', json.dumps({<span class="hljs-symbol"><span class="hljs-symbol">'post</span></span>s': data}, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>))], sync=<span class="hljs-type"><span class="hljs-type">True</span></span>) except: # ...</code> </pre> <br><p>     <code>send_email()</code> .       ,     <code>attach()</code>  Flask-Mail's <code>Message</code> .    -  ,      Python <code>json.dumps()</code> . </p><br><p>    ,  ,        HTML .   : </p><br><blockquote> <strong>app/templates/email/export_posts.txt</strong> : Export posts text email template. </blockquote><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">Dear</span></span> {{ user.username }}, <span class="hljs-type"><span class="hljs-type">Please</span></span> <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> attached the archive of your posts that you requested. <span class="hljs-type"><span class="hljs-type">Sincerely</span></span>, <span class="hljs-type"><span class="hljs-type">The</span></span> <span class="hljs-type"><span class="hljs-type">Microblog</span></span> <span class="hljs-type"><span class="hljs-type">Team</span></span></code> </pre> <br><p>  HTML- : </p><br><blockquote> app/templates/email/export_posts.html: Export posts HTML email template. </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Dear </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.username }}</span></span><span class="xml"><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Please find attached the archive of your posts that you requested.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Sincerely,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">The Microblog Team</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><h2 id="eksport-funkcionalnosti-v-prilozhenii">     </h2><br><p>           .      ,           . </p><br><p>        <code>export_posts</code> : </p><br><blockquote> <strong>app/main/routes.py</strong> : Export posts route and view function. </blockquote><br><pre> <code class="hljs pgsql">@bp.route(<span class="hljs-string"><span class="hljs-string">'/export_posts'</span></span>) @login_required def export_posts(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.get_task_in_progress(<span class="hljs-string"><span class="hljs-string">'export_posts'</span></span>): flash(_(<span class="hljs-string"><span class="hljs-string">'An export task is currently in progress'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.launch_task(<span class="hljs-string"><span class="hljs-string">'export_posts'</span></span>, _(<span class="hljs-string"><span class="hljs-string">'Exporting posts...'</span></span>)) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'main.user'</span></span>, username=<span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.username))</code> </pre> <br><p>   ,       ,       .                ,   .     ,   <code>get_task_in_progress()</code> ,    . </p><br><p>      ,      <code>launch_task()</code> .  -  ,    RQ worker   <code>app.tasks.</code>  .  -   ,    .      <code>Task</code>   .       . </p><br><p>        ,         .  ,          ,          ,   " ": </p><br><blockquote> <strong>app/templates/user.html</strong> :      . </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.edit_profile') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Edit your profile') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> not current_user.get_task_in_progress('export_posts') %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.export_posts') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Export your posts') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>     ,     ,   ,     . </p><br><p>        ,      .     ,      RQ worker  : </p><br><ul><li> ,  Redis  </li><li>    ,       RQ.      <code>rq worker microblog-tasks</code> </li><li>       Flask,  <code>flask run</code> (    <code>FLASK_APP</code> ) </li></ul><br><h2 id="uvedomleniya-o-hode-vypolneniya">     </h2><br><p>    ,            .    Bootstrap,         . -   ,    .   - ,       .     ,    .    ,    : </p><br><p><img src="https://habrastorage.org/webt/sf/u5/44/sfu544ikvis0stvz41c8gpxhqqe.png"></p><br><blockquote> <strong>app/templates/base.html</strong> :        . </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml">... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> current_user.is_authenticated %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">with</span></span></span></span></span><span class="hljs-template-tag"> tasks = current_user.get_tasks_in_progress() %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> tasks %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> task </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> tasks %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"alert alert-success"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">role</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"alert"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ task.description }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ task.id }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">-progress"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ task.get_progress() }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">% </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endwith</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> ... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> ...</span></span></code> </pre> <br><p>          .              .        ,   <code>get_tasks_in_progress()</code> ,    .         ,           ,          ,   ,          . </p><br><p>       alert  .      CSS,      <code>alert-success</code> ,          alert-info. <a href="https://getbootstrap.com/docs/3.3/components/"> Bootstrap</a>      HTML  .    ,    ,     . </p><br><p>     <code>&lt;span&gt;</code> ,    <code>id</code> .     ,      JavaScript   . ,      ,       <code>-progress</code>  .   ,     ,        <code>&lt;span&gt;</code>       <code>#&lt;task.id&gt; - progress</code> . </p><br><p>       ,   ""   ,      .  ,             ,       . </p><br><p>        <code>&lt;span&gt;</code> ,       JavaScript: </p><br><blockquote> <strong>app/templates/base.html</strong> :         . </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml">... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> scripts %}</span></span><span class="xml"><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> ... function set_task_progress(task_id, progress) { $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#'</span></span></span></span><span class="xml"><span class="javascript"> + task_id + </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'-progress'</span></span></span></span><span class="xml"><span class="javascript">).text(progress); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>    <code>id</code>        jQuery    <code>&lt;span&gt;</code>            .      ,     ,   jQuery    ,       . </p><br><p>     ,    <code>_set_task_progress()</code>  <em>app/tasks.py</em>  <code>add_notification()</code>     .    ,         - ,   ,   <a href="https://habrahabr.ru/post/354322/"> 21</a>    ,        .  ,     <code>add_notification()</code> ,   ,        . </p><br><p>   JavaScript,    ,   ,    <code>unread_message_count</code> ,   .      ,     <code>task_progress</code> ,   <code>set_task_progress()</code> ,    .    ,     JavaScript: </p><br><blockquote> <strong>app/templates/base.html</strong> :  . </blockquote><br><pre> <code class="hljs matlab"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; notifications.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (notifications[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].name) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'unread_message_count'</span></span>: set_message_count(notifications[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].data); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'task_progress'</span></span>: set_task_progress( notifications[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].data.task_id, notifications[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].data.progress); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } since = notifications[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].timestamp; }</code> </pre> <br><p> ,       ,     <code>if</code> ,     <code>unread_message_count</code> ,  <code>switch</code> ,       ,     .         "C", ,     switch .    ,      <code>if/elseif</code> .       ,          . </p><br><p>   , ,   RQ    <code>task_progress</code> ,      <code>task_id</code>  <code>progress</code> ,        <code>set_task_progress()</code> . </p><br><p>     ,          10 ,     . </p><br><p>          ,    ,     .    ,     ,    Flask-Babel     ,     : </p><br><pre> <code class="hljs pgsql">(venv) $ flask translate <span class="hljs-keyword"><span class="hljs-keyword">update</span></span></code> </pre> <br><p>       ,      ,       <em>app/translations/es/LC_MESSAGES/messages.po</em>            . </p><br><p>  ,   ,     : </p><br><pre> <code class="hljs ruby">(venv) $ flask translate compile</code> </pre> <br><h2 id="rekomendacii-po-razvertyvaniyu">    </h2><br><p>         .           :  Redis      RQ. ,        ,        ,       ,   ,      . </p><br><h2 id="razvertyvanie-na-servere-linux">    Linux </h2><br><p>      Linux,  Redis     ,       .  Ubuntu Linux   <code>sudo apt-get install redis-server</code> . </p><br><p>     RQ,     " Gunicorn  Supervisor"  <a href="https://habrahabr.ru/post/352266/"> 17</a> ,     Supervisor,      <code>rq worker-tasks</code>  <code>gunicorn</code> .        (, ,   production),     <code>numprocs</code> ,  ,      . </p><br><h2 id="razvertyvanie-na-heroku">   Heroku </h2><br><p>     Heroku,     Redis    .    ,        Postgres. Redis    ,       : </p><br><pre> <code class="hljs pgsql">$ heroku addons:<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> heroku-redis:hobby-dev</code> </pre> <br><p> URL-     redis     Heroku    <code>REDIS_URL</code> ,    ,   . </p><br><p>    Heroku   web-dyno   worker dyno,        rq    ,    .             procfile: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">web</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">flask</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">db</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">upgrade</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">flask</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">translate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">compile</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">gunicorn</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">microblog</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:app</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">worker</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">rq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">worker</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">microblog-tasks</span></span></code> </pre> <br><p>             : </p><br><pre> <code class="hljs mel">$ heroku ps:<span class="hljs-keyword"><span class="hljs-keyword">scale</span></span> worker=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><h2 id="razvertyvanie-na-docker">   Docker </h2><br><p>      Docker     Redis.         Redis   Docker: </p><br><pre> <code class="hljs pgsql">$ docker run <span class="hljs-comment"><span class="hljs-comment">--name redis -d -p 6379:6379 redis:3-alpine</span></span></code> </pre> <br><p>       redis     <code>REDIS_URL</code> ,  ,    MySQL.      ,   redis: </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ docker run --name microblog -d -p 8000:5000 --rm -e SECRET_KEY=my-secret-key </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e MAIL_SERVER=smtp.googlemail.com -e MAIL_PORT=587 -e MAIL_USE_TLS=true </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e MAIL_USERNAME=&lt;your-gmail-username&gt; -e MAIL_PASSWORD=&lt;your-gmail-password&gt; </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--link mysql:dbserver --link redis:redis-server </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e DATABASE_URL=mysql+pymysql://microblog:&lt;database-password&gt;@dbserver/microblog </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e REDIS_URL=redis://redis-server:6379/0 </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">microblog:latest</span></span></code> </pre> <br><p> ,         RQ.        ,    ,      ,    ,   start up,     -.    <code>docker run</code> ,   worker: </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ docker run --name rq-worker -d --rm -e SECRET_KEY=my-secret-key </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e MAIL_SERVER=smtp.googlemail.com -e MAIL_PORT=587 -e MAIL_USE_TLS=true </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e MAIL_USERNAME=&lt;your-gmail-username&gt; -e MAIL_PASSWORD=&lt;your-gmail-password&gt; </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--link mysql:dbserver --link redis:redis-server </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e DATABASE_URL=mysql+pymysql://microblog:&lt;database-password&gt;@dbserver/microblog </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-e REDIS_URL=redis://redis-server:6379/0 </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--entrypoint venv/bin/rq </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">microblog:latest worker -u redis://redis-server:6379/0 microblog-tasks</span></span></code> </pre> <br><p>       Docker  ,         .  <code>--entrypoint</code>     ,   (  )           .   <code>rq</code>    <code>venv/bin/rq</code> ,        . </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/354322/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354752/">https://habr.com/ru/post/354752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354740/index.html">Implementing a RESTful Table in the Atlassian User Interface</a></li>
<li><a href="../354742/index.html">PHP could get better</a></li>
<li><a href="../354744/index.html">Protection against easy DDoS'a</a></li>
<li><a href="../354748/index.html">CPU Cache Myths About Programmers Believe</a></li>
<li><a href="../354750/index.html">Do not write too much</a></li>
<li><a href="../354756/index.html">DevConf 2018 - vote for reports</a></li>
<li><a href="../354758/index.html">How to assign a custom method for a button in a notification</a></li>
<li><a href="../354760/index.html">Too many cooks, or hacking the Internet with TR-069</a></li>
<li><a href="../354766/index.html">Walk between pixels</a></li>
<li><a href="../354768/index.html">Higher order components using Recompose</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>