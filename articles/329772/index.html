<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Designing and developing a template engine in C # and ANTLR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 


 For many years we have been helping our customers send good, informative and human letters to consumers. Instead of the dry ‚ÄúGood day‚Äù,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Designing and developing a template engine in C # and ANTLR</h1><div class="post__text post__text-html js-mediator-article"><h2 id="predystoriya">  Prehistory </h2><br><p>  For many years we have been helping our customers send good, informative and human letters to consumers.  Instead of the dry ‚ÄúGood day‚Äù, we write ‚ÄúHello, Nikita!‚Äù In them, and instead of ‚ÄúYour balance has increased,‚Äù we report ‚Äúyou received 25 points‚Äù.  But marketers are becoming more creative, and a modern letter from an online store should look like this: </p><br><p><img src="https://habrastorage.org/web/db6/d77/4f4/db6d774f451a43329ae7f407907c5c30.png" alt="In real life, all this is an order of magnitude greater in each letter."></p><br><p>  And we want to be able to generate such letters automatically. </p><a name="habracut"></a><br><p>  Our old, time-tested template engine can insert parameters into the right places of the letter, substitute something by default for the missing value and write ‚Äú1 ruble, 2 rubles, 5 rubles‚Äù, and does it well.  But it is not intended for complex branches, cycles, and any other complex logic.  Therefore, to form complex letters like in the picture, we had to resort to C # code, and it looked like this: </p><br><p><img src="https://habrastorage.org/web/f34/518/7c1/f345187c17bc4e359553487343030d61.png" alt="And then it is in a cycle, and placeholders are replaced with specific values."></p><br><p>  We ended up in a not very pleasant universe, where the client‚Äôs desire to italicize a word in a letter leads to a ticker for a programmer and a layout for production.  We did not want to linger in this universe, and it became clear that we needed a new template engine, which should be able to: </p><br><ul><li>  simple parameter output </li><li>  output of complex multi-level parameters (Recipient.Address.City.Name) </li><li>  conditions </li><li>  cycles </li><li>  arithmetic operations </li></ul><br><p>  And these are just business requirements based on real-world scenarios.  And since we want to make it easy for the manager to get started when sending newsletters and difficult to make mistakes, we need more: </p><br><ul><li>  clear error messages </li><li>  validation of parameters used in the template </li><li>  extensibility (ability to add your own functions) </li></ul><br><p>  And since we sometimes send millions of emails per hour, we need good performance, which means: </p><br><ul><li>  precompile template </li><li>  reuse pattern and thread safety </li></ul><br><p>  We looked at several of the available template engines, starting <a href="https://shopify.github.io/liquid/">Liquid</a> and ending with <a href="https://mustache.github.io/">Mustache</a> , and all of them are a bit weird.  Someone fails with the exception with an error, but simply renders an empty string.  Somewhere syntax is such that we, being programmers, could not figure out how to write a condition.  We seriously approached the insane idea of ‚Äã‚Äãusing <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/views/razor">Razor</a> , close and understandable to us, to form letters, but refused it because of the annoying little things: it turned out that the author of the mailing template could execute arbitrary .NET code in the process that sends the letter. </p><br><p>  And of course, in the end, we decided to write our own template engine.  With static typing and filter chains. </p><br><h2 id="dizayn-yazyka">  Language design </h2><br><p>  Almost immediately, we decided to abandon compatibility with something.  They rejected backward compatibility with the previous template engine: the syntax should be such that it can organically expand the language five years in the future, and not adapt to what has been developed for five years in the past.  They abandoned compatibility with some de facto standard, according to which everyone imposes letter templates: it simply does not exist.  We found ourselves in front of a completely white board on which we had to draw the syntax of our language, and immediately began to invent our own framework in which to create. </p><br><p>  First, the language must be embedded in HTML, which means it must provide escape sequences that separate our code blocks from the rest of the markup. </p><br><p>  We stopped at this option: </p><br><p><img src="https://habrastorage.org/web/0c6/20c/ef4/0c620cef49df437faafaa58c6371873f.png"></p><br><p> The idea of ‚Äã‚Äãseparating the output instructions <code>${ ‚Ä¶ }</code> and the non-output, service instructions <code>@{ ‚Ä¶ }</code> inspired by <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/views/razor">implicit and explicit expressions from Razor</a> .  We tried to see how it would look in a real HTML-layout, and yes, it turned out better and clearer. </p><br><p>  Later they remembered that the same syntax is used <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html">in TypeScript for string interpolation</a> (and in C # it is <a href="https://docs.microsoft.com/en-us/dotnet/articles/csharp/language-reference/keywords/interpolated-strings">different, but also similar</a> ).  It was nice: if Anders Hejlsberg considered this a good syntax, then we are on the right track. </p><br><p>  Secondly, we thought who would use our template language.  Most likely, the layout will be done by a layout designer to whom javascript is close and understandable.  On the other hand, the manager who does not know javascript, but knows English and common sense will most likely refine the layout of small things and correct little things in logic.  Therefore, our syntax in the end turned out to be more similar to Pascal, with normal human words <code>and</code> , <code>or</code> , <code>not</code> instead of stitches and ampersands. </p><br><p>  As a result, we stopped at this syntax: </p><br><p> <a href=""><img src="https://habrastorage.org/web/cf4/43b/940/cf443b94006148f691e348fcd1ba3374.png" alt="Branches, output variables of their fields, arithmetic operations, cycles, global functions, string constants and even a comment"></a> </p><br><p>  All that remains is nothing: blow the dust off the <a href="https://en.wikipedia.org/wiki/Compilers:_Principles,_Techniques,_and_Tools">‚Äúdragon book‚Äù</a> and implement lexical parsing, parsing, semantic analysis, and then ensure the generation of the output result - the letter. </p><br><h2 id="parsing-i-antlr">  Parsing and ANTLR </h2><br><p>  It should be obvious to everyone that <a href="https://en.wikipedia.org/wiki/Chomsky_hierarchy">Chomsky‚Äôs classification of the</a> language invented by us is described by context-free LL grammar, to parse which, respectively, it suffices to implement LL (*) - the parser.  And here we are faced with a small problem: we almost do not understand this and are not able to. </p><br><p>  We are well able to do complex web front-end with a large number of javascript, do complex server validation, work with terabyte databases and solve problems of performance and multithreading in terms of thousands of transactions per minute.  But linguistic grammars are not entirely our competence.  And ideally we have two weeks to develop a template engine. </p><br><p>  At this place we went and entered the following cheat code in Google: ANTLR.  The effect was not instantaneous, but after a couple of days spent reading the documentation and experiments, we got the kind of progress that would have taken a few weeks with manual development.  So what is Antlr and what does it take on? </p><br><p>  <a href="http://www.antlr.org/">ANTLR</a> (ANother Tool for Language Recognition) is an open library written by Terrence Parr, a professor at the University of San Francisco and the author of more than a dozen scientific articles on formal grammars and their analysis.  Little by little, it is used for parsing by guys from Google, Oracle and Microsoft (for example, in ASP.NET MVC).  Antlr fully assumes the lexical and syntactic analysis of the text, guided by the formal description of the grammar of the language. </p><br><p>  Of course, not everything was cloudless.  On close acquaintance, Antlr turned out to be a java-utility that needs to be run from the command line, trying to <a href="">find the right arguments</a> from conflicting articles of the documentation, so that it generates a C # code for which StyleCop will swear.  The documentation was found, but not everything that is implemented in the utility is described in the documentation, and - this was a blow - not everything that is described in the documentation (the official book from the author of the library) is already implemented in the utility.  C # support was not as complete as Java support, and from the working support tools we found only a <a href="https://marketplace.eclipse.org/content/antlr-4-ide">plug-in to Eclipse</a> . </p><br><p>  We can safely close our eyes to all this, because after we made this stupid thing work, we received a code that receives the stream with the text, and returns the complete syntax tree and classes to work around it. </p><br><p>  We did not write a template parser and never plan to do this in the future.  We described the grammar of the language, entrusting Antlr with the solution to boring everyday problems associated with its parsing, and left to ourselves interesting and unexpected problems related to everything else. </p><br><h2 id="grammatika-yazyka-leksicheskie-pravila">  Language Grammar: Lexical Rules </h2><br><p>  The ANTLR grammar description is made up of a set of recursive rules.  Anyone who has met the <a href="https://en.wikipedia.org/wiki/Backus%25E2%2580%2593Naur_form">BNF</a> , <a href="https://en.wikipedia.org/wiki/Syntax_diagram">Wirth diagrams,</a> or other means of describing formal languages ‚Äã‚Äãin the first or second year will be close to this idea. </p><br><p>  In the same way, we are close to the idea of ‚Äã‚Äãmaximum separation of lexical analysis from syntactic analysis.  We gladly took the opportunity to spread the rules defining terminals and primitive tokens of the language in different files, from syntax rules describing more complex composite and high-level constructions. </p><br><p>  We took the rules lexer.  The most important task is to make sure that we recognize our language only inside <code>${ ... }</code> and <code>@{ .... }</code> blocks, and leave the rest of the letter text unchanged.  In other words, the grammar of our language is <a href="https://en.wikipedia.org/wiki/Island_grammar">island grammar</a> , where the text of the letter is uninteresting ‚Äúocean‚Äù for us, and the inserts in curly brackets are interesting ‚Äúislands‚Äù.  The ocean block is absolutely opaque for us, we want to see it as one large token.  In the block of the island we want the most specific and detailed analysis. </p><br><p>  Fortunately, Antlr supports island grammars out of the box thanks to the mechanism of lexical modes.  Formulating the rules by which we divide the text into the ‚Äúocean‚Äù and ‚Äúislands‚Äù was not entirely trivial, but we managed: </p><br><p><img src="https://habrastorage.org/web/dd5/fa3/b8d/dd5fa3b8d4994830871175e51dfb9361.png" alt="This can be done by one rule with an alternative block, but then it will turn into a branch by the value of a constant in the code, but we are declarative."></p><br><p>  These rules put the parser into ‚Äúinside instruction‚Äù mode.  There are two of them, because earlier we decided to have a slightly different syntax for control instructions and output instructions. </p><br><p>  In the ‚Äúinside instruction‚Äù mode, a symmetric rule that returns the parser to the main mode when it encounters a closing brace. </p><br><p><img src="https://habrastorage.org/web/380/33a/b9d/38033ab9d25d43a8a6e7b941cc4eaef1.png"></p><br><p>  The keywords ‚ÄúpopMode‚Äù and ‚ÄúpushMode‚Äù hint to us that the parser has a mode stack, and they can be nested with some impressive depth, but for our grammar it is enough to switch from one mode to another and then come back. </p><br><p>  It remains to describe in the ‚Äúocean‚Äù a rule that will describe everything else, all text that is not an input to the instructions mode: </p><br><p><img src="https://habrastorage.org/web/98f/348/517/98f34851784c43788bcb7616347d0430.png" alt="A tilde is a negation, like a cap in regular expressions."></p><br><p>  This rule will be perceived as <em>Fluff</em> (nonsense, husks, minor garbage) any string of characters that does not contain <code>@</code> and <code>$</code> , or exactly one character <code>$</code> or <code>@</code> .  The Fluff token chain can then and must be glued together into one string constant. </p><br><p>  It is important to understand that the lexer tries to apply the rules as eagerly as possible, and if the current character satisfies two rules, the rule that captures the largest number of following characters will always be chosen.  That is why, when a sequence of <code>${</code> encountered in the text, the lexer will interpret it as an <em>OutputInstructionStart</em> , and not as two <em>Fluff</em> tokens for one character. </p><br><p>  So, we learned to find the ‚Äúislands‚Äù of our grammar.  This is a sterile and controlled space inside the template, where we decide what is possible and what is not, and what each symbol means.  This will require other lexical rules that work inside the instruction mode. </p><br><p>  We do not write a Python compiler and want to allow spaces, tabs, and line breaks wherever it looks reasonable.  Fortunately, this also allows Antlr: </p><br><p><img src="https://habrastorage.org/web/2f5/444/eae/2f5444eae1ab4448a66fc3d770270a1f.png" alt="It is also possible to redirect unwanted characters to a separate channel, from where they can, if desired, still be obtained, but for our tasks it is enough just to discard them."></p><br><p>  Such a rule, of course, can only exist in the "island" mode, so that we do not cut spaces and line breaks in the text of the letter. </p><br><p>  The rest is simple: we look at the approved example of the syntax and methodically describe all the tokens that we meet in it, starting with <em>DIGIT</em> </p><br><p><img src="https://habrastorage.org/web/f81/91d/336/f8191d33610a471bb41795aa32dcd2dd.png" alt="And the Number will be like this: Digit + ('.'Digit +)?"></p><br><p>  and ending with keywords ( <em>IF</em> , <em>ELSE</em> , <em>AND</em> and others): </p><br><p><img src="https://habrastorage.org/web/060/c58/816/060c588160984d82915cabd375a964a3.png"></p><br><p>  Register independence looks scary, but the documentation reasonably says that lexical analysis is an exact thing and implies the most explicit description, and heuristics, by definition, are not in all alphabets in the world.  We did not argue with that.  But we have <code>else if</code> perceived as one token (which is convenient), but at the same time it is not <code>elsif</code> and not <code>elseif</code> , as it happens in some languages. </p><br><p>  From somewhere in the depths of memories of the first and second year, disturbed by the words about the BNF and the Wirth diagram, an understanding emerges of how to describe <em>IDENTIFIER</em> so that the identifier can begin only with a letter: </p><br><p><img src="https://habrastorage.org/web/66f/33e/b0d/66f33eb0d0364215a8f8f0ec74a23a28.png" alt="When you try to use identifiers in different contexts, and the grammar goes into left-sided recursion, you really understand why they cannot begin with a digit."></p><br><p>  A few dozen are not the most complex rules, and you can emerge a level above - in the syntax analysis. </p><br><h2 id="grammatika-yazyka-sintaksicheskie-pravila">  Language Grammar: Syntax Rules </h2><br><p>  The structure of any letter in our templating system is simple and resembles a zebra: static layout blocks alternate with dynamic ones.  Static blocks are layouts with parameter substitution.  Dynamic is cycles and branching.  We described these basic blocks with the following set of rules (not fully given): </p><br><p><img src="https://habrastorage.org/web/128/c1f/e7f/128c1fe7f2e84ee7b08fe222934d9716.png"></p><br><p>  The syntax rules are described in the same way as the lexical rules, but they are not based on specific symbols (terminals), but on lexemes described by us (with a capital letter) or other syntax rules (with a small letter). </p><br><p>  Having examined the text with this set of rules, we got something similar: </p><br><p><img src="https://habrastorage.org/web/518/620/e1e/518620e1e26349619302b6c7410fcbe3.png" alt="Treetop"></p><br><p>  In static and dynamic blocks, there can be a set of instructions of arbitrary complexity, starting with the derivation of a single parameter and ending with complex branching based on the results of performing arithmetic operations within the loop.  In total, we got about 50 syntactic rules of this type: </p><br><p><img src="https://habrastorage.org/web/335/8f7/905/3358f7905f374ef1aa8f7e60c401b12e.png"></p><br><p>  Here we describe a complex conditional statement in which an <code>if</code> block is required, there may be several <code>else if</code> blocks <code>else if</code> and there may be (but not necessarily) one <code>else</code> block.  In the If block inside the familiar to us <em>templateBlock</em> is the one that can be anything, including another condition. </p><br><p>  Somewhere in this place, our grammar began to be really recursive, and it became creepy.  Putting the last closing brace, we generated the parser code of our grammar using ANTLR, connected it to our project and wondered what to do with all this. </p><br><h2 id="ot-dereva-k-derevu">  From tree to tree </h2><br><p>  The result of Antlr from version 4 is a parser that turns the text into a so-called <a href="https://en.wikipedia.org/wiki/Parse_tree">concrete syntax tree</a> , it is also a parser tree.  By concrete is meant that the tree contains all the information about the syntax, every service word, every brace and comma.  This is a useful tree, but not exactly what is needed for our tasks.  Its main problems are too much connectedness with the syntax of the language (which will inevitably change) and perfect ignorance about our subject area.  Therefore, we decided to bypass this tree exactly once and build on its basis our own tree, which is closer to the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> and is more convenient for further use. </p><br><p>  Requirements for the tree are: </p><br><ul><li>  It should not contain details of the syntax (it is important for us that there is a branch into three branches, and the words <code>if</code> , <code>else if</code> and <code>else</code> not interesting) </li><li>  Must support all typical bypass scripts (letter rendering with parameter value substitution, getting a list of parameters and their types) </li></ul><br><p>  The simplified interface of the top of our tree ultimately looks like this (the set of descendants and the logic of their traversal are too different for different nodes, therefore they are not in the general interface): </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ITemplateNode</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PerformSemanticAnalysis</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AnalysisContext context</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder resultBuilder, RenderContext renderContext</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  Inspired by the <a href="https://blogs.msdn.microsoft.com/ericlippert/2012/06/08/persistence-facades-and-roslyns-red-green-trees/">stories of the creators of Roslyn about red-green trees</a> , we decided that our tree would be completely immutable.  First, it is easier and easier to work with such code without asking questions about the state and sequence of changes.  Secondly, this is the easiest way to provide thread safety, which means that you can use one precompiled letter template to send in many threads.  In general, the beauty left to build it. </p><br><p>  It is suggested to bypass the parser tree generated by Antlr using the <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor</a> pattern.  Antlr itself provides the visitor interface, as well as a basic implementation, which goes all the vertices of the tree in depth, but does nothing at the same time. </p><br><p>  Of course, there is an option to make one giant visitor, which will implement a detour of all our rules, of which there‚Äôs not so much, but almost 50. But it‚Äôs much more convenient to describe several different visitors, the task of each of which is to construct one vertex of our resultant tree. </p><br><p>  For example, to bypass conditions inside <code>@{ if } ‚Ä¶ {else if } ‚Ä¶ {else } .. @{ end if }</code> we use a special visitor: </p><br><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionsVisitor</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QuokkaBaseVisitor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionBlock</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConditionsVisitor(VisitingContext visitingContext) : base(visitingContext) { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> ConditionBlock VisitIfCondition(QuokkaParser.IfConditionContext context) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConditionBlock( context.ifInstruction().booleanExpression().Accept( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BooleanExpressionVisitor(visitingContext)), context.templateBlock()?.Accept( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TemplateVisitor(visitingContext))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> ConditionBlock VisitElseIfCondition(QuokkaParser.ElseIfConditionContext context) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConditionBlock( context.elseIfInstruction().booleanExpression().Accept( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BooleanExpressionVisitor(visitingContext)), context.templateBlock()?.Accept( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TemplateVisitor(visitingContext))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> ConditionBlock VisitElseCondition(QuokkaParser.ElseConditionContext context) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConditionBlock( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrueExpression(), context.templateBlock()?.Accept( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TemplateVisitor(visitingContext))); } }</code> </pre> <br><p>  It encapsulates the logic of creating a <code>ConditionBlock</code> object from a fragment of the syntactic tree describing the branch of the conditional operator.  Since inside the condition there can be an arbitrary piece of the template (the grammar is something recursive), the control for parsing everything inside is again transferred to the universal visitor.  Our visitors are related recursively about the same way as grammar rules. </p><br><p>  In practice, it is easy and convenient to work with such small visitors: they only bypass those elements of the language that we expect to see in each particular place, and their work consists either in instantiating a new vertex of the tree that we are building or in transferring control to another visitor. which deals with a narrower task. </p><br><p><img src="https://habrastorage.org/web/d82/51f/c40/d8251fc40169493596fb6ba55e93260b.png"></p><br><p>  At the same stage, we get rid of some inevitable formal grammar artifacts, such as redundant brackets, conjunctions and single argument clauses, and other things needed to define left-recursive grammar and absolutely unnecessary for applied tasks. </p><br><p>  As a result, we obtain from such a tree </p><br><p> <a href=""><img src="https://habrastorage.org/web/782/a63/573/782a6357324645738d7f0b183883db01.png" alt="The photo shows a syntax tree corresponding to the syntax example above."></a> </p><br><p>  such a </p><br><p> <a href=""><img src="https://habrastorage.org/web/d0f/2cc/ebc/d0f2ccebc1de40a6be8d168fbc0fd7c7.png" alt="The colored blocks are painted roughly over the nodes of the parser tree that they replace. Powered by Paint.Net"></a> </p><br><p>  This tree is much better placed in the head, does not contain useless information, its nodes encapsulate the implementation of specific instructions, and in general you can work with it. </p><br><p>  It remains quite a bit - to bypass it several times.  And the first, required traversal is a traversal for semantic analysis. </p><br><h2 id="poluchenie-spiska-parametrov-i-tipizaciya">  Getting the list of parameters and typing </h2><br><p>  One of the key tasks of our template engine is the ability to find in the text of the letter all the parameters used in it.  The goal is clear: to validate and not to save the template, in which there are parameters that we can not substitute in the letter.  For example, <code>Recipient.Email</code> we know, but <code>Recipietn.Eamil</code> is not.  It is important for us that the sender learns about the error in the template immediately when it is saved, and not when trying to send an email. </p><br><p>  However, this is not the only direction of parameter validation.  Do we want to write <code>${ Recipient.Email + 5 }</code> in the letter, knowing that <code>Email</code> in our system is a string field?  It seems not.  It means that we must not only find all the parameters in the letter, but also determine their type.  At this point, we thought about typing and realized that it is static (which is good), but implicitly (which is convenient for the user, but inconvenient for us).  We felt a fleeting impulse to make the manager declare all the parameters at the beginning of the letter, indicating the type.  User friendliness won, momentum suppressed.  It is necessary to determine the type ‚Äúon the fly‚Äù based on the context. </p><br><p>  The type system of our template engine looks like this: </p><br><ul><li>  primitive type <br><ul><li>  integer </li><li>  a fractional number </li><li>  boolean value </li><li>  date Time </li></ul></li><li>  a composite type containing named properties of any type </li><li>  a multiple type (array, collection, list, whatever) containing several values ‚Äã‚Äãof one specific type </li></ul><br><p>  The approach to solving the problem is simple: in order to determine the type of the parameter included in the letter, it is enough to find all its uses in the text and try to determine a consistent type that satisfies all occurrences or report a template error.  In practice, this was not the easiest task with a bunch of special cases that need to be taken into account. </p><br><p>  It turned out that the loop variables have scope.  It turned out that there are nested loops on the list of lists.  It turned out that you can loop through the same list in two different places in the template, and refer to different fields of the list items.  In general, we needed a strong static analysis, which we had to think about as well as a few dozen unit tests, but we are happy with the result. </p><br><p><img src="https://habrastorage.org/web/ba6/ae1/a47/ba6ae1a47ca54280990f05266ed217e0.png" alt="Two different iterations on an element that is itself the result of an iteration"></p><br><p>  Looking at this template, we can say that the consumer must have an array of products, and each product has a price and an array of categories, and each category must have both an identifier <code>Id</code> and the name <code>Name</code> .  Now it‚Äôs enough to ask our system if there are any parameters of such a structure in it, and there will be no surprises when sending it.   . </p><br><h2 id="rendering">  </h2><br><p>      :            ,       ,     -    (  ). </p><br><p>             :  ,    ,    ,     . </p><br><p>       ,                ?  , : </p><br><p><img src="https://habrastorage.org/web/d58/893/efe/d58893efef614aa1af94d0163cba1bac.png"></p><br><p>      ,  B = 0.   ‚Äì      ,      ,   - : </p><br><p><img src="https://habrastorage.org/web/8f5/aea/a8d/8f5aeaa8d1584792b9e22d25e47ef28a.png"></p><br><p>    ,  ,          ,    ,      : </p><br><ul><li>  reasonable defaults (  null-   ,     null-  false,       NaN   ) </li><li>   <a href="https://en.wikipedia.org/wiki/Fail-fast">fail fast</a> </li></ul><br><p>  :     ,     .    ,       .  fail fast, ,    ,    . </p><br><p>           ,         .      ,  -   :  -      ,  ,    .         ,      .  ,   ,        : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToUpperTemplateFunction</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScalarTemplateFunction</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">string, string</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ToUpperTemplateFunction() : base( <span class="hljs-string"><span class="hljs-string">"toUpper"</span></span>, new StringFunctionArgument(<span class="hljs-string"><span class="hljs-string">"string"</span></span>)) { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> string Invoke(string argument1) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> argument1.ToUpper(CultureInfo.CurrentCulture); } }</code> </pre> <br><p>    :        ,      - ,   ,     . </p><br><h2 id="itogi">  Results </h2><br><p>       ,          .      ,   ,    ,   Not invented here ‚Äì ,      ,    ,     . </p><br><p> ,          ,           ,    ,    ,     . </p><br><p>     ,    ,  -     ,   ,         . </p><br><h4 id="ssylki">  References: </h4><br><ol><li> <a href="http://mindbox.ru/blog/auto-templater/">       Mindbox</a> </li><li> <a href="http://www.antlr.org/">ANTLR</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/329772/">https://habr.com/ru/post/329772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329758/index.html">IT project with schoolchildren: a few recommendations</a></li>
<li><a href="../329760/index.html">Implementation of the access system in its own corporate messenger: part one</a></li>
<li><a href="../329762/index.html">How to apply ‚Äúbig data‚Äù in insurance: ITMO University projects</a></li>
<li><a href="../329766/index.html">Evaluate the effectiveness of Guetzli - optimization time and compression ratio</a></li>
<li><a href="../329768/index.html">The fading border between corporate and personal accounts</a></li>
<li><a href="../329774/index.html">Biometrics: not as difficult as it seems</a></li>
<li><a href="../329776/index.html">Why it was worth visiting OS Day 17</a></li>
<li><a href="../329778/index.html">Brief history of random numbers</a></li>
<li><a href="../329780/index.html">Chrome won</a></li>
<li><a href="../329782/index.html">Create your own Angular 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>