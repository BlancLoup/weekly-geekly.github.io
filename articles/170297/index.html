<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pattern Processing Optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In practice, we had to deal with some not obvious features of the performance of template processing. The study of the issue gave rise to a small stud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pattern Processing Optimization</h1><div class="post__text post__text-html js-mediator-article">  In practice, we had to deal with some not obvious features of the performance of template processing.  The study of the issue gave rise to a small study, the results of which I hasten to share. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  Currently I am developing a fairly large project on Django.  The project is large, I am actually developing it alone, respectively, the issue of optimization arises only when it is completely gone.  General technical information on the project: <br>  Project size: about 70k lines <br>  Django: 1.4.3 <br>  Environment: apache2 + mod_wsgi + virtualenv, python2.6, mysql, dedicated server.  The project on the server is not the only one. <br><br><h4>  Problem evaluation </h4><br>  I am a fan of the invention of bicycles; according to this decorator, I collected the execution time, the module name, the name of the function, the user and the key parameter from the presentation and saved everything in the database. <br><br>  The result - the average execution time of one of the main ideas was 1200ms, which is extremely sad. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Database Optimization </h4><br>  The first thing that comes to mind is of course the ineffective work with the database.  A sufficiently large amount of work was carried out, which reduced the number of queries to the database in half, their complexity (and the execution time) was still doubled.  It was supposed that this would correct the situation, but the result was not at all impressive.  The execution time dropped ‚Äúonly‚Äù to 100ms and amounted to 1,100ms, which did not make the weather.  Stock optimization database still remained, but there are many other ways, but it became clear that the problem is clearly not in working with the database.  More detailed profiling of the presentation function showed that about 80-90% of the time a line that you get used to not notice is executed: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> direct_to_template(request, template_name, locals())</code> </pre> <br>  As a template engine in the project, hamlpy is used, which in itself is not fast.  The templates themselves are quite complex - they include double inheritance, several include, cycles, quite a lot of logic associated with the display.  However, 950ms for rendering is too much. <br><br>  Updating hamlpy to the latest version won about 50ms more.  Rendering a template still takes an average of 900ms. <br><br>  A more detailed study of the issue allowed us to learn that django can cache templates, and this should be configured separately: <br><br><pre> <code class="python hljs">TEMPLATE_LOADERS = ( (<span class="hljs-string"><span class="hljs-string">'django.template.loaders.cached.Loader'</span></span>, ( <span class="hljs-string"><span class="hljs-string">'hamlpy.template.loaders.HamlPyFilesystemLoader'</span></span>, <span class="hljs-string"><span class="hljs-string">'hamlpy.template.loaders.HamlPyAppDirectoriesLoader'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.template.loaders.filesystem.Loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.template.loaders.app_directories.Loader'</span></span>, )), )</code> </pre><br>  The processing time of the template has fallen markedly, to 500-600ms, but still remains significant.  At the same time, an unpleasant effect appeared - changes in patterns, which is logical, ceased to cling on the fly.  So under DEBUG it is better to refuse caching. <br><br>  Looking in more detail at these statistics, I noticed that the results are heterogeneous.  If I had a distribution graph, then probably there would be not one Gaussian curve, but two.  Curiosity overcame laziness, and graphics were fastened to the statistics.  Going back a bit, this is how the distribution of template processing time looks like without caching: <br><br><img src="https://habrastorage.org/storage2/448/7d9/d9f/4487d9d9f39ec6f4b7c01dbd3c3ef4f1.png" alt="image"><br>  There is no clearly defined curve on the graph, since the statistics are collected from one representation without specification.  The output HTML code of this view depends on a large number of different parameters, and the processing of its template takes different times.  The peaks in the graph are presumably the result of overlapping curves from several key factors.  Probably, if we take the samples not only by the presentation, but also by its parameters, then we would get the classical curves.  But this is somewhat beyond the scope of the study. <br><br>  Returning to caching, its distribution schedule looks like this: <br><br><img src="https://habrastorage.org/storage2/9a5/50b/b6e/9a550bb6ed4c1d7e9a0e2418257e6988.png"><br>  Indeed, it has two peaks.  The nature of the peak on the left is clear - this is the result of caching.  But the peak on the right obviously arises from the lack thereof.  Apache regularly kills streams of execution to protect against memory leaks.  How often he does it is unknown to me, but judging by the schedule, he kills them after every third request, which makes caching not too effective. <br>  Go to the Apache host configuration and do the following: <br><br> <code>WSGIDaemonProcess mysite threads=5 maximum-requests=5 <br></code> <br><br>  This translates the life cycle of threads from running Apache to mod_wsgi and sets the lifetime of the thread to 5 requests.  We get the following schedule: <br><br><img src="https://habrastorage.org/storage2/05c/3a2/a6f/05c3a2a6f9df8a8aedf0761c5984a08e.png" alt="image"><br>  As you can see, the peak on the right has become smaller.  Streams began to die less often, caching efficiency increased, the average execution time fell.  The path is clearly correct, but a well-running caching schedule should obviously look different.  We increase the lifetime to 10 queries: <br><br><img src="https://habrastorage.org/storage2/f2c/ca3/dfd/f2cca3dfde03b611dc5cbc07a689e9ff.png" alt="image"><br>  Already not bad.  The execution time has fallen noticeably to an acceptable value of 230ms.  The best is the enemy of the good, and the longevity of the stream is not nonsense.  The study of memory consumption through top did not reveal any tangible problems, so we increase the life expectancy to 15: <br><br><img src="https://habrastorage.org/storage2/869/88c/9ee/86988c9ee1b1d110c1307820a32250ae.png" alt="image"><br>  Such a graph looks plausible - not cached requests are no longer statistically significant, which means a further increase in the life of threads will not give a tangible result.  The total execution time reached is 190ms.  The time of the performance of the performance fell from 900 to 290ms, which is much better. <br><br><h4>  findings </h4><br>  When optimizing the application code, you should also pay attention not only to the presentation itself, but also to the template processing.  A key factor in the struggle for processing speed may be the life of threads executing your application.  In my case, the optimal life time of threads was 15 requests, but most likely for different projects it could be a different number that needs to be selected, looking at the memory consumption. </div><p>Source: <a href="https://habr.com/ru/post/170297/">https://habr.com/ru/post/170297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170277/index.html">Postcard Habrahabru from the radio station "Mayak"</a></li>
<li><a href="../170281/index.html">Our answer is 3doodler. Assembled in 20 minutes</a></li>
<li><a href="../170283/index.html">Apple seems to be working hard on iWatch</a></li>
<li><a href="../170285/index.html">APT1: Exposing a Chinese organization engaged in industrial cyber espionage</a></li>
<li><a href="../170295/index.html">Chromebook Pixel released - price from $ 1299</a></li>
<li><a href="../170299/index.html">Pre-order available on Google Chromebook Pixel. Screen 2560x1700, 1.8GHz Core i5, touchscreen, optional LTE</a></li>
<li><a href="../170303/index.html">Bitcoin 0.8.0 released (Important changes)</a></li>
<li><a href="../170305/index.html">How we created a cluster from Raspberry Pi</a></li>
<li><a href="../170307/index.html">Prototype against designer</a></li>
<li><a href="../170313/index.html">Another boring, boring story about the first independent project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>