<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaFX and AnimationTimer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The application of an interesting class in a JavaFX application is to prevent the window from ‚Äúfreezing‚Äù during a long process. At the same time a lit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaFX and AnimationTimer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/88a/60f/312/88a60f3121dc05d606ff0c86dd0339d4.png" alt="Countdown" title="Countdown" align="right">  The application of an interesting class in a JavaFX application is to prevent the window from ‚Äúfreezing‚Äù during a long process.  At the same time a little bit about the features of drawing scenes in JavaFX. <a name="habracut"></a><br><br>  Suppose there is a desire (and / or necessity) to set up a Java desktop application with a long process mapping.  Well, you never know, there is a long cycle of calculations, and the desire to see the result of each iteration, at least briefly.  To make sure that the process goes in the right direction, maybe a histogram of which to build. <br><br>  Suppose the interface is decided to do on JavaFX.  Somehow: <br><div class="spoiler">  <b class="spoiler_title">file main.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> romeogolf.example1; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.animation.AnimationTimer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.application.Application; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.event.ActionEvent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.event.EventHandler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.geometry.Pos; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.Scene; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.control.Button; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.control.Label; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.layout.HBox; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.layout.VBox; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.scene.text.Font; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javafx.stage.Stage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ArrayList&lt;Label&gt; aLabels = new ArrayList&lt;Label&gt;(); //   final private int digitCount = 5; //   + 1 //   final private int maxCount = 12345; public static void main(String[] args) { launch(args); } @Override public void start(Stage primaryStage) { primaryStage.setTitle("Example"); VBox vbox = new VBox(); vbox.setAlignment(Pos.CENTER); vbox.setSpacing(20); HBox hbox = new HBox(); hbox.setAlignment(Pos.CENTER); hbox.setSpacing(20); for(int i = 0; i &lt;= digitCount; i++){ aLabels.add(new Label("X")); aLabels.get(i).setFont(new Font("Arial", 30)); aLabels.get(i).setStyle("-fx-padding: 5;" + "-fx-border-color: rgb(49, 89, 23);" + "-fx-border-radius: 5;"); hbox.getChildren().add(aLabels.get(i)); } // ,   Button button = new Button("Start"); button.setOnAction(new EventHandler&lt;ActionEvent&gt;() { @Override public void handle(ActionEvent e) { longProcess(); } }); vbox.getChildren().add(hbox); vbox.getChildren().add(button); primaryStage.setScene(new Scene(vbox, 55 * (digitCount + 1), 100)); primaryStage.show(); } //    private void longProcess(){ //  } }</span></span></code> </pre> </div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/ee5/b90/def/ee5b90def9f4bef213ba7340a6893ca6.png" alt="" title="Window">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This will result in a window that so far nothing can.  For test purposes, I‚Äôll add wildly complex calculations as an increment to a counter variable.  The longProcess method will then look, let's say, like this: <pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">longProcess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> digit; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxCount; i++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt;= digitCount; j++){ digit = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (i % (Math.pow(<span class="hljs-number"><span class="hljs-number">10.0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)(j + <span class="hljs-number"><span class="hljs-number">1</span></span>)))); digit = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (digit / (Math.pow(<span class="hljs-number"><span class="hljs-number">10.0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)j))); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aLabels.get(digitCount - j).setText(Integer.toString(digit)); } } }</code> </pre><br>  Here, a certain number i is plainly broken down into numbers and displayed in the familiarity.  Launch this creation by an insane programmer genius and press a single button.  Very quickly get the result, almost instantly: <br><br><img src="//habrastorage.org/files/45a/8e9/471/45a8e94710e14f4988cc6ddb44c5c990.png" alt="" title="Result"><br><br>  Very happy that so fast.  But bad luck is that this is not the problem.  The goal was to see the whole process, albeit slowly.  That would somehow slow down each pass of the cycle and give the command to display the result ... Something like repaint () in Swing, or some refresh, update, maybe, <nobr>Application.ProcessMessages</nobr> . <br><br>  Not provided.  In Swing, when you call a redraw, it is immediately implemented.  In JavaFX, the redraw requirement is reflected in the scene graph, and the scene is redrawn when the time comes when pulse is ticked.  Pulse is an event that tells the scene graph that it‚Äôs time to draw.  It ticks no more than 60 fps, if the animation is running, and, if necessary, if changes occurred in the scene graph.  This is the so-called Retained Mode, which is often translated as ‚Äúabstract mode‚Äù, implying that this approach increases the level of abstraction, in contrast to Immediate Mode - the direct mode. <br><br>  Article <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ff684178%2528v%3Dvs.85%2529.aspx" title="Retained Mode Versus Immediate Mode">Retained Mode Versus Immediate Mode</a> describes the difference between the approaches on the example of Direct2D and WPF.  I will translate the last paragraph: <br><blockquote>  Retained Mode API is easier to use, because this API does more work for you: initialization, state maintenance, cleaning.  But on the other hand, such an approach is often less flexible, since this API imposes its own scene model.  In addition, the Retained Mode API may have increased memory requirements, as it is necessary to provide a general-purpose scene model.  Using the Immediate Mode API you can implement targeted optimization. </blockquote><br>  What to do?  Let's try this.  We take out the counter from the loop variable, make it a class field (let's say, right before the new method): <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  Let's make a new method a little differently (you can simply change the old one, but if you leave, it will be easier to switch between the old and new versions).  Remove the outer loop altogether: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">longProcess2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> digit; <span class="hljs-comment"><span class="hljs-comment">//     for(int j = 0; j &lt;= digitCount; j++){ digit = (int) (counter % (Math.pow(10.0, (double)(j + 1)))); digit = (int) (digit / (Math.pow(10.0, (double)j))); this.aLabels.get(digitCount - j).setText(Integer.toString(digit)); } // ******* //  ,  : counter++; // ******* }</span></span></code> </pre><br>  Add the following code at the end of the Main class: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> AnimationTimer at = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnimationTimer(){ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> now)</span></span></span><span class="hljs-function"> </span></span>{ longProcess2(); } };</code> </pre><br>  To start the process in processing a button instead of <br><pre> <code class="java hljs"> longProcess();</code> </pre><br>  set <br><pre> <code class="java hljs"> at.start();</code> </pre><br>  And for a timely stop, we insert into the longProcess2 () method itself, which implements the process, the following lines (at the very beginning): <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter &gt; maxCount){ at.stop(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  Now about why this was all needed.  As a result, an at-instance of the AnimationTimer class is created.  Its handle () method is called each time the application window is redrawn.  That is, by calling longProcess2 (), we ordered to redraw the familiarity of numbers.  Caused the need to redraw the scene.  It calls handle (), and starts longProcess2 () again.  And so on until in the method itself longProcess2 () there is a stop condition for at.stop (). <br><br>  Now when you press the button in the "windows" tsiferki will flicker.  Flicker at different speeds, depending on the price of the discharge. <br><br><img src="//habrastorage.org/files/237/71b/a38/23771ba3851545c8a6bd4e880122374d.png" alt="" title="Process"><br><br>  If, for example, increase digitCount to 7, and maxCount - to 98765432, the difference between the options without a timer and with a timer will become significantly more noticeable.  In the initial version, you will have to contemplate the crosses in the familiarity until the process is completed, and even close the window in the traditional way (the ‚Äúcross‚Äù in the upper right corner) does not work.  In the version with the timer, the process is wonderfully displayed, the window can be dragged behind the title and closed at any time, but the process itself will stretch incredibly.  Here the question is what more is needed - speed or display. <br><br>  In fact, the speed can be slightly increased by skipping the display of individual iterations, and the more we skip, the faster we finish, although we will see less.  To do this, you can insert into longProcess2 (), at the very end, instead of <br><pre> <code class="java hljs"> counter++;</code> </pre><br>  something like <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> skip = <span class="hljs-number"><span class="hljs-number">0</span></span>; skip &lt; <span class="hljs-number"><span class="hljs-number">100000</span></span>; skip++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter &gt;= maxCount){ <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } counter++; }</code> </pre><br>  Then the result of each 100-thousandth iteration will be displayed, and thanks to the stop condition, the final result will be displayed at the end.  True, in the process, the lower digits will be stupidly zeros, but for clarity, they can also be washed out somehow.  However, these are details from the field of whistles, for example, it has no relation. <br><br>  It would be possible to add the reset of the counter before each start of the timer, the inadmissibility of the secondary start of the timer when it is already running (and this is possible!) And some other useful whistles, but this is a brute force to show an example. <br><br>  A little bit about AnimationTimer: someone Mike wrote a very good article about <a href="http://blog.netopyr.com/2012/06/14/using-the-javafx-animationtimer/" title="Using the JavaFX AnimationTimer">using the JavaFX AnimationTimer</a> on his blog. <br><br>  Mike believes that it was not a particularly good idea to call this class.  After all, it can be used not only for animation: for measuring fps-rate, for detecting collisions, for calculating modeling steps, as the main loop in games, etc. Personally, he most often sees AnimationTimer applications that are not related to animation .  AnimationTimer provides an extremely simple, but very flexible and useful feature.  The timer allows you to define the method that will be called for each frame.  What this method will do is not only unlimited, but, as mentioned above, may have nothing to do with animation.  The only requirement is that this method should be fast enough, otherwise it will simply become a bottleneck in the system. <br><br>  Of course, there is not the only way to solve this problem, but I liked this timer - it's simple and quite convenient.  Who did not know him - please love and favor. </div><p>Source: <a href="https://habr.com/ru/post/217269/">https://habr.com/ru/post/217269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217251/index.html">Quick Mozilla debugger with recording and playback</a></li>
<li><a href="../217253/index.html">Making a remake of "Chopper Duel" on Android</a></li>
<li><a href="../217255/index.html">Authorization on the Internet</a></li>
<li><a href="../217261/index.html">LuckyTee.ru - designs sent by the users themselves</a></li>
<li><a href="../217267/index.html">Oort cloud - we are waiting for the mass of discoveries</a></li>
<li><a href="../217281/index.html">How to create and make money on SaaS (Part 3 / sales through a partner channel, which may not be needed)</a></li>
<li><a href="../217283/index.html">How to create and earn SaaS (Part 2 / invaluable experience of Russian ISV)</a></li>
<li><a href="../217285/index.html">Friendly AI and the capture of the universe</a></li>
<li><a href="../217287/index.html">Microsoft has finally introduced Office for iPad</a></li>
<li><a href="../217289/index.html">TOX: What happened in the project for six months</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>