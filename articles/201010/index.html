<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FileAPI 2.0: Uploading files to the server a year later</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! About a year ago, I presented to you the first version of the open-source FileAPI library , designed to work with files on the client and the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FileAPI 2.0: Uploading files to the server a year later</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c9e/c06/907/c9ec069077a789d6569e563c618cb43f.png" alt="FileAPI 2.0" align="right">  Hi Habr!  About a year ago, I presented to you the first version of the <a href="http://habrahabr.ru/company/mailru/blog/159587/">open-source FileAPI library</a> , designed to work with files on the client and then upload to the server. <br><br>  During this time a long way has been traveled.  The library earned <a href="https://github.com/mailru/FileAPI/stargazers">670+</a> stars and <a href="https://github.com/mailru/FileAPI/network/members">90+</a> forks.  With the help of the github-community, we managed to fix many "childish" problems and make a number of improvements.  More than <a href="https://github.com/mailru/FileAPI/issues%3Fsort%3Dcreated%26state%3Dclosed">100</a> tasks were closed, and thanks to Ilya Lebedev, file downloads were made in parts.  Today, I am proud to present you <a href="http://mailru.github.io/FileAPI/">FileAPI 2.0</a> . <a name="habracut"></a><br><br><br>  So, the first version had the following features: <ul><li>  multiple file selection; </li><li>  getting information (name, size and mime type); </li><li>  generation of preview before loading; </li><li>  scaling, cropping and rotation on the client; </li><li>  upload all that happened to the server + CORS; </li><li>  support for all of the above in older browsers, including IE6. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Flash is used to support older browsers.  Unlike other similar solutions, where you need to explicitly set the element that will be the "Select files" button, FileAPI does not impose such restrictions.  The developer does not need to think about which technology the library is currently using.  At the same time, the written code is as close as possible to the native one, i.e.  HTML5: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-fileapi-wrapper"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> input = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"file"</span></span></span><span class="javascript">); FileAPI.event.on(input, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"change"</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> list = FileAPI.getFiles(input); </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    FileAPI.upload({ url: "./ctrl.php", files: { userFiles: list }, complete: function (err, xhr){ /*...*/ } }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The library will determine the capabilities of the browser and, if something is missing, switches to Flash. <br><br>  Almost immediately after publication, I began to receive the first reviews and suggestions, I will give the most interesting ones. <br><br><h5>  Error during obfuscation </h5>  One user code did not work, at all.  The problem was in the construction <code>(api.expando + ++gid)</code> .  It turned out that his obfuscator did not understand it and simply removed spaces, which led to a syntax error, so the code had to be changed to <code>(++gid, api.expando + gid)</code> . <br><br><h5>  Features integration with Amazon S3 </h5>  When calling the FileAPI.upload method, the library adds a unique GET parameter to the url to which you need to make a request, in order to avoid caching the POST post request on mobile devices.  When integrating with Amazon S3, it turned out that it does not allow GET parameters.  Since it is impossible to accurately determine all mobile devices by the user-agent, a cache option has been added to the upload, with which you can influence the addition of a unique GET parameter. <br><br><h5>  Work with images </h5>  All images were forcibly converted to png, which led to a drag on the size of the output file, and the original type also changed, which was critical for many tasks.  In addition, it is often necessary to add a watermark to the uploaded image or to take a picture of "yourself" using WebCam. <br><br><h5>  "Download" without files </h5>  Since the API was created for uploading files, the <code>FileAPI.upload</code> method gave an error when calling it without the files themselves.  As it turned out, this is quite a frequent case.  For example, when you have a form in which the "file" field is optional. <br><br>  In addition, weak documentation and the lack of uncompressed code (the source was, but compressed with the help of its ‚Äúbicycle‚Äù) made it difficult to debug and make its own changes.  The lack of unit tests greatly affected the speed and quality of development.  It is not surprising, but many users do not need a low-level API and each of them starts writing some kind of wrapper, in most cases jQuery plugin.  Therefore, it was necessary to offer a ready-made solution that would cover all the main tasks. <br><br>  Having collected and analyzed reviews, an action plan was drawn up: <ul><li>  <b>Grunt</b> is a tool for building code; </li><li>  <b>QUnit</b> - testing the basic functionality (Grunt + PhantomJS); </li><li>  <b>Features</b> - improved work with images and WebCam; </li><li>  <b>jQuery plugin</b> - super-duper plugin for typical tasks; </li><li>  <b>Documentation</b> - a detailed description of the methods and examples. </li></ul><br><br><br><h3>  Grunt </h3><br>  As I said before, in the first version js was built using a primitive script that simply merged and obfuscated 6 files into one.  In order to make changes or debug the code, it was necessary to connect 6 source codes in a certain order.  This is inconvenient, so a tool for building the project was required.  <a href="http://gruntjs.com/">Grunt</a> was chosen as such a tool, which is the de facto standard in the design and build of a project.  With it, we not only collect FileAPI, but also run its code through <a href="http://www.jshint.com/about/">JSHint</a> and <a href="http://qunitjs.com/">QUnit-</a> tests, which I will discuss next.  To start using Grunt, it‚Äôs enough to create two files: package.json with a description of the package and Gruntfile.js with a list of the necessary tasks and their options. <br><br>  Let's take a closer look at <a href="">Gruntfile.js</a> .  It consists of 5 main tasks: <br><br><h4>  jshint </h4>  This is a branch from <a href="http://www.jslint.com/lint.html">JSLint</a> , a validator to validate JavaScript code.  In contrast, JSHint can be configured under your code in order to keep track of a single design style, check for missing semicolons, extra commas at the end of an array or an object, unused variables and parts of code. <br><br><h4>  concat </h4>  Collects files in one.  In FileAPI, this section consists of two parts, `all` and` html5`, which corresponds to two assemblies: with and without flash support, for example, for mobile projects. <br><br><h4>  uglify </h4>  Obfuscation of the code, in our case it compresses the files received after the concat. <br><br><h4>  watch </h4>  Since  Since the library consists of several files, and only one is connected, then this task monitors changes to js files and runs the task <b>concat</b> . <br><br><h4>  qunit </h4>  Using <a href="http://phantomjs.org/">PhantomJS</a> performs <a href="http://qunitjs.com/">QUnit</a> tests, which allows you to test the basic functionality. <br><br>  Using grunt is very simple, but before you begin, you need to install the necessary dependencies.  This is done once, using the <code>npm install</code> command. <br><br>  Now we can run the task: <br>  <code>$ /FileAPI/ &gt; grunt</code> - execute default task (jshint + build) <br>  <code>$ /FileAPI/ &gt; grunt build</code> - build and obfuscation (concat + uglify + qunit) <br>  <code>$ /FileAPI/ &gt; grunt watch</code> - monitor changes and, if they are found, run concat <br><br><br><h3>  Testing </h3><br>  As you already understood, <a href="http://qunitjs.com/">QUnit is</a> used for testing, I always liked it for its brevity and simplicity.  In addition, for him there is a ready <a href="https://github.com/gruntjs/grunt-contrib-qunit">grunt-task</a> .  Tests are run through <a href="http://phantomjs.org/">PhantomJS</a> , and during development you can simply refresh the page and wait for the test results. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c75/2bf/00a/c752bf00a7514edd71fabd325439bb9d.png" alt="FileAPI + Qunit"><br><br>  But, as it turned out, in the standard grunt-task it is impossible to bind files to the inputs I need for the test.  So I had to <a href="">modify</a> it a bit: <br><br><pre> <code class="javascript hljs">qunit: { <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-comment"><span class="hljs-comment">// :  ‚Äî  ,  ‚Äî   files: { one: ["foo.jpeg"], multiple: ["bar.txt", "baz.png", "qux.zip"] } }, all: ["tests/*.html"] }</span></span></code> </pre> <br>  The first test methods for working with files.  Such as obtaining meta information (name, type, size, exif), reading the contents (DataURL, BinaryString and Text).  Further loading, during which events and the response from the server are checked. <br><br>  But the most interesting thing is testing of work with images, everything is sly.  Since FileAPI ‚Äúout of the box‚Äù is able to transform images according to specified rules, it is necessary to check that the image received by the server is exactly the one you need.  To do this, use two sets of images: the source, which loads the library, and the reference, with which the result is compared.  How does this happen?  FileAPI loads the image with the transformation parameters being tested and receives dataURL in response.  The data is transferred to the assert-function, converted to canvas and pixel-by-pixel compared with the reference image.  If the discrepancy is less than &lt;1%, then the test is passed. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">imageEqual</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">actual</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**Image*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, expected</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**Image*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, message</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**String*/</span></span></span></span></span><span class="hljs-function">)</span></span>{ actual = toCanvas(actual); expected = toCanvas(expected); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( actual.width != expected.width ){ ok(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, message + <span class="hljs-string"><span class="hljs-string">' (width: '</span></span> + actual.width + <span class="hljs-string"><span class="hljs-string">' != '</span></span> + expected.width + <span class="hljs-string"><span class="hljs-string">')'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( actual.height != expected.height ){ ok(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, message + <span class="hljs-string"><span class="hljs-string">' (height: '</span></span> + actual.height + <span class="hljs-string"><span class="hljs-string">' != '</span></span> + expected.height + <span class="hljs-string"><span class="hljs-string">')'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actualData = actual.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>).getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, actual.width, actual.height); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> expectedData = expected.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>).getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, expected.width, expected.height); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pixels = <span class="hljs-number"><span class="hljs-number">0</span></span>, failPixels = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; actualData.height; y++ ){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; actualData.width; x++ ){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> idx = (x + y * actualData.width) * <span class="hljs-number"><span class="hljs-number">4</span></span>; pixels++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !pixelEqual(actualData.data, expectedData.data, idx) ){ failPixels++; } } } ok(failPixels / pixels &lt; <span class="hljs-number"><span class="hljs-number">.01</span></span>, text + <span class="hljs-string"><span class="hljs-string">' (fail pixels: '</span></span> + (failPixels / pixels) + <span class="hljs-string"><span class="hljs-string">')'</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelEqual</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">actual, expected, idx</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delta = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   return (Math.abs(actual[idx] - expected[idx]) &lt; delta) &amp;&amp; (Math.abs(actual[idx+1] - expected[idx+1]) &lt; delta) &amp;&amp; (Math.abs(actual[idx+2] - expected[idx+2]) &lt; delta); }</span></span></code> </pre> <br>  The peculiarity of this method is that the <a href="https://github.com/mailru/FileAPI/tree/dev/tests/files/samples">reference image</a> should be made for each browser (Phantom, Firefox, Chrome).  This is due to the fact that the color rendition and compression algorithms in each browser are different.  A funny situation happened with Safari.  Initially, I saved reference images using the browser, not on the server side.  So, in Safari, the image built on the basis of dataURL and the saved disk do not match what you see on the screen, the colors are distorted. <br><br>  Alas, this is only functional testing, which helps a lot, but cannot replace manual testing where Flash is used.  In addition, there is an idea to create a grunt-task, which will run QUnit tests through Selenium, then we will live. <br><br><br><h3>  Features </h3><br>  Grunt, testing is, of course, good, but in no way pulls up on version 2.0, I wanted something. <br><br><h4>  Image overlay </h4>  About a month after publication, I was asked how, using the library, to put a watermark on the image and upload the result to the server?  This task could be solved by providing direct access to the canvas, through which transformations take place (as was done in <a href="https://github.com/blueimp/jQuery-File-Upload/issues/1300">jQuery FileUpload</a> ).  But, alas, there are IE below version 10, where all the transformations go through Flash, so it was decided to create a method that would allow you to make any number of overlays with a flexible positioning system: <br><br><pre> <code class="javascript hljs">FileAPI.Image(file) .overlay([ { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  rel: FileAPI.Image.RIGHT_BOTTOM, //  opacity: 0.7, //  ,  0  1 src: "watermark.png" //   } ]) .get(err/**Mixed*/, img/**HTMLElement*/){ /*__*/ }) ;</span></span></code> </pre> <br>  Also, the property of the same name is supported in imageTransform: <br><br><pre> <code class="javascript hljs">FileAPI.upload({ <span class="hljs-attr"><span class="hljs-attr">imageTransform</span></span>: { <span class="hljs-attr"><span class="hljs-attr">overlay</span></span>: { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">rel</span></span>: FileAPI.Image.CENTER_TOP, <span class="hljs-attr"><span class="hljs-attr">src</span></span>: <span class="hljs-string"><span class="hljs-string">"watermark.png"</span></span> <span class="hljs-comment"><span class="hljs-comment">//   } } });</span></span></code> </pre> <br>  As you can see, the method turned out to be simple, but flexible. <br><br><br><h3>  Webcam </h3><br>  The main innovation was the work with a webcam.  For this, the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator.getUserMedia">navigator.getUserMedia</a> method has been introduced in HTML5.  Working with him is very simple: <br><br>  <a href="http://jsfiddle.net/RubaXa/uZhRp/">http://jsfiddle.net/RubaXa/uZhRp/</a> <pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setWebCam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">video</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**HTMLVideo*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, doneFn</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**Function*/</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> navigator = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.navigator; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia; getMedia.call(navigator, { <span class="hljs-attr"><span class="hljs-attr">video</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">//    - }, function (stream) { var URL = window.URL || window.webkitURL || window.mozURL; video.addEventListener('loadedmetadata', function () { doneFn(); }, false); video.src = URL.createObjectURL(stream); video.play(); }, function () { /*    */ }); } setWebCam(videoEl, function () { //   });</span></span></code> </pre> <br>  It seems that everything works, but if you open this example in FireFox, you will see that the callback is triggered before the image appears.  Therefore it was necessary to make the definition of a signal through canvas: <br><br>  <a href="http://jsfiddle.net/RubaXa/uZhRp/">http://jsfiddle.net/RubaXa/uZhRp/</a> <div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setWebCam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">video</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**HTMLVideo*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, doneFn</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">/**Function*/</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_detectVideoSignal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>), ctx, res = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); ctx.drawImage(video, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); res = ctx.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).data[<span class="hljs-number"><span class="hljs-number">4</span></span>] != <span class="hljs-number"><span class="hljs-number">255</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> navigator = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.navigator; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia; getMedia.call(navigator, { <span class="hljs-attr"><span class="hljs-attr">video</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pid, URL = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitURL || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.mozURL; pid = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_detectVideoSignal()) { clearTimeout(pid); doneFn(); } }, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... }, function () { /*    */ }); } setWebCam(videoEl, function () { //   });</span></span></code> </pre> </div></div><br>  Alas, at the time of this writing, the <code>navigator.getUserMedia</code> method only <a href="http://caniuse.com/">supports</a> FireFox and Chrome, which is good, but not enough.  Therefore, we did a fallback in Flash, which allowed us to use all other browsers.  The result was the following API for working with the camera: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> el = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'container'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   FileAPI.Camera.publish(el, { width: 320, height: 240 }, function (err, cam/**FileAPI.Camera*/){ var btn = document.getElementById('shot') // btn ‚Äî ,      FileAPI.event.on(btn, 'click', function (evt){ var shot = cam.shot(); //  FileAPI.Image FileAPI.upload({ url: './ctrl.php', files: { photo: shot } }); }); });</span></span></code> </pre> <br><br><h4>  FileAPI.Camera </h4><ul><li>  <b>publish (el, options, callback)</b> - static method for camera publishing; </li><li>  <b>start (callback)</b> - start broadcasting; </li><li>  <b>shot ()</b> - create a screenshot, returns the heir to FileAPI.Image; </li><li>  <b>stop ()</b> - stop the camera. </li></ul><br><br><br><h3>  Filters </h3><br>  Having made two features, I thought that something else was needed, there was not enough wow effect.  But nothing came to mind.  After some time, I accidentally stumbled upon the wonderful library of <a href="http://camanjs.com/">CamanJS</a> , which allows not only to make color correction, but also to use complex image blending modes, as well as powerful filters - I strongly advise.  That was what you need: there is a camera, work with images too, it remains to add CamanJS - and your ‚Äúinstagram‚Äù with FileAPI, WebCam and filters is ready. <br><br>  It is very simple to use all this, as part of CamanJS there are 10 pre-installed filters, you can see them in work <a href="http://camanjs.com/examples/">here</a> and <a href="http://mailru.github.io/FileAPI/examples/caman.html">here</a> . <br><pre> <code class="javascript hljs">FileAPI.Image(file) .filter(<span class="hljs-string"><span class="hljs-string">'hazyDays'</span></span>) <span class="hljs-comment"><span class="hljs-comment">// CamanJS  .get(function (err, img/**Image*/){ /* ... */ }) ;</span></span></code> </pre> <br>  In addition, you can transfer a function and implement more complex transformations in it.  A reference to the canvas and a callback function will be passed to the input. <br><br><pre> <code class="javascript hljs">FileAPI.Image(file) .filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">canvas, callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  canvas callback(); }) .get(function (err, img/**Image*/){ /* ... */ }) ;</span></span></code> </pre> <br>  Alas, it all works only with the support of HTML5.  To be honest, I really wanted to make support for the above functionality through Flash, and this is even possible: all you need to do is implement the necessary methods for working with canvas in Flash.  Another time somewhere in the future somehow another time sometime later. <br><br><br><h3>  jQuery.FileAPI </h3><br>  The final innovation was the full plugin for jQuery.  In it, I tried to take into account the most common features of downloading files, such as: <br><br><ul><li>  <b>‚ÄúOne button‚Äù</b> - select and automatically download the file; </li><li>  <b>"Restrictions"</b> - the minimum / maximum size of both the file and the image, in width and height; </li><li>  <b>"Work with the queue"</b> - sorting and filtering the file upload queue; </li><li>  <b>"Images"</b> - preview, rotate and crop; </li><li>  <b>‚ÄúInterface‚Äù</b> - flexible and transparent interface setting; </li><li>  As well as <b>Drag'n'Drop</b> and <b>WebCam</b> . </li></ul><br><br>  You can evaluate the features on the <a href="http://rubaxa.github.io/jquery.fileapi/">demo page</a> , <a href="https://github.com/RubaXa/jquery.fileapi">github</a> or by looking under the spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">"One button"</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage3/ca3/268/294/ca3268294ac9ba4e1528397973abc3a0.gif" alt="image"></div></div><div class="spoiler">  <b class="spoiler_title">Loading avatars</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage3/8d0/8ba/c99/8d08bac995ed5edc99222ddd2f487ab7.gif" alt="image"></div></div><div class="spoiler">  <b class="spoiler_title">Multiple loading</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage3/8dd/b01/edb/8ddb01edba74ac220d0b604a91034710.gif" alt="image"></div></div><br>  Here I will analyze only one example, the loading of an avatar, namely: the choice of a photo, cropping and subsequent upload to the server.  Surprisingly, none of the popular solutions provides such an opportunity.  For this reason, this case was implemented first: <br><br><div class="spoiler">  <b class="spoiler_title">Layout</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userpic"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userpic"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-preview userpic__preview"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success js-fileapi-wrapper"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-browse"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn-txt"</span></span></span><span class="hljs-tag">&gt;</span></span>Choose<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"filedata"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-upload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"progress progress-success"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-progress bar"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn-txt"</span></span></span><span class="hljs-tag">&gt;</span></span>Uploading<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">"#userpic"</span></span>).fileapi({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"./ctrl.php"</span></span>, <span class="hljs-attr"><span class="hljs-attr">accept</span></span>: <span class="hljs-string"><span class="hljs-string">"image/*"</span></span>, <span class="hljs-attr"><span class="hljs-attr">imageSize</span></span>: { <span class="hljs-attr"><span class="hljs-attr">minWidth</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-attr"><span class="hljs-attr">minHeight</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span> }, <span class="hljs-attr"><span class="hljs-attr">elements</span></span>: { <span class="hljs-comment"><span class="hljs-comment">//    ( ),  active: { show: ".js-upload", //   hide: ".js-browse" //   }, //      preview: { el: ".js-preview", width: 200, //   height: 200 }, //       progress: ".js-progress" }, onSelect: function (evt, ui){ var image = ui.files[0]; if( image ){ createModal(function (overlay){ $(overlay).on("click", ".js-upload", function (){ closeModal(); $("#userpic").fileapi("upload"); //  }); $(".js-img", overlay).cropper({ //   file: image, //   bgColor: "#fff", //  ,      maxSize: [$(window).width() - 100, $(window).height() - 100], //   - minSize: [130, 130], //  -: Math.min(width*.9, height*.9) selection: 0.9, //  "90%" //   - aspectRatio: 1, //   - onSelect: function (coords/**Object*/){ $("#userpic").fileapi("crop", image, coords); } }); }); } } });</span></span></code> </pre> <br><br>  In addition, the plugin has very flexible appearance settings, which allows you to adjust to most tasks.  Well, if something is missing or you find a bug, then you can always leave a <a href="https://github.com/RubaXa/jquery.fileapi/issues">ticket</a> on github, or write to me - I will be happy to help. <br><br>  In addition to the library itself and the plugin, the <a href="http://mailru.github.io/FileAPI/">documentation</a> has been greatly reworked.  Now these are two full sites: <br><br><ul><li>  <b>FileAPI</b> : <a href="http://mailru.github.io/FileAPI/examples/caman.html">examples</a> |  <a href="https://github.com/mailru/FileAPI/tree/dev">source code</a> |  <a href="https://github.com/mailru/FileAPI/issues%3Fstate%3Dopen">issues</a> </li><li>  <b>jQuery.FileAPI</b> : <a href="http://rubaxa.github.io/jquery.fileapi/">examples</a> |  <a href="https://github.com/RubaXa/jquery.fileapi">source code</a> |  <a href="https://github.com/RubaXa/jquery.fileapi/issues%3Fstate%3Dopen">issues</a> </li></ul><br><br><h5>  You can also follow our projects through: </h5>  <a href="https://github.com/mailru">github.com/mailru</a> - FileAPI, Tarantool, Fest and more <br>  <a href="https://github.com/rubaxa/">github.com/rubaxa</a> - my github <br>  <a href="https://twitter.com/ibnRubaXa">@ibnRubaXa</a> <br></div><p>Source: <a href="https://habr.com/ru/post/201010/">https://habr.com/ru/post/201010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200996/index.html">PaintShop Photo Pro Lessons: Restore an Old Photo I</a></li>
<li><a href="../201000/index.html">Wireless sound. Part 1. Dissect Bluetooth</a></li>
<li><a href="../201002/index.html">MS warns about the use of CVE-2013-3906 in-the-wild</a></li>
<li><a href="../201004/index.html">Autonomy first</a></li>
<li><a href="../201008/index.html">ScienceHub # 03: Synthetic Microbiology</a></li>
<li><a href="../201012/index.html">R: choir map of Russia with a larger European part</a></li>
<li><a href="../201018/index.html">Humble WB Games Bundle</a></li>
<li><a href="../201020/index.html">Nexus 5: Unboxing</a></li>
<li><a href="../201022/index.html">Published source x86 emulator JavaScript</a></li>
<li><a href="../201026/index.html">Live Mobile in a week in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>