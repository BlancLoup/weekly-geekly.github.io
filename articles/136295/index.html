<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx + uWSGI + virtualenv + Django on Debian Squeeze</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, I was puzzled by the search for a way to deploy Django projects, which had two requirements: 


1. Convenient management of starting / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx + uWSGI + virtualenv + Django on Debian Squeeze</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, I was puzzled by the search for a way to deploy Django projects, which had two requirements: <br><ol><li>  Convenient management of starting / stopping / restarting several projects on a single host </li><li>  Support for different virtual environments for different projects </li></ol><br>  On the second point, my choice leaned in favor of Nginx + uWSGI.  For the first of the options I considered, I liked the strapping for uWSGI in Debian the most. <br><a name="habracut"></a><br><h4>  Software installation </h4><br>  UWSGI support appeared in Nginx from version 0.8.40, but neither the first nor the second in the stable Debian branch exists.  Therefore, we will take Nginx from backports, and uWSGI from an unstable branch.  To do this, add the following lines to /etc/apt/sources.list: <br><pre><code class="bash hljs">deb http://backports.debian.org/debian-backports squeeze-backports main contrib non-free deb http://ftp.ru.debian.org/debian testing main non-free contrib deb http://ftp.ru.debian.org/debian unstable main non-free contrib</code> </pre> <br>  And create something like / etc / apt / preferences: <br><pre> <code class="bash hljs">Package: * Pin: release a=stable Pin-Priority: 700 Package: * Pin: release a=squeeze-backports Pin-Priority: 675 Package: * Pin: release a=testing Pin-Priority: 650 Package: * Pin: release a=unstable Pin-Priority: 600</code> </pre><br>  Synchronize using <b>aptitude update</b> and install the necessary packages: <br><pre> <code class="bash hljs">aptitude -t squeeze-backports install nginx aptitude -t unstable install uwsgi aptitude -t unstable install uwsgi-plugin-python aptitude -t unstable install python-virtualenv</code> </pre><br><h4>  Directory structure for projects </h4><br>  Consider a deployment for an example project.  For definiteness, suppose that all projects are located in the <i>proj</i> subdirectory of the <i>user's</i> home directory <i>web</i> .  Also in <i>proj</i> there is a <i>static</i> subdirectory where static files of projects will be placed, for the distribution of which Nginx will be responsible.  For the example project, we get the following paths: <br><pre> <code class="bash hljs">/home/web/proj/example /home/web/proj/static/example</code> </pre><br>  In the <i>settings.py</i> of the example project we have the settings: <br><pre> <code class="python hljs">STATIC_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), <span class="hljs-string"><span class="hljs-string">'../static/example'</span></span>)) STATIC_URL = <span class="hljs-string"><span class="hljs-string">'/static/'</span></span></code> </pre><br>  Thus, the <i>collectstatic</i> management team will collect all project statics in <i>/ home / web / proj / static / example</i> . <br><br>  The virtual environment for the example project will be in <i>/ home / web / envs / example</i> . <br><br><h4>  Setting uWSGI and Nginx </h4><br>  The configuration file uWSGI for the example project will be called <i>/etc/uwsgi/apps-available/example.ini</i> and will look like this: <br><pre> <code class="bash hljs">[uwsgi] plugins = python27 virtualenv = /home/web/envs/example/ <span class="hljs-built_in"><span class="hljs-built_in">chdir</span></span> = /home/web/proj/example/ pythonpath = .. env = DJANGO_SETTINGS_MODULE=example.settings module = django.core.handlers.wsgi:WSGIHandler() touch-reload = /home/web/proj/example/touchme</code> </pre><br>  We also create a symbolic link to it in <i>/ etc / uwsgi / apps-enabled</i> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/uwsgi/apps-enabled ln -s ../apps-available/example.ini .</code> </pre><br>  Then we start the uWSGI daemon: <b>/etc/init.d/uwsgi start example</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The Nginx configuration file is called <i>/ etc / nginx / sites-available / example</i> .  Its minimum option may be: <br><pre> <code class="bash hljs">server { listen 80; server_name example; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/example.access.log; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/example.error.log; location /static/ { <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> /home/web/proj/static/example/; } location / { include uwsgi_params; uwsgi_pass unix:///var/run/uwsgi/app/example/socket; } }</code> </pre><br>  Similarly, we create a symbolic link in / etc / nginx / sites-enabled: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/nginx/sites-enabled/ ln -s ../sites-available/example .</code> </pre><br>  And restart Nginx: <b>/etc/init.d/nginx restart</b> <br><br><h4>  Under the hood </h4><br>  First, I will briefly discuss the parameters in the uWSGI configuration file.  The <i>plugins option</i> explicitly specifies the version of Python.  The <i>chdir</i> and <i>pythonpath parameters</i> add the project directory and its parent directory to the Python search path.  The <i>env</i> and <i>module</i> parameters allow you to do without creating a special script to launch the project with the uWSGI daemon.  The <i>touch-reload option</i> allows you to reload the project using the <b>touch / home / web / proj / example / touchme command</b> . <br><br>  Such a concise configuration file for uWSGI turned out because the startup script <i>/etc/init.d/uwsgi</i> uses another configuration file <i>/usr/share/uwsgi/conf/default.ini</i> , which for all other necessary parameters are set reasonable enough values ‚Äã‚Äãfor default  If necessary, you can override them in <i>/etc/uwsgi/apps-available/example.ini</i> .  After removing some of the comments, the contents of <i>/usr/share/uwsgi/conf/default.ini</i> will be as follows: <br><pre> <code class="bash hljs">[uwsgi] <span class="hljs-comment"><span class="hljs-comment"># try to autoload appropriate plugin if "unknown" option has been specified autoload = true # enable master process manager master = true # spawn 2 uWSGI worker processes workers = 2 # automatically kill workers on master's death no-orphans = true # write master's pid in file /run/uwsgi/&lt;confnamespace&gt;/&lt;confname&gt;/pid pidfile = /run/uwsgi/%(deb-confnamespace)/%n/pid # bind to UNIX socket at /run/uwsgi/&lt;confnamespace&gt;/&lt;confname&gt;/socket socket = /run/uwsgi/%(deb-confnamespace)/%n/socket # set mode of created UNIX socket chmod-socket = 660 # place timestamps into log log-date = true # user identifier of uWSGI processes uid = www-data # group identifier of uWSGI processes gid = www-data</span></span></code> </pre><br>  The concept of a <i>configuration namespace was</i> introduced in uWSGI in Debian.  In <i>default.ini,</i> it is represented using the variable <i>% (deb-confnamespace)</i> with the default value of <i>app</i> .  The name of the configuration namespace is defined as follows: the start script <i>/etc/init.d/uwsgi</i> searches in the <i>/ etc / uwsgi</i> directory for all subdirectories ending in <i>s-enabled</i> , and the part of the subdirectory name that precedes <i>s-enabled</i> becomes the name of the configuration space for files in this subdirectory.  In our case, it would be possible to create more familiar subdirectories of <i>sites-available</i> and <i>sites-enabled</i> in <i>/ etc / uwsgi</i> , in which you place the configuration file <i>example.ini</i> and a symbolic link to it, respectively;  pidfile and socket for this configuration would be in <i>/ run / uwsgi / site / example / pid</i> and <i>/ run / uwsgi / site / example / socket</i> , and the uWSGI daemon for this configuration would be controlled using the <b>/etc/init.d/</b> commands <b>uwsgi start | stop | restart site / example</b> .  If there is no prefix, the <i>app</i> namespace is implied. </div><p>Source: <a href="https://habr.com/ru/post/136295/">https://habr.com/ru/post/136295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136289/index.html">Education in high school and beyond: a view from the department</a></li>
<li><a href="../136290/index.html">What is more important for a programmer?</a></li>
<li><a href="../136291/index.html">By lamers for lamers</a></li>
<li><a href="../136292/index.html">Compact gaming steering wheel Steelseries SRW-S1</a></li>
<li><a href="../136294/index.html">Prototype Lane Departure Warning or how to remind the driver that he did not have a very long time to live</a></li>
<li><a href="../136296/index.html">CES 2012 // Acer Aspire S5</a></li>
<li><a href="../136298/index.html">Official release of ADO.NET driver for CUBRID</a></li>
<li><a href="../136299/index.html">Where do you buy games online?</a></li>
<li><a href="../136300/index.html">Death in games. Monday video</a></li>
<li><a href="../136301/index.html">Filtering Texts by Regular Expression List</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>