<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Entity Framework 6 extensions that you might not know about</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many programmers take notes, describe the difficulties, beautiful and not-so-great solutions, which one has to face as a matter of duty. This could be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Entity Framework 6 extensions that you might not know about</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/6e6/12c/47e/6e612c47ed7c469fb8ad64650acfd03d.jpg"></div><br><p>  Many programmers take notes, describe the difficulties, beautiful and not-so-great solutions, which one has to face as a matter of duty.  This could be your own technical blog, a working wiki, or even a regular notebook - the essence is the same.  Gradually, from small Evernote-notes the whole article on Habr can grow.  But as time goes on, a change of place of work promises changes in the development stack, and the technologies are not standing still (by the way, EF Core has been a couple of months as in <a href="https://blogs.msdn.microsoft.com/dotnet/2016/11/16/announcing-entity-framework-core-1-1/">version 1.1</a> ).  On the other hand, Entity Framework 6 has been and remains a ‚Äúworkhorse‚Äù for accessing data in corporate applications on the .net stack, not least because of its stability, low entry threshold and widespread fame.  Therefore, I hope the article will still be useful to someone. </p><br><p>  Content: </p><br><ol><li>  Database First without EDMX </li><li>  Work with detached graphs </li><li>  Modify SQL.  Adding table instructions </li><li>  Caching data outside of the DbContext lifetime </li><li>  Retry on SQL Server errors </li><li>  We substitute DbContext, we are isolated from the real database </li><li>  Quick insert </li></ol><a name="habracut"></a><br><h2 id="database-first-bez-edmx">  Database First without EDMX </h2><br><p>  I would not want to start another round of the controversy "Code First vs. Database First".  Better just tell you how to make your life easier if you prefer Database First.  Many developers using this approach have noted the inconvenience of working with a bulky EDMX file.  This file can turn teamwork into hell, making it very difficult to merge parallel changes due to the constant ‚Äúmixing‚Äù of its internal structure.  Among other shortcomings, for models with several hundred entities (the usual such legacy monolith), you may encounter a strong drop in the speed of any action, working with a standard EDMX-designer. </p><br><p>  The solution seems obvious - it is necessary to abandon the EDMX in favor of alternative means of generating POCO and storing metadata.  The task is simple, and in EF there is an "out of the box" - this is the "Generate Code First From Database" item available in Visual Studio (VS2015 for sure).  But, in practice, it is very inconvenient to roll database changes onto the resulting model through this tool.  Further, who works with EF for a long time - the <a href="https://marketplace.visualstudio.com/items%3FitemName%3DEntityFrameworkTeam.EntityFrameworkPowerToolsBeta4">Entity Framework Power Tools</a> extension can remember, solving similar problems - but, alas, the project no longer develops (on VS2015 <a href="http://thedatafarm.com/data-access/installing-ef-power-tools-into-vs2015/">without a hack</a> ), and some of the developers of this tool now work directly in the EF team. </p><br><p>  It would seem that everything is bad - and here we found the <a href="https://marketplace.visualstudio.com/items%3FitemName%3DSimonHughes.EntityFrameworkReversePOCOGenerator">EntityFramework Reverse POCO Generator</a> .  This is a T4 template for generating POCO based on an existing database with a large number of settings and open <a href="https://github.com/sjh37/EntityFramework-Reverse-POCO-Code-First-Generator">source</a> .  All basic features of EDMX are supported, and there are a number of additional goodies: FakeDbContext / FakeDbSet generation for unit testing, model attribute coverage (eg DataContract / DataMember), etc. Thanks to T4, there is full control over code generation.  Summarizing: it works stably, the team likes it, it is easy to migrate existing projects. </p><br><h2 id="rabota-s-otsoedinennymi-grafami">  Work with detached graphs </h2><br><p>  Attaching a new object to a DbContext or a single object previously obtained in another context is usually not difficult.  Problems begin in the case of graphs, i.e.  entities with links - EF "out of the box" does not track changes in the contents of the navigation properties of the newly attached to the context of the entity.  To track changes, for each entity object during the context's life, there must be a corresponding entry - an object with service information, including the state of the entity (Added, Modified, Deleted, etc.).  Fill in the entries to attach the graph - perhaps at least 2 ways: </p><br><ol><li>  Store state in the entities themselves, tracking changes on their own.  Thus, our disconnected graph will contain all the necessary information to join. </li><li>  Do not do anything in advance, and when adding a graph to a new context, pull up the original graph from the database and set the entry state based on the comparison of the two graphs. </li></ol><br><p>  An example of <strong>solution # 1</strong> can be found, for example, in a <a href="https://www.pluralsight.com/courses/entity-framework-enterprise-update">fresh Pluralsight course</a> from Julie Lerman, a well-known EF specialist.  For its generic self-realization requires a large number of gestures.  All entities must implement the IStateObject interface: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IStateObject</span></span> { ObjectState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  In one way or another, it is necessary to ensure the relevance of State values ‚Äã‚Äãso that after manually joining each entity in the graph to the context: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">context</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Foos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Attach</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">foo</span></span>);</code> </pre> <br><p>  go through all the entry, editing their state: </p><br><pre> <code class="hljs vhdl">IStateObject <span class="hljs-keyword"><span class="hljs-keyword">entity</span></span> = entry.<span class="hljs-keyword"><span class="hljs-keyword">Entity</span></span>; entry.State = ConvertState(<span class="hljs-keyword"><span class="hljs-keyword">entity</span></span>.State);</code> </pre> <br><p>  In this case, we do not need additional appeals to the database, but the solution is voluminous, fragile, and potentially inoperative for many-to-many relationships.  Also, the models littered (by the way, the requirement to implement the interface can be solved by modifying the T4 templates from the previous section of the article). </p><br><p>  Consider <strong>solution # 2</strong> .  I'll be brief: </p><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">context</span></span>.UpdateGraph(root, <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>.OwnedCollection(r =&gt; r.Childs));</code> </pre> <br><p>  This call will add the root entity to the context, updating the navigation property with the Childs collection of child objects, at the cost of SELECT to the database alone.  That became possible thanks to the <a href="https://github.com/refactorthis/GraphDiff">GraphDiff</a> library, the author of which did all the dirty work and caught the main bugs. </p><br><h2 id="modifikaciya-sql-dobavlenie-tablichnyh-ukazaniy">  Modify SQL.  Adding table instructions </h2><br><p>  A seemingly simple SELECT statement ... FROM Table WITH (UPDLOCK) is not supported by EF.  But there are interceptors that allow you to modify the generated SQL in any suitable way, for example, using regular expressions.  Let's add UPDLOCK to each SELECT generated within the context lifetime (naturally, granularity is not necessarily the context, it all depends on your implementation): </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyDbContext().With(SqlLockMode.UpdLock)) {}</code> </pre> <br><p>  To do this, declare the With method inside the context and register the interceptor: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ILockContext</span></span> { SqlLockMode LockMode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-function">MyDbContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">With</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlLockMode lockMode</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbConfig</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AddInterceptor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LockInterceptor()); } } [DbConfigurationType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MyDbConfig))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">ILockContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SqlLockMode LockMode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MyDbContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">With</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlLockMode lockMode</span></span></span><span class="hljs-function">)</span></span> { LockMode = lockMode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContextStaticPartial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">LockInterceptor</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LockInterceptor</span></span> : <span class="hljs-title"><span class="hljs-title">DbCommandInterceptor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ScalarExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbCommand command, DbCommandInterceptionContext&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; interceptionContext</span></span></span><span class="hljs-function">)</span></span> { AddLockStatement(command, interceptionContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReaderExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbCommand command, DbCommandInterceptionContext&lt;DbDataReader&gt; interceptionContext</span></span></span><span class="hljs-function">)</span></span> { AddLockStatement(command, interceptionContext); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AddLockStatement&lt;T&gt;(DbCommand command, DbCommandInterceptionContext&lt;T&gt; interceptionContext) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lockMode = GetLock(interceptionContext); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (lockMode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SqlLockMode.UpdLock: command.CommandText = SqlModifier.AddUpdLock(command.CommandText); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SqlLockMode GetLock&lt;T&gt;(DbCommandInterceptionContext&lt;T&gt; interceptionContext) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (interceptionContext == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SqlLockMode.None; ILockContext lockContext = interceptionContext.DbContexts.First() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ILockContext; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lockContext == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SqlLockMode.None; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lockContext.LockMode; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">The regular expression might be:</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqlModifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Regex _regex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">@"(?&lt;tableAlias&gt;SELECT\s.*FROM\s.*AS \[Extent\d+])"</span></span>, RegexOptions.Multiline | RegexOptions.IgnoreCase); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddUpdLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _regex.Replace(text, <span class="hljs-string"><span class="hljs-string">"${tableAlias} WITH (UPDLOCK)"</span></span>); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">We test the regular expression</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqlModifier_Tests</span></span> { [TestCase(<span class="hljs-string"><span class="hljs-string">"SELECT [Extent1].[Name] AS [Name] FROM [dbo].[Customer] AS [Extent1]"</span></span>)] [TestCase(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM [dbo].[Customer] AS [Extent999]"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddUpdLock_ValidEfSelectStatement_AddLockAfterTableAlias</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> expected = text + <span class="hljs-string"><span class="hljs-string">" WITH (UPDLOCK)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> actual = SqlModifier.AddUpdLock(text); Assert.AreEqual(expected, actual); } [TestCase(<span class="hljs-string"><span class="hljs-string">"SELECT [Extent1].[Extent1] AS [Extent1]"</span></span>)] [TestCase(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM Order"</span></span>)] [TestCase(<span class="hljs-string"><span class="hljs-string">" AS [Extent111]"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddUpdLock_InvalidEfSelectStatement_NoChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> actual = SqlModifier.AddUpdLock(text); Assert.AreEqual(text, actual); } }</code> </pre> </div></div></div></div><br><h2 id="keshirovanie-dannyh-za-predelami-vremeni-zhizni-dbcontext">  Caching data outside of the DbContext lifetime </h2><br><p>  EF <a href="https://msdn.microsoft.com/en-us/data/hh949853.aspx">caches</a> things like: </p><br><ul><li>  Query Plan. </li><li>  Metadata. </li><li>  Compiled Queries. </li></ul><br><p>  Data caching is only within the context of the life (remember the Find method), and this language will not be called a full-fledged cache.  How do we organize a single, in all contexts, managed cache in the process memory?  Use <a href="https://github.com/zzzprojects/EntityFramework-Plus/wiki/EF-Query-Cache-%257C-Entity-Framework-Second-Level-Caching">EntityFramework.Plus</a> , or its "poor" alternative to <a href="https://github.com/moozzyk/EFCache">EntityFramework.Cache</a> : </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectWithCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyDbContext()) { ctx.Customers.FromCache().ToList(); } } [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectWithCache_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { TimeSpan expiration = TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheItemPolicy() { SlidingExpiration = expiration }; QueryCacheManager.DefaultCacheItemPolicy = options; SelectWithCache(); <span class="hljs-comment"><span class="hljs-comment">//   SelectWithCache(); //  Thread.Sleep(expiration); SelectWithCache(); //   }</span></span></code> </pre> <br><p>  It is enough to run the SQL profiler to make sure that the 2nd SelectWithCache () call does not affect the database.  Lazy calls will also be cached. </p><br><p>  Moreover, EF integration with distributed cache is possible.  For example, through a self-written cache manager based on Sytem.Runtime.Caching.ObjectCache connected to EntityFramework.Plus.  NCache <a href="http://www.alachisoft.com/ncache/entity-framework.html">supports</a> integration with EF "out of the box" (I can not share specifics - I have not tried this cache). </p><br><h2 id="retry-pri-oshibkah-ot-sql-server">  Retry on SQL Server errors </h2><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SchoolConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SchoolConfiguration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { SetExecutionStrategy(<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient"</span></span>, () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlAzureExecutionStrategy(maxRetryCount: <span class="hljs-number"><span class="hljs-number">3</span></span>, maxDelay: TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">10</span></span>))); } }</code> </pre> <br><p>  SqlAzureExecutionStrategy - this strategy is contained in EF6 (disabled by default).  When used, receiving a specific error code in the response from SQL Server causes the SQL instruction to be sent again to the server. </p><br><div class="spoiler">  <b class="spoiler_title">Error codes for SqlAzureExecutionStrategy</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> Error Code: <span class="hljs-number"><span class="hljs-number">40197</span></span> // The service has encountered an error processing your request. Please try again. <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">40197</span></span>: // <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> Error Code: <span class="hljs-number"><span class="hljs-number">40501</span></span> // The service <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> currently busy. Retry the request <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> seconds. <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">40501</span></span>: // <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> Error Code: <span class="hljs-number"><span class="hljs-number">10053</span></span> // A transport-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> error has occurred <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> receiving results <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>. // An established <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> was aborted <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the software <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> your host machine. <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">10053</span></span>: // <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> Error Code: <span class="hljs-number"><span class="hljs-number">10054</span></span> // A transport-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> error has occurred <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> sending the request <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>. // (provider: TCP Provider, error: <span class="hljs-number"><span class="hljs-number">0</span></span> - An existing <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> was forcibly closed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the remote host.) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">10054</span></span>: // <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> Error Code: <span class="hljs-number"><span class="hljs-number">10060</span></span> // A network-related <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> instance-specific error occurred <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> establishing a <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>. // The <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> was <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> was <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> accessible. Verify that the instance <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> correct <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> that <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allow remote connections. (provider: TCP Provider, error: <span class="hljs-number"><span class="hljs-number">0</span></span> - A <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> attempt failed // because the connected party did <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> properly respond <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> a period <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> established <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> failed // because connected host has failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> respond.)"} case 10060: // SQL Error Code: 40613 // Database XXXX on server YYYY is not currently available. Please retry the connection later. If the problem persists, contact customer // support, and provide them the session tracing ID of ZZZZZ. case 40613: // SQL Error Code: 40143 // The service has encountered an error processing your request. Please try again. case 40143: // SQL Error Code: 233 // The client was unable to establish a connection because of an error during connection initialization process before login. // Possible causes include the following: the client tried to connect to an unsupported version of SQL Server; the server was too busy // to accept new connections; or there was a resource limitation (insufficient memory or maximum allowed connections) on the server. // (provider: TCP Provider, error: 0 - An existing connection was forcibly closed by the remote host.) case 233: // SQL Error Code: 64 // A connection was successfully established with the server, but then an error occurred during the login process. // (provider: TCP Provider, error: 0 - The specified network name is no longer available.) case 64: // DBNETLIB Error Code: 20 // The instance of SQL Server you attempted to connect to does not support encryption. case (int)ProcessNetLibErrorCode.EncryptionNotSupported: return true;</code> </pre> </div></div><br><p>  Interesting: </p><br><ul><li>  Based on <a href="">the SqlAzureExecutionStrategy source code, it is</a> possible to write your own strategy by redefining error codes leading to retry. </li><li>  The use of retry-strategies, including SqlAzureExecutionStrategy, imposes a number of limitations, the most serious of which is <strong>incompatibility with user transactions</strong> .  To explicitly declare a transaction, disable the strategy by calling <a href="https://msdn.microsoft.com/en-us/library/dn307226%2528v%3Dvs.113%2529.aspx">System.Runtime.Remoting.Messaging.CallContext</a> : </li><li>  The strategy can even be covered with integration tests (thanks again to Julie Lerman, <a href="http://thedatafarm.com/data-access/testing-out-the-connection-resiliency-feature-into-ef6/">who covered</a> this issue <a href="http://thedatafarm.com/data-access/testing-out-the-connection-resiliency-feature-into-ef6/">in detail</a> ). </li></ul><br><h2 id="podmenyaem-dbcontext-izoliruemsya-ot-realnoy-bd">  We substitute DbContext, we are isolated from the real database </h2><br><p>  For testing purposes, substitute DbContext transparently to the calling code, and fill in the fake DbSet with test data.  I will give several ways to solve the problem. <br>  <strong>Method # 1</strong> (long): manually create stubs for IMyDbContext and DbSet, explicitly prescribe the required behavior.  Here is what it might look like using the Moq library: <br></p><div class="spoiler">  <b class="spoiler_title">Mockdbset</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">public</span></span> <span class="hljs-type"><span class="hljs-type">IMyDbContext</span></span> <span class="hljs-type"><span class="hljs-type">Create</span></span>() { var mockRepository = new <span class="hljs-type"><span class="hljs-type">MockRepository</span></span>(<span class="hljs-type"><span class="hljs-type">MockBehavior</span></span>.<span class="hljs-type"><span class="hljs-type">Default</span></span>); var mockContext = mockRepository.<span class="hljs-type"><span class="hljs-type">Create</span></span>&lt;<span class="hljs-type"><span class="hljs-type">IMyDbContext</span></span>&gt;(); mockContext.<span class="hljs-type"><span class="hljs-type">Setup</span></span>(x =&gt; x.<span class="hljs-type"><span class="hljs-type">SaveChanges</span></span>()).<span class="hljs-type"><span class="hljs-type">Returns</span></span>(int.<span class="hljs-type"><span class="hljs-type">MaxValue</span></span>); var mockDbSet = <span class="hljs-type"><span class="hljs-type">MockDbSet</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Customer</span></span>&gt;(customers); mockContext.<span class="hljs-type"><span class="hljs-type">Setup</span></span>(m =&gt; m.<span class="hljs-type"><span class="hljs-type">Customers</span></span>).<span class="hljs-type"><span class="hljs-type">Returns</span></span>(mockDbSet.<span class="hljs-type"><span class="hljs-type">Object</span></span>); return mockContext.<span class="hljs-type"><span class="hljs-type">Object</span></span>; } private <span class="hljs-type"><span class="hljs-type">Mock</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DbSet</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt;&gt; <span class="hljs-type"><span class="hljs-type">MockDbSet</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt;(<span class="hljs-type"><span class="hljs-type">List</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = null) where </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class"> : class { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AsQueryable</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Mock</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DbSet</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;&gt;(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;&gt;().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Setup</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Provider</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Returns</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Provider</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;&gt;().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Setup</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Expression</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Returns</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Expression</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;&gt;().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Setup</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ElementType</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Returns</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ElementType</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">As</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;&gt;().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Setup</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetEnumerator</span></span></span><span class="hljs-class">()) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Returns</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queryable</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetEnumerator</span></span></span><span class="hljs-class">()); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mock</span></span></span><span class="hljs-class">; }</span></span></code> </pre> </div></div><br><p>  There is a basic MSDN article on this topic: <a href="https://msdn.microsoft.com/en-us/library/dn314429%2528v%3Dvs.113%2529.aspx">Entity Framework Testing with a Mocking Framework (EF6 onwards)</a> .  And once I was so impressed with this approach that I got a <a href="https://github.com/chumakov-ilya/Demo.DbContextMocking">demo project</a> on a githaba (using EF6 DbFirst, SQL Server, Moq, Ninject).  By the way, in the course already mentioned in the <a href="https://www.pluralsight.com/courses/entity-framework-enterprise-update">Entity Framework in the Enterprise</a> , an entire chapter is devoted to testing. </p><br><p>  <strong>Method # 2</strong> (short): use the already mentioned Reverse POCO Generator, which by default creates stubs for your DbContext and all DbSets (inside FakeDbSet there will be a regular in-memory collection). <br><br></p><h2 id="bystraya-vstavka">  Quick insert </h2><br><p>  To insert thousands of new records into the SQL Server database at the same time, it is extremely efficient to use BULK operations instead of standard non-default INSERT.  I covered the problem in more detail in a separate <a href="https://habrahabr.ru/post/251397/">article</a> , so I‚Äôll give below only ready-to-use solutions based on SqlBulkCopy: </p><br><p>  ‚Üí <a href="https://github.com/MikaelEliasson/EntityFramework.Utilities">EntityFramework.Utilities</a> <br>  ‚Üí <a href="http://entityframework-extensions.net/">Entity Framework Extensions</a> </p><br><p>  I have it all.  Share your recipes and tricks in the comments =) </p><p></p><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320128/">https://habr.com/ru/post/320128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320110/index.html">Windows Performance Station or how I taught the computer to work effectively</a></li>
<li><a href="../320114/index.html">Stagnation: message format</a></li>
<li><a href="../320116/index.html">"... and in every joke there is some joke"</a></li>
<li><a href="../320120/index.html">Visual C ++ for IoT Development: Breakthrough or Frustration?</a></li>
<li><a href="../320124/index.html">Overview of modern web desktops systems</a></li>
<li><a href="../320132/index.html">How to create in a large company a convenient workplace for distributed teams?</a></li>
<li><a href="../320134/index.html">The digest of interesting materials for the mobile # 187 developer (January 16-22)</a></li>
<li><a href="../320136/index.html">Cases: development of specifications and guidelines (web ui kit)</a></li>
<li><a href="../320140/index.html">Classical labyrinth generation algorithms. Part 1: introduction</a></li>
<li><a href="../320142/index.html">What if in games to use a video card for physics, not for graphics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>