<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How the infrastructure of Yandex. Mail has grown over 13 years</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the second decade of the 21st century, mail is not only correspondence between people. Users expect that the mail will help them solve daily tasks,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How the infrastructure of Yandex. Mail has grown over 13 years</h1><div class="post__text post__text-html js-mediator-article">  In the second decade of the 21st century, mail is not only correspondence between people.  Users expect that the mail will help them solve daily tasks, save time, prompt the missing information.  We are constantly adding new strokes to Yandex.Mail that make the lives of users a little easier.  Today we would like together with you to re-follow the path that Yandex.Mail has done in 13 years, focusing on the development of the architecture and infrastructure of the service. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/210478/"><img src="https://habrastorage.org/getpro/habr/post_images/452/a43/80d/452a4380d6049a0202ebd65bde1ce2d5.jpg" width="600" height="760"><br></a> <br>  Now, few people remember that the very first version of Yandex.Mail was written in PHP, and the letters were stored directly in a relational database next to the meta-information.  In the not-so-distant 2000, the entire postal service fit into a dozen servers.  The servers themselves were fully serviced manually: from the configuration of the disks to the installation of the operating system, there was no automation. <br><a name="habracut"></a><br><h4>  2002 </h4><br>  The first thing I had to give up was PHP.  At that time, he often interfered with, than he helped to develop. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd0/46a/ccf/fd046accf52519c55e3af8a74908edae.jpg" title="Yandex.Mail in 2001">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There were a lot of first-class Perl specialists around, there was already a huge number of libraries under Perl itself, and we rewrote mail on the <a href="http://en.wikipedia.org/wiki/Apache_HTTP_Server">Apache</a> + Perl bundle.  It became faster and easier. <br><br><h4>  2005 year </h4><br>  A little more time passed, and the existing Apache multiprocess model ceased to cope with the load.  A separate problem was created by the Perl interpreter and the peculiarities of its connection to the meta-information repository.  As a result, after a series of experiments, including the beta version of the bad Apache 2, we wrote our own modular application server called Baida.  It can use both the transaction and <a href="http://en.wikipedia.org/wiki/Event_loop">event-loop</a> query processing model, is very convenient for connecting extensions, including language interpreters - for example, JS.  The server, like most of the Yandex.Mail code, is written in C ++.  In many ways, it is a library for network sharing and work with threads, which was needed in order to ensure the work of the service with increasing loads. <br><br>  Real-time monitoring of its condition is built into this server to facilitate its operation.  In addition, we completely abandoned Perl.  Instead, a separate Baida module was created - the Web Mail Interface, which contained within itself an XScript interpreter: an XML parser and <a href="http://en.wikipedia.org/wiki/XSLT">XSLT</a> transformation engine.  Another feature is the connection pool with relational meta-storage and effective management of this pool. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f4c/afa/db5/f4cafadb5c7086fa353b56dc981c4f35.jpg" title="Design Yandex. Mail, created in 2003"><br><br><h4>  2006 </h4><br>  It became clear that storing the bodies of letters in a relational repository with growing data volumes will not work.  So there was an order for a specialized store of letters, which was called Mulca.  Technology for eight years of development has undergone not so much architectural changes, although the repository has grown many times in size.  Now, besides Mail, it is used to store files in Yandex.Disk. <br><br>  Since the launch of a separate storage, we have experimented with the configuration of the disk subsystem on the servers: we tried different <a href="http://en.wikipedia.org/wiki/RAID">RAID</a> levels and merged the devices into large partitions.  The RAID5 configuration lasted the longest, but it had drawbacks that needed to be fixed: RAID5 required the computation of checksums, as well as re-reading the block when it was being recorded, which lowers the write speed.  In case you need to rebuild the array, its performance also degrades for a long time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d28/8e3/d68/d288e3d68d00cc789752384a4a5c92c6.jpg" title="It looked like the new letter page in Yandex.Mail 2006"><br><br>  Then we began to experiment with <a href="http://en.wikipedia.org/wiki/SATA">SATA</a> disks instead of <a href="http://en.wikipedia.org/wiki/SCSI">SCSI</a> .  It turned out that non-RAID5 SATA drives provide approximately the same data access speed as SCSI collected in RAID5 in our configuration.  It was necessary either to optimize the configuration, or to come up with a solution to ensure fault tolerance. <br><br><h4>  2007 </h4><br>  We decided to completely abandon the RAID arrays on Mulca, and provide fault tolerance at the storage level, rather than the disk subsystem of a separate server.  Some time later, we replaced the high-capacity SCSI disks of small capacity with large SATA disks.  Moving to separate file systems and discarding redundancy at the disk level gave a good saving of resources in place.  Coupled with the transition to SATA, the commissioning of new storage volumes has noticeably accelerated.  In the event of a disk failure, we simply copied the data from the second copy in another data center.  At the same time, our famous postal wall first appeared. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/732/4cd/7e2/7324cd7e269e08dcbede18e270848b6d.jpg" alt="image"><br><br>  The development of this dashboard was initiated by system administrators and served to bring together the perception of the situation by exploitation, development and managers.  We singled out the most important numbers and hung them in a prominent place so that all involved in the product could see how it feels.  By the way, the appearance of the wall has not changed much over the years.  The tradition of hanging panels and projectors with important information went from this wall all over Yandex. <br><br>  Traditional POP3 evolved over time: from the Baida module it became an independent demon and learned to read data from a repository of the meta-storage.  At about the same time, it became clear that we needed the IMAP protocol, and using the experience gained in developing POP3, we started to write it from scratch.  The current version of <a href="http://habrahabr.ru/company/yandex/blog/182140/">our IMAP</a> is the fourth in a row, and we do not plan to stop there. <br><br>  For the delivery of mail, the <a href="http://en.wikipedia.org/wiki/ZMailer">zMailer</a> SMTP server was <a href="http://en.wikipedia.org/wiki/ZMailer">used</a> , and we began to feel its limitations: in our architecture, it didn‚Äôt accept incoming connections, since for each incoming connection it convened a new process and very quickly degraded as the queue grew.  We put our own patches on him, but that didn't help much in solving problems.  It became clear that we need another technology.  After much discussion, we decided to switch to <a href="http://en.wikipedia.org/wiki/Postfix_(software)">Postfix</a> , it works much better with large queues.  It was necessary, of course, to rewrite the delivery agent from Postfix to our storage. <br><br><h4>  2008 </h4><br>  We have set ourselves the task of ensuring the speed of letter delivery.  At that time, an average letter was delivered in a few seconds, and such a delivery time was considered good.  We also needed mail to be comparable in speed with instant messaging systems. <br><br>  First, we wrote a new delivery agent - Fastsrv, and embedded it first in zMailer, and then in <a href="http://www.postfix.org/">Postfix</a> .  Fastsrv has virtually no queue and keeps a constant connection to the meta base.  It was installed on mail receiving clusters.  Any incoming letter was tried to be instantly put to the user in the box, and only if it did not work out, they were thrown back into the delivery queue.  So most of the letters began to be delivered almost instantly.  The queues for delivery from the usual picture on the charts became a symbol of the problem, and we reflected this in the monitoring. <br><br>  Additionally, we have divided the queues for sending and receiving letters, so that in case of any problems with one part, to maintain the serviceability of the service. <br><br>  Now it's time to replace Postfix on receiving mail.  We called <a href="https://github.com/khanton/NwSMTP">our</a> own SMTP server <a href="https://github.com/khanton/NwSMTP">NwSMTP</a> .  It was conceived as an event-based server capable of handling an unlimited number of connections.  Similarly, the well-known web-server <a href="http://nginx.org/">NGINX</a> is arranged, but at that time there was no SMTP-proxy support in it.  So we started receiving letters almost instantly.  The development of NwSMTP was quite interesting: rollouts took place very often - sometimes according to the version per hour.  Immediately after building a new version, they rolled it out onto one production machine and watched what was going on.  Such efficiency allowed the product to be released very quickly.  From here came the name NwSMTP, this is an abbreviation for Next Week SMTP: almost any task in it goes through the full development cycle in seven days and to the question "When will you do this?" The server development team answers: "Next week." <br><br>  In the middle of 2008, when our Jabber server was launched, we made a real-time notification of new letters as an experiment.  In order not to slow down the billing system, the notifications worked over the UDP protocol, and inside contained XML data convenient for turning into an XMPP packet.  Today, jokes about ‚ÄúXML over UDP‚Äù make us smile, but at that time it worked, albeit with great limitations and loss of some notifications. <br><br><h4>  year 2009 </h4><br>  By this time, several interfaces worked at the same time in Yandex.Mail.  Neo was not interactive: the HTML page was generated inside WMI.  Modern contained an interactive, but was built on the same architecture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f8/672/6c1/9f86726c1189f24155b97ac85d8c02ef.png" alt="Yandex.Mail Interface in 2009"><br><br>  We decided to come up with an interface that loads only the most necessary - what has changed right now.  After a series of experiments, we managed to prepare a platform and prove that such a service could work.  This is how the Daria interface was born, it can be seen in the Mail now. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce2/88e/10d/ce288e10d58a89e4b382110d6e652fcc.png" title="Design Yandex.Mail in 2010"><br><br>  With the transition to dynamics, the query structure has changed greatly.  By this time, the nginx server had developed enough and we decided to put it in front of Baida for the return of static in the Mail (by this time it was already used, for example, in the People).  Simultaneously with Daria, we experimented with the launch of interpreted languages ‚Äã‚Äãon the server side.  We stopped on Javascript mainly because of convenience, since the same programming language is used on the client and the server.  Under the Baida server they wrote a module with <a href="http://en.wikipedia.org/wiki/SpiderMonkey_(JavaScript_engine)">TraceMonkey</a> , it was unfortunately impossible to integrate a <a href="http://en.wikipedia.org/wiki/V8_(JavaScript_engine)">V8</a> .  It was already popular, but at that time the V8 could not work with the third-party programming model (in recent versions of the V8, this flaw was fixed). <br><br>  Nginx allowed us to handle different URLs in different ways, and we split the actual logic, the distribution of attachments, and also rendered the old interfaces to separate clusters.  This greatly simplified the deployment of updates and maintenance, and also allowed the decomposition of the complete system into separate components.  The main methods of mail operation have become independent of secondary ones, the whole system has become more stable. <br><br>  This year we made threads, which certainly had a strong effect on the structure of the database and the load. <br><br>  Traditionally, the size of the box was limited in size, and Yandex.Mail was no exception.  But we decided that it was time to lift this restriction.  This decision has changed our rules.  If earlier we could calculate the load and the size of the storage, then with an infinite box everything is a little more complicated.  We couldn‚Äôt tell at each moment of time how much data we needed to store.  At this time, we added approximately one terabyte of data per day.  For comparison, today we save 120 TB per day. <br><br><h5>  Separate story about the document viewer </h5><br>  Somehow we wanted to check how popular the document viewing service would be.  It was possible to very quickly develop a prototype in python and raise the OpenOffice farm, which converted documents into HTML.  Before the service, they installed nginx for protection against surges in load, added a module for accessing the repository for documents and put them into operation.  In this form, the prototype existed for several years, overgrown with monitoring, optimizations and secondary features.  Now the second version of the browser is being operated, which, incidentally, works on approximately the same technologies. <br><br><h4>  2010 </h4><br>  This year we completely redesigned the search by mail.  The implementation that existed at that time did not suit us both with the speed of work and the quality of the search result.  As a result of refining the search, the system turned out to be based on not only the actual search for letters, serving tens of millions of queries per day, but also some other functions of Yandex.Mail. <br><br>  We are increasingly being asked to do so that our mail service can be connected to our own domain.  This is how Mail for Domains service appeared, which we already <a href="http://habrahabr.ru/company/yandex/blog/181928/">wrote about</a> .  It is remarkable that it was developed and launched on the basis of already existing components with minimal modifications.  This is a fully integrated service that collects information in pieces from different places in order to show it to the domain administrator. <br><br>  Then in 2010 we did a great job to translate internal Yandex correspondence (our colleagues write a lot of letters) on Yandex.Mail technology.  It works in almost the same way as Mail for Domains, but is integrated with other internal services of the company.  Almost all new functions first run in corporate e-mail, are debugged, refined functionally, and only after that they are available to all users. <br><br><h4>  2011 </h4><br>  We actively began offering our users to use HTTPS to protect the transmitted data, and then turned on secure mail handling by default.  This solution, on the one hand, made working with Yandex.Mail more secure, and on the other, it required us to work on setting the connection parameters.  Classically, mail runs on long HTTPS connections with a high keepalive value.  However, in smartphones, this connection mode is often limited or works strangely.  When an HTTPS connection incurs an additional overhead for a handshake, and if the browser does not want or cannot keep the connection open, then each request will incur additional costs.  On narrow channels and weak processors of phones this time becomes noticeable.  Immediately after turning on HTTPS by default, we saw how the graphs of email interface load times increased, and it took some time to find the causes and solve the problem.  Another problem was the display of the HTTP content of HTTPS emails, for example, images added via a tag.  We built a separate service that caches images and is able to give them over HTTPS, after which we replaced the images inserted in the letters with the links of our proxy.  When designing such services, it is important not to allow open redirection - the ability to open any URL from a trusted host, and adding security levels should not lead to a noticeable decrease in performance.  We coped with this task. <br><img src="https://habrastorage.org/getpro/habr/post_images/116/ab4/e08/116ab4e084e687513170d7193958d85f.png" alt="image"><br>  At the same time, the first experiments began with non-relational data stores.  The first service that was transferred to NoSQL ( <a href="http://en.wikipedia.org/wiki/MongoDB">MongoDB</a> ) was the address book.  Up to this point, the operation of the post has not had any combat experience with external non-relational storage technologies.  This experiment was a success - the address book and today stores contact books in MongoDB. <br><br>  Meanwhile, Yandex was preparing to launch in Turkey.  For the service, this meant mandatory localization support, and the translation of the interface is only a small part of the work.  In fact, we prepared and launched a separate product - a Turkish Yandex.Mail - on the same code base.  They differ somewhat functionally, which now need to be remembered when developing.  To speed up access, we installed servers in Europe from which we are delivering static content - this is how our network has become even more extensive. <br><br>  There have been changes in the development process.  The Web Mail Interface, discussed above, has begun to use Scrum and flexible development technologies.  We managed to implement a cycle of continuous display of new functionality, in which each feature or correction of a defect is laid out separately, but it goes through a full production cycle: development, automatic testing, functional testing, load testing, and, finally, a two-stage display into battle - first for one server, and then the entire cluster.  This process allows you to quickly respond to the emergence of new product requirements and eliminate defects. <br><br><h4>  Our days </h4><br>  The launch of Yandex.Disk has significantly changed our equipment operation protocols.  The disk, like Mail, uses Mulca to store users' files, but the amount of downloadable information exceeds the postal one by several times.  Every month, we add at least five server racks to Mulca to ensure reliable storage of your letters and files.  The capacity needs of the core network and the network within the DC have also increased in proportion.  The data volumes are such that in the long term we have moved from planning the installation of racks to planning the opening of new data centers. <br><br>  To revive the mailbox, we developed and launched the <a href="http://habrahabr.ru/company/yandex/blog/141314/">technology "Eva"</a> , which collects avatars of users from open sources and displays them.  All avatars are scaled, cropped and cached in a special repository based on our other development, <a href="http://habrahabr.ru/search/%3Fq%3D%255Belliptics%255D%26target_type%3Dposts">Elliptics</a> , a fault-tolerant distributed key-value repository distributed under the GPL license. <br><br>  Cards organizations, which can be seen in the letters, is another example of a quick solution to the product problem.  Information about companies is updated less frequently, about once every two weeks.  The rest of the time is just a static issue, and the number of these organizations is small - only a few tens of thousands.  To solve the problem of displaying cards, we decided to use cached static html-files that are accessible by hash on behalf of the organization's domain.  The task was solved quickly and ensured high performance and fault tolerance. <br><br>  <a href="http://habrahabr.ru/company/yandex/blog/184788/">The Marker technology</a> allowed us to automatically extract useful information from letters of certain types.  On this technology, for example, it works to extract information from airline tickets and to highlight an event from a letter.  Behind this service is a lot of maintenance work, about a hundred servers and tens of millions of queries every day. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/626/ed0/233/626ed02335cade3487c1c2081ca44b81.png" alt="image"><br><br>  In the meantime, major changes were emerging on the Internet.  The IPv4 address space has come to an end, and June 6, 2012 is considered <a href="http://www.worldipv6launch.org/">IPv6 Day</a> .  For this event, we have prepared our internal architecture to work in IPv6 networks.  Today, IPv6 works for the mail.yandex.com domain and for sending mail.  We are actively working on full IPv6 support in all components and for all of our domains. <br><br>  XScript, which arranged for us for a long time, was finally excluded from the work of the mail.  Now mail is a static web application that communicates with the backend through short API calls.  Calls are still handled inside Baida's WMI server and broadcast through one of its modules. <br><br>  Mail collectors have learned how to collect mail <a href="http://habrahabr.ru/company/yandex/blog/182140/">using the IMAP protocol</a> .  Much more useful information is transmitted via IMAP, which means that the mail collection process has become much more efficient. <br><br>  Behind each of our big and small, past, existing and future technologies are people, real professional engineers: system administrators, developers, managers.  We are always happy when those who like tasks <a href="http://company.yandex.ru/job/vacancies/%3Fcity%3Dmsk">come</a> to us, who have not been solved yet, who are ready to be at the cutting edge of technology and are not averse to writing a few pages in the history of the development of Yandex.Mail. </div><p>Source: <a href="https://habr.com/ru/post/210478/">https://habr.com/ru/post/210478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210462/index.html">SharePoint collection site, managed paths, and can subdomains?</a></li>
<li><a href="../210464/index.html">Samsung and Google enter into patent agreements</a></li>
<li><a href="../210466/index.html">Dev Story: Raildale - a game about the railway for iOS and Mac</a></li>
<li><a href="../210468/index.html">Own chess (with tanks and helicopters)</a></li>
<li><a href="../210472/index.html">What to do if you got an Android with a broken touch screen</a></li>
<li><a href="../210480/index.html">We parallelize processes to speed up computations and tasks in Linux.</a></li>
<li><a href="../210482/index.html">Freelancer's view of management: project management and customer communication</a></li>
<li><a href="../210484/index.html">Chrome extension to soften high-profile news headlines</a></li>
<li><a href="../210486/index.html">The State Duma will approve the threshold of 150 euros for duty-free parcels from online stores?</a></li>
<li><a href="../210488/index.html">Duty-free in foreign online stores you can buy goods no more than 150 dollars / euro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>