<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Macros with a variable number of parameters</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I had to deal with one Open Source project. It was necessary to deal with one mistake. The error was floating and manifested itself exclusive...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Macros with a variable number of parameters</h1><div class="post__text post__text-html js-mediator-article">  Recently I had to deal with one Open Source project.  It was necessary to deal with one mistake.  The error was floating and manifested itself exclusively on the stand, after half an hour the slave.  And even then not always.  Therefore, it was decided to log certain areas of the code. <a name="habracut"></a><br><br>  Therefore, a simple function was written: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * AMsg)</span></span></span></span>;</code> </pre>  which recorded the string in the log.  It soon turned out that such a function was not enough and it was rewritten in this form: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * AFmt, ...)</span></span></span></span>;</code> </pre>  those.  now it uses the vfprintf () function to write a formatted string to the file.  As the number of calls grew, I wanted to write two more parameters to the file, namely __LINE__ and __FILE__.  I did not want to transfer these two parameters with each function call, so it was decided to write a macro wrapper over the dbg () function, which would accept a variable number of parameters, call the original function and pass the file name and line number to it by the first two parameters. <br><br>  Googling, I found a rather beautiful <a href="http://exelab.ru/pro/cpp.php%3Fr%3Dbeginners%26d%3Dzgrt176">solution</a> - to describe the class and reload the operator () in it.  I sketched a test project, tested a new macro and a modified function, and was pleased with the result.  After that, I connected the files to the source project, h-file clicked ‚ÄúStdAfx.h‚Äù and clicked Build.  And then I was deeply disappointed.  It turned out that part of the project was written in pure C, which was meant by my classes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Googling more, I found <a href="http://www.gamedev.ru/faq/%3Fid%3D124">such a</a> solution.  But alas, I used the VC6 ... <br><br>  And then the idea came to me - and if the macro is replaced by a function that takes the parameters __FILE__ and __LINE__, save them somewhere and return a pointer to the original dbg () function.  And this function will read the saved parameters and write them to a file.  It was decided to save the parameters in global variables.  And the variables themselves, in order not to run into a rake when multi-threaded work, declare as __ declspec (thread).  B that's what happened in the end: <br><br>  h-file <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// File debug_info.h #ifndef __DEBUG_INFO_H #define __DEBUG_INFO_H //     ,   typedef void (* DbgFuncType)(const char * AFmt, ...); // ,   __FILE__  __LINE__,       #ifdef __cplusplus extern "C" #endif DbgFuncType DbgFuncRet(const char* AFile, int ALine); //    #define dbg DbgFuncRet(__FILE__, __LINE__) #endif</span></span></code> </pre>  cpp file <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// File debug_info.h #include "StdAfx.h" #include &lt;stdio.h&gt; #include &lt;stdarg.h&gt; __declspec(thread) char __File__[MAX_PATH]; __declspec(thread) int __Line__; void DbgFunc(const char * AFmt, ...) { FILE * log; if (fopen_s(&amp;log, log_name, "a")) return; va_list args; va_start(args, AFmt); vfprintf(log, AFmt, args); fprintf(log, "File: \"%s\", Line: %d\n", __File__, __Line__); fclose(log); va_end(args); } DbgFuncType DbgFuncRet(const char* AFile, int ALine) { strcpy_s(__File__, MAX_PATH, AFile); __Line__ = ALine; return &amp;DbgFunc; }</span></span></code> </pre> <br>  That's all.  The only thing I would like to dwell on is the declaration of the function DbgFuncRet () <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> DbgFuncType DbgFuncRet(const char* AFile, int ALine);</span></span></code> </pre>  Because  Since the header is included in both c and cpp files, the name translator will use different decorations for the function.  And such an announcement tells the broadcaster to always use decoration C. </div><p>Source: <a href="https://habr.com/ru/post/138150/">https://habr.com/ru/post/138150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138141/index.html">Competition for the best name of the project on video surveillance of the presidential elections in Russia</a></li>
<li><a href="../138144/index.html">Console Player .wav for pc-speaker in Linux</a></li>
<li><a href="../138145/index.html">Automate vacation</a></li>
<li><a href="../138146/index.html">Merge sort without using additional memory</a></li>
<li><a href="../138147/index.html">Firefox developers have published a roadmap for 2012</a></li>
<li><a href="../138151/index.html">How do you feel about the eval function in javascript?</a></li>
<li><a href="../138155/index.html">TOP 10 services provided by freelancers</a></li>
<li><a href="../138156/index.html">Controller for home brewery Mega Brewery. Part II</a></li>
<li><a href="../138157/index.html">‚ÄúSimple Business‚Äù - Organization Management Complex ". Version 1.6.1.6</a></li>
<li><a href="../138159/index.html">Leaflet library version 0.3 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>