<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimistic synchronization primitives, queues and all-all-all. Tragicomedy in three acts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I warn you in advance, for those who are in the subject, there will not be much interesting. :) 

 I have an urgent task to implement the basic synchr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimistic synchronization primitives, queues and all-all-all. Tragicomedy in three acts</h1><div class="post__text post__text-html js-mediator-article">  I warn you in advance, for those who are in the subject, there will not be much interesting.  :) <br><br>  I have an urgent task to implement the basic synchronization primitives ( <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D0%25BA%25D1%2581">mutex</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D0%25BC%25D0%25B0%25D1%2584%25D0%25BE%25D1%2580_%2528%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0%2529">semaphore</a> and <a href="http://en.wikipedia.org/wiki/Read_write_lock_pattern">read / write lock</a> ), using only the synchronous queue - the only available primitive.  At the same time along the way, I will tell you how the spinlock is arranged and we will even assemble a small Frankenstein. <br><br><h1>  Part 1: All - Queue </h1><a name="habracut"></a>  The synchronous queue works like this: queue.get () returns the first event in the queue (number), if it does not exist, it puts the stream to sleep.  queue.post (number) sends an event and wakes one of the threads waiting for an event in get (). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1.1 Mutex </h2>  So, to begin with, the simplest task is the mutex.  As the name implies, it (mutex) provides exclusive access to the resource.  The resource in this case is just a single event in the queue.  I.e: <br><br>  <b>Initialization:</b> <br>  queue.post (0); <br>  <b>Capture:</b> <br>  queue.get ();  // we will sleep if the queue is empty. <br>  <b>Release:</b> <br>  queue.post (0);  // we will return the event to the place. <br><br><h2>  1.2 Semaphore </h2>  In a naive way, this scheme can be expanded to a semaphore ‚Äî you just don't have to put anything in the queue in the initialization, the increase in the semaphore counter will be queue.post (0), a decrease in queue.get (). <br><br><h2>  1.3 RWLock </h2>  Now the most difficult thing is read write lock.  The simplest solution can be constructed from a semaphore and mutex.  The disadvantage of this option is that you must initially fix the maximum number of simultaneously reading streams.  How is this technically performed?  Very simple: <br><br>  <b>Initialization:</b> <br>  initialize the semaphore with the maximum number of clients. <br>  <b>Capture reading:</b> <br>  we capture a semaphore (the number of clients decreases by 1) <br>  Exemption to read: release the semaphore (the number of clients increases by 1) <br>  <b>Capture Record:</b> <br>  we capture the mutex, and we capture the maximum number of clients on the semaphore (we will wait until all reading streams release the lock.) The mutex is needed to serialize locks for recording between recording streams, otherwise one stream may capture some of the counter on the semaphore, and the other part.  Dedlock.  Release the mutex after the semaphore is fully captured.  (counter in semaphore 0) <br>  <b>Release:</b> <br>  We capture the mutex, release the semaphore (the counter is again equal to the maximum number of reading clients, release the mutex. <br><br>  On two queues, you can implement a similar scheme, but without specifying the maximum number of clients: <br>  create two queues: a read queue (read_queue) and a write queue (write_queue).  We send zeros to both queues.  <b>Capturing a post</b> looks very simple (like a mutex at the very beginning): instead of capturing we write write_queue.get () and free it with write_queue.post (0).  <b>The capture for reading</b> looks a bit more complicated: first we read our number from the turn turn = read_queue.get (), then we look - if turn == 0, then we also capture write - write_queue.get ().  If this fails, it is nothing, the following reading threads fall asleep on read_queue.get () and there will be no flight.  Now we send in read_queue (turn + 1).  read_queue.post (turn + 1).  Write lock does not return back.  <b>When freeing</b> such a lock, do the following: turn = read_event.get () - 1;  if turn == 0, then you need to return the write lock in place.  After that do read_event.post (turn); <br><br><h1>  Part 2: Spinlock </h1>  Spinlock is a great way to do most of the synchronization work in process space.  This will work if the processors and / or your platform supports some hardware synchronization primitives.  Typically, the semantics of such instructions are combined into several groups: Fetch-And-Add (FAA), Compare-And-Swap (CAS).  There are others, but they are more exotic and I will not touch them. <br><br>  The most interesting of course is the FAA and CAS.  Fetch-And-Add is a processor instruction that atomically increments the value of a variable in memory by some arbitrary number and returns the previous value.  CAS A, B, C atomically compares the value in memory [A] with the desired value B, and if everything is correct, sets the value in memory to number C. On x86 processors, the CAS is represented by the instruction cmpxchg8b. <br><br>  Spinlock in this case is a very simple and fast thing.  We, instead of calling the operating system and wasting precious processor cycles, can arrange the synchronization ourselves.  The simplest spinlock does not even return time to the system ‚Äî you can simply spin in a loop until the desired number appears in the memory.  There are various improvements to this method, but they are outside of this introductory article.  :) <br><br><h2>  2.1 Mutex </h2>  Now I will show the implementation of a mutex on these primitives with the simplest examples: <br>  Implementing with CAS: <br>  <b>Initialization:</b> <br>  value = 1 <br>  <b>Capture:</b> <br>  while (__ compare_and_swap (&amp; value, 1, 0)! = 1) {/ * wait until the memory cell contains 1, which means that the resource is free, if 1, then we atomically write 0 * /} there <br>  <b>Release:</b> <br>  value = 1;  / * just write 1 to the memory * / <br><br>  A little harder on the FAA: <br>  Two numbers must be entered: a ticket (ticket) and a turn (turn), initially both contain 0. <br>  <b>Capture mutex:</b> <br>  my_turn = __fetch_and_add (&amp; ticket, 1);  // get the number of your turn. <br>  while (turn! = my_turn) {/ * waiting for our turn * /} <br>  <b>Release:</b> <br>  __fetch_and_add (&amp; turn, 1);  // increase the turn, the next client gets a lock. <br><br>  The rest of the primitives inquisitive reader can come up with himself and even <b>get the Nobel Prize!</b> <br><br><h1>  Part 3: I'm tired, I want to sleep and when will it all end?  Optimism. </h1>  Now collect our semaphore frankenstein.  If you think about it, it is not at all necessary to present free resources in the form of real messages in a queue and to spend precious resources on it.  We can help fetch-and-add. <br>  <b>Semaphore seizure (wait):</b> <br>  old_value = __fetch_and_add (&amp; value, -1); <br>  if here old_value is greater than 0, then we enjoy life, and we don‚Äôt call for any functions of the operating system, we have enough resources, everything is fine, otherwise we need to do queue.get () and go to sleep. <br><br>  <b>Release of the semaphore</b> (post) should increase the counter by 1: old_value = __fetch_and_add (&amp; value, 1) ;. <br>  If old_value is less than zero here, it means someone slept on the semaphore and needs to be woken up by event.post (0) ;. <br><br>  Voila!  We got an extremely light, simple semaphore <i>optimistically</i> not using the operating system.  A mutex is obtained from a semaphore with a value of 1, and rw-lock is obtained from a semaphore and a mutex from clause 1.3, for example. <br><br>  Thank you for reading to the end!  :) <br></div><p>Source: <a href="https://habr.com/ru/post/56578/">https://habr.com/ru/post/56578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../56570/index.html">The development of the Internet in the regions of Russia - the latest statistics</a></li>
<li><a href="../56572/index.html">Version 1.20 of the free real-time meditative strategy game Dyson has been released</a></li>
<li><a href="../56573/index.html">Socionics "in the search for portraits"</a></li>
<li><a href="../56575/index.html">Professional vs Beginner. Is it possible to order icons for your project ‚Äúthanks‚Äù?</a></li>
<li><a href="../56577/index.html">Laptop table</a></li>
<li><a href="../56583/index.html">Blog post</a></li>
<li><a href="../56584/index.html">Version 1.0.4</a></li>
<li><a href="../56588/index.html">Writing dpi to PNG with PHP</a></li>
<li><a href="../56589/index.html">Writing articles on Yii</a></li>
<li><a href="../56590/index.html">What you need to know the organizer of master classes?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>