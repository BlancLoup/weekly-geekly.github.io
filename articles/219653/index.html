<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we were beaten by current on April 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On fool's day this year, my colleagues and I decided to do a little more than just a joke. We came up with an interactive format with transmissions fr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we were beaten by current on April 1</h1><div class="post__text post__text-html js-mediator-article">  On fool's day this year, my colleagues and I decided to do a little more than just a joke.  We came up with an interactive format with transmissions from our office and made it possible for everyone to tickle our volunteers with a small electrical discharge, literally live. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9fa/5e7/862/9fa5e78624d020ba90bd4444935f7d65.jpg"><br><br>  We will not touch on the moral and ethical side of this issue in the article, just to say that all participants had the opportunity only to simulate getting a discharge, but none of them practically used it. <br><a name="habracut"></a><br>  Here we will talk about how the technical part of this event worked. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Task </h2><br>  On the page there is a slider from three video streams, under each of which there are buttons like from Facebook and VK.  Clicking on any of them should cause the relay corresponding to the slide to close. <br><br><h2>  Implementation in brief </h2><br><ul><li>  Clicking on the like-button causes an ajax request to the server.  On the server, the receiving script collects a queue of ‚Äúclicked‚Äù frames from the slider; </li><li>  On the computer to which the Arduino board is connected, a Qt application is running.  It contacts the site once a second (the idea is to keep one connection burned out due to insufficiently stable connection in the office) and gets a list of ‚Äúslides‚Äù slides; </li><li>  The same application sends the received slide numbers through the serial port to the Arduino, which, according to the received numbers for 1200 ms, turns on the relay; </li></ul><br>  Special thanks to Arduino, Qt and the wonderful QextSerialPort library. <br><br><h2>  Implementation details </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/993/f92/fed/993f92fedbfac60f2f55d18fcc5f446d.jpg"><br>  The blue tape was not there because of the need to use non-Orthodox black tape. <br><br>  First you had to figure out how to catch likes.  API excavations on VK and Facebook led to the following: <br>  inserting more than one button is a bit unpleasant, but possible <br>  catching likes is easy.  Distinguishing them is a little more difficult. <br><br>  Let's do the insertion of several buttons and catching likes. <br><br><h2>  In contact with </h2><br>  We read the manual <a href="https://vk.com/dev/widget_like">vk.com/dev/widget_like</a> , create three blocks: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk vk1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk vk2"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk2"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk vk3"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk3"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  And we initialize them: <br><pre> <code class="java hljs">&lt;scrit&gt; VK.Widgets.Like(<span class="hljs-string"><span class="hljs-string">'vk1'</span></span>, {pageImage:<span class="hljs-string"><span class="hljs-string">'http://site.ru/i/vk.png'</span></span>, pageTitle:<span class="hljs-string"><span class="hljs-string">'  ‚Äî *  !'</span></span>, pageUrl:<span class="hljs-string"><span class="hljs-string">'http://electro.eggo.ru/?1'</span></span>, width:<span class="hljs-number"><span class="hljs-number">80</span></span>,type:<span class="hljs-string"><span class="hljs-string">'mini'</span></span>}, <span class="hljs-number"><span class="hljs-number">100</span></span>); VK.Widgets.Like(<span class="hljs-string"><span class="hljs-string">'vk2'</span></span>, {pageImage:<span class="hljs-string"><span class="hljs-string">'http://site.ru/i/vk.png'</span></span>, pageTitle:<span class="hljs-string"><span class="hljs-string">'  ‚Äî *  !'</span></span>,pageUrl:<span class="hljs-string"><span class="hljs-string">'http://electro.eggo.ru/?2'</span></span>, width:<span class="hljs-number"><span class="hljs-number">80</span></span>,type:<span class="hljs-string"><span class="hljs-string">'mini'</span></span>}, <span class="hljs-number"><span class="hljs-number">200</span></span>); VK.Widgets.Like(<span class="hljs-string"><span class="hljs-string">'vk3'</span></span>, {pageImage:<span class="hljs-string"><span class="hljs-string">'http://site.ru/i/vk.png'</span></span>, pageTitle:<span class="hljs-string"><span class="hljs-string">'  ‚Äî *  !'</span></span>,pageUrl:<span class="hljs-string"><span class="hljs-string">'http://electro.eggo.ru/?3'</span></span>, width:<span class="hljs-number"><span class="hljs-number">80</span></span>,type:<span class="hljs-string"><span class="hljs-string">'mini'</span></span>}, <span class="hljs-number"><span class="hljs-number">300</span></span>); &lt;/scrit&gt;</code> </pre> <br>  With the last parameter, you need to be careful - it affects the cache of the remaining parameters and after any change in the second parameter, you must change the third one.  Sad, but true. <br><br>  Now catching likes.  The documentation says that you can subscribe to the widgets.like.liked event.  But the parameters of the handler function are not described and how to understand which button was pressed is not very clear.  Through the debugger, we managed to find out that there are two parameters a and b, but using undocumented features is fraught.  Remember the laws of Murphy.  Behind this, we set up a global variable ‚Äúslide number‚Äù, according to which we send to the server information about which relay should work (and whom, respectively, of our stars to hit with current).  For maniacs who quickly flip through and like, we use the ostrich algorithm, that is, we will not do anything.  So js begins to take the following form: <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> current_slide = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendLike</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type)</span></span></span><span class="hljs-function"> </span></span>{ $.post(<span class="hljs-string"><span class="hljs-string">'/sn/snh.php'</span></span>, {action:<span class="hljs-string"><span class="hljs-string">'like'</span></span>, socnet:type}, function(reply){}); } VK.Observer.subscribe(<span class="hljs-string"><span class="hljs-string">"widgets.like.liked"</span></span>, <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function"> </span></span>{ sendLike(current_slide); });</code> </pre><br>  On the slideshow we put back and forth functions that change the current_slide variable to the value corresponding to the current frame. <br><br><h2>  Facebook </h2><br>  Now remember about Facebook.  I do not like this social network, but as they say, the taste and color of all markers are different.  In the documentation <br>  <a href="https://developers.facebook.com/docs/plugins/like-button/">developers.facebook.com/docs/plugins/like-button</a> <br>  <a href="https://developers.facebook.com/docs/reference/javascript/FB.Event.subscribe/">developers.facebook.com/docs/reference/javascript/FB.Event.subscribe</a> <br>  find the opportunity to subscribe to the edge.create event and try to use it: <br><pre> <code class="java hljs">$(window).load(function(){ FB.Event.subscribe(<span class="hljs-string"><span class="hljs-string">'edge.create'</span></span>, function(targetUrl) { sendLike( current_slide ); }); });     : &lt;fb:like href=<span class="hljs-string"><span class="hljs-string">"site.ru/?1"</span></span> layout=<span class="hljs-string"><span class="hljs-string">"button_count"</span></span> show_faces=<span class="hljs-string"><span class="hljs-string">"false"</span></span> width=<span class="hljs-string"><span class="hljs-string">"160"</span></span> height=<span class="hljs-string"><span class="hljs-string">"40"</span></span> action=<span class="hljs-string"><span class="hljs-string">"like"</span></span> colorscheme=<span class="hljs-string"><span class="hljs-string">"light"</span></span>&gt;&lt;/fb:like&gt; ... &lt;fb:like href=<span class="hljs-string"><span class="hljs-string">"site.ru/?2"</span></span> layout=<span class="hljs-string"><span class="hljs-string">"button_count"</span></span> show_faces=<span class="hljs-string"><span class="hljs-string">"false"</span></span> width=<span class="hljs-string"><span class="hljs-string">"160"</span></span> height=<span class="hljs-string"><span class="hljs-string">"40"</span></span> action=<span class="hljs-string"><span class="hljs-string">"like"</span></span> colorscheme=<span class="hljs-string"><span class="hljs-string">"light"</span></span>&gt;&lt;/fb:like&gt; ... &lt;fb:like href=<span class="hljs-string"><span class="hljs-string">"site.ru/?3"</span></span> layout=<span class="hljs-string"><span class="hljs-string">"button_count"</span></span> show_faces=<span class="hljs-string"><span class="hljs-string">"false"</span></span> width=<span class="hljs-string"><span class="hljs-string">"160"</span></span> height=<span class="hljs-string"><span class="hljs-string">"40"</span></span> action=<span class="hljs-string"><span class="hljs-string">"like"</span></span> colorscheme=<span class="hljs-string"><span class="hljs-string">"light"</span></span>&gt;&lt;/fb:like&gt;</code> </pre> <br>  The get parameter only serves to ensure that the counters near the buttons work independently of each other. <br>  Save, load the page and test the buttons.  Hurray, the data goes to the server.  For now, nowhere. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/382/72a/81a/38272a81a762c949ce757bdc1b58d473.jpg"><br>  On the photo, the data has already come where it is necessary and the light bulb is lit. <br><br><h2>  Server part </h2><br>  In the absence of a large amount of time and the presence of a small laziness, the server part took the following form: <br>  1. an ajax server that receives reports about http http and sends them to the socket on a daemon process that already stores all of the likes that were not sent to the performing part and sends them on request from the client. <br>  2. a process daemon that is a server on sockets and understands two variants of the request: ‚Äúgive up the message‚Äù and ‚Äúadd a like to the queue‚Äù. <br><br>  The first point is solved briefly and clearly: <br><div class="spoiler">  <b class="spoiler_title">ajax server</b> <div class="spoiler_text"><pre> <code class="hljs php">/sn/snh.php error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_REQUEST[<span class="hljs-string"><span class="hljs-string">'action'</span></span>] == <span class="hljs-string"><span class="hljs-string">'like'</span></span> &amp;&amp; intval($_REQUEST[<span class="hljs-string"><span class="hljs-string">'socnet'</span></span>])) { $address = <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>; $port = <span class="hljs-number"><span class="hljs-number">13666</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Create a TCP/IP socket. */</span></span> $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(); } $result = socket_connect($socket, $address, $port); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(); } socket_write($socket, <span class="hljs-string"><span class="hljs-string">'add '</span></span>.trim(strval($_REQUEST[<span class="hljs-string"><span class="hljs-string">'socnet'</span></span>])).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); $_SESSION[<span class="hljs-string"><span class="hljs-string">'count'</span></span>]++; <span class="hljs-comment"><span class="hljs-comment">//   echo $_SESSION['count']; socket_close($socket); }</span></span></code> </pre> </div></div><br>  ‚ÄúThe Demon‚Äù is a little bit messed up, for he is smarter <br><div class="spoiler">  <b class="spoiler_title">Demon</b> <div class="spoiler_text"><pre> <code class="hljs bash">srv.php &lt;?php error_reporting(E_ALL); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"starting...\n"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$address</span></span> = <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$port</span></span> = 13666; <span class="hljs-variable"><span class="hljs-variable">$sock</span></span> = socket_create(AF_INET, SOCK_STREAM, 0); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"socket ok\n"</span></span>; socket_set_option(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>, SOL_SOCKET, SO_REUSEADDR, 1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!socket_bind(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>, <span class="hljs-variable"><span class="hljs-variable">$address</span></span>, <span class="hljs-variable"><span class="hljs-variable">$port</span></span>)) { socket_close(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>); die(<span class="hljs-string"><span class="hljs-string">'Could not bind to address'</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"bind ok\n"</span></span>; socket_listen(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"listen ok\n"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = array(); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"accepting...\n"</span></span>; socket_set_nonblock(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>); ini_set(<span class="hljs-string"><span class="hljs-string">'log_errors'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-variable"><span class="hljs-variable">$notify_socket</span></span> = array(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$client</span></span> = @socket_accept(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_resource(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"connected client\n"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = trim(socket_read(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>, 32, PHP_NORMAL_READ)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>, <span class="hljs-string"><span class="hljs-string">"get"</span></span>) !==<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"send events\n"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$n</span></span> = -1; <span class="hljs-variable"><span class="hljs-variable">$str</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (++<span class="hljs-variable"><span class="hljs-variable">$n</span></span> &lt; 5 &amp;&amp; count(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>) &gt; 0) { <span class="hljs-variable"><span class="hljs-variable">$str</span></span> .= array_shift(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"\nsend events:"</span></span>.<span class="hljs-variable"><span class="hljs-variable">$str</span></span>.<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen(<span class="hljs-variable"><span class="hljs-variable">$str</span></span>) &gt; 0) { socket_write(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>, <span class="hljs-variable"><span class="hljs-variable">$str</span></span>.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { socket_write(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>, <span class="hljs-string"><span class="hljs-string">"none\n"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>, <span class="hljs-string"><span class="hljs-string">"add"</span></span>)===0) { <span class="hljs-variable"><span class="hljs-variable">$what</span></span> = explode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intval(<span class="hljs-variable"><span class="hljs-variable">$what</span></span>[1])) { socket_write(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>, <span class="hljs-string"><span class="hljs-string">"ok\n"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[]=(int)<span class="hljs-variable"><span class="hljs-variable">$what</span></span>[1]; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"n/c. events: ["</span></span>.implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-variable"><span class="hljs-variable">$events</span></span>).<span class="hljs-string"><span class="hljs-string">"]\n"</span></span>; } } socket_shutdown(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>); socket_close(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"end of chat\n"</span></span>; }//<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> valid connection }//<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> accepted }//<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; socket_shutdown(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>); socket_close(<span class="hljs-variable"><span class="hljs-variable">$sock</span></span>);</code> </pre> </div></div><br>  So, now we run ... <br>  screen php -f srv.php <br><br>  And go to the part that will work with the Arduino.  In the absence of the ethernet shield, we are doing a desktop application that will work as a daisy interface module on the server and Arduino. <br><br>  Since I am a Linux user, and the ‚Äúclient‚Äù computers will work under Windows, then for the development of this module, we take Qt + Qt Creator.  It can make the interface, works with the network, and indeed the thing is good and cross-platform.  There is no standard library for working with the serial port, but there is a wonderful QextSerialPort project: <a href="https://code.google.com/p/qextserialport/">code.google.com/p/qextserialport</a> which I have been using for my own purposes for a long time. <br><br>  We put Q-everything, make a new project, add the network module, QextSerialPort files and rivet a simple interface: a text field for entering the port name and a ‚Äúconnect‚Äù button, which starts an endless process of requesting new likes from the server and sending the entire answer to arduino. <br><br>  I note that the information about the pressed like-buttons is sent to the qt-client in batches of no more than 5 events.  The consideration is simple: this is enough for the receiving party to know what to do and not to strain too much, which can be blocked by the serial port buffer on the Arduino.  Plus there are some considerations of humanity, which are a little lower. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8aa/635/725/8aa6357255522719fbe084c84169c99b.jpg" width="500" height="500"><br>  The main instrument of torture. <br><br><h2>  Arduino </h2><br>  The sketch is extremely simple.  We read a digit from the serial port and feed HIGH to the corresponding pin.  And after 1200ms turn off back. <br><br><div class="spoiler">  <b class="spoiler_title">Arduino code</b> <div class="spoiler_text"><pre> <code class="hljs lua">#define LED_1 A0 #define LED_2 A1 #define LED_3 A2 void setup() { pinMode(LED_1, OUTPUT); pinMode(LED_2, OUTPUT); pinMode(LED_3, OUTPUT); Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); } void LEDoff() { digitalWrite(LED_1, LOW); digitalWrite(LED_2, LOW); digitalWrite(LED_3, LOW); }//<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span> void loop() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Serial.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> ch; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial.available()) { ch=Serial.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'1'</span></span>) { digitalWrite(LED_1, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ch == <span class="hljs-string"><span class="hljs-string">'2'</span></span>) { digitalWrite(LED_2, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'3'</span></span>) { digitalWrite(LED_3, HIGH); } }//<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> delay(<span class="hljs-number"><span class="hljs-number">1200</span></span>); LEDoff(); }//<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> avail }//<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span></code> </pre> </div></div><br>  From the code it is clear that if during the time between polls of the server (about 1-2c) five commands arrive with a current to hit one person, he will receive only one hit.  Firstly, it is more humane.  Secondly, in such a simple way we get rid of the problem with the fact that the distribution of electric shocks can be infinite, if people break in like a wild speed. <br><br>  Switching on for 1200 ms was chosen empirically; this value was enough for the Chinese lighter for the stove to be guaranteed to ‚Äúswing‚Äù a spark. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9b/cc6/21b/e9bcc621bde29f4cbe7fd851f0150716.jpg"><br>  The same Chinese stove lighter is already half-assembled. <br><br><h2>  Iron part on Arduino </h2><br>  Take the Arduino Uno, prototype shield, three relays, wiring, twisted pair trim, 3 Chinese electric lighters and PLS-40 / PBS-40 bar for connections.  While the soldering iron is heating up, we put the shield on the arduino, cut off the centimeters of the 15th twisted pair and cut the connector strips into 3 to 3. The twisted pair turned out to be copper, but mono-core, which was somewhat upsetting, as I was used to home (already deceased) stocks, where the wiring was multicore and soft.  We solder the connecting wires, connect the relay to the Arduino and wiring check the operation of the relay.  Click-Click-Click.  Works. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/09d/e73/afd/09de73afd20133ced9e1a6547deacc17.jpg"><br>  Arduino itself with the installed bar. <br><br>  We disassemble the lighters, solder to the contacts that were closed with a button on the lighter, along a segment of a twisted pair.  The second ends of these wires are inserted into the controlled contacts of the relay, we connect the batteries in the lighters, we try.  We happily swear because we did not notice how we touched the contacts with the elbow =) <br><br>  We stick Arduino in a computer, we fill in the sketch, starts the Qt-client, we try.  The poisonous crackling of sparks from lighters shows what worked. <br><br>  Understanding perfectly well that good people can calmly ‚Äúfry‚Äù the test subjects, and the D-size battery is simply discharged, then parallel to the control contacts of each relay through 1K resistor we turn on the LED placed on the long wire to the upper edge of each monitor.  Given that the lighter ‚Äúswings‚Äù for almost a second, this alarm goes even before the relay clicks and the sparks from the lighter are about half a second. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a37/30c/065/a3730c065262fe895df78671f07e6367.jpg"><br>  The battery was able to hold out all day. <br><br><h2>  Video customization. </h2><br>  Video broadcasting was implemented via youtube using <a href="https://support.google.com/youtube/answer/2853700%3Fhl%3Dru">Live events</a> .  Since one channel can only have one broadcast at a time, we had to make three confirmed channels.  Plus, you need to install the Google hangouts extension in your browser.  Both take not much time. <br>  So, the software part is ready, the cameras are installed.  We open on three computers of our youtube artists, we launch three broadcasts.  We copy on them links for display and we insert them on our page with electrocontrol.  The main thing is not to make a mess of matching cameras and relays.  Well, do not forget the magic phrase ‚Äúdo not close this window!‚Äù. <br>  The restriction on the length of the broadcast at 8h was bypassed simply: at the end of those 8h hours, the old ones were stopped and new broadcasts were launched for the remaining hour (the show lasted 9h).  And the artists got five minutes of rest. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/88c/e30/8e0/88ce308e0b0e1bd099ec5c3a8062ccb2.jpg"><br>  15 minutes before the start. <br><br><h2>  Battle check </h2><br>  During operation, it turned out that there were cunning users who guessed that you could put like, then press dislike and so on ad infinitum. <br><br>  We have not yet decided on this bug or feature, but still, having received lulz from users and fountains of joy and repost, we slightly covered this hole.  We have three streams, each can put like in two social networks.  Total 6 maximum for a ‚Äúnon-clinical‚Äù sadist.  We give a small margin to play around and on the value 9 we begin to show a picture with the inscription ‚ÄúSadist‚Äù.  Yes, we leave the opportunity to play further. <br><img src="https://habrastorage.org/getpro/habr/post_images/d0d/c5f/228/d0dc5f2289a5c695f033f698e6534c27.png"><br><br><h2>  Results </h2><br>  The system is recognized as working and bringing a lot of joy.  Hopefully, the description described here will be a source of inspiration for someone, and we will see other examples of connecting social mechanics with offline. <br><br>  Screenshot of the site, as it looked live <br><div class="spoiler">  <b class="spoiler_title">Tyts</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/c6d/019/a0c/c6d019a0cf04c108b8cb2fa2196808ed.png"></div></div><br>  UPD Video Broadcast.  Video report about the event is mounted. <br>  <a href="http://www.youtube.com/watch%3Fv%3DG52Rfq6wrDk">www.youtube.com/watch?v=G52Rfq6wrDk</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3DS4dwTEVqZIc">www.youtube.com/watch?v=S4dwTEVqZIc</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3Dp0ABXUK3tWo">www.youtube.com/watch?v=p0ABXUK3tWo</a> </div><p>Source: <a href="https://habr.com/ru/post/219653/">https://habr.com/ru/post/219653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219629/index.html">Useful techniques for working with Apache Camel</a></li>
<li><a href="../219635/index.html">Microsoft Azure for Research Grant</a></li>
<li><a href="../219637/index.html">10 game mechanics in HTML Academy</a></li>
<li><a href="../219647/index.html">What happens in the brains of the neural network and how to help them</a></li>
<li><a href="../219651/index.html">Rakes that are not worth stepping on</a></li>
<li><a href="../219655/index.html">Automate acceptance testing for Android applications using Calabash</a></li>
<li><a href="../219657/index.html">String theory for guitarists</a></li>
<li><a href="../219659/index.html">Review of the home robot ver 0.3</a></li>
<li><a href="../219661/index.html">Debugging a Java application when it doesn't wait at all - welcome to the InTrace approach</a></li>
<li><a href="../219665/index.html">Django BDD development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>