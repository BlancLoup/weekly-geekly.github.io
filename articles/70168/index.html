<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing Spring applications. Transactions in Testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About the usefulness of the TDD approach ( development through testing , test driven development ) did not hear only lazy or deaf. But today we will n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing Spring applications. Transactions in Testing</h1><div class="post__text post__text-html js-mediator-article"><img title="spring-overview" src="http://intr13.ru/wp-content/uploads/2009/09/spring-overview-300x231.png" alt="spring-overview" width="300" height="231"><br><br>  About the usefulness of the TDD approach ( <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B7%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B0_%25D1%2587%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B7_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">development through testing</a> , <a href="http://en.wikipedia.org/wiki/Test-driven_development">test driven development</a> ) did not hear only lazy or deaf.  But today we will not discuss all its usefulness and beauty, as well as problems and disadvantages.  Today we will try to see how to develop unit tests for spring applications.  We will also touch on the manual management of transactions in unit tests. <br><a name="habracut"></a><br>  A small note: sometimes spring application tests are not exactly unit tests, because we can raise and use very complex environments (DB, WebService, etc.) in them.  Such tests are more <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">integration tests</a> , but I think that now we will not raise philosophical questions. <br><br>  To begin with, I propose to harmonize some terms and concepts: <br><ul><li>  <strong>Unit-test</strong> - a test that checks the behavior of a small part of the application.  This part can be a single class, one method, or a set of classes that implement some kind of architectural solution, and this solution should be tested for operability.  For details, go <a href="http://wiki.agiledev.ru/doku.php%3Fid%3Dtdd">here</a> or <a href="http://www.agiledata.org/essays/tdd.html">there</a> . </li><li>  <strong>Application context config</strong> - a configuration file in xml format for describing the structure of the spring application.  About spring read <a href="http://www.javaportal.ru/java/articles/spring.html">here</a> or <a href="http://www.springsource.org/about">there</a> . </li><li>  <strong>DAO</strong> - data access object or data access object.  The main purpose of this design pattern is to link the database and our application together.  For details go <a href="http://www.java-course.ru/students/part14.html">here</a> or <a href="http://en.wikipedia.org/wiki/Data_access_object">there</a> . </li><li>  <strong>A transaction</strong> is a group of sequential operations, which is a logical unit of work with data.  A transaction can be executed either completely and successfully, respecting the integrity of the data and independently of other transactions running in parallel, or not executed at all and then it should have no effect.  Read about transactions <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B0%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">here</a> or <a href="http://en.wikipedia.org/wiki/Database_transaction">there</a> . </li></ul><br>  All other terms and concepts are standard and have long been established or their description is uncritical here.  For example, such a thing as IoC ( <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BD%25D1%2582%25D1%2580%25D0%25BE%25D0%25BB%25D1%258F">inversion of control</a> , <a href="http://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I completely forgot, I‚Äôm not writing the first about writing unit tests for spring applications, I‚Äôm a little <a href="http://habrahabr.ru/blogs/java/29395/">here</a> and <a href="http://static.springsource.org/spring/docs/2.5.6/reference/testing.html">there</a> . <br><br>  So, we have a <strong>goal: to test the behavior of the class in the spring-application, in addition, you must manually manage transactions</strong> .  To do this, we will create a simple spring application and write a unit test.  Our unit-test at startup will initialize the application context config of our spring application and then call methods on the class we are testing.  We will also develop a separate test in which we will manage transactions manually. <br><br>  To begin, <b>create an application</b> that we will test.  <strong>Technologies in the application</strong> will be as follows: <br><ol><li>  Tool assembly and compilation - <a href="http://maven.apache.org/">Apache Maven</a> . </li><li>  Database - <a href="http://hsqldb.org/">HSQLDB</a> . </li><li>  The tool for mapping classes to the database (Object relation mapping) is <a href="http://www.hibernate.org/">Hibernate</a> . </li><li>  Tool for configuring the application - <a href="http://www.springsource.org/">Spring framework</a> . </li><li>  Tool for creating unit tests - <a href="http://www.junit.org/">JUnit</a> . </li></ol><br>  The final <strong>file structure in the application</strong> will look like this: <img title="structure" src="http://intr13.ru/wp-content/uploads/2009/09/structure.JPG" alt="structure" width="331" height="395"><br>  By the way, you can <a href="http://intr13-examples.googlecode.com/svn/springTransactionalTest/tags/2009-09-12-23-50/">download it yourself (from SVN)</a> and <a href="http://code.google.com/p/intr13-examples/source/browse/springTransactionalTest/tags/2009-09-12-23-50/">view the</a> source code of the running application <a href="http://code.google.com/p/intr13-examples/source/browse/springTransactionalTest/tags/2009-09-12-23-50/">in the browser</a> . <br><br>  Let's start? <br><br>  <strong>First</strong> , we need to create pom.xml in which we describe the build and compilation of the application (read about maven <a href="http://ru.wikipedia.org/wiki/Apache_Maven">here</a> or <a href="http://maven.apache.org/">there</a> ).  In this <a href="">configuration file,</a> we prescribe all dependencies on the libraries we use.  Also at this step, we will create all the directories of our application. <br><br>  <strong>Second</strong> , we will create a java persistente entity class - <a href="">ru.intr13.example.springTransactionalTest.Data</a> .  This class will describe the data model and with the help of the hibernate library it will be displayed in the database (a table will be automatically created in the database).  Also in this step, we will create the <a href="">hibernate.cfg.xml</a> file, where we will link to the class we developed. <br><br>  <strong>Third</strong> , we will create an interface - <a href="">ru.intr13.example.springTransactionalTest.DataDao</a> .  In which we describe the main methods for working with our database.  The checkpoint and shutdown methods are designed to work with hsqldb and their presence is connected with the peculiarity of the operation of this database (see details <a href="http://hsqldb.org/web/hsqlFAQ.html">here</a> ). <br><br>  <strong>Fourth</strong> , we will create an implementation of the interface we developed - <a href="">en.intr13.example.springTransactionalTest.DataHibernateDao</a> .  Where we implement all the methods described in the DataDao interface.  It is worth noting that this class is inherited from the class org.springframework.orm.hibernate3.support.HibernateDaoSupport, which in turn is part of the Spring Dao library and already has methods for convenient work with the database. <br><br>  <strong>Fifth</strong> , we will create an <a href="">application context config file</a> to configure our application.  In which we describe: <br><ul><li>  Data source ( <strong>dataSource</strong> ), in which we describe the parameters for connecting to our hsqldb database. </li><li>  Factory for working with connections to the database and for displaying our model in the database ( <strong>sessionFactory</strong> ).  When configuring the factory, we will provide a link to the hibernate.cfg.xml file, where all classes of our model are described.  We will also write the parameters for creating and working with the database, a link to the data source. </li><li>  Service developed by us ( <strong>dataDao</strong> ).  When configuring, we will specify a link to the <strong>sessionFactory</strong> . </li><li>  Transaction Manager ( <strong>transactionManager</strong> ).  When configured, we specify a link to the <strong>sessionFactory</strong> and also indicate: what methods we need to start a new transaction. </li></ul><br>  <strong>In the sixth</strong> , we will create a <a href="">test application</a> that initializes the application context config and works a bit with the service we developed.  The results of the work are saved in our local database, which can be observed in the <strong>data / test.db.script</strong> file (this file contains the data of our database): <br><blockquote><code><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">SCHEMA</font> <font color="#0000ff">PUBLIC</font> <font color="#0000ff">AUTHORIZATION</font> DBA <br> <font color="#0000ff">CREATE</font> MEMORY <font color="#0000ff">TABLE</font> <font color="#0000ff">DATA</font> (ID BIGINT <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> ,TEXT <font color="#0000ff">VARCHAR</font> (255)) <br> <font color="#0000ff">CREATE</font> MEMORY <font color="#0000ff">TABLE</font> HIBERNATE_SEQUENCES(SEQUENCE_NAME <font color="#0000ff">VARCHAR</font> (255),SEQUENCE_NEXT_HI_VALUE <font color="#0000ff">INTEGER</font> ) <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">USER</font> SA PASSWORD "" <br> <font color="#0000ff">GRANT</font> DBA <font color="#0000ff">TO</font> SA <br> <font color="#0000ff">SET</font> WRITE_DELAY 10 <br> <font color="#0000ff">SET</font> <font color="#0000ff">SCHEMA</font> <font color="#0000ff">PUBLIC</font> <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> <font color="#0000ff">DATA</font> <font color="#0000ff">VALUES</font> (1, <font color="#A31515">'one'</font> ) <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> <font color="#0000ff">DATA</font> <font color="#0000ff">VALUES</font> (2, <font color="#A31515">'two'</font> ) <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> <font color="#0000ff">DATA</font> <font color="#0000ff">VALUES</font> (3, <font color="#A31515">'three'</font> ) <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> HIBERNATE_SEQUENCES <font color="#0000ff">VALUES</font> ( <font color="#A31515">'Data'</font> ,1)</font></code> </blockquote> <br>  So, the <strong>test application has been created and now we need to develop a unit test</strong> .  To do this, we create a class <a href="">ru.intr13.example.springTransactionalTest.DataDaoTest</a> .  This class is derived from the org.springframework.test.context.junit4.AbstractTransactionalJUnit4SpringContextTests class, which allows you to run the application context config when running tests.  This is done using annotations for the test class: <br><blockquote> <code><font color="black">@ContextConfiguration(locations = { <font color="#A31515">"/applicationContext.xml"</font> }).</font></code> </blockquote> <br>  But for full testing, we need our test to have the opportunity to get a service developed by us.  To do this, we register in our test field with reference to the service and set the annotation for this field - @Autowired: <br><blockquote> <code><font color="black"><font color="#0000ff">@Autowired</font> <br> <font color="#0000ff">private</font> DataDao dataDao;</font></code> </blockquote> <br>  Now when you run the tests in this field will be set a link to the previously developed service. <br><br>  And in the end it remains to write the text of the unit test: <br><blockquote> <code><font color="black"><font color="#0000ff">@Test</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> simpleTest() { <br> String text = UUID.randomUUID().toString(); <br> dataDao.save( <font color="#0000ff">new</font> Data(text)); <br> Collection result = dataDao.find(text); <br> Assert.assertEquals(1, result.size()); <br> Assert.assertEquals(text, result.iterator().next().getText()); <br> }</font></code> </blockquote> <br>  This test creates a Data object, stores it in a database, and then searches for a Data object by its contents. <br><br>  I think there is nothing particularly difficult in the above, and this can even be used, but sometimes in such tests it is required to organize <strong>manual management of transactions</strong> (that is, declaratively roll back or save the transaction, start a new transaction).  How to do this is described <a href="http://static.springsource.org/spring/docs/2.5.6/reference/testing.html">here</a> , but now we consider a small example. <br><br>  To manually manage transactions in tests, we need to get the transaction manager described in the application context config (transactionManager), which is done by creating a field in our test: <br><blockquote> <code><font color="black"><font color="#0000ff">@Autowired</font> <br> <font color="#0000ff">private</font> PlatformTransactionManager transactionManager;</font></code> </blockquote> <br>  Next, we simply create a new transaction: <br><blockquote> <code><font color="black">TransactionStatus transaction = transactionManager.getTransaction( <font color="#0000ff">new</font> DefaultTransactionDefinition(TransactionDefinition.PROPAGATION_REQUIRES_NEW));</font></code> </blockquote> <br>  and then we commit to it (save): <br><blockquote> <code><font color="black">transactionManager.commit(transaction);</font></code> </blockquote> <br>  or rollback: <br><blockquote> <code><font color="black">transactionManager.rollback(transaction);</font></code> </blockquote> <br>  Knowing all of the above, we can write the following test, which creates several transactions manually: <br><blockquote> <code><font color="black"><font color="#0000ff">@Test</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> comlexTest() { <br> TransactionStatus transaction = transactionManager.getTransaction( <font color="#0000ff">new</font> DefaultTransactionDefinition(TransactionDefinition.PROPAGATION_REQUIRES_NEW)); <br> String text = UUID.randomUUID().toString(); <br> dataDao.save( <font color="#0000ff">new</font> Data(text)); <br> transactionManager.commit(transaction); <br> transaction = transactionManager.getTransaction( <font color="#0000ff">new</font> DefaultTransactionDefinition(TransactionDefinition.PROPAGATION_REQUIRES_NEW)); <br> Collection result = dataDao.find(text); <br> Assert.assertEquals(1, result.size()); <br> Assert.assertEquals(text, result.iterator().next().getText()); <br> transactionManager.rollback(transaction); <br> }</font></code> </blockquote> <br>  The final version of the test can be viewed <a href="">here</a> . <br><br>  <b>Total:</b> we created a test application based on the spring framework (the source code lies <a href="http://intr13-examples.googlecode.com/svn/springTransactionalTest/tags/2009-09-12-23-50/">here</a> ).  A way of testing individual services in the spring framework was demonstrated.  It also showed how to manually manage transactions in unit tests.  As a result, we saw that creating simple unit tests for the spring framework is a fairly simple task.  The question of the appropriateness and the need to develop such tests was not considered, this is a topic for a separate conversation. <br><br>  p / s <br>  This is an edited version of a <a href="http://intr13.ru/2009/09/13/425">post</a> from my personal <a href="http://intr13.ru/">blog</a> .  Do not count for advertising :) <br><br>  p / s / s <br>  Picture found <a href="">here</a> .  By the way, an attentive person will notice one funny thing :) </div><p>Source: <a href="https://habr.com/ru/post/70168/">https://habr.com/ru/post/70168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70151/index.html">Work with databases in iPhone, SQLite and work with dates</a></li>
<li><a href="../70162/index.html">Rock # 1: First Album Compiled</a></li>
<li><a href="../70164/index.html">KO3: HMVC and Routing</a></li>
<li><a href="../70165/index.html">Majesty 2</a></li>
<li><a href="../70167/index.html">Server on steroids: FreeBSD, nginx, MySQL, PostgreSQL, PHP, and more</a></li>
<li><a href="../70169/index.html">Point Gray introduced the first USB 3.0 Webcam with support for FullHD video</a></li>
<li><a href="../70170/index.html">Habrarazu tell me ...</a></li>
<li><a href="../70171/index.html">iXBT is infected, according to Yandex</a></li>
<li><a href="../70173/index.html">Doctrine integration in kohana 3</a></li>
<li><a href="../70174/index.html">simple editor bb codes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>