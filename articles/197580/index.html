<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we work with the iPhone camera in QCamplr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all Habra community! 

 Today I would like to use the example of a new product, QCamplr , to tell you how to work with the camera of an i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we work with the iPhone camera in QCamplr</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/5f2/9ee/9a0/5f29ee9a03600813a01f71012f1fe12b.png" alt="image"><br><br>  Greetings to all Habra community! <br><br>  Today I would like to use the example of a new product, <b>QCamplr</b> , to tell you how to work with the camera of an iOS device. <br>  In this post, I will discuss the basic aspects of setting up the camera and obtaining an image for later work with it. <br><a name="habracut"></a><br><h5>  Step 1: Import the frameworks </h5><br>  I've already started using Objective-C syntax in Xcode 5, which is why <pre><code class="hljs swift">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span></code> </pre>  was replaced by <pre> <code class="hljs swift">@<span class="hljs-keyword"><span class="hljs-keyword">import</span></span></code> </pre> <br>  To work with the iOS camera, we definitely need <b>AVFoundation.framework</b> , we may also need the capabilities from <b>CoreMedia</b> , <b>CoreVideo</b> and <b>ImageIO</b> .  I advise you to import all these frameworks right now, so that later there would be no errors. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs actionscript">@<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> AVFoundation;</span></span> @<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> CoreMedia;</span></span> @<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> CoreVideo;</span></span> @<span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> ImageIO;</span></span></code> </pre><br><h5>  Step 2: Declare properties and methods </h5><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureSession</span></span> *captureSession; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *captureDevice; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureVideoPreviewLayer</span></span> *captureVideoPreviewLayer; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDeviceInput</span></span> *captureDeviceInput; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureStillImageOutput</span></span> *captureStillImageOutput; + (QCCameraManager *)sharedManager; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setupCaptureSessionWithSessionPreset:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)sessionPreset captureDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice captureViewLayer:(<span class="hljs-built_in"><span class="hljs-built_in">CALayer</span></span> *)captureViewLayer; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)captureStillImageWithCompletionHandler:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *capturedStillImage))completionHandler; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)toggleCaptureDevice; - (<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDeviceWithPosition:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePosition</span></span>)captureDevicePosition; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureFocusModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withFocusMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureFocusMode</span></span>)focusMode focusPointOfInterest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)focusPointOfInterest; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureExposureModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withExposureMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureExposureMode</span></span>)exposureMode exposurePointOfInterest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)exposurePointOfInterest; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureWhiteBalanceModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withWhiteBalanceMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureWhiteBalanceMode</span></span>)whiteBalanceMode; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureFlashModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withFlashMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureFlashMode</span></span>)flashMode; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureTorchModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withTorchMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureTorchMode</span></span>)torchMode torchLevel:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)torchLevel; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureLowLightBoostOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withLowLightBoostEnabled:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)lowLightBoostEnabled;</code> </pre><br>  All our properties have <b>readonly keyword</b> .  Since we do not want someone to change them directly, but there are situations when we need to quickly access the active session or any other property from the main <b>AVFoundation stack</b> , which is needed for taking <b>pictures</b> from the camera of an iOS device. <br><br>  <i>Next, we announced 11 methods, which I will discuss in more detail in the following steps.</i> <br><br>  <i><b>Now you can safely open the .m file and start writing the implementation of our camera.</b></i> <br><br><h5>  Step 3: Singleton </h5><br>  The fact is that the iOS device supports only one active <b>AVCaptureSession</b> .  If you try to create and run several sessions at the same time, you will see an error in the <b>Console</b> .  There are also a lot of moments when we need to access the camera properties from any class of our application, which is why we will create <b>singleton</b> .  We support ARC, so <b>we</b> create <b>singeton</b> like this: <br><pre> <code class="hljs objectivec">+ (QCCameraManager *)sharedManager { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> dispatchOncePredicate; __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> QCCameraManager *cameraManager = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;dispatchOncePredicate, ^{ cameraManager = [[QCCameraManager alloc] init]; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cameraManager; }</code> </pre><br><br><h5>  Step 4: Create and customize our AVFoundation Stack </h5><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setupCaptureSessionWithSessionPreset:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)sessionPreset captureDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice captureViewLayer:(<span class="hljs-built_in"><span class="hljs-built_in">CALayer</span></span> *)captureViewLayer { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureSession:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureSession</span></span> alloc] init]]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] canSetSessionPreset:sessionPreset]) { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] setSessionPreset:sessionPreset]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] setSessionPreset:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureSessionPresetHigh</span></span>]; } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureDevice:captureDevice]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureDeviceInput:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDeviceInput</span></span> alloc] initWithDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDevice] error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] inputs] count]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] canAddInput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput]]) { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] addInput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput]]; } } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureStillImageOutput:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureStillImageOutput</span></span> alloc] init]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput] setOutputSettings:[[<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> alloc] initWithObjectsAndKeys:<span class="hljs-built_in"><span class="hljs-built_in">AVVideoCodecJPEG</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">AVVideoCodecKey</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] canAddOutput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput]]) { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] addOutput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput]]; } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> configureWhiteBalanceModeOnDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDevice] withWhiteBalanceMode:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> configureLowLightBoostOnDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDevice] withLowLightBoostEnabled:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureVideoPreviewLayer:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureVideoPreviewLayer</span></span> alloc] initWithSession:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession]]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureVideoPreviewLayer] setVideoGravity:<span class="hljs-built_in"><span class="hljs-built_in">AVLayerVideoGravityResizeAspectFill</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureVideoPreviewLayer] setBounds:[captureViewLayer bounds]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureVideoPreviewLayer] setFrame:[captureViewLayer bounds]]; [captureViewLayer setMasksToBounds:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; [captureViewLayer insertSublayer:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureVideoPreviewLayer] atIndex:<span class="hljs-number"><span class="hljs-number">0</span></span>]; }</code> </pre><br><br>  It's all pretty simple: <br><ul><li>  We create a session, and we give it a preset, it affects the quality and resolution of the image that you will receive during the output of the image on the screen and direct shooting. </li><li>  Choose the device that will be used for shooting, in our case, by default it is always the back camera </li><li>  Next we have to connect the <b>input</b> to our session.  We will need it in order to display the image from the camera on the screen in real time.  Session supports only one <b>input</b> , while the amount of <b>output is</b> not limited to one.  Checks like "can I connect this <b>input</b> to a session?" Should always be done! </li><li>  We do about the same thing, only now we attach <b>output</b> , we will need it in order to take pictures and get a real image from the camera.  Checks like "can I attach this <b>output</b> to a session?" Should be done, always! </li><li>  Further, we carry out a small configuration of those camera options to which we do not give access to the user.  I will tell you more about them later. </li><li>  Finally, we create a layer on which the picture will be displayed in real time from our <i>input device</i> .  We add the layer as a <b>sublayer</b> layer, which we passed as an argument to this method. </li></ul><br><br>  Session created!  To start it, you need to call the <b>startRunning</b> method of the <b>captureSession</b> property, in order to terminate the session, you need to call the <b>stopRunning</b> method. <br><br>  This is how a call to this method in your controller might look like: <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[[QCCameraManager sharedManager]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">setupCaptureSessionWithSessionPreset</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:AVCaptureSessionPresetPhoto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">captureDevice</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">captureViewLayer</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[self view]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">layer</span></span>]]; <span class="hljs-selector-attr"><span class="hljs-selector-attr">[[[[QCCameraManager sharedManager]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">captureSession</span></span>] <span class="hljs-selector-tag"><span class="hljs-selector-tag">startRunning</span></span>];</code> </pre><br><br><h5>  Step 5: Set up the camera </h5><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureTorchModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withTorchMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureTorchMode</span></span>)torchMode torchLevel:(<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)torchLevel { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice hasTorch] &amp;&amp; [captureDevice isTorchAvailable]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice torchMode] != torchMode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isTorchModeSupported:torchMode]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(([captureDevice isTorchActive]) &amp;&amp; (torchMode == <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureTorchModeOn</span></span>))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((torchMode == <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureTorchModeOn</span></span>) &amp;&amp; (torchLevel &gt;= <span class="hljs-number"><span class="hljs-number">0.0</span></span>f)) { [captureDevice setTorchModeOnWithLevel:torchLevel error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [captureDevice setTorchMode:torchMode]; } [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureFlashModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withFlashMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureFlashMode</span></span>)flashMode { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isFlashAvailable] &amp;&amp; [captureDevice isFlashModeSupported:flashMode]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice flashMode] != flashMode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { [captureDevice setFlashMode:flashMode]; [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureWhiteBalanceModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withWhiteBalanceMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureWhiteBalanceMode</span></span>)whiteBalanceMode { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isWhiteBalanceModeSupported:whiteBalanceMode]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice whiteBalanceMode] != whiteBalanceMode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { [captureDevice setWhiteBalanceMode:whiteBalanceMode]; [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureFocusModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withFocusMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureFocusMode</span></span>)focusMode focusPointOfInterest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)focusPointOfInterest { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isFocusModeSupported:focusMode] &amp;&amp; [captureDevice isFocusPointOfInterestSupported]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice focusMode] == focusMode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { [captureDevice setFocusPointOfInterest:focusPointOfInterest]; [captureDevice setFocusMode:focusMode]; [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureExposureModeOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withExposureMode:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureExposureMode</span></span>)exposureMode exposurePointOfInterest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)exposurePointOfInterest { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([captureDevice isExposureModeSupported:exposureMode] &amp;&amp; [captureDevice isExposurePointOfInterestSupported]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice exposureMode] == exposureMode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { [captureDevice setExposurePointOfInterest:exposurePointOfInterest]; [captureDevice setExposureMode:exposureMode]; [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)configureLowLightBoostOnDevice:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDevice withLowLightBoostEnabled:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)lowLightBoostEnabled { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isLowLightBoostSupported]) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice isLowLightBoostEnabled] != lowLightBoostEnabled) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice lockForConfiguration:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]) { [captureDevice setAutomaticallyEnablesLowLightBoostWhenAvailable:lowLightBoostEnabled]; [captureDevice unlockForConfiguration]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } }</code> </pre><br>  All possible camera settings are carried out by our own methods, they all work on the same principle.  All you need to know is that before changing the parameters we need to call the <b>lockForConfiguration:</b> method, after we have completed the configuration process, we need to call the <b>unlockForConfiguration</b> method. <br><br>  In <b>QCamplr,</b> we enable the user to configure 4 options: flash, flashlight (night shooting), focus and exposure. <br><br><img src="https://habrastorage.org/storage3/318/13d/afa/31813dafac423eb944a1d1ee6223f959.png" alt="image"><br><br><h5>  Step 5: Photographing </h5><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)captureStillImageWithCompletionHandler:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *capturedStillImage))completionHandler { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput] isCapturingStillImage]) { [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] postNotificationName:<span class="hljs-string"><span class="hljs-string">@"QCCameraManagedWillCaptureStillImageNotification"</span></span> object:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> userInfo:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput] captureStillImageAsynchronouslyFromConnection:[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureStillImageOutput] connectionWithMediaType:<span class="hljs-built_in"><span class="hljs-built_in">AVMediaTypeVideo</span></span>] completionHandler:^(<span class="hljs-built_in"><span class="hljs-built_in">CMSampleBufferRef</span></span> imageDataSampleBuffer, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (imageDataSampleBuffer) { <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *capturedStillImage = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> alloc] initWithData:[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureStillImageOutput</span></span> jpegStillImageNSDataRepresentation:imageDataSampleBuffer]]; completionHandler([capturedStillImage croppedImageFromCaptureDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDevice]]); } }]; } }</code> </pre><br><br>  This method is called when you click on the big red ‚Äútugler‚Äù in QCamplr.  In the completionHandler comes a picture in jpeg format, wrapped in an object of class UIImage. <br><br><img src="https://habrastorage.org/storage3/6e1/2f6/691/6e12f6691ded366b8190f7883dc29240.png" alt="image"><br><br>  Now a few helper methods that will help you in working with the camera. <br><br><h5>  Method # 1 </h5><br>  You can access the front or rear camera using this method: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *)captureDeviceWithPosition:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePosition</span></span>)captureDevicePosition { <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *captureDevices = [<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> devicesWithMediaType:<span class="hljs-built_in"><span class="hljs-built_in">AVMediaTypeVideo</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> *captureDevice <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> captureDevices) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([captureDevice position] == captureDevicePosition) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> captureDevice; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br><br><h5>  Method # 2 </h5><br>  You can switch from the front camera to the rear one and vice versa using this method: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)toggleCaptureDevice { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevice</span></span> devicesWithMediaType:<span class="hljs-built_in"><span class="hljs-built_in">AVMediaTypeVideo</span></span>] count] &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDeviceInput</span></span> *captureDeviceInput = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput] device] position] == <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePositionBack</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureDeviceInput:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDeviceInput</span></span> alloc] initWithDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceWithPosition:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePositionFront</span></span>] error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput] device] position] == <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePositionFront</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureDeviceInput:[[<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDeviceInput</span></span> alloc] initWithDevice:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceWithPosition:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePositionBack</span></span>] error:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput] device] position] == <span class="hljs-built_in"><span class="hljs-built_in">AVCaptureDevicePositionUnspecified</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureDevice:[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput] device]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] beginConfiguration]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] removeInput:captureDeviceInput]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] canAddInput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput]]) { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] addInput:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureDeviceInput]]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] addInput:captureDeviceInput]; } [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureSession] commitConfiguration]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } }</code> </pre><br><br><h5>  Useful links </h5><br>  <a href="https://developer.apple.com/av-foundation/">AVFoundation Documentation</a> <br>  <a href="https://www.qcamplr.com/">QCamplr official website</a> <br><br>  PS I hope this article was useful to all those who wanted to get more freedom and flexibility in working with the camera device, but did not know where to start.  I wish you all a lot more quality code, and good luck in our difficult task! </div><p>Source: <a href="https://habr.com/ru/post/197580/">https://habr.com/ru/post/197580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197566/index.html">Localization of Node.js applications Part 1</a></li>
<li><a href="../197568/index.html">Column Viks VS-BT10 as a solution to parent-child music problems</a></li>
<li><a href="../197570/index.html">200 line Go balancer</a></li>
<li><a href="../197574/index.html">October 23 - Virtual Conference "All about Windows 8.1" for developers</a></li>
<li><a href="../197578/index.html">Paradoxes of set theory and their philosophical interpretation</a></li>
<li><a href="../197582/index.html">KiCad and GOST. HBO Library</a></li>
<li><a href="../197584/index.html">Yandex bought Film Search</a></li>
<li><a href="../197586/index.html">Testing installers in Windows when you need to quickly and cheaply</a></li>
<li><a href="../197588/index.html">Collected Website Psd Layout Requirements</a></li>
<li><a href="../197590/index.html">MonoDB vs PostgreSQL performance comparison. Part I: No index</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>