<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What if your card looks like this?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, my name is Vlad. I am a leading developer of the project Ezem.ru. In the picture above you can see all the sites posted by our users in the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What if your card looks like this?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/olpictures/1f0/1ae/fdb/1f01aefdb4aab272b211dc04b68f2790.jpg" width="450" height="457" alt="Ezem.ru - Land" hspace="10" vspace="10"><br><a name="habracut"></a><br><br>  Greetings, my name is Vlad.  I am a leading developer of the project <a href="http://www.ezem.ru/">Ezem.ru.</a>  In the picture above you can see all the sites posted by our users in the Moscow region (8000+ sites).  I want to tell you how we solved this problem and what pitfalls were in our way. <br><br>  The main problem is that when we have more than 500 objects on the map - the average office computer begins to slow down terribly and it becomes difficult to use the card.  In addition to the main problem, if you display all the plots, it is impossible to click on any particular marker, and in Moscow there was just some kind of black hole :) We climbed up to watch how other Google Maps API users solved this problem.  <a href="http://poi.gps-club.ru/speedcam.html">GPS-Club: POI: Speed ‚Äã‚ÄãCameras</a> , <a href="http://www.gdeetotdom.ru/">Where is this house</a> , <a href="http://www.mirtesen.ru/">MirTesen</a> , <a href="http://www.pushkino.org/">Pushkino.org</a> (the first thing that came to mind), either did not solve the problem with ‚Äúbrakes‚Äù, or simply limit the number of objects on the screen.  And the problem here is probably not in google maps api, but in the DOM model itself, which is very slow in the Internet killer (IE 6). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>Crutches 1. Use standard tools.</strong> <br>  Glance fell on <a href="http://econym.googlepages.com/markermanager.htm">GMarkerManager</a> .  The principle of its operation is simple.  To load in DOM only those markers that we now see on the screen, thereby reducing the number of DOM objects and facilitating the already difficult life of the browser ... <br>  But looking in more detail at the <a href="http://code.google.com/apis/maps/documentation/reference.html">documentation</a> was a bit confused: <br><blockquote>  This class is deprecated;  developers are recommended to use the open source MarkerManager instead. </blockquote><br><br><br>  <strong>Crutches 2. Use third-party tools.</strong> <br>  After wandering around the Internet and asking passers-by, I came across a wonderful library with a no less remarkable name " <a href="http://code.google.com/p/gmaps-utility-library/">MarkerManager</a> ".  The principle of its operation is the same as that of GMarkerManager, but with a slight difference.  There are functions to delete all markers on the screen and delete a specific marker.  This crutch worked correctly, but only until the number of markers exceeded 3,000. Another stone was that the markers were loaded when you first entered the page and processed them (200kb XML), on the client side, It took quite a lot of time.  In general, it was decided to juggle AJAX with requests and pull out ONLY the markers of the visible area and ONLY of the zoom on which we are now.  This option, with minor amendments, works on our website. <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/578/97e/33f/57897e33ff57ec0f0c77013c61cbf281.jpg" width="217" height="186" hspace="10" vspace="10" align="right"><br>  <strong>Crutches 3. Grouping markers.</strong> <br>  As I said above, the more markers we have concentrated at one point, the harder it is to use the map.  Indeed, to get on any particular marker, sometimes, it became simply impossible.  It was decided to reduce the number of markers on the screen and implement the grouping of markers on the server side.  The solution is quite simple, but not too correct.  For each map zoom, the correct sizes of the rectangles (see the picture on the right) were selected and the markers that fall into this area were marked as children and only 1 of them were shown on this zoom.  And so for each ungrouped marker and for each zoom.  The advantages of this approach are that it is now possible to use the card.  But in this approach there are major drawbacks: the calculation took about 12 minutes and was done ONCE per day.  We overcame the slowness of the map, but we had another problem: since counting markers was done once a day, we could not incorporate grouping into our filters.  And the browser could easily be put on my knees by choosing the type: "Individual housing construction (only red markers)" and the size of the plot from 0 to 50 hectare. <br><br>  <strong>Crutch 4. Dynamic grouping of markers.</strong> <br>  The idea that the browser can be put on our knees with 2 mouse clicks kept us awake and we decided to make a more advanced version of the group: <br><br>  <strong>Option 1. Static squares</strong> <br>  The idea gave <a href="http://sumo.habrahabr.ru/">Oleg Volchkov</a> .  Calculate in advance ALL possible card squares on ALL possible zooms.  Immediately make a reservation that the coefficient of the rectangle for each of the zooms is different and we considered only Russia.  We got more than 23 000 000 records and the base ‚Äúrecovered‚Äù by 200 MB.  The advantage of this approach is that the grouping of markers was carried out more accurately than in the second version.  The disadvantages are that the data had to be calculated (it took about one night on the development wheelbarrow) and the already calculated data needed to be allocated to a separate database, and this would have pulled some refactoring. <br><br>  <strong>Option 2. Grouping by visible area only.</strong> <br>  The author of this idea is <a href="http://ksa242.habrahabr.ru/">Sergey Kolchin</a> .  Every time when we move the map, we transfer the coordinates of the visible area to the server - so why not just divide this rectangle and group markers in real time?  The downside in this case is that when shifted by small distances the markers will move slightly.  We considered this to be an uncritical problem because, firstly, the markers do not move so much, and secondly: the user usually immediately approaches the area of ‚Äã‚Äãinterest, and does not travel around the map.  This option, due to the fact that it is simpler and works faster than the 1st and is used on our site to this day. <br><br>  <strong>A bit of conceptual code:</strong> <br><br>  Request example: <a href="http://ezem.ru/gmap/getmarkers/%3Fappointment%3D%26area_min%3D100%26area_max%3D0%26zoom%3D10%26units%3D3%26no_groups%3Dfalse%26deal_type%3Dbuy%26except_objects%3D%26lat1%3D55.522411831398216%26lng1%3D37.2216796875%26lat2%3D55.98762792516235%26lng2%3D38.0126953125">http://ezem.ru/gmap/getmarkers/?appoi ..</a> <br><br>  <b><a href="">Markermanager</a></b> <br><blockquote><pre> / * Copyright (c) 2007 Google Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file.
  * You can get a copy of the License at
  *
  * http://www.apache.org/licenses/LICENSE-2.0
  *
  *
  * distributed under an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the license for the specific language permissions and
  * limitations under the License.
  *
  * Version: 1.0
  * Author: Doug Ricket, others
  *
  * Marker manager
  Add to viewport changes.
  *
  *
  Algorithm:
  * When the user moves the grid cells
  * All the markers in those
  * cells.
  * (If the users scrolls the viewport beyond the markers that are loaded,
  * no markers will be visible until the EVENT_moveend triggers an update.)
  *
  * In practical consequences, this allows 10,000 markers to be distributed over
  * a large area, view as 100-200
  * visible markers,
  * rather than poor performance corresponding to 10,000 markers.
  *
  * Note that some code is optimized for speed over space,
  * with the goal of accommodating thousands of markers.
  *
  * /

 The file is big and I didn‚Äôt upload it.  You can watch it by the link http://ezem.ru/js/gmap/markermanager.js
</pre></blockquote><br><br>  <b>Function handler</b> <br><br><blockquote><pre>     public function getmarkersAction ()
     {
         $ params = array ();
         foreach (array ('zoom', 'area_min', 'area_max', 'units') as $ k) {
             $ params [$ k] = (int) $ this -&gt; _ getParam ($ k, 0);
         }
         foreach (array ('lat1', 'lat2', 'lng1', 'lng2') as $ k) {
             $ params [$ k] = round ((float) $ this -&gt; _ getParam ($ k, 0.0), 4);
         }
         $ params ['no_groups'] = ('true' == $ this -&gt; _ getParam ('no_groups', null));
         $ params ['deal_type'] = ('sell' == $ this -&gt; _ getParam ('deal_type', null))?  'sell': 'buy';
         $ params ['appointment'] = explode (',', trim ($ this -&gt; _ getParam ('appointment', '')));
         $ params ['except_objects'] = explode (',', trim ($ this -&gt; _ getParam ('except_objects', ''))));

         $ dbWhere = Medialab_Items :: getActiveItemsLimits ();
         if (@ $ this-&gt; user-&gt; id) {
             $ dbWhere = array ('(('. implode ('AND', $ dbWhere). ') OR o.uid ='. $ this-&gt; user-&gt; id. ')');
         }
         $ dbWhere [] = "` deal`.`type` = '". $ params [' deal_type ']."' "";
         $ dbWhere [] = '`marker`.`is_polygon` = 0';

         $ markers = Medialab_Gmap_Marker :: getMarkersDynamic ($ params, $ dbWhere);

         $ qty = 0;
         $ s = "&lt;m&gt; \ n";
         foreach ($ markers as $ marker) {
             $ isGroup = (1 &lt;$ marker ['qty']);
             $ s. = '&lt;mi = "'. $ marker ['id']. '"'
                 .'o = "'. $ marker [' object_id '].'" '&lt;BR /&gt;
                 .'t = "'. $ marker [' lat '].'" ' 
                 .'g = "'. $ marker [' lng '].'" ' 
                 .'q = "'. $ marker [' qty '].'" ' 
                 .'a = "'. ($ isGroup?' group ': $ marker [' appointment_type ']).'" /&gt; '. "\ n";
             $ qty + = $ marker ['qty'];
         }
         $ s. = '&lt;info count = "'. $ qty." \ "/&gt; \ n";
         $ s. = '&lt;/ m&gt;';

         header ('Content-Type: text / xml; charset = windows-1251');
         exit ($ s);
     }
</pre></blockquote><br><br>  <font color="red">BRANCH BR out of code.</font>  <font color="red">I had to insert it, otherwise habraparser buggy.</font>  <font color="red">I do not know why, but without it, it pulls out a piece of code in one line and scrolling appears.</font> <br><br>  <b>A class that deals with everything dirty :)</b> <br><blockquote><pre> class Medialab_Gmap_Marker {/ * * * Block size in degrees for a scale of 0. * 72x128 sets 6x6 blocks in the visible area * 64x96 - 8x8 * * * / public static $ blockSize = array ('lat' =&gt; 64.0, 'lng' = &gt; 96.0);  / ** * Calculate map * * @param int $ zoom Map zoom * @return array Block $ public = function ($ zoom = 10) {$ rect = array () ;  foreach (array ('lat', 'lng') as $ k) {$ rect [$ k] = round (self :: $ blockSize [$ k] / (1 &lt;&lt; $ zoom), 4);  $ rect [$ k .'_ half '] = round ($ rect [$ k] / 2, 4);  } return $ rect;  } / ** * Fetches markers for visible map area, dynamically grouping them if needed * * @param array $ params Array of search params, provide at least (lat, lng) .  * @param array $ dbWhere Additional SQL query conditions (*) *return array Found items * * TODO: w / Google Maps API * / public static function getMarkersDynamic (array $ params, array $ dbWhere = array ()) {$ block = self :: getBlockSize ($ params ['zoom']);  $ dbWhere [] = '(`marker`.`lat` BETWEEN'. $ params ['lat1']. 'AND'. $ params ['lat2']. ')';  // Longitude 180 -&gt; -180 degrees wrap workaround if ($ params ['lng2'] &lt;$ params ['lng1']) {$ dbWhere [] = '((`` ```lng` BETWEEN'. $ Params ['lng1']. 'AND 180.0) OR (`marker`.`lng` BETWEEN -180.0 AND'. $ params ['lng2']. '))';  } else {$ dbWhere [] = '(`marker``lng` BETWEEN'. $ params ['lng1']. 'AND'. $ params ['lng2']. ')';  } if (($ params ['area_min'] || $ params ['area_max']) &amp;&amp; $ params ['units']) {$ unit = DB :: FindFirst ('ezem_units', array ('rate'), array ('id' =&gt; $ params ['units']));  if ($ params ['area_min']) {$ dbWhere [] = '`o`.`area`&gt; ='. ($ params ['area_min'] * $ unit ['rate']);  } if ($ params ['area_max']) {$ dbWhere [] = '`o`.`area` &lt;='. ($ params ['area_max'] * $ unit ['rate']);  }} $ a = $ params ['appointment'];  if (count ($ a) &amp;&amp; $ a [0]) {$ dbWhere [] = "` appointment`.`type` IN ('".implode ("', '", $ a)."') ";  } $ a = $ params ['except_objects'];  if (count ($ a) &amp;&amp; $ a [0]) {$ dbWhere [] = '`o`.`id` NOT IN (' .implode (',', $ a). ')';  } $ dbGroupBy = '`marker`.`id`';  if (($ params ['zoom'] &lt;13) &amp;&amp;! $ params ['no_groups']) {// Group only for zooms &lt;= 12 and with no' no_groups' flag set $ dbGroupBy = '`grp_lat`,` grp_lng` ';  } $ query = 'SELECT `marker`.`id`,` marker``object_id`, `appointment`.`type` AS` appointment_type`, AVG (`marker`.`lat`) AS` lat`, AVG (`marker``lng`) AS` lng`, FLOOR ((`marker`.`lat` - '. $ params [' lat1 '].') / '. $ block [' lat '].') AS `grp_lat`, FLOOR ((` marker``lng` - '. $ Params [' lng1 '].') / '. $ Block [' lng '].') AS `grp_lng`, COUNT (` marker `.`id`) AS` qty` FROM `ezem_gmap` AS` marker` JOIN `ezem_object` AS` o` ON (`o`.`id` =` marker`.`object_id`) JOIN `ezem_appointment` AS` appointment` ON (`appointment`.`id` =` o`.`applement_id`) JOIN `ezem_deal` AS` deal` ON (`deal`.`id` =` o`.`deal_id`) WHERE '.implode ('AND', $ dbWhere). '  GROUP BY '. $ DbGroupBy;  return DB :: Query ($ query);  }} </pre></blockquote><br><br>  The portal is implemented on <a href="http://framework.zend.com/">Zend Framework</a> , <a href="http://www.smarty.net/">Smarty</a> , <a href="http://company.yandex.ru/technology/server/">Yandex Server</a> and <a href="http://www.jquery.com/">Jquery</a> .  A working example of what I said can be found on our <a href="http://www.ezem.ru/gmap/">website</a> . <br><br>  <b>ps</b> Plans for the near future: add support for polygons and replace <a href="http://company.yandex.ru/technology/server/">Yandex search</a> with <a href="http://www.sphinxsearch.com/">sphinx</a> , but more on that in the next articles. <br>  <b>pps</b> We are still looking for <a href="http://habrahabr.ru/job/4956/">intelligent programmers</a> . </div><p>Source: <a href="https://habr.com/ru/post/28621/">https://habr.com/ru/post/28621/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../286198/index.html">Runa Capital investment fund invested in MariaDB</a></li>
<li><a href="../28620/index.html">Smart swimsuit</a></li>
<li><a href="../286200/index.html">Priority structure in web content creation projects</a></li>
<li><a href="../286202/index.html">The apotheosis of a loser or how I like failing startups and their founders</a></li>
<li><a href="../286208/index.html">The devaluation of the ruble had a positive impact on revenues from communication services "Beeline"</a></li>
<li><a href="../286210/index.html">Mail.ru Group Announced Uncertainty In HeadHunter Sales</a></li>
<li><a href="../286212/index.html">Forbes ranked the 20 most expensive Runet companies</a></li>
<li><a href="../286214/index.html">At the end of 2014, games and social services are the main points of growth of income of Mail.ru Group</a></li>
<li><a href="../286216/index.html">Managing Retrospective or Looking Into the Past: Gov.uk Handbook</a></li>
<li><a href="../286218/index.html">New blog from Intellin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>