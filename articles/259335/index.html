<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New 2GIS under Windows Phone: architecture and technology stack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Shel 2013 year. For a dollar, they gave 30 rubles, and I got a job at 2GIS to develop for Windows Phone. I managed to participate in the launch of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New 2GIS under Windows Phone: architecture and technology stack</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5ef/14b/6c1/5ef14b6c17c546ea807c56c161705371.png" alt="picture to attract attention"><br><br>  Shel 2013 year.  For a dollar, they gave 30 rubles, and I got a job at 2GIS to develop for Windows Phone.  I managed to participate in the launch of the almost ready for that time application 2GIS, which soon became available to our users in the Marketplace. <br><br>  This application had one annoying feature: it worked on our WebAPI, and, accordingly, required an Internet connection.  Therefore, almost immediately it became necessary to teach 2GIS under WP to work offline.  But at the same time to solve other pressing problems. <br><a name="habracut"></a><br><h1>  Reasons to rewrite everything </h1><br>  The old application, despite the fact that it was published quite recently, did not cope well with the requirements of users and businesses.  Requirements looked like this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Fast data delivery </h3><br>  Suppose 2GIS learned some new information about your city.  In order to share this information with users, we performed such actions here. <br><br><ol><li>  They taught the application to display new data. </li><li>  All tested. </li><li>  Published a new version of the application in the store. </li><li>  We released data updates for the city. </li></ol><br>  Only after that you downloaded the new version of the application, and found out, finally, how much does it cost to comb a beard in the nearest barbershop.  I am not talking about the problems of versioning data and applications, compatibility and all that.  Fast data delivery means that we would like to exclude items 1-3 from this process altogether, and thus make the beard owners a little happier. <br><br><h3>  The rapid emergence of new features </h3><br>  Suppose we come up with a new search algorithm that searches better and faster.  I wanted this algorithm to appear in the product without significant effort on the part of the Windows Phone team. <br><br><h3>  Offline </h3><br>  As I said, for the previous version of the application needed the Internet. <br><br><img src="https://habrastorage.org/files/603/fca/655/603fca655cfa4df298af8f422ebadca4.png" alt="picture with a bad review"><br><br>  For some of our users, this was slightly frustrating, and therefore the new 2GIS for WP had to work offline. <br><br><h1>  The architecture of the new 2GIS under Windows Phone </h1><br>  Well, our small, but friendly team has clarified the basic requirements, was charged early in the morning with positive feedback from fresh reviews and began to develop.  First of all, of course, architecture. <br><br>  It should be said that in 2GIS, mobile applications have been doing for quite some time, and for other platforms, several versions have changed.  When we designed the architecture, we took into account the experience gained by the company and the requirements voiced above.  That's what happened. <br><br><img src="https://habrastorage.org/files/4af/623/e61/4af623e610bc4c9f917547e5ff300475.png" alt="architecture"><br><br><h3>  Cross-platform core </h3><br>  The upper block in the picture is a cross-platform core, the foundation of everything, the entry point to all our algorithms and services.  Our offline back end to which we ask questions and get answers.  This thing provides us work without connecting to the network.  We call it cross-platform, because we can build it not only under WP, but also under Windows, OS X, Linux, iOS and Android. <br><br>  In accordance with the requirement to quickly add new features, everything new that appears in 2GIS appears in the kernel and automatically gets into the new 2GIS for WP (as in all products that use this kernel).  The cross-platform kernel is developed in C ++ by very smart guys from the special team for the development of the cross-platform kernel.  They are great, but I will not write anything more about them, because the article is not about them, but about Windows Phone. <br><br><h3>  Ui </h3><br>  The lowest block in the diagram is the UI, the front end, the part that the user is working with.  It is developed using native platform tools (C # and XAML) to provide the user with the usual experience of interacting with his favorite platform as easily and efficiently as possible.  At the time of this writing, several types of applications were available to developers under WP: Silverlight Application, Windows Phone (not Silverlight!) Application, Universal Application.  But when we first started working on the new 2GIS, there was only Silverlight, so it‚Äôs not surprising that we chose it. <br><br><h3>  Intermediate layer </h3><br>  In order to make friends C ++ and C #, to teach the kernel to communicate with the application, and the application with the kernel, you need some intermediate layer in the form of the Windows Runtime Component, written in C ++ / CX. <br><br><h1>  OpenGL 3D Map </h1><br>  Continuing the conversation about offline, we can not say about our map, which also works without an internet connection.  The 2GIS map is a fairly recognizable element.  It is three-dimensional, cross-platform (also compiled for different operating systems) and written in OpenGL. <br><br>  Unfortunately, OpenGL is not supported on WP, so we have to use <a href="https://github.com/MSOpenTech/angle">Angle</a> to translate OpenGL calls to DirectX.  I want to note that with the integration of the card we have suffered a lot of different things, but in the end we managed to launch it on WP.  Of course, the use of Angle leaves its mark on performance, but we try to minimize this effect. <br><br><h1>  Instruments </h1><br>  As in any other application written in C # / XAML, the entire internal structure of the 2GIS frontend for WP obeys the MVVM pattern. <br><br>  Any programmer using MVVM, sooner or later there is a need <s>to write your own</s> start to use some MVVM framework.  I present to you a very brief instruction on the choice of MVVM framework, not claiming to be the ultimate truth. <br><br><ol><li>  Open your favorite browser.  For example, Internet Exporer. </li><li>  Go to the site <a href="http://caliburnmicro.com/">caliburnmicro.com</a> . </li><li>  Download Caliburn.Micro, install and enjoy. </li></ol><br>  But seriously, in 2013, the popular MVVM frameworks running on WP8 were not very numerous.  In fact, the choice was between Prism, MVVM Light and Caliburn. Micro.  Prism is too monstrous, more suitable for large enterprise applications, MVVM Light, on the contrary, is too light, and I wanted something more.  But Caliburn.Micro liked us for the following reasons. <br><br><h5>  Navigation support </h5><br>  Usually navigation between pages in a silverlight application looks like this: <br><br><pre><code class="cs hljs">NavigationService.Navigate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"/GroupPage.xaml?name=Administrators"</span></span>, UriKind.Relative));</code> </pre> <br>  This is not very beautiful, it is easy to make a mistake when entering lines, because  no typing.  The name parameter itself must be retrieved inside the page's onNavigated event in this form. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = NavigationContext.QueryString[<span class="hljs-string"><span class="hljs-string">"name"</span></span>];</code> </pre><br>  Caliburn.Micro allows you to solve the same problem as follows. <br><br><pre> <code class="cs hljs">NavigationService.UriFor&lt;GroupPageViewModel&gt;() .WithParam(x =&gt; x.Name, <span class="hljs-string"><span class="hljs-string">"Administrators"</span></span>) .Navigate();</code> </pre><br>  The code looks beautiful, there is type control, and the Name parameter is immediately written to the corresponding ViewModel property when navigating. <br><br><h5>  State preservation support </h5><br>  Caliburm.Micro offers an interesting infrastructure for maintaining the state of the application.  For example, in order to determine the persistence strategy for GroupPageViewModel, it is sufficient to define such a class. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GroupPageViewModelStorage</span></span> : <span class="hljs-title"><span class="hljs-title">StorageHandler</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GroupPageViewModel</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Property(x =&gt; x.Name) .InPhoneState() .RestoreAfterActivation(); } }</code> </pre><br>  The code above means that if the system suddenly unloads your application while it is inactive, then the Name property of GroupPageViewModel will survive this trouble and will be saved and then restored when the application is reactivated. <br><br><h5>  Native support for IoC container </h5><br>  The heart of Caliburn.Micro is an <a href="http://caliburnmicro.com/documentation/simple-container">embedded IoC container</a> with which the dependency injection pattern is implemented.  When navigating between the ViewModel's pages, they get all the necessary services using constructor / property injection, and this is extremely convenient.  I strongly recommend. <br><br><h5>  For WP - Pivot support </h5><br>  Caliburn.Micro provides the infrastructure in which each Pivot control page can be a separate View with its own ViewModel.  This is very convenient, allows you to decompose logic and relatively easy to adjust the lazy loading of data for the Pivot tabs. <br><br><h5>  Special methods in viewmodels associated with the page life cycle </h5><br>  Screen class - the base class for most of your ViewModels has very convenient methods OnInitialize, OnActivate, OnDeactivate, etc., which are called by the framework when creating an instance of ViewModel and navigating to the corresponding page or leaving it.  You can override these methods in your ViewModels and execute some useful code there. <br><br><h5>  Open source </h5><br>  Caliburn.Micro has open source code.  If you lack something in the framework, you can always add it yourself. <br><br><h5>  Low threshold of entry </h5><br>  Getting started using Caliburn.Micro is easy.  In addition, it is quite lightweight, all Caliburn.Micro code is quite possible to study in a day or two. <br><br><h3>  Saving Application State </h3><br>  It is worth saying that we have slightly refined the mechanism for maintaining the state of the application used in Caliburn.Micro.  By default, Caliburn uses the standard XML serialization mechanisms used in WP.  We added support for binary serialization using the <a href="http://www.sharpserializer.com/">SharpSerializer</a> .  It turned out conveniently, quickly, and you can serialize almost anything. <br><br><h1>  Fast data delivery </h1><br>  So, the cross-platform core provides us with the rapid emergence of new features and work offline, but what about the fast delivery of data?  How can new city data appear in the application if the application does not know anything about this data? <br><br>  The answer is that along with the new data we have to supply a new UI to display it.  In our case, these are XAML templates.  Usually, XAML templates live within the application itself and come with it, but we want to distribute XAML resources separately and completely independently of the application itself. <br><br>  I'm not sure that anyone else is doing it, but, by and large, there is nothing fantastic here.  For some time we experimented with various options and settled on a very simple, in my opinion, scheme, which I will try to tell you now very simply. <br><br>  Suppose that apart from the application we are distributing the data we want to display. <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"data"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows Phone"</span></span> }</code> </pre><br>  Nothing special here - it's just json. <br><br>  We also distribute (also separately from the application) the XAML template needed to display this data. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:d</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:mc</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIcon"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Path</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"42"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"41"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Stretch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Fill"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Fill</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{StaticResource PhoneForegroundBrush}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"F1 M 17,23L 34,20.7738L 34,37L 17,37L 17,23 ZM 34,55.2262L 17,53L 17,39L 34,39L 34,55.2262 ZM 59,17.5L 59,37L 36,37L 36,20.5119L 59,17.5 ZM 59,58.5L 36,55.4881L 36,39L 59,39L 59,58.5 Z "</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EntryPoint"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ContentPresenter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentTemplate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{StaticResource TestIcon}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0,0,0,12"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding [data]}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here it is worth noting a few points. <br><br><ul><li>  We will load this template on the side of the application as a string and parse using XamlReader.Load ().  It naturally follows from this that not every XAML can be used like this.  A valid XAML should not contain any code behind, no references to x: Class, event subscriptions, etc. </li><li>  DataTemplates are great for the previous requirement, so we will use them. </li><li>  We use ResourceDictionary as a container for several templates. </li><li>  Notice how we distribute the TestIcon icon, also in the form of a DataTemplate.  And display it using ContentPresenter. </li><li>  The Text property of a text box is bound to some data property by binding to an indexer of some ViewModel'i (about which after).  Please note that in our json there is an element with the exact same name, and this is no accident. </li></ul><br>  Suppose, already in the application itself, we have this View. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phone:PhoneApplicationPage</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DynamicXaml.MainPage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:phone</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:d</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:mc</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:local</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clr-namespace:DynamicXaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mc:Ignorable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"d"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phone:PhoneApplicationPage.DataContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:MainPageViewModel</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phone:PhoneApplicationPage.DataContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ContentControl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding DynamicData}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContentTemplate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{StaticResource EntryPoint}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phone:PhoneApplicationPage</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In this View, the ContentControl element is the entry point for displaying dynamic data.  There is an important agreement here: ContentControl knows what it needs to display a template with the EntryPoint key, and it is this template in our XAML that we distribute separately.  Actually, the key name is the only thing that the application knows about the template that will be shown. <br><br>  Accordingly, ViewModel is defined for View, which implements some test magic on loading dynamic content. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainPageViewModel</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPageViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     2   . string json = LoadDynamicData(); DynamicData = (JObject)JsonConvert.DeserializeObject(json); //     . string xaml = LoadDynamicXaml(); //  xaml. var resources = (ResourceDictionary)XamlReader.Load(xaml); //     . foreach (DictionaryEntry entry in resources) { Application.Current.Resources.Add(entry.Key, entry.Value); } } public JObject DynamicData { get; private set; } }</span></span></code> </pre><br>  Let me explain a few points. <br><br><ul><li>  In the example, I used <a href="">Json.Net</a> to <a href="">parse</a> json and get some object from it suitable for data binding.  In fact, we use the <a href="http://www.xavierdecoster.com/post/2010/10/08/silverlight-4-data-binding-to-dynamic-datacontext">DynamicDataContext</a> for this purpose, but in this example JObject is used for simplicity. </li><li>  JObject has an indexer that takes a string ‚Äî the name of the json element, and returns the value of this element. </li><li>  That is why in the template text of the text block is attached to the [data] indexer, which returns the value of the data element from json.  So the usual json becomes the viewfinder for our template. </li></ul><br>  If you collect this example and run it on your favorite phone running Windows Phone, you can see such a picture. <br><br><img src="https://habrastorage.org/files/20e/8c8/668/20e8c8668922498e9fd4b2fd6b722d90.png" alt="result"><br><br>  It‚Äôs so easy and natural that we just displayed data in the application that the application knows nothing about.  And the application also does not know how to display this data - all information is downloaded from 2GIS servers. <br><br><h1>  Results </h1><br>  We made a real 2GIS for WP: we have a three-dimensional map, a detailed directory of organizations, a cross-platform core, and we distribute xaml-templates independently of the application.  And it all works without an internet connection.  If for some reason you have not yet installed the new 2GIS on your Windows Phone smartphones, it <a href="https://www.windowsphone.com/ru-ru/store/app/2%25D0%2593%25D0%2598%25D0%25A1/4c2d3b4e-c1f1-439b-bf16-f8b0d829fe87">'s time to do it</a> . </div><p>Source: <a href="https://habr.com/ru/post/259335/">https://habr.com/ru/post/259335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259325/index.html">Do not rely on employees to protect yourself from data leakage.</a></li>
<li><a href="../259327/index.html">A new bug from Apple, a game from Zynga and a report from App Annie in the news of the week for a mobile developer</a></li>
<li><a href="../259329/index.html">App Store style customizable download button</a></li>
<li><a href="../259331/index.html">Secure computer inside Micro SD card</a></li>
<li><a href="../259333/index.html">Simplicity design: How to make effective plain-text letters</a></li>
<li><a href="../259337/index.html">XMPP sucks</a></li>
<li><a href="../259339/index.html">Integration of OTRS v4 with Active Directory. Configure Single Sign On Authentication</a></li>
<li><a href="../259341/index.html">Microsoft will force users to update Windows 10</a></li>
<li><a href="../259343/index.html">DDA for cat</a></li>
<li><a href="../259345/index.html">Kerio Operator 2.4 saves costs and increases employee productivity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>