<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Visual Studio Application Insights - Test Engineer's Experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thank you very much for preparing the article, Igor Shcheglovitov, Senior Test Engineer at Kaspersky Lab, for help in writing this article and valuabl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Visual Studio Application Insights - Test Engineer's Experience</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <em>Thank you very much for preparing the article, Igor Shcheglovitov, Senior Test Engineer at Kaspersky Lab, for help in writing this article and valuable practical experience.</em>  <em>Our remaining Azure articles can be found on the <a href="http://habrahabr.ru/search/%3Fq%3D%255Bazureweek%255D%26target_type%3Dposts">azureweek</a> tag, as well as on the <a href="http://habrahabr.ru/search/%3Fq%3D%255Bmstesting%255D%26target_type%3Dposts">mstesting</a> tag - testing articles.</em> </blockquote><br>  Application Insights (hereinafter simply AI) is a mechanism for collecting and analyzing user telemetry: various performance counters, user events (logs), and so on.  Currently, it supports not only ASP.NET applications, but also others, including Java, IOS, JavaScript, and others. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d86/7aa/7eb/d867aa7eb01dbb7eec7359723ef9e724.png"><br><a name="habracut"></a><br>  When connecting and setting up an AI package, it starts by default to collect some metrics, for example, for web applications, this is information on requests to the web server, as well as various server counters (for example, request time, CPU load).  In addition, AI has an advanced API that allows you to save custom and business counters and logs. <br>  Our team is developing Azure cloud services.  Logs are stored in Azure Storage, and performance counters (server and performance) are read and analyzed automatically by a separate monitoring server.  For logging we use <b>Serilog</b> .  Unlike other loggers, it (out of the box) allows you to write structural logs, highlighting individual properties. <br>  Currently, for many popular loggers, such as Serilog, log4net, Nlog, there are add-ons that allow you to redirect logs to AI.  If you use these loggers and also have an active Azure subscription, you can try AI features in free mode. <br><br>  Below is an example of setting Serilog to save logs in AI: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Via NuGet, we connect the Serilog.Sinks.ApplicationInsights package: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66a/0d9/873/66a0d98735087d553073b603b16f3cc5.png"><br>  (this package will automatically connect the Application Insights API dependent on it) <br><br>  Further, when configuring the Serilog logger, you must specify an ApplicationInsights extension, for example, like this: <br><br><pre><code class="hljs vbscript"><span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>.Logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggerConfiguration().WriteTo.ApplicationInsights(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-literal"><span class="hljs-literal">Empty</span></span>).CreateLogger();</code> </pre> <br>  In the Azure portal preview version create a new container Application Insigts <br><br><img src="https://habrastorage.org/getpro/habr/post_images/584/f2c/a00/584f2ca00924e7e82a899c2a58b3941d.png"><br><br>  After creation, on the ‚ÄúBasic‚Äù tab, copy the instrumentation key <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf1/2f7/644/cf12f764435ccd73450c1904697cfeca.png"><br><br>  Now in the code before starting the application should be written: <br><pre> <code class="hljs objectivec">TelemetryConfiguration.Active.InstrumentationKey = <span class="hljs-string"><span class="hljs-string">"{-}"</span></span>;</code> </pre> <br>  <i>If, for example, you use</i> <i>Nlog</i> <i>logging</i> <i>, then to redirect logs to</i> <i>AI, you</i> <i>just need to connect the ‚Äú</i> <i>Application</i> <i>Insights</i> <i>Nlog</i> <i>Target</i> <i>‚Äù</i> <i>package</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/c25/e71/29f/c25e7129fae53379aefc0c2a3e18ed0f.png"><br><br>  After that, the section automatically appears in the application config: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nlog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">assembly</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.ApplicationInsights.NLogTarget"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targets</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ApplicationInsightsTarget"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aiTarget"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targets</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">minlevel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Trace"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">writeTo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aiTarget"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nlog</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>The main problem with using</i> <i>NLog</i> <i>is that it allows you to write only strings, without custom properties.</i>  <i>In addition to using loggers, custom events in</i> <i>AI</i> <i>can be sent via the</i> <i>API</i> <i>, here's an example:</i> <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>var<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> telemetry = new <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>TelemetryClient<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>(<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>);<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>try <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>{ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>var<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>eventTelemetry<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> = new <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>EventTelemetry<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>(‚Äúlog‚Äù); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>eventTelemetry<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>. Properties[‚Äú<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>CustomProperty<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>‚Äù] = ‚Äútest‚Äù; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>telemetry.Track<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>(<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>eventTelemetry<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>);<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>catch (Exception ex)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>{<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>var<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> properties = new Dictionary <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> {{" <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>CustomProperty<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> ", ‚Äútest‚Äù}};<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>telemetry.TrackException<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>(ex, properties);<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span>} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">I</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now, after launching the application, the logs will be redirected to AI. <br><br>  Unlike log forwarders, the explicit use of the AI ‚Äã‚ÄãAPI allows you to write telemetry in different AI containers.  This is convenient when you have a large application consisting of many components: services, web interface and so on.  In this case, when sending telemetry to AI, you can explicitly set the InstrumentationKey property in TelemetryClient instances. <br><br>  For example, for your application you have created three different containers: one for performance analysis, the other for logs, and the third for monitoring user activity.  Regarding the latter, a special TrackPageView method is provided for analyzing user activity of UI applications in the AI ‚Äã‚ÄãAPI.  You can save data, for which pages (tabs) a particular user visited (remember that you can save events in AI directly in the JavaScript code), on the basis of which you can draw any conclusions. <br><br>  Also add that you can configure the export of AI telemetry for further analysis in Azure Blobs.  A convenient search interface will allow you to find the desired user events through the Azure portal.  The screenshot shows how the properties of one of my saved logs are displayed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e8d/1ee/9c1/e8d1ee9c18b735666a22dc361a92149f.png"><br><br>  Moreover, each logged property is indexed separately and you can filter logs by its specific value through the filter menu: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/89a/3cb/320/89a3cb320f29a91849a872c339542dcf.png"><br><br>  This is very convenient, because  allows you to track the emergence of new events, for example, some new exceptions. <br><br>  The log search interface itself is very simple; besides standard filters, you can write various requests to your logs (for more information, see the <a href="http://azure.microsoft.com/ru-ru/documentation/services/application-insights/">documentation</a> ). <br><br>  In addition to logs, if you have a web application (for example, MVC Web API), then by connecting Nuget Application Insights Web package (without any additional settings), the AI ‚Äã‚Äãwill receive information on all web requests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/350/3a4/220/3503a4220edcda5deee103f6898a7a0a.png"><br><br>  In addition, AI will build dependencies related to queries.  For example, a database call was made during an HTTP request.  In the AI ‚Äã‚Äãlogs, you will see this link, as well as information on the related request (URL, return code ...). <br><br>  In addition, various server performance counters (CPU, Memory ...) will be available on the ‚ÄúServers‚Äù tab.  By default, there are not so many of them, but through ApplicationInsights.config you can add those counters that you need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ba/b73/993/7bab739937915ac354ea0f687787f1bc.png"><br><br>  Using the functionality of alert rules, you can create a rule, upon the occurrence of which a corresponding notification will arrive at the specified e-mail (for example, the CPU threshold value is exceeded). <br><br>  In our team, we develop asynchronous services.  We do not use transactions in the truest sense of the word.  To ensure data integrity when running long BPs, when the state of database objects changes more than once when one calls the API method, we use queues and Service Bus (for example: the API method validated data, changed the state of the object, sent a command message to the queue and returned the result to the callee; the queue handler picked up the message, performed some action and put a new message in the queue, and so on). <br><br>  The number of logs that are created with one such BP can reach dozens of records.  For their bundles, we use a special custom <i>conversation</i> header.  It is forwarded in all commands and messages during the execution of the whole process.  This header can be specified by the caller.  It is logged as a custom property.  Thus, specifying the value of conversationId in the search window, you can get the whole chain of PS logs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e5d/e6f/db9/e5de6fdb9c51852568fe10b6c86f1cfe.png"><br><br>  In addition to operation, this approach is very useful in integration testing. <br>  I am developing integration tests for our cloud services.  Automated test scripts live in MTM, run through a special build.  Tests in most cases, client-server.  According to a message with an error in the information of the fallen test, the cause of the fall is far from always clear.  Often, server logs are needed for diagnostics.  Separately, looking for and watching the logs for each test is not convenient and takes a lot of time.  This is where such functionality as MSTest custom diagnostic adapters came to my rescue. <br><br>  In short, the diagnostic adapter in this context is an assembly containing a special class that inherits from Microsoft.VisualStudio.TestTools.Execution.DataCollector.  If the test agent is configured to use this diagnostic adapter, then during the execution of the test, the corresponding event is triggered, the logic of which is defined in the OnTestCaseStart, OnTestCaseEnd methods.  In these methods, you have access to the context of the test, including its name, state, and so on.  Here is an example implementation of a diagnostic adapter: <br><pre> <code class="hljs pgsql">[DataCollectorConfigurationEditor("configurationeditor://CompanyName/LogConfigEditor/4.0")] [DataCollectorTypeUri("datacollector://CompanyName/LogCollector/4.0")] [DataCollectorFriendlyName("log collector.")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> LogCollecter : DataCollector { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize( XmlElement configurationElement, DataCollectionEvents events, DataCollectionSink sink, DataCollectionLogger logger, DataCollectionEnvironmentContext environmentContext) { _stopwatch = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Stopwatch(); _dataEvents = events; // The test events _dataLogger = logger; // The error <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> _dataSink = sink; <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>.Init(configurationElement); events.TestCaseStart += OnTestCaseStart; events.TestCaseEnd += OnTestCaseEnd; } private <span class="hljs-type"><span class="hljs-type">void</span></span> OnTestCaseStart(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, TestCaseEventArgs e) { _stopwatch.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); } private <span class="hljs-type"><span class="hljs-type">void</span></span> OnTestCaseEnd(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, TestCaseEndEventArgs e) { Guard.CheckNotNull(e, "TestCaseFailedEventArgs is null"); var testCaseEndDate = DateTime.Now; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stopwatch.IsRunning) { _stopwatch.Stop(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.TestOutcome == TestOutcome.Failed) { //         . _dataSink.SendFileAsync(e.Context, <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>.ZipFilePath, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } private Stopwatch _stopwatch; private DataCollectionEvents _dataEvents; private DataCollectionLogger _dataLogger; private DataCollectionSink _dataSink; }</code> </pre><br>  After implementing the diagnostic adapter, build it with the need to attach it to all servers with installed test agents (including the machine on which the Lab Management settings are configured) in the% Microsoft Visual Studio 12.0 \ Common7 \ IDE \ PrivateAssemblies \ DataCollectors folder. <br><br>  Next, run MTM, and tick the adapter. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a56/87d/250/a5687d25091ee4f43b85bd7665e991c7.png"><br><br>  For more information about diagnostic adapters, their configuration forms and settings, read here <a href="https://msdn.microsoft.com/en-us/library/dd286727.aspx">msdn.microsoft.com/en-us/library/dd286727.aspx</a> . <br><br>  In each test class, in the TestInitialize method, the initialization code for the conversationId was added, which was subsequently put in headers when creating wcf and http clients.  This onversationId was played with a diagnostic adapter.  And when an error occurred in the test results, information appeared about the conversationId.  And knowing the conversationId through AI you can very easily see all the server events associated with a specific test. <br><br>  Application Insights is a very powerful tool that simply allows you to connect to your application a collection of various diagnostic telemetry, as well as to simplify its further visual analysis using the user-friendly portal interface.  If you have an Azure subscription, then you can use AI in two modes: Free and Premium.  The main limitation of the Free mode is the maximum number of user events - 5 million per month, and the added data is stored for 7 days, after which it is deleted.  In the Premium version, these restrictions have been removed.  Free to use for 30 days. <br><br><h4>  Various useful resources </h4><br><ul><li>  <a href="http://l.techdays.ru/go/azuretrial">Try Azure</a> for free for 30 days! </li><li>  <a href="http://l.techdays.ru/go/mva">Explore</a> Microsoft Virtual Academy <a href="http://l.techdays.ru/go/mva">courses</a> on cloud and other technologies </li><li>  <a href="http://l.techdays.ru/go/getvs">Download</a> free or trial Visual Studio </li><li>  <a href="http://www.azurehub.ru/">Microsoft Azure Development Center (azurehub.ru)</a> - scripts, tutorials, examples, design recommendations </li><li>  <a href="http://www.twitter.com/windowsazure_ru">Twitter.com/windowsazure_ru</a> - the latest Microsoft Azure news </li><li>  <a href="http://www.facebook.com/groups/azurerus/">Microsoft Azure Community on Facebook</a> - experts, questions </li><li>  <a href="http://l.techdays.ru/go/winstart">Become a</a> universal Windows application <a href="http://l.techdays.ru/go/winstart">developer</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/263999/">https://habr.com/ru/post/263999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263985/index.html">Answers to the quest about the space admin with comments</a></li>
<li><a href="../263991/index.html">Probabilistic programming</a></li>
<li><a href="../263993/index.html">Continuously distributed random variables generators</a></li>
<li><a href="../263995/index.html">Google Analytics with Unity3D</a></li>
<li><a href="../263997/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ170 (July 26 - August 2, 2015)</a></li>
<li><a href="../264001/index.html">We clean the Internet from annoying ads (AD Blocker for MikroTik)</a></li>
<li><a href="../264003/index.html">Lambda expressions in Java, how and why to serialize them?</a></li>
<li><a href="../264005/index.html">PHP to Clojure</a></li>
<li><a href="../264007/index.html">Magic of tensor algebra: Part 16 - Properties of the solid body inertia tensor</a></li>
<li><a href="../264009/index.html">Message Formatting for Yii :: t ()</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>