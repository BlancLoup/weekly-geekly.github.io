<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Log4j 1.x performance in synchronous and asynchronous mode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, habrazhiteli! 

 At the moment I am engaged in improving the performance of a large corporate solution. Its specificity allows multiple user...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Log4j 1.x performance in synchronous and asynchronous mode</h1><div class="post__text post__text-html js-mediator-article">  Good day, habrazhiteli! <br><br>  At the moment I am engaged in improving the performance of a large corporate solution.  Its specificity allows multiple users to perform similar actions, and therefore behind the scenes, the application server works with the same code.  And at one of the moments of the long way to accelerate the application, it was noticed that in the top of the most low-performance sections, the top places are taken by log4j.  The first thought was - excessive logging, but subsequent analysis refuted it.  Moreover, this is extremely important data for support engineers, and if you remove it now, then either the code will be returned or the analysis of the production problems of the server will be significantly complicated. <br><br>  This prompted me to this study - is there a way to optimize the logging process? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Disclaimer</b> : <i>because of the abundance of diagrams in this article that cause psychedelic associations (like this: this is not a comparison of synchronous and asynchronous logging modes, the dragon kills a snake here!) Is not recommended for minors, people with unstable mentality and pregnant prodakshene and issuing the nearest patch is not this year.</i> <br><br>  Carefully, under the cut traffic. <br><a name="habracut"></a><br><h4>  What is the reason? </h4><br>  As usual, the reason is trivial - ‚Äúcompetitive access‚Äù.  After several experiments with a floating number of parallel threads, it became clear that the call logging time was not linear, so the output is that the railway loses a lot. <br><br>  Here are the results of measurements: <br><img src="https://habrastorage.org/getpro/habr/post_images/7e2/7dc/9e2/7e27dc9e2942599c55b1b6367bab43ea.png"><br><br><h4>  What is the solution? </h4><br>  Search for other logging methods, upgrade libraries, you can do all this, but the task is to achieve maximum results with minimum effort.  I can also tell about the ‚Äúlog4j 2‚Äù library, but this will be a separate article.  Now we will consider the tools provided to us "out of the box" in log4j 1.x. <br><br>  Among the appenders supplied with the library is AsyncAppender, which allows using the intermediate buffer to accumulate logging events to organize asynchronous work with the file system (if the final appender is a file, because it was originally intended for the SMTP logger).  When generated, logging events accumulate, and only when a certain buffer level is reached, they get into the file. <br><br><h4>  Measurements </h4><br>  Now, when the approach is defined, it would be necessary to understand how effective it is, for this we will conduct the appropriate measurements. <br><br>  <u>We will measure this way:</u> <br>  0) I warn you in advance, ‚ÄúI didn‚Äôt do beautiful data,‚Äù in places it is clear that the processor switched to another job, and I left these places as it was.  This is also part of the real work of the system. <br>  1) We divide the tests into 3 groups: <br>  - 10 logging events (from 1 to 10 with a step of 1) <br>  - 550 logging events (from 10 to 100 with a step of 10) <br>  - 5500 logging events (from 100 to 1000 in increments of 100) <br>  2) In each group there will be 3 subgroups of tests - depending on the buffer size (we will try to find the optimal one): <br>  - 500 events <br>  - 1500 events <br>  - 5000 events <br>  3) Tests will be performed synchronously and asynchronously. <br><div class="spoiler">  <b class="spoiler_title">Synchronous Logger Configuration</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE log4j:configuration SYSTEM "log4j.dtd" &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4j:configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fileAppender"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.log4j.FileAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"st.log"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.log4j.PatternLayout"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ConversionPattern"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"%d{ABSOLUTE} %5p %t %c{1}:%M:%L - %m%n"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">priority</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"info"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fileAppender"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4j:configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Asynchronous Logger Configuration</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE log4j:configuration SYSTEM "log4j.dtd" &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4j:configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fileAppender"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.log4j.FileAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"st.log"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.log4j.PatternLayout"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ConversionPattern"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"%d{ABSOLUTE} %5p %t %c{1}:%M:%L - %m%n"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ASYNC"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.log4j.AsyncAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BufferSize"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fileAppender"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">priority</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"info"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ASYNC"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4j:configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  4) The tests themselves are simple logging calls interspersed with ‚Äúrandom work‚Äù (duration from 1 to 15 ms, in order to be able to alternate access to the file). <br><div class="spoiler">  <b class="spoiler_title">Test Source Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.ice.logger_test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.lang3.time.StopWatch; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.log4j.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger logger = Logger.getLogger(SimpleTest.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> NANOS_TO_SEC = <span class="hljs-number"><span class="hljs-number">1000000000.0</span></span>d; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String LOG_MESSAGE = <span class="hljs-string"><span class="hljs-string">"One hundred bytes log message for performing some tests using sync/async appenders of log4j library"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//performTest("Single thread"); ThreadRunner t1 = new ThreadRunner(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); new Thread(t1).start(); } private static void performTest(String message) throws InterruptedException { logger.info("Warm-up..."); logger.info("Warm-up..."); logger.info("Warm-up..."); StopWatch timer = new StopWatch(); Random ran = new Random(); for(int i = 1; i &lt;= 10000; i += getIncrementator(i)) { timer.reset(); timer.start(); int iterations = 0; for(int j = 1; j &lt;= i; j++) { timer.suspend(); Thread.sleep(ran.nextInt(15)+1); // some work timer.resume(); logger.info(LOG_MESSAGE); timer.suspend(); Thread.sleep(ran.nextInt(15)+1); // some work timer.resume(); iterations = j; } timer.stop(); System.out.printf(message + " %d iteration(s) %f sec\n", iterations, (timer.getNanoTime() / NANOS_TO_SEC)); } } private static int getIncrementator(int i) { if(i &gt;= 0 &amp;&amp; i &lt; 10) return 1; if(i &gt;= 10 &amp;&amp; i &lt; 100) return 10; if(i &gt;= 100 &amp;&amp; i &lt; 1000) return 100; if(i &gt;= 1000 &amp;&amp; i &lt; 10000) return 1000; if(i &gt;= 10000 &amp;&amp; i &lt;= 100000) return 10000; return 0; } static class ThreadRunner implements Runnable { @Override public void run() { try { performTest(Thread.currentThread().getName()); } catch (InterruptedException e) { e.printStackTrace(); } } } }</span></span></code> </pre><br></div></div><br>  Both results (plus intermediate, so as not to lose the thread), synchronous and asynchronous will be visualized diagrams, for clarity. <br>  <b>So, let's begin.</b> <br><br><h5>  Synchronous start, 2 threads </h5>  First, let's see how the logger behaves in a synchronous configuration.  Run all scripts on 2 threads. <br>  Here are the results: <br><img src="https://habrastorage.org/getpro/habr/post_images/a84/a1b/c4b/a84a1bc4b8af22bf28eb24dfb545f313.png"><br><br><h5>  Asynchronous start, 2 threads </h5><h6>  Buffer = 500 </h6>  Now we will switch to asynchronous mode and at the same time we will try to find the optimal buffer, let's start with 500 <br><img src="https://habrastorage.org/getpro/habr/post_images/f3a/f78/4d5/f3af784d53b191962892d878e9d20659.png"><br><br><h6>  Buffer = 1500 </h6>  Increase the buffer 3 times and perform the same tests: <br><img src="https://habrastorage.org/getpro/habr/post_images/f4d/c33/687/f4dc33687c425b2746c063fd0b27c11f.png"><br><br><h6>  Buffer = 5000 </h6>  Increase the buffer 10 times and perform the same tests: <br><img src="https://habrastorage.org/getpro/habr/post_images/c36/db6/ba6/c36db6ba63b02c7115e79e6b76ab7866.png"><br><br><h6>  Total for 2 threads </h6>  Now, for clarity, I will collect all the asynchronous (to try to determine the optimal buffer) and synchronous (for clarity, it is interesting, who won) tests in one diagram: <br><img src="https://habrastorage.org/getpro/habr/post_images/30f/a73/916/30fa73916f54cf79fa6bef9fb1e53e32.png"><br>  Now I think I can clearly see the acceleration in asynchronous mode. <br>  But before drawing conclusions, let's repeat our tests on the 5th and 10th streams. <br><br><h5>  Synchronous start, 5 threads </h5><img src="https://habrastorage.org/getpro/habr/post_images/17b/705/3f7/17b7053f7407fc15bccd42b5fef78ae5.png"><br><br><h5>  Asynchronous start, 5 threads </h5><h6>  Buffer = 500 </h6><img src="https://habrastorage.org/getpro/habr/post_images/ba8/336/32f/ba833632fb3c25214409fd04f74bb344.png"><br><br><h6>  Buffer = 1500 </h6><img src="https://habrastorage.org/getpro/habr/post_images/cf0/277/961/cf02779615cdd16d68603198278a933d.png"><br><br><h6>  Buffer = 5000 </h6><img src="https://habrastorage.org/getpro/habr/post_images/1d9/1ed/607/1d91ed607f4306134f1ae26ecf5ad496.png"><br><br><h6>  Total for 5 threads </h6><img src="https://habrastorage.org/getpro/habr/post_images/566/139/981/56613998175b943cf714de36e3e0c523.png"><br><br><h5>  Synchronous start, 10 threads </h5><img src="https://habrastorage.org/getpro/habr/post_images/a7b/757/4f2/a7b7574f26d0ddf7e3aae50c2ad27642.png"><br><h5>  Asynchronous start, 10 threads </h5><h6>  Buffer = 500 </h6><img src="https://habrastorage.org/getpro/habr/post_images/0d9/195/fb6/0d9195fb673463426c985c8bc171140b.png"><br><br><h6>  Buffer = 1500 </h6><img src="https://habrastorage.org/getpro/habr/post_images/e8a/074/b9e/e8a074b9e0381551057c5c751fcfe1b1.png"><br><br><h6>  Buffer = 5000 </h6><img src="https://habrastorage.org/getpro/habr/post_images/13d/153/f53/13d153f537ece578400fb91b20e058c3.png"><br><br><h6>  Total for 10 threads </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/05f/2ae/8ad/05f2ae8ad8a5ec1d0144df9a28f5a6d2.png" width="500"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/982/bd3/079/982bd30792476527a4d9b7461cfc5950.png" width="500"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a20/0e2/ff1/a200e2ff15d15cfcd17c1eda7c5a8754.png" width="500"><br><br>  The conclusion, as they say, on the face. <br>  Since now we can definitely talk about the advantages of the asynchronous logging method, then let's try to increase the volume of tests by another 10 times.  Add a test for 55000 logging events (from 1000 to 10,000 in increments of 1000).  We take the buffer equal to 500 (since it is at first glance, and later it will be proved, is the most optimal in our tests). <br><br><h5>  Synchronous start, 10 flows on large volumes of data </h5><img src="https://habrastorage.org/getpro/habr/post_images/f64/5a7/b8e/f645a7b8e08124b6de04835714f12e6b.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/ba0/b14/a93/ba0b14a937d471fa2b60f21eec61b440.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/53e/a90/24a/53ea9024ab2d8f63838d417b0159eb0c.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/b0a/cf2/0f4/b0acf20f4af37577308594a8d025e831.png"><br><br><h5>  Asynchronous start, 10 flows on large volumes of data </h5><img src="https://habrastorage.org/getpro/habr/post_images/a92/99d/8e2/a9299d8e220d27b221661dba11cf8976.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/dce/1bc/a5b/dce1bca5bec0d436954b13fbc4a88388.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/023/dc9/2ca/023dc92ca0d1636e2f2d96ed338f8c70.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/8ae/c5a/614/8aec5a614353fcb1f059eb2e71475cb7.png"><br><br><h5>  Total for 10 streams on large amounts of data </h5><img src="https://habrastorage.org/getpro/habr/post_images/e7e/ce9/399/e7ece9399cb843abb104f562fd23af0c.png" width="500"><br><img src="https://habrastorage.org/getpro/habr/post_images/394/65a/b95/39465ab950ba8b7a8a098276ba2c7757.png" width="500"><br><img src="https://habrastorage.org/getpro/habr/post_images/85a/20f/c64/85a20fc64666dc8c7b725d0d665b6050.png" width="500"><br><img src="https://habrastorage.org/getpro/habr/post_images/af6/4a8/013/af64a8013d6f01ccfb828ade6025bd58.png" width="500"><br><br><h5>  Optimal buffer </h5>  At the moment, we have already accumulated quite a lot of statistical data, so let's average them all and see which buffer is the most suitable. <br><table><tbody><tr><td colspan="2">  <b>2 Flows</b> </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/560/613/247/56061324718d2e8344b02c79f9910274.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/5f8/7d7/3f2/5f87d73f2bc893902ddd2e827421ccf1.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/c28/073/e80/c28073e80061a233689fb7d28380c489.png"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/8af/c49/440/8afc49440da15a9f476bc7cf6d129547.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/06b/a47/069/06ba470698acfc2288b4437b238d5ccc.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/a80/2db/3e7/a802db3e7ddf8c6f587db594bebe95c7.png"><br></td></tr><tr><td colspan="2">  <b>5 Streams</b> </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/7db/57c/0c4/7db57c0c497c33535fe1ccda91bd7c7f.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/492/495/a87/492495a876dd0d5645a573d081958ad7.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/606/139/371/606139371017b7602c53f392647b08ee.png"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/3c5/a4a/f6b/3c5a4af6b9755b939a46edc62f6a50a5.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/2eb/080/7f6/2eb0807f6dd0a64490fa77860846e3e6.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/d49/1c1/3a0/d491c13a093c9ec8c14fcf401eee0378.png"><br></td></tr><tr><td colspan="2">  <b>10 Streams</b> </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/32a/af2/f1c/32aaf2f1c0e3f350497ecfa889ffecad.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/7d8/f6e/4dd/7d8f6e4dd4665e45ea7b66f7c44351c5.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/6a4/c4b/e2e/6a4c4be2e074f7721f7c182338ccf57a.png"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/869/889/398/86988939876973f35395ed84603f56bb.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/d81/3c9/bd8/d813c9bd8d8dcf87d6fcfdc762f14c6d.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/a42/c78/0a8/a42c780a8d5cd135a554695ee4164a5e.png"><br></td></tr><tr><td colspan="2">  <b>10 Streams, large amount of tests</b> </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/c10/fc8/e6c/c10fc8e6c306451cc144d4c52c9a554d.png"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/56f/e5b/d2b/56fe5bd2b04b98fcc0359ea48e55f95e.png"><br></td></tr></tbody></table><br>  <b>Total - 500 events</b> , it is our buffer that allows you to work most effectively in asynchronous mode. <br>  And now, if we compare the total (or average) running time of all the tests at all, then we can get a constant that reflects the order in which the asynchronous mode wins before the synchronous one, for me it is <b>8.9 (times)</b> . <br><br><h4>  Conclusion </h4><br>  The above material makes it clear that the strategy of asynchronous logging gives a performance benefit.  Then the question arises - why not always use it?  In order to make a choice in favor of a particular method, it is necessary to present the mechanisms that are hidden inside.  Below are some abstracts taken from offsite: <br>  1) AsyncAppender operates with its own thread (while FileAppender itself runs in the context of the current thread), therefore when using it, it is desirable to increase the limit of application server threads. <br>  2) When using AsyncAppender, memory overheads occur, since logging events are not immediately flushed to the file, but after filling the buffer. <br>  3) Locking a log file takes longer than using the synchronous approach, since the message buffer contains much more information to write. <br>  In principle, everything is prosaic, but here you need to understand that synchronization itself is also a lock, so it is important that transferring it from one place to another does not make it worse. <br><br>  Use asynchrony where you really need it: <br>  - long-playing appenders - SMTP, JDBC <br>  - general resource lock - FTP, Local File Storage <br>  But above all, be sure to profile your code. <br><br>  Excel version of this article: <br>  <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AkyN15vTZD-ddHV0Y3p4QVUxTXVZRldPcU0tNzNucWc%26usp%3Dsharing">docs.google.com/spreadsheet/ccc?key=0AkyN15vTZD-ddHV0Y3p4QVUxTXVZRldPcU0tNzNucWc&amp;usp=sharing</a> <br>  <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AkyN15vTZD-ddFhGakZsVWRjV1AxeGljdDczQjdNbnc%26usp%3Dsharing">docs.google.com/spreadsheet/ccc?key=0AkyN15vTZD-ddFhGakZsVWRjV1AxeGljdDczQjdNbnc&amp;usp=sharing</a> <br><br>  Thanks for attention.  I hope the article will be useful to you. <br>  Have a productive week! </div><p>Source: <a href="https://habr.com/ru/post/215147/">https://habr.com/ru/post/215147/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215131/index.html">Comparison of popular build systems for frontend developers</a></li>
<li><a href="../215133/index.html">Python-digest # 17. News, interesting projects, articles and interviews [March 2, 2014 - March 9, 2014]</a></li>
<li><a href="../215137/index.html">Project Blocks: do-it-yourself modular smart devices</a></li>
<li><a href="../215139/index.html">Implicit php code call techniques used in malicious scripts</a></li>
<li><a href="../215141/index.html">Is there an API for Kiosk apps on Android?</a></li>
<li><a href="../215149/index.html">Personal experience: the benefits of "independent" RSS-reader</a></li>
<li><a href="../215151/index.html">The logic of thinking. Part 8. Selection of factors in the wave networks</a></li>
<li><a href="../215161/index.html">Design and architecture in the OP. Part 2</a></li>
<li><a href="../215163/index.html">My tool for time tracking and invoicing</a></li>
<li><a href="../215167/index.html">The Linux Foundation and EdX begin a free course on Introduction to Linux.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>