<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing 2 or more channels on FreeBSD using PF + Squid</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of the day, habrozhiteli! 

 Due to the fact that although my previous attempt to share thoughts brought me an invite, however, Karma went i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing 2 or more channels on FreeBSD using PF + Squid</h1><div class="post__text post__text-html js-mediator-article"><h4>  Good time of the day, habrozhiteli! </h4><br><br>  Due to the fact that although my previous attempt to share thoughts brought me an invite, however, Karma went into the minus, <s>so now I will try to rehabilitate</s> myself again trying to please the audience with a recipe for setting up the buzzing thing in the corner. <br><h6>  So, about the task: there are two Internet channels, a gateway on FreeBSD </h6><br><pre><code class="bash hljs">gate<span class="hljs-comment"><span class="hljs-comment"># uname -a FreeBSD gate 9.0-RELEASE FreeBSD 9.0-RELEASE #0: Thu Nov 1 06:48:52 OMST 2012 root@gate:/usr/obj/usr/src/sys/GATE amd64</span></span></code> </pre> <br>  Not that a necessity, but a desire to create a flexible system with balancing traffic by channel and a desire to receive an award from management. <br>  Channel number 1: unlimited, speed 7 MB, real ip-address <br>  Channel number 2: unlimited, speed up to 60Mb, real ip-address. <br>  On the provider’s side, gateways were installed through which I implemented the DMZ on “traps” for hackers, so the PF and SQUID settings are minimal <br><br><a name="habracut"></a><br><h6>  Description of raising the balancing </h6>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All manipulations from the root user.  (Connect to the host by any user, then su, root password). <br><br>  1. Kernel options for enabling PF: <br>  If you do not consider traffic as PF, then the second paragraph can be disabled <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /sys/amd64/conf cp GENERIC GATE ee GATE device pf device pflog options ALTQ options ALTQ_CBQ options ALTQ_RED options ALTQ_RIO options ALTQ_HFSC options ALTQ_PRIQ options ALTQ_NOPCC</code> </pre> <br><br>  2. kernel assembly <br><pre> <code class="bash hljs">make kernel KERNCONF=GATE</code> </pre> <br><br>  3. 2 network cards are installed in the gateway, one integrated into the motherboard: <br><pre> <code class="bash hljs">re0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 options=389b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_UCAST,WOL_MCAST,WOL_MAGIC&gt; inet 192.168.1.2 netmask 0xffffff00 broadcast 192.168.1.255 re1: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 options=389b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_UCAST,WOL_MCAST,WOL_MAGIC&gt; inet 192.168.63.26 netmask 0xfffffff8 broadcast 192.168.63.31 nfe0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 options=82008&lt;VLAN_MTU,WOL_MAGIC,LINKSTATE&gt; inet 10.1.1.30 netmask 0xffffff00 broadcast 10.1.1.255</code> </pre> <br>  re0 provider # 1, re1 - provider # 2.  The internal interface nfe0 (assigning ip addresses and masks has developed historically, I work with what is).  And of course, vlan is raised on the internal interface, scattering video surveillance ip and various departments of the company on them. <br><br>  4. Configure rc.conf <br><pre> <code class="bash hljs">ee /etc/rc.conf pf_enable=«YES» pf_rules=«/etc/pf.conf» squid_enable=«YES» reboot</code> </pre> <br><br>  That is, when loading, the rules from the /etc/pf.conf file are executed. <br><br>  5. Listing pf.conf. <br><br><pre> <code class="bash hljs">cat pf.conf <span class="hljs-comment"><span class="hljs-comment"># ,  int_if -  , ext_if - . int_if=«nfe0» ext_if=«re1» ext_if2=«re0» int_net=«10.1.1.0/24» freeBSD=«10.1.1.30» icmp_types=«{ echoreq, unreach}» http=«80» https=«443» ssh=«22» #     . gw1=«192.168.63.25» gw2=«192.168.1.1» # ,             . #, -       ip-  . to_ertel=«{10.1.1.42, 10.1.1.33, 10.1.1.4, 10.1.1.12, 10.1.1.5, 10.1.1.48, 10.1.1.25, 10.1.1.3, 10.1.1.243, 10.1.1.5 }» to_trans=«{ 10.1.1.27, 10.1.1.2, 10.1.1.181, 10.1.1.46, 10.1.1.39, 10.1.1.27, 10.1.1.31, 10.1.1.113 }» #   -    , set block-policy drop set skip on lo #     . scrub in all #   - nat on $ext_if inet from any to any -&gt; ($ext_if) #   - nat on $ext_if2 inet from any to any -&gt; ($ext_if2) #  SQUID rdr on $int_if inet proto tcp from any to any port www -&gt; 127.0.0.1 port 3128 block in from any to any block out from any to any # antispoof quick for $int_if inet #        pass out on $int_if from any to $int_net #   (  ) pass in quick on $int_if route-to ($ext_if2 $gw2) from $to_trans to !$int_net keep state pass in quick on $int_if route-to ($ext_if $gw1) from $to_ertel to !$int_net keep state #  (quick)     pass in quick on $int_if from $int_net to $int_if pass in quick on $int_if route-to { ($ext_if $gw1), ($ext_if2 $gw2)} round-robin sticky-address proto tcp from $int_net to any flags S/SA keep state # sticky-address    RicoX #   icmp  udp      pass in on $int_if route-to { ($ext_if $gw1), ($ext_if2 $gw2) } round-robin proto { udp, icmp } from $int_net to any keep state #  ""     pass out on $ext_if proto tcp from any to any flags S/SA modulate state pass out on $ext_if proto { udp, icmp } from any to any keep state pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state pass out on $ext_if2 proto { udp, icmp } from any to any keep state #      IP  $ext_if1  $ext_gw1  #    $ext_if2  $ext_gw2 pass out on $ext_if route-to ($ext_if2 $gw2) from $ext_if2 to any pass out on $ext_if2 route-to ($ext_if $gw1) from $ext_if to any</span></span></code> </pre> <br><br>  The bandwidth setting did not, as there was no need.  It turns on quite simply and quickly, I think in the future it will be possible to add a config. <br><br>  The disadvantage of this path is that sometimes, when something happens to one of the providers, load balancing stops working. <br>  To solve this problem, the following configuration files were created: pf.conf.ertelecom and pf.conf.trans, which differ from the main configuration file only in that the line: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#pass in on $int_if route-to { ($ext_if $gw1), ($ext_if2 $gw2) } round-robin proto { udp, icmp } from $int_net to any keep state</span></span></code> </pre><br>  thrown out of them.  Two lines appear instead: <br><br><pre> <code class="bash hljs">pass out route-to (<span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span> <span class="hljs-variable"><span class="hljs-variable">$gw1</span></span>) from <span class="hljs-variable"><span class="hljs-variable">$int_if</span></span> to any pass out route-to (<span class="hljs-variable"><span class="hljs-variable">$ext_if2</span></span> <span class="hljs-variable"><span class="hljs-variable">$gw2</span></span>) from <span class="hljs-variable"><span class="hljs-variable">$int_if</span></span> to any</code> </pre><br><br>  one of which works, depending on which gateway is installed by default. <br><br>  Switching scripts look like this: <br><br><pre> <code class="bash hljs">cat er_conn.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh GW1=«192.168.63.25» if1=«192.168.63.26» #  /sbin/pfctl -d #      №2 /sbin/pfctl -e -f /etc/pf.conf.dom #  - /sbin/route del default #  -   №2 /sbin/route add default $GW1</span></span></code> </pre><br><br>  Similar to this script, the scripts for controlling the inclusion of the provider №1 and load balancing work.  Only the gateway address and the pf configuration rules file change. <br>  In cron, we include a script that every few (optional) minutes checks for a response from the gateway: <br>  ping -S &lt;ip address of the provider's gateway&gt; &lt;our real ip-address&gt;. <br>  If there is no answer, we automatically load the rules of the live channel. <br><br>  As for the SQUID setting, there I did everything in a primitive way.  I assembled squid 3 from ports, without changing anything except the transparent setting, that is, a transparent proxy.  I give its configuration file: <br><br><pre> <code class="bash hljs">cat squid.conf http_port 127.0.0.1:3128 transparent icp_port 0 hierarchy_stoplist cgi-bin ? acl QUERY urlpath_regex cgi-bin \? no_cache deny QUERY cache_mem 256 MB maximum_object_size 8092 KB maximum_object_size_in_memory 512 KB cache_dir ufs /bkp/var/squid/cache 2048 64 256 cache_access_log /bkp/var/squid/access.log cache_log /bkp/var/squid/cache.log cache_store_log /bkp/var/squid/store.log cache_mgr root@xxx.ru cache_effective_user squid cache_effective_group squid visible_hostname gate coredump_dir /bkp/var/squid/cache pid_filename /var/run/squid/squid.pid acl our_networks src 10.1.1.0/24 http_access allow our_networks</code> </pre><br><br>  We have been working with this for about two years, almost nothing crashes, the gateway reboots only at the whims of electricians, users have forgotten what Internet access problems are. <br>  I consider traffic as alcohol (cnupm), followed by uploading its logs to the MySQL database. <br><br>  A small bonus: when I took the farm, all the IPs were set manually for the machines.  In addition, to these IP (and not machine names) there was a binding of some services of the local network.  Therefore, the following script was born for the quick transfer of IP settings to the DHCP format of the server configuration file, namely, the part that assigns IP to the MAC address. <br>  Here is the listing: <br><pre> <code class="bash hljs">gate<span class="hljs-comment"><span class="hljs-comment"># cat do_dhcp #!/bin/sh arp -an | grep &lt;   &gt; &gt; /usr/arp.txt # IFS     IFS=« » cat /usr/arp.txt | while read line do set -- $line; echo -e «host $1 { hardware ethernet $4; fixed-address $2; }\n» done</span></span></code> </pre><br><br>  The output occurs on the terminal screen, but if you add to echo after the last quotation mark&gt; /usr/dhcp.txt, the output will be in the file.  Next came copy-paste output to the appropriate section of the dhcpd.conf file.  It is possible so: <pre> <code class="bash hljs">cat dhcpd.txt &gt;&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dhcpd.conf</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/177767/">https://habr.com/ru/post/177767/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177753/index.html">Are we not heroes? Mission for the company</a></li>
<li><a href="../177755/index.html">Easy way to manage remote devices</a></li>
<li><a href="../177759/index.html">tFormer.js - bike for form validation</a></li>
<li><a href="../177761/index.html">MongoDB: Too many fields to index? Use a common index</a></li>
<li><a href="../177763/index.html">About cloud and not only technologies of Yandex in Kiev this Saturday</a></li>
<li><a href="../177769/index.html">Online editor for Bootstrap — LayoutIt</a></li>
<li><a href="../177775/index.html">Package Manager for Xcode</a></li>
<li><a href="../177779/index.html">Apple reported on the results of the previous quarter</a></li>
<li><a href="../177781/index.html">Where is the market of electronic payment systems in Russia? Part 2. Plastic cards</a></li>
<li><a href="../177785/index.html">Fidonet's arrival on Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>