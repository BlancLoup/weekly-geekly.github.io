<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load testing CMS "1C-Bitrix"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Do you know the joke about the plane, in which there is a bar, and a swimming pool, and a restaurant, but only when taking off, the flight attendant s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load testing CMS "1C-Bitrix"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2da/4ee/e3c/2da4eee3caea435f806ad5b79b58ae0e.jpg" align="left">  Do you know the joke about the plane, in which there is a bar, and a swimming pool, and a restaurant, but only when taking off, the flight attendant says: ‚ÄúAnd now with all this we will try to take off‚Äù? <br><br>  Web development is a bit like an airplane.  The customer wants from the web studio both a cool design, and a lot of interactivity, and all delivery and payment services in online stores, the studio is happy to program all this ... But it‚Äôs not clear whether the server‚Äôs capacity is enough to ensure stable operation of the site. <br>  In order for the load to be predictable, in order to set some reference values, we conducted load testing of ‚Äú1C-Bitrix: Site Management‚Äù and ‚Äú1C-Bitrix: Enterprise‚Äù. <br><br>  We tried to test it so that the client understood what can be obtained on current equipment, and the developer could understand what the prospects for the project are.  Will it be able to scale with increasing load? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article we will talk about how they organized and carried out the testing, and what conclusions they made for themselves. <br><br>  What can it be useful for?  The reference numbers will make it possible to compare the current site with the potential new hosting, to clearly assess what effect the introduction of new functionality has on the system.  And just to understand the technical limits of the system. <br><br>  We focused on the organization of testing, on the specific problems encountered in the testing process and on what conclusions can be drawn from the test results.  For those most interested, here is a <a href="http://www.1c-bitrix.ru/products/cms/performance/index.php%3Futm_source%3Dhabr%26utm_medium%3Dtext%26utm_campaign%3Dcrushtest">link to a detailed technical report</a> . <br><a name="habracut"></a><br><h3>  Formulation of the problem </h3><br>  Many differently understand the meaning, purpose and objectives of load testing. <br><br>  First, you need to formulate for yourself - what do we want? <br><br>  <b>What product and how to test?</b> <br>  First, we wanted to take a real online store, its code and base.  But it would be testing this particular solution; other developers will not be able to use it as a reference point.  So, it is necessary to test the standard ‚Äúbox‚Äù, filling it with a large number of positions corresponding to a large online store (in our experience, this is about 100,000 SKU).  ‚Äú1C-Bitrix‚Äù worked with the ‚ÄúComposite Cache‚Äù technology enabled - a solution that first loads the fast cache of the saved page from nginx, and then loads the dynamic data with an ajax-request.  Thus, the user receives the page as quickly as possible.  To estimate the number of requests per second, we considered exactly dynamic requests. <br><br>  <b>What should be the server architecture?</b> <br>  Be sure to test the single-server configuration: it is the simplest and most popular.  But it is also interesting to understand how the performance will increase if you add a second server?  Will it grow twice?  What happens if you use a cluster of four machines?  Is it possible to successfully scale horizontally by adding new and new servers to the cluster? <br><br>  Thus, it was decided to test configurations from one server, from two and from four. <br><br>  <b>What need to create load scenarios?</b> <br>  According to the analysis of the load on a number of large stores, the online store traffic can be divided into 3 categories: <br><br><ol><li>  60% of users come and browse several pages in the catalog, knowing what specific product they need. </li><li>  37% of users choose the right product from several possible, apply filtering (smart filter). </li><li>  3% of users (the standard indicator of good conversion) put the product in the basket and bought it. </li></ol><br>  <b>How to load servers?</b> <br>  There are two main models of load testing of the project: closed and open.  Closed means an artificial constant static load, in which the requests of "users" go in a static stream (and not in waves, as in real life).  Its goal is to find out the behavior of the project at maximum load, to understand the maximum ‚Äúthroughput‚Äù of the system.  This is the top bar of the metric, it is no longer above it. <br><br>  An open model implies testing that is close to real life: users arrive in waves, sometimes more than the system can withstand.  It helps to figure out the limits of the system, how it will behave in critical conditions. <br><br>  In this test, our goal was to find out the capacity of the system, so we chose a closed model with the maximum load on which the SLA will be sustained. <br><br>  <b>Which SLA to choose for testing?</b> <br>  We needed to clearly define for ourselves that threshold, below which we consider the system to be consistently serving requests.  To do this, we used the statistics of the <a href="http://www.kommersant.ru/doc/2464244">TOP-100 major online stores</a> (according to Kommersant, 2014) and chose two main metrics: the answer to 99% of requests should be given in less than 1 second, and the number of answers with a code other than HTTP 200, should be no more than 0.5%.  Testing should be carried out continuously for 24 hours. <br><br>  <b>Which hosting to choose?</b> <br>  We chose <a href="https://selectel.ru/">Selectel</a> hosting with the Tsvetochnaya-1 data center in St. Petersburg as a platform for testing.  Selectel provided us with its most popular configuration servers - Intel Xeon E3-1270v3 3.5 GHz, 32 GB of RAM, 2 √ó 240 GB SSD-drives in RAID 1. One of the servers was used as a load center, the rest, in different configurations " 1C-Bitrix ", we used for testing. <br><br>  <b>system configuration</b> <br>  As part of the testing, the servers worked on Linux OS CentOS 6.6 with the 1C-Bitrix: Web Environment package installed on it, <a href="https://www.1c-bitrix.ru/products/env/%3Futm_source%3Dhabr%26utm_medium%3Dtext%26utm_campaign%3Dcrushtest">you can read</a> more about it <a href="https://www.1c-bitrix.ru/products/env/%3Futm_source%3Dhabr%26utm_medium%3Dtext%26utm_campaign%3Dcrushtest">here</a> . <br><br>  PHP in the system was updated to version 5.6.9, and the cache directories were mounted in tmpfs.  Three configurations were prepared for testing: <br><br>  1) 1 server.  "1C-Bitrix: Site Management", web and MySQL work on the same server <br><br><img src="https://habrastorage.org/files/a92/008/680/a9200868022640d387ec83886ab91845.png"><br><br>  2) 2 servers.  "1C-Bitrix: Enterprise", the nginx balancer on the first server, the web application on both servers, the MySQL master and read / write to it on the first server, the MySQL slave and read from it on the second server <br><br><img src="https://habrastorage.org/files/e9e/921/b8a/e9e921b8aa5d4d6c99815fd9dfd808df.png"><br><br>  3) four servers.  A variant in which the second configuration is horizontally scaled by the slave machine. <br><br>  <b>What to test?</b> <br>  <a href="https://tech.yandex.ru/tank/">Yandex.Tank</a> was chosen as a testing tool.  Yandex.Tank allows using two load generation systems - Phantom and JMeter.  Phantom is superior to JMeter in terms of performance, but does not allow generating POST logic, saving and subsequent use of cookies.  For this reason, we generated the load using JMeter. <br><br>  <b>Who is testing?</b> <br>  We wanted to be tested by an independent company, whose opinion we, and third-party companies, and industry experts could trust.  We entrusted this task to <a href="http://itsumma.ru/">ITSumma</a> , which since 2008 has been engaged in round-the-clock administration and technical support of well-known projects in RuNet and has established itself in the market.  Its employees are regular speakers of relevant conferences (such as Highload, RIT ++, etc.). <br><br><h3>  Testing </h3><br>  In retrospect, testing can be divided into three stages. <br><br>  <b>The first stage</b> is a fitting room, within which we selected the maximum number of streams at which the SLA will be maintained: <br><br><ul><li>  single server configuration: 34 threads </li><li>  two server configuration: 74 threads </li><li>  four server configuration: 136 threads </li></ul><br>  <b>The second stage</b> is the first attempts to launch a full test.  When planning load testing, you need to understand that it will take some time to refine the system on which the test will be performed, and to work out the test procedure itself. <br><br>  At this stage, we are faced with a number of difficulties.  From the experience of overcoming them, we learned a number of lessons: <br><br><ol><li>  When organizing load testing, remember that the first large test run will be far from ideal results.  Perhaps you will forget something in the configuration of the OS and server software.  There may be problems with the testing system itself (JMeter is a Java application, with its inherent <a href="http://blazemeter.com/blog/jmeter-performance-and-tuning-tips">problems with garbage collection</a> ).  Well and the main thing - you will see thin places in your system that you have not noticed before and which can be corrected.  For example, as part of our testing, nine significant bugs were discovered, the fixes of which will be released in the next versions of the product.  So consider your first test as an optimization guide. </li><li>  Somewhat obvious thing, which, however, is to say: during the optimization all configuration changes on the servers should be recorded.  Ideally, do not apply more than a few changes at once.  Otherwise, it will be difficult to figure out exactly which action led to an improvement in performance. </li><li>  Daily testing in the presence of any error that is not immediately detected is a lost day of work.  After one of the iterations, when we made a number of changes to the configuration, we got good results and were happy about it.  But then they discovered that the third scenario was disconnected - the execution of user orders, the hardest in our case.  I had to start testing again.  After a day, we found out that the applied changes do not speed up the system. </li><li> A system under load test is a production system, and all the typical problems that occur on production sites can happen to it.  We have in one of the tests, 12 hours after launch, one of the servers ran out of space.  Therefore, it is vital to put standard alerts about problems on the site in their usual monitoring system so that they come to your phone.  And upon receipt, you need to immediately run to correct the situation, so as not to lose the already collected precious data. </li><li>  Good results most often mean testing errors.  In one iteration, we received a two-fold increase compared with the previous test.  It turned out that MySQL ‚Äúcrashed‚Äù through max connections, and the site in such a situation responded with a valid HTTP 200 code for the testing system. </li><li>  In any testing, ‚Äúbureaucracy‚Äù is very important: make the most detailed description of the test performed - scenarios, system configuration, test logs, etc.  All this will be useful for further analysis. </li></ol><br>  <b>The third stage</b> is the test itself.  After all procedures are worked out, and the system is optimized, it is better to run the test several times.  In our experience, this allows you to get a really accurate result, which even on 24-hour testing will be almost identical to the same test.  In repetitions of our tests, we obtained results with an accuracy of queries per second. <br><br><h3>  Test results </h3><br>  <u>Configuration 1 (1 server, ‚Äú1C-Bitrix: Site Management‚Äù, edition ‚ÄúBusiness‚Äù)</u> <br><br>  Test run time: 86,892 seconds <br><ul><li>  The number of PHP requests per second: 167, with 34 simultaneous streams </li><li>  99th percentile: 0.366 ms. </li><li>  Viewed Pages: 14,421,563 </li><li>  The percentage of outstanding requests: 0.31% </li></ul><br><br><img src="https://habrastorage.org/files/72e/f1e/b2e/72ef1eb2e7c74235a02f88673d101238.png"><br>  <i>Yandex.Tank percentile</i> <br><br><img src="https://habrastorage.org/files/f33/091/e35/f33091e35f134a20ac08fef8d19132be.png"><br>  <i>Shelf RPS (upper limit - 350 requests per second, including "composite" requests - 167 dynamic requests per second).</i> <br><br>  This is a good result for a complex system, and it is important to note that the main load is created by the complex procedures of adding goods to the basket and its design. <br><br>  <u>Configuration 2 (2 servers, "1C-Bitrix: Enterprise")</u> <br><br><ul><li>  Test run time: 86,850 seconds </li><li>  The number of PHP requests per second: 265, with 74 simultaneous streams </li><li>  99th percentile: 0.95 </li><li>  Number of viewed pages 23 082 301 </li><li>  The percentage of outstanding requests: 0.47% </li><li>  Scale factor versus 1: 1.60 configuration </li></ul><br><br><img src="https://habrastorage.org/files/af6/057/983/af60579836f94b1f8cf4fbef2dc9f743.png"><br>  <i>Yandex.Tank percentile</i> <br><br><img src="https://habrastorage.org/files/076/cdf/639/076cdf63915445c88aa99fcc48939b06.png"><br>  <i>"Shelf" RPS (including "composite" requests - the upper limit - 550 requests per second).</i> <br><br>  The number of requests per second did not grow as much as we would like - 1.6 times.  It is important to remember that in the multi-server configuration, server-to-server communication is added, and an additional overhead on the data exchange. <br><br>  <u>Configuration 3 (4 servers, ‚Äú1C-Bitrix: Enterprise‚Äù)</u> <br><br><ul><li>  Test run time: 86,402 seconds </li><li>  PHP requests per second: 535, with 136 simultaneous streams </li><li>  99th percentile: 0.9 </li><li>  Number of the browsed pages: 46 256 141 </li><li>  The percentage of outstanding requests: 0.47% </li><li>  Scale factor compared to configuration 2 - 2.00 </li></ul><br><br><img src="https://habrastorage.org/files/1b7/b97/cf0/1b7b97cf0ec14d039942a8d4a54c972c.png"><br>  <i>Yandex.Tank percentile</i> <br><br><img src="https://habrastorage.org/files/a3f/cd3/c26/a3fcd3c2652d48ef8576a46fe417e782.png"><br>  <i>"Shelf" RPS (including "composite" requests - the upper limit - 1100 requests per second).</i> <br><br>  And here - an excellent result for scaling.  By adding two more servers to the two-server configuration, we received a twofold increase in performance.  This result suggests that you will not run into the vertical limits of the hardware, additional servers will allow you to adequately distribute the load between the machines. <br><br><h3>  Results and future plans </h3><br>  With this testing, we tried to set a certain benchmark to which developers can orient themselves when evaluating the performance of their systems.  For us, a very important result was the confirmation of the high efficiency of the horizontal scaling of ‚Äú1C-Bitrix‚Äù: the use of four servers instead of two and gave a double increase.  And, of course, a pleasant metric - 167 requests for dynamics in a complex system on a single server. <br><br>  Now we plan to conduct a test in the open system to find out for ourselves the following points: <br><br><ol><li>  What happens to the system after reaching its limits within a single server, what can be optimized in it? </li><li>  How fast will the system recover from ultrahigh load? </li><li>  How to get such a toolkit so that developers can estimate the real number of users that can serve the project they have created on current equipment? </li></ol><br>  We will tell you about the results of this test and the experience. <br><br>  Useful links: <br><ol><li>  Detailed report on load <a href="http://www.1c-bitrix.ru/download/files/manuals/ru/1cbitrix_tests_2015.pdf%3Futm_source%3Dhabr%26utm_medium%3Dtext%26utm_campaign%3Dcrushtest">testing 1C-Bitrix</a> </li><li>  Alexey Lavrenyuk's <a href="http://www.failoverconf.ru/upload/iblock/8ce/2_01_YandexTank.pdf">report</a> on Yandex.Tank at the FailOver Conference 2015 conference </li><li>  <a href="http://blazemeter.com/blog/jmeter-performance-and-tuning-tips">JMeter tuning</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/262029/">https://habr.com/ru/post/262029/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262019/index.html">The first acquaintance with the coprocessor Intel Xeon Phi</a></li>
<li><a href="../262021/index.html">Creating the simplest data structures using functions in Python</a></li>
<li><a href="../262023/index.html">Entity Framework through the eyes of a stranger</a></li>
<li><a href="../262025/index.html">Cohort analysis: 3 cases</a></li>
<li><a href="../262027/index.html">UNetLab emulator - revolutionary leap</a></li>
<li><a href="../262035/index.html">Setting up the Express panel in the weekly assembly Vivaldi 1.0.219.3</a></li>
<li><a href="../262037/index.html">Books for the system administrator. My bookshelf</a></li>
<li><a href="../262039/index.html">Baidu anti-virus software removal procedure</a></li>
<li><a href="../262043/index.html">Permanent loss of EC2 instance, EBS volumes and all snapshots</a></li>
<li><a href="../262045/index.html">Processing 1 million requests per minute with Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>