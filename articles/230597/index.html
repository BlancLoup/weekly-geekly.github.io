<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Juniper SRX: Site-to-Site IPSec VPN using SSL certificates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time, we set up a Site-to-Site IPSec VPN using a pre-shared-key. Today we will talk about the same IPSec VPN, only using SSL certificates. 

 I d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Juniper SRX: Site-to-Site IPSec VPN using SSL certificates</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/230087/">Last time,</a> we set up a Site-to-Site IPSec VPN using a pre-shared-key.  Today we will talk about the same IPSec VPN, only using SSL certificates. <br><br>  I draw attention to the fact that both SRX'a must have a static external IP address. <br><br>  The network layout will be the same as last time: <br><img src="https://habrastorage.org/getpro/habr/post_images/dda/1a1/9c3/dda1a19c38976f11067224a0d57393b0.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will create certificates using OpenSSL, because  it's more interesting - CA for Windows Server 2012 R2 when installing ‚ÄúNext, Next, Next‚Äù signs CSR requests without problems, I had to tinker a bit with OpenSSL. <br><br>  All interested in asking under the cat. <br><a name="habracut"></a><br><br>  I will produce all of the following actions on Oracle Enterprise Linux 6.5 x64 (default install) and JunOS 12.1X46-D20.5: <br><pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat /etc/oracle-release Oracle Linux Server release 6.5 [root@localhost ~]# uname -mrs Linux 3.8.13-35.el6uek.x86_64 x86_64 [root@localhost ~]# openssl version OpenSSL 1.0.1e-fips 11 Feb 2013</span></span></code> </pre> <br><pre> <code class="bash hljs">cartman@gw-jvsrx-1<span class="hljs-comment"><span class="hljs-comment"># run show version Hostname: gw-jvsrx-1 Model: firefly-perimeter JUNOS Software Release [12.1X46-D20.5]</span></span></code> </pre><br><br>  The whole process is divided into the following parts: <br><ul><li>  Create a private key and certificate request on a Juniper SRX device </li><li>  Prepare Root CA </li><li>  Sign CSR requests with a Root CA certificate </li><li>  Install a chain of certificates for Juniper SRX devices </li><li>  Configure IPSec VPN </li><li>  Check IPSec VPN performance </li></ul><br><br><h4>  Create private key and CSR </h4><br>  Everything is simple - on each device you need to execute the following commands (you need to pay attention to the certificate-id, domain-name, ip-address and CN entry, since they will be different for each device).  Further (in the final config of the tunnel) I will use the <i>domain-name</i> , as local and remote identity, so this parameter <u>must</u> be present in the CSR request.  It is recommended to use the device FQDN. <br><pre> <code class="bash hljs">run request security pki generate-key-pair certificate-id gw-jvsrx-1 size 2048 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> rsa run request security pki generate-certificate-request certificate-id gw-jvsrx-1 digest sha-256 domain-name gw-jvsrx-1.home.local ip-address 192.168.136.137 subject <span class="hljs-string"><span class="hljs-string">"DC=HOME.local,CN=gw-jvsrx-1.home.local,OU=IT,O=Home,L=Moscow,C=RU"</span></span></code> </pre><br><br>  As a result of the last command, a CSR request will be displayed in the console and its MD5 and SHA1 fingerprints: <br><blockquote>  Generated certificate request <br>  <b>----- BEGIN CERTIFICATE REQUEST -----</b> <b><br></b>  <b>MIIC9DCCAdwCAQAwdjEaMBgGCgmSJomT8ixkARkWCkhPTUUubG9jYWwxHjAcBgNV</b> <b><br></b>  <b>BAMTFWd3LWp2c3J4LTEuaG9tZS5sb2NhbDELMAkGA1UECxMCSVQxDTALBgNVBAoT</b> <b><br></b>  <b>BEhvbWUxDzANBgNVBAcTBk1vc2NvdzELMAkGA1UEBhMCUlUwggEiMA0GCSqGSIb3</b> <b><br></b>  <b>DQEBAQUAA4IBDwAwggEKAoIBAQDNz / 0WXjOYu0rMy9sv865BjH0QbYQSjyqehpfv</b> <b><br></b>  <b>U0cIzRcRvhASrLVunHUQbnQCjZtjCEPQj3cpumXaxM5KufpmNelo + 3NXnIo70yn7</b> <b><br></b>  <b>oxD / 9SOd3UUV6wPrSVGnu8j1PlL08YAaSTIxtqchhQ + 0JK8DJVPHRCH2sXSwPy9B</b> <b><br></b>  <b>RbmfAi4p7cfHHo28c7 / wECWPpK4GvEKZ7SzqLtAbZsPqB6ulk8Qy41Qk3Agi4qrf</b> <b><br></b>  <b>u3YxfynrxZQH2ZhsxCIdUollzKMe8BmlViL9mbv31 + 9UKogXdgsG1rRQWjJflghQ</b> <b><br></b>  <b>oGZ6NIDqwDV8g2Fc5SCQo0mSdmXHz44zYRkfzgQLUCQuqm0dAgMBAAGgOTA3Bgkq</b> <b><br></b>  <b>hkiG9w0BCQ4xKjAoMCYGA1UdEQQfMB2CFWd3LWp2c3J4LTEuaG9tZS5sb2NhbIcE</b> <b><br></b>  <b>wKiIiTANBgkqhkiG9w0BAQsFAAOCAQEAw6nvznXy60xzd69zKd4mWRdXBF + sw5Wo</b> <b><br></b>  <b>i5x9 / qhLG4OtBDi2byBMLirytnVyFv2QOGCSjX6 / O0uI7lPec2Qvt / hB40QMifOk</b> <b><br></b>  <b>CIcF8nErseEwWyFJIHN3LVN0GrNb + wleZP8DiAVIHmDxefpaBMlB207fOu02jrkp</b> <b><br></b>  <b>AdFdb0UAGmvqLBi9dYLWFq9MIHpTKBygIwWvn1gFoToZHJhWSDuHZTeYpVGYMBWN</b> <b><br></b>  <b>MGTUNmo7h3Hp1IOghYVK9VsanK9mikWHebZN1aKUi6bDoRAi + UXnd2j1qBEPwc5q</b> <b><br></b>  <b>LWX0ytm + ykMmkEKcT5S + EeIP + wgw74mQ9k6 + P2f53fecKPK13Q3ASg ==</b> <b><br></b>  <b>----- END CERTIFICATE REQUEST -----</b> <br>  Fingerprint: <br>  77: 5a: 8c: 51: c1: 29: 3b: 73: 81: 0d: 52: a3: 7f: 56: 06: 21: 17: 42: 8f: 20 (sha1) <br>  d6: 41: a6: b8: af: f9: e5: e0: 2f: 6c: 0f: fa: 3b: 23: 3d: 76 (md5) </blockquote><br><br>  Copy the bold fragment to the clipboard and save it as a file on the server, where we will sign this request: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cat gw-jvsrx-1.csr -----BEGIN CERTIFICATE REQUEST----- MIIC9DCCAdwCAQAwdjEaMBgGCgmSJomT8ixkARkWCkhPTUUubG9jYWwxHjAcBgNV BAMTFWd3LWp2c3J4LTEuaG9tZS5sb2NhbDELMAkGA1UECxMCSVQxDTALBgNVBAoT BEhvbWUxDzANBgNVBAcTBk1vc2NvdzELMAkGA1UEBhMCUlUwggEiMA0GCSqGSIb3 DQEBAQUAA4IBDwAwggEKAoIBAQDNz/0WXjOYu0rMy9sv865BjH0QbYQSjyqehpfv U0cIzRcRvhASrLVunHUQbnQCjZtjCEPQj3cpumXaxM5KufpmNelo+3NXnIo70yn7 oxD/9SOd3UUV6wPrSVGnu8j1PlL08YAaSTIxtqchhQ+0JK8DJVPHRCH2sXSwPy9B RbmfAi4p7cfHHo28c7/wECWPpK4GvEKZ7SzqLtAbZsPqB6ulk8Qy41Qk3Agi4qrf u3YxfynrxZQH2ZhsxCIdUollzKMe8BmlViL9mbv31+9UKogXdgsG1rRQWjJflghQ oGZ6NIDqwDV8g2Fc5SCQo0mSdmXHz44zYRkfzgQLUCQuqm0dAgMBAAGgOTA3Bgkq hkiG9w0BCQ4xKjAoMCYGA1UdEQQfMB2CFWd3LWp2c3J4LTEuaG9tZS5sb2NhbIcE wKiIiTANBgkqhkiG9w0BAQsFAAOCAQEAw6nvznXy60xzd69zKd4mWRdXBF+sw5Wo i5x9/qhLG4OtBDi2byBMLirytnVyFv2QOGCSjX6/O0uI7lPec2Qvt/hB40QMifOk CIcF8nErseEwWyFJIHN3LVN0GrNb+wleZP8DiAVIHmDxefpaBMlB207fOu02jrkp AdFdb0UAGmvqLBi9dYLWFq9MIHpTKBygIwWvn1gFoToZHJhWSDuHZTeYpVGYMBWN MGTUNmo7h3Hp1IOghYVK9VsanK9mikWHebZN1aKUi6bDoRAi+UXnd2j1qBEPwc5q LWX0ytm+ykMmkEKcT5S+EeIP+wgw74mQ9k6+P2f53fecKPK13Q3ASg== -----END CERTIFICATE REQUEST----- [root@localhost ~]# cat gw-jvsrx-2.csr -----BEGIN CERTIFICATE REQUEST----- MIIC9DCCAdwCAQAwdjEaMBgGCgmSJomT8ixkARkWCkhPTUUubG9jYWwxHjAcBgNV BAMTFWd3LWp2c3J4LTIuaG9tZS5sb2NhbDELMAkGA1UECxMCSVQxDTALBgNVBAoT BEhvbWUxDzANBgNVBAcTBk1vc2NvdzELMAkGA1UEBhMCUlUwggEiMA0GCSqGSIb3 DQEBAQUAA4IBDwAwggEKAoIBAQDGSfJvRWRGz8gRQAiTQaoVfgrLGv4l00xDBqat egRMJ4811d80auFz8JvBy6XLCliaDUdTthGOu+8S8FACzO7sQHPLa+r1rnURU7A4 j9UxTLCDJ/5KR4FZHfIR+B/2ni3P40qWuat/KaYjJNW0Rb6cAZ9BRgbuTQU09i39 kPsZWLT3mazx1HP5hmAwRDHtx+AmZNV/gf/ho7JTNfbmRbh56CmJqGuLXDvKrGtN Us5K0BdFH6/SlRO+k8sD/mMJUOl909VT11WTj1li9C2EHzgVmrC3L78A9WWjLHDF FHpiYfP+8krMotek4n4BChMFnSBsGD6uBKtnNjvPRnvOI60HAgMBAAGgOTA3Bgkq hkiG9w0BCQ4xKjAoMCYGA1UdEQQfMB2CFWd3LWp2c3J4LTIuaG9tZS5sb2NhbIcE wKiIijANBgkqhkiG9w0BAQsFAAOCAQEAOc2zAMGMbo6SwvyBz+yJ8Ep1WL/rLuN8 ZKhkytwdVJJT42NyAZMyg2NLTyv735fgfGo7lMTW/18foVNhqG2gQwM/OETgqhTu K2XblHOCD9A0WRD6bUfL1pST7brJNQjmpnXRo+WRqHnZuVxNgj/gdbkCceYrVG70 BpA12SdJoWVMCbe/qVQ+N7OSECmL8skUCHPTQiKxW/lKQKvlbSReq7NnccdfcheK wZGa+uqb8EzZV3e0PwR75+VKIyw2Rf1IDU/sQrShqCGKrIJcfU16XL9hvTdINXFW RGtfuBhERHw1HcWiQL+x56Htyc4qDdt8ffz+aV38jVtCcwN+FoqWxA== -----END CERTIFICATE REQUEST-----</span></span></code> </pre><br><br><h4>  Create a root certificate </h4><br>  Now let's prepare the file structure and configuration of our CA Root: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># mkdir -p ca_root/{certs,conf,csr,newcerts,private} [root@localhost ~]# cd ca_root [root@localhost ca_root]# echo 1000 &gt; serial [root@localhost ca_root]# touch index.txt [root@localhost ca_root]# cp /etc/pki/tls/openssl.cnf conf/</span></span></code> </pre><br><br>  Do not forget to transfer our CSR to the "correct" directory: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># mv *.csr ca_root/csr</span></span></code> </pre><br><br>  I will create certificates without the ST field in the Subject (this can be done with this field, but there can be a lot of configurations and I decided to cover this moment), so I need to fix this parameter in the openssl.cnf config, which we will use: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># vi conf/openssl.cnf ..... [ CA_default ] dir = /etc/pki/CA &lt;==========================  /etc/pki/CA  . ..... [ policy_match ] countryName = match stateOrProvinceName = match &lt;==========================  match  optional organizationName = match organizationalUnitName = optional commonName = supplied emailAddress = optional .....</span></span></code> </pre><br><br>  JunOS creates a query using the PRINTABLESTRING encoding (string mask), while OpenSSL (by default) uses UTF8ONLY.  You can check it like this: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># openssl asn1parse -in csr/gw-jvsrx-1.csr | grep PRINTABLESTRING --color 50:d=5 hl=2 l= 21 prim: PRINTABLESTRING :gw-jvsrx-1.home.local 82:d=5 hl=2 l= 2 prim: PRINTABLESTRING :IT 95:d=5 hl=2 l= 4 prim: PRINTABLESTRING :Home 110:d=5 hl=2 l= 6 prim: PRINTABLESTRING :Moscow 127:d=5 hl=2 l= 2 prim: PRINTABLESTRING :RU [root@localhost ca_root]# openssl asn1parse -in csr/gw-jvsrx-2.csr | grep PRINTABLESTRING --color 50:d=5 hl=2 l= 21 prim: PRINTABLESTRING :gw-jvsrx-2.home.local 82:d=5 hl=2 l= 2 prim: PRINTABLESTRING :IT 95:d=5 hl=2 l= 4 prim: PRINTABLESTRING :Home 110:d=5 hl=2 l= 6 prim: PRINTABLESTRING :Moscow 127:d=5 hl=2 l= 2 prim: PRINTABLESTRING :RU</span></span></code> </pre><br><br>  If the encodings do not match, we will not be able to sign certificates for devices, since  there will be an error about the mismatch of values ‚Äã‚Äã(although the error text will indicate something like HOME &lt;&gt; HOME and guess which direction to dig might be problematic).  Let's make OpenSSL use PRINTABLESTRING: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># vi conf/openssl.cnf ..... string_mask = utf8only &lt;==========================  utf8only  default .....</span></span></code> </pre><br><br>  Now we will generate the root certificate of our Root CA (we will do for 10 years): <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># openssl req -new -x509 -days 3650 -keyout private/rootCA.key -out certs/rootCA.crt -config conf/openssl.cnf Generating a 2048 bit RSA private key .........+++ .........................................................................................+++ writing new private key to 'private/rootCA.key' Enter PEM pass phrase: Verifying - Enter PEM pass phrase: ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [XX]:RU State or Province Name (full name) []: Locality Name (eg, city) [Default City]:Moscow Organization Name (eg, company) [Default Company Ltd]:Home Organizational Unit Name (eg, section) []:IT Common Name (eg, your name or your server's hostname) []:Internal Root CA Email Address []:</span></span></code> </pre><br><br>  Just in case, <i>let me</i> remind you that <i>private / rootCA.key</i> must be guarded like the apple of an eye, because  This is the private key of our root certificate.  It is also recommended that when creating the root certificate, enter a very complex password for the <i>Enter PEM pass phrase</i> prompt. <br><br>  Verify that the encoding is correct: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># openssl asn1parse -in certs/rootCA.crt | grep PRINTABLESTRING --color 50:d=5 hl=2 l= 2 prim: PRINTABLESTRING :RU 63:d=5 hl=2 l= 6 prim: PRINTABLESTRING :Moscow 80:d=5 hl=2 l= 4 prim: PRINTABLESTRING :Home 95:d=5 hl=2 l= 2 prim: PRINTABLESTRING :IT 108:d=5 hl=2 l= 16 prim: PRINTABLESTRING :Internal Root CA 169:d=5 hl=2 l= 2 prim: PRINTABLESTRING :RU 182:d=5 hl=2 l= 6 prim: PRINTABLESTRING :Moscow 199:d=5 hl=2 l= 4 prim: PRINTABLESTRING :Home 214:d=5 hl=2 l= 2 prim: PRINTABLESTRING :IT 227:d=5 hl=2 l= 16 prim: PRINTABLESTRING :Internal Root CA</span></span></code> </pre><br><br><h4>  Sign CSR Requests </h4><br>  Let's start generating certificates for devices.  First you need to create 2 files in which we write down the attributes of the subjectAltName.  For us, the most critical will be the DNS parameter (the same local and remote identity), IP can be omitted, but we will do this: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># cat conf/gw-jvsrx-1.cnf extensions = extend [extend] subjectAltName = "DNS:gw-jvsrx-1.home.local","IP:192.168.136.137" [root@localhost ca_root]# cat conf/gw-jvsrx-2.cnf extensions = extend [extend] subjectAltName = "DNS:gw-jvsrx-2.home.local","IP:192.168.136.138"</span></span></code> </pre><br><br>  Now we will sign our CSR root certificate requests: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># openssl ca -verbose -in csr/gw-jvsrx-1.csr -out certs/gw-jvsrx-1.crt -keyfile private/rootCA.key -cert certs/rootCA.crt -extfile conf/gw-jvsrx-1.cnf -config conf/openssl.cnf [root@localhost ca_root]# openssl ca -verbose -in csr/gw-jvsrx-2.csr -out certs/gw-jvsrx-2.crt -keyfile private/rootCA.key -cert certs/rootCA.crt -extfile conf/gw-jvsrx-2.cnf -config conf/openssl.cnf</span></span></code> </pre><br><br>  Verify that subjectAltName is in the final certificates: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># openssl x509 -in certs/gw-jvsrx-1.crt -text -noout | grep DNS DNS:gw-jvsrx-1.home.local, IP Address:192.168.136.137 [root@localhost ca_root]# openssl x509 -in certs/gw-jvsrx-2.crt -text -noout | grep DNS DNS:gw-jvsrx-2.home.local, IP Address:192.168.136.138</span></span></code> </pre><br><br>  (For fun) Let's look at the issued certificates: <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># cat index.txt V 150721115632Z 1000 unknown /C=RU/O=Home/OU=IT/CN=gw-jvsrx-1.home.local V 150721115943Z 1001 unknown /C=RU/O=Home/OU=IT/CN=gw-jvsrx-2.home.local</span></span></code> </pre><br><br><h4>  Install a chain of certificates for devices </h4><br>  First you need to copy the device certificate files and the root certificate to our Junipers (can be done using scp or WinSCP). <br><pre> <code class="bash hljs">[root@localhost ca_root]<span class="hljs-comment"><span class="hljs-comment"># scp certs/gw-jvsrx-1.crt cartman@192.168.136.137:/cf/var/home/cartman/gw-jvsrx-1.crt [root@localhost ca_root]# scp certs/rootCA.crt cartman@192.168.136.137:/cf/var/home/cartman/rootCA.crt [root@localhost ca_root]# scp certs/gw-jvsrx-2.crt cartman@192.168.136.138:/cf/var/home/cartman/gw-jvsrx-2.crt [root@localhost ca_root]# scp certs/rootCA.crt cartman@192.168.136.138:/cf/var/home/cartman/rootCA.crt</span></span></code> </pre><br><br>  Now let's prepare the PKI configuration (this part of the config is the same for both devices): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security pki ca-profile openssl_root_ca ca-identity openssl_root_ca <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security pki ca-profile openssl_root_ca revocation-check <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span></code> </pre><br><br>  Install the root certificate and device certificate: <br><pre> <code class="bash hljs">run request security pki ca-certificate load ca-profile openssl_root_ca filename rootCA.crt run request security pki <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-certificate load certificate-id gw-jvsrx-1 filename gw-jvsrx-1.crt</code> </pre><br><br>  The same should be done on the 2nd device (just install the certificate for gw-jvsrx-2). <br><br><h4>  Configure IPSec VPN </h4><br>  There is nothing complicated here, most of the parameters I described in <a href="http://habrahabr.ru/post/230087/">this</a> article: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces st0 unit 0 point-to-point <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces st0 unit 0 family inet address 172.16.0.1/30 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike respond-bad-spi 1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike proposal ike-proposal-rsa authentication-method rsa-signatures <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike proposal ike-proposal-rsa dh-group group14 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike proposal ike-proposal-rsa authentication-algorithm sha-256 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike proposal ike-proposal-rsa encryption-algorithm aes-128-cbc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike proposal ike-proposal-rsa lifetime-seconds 3600 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike policy ike-policy-rsa mode main <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike policy ike-policy-rsa proposals ike-proposal-rsa <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike policy ike-policy-rsa certificate <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-certificate gw-jvsrx-1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike policy ike-policy-rsa certificate peer-certificate-type x509-signature <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 ike-policy ike-policy-rsa <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 address 192.168.136.138 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 dead-peer-detection always-send <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 dead-peer-detection interval 10 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-identity hostname gw-jvsrx-1.home.local <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 remote-identity hostname gw-jvsrx-2.home.local <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 external-interface ge-0/0/0.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ike gateway gw-jvsrx-2 version v2-only <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec proposal ipsec-proposal-rsa protocol esp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec proposal ipsec-proposal-rsa authentication-algorithm hmac-sha-256-128 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec proposal ipsec-proposal-rsa encryption-algorithm aes-128-cbc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec proposal ipsec-proposal-rsa lifetime-seconds 7200 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec policy ipsec-policy-rsa perfect-forward-secrecy keys group14 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec policy ipsec-policy-rsa proposals ipsec-proposal-rsa <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-interface st0.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 vpn-monitor <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-interface ge-0/0/0.1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 vpn-monitor destination-ip 172.16.0.2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 ike gateway gw-jvsrx-2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 ike ipsec-policy ipsec-policy-rsa <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security ipsec vpn gw-jvsrx-2 establish-tunnels immediately</code> </pre><br><br>  To increase paranoia, we tunnel the st0.0 tunnel interface into a separate security-zone with the name vpn (although it is possible with the trust already created), but since  educational post allow all traffic between trust and vpn: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone vpn to-zone trust policy vpn-to-trust match <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-address any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone vpn to-zone trust policy vpn-to-trust match destination-address any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone vpn to-zone trust policy vpn-to-trust match application any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone vpn to-zone trust policy vpn-to-trust <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> permit <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone trust to-zone vpn policy trust-to-vpn match <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-address any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone trust to-zone vpn policy trust-to-vpn match destination-address any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone trust to-zone vpn policy trust-to-vpn match application any <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security policies from-zone trust to-zone vpn policy trust-to-vpn <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> permit <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security zones security-zone vpn interfaces st0.0 host-inbound-traffic system-services all <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security zones security-zone vpn interfaces st0.0 host-inbound-traffic protocols all</code> </pre><br><br>  And of course OSPF: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf area 0.0.0.0 interface ge-0/0/1.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf area 0.0.0.0 interface st0.0 interface-type p2p <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf area 0.0.0.0 interface st0.0 hello-interval 10 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf area 0.0.0.0 interface st0.0 flood-reduction <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf area 0.0.0.0 interface st0.0 neighbor 172.16.0.2</code> </pre><br><br><h4>  Check the state of our tunnel </h4><br>  Verify that the first IPSec phase is functioning, and also verify the authentication method field: <br><pre> <code class="bash hljs">cartman@gw-jvsrx-1<span class="hljs-comment"><span class="hljs-comment"># run show security ike security-associations detail IKE peer 192.168.136.138, Index 6745, Gateway Name: gw-jvsrx-2 Role: Initiator, State: UP Initiator cookie: ce70b7c0d1c523a2, Responder cookie: be63393746194b61 Exchange type: IKEv2, Authentication method: RSA-signatures Local: 192.168.136.137:500, Remote: 192.168.136.138:500 Lifetime: Expires in 900 seconds Peer ike-id: gw-jvsrx-2.home.local Xauth assigned IP: 0.0.0.0 Algorithms: Authentication : hmac-sha256-128 Encryption : aes128-cbc Pseudo random function: hmac-sha256 Diffie-Hellman group : DH-group-14 Traffic statistics: Input bytes : 42720 Output bytes : 42720 Input packets: 534 Output packets: 534 Flags: IKE SA is created IPSec security associations: 0 created, 0 deleted Phase 2 negotiations in progress: 0 Negotiation type: Quick mode, Role: Initiator, Message ID: 0 Local: 192.168.136.137:500, Remote: 192.168.136.138:500 Local identity: gw-jvsrx-1.home.local Remote identity: gw-jvsrx-2.home.local Flags: IKE SA is created</span></span></code> </pre><br><br>  Check the second phase: <br><pre> <code class="bash hljs">cartman@gw-jvsrx-1<span class="hljs-comment"><span class="hljs-comment"># run show security ipsec security-associations detail ID: 131073 Virtual-system: root, VPN Name: gw-jvsrx-2 Local Gateway: 192.168.136.137, Remote Gateway: 192.168.136.138 Local Identity: ipv4_subnet(any:0,[0..7]=0.0.0.0/0) Remote Identity: ipv4_subnet(any:0,[0..7]=0.0.0.0/0) Version: IKEv2 DF-bit: clear Bind-interface: st0.0 Port: 500, Nego#: 11, Fail#: 0, Def-Del#: 0 Flag: 0x600a29 Last Tunnel Down Reason: Lifetime expired Direction: inbound, SPI: da9f6c4f, AUX-SPI: 0 , VPN Monitoring: UP Hard lifetime: Expires in 3880 seconds Lifesize Remaining: Unlimited Soft lifetime: Expires in 3245 seconds Mode: Tunnel(10 10), Type: dynamic, State: installed Protocol: ESP, Authentication: hmac-sha256-128, Encryption: aes-cbc (128 bits) Anti-replay service: counter-based enabled, Replay window size: 64 Direction: outbound, SPI: cb42bcf5, AUX-SPI: 0 , VPN Monitoring: UP Hard lifetime: Expires in 3880 seconds Lifesize Remaining: Unlimited Soft lifetime: Expires in 3245 seconds Mode: Tunnel(10 10), Type: dynamic, State: installed Protocol: ESP, Authentication: hmac-sha256-128, Encryption: aes-cbc (128 bits) Anti-replay service: counter-based enabled, Replay window size: 64</span></span></code> </pre><br><br>  It would be nice to see how OSPF worked there: <br><pre> <code class="bash hljs">cartman@gw-jvsrx-1<span class="hljs-comment"><span class="hljs-comment"># run show ospf route Topology default Route Table: Prefix Path Route NH Metric NextHop Nexthop Type Type Type Interface Address/LSP 172.31.255.2 Intra Router IP 1 st0.0 172.16.0.0/30 Intra Network IP 1 st0.0 172.16.1.0/27 Intra Network IP 1 ge-0/0/1.0 172.16.2.0/27 Intra Network IP 2 st0.0</span></span></code> </pre><br><br>  ... And check the availability of addresses "on the other side": <br><pre> <code class="bash hljs">cartman@gw-jvsrx-1<span class="hljs-comment"><span class="hljs-comment"># run ping inet 172.16.0.2 interface ge-0/0/1.0 count 5 PING 172.16.0.2 (172.16.0.2): 56 data bytes 64 bytes from 172.16.0.2: icmp_seq=0 ttl=64 time=15.802 ms 64 bytes from 172.16.0.2: icmp_seq=1 ttl=64 time=5.458 ms 64 bytes from 172.16.0.2: icmp_seq=2 ttl=64 time=10.438 ms 64 bytes from 172.16.0.2: icmp_seq=3 ttl=64 time=10.476 ms 64 bytes from 172.16.0.2: icmp_seq=4 ttl=64 time=5.445 ms --- 172.16.0.2 ping statistics --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max/stddev = 5.445/9.524/15.802/3.856 ms cartman@gw-jvsrx-1# run ping inet 172.16.2.1 interface ge-0/0/1.0 count 5 PING 172.16.2.1 (172.16.2.1): 56 data bytes 64 bytes from 172.16.2.1: icmp_seq=0 ttl=64 time=11.051 ms 64 bytes from 172.16.2.1: icmp_seq=1 ttl=64 time=5.441 ms 64 bytes from 172.16.2.1: icmp_seq=2 ttl=64 time=4.553 ms 64 bytes from 172.16.2.1: icmp_seq=3 ttl=64 time=5.447 ms 64 bytes from 172.16.2.1: icmp_seq=4 ttl=64 time=5.542 ms --- 172.16.2.1 ping statistics --- 5 packets transmitted, 5 packets received, 0% packet loss round-trip min/avg/max/stddev = 4.553/6.407/11.051/2.350 ms</span></span></code> </pre><br><br>  The tunnel is up and functioning correctly.  Hooray! <br><br>  Just in case, I bring the complete configuration of each device: <br><div class="spoiler">  <b class="spoiler_title">cartman @ gw-jvsrx-1 # show</b> <div class="spoiler_text">  cartman @ gw-jvsrx-1 # show <br>  system { <br>  host-name gw-jvsrx-1; <br>  time-zone Europe / Moscow; <br>  root-authentication { <br>  encrypted-password "YOUR_SECRET_ROOT_PASSWORD_HASH";  ## SECRET-DATA <br>  } <br>  name-resolution { <br>  no-resolve-on-input; <br>  } <br>  login { <br>  user cartman { <br>  full-name "FIRST_NAME LAST_NAME"; <br>  uid 2000; <br>  class super-user; <br>  authentication { <br>  ssh-rsa "ssh-rsa YOUR_PUBLIC_RSA_KEY cartman @ gw-jvsrx-1";  ## SECRET-DATA <br>  } <br>  } <br>  } <br>  services { <br>  ssh { <br>  root-login deny; <br>  protocol-version v2; <br>  client-alive-count-max 5; <br>  client-alive-interval 120; <br>  connection-limit 5; <br>  rate-limit 2; <br>  } <br>  dhcp { <br>  default-lease-time 21600; <br>  pool 172.16.1.0/27 { <br>  address-range low 172.16.1.2 high 172.16.1.30; <br>  router { <br>  172.16.1.1; <br>  } <br>  propagate-settings ge-0/0 / 1.0; <br>  } <br>  } <br>  } <br>  ntp { <br>  server 0.pool.ntp.org prefer; <br>  server 1.pool.ntp.org; <br>  server 2.pool.ntp.org; <br>  server 3.pool.ntp.org; <br>  } <br>  } <br>  interfaces { <br>  ge-0/0/0 { <br>  unit 0 { <br>  family inet { <br>  dhcp; <br>  } <br>  } <br>  } <br>  ge-0/0/1 { <br>  unit 0 { <br>  family inet { <br>  address 172.16.1.1/27; <br>  } <br>  } <br>  } <br>  lo0 { <br>  unit 0 { <br>  family inet { <br>  address 172.31.255.1/32; <br>  } <br>  } <br>  } <br>  st0 { <br>  unit 0 { <br>  point-to-point; <br>  family inet { <br>  address 172.16.0.1/30; <br>  } <br>  } <br>  } <br>  } <br>  routing-options { <br>  router-id 172.31.255.1; <br>  } <br>  protocols { <br>  ospf { <br>  area 0.0.0.0 { <br>  interface ge-0/0 / 1.0; <br>  interface st0.0 { <br>  interface-type p2p; <br>  hello-interval 10; <br>  flood-reduction; <br>  neighbor 172.16.0.2; <br>  } <br>  } <br>  } <br>  } <br>  security { <br>  pki { <br>  ca-profile openssl_root_ca { <br>  ca-identity openssl_root_ca; <br>  revocation-check { <br>  disable; <br>  } <br>  } <br>  } <br>  ike { <br>  respond-bad-spi 1; <br>  proposal ike-proposal-rsa { <br>  authentication-method rsa-signatures; <br>  dh-group group14; <br>  authentication-algorithm sha-256; <br>  encryption-algorithm aes-128-cbc; <br>  lifetime-seconds 3600; <br>  } <br>  policy ike-policy-rsa { <br>  mode main; <br>  proposals ike-proposal-rsa; <br>  certificate { <br>  local-certificate gw-jvsrx-1; <br>  peer-certificate-type x509-signature; <br>  } <br>  } <br>  gateway gw-jvsrx-2 { <br>  ike-policy ike-policy-rsa; <br>  address 192.168.136.138; <br>  dead-peer-detection { <br>  always-send; <br>  interval 10; <br>  } <br>  local-identity hostname gw-jvsrx-1.home.local; <br>  remote identity identity hostname gw-jvsrx-2.home.local; <br>  external-interface ge-0/0 / 0.0; <br>  version v2-only; <br>  } <br>  } <br>  ipsec { <br>  proposal ipsec-proposal-rsa { <br>  protocol esp; <br>  authentication-algorithm hmac-sha-256-128; <br>  encryption-algorithm aes-128-cbc; <br>  lifetime-seconds 7200; <br>  } <br>  policy ipsec-policy-rsa { <br>  perfect-forward-secrecy { <br>  keys group14; <br>  } <br>  proposals ipsec-proposal-rsa; <br>  } <br>  vpn gw-jvsrx-2 { <br>  bind-interface st0.0; <br>  vpn-monitor { <br>  source-interface ge-0/0 / 0.1; <br>  destination-ip 172.16.0.2; <br>  } <br>  ike { <br>  gateway gw-jvsrx-2; <br>  ipsec-policy ipsec-policy-rsa; <br>  } <br>  establish-tunnels immediately; <br>  } <br>  } <br>  nat { <br>  source { <br>  rule-set trust-to-untrust { <br>  from zone trust; <br>  to zone untrust; <br>  rule source-nat { <br>  match { <br>  source-address 0.0.0.0/0; <br>  } <br>  then { <br>  source-nat { <br>  interface; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } <br>  policies { <br>  from-zone trust to-zone untrust { <br>  policy trust-to-untrust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone trust to-zone trust { <br>  policy trust-to-trust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone vpn to-zone trust { <br>  policy vpn-to-trust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone trust to-zone vpn { <br>  policy trust-to-vpn { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  } <br>  zones { <br>  security-zone untrust { <br>  interfaces { <br>  ge-0/0 / 0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  ssh; <br>  ping; <br>  dhcp; <br>  ike; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  security-zone trust { <br>  interfaces { <br>  ge-0/0 / 1.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  all; <br>  } <br>  protocols { <br>  all; <br>  } <br>  } <br>  } <br>  lo0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  ping; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  security-zone vpn { <br>  interfaces { <br>  st0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  all; <br>  } <br>  protocols { <br>  all; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } </div></div><br><div class="spoiler">  <b class="spoiler_title">cartman @ gw-jvsrx-2 # show</b> <div class="spoiler_text">  cartman @ gw-jvsrx-2 # show <br>  system { <br>  host-name gw-jvsrx-2; <br>  time-zone Europe / Moscow; <br>  root-authentication { <br>  encrypted-password "YOUR_SECRET_ROOT_PASSWORD_HASH";  ## SECRET-DATA <br>  } <br>  name-resolution { <br>  no-resolve-on-input; <br>  } <br>  login { <br>  user cartman { <br>  full-name "FIRST_NAME LAST_NAME"; <br>  uid 2000; <br>  class super-user; <br>  authentication { <br>  ssh-rsa "ssh-rsa YOUR_PUBLIC_RSA_KEY cartman @ gw-jvsrx-2";  ## SECRET-DATA <br>  } <br>  } <br>  } <br>  services { <br>  ssh { <br>  root-login deny; <br>  protocol-version v2; <br>  client-alive-count-max 5; <br>  client-alive-interval 120; <br>  connection-limit 5; <br>  rate-limit 2; <br>  } <br>  dhcp { <br>  default-lease-time 21600; <br>  pool 172.16.2.0/27 { <br>  address-range low 172.16.2.2 high 172.16.2.30; <br>  router { <br>  172.16.2.1; <br>  } <br>  propagate-settings ge-0/0 / 1.0; <br>  } <br>  } <br>  } <br>  ntp { <br>  server 0.pool.ntp.org prefer; <br>  server 1.pool.ntp.org; <br>  server 2.pool.ntp.org; <br>  server 3.pool.ntp.org; <br>  } <br>  } <br>  interfaces { <br>  ge-0/0/0 { <br>  unit 0 { <br>  family inet { <br>  dhcp; <br>  } <br>  } <br>  } <br>  ge-0/0/1 { <br>  unit 0 { <br>  family inet { <br>  address 172.16.2.1/27; <br>  } <br>  } <br>  } <br>  lo0 { <br>  unit 0 { <br>  family inet { <br>  address 172.31.255.2/32; <br>  } <br>  } <br>  } <br>  st0 { <br>  unit 0 { <br>  point-to-point; <br>  family inet { <br>  address 172.16.0.2/30; <br>  } <br>  } <br>  } <br>  } <br>  routing-options { <br>  router-id 172.31.255.2; <br>  } <br>  protocols { <br>  ospf { <br>  area 0.0.0.0 { <br>  interface ge-0/0 / 1.0; <br>  interface st0.0 { <br>  interface-type p2p; <br>  hello-interval 10; <br>  flood-reduction; <br>  neighbor 172.16.0.1; <br>  } <br>  } <br>  } <br>  } <br>  security { <br>  pki { <br>  ca-profile openssl_root_ca { <br>  ca-identity openssl_root_ca; <br>  revocation-check { <br>  disable; <br>  } <br>  } <br>  } <br>  ike { <br>  respond-bad-spi 1; <br>  proposal ike-proposal-rsa { <br>  authentication-method rsa-signatures; <br>  dh-group group14; <br>  authentication-algorithm sha-256; <br>  encryption-algorithm aes-128-cbc; <br>  lifetime-seconds 3600; <br>  } <br>  policy ike-policy-rsa { <br>  mode main; <br>  proposals ike-proposal-rsa; <br>  certificate { <br>  local-certificate gw-jvsrx-2; <br>  peer-certificate-type x509-signature; <br>  } <br>  } <br>  gateway gw-jvsrx-1 { <br>  ike-policy ike-policy-rsa; <br>  address 192.168.136.137; <br>  dead-peer-detection { <br>  always-send; <br>  interval 10; <br>  } <br>  local-identity hostname gw-jvsrx-2.home.local; <br>  remote identity identity hostname gw-jvsrx-1.home.local; <br>  external-interface ge-0/0 / 0.0; <br>  version v2-only; <br>  } <br>  } <br>  ipsec { <br>  proposal ipsec-proposal-rsa { <br>  protocol esp; <br>  authentication-algorithm hmac-sha-256-128; <br>  encryption-algorithm aes-128-cbc; <br>  lifetime-seconds 7200; <br>  } <br>  policy ipsec-policy-rsa { <br>  perfect-forward-secrecy { <br>  keys group14; <br>  } <br>  proposals ipsec-proposal-rsa; <br>  } <br>  vpn gw-jvsrx-1 { <br>  bind-interface st0.0; <br>  vpn-monitor { <br>  source-interface ge-0/0 / 0.1; <br>  destination-ip 172.16.0.1; <br>  } <br>  ike { <br>  gateway gw-jvsrx-1; <br>  ipsec-policy ipsec-policy-rsa; <br>  } <br>  establish-tunnels immediately; <br>  } <br>  } <br>  nat { <br>  source { <br>  rule-set trust-to-untrust { <br>  from zone trust; <br>  to zone untrust; <br>  rule source-nat { <br>  match { <br>  source-address 0.0.0.0/0; <br>  } <br>  then { <br>  source-nat { <br>  interface; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } <br>  policies { <br>  from-zone trust to-zone untrust { <br>  policy trust-to-untrust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone trust to-zone trust { <br>  policy trust-to-trust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone vpn to-zone trust { <br>  policy vpn-to-trust { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  from-zone trust to-zone vpn { <br>  policy trust-to-vpn { <br>  match { <br>  source-address any; <br>  destination-address any; <br>  application any; <br>  } <br>  then { <br>  permit; <br>  } <br>  } <br>  } <br>  } <br>  zones { <br>  security-zone untrust { <br>  interfaces { <br>  ge-0/0 / 0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  ssh; <br>  ping; <br>  dhcp; <br>  ike; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  security-zone trust { <br>  interfaces { <br>  ge-0/0 / 1.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  all; <br>  } <br>  protocols { <br>  all; <br>  } <br>  } <br>  } <br>  lo0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  ping; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  security-zone vpn { <br>  interfaces { <br>  st0.0 { <br>  host-inbound-traffic { <br>  system-services { <br>  all; <br>  } <br>  protocols { <br>  all; <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } <br>  } </div></div></div><p>Source: <a href="https://habr.com/ru/post/230597/">https://habr.com/ru/post/230597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230587/index.html">The most detailed geological map of Mars</a></li>
<li><a href="../230589/index.html">CSScomb 3.0: beautiful code with one team</a></li>
<li><a href="../230591/index.html">Statistics from the Android application on your GAE site</a></li>
<li><a href="../230593/index.html">Gamers. Difference of interests</a></li>
<li><a href="../230595/index.html">ActivityRecognitionClient from the Google Play Services Library - "recognition of user actions"</a></li>
<li><a href="../230601/index.html">Book about venus</a></li>
<li><a href="../230603/index.html">No worries, no hassle: What you need for successful store automation</a></li>
<li><a href="../230605/index.html">Controls of CIA</a></li>
<li><a href="../230607/index.html">Modern Tornado: distributed image hosting in 30 lines of code</a></li>
<li><a href="../230613/index.html">What must a startup do to survive?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>