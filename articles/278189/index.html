<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Very smart WordPress blog with nginx + PHP-FPM + MariaDB + Varnish</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will talk about how I made my blog on WordPress fly at the expense of proper caching, compression and other optimization of the ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Very smart WordPress blog with nginx + PHP-FPM + MariaDB + Varnish</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will talk about how I made my blog on WordPress fly at the expense of proper caching, compression and other optimization of the server and client sides.  At the time of this writing, the characteristics of VDS are as follows: <br><blockquote>  CPU: 1 x 2GHz <br>  HDD: 10Gb <br>  RAM: 512Mb <br>  OS: Debian 8 x64 </blockquote><br>  The scheme of the system is as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/117/79e/d0a/11779ed0aa99f3441e7e1660e14c1ac5.jpg" alt="image"><br><a name="habracut"></a><br><h4>  Description of the scheme </h4><br>  For site visitors there is a redirection to HTTPS, where nginx works as a proxy for Varnish, while at the output of nginx, in addition to implementing an HTTPS connection, there is gzip compression of the data transmitted to the user.  The next element in this system is the Varnish HTTP accelerator, waiting for a connection on port 6081.  When receiving a request from a client, it searches for the requested URL in the cache, and if it is found it instantly returns it to the frontend.  Thus, if the requested file is in the cache, the speed of the request for pages is reduced to the speed of the request for static data.  If the requested file is not found in the cache, Varnish passes the request to the backend.  Also in Varnish, client side optimization is implemented ‚Äî here, the Cache-Control and Expires headers are set to static data, which indicate to the browser the need for caching this data on the client side.  This reduces the time to load the site and reduces the load on the server. <br><br>  The backend is again nginx, waiting for connections at 127.0.0.1:81.  PHP interpretation is implemented using FPM.  PHP version is 5.6 with OPcache accelerator enabled by default.  As a DBMS, MariaDB 10 is one of the best in performance and moderately operative DBMS among MySQL forks.  MyISAM is used as a table engine, since writing is rarely done, mainly reading, for which this engine is more optimized.  By turning off the engine InnoDB saves RAM.  Finally, WordPress functions as a CMS with the Varnish HTTP Purge plugin installed, sending PURGE requests to the addresses of the pages on which changes were made, which causes the Varnish cache for these pages to be cleared.  Thus, the user always receives the current version of the site.  Next, I will talk in detail about installing and configuring these components, as well as the problems that I encountered. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Install and configure nginx </h4><br>  Install: <br><br><pre><code class="cpp hljs">apt-get install nginx</code> </pre> <br>  The contents of the main config /etc/nginx/nginx.conf: <br><br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,       user www-data www-data; #         auto worker_processes auto; error_log /var/log/nginx/error.log; pid /var/run/nginx.pid; events { #      worker_connections 1024; #    ( FreeBSD  kqueue) use epoll; #      multi_accept on; } http { #    mime-     - include /etc/nginx/mime.types; default_type application/octet-stream; #    nginx   server_tokens off; #    sendfile   read+write sendfile on; #   ,       sendfile().            sendfile_max_chunk 128k; #          tcp_nopush on; tcp_nodelay on; #        reset_timedout_connection on; #            client_header_timeout 3; client_body_timeout 5; #  ,       3  send_timeout 3; #        client_header_buffer_size 2k; client_body_buffer_size 256k; #      client_max_body_size 12m; #    access_log off; #    include /etc/nginx/conf.d/*.conf; }</span></span></code> </pre><br>  Create a backend configuration file /etc/nginx/conf.d/backend.conf: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-comment"><span class="hljs-comment">#     81  listen 127.0.0.1:81; #      root /var/www/site.ru/public_html; index index.php; #  gzip-   .       .     9  .  ,    text/plain,       1  ,      CPU     gzip on; gzip_comp_level 9; gzip_min_length 512; gzip_buffers 8 64k; gzip_types text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml; gzip_proxied any; #   server_name site.ru www.site.ru; #       location ~ /\. { deny all; } #       location ~* /(?:uploads|files)/.*\.php$ { deny all; } #   URI    location / { try_files $uri $uri/ /index.php?$args; } #       */wp-admin rewrite /wp-admin$ $scheme://$host$uri/ permanent; location ~ \.php$ { #   404  ,  WordPress try_files $uri =404; #    php     FPM include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_pass unix:/var/run/php5-fpm.sock; } }</span></span></code> </pre><br>  For a detailed description of how to configure HTTPS in nginx, I recommend reading this article for reading: <a href="https://habrahabr.ru/post/252821/">habrahabr.ru/post/252821</a> <br>  Create a frontend settings file /etc/nginx/conf.d/frontend.conf: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-comment"><span class="hljs-comment">#   HTTPS listen REAL_IP:80; server_name site.ru www.site.ru; return 301 https://$server_name$request_uri; } server { listen 93.170.105.102:443 ssl; server_name site.ru www.site.ru; #  Keep-Alive    keepalive_timeout 60 60; #     .  ,      text/plain,            ,       .   ,     CPU    . gzip on; gzip_comp_level 1; gzip_min_length 512; gzip_buffers 8 64k; gzip_types text/plain; gzip_proxied any; #   ,    ssl_prefer_server_ciphers on; #   TLS   2  ssl_session_cache shared:TLS:2m; ssl_session_timeout 2m; #  ,       ssl_certificate /etc/ssl/combined.crt; #    ssl_certificate_key /etc/ssl/3_site.ru.key; #    - ssl_dhparam /etc/ssl/dh2048.pem; #   ssl_protocols TLSv1.2 TLSv1.1 TLSv1; #  ,    forward secrecy ssl_ciphers EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA512:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:ECDH+AESGCM:ECDH+AES256:DH+AESGCM:DH+AES256:RSA+AESGCM:!aNULL:!eNULL:!LOW:!RC4:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS; #  Strict-Transport-Secutiry  add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains'; location / { #   Varnish proxy_pass http://127.0.0.1:6081/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header X-Forwarded-Port 443; } }</span></span></code> </pre><br>  Re-read nginx configs: <br><br><pre> <code class="cpp hljs">service nginx reload</code> </pre><br>  Now, when you try to enter the site, you will see error 502. This is normal, since Varnish is not yet running. <br><br><h4>  Install and configure Varnish </h4><br>  Install Varnish: <br><br><pre> <code class="cpp hljs">apt-get install varnish</code> </pre><br>  The startup options file is located here - / etc / default / varnish.  In DAEMON_OPTS we set the following parameters: <br><br><pre> <code class="cpp hljs">DAEMON_OPTS=<span class="hljs-string"><span class="hljs-string">"-a :6081 \ -T 127.0.0.1:6082 \ -f /etc/varnish/default.vcl \ -S /etc/varnish/secret \ -s malloc,128m"</span></span></code> </pre><br>  -a - sets the port on which Varnish will accept connections, in our case from the frontend - nginx; <br>  -T - here the admin is spinning, in more detail in the description of the -S flag; <br>  -f - VCL configuration file - a special language for defining query processing and caching rules in Varnish; <br>  -S - Varnish has an admin panel.  To enter, you must run the varnishadm command, and the user must have read permissions on the / etc / varnish / secret file to authenticate; <br>  -s specifies where the cache is stored and its size, in this case 128MB in RAM. <br><br>  As you have probably understood, the most interesting is waiting for us in the file with the rules for processing requests.  During the start of the Varnish process, this file is compiled.  The VCL uses several sub-functions that describe these rules.  I will briefly tell about them, I recommend reading the full description on the official website. <br><br>  <b>sub vcl_recv</b> - this function is used when a request comes from a client; <br>  <b>sub vcl_pass</b> - executed when the client request needs to be sent directly to the backend, not to cache and not look for matches in the cache; <br>  <b>sub vcl_hash</b> - defines caching rules; you can use several storages for the same document, depending on different conditions, for example, support for client compression, or any other client features.  In our case, it will not be used, since we have only one client for Varnish - nginx on the frontend; <br>  <b>sub vcl_backend_response</b> - this function is used when a request comes from the backend (nginx); <br>  <b>sub vcl_deliver</b> - used immediately before sending data to the client, for example, to add / change headers. <br><br>  The scheme of the VCL components can be represented as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/61e/809/c6e/61e809c6e550bd7748842fc34c704f9d.jpg" alt="image"><br><br>  If the backend is accessed from the vcl_miss function, the backend response is sent to the cache.  The language itself is very similar to C. We proceed to the setting.  Open the file /etc/varnish/default.vcl and start to code: <br><br><pre> <code class="cpp hljs">#    ,     VCL <span class="hljs-number"><span class="hljs-number">4</span></span> vcl <span class="hljs-number"><span class="hljs-number">4.0</span></span>; #   backend <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> { .host = <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>; .port = <span class="hljs-string"><span class="hljs-string">"81"</span></span>; } #  IP/,    PURGE-    acl purge { <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>; } #     sub vcl_recv { #      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.method == <span class="hljs-string"><span class="hljs-string">"PURGE"</span></span>) { #     ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.ip ~ purge) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(synth(<span class="hljs-number"><span class="hljs-number">405</span></span>, <span class="hljs-string"><span class="hljs-string">"This IP is not allowed to send PURGE requests."</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (purge); } # POST-     Basic-  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.http.Authorization || req.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pass); } #      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.url ~ <span class="hljs-string"><span class="hljs-string">"wp-(login|admin)"</span></span> || req.url ~ <span class="hljs-string"><span class="hljs-string">"preview=true"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pass); } #  sitemap   robots,   sitemap   <span class="hljs-function"><span class="hljs-function">Google XML Sitemaps </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req.url ~ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sitemap"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> || req.url ~ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"robots"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pass); } #  cookies,  <span class="hljs-string"><span class="hljs-string">"has_js"</span></span>  <span class="hljs-string"><span class="hljs-string">"__*"</span></span>,  CloudFlare  Google Analytics,   Varnish    ,    cookies. <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> req.http.Cookie = regsuball(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"(^|;\s*)(_[_a-z]+|has_js)=[^;]*"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #   <span class="hljs-string"><span class="hljs-string">";"</span></span>  cookies,     <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> req.http.Cookie = regsub(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"^;\s*"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #  <span class="hljs-function"><span class="hljs-function">Quant Capital </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cookies</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  )</span></span></span><span class="hljs-function"> </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">set</span></span></span><span class="hljs-function"> req.http.Cookie </span></span>= regsuball(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"__qc.=[^;]+(; )?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #  wp-settings<span class="hljs-number"><span class="hljs-number">-1</span></span> cookie <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> req.http.Cookie = regsuball(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"wp-settings-1=[^;]+(; )?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #  wp-settings-time<span class="hljs-number"><span class="hljs-number">-1</span></span> cookie <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> req.http.Cookie = regsuball(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"wp-settings-time-1=[^;]+(; )?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #  wp test cookie <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> req.http.Cookie = regsuball(req.http.Cookie, <span class="hljs-string"><span class="hljs-string">"wordpress_test_cookie=[^;]+(; )?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); #  cookie,     (  ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.http.cookie ~ <span class="hljs-string"><span class="hljs-string">"^ *$"</span></span>) { unset req.http.cookie; } #      cookies,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.url ~ <span class="hljs-string"><span class="hljs-string">"\.(css|js|png|gif|jp(e)?g|swf|ico|woff|svg|htm|html)"</span></span>) { unset req.http.cookie; } #   cookies <span class="hljs-string"><span class="hljs-string">"wordpress_"</span></span>  <span class="hljs-string"><span class="hljs-string">"comment_"</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.http.Cookie ~ <span class="hljs-string"><span class="hljs-string">"wordpress_"</span></span> || req.http.Cookie ~ <span class="hljs-string"><span class="hljs-string">"comment_"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pass); } #  cookie  ,         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!req.http.cookie) { unset req.http.cookie; } #      cookies,     <span class="hljs-function"><span class="hljs-function">WordPress </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req.http.Authorization || req.http.Cookie)</span></span></span><span class="hljs-function"> </span></span>{ # <span class="hljs-function"><span class="hljs-function">Not cacheable by </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pass)</span></span></span></span>; } #    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (hash); } sub vcl_pass { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (fetch); } sub vcl_hash { hash_data(req.url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (lookup); } #     sub vcl_backend_response { #    unset beresp.http.Server; unset beresp.http.X-Powered-By; #     robots  <span class="hljs-function"><span class="hljs-function">sitemap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bereq.url ~ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sitemap"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> || bereq.url ~ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"robots"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.uncacheable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">30</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #   ,   ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bereq.url ~ <span class="hljs-string"><span class="hljs-string">"\.(css|js|png|gif|jp(e?)g)|swf|ico|woff|svg|htm|html"</span></span>) { #    unset beresp.http.cookie; #      -  <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">7</span></span>d; #   Cache-Control  Expires,    ,                unset beresp.http.Cache-Control; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.http.Cache-Control = <span class="hljs-string"><span class="hljs-string">"public, max-age=604800"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.http.Expires = now + beresp.ttl; } #       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bereq.url ~ <span class="hljs-string"><span class="hljs-string">"wp-(login|admin)"</span></span> || bereq.url ~ <span class="hljs-string"><span class="hljs-string">"preview=true"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.uncacheable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">30</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #         ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(bereq.url ~ <span class="hljs-string"><span class="hljs-string">"(wp-login|wp-admin|preview=true)"</span></span>)) { unset beresp.http.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cookie; } #      POST-  Basic  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( bereq.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span> || bereq.http.Authorization ) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.uncacheable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">120</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( bereq.url ~ <span class="hljs-string"><span class="hljs-string">"\?s="</span></span> ){ <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.uncacheable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">120</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #    ,     ! <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( beresp.status != <span class="hljs-number"><span class="hljs-number">200</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.uncacheable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">120</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #          <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.ttl = <span class="hljs-number"><span class="hljs-number">1</span></span>d; #       TTL <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> beresp.grace = <span class="hljs-number"><span class="hljs-number">30</span></span>s; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); } #      sub vcl_deliver { #    unset resp.http.X-Powered-By; unset resp.http.Server; unset resp.http.Via; unset resp.http.X-Varnish; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (deliver); }</code> </pre><br>  Then execute the command: <br><br><pre> <code class="cpp hljs">service varnish restart</code> </pre><br>  Having passed now in the browser to our site, we will see index.php which needs to be created previously. <br><br><h5>  Varnish and Debian 8 problem </h5><br>  And what if you want to change the port on which Varnish will accept incoming connections or change the cache size.  Judging by the official documentation, you need to change the file with Varnish startup parameters, which is located along the path: / etc / default / varnish and restart the service.  But no!  Nothing will change, and if we go to the top and press the 'c' key, we will see that the service is started with the same settings.  And the thing is that the new version of Debian uses systemd instead of init.d as the initialization system, and therefore you need to go to the /lib/systemd/system/varnish.service file and write the same startup parameters there in the ExecStart directive: <br><br><pre> <code class="cpp hljs">[Unit] Description=Varnish HTTP accelerator [Service] Type=forking LimitNOFILE=<span class="hljs-number"><span class="hljs-number">131072</span></span> LimitMEMLOCK=<span class="hljs-number"><span class="hljs-number">82000</span></span> ExecStartPre=/usr/sbin/varnishd -C -f /etc/varnish/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.vcl ExecStart=/usr/sbin/varnishd -a :<span class="hljs-number"><span class="hljs-number">6081</span></span> -T <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">6082</span></span> -f /etc/varnish/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.vcl -S /etc/varnish/secret -s <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>,<span class="hljs-number"><span class="hljs-number">128</span></span>m ExecReload=/usr/share/varnish/reload-vcl [Install] WantedBy=multi-user.target</code> </pre><br>  After saving, execute the following commands to make the changes effective: <br><br><pre> <code class="cpp hljs">systemctl daemon-reload service varnish restart</code> </pre><br>  At the moment, this problem is unsubscribed to the developers, when and how they will solve it is unknown, so just in case, make the same changes in both files so that once after the update everything does not fall. <br><br><h4>  Install and configure PHP-FPM </h4><br>  Install FPM and PHP library for working with DBMS: <br><br><pre> <code class="cpp hljs">apt-get install php5-fpm php5-mysqlnd</code> </pre><br>  Go to the configuration file /etc/php5/fpm/pool.d/www.conf and change the directive: <br><br><pre> <code class="cpp hljs">listen = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">9000</span></span></code> </pre><br>  To the following: <br><br><pre> <code class="cpp hljs">listen = /var/run/php5-fpm.sock</code> </pre><br>  In the same file we set the settings of the workers: <br><br><pre> <code class="cpp hljs">;     pm = dynamic ;   ,   ,     pm.max_spare_servers. pm.max_children = <span class="hljs-number"><span class="hljs-number">10</span></span> ;      FPM pm.start_servers = <span class="hljs-number"><span class="hljs-number">1</span></span> ;     (     ) pm.min_spare_servers = <span class="hljs-number"><span class="hljs-number">1</span></span> ;     ( ,    ) pm.max_spare_servers = <span class="hljs-number"><span class="hljs-number">3</span></span> ;   ,    ,    pm.max_requests = <span class="hljs-number"><span class="hljs-number">500</span></span></code> </pre><br>  Change several directives in /etc/php5/fpm/php.ini <br><pre> <code class="cpp hljs">upload_max_filesize = <span class="hljs-number"><span class="hljs-number">10</span></span>M post_max_size = <span class="hljs-number"><span class="hljs-number">12</span></span>M allow_url_fopen = Off</code> </pre><br>  post_max_size we set a little more than upload_max_filesize, because in addition to the file, there is other data in the request. <br>  Here, by the allow_url_fopen directive, we prohibit the execution of scripts located remotely (by removing the possibility of exploiting the vulnerability of a remote inclusion). <br><br>  And we say FPM to re-read the config: <br><br><pre> <code class="cpp hljs">service php5-fpm reload</code> </pre><br>  Now create a file that displays phpinfo () and access it in the browser, everything should work.  Do not forget that it has already been cached in Varnish and if you change the configuration of PHP, it will not be updated in your browser.  You can write a rule to skip this file in Varnish, or, for the duration of the tests, do not proxy Varnish, but directly backend on port 81. <br><br><h4>  Install and configure MariaDB </h4><br>  I chose this DBMS because of its better performance and ability to withstand heavy loads, while spending less RAM compared to MySQL, as well as its full compatibility with WordPress.  Installation is very simple; a password will be requested for the root user. <br><br><pre> <code class="cpp hljs">apt-get install mariadb-server</code> </pre><br>  I use MyISAM as an engine for tables, because writing to a table is rarely done, and on reading MyISAM shows the best characteristics.  I completely disabled support for InnoDB to free up RAM.  Settings are stored in the /etc/mysql/my.cnf file.  I will describe only those directives that I changed: <br><br><pre> <code class="cpp hljs">#        key_buffer = <span class="hljs-number"><span class="hljs-number">64</span></span>M #   query_cache_size = <span class="hljs-number"><span class="hljs-number">32</span></span>M #  MyISAM     <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-storage-engine=MyISAM #   InnoDB skip-innodb</code> </pre><br>  After saving the changes, restart the service: <br><br><pre> <code class="cpp hljs">service mysql restart</code> </pre><br><h4>  WordPress Customization - Varnish HTTP Purge Plugin </h4><br>  Install the Varnish HTTP Purge plugin in the WP administration panel.  Now when updating data to the changed pages, a PURGE request will be sent, clearing the cache in Varnish, and for visitors the data will always be updated. <br><br><h4>  Additional optimization </h4><br>  To optimize the client side with Varnish, we indicate to the browser the need to store static data in the local client cache.  But if you're craving for even more optimization, go to the <a href="https://developers.google.com/speed/pagespeed/insights/">developers.google.com/speed/pagespeed/insights</a> page and enter the URL of your site or even a specific page.  You will be given a list of recommendations, as well as offer an archive with compressed versions of your css and js styles.  Replace them on your website and get even greater download speed due to the reduced amount of data transferred, as well as the load on the server and the space occupied by these files in the cache. <br><br>  What should I do with documents requested from third-party servers, such as fonts or the jquery library?  You can transfer them to yourself, and here, by establishing a connection with only one server, the speed of loading pages increases, however, at the same time, the list of calls and the total load will increase.  Which option to choose - decide for yourself, depending on the workload of your server and your laziness. <br><br><h4>  Total </h4><br>  For the most part gzip compression and caching in Varnish gave the greatest effect.  The comments have already written a lot of additional optimization methods that I will certainly learn and implement as necessary.  In the meantime, the optimization results are as follows: <br>  Before <br> <a href=""><img src="https://habrastorage.org/files/622/400/1b1/6224001b1e86426eb2a4863a67c2437d.png" alt="image"></a> <br>  After <br> <a href=""><img src="https://habrastorage.org/getpro/habr/comment_images/acc/549/ace/acc549ace3077eb20a4b7379656bde64.png" alt="image"></a> <br>  Full stress tests will hold later. <br><br>  Source: <a href="https://webshake.ru/post/206">webshake.ru/post/206</a> </div><p>Source: <a href="https://habr.com/ru/post/278189/">https://habr.com/ru/post/278189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278179/index.html">Why technical debt is good</a></li>
<li><a href="../278181/index.html">We saw a web demo - Wavescroll</a></li>
<li><a href="../278183/index.html">Where and from whom to study robotics, big data management, high-quality software development</a></li>
<li><a href="../278185/index.html">"We will understand": Why not need to introduce complex products on their own</a></li>
<li><a href="../278187/index.html">Broadcast of TechNet Virtual Conference 2016 from Redmond, March 1-3</a></li>
<li><a href="../278191/index.html">Speaking in plain language</a></li>
<li><a href="../278193/index.html">Quantum leap</a></li>
<li><a href="../278199/index.html">Features support 10 data centers around the world: my experience and rake</a></li>
<li><a href="../278201/index.html">Intel has prepared a working prototype of the 5G platform</a></li>
<li><a href="../278205/index.html">360 Total Security welcomes Habrahabr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>