<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We program stm32 microcontrollers with QtCreator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow so imperceptibly it turned out that the programmer who developed the firmware for the microcontroller to us didn‚Äôt have time to keep up, and a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We program stm32 microcontrollers with QtCreator</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/620/6e8/e5f/6206e8e5f9be45a9a974071e3dc05c78.jpg" align="right" width="300"><br>  Somehow so imperceptibly it turned out that the programmer who developed the firmware for the microcontroller to us didn‚Äôt have time to keep up, and at some points I began to intercept the initiative and take it myself to correct errors. <br>  The development was conducted in the IAR environment, and many will agree with me that, compared with the development in QtCreator, this is pain and suffering. <br>  At some point, we decided that it would be faster to hire a new programmer and rewrite the stm32 controller firmware again with it, as I already knew a little about programming them and also found that QtCreator can debug on bare hardware (BareMetal plugin), I decided to take an active part in this. <br>  Here I want to share a project template for stm32f407 from Terra Electronica and talk about the features of its settings. <br><a name="habracut"></a><br><h4>  Test project </h4><br><h5>  Stage One - Toolchain </h5><br>  The development used Yagarto, or gcc-arm-embedded, which can be downloaded <a href="https://launchpad.net/gcc-arm-embedded">here</a> .  For platforms other than Linux, there is a significant limitation: gdb is built without Python support, which makes debugging impossible via QtCreator, the best way out is still using Linux, or at worst OSX, where it is not difficult to rebuild gdb from python support. <br><br>  QtCreator can be used as from the repository, if its version is not lower than 3.1, or it can be downloaded as part of QtSDK.  The main thing is that it includes support for qbs and BareMetal <br><br><h5>  Stage Two - IDE Setup </h5><br>  Turn on BareMetal and QbsProjectManager and reboot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/a5e/517/fc6/a5e517fc6ea0ec6af4e1d30dc5b7954b.png"><br><br>  Now we can go to the ‚ÄúDevices‚Äù tab and click on ‚Äúadd device‚Äù, if you did everything correctly, then the ‚ÄúBare device‚Äù type should appear there.  Gdb-server will be used for debugging, so you need to make sure that its address and port are correct. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abb/f7a/3cb/abbf7a3cb02b4c7a0e6536a120591659.png"><br><br>  In the compilers tab, add our arm-none-eabi-g ++ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b54/8a8/bfd/b548a8bfd4e1c4facc3c3ac34c009a5f.png"><br><br>  Similarly, we add the debugger arm-none-eabi-gdb, after which we create a new bundle, in which we indicate the device type ‚ÄúNaked Device‚Äù as well as our compiler and debugger. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10d/5bc/5e4/10d5bc5e4dc04d7d388f41790b0ce4ad.png"><br><br><h5>  Stage Three - Build a Test Project </h5><br>  Everything is simple, a template with a <a href="https://github.com/gorthauer/te-stm32f407-qbs-template">github</a> , open the stm32.qbs file, select the arm-embedded profile we created and compile.  The output should be an elf file with firmware, which somehow will need to run on the device. <br><br><h5>  Stage Four - Launch </h5><br>  Here it all depends on the type of debugger that you use, I use the jlink clone and run it using openocd, QtCreator is not able to independently raise the debug server, so we will need to run it in the template folder with the openocdf.cfg file, with profile for jlink. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/12d/3db/aae/12d3dbaae6e3ecb4088a88539803f18a.png"><br><br>  After you start openocd, you can simply click on the ‚ÄúStart Debugging‚Äù button in QtCreator and get a completely familiar environment.  In this template, work with tcp via lwip is implemented and a simple tcp echo server is written, which is located at 192.168.1.10 and listens to port 7000, and also responds to ping requests.  If everything is successfully assembled and started, then you will see the following picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d29/250/5d3/d292505d35dd9d2401525fe602c44768.png"><br><br>  But I think this article would not be complete without a description of the internals of the project. <br><br><h4>  What does this project have under the hood? </h4><br>  For the assembly uses qbs, the merits of which have already been <a href="http://habrahabr.ru/post/144127/">discussed</a> on Habr√©. <br><br>  In order not to litter the project file itself, I created the modules Stm32Product, Stm32Application, in which I set all the compiler and linker keys necessary for the assembly <br><br>  Stm32Product <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> qbs Product { Depends { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"cpp"</span></span> } cpp.commonCompilerFlags: [ <span class="hljs-string"><span class="hljs-string">"-mcpu=cortex-m4"</span></span>, <span class="hljs-string"><span class="hljs-string">"-mthumb"</span></span>, <span class="hljs-string"><span class="hljs-string">"-mfpu=fpv4-sp-d16"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//     "-mfloat-abi=softfp" //   ] cpp.linkerFlags: [ "-mcpu=cortex-m4", "-mthumb", "-mfpu=fpv4-sp-d16", "-mfloat-abi=softfp", ] }</span></span></code> </pre> <br><br>  Stm32Application <br><pre> <code class="javascript hljs">Stm32Product { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"application"</span></span> <span class="hljs-comment"><span class="hljs-comment">// To suppress bundle generation on Mac consoleApplication: true cpp.positionIndependentCode: false cpp.executableSuffix: ".elf" cpp.linkerFlags: { base.push("-Xlinker"); base.push("--gc-sections"); return base; } }</span></span></code> </pre><br><br>  Actually project file app.qbs <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> qbs <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Stm32Application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> qbs.FileInfo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> qbs.ModUtils Stm32Application { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Application"</span></span> cpp.includePaths: [ <span class="hljs-string"><span class="hljs-string">"app"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/cmsis"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/port/gcc"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/periphery"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/system"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/ethernet"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/lwip/src/"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/lwip/src/arch/"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/lwip/src/include"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/lwip/src/include/lwip"</span></span>, <span class="hljs-string"><span class="hljs-string">"libs/lwip/src/include/ipv4"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//Use old internet protocol due ipv6 has experimental status "libs/lwip/src/include/netif", "libs/lwip/src/netif", "libs/lwip/include", ] cpp.defines: [ "STM32F4XX", //  cmsis    "STM32F40_41xxx", "USE_STDPERIPH_DRIVER", "HSE_VALUE=168000000", ] Properties { condition: cpp.debugInformation cpp.defines: outer.concat("DEBUG") } cpp.linkerScripts: [ "../ldscripts/libs.ld", //  :  ,   , ,    "../ldscripts/mem.ld", "../ldscripts/sections.ld", ] Group { name: "sources" prefix: "../**/" files: [ "*.c", "*.cpp", "*.h", "*.s" ] excludeFiles: [ "ipv6/*.*", "test/unit/**/*.*", ] cpp.cxxFlags: [ "-std=c++11" ] //gcc         C++11 cpp.cFlags: [ "-std=gnu99" ] cpp.warningLevel: "all" } Group { name: "ldscripts" prefix: "../ldscripts/" files: "*.ld" } }</span></span></code> </pre><br><br>  In general, it seems to me that this template will not be too difficult to adapt for other microcontrollers, the main thing is that they have gcc support and libraries available in the source code for working with peripherals.  I hope that many, like me, feel more comfortable working in QtCreator than in IDEs such as Eclipse, Keil or IAR. </div><p>Source: <a href="https://habr.com/ru/post/222877/">https://habr.com/ru/post/222877/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222859/index.html">‚ÄúLike‚Äù button for websites and blogs: tasting</a></li>
<li><a href="../222861/index.html">SERPClick prepares to enter western markets</a></li>
<li><a href="../222863/index.html">Professional change management</a></li>
<li><a href="../222871/index.html">SpaceIL - Google Lunar X PRIZE member</a></li>
<li><a href="../222875/index.html">Java OSM Geocoder</a></li>
<li><a href="../222883/index.html">Adaptive interface for transformers on the example of Krita Gemini</a></li>
<li><a href="../222885/index.html">bb-mobile micrON-4: headset with the form of a phone with support for SMS and notifications</a></li>
<li><a href="../222887/index.html">International Agile Consortium ICAgile: Agile, Lean and all-all</a></li>
<li><a href="../222891/index.html">Radioactivity meter (radiometer) with Glonass receiver and data transmission via Wi-Fi</a></li>
<li><a href="../222895/index.html">2GIS showed new</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>