<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to send push notifications from your Rails application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most popular ways to connect a mobile application with a server is to send push notifications to the user. If you have already encountered ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to send push notifications from your Rails application</h1><div class="post__text post__text-html js-mediator-article">  One of the most popular ways to connect a mobile application with a server is to send push notifications to the user.  If you have already encountered the implementation of push notifications, then the discovery of America will not happen for you, however, newcomers in this topic have a hard time - this is due to the huge confusion in the information <i>(from the translator: really quite a lot of contradictory, and often completely useless information)</i> .  This confusion was the reason for writing this article for WellWithMe, where I will describe the development of the server side of push notifications. <br><br><a name="habracut"></a><br><br>  Before I continue, I have to warn about plug-n-play services that provide push notifications if you want to pay them ( <a href="https://www.parse.com/">Parse</a> , <a href="https://www.mobdb.net/">mobDB</a> , <a href="http://www.pushwoosh.com/">Pushwoosh</a> , <a href="http://urbanairship.com/">Urban Airship</a> , etc.), but this is not the way of the warrior.  Let's do it yourself, from scratch (and for free) <i>(in fact, not so from scratch, but nobody will have to pay)</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  If you want to make an apple pie from scratch, then first create the universe </blockquote>  <b>Karl Sagan</b> <br><br>  Here are three components that play an important role in our push notification delivery system: <br><ul><li>  API method for getting mobile device tokens </li><li>  Worker - constantly connected to Apple / Google servers and monitors the queue in Redis </li><li>  Code that, in fact, sends messages to the queue </li></ul><br><br>  First of all, you need to ask the user if he wants to receive push notifications <i>(golden words)</i> and if the user agrees to send a device token <i>(I don‚Äôt know how to translate, I think the device token will be clear to everyone)</i> .  We will save them (device token) in a simple ActiveRecord model, which we will call Device <br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Schema Information # Table name: devices # id :integer not null, primary key # user_id :integer # token :string(255) # enabled :boolean default(TRUE) # created_at :datetime not null # updated_at :datetime not null # platform :string(255) class Device &lt; ActiveRecord::Base attr_accessible :enabled, :token, :user, :platform belongs_to :user validates_uniqueness_of :token, :scope =&gt; :user_id end</span></span></code> </pre> <br><br>  Device instances <i>(entries to the database)</i> must be created when the application calls the appropriate API method. <br><br><pre> <code class="ruby hljs">resource <span class="hljs-symbol"><span class="hljs-symbol">:devices</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @device = Device.create(<span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> current_user, <span class="hljs-symbol"><span class="hljs-symbol">token:</span></span> params[<span class="hljs-symbol"><span class="hljs-symbol">:token</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">platform:</span></span> params[<span class="hljs-symbol"><span class="hljs-symbol">:platform</span></span>]) present @device, <span class="hljs-symbol"><span class="hljs-symbol">with:</span></span> WellWithMe::Entities::Device <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Use the Redis Notification model as a queue <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationSender</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notifications</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Redis::List</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Notification</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key_name</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform</span></span></span><span class="hljs-class">'] == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iOS</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">note</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Grocer::Notification</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_token</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class">'], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alert</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">'], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sound</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">badge</span></span></span><span class="hljs-class">: 0 ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PUSHER</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">note</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elsif</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform</span></span></span><span class="hljs-class">'] == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Android</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gcm</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GCM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENV</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gcm_key</span></span></span><span class="hljs-class">']) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registration_id</span></span></span><span class="hljs-class"> = [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class">']] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class"> = { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">' =&gt; { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_json</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">'] }, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">collapse_key</span></span></span><span class="hljs-class">' =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">updated_state</span></span></span><span class="hljs-class">' } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gcm</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send_notification</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registration_id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  NotificationSender reads tasks from the queue while constantly maintaining a connection to the servers, without trying to establish new connections to send each push notification, which Apple actively impedes: <a href="https://developer.apple.com/news/%3Fid%3D03212012a">Apple's note about connecting to push notification servers</a> <br><br>  This code runs every minute, checking the Redis notification queue and sending push notifications to devices. <br><br>  Great jams <a href="https://github.com/grocer/grocer">grocer</a> for iOS and <a href="https://github.com/spacialdb/gcm">GCM</a> for Android were used.  Both jams work great and are very well documented.  The only restriction is that you have to create certificates for iOS and export them correctly - just follow the instructions from Apple. <br><br>  Now you have an easily expandable push notification system.  Push notifications will help to increase the number of your users, but do not abuse them, otherwise the opposite effect will occur. <br>  <i>And the translator will write his crutch almost in the same spirit, only throwing out Redis and adding Windows Phone</i> </div><p>Source: <a href="https://habr.com/ru/post/214607/">https://habr.com/ru/post/214607/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214595/index.html">Fujitsu Webinar Fujitsu ServerView Suite Software</a></li>
<li><a href="../214597/index.html">HP Converged System Converged Platforms for Virtualization</a></li>
<li><a href="../214599/index.html">NetBeans: maintaining current versions of files from a remote server via ssh</a></li>
<li><a href="../214601/index.html">How-to: We write trade robots on TradeScript</a></li>
<li><a href="../214605/index.html">Globex GU5011B Review - MediaTek MT6582 quad-core solution</a></li>
<li><a href="../214609/index.html">Stable Opera 20</a></li>
<li><a href="../214611/index.html">Digest of news of the Windows Azure platform, February 2014</a></li>
<li><a href="../214613/index.html">Control roboruku using leap motion</a></li>
<li><a href="../214615/index.html">E7 v2 - addition to the Intel Xeon family</a></li>
<li><a href="../214617/index.html">Interception of FBI conversations using Google Maps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>