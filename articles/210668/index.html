<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two or more jobs on the same computer - free solution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the idea and practical guide to creating a multi-user workstation (multiseat) using KVM virtualization, with the possibility of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two or more jobs on the same computer - free solution</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4cd/a96/7f3/4cda967f366b86e2db579b9002db6545.jpg"><br>  This article discusses the idea and practical guide to creating a multi-user workstation (multiseat) using KVM virtualization, with the possibility of remote control via libvirt.  With this guide, it is possible to create two or more workplaces both in the office and at home, which may require the ability to make full use of the computer‚Äôs graphics subsystem.  Moreover, it is possible to simultaneously work on different operating systems Windows, Linux, Mac OS X on one system unit, the rest is to the taste. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  The desire to realize the possibility of sharing one computer, at least two people appeared a long time ago.  The idea to make from a home or office computer at least two workplaces used to be implemented mainly on the same operating system with all the ensuing disadvantages.  Difficulties arose especially when one person liked to work in windows, and another in Linux and someone had to endure if the solution was implemented only through one OS.  However, there were other difficulties. <br><br>  Now computers have become more productive, the increase in the frequency of new processors has long been unhappy for us, but it pleases the growth of the cores.  And this means that we potentially already have several computers in one system unit.  And this trend will only grow.  The work of several people with one computer in a standard configuration will soon be in demand on the market and is now available for sale. <br><h4>  Gentoo Installation </h4><br><div class="spoiler">  <b class="spoiler_title">Training</b> <div class="spoiler_text">  We download the <a href="">current livecd</a> and load. <br>  Raise the network.  What is the name of the network interface? <br><pre><code class="bash hljs">ifconfig eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</code> </pre> <br>  For those who love windows, set up a network like this <br><pre> <code class="bash hljs">net-setup eno1</code> </pre><br>  I personally got used in the old fashioned way.  Register your ip <br><pre> <code class="bash hljs">ifconfig eno1 192.168.1.2/24</code> </pre><br>  Set the default router <br><pre> <code class="bash hljs">route add default gw 192.168.1.1</code> </pre><br>  We specify our DNS <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"nameserver 8.8.8.8"</span></span> &gt;&gt; /etc/resolv.conf</code> </pre><br>  We set the password for root <br><pre> <code class="bash hljs">passwd root</code> </pre><br>  Run ssh to continue the installation remotely <br><pre> <code class="bash hljs">/etc/init.d/sshd start</code> </pre><br>  From your favorite workplace we go via ssh <br><pre> <code class="bash hljs">ssh root@192.168.1.186</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Disk partitioning</b> <div class="spoiler_text">  It is assumed that you have one empty disk named / dev / sda <br><pre> <code class="bash hljs">parted -a opt /dev/sda (parted) mklabel msdos</code> </pre><br>  Create a section for download.  150M with a very large margin.  Maybe we will migrate in the future sections in GPT and put EFI. <br><pre> <code class="bash hljs">(parted) mkpart primary ext2 1 150M (parted) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> 1 boot on</code> </pre><br>  Everything else will give under lvm <br><pre> <code class="bash hljs">(parted) mkpart primary 150M -1s (parted) <span class="hljs-comment"><span class="hljs-comment">#Is this still acceptable to you? Yes/No? yes (parted) set 2 lvm on (parted) quit</span></span></code> </pre><br>  We need LVM in order to take snapshots of virtual machine disks, without stopping the system, for organizing backup copies.  It will also be more convenient to change sections, add new ones. <br>  Partitioning disk for LVM.  Sizes put on your taste <br><pre> <code class="bash hljs">pvcreate /dev/sda2 vgcreate vg /dev/sda2 lvcreate -L 1G -n root vg lvcreate -L 1G -n tmp vg lvcreate -L 5G -n var vg lvcreate -L 10G -n usr vg</code> </pre><br>  If LVM has already been configured, you need to activate it. <br><pre> <code class="bash hljs">vgchange -ay</code> </pre><br>  Format all partitions <br><pre> <code class="bash hljs">mkfs.ext2 /dev/sda1 mkfs.ext2 /dev/vg/tmp <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> root var usr ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkfs.ext4 /dev/vg/<span class="hljs-variable"><span class="hljs-variable">$p</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Mounting our future root partition <br><pre> <code class="bash hljs">mount /dev/vg/root /mnt/gentoo</code> </pre><br>  Create directories for the rest of the mount points <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/gentoo mkdir boot usr var tmp sys proc dev chmod 1777 tmp</code> </pre><br>  We mount the remaining sections <br><pre> <code class="bash hljs">mount /dev/vg/usr /mnt/gentoo/usr mount /dev/vg/tmp /mnt/gentoo/tmp mount /dev/vg/var /mnt/gentoo/var mount /dev/sda2 /mnt/gentoo/boot</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Expanding the finished image and preparing for chroot</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/gentoo</code> </pre><br>  Downloading the latest system (check the date in the file name) <br><pre> <code class="bash hljs">wget http://mirror.yandex.ru/gentoo-distfiles/releases/amd64/current-stage3/stage3-amd64-nomultilib-20140123.tar.bz2</code> </pre><br>  Take the portage.  Portage - a description of how to build and install the programs we need. <br><pre> <code class="bash hljs">wget http://mirror.yandex.ru/gentoo-distfiles/snapshots/portage-latest.tar.bz2</code> </pre><br>  Unpack it all <br><pre> <code class="bash hljs">tar xvjpf stage3-amd64-nomultilib-20140123.tar.bz2 tar xvjf portage-latest.tar.bz2 -C /mnt/gentoo/usr</code> </pre><br>  Copy resolv.conf to the future root partition. <br><pre> <code class="bash hljs">cp /etc/resolv.conf /mnt/gentoo/etc/resolv.conf</code> </pre><br>  Mount system partitions <br><pre> <code class="bash hljs">mount --rbind /dev /mnt/gentoo/dev mount -t proc none /mnt/gentoo/proc mount --rbind /sys /mnt/gentoo/sys</code> </pre><br>  We get inside the created root partition (future system) <br><pre> <code class="bash hljs">chroot /mnt/gentoo env-update <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /etc/profile</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">We live in a new system</b> <div class="spoiler_text"><pre> <code class="bash hljs">nano /etc/portage/make.conf</code> </pre><br>  If necessary, change CFLAGS options for the compiler.  Compiler options are almost standard except for -march = native (instead of -march = i686), which makes the compiler use all the features of the processor.  If the task is to make an iron independent installation, it is better not to use, because  when recovering on a new hardware, (possibly) you will have to rebuild the whole world. <br>  USE - lists the globally basic program options that will be installed. <br>  If there are thin clients, add ‚Äúspice‚Äù to USE, if you need to forward USB ports of thin clients, add ‚Äúusbredir‚Äù <br><pre> <code class="bash hljs">CFLAGS=<span class="hljs-string"><span class="hljs-string">"-O2 -pipe -march=native"</span></span> <span class="hljs-comment"><span class="hljs-comment">#      MAKEOPTS="-j3" USE="bindist mmx sse sse2 -ipv6 unicode device-mapper -X slang udev pulseaudio" GENTOO_MIRRORS=http://mirror.yandex.ru/gentoo-distfiles/ SYNC="rsync://rsync.ru.gentoo.org/gentoo-portage" LINGUAS="ru en"</span></span></code> </pre><br>  Let's write our sections for auto-mount <br><pre> <code class="bash hljs">cat &gt; /etc/fstab &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> /dev/sda1 /boot ext2 noauto,noatime 1 2 /dev/vg/root / ext4 noatime 0 1 /dev/vg/tmp /tmp ext2 noatime 0 0 /dev/vg/usr /usr ext4 noatime 0 0 /dev/vg/var /var ext4 noatime 0 0 EOF</code> </pre><br>  Update the portage tree <br><pre> <code class="bash hljs">emerge --sync</code> </pre><br>  If you need to change the profile, then it's time <br><pre> <code class="bash hljs">eselect profile list eselect profile <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> &lt;&gt;</code> </pre><br>  Create a network configuration file <br><pre> <code class="bash hljs">cat &gt; /etc/conf.d/net &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> config_eno1=<span class="hljs-string"><span class="hljs-string">"null"</span></span> config_br0=<span class="hljs-string"><span class="hljs-string">"192.168.1.2/24"</span></span> routes_br0=<span class="hljs-string"><span class="hljs-string">"default via 192.168.1.1"</span></span> bridge_br0=<span class="hljs-string"><span class="hljs-string">"eno1"</span></span> rc_net_br0_need=<span class="hljs-string"><span class="hljs-string">"net.eno1"</span></span> ethtool_offload_eno1=<span class="hljs-string"><span class="hljs-string">"gro off"</span></span> dns_domain=<span class="hljs-string"><span class="hljs-string">"mydomain.ru"</span></span> dns_servers=<span class="hljs-string"><span class="hljs-string">"8.8.8.8 8.8.4.4"</span></span> EOF ln -s /etc/init.d/net.lo /etc/init.d/net.eno1 ln -s /etc/init.d/net.lo /etc/init.d/net.br0</code> </pre><br>  Set a password for root <br><pre> <code class="bash hljs">passwd root</code> </pre><br>  Add yourself (testuser) as a user and set a password.  Add to the group users, wheel, audio <br><pre> <code class="bash hljs">useradd -m -G users,wheel,audio -s /bin/bash testuser passwd testuser</code> </pre><br>  At the time of writing, qemu-1.7.1 was not released yet, so we‚Äôll put two stars to pick up the developer version <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"app-emulation/qemu ** ~amd64"</span></span> &gt;&gt;/etc/portage/package.accept_keywords</code> </pre><br>  This flag is needed so that pulseaudio works as an independent process.  Unfortunately, by default I could not get it to work steadily with libvirt using the variable ‚Äúnographics_allow_host_audio = 1‚Äù in libvirtd.conf.  Maybe you will succeed? <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"media-sound/pulseaudio -system-wide"</span></span> &gt;&gt;/etc/portage/make.profile/package.use.mask <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"media-sound/pulseaudio -dbus system-wide"</span></span> &gt;&gt;/etc/portage/package.use</code> </pre><br>  Indicate that you will need to build new versions of packages <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sys-kernel/gentoo-sources app-emulation/libvirt sys-apps/dtc sys-firmware/seabios; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$p</span></span><span class="hljs-string"><span class="hljs-string">" ~amd64"</span></span> &gt;&gt;/etc/portage/package.accept_keywords ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Install the necessary programs.  The -av key allows you to view the build options, if something does not suit you, you can include the option in the USE variable, which is contained in the /etc/portage/make.conf file.  app-misc / mc - if someone is comfortable <br><pre> <code class="bash hljs">emerge -av gentoo-sources vixie-cron lvm2 genkernel syslog-ng iproute2 libvirt ethtool bridge-utils grub terminus-font radeon-ucode app-misc/mc</code> </pre><br>  Add programs to startup <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sshd vixie-cron syslog-ng net.br0 libvirtd ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> rc-update add <span class="hljs-variable"><span class="hljs-variable">$s</span></span> default; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Build the Linux kernel, and in the sections <br>  &gt; Device Drivers&gt; IOMMU Hardware Support&gt; IOMMU Hardware Support <br>  Mark all asterisks <br>  &gt; Device Drivers&gt; VFIO Non-Privileged userspace driver framework <br>  Mark all asterisks <br>  &gt; Device Drivers&gt; Networking support&gt; Universal TUN / TAP device driver support <br>  Put an asterisk. <br>  Everything else to taste ;-) <br><pre> <code class="bash hljs">genkernel --lvm --menuconfig all</code> </pre><br>  Add the flag "dolvm" for autoloading LVM <br><pre> <code class="bash hljs">nano /etc/default/grub <span class="hljs-comment"><span class="hljs-comment">#   GRUB_CMDLINE_LINUX="dolvm"</span></span></code> </pre><br>  Install the Grub loader <br><pre> <code class="bash hljs">grub2-install /dev/sda grub2-mkconfig -o /boot/grub/grub.cfg</code> </pre><br>  Configuring localization <br><pre> <code class="bash hljs">cat /usr/share/i18n/SUPPORTED | grep -E <span class="hljs-string"><span class="hljs-string">'ru_RU|en_US'</span></span> &gt;&gt; /etc/locale.gen &amp;&amp; locale-gen</code> </pre><br>  Copy the new time zone file in / etc / localtime <br><pre> <code class="bash hljs">cp /usr/share/zoneinfo/Europe/Moscow /etc/localtime</code> </pre><br>  Configure keyboard switching <br><pre> <code class="bash hljs">nano /etc/conf.d/keymaps <span class="hljs-comment"><span class="hljs-comment">#   dumpkeys_charset="utf8" keymap="-u ru"</span></span></code> </pre><br>  Font in the console will prescribe <br><pre> <code class="bash hljs">nano /etc/conf.d/consolefont <span class="hljs-comment"><span class="hljs-comment">#   consolefont="cyr-sun16"</span></span></code> </pre><br>  Localization of messages <br><pre> <code class="bash hljs">cat &gt; /etc/env.d/02locale &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> LANG=<span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span> LC_ALL=<span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span> LANG=<span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span> LC_MESSAGES=<span class="hljs-string"><span class="hljs-string">"POSIX"</span></span> LC_NUMERIC=<span class="hljs-string"><span class="hljs-string">"POSIX"</span></span> LC_TIME=<span class="hljs-string"><span class="hljs-string">"POSIX"</span></span> EOF env-update &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /etc/profile rc-update add keymap default rc-update add consolefont default</code> </pre><br><br>  If necessary, you can update and rebuild packages with new USE flags. <br><pre> <code class="bash hljs">emerge -avuDN system world</code> </pre><br>  Set the host name <br><pre> <code class="bash hljs">nano /etc/conf.d/hostname hostname=<span class="hljs-string"><span class="hljs-string">"testhost"</span></span></code> </pre><br>  Rule / etc / hosts <br><pre> <code class="bash hljs">nano /etc/hosts 127.0.0.1 localhost testhost testhost.mydomain.ru</code> </pre><br>  We are overloaded, if everything is good, then you are lucky ;-) Still, everyone has different iron, maybe something will need to be included in the kernel. <br>  If everything is bad, then we understand the documentation or use google.  Documentation in Russian online is enough. <br></div></div><br><h4>  Customization </h4><br><h5>  BIOS setup </h5><br>  We check that the VT-d is enabled in the BIOS, for the Z87, ‚Äúusb intel XHCI‚Äù needs to be disabled for forwarding USB controllers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Sound setting </h5><br>  usermod -G kvm, audio, pulse-access -d / home / qemu qemu <br>  usermod -G wheel, audio, pulse-access, users testuser <br>  Run pulseaudio. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'PULSEAUDIO_SHOULD_NOT_GO_SYSTEMWIDE="1"'</span></span> &gt;&gt; /etc/conf.d/pulseaudio rc-update add pulseaudio default /etc/init.d/pulseaudio start su - testuser <span class="hljs-comment"><span class="hljs-comment"># C  alsamixer   ,     . alsamixer #   root exit #    /etc/init.d/alsasound save /etc/init.d/alsasound start rc-update add alsasound default</span></span></code> </pre><br><h5>  Libvirt setup </h5><br>  In the file /etc/libvirt/qemu.conf, we define the user, from which the virtualoks will run <br><pre> <code class="bash hljs">user = <span class="hljs-string"><span class="hljs-string">"qemu"</span></span> group = <span class="hljs-string"><span class="hljs-string">"qemu"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,    # clear_emulator_capabilities = 0</span></span></code> </pre><br>  At the time of writing the article seabios in gentoo 1.7.3, and we need a fresh one, so download and unpack it <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/libvirt wget http://code.coreboot.org/p/seabios/downloads/get/bios.bin-1.7.4.gz gzip -d bios.bin-1.7.4.gz</code> </pre><br><br>  Create a helper script for forwarding devices <br><pre> <code class="bash hljs">cat &gt; /etc/libvirt/vfio-bind &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh for dev in "$@"; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done EOF chmod +x /etc/libvirt/vfio-bind</span></span></code> </pre><br>  Run lspci and select the victim for manual forwarding. <br><pre> <code class="bash hljs">03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Turks PRO [Radeon HD 6570/7570] 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Turks/Whistler HDMI Audio [Radeon HD 6000 Series 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI <span class="hljs-comment"><span class="hljs-comment">#2 (rev 04)</span></span></code> </pre><br>  Create a script for forwarding a specific video card <br><pre> <code class="bash hljs">cat &gt; /etc/libvirt/<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-vga-1 &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /etc/libvirt/vfio-bind 0000:03:00.0 0000:03:00.1 #     6.    /sys/kernel/iommu_groups/6/devices chown qemu /dev/vfio/6 EOF chmod +x /etc/libvirt/bind-vga-1 #  /etc/libvirt/bind-vga-1 #    cat &gt; /etc/init.d/bind-vga-1 &lt;&lt; "EOF" #!/sbin/runscript start() { ebegin "Starting vfio-bind" /etc/libvirt/bind-vga-1 eend $? "Failed to start vfio-bind" } EOF #  ,     rc-update add bind-vga-1 default</span></span></code> </pre><br>  Now we will create a partition where the virtual machine image will lie <br><pre> <code class="bash hljs">lvcreate -L70G -nwks1 vg</code> </pre><br>  I have a machine, where the images of already prepared virtual locks with software are lying, I hope you will have one too.  How to prepare an image I will write below. <br><pre> <code class="bash hljs">ssh root@192.168.1.3 <span class="hljs-string"><span class="hljs-string">"dd if=/dev/vg_archive/windows7 bs=1M |gzip -"</span></span> |gunzip - | dd of=/dev/vg/wks1 bs=1M</code> </pre><br><h5>  Domain Setting </h5><br><br>  Below is the final configuration configuration file with comments. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'kvm'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:qemu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'http://libvirt.org/schemas/domain/qemu/1.0'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>wks1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uuid</span></span></span><span class="hljs-tag">&gt;</span></span>2811e544-bf4d-baf6-1135-ec5acd139999<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uuid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">memory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'KiB'</span></span></span><span class="hljs-tag">&gt;</span></span>4145152<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">memory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">currentMemory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'KiB'</span></span></span><span class="hljs-tag">&gt;</span></span>4145152<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">currentMemory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cpu</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'host-passthrough'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">os</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">arch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'x86_64'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">machine</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pc-q35-2.0'</span></span></span><span class="hljs-tag">&gt;</span></span>hvm<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loader</span></span></span><span class="hljs-tag">&gt;</span></span>/etc/libvirt/bios.bin-1.7.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">boot</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'hd'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bootmenu</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'yes'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">os</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">features</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">acpi</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">apic</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pae</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">features</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">offset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'localtime'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_poweroff</span></span></span><span class="hljs-tag">&gt;</span></span>destroy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_poweroff</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_reboot</span></span></span><span class="hljs-tag">&gt;</span></span>restart<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_reboot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_crash</span></span></span><span class="hljs-tag">&gt;</span></span>restart<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">on_crash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">devices</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emulator</span></span></span><span class="hljs-tag">&gt;</span></span>/usr/bin/qemu-kvm<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emulator</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'block'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'disk'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">driver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'qemu'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'raw'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cache</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'none'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/dev/vg/wks1'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   windows    target &lt;target dev='sda' bus='sata'/&gt; --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vda'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'virtio'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   CD  &lt;disk type='file' device='cdrom'&gt; &lt;driver name='qemu' type='raw'/&gt; &lt;source file='/usr/win_7.iso'/&gt; &lt;target dev='hdc' bus='sata'/&gt; &lt;readonly/&gt; &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt; &lt;/disk&gt; --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pcie-root'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alias</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pcie.0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'dmi-to-pci-bridge'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alias</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci.1'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'2'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci-bridge'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alias</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci.2'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">controller</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'bridge'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'52:54:00:12:50:01'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bridge</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'br0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   windows    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">model</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'virtio'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0000'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x02'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x03'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     windows,  vnc &lt;controller type='usb'/&gt; &lt;input type='tablet' bus='usb'/&gt; &lt;input type='mouse' bus='ps2'/&gt; &lt;graphics type='vnc' port='5900' autoport='no' listen='192.168.1.2' passwd='mypassword'/&gt; --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- BEGIN    vn    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostdev</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'subsystem'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">managed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'yes'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  source1   source.  -    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0000'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x00'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x1a'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0000'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x02'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x04'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostdev</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- END E   vn    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sound</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'ich9'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">memballoon</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'virtio'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">domain</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0000'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x02'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x08'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0x0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">memballoon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">devices</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">seclabel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'none'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:commandline</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HOME"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/home/qemu"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"QEMU_AUDIO_DRV"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pa"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- BEGIN     vnc,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'-vga'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'none'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'-device'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vfio-pci,host=03:00.0,bus=pcie.0,addr=02.0,x-vga=on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- END     vnc,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:commandline</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We write this configuration to the /etc/libvirt/qemu/wks1.xml file. <br>  Re-read the configuration file <br><pre> <code class="bash hljs">/etc/init.d/libvirtd restart</code> </pre><br>  We start the domain <br><pre> <code class="bash hljs">virsh start wks1 <span class="hljs-comment"><span class="hljs-comment">#    ,      # virsh autostart wks1</span></span></code> </pre><br><h4>  Initial installation </h4><br>  For the initial installation, write the desired iso image and uncomment the cdrom section.  We also remove all virtio settings and device 03: 00.0 rollouts - video and 00: 1a.0 usb controller.  We include access on vnc.  After that, when you install the system, you need to install the virtio driver in the guest OS.  <a href="">Drivers for windows.</a> <br>  Without drivers, everything works very slowly. <br><h4>  Known ambush </h4><br><ul><li>  I met the fact that without a full windows update, the latest virtio drivers did not get up. </li><li>  Before you install the driver-virtio of the main disk, you need to connect a second empty disk with the type of virtio already defined <br><pre> <code class="bash hljs">lvcreate -nzero -L1M</code> </pre><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'block'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'disk'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">driver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'qemu'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'raw'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cache</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'writethrough'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/dev/vg/wks1'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'sda'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'sata'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'block'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'disk'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">driver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'qemu'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'raw'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cache</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'writethrough'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/dev/vg/zero'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dev</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vda'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bus</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'virtio'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></li><li>  In windows, changing power saving settings -&gt; setting the transition to sleep mode -&gt; putting the computer into sleep mode -&gt; <br>  "never" </li></ul><br><br>  This script can be installed in the crontab. <br><pre> <code class="bash hljs">cat &gt; /etc/libvirtd/shutdown_if_not_start.sh &lt;&lt; <span class="hljs-string"><span class="hljs-string">"EOF"</span></span> <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh LIST_VM=`virsh list | awk '{if($3=="running")print $2}'|wc -l` if [ ${LIST_VM} -ne 0 ] ; then exit 0 fi awk '{if(int($1)&gt;300){exit 0}else{ exit 1}}' /proc/uptime if [ $? -ne 0 ]; then exit 0 fi /sbin/shutdown -h now EOF chmod +x /etc/libvirtd/shutdown_if_not_start.sh</span></span></code> </pre><br><h4>  Conclusion </h4><br>  Like the highlights described.  <a href="https://bbs.archlinux.org/viewtopic.php%3Fid%3D162768">Here</a> you can find solutions if you have windows crashes into BSOD.  If you organize snapshots, do not forget to install the QEMU Guest Agent and learn how to work with it. <br>  We have an Apache on our combat computers; through the script, the user himself can perform actions from the VM from a nearby computer or virtual machine.  You can also implement the launch of virtualok via USB key. <br>  I am sure that someone will be able to improve this configuration.  Please write about it in the comments to help others. <br>  This configuration can be packaged and distributed to other machines, as well as images of guest OCs.  Do not forget after expanding the host image, correct addresses, host names, interfaces and generate ssh keys. <br>  About spice and ARM, if it is interesting to write separately. </div><p>Source: <a href="https://habr.com/ru/post/210668/">https://habr.com/ru/post/210668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210654/index.html">Direct entry to the 1C: Enterprise Directory via Linq on the example of working with Asp.Net users</a></li>
<li><a href="../210656/index.html">Horizontal scaling PHP applications. Part 1</a></li>
<li><a href="../210660/index.html">What to do if the client is a friend / good friend?</a></li>
<li><a href="../210664/index.html">My comfortable home</a></li>
<li><a href="../210666/index.html">Access to the file system from the Portable Class Library (PCL)</a></li>
<li><a href="../210672/index.html">10 obscure Objective-C features</a></li>
<li><a href="../210676/index.html">Smartphone / clock video review iconBIT Callisto 100</a></li>
<li><a href="../210680/index.html">Do you use web components?</a></li>
<li><a href="../210682/index.html">Escene ES620 IP Phone Review with Escene ESM 32 Expansion Module</a></li>
<li><a href="../210684/index.html">Cryptanalysis hash functions GOST R 34.11-2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>