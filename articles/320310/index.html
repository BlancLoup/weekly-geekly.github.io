<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JunOS update on EX4500 switches in VirtualChassis - what could go wrong? Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, not postponing the case indefinitely, I publish the second part of the post above. I express my gratitude for the publication - it is nice that th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JunOS update on EX4500 switches in VirtualChassis - what could go wrong? Part 2</h1><div class="post__text post__text-html js-mediator-article">  So, not postponing the case indefinitely, I publish the second part of the <a href="https://habrahabr.ru/post/320266/">post</a> above.  I express my gratitude for the publication - it is nice that the article interested you and the topic has found a continuation. <br><br>  Let me remind you that in the last part I stopped at the conclusion that after rebooting one of the VC devices did not work properly.  As was rightly noted in one of the comments, it turns out that after all this I went home.  No, the first part describes about 20 minutes of my almost five-hour epic.  Buckled up?  Go! <br><a name="habracut"></a><br>  After the reboot, it is not entirely clear what happened and did happen, but the main thing is that the client traffic has gone.  I am connecting via a dedicated management Ethernet interface and the first surprise is that the main RE has become a member1: <br><br><blockquote><code>login as: user <br> user@switch password: <br> --- JUNOS <b>12.3R12.4</b> built 2016-01-20 04:27:51 UTC <br> <b>{master:1}</b> <br> user@switch&gt;</code> </blockquote> <br>  In principle, this happens and is not scary, since I have the same devices with the pre-provisioned VC configuration and any of them can be a master.  The operating system was updated and it is good.  But this is no longer good: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code>user@switch&gt; show chassis routing-engine <br> Routing Engine status: <br> Slot 1: <br> Current state Master <br> DRAM 1024 <br> Memory utilization 45 percent <br> CPU utilization: <br> User 14 percent <br> Background 0 percent <br> Kernel 11 percent <br> Interrupt 1 percent <br> Idle 74 percent <br> Model EX4500-40F <br> Serial ID <br> Start time 2016-06-02 01:28:45 <br> Uptime 34 minutes, 55 seconds <br> Last reboot reason Router rebooted after a normal shutdown. <br> Load averages: 1 minute 5 minute 15 minute <br> 0.59 0.80 0.66 <br> {master:1} <br> user@switch&gt;</code> </blockquote> <br>  The device sees only one RE, and there should be two of them.  Further investigation only confirms that non-burning LEDs are not without reason: <br><br><blockquote> <code>user@switch&gt; show virtual-chassis <br> Preprovisioned Virtual Chassis <br> Virtual Chassis ID: <br> Virtual Chassis Mode: Enabled <br> Mstr Mixed Neighbor List <br> Member ID Status Serial No Model prio Role Mode ID Interface <br> 0 (FPC 0) <b>Inactive</b>  ex4500-40f 129 <b>Linecard</b> N 1 vcp-1 <br> 1 vcp-0 <br> 1 (FPC 1) Prsnt  ex4500-40f 129 Master* N 0 vcp-1 <br> 0 vcp-0 <br> {master:1} <br> user@switch&gt;</code> </blockquote> <br>  The first device, member0, is recognized as a Linecard and has the status Inactive - this means that it does not actively participate in the virtual chassis.  Dedicated stack interfaces (vcp-1 and vcp-0) are active, so you can try a local connection: <br><br><div class="spoiler">  <b class="spoiler_title">Connection and verification</b> <div class="spoiler_text">  {master: 1} <br>  user @ switch&gt; request session member 0 <br>  --- <b>JUNOS 11.1R3.5</b> built 2011-06-25 01:18:46 UTC <br>  {linecard: 0} <br>  user @ switch&gt; show system storage <br>  <b>fpc0:</b> <br>  - Filesystem Size Used Avail Capacity Mounted on <br>  / dev / da0s1a 370M 142M 198M 42% / <br>  devfs 1.0K 1.0K 0B 100% / dev <br>  / dev / md0 37M 37M 0B 100% / packages / mnt / jbase <br>  / dev / md1 12M 7.3M 3.6M 67% / packages / mfs-jcrypto-ex <br>  / dev / md2 22M 22M 0B 100% / packages / mnt / jcrypto-ex- <b>11.1R3.5</b> <br>  / dev / md3 8.7M 4.1M 3.9M 51% / packages / mfs-jdocs-ex <br>  / dev / md4 6.3M 6.3M 0B 100% / packages / mnt / jdocs-ex- <b>11.1R3.5</b> <br>  / dev / md5 64M 61M -1.4M 102% / packages / mfs-jkernel-ex <br>  / dev / md6 162M 162M 0B 100% /packages/mnt/jkernel-ex-11.1R3.5 <br>  / dev / md7 13M 8.5M 3.5M 71% / packages / mfs-jpfe-ex45x <br>  / dev / md8 24M 24M 0B 100% /packages/mnt/jpfe-ex45x-11.1R3.5 <br>  / dev / md9 20M 15M 2.9M 84% / packages / mfs-jroute-ex <br>  / dev / md10 47M 47M 0B 100% /packages/mnt/jroute-ex-11.1R3.5 <br>  / dev / md11 16M 11M 3.2M 78% / packages / mfs-jswitch-ex <br>  / dev / md12 35M 35M 0B 100% /packages/mnt/jswitch-ex-11.1R3.5 <br>  / dev / md13 12M 7.8M 3.6M 68% / packages / mfs-jweb-ex <br>  / dev / md14 22M 22M 0B 100% /packages/mnt/jweb-ex-11.1R3.5 <br>  / dev / md15 126M 8.0K 116M 0% / tmp <br>  / dev / da0s3e 243M 4.4M 219M 2% / var <br>  / dev / da0s3d 727M 130K 668M 0% / var / tmp <br>  / dev / da0s4d 123M 492K 113M 0% / config <br>  / dev / md16 118M 14M 95M 13% / var / rundb <br>  procfs 4.0K 4.0K 0B 100% / proc <br>  / var / jail / etc 243M 4.4M 219M 2% /packages/mnt/jweb-ex-11.1R3.5/jail/var/etc <br>  / var / jail / run 243M 4.4M 219M 2% /packages/mnt/jweb-ex-11.1R3.5/jail/var/run <br>  / var / jail / tmp 243M 4.4M 219M 2% /packages/mnt/jweb-ex-11.1R3.5/jail/var/tmp <br>  / var / tmp 727M 130K 668M 0% /packages/mnt/jweb-ex-11.1R3.5/jail/var/tmp/uploads <br>  devfs 1.0K 1.0K 0B 100% /packages/mnt/jweb-ex-11.1R3.5/jail/dev <br><br>  <b>fpc1:</b> <br>  - Filesystem Size Used Avail Capacity Mounted on <br>  / dev / da0s2a 363M 130M 204M 39% / <br>  devfs 1.0K 1.0K 0B 100% / dev <br>  / dev / md0 69M 69M 0B 100% / packages / mnt / jbase <br>  / dev / md1 5.8M 1.1M 4.2M 21% / packages / mfs-fips-mode-powerpc <br>  / dev / md2 2.9M 2.9M 0B 100% / packages / mnt / fips-mode-powerpc- <b>12.3R12.4</b> <br>  / dev / md3 9.1M 4.4M 3.9M 53% / packages / mfs-jcrypto-ex <br>  / dev / md4 12M 12M 0B 100% / packages / mnt / jcrypto-ex- <b>12.3R12.4</b> <br>  / dev / md5 8.1M 3.5M 4.0M 47% / packages / mfs-jdocs-ex <br>  / dev / md6 6.2M 6.2M 0B 100% /packages/mnt/jdocs-ex-12.3R12.4 <br>  / dev / md7 43M 39M 616K 98% / packages / mfs-jkernel-ex <br>  / dev / md8 109M 109M 0B 100% /packages/mnt/jkernel-ex-12.3R12.4 <br>  / dev / md9 12M 7.9M 3.6M 69% / packages / mfs-jpfe-ex45x <br>  / dev / md10 22M 22M 0B 100% /packages/mnt/jpfe-ex45x-12.3R12.4 <br>  / dev / md11 17M 12M 3.2M 79% / packages / mfs-jroute-ex <br>  / dev / md12 38M 38M 0B 100% /packages/mnt/jroute-ex-12.3R12.4 <br>  / dev / md13 12M 7.2M 3.6M 67% / packages / mfs-jswitch-ex <br>  / dev / md14 21M 21M 0B 100% /packages/mnt/jswitch-ex-12.3R12.4 <br>  / dev / md15 14M 9.5M 3.4M 73% / packages / mfs-jweb-ex <br>  / dev / md16 25M 25M 0B 100% /packages/mnt/jweb-ex-12.3R12.4 <br>  / dev / da0s3e 243M 20M 204M 9% / var <br>  / dev / md17 252M 12K 232M 0% / tmp <br>  / dev / da0s3d 727M 107M 561M 16% / var / tmp <br>  / dev / da0s4d 123M 494K 113M 0% / config <br>  / dev / md18 118M 22M 86M 20% / var / rundb <br>  procfs 4.0K 4.0K 0B 100% / proc <br>  / var / jail / etc 243M 20M 204M 9% /packages/mnt/jweb-ex-12.3R12.4/jail/var/etc <br>  / var / jail / run 243M 20M 204M 9% /packages/mnt/jweb-ex-12.3R12.4/jail/var/run <br>  / var / jail / tmp 243M 20M 204M 9% /packages/mnt/jweb-ex-12.3R12.4/jail/var/tmp <br>  / var / tmp 727M 107M 561M 16% /packages/mnt/jweb-ex-12.3R12.4/jail/var/tmp/uploads <br>  devfs 1.0K 1.0K 0B 100% /packages/mnt/jweb-ex-12.3R12.4/jail/dev <br><br>  {linecard: 0} <br>  user @ switch&gt; exit <br>  rlogin: connection closed <br>  {master: 1} <br>  user @ switch&gt; <br></div></div><br>  That's it!  The operating system was updated only on the second device, and on the first - the old one (pay attention to the version of the firmware file FPC0 and FPC1), therefore the VC logic deactivated it.  Anyway, the device is and you can try to update it again.  One problem - when updating, I followed the guides from Juniper and put the image in / var / tmp, respectively, it is now empty and you need to upload the image again.  I concentrate all attention on this switch and several times I try to update the system / reboot only it (member1 continues to work): <br><br><blockquote> <code>{master:1} <br> user@switch&gt; request system software add /var/tmp/jinstall-XXX.tgz validate member 0 <br> user@switch&gt; request system reboot member 0</code> </blockquote> <br>  At the end of the download / update process every time I see: <br><blockquote> <code>Installing disk0s3d:/jinstall-ex-4500-12.3R12.4-domestic-signed.tgz <br> Verified jinstall-ex-4500-12.3R12.4-domestic.tgz signed by PackageProduction_12_ 3_0 <br> mode = 040700, inum = 38, fs = /instrootmnt/var <br> panic: ffs_valloc: dup alloc <br> ###Entering boot mastership relinquish phase <br> KDB: enter: panic <br> ###Entering boot mastership relinquish phase <br> [thread pid 316 tid 100041 ] <br> Stopped at kdb_enter+0x1a0: addis r3, r0, -0x7fa4 <br> db&gt;</code> </blockquote> <br>  Despite the lack of knowledge in Unix, on which JunOS is based, the string "KDB: enter: panic" does not inspire optimism.  Among other things, the system crashes into system debugging mode (db&gt;), and this is really bad.  For reference: Juniper has a familiar console mode where a working piece of hardware is configured, you can enter the Unix command line as root and so on;  there is a loader loader mode&gt; for restoring and uploading an operating system image, roughly corresponding to rommon&gt; Cisco;  and there is a debug mode db&gt;, which appears when there are problems with the physical components of the device.  You can do very little in this mode if you are not a Juniper TAC engineer.  At that moment I don‚Äôt really understand what it is and, as a proud Windows user, I try to click ‚Äúnext‚Äù: <br><br><blockquote> <code>db&gt; help <br> DDB Quick Help <br> ------------------- <br> Type 'c' to continue, 'reset' or 'panic' to restart. <br> <br> print p examine x search set write <br> w delete d break dwatch watch dhwatch <br> hwatch step s continue c until next <br> match trace alltrace where bt call show <br> ps gdb reset kill watchdog thread panic <br> ddbdumpsys dumpsys halt reboot <br> db&gt; c <br> Uptime: 2m41s <br> Cannot dump. No dump device defined. <br> Automatic reboot in 15 seconds - press a key on the console to abort <br> Rebooting... <br> <br> ...   ... <br> <br> ***** FILE SYSTEM MARKED CLEAN ***** <br> switch (ttyu0) <br> login: user <br> Logging to master <br> ... <br> Connection to master failed, enabling local login <br> Password: <br> --- JUNOS 11.1R3.5 built 2011-06-25 01:18:46 UTC <br> {linecard:0} <br> user@switch&gt;</code> </blockquote> <br>  About a miracle - the system boots, albeit with the old version.  At that time, I did not realize that this old version is loaded from the <b>backup section</b> (slice alternate), since the updated version is written to the main section and in my case cannot be loaded from it.  Therefore, it is so important to update the bootloader whenever possible - this is another saving straw when problems arise.  As a remark: pay attention to the lines ‚ÄúLogging to master ... Connection to master failed‚Äù.  All devices united in VC have a single management console, that is, when connected, for example via SSH, we immediately get into the console of the master device.  Since in my case the VC is not operational, I get into the control mode of the local gland. <br><br>  In the process of work, I think of pouring an image of the OS on a workable RE and copy between VC members - this is faster and there is no need to constantly be distracted by WinSCP.  It works even in my case, since the communication channels between devices are active. <br><br><blockquote> <code>user@switch&gt; file copy fpc1:/var/tmp/jinstall-XXX.tgz fpc0:/var/tmp/jinstall-XXX.tgz</code> </blockquote> <br>  Nevertheless, an attempt to update and reboot each time gives the same result - I find myself on the system debug mode, followed by the ability to download the old version.  Accordingly, the problem is constant and I will not achieve anything by repeating the steps.  Then it occurs to me when I have a device, since I have a device with a working system (member1) and there is a flash drive on which you can roll a snapshot and boot from it.  So I do: <br><br><blockquote> <code>{master:1} <br> umass1: SanDisk Corporation U3 Cruzer Micro, rev 2.00/0.10, addr 4 <br> <b>da1</b> at umass-sim1 bus 1 target 0 lun 0 <br> <b>da1</b> : &lt;SanDisk U3 Cruzer Micro 2.15&gt; Removable Direct Access SCSI-2 device <br> da1: 40.000MB/s transfers <br> da1: 973MB (1994385 512 byte sectors: 64H 32S/T 973C) <br> user@switch&gt; request system snapshot local partition media external <br> user@switch&gt; show system snapshot media external <br> fpc0: <br> -------------------------------------------------------------------------- <br> error: external media missing or invalid <br> <br> fpc1: <br> -------------------------------------------------------------------------- <br> Information for snapshot on external ( <b>/dev/da1s1a</b> ) (backup) <br> Creation date: Jun 2 02:28:20 2016 <br> JUNOS version on snapshot: <br> jbase : 11.1R3.5 <br> jkernel-ex: 11.1R3.5 <br> jcrypto-ex: 11.1R3.5 <br> jdocs-ex: 11.1R3.5 <br> jswitch-ex: 11.1R3.5 <br> jpfe-ex45x: 11.1R3.5 <br> jroute-ex: 11.1R3.5 <br> jweb-ex: 11.1R3.5 <br> Information for snapshot on external ( <b>/dev/da1s2a</b> ) (primary) <br> Creation date: Jun 2 02:29:21 2016 <br> JUNOS version on snapshot: <br> jbase : ex-12.3R12.4 <br> jkernel-ex: 12.3R12.4 <br> jcrypto-ex: 12.3R12.4 <br> jdocs-ex: 12.3R12.4 <br> jswitch-ex: 12.3R12.4 <br> jpfe-ex45x: 12.3R12.4 <br> jroute-ex: 12.3R12.4 <br> jweb-ex: 12.3R12.4 <br> fips-mode-powerpc: 12.3R12.4</code> </blockquote> <br>  Pay attention to the messages when you connect a flash drive - it was defined as a system device da1, it will be needed in the future.  Snapshot on the external flash drive repeats itself on the internal storage device - version 12.3 on the main partition (/ dev / da1s2a) and 11.1 - on the backup (/ dev / da1s1a).  Slice names can also be useful if you want to boot the system from a specific partition.  I insert the USB flash drive into the problem device and continue: <br><br><blockquote> <code>user@switch&gt; request session member 0 <br> --- JUNOS 11.1R3.5 built 2011-06-25 01:18:46 UTC <br> {linecard:0} <br> user@switch&gt; request system reboot member 0 media external <br> Reboot the system ? [yes,no] (no) yes <br></code> </blockquote><br>  Here again, as a precaution, I entered the local device control session, most likely it was possible to overload member0 from the wizard console.  When I restart, I see a constantly cyclic sequence: <br><br><blockquote> <code>U-Boot 1.1.6 (Mar 26 2011 - 04:34:19) <br> Board: EX4500-40F 10.4 <br> EPLD: Version 6.2 (0x81) <br> DRAM: Initializing (1024 MB) <br> FLASH: 8 MB <br> Firmware Version: 01.00.00 <br> USB: scanning bus for devices... 3 USB Device(s) found <br> scanning bus for storage devices... 1 Storage Device(s) found <br> ELF file is 32 bit <br> Consoles: U-Boot console <br> FreeBSD/PowerPC U-Boot bootstrap loader, Revision 2.4 <br> (hmerge@svl-junos-pool130.juniper.net, Sat Mar 26 02:46:28 PDT 2011) <br> Memory: 1024MB <br> bootsequencing is enabled <br> bootsuccess is not set <br> new boot device = disk2 <br> <b>can't load '/kernel' <br> can't load '/kernel.old' <br> Press Enter to stop auto bootsequencing and to enter loader prompt.</b> <br> Watchdog timed out. Resetting the board.</code> </blockquote> <br>  Switch nowhere further these repeating lines does not move.  What the?!?  Can't find the core?  After a while I pay attention to the penultimate line, press Enter and get into the loader: <br><br><blockquote> <code>loader&gt; ? <br> Available commands: <br> bcachestat get disk block cache stats <br> boot boot a file or loaded kernel <br> autoboot boot automatically after a delay <br> help detailed help <br> ? list commands <br> show show variable(s) <br> set set a variable <br> unset unset a variable <br> echo echo arguments <br> read read input from the terminal <br> more show contents of a file <br> nextboot set next boot device <br> lsdev list all devices <br> install install JUNOS <br> include read commands from a file <br> ls list files <br> load load a kernel or module <br> unload unload all modules <br> lsmod list loaded modules <br> export export variables to U-Boot environment <br> save save U-Boot environment <br> heap show heap usage</code> </blockquote> <br>  Thin, but still better than a cyclic reboot.  The loader mode itself is just created for system recovery, that is, I'm in the right place.  The work time has exceeded 2 hours ... I try different versions of the system image layout and update - with no result. <br><br><blockquote> <code>loader&gt; install /var/tmp/jinstall-ex-4500-12.3R12.4-domestic-signed.tgz <br> invalid URL <br> loader&gt; install --format file:///jinstall-ex-4500-12.3R12.4-domestic-signed.tgz <br> cannot open package (error 22) <br> loader&gt; install --format file:///jinstall-ex-4500-12.3R12.4-domestic-signed.tgz <br> Device NOT ready <br> Request Sense returned 06 28 00 <br> cannot open package (error 5) <br></code> </blockquote><br>  Actually, these lines should work, but for some reason they don‚Äôt work - either at that time I didn‚Äôt understand anything, or something else.  I see the same cyclic reboot and swear at the lack of a kernel.  During the constant reboot, another interesting thing pops up: <br><br><blockquote> <code>Firmware Version: 01.00.00 <br> USB: scanning bus for devices... 3 USB Device(s) found <br> scanning bus for storage devices... <b>1 Storage Device(s) found</b> <br> ELF file is 32 bit <br> Consoles: U-Boot console <br> FreeBSD/PowerPC U-Boot bootstrap loader, Revision 2.4 <br> (hmerge@svl-junos-pool130.juniper.net, Sat Mar 26 02:46:28 PDT 2011) <br> Memory: 1024MB <br> bootsequencing is enabled <br> bootsuccess is not set <br> <b>new boot device = disk2</b></code> </blockquote> <br>  For me, at that moment, this is nothing more than an assumption, but bearing in mind that Juniper stands for devices with 0, it seems strange to me to have a ‚Äúdisk2‚Äù - I have one flash drive.  In addition, when I inserted the flash drive, it was identified as da1.  If you go back a little, you can see that the device tried to boot from disk 2 immediately after rebooting from the console (when I indicated the external flash drive as a device for booting), but I haven‚Äôt noticed it until now.  We return to the loader and confirm the concerns, there is no disk 2, and the flash drive is a zero device: <br><br><blockquote> <code>loader&gt; lsdev <br> disk devices: <br> disk0 - USB storage device 0 <br> net devices: <br> net0: <br> loader&gt; nextboot disk0: <br> loader&gt; reboot <br> Resetting...</code> </blockquote> <br>  Everything?  But how not so!  The system is again trying to boot from disk 2, but now I feel that the right way.  Along the way, I'm sorting out nearby options with different slices on a flash drive (nextboot diskXsY), with no result.  Already almost desperate, I find the information that the boot device should be set as an environment variable from U-boot mode.  I don‚Äôt know how to describe this fourth mode and what can be done there, but you can get there by interrupting the boot process by pressing Ctrl + C at the very beginning, when the system polls USB devices (USB: scanning bus for devices ...).  The first line contains INTERRUPT in &lt;&gt; delimiters, but because of it the markup and fonts move down, so the delimiters removed: <br><br><blockquote> <code>=&gt; INTERRUPT <br> =&gt; setenv loaddev disk1 <br> =&gt; saveenv <br> Saving Environment to Flash... <br> . done <br> Un-Protected 1 sectors <br> Erasing Flash... <br> . done <br> Erased 1 sectors <br> Writing to Flash... writing to flash... <br> done <br> . done <br> Protected 1 sectors <br> =&gt; reset <br> <br> ...... <br> <br> ... <br> Boot media /dev/da1 has dual root support <br> <b>WARNING: JUNOS versions running on dual partitions are not same</b> <br> ** /dev/da1s1a <br> FILE SYSTEM CLEAN; SKIPPING CHECKS <br> clean, 274948 free (84 frags, 34358 blocks, 0.0% fragmentation) <br> switch (ttyu0) <br> login: user <br> Logging to master <br> ... <br> <b>Connection to master failed, enabling local login</b> <br> Password: <br> <br> --- JUNOS 12.3R12.4 built 2016-01-20 04:27:51 UTC <br> <b>warning: This chassis is operating in a non-master role as part of a virtual-chassis (VC) system.</b> <br> warning: Use of interactive commands should be limited to debugging and VC Port operations. <br> warning: Full CLI access is provided by the Virtual Chassis Master (VC-M) chassis. <br> warning: The VC-M can be identified through the show virtual-chassis status command executed at this console. <br> warning: Please logout and log into the VC-M to use CLI. <br> {linecard:1} <br> user@switch&gt; <br> <br> <b>WARNING: cli has been replaced by an updated version:</b> <br> CLI release <b>12.3R12.4</b> built by builder on 2016-01-20 03:55:45 UTC <br> Restart cli using the new version ? [yes,no] (yes) <br> <br> Restarting cli ... <br> {master:0} <br> user@switch&gt; <br></code> </blockquote><br>  Let's see what I saw after the reboot: <br><br>  "WARNING: JUNOS versions running on dual partitions are not the same" is not terrible and expected, because the new version is contained only in the main slice of the device. <br><br>  "Connection to master failed ..." and "warning: This chassis is operating in a non-master role ..." is not a problem, as the VC needs time to reconnect with the members and synchronize the configuration. <br><br>  After a few minutes of waiting, the system itself asks to restart the console (WARNING: cli has been replaced by an updated version) and now the new version is loaded on the correct RE. <br><br>  Checking: <br><br><blockquote> <code>user@switch&gt; show chassis routing-engine <br> Routing Engine status: <br> Slot 0: <br> Current state Master <br> DRAM 1024 <br> Memory utilization 50 percent <br> CPU utilization: <br> User 43 percent <br> Background 0 percent <br> Kernel 24 percent <br> Interrupt 1 percent <br> Idle 32 percent <br> Model EX4500-40F <br> Serial ID <br> Start time 2016-06-02 03:43:20 <br> Uptime 3 minutes, 22 seconds <br> Last reboot reason Router rebooted after a normal shutdown. <br> Load averages: 1 minute 5 minute 15 minute <br> 2.40 1.12 0.46 <br> Routing Engine status: <br> Slot 1: <br> Current state Backup <br> DRAM 1024 <br> Memory utilization 44 percent <br> CPU utilization: <br> User 40 percent <br> Background 0 percent <br> Kernel 30 percent <br> Interrupt 1 percent <br> Idle 28 percent <br> Model EX4500-40F <br> Serial ID <br> Start time 2016-06-02 01:28:45 <br> Uptime 2 hours, 17 minutes, 57 seconds <br> Last reboot reason Router rebooted after a normal shutdown. <br> Load averages: 1 minute 5 minute 15 minute <br> 0.49 0.46 0.44 <br> <br> {master:0} <br> user@switch&gt; <br> show virtual-chassis <br> <br> Preprovisioned Virtual Chassis <br> Virtual Chassis ID: <br> Virtual Chassis Mode: Enabled <br> Mstr Mixed Neighbor List <br> Member ID Status Serial No Model prio Role Mode ID Interface <br> 0 (FPC 0) Prsnt ex4500-40f  129 Master* N 1 vcp-1 <br> 1 vcp-0 <br> 1 (FPC 1) Prsnt ex4500-40f  129 Backup N 0 vcp-1 <br> 0 vcp-0 <br> <br> {master:0}</code> </blockquote> <br>  Victory!  Complete and unconditional!  To say that I was pleased with myself - to say nothing, CSW just went off scale.  Despite the fact that my work lasted about 4 hours, it was no longer so important, because the customers did not feel it.  I not only gave myself a virtual medal, but also saved a lot of money to my company.  I got so many impressions during these 4 hours that then it took many days (and beer) to put everything together and understand the full picture. <br><br>  Now it remains only to make snapshots to the internal storage in the main section and, after a week or two, to the backup.  Why in a week - for running in a new version in production, since downloading the old version of the system from the backup section is much easier than downgrading it on the entire device. <br><br>  Let's analyze the situation. <br><br>  According to Juniper TAC, problems with the upgrade arose due to damage to the main boot partition.  You can‚Äôt do anything about it and the switch should be handed over under warranty.  I still really hope that the problem was caused by file system corruption (incorrect reboot or the like) and was fixed during the update process (Un-Protected 1 sectors Erasing Flash .... done) when I set the environment variable. <br><br>  What a fright the device wanted to boot from disk2, if nobody explicitly pointed at it and it wasn‚Äôt in the system - it‚Äôs not clear, TAC also found it difficult to comment.  In the logs, then it was even possible to trace that disk2 appears from nowhere (note that new boot device = disk1s2 changes to new boot device = disk2): <br><br><div class="spoiler">  <b class="spoiler_title">Change boot device</b> <div class="spoiler_text">  user @ switch&gt; request system reboot member 0 media external <br>  Reboot the system?  [yes, no] (no) yes <br>  Rebooting fpc0 <br>  *** FINAL System shutdown message from root @ switch *** System going down IMMEDIATELY {linecard: 0} <br>  iuriia @ CORE&gt; JWaiting (max 300 seconds) for system process `vnlru_mem 'to stop ... done <br>  Waiting (max 300 seconds) for system process `vnlru 'to stop ... done <br>  Waiting (max 300 seconds) for system process `bufdaemon 'to stop ... done <br>  Waiting (max 300 seconds) for system process syncer 'to stop ... <br>  Syncing disks, vnodes remaining ... 2 2 2 0 1 1 1 0 0 0 0 0 done <br>  syncing disks ... All buffers synced. <br>  Uptime: 23m53s <br>  recorded reboot as normal shutdown <br>  Rebooting ... <br>  U-Boot 1.1.6 (Mar 26 2011 - 04:34:19) <br>  Board: EX4500-40F 10.4 <br>  EPLD: Version 6.2 (0x82) <br>  DRAM: Initializing (1024 MB) <br>  FLASH: 8 MB <br>  Firmware Version: 01.00.00 <br>  USB: scanning bus for devices ... 3 USB Device (s) found <br>  scanning bus for storage devices ... 1 Storage Device (s) found <br>  ELF file is 32 bit <br>  Consoles: U-Boot console FreeBSD / PowerPC U-Boot bootstrap loader, Revision 2.4 (hmerge@svl-junos-pool130.juniper.net, Sat Mar 26 02:46:28 PDT 2011) Memory: 1024MB bootsequencing is enabled <br>  bootsuccess is set <br>  <b>new boot device = disk1s2:</b> <br><br>  can't load '/ kernel' can't load '/kernel.old' Press Enter to stop auto bootsequencing and to enter loader prompt.  Watchdog timed out.  Resetting the board. <br>  U-Boot 1.1.6 (Mar 26 2011 - 04:34:19) <br>  Board: EX4500-40F 10.4 <br>  EPLD: Version 6.2 (0x81) <br>  DRAM: Initializing (1024 MB) <br>  FLASH: 8 MB <br>  Firmware Version: 01.00.00 <br>  USB: scanning bus for devices ... 3 USB Device (s) found <br>  scanning bus for storage devices ... 1 Storage Device (s) found <br>  ELF file is 32 bit <br>  Consoles: U-Boot console FreeBSD / PowerPC U-Boot bootstrap loader, Revision 2.4 (hmerge@svl-junos-pool130.juniper.net, Sat Mar 26 02:46:28 PDT 2011) Memory: 1024MB bootsequencing is enabled <br>  bootsuccess is not set <br>  <b>new boot device = disk2</b> <br></div></div><br>  In fact, this problem increased the time spent an hour and a half.  Yes, the switch also swears at the absence of the kernel, but why then the system tries to use disk2 if the system did not seem to see it in the loader&gt; it is not clear.  I can assume that in case of problems with booting, the device tries to cycle through the disks, but again the system did not see the disk2 device.  How and why then the same flash drive later successfully loaded the device also raises questions. <br><br>  It is possible that I was mistaken here: <br><br><blockquote> <code>loader&gt; nextboot disk0: <br> loader&gt; reboot</code> </blockquote> <br>  After all, when rebooting, the loader settings are lost.  You had to try ‚Äúboot‚Äù instead of ‚Äúreboot‚Äù, but then I did not. <br><br>  The new version of the system significantly increased the load on the device.  On the old version, the CPU usage during the day was about 27-30%, after the upgrade - 45-48%, but neither the device‚Äôs simple configuration nor the traffic characteristics changed.  After several remote sessions with Juniper TAC, the reason could not be established - there were assumptions about a memory leak and similar problems, but no.  Strange, but I had to accept as a fact. <br><br>  The attentive reader might have noticed that the device names displayed in the loader (disk0) and used for successful boot (disk1 and then / dev / da1s1a) are different.  What is the reason I will not venture to assert.  I can assume that the names change depending on the degree of successful loading of the system.  Loader loaded - got some device names, contacting from db&gt; - there will be others;  from the CLI, we generally call devices via ‚Äúmedia external‚Äù and ‚Äúmedia internal‚Äù.  In general, while only the assumption. <br><br>  Most of the above calculations and commands I put together in the guide long before the update.  After that, I periodically read and supplemented it, if possible problems occurred to me.  It wasn‚Äôt perhaps db&gt; mode and procedures ==&gt; setenv.  It is clear that everything did not work out and something did not work as it should.  But hand on heart - without this guide and time for his mental running in, I would have given up.  Especially since it was night work and the sharpness of the mind was reduced. <br><br>  Backups - although they did not help me much, their presence calmed the conscience and soul.  In the worst case, even if all the internal storage is damaged, I would copy the text config to the console.  These two points are a guarantee that you will concentrate on your work, rather than analyzing how to return everything to its original state and what to do next. <br><br>  Of the major shortcomings: in the process of work, I had several tabs running PuTTY, writing a log in one file.  Then it was very difficult to sort everything out according to individual devices and timestamps, it was better to use SecureCRT or run a separate window on different devices, especially since I had enough funds for this. <br><br>  And in the end - a picture from the scene.  I hope this post will be useful to you.  Good luck in the upcoming updates! <br><br><img src="https://habrastorage.org/files/0ee/9c2/6a2/0ee9c26a29bc490eb00a5fa32cbd0830.jpg"><br><br>  PS in the output of the commands I used the markup for the usual code ‚Äúcode‚Äù, which looks worse than the markup with the background of the source code of a specific language or BASH.  However, the ‚Äúcode‚Äù markup allows bold text selection, which was important for me to highlight interesting places in the output of commands.  If someone shares how to do both (background + bold inside), I will be grateful and promise to use in the future. <br>  Update: it turned out that in different browsers and versions, the markup of the code is displayed differently.  Trouble smoking further, how to make the text more visible and readable. </div><p>Source: <a href="https://habr.com/ru/post/320310/">https://habr.com/ru/post/320310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320300/index.html">How we created a hosting provider with our own data center</a></li>
<li><a href="../320302/index.html">Creating an encrypted Kali Linux Encrypted Persistence flash drive</a></li>
<li><a href="../320304/index.html">RGB color model history</a></li>
<li><a href="../320306/index.html">Async / await is a step back for javascript?</a></li>
<li><a href="../320308/index.html">It's time to play fair, Microsoft</a></li>
<li><a href="../320314/index.html">Technotrack: from college to leading IT-companies</a></li>
<li><a href="../320316/index.html">Docker implementation for a small project in Production</a></li>
<li><a href="../320318/index.html">Seven excellent site accelerators for Linux and Unix</a></li>
<li><a href="../320320/index.html">How is the League of Legends frame rendered?</a></li>
<li><a href="../320322/index.html">How to make localization for the Japanese market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>