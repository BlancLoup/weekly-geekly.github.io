<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unexpected exception filter behavior in C # 6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What are exception filters? 
 Exception Filters is a new C # 6 feature that allows you to set specific conditions for a catch . This block will be exe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unexpected exception filter behavior in C # 6</h1><div class="post__text post__text-html js-mediator-article"><h3>  What are exception filters? </h3><br>  <i>Exception Filters</i> is a new C # 6 feature that allows you to set specific conditions for a <code>catch</code> .  This block will be executed only if the specified conditions are met.  We illustrate the syntax with a small code snippet: <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void Main() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"E2"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) when(ex.Message == <span class="hljs-string"><span class="hljs-string">"E1"</span></span>) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"caught E1"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) when(ex.Message == <span class="hljs-string"><span class="hljs-string">"E2"</span></span>) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"caught E2"</span></span>); } }</code> </pre><a name="habracut"></a><br><h3>  Is this really a new feature? </h3><br>  For C #, yes.  However, support for exception filters has long been present in IL and VB.NET.  Even F # supports these filters through a mechanism called exception pattern matching. <br><br><h3>  Can we get this functionality with the help of ordinary conditional statements? </h3><br>  Logically, yes, but there is a fundamental difference.  If the condition is inside a <code>catch</code> block, the exception will be caught first, and then the condition will be checked.  Exception filters check the condition before an exception is caught.  If the condition is not met, then the <code>catch</code> block will be skipped, .NET will proceed to consider the next <code>catch</code> block. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  So what's the difference? </h3><br>  When you catch an exception, you have an unwound stack, i.e.  lose important information about the exception.  There is an erroneous opinion that if we execute a <code>throw</code> inside a <code>catch</code> block instead of a <code>throw ex</code> , then we save the stack.  The fact is that people think only about the <code>StackTrace</code> exception <code>StackTrace</code> , but not about the CLR stack itself.  Let's take an example.  If you try to start it yourself, then make sure that the ‚ÄúBreak on Exception‚Äù checkbox for exceptions is turned off in the Visual Studio settings (Debug-&gt; Exceptions-&gt; Uncheck all). <br><br>  Consider a common scenario in which we catch an exception, log it and do nothing else.  The following image shows where the debugger stops when an exception is thrown.  Note the stop line of the debugger and the Locals window: <br><br><img src="https://habrastorage.org/files/d9e/d2c/ea8/d9ed2cea8b854bfd96d71860631f6eca.jpg"><br><br>  Now let's rewrite the example a bit using exception filters.  Let's make the <code>Log</code> method always return <code>false</code> and perform logging using exception filters instead of placing it inside the <code>catch</code> block.  Notice again the stop line of the debugger and the debugger window ( <i>Note: the post and example were updated, but the picture remained the same; instead of <code>catch (if(Log()))</code> should read <code>catch when (Log())</code></i> ): <br><br><img src="https://habrastorage.org/files/867/d43/3dc/867d433dc51442d1bc9329e0d1f56b57.jpg"><br><br>  <i>From the translator: the original picture is outdated, because in the recent past, the exclusion filter syntax has changed a bit: they were previously described using the <code>if</code> keyword, and now it has been replaced with a new <code>when</code> keyword.</i>  <i>Motivation is well illustrated by the following picture:</i> <br><br><img src="https://habrastorage.org/files/9db/eff/0a6/9dbeff0a67ec4fb4bfeafae1602da19f.png"><br><br>  In addition to information on where exactly the exception occurred, you can also see in the Locals window of the second example a local variable <code>localVariable</code> , which is not available in the first example, because it is not on the stack inside the <code>catch</code> block.  This corresponds to what we can see in crash dumps. <br><br>  In addition, if you enter a <code>catch</code> block, you will not enter the rest.  If you analyzed the condition and decided not to throw it out again, then you will not be able to get into other <code>catch</code> blocks.  In the case of exclusion filters, an unfulfilled condition does not prevent us from checking the remaining <code>catch</code> conditions to try to enter another block. <br><br><h3>  Expected behavior </h3><br>  Thus, we can specify a condition in the exception filter;  <code>catch</code> block will only be executed if the condition is met.  And we can use the <code>bool</code> function as a condition.  But what happens if the condition itself throws an exception?  The expected behavior is the following: the exception is ignored, the conditions are considered false.  Consider the following code: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { TestExceptionFilters(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestExceptionFilters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Original Exception"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) when (MyCondition()) { Console.WriteLine(ex); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyCondition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Condition Exception"</span></span>); } }</code> </pre><br>  When an <code>"Original Exception"</code> exception is thrown <code>"Original Exception"</code> before entering a <code>catch</code> MyCondition condition will be checked.  But this condition itself throws an exception, which should be ignored, and the condition should be considered false.  Thus, we get an unhandled exception: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: Original <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span></code> </pre><br><h3>  Unexpected behavior </h3><br>  It is time for a strange example.  Let's change the above code so that instead of directly calling the <code>TestExceptionFilters()</code> method, this method will be invoked through reflection.  The expected behavior remains the same, although we call the function differently. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetMethod = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Program).GetMethod(<span class="hljs-string"><span class="hljs-string">"TestExceptionFilters"</span></span>); targetMethod.Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestExceptionFilters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Original exception"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) when (MyCondition()) { Console.WriteLine(ex); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyCondition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Condition Exception"</span></span>); } }</code> </pre><br>  Let's run this code.  As expected, we will get an unhandled exception, but the exception type will be different: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: Condition <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span></code> </pre><br>  Thus, the type of exception depends on the way we called the function.  About this bug got an issue on GitHub ( <a href="https://github.com/dotnet/coreclr/issues/410">Exception filters</a> ).  At the time of writing the translation, the bug is still present in CoreCLR.  Let's hope that someone will fix it soon. <br><br>  <i>From the translator: this post is an integral translation of two posts at once from the site <a href="http://www.volatileread.com/">www.volatileread.com</a> : <a href="http://www.volatileread.com/Wiki/Index%3Fid%3D2095">Unpredictable Behavior With C # 6 Exception Filters</a> and <a href="http://www.volatileread.com/Wiki/Index%3Fid%3D1087">C # 6 Exception Filters</a></i> </div><p>Source: <a href="https://habr.com/ru/post/252437/">https://habr.com/ru/post/252437/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252419/index.html">C #: how not to "shoot yourself in the leg"</a></li>
<li><a href="../252421/index.html">A hundred lines of code for the beloved</a></li>
<li><a href="../252429/index.html">DICOM Viewer from the inside. Voxel render</a></li>
<li><a href="../252433/index.html">HSTS-based super cookies will track you even in private mode</a></li>
<li><a href="../252435/index.html">Configuring Amazon Elastic Load Balancing: with email forwarding and redirects</a></li>
<li><a href="../252439/index.html">Auto registration of tests on C language tools</a></li>
<li><a href="../252441/index.html">Reconnect - Facebook Login Vulnerability</a></li>
<li><a href="../252443/index.html">Documentation in Doxygen</a></li>
<li><a href="../252445/index.html">Fragmented video stream compression method</a></li>
<li><a href="../252447/index.html">Overview of the video on Go c FOSDEM 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>