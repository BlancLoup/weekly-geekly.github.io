<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network for the smallest. Micro Issue number 3. IBGP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All issues  8. Networks for the smallest. Part Eight BGP and IP SLA 
 7. Networks for the smallest. Part Seven. VPN 
 6. Networks for the smallest. Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network for the smallest. Micro Issue number 3. IBGP</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">All issues</b> <div class="spoiler_text">  <a href="http://linkmeup.ru/blog/65.html">8. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/65.html">Part Eight</a>  <a href="http://linkmeup.ru/blog/65.html">BGP and IP SLA</a> <br>  <a href="http://linkmeup.ru/blog/50.html">7. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/50.html">Part Seven.</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br>  <a href="http://linkmeup.ru/blog/33.html">6. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/33.html">Part six.</a>  <a href="http://linkmeup.ru/blog/33.html">Dynamic routing</a> <br>  <a href="http://linkmeup.ru/blog/16.html">5. Networks for the smallest: Part Five.</a>  <a href="http://linkmeup.ru/blog/16.html">NAT and ACL</a> <br>  <a href="http://linkmeup.ru/blog/15.html">4. Networks for the smallest: Part Four.</a>  <a href="http://linkmeup.ru/blog/15.html">STP</a> <br>  <a href="http://linkmeup.ru/blog/14.html">3. Networks for the smallest: Part Three.</a>  <a href="http://linkmeup.ru/blog/14.html">Static routing</a> <br>  <a href="http://linkmeup.ru/blog/13.html">2. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a>  <a href="http://linkmeup.ru/blog/13.html">Switching</a> <br>  <a href="http://linkmeup.ru/blog/12.html">1. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a>  <a href="http://linkmeup.ru/blog/12.html">Connection to the equipment cisco</a> <br>  <a href="http://linkmeup.ru/blog/11.html">0. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/11.html">Part zero.</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div><br><br>  How long did the history of linkmeup, but the company grew, developed?  The number of routers is already dozens of, its own fiber-optic lines, a developed network in the city.  And it was decided to form the company as a provider and provide Internet access services for third-party organizations. <br>  By itself, the administrative task - a license there, search for a client base, advertising, put SORM. <br>  Of course, on the technical side, preparations are also needed - calculate the resources, capacities, ports, prepare a QoS policy.  But all this (with the exception of QoS) is a routine. <br><br>  We want to talk about something else - IBGP.  Perhaps the topic will seem a little far-fetched, they say, the internal BGP is the prerogative of quite large providers. <br>  However, this is not the case; now iBGP is involved in enterpraces almost no more often than in providers.  For the sole purpose of internal routing.  For example, for the sake of VPN is a very popular BGP-based application in a corporate environment.  For example, the ability to organize perimeters, isolated on L3, on the already used infrastructure is very valuable.  And there may be some fifty or even ten prefixes.  Not at all Full View, but still comfortable. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It may not be relevant to our Linkmeup network, but it will be completely unforgivable to avoid such a concept.  Therefore, we assume that the network is large enough, and we have a need for BGP in the core. <br><br>  Today we will discuss <br><ul><li>  When do you need IBGP </li><li>  What are the differences from EBGP </li><li>  Route Reflectors </li><li>  Confederation </li><li>  BGP attributes not covered in the main article </li></ul><br><br>  Traditional video <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/oFTLaWkGvfE%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700190,15700253,15700256&amp;usg=ALkJrhhLsV39wHYQknGahtmYJ3IlWn72yA" frameborder="0" allowfullscreen=""></iframe><br><br>  <i>The challenges in this release are not directly related to IBGP, it‚Äôs rather BGP in general.</i>  <i>It will be interesting to both beginners to break their heads, and old-timers to warm up</i> <br><br><a name="habracut"></a><br><br><h1>  What is IBGP? </h1><br>  Let's start with the fact that such a Internal BGP.  In essence, this is the same BGP, but <b>inside the</b> AS.  It is even configured almost the same. <br>  There are two main applications: <br>  <b>Reservation</b>  When there are several links to providers and you don‚Äôt want to close everything on one of your border routers (the so-called boredre (from the Old Slavic border), several routers are put, and between them IBGP rises so that they always have relevant information about all routes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a4/0ed/5f0/5a40ed5f0eec37530c633bdaff1d695c.png"><br><br>  In case of problems, the ISP2 R2 provider will know that the same networks are available through ISP1.  He will be informed about this by R1 via IBGP. <br><br>  <b>Connecting clients by BGP</b> .  If there is a task to connect a client via BGP, and you have more than one router, you cannot do without IBGP. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a7/600/fd8/1a7600fd8e9f04ad4585afe38b9abac4.png"><br><br>  In order for R4 to transfer 1 Full View to the Client, it must receive it via IBGP from R1 or R2. <br><br>  Again, EBGP is used <b>between</b> Automnom Systems, IBGP - <b>inside</b> . <br><br><h1>  Differences between IBGP and EBGP </h1><br>  <b>1) The main subtlety</b> that appears when moving inside the Autonomous System and from where the legs of almost all differences grow are loops.  In EBGP, we dealt with them using AS-Path.  If the list already had its own AS number, then such a route was discarded. <br>  But, as you remember, when passing a route within the Autonomous System, AS-Path does not change.  Instead, IBGP resorts to tricks: a <b>fully connected topology</b> is used ‚Äî all neighbors have sessions with all ‚Äî <b>Full Mesh</b> . <br>  At the same time, the route received from the IBGP neighbor is not announced to other IBGP neighbors. <br>  This allows all routers to have all the routes and avoid loops. <br><br>  Let's explain with examples. <br><br>  How could this be in such a topology, for example, if you do not use loop avoidance technology: <br><img src="https://habrastorage.org/getpro/habr/post_images/a42/71f/13b/a4271f13b873e4e74b336ada2e69d5a7.png"><br>  R1 received an announcement from an EBGP neighbor, passed it to R2, he passed it to R3, R3 passed it to R4.  It seems that all well done, everyone knows where the Internet is.  But R4 transmits this announcement back to R1. <br><img src="https://habrastorage.org/getpro/habr/post_images/417/9ef/7f3/4179ef7f36a2c7cd5780f5c82f03bdeb.gif"><br>  R1 received the route from R4, and at a profit it is exactly the same as the original from the ISP - AS-Path has not changed.  Therefore, even a new route from R4 can be selected as a priority, which, of course, is unwise: not only are the routes not correctly studied, so the traffic may eventually stop and will not get to the destination. <br><img src="https://habrastorage.org/getpro/habr/post_images/ca5/78c/b17/ca578cb17787a3cf02c75de71ed182c1.gif"><br><br>  In the case of a fully connected topology and the Split Horizon rule, this situation is excluded.  R1, having received an announcement from ISP1, sends it to all its neighbors at once: R2, R3, R4.  And those, in turn, retain these announcements, but transmit only to EBGP partners, but not IBGP, precisely because they were received from an IBGP partner.  That is, all BGP routers have up-to-date information and loops are excluded. <br><img src="https://habrastorage.org/getpro/habr/post_images/bd1/7cd/3b4/bd17cd3b4c18eabdfa0f6d113f93195a.png"><br><br>  Moreover, it does not matter if the neighbors are connected directly or through intermediate routers.  For example, in the above scheme, R1 does not have a connection with R3 directly - they communicate via R2, but this does not prevent them from establishing a TCP session and BGP on top of it. <br><blockquote>  The concept of Split Horizon is used here in a broader sense.  If in RIP it meant ‚Äúnot to send announcements back to the <b>interface where they came from</b> ‚Äù, to IBGP it means ‚Äúnot to send announcements from IBGP partners to <b>other IBGP partners</b> .‚Äù <br></blockquote><br><br>  <b>2) The second subtlety is the address of Next Hop</b> .  In the case of External BGP, the router, when sending an announcement to its EBGP neighbor, first changes the address of the Next-Hop to its own, and then sends it.  It is quite logical action. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/577/cf8/2ff/577cf82ff7cc303beaf04319b8d1bd1b.png"><br>  Here's how the announcement of the network 103.0.0.0/22 ‚Äã‚Äãlooks like when transferring from R5 to R1: <br><br> <a href="http://fotki.yandex.ru/users/ait-it/view/815298/"><img src="https://habrastorage.org/getpro/habr/post_images/5db/eab/be1/5dbeabbe1a6135810f2470d9d1340c3b.png" width="1124" height="381"></a> <br><br>  If the router sends an announcement to the IBGP neighbor, then the Next-Hop address does not change.  Hm  Unclear.  Why?  This is at odds with the usual understanding of the DV-routing protocol. <br><br>  Here is the same announcement when transferring from R1 r R2: <br><br> <a href="http://fotki.yandex.ru/users/ait-it/view/815299/"><img src="https://habrastorage.org/getpro/habr/post_images/976/1ca/de9/9761cade9aa4bd1258fd219602046b53.png" width="1003" height="374"></a> <br><br>  The fact is that here the concept of Next-Hop is different from that used in IGP.  In IBGP, it reports the exit point from the local AS. <br><img src="https://habrastorage.org/getpro/habr/post_images/a90/d02/a5d/a90d02a5d91855553429b3786e8a33ae.png"><br><br>  And here another moment arises - it is important that the recipient of such an announcement had a route to Next-Hop - this is the first thing that is checked when choosing the best route.  If it does not exist, the route will be placed in the BGP table, but it will not be in the routing table. <br><br>  This process is called recursive routing. <br><br>  That is, in order for R2 to send ISP1 packets, it must know how to get to the address 101.0.0.1, which in this scheme is Next-Hop for the network 103.0.0.0/22. <br><br>  In principle, almost all of the equipment makes it possible to change the Next-Hop address to your own when sending a route to an IBGP neighbor. <br>  On a tsiska, this is done by the " <b>neighbor XYZ Next-Hop-self</b> " command.  You will see later how this applies. <br><br>  <b>3) The third point</b> : if the EBGP usually implies a direct connection of two neighbors to each other, in the Internal BGP neighbors can be connected through several intermediate devices. <br><br><blockquote>  In fact, EBGP can also be set up for neighbors who are a few hops from each other and this is actually practiced, for example, when setting up Inter-AS Option C. This business is called MultiHop BGP and is activated with the command " <b>neighbor XYZ ebgp-multihop</b> "in BGP configuration mode. <br>  But for IBGP, this works by default. <br></blockquote><br>  This allows you to set up an IBGP partnership between Loopback addresses.  This is done in order not to become attached to the physical interfaces - in case of the main link falling, the BGP session will not be interrupted, because the loopback will be available through the backup. <br>  This is the most common practice. <br><br>  However, EBGP is usually installed on link addresses, because as a rule there is only one connection and if it fails, the Loopback will still not be available.  Yes, and I still don‚Äôt really want to configure some additional routing with the provider. <br><br>  An example of the configuration of such a neighborhood: <br><img src="https://habrastorage.org/getpro/habr/post_images/f54/fa8/bb7/f54fa8bb709897c3fcfa243e66f4d6ea.png"><br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/93.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/93.html"><b>Problem number 1</b></a> <br><br>  Scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/11a/e3f/b64/11ae3fb64e690fef385cff3bb402cccc.png"><br><br>  In this scenario, we have two BGP routers R1 and R3, but they are located in different parts of the city and are connected via an intermediate router on which BGP is not configured. <br><br>  Condition: <br>  The IBGP session is perfectly established, even though the intermediate BGP router is not enabled, and we even see the routes: <br><img src="https://habrastorage.org/getpro/habr/post_images/b2a/aff/3f8/b2aaff3f856705ebb4832be22f0d1a67.png"><br><br>  But where is the ping? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/517/fca/f68/517fcaf68237d7a992082e291d73de9f.png"><br><br>  Details of the problem <a href="http://linkmeup.ru/blog/93.html">here</a> . <br>  ===================== <br><br>  You need to try to avoid situations where there are non-BGP routers between IBGP neighbors. <br><br><blockquote>  In fact, there is a mechanism that allows if not corrected, then at least to prevent such a situation - IGP Synchronization.  It will not allow the route to be added to the table if the exact same route is not known through IGP.  This to some extent ensures that intermediate devices, regardless of whether BGP is activated on them or not, will have the necessary routes. <br>  But I do not know those desperado who decided to enable IGP Synchronization. <br>  First, how will such routes get to IGP?  Only redistribution.  Now imagine how Full View slowly fills LSDB OSPF, penetrating into remote corners of memory and forcing the processor to look for the shortest possible routes until exhausted.  Do you want <a href="http://habrahabr.ru/company/yandex/blog/126709/">this</a> ? <br>  And, secondly, resulting from the ‚Äúfirst‚Äù, by default, IGP-synchronization is turned off on almost all modern routers. <br></blockquote><br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/94.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/94.html"><b>Problem number 2</b></a> <br>  A link appeared between AS64504 and AS64509, which links them directly.  Both networks used OSPF and seamlessly combined the network into one.  But, after verification, it turned out that the traffic goes through AS64500, and not directly from AS64504 to AS64509, through OSPF. <br>  Change BGP configuration: <br>  - R7 must use OSPF if traffic goes to the network 109.0.0.0/24 <br>  - R9 must use OSPF if traffic goes to the network 104.0.0.0/24 <br><br>  Details of the task <a href="http://linkmeup.ru/blog/94.html">here</a> <br>  ===================== <br><br><h2>  BGP practice </h2><br>  Let's now go back to the network linkmeup and try to run BGP in it. <br><br>  The scheme will be as follows (on click more detailed with interfaces and IP-addresses): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/bad/c5a/782/badc5a782eb316777fc89bcfa7b30f58.png"></a> <br>  As you can see, we have significantly modified it.  Abandoned the naming of devices by geolocation and functions, changed the addressing for the sake of ease of remembering and understanding. <br><br>  The routers will be called R <i>X</i> , the fine subnet between the routers R <i>X</i> and R <i>Y</i> is assigned as follows: 10.0.  <i>XY</i> .0 / 24.  Addresses are respectively 10.0.  <i>Xy.</i>  <i><b>X</b></i> at R <i>X</i> and 10.0.  <i>Xy.</i>  <i><b>Y</b></i> y <i>ry</i> . <br><br>  From above, everything remains the same as in the <a href="http://habrahabr.ru/post/184350/">main article on BGP</a> . <br>  And below was added our first commercial client that connected via BGP. <br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/95.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/95.html"><b>Problem number 3</b></a> <br><br>  Our new client AS 64504 is connected to our network.  And in the future, he plans to connect to another provider and he already has his PI-block of addresses.  But at this stage, there is a connection only to our AS and therefore the client can use the private AS number. <br>  Task: When a client network is announced to higher providers, remove the AS64504 private number. <br>  Configuration and scheme: <a href="https://docs.google.com/document/d/1WFjksUR5aD2KhuN_ypA1IOMFavRzOX6p5ledbhyAN8o/pub">basic</a> . <br><br>  Details of the problem <a href="http://linkmeup.ru/blog/95.html">here</a> . <br>  ===================== <br><br><h5>  EBGP </h5><br>  I think you should not stop at setting up and working EBGP - we did it in the last article. <br>  Just for example, we give the session configuration with a new client: <br><br>  <b>R4</b> <br><pre><code class="bash hljs">interface FastEthernet1/0 ip address 100.0.0.5 255.255.255.252 router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 100.0.0.6 remote-as 64504</code> </pre>  <b>R7</b> <br><pre> <code class="bash hljs">interface Loopback1 ip address 130.0.0.1 255.255.255.255 ! interface FastEthernet0/0 ip address 100.0.0.6 255.255.255.252 ! router bgp 64504 network 130.0.0.0 mask 255.255.255.0 neighbor 100.0.0.5 remote-as 64500</code> </pre><br><br>  Everything is simple and clear, after setting up all external neighbors, we will have the following situation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/88b/ab1/a7a/88bab1a7a3f90fdcdcf5b347afd72d42.png"><div class="spoiler">  <b class="spoiler_title">On other devices</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/8c6/43d/a2c/8c643da2cbd8032594304c756099b952.png"><img src="https://habrastorage.org/getpro/habr/post_images/b2a/9e8/f4b/b2a9e8f4b6ecd311bc299cb6f09454df.png"><img src="https://habrastorage.org/getpro/habr/post_images/2ff/13b/087/2ff13b087788a0644eaed2511c57138b.png"></div></div><br><br>  Each BGP router knows only about those networks that it received directly from its EBGP neighbor. <br><br><h4>  IBGP </h4><br>  Now let's turn to the configuration of our AS routers from the point of view of IBGP. <br><br>  First, as we said earlier, IBGP is usually installed between Loopback interfaces to increase availability, so first of all we will create them: <br><br>  On all routers on the Loopback0 interface, configure the IP address XXXX, where X is the router number (this is for example only and do not even think of doing it on a real network): <br><br>  <b>R1</b> <br><pre> <code class="bash hljs">interface Loopback0 ip address 1.1.1.1 255.255.255.255</code> </pre>  <b>R2</b> <br><pre> <code class="bash hljs"> interface Loopback0 ip address 2.2.2.2 255.255.255.255</code> </pre>  <b>R3</b> <br><pre> <code class="bash hljs">interface Loopback0 ip address 3.3.3.3 255.255.255.255</code> </pre>  <b>R4</b> <br><pre> <code class="bash hljs">interface Loopback0 ip address 4.4.4.4 255.255.255.255</code> </pre><br><br>  They will become the Router ID for both OSPF and BGP. <br><br>  By the way, about OSPF.  As a rule, IBGP ‚Äústretches‚Äù over the existing IGP on the network.  IGP provides connectivity of all routers to each other over IP, a quick response to changes in the topology and transfer of routing information about internal networks. <br><br><h5>  Configure internal routing.  Ospf </h5><br>  Actually this will go on. <br><br>  Our task is for everyone to know about all link subnets, addresses of Loopback interfaces and, of course, about our white addresses. <br><br>  OSPF configuration: <br>  <b>R1</b> <br><pre> <code class="bash hljs">router ospf 1 network 1.1.1.1 0.0.0.0 area 0 network 10.0.0.0 0.255.255.255 area 0 network 100.0.0.0 0.0.1.255 area 0</code> </pre>  <b>R2</b> <br><pre> <code class="bash hljs">router ospf 1 network 2.2.2.2 0.0.0.0 area 0 network 10.0.0.0 0.255.255.255 area 0 network 100.0.0.0 0.0.1.255 area 0</code> </pre>  <b>R3</b> <br><pre> <code class="bash hljs">router ospf 1 network 3.3.3.3 0.0.0.0 area 0 network 10.0.0.0 0.255.255.255 area 0 network 100.0.0.0 0.0.1.255 area 0</code> </pre>  <b>R4</b> <br><pre> <code class="bash hljs">router ospf 1 network 4.4.4.4 0.0.0.0 area 0 network 10.0.0.0 0.255.255.255 area 0 network 100.0.0.0 0.0.1.255 area 0</code> </pre><br><br>  After that, connectivity appears with all Loopback addresses. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afc/142/1a3/afc1421a3ceffc01d293e2f8694cdb0a.png"><h5>  Configure BGP </h5><br>  On each node you need to configure all the neighbors manually: <br><br>  <b>R1</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 2.2.2.2 remote-as 64500 neighbor 2.2.2.2 update-source Loopback0 neighbor 3.3.3.3 remote-as 64500 neighbor 3.3.3.3 update-source Loopback0 neighbor 4.4.4.4 remote-as 64500 neighbor 4.4.4.4 update-source Loopback0</code> </pre><br><br>  A team of the type <b>2.2.2.2 remote-as 64500</b> announces a neighbor and informs that it is in AS 64500, BGP understands that this is the same AS in which it works and then considers 2.2.2.2 as its IBGP partner. <br><br>  A command like <b>neighbor 2.2.2.2 update-source Loopback0</b> reports that the connection will be established from the address of the Loopback interface.  The fact is that on the other side (on 2.2.2.2) the neighbor is configured as 1.1.1.1 and it is from this address that all BGP messages are waiting. <br><br>  We apply this setting on all nodes of our AS: <br><br>  <b>R2</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 3.3.3.3 remote-as 64500 neighbor 3.3.3.3 update-source Loopback0 neighbor 4.4.4.4 remote-as 64500 neighbor 4.4.4.4 update-source Loopback0</code> </pre>  <b>R3</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 2.2.2.2 remote-as 64500 neighbor 2.2.2.2 update-source Loopback0 neighbor 4.4.4.4 remote-as 64500 neighbor 4.4.4.4 update-source Loopback0</code> </pre>  <b>R4</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 2.2.2.2 remote-as 64500 neighbor 2.2.2.2 update-source Loopback0 neighbor 3.3.3.3 remote-as 64500 neighbor 3.3.3.3 update-source Loopback0</code> </pre><br><br>  Now we can verify that the neighborhood relationship has been established safely. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e8/773/6b4/9e87736b42f84544bfc7c33db0b6a28e.png"><br><br>  All routes are in our BGP table. <br><br>  Network 130.0.0.0/24 can be seen on R1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/307/ba1/b62/307ba1b62767f9ba796e1bc7ee766027.png"><br><br>  Network 103.0.0.0/22 ‚Äã‚Äãcan be seen on R4: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd7/0db/fc8/fd70dbfc84be5b7fddd3788332fb7d3f.png"><br><br>  Is it time to check the end-to-end ping from R7 (our client) to the Internet (103.0.0.1)? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e77/3db/eb4/e773dbeb481cb3c24b7a469f59b5af4b.png"><br><br>  We arrived. <br>  We will not torment the reader for a long time and immediately look at the routing table, R4. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9d/155/a92/a9d155a9216fe845c0485c72718576d0.png"><br><br>  And on R7 at the same time: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/15e/4fb/21a/15e4fb21a598cc93ed34fbf084dbc94d.png"><br><br>  BUT?  Where are my routes?  Where are all my routes?  R4 does not know anything about the Balagan-Telecom network, the Filkin Certificate, the Internet, respectively, there are none on R7 either. <br><br>  Remember, we talked about Next-Hop above?  Like, he does not change in the transfer of IBGP? <br><br>  Pay attention to the Next-Hop obtained R4 routes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a0/675/b4f/3a0675b4f54a4ff5ab0aa66f1002a3ed.png"><br><br>  Despite the fact that they came to R4 from R1 and R2, Next-Hop addresses on them are R5 and R6 - that is, they have not changed. <br><br>  This means that traffic to the network 103.0.0.0/22 ‚Äã‚ÄãR4 should be sent to the address 101.0.0.1, well, or to 102.0.0.1.  Where are they in the routing table?  There are no them in the routing table.  Well, and this is natural - where will they come from. <br><br>  To solve this problem, we have 3 ways: <br>  1) Setting up static routes to these addresses is still fun, even if it is the gateway of last resort. <br>  2) Add these interfaces (towards providers) to the IGP routing domain.  Also an option, but as you know, external networks are not recommended to be added to IGP. <br>  3) Change the Next-Hop address when transmitting to IBGP neighbors.  Beautiful and scalable.  A situation that will prevent us from realizing this, simply cannot be. <br><br>  As a result, we add the following command to BGP: <b>neghbor 2.2.2.2 Next-Hop-self</b> .  For each neighbor, on each node. <br>  After that we see the following situation <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b7/212/987/4b721298760f81077ab13ef2d467885a.png"><br><br>  And, how to get to the address 1.1.1.1 - we know thanks to OSPF: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/55e/068/8f9/55e0688f923232afb87fe9579c81b149.png"><br><br>  As you can see, all interesting networks have already appeared in table R7. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56b/140/82b/56b14082b0a199d47896020c970eb0c3.png"><br><br>  Now the ping is successful: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f53/7ae/7c8/f537ae7c8118b43886f89c91afa8f927.png"><img src="https://habrastorage.org/getpro/habr/post_images/321/926/1f2/3219261f240ca3917df4cb6eed40bd01.png"><blockquote>  A very simple question: where are these gigantic delays in tracing?  And often this situation also happens: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f1/092/f7e/9f1092f7e4ea2dc0346a283895be1f17.png"><br></blockquote><br><br>  <a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub">Device configuration</a> <br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/96.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/96.html"><b>Problem number 4</b></a> <br>  You need to configure the following rules for working with neighboring AS: <br>  - prefixes are received from all neighboring ASs only if there are no more than 10 autonomous systems in them (in real life, the order of this value may be around 100). <br>  - all prefixes that are accepted from clients must be with a mask of no more than 24 bits. <br>  Configuration and scheme: <a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub">basic</a> . <br>  Details of the problem <a href="http://linkmeup.ru/blog/96.html">here</a> . <br>  ===================== <br><br><h3>  What can we improve? </h3><br>  Of course, the process of setting up BGP.  Still, these are labor costs - to make very similar settings on each node.  For simplicity, the concept of peer-group is introduced, which, based on the name, allows you to combine your neighbors into groups and use one command to set the necessary parameters for everyone at once. <br>  In order not to be unfounded, we will implement it on our network: <br><br>  <b>R1</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor AS64500 peer-group neighbor AS64500 remote-as 64500 neighbor AS64500 update-source Loopback0 neighbor AS64500 Next-Hop-self neighbor 2.2.2.2 peer-group AS64500 neighbor 3.3.3.3 peer-group AS64500 neighbor 4.4.4.4 peer-group AS64500</code> </pre><br><br>  The <b>AS64500 peer-group</b> neighbor command creates an AS64500 neighbor group. <br>  The <b>AS64500 remote-as 64500 neighbor command</b> reports that all neighbors are in AS 64500. <br>  The <b>AS64500 update-source Loopback0</b> command indicates that the connection will be established with all neighbors from the Loopback interface address. <br>  The <b>AS64500 Next-Hop-self neighbor command</b> causes the router to change the Next-Hop address to its own when transmitting announcements to all its neighbors. <br>  Further, in fact, we add neighbors to this group. <br><br>  Moreover, we can easily copy the configuration commands of a group of neighbors to other routers, changing only the addresses of neighbors. <br><blockquote>  A couple of comments on the Peer-group: <br>  1) For all members of a group, policies must be identical. <br>  2) In fact, cisco has long been using dynamic update groups.  This saves CPU resources, since the processing is carried out not once for each group member, but once for the whole group.  The actual Peer groups only facilitate the configuration, and optimization is left to the mercy of the Update groups. <br></blockquote><br><br><blockquote>  Surely, young green engineers had a question: why it is impossible to transfer information about public addresses via IBGP?  Is he supposed to be for this?  And even a more general question, why it is impossible to do BGP alone, without OSPF or IS-IS, for example?  (No, seriously, forums sometimes boil holivary on the topic of BGP vs OSPF).  Well, in fact, after all, there is also a routing protocol - what's the difference, to transfer information between AS or between routers - there is also Internal BGP. <br>  To this I want to say that it will be enough for you to work a little with BGP on a real network in order to understand the insanity of such a venture. <br><br>  <b>The most important obstacle is Full Mesh</b> .  We'll have to set up a neighborhood with all all routers manually.  OMG, my life and health are dear to me.  (Yes, even despite the presence of Route Reflectors and scripts - these are unnecessary operations) <br>  <b>Another problem is the slow response and the Remote-Vector approach</b> to the distribution of route information. <br>  And here you can reasonably argue that, they say, there is a BFD.  However, it will reduce the time to detect a problem, but convergence / restoration of connectivity will still be slow. <br>  <b>The third subtle point is the inability to automatically explore the neighbors.</b>  Which leads to their manual configuration. <br>  All of the above implies scalability and service issues. <br><br>  Just try it yourself to use BGP instead of IGP on a network of 10 routers, and everything will become clear. <br><br>  The same applies to the distribution of white addresses - IBGP will cope with this, but each router will have to manually register all the subnets. <br>  Well, for example, our network is 100.0.0.0/23.  Suppose that 3 clients are connected to router R3 by link addresses: 100.0.0.8/30, 100.0.0.12/30 and 100.0.0.16/0. <br>  So these 3 subnets you will need to enter into the BGP with three <b>network</b> commands, while in IGP it is enough to activate the protocol on the interface. <br>  You can, of course, resort to clever redistribution of routes from IGP, but this smacks of crutches and an even less transparent configuration. <br><br>  What are we doing all this for?  eBGP is a routing protocol, no fools.  At the same time, iBGP is not quite.  It is more like a top-level application that organizes the distribution of route information throughout the network.  In unchanged form, and without informing the neighbor ‚Äúover there through me‚Äù at each iteration.  In IGP, this behavior also sometimes occurs, but there is an exception, and here it is the norm. <br>  I want to emphasize once again, IGP and IBGP work in a pair, in a bundle, each of them doing their work. <br>  IGP provides internal IP connectivity, a quick (read instant) response to changes in the network, notification of all nodes about it as soon as possible.  He knows about the public addresses of <b>our</b> AS. <br>  IBGP handles Internet routes in our AS and their transit from Uplink to customers and back.  Usually he knows nothing about the structure of the internal network. <br><br>  If the question ‚Äúwhich is better than BGP or IS-IS?‚Äù Occurred to you, this is good, it means that you have an inquiring mind, but you must clearly understand that there is only one correct answer - these are fundamentally different things, you cannot compare them and choose a miss ‚ÄúRouting technology 2013‚Äù.  <b>IBGP runs on top of IGP</b> . <br></blockquote><br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/97.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/97.html"><b>Problem number 5</b></a> <br>  The higher AS 604503 aggregates several networks, including ours, into one 100.0.0.0/6 range.  But this summary prefix has returned to our autonomous system, although it should not have been. <br>  Configure R8 so that the aggregated prefix does not fall into the BGP table of routers that announce the subnets of this prefix.  Do not use filtering for this. <br><br>  Configuration and scheme: <a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub">basic</a> . <br><br>  Details of the problem <a href="http://linkmeup.ru/blog/97.html">here</a> . <br>  ===================== <br><br><h2>  Problem en square </h2><br>  At this point, the IBGP topic could have been closed if not for one ‚ÄúBUT‚Äù - Full Mesh.  We talked about the problems of full mesh topology when we discussed <a href="http://linkmeup.ru/blog/33.html">OSPF</a> .  There, the output was the DR - Designated Router, allowing to reduce the number of connections between routers from n * (n-1) / 2 to n-1.  But, if in the case of OSPF, this topology was rather an exception, because more than 2-3 routers in one L2 segment are quite rare, then for IBGP this is the most common practice.  The ‚Äúlarge‚Äù account of BGP routers inside the AS goes to the tens.  And already for 10 devices at <b>each</b> node it will be necessary to register 9 neighbors, that is, only 45 connections and 90 <b>neighbor</b> commands at a minimum.  Not sickly so. <br>  So, we come to terms like <i>Route Reflector</i> and <i>Confederation</i> .  I don‚Äôt know why, but this topic has always frightened me by some contrived complexity. <br><br><h3>  Route Reflectror </h3><br>  What is the essence of the concept Route Reflector?  This is a special IBGP router, which, on the basis of its literal translation, performs the function of reflecting routes ‚Äî one neighbor sends it to the route, and it sends it to all others.  That is, in fact, on IBGP routers you need to set up a session with only one neighbor ‚Äî with Route Reflector, and not with nine.  Everything is quite simple and here is a direct analogy with the very DR OSPF. <br><br>  A little more about the rules of the RR. <br>  First, we introduce the notion <i>RR client</i> and <i>non-RR client</i> . <br><br>  For this router, the client is an iBGP neighbor that is specifically declared as an RR client and for which special rules apply.  Non-client - iBGP neighbor, which is not declared as RR client <br>  RR servers can be (and should be in terms of fault tolerance) a few.  And client / non-client concepts are strictly local to each RR server. <br>  RR-server (or several) in conjunction with with their customers form a <i>cluster</i> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e33/c99/73b/e33c9973b3f5602d083aed1eac234efd.png"><h4>  Rules of the RR </h4><br><ul><li>  If the RR has received the route from the client, it sends it to all its customers, non-customer neighbors, and external (EBGP) neighbors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf5/9b9/e5c/bf59b9e5c0e666973fbbecb13da4afe3.gif"><br></li><li>  If the RR has received a route from a non-client, it sends it to all clients and EBGP neighbors.  Routes are NOT sent to non-clients (because they have already received these routes directly from the source router). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0e/fdc/167/f0efdc167c7a1850d0d50934f2544d1a.gif"><br></li><li>  If the RR has received a route from an EBGP neighbor, it sends it to all its clients, non-neighbor clients and external neighbors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c1/206/7f3/0c12067f35bd58299c80aed3bfca956e.gif"><br></li><li>  If the client has received a route from the RR, he can send it only to the EBGP neighbor. </li></ul><br><br>  As we said above, there can be several Route reflectors on the network.  This is normal, it will not cause the formation of a loop, because the Originator ID attribute exists - as soon as the RR receives the route, where it is specified as the sender of this route, it will discard it.  Each RR in this case will have a BGP routing table exactly the same as the others.  This is forced redundancy, which allows to significantly increase stability, but at the same time you should have sufficient performance of the devices themselves, for example, to maintain a pair of Full View on each. <br>  But several RRs can cluster into clusters and <s>destroy villages</s> to save resources ‚Äî the BGP table will be divided among several RRs. <br>  Belonging to a single cluster is configured on each RR and is determined by the Cluster ID attribute. <br><br><blockquote>  And here is a delicate moment - it is considered that Best Practice is setting up the same Cluster-ID on all RRs, but in fact this is not always the case.  You need to choose based on the design of your network.  Moreover, it is often recommended to even intentionally separate Route Reflectors - oddly enough, this increases the stability of the network. <br>  In order not to spread across the tree, just <a href="http://blog.ipexpert.com/2012/02/20/understanding-bgp-originator-id-and-cluster-id/">give a link</a> to the material about it. <br></blockquote><br><br>  This is the usual RR scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8ec/fdd/357/8ecfdd357ada192ee311f7b109fe19d7.png"><br><br>  The scheme with the main and backup RR: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/522/022/c27/522022c27a1d48778abc4e2a9adc385f.png"><br><br>  Within the cluster between the entire RR there must be complete connectivity. <br><br>  There can be several clusters and a full-mesh network should also be created between them: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5d6/04f/f13/5d604ff13b62545a7894da8e731ae434.png"><br><br><br>  We repeat that the cluster: this is the Ruth-reflector (one or several) together with all its clients. <br><br>  In addition, hierarchical RRs are often practiced.  For example: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/774/6c6/b5e/7746c6b5ed38d857e0ca6f4608af3cfb.png"><br><br>  RR1 receives routes from the remote AS and distributes them to its subsidiary RR (Client / RR1), which in turn distributes them to customers. <br>  This makes sense only in fairly large networks. <br><br>  Regarding Route Reflectors, it is important to understand that the router itself, performing the RR functions, is not necessarily involved in data transmission.  Moreover, RRs are often specifically taken out of the traffic path so that it performs solely the duties of transferring the routes so as not to increase the load on it. <br><br><h3>  RR practice </h3><br>  For example, suppose that in our network R1 will act as RR. <br>  Here is the configuration of the simplest case of RR - single, without a cluster. <br><br>  <b>R1</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor AS64500 peer-group neighbor AS64500 remote-as 64500 neighbor AS64500 update-source Loopback0 &lt;b&gt;neighbor AS64500 route-reflector-client&lt;/b&gt; neighbor AS64500 Next-Hop-self neighbor 2.2.2.2 peer-group AS64500 neighbor 3.3.3.3 peer-group AS64500 neighbor 4.4.4.4 peer-group AS64500 neighbor 101.0.0.1 remote-as 64501</code> </pre>  <b>R2</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 1.1.1.1 Next-Hop-self neighbor 102.0.0.1 remote-as 64502</code> </pre>  <b>R3</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 1.1.1.1 Next-Hop-self</code> </pre>  <b>R4</b> <br><pre> <code class="bash hljs">router bgp 64500 network 100.0.0.0 mask 255.255.254.0 neighbor 1.1.1.1 remote-as 64500 neighbor 1.1.1.1 update-source Loopback0 neighbor 1.1.1.1 Next-Hop-self neighbor 100.0.0.6 remote-as 64504</code> </pre><br><br>  Note the " <b>neighbor AS64500 route-reflector-client</b> " command added to the R1 setting and that the BGP configuration on all other devices is completely identical, with the exception of external neighbors (102.0.0.1 for R2 and 100.0.0.6 for R4). <br><br>  In general, nothing will change externally.  R4, for example, will see everything exactly the same, except for the number of neighbors: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5b/e6d/492/a5be6d492765ff2e745e2811641d9204.png"><br><br>  Please note that Route Reflector does not change the Next-Hop reflected routes to its own, despite the presence of the <i>Next-Hop-self</i> parameter. <br><br>  At the Route Reflector itself, the difference will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7fe/383/390/7fe38339046d4207eb76e4225a3fd59e.png"><br><br>  If you look at specific routes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0d/c4c/111/b0dc4c111a8c8a99125f4df33321bf41.png"><br><br>  Here you can see the full subnet, the number of paths to it, which one is the best, to which table it is added, to where it is sent (update-group 2 - just our cluster). <br>  The following lists all these paths, containing such important parameters as AS-Path, Next-Hop, Origin, etc., as well as information that, for example, the first route was received from an RR client. <br><br>  This information can be successfully used for troubleshooting.  So, for example, its output looks like when Next-Hop-self is not configured: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e45/020/022/e45020022bb117b73d3545d159b49e17.png">  <a href="https://docs.google.com/document/d/1LUf-RSx62_QUN5KNARufwSDz8duq1D9fCRa6u6pZlPk/pub">Device configuration</a> <br><br><h4>  Reservation issue </h4><br>  What is the problem with the root reflector now?  All routers have connections only with it.  And if R1 suddenly fails, write it is gone - the network will fall. <br>  For these purposes, let's configure the cluster and select R2 as the second RR. <br>  That is, now on R3 and R4 it is necessary to raise the neighborhoods not only with R1, but also with R2. <br><br>  Now sh ip bgp update-group looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a7f/4b0/d7d/a7f4b0d7d5059db11e6f0a9f8f6b0bff.png"><br><br>  One external, one internal is not an RR client and two internal RR clients. <br>  Similarly on R2: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/512/647/6dc/5126476dc9306bc7f381e3123da07136.png"><br><br>  On clients, we now have two connections with RR: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/737/18e/d52/73718ed527b54580c0785c0dc6a85ec1.png"><br><br>  Notice that there are now two new attributes in the Update messages: Cluster-List and Originator-ID.  Based on the name, they carry the RR-cluster number and the sender identifier of the announcement: <br><br>  R1R2 <br> <a href="http://fotki.yandex.ru/users/ait-it/view/815297/"><img src="https://habrastorage.org/getpro/habr/post_images/0b3/a24/97c/0b3a2497cab7196c01a2f35cb7dfb277.png" width="1134" height="617"></a> <br><br>  These parameters are added only to routes transmitted by IBGP. <br><br>  They are necessary in order to avoid the formation of loops.  If, for example, a route has passed several clusters and returned to the original one, then in the Cluster-List parameter among all the others, the router will see its cluster number, and then delete the route. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f3d/983/757/f3d9837572a420950ca533d6bd62d6f6.png"><blockquote>  Try to answer the question, why do you need the attribute Originator-ID?  Doesn't Cluster-List exhaust all the options? <br></blockquote><br><br>  If even now R1 is burned, the connection will partially only lie at the time of detecting the problem and rebuilding the routing tables (in the worst case, this is 3 minutes of waiting for the BGP keepalive message and some more time to study the new routes). <br>  But, if your network design suggested that RRs are independent pieces of hardware, and traffic did not go through them (that is, they were solely involved in distributing routes), then it is quite likely that there will be no traffic interruption at all.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the sender will notice only after 3 minutes that something is wrong with the RR - during this time he will have a route anyway, and since he leads not through the ingloriously lost RR, traffic will go quite safely. </font><font style="vertical-align: inherit;">After these three minutes, the sender will switch to the backup RR and receive a new actual route from it. </font><font style="vertical-align: inherit;">Thus the connection will not be terminated. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The essence of hierarchical root-reflectors is only that one of them is a client of the other. </font><font style="vertical-align: inherit;">This helps to build a more understandable and transparent scheme of work, which will be easier to troubleshoot further. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On our network, it is devoid of any meaning, so this case will not be considered.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Confederation </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another way to solve the Full-Mesh problem is to confederations or else they are called sub-AS, sub-AS. In fact, it is a small virtual speaker inside a large real speaker. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each confederation behaves like an adult AS - inside is a complete connectivity, from the outside, as Leibnitz puts its soul - IBGP works here on the EBGP principle (with some reservations), the border routers of the confederations, behave like EBGP neighbors, must be connected directly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example topology: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/279/76a/6bb/27976a6bb4f897764db78cca5eb322d2.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When routes are transmitted within the AU between confederations, a confederation number is added to their AS-Path (AS_CONFED_SEQ and AS_CONFED_SET segments) to avoid loops. As soon as the route leaves AS, all these numbers are deleted so that the outside world does not know about them.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is quite rare due to its weak scalability and opacity, so we will not consider it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More details can be read on </font></font><a href="http://xgu.ru/wiki/BGP_%25D0%25B2_Cisco"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">____________________________</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BGP Attributes </font></font></h1><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final topic we‚Äôll touch on BGP is its attributes. </font><font style="vertical-align: inherit;">We have already begun to consider them in the main article (AS-Path and Next-Hop, for example). </font><font style="vertical-align: inherit;">Now we will systematize and expand the existing knowledge. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They are divided into four types:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well-known Mandatory (Well-known Mandatory) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well-known optional (Well-known Discretionary) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optional Transmit / Transitive </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optional non-transitive (Optional Non-transitive) </font></font></li></ul><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well-known Mandatory (Well-known Mandatory) </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These are the attributes that must </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">always</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be present in announcements </font><font style="vertical-align: inherit;">, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">every</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BGP router must know them. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following three attributes and only they belong to this type. </font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next-Hop</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tells the receiving router how to send the packet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When transmitting a route between different ASs, the value of Next-Hop changes to the address of the sending router. Inside the AS, the Next-Hop attribute does not change by default when transmitting from one IBGP speaker to another. Above, we have already considered why. </font></font><br><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AS-path</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carries a list of all Autonomous Systems that must be overcome to achieve the goal. </font><font style="vertical-align: inherit;">Used to select the best path and to eliminate routing loops. </font><font style="vertical-align: inherit;">When a route is sent from one AS to another, the number of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sending</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AS is </font><font style="vertical-align: inherit;">inserted into the AS-path </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When transmitted within an AS, the parameter does not change. </font></font><br><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Origin</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tells how the route originated - with the network command (IGP - value 0) or redistribution (Incomplete - value 2). </font><font style="vertical-align: inherit;">The value 1 (EGP) is no longer encountered due to the fact that the EGP protocol is not used. </font><font style="vertical-align: inherit;">It is assigned once by the router-dad that generated the route and nowhere else changes. </font><font style="vertical-align: inherit;">Essentially means the degree of reliability of the source. </font><font style="vertical-align: inherit;">IGP - the coolest.</font></font><br> <a href="http://fotki.yandex.ru/users/ait-it/view/816511/"><img src="https://habrastorage.org/getpro/habr/post_images/f2f/8a8/4f5/f2f8a84f5fb2a617520d9c6539908bfb.png" width="1034" height="389"></a> <br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well-known optional (Well-known Discretionary) </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These attributes must be known to all BGP routers, but their presence in the announcement is not required. </font><font style="vertical-align: inherit;">Do you want to eat, do not want to - do not eat.</font></font><br><br>  Examples: <br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Local Preference</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> helps you choose one of several routes to one network. </font><font style="vertical-align: inherit;">This attribute can be transmitted only within one AS. </font><font style="vertical-align: inherit;">If the announcement with Local Preference comes from an EBGP partner, the attribute is simply ignored - we cannot control the routes of someone else's AS using Local Preference. </font></font><br><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomic Aggregate</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> says that the prefix was obtained by aggregating smaller ones.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optional Transmit / Transitive </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attributes that do not necessarily know everything. </font><font style="vertical-align: inherit;">Who knows - uses, who does not know - passes them on.</font></font><br><br>  Examples: <br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aggregator</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Indicates the Router ID of the router where the aggregation occurred. </font></font><br><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Community</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We will talk about this attribute in detail later, in the final part of the article.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optional non-transitive (Optional Non-transitive) </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attributes that do not necessarily know everything. </font><font style="vertical-align: inherit;">But the router, which does not support them, discards them and does not transmit anywhere else.</font></font><br><br>  Example: <br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MED - Multi-exit Descriminator</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With this attribute, we can try to manage priorities in an alien AS. We can try, but it is unlikely that something will work out :) Often this attribute is filtered, it matters only if there are at least two links to one AS, it is checked after many very strong attributes (Local Preference, AS-Path), and different vendors can interpret MED in different ways.</font><font style="vertical-align: inherit;">The previously mentioned</font><i><b><font style="vertical-align: inherit;"> Cluster List</font></b></i><font style="vertical-align: inherit;"> and</font><i><b><font style="vertical-align: inherit;"> Originator-ID</font></b></i><font style="vertical-align: inherit;"> . Naturally, they are optional, and of course, there is no sense in transferring them somewhere outside the AS, therefore it is not transferable.</font><font style="vertical-align: inherit;">=====================</font><a href="http://linkmeup.ru/blog/98.html"><b><font style="vertical-align: inherit;"> Task number 6 * You</font></b></a><font style="vertical-align: inherit;"> need to change the standard procedure for choosing the best route on the routers in AS64500:</font></font><br> <a href="http://fotki.yandex.ru/users/ait-it/view/816512/"><img src="https://habrastorage.org/getpro/habr/post_images/0dd/ec0/a1c/0ddec0a1c7c7ecc441cd826197503a27.png" width="1034" height="389"></a> <br><font style="vertical-align: inherit;"></font><i><b><font style="vertical-align: inherit;"></font></b></i><font style="vertical-align: inherit;"></font><i><b><font style="vertical-align: inherit;"></font></b></i><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br> <a href="http://linkmeup.ru/blog/98.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"></font></b></a> <br><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- R1 and R2 routers should choose eBGP routes, not iBGP, regardless of the AS path length, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- R3 and R4 routers inside the autonomous system should choose routes based on the OSPF metric. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration and scheme: </font></font><a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the problem </font></font><a href="http://linkmeup.ru/blog/98.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=====================</font></font><br><br><h3>  Community </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is - one of the most interesting aspects of BGP, this is where its flexibility is manifested - the ability, in addition to the routes themselves, to transmit additional information. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the Community attribute, you can control the behavior of another AS‚Äôs routers from your AS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For a long time, for some reason I did not understand for myself, I underestimated the power of this tool. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Managing your announcements in a foreign AS with the help of the community is supported by the overwhelming majority of vendors. But in fact, we should not speak here about vendors, but rather about operators / providers - it depends on them, on their configuration, whether you can manage or not.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the theory, Community, as mentioned above, is an optional Transmit attribute (4 bytes). It is a record of the form AA: NN, where AA is the two-byte AS number, NN is the community number (for example, 64500: 666). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are 4 so-called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well-Known community</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">well-known</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - There are no restrictions - it is transmitted to everyone. </font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-export</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Cannot export route to other AS. At the same time, it is possible to transfer them outside the confederation. </font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-export-subconfed</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (also called </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Local AS</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - As No-export, only a restriction is added and according to confederations - between them it is no longer transmitted either. </font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-advertise</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Do not pass this route to anyone - only a neighbor will know about it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/99.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 7</font></font></b></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Our new client AS 64504 is connected to our network. And while not planning to connect to another provider. At this stage, the client can use the autonomous system number from the private range. The address block that the client uses will be part of our range of networks. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: Since the client's network is part of our address block, it is necessary that the client's network is not announced to neighboring providers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not use prefix filtering or AS filtering to solve this problem. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration and schema: </font></font><a href="https://docs.google.com/document/d/1WFjksUR5aD2KhuN_ypA1IOMFavRzOX6p5ledbhyAN8o/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Community</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The only difference is that the network, which is announced by AS64504: 100.0.1.0/28, and not 130.0.0.0/24</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the problem </font></font><a href="http://linkmeup.ru/blog/99.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are thousands of online configuration examples for such a basic community and very few real-life examples. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meanwhile, one of the most interesting uses of this attribute is black houlling from Old Slavic black hole - a way to combat DoS attacks. In great detail with an example of customization, it has already </font></font><a href="http://habrahabr.ru/post/91574/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">been</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> described in Habr√©.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The bottom line is that when an attack began on one of your AS‚Äôs addresses, you transfer this address to a higher-level provider from the 666 community, and it sends such a route to NULL - blackhole him. </font><font style="vertical-align: inherit;">That is, this parasitic traffic does not reach you already. </font><font style="vertical-align: inherit;">The provider can transfer such a route further, and so, step by step, the traffic from the attacker or the bots system will be discarded already at the earliest stages, without clogging the Internet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Such an effect of an expanding black hole is achieved thanks to the community. </font><font style="vertical-align: inherit;">That is, in the usual case, you announce this address as part of a large network / 22, for example, and in the case of DoS, you pass the most specific route / 32, which will, naturally, take a higher priority.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the </font><font style="vertical-align: inherit;">way, you can listen to such attacks in the </font></font><a href="http://linkmeup.ru/blog/86.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sixth edition of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> our podcast linkmeup.</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other examples are the management of the Local Preference attribute in a foreign AS, telling it that the announcement needs to increase the AS-path (AS-path prepending) or not pass the route to any neighbors. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About the latter. How, for example, do you solve the following problem? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a network shown in the figure below. You want to give your routes to neighbors from AS 100 and 200 and you do not want 300. </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/6d0/752/7db/6d07527db925854d4c7d2d7e05187ea0.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without the use of the community, it is not possible to do this only with your AS.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, no matter how regrettable it may be, but such restrictions are actually used in our life. </font><font style="vertical-align: inherit;">There are common situations when several providers establish peering relationships among themselves - the traffic between their networks does not go through the higher providers, does not allow a circle through half of Russia, but does not let someone in - they do not announce their networks to someone. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most interesting articles about the </font></font><a href="http://habrahabr.ru/post/186282/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet and BGP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and about </font></font><a href="http://nag.ru/articles/article/19954/depir-vo-imya-status-kvo-cdn-platejey-comcast-protiv-level3.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peering wars</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Community Practice </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We consider the following situation as an example. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main scheme of the article is complemented by another client router and two links. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dad/9f4/5a6/dad9f45a665e098a18671601a66380b6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R7 and R9 are separated geographically - the so-called georeserving. The main is its right site, left - reserve. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inside his AS, he set up transmission of outgoing traffic in the right place - via R3. But with the incoming more difficult - MED does not allow the use of religion, and there is no trust in it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, we developed an interaction scheme using the community. In fact, it will be common to all. For example, below we will establish a rule - if you got a route with a community of 64500: 150, increase Local Preference for it to 150. And then we apply this policy to the routes we need.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On our hardware (on everything) we define the ip community-list: </font></font><br><pre> <code class="bash hljs">ip community-list 1 permit 64504:150</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Set the processing rule: </font></font><br><pre> <code class="bash hljs">route-map LP150 permit 10 match community 1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-preference 150</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a common unit that will be the same for all devices. </font><font style="vertical-align: inherit;">After that, the client can say that he wants to use this function and we apply the card to the BGP neighbor: We apply the card to the BGP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neighbor on R3:</font></font><br><pre> <code class="bash hljs">router bgp 64500 neighbor 100.0.0.10 remote-as 64504 neighbor 100.0.0.10 route-map LP150 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, if in the announcement from the neighbor 100.0.0.10 community coincides with the value in the condition, set the Local Preference for these routes to 150. </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often such policies (route maps) are applied by default on all external neighbors. </font><font style="vertical-align: inherit;">Clients can only set up the transfer of the desired community and do not even need to ask for something provider - everything will work automatically.</font></font><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is our community policy. </font><font style="vertical-align: inherit;">We inform the client about it, they say, you want to set Local Preference for your route at 150 in our AS, use community 64,500: 150 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now he sets up R9:</font></font><br><pre> <code class="bash hljs">router bgp 64504 neighbor 100.0.0.9 remote-as 64500 neighbor 100.0.0.9 route-map LP out neighbor 100.0.0.9 send-community route-map LP permit 10 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> community 64500:150</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If necessary, he can adjust the same to R7. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear ip bgp * soft</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the sent announcements, we can see the community: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0e/1d5/a8c/f0e1d5a8c5be131c7e774a83ca362a43.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, R3 has a route with a higher Local Preference: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a3c/a9f/bb2/a3ca9fbb2684992c72cf4e2e5737a623.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmits it to the root-reflector (R1 and R2), which makes a choice and distributes to all its neighbors: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f7a/b19/bb7/f7ab19bb71534a640f8d03931998be84.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And even R4, to which hand to reach R7, will send traffic to R3: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/765/b84/361/765b8436163359490e1805b279bfcc99.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic goes exactly the way we chose.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/258/2d4/f04/2582d4f040af0c4a02c2770414caa240.png"><blockquote>      3     ‚Äî         <i>R1R2R3</i>  <i>R1R4R3</i> .        ,   .        ,     1-  3-    R4,       R3.   ‚Äú‚Äù?  How is it going? <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, do not forget the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip bgp-community new-format</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">, otherwise instead: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/8fa/9b6/94f/8fa9b694fa3d0d2522c679d25f112f94.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you will see this: The </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/a80/f41/145/a80f411459428e0b6b56efc2afcafbe6.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">same will be sent, but in the output of the show commands will be displayed in a convenient form. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/100.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 8</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In our AS, for setting up policies with client AS, they use the community. The following values ‚Äã‚Äãare used: 64500: 150, 64500: 100, 64500: 50, 64500: 1, 64500: 2, 64500: 3. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, the routers of our AS also use the community to work with neighboring ASs. Their format: 64501: xxx, 64502: xxx. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- all community values ‚Äã‚Äãcoming from clients that are not defined by the policy should be deleted,</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- community values, which are set by clients, must be deleted when prefixes are transmitted to neighboring higher ASs. At the same time other values ‚Äã‚Äãwhich are put down by routers of our AS should not be deleted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration and scheme: </font></font><a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the problem </font></font><a href="http://linkmeup.ru/blog/100.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br><br> <a href="https://docs.google.com/document/d/1WFjksUR5aD2KhuN_ypA1IOMFavRzOX6p5ledbhyAN8o/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device Configuration</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the above example, you can see that the community allows you to work not with separate announcements and apply separate policies for each of them, but consider they are immediately as a group, which naturally makes maintenance much easier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In other words, a community is a group of announcements with the same characteristics.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When working with the community, it is important to understand that the configuration is necessary from two sides - in order for the desired to work, the provider must also have the appropriate configuration. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often, providers have an already established policy for using the community, and they simply give you the numbers you need to use. </font><font style="vertical-align: inherit;">That is, after you add a community number to the announcement, the provider will not have to do anything with his hands - everything will happen automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, Balagan Telecom may have such a policy:</font></font><br><br><table border="1"><tbody><tr><th>  Value </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Act </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 64501: 100X </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When announcing a route to neighbor A, add X predends, where X is from 1 to 6 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 64501: 101X </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When announcing a route to neighbor B, add X predends, where X is from 1 to 6 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 64501: 102X </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When announcing the route to neighbor C, add X prepend, where X is from 1 to 6 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 64501: 103X </font></font></td><td>     AS64503   ,    1  6 </td></tr><tr><td> 64501:20050 </td><td>  Local Preference     50 </td></tr><tr><td> 64501:20150 </td><td>  Local Preference     150 </td></tr><tr><td> 64501:666 </td><td>  Next-Hop    Null ‚Äî  Black Hole </td></tr><tr><td> 64501:3333 </td><td>      BGP    AS </td></tr></tbody></table><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Based on this label, which is published on the site of Balagan Telecom, we can make a decision about traffic management. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can this really help us? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have Dual-homing connection to two different providers - Balagan Telecom and Filkin Certificate. The data center also has connections to both providers. It belongs to some kind of content generator, say this is a sweat video operator. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By default, everything goes to our network through Balagan Telecom (AS64501). Although the channel is wide there, its utilization is already quite high. We want to sell IPTV service to home customers and expect a significant increase in incoming traffic. It would be nice to wrap it in Filkin Certificate and not be afraid that the main channel will be clogged. At the same time, of course, you do not need to transfer all other traffic.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the BGP table, we check where the network is 103.0.0.0. We see that this is AS64503, which is reachable through both providers with an equal number of AS in the AS-Path. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f4f/2c0/f85/f4f2c0f8581b565f8faacfce2b9fa2e5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how the router sees us from AS 64503: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4dc/70b/551/4dc70b5518094b1d42285ad6944e06ac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The route to Balagan-Telecom is preferred. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are your thoughts? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Announce certain networks in Filkin Certificate, and leave the rest in Balagan Telecom? Inflexible, unscalable. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hang up on the routes given to Balagan Telecom? Then, most likely, a bunch of other traffic will flow to the Filkin Certificate. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ask the engineer Balagan-Telecom to manually extend our routes by transferring them to AS64503. Already closer to the truth, and it will even work, but, most likely, the provider engineer will send you ... to the site with a sign, where their Community policy is written.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, all we need to do is to use the route-map on the R1 router to add the 64500: 1031 community to the R5 neighbor (recall that 103X is for the neighbor from AS 64503). Then everything will do automatic. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here‚Äôs how the R5 sees the route itself: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8c/0d2/615/b8c0d2615e604da57a54d65db6037c7e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All without changes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here‚Äôs how the R8 sees it: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ec/297/71f/9ec29771fcb41e5a4746042c4e5df24b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, the check mark stands in front of a shorter way through the Filkin Certificate, which we achieved. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/161/a9e/5d7/161a9e5d7d9853a467504f5f5ee11d32.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/101.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 9</font></font></b></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> One of our clients was a large company. They pay us quite a lot, but there is a problem with the fact that when some problems occur with the AS64501 provider, the quality of the connection provided by the link with the AS64502 provider does not suit the client. The main thing for our client, good quality of communication to the branches.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the client is solid, we had to install peering with another provider AS64513. But it costs us dearly so we will use it only when the provider AS64501 is not available and only for this important client. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary to configure the network so that the client network 150.0.0.0/24 is announced through the AS64513 provider only if the network 103.0.0.0/22 ‚Äã‚Äãis not available through the AS64501 provider (it is used to verify the provider‚Äôs operation). In addition, from the provider AS64513, we need to accept only the networks of the client‚Äôs branches (50.1.1.0/24, 50.1.2.0/24, 50.1.3.0/24) and use them only if they are not available through the provider AS64501. The rest of the client traffic will go through AS64502. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration: </font></font><a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the problem </font></font><a href="http://linkmeup.ru/blog/101.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=====================</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Release materials </font></font></h1><br> <a href="http://habrahabr.ru/post/186282/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Tale of the Present Internet </font></font></a> <br> <a href="http://habrahabr.ru/post/91574/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BGP Blackhole - an effective means of dealing with DDoS </font></font></a> <br> <a href="http://mcp1971.livejournal.com/10316.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparison of functions and uses of EBGP and IBGP </font></font></a> <br><br> <a href="http://ts.psc.ru/CISCO/ees/DAY4-BGP.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BGP Basics</font></font><br></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Device Configuration: </font></font><a href="https://docs.google.com/document/d/1Nd2qWdLNUd1WyO1Q-U3UKZu4W3LJk8BQYlACfVCjz-I/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic IBGP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1LUf-RSx62_QUN5KNARufwSDz8duq1D9fCRa6u6pZlPk/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route Reflectors</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://docs.google.com/document/d/1WFjksUR5aD2KhuN_ypA1IOMFavRzOX6p5ledbhyAN8o/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Community</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h1>  Afterword </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here on this familiarity with BGP can be considered complete. </font><font style="vertical-align: inherit;">Now we come back to it as much as possible when considering MPLS L3VPN. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Material prepared for you </font></font><a href="http://eucariot.lj.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eucariot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For troubleshooting articles thanks to </font></font><a href="http://habrahabr.ru/users/JDima/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDIMA. The</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puzzles are provided by </font></font><a href="http://xgu.ru/wiki/%25D0%259A%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F:%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580_%25D0%259D%25D0%25B0%25D1%2582%25D0%25B0%25D1%2588%25D0%25B0_%25D0%25A1%25D0%25B0%25D0%25BC%25D0%25BE%25D0%25B9%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25BA%25D0%25BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natasha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the author of the best wikisite on network protocols and technologies - xgu.ru. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As usual, a moment of self-promotion: you can find all articles of the cycle on our website </font></font><a href="http://linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linkmeup.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In the same place all releases of the first podcast for linkmeup operators.</font></font></div><p>Source: <a href="https://habr.com/ru/post/197516/">https://habr.com/ru/post/197516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197498/index.html">About competitors to our WiFi-kettle. iKettle</a></li>
<li><a href="../197506/index.html">iPhone 5S got a "blue screen of death"</a></li>
<li><a href="../197508/index.html">ROI website could not withstand the effect of Navalny</a></li>
<li><a href="../197512/index.html">The tale of how the First Channel itself creates prohibited content and complains about it</a></li>
<li><a href="../197514/index.html">Officials rejected the petition to repeal the "anti-piracy" law</a></li>
<li><a href="../197518/index.html">ePayService at Kyiv CasualConnect 2013</a></li>
<li><a href="../197520/index.html">Lock-free data structures. Basics: Memory Model</a></li>
<li><a href="../197522/index.html">How we did the wiren board</a></li>
<li><a href="../197524/index.html">Symfony CMF. Part 1, data storage</a></li>
<li><a href="../197528/index.html">ABCat: OpenSource catalog and audiobook downloader</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>