<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How and why we wrote a highly loaded scalable service for 1C: Enterprises: Java, PostgreSQL, Hazelcast</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will talk about how and why we developed the Interaction System - a mechanism that transfers information between client applicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How and why we wrote a highly loaded scalable service for 1C: Enterprises: Java, PostgreSQL, Hazelcast</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will talk about how and why we developed <a href="https://wonderland.v8.1c.ru/blog/sistema-vzaimodeystviya/">the Interaction System</a> - a mechanism that transfers information between client applications and 1C: Enterprise servers - from setting a task to thinking through the architecture and implementation details. <br><br>  The Interaction System (hereinafter - CB) is a distributed fault-tolerant messaging system with guaranteed delivery.  SV is designed as a highly loaded service with high scalability, and is available as an online service (provided by 1C), and as a lottery product that can be deployed on its server capacities. <br><br>  CB uses <a href="https://en.wikipedia.org/wiki/Hazelcast">Hazelcast</a> distributed storage and <a href="https://en.wikipedia.org/wiki/Hazelcast">Elasticsearch</a> search engine.  We will also discuss Java and how we horizontally scale PostgreSQL. <br><img src="https://habrastorage.org/webt/gh/nq/sq/ghnqsqdgkb0i4ze_7ig8blrfilk.png" alt="image"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Formulation of the problem </h2><br>  To make it clear why we did the Interaction System, I‚Äôll tell you a little about how the development of business applications in 1C is arranged. <br><br>  For a start - a little about us for those who still do not know what we are doing :) We are making the 1C: Enterprise technology platform.  The platform includes a business application development tool, as well as a runtime that allows business applications to work in a cross-platform environment. <br><br><h3>  Client-server development paradigm </h3><br>  Business applications created on 1C: Enterprise operate in a three-tier <a href="http://v8.1c.ru/overview/Term_000000033.htm">client / server</a> architecture ‚ÄúDBMS - Application Server - Client‚Äù.  The application code written in the <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F_1%25D0%25A1:%25D0%259F%25D1%2580%25D0%25B5%25D0%25B4%25D0%25BF%25D1%2580%25D0%25B8%25D1%258F%25D1%2582%25D0%25B8%25D0%25B5">embedded language 1C</a> can be executed on the application server or on the client.  All work with application objects (directories, documents, etc.), as well as reading and writing the database is performed only on the server.  The functionality of the forms and the command interface is also implemented on the server.  The client receives, opens and displays forms, ‚Äúcommunicates‚Äù with the user (warnings, questions ...), makes small calculations in forms that require quick reaction (for example, multiplying prices by quantity), working with local files, working with equipment. <br><br>  In the application code, the headers of the procedures and functions must explicitly indicate where the code will be executed - using the &amp; OnClient / &amp; OnServer directives (&amp; AtClient / &amp; AtServer in the English language version).  The 1C developers will now correct me, saying that there are actually <a href="https://yandex.ru/search/%3Ftext%3D1%25D1%2581%2520%25D0%2594%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D0%25B2%25D1%258B%2520%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D0%25B8%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D0%25B8%26lr%3D213">more</a> directives, but for us this is not essential now. <br><br>  You can call the server code from the client code, but you cannot call the client code from the server code.  This is a fundamental limitation made by us for a number of reasons.  In particular, because the server code must be written in such a way that it will be executed equally from wherever it is called - from the client or from the server.  And in the case of calling the server code from another server code, the client is missing as such.  And because during the execution of the server code, the client that called it could close, exit the application, and the server will have no one to call. <br><br><img src="https://habrastorage.org/webt/3e/pb/eh/3epbeh_fc7t4yipr5halnamtbmg.png" alt="image"><br>  <b>The code that handles button presses: a call to the server procedure from the client will work, a call to the client procedure from the server - no</b> <br><br>  This means that if we want to send some message from the server to the client application, for example, that the formation of a ‚Äúlong-playing‚Äù report has finished and the report can be viewed - we have no such method.  We have to go for tricks, for example, periodically polling the server from client code.  But this approach loads the system with unnecessary calls, and in general does not look very elegant. <br><br>  And there is also a need, for example, when a received <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB_%25D1%2583%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D1%2581%25D0%25B5%25D0%25B0%25D0%25BD%25D1%2581%25D0%25B0">SIP</a> telephone call arrives, to notify the client application about it, so that it will find the caller's number in the counterparty database and show the user information about the calling counterparty.  Or, for example, when arriving at the warehouse of the order to notify the client application of the customer.  In general, there are a lot of cases where such a mechanism would be useful. <br><br><h3>  Actually staging </h3><br>  Create a messaging mechanism.  Fast, reliable, with guaranteed delivery, with the possibility of flexible message retrieval.  On the basis of the mechanism to implement an instant messenger (messages, video calls) that runs inside 1C applications. <br><br>  Design the system horizontally scalable.  Increasing load must be closed by increasing the number of nodes. <br><br><h2>  Implementation </h2><br>  We decided not to build the server part of SV into the 1C: Enterprise platform, but to implement it as a separate product, whose API can be called from the 1C application solution code.  This was done for a number of reasons, the main of which was to make it possible to exchange messages between different 1C applications (for example, between the Office of Trade and Accounting).  Different 1C applications can work on different versions of the 1C: Enterprise platform, reside on different servers, etc.  In such conditions, the implementation of the SV as a separate product located ‚Äúon the side‚Äù of 1C installations is the optimal solution. <br><br>  So, we decided to do SV as a separate product.  We recommend that small companies use the CB server that we installed in our cloud (wss: //1cdialog.com) to avoid the overhead associated with installing and configuring the server locally.  Large clients may consider it expedient to install their own CB server at their facilities.  We used a similar approach in our cloud SaaS product <a href="http://v8.1c.ru/fresh/">1cFresh</a> - it is released as a lottery product for installation with customers, and also deployed in our cloud <a href="https://1cfresh.com/">https://1cfresh.com/</a> . <br><br><h3>  application </h3><br>  For load balancing and fault tolerance, we will deploy not one Java application, but several; we will put a load balancer in front of them.  If you need to send a message from node to node, use publish / subscribe in Hazelcast. <br><br>  Client communication with the server - by websocket.  It is well suited for real-time systems. <br><br><h3>  Distributed cache </h3><br>  Choose between Redis, Hazelcast and Ehcache.  In the yard in 2015.  Redis just released a new cluster (too new, scary), there is a Sentinel with a bunch of restrictions.  Ehcache does not know how to assemble into a cluster (this functionality appeared later).  We decided to try with Hazelcast 3.4. <br>  Hazelcast is going to cluster out of the box.  In the single node mode, it is not very useful and can only fit as a cache - it does not know how to dump data to disk, if it lost a single node - it lost data.  We deploy several Hazelcasts, between which we back up critical data.  Cache is not backed up - it is not a pity. <br><br>  For us, Hazelcast is: <br><br><ul><li>  User session repository.  Each time, going after the session to the base is long, so we put all the sessions in the Hazelcast. </li><li>  Cache.  Looking for a user profile - check in the cache.  Wrote a new message - put in the cache. </li><li>  Topics for communication instances of the application.  The node generates an event and puts it in the Hazelcast topic.  Other application nodes subscribed to this topic receive and process the event. </li><li>  Cluster lock.  For example, we create a discussion using a unique key (a singleton discussion within the 1C database): </li></ul><br><pre><code class="java hljs">conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); doInClusterLock(<span class="hljs-string"><span class="hljs-string">""</span></span>, () -&gt; { conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); createChannel(<span class="hljs-string"><span class="hljs-string">""</span></span>); });</code> </pre> <br>  Checked that there is no channel.  They took the lock, again checked, created.  If you do not check after taking the lock, then there is a chance that another thread at this moment also checked and will now try to create the same discussion - and it already exists.  You cannot block using synchronized or regular java Lock.  Through the base - slowly, and the base is pitiful, through the Hazelcast - what we need. <br><br><h3>  Choosing a DBMS </h3><br>  We have a large and successful experience with PostgreSQL and cooperation with the developers of this DBMS. <br><br>  With a cluster, PostgreSQL is not easy - there are <a href="https://www.postgres-xl.org/">XL</a> , <a href="https://wiki.postgresql.org/wiki/Postgres-XC">XC</a> , <a href="https://www.citusdata.com/">Citus</a> , but, in general, this is not noSQL, which scale out of the box.  NoSQL as the main repository was not considered, it was enough that we take Hazelcast, with which we have not worked before. <br><br>  If you need to scale the relational database, it means <a href="https://en.wikipedia.org/wiki/Shard_(database_architecture)">sharding</a> .  As you know, with sharding, we divide the database into separate parts so that each of them can be transferred to a separate server. <br><br>  The first version of our sharding suggested the possibility of spreading each of the tables of our application across different servers in different proportions.  There are a lot of messages on server A ‚Äî please, let's transfer part of this table to server B. Such a solution just screamed about premature optimization, so we decided to limit ourselves to a multi-tenant approach. <br><br>  You can <a href="http://docs.citusdata.com/en/v7.4/get_started/tutorial_multi_tenant.html">read</a> about multi-tenant, for example, on the <a href="http://docs.citusdata.com/en/v7.4/get_started/tutorial_multi_tenant.html">Citus Data</a> website. <br><br>  In NE there are concepts of the application and subscriber.  An application is a specific installation of a business application, such as ERP or Accounting, with its users and business data.  A subscriber is an organization or an individual on whose behalf the application is registered in the CB server.  A subscriber can have several applications registered, and these applications can exchange messages with each other.  The subscriber and became a tenant in our system.  Messages of several subscribers can be in the same physical database;  if we see that a subscriber began to generate a lot of traffic, we bring it to a separate physical database (or even a separate database server). <br><br>  We have the main database where the routing table is stored with information about the location of all subscriber databases. <br><br><img src="https://habrastorage.org/webt/yf/3k/bo/yf3kboqvabg3ljf791sdlpn0zay.png" alt="image"><br><br>  So that the main database is not a bottleneck, we keep the routing table (and other frequently requested data) in the cache. <br><br>  If the subscriber‚Äôs database starts to slow down, we‚Äôll cut the partitions inside.  On other projects, we use pg_pathman to partition large tables. <br><br>  Since losing users' messages is bad, we support our databases with replicas.  The combination of synchronous and asynchronous replicas allows you to hedge against the loss of the main database.  The message will be lost only in case of simultaneous failure of the main database and its synchronous replica. <br><br>  If a synchronous replica is lost, the asynchronous replica becomes synchronous. <br>  If the primary database is lost, the synchronous replica becomes the primary database, the asynchronous replica becomes the synchronous replica. <br><br><h3>  Elasticsearch for search </h3><br>  Since, among other things, CB is also an instant messenger, we need a quick, convenient and flexible search, taking into account the morphology, by inaccurate correspondences.  We decided not to reinvent the wheel and use the free search engine Elasticsearch, based on the <a href="https://ru.wikipedia.org/wiki/Lucene">Lucene</a> library.  We also expand Elasticsearch in a cluster (master - data - data) to eliminate problems in case of failure of application nodes. <br><br>  On github, we found <a href="https://github.com/imotov/elasticsearch-analysis-morphology">a Russian morphology plugin</a> for Elasticsearch and use it.  In the Elasticsearch index, we store the roots of the words (which the plugin defines) and N-grams.  As the user enters the text for the search, we are looking for typed text among N-grams.  When you save to the index, the word "texts" is divided into the following N-grams: <br><br>  [those, tech, tex, text, texts, ek, ex, text, texts, kc, kst, ksta, art, art, you], <br><br>  And also the root of the word "text" will be saved.  This approach allows you to search and at the beginning, and in the middle, and at the end of the word. <br><br><h2>  Overall picture </h2><br><img src="https://habrastorage.org/webt/wo/w3/ke/wow3ke8dq1cqrb_ujsjm4uhevfm.png" alt="image"><br>  Repeat pictures from the beginning of the article, but with explanations: <br><br><ul><li>  Online balancer;  we have nginx, maybe any. </li><li>  Java application instances communicate via Hazelcast. </li><li>  For work with a web socket we use <a href="https://en.wikipedia.org/wiki/Netty_(software)">Netty</a> . </li><li>  Java application written in Java 8, consists of <a href="https://ru.wikipedia.org/wiki/OSGi">OSGi</a> bundles.  The plans - migration to Java 10 and the transition to modules. </li></ul><br><h2>  Development and Testing </h2><br>  During the development and testing of CB, we encountered a number of interesting features of the products used by us. <br><br><h3>  Load Testing and Memory Leaks </h3><br>  The release of each CB release is load testing.  It was successful when: <br><br><ul><li>  The test worked for several days and there were no service failures. </li><li>  Response time for key operations did not exceed the comfortable threshold </li><li>  The performance degradation compared with the previous version is not more than 10% </li></ul><br>  We fill the test database with data - to do this, we receive information from the production server about the most active subscriber, multiply its numbers by 5 (the number of messages, discussions, users) and so we test. <br><br>  We carry out load testing of the interaction system in three configurations: <br><br><ol><li>  Stress test </li><li>  Connections only </li><li>  Subscribers Registration </li></ol><br>  In the stress test, we run several hundred threads, and those without stopping load the system: write messages, create discussions, get a list of messages.  We simulate the actions of ordinary users (get a list of my unread messages, write to someone) and software solutions (send a package of another configuration, handle the alert). <br><br>  For example, this is how a part of the stress test looks like: <br><br><ul><li>  User is logging in <br><ul><li>  Requests his unread discussions </li><li>  With a 50% chance of reading messages </li><li>  50% likely to write messages </li><li>  Next user: <br><ul><li>  With 20% probability creates a new discussion. </li><li>  Randomly selects any of his discussions. </li><li>  Goes inside </li><li>  Requests messages, user profiles </li><li>  Creates five messages addressed to random users from this thread. </li><li>  Out of the discussion </li><li>  Repeats 20 times </li><li>  Log out, go back to the beginning of the script. </li></ul><br></li><li>  A chat bot enters the system (emulates the exchange of messages from application code) <br><br><ul><li>  With a 50% chance of creating a new channel for data exchange (special discussion) </li><li>  With a 50% chance of writing a message in any of the existing channels </li></ul><br></li></ul><br></li></ul><br>  The ‚ÄúOnly Connections‚Äù scenario did not appear for nothing.  There is a situation: users have connected the system, but have not yet been involved.  Each user at 09:00 in the morning turns on the computer, establishes a connection with the server and is silent.  These guys are dangerous, there are many of them - from the packages they have only PING / PONG, but they keep the connection to the server (they can't keep it - and what if a new message).  The test reproduces the situation when in half an hour a large number of such users try to log in to the system.  It looks like a stress test, but the focus is on this first entry - so that there are no failures (the person does not use the system, and it already falls off - it‚Äôs hard to think of something worse). <br><br>  The subscriber registration script originates from the first launch.  We conducted a stress test and were confident that the system does not slow down in correspondence.  But users went and started to fall off registration by timeout.  During registration, we used <a href="https://ru.wikipedia.org/wiki/dev/random_%25D0%25B8_/dev/urandom">/ dev / random</a> , which is tied to the entropy of the system.  The server did not have time to save enough entropy, and when it requested a new SecureRandom it would freeze for tens of seconds.  There are many ways out of this situation, for example: switch to a less secure / dev / urandom, put a special fee that forms entropy, generate random numbers in advance and store in a pool.  We have temporarily closed the problem with a pool, but since then we have run a separate test for registering new subscribers. <br><br>  We use <a href="https://ru.wikipedia.org/wiki/JMeter/">JMeter</a> as a load generator.  He doesn‚Äôt know how to work with a web-application; we need a plugin.  The first in search results for the query ‚Äújmeter websocket‚Äù are <a href="https://www.blazemeter.com/blog/jmeter-websocket-samplers-a-practical-guide">articles from BlazeMeter</a> , which recommend a <a href="https://github.com/maciejzaleski/JMeter-WebSocketSampler">plugin from Maciej Zaleski</a> . <br><br>  We decided to start with it. <br><br>  Almost immediately after the start of serious testing, we discovered that memory leaks started in JMeter. <br><br>  The plugin is a separate big story, with 176 stars it has 132 forks on github.  The author himself does not commit it since 2015 (we took it in 2015, then it did not arouse suspicion), several github issues about memory leaks, 7 unclosed pull request-s. <br>  If you decide to do load testing with this plugin, pay attention to the following discussions: <br><br><ol><li>  In a multi-threaded environment, the usual LinkedList was used, as a result, <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/NullPointerException.html">NPEs</a> were obtained in runtime.  It is solved either by switching to ConcurrentLinkedDeque, or by synchronized blocks.  For myself, we chose the first option ( <a href="https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/43">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/43</a> ). </li><li>  Memory leak, disconnect does not remove connection information ( <a href="https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/44">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/44</a> ). </li><li>  In streaming mode (when the web socket does not close at the end of the sample, but used further in the plan) Response patterns do not work ( <a href="https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/19">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/19</a> ). </li></ol><br>  This is one of those on github.  What we did: <br><br><ol><li>  They took the <a href="https://github.com/elyrank/JMeter-WebSocketSampler">fork of Elyran Kogan</a> (@elyrank) - it fixed problems 1 and 3 </li><li>  Solved problem 2 </li><li>  Updated jetty from 9.2.14 to 9.3.12 </li><li>  Wrapped SimpleDateFormat into ThreadLocal;  SimpleDateFormat is not thread safe, resulting in NPE in runtime </li><li>  Eliminate another memory leak (connection was not properly closed during disconnect) </li></ol><br>  And yet it flows! <br><br>  Memory began to end not in a day, but in two.  There was no time left, we decided to run fewer threads, but on four agents.  This should have been enough for at least a week. <br><br>  Two days have passed ... <br><br>  Now the memory began to end at Hazelcast.  In the logs, it was clear that after a couple of days of testing, Hazelcast begins to complain about the lack of memory, and after some time the cluster falls apart, and the nodes continue to die one by one.  We connected JVisualVM to the hazelcast and saw the ‚Äúascending saw‚Äù - he regularly called the GC, but could not clear the memory. <br><br><img src="https://habrastorage.org/webt/ha/uc/5y/hauc5ydqebpmxtfirqalulaandi.png" alt="image"><br><br>  It turned out that in hazelcast 3.4, when deleting map / multiMap (map.destroy ()), the memory is not completely freed: <br><br>  <a href="https://github.com/hazelcast/hazelcast/issues/6317">github.com/hazelcast/hazelcast/issues/6317</a> <br>  <a href="https://github.com/hazelcast/hazelcast/issues/4888">github.com/hazelcast/hazelcast/issues/4888</a> <br><br>  Now the bug is fixed in 3.5, but then it was a problem.  We created new multiMap with dynamic names and deleted it according to our logic.  The code looked like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.put(auth.getUserId(), auth); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.remove(auth.getUserId(), auth); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessions.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sessions.destroy(); } }</code> </pre> <br>  Call: <br><br><pre> <code class="java hljs">service.join(auth1, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>); service.join(auth2, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>);</code> </pre> <br>  MultiMap was created for each subscription and was deleted when it was not needed.  We decided that we will start Map &lt;String, Set&gt;, the key will be the name of the subscription, and the identifiers of the sessions as values ‚Äã‚Äã(which can then be used to obtain user identifiers if needed). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ addValueToMap(sub, auth.getSessionId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ removeValueFromMap(sub, auth.getSessionId()); }</code> </pre> <br>  The charts straightened. <br><br><img src="https://habrastorage.org/webt/li/_z/ai/li_zaiochcpbgvviybycfvzslz4.png" alt="image"><br><br><h4>  What else have we learned about load testing? </h4><br><ol><li>  JSR223 needs to be written on groovy and include compilation cache - it is much faster.  <a href="https://www.blazemeter.com/blog/beanshell-vs-jsr223-vs-java-jmeter-scripting-its-performance">Link</a> </li><li>  Jmeter-Plugins graphics are easier to understand than standard ones.  <a href="https://jmeter-plugins.org/downloads/all/">Link</a> </li></ol><br><br><h3>  About our experience with Hazelcast </h3><br>  Hazelcast for us was a new product, we started working with it from version 3.4.1, now version 3.9.2 is on our production server (at the time of this writing, the latest version of Hazelcast is 3.10). <br><br><h4>  ID generation </h4><br>  We started with integer ids.  Let's imagine that we need another Long for a new entity.  Sequence in the database is not suitable, the tables participate in sharding - it turns out that there is a message ID = 1 in DB1 and a message ID = 1 in DB2; from two databases to one (for example, deciding that one base is enough for these subscribers).  You can start several AtomicLongs in Hazelcast and keep the counter there, then the performance of getting a new ID is incrementAndGet plus the time for a query in Hazelcast.  But in Hazelcast there is something more optimal - FlakeIdGenerator.  Each client is issued with a range of IDs, for example, the first is from 1 to 10,000, the second is from 10,001 to 20,000, and so on.  Now the client can issue new identifiers independently, until the range given to him ends.  It works quickly, but when the application is restarted (and the Hazelcast client), a new sequence begins - hence the omissions, etc.  In addition, developers are not very clear why the ID is an integer, but they are so much at odds with each other.  We all weighed and switched to UUIDs. <br><br>  By the way, for those who want to be like Twitter, there is such a Snowcast library - this is the implementation of Snowflake over Hazelcast.  You can see here: <br><br>  <a href="https://github.com/noctarius/snowcast">github.com/noctarius/snowcast</a> <br>  <a href="https://github.com/twitter/snowflake">github.com/twitter/snowflake</a> <br><br>  But we have not reached her hands. <br><br><h4>  TransactionalMap.replace </h4><br>  Another surprise: TransactionalMap.replace is not working.  Here is a test: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap_putsAndGetsInsideTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).put(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>); context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>, <span class="hljs-string"><span class="hljs-string">"newValue"</span></span>); String value = (String) context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>); assertEquals(<span class="hljs-string"><span class="hljs-string">"newValue"</span></span>, value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); } Expected : newValue Actual : oldValue</code> </pre> <br>  I had to write my replace using getForUpdate: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> &lt;K,V&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mapName, K key, V oldValue, V newValue)</span></span></span><span class="hljs-function"> </span></span>{ TransactionalTaskContext context = HazelcastTransactionContextHolder.getContext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a transactional map"</span></span>); TransactionalMap&lt;K, V&gt; map = context.getMap(mapName); V value = map.getForUpdate(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.equals(value)) { map.put(key, newValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a not transactional map"</span></span>); IMap&lt;K, V&gt; map = hazelcastInstance.getMap(mapName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.replace(key, oldValue, newValue); }</code> </pre> <br>  Test not only regular data structures, but also their transactional versions.  It happens that IMap works, and TransactionalMap is no longer there. <br><br><h4>  Put a new JAR without downtime </h4><br>  At first we decided to record objects of our classes in Hazelcast.  For example, we have an Application class, we want to save and read it.  Save: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); map.set(id, application);</code> </pre> <br>  We read: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.get(id);</code> </pre> <br>  Everything is working.  Then we decided to build an index in Hazelcast, to look for it: <br><br><pre> <code class="java hljs">map.addIndex(<span class="hljs-string"><span class="hljs-string">"subscriberId"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre> <br>  And when writing a new entity, we started getting ClassNotFoundException.  Hazelcast tried to supplement the index, but knew nothing about our class and wanted to have a JAR planted with this class.  We did it, it all worked, but a new problem appeared: how to update the JAR without completely stopping the cluster?  Hazelcast does not pick up a new JAR with a new update.  At this point, we decided that we could live without index search.  After all, if you use Hazelcast as a key-value type storage, then everything will work?  Not really.  Here again the different behavior of IMap and TransactionalMap.  Where IMap doesn't care, TransactionalMap throws an error. <br><br>  IMap.  We write down 5000 objects, we read.  Everything is expected. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get5000</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); UUID subscriberId = UUID.randomUUID(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000</span></span>; i++) { UUID id = UUID.randomUUID(); String title = RandomStringUtils.random(<span class="hljs-number"><span class="hljs-number">5</span></span>); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, title, subscriberId); map.set(id, application); Application retrieved = map.get(id); assertEquals(id, retrieved.getId()); } }</code> </pre> <br>  And in the transaction does not work, we get a ClassNotFoundException: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_transaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); UUID subscriberId = UUID.randomUUID(); UUID id = UUID.randomUUID(); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, <span class="hljs-string"><span class="hljs-string">"qwer"</span></span>, subscriberId); map.set(id, application); Application retrievedOutside = map.get(id); assertEquals(id, retrievedOutside.getId()); hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TransactionalMap&lt;UUID, Application&gt; transactionalMap = context.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); Application retrievedInside = transactionalMap.get(id); assertEquals(id, retrievedInside.getId()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); }</code> </pre> <br>  In 3.8, the User Class Deployment mechanism appeared.  You can assign one master node and update the JAR file on it. <br><br>  Now we have completely changed the approach: we serialize ourselves into JSON and save to Hazelcast.  Hazelcast does not need to know the structure of our classes, and we can be updated without downtime.  Versioning of domain objects is controlled by the application.  At the same time, different versions of the application can be launched, and it is possible that a new application writes objects with new fields, but the old one does not know about these fields.  And at the same time, the new application reads objects written by the old application, in which there are no new fields.  We handle such situations inside the application, but for simplicity we do not change or delete fields, we only expand classes by adding new fields. <br><br><h3>  How we provide high performance </h3><br><h4>  Four trips to Hazelcast - good, two trips in the database - bad </h4><br>  Going for data in the cache is always better than in the database, but you do not want to store unclaimed records either.  The decision that to cache, we postpone for the last stage of development.  When the new functionality is encoded, we enable logging of all requests (log_min_duration_statement to 0) in PostgreSQL and run load testing for 20 minutes. Using the collected logs, utilities like pgFouine and pgBadger can build analytical reports.  In the reports we are primarily looking for slow and frequent requests.  For slow queries, we build an execution plan (EXPLAIN) and evaluate whether such a query can be accelerated.  Frequent requests for the same input data fit well into the cache.  We try to keep the requests ‚Äúflat‚Äù, one table in the request. <br><br><h2>  Exploitation </h2><br>  SV as an online service was launched in spring 2017, as a separate product SV came out in November 2017 (at that time in beta status). <br><br>  For more than a year of operation, there were no serious problems with the operation of the SV online service.  Online service is monitored via <a href="https://www.zabbix.com/ru/">Zabbix</a> , assembled and deployed from <a href="https://www.atlassian.com/software/bamboo">Bamboo</a> . <br><br>  The CB distribution package is delivered in the form of native packages: RPM, DEB, MSI.  Plus for Windows, we provide a single installer in the form of a single EXE, which installs the server, Hazelcast and Elasticsearch on one machine.  At first we called this version of the installation ‚Äúdemo‚Äù, but now it has become clear that this is the most popular deployment option. </div><p>Source: <a href="https://habr.com/ru/post/422903/">https://habr.com/ru/post/422903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422893/index.html">Node.js Part 1 Guide: General Information and Getting Started</a></li>
<li><a href="../422895/index.html">Google wants to kill url</a></li>
<li><a href="../422897/index.html">Bad, but yours: how to write a really awful CSS</a></li>
<li><a href="../422899/index.html">Under vigilant supervision: how to monitor hosters' tariffs and maintain the relevance of the VPS catalog</a></li>
<li><a href="../422901/index.html">Pulsometer for Putin, or what is Ritmer</a></li>
<li><a href="../422905/index.html">But you say Ceph ... is it really good?</a></li>
<li><a href="../422907/index.html">Quick Reference Guide for 2018 Robot Vacuum Cleaners</a></li>
<li><a href="../422909/index.html">10 most popular videos of retro reports of the Festival 404</a></li>
<li><a href="../422915/index.html">I am looking for a senior without an office and cookies: how are we organized the search for employees 100% remote</a></li>
<li><a href="../422917/index.html">I have no mouth, but I have to shout. Reflections on AI and ethics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>