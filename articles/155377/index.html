<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous MySQL queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In mysqlnd , it became possible to execute queries to MySQL asynchronously, that is, to continue the script without waiting for the query to be execut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous MySQL queries</h1><div class="post__text post__text-html js-mediator-article">  In <a href="http://habrahabr.ru/post/154663/">mysqlnd</a> , it became possible to execute queries to MySQL asynchronously, that is, to continue the script without waiting for the query to be executed and the result to be generated.  The advantage of this approach is obvious, because you can do a lot of useful work while waiting for a request, but first I will give a slightly different example: <br><br>  Suppose you have 3 queries ( <i>q1</i> , <i>q2</i> , <i>q3</i> ), each query is executed for a certain time ( <i>t1</i> , <i>t2</i> , <i>t3</i> ), for example: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> val, <span class="hljs-keyword"><span class="hljs-keyword">SLEEP</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> val, <span class="hljs-keyword"><span class="hljs-keyword">SLEEP</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> val, <span class="hljs-keyword"><span class="hljs-keyword">SLEEP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the case of <i>synchronous</i> execution of requests, you can get the results of their execution through <b>t1 + t2 + t3</b> (ex: 6 seconds), and in the case of <i>asynchronous</i> execution of requests already in <b>max (t1, t2, t3)</b> (ex: 3 seconds) <br><br>  Examples of working with asynchronous requests, as well as other examples of working with mysqlnd can be found on <a href="https://github.com/aeryaguzov/php-mysqlnd-examples">github</a> <br><br><a name="habracut"></a><br><br><h5>  Run asynchronous requests </h5><br><br>  To perform asynchronous requests, it is sufficient to specify the special flag <b>MYSQLI_ASYNC</b> . <br><br><pre> <code class="php hljs">mysqli_query($link, $query, MYSQLI_ASYNC);</code> </pre><br><br>  This constant is declared directly in the extension, so the expressions above will not execute without mysqlnd.  To provide the ability to execute a query synchronously, in the absence of mysqlnd, there are several options for executing the query: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     ( notice     - !) mysqli_query($link, $query, MYSQLI_ASYNC || MYSQLI_USE_RESULT); //   $flag = defined('MYSQLI_ASYNC') ? MYSQLI_ASYNC : MYSQLI_USE_RESULT; mysqli_query($link, $query, $flag); //   defined('MYSQLI_ASYNC') || define('MYSQLI_ASYNC', MYSQLI_USE_RESULT); mysqli_query($link, $query, MYSQLI_ASYNC);</span></span></code> </pre><br><br>  Unlike the usual result of this function, in the case of asynchronous execution of a read request (SELECT, etc.), it returns true, instead of mysqli_result. <br><br><h5>  Verifying asynchronous requests </h5><br><br>  To check the performance of asynchronous requests, use the <a href="http://php.net/manual/ru/mysqli.poll.php">mysqli_poll</a> function.  Unfortunately, the function is not documented, and the set of parameters is puzzling, so I had to go into the sources and see what happens after all.  As a result, it turned out that the function is a wrapper for the <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/select.2.html">select</a> system call, like the <a href="http://php.net/manual/ru/function.stream-select.php">stream_select</a> function: <br><br><img src="https://habrastorage.org/storage2/397/919/401/3979194017794978befeb141c013d513.png" alt="image"><br><br>  The mysqli_poll function is supplied with three arrays containing mysqli objects that need to be checked and validation timeout values ‚Äã‚Äã(sec, [usec]).  The arrays are converted to the appropriate set of file descriptors, the values ‚Äã‚Äãfor the timeout are converted to the timeval structure and input to the select system call, then the inverse conversion of the descriptors to mysqli objects is performed and the result of the select system call is returned.  Examples of checking the results of asynchronous requests can be found <a href="https://github.com/aeryaguzov/php-mysqlnd-examples/blob/master/polling.php">here</a> . <br><br><h5>  Retrieving query results </h5><br><br>  Getting the results of an asynchronous request occurs through the function <a href="http://www.php.net/manual/ru/mysqli.reap-async-query.php">mysqli_reap_async_query</a> .  The function call is always necessary, since it removes the blocking from the request and without this call, all subsequent requests will fall from ‚ÄúCommands out of sync‚Äù. For read requests (SELECT and so on), the function will return mysqli_result, which after processing must be ‚Äúreleased ¬ªTo continue working with the database, for the rest - bool. <br><br><h5>  Use cases </h5><br><br>  The main advantage of using asynchronous requests is more efficient use of CPU time.  At the beginning of the article there is an example that shows how quickly you can perform multiple asynchronous queries to the database ( <a href="https://github.com/aeryaguzov/php-mysqlnd-examples/blob/master/sync_vs_async_time.php">code</a> ).  In addition, the developer often faces the task of writing migrations to the database.  Migrations are usually divided into schema migrations (CREATE, ALTER, DROP) and data migrations (INSERT, UPDATE, DELETE).  In the case of working with large tables, the execution of ALTER takes a large amount of time, which can be effectively used to prepare data for UPDATE ( <a href="https://github.com/aeryaguzov/php-mysqlnd-examples/blob/master/mersenne_migration.php">code</a> ). <br><br>  PS Working with asynchronous requests is not yet completely transparent to me, so I ask for your help: <br><br>  1. I could not emulate getting errors (the appearance of the mysqli object in the errors array) via mysqli_poll.  If you know how to do this, write plz, be sure to add to the article. <br><br>  2. If I close the connection before calling mysqli_poll, I get segfault (ubuntu 12.04, php 5.3.10).  Plz play the following code in your homepage, you may need to report a bug: <br><br><pre> <code class="php hljs">$link = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mysqli(<span class="hljs-string"><span class="hljs-string">'host'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'db'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span>); mysqli_close($link); $read = $error = $reject = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $read[] = $error[] = $reject[] = $link; mysqli_poll($read, $error, $reject, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br><br>  <b>UPD:</b> <a href="https://bugs.php.net/bug.php%3Fid%3D63398">Bug is</a> open, quickfix is ‚Äã‚Äãalready there </div><p>Source: <a href="https://habr.com/ru/post/155377/">https://habr.com/ru/post/155377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155367/index.html">Behind the Scenes of Formula 1</a></li>
<li><a href="../155369/index.html">AWS: VPC now supports Micro instances</a></li>
<li><a href="../155371/index.html">How does microelectronic production work and what should we build a house?</a></li>
<li><a href="../155373/index.html">In France, they want to force search engines to pay for content. Google threatened to remove French sites from its index</a></li>
<li><a href="../155375/index.html">Stream from mpd to smartphone or the entire music collection in your pocket</a></li>
<li><a href="../155379/index.html">Several interesting features of Windows 8</a></li>
<li><a href="../155383/index.html">Kyocera - applications and tools. Part 3 - for the economical and loaded</a></li>
<li><a href="../155389/index.html">Smartphone on Android with e-ink: a week without recharging</a></li>
<li><a href="../155391/index.html">Git up and everything is all</a></li>
<li><a href="../155393/index.html">Competition from Viope for gameplay around the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>