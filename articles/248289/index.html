<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart alarm clock for smart home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What not to collect on avr, but in the end the clock still turns out 
 from amateur radio forums 

 Many residents of megalopolises (and not only) oft...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart alarm clock for smart home</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>What not to collect on avr, but in the end the clock still turns out</i> <br>  from amateur radio forums <br></blockquote><br><img src="https://habrastorage.org/files/8a4/702/281/8a47022811af455aae5b973785b93d3d.jpg" align="left" alt="image">  Many residents of megalopolises (and not only) often experience discomfort from having to wake up early in the morning.  Especially in winter - it is dark outside the window, the body thinks that it is still night, hence the feeling of lack of sleep and poor health.  At the same time, waking up in the morning sunlight is usually noticeably easier.  It was decided to try to "deceive" the body, using for awakening the gradually increasing brightness of artificial lighting.  Alarm clocks with this effect are ready-made, but they are quite expensive, in addition, the project was made more for my own pleasure. <br><br>  On Habr√©, quite often various remotely controlled sockets and light bulbs controlled by Wi-Fi are mentioned, in this project a similar problem is solved by means of IR control. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/46c/fcf/1ab/46cfcf1ab8834def8c50594749de598b.jpg" align="right" alt="image">  Quite a long time ago, a Chinese-made LED lamp with an IR remote control was purchased at ebay auction.  The lamp has a standard E27 base, 9W power and subjectively has the brightness of a 40W incandescent lamp.  From the remote you can turn on / off the lamp, as well as set 5 different levels of brightness. <br><br>  The idea was the following - to assemble an alarm clock on the AVR microcontroller, which will advance in advance of the sound signal to smoothly increase the brightness of this lamp by transmitting IR commands.  The lamp is screwed in instead of one of the ordinary chandeliers of the overhead lighting.  Half an hour before the set time, the light turns on at the minimum brightness, then the brightness gradually increases to 100%. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result of the work, I wanted to see, if not a masterpiece, then at least something in a decent-looking body, for which it was decided to make an alarm clock in a partially glass case with touch controls.  Atmel offers the QTouch library for its microcontrollers, which allows you to implement touch-sensitive buttons in your devices at minimal cost.  In this project, I just wanted to try this remarkable library in practice. <br><br>  The final design was as follows: a one-sided printed circuit board on which LED indicators, an IR LED, a photo sensor, a power connector are installed on the one side (front), and the rest of the elements are soldered on the other side (tracks side).  Then the indicators are closed with a plate of tinted glass, on the back of which in the right places are glued touch buttons.  From the back side, the board is covered with a case, which is a plastic box of a suitable size.  At the same time we have an aesthetic appearance in the absence of mechanical buttons. <br><br>  So let's get down to the design.  To begin with, we will define the microcontroller - it must have a sufficient number of pins for the implementation of the display and touch buttons, and also be in a case that is not very difficult for manual soldering.  ATMEGA324P satisfies these conditions (44 legs and lead pitch 0.8 mm).  Choosing a display - as such, it was decided to use a LED display with large numbers (1.8 ‚Äù).  The display consists of four single-digit indicators with a common anode.  Typically, large-sized display segments consist of several series-connected LEDs, so a five-volt power source is indispensable, and a power source of at least 9 V is required to power the clock. <br><br><img src="https://habrastorage.org/files/d74/fe6/34a/d74fe634a0a948dd94b76cc6b0bfddf7.jpg" align="left" alt="image"><br><br>  To control such a display you will need a driver.  The display has a common anode, so we proceed as follows - the display cathodes through current-limiting resistors will be connected to the ULN2803 microcircuit, and for the anodes we will provide separate transistor switches.  The ULN2803 chip consists of 8 transistors with resistors in the base circuit, which makes it very convenient for such an application. <br><br>  Next, the actual clock, more precisely, the RTC chip.  As such, the DS3231 was chosen - a chip with a built-in quartz resonator and a minimum number of external components.  The manufacturer promises the accuracy of the course of a few seconds per year.  Also, due to the built-in temperature meter for thermal compensation of quartz frequency drift, we get a ‚Äúfree‚Äù thermometer showing the temperature inside the case. <br><br>  For the call, the ZP-19 piezo-emitter is used. <br><br>  As an "actuator", which distinguishes an alarm clock from millions of similar ones, there is an IR LED in the circuit, which will form commands for the light bulb. <br><br>  To power the clock from the mains, an unstabilized 12 V power supply is used. To power the microcontroller, a separate power supply must be provided in the circuit - we put the well-known linear power supply LM7805. <br><br>  In conclusion, we will provide in the scheme a two-color LED for indicating the state of the alarm, as well as a photo sensor for realizing the change in the brightness of the indicator depending on the level of illumination.  The photo sensor will be connected to the comparator, therefore, it is necessary to provide a trimming resistor to adjust the threshold. <br>  <a href="">The scheme</a> is ready, you can start programming and manufacturing.  Before manufacturing, most of the program was tested in the Proteus simulator, in which all the design was done. <br><br>  Unfortunately, it was not possible to simulate the work of the QTouch library in the proteus, so it was necessary to pre-assemble part of the circuit on the breadboard and ‚Äúplay‚Äù with the capacitive sensors separately.  The library performed well - a clear response in all cases. <br><br>  The next element that required experimental testing was the remote control of the light bulb itself.  Connect the photodiode to the oscilloscope and look at the signal by pressing the console buttons: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6cd/7ba/86d/6cd7ba86d6f04b2795e9685431306f40.png" alt="image" width="450"></div><br><br>  From the picture it is clear that the NEC protocol is used - one of the well-known infrared control protocols, where information is encoded by the duration of the pause between pulses.  A logical 1 is a pause of 1.7 ms, a logical 0 is a pause of 0.6 ms.  After the start sequence (9 ms pulse and 4.5 ms pause) 32 bits are transmitted: address, inverse address, command, inverse command.  The protocol is well documented, and it is not difficult to find a detailed description on the Internet. <br><br>  Using an oscilloscope, we also determine the transmission frequency - it turned out to be 38 KHz.  So, the necessary codes of the remote buttons: <br><br><img src="https://habrastorage.org/files/075/003/9c0/0750039c025f40b595e96ccb08cb780e.png" alt="image" width="200"><br><br>  We write the functions that will form the IR commands, check with the layout - the light turns on, the brightness is adjusted - it means everything is almost ready, you can assemble the clock. <br><br>  The board was made by the LUT method.  I have quite a modest experience in the manufacture of boards using this method, but it turned out quite tolerant.  Not without jambs - I forgot to provide the RESET pin in the programming connector on the circuit, I had to solder it separately.  In the photo just collected fee, with flux still not washed in places. <br><br><img src="https://habrastorage.org/files/d47/401/f6f/d47401f6f6394a7991b834f342dc7bd1.jpg" alt="image"><br><br>  Once again, we check, turn on, upload the firmware and start the debugging process.  After everything works, you can close everything in the case. <br><br>  We continue to catch mistakes.  As already mentioned, it was decided to order a plate made of tinted glass with a finished edge and four holes as the main body element, through which it will be attached to the board.  If someone wants to make a similar design - I advise you to design the board after ordering the plate.  I found a company that promised any work with glass according to sketches, with high precision, modern machine tools, etc., in practice, the mounting holes were drilled with a centimeter difference from the sketch.  However, I didn‚Äôt make any claims, I just adjusted the fee a little.  Another mistake was the wrong choice of the diameter of the holes in the glass - initially for fixing I wanted to use decorative nuts with a flat surface.  These were found on ebay in the store accessories for metalworkers - used, apparently, to simulate the rivets on the belts (the so-called <a href="http://www.ebay.com/sch/i.html%3F_nkw%3DChicago%2BScrews">Chicago Screws</a> ).  However, when the nuts arrived, it turned out that they had a threaded part diameter of 5 mm, and the holes in the glass plate were 4 mm, so the idea had to be abandoned and the glass was fixed with ordinary countersunk bolts, which were then simply painted with a marker. <br><br>  On the reverse side of the glass are touch sensors - for this we use aluminum tape.  To the sensors, pieces of foamed polyethylene (from packages with ebay) are pressed against the wires from the board.  There is an indicator LED under the alarm button - the logic of its operation is as follows: if the alarm rings in the next 24 hours - green, will not ring - red, all alarms are off - the LED does not light up.  The alarm clock symbol (bell) is also translated into Scotch tape using the LUT method, carefully cut it out and glue it to the glass. <br><br>  Tinted glass has shown itself to be excellent in working with touch buttons and aesthetic design of the display, but it very significantly attenuates IR radiation.  One IR-LED works uncertainly, so that in addition to the gap in the track, another was additionally soldered, which shines into the hole in the upper wall of the housing.  As a result, we have a confident operation, no worse than the regular remote. <br><br>  According to the results of the operation of the alarm clock, it can be said that the idea has fully justified itself - it is indeed much easier to wake up with such a device on a dark winter morning.  Additionally, we have a bedside remote lighting switch. <br><br>  The article was written more out of a desire to share the idea of ‚Äã‚Äãhow to implement this with minimal effort, but if someone wants to repeat the device in this form, it‚Äôs ready to provide the firmware and answer questions. <br><br>  Update: <br>  Link to the firmware sources, circuit and board in Proteus format: <br>  <a href="">clock.zip</a> <br><br><h3>  List of sources: </h3><br><ul><li>  <a href="http://www.atmel.com/ru/ru/products/touchsolutions/touchsoftware/default.aspx">Atmel QTouch Library</a> </li><li>  <a href="http://radiohlam.ru/teory/nec.htm">NEC protocol description</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/248289/">https://habr.com/ru/post/248289/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248279/index.html">Practice "Intel IoT". Galileo Gen2 - First dating</a></li>
<li><a href="../248281/index.html">Zoho CRM. Overview</a></li>
<li><a href="../248283/index.html">Introduction to the development of web-applications on PSGI / Plack. Part 3. Starman</a></li>
<li><a href="../248285/index.html">Free https certificate + integration into Apache ‚Äì TomCat</a></li>
<li><a href="../248287/index.html">Critical Vulnerability in PolarSSL</a></li>
<li><a href="../248291/index.html">Grape: no single rails, part 2</a></li>
<li><a href="../248293/index.html">The digest of interesting materials from the world of Drupal # 3</a></li>
<li><a href="../248295/index.html">Flurry retention rates: very important and very incomprehensible</a></li>
<li><a href="../248301/index.html">How we connected DigitalOcean under Christmas</a></li>
<li><a href="../248303/index.html">Publish configuration 1C on GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>