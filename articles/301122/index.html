<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Type Analysis with Proxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of describing the next set of tests for the Node.js module, I caught myself thinking "again type checking". Each parameter of a class m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Type Analysis with Proxy</h1><div class="post__text post__text-html js-mediator-article"><p>  In the process of describing the next set of tests for the Node.js module, I caught myself thinking "again type checking".  Each parameter of a class method, each property set using a setter must be checked.  Of course, you can just score or supplement everything with code that implements checks or try to describe everything with decorators.  But this time we will do a little differently. <a name="habracut"></a></p><br><h2>  A bit of emotion and sweetness </h2><br><hr><br><p>  The arrival of the ES6 specification and its implementation in various engines gives us a lot of amazing things, I think it's stupid to stand aside from this holiday.  Armed with the desire to dive deeper into the new specification and simplify your life a bit, we will try to implement type analysis using such a wonderful thing as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a> .  Of course, we will use other ES6 buns natively supported by Node.js version 6.1.0, such as: classes, maps, arrow functions, etc. </p><br><h2>  How to use it </h2><br><hr><br><ol><li><p> Install the <code>npm i typedproxy</code> .  We connect the module </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 1. const Typed = require('typedproxy');</span></span></code> </pre> <br></li><li><p>  We create a class, we use static methods, methods, static properties and properties.  When describing the parameters of methods and setters, we use a special syntax. </p><br></li><li><p>  Namely: each parameter name used in methods (including static) must begin with a sequence of characters corresponding to the type.  A type is nothing more than a property of a so-called <em>type object</em> .  Where the name of the property corresponds to the name of the type, and the value of the property is a function that implements the verification of the transferred value.  In other words, you can define as many of your own types of variables. </p><br></li><li><p>  Read more about <em>object types</em> .  This object should list <strong>all</strong> types that are used or planned for use in your class.  If you forget to fulfill the specified condition, it will result in a <em>RangeError</em> during execution. <br>  And so little code to understand the principles: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 2.  ,   . class TestClass { // 3.       myRange. constructor(myRangeValue){ this.value = myRangeValue; } }; // 4.   .      myRange. const types = { 'myRange' : (value) =&gt; { if(value &lt; 0 || value &gt; 10) { throw new TypeError(`parameter must be more than 0 and less than 10, not ${value}`); } } };</span></span></code> </pre> <br><p>  As we can see, <strong>myRange</strong> Value is the name of the parameter, the check of which is defined in the property <em>of the type object</em> with the corresponding name <strong>myRange</strong> . </p><br></li><li><p>  Now, in order to enable type checking, it is necessary to make the class typed (this concept is of course used within the framework of the module used, it is not necessary here to attract concepts from the specification).  And we do it like this, having the previously described TestClass class and types: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 5. const TypedTestClass = new Typed(TestClass, types);</span></span></code> </pre> <br></li><li><p>  Above, we got a new class, TypedTestClass, which is actually a proxy instance, but more on that <a href="https://habr.com/ru/post/301122/">later</a> .  We use it instead of TestClass, that is, we create instances, we call static methods of both the class itself and its instance.  In general, doing all that we wanted to do with the original TestClass class. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 6.    . /*ok -    */ const instance1 = new TypedTestClass(5); /*TypeError -     */ const instance2 = new TypedTestClass(11); /*RangeError -           */ const instance3 = new TypedTestClass(); /*RangeError -           */ const instance3 = new TypedTestClass(1, 2);</span></span></code> </pre> <br><p>  As you can see, passing an invalid parameter type now causes an error.  Passing an incorrect number of parameters (no matter whether they meet the requirements of the type or not) also causes an error. </p><br></li><li>  Usage Note: <br>  7.1.  If you use inheritance (for example through <code>extends</code> ) you need to type the final class, not the whole chain.  Well, firstly, why unnecessary variables and extra work, and secondly, we just will not work. <br>  7.2.  If you use the default parameters, then this module <strong>is</strong> not suitable <strong>for</strong> you (we are working on it). </li></ol><br><div class="spoiler">  <b class="spoiler_title">Together</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 1. const Typed = require('typedproxy'); // 2.  ,   . class TestClass { // 3.       myRange. constructor(myRangeValue){ this.value = myRangeValue; } }; // 4.   .      myRange. const types = { 'myRange' : (value) =&gt; { if(value &lt; 0 || value &gt; 10) { throw new TypeError(`parameter must be more than 0 and less than 10, not ${value}`); } } }; // 5. const TypedTestClass = new Typed(TestClass, types); // 6.    . /*ok -    */ const instance1 = new TypedTestClass(5); /*TypeError -     */ const instance2 = new TypedTestClass(11); /*RangeError -           */ const instance3 = new TypedTestClass(); /*RangeError -           */ const instance3 = new TypedTestClass(1, 2);</span></span></code> </pre> </div></div><br><h2>  How it works </h2><br><hr><br><p>  For those who understand the code thousands of words and a couple of pictures: a project with tests <a href="https://github.com/antonecma/TypedProxy">here</a> .  For those who have retained the desire to understand how it works in words, I will try to explain further. </p><br><h3>  The relationship of the names of the parameters and the object describing the types: </h3><br><p><img src="https://habrastorage.org/files/b5f/573/354/b5f57335472449a5b72da9c64546f263.jpg" alt="relation"></p><br><p>  As can be seen in the figure and as mentioned above, it is necessary to establish a direct relationship between the names of the parameters of the methods and the <em>types</em> used in our class.  That is, the name of the parameter must begin with a sequence of characters corresponding to the type. <br>  It is necessary that the function producing the type check would work <a href="https://habr.com/ru/post/301122/">(let's talk about it a little later)</a> .  In principle, if the implementation of this function does not suit you, you can pass your third parameter when creating a typed class. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Typed = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'typedproxy'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }; const types = { // ... }; const TypedTestClass = Typed(TestClass, types, (types, someFunction, ...args) =&gt; {/*   */});</span></span></code> </pre> <br><h3>  Schematic work </h3><br><p><img src="https://habrastorage.org/files/94b/b36/a6e/94bb36a6ec40495690c55eb6d19bc37d.jpg" alt="workingscheme"></p><br><p>  When typing a class, a new Proxy is created and returned.  This is the proxy and is a class performing type analysis.  Its essence consists in applying the <a href="https://habr.com/ru/post/301122/">function of type checking</a> and determining the necessary <a href="https://habr.com/ru/post/301122/">traps</a> for intercepting a call to static methods, creating new instances, etc. </p><br><p>  The type checking function (green-red squares in the figure) works as follows: </p><br><ol><li>  Gets a list of the types used, the function and the parameters passed to the function. </li><li>  Retrieves (using a regular expression) the names of the parameters that the function expects to accept. </li><li>  Checks whether the number of parameters transmitted and expected to be received is the same.  If differently throws an exception. </li><li>  Checks whether the name of the expected parameter begins with a sequence of characters corresponding to one of the types.  If does not coincide with one throws an exception. </li><li>  Performs the function of the corresponding type. </li></ol><br><p>  New proxy contains only three pitfalls: <em>get</em> , <em>set</em> and <em>construct</em> . </p><br><ol><li>  get - when accessing a static method will return a proxy that will perform type checking, and only then redirect to the static method of the original class. </li><li>  set - when you try to change the value of a static class property, if there is a setter, it will perform type checking, and only then set the specified value. </li><li>  construct - when calling a <em>typed</em> class with the <code>new</code> operator, checks the types of parameters passed to the constructor.  After that, it creates an instance of the original class and a proxy based on it (with two get and set traps that work similarly with the above methods 1 and 2). </li></ol><br><p>  Of course, this looks quite monstrous, and in fact it is.  This module displays only the idea that requires improvements and revisions.  I don‚Äôt even want to think about performance; rather, you can use it by sacrificing it for the sake of convenience and time savings. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/301122/">https://habr.com/ru/post/301122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301112/index.html">Online video interview with PayOnline CEO Marat Abasaliyev</a></li>
<li><a href="../301114/index.html">DevConf 2016: Interview with one of the developers of Yii</a></li>
<li><a href="../301116/index.html">Digital asset protection is a strategic task.</a></li>
<li><a href="../301118/index.html">E-mail delivery guide or how not to become a ‚Äúspammer‚Äù</a></li>
<li><a href="../301120/index.html">Non-technological leak protection problems. Field Engineer Practice</a></li>
<li><a href="../301126/index.html">Koajs 2.0: a new generation of the framework of the new generation</a></li>
<li><a href="../301128/index.html">Work with ListView in Xamarin.Android</a></li>
<li><a href="../301132/index.html">Optical fibers for telecommunications: quartz and not only</a></li>
<li><a href="../301134/index.html">Firsthand case: how Igor Kalganov‚Äôs IT service ‚Äú33 Elephants‚Äù began to compete with real estate managers</a></li>
<li><a href="../301136/index.html">Animated stub "Sorry, your browser doesn't support WebGL"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>