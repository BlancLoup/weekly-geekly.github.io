<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving network security with Content Security Policy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content Security Policy (CSP) is a security mechanism that can be used to protect against content injection attacks, such as cross-site scripting (XSS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving network security with Content Security Policy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/de7/dad/f55/de7dadf55b794ee5ba1af9f773cd6cf9.jpg"><br><br>  Content Security Policy (CSP) is a security mechanism that can be used to protect against content injection attacks, such as cross-site scripting (XSS).  CSP describes secure sources for loading resources, sets rules for using embedded styles, scripts, and dynamic JavaScript evaluation ‚Äî for example, using eval.  Downloading from non-whitelist resources is blocked. <br><a name="habracut"></a><br><h3>  Operating principle </h3><br>  The CSP is now a candidate for recommendations <a href="http://www.w3.org/2011/webappsec/">from the W3C consortium</a> .  To use the policy, the page must contain an HTTP <code>Content-Security-Policy</code> header with one or more directives that are whitelists.  Version 1.0 supports the following directives: <br><br><ul><li> <code>default-src</code> </li> <li> <code>script-src</code> </li> <li> <code>object-src</code> </li> <li> <code>style-src</code> </li> <li> <code>img-src</code> </li> <li> <code>media-src</code> </li> <li> <code>frame-src</code> </li> <li> <code>font-src</code> </li> <li> <code>connect-src</code> </li> </ul><br>  Default <code>default-src</code> lists the allowed default sources for the remaining directives.  If any directive is not specified in the header, the policy is applied according to the <code>default-src</code> list. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For all directives, the following rules apply: <br><br><ul><li>  <code>self</code> used to reference the current domain. </li><li>  In the list, URLs are separated by spaces. </li><li>  If nothing is loaded within this directive, then <code>none</code> is applied.  For example, <code>object-src 'none'</code> prohibits the download of any plug-ins, including Java and Flash. </li></ul><br>  The simplest example of a policy that allows the loading of resources only on a specified domain: <br><br> <code>Content-Security-Policy: default-src 'self';</code> <br> <br>  Attempting to download resources from other domains will be stopped by the browser with a notification in the console: <br><br><img src="https://habrastorage.org/files/d83/2ae/338/d832ae338b0a4792bffa2b019939df8c.png"><br><br>  By default, CSP restricts the execution of JavaScript by disabling embedded scripts and dynamically evaluating code.  In combination with white lists, this allows you to prevent content injection attacks.  For example, an XSS attack using an inline script tag: <br><br><img src="https://habrastorage.org/files/c96/7aa/e5a/c967aae5ab854076ad47c316123cc34d.png"><br><br>  Loading external scripts that are not included in the CSP will also be stopped: <br><br><img src="https://habrastorage.org/files/b9d/de4/410/b9dde44107a543e584fe6404ada3f9d1.png"><br><br>  At the moment, you cannot enter paths in the URL list ( <code>http://cdn.example.com/path</code> ), you can only list the domains themselves ( <code>http://cdn.example.com</code> ).  But wildcards are supported, so you can describe all the subdomains at once ( <code>http://*.example.com</code> ). <br><br>  Directives do not inherit rights from previous directives.  Each directive included in the CSP header must contain a list of allowed domains / subdomains.  In the following example, <code>default-src</code> and <code>style-src</code> contain the keyword <code>self</code> , and <code>script-src</code> and <code>style-src</code> contain the domain <code>http://cdn.example.com</code> : <br><br><pre> <code class="html hljs xml">Content-Security-Policy: default-src 'self'; style-src 'self' http://cdn.example.com; script-src http://cdn.example.com;</code> </pre><br>  If you need to specify hosts to download data, then you need to specify the <code>data: img-src 'data';</code> keyword <code>data: img-src 'data';</code>  . <br><br>  In addition to domain lists, the <code>script-src</code> and <code>style-src</code> directives support the keywords <code>unsafe-inline</code> and <code>unsafe-eval</code> . <br><br><ul><li>  <code>unsafe-inline</code> used to resolve inline styles and scripts <code>style</code> and <code>script</code> .  This keyword also allows CSS <code>style</code> inline attributes, inline event handlers (onclick, onmouseover, etc.) and javascript links like <code>a href="javascript:foobar()"</code> .  CSP works on the principle ‚Äúif something is not mentioned, it means prohibited‚Äù.  That is, in the absence of the <code>unsafe-inline</code> all inline tags <code>style</code> and <code>script</code> will be blocked. </li><li>  <code>unsafe-eval</code> used only in the <code>script-src</code> directive.  If this keyword is not specified, then any dynamic code evaluation is blocked, including the use of <code>eval</code> , the constructor of functions, and the transfer of strings in <code>setTimeout</code> and <code>setInterval</code> . </li></ul><br><h3>  Browser Support </h3><br>  Currently, <a href="http://caniuse.com/contentsecuritypolicy">most browsers and their versions already support CSP 1.0</a> .  IE distinguished itself again: in 10 and 11 versions, only partial support was provided with the <code>X-Content-Security-Policy</code> header.  Apparently, only the optional <a href="http://www.w3.org/TR/CSP2/">sandbox</a> directive is supported. <br><br><h3>  Receive CSP Abuse Reports </h3><br>  As already mentioned, reports of all security policy violations are logged in the browser console.  This is convenient while you are developing the site, but after deployment you need a more practical way to get reports on violations.  For this, you can use the directive <code>report-uri</code> .  Every time a CSP violation is registered, the directive sends an HTTP POST request to the specified address.  The request body contains a JSON object, which contains all the necessary details. <br><br>  Suppose we have such a CSP: <br><br><pre> <code class="html hljs xml">Content-Security-Policy: default-src 'self'; report-uri: https://example.com/csp/report;</code> </pre><br>  This means that the browser can download resources only from our own domain.  But we need to use Google Analytics, which will try to download JavaScript from <a href="http://www.google-analytics.com/">www.google-analytics.com</a> .  And this is a violation of our CSP.  In this case, <code>report-uri</code> will send a request with the following JSON: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"csp-report"</span></span>: { <span class="hljs-string"><span class="hljs-string">"blocked-uri:"</span></span> <span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com"</span></span> <span class="hljs-string"><span class="hljs-string">"document-uri:"</span></span> <span class="hljs-string"><span class="hljs-string">"http://example.com/index.html"</span></span> <span class="hljs-string"><span class="hljs-string">"original-policy"</span></span>: <span class="hljs-string"><span class="hljs-string">"default-src 'self'; report-uri http://example.com/csp/report"</span></span> <span class="hljs-string"><span class="hljs-string">"referrer:"</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">"violated-directive"</span></span>: <span class="hljs-string"><span class="hljs-string">"default-src 'self'"</span></span> } }</code> </pre><br><h3>  Content-Security-Policy-Report-Only </h3><br>  If you are not sure yet whether it is worth implementing CSPs, you can try using <code>Content-Security-Policy-Report-Only</code> instead of the <code>Content-Security-Policy</code> header.  In this case, the CSP will log violations without any blocking of resources.  You can even use both <code>Content-Security-Policy</code> and <code>Content-Security-Policy-Report-Only</code> at the same time, running around certain configurations to the second. <br><br><h3>  Spelling title </h3><br>  The HTTP header can be written directly in the configuration files on the server: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># Apache config Header set Content-Security-Policy "default-src 'self';" # IIS Web.config &lt;system.webServer&gt; &lt;httpProtocol&gt; &lt;customHeaders&gt; &lt;add name="Content-Security-Policy" value="default-src 'self';" /&gt; &lt;/customHeaders&gt; &lt;/httpProtocol&gt; &lt;/system.webServer&gt; # nginx conf file add_header Content-Security-Policy "default-src 'self';";</span></span></code> </pre><br>  Also, many programming languages ‚Äã‚Äãand frameworks allow you to add headers programmatically (for example, <a href="http://php.net/manual/en/function.header.php">PHP</a> , <a href="&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhNp8DwsG971B45N-atJZZU-IDnBg#">Node.js</a> ): <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># PHP example header("Content-Security-Policy: default-src 'self'");</span></span></code> </pre><br><pre> <code class="javascript hljs"># Node.js example request.setHeader(<span class="hljs-string"><span class="hljs-string">"Content-Security-Policy"</span></span>, <span class="hljs-string"><span class="hljs-string">"default-src 'self'"</span></span>);</code> </pre><br><h3>  CSP in the wild </h3><br>  Let's see how CSP is implemented on Facebook: <br><br><pre> <code class="html hljs xml">default-src *; script-src https://*.facebook.com http://*.facebook.com https://*.fbcdn.net http://*.fbcdn.net *.facebook.net *.google-analytics.com *.virtualearth.net *.google.com 127.0.0.1:* *.spotilocal.com:* 'unsafe-inline' 'unsafe-eval' https://*.akamaihd.net http://*.akamaihd.net *.atlassolutions.com; style-src * 'unsafe-inline'; connect-src https://*.facebook.com http://*.facebook.com https://*.fbcdn.net http://*.fbcdn.net *.facebook.net *.spotilocal.com:* https://*.akamaihd.net wss://*.facebook.com:* ws://*.facebook.com:* http://*.akamaihd.net https://fb.scanandcleanlocal.com:* *.atlassolutions.com http://attachment.fbsbx.com https://attachment.fbsbx.com;</code> </pre><br>  Note the use of wildcards to describe subdomains, as well as port numbers in <code>connect-src</code> . <br><br>  And now the Twitter option: <br><br><pre> <code class="html hljs xml">default-src https:; connect-src https:; font-src https: data:; frame-src https: twitter:; frame-ancestors https:; img-src https: data:; media-src https:; object-src https:; script-src 'unsafe-inline' 'unsafe-eval' https:; style-src 'unsafe-inline' https:; report-uri https://twitter.com/i/csp_report?a=NVQWGYLXFVZXO2LGOQ%3D%3D%3D%3D%3D%3D&amp;ro=false;</code> </pre><br>  Here <code>https:</code> is written everywhere, that is, SSL is enforced. <br><br><h3>  CSP Level 2 </h3><br>  Also a <a href="http://www.w3.org/TR/CSP2/">candidate for recommendation</a> .  The following innovations are made in CSP Level 2: <br><br><ul><li>  <code>base-uri</code> : allows a document to manipulate the page's base <a href="https://ru.wikipedia.org/wiki/URI">URI</a> . </li><li>  Instead of <code>frame-src</code> , <code>child-src</code> is now used. </li><li>  <code>form-action</code> : allows the document to place HTML forms. </li><li>  <code>frame-ancestors</code> : governs how to embed this document in other documents.  It works like a X-Frame-Options header, which is likely to be replaced. </li><li>  <code>plugin-types</code> : allows downloading specific plugins - Flash, Java, Silverlight, etc. </li></ul><br>  There are two new fields in JSON contained in the abuse reports: <br><br><ul><li>  <code>effective-directive</code> : here is the name of the directive that was violated. </li><li>  <code>status-code</code> : HTTP status code of the requested resource.  If the violating request was not made via HTTP, then put 0. </li></ul><br>  Also in CSP Level 2, it became possible to resolve inline scripts and styles using nonce values ‚Äã‚Äãand hashes. <br><br>  Nonce is a string variable generated randomly on the server.  It is added to the CSP header: <br><br><pre> <code class="html hljs xml">Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-Xiojd98a8jd3s9kFiDi29Uijwdu';</code> </pre><br>  and in the inline script tag: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Script won't run as it doesn't contain a nonce attribute"</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nonce</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Eskdikejidojdk978Ad8jf"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Script won't run as it has an invalid nonce"</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nonce</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Xiojd98a8jd3s9kFiDi29Uijwdu"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'Script runs as the nonce matches the nonce in the HTTP header'</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  If you want to use hashes, you first need to generate them on the server and include them in the CSP header, respectively, in the <code>style-src</code> or <code>script-src</code> directives.  Before rendering the page, the browser calculates the hash of the script / style, and if it matches the specified one, then execution is allowed. <br><br>  An example of a hash generated from a string <code>console.log('Hello, SitePoint');</code>  using the Sha256 (base64) algorithm. <br><br><pre> <code class="html hljs xml">Content-Security-Policy: default-src 'self'; script-src 'self' 'sha256-V8ghUBat8RY1nqMBeNQlXGceJ4GMuwYA55n3cYBxxvs=';</code> </pre><br>  During page rendering, the browser for each inline script calculates hashes and compares with those listed in the CSP.  The above hash allows you to run the script: <br><br> <code>&lt; sript &gt;console.log('Hello, SitePoint');&lt; /sript &gt; <br></code> <br>  Please note that spaces do matter, so these scripts will not be executed: <br><br> <code>&lt;sript&gt; console.log('Hello, SitePoint');&lt;/sript&gt; <br></code> <br> <code>&lt;sript&gt;console.log('Hello, SitePoint'); &lt;/sript&gt; <br></code> <br><h3>  Finally </h3><br>  If you have experience using CSP, positive or negative, please share in the comments.  It would also be interesting to learn about non-standard tasks that you solved using CSP. </div><p>Source: <a href="https://habr.com/ru/post/271575/">https://habr.com/ru/post/271575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271565/index.html">Ruli24: perfect tuning for your company</a></li>
<li><a href="../271567/index.html">How to solve problems with the payment gateway: Airbnb Case</a></li>
<li><a href="../271569/index.html">12.12 at 12:00, come to Community DevCamp in Moscow</a></li>
<li><a href="../271571/index.html">Introduction to AutoCAD Architecture</a></li>
<li><a href="../271573/index.html">First February - International Aid Day</a></li>
<li><a href="../271577/index.html">We will load everything: demonstration of the –ÜXIA solution for load tests</a></li>
<li><a href="../271581/index.html">How to master PowerShell professionally in 5 days and become a ‚Äúlazy‚Äù administrator?</a></li>
<li><a href="../271583/index.html">Atomic processing of data blocks without blocking</a></li>
<li><a href="../271585/index.html">We need less powerful programming languages.</a></li>
<li><a href="../271587/index.html">Microsoft has withdrawn the updated Windows 10 from the download portal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>