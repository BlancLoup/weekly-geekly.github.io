<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ELK on Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many have read about using Elasticsearch, Logstash and Kibana to collect and analyze logs, but often articles start with a long manual on how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ELK on Docker</h1><div class="post__text post__text-html js-mediator-article">  I think many have read about using Elasticsearch, Logstash and Kibana to collect and analyze logs, but often articles start with a long manual on how to raise ELK services and get them to work together. <br>  Here I want to talk about quick start with Docker. <br><a name="habracut"></a><br>  I will write in advance that the article is aimed at those who are already familiar with Docker and have a desire to raise the ELK stack for familiarization or future use in production.  And for those who do not know if they need ELK, I recommend <a href="https://habrahabr.ru/company/uteam/blog/278729/">reading the Kibana-mother</a> article <a href="https://habrahabr.ru/company/uteam/blog/278729/">or Why do you need logs in general?</a>  . <br><br>  So, ideally, the task is to find the container from ELK on hub.docker.com and run it.  I suggest to do so with some modifications.  In the example, let's consider sending nginx logs to elasticSearch. <br><br>  The abbreviation of ELK services includes the following tasks: <br>  1) Processing incoming data and delivering it to <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> - <a href="https://www.elastic.co/products/logstash">Logstash</a> service is responsible for this <br>  2) Search engine and data access interface - Elasticsearch and <a href="https://www.elastic.co/products/kibana">Kibana</a> are responsible for this 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But for good Logstash should not be responsible for the delivery of data.  Data <a href="https://www.elastic.co/products/beats/filebeat">transfer</a> is delegated to the fourth service - <a href="https://www.elastic.co/products/beats/filebeat">Filebeat</a> . <br><br>  The general scheme of work is as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa6/7bf/3f8/aa67bf3f8283046babe854a0e2e30127.png" alt="image"><br><br>  The network may contain a different number of services from which data must be collected and the Filebeat service is the logging provider for the Logstash service. <br><br>  In other words, I mean that we need to have another container with the Filebeat service. <br><br>  Let's get down to business.  I strongly recommend that you use the Docker Compose service - to describe the parameters in one YAML format file, it is much more convenient than executing commands with parameters each time.  And at the debugging stage, it will be necessary to start and stop more than once. <br><br>  1. Create a folder with the project, for example myElk, and create a file with the following name docker-compose.yml, which we will add. <br><br>  2. We look for and find a container with a filebeat.  I recommend to take this <a href="https://hub.docker.com/r/olinicola/filebeat/">olinicola / filebeat</a> or docker pull olinicola / filebeat <br>  Setting up a container with a filebeat is to prepare a configuration file in YAML format for the filebeat service. <br>  Here it will look like this: <br><br><pre><code class="xml hljs">prospectors: - paths: - "/etc/logs/nginx/access.log" document_type: nginx-access - paths: - "/var/log/nginx/error.log" document_type: nginx-error output: logstash: hosts: ["elk:5044"] tls: certificate_authorities: - /etc/pki/tls/certs/logstash-beats.crt timeout: 15 file: path: "/tmp/filebeat"</code> </pre> <br><br>  In short, we take nginx logs from a specific server location and send them to the ELK server, which is ready to receive messages from us on port 5044. <br>  In this configuration file, "elk" - the name of the linked container - is more detailed below. <br>  I also additionally indicated uploading to a file, for easier debugging at the startup stage. <br><br>  At this stage, you can already supplement docker-compose.yml with the following code: <br><br><pre> <code class="xml hljs">version: '2' services: filebeat: build: . image: [ imageId  filebeat] volumes: - /path/to/myElk/log/nginx:/etc/logs/nginx #  nginx - /path/to/myElk/filebeat:/etc/filebeat - /path/to/myElk/filebeat/tmp:/tmp/filebeat</code> </pre><br><br>  You can already start to lift the container with the docker-compose up command.  And to see how when changing the access.log file, the data will be sent to the file "/ tmp / filebeat", only at this stage there is no elk container, so it is better to comment out the output logstash. <br><br>  3. Ok, we have the first container with a filebeat.  Now we need a second container with ELK.  Go to <a href="https://hub.docker.com/">hub.docker.com</a> and find <a href="https://hub.docker.com/r/sebp/elk/">sebp / elk</a> or execute the docker pull sebp / elk command. <br><br>  Configure the ELK container. <br>  The only thing you need to configure here is logstash, and here are 2 options: a) leave everything as it is and it will work, since logstash in this container is already configured to receive logs from the nginx server. <br>  However, after you start, you will want to go on the path b), then there is a set up logs as you need.  Because from the way the logs are transferred to elasticsearch, it will be more or less convenient for you to analyze the data coming from nginx. <br>  So I will explain the logstash configuration files.  Log files that interest us the following: <br>  Input parameters: <br>  02-beats-input.conf - you can not touch <br><br><pre> <code class="xml hljs">input { beats { port =&gt; 5044 ssl =&gt; true ssl_certificate =&gt; "/etc/pki/tls/certs/logstash-beats.crt" ssl_key =&gt; "/etc/pki/tls/private/logstash-beats.key" } }</code> </pre><br><br>  Here we see that the service is ready to receive data on port 5044. <br>  Output Parameters: <br>  30-output.conf - you can not touch <br><br><pre> <code class="xml hljs">output { elasticsearch { hosts =&gt; ["localhost"] sniffing =&gt; true manage_template =&gt; false index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}" document_type =&gt; "%{[@metadata][type]}" } stdout { codec =&gt; rubydebug } }</code> </pre><br><br>  The most interesting is data conversion.  By default, the 11-nginx.conf file looks like this. <br><br><pre> <code class="xml hljs">filter { if [type] == "nginx-access" { grok { match =&gt; { "message" =&gt; "%{NGINXACCESS}" } } } }</code> </pre><br><br>  But maybe after playing with the NGINXACCESS template, you will want to process your logs exactly as you need it. <br>  To do this, you will need to change the filter section.  There may be several parameters - very well described here <a href="https://habrahabr.ru/post/165059/">We collect, parse and give logs using Logstash</a> . <br>  From myself I want to add that the following service works well for debugging grok filters: <a href="https://grokdebug.herokuapp.com/">Grok Debugger</a> <br><br>  3. Layout of 2 containers. <br><br>  Here I strongly recommend that you use the Docker Compose service - to describe the parameters in one YAML format file, it is much more convenient than executing commands with parameters each time.  And at the debugging stage, it will be necessary to start and stop more than once. <br>  To do this, you need to create a folder with a project, for example myElk, and create a file with the following name docker-compose.yml and, for example, the following: <br><br><pre> <code class="xml hljs">version: '2' services: filebeat: build: . image: [ imageId  filebeat] volumes: - /path/to/myElk/log/nginx:/etc/logs/nginx #  nginx - /path/to/myElk/filebeat:/etc/filebeat - /path/to/myElk/filebeat/tmp:/tmp/filebeat - /path/to/myElk/filebeat/certs:/etc/pki/tls/certs links: - "elk" depends_on: - "elk" #entrypoint: ./time-to-start.sh elk: image: [ imageId  elk] ports: - "5601:5601" #kibana - "9200:9200" #elastic - "5044:5044" #logstash beats filebeat</code> </pre><br><br>  This configuration file describes two containers and their relationship, and t <br>  Try running the container, if everything is OK, then at localhost: 5601 you will see the first Kibana page, where you will need to select the first index, it will be formed like filebeat- [date], type filebeat and if the data started to arrive, it will be generated automatically. <br><br>  For those who run docker on mac, you will need to forward ports through VirtualBox port forwarding in addition to localhost: 5601 being available on the host machine. </div><p>Source: <a href="https://habr.com/ru/post/282866/">https://habr.com/ru/post/282866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282852/index.html">Application server 1C on Linux</a></li>
<li><a href="../282854/index.html">Happy shipper</a></li>
<li><a href="../282858/index.html">MikroTik and 192.168.0.0/24</a></li>
<li><a href="../282860/index.html">Site protection against hacker attacks - Nemesida WAF</a></li>
<li><a href="../282862/index.html">Snow cooling system. White Datacenter Project</a></li>
<li><a href="../282870/index.html">Voice control of the smart home on the Z-wave via Siri</a></li>
<li><a href="../282874/index.html">ReactJS 15.0.2 Tutorial</a></li>
<li><a href="../282876/index.html">The digest of interesting materials for the mobile developer # 151 (April 25-May 3)</a></li>
<li><a href="../282878/index.html">Validation: inside entities or outside?</a></li>
<li><a href="../282884/index.html">My experience setting up an environment for web development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>