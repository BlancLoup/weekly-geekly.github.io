<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cowboy Web Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In this tutorial, I plan to show those who are not familiar with the Cowboy web server how to use it. For people who have experience with him...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cowboy Web Server</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  In this tutorial, I plan to show those who are not familiar with the Cowboy web server how to use it.  For people who have experience with him, this tutorial will hardly be interesting, but for those who know about Cowboy only by hearsay - welcome! <br><br>  What do we do: <br><ol><li>  The simplest installation and server startup </li><li>  Routing Overview, Static Maintenance </li><li>  Templating with ErlyDTL (Django Template Language for Erlang) </li></ol><br><a name="habracut"></a><br>  For convenience, we need rebar, the installation is simple: <br><pre><code class="bash hljs">&gt; git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/basho/rebar.git &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rebar &amp;&amp; ./bootstrap</code> </pre> <br>  Now we have an executable file rebar in the directory - we copy (and better link) it somewhere in $ PATH.  For example: <br><pre> <code class="bash hljs">&gt; sudo ln -s `<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>`/rebar /usr/bin/rebar</code> </pre><br><br>  And here we go! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The simplest installation and server startup </h4><br>  To begin with, we will create a directory and a skeleton for our future application, rebar will help us with this.  Go to somewhere where we will create the application and execute the following command: <br><pre> <code class="bash hljs">&gt; mkdir webserver &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> webserver &amp;&amp; rebar create-app appid=webserver</code> </pre><br>  The <code>rebar create-app appid=webserver</code> creates the skeleton of the simplest Erlang application and now our webserver directory should look like this: <br><img src="https://habrastorage.org/storage2/c76/cb0/845/c76cb0845dbe0ec0cbf9d422fc5a5738.png"><br>  The next thing we do is add a dependency on Cowboy, Sync, Mimetypes and Erlydtl.  Cowboy is our web server, Sync is a utility that will allow us not to reboot our server with every change and will recompile modified modules itself when updating, Mimetypes is a library for determining whether the extension matches the mimetype (useful when we are dealing with static feedback), and Erlydtl - template engine.  Create a configuration file for rebar called rebar.config: <br><div class="spoiler">  <b class="spoiler_title">Rebar.config content</b> <div class="spoiler_text"><pre> <code class="erlang hljs">{deps, [ {cowboy, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"https://github.com/extend/cowboy.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {sync, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/rustyio/sync.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {mimetypes, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/spawngrid/mimetypes.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {erlydtl, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/evanmiller/erlydtl.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}} ]}.</code> </pre><br></div></div><br>  Create a file src / webserver.erl, with the help of which we will just start and stop our server: <br><div class="spoiler">  <b class="spoiler_title">Src / webserver.erl content</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(webserver)</span></span>. <span class="hljs-comment"><span class="hljs-comment">%% API -export([ start/0, stop/0 ]). -define(APPS, [crypto, ranch, cowboy, webserver]). %% =================================================================== %% API functions %% =================================================================== start() -&gt; ok = ensure_started(?APPS), ok = sync:go(). stop() -&gt; sync:stop(), ok = stop_apps(lists:reverse(?APPS)). %% =================================================================== %% Internal functions %% =================================================================== ensure_started([]) -&gt; ok; ensure_started([App | Apps]) -&gt; case application:start(App) of ok -&gt; ensure_started(Apps); {error, {already_started, App}} -&gt; ensure_started(Apps) end. stop_apps([]) -&gt; ok; stop_apps([App | Apps]) -&gt; application:stop(App), stop_apps(Apps).</span></span></code> </pre><br></div></div><br>  Now the webserver: start () call will start the crypto, ranch, cowboy, webserver and auto-update applications using Sync in turn, and the webserver: stop will stop everything running in reverse order. <br>  The cascade is ready, it's time to go to the Cowboy.  Open webserver_app.erl and edit the function start / 2: <br><div class="spoiler">  <b class="spoiler_title">Webserver_app function: start / 2</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_StartType, _StartArgs)</span></span></span><span class="hljs-function"> -&gt;</span></span> Dispatch = cowboy_router:compile([ {'_', [ {<span class="hljs-string"><span class="hljs-string">"/"</span></span>, index_handler, []}, {'_', notfound_handler, []} ]} ]), Port = <span class="hljs-number"><span class="hljs-number">8008</span></span>, {ok, _} = cowboy:start_http(http_listener, <span class="hljs-number"><span class="hljs-number">100</span></span>, [{port, Port}], [{env, [{dispatch, Dispatch}]}] ), webserver_sup:start_link().</code> </pre><br></div></div><br>  In the dispatching rules, we indicated that we will serve all requests except "/" that will be sent to the server using notfound_handler (we will give 404 error), and requests to "/" will be processed using index_handler.  So you should create them: <br><div class="spoiler">  <b class="spoiler_title">Contents src / index_handler.erl</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(index_handler)</span></span>. -behaviour(cowboy_http_handler). <span class="hljs-comment"><span class="hljs-comment">%% Cowboy_http_handler callbacks -export([ init/3, handle/2, terminate/3 ]). init({tcp, http}, Req, _Opts) -&gt; {ok, Req, undefined_state}. handle(Req, State) -&gt; Body = &lt;&lt;"&lt;h1&gt;It works!&lt;/h1&gt;"&gt;&gt;, {ok, Req2} = cowboy_req:reply(200, [], Body, Req), {ok, Req2, State}. terminate(_Reason, _Req, _State) -&gt; ok.</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Src / notfound_handler.erl content</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(notfound_handler)</span></span>. -behaviour(cowboy_http_handler). <span class="hljs-comment"><span class="hljs-comment">%% Cowboy_http_handler callbacks -export([ init/3, handle/2, terminate/3 ]). init({tcp, http}, Req, _Opts) -&gt; {ok, Req, undefined_state}. handle(Req, State) -&gt; Body = &lt;&lt;"&lt;h1&gt;404 Page Not Found&lt;/h1&gt;"&gt;&gt;, {ok, Req2} = cowboy_req:reply(404, [], Body, Req), {ok, Req2, State}. terminate(_Reason, _Req, _State) -&gt; ok.</span></span></code> </pre><br></div></div><br>  That's all - we created a simplest web server that can handle requests to <a href="http://localhost/">localhost</a> : 8008 and <a href="http://localhost/">localhost</a> : 8008 / WHATEVER.  Now it is necessary to compile and run the web server: <br><pre> <code class="bash hljs">&gt; rebar get-deps &gt; rebar compile &gt; erl -pa ebin deps/*/ebin -s webserver</code> </pre><br>  <code>rebar get-deps</code> pull up dependencies from the config, <code>rebar compile</code> compile the code, and <code>erl -pa ebin deps/*/ebin -s webserver</code> will start the server itself.  By the way, it's time to create a simple Makefile to facilitate the implementation of the above operations: <br><div class="spoiler">  <b class="spoiler_title">Makefile Content</b> <div class="spoiler_text"><pre> REBAR = `which rebar`<font></font>
<font></font>
 all: deps compile<font></font>
<font></font>
 deps:
	 @ ($ (REBAR) get-deps)<font></font>
<font></font>
 compile: clean
	 @ ($ (REBAR) compile)<font></font>
<font></font>
 clean:
	 @ ($ (REBAR) clean)<font></font>
<font></font>
 run:
	 @ (erl -pa ebin deps / * / ebin -s webserver)<font></font>
<font></font>
 .PHONY: all deps compile clean run
</pre><br></div></div><br>  Now you can compile the project by calling <code>make</code> , and run by calling <code>make run</code> <br>  After the server has been started, you can go first to <a href="http://localhost/">localhost</a> : 8008 and then to <a href="http://localhost/">localhost</a> : 8008 / whatever and make sure that the server is working as expected by sending ‚ÄúIt works‚Äù to the first request and ‚Äú404 Page Not Found‚Äù to the second <br><br><h4>  Routing Overview, Static Maintenance </h4><br>  Routing in Cowboy is not to say that the most convenient, but quite tolerable - basic features like passing parameters to the URL and validating these parameters are available.  So far we have only two routes in the dispatch rules: <br><pre> <code class="erlang hljs">{<span class="hljs-string"><span class="hljs-string">"/"</span></span>, index_handler, []}, {'_', notfound_handler, []}</code> </pre><br>  Which is inside of another, defining for which host we will use nested.  You can read more about this and routing in general here: <a href="">github.com/extend/cowboy/blob/master/guide/routing.md</a> and here I‚Äôll only clarify that the atom '_' means that the route will match requests to absolutely all addresses , notfound_handler is the name of the module that will process zatachenny requests, and [] is a list of additional.  parameters passed to the module <br>  We will keep statics in the priv directory in the priv / css priv / js, priv / img subdirectories and match it with the following rules: <br><pre> <code class="bash hljs">/css/WHATEVER -&gt; /priv/css/WHATEVER /js/WHATEVER -&gt; /priv/js/WHATEVER /img/WHATEVER -&gt; priv/img/WHATEVER</code> </pre><br>  To do this, add 3 routes respectively: <br><pre> <code class="erlang hljs">Dispatch = cowboy_router:compile([ {'_', [ {<span class="hljs-string"><span class="hljs-string">"/css/[...]"</span></span>, cowboy_static, [ {directory, {priv_dir, webserver, [&lt;&lt;<span class="hljs-string"><span class="hljs-string">"css"</span></span>&gt;&gt;]}}, {mimetypes, {<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> mimetypes:path_to_mimes/<span class="hljs-number"><span class="hljs-number">2</span></span>, default}} ]}, {<span class="hljs-string"><span class="hljs-string">"/js/[...]"</span></span>, cowboy_static, [ {directory, {priv_dir, webserver, [&lt;&lt;<span class="hljs-string"><span class="hljs-string">"js"</span></span>&gt;&gt;]}}, {mimetypes, {<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> mimetypes:path_to_mimes/<span class="hljs-number"><span class="hljs-number">2</span></span>, default}} ]}, {<span class="hljs-string"><span class="hljs-string">"/img/[...]"</span></span>, cowboy_static, [ {directory, {priv_dir, webserver, [&lt;&lt;<span class="hljs-string"><span class="hljs-string">"img"</span></span>&gt;&gt;]}}, {mimetypes, {<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> mimetypes:path_to_mimes/<span class="hljs-number"><span class="hljs-number">2</span></span>, default}} ]}, {<span class="hljs-string"><span class="hljs-string">"/"</span></span>, index_handler, []}, {'_', notfound_handler, []} ]} ]).</code> </pre><br>  the mimetypes: path_to_mimes / 2 function is responsible for returning the correct mimetype by file extension. <br>  It is easy to see that the previous 3 routes almost completely copy each other with minor exceptions, let's take out the generation of the static route into the function and replace the routes with it: <br><pre> <code class="erlang hljs">Static = <span class="hljs-keyword"><span class="hljs-keyword">fun</span></span>(Filetype) -&gt; {lists:append([<span class="hljs-string"><span class="hljs-string">"/"</span></span>, Filetype, <span class="hljs-string"><span class="hljs-string">"/[...]"</span></span>]), cowboy_static, [ {directory, {priv_dir, webserver, [list_to_binary(Filetype)]}}, {mimetypes, {<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> mimetypes:path_to_mimes/<span class="hljs-number"><span class="hljs-number">2</span></span>, default}} ]} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, Dispatch = cowboy_router:compile([ {'_', [ Static(<span class="hljs-string"><span class="hljs-string">"css"</span></span>), Static(<span class="hljs-string"><span class="hljs-string">"js"</span></span>), Static(<span class="hljs-string"><span class="hljs-string">"img"</span></span>), {<span class="hljs-string"><span class="hljs-string">"/"</span></span>, index_handler, []}, {'_', notfound_handler, []} ]} ]).</code> </pre><br>  Now, in order for new dispatch rules to take effect, we need to either restart the server or use the cowboy function: set_env / 3 <br>  The first is unsportsmanlike, and you‚Äôre going to reboot the server for every sneeze in the routing rules, so we‚Äôll add a function to update the routing in our webserver file so that you can call the webserver: update_routing () in the console.  And, so that the webserver: update_routing / 0 function knows about new routes, we will put their definition into a separate function.  As a result, the webserver_app.erl file will look as follows: <br><div class="spoiler">  <b class="spoiler_title">Src / webserver_app.erl content</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(webserver_app)</span></span>. -behaviour(application). <span class="hljs-comment"><span class="hljs-comment">%% Application callbacks -export([ start/2, stop/1 ]). %% API -export([dispatch_rules/0]). %% =================================================================== %% API functions %% =================================================================== dispatch_rules() -&gt; Static = fun(Filetype) -&gt; {lists:append(["/", Filetype, "/[...]"]), cowboy_static, [ {directory, {priv_dir, webserver, [list_to_binary(Filetype)]}}, {mimetypes, {fun mimetypes:path_to_mimes/2, default}} ]} end, cowboy_router:compile([ {'_', [ Static("css"), Static("js"), Static("img"), {"/", index_handler, []}, {'_', notfound_handler, []} ]} ]). %% =================================================================== %% Application callbacks %% =================================================================== start(_StartType, _StartArgs) -&gt; Dispatch = dispatch_rules(), Port = 8008, {ok, _} = cowboy:start_http(http_listener, 100, [{port, Port}], [{env, [{dispatch, Dispatch}]}] ), webserver_sup:start_link(). stop(_State) -&gt; ok.</span></span></code> </pre><br></div></div><br>  Now add the update_routing function to the webserver.erl module: <br><div class="spoiler">  <b class="spoiler_title">Webserver function: update_routes / 0</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_routes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> Routes = webserver_app:dispatch_rules(), cowboy:set_env(http_listener, dispatch, Routes).</code> </pre><br></div></div><br>  And do not forget to add a function to the -export () attribute, after which it will look like this: <br><pre> <code class="erlang hljs"><span class="hljs-comment"><span class="hljs-comment">%% API -export([ start/0, stop/0, update_routes/0 ]).</span></span></code> </pre><br>  execute in the <code>webserver:update_routes().</code> console <code>webserver:update_routes().</code>  create directories for statics <br><pre> <code class="bash hljs">&gt; mkdir priv &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> priv &amp;&amp; mkdir css js img</code> </pre><br>  and put there any relevant files, after which you can verify that they are being sent, as expected, to the address <a href="http://localhost/">localhost</a> : 8008 / PATH / FILE <br><br><h4>  Templating with ErlyDTL (Django Template Language for Erlang) </h4><br>  Evan Miller, author of the notorious Chicago Boss web framework under Erlang, ported Django Template Language (https://docs.djangoproject.com/en/dev/topics/templates/) to Erlang and it turned out, quite frankly, pretty cool.  Actually, I would recommend this template engine to use in your future projects - I haven‚Äôt seen any alternatives yet. <br>  Create a new webserver / tpl directory and save there three templates: <br><br><div class="spoiler">  <b class="spoiler_title">Content tpl / layout.dtl</b> <div class="spoiler_text"><pre> <code class="django hljs"><span class="xml"><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">head</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">title</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Webserver</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">title</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">head</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Content tpl / index.dtl</b> <div class="spoiler_text"><pre> <code class="django hljs"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "layout.dtl" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Hello, </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ username | default : "stranger" }}</span></span><span class="xml"><span class="xml">!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Content tpl / 404.dtl</b> <div class="spoiler_text"><pre> <code class="django hljs"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "layout.dtl" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">URL </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"color:red;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> does not exists.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br></div></div><br><br>  To use templates, they need to be compiled.  This is done with erlydtl: compile / 3 as follows: <br><pre> <code class="erlang hljs">ok = erlydtl:compile(<span class="hljs-string"><span class="hljs-string">"tpl/layout.dtl"</span></span>, <span class="hljs-string"><span class="hljs-string">"layout_tpl"</span></span>, []), ok = erlydtl:compile(<span class="hljs-string"><span class="hljs-string">"tpl/index.dtl"</span></span>, <span class="hljs-string"><span class="hljs-string">"index_tpl"</span></span>, []), ok = erlydtl:compile(<span class="hljs-string"><span class="hljs-string">"tpl/404.dtl"</span></span>, <span class="hljs-string"><span class="hljs-string">"404_tpl"</span></span>, []).</code> </pre><br>  The final argument is a list of options for compiling a template, which you can read more about here: <a href="https://github.com/evanmiller/erlydtl">github.com/evanmiller/erlydtl</a> <br>  In order not to compile all templates with your hands each time you change, we will create functions in the webserver module that will be recompiled: <br><div class="spoiler">  <b class="spoiler_title">Functions for recompiling templates</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">c_tpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> c_tpl([]). c_tpl(Opts) -&gt; c_tpl(filelib:wildcard(<span class="hljs-string"><span class="hljs-string">"tpl/*.dtl"</span></span>), Opts). c_tpl([], _Opts) -&gt; ok; c_tpl([File | Files], Opts) -&gt; ok = erlydtl:compile(File, re:replace(filename:basename(File), <span class="hljs-string"><span class="hljs-string">".dtl"</span></span>, <span class="hljs-string"><span class="hljs-string">"_tpl"</span></span>, [global, {return, list}]), Opts), c_tpl(Files, Opts).</code> </pre><br></div></div><br>  and export them: <br><pre> <code class="erlang hljs"><span class="hljs-comment"><span class="hljs-comment">%% API -export([ start/0, stop/0, update_routes/0, c_tpl/0, c_tpl/1, c_tpl/2 ]).</span></span></code> </pre><br>  c_tpl / 0 will recompile all the templates from the tpl directory with no options, c_tpl / 1 will do the same, only with the specified options, and c_tpl / 2 will recompile the specified files with the specified options.  Let's compile all the templates by running the <code>webserver:c_tpl().</code> Erlang console <code>webserver:c_tpl().</code> <br>  We will also update our rebar.config so that when compiling it also compiles the templates (thanks for the <a href="https://habrahabr.ru/users/egobrain/" class="user_link">egobrain</a> hint): <br><div class="spoiler">  <b class="spoiler_title">Updated rebar.config</b> <div class="spoiler_text"><pre> <code class="erlang hljs">{plugins,[rebar_erlydtl_compiler]}. {deps, [ {cowboy, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"https://github.com/extend/cowboy.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {sync, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/rustyio/sync.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {mimetypes, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/spawngrid/mimetypes.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}}, {erlydtl, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/evanmiller/erlydtl.git"</span></span>, {branch, <span class="hljs-string"><span class="hljs-string">"master"</span></span>}}} ]}. {erlydtl_opts,[ {compiler_options, [debug_info]}, [ {doc_root, <span class="hljs-string"><span class="hljs-string">"tpl"</span></span>}, {out_dir, <span class="hljs-string"><span class="hljs-string">"ebin"</span></span>}, {source_ext, <span class="hljs-string"><span class="hljs-string">".dtl"</span></span>}, {module_ext, <span class="hljs-string"><span class="hljs-string">"_tpl"</span></span>} ] ]}.</code> </pre><br></div></div><br>  Unfortunately, it did not work out for me by simple means to force Sync to pick up the changes in the templates, I‚Äôll look into its code a bit later, so I still left the functions for recompilation in the module. <br><br>  Now we edit our handlers so that they give the answer the compiled templates, and also transfer the necessary variables to the templates: <br><br><div class="spoiler">  <b class="spoiler_title">Contents src / index_handler.erl</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(index_handler)</span></span>. -behaviour(cowboy_http_handler). <span class="hljs-comment"><span class="hljs-comment">%% Cowboy_http_handler callbacks -export([ init/3, handle/2, terminate/3 ]). init({tcp, http}, Req, _Opts) -&gt; {ok, Req, undefined_state}. handle(Req, State) -&gt; {Username, Req2} = cowboy_req:qs_val(&lt;&lt;"username"&gt;&gt;, Req, "stranger"), {ok, HTML} = index_tpl:render([{username, Username}]), {ok, Req3} = cowboy_req:reply(200, [], HTML, Req2), {ok, Req3, State}. terminate(_Reason, _Req, _State) -&gt; ok.</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Src / notfound_handler.erl content</b> <div class="spoiler_text"><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(notfound_handler)</span></span>. -behaviour(cowboy_http_handler). <span class="hljs-comment"><span class="hljs-comment">%% Cowboy_http_handler callbacks -export([ init/3, handle/2, terminate/3 ]). init({tcp, http}, Req, _Opts) -&gt; {ok, Req, undefined_state}. handle(Req, State) -&gt; {URL, Req2} = cowboy_req:url(Req), {ok, HTML} = '404_tpl':render([{url, URL}]), {ok, Req3} = cowboy_req:reply(404, [], HTML, Req2), {ok, Req3, State}. terminate(_Reason, _Req, _State) -&gt; ok.</span></span></code> </pre><br></div></div><br>  That's all.  Open <a href="http://localhost/">localhost</a> : 8008 /? Username = world or <a href="http://localhost/">localhost</a> : 8008 / qweqweasdasd and rejoice that everything works exactly as we expected. <br><br>  The complete project code can be found here: <a href="https://github.com/chvanikoff/webserver">github.com/chvanikoff/webserver</a> <br><br>  This is the end of my story, and in the next article I will talk about how to add multilingual support to our application written today.  Questions, comments, comments are welcome;) </div><p>Source: <a href="https://habr.com/ru/post/173595/">https://habr.com/ru/post/173595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173575/index.html">Google expands Google Fiber service</a></li>
<li><a href="../173579/index.html">KFC + Imagine Cup = another opportunity to reach the world final</a></li>
<li><a href="../173581/index.html">In Russia, a man was first convicted for Xbox 360 firmware, and then acquitted!</a></li>
<li><a href="../173587/index.html">Graphene and molybdenite based memory</a></li>
<li><a href="../173593/index.html">ContactManager, part 4. Add a web service (REST)</a></li>
<li><a href="../173599/index.html">Combine multiple videos in iOS using AVMutableVideoComposition</a></li>
<li><a href="../173603/index.html">Cowon D20 - the heir to the legendary D2 +</a></li>
<li><a href="../173605/index.html">Exim + DKIM using the example of FreeBSD 8.2</a></li>
<li><a href="../173607/index.html">Dynamic graphic password</a></li>
<li><a href="../173609/index.html">Norway and South Korea have been subjected to large-scale cyber attacks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>