<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized continuous deployment for the year vol 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our last article, we talked about how to build a centralized conveyor, but described it rather superficially. This gave rise to a lot of questions ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized continuous deployment for the year vol 2</h1><div class="post__text post__text-html js-mediator-article">  In our <a href="https://habrahabr.ru/company/raiffeisenbank/blog/342126/">last article,</a> we talked about how to build a centralized conveyor, but described it rather superficially.  This gave rise to a lot of questions that we cannot leave unanswered.  Here we will try to get as deep as possible ‚Äúunder the hood‚Äù and tell you how our centralized conveyor works. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9w/of/da/9wofdauxns7ccyn9i7gmdcjcdc8.png"></div><a name="habracut"></a><br>  I think that it is best to describe the whole process from the moment the work begins on the task to the launch of the changes made to the operation.  And in the course of the story I will try to answer all the questions that were left unanswered in the last article. <br><br>  Immediately make a reservation that our development teams enjoy complete freedom in building processes, so it cannot be said that all teams work in exact accordance with the description below.  Although, of course, a set of tools imposes certain restrictions.  So, to the point. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the bank, the main error tracking system is JIRA.  It registers tasks for all modifications, changes, and so on.  Developing the task, the developers ‚Äúcut off‚Äù the branch from the main repository and further develop it in it.  Below is an example of a fairly typical problem. <br><br><img src="https://habrastorage.org/webt/cl/zr/0w/clzr0w_qiejuqr5sqdnbpz52xqu.png"><br><br>  When finished with the task, the developer initiates a Bitbucket pull request to make changes to the main branch.  And here, for the first time, he encounters a manifestation of the work of the pipeline: pull request starts the process of automatic code revision. <br><br>  Our audit is performed using the SonarQube integrated into the pipeline through the Sonar for Bamboo and Sonar for Bitbucket plugins.  When you register a pull request in Bamboo, the build plan automatically runs, analyzing the branch you want to add.  The result of the analysis is displayed directly in the pull request in this form: <br><br><img src="https://habrastorage.org/webt/uz/e_/ko/uze_ko15r2mz7dfvp47cg2kqzpw.png"><br><br>  In the form of a pull request, you can immediately see which new notes the code contains, their criticality, category, etc.  The comments themselves can be viewed directly from the pull request form, just go to the Diff tab. <br><br><img src="https://habrastorage.org/webt/gc/db/-l/gcdb-lpwqybjk5mtfzddkalspog.png"><br><br>  Thus, the code revision process is significantly accelerated and facilitated, plus a fairly large number of settings allows for very flexible adjustment of the behavior of the pipeline both during the audit and in its results.  Suppose the audit is completed successfully, and we can move on. <br><br>  The next step is to build from our code something necessary and useful.  Build runs in Bamboo in a variety of ways.  You can manually, automatically after a merge or commit in the repository, on a schedule, or even through a call to the Bamboo Rest API.  For simplicity and clarity, we consider the most banal option - run the assembly by hand.  To do this, go to Bamboo, select the desired plan and press start. <br><br>  After starting, according to the dependencies indicated in the plan, a suitable agent is selected on which the assembly will be performed.  At the moment we have 30 Windows agents, 20 Linux, 2 iOS agents, and 5 more we keep for experiments and pilots.  Half of the agents are deployed in our internal cloud, but more on that later.  This number allows us to smoothly serve more than 500 active build plans and about a couple of hundred deployment projects. <br><br>  But back to our assembly plan.  The pipeline supports all common build tools, the list of which can be expanded with plug-ins. <br><br><img src="https://habrastorage.org/webt/os/gv/zj/osgvzjfzlft_de3q0yfvtgflbny.png"><br><br>  The build itself is standard: the code is saved to the agent, compiled in the same binaries and packaged in the appropriate packages.  Optionally any testing is connected, up to modular and integration.  At the end of the build, we get a beautiful report containing a lot of useful information about what commits went into the build, what tests were performed and with what result, what tasks went into the build, etc. <br><br><img src="https://habrastorage.org/webt/w7/m5/ss/w7m5ssdbn5m9hk0wglkfoyaijis.png"><br><br>  The artifact generated as a result of the assembly is automatically placed in the Artifactory. <br><br><img src="https://habrastorage.org/webt/ko/6n/dt/ko6ndtwvpcpbmkax2dhwd31zljg.png"><br><br>  On the one hand, this system is used as a centralized repository of artifacts collected by us, and on the other hand, through the Artifactory we proxify most external repositories, which significantly speeds up the build process and reduces the load on the network.  When assembling, we turn to Artifactory for all dependencies, rather than pumping them out of external repositories, which very well affects the speed and stability of the work of the assembly plans. <br><br>  Having placed the package in the Artifactory, we can do anything with it, including installing it on the environment we need.  Teams typically use three environments to create software.  Dev-environment - development environment, used for development and debugging.  Test environment - used for functional and integration testing of applications.  Preview-environment - is used for acceptance of the functionality by the customer and load testing;  as a rule, it is closest to operating conditions.  Some teams have decided to install to yesterday's copy of the working environment before installing it in production, which also helps to identify problems. <br><br>  The teams, together with the support, decide who sets up what environments, and here we use almost all the options.  There are teams that only developers are responsible for deployment (hello, DevOps!);  There are teams where developers update only dev and test, and support - preview and prod.  Some teams generally have dedicated people who install in all environments. <br><br>  A deployable project is a collection of environments associated with a specific build plan. <br><br><img src="https://habrastorage.org/webt/g1/5k/vk/g15kvkidl2kns_bezqnkc-6e1ii.png"><br><br>  The environment contains medium-dependent variables that are configured for each environment separately.  In the comments to the last article there was a question about how we store passwords.  As you can see in the screenshot, we store them in the parameters of the build and deployment plans.  In Bamboo, a password encryption mechanism is implemented: it is enough to use the word password in the variable name, and it will be encrypted.  After saving, the value of such a variable can no longer be viewed through the interface or seen in the execution logs, it will be ‚Äúmasked‚Äù by asterisks everywhere. <br><br><img src="https://habrastorage.org/webt/df/oo/od/dfooodkhgffr2efjk-y3lm6zu-4.png"><br><br>  In addition to variables, the environment contains an executable part, implemented as tasks that describe the set of actions required to install the application on the target host or hosts.  The list supports all standard tools and can be expanded with plugins. <br><br><img src="https://habrastorage.org/webt/00/0c/fe/000cfe7smdvpmlfn4qdlishg6o8.png"><br><br>  Based on the execution results, we also get a detailed execution log, with nesting levels and cross-references to tasks, commits, assemblies, etc. <br><br><img src="https://habrastorage.org/webt/nw/6z/l5/nw6zl5cxw_lvikka4xuqx9r5xrc.png"><br><br>  About installation in production, probably, it is worth talking separately.  The bank has a change registration process (CM), according to which all changes in production must be announced and agreed in advance.  To register changes, the command gets change management request (CRQ) at least three days before installation.  All sorts of testing reports are attached to this CRQ, an impressive list of coordinators is being formed.  The process is rather slow and cumbersome ... But we are dispelling myths about IT in banks <br><br>  We have teams that, together with business and support, have decided that they are doing everything so well that they are ready to make any changes to production at any time, and this will not lead to disastrous consequences.  Especially for such teams, the process of simplified registration and coordination of changes in the production-system was invented, within which you can make changes to production at any time, and register the CRQ after the actual work has been done.  But what kind of a CI / CD is this, if you need to start some applications manually ... Therefore, we wrote our own plugin for Bamboo, which allows you to automatically register a CRQ that is embedded in the deployment plan. <br><br><img src="https://habrastorage.org/webt/hx/26/ms/hx26ms_t5d0grejp75f2khq88ac.png"><br><br>  Now the whole process of registration and approval of changes takes several minutes and does not require manual intervention.  By the way, we have more than a dozen teams working in this new process, and their number is steadily growing.  So, in such bulky, conservative organizations like a bank, you can successfully implement best practices from the IT sphere. <br><br>  In modern realities, talking about the process of deployment, it is impossible to ignore such a thing as clouds.  As we already wrote that we have an internal cloud based on VMWare vRealize.  It is used both in non-industrial environments and in production.  We also integrated the cloud into the pipeline with the help of another own plug-in.  Now through Bamboo we can create or delete servers in the cloud. <br><br><img src="https://habrastorage.org/webt/d6/xy/ps/d6xypsdqfgwrr_jqqzokprfmp-y.png"><br><br>  For example, we re-create the servers mentioned above for Bamboo agents in the cloud every two weeks simply by launching a deployment plan that creates the necessary number of servers, installs all the necessary software on them, registers in the monitoring system, etc.  This operation takes about two hours, and then only because more than a hundred applications are installed. <br><br><img src="https://habrastorage.org/webt/tr/qz/x4/trqzx4qxk8097pv96qc68ghbo0q.png"><br><br>  Thus, thanks to the boxed integration and small customization, we were able to build a CI / CD pipeline that can solve all the tasks.  But nothing stands still.  Now we (like all progressive humanity) are actively moving towards integrating the pipeline with chatops tools, using containers and automating the processes associated with the pipeline itself. <br><br>  In the comments to the previous article, we asked a number of other questions, which, in our opinion, are not related either to CI / CD or to the pipeline.  So we will answer them in the "question-answer" format.  Probably, the answers will seem monotonous to you.  But the bank has more than 700 applications written at different times, under different operating systems and using different technologies, therefore it is impossible to give a definite answer, in most cases everything is determined by the application and its team. <br><br>  <i><b>What deployment schemes are used?</b></i>  <i><b>(green / blue, rolling, canary, etc.).</b></i>  <i><b>And if you need to roll back?</b></i> <br><br>  Depends on the specific application.  As far as I know, for sure there is green / blue and rolling, I'm not sure about the rest.  The teams themselves choose the best deployment option.  If you need to roll back and it is possible, then roll back. <br><br>  <i><b>How and by whom is the decision about successful deployment made?</b></i>  <i><b>Based on what parameters?</b></i> <br><br>  It's not entirely clear what this is about.  If the deployment process itself, then the decision is made by Bamboo. The plan worked without errors - well, did not work - an error.  If the question about the functional component of the installed changes, then the decision is made by business customers during smoke-testing after installation. <br><br>  <i><b>What if the load increases?</b></i>  <i><b>Is it easy to add more servers to keep up the load?</b></i>  <i><b>Is there autoscaling?</b></i> <br><br>  It depends on the application and still many, many factors, as always, when it comes to the load.  Autoscaling is not used. <br><br>  <i><b>Is each new deployment running on newly created servers or the same ones?</b></i> <br><br>  Depends on the application.  Our team re-creates the servers every two weeks, and we deploy only to new ones.  Other commands always deploy to the same servers.  The teams themselves choose the approach. <br><br>  <i><b>What with patches on the operating system?</b></i> <br>  Depends on the application, OS and updates.  But, in the end, we have installed all critical fixes and no vulnerabilities. <br><br>  <i><b>And what about monitoring and application and system metrics (OS)?</b></i> <br><br>  The topic of monitoring deserves a separate large article that may be written by our monitoring specialists.  I can say that there is monitoring, alerts work, incidents are recorded and processed, some processing is automated. <br><br>  <i><b>What do you use for load balancing between application copies?</b></i>  <i><b>nginx / haproxy / etc?</b></i> <br><br>  Depends on the application There are both nginx, and haproxy, and NLB, and Cisco hardware. </div><p>Source: <a href="https://habr.com/ru/post/350986/">https://habr.com/ru/post/350986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350974/index.html">Slingshot APT: Advanced virus found - it went unnoticed for 6 years</a></li>
<li><a href="../350976/index.html">Guide to SEO javascript sites. Part 1. The Internet through the eyes of Google</a></li>
<li><a href="../350978/index.html">Drupal 8 + Varnish: Cache HTML correctly</a></li>
<li><a href="../350982/index.html">6 myths about Service Fabric</a></li>
<li><a href="../350984/index.html">First steps in machine learning</a></li>
<li><a href="../350988/index.html">Recruitment: play, hitting the target</a></li>
<li><a href="../350990/index.html">‚ÄúWe'll have to write by ourselves. They sat down and wrote ": the life of the developers of the laboratory cluster of super-arrays in Sbertech</a></li>
<li><a href="../350992/index.html">Organization of information systems production processes. Part 2. Formation of the design solution</a></li>
<li><a href="../350994/index.html">31 business cybersecurity tips</a></li>
<li><a href="../350996/index.html">Java and Project Reactor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>