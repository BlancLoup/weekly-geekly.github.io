<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We manage the server via SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the fact that I dug out a USB modem huaweiE1550, which I bought last summer to organize a backup Internet channel, in a shelf with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We manage the server via SMS</h1><div class="post__text post__text-html js-mediator-article">  It all started with the fact that I dug out a USB modem huaweiE1550, which I bought last summer to organize a backup Internet channel, in a shelf with glands of USB.  He then worked for a short time and as unnecessary was removed to the "bins" until better times.  The first thing I did was unlock it to work with MTS (historically, I prefer this particular operator).  Initially, the idea of ‚Äã‚Äãsending SMS with warnings from Nagios, instead of mail, came to mind.  Run through the Internet, stumbled upon the smsd daemon to send / receive SMS from the smstools package.  After reading the documentation for this beast, I got the idea that you can receive messages from the right phones, with commands for the server.  This is how the idea of ‚Äã‚Äã‚ÄúManage server via SMS‚Äù was born. <br><a name="habracut"></a><br><h4>  Configuring the modem </h4><br>  First you need to make friends with our modem and Linux (by the way, I use Centos 5.5).  We stick the modem into one of the free usb ports.  The first thing you have to face is that the modem is defined as a CD-ROM, and you don‚Äôt send SMS from a CD-ROM, and you don‚Äôt receive it.  In order to fix this case, you just need to feed the modem this command: <b>AT ^ U2DIAG = 0</b> (0 - only modem, 1 - modem + cd-rom, 255 - modem + cd-rom + cardreader, 256 - modem + cardreader ).  If you have a computer at hand with Windows installed, then open HyperTerminal, connect to the modem, enter the command: <b>AT ^ U2DIAG = 0</b> and skip the next step. <br><br>  So, we force the modem to be a modem, and not some kind of CD-ROM under Linux.  First you need to install the <u>usb_modeswitch</u> and <u>minicom</u> <code>yum --enablerepo=rpmforge install usb_modeswitch minicom</code> packages <code>yum --enablerepo=rpmforge install usb_modeswitch minicom</code> , then create / edit <b>/etc/usb-modeswitch.conf</b> : <br> <code>DefaultVendor = 0x12d1 <br> DefaultProduct = 0x1446 <br> MessageEndPoint = "0x01" <br> MessageContent = "55534243000000000000000000000011060000000000000000000000000000"</code> <br> <br>  And we preempt the modem to another port, it is necessary to wait 5-10 seconds (it is necessary that the modem is defined as a CD-ROM) and as root we run <code>usb_modeswitch</code> and see something like the following: <br> <code>Looking for target devices ... <br> No devices in target mode or class found <br> Looking for default devices ... <br> Found default devices (1) <br> Accessing device 004 on bus 007 ... <br> Using endpoints 0x01 (out) and 0x81 (in) <br> Inquiring device details; driver will be detached ... <br> Looking for active driver ... <br> OK, driver found ("usb-storage") <br> OK, driver "usb-storage" detached <br> <br> SCSI inquiry data (for identification) <br> ------------------------- <br> Vendor String: HUAWEI <br> Model String: Mass Storage <br> Revision String: 2.31 <br> ------------------------- <br> <br> USB description data (for identification) <br> ------------------------- <br> Manufacturer: HUAWEI Technology <br> Product: HUAWEI Mobile <br> Serial No.: not provided <br> ------------------------- <br> Setting up communication with interface 0 ... <br> Trying to send the message to endpoint 0x01 ... <br> OK, message successfully sent <br> Device is gone, skipping any further commands <br> -&gt; Run lsusb to note any changes. Bye.</code> <br> <br>  Should there be new ttyUSB devices <br> <code>ls /dev | grep ttyUSB</code>  <code>ls /dev | grep ttyUSB</code> : <br> <code>ttyUSB0 <br> ttyUSB1 <br> ttyUSB2</code> <br> <br>  We start <code>minicom ‚Äìs</code> configure a serial port for work with / dev / ttyUSB0, <br>  Exit the settings, the terminal starts, then you need to send the command <b>AT ^ U2DIAG = 0</b> and get <b>ok</b> in response <br><br>  The procedure of turning the modem into a modem is over, we are going to install / configure smstools. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Smstools </h4><br>  Strangely enough, in huge rpmforge repositories there was no place for such a most useful package as smstools.  But it does not matter, on the Internet and on <a href="http://smstools3.kekekasvi.com/">the manufacturer's website</a> it is enough.  I found the package: smstools-3.0.10-4.el5.i386.rpm and ‚Äúused‚Äù them rpm ‚Äìi smstools-3.0.10-4.el5.i386.rpm.  Configure smstools, file <b>/etc/sms.conf</b> : <br> <code>devices = huaweiE1550 <br> logfile = /var/log/smsd.log <br> loglevel = 2 <br> <br> [huaweiE1550] <br> device = /dev/ttyUSB0 <br> baudrate = 115200 <br> rtscts = no <br> init = at+cpms="sm","sm","" <br> incoming = yes <br> incoming = high</code> <br> <br>  The settings are clear, we start the daemon, <code>service smsd start</code> and check this miracle: <code>smssend 9128141111 'test message'</code> (does not understand Cyrillic, needs to be converted to <a href="http://en.wikipedia.org/wiki/UTF-16/UCS-2">UCS-2BE</a> , I‚Äôll not consider this in this article) and wait for a sms on a mobile phone.  If the coveted message did not come, put in the config <b>loglevel = 7</b> and go for the tambourine.  I got everything up the first time. <br><br><h4>  smsctrl daemon </h4><br>  So we can talk, you need to learn to listen! <br>  If you send an SMS to the SIM card number in the modem, after a while smsd will create a file in /var/spool/sms/incoming/huaweiE1550.* of the following format: <br> <code>From: 79128141111 <br> From_TOA: 91 international, ISDN/telephone <br> From_SMSC: 79126313431 <br> Sent: 11-03-02 08:05:46 <br> Received: 11-03-02 08:08:09 <br> Subject: huaweiE1550 <br> IMSI: 2500XXXXXXXXXXX <br> Report: no <br> Alphabet: ISO <br> UDH: false <br> <br> Test message</code> <br>  Accordingly, we will check these files for the presence of commands to control the server.  There are two ways for this: the 1st small daemon on bash, the 2nd built-in event handler in smsd. <br><br><h5>  1st method </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # SMSCtrl # chkconfig: - 55 45 # description: Sms control, Egor N. Zuskin, 2011, http://www.it2k.ru/projects/smsctrl . /etc/rc.d/init.d/functions DAEMON=smsctrl REFRESH_TIME=15 COMMAND_CHAR="#" INCOMING_DIR=/var/spool/sms/incoming ALLOW_PHONES="79128141111 79128141112" SEND_BACK_REPORT=YES to_log(){ text=$1 export LANG=en_EN log_date=`date "+%b %d %H:%M:%S "` log_host=`hostname -s` echo "$log_date $log_host $DAEMON: $text" &gt;&gt; /var/log/$DAEMON.log } start() { echo -n "Starting $DAEMON: " $0 --daemon &amp;&amp; success || failure RETVAL=$? echo [ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/$DAEMON to_log "Starting ..." return $RETVAL } stop() { # Stop daemon. echo -n "Shutting down $DAEMON: " killproc $0 RETVAL=$? to_log "Stopping ..." echo [ $RETVAL = 0 ] &amp;&amp; rm -f /var/lock/subsys/$DAEMON } run() { for File in $(ls $INCOMING_DIR); do Allow=0 for Phone in $ALLOW_PHONES; do cat $INCOMING_DIR/$File | grep "From: $Phone" &gt; /dev/null 2&gt;&amp;1 [ $? -eq 0 ] &amp;&amp; Allow=1 done; [ $Allow -eq 0 ] &amp;&amp; continue cat $INCOMING_DIR/$File | grep "$COMMAND_CHAR" [ $? -ne 0 ] &amp;&amp; continue FromPhone=`cat $INCOMING_DIR/$File | grep "From:" | cut -d " " -f2` command=`cat $INCOMING_DIR/$File | grep "$COMMAND_CHAR" | cut -d "$COMMAND_CHAR" -f2` to_log "Incoming command: $command from $FromPhone" out=`$command` if [ "$SEND_BACK_REPORT" = "YES" ]; then smssend $FromPhone "$out" to_log "Send sms to $FromPhone: $out" fi rm -f $INCOMING_DIR/$File to_log "Deleting file $INCOMING_DIR/$File" done } daemon() { exec &gt;/dev/null exec 2&gt;/dev/null ( trap "" TERM while [ true ]; do run sleep $REFRESH_TIME; done; )&amp; } case "$1" in --daemon) daemon ;; run) run ;; start) start ;; stop) stop ;; restart) $0 stop $0 start exit $? ;; status) status $DAEMON echo ;; *) echo "Usage: $DAEMON {start|stop|restart|status|run}" exit 1 esac exit 0</span></span></code> </pre><br><br> <code>COMMAND_CHAR="#" ‚Äì   <br> INCOMING_DIR=/var/spool/sms/incoming ‚Äì    - <br> ALLOW_PHONES="79128141111 79128141112" ‚Äì      <br> SEND_BACK_REPORT=YES ‚Äì   - </code> <br> <br>  In order not to bother with all sorts of passages phrases, etc.  it was decided to accept commands only from certain numbers (did not check how SMS from substitution numbers would look) and make a check for the presence of a special character in front of the command in order to isolate from a random SMS. <br><br>  Save the daemon in <b>/etc/init.d/smsctrl</b> , <code>chkconfig --add smsctrl</code> , <code>service smsctrl start</code> <br><br><h4>  2nd method </h4><br>  We add in / <b>etc</b> / <b>smsd.conf</b> : <br> <code>eventhandler = /root/bin/sms_event.sh</code> <br>  create <b>/root/bin/sms_events.sh</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash COMMAND_CHAR="#" ALLOW_PHONES="79128141111 79128141112" SEND_BACK_REPORT=YES [ "$1" = "RECEIVED" ] || exit 0 to_log(){ text=$1 export LANG=en_EN log_date=`date "+%b %d %H:%M:%S "` log_host=`hostname -s` echo "$log_date $log_host $text" &gt;&gt; /var/log/smsctrl.log } File=$2 Allow=0 for Phone in $ALLOW_PHONES; do cat $File | grep "From: $Phone" &gt; /dev/null 2&gt;&amp;1 [ $? -eq 0 ] &amp;&amp; Allow=1 done; [ $Allow -eq 0 ] &amp;&amp; exit 0 cat $INCOMING_DIR/$File | grep "$COMMAND_CHAR" [ $? -ne 0 ] &amp;&amp; exit 0 FromPhone=`cat $File | grep "From:" | cut -d " " -f2` command=`cat $File | grep "$COMMAND_CHAR" | cut -d "$COMMAND_CHAR" -f2` to_log "Incoming command: $command from $FromPhone" out=`$command` if [ "$SEND_BACK_REPORT" = "YES" ]; then smssend $FromPhone "$out" to_log "Send sms to $FromPhone: $out" fi rm -f $File to_log "Deleting file $File"</span></span></code> </pre><br><br><h4>  Check </h4><br>  Create a /root/bin/test.sh <b>file with the</b> following contents: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ls ‚Äìla /etc | grep $1</span></span></code> </pre> <br>  Then we take the phone in our hands and send an SMS with the text <code>#/root/bin/test.sh sms</code> to the coveted number and look at the <code>tail ‚Äìf /var/log/smsctrl.log</code> log, if all is well, we‚Äôll <code>#/root/bin/test.sh sms</code> in response : <code>smsd.conf</code> <br><br><h4>  Conclusion </h4><br>  I have this solution, by SMS opens the ssh port for incoming connections.  I think this is not the only application, just turn on a little imagination. <br><br>  Useful links to customize huaweiE1550 and smsd <br>  1: <a href="http://www.lissyara.su/articles/freebsd/programms/smstools_3/">SMSTools 3 - gateway to send SMS</a> <br>  2: <a href="http://forum.lissyara.su/viewtopic.php%3Ff%3D14%26t%3D27612">Need an article on SMS center with Huawei E1550 modem?</a> <br>  3: <a href="http://rus-linux.net/nlib.php%3Fname%3D/MyLDP/internet/modem-ru.html">How to "tame" MTS-modem Huawei E1550</a> <br><br>  Thank you for your attention, looking forward to your comments. <br><br>  UPD As noted by my good friend, I added the implementation of the processing of leading SMS messages by means of smsd. </div><p>Source: <a href="https://habr.com/ru/post/114912/">https://habr.com/ru/post/114912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../114906/index.html">Happy Birthday, Pi!</a></li>
<li><a href="../114907/index.html">In Great Britain, the creators of the Gh0stMarket forum were planted</a></li>
<li><a href="../114908/index.html">ABBYY CEO Sergey Andreev answers questions from Habr's readers about the company's participation in the Skolkovo project</a></li>
<li><a href="../114910/index.html">Choosing a population size for a genetic algorithm</a></li>
<li><a href="../114911/index.html">Hash navigation in AJAX sites</a></li>
<li><a href="../114913/index.html">Extending jQuery style functionality</a></li>
<li><a href="../114914/index.html">Age of Relevance</a></li>
<li><a href="../114915/index.html">"Beeline" fined 100,000 rubles for sending advertising messages</a></li>
<li><a href="../114916/index.html">Google unmanned cars demonstrate racing driving style</a></li>
<li><a href="../114918/index.html">PC air filters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>