<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jira DataCenter - what is it? How does it work? How to deploy?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 With the spread of the Agile philosophy, Russian IT specialists are gaining more and more expertise and competence in customizing and m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jira DataCenter - what is it? How does it work? How to deploy?</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  With the spread of the Agile philosophy, Russian IT specialists are gaining more and more expertise and competence in customizing and managing products for development teams, the most popular of which is still Jira.  However, working with the highest, most productive and highly available version of it - the Jira Data Center - still raises a lot of questions.  In this post I will talk about some of the principles and mechanisms of the Jira DataCenter, which we apply in practice.  I'll start with a story about the structure of the Jira cluster. <br><a name="habracut"></a><br><h2>  What is the Jira DataCenter? </h2><br>  Jira DataCenter is, in fact, a server version, but with the ability to use a common database and a joint index. <br><br>  It is important to understand that Jira DataCenter itself, as a product and as an application, <b>does NOT</b> provide fault tolerance and load balancing.  The modules and systems to which the Atlassian product has nothing to do are responsible for this. <br><br>  In other words - Atlassian provides support for working in a cluster, but clustering itself is implemented by external means, the choice of which is quite rich. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A detailed description of the product can be found <a href="https://ru.atlassian.com/enterprise/data-center">on the Atlassian website</a> . <br><br>  There are several options for building: <br><br>  1. On own infrastructure <br>  2. In the Amazon cloud (AWS) <br>  3. In the MS cloud (Azure) <br><br>  This article will describe the solution for your own infrastructure. <br><br><h2>  What problems does the Jira DataCenter solve? </h2><br>  Jira Data Center helps to achieve the following goals: <br><br><ol><li>  Fault tolerance implementation. </li><li>  Ensuring stable operation under high load.  High load refers to large / enterprise scale instances, according to the <a href="https://confluence.atlassian.com/enterprise/jira-sizing-guide-461504623.html">Jira Sizing Guide</a> . </li><li>  Ensure continuous operation when maintenance is required.  At this point, I will focus separately.  The application quite often has to be updated and not all companies have the opportunity to do it quickly, and invisibly to users.  This problem is solved by clustering and using the so-called <a href="https://confluence.atlassian.com/adminjiraserver073/managing-zero-downtime-upgrades-861253112.html">Zero Downtime</a> update scheme. </li></ol><br>  These problems are solved through clustering and scalable architecture. <br><br><h2>  What are the components of the Jira DataCenter? </h2><br>  As you can see in the figure below, the Jira DataCenter cluster is a set of several dedicated machines. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df9/c80/76a/df9c8076a3d9bceb3c18a7392588dc5a.png" alt="image"><br>  <i>Figure 1. Jira Data Center architecture</i> <br><br><ol><li>  Application nodes (Application nodes or cluster nodes).  They accept and process all workloads and requests.  The role of the nodes is performed by regular servers, with identical content and installed application, as well as a shared file system mounted. </li><li>  File system (Shared file system) with standard file import / export capabilities, plugins, caching and so on.  A file server is also a separate server on which a shared folder or resource is created, which is mounted to the nodes and used for shared files. </li><li>  Database (Shared database).  The database server is also, in this case, a separate server and can be built on MS SQL, PostgreSQL, MySQL, Oracle solutions. </li><li>  Load balancer.  It distributes user requests and delivers them to the nodes, and if one of them fails, the balancer redirects its requests to other nodes almost instantly.  Thanks to his work, the failure of one node is not even noticed by users.  We will talk about the work of the balancer separately below. </li></ol><br><h2>  Jira Data Center cluster topology </h2><br>  I will give the basic principles on which the cluster is built in the JDC: <br><br><ul><li>  Jira instances share a common database; </li><li>  the Lucene index is replicated in real time and stored locally for each instance; </li><li>  attachments are stored in a shared storage; </li><li>  Jira instances monitor cache consistency; </li><li>  several instances can be active at any time; </li><li>  cluster locks are available; </li><li>  the balancer is configured to redirect requests only to active nodes, while it should not redirect requests to inactive nodes, and also cannot address all sessions to one node. </li></ul><br>  All nodes are divided into active and passive.  Active nodes are different in that they: <br><br><ul><li>  Process requests </li><li>  Perform background processes and tasks. </li><li>  Scheduled tasks can be configured on one or more of them. </li><li>  In all practical scenarios, the situation will look like when using a standard Jira Server.  Accordingly, passive nodes do not process requests and do not perform tasks, but serve to take short-term workload (for example, at system startup, loading plug-ins and / or indexing). </li></ul><br>  The figure below shows the operation of the Jira cluster. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5c/fe5/ab3/a5cfe5ab39c39fd277e832ce29364fd9.png" alt="image"><br>  <i>Figure 2. Simplified architecture diagram</i> <br><br><h2>  About load balancers </h2><br>  Any server with a reverse proxy or physical device can act as a balancer.  I will give the most famous examples of balancers. <br><br>  1. Hardware balancers: <br><br>  ‚Ä¢ Cisco <br>  ‚Ä¢ Juniper <br>  ‚Ä¢ F5 <br><br>  2. Software balancers: <br><br>  ‚Ä¢ mod_proxy (Apache) is a proxy server for the Apache HTTP Server, which supports most popular protocols and several different load balancing algorithms. <br><br>  ‚Ä¢ Varnish is a reverse HTTP proxy server and accelerator, it is designed for sites with high traffic.  Unlike the others, it is only a proxy server and load balancing HTTP traffic.  In particular, Varnish uses the Wikipedia, NY Times, The Guardian and many other major projects. <br><br>  ‚Ä¢ Nginx - web server number 1 in popularity among load balancers and proxy solutions for sites with high traffic.  It is actively developing, the manufacturer offers free and corporate versions.  Used on many of the most visited sites in the world, for example, WordPress.com, Zynga, Airbnb, Hulu, MaxCDN. <br><br>  ‚Ä¢ Nginx Plus - in fact, the above-mentioned paid corporate version of Nginx. <br><br>  ‚Ä¢ HAProxy is a free, open source tool that provides load balancing and proxy server capabilities for TCP / HTTP protocols.  It is fast and consumes few system resources, compatible with Linux, Solaris, FreeBSD and Windows. <br><br>  A good comparison of proxy servers can be found <a href="https://andreyex.ru/operacionnaya-sistema-linux/sravnenie-nginx-haproxy-i-varnish/">here on this link</a> . <br><br><h2>  Direct and reverse proxies </h2><br>  Load balancers can work as direct, as well as reverse proxies.  The difference is well described by the author of <a href="https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server/366212">this</a> comment on stackoverflow: <br><br>  1. ‚ÄúForward proxy‚Äù (Forward proxy).  The proxy event in this case is that the ‚Äúdirect proxy‚Äù retrieves data from another web site on behalf of the original requester.  As an example, I will give a list of three computers connected to the Internet. <br><br>  X = computer or client computer on the Internet <br>  Y = proxy website, proxy.example.org <br>  Z = The website you want to visit, <a href="http://www.example.net/">www.example.net</a> <br>  You can usually connect directly from X -&gt; Z. However, in some scenarios it is better to use Y -&gt; Z on behalf of X, which looks like this: X -&gt; Y -&gt; Z. <br><br>  2. "Reverse proxy" (Reverse proxy).  Imagine the same situation, only on site Y is a reverse proxy configured.  Usually, you can connect directly from X -&gt; Z. However, in some scenarios, administrator Z is better to restrict or prohibit direct access and force visitors to first pass through Y. Thus, as before, we receive data received from Y -&gt; Z on behalf of X, which follows: X -&gt; Y -&gt; Z. <br>  This case differs from ‚Äúdirect proxy‚Äù in that user X does not know that he is accessing Z, because user X sees that he is communicating with Y. Server Z is invisible to clients and only the external proxy server Y is visible .  Reverse proxy does not require client-side configuration.  Client X believes that he only interacts with Y (X -&gt; Y), but the reality is that Y redirects the entire connection (X -&gt; Y -&gt; Z again). <br><br>  Next, we look at working with a software balancer. <br><br><h2>  Which software balancer to choose? </h2><br>  In our experience, the best choice among software balancers is Nginx, because it supports Sticky sessions and is also one of the most commonly used web servers, which means good documentation and sufficient fame among IT specialists. <br><br>  Sticky session is a load balancing method in which client requests are sent to the same server in a group.  In Nginx, there is a sticky method that uses a cookie for balancing, though only in the commercial version.  But there is a free way - using external modules. <br><br>  The module creates a cookie, and thus makes each browser unique.  Next, a cookie is used to redirect requests to the same server.  If there is no cookie (for example, at the first request), the server is selected randomly. <br>  More information about the sticky method can be found at <a href="http_upstream_module.html">this link</a> , as well as <a href="https://habr.com/post/231523/">here in this Habrapost</a> . <br><br>  Now, go to the practical part ... <br><br><h2>  Instructions for creating a cluster Jira DataCenter </h2><br>  For clustering, you can use either an existing instance with Jira installed, or a new one.  In our example, the installation of new instances on different operating systems will be described (to demonstrate the universality of the system). <br><br>  1. Let's start with the database server.  You can use both existing and create a new one.  Again, for illustration purposes, Windows Server 2016 + PostgreSQL 9.4 was chosen.  Install the OS, install the PG server, install the PG Admin, add the user and the database. <br><br>  2. Create the first node on Ubuntu 16.04 LTS.  Install the necessary packages, update the repositories. <br><br>  3. <a href="https://www.atlassian.com/software/jira/download/data-center">Download</a> and install the Jira DataCenter, launch, configure the database (just in case, Atlassian has a detailed <a href="https://confluence.atlassian.com/adminjiraserver073/installing-jira-data-center-861253059.html">guide</a> ). <br><br>  4. Turn off the Jira, turn off the node. <br>  <i>service jira stop</i> <br><br>  5. For further manipulations, it is better to temporarily disable the autorun Jira: <br>  <i>update-rc.d -f jira remove</i> <br><br>  6. Clone the disabled node. <br><br>  7. Start the first node, turn off the Jira (by default, after installation, Jira is set to autorun). <br><br>  8. Start the second node, turn off the Jira. <br><br>  9. Create a separate instance for the balancer.  I chose Ubuntu 16.04, because  it is quite fast, simple and does not require additional costs in the form of licenses. <br><br>  10. Install nginx (version 1.13.4 is used in the example). <br><br>  11. Download and unpack nginx-sticky-module-ng: <br>  git clone <a href="">bitbucket.org/nginx-goodies/nginx-sticky-module-ng.git</a> <br><br>  12. Preparing nginx for <a href="https://firstwiki.ru/index.php/%25D0%2594%25D0%25BE%25D0%25B1%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D0%25B5%25D0%25B9_nginx_%25D0%25B2_Linux_(Debian/Ubuntu/CentOS)">recompilation</a> and adding a module. <br><br>  13. Compile nginx with the module nginx-sticky-module-ng.  In my case, the compilation line was: <br>  <i>./configure --prefix = / etc / nginx --sbin-path = / usr / sbin / nginx --modules-path = / usr / lib / nginx / modules --conf-path = / etc / nginx / nginx. conf --error-log-path = / var / log / nginx / error.log --http-log-path = / var / log / nginx / access.log --pid-path = / var / run / nginx. pid --lock-path = / var / run / nginx.lock --http-client-body-temp-path = / var / cache / nginx / client_temp --http-proxy-temp-path = / var / cache / nginx / proxy_temp --http-fastcgi-temp-path = / var / cache / nginx / fastcgi_temp --http-uwsgi-temp-path = / var / cache / nginx / uwsgi_temp --http-scgi-temp-path = / var / cache / nginx / scgi_temp --user = nginx --group = nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module - "s-kx -with-http_sub_module --with-ht</i>  <i>tp_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt = '- g -O2 -fstack-protector - param = ssp-buffer-size = 4 -Wformat -Werror = format-security -Wp, -D_FORTIFY_SOURCE = 2 -fPIC '--with-ld-opt =' - Wl, -Bsymbolic-functions -Wl, -z, relro -Wl, -z, now -Wl, - as-needed -pie '--add-module = / usr / local / src / nginx-sticky-module-ng</i> <br><br>  14. Find the file /etc/nginx/nginx.conf, copy it to .bak, <a href="https://confluence.atlassian.com/jirakb/how-to-set-up-nginx-plus-as-the-load-balancer-for-a-jira-data-center-cluster-640516559.html">configure</a> nginx for reverse proxy mode. <br><br>  15. Next, we need a file server (preferably also fault tolerant).  For example, I chose a Windows server, where I <a href="https://help.ubuntu.ru/wiki/nfs">created an</a> NFS ball. <br><br>  16. On each node install packages to support NFS: <br>  <i>apt-get install nfs-common</i> <br><br>  17. Create the folder / media / jira and execute: <br>  <i>chmod -R 0777 / media / Jira</i> <br><br>  18. Mount the NFS ball as a shared one (be sure to mount it not in the root folder, but, for example, in / media / jira) - ON EACH NODE <br><br>  19.1.  Next, you can either mount manually (once): <br>  <i>sudo mount -t nfs -O uid = 1000, iocharset = utf-8 xx.xx.xx.xx: / jira / media / jira</i> <br>  where xx.xx.xx.xx is the ip address of the server with the NFS ball <br><br>  19.2.  Or immediately automatic mount (when you start the OS): <br>  <i>mcedit / etc / fstab</i> <br>  At the end you need to add the line: <br>  <i>192.168.7.239:/jira / media / jira nfs user, rw 0 0</i> <br>  Then save and exit. <br><br>  20. Assign an ID: the first node of node1, the second node of node2, and so on. <br>  <i>#This ID must be unique across the cluster</i> <i><br></i>  <i>jira.node.id = node1</i> <i><br></i>  <i>#The location of the shared home directory for all Jira nodes</i> <i><br></i>  <i>jira.shared.home = / media / jira</i> <br><br>  21. Start the jeera on the first node <br>  <i>service jira start</i> <br>  check: <br>  go to system -&gt; system info -&gt; look for cluster ON and node number. <br><br>  22. Setting up nginx balancing <br><br>  23. Because  we have previously disabled autorun Jira on the nodes, then you can enable it with the command: <br>  <i>update-rc.d -f jira enable</i> <br><br>  24. Check the operation of the cluster and, if necessary, add nodes. <br><br><h4>  Cluster Startup Order </h4><br>  1. Enable Shared file system server <br>  2. Enable Load balancer <br>  3. Enable node1 <br>  4. Enable node2 <br>  five. ‚Ä¶ <br><br><h4>  Cluster stop order </h4><br>  1. Stop the Jira on both nodes with the service Jira stop command <br>  2. Turn off node 2 <br>  3. Turn off node 1 <br>  4. Turn off the load balancer <br>  5. Shut down the file system server <br><br><h2>  That's all‚Ä¶ </h2><br>  Of course, the method described is not the only correct one.  This is just one of the ways to implement. <br><br>  I express my gratitude to my colleagues for their help in preparing the material. <br>  Comment, ask questions and thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/433904/">https://habr.com/ru/post/433904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433894/index.html">[Video] Why rockets explode, what will appear in Kotlin soon and how to save the review code</a></li>
<li><a href="../433896/index.html">Using machine learning is not difficult. Enough for a week ...</a></li>
<li><a href="../433898/index.html">Digest MBLT DEV :: release ‚Ññ200</a></li>
<li><a href="../433900/index.html">ICQ is dead. Long live ICQ?</a></li>
<li><a href="../433902/index.html">Repetition for the programmer: why it is important to solve similar problems</a></li>
<li><a href="../433906/index.html">Problems using NtQuerySystemInformation with undocumented arguments</a></li>
<li><a href="../433908/index.html">Tetris on C # in 100 lines</a></li>
<li><a href="../433910/index.html">Thoughts on Rust 2019</a></li>
<li><a href="../433912/index.html">Want to attract the best engineers? Open code</a></li>
<li><a href="../433916/index.html">Go Community in Kazan and our meetings</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>