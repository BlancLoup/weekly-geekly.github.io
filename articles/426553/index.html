<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Banner advertising in iOS application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we are opening a series of articles about what is not usually talk at technical conferences and meetings. This and the following posts will tell...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Banner advertising in iOS application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Today we are opening a series of articles about what is not usually talk at technical conferences and meetings.  This and the following posts will tell you how the monetization mechanism works in iFunny, an entertainment iOS application popular in the US, which we are developing. <br><a name="habracut"></a><br>  Advertising is one of the main ways to monetize free apps.  But it is now, and what options were in 2011, when iFunny appeared?  The service was originally built as a strong, sustainable business, so from the very first day the company decided not to flirt with users and not engage in games with conditional capitalization. <br><br>  At that time, the main monetization option was to create a free cut-down version of the service, and then try to sell the main functionality.  The consumer was young, inexperienced and was not ready to part with the sums of more than one dollar. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Simple mathematics showed that at a 10% conversion, getting ARPU more than 10 cents is almost impossible task. <br><br>  Then I had to think about how else you can monetize the product.  The advertising model already worked very well on the web, and it could be assumed that it would soon flourish on the phones. <br>  In general, the beginning of the mobile advertising model of monetization can be considered the emergence of AdWhirl - a service that allowed to integrate the SDK ad networks and rotate them.  Its appearance allowed FillRate to increase on average to 50% in the market and make the revenue from the advertising model at least comparable to the one-dollar sale.  The principle of implementation of all possible sources of demand and the organization of competition between them has become the main driver of the growth of the advertising industry and continues to be exploited to this day. <br><br>  But the more complex the system, the less stable it becomes, which is absolutely unacceptable for large services of the iFunny level.  Starting to move in this direction in 2011, the company created one of the most effective mechanisms for working with mobile banner and native advertising and increased revenue per user 40 times, which allowed developing not only internal projects, but also investing in other companies. <br><br><h2>  MoPub and Company </h2><br>  Since 2012, we switched from AdWhirl to MoPub. <br><br>  MoPub is a mobile advertising platform with the ability to add your own modules, which includes several large tools: <br><br><ul><li>  MoPub marketplace - own advertising exchange; </li><li>  a mediator of ad networks for working with external networks; </li><li>  ordering mechanism that allows you to place banners in your own application and customize their displays. </li></ul><br>  The main advantages of MoPub: <br><br><ul><li>  can work with most ad networks; </li><li>  clear mechanism for connecting new third-party networks; </li><li>  open source; </li><li>  a huge number of basic settings and targeting; </li><li>  there is a large community around the network, there is even its own conference. </li></ul><br>  There are MoPub and disadvantages: <br><br><ul><li>  GitHub pull requests are not accepted and there is no reaction to them at all; </li><li>  The control panel is very complex, and it takes some time for the developer to debug into its structure. </li></ul><br><h2>  Power is in the truth </h2><br>  As the hero of a Russian film said: ‚ÄúStrength in truth.‚Äù  In this part, I will talk about the difficulties that we, as application developers, had to face after the first million downloads of iFunny, audience growth and advertising traffic from more than 100 partners. <br><br><h3>  Content </h3><br>  The advertising market is a very closed ‚Äúcaste‚Äù of technology companies, but at the same time aggregators have a large network of partners: from large companies that work with millions of budgets to small firms, tailored to specific target audiences. <br><br>  This closeness and fragmentation of partners, despite the pre-moderation of banners and fairly strict rules on advertising content, allows not the most honest sellers of advertising to publish creatives that are prohibited or spoil the user experience in the application. <br><br>  There are several main categories of "obscene" content in advertising banners: <br><br><ul><li>  porn content  Recently, it appears less and less, but nevertheless it has a place to be.  We can not publish this content in the article, so the pictures will not be here </li><li>  system alerts in banners, you can see an example from one of the users on <a href="https://twitter.com/IfunnyStates/status/1029393804749668352">twitter.com/IfunnyStates/status/1029393804749668352</a> </li><li>  content with sound.  Sounds are not prohibited by ad networks, as well as animations, but if the sound is played without interacting with the interface, this is perceived by users as an application bug and negatively affects the user experience. </li><li>  to attract attention.  A good banner should attract the attention of the user, but this is not always the case in an honest manner: sometimes flickering videos appear in the banners.  Another dishonest way to force a user to tap on a banner is to imitate an application interface, like this: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  By the way, in Russia, the usual tap on this banner can make a paid subscription from some cellular operators, and you will not even know about it until you see the details.  This is also a dishonest way to work with advertising, but operators in the US have no such opportunity. <br><br><h3>  Autoclics </h3><br>  As my experience shows, this is a very negative case for users.  Using the capabilities of JavaScript, WKWebView or UIWebView, as well as holes within the implementation of advertising libraries, you can make an advertisement that will open the banner content itself and lead the user out of the application. <br><br>  In order to repeat this problem with the example from MoPub, it is enough to add the following javascript code to the banner: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This worked long in many versions of MoPub, up to version 4.13. <br><br>  Exploring the implementation of MoPub, it was possible to generate more complex links that allowed not only to open ads on full screen, but also to send the user to the AppStore for a specific application and not even take into account the display of the banner. <br><br>  By the way, in the release notes for version 4.13.0 of the MoPub SDK for iOS, there is no information about this fix, since it was a rather serious hole in the SDK, and MoPub's dishonest partners were exploiting it quite actively.  As the logs show, which I will discuss next, I had to block up to 2 million attempts to open a banner every day without user interaction with it. <br><br>  In the case of MoPub, it turned out to find and repeat the problem quite easily, but other networks with which iFunny works have a closed code, and it is necessary to deal with the resulting auto-clicks by blocking banners or even turning off networks for a while. <br>  iFunny works closely with all advertising partners and informs them about such banners.  Since the young audience of iFunny is interesting to advertisers, partners willingly go forward and remove such advertising from the rotation. <br><br><h3>  Crash </h3><br>  Crash is always bad.  Even worse, when they happen due to a closed code dependency, and they can only be influenced indirectly.  Over the years, working with advertising in iFunna has identified for itself several types of crashes that can be divided into several groups. <br><br><ul><li>  Systemic </li></ul><br>  These include exceptions in the network library, WKWebView (UIWebView), OpenGL. <br>  It is very difficult to directly affect this type of crash, but it was still possible to influence some of them by first studying the work of the WebView component with WebGL. <br><br>  It looks like a beautiful scene such beautiful: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  And they occur only when leaving in the background.  This is due to the fact that the OpenGL engine should not work when the application is in the background. <br><br>  The fix here turned out to be quite simple: <br><br>  When leaving in the background you need to take a banner screenshot. <br><br>  Remove the ad View from the screen so that the WebView component stops using OpenGL. <br>  When you exit the background, return everything as it was. <br><br>  In Objective-C code, it looks like this: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Integration </li></ul><br>  These are problems that occur at the junction of iFunny, Mopub and the advertising provider. <br>  As a rule, they arise after updating the providers library and because of new ways of interacting with them. <br><br>  The last such case was in June of this year, after the next update of one of the used libraries.  A new way to initialize the library suggested using singleton to configure network settings. <br><br>  Appealing to it twice, as it happened in the implementation, periodically caused a frieze of the main thread, so I had to wrap the initialization in dispatch_once. <br><br>  IFunny's QA department is able to test advertising libraries well, so this problem was found during the update testing. <br><br><ul><li>  Unexpected </li></ul><br>  This type of crashes cannot be controlled at all, as it happens without any changes in the client. <br><br>  They are associated with updating the backend of the partners and the lack of backward compatibility.  Such crashes often occur with large advertising providers, but are quickly corrected, since they act on a large number of applications at the same time. <br><br>  There were cases when crash free iFunny per day dropped from the standard 99.8% to 80%, and the number of angry comments in the page was in the tens. <br><br><h4>  Performance </h4><br>  Banner ads typically use WebView components to display ads, so each banner shown is an initialization of a new WebView with all its dependencies. <br><br>  In addition, some partners use WebView to communicate with their own backend, as banner advertising on mobile devices is a descendant of advertising on the web. <br><br>  It happens that after the update there are memory leaks inside the new library.  After the appearance of the Memory Graph tool in Xcode, it has become much easier to find leaks in third-party libraries, so now we are able to promptly report them to our partners. <br><br>  Below is the iFunny gif in idle when there is no advertising for the user: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  Solutions </h2><br>  But despite all the problems described above, iFunny works stably and every day causes smiles to millions of its users. <br><br>  Over the years of active work with advertising, the development team has acquired several tools that allow you to successfully monitor advertising problems and respond to them in time. <br><br><h3>  Logging system </h3><br>  Now the system of exceptions logging in iFunny has spread to the entire application: it uses its own backend with a base on ClickHouse and a display in Grafana. <br><br>  But the first task for working with logs in the application was exactly logging of exceptional situations in advertising. <br><br>  There are several related components for determining whether redirects are in iFunny.  I'll tell you more about each of them. <br><br><h4>  IFAdView </h4><br>  This is the heir from the MPAdView class (he is responsible for displaying ads on MoPub). <br><br>  In this class, the hitTest: withEvent method is overridden: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Thus, we set the trigger on what the user interacted with the advertisement. <br><br><h4>  IFURLProtocol </h4><br>  Inherit from NSURLProtocol and describe the method: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  This is a trigger to open the AppStore from the application, we list all available URLs for this. <br><br><h4>  IFAdsExceptionManager </h4><br>  A class that collects triggers and generates an exception record in the log. <br><br>  To make it clear what are the triggers, I will describe each interface method of this class. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  A trigger that determines that a redirect occurs in iTunes. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  A trigger for determining the loss of activity by an application.  It compares the two previous triggers. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Reset triggers.  We call when we go to the background or when we open the AppStore ourselves, for example, when we send a user to rate in older versions of iOS. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Properties for recording the last successfully or unsuccessfully requested and loaded advertising.  Needed to form a message in the log. <br><br>  It is seen that the algorithm turned out quite simple, but effective.  It allows us to track not only auto discoveries from MoPub, but also from other networks. <br><br>  Recently, auto-discovery advertising often opens with SKStoreProductViewController, so now we are working on defining auto-opening of this controller.  The algorithm for determining this exception will be somewhat more complicated, but here the Objective-C Runtime will help us. <br><br><h2>  Local stand </h2><br>  Based on the logging system in iFunny, they also began to develop a local booth in order to receive and debug the ads that users see in real time. <br><br>  The stand consists of: <br><br><ul><li>  build agent </li><li>  devices </li><li>  test suite for each provider </li></ul><br>  One of the interesting solutions that is used at the stand is IDFA from user complaints for receiving real advertising. <br><br>  Since about 2016, we have stopped receiving real ads targeted to the USA using only VPN, so we have to replace IDFA devices with IDFAs of real users. <br><br>  This is done quite easily with Objective-C Runtime and Swizzling. <br>  It is necessary to replace the advertisingIdentifier method of the ASIdentifierManager class. <br><br>  Here we do it through the category: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  For transfer from the build-agent of the user IDFA to the build, the method described in the <a href="https://habr.com/company/funcorp/blog/417059/">article is used</a> . <br><br>  In conclusion, I would like to say that banner advertising works perfectly in the USA, and during seven years of its active use as the main method of monetization in iFunny, we learned how to work well with it. <br><br>  But despite the fact that banners bring 75% of the company's revenues, work is constantly underway on alternative ways to monetize and some experience has already been gained in native advertising and the use of advertising auctions in the US market. <br><br>  In general, there is something to tell. </div><p>Source: <a href="https://habr.com/ru/post/426553/">https://habr.com/ru/post/426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426543/index.html">Stateful backups in Kubernetes</a></li>
<li><a href="../426545/index.html">Joker 2018 Bonuses: Free Live Webcast, Bags, Party, and Desktops</a></li>
<li><a href="../426547/index.html">As the creator of Android is trying to release the first "anti-smartphone"</a></li>
<li><a href="../426549/index.html">New type of software for product managers</a></li>
<li><a href="../426551/index.html">Trekz Air - how bone conduction headphones actually sound</a></li>
<li><a href="../426555/index.html">"PC", but not "personal computer": an interview with the program committee Joker</a></li>
<li><a href="../426557/index.html">The most sought-after skills in data science</a></li>
<li><a href="../426559/index.html">Neural networks for image processing. Tells Alexander Savsunenko from Skylum Software</a></li>
<li><a href="../426561/index.html">The Magnificent Five: must have tools to speed development</a></li>
<li><a href="../426563/index.html">Hierarchical address book, change of primary e-mail and other innovations in Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>