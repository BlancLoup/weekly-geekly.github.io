<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About memory leak in one server application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading this note, you will learn what you had to go through after an unexpected memory leak of the server application in the FreeBSD OS. What m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About memory leak in one server application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/_f/sp/r4/_fspr4nsyfwkgj-qhemp25h5ziu.png"><br><br>  After reading this note, you will learn what you had to go through after an unexpected memory leak of the server application in the FreeBSD OS.  What modern means of detecting such problems exist in this environment, and why the most powerful of them can be completely useless <s>in crooked hands</s> . <br><a name="habracut"></a><br>  One fine afternoon of Thursday, on 5 of 50 servers Zabbix sent notifications about the ending place on the swap-section.  The graph of the KPV (free memory) clearly demonstrates the scale of the problem (the mounds on the right are the release of memory due to crowding in the swap).  Fortunately, it's Friday ahead, and you can calmly fix everything over the weekend.  At that moment no one had imagined that it would take more than 6 days to find and eliminate the cause. <br><br>  <b>About servers.</b>  Typical server generation tenth-eleventh with 8GB of memory (almost completely identical, and even one brand).  Servers are divided into groups to serve different sets of user accounts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>About the application.</b>  Ad-server, HTTP (libh2o) with C \ C ++ logic, a bunch of third-party libraries and bicycles like standard C ++ containers in shared memory, etc.  Accepts an incoming request, redirects to several upstream servers, conducts an auction for the answers and returns the answer to the client.  Everything revolves on FreeBSD 11.0 \ 11.1. <br><br><h2>  Who is guilty? </h2><br>  The latest changes in the code base were about ten days ago, all these days nothing remarkable happened to the memory.  A quick analysis gave such a list of the most likely reasons: <br><br><ul><li>  the qualitative or quantitative characteristics of incoming / outgoing requests have changed, which led to errors in the allocation / release of memory; </li><li>  bicycles with containers in shared memory.  They are always suspicious if something goes wrong; </li><li>  there is no leakage, just more data has become available and they have now ceased to intervene; </li><li>  the result of updating the kernel OS \ libraries.  But there are no auto-updates by default, this is not some kind of Windows that, God forgive me, can <a href="https://www.raymond.cc/blog/disable-and-stop-restart-or-reboot-after-installing-windows-update/">roll updates</a> whenever it pleases and, in addition, restart the machine.  <i>A couple of months ago, so many services collapsed on a nearby project.</i> </li><li>  someone conducts a targeted network attack that causes overflow; </li><li>  Meltdown \ Specter.  Yes!  Surely.  I do not remember that we were rolling out any updates, fearing a slowdown, but such an item today simply must have a place to be in any abnormal situation; </li></ul><br>  But the characteristics of the requests / responses have not changed (at least for all metrics collected).  No more data, network order, a lot of free resources, the server responds quickly ... Has the external environment changed? <br><br><h2>  What to do? </h2><br>  A couple of years ago something like this popped up, but almost all the tools that had helped to solve the problem at that time were forgotten.  I just wanted to get rid of it in just a couple of hours, so the first naive attempt was to find an answer to StackOverflow ... Mostly people recommend Valgrind and some unknown crafts (apparently the authors themselves) or plug-ins to VisualStudio (irrelevant).  Crafts fell almost everything, even without starting to work properly (memleax, ElectricFence, etc.), we will not dwell on them in detail. <br><br>  Along the way, we recall all the recently released features, thankfully, there have been few changes over the past month, of the main ones - to attach GeoIP databases, and so, in trivia ... <br><br>  We are trying to disconnect clients and upstream servers in turn (this method was tested one of the first, but for some reason did not give any result, the leak manifested itself in all combinations with varying degrees of intensity, only a linear dependence on incoming requests was observed). <br><br>  There were also attempts to roll back to the old version, up to a revision two months ago.  Memory continued to flow away there.  Rollback to even earlier versions was not possible due to incompatibility with other components. <br><br>  The main question is why these 5 servers?  All machines are almost identical (except for the difference in OS version 11 \ 11.1).  The problem occurs only on a specific group of accounts.  There is not even a hint of such behavior on the others, which means that it must be exactly dependent on incoming requests ... <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  Repeatedly faced with leaks in different projects, it was possible to listen to terrible stories about the most popular and effective method of treatment - periodically reload the defective application.  Yes, yes, it turns out, this works for years in highly respected companies.  It always seemed to me to be a complete game, and that I would never go down to this in my life, whatever the scale of the problem.  However, already on the second day I had to register a shameful restart in the cron, because  restarting the application every few hours was quite tedious (especially at night). <br></div></div><br>  For some reason, I wanted to make everything beautiful, namely, to find a leakage place by universal means.  It was probably one of the main mistakes made at an early stage. <br>  So, what universal means of solving the described problem exist today?  Basically, these are third-party libraries that wrap calls to malloc \ free and follow all memory operations. <br><br><h3>  valgrind </h3><br>  Excellent tool for detecting problems.  Indeed, it catches almost all types (double release, overflow, leakage, etc.).  There would be this whole story and ended without starting.  But with valgrind there is one problem - almost complete uselessness for high-load applications.  It looks like this: the program starts 20-50 times longer than usual, then it also works, with the majority of requests, of course, do not have time to work out and end with timeouts.  The CPU cores are loaded 100%, while the application does not produce any useful actions, spending all resources on the valgrind virtual machine.  In the logs you will find a measly percentage of the percentage of all requests that pass normally.  After pressing Ctrl + C, if you are lucky, a log will appear in a few minutes, or else everything will fall down (I often had the second one, or a nearly empty log).  In general, it did not take off. <br><br><h3>  tcmalloc </h3><br>  The library is available from the google-perftools port.  According <a href="https://gperftools.github.io/gperftools/heapprofile.html">to the developers</a> : <blockquote>  This is the heap profiler we use at Google. </blockquote>  Like most similar tools, it is connected either using the environment variable (LD_PRELOAD) or by compiling the library itself (-ltcmalloc).  Neither method worked.  In the process, another way came up - calling the static method HeapLeakChecker :: NoGlobalLeaks () from the code.  But for some reason it was not exported in any version of the library.  <a href="https://github.com/gperftools/gperftools/blob/master/INSTALL">Later it turns out</a> : <blockquote>  [on FreeBSD] libtcmalloc.so successfully builds, and the "advanced" tcmalloc functionality all works for the leak-checker, which has a Linux-specific code. </blockquote>  : (Let's go further. <br><br><h3>  libumem </h3><br>  Available from umem port.  A smart way to detect memory problems.  Especially in <a href="https://blogs.oracle.com/jwadams/debugging-with-libumem-and-mdb">combination with MDB</a> .  Unfortunately, all this is available only in the Solaris OS, and on FreeBSD MDB it would be <a href="https://wiki.freebsd.org/Debugging">nice to port</a> .  Launching the application with it failed.  At the start, before the call to main, calloc from libthr.so is called, which is already intercepted by libumem.  In turn, libumem tries to initialize work with threads in its code.  Recursion, s.  In general, the stack long before the call to main looks like this: <br><br><img src="https://habrastorage.org/webt/06/8h/8x/068h8xitiui8ugjgrz5-vbtbqve.png"><br><br>  The typical problem of eggs and chicken, which is not clear how to get around.  It was decided to postpone the idea of ‚Äã‚Äãcutting out a lot of threading (fortunately, it is used only somewhere in boost dependencies and in a wrapper over getaddrinfo).  Well, let's write to the developers (if there are still <a href="https://github.com/gburd/libumem/issues/10">alive</a> ) in the open by someone <a href="https://github.com/gburd/libumem/issues/9">like a similar ticket</a> and go further. <br><br><h3>  dmalloc </h3><br>  Available from the same port.  It has good documentation.  The startup stack surprisingly recalls the previous case: <br><br><pre><code class="hljs delphi">(gdb) bt
<span class="hljs-string"><span class="hljs-string">#0</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c8783e <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dmalloc_malloc ()
   from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#1</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c88623 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> calloc () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#2</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a8594 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#3</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a98d4 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#4</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a58fa <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pthread_mutex_lock () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#5</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c87641 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#6</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c87bb3 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#7</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c8787a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dmalloc_malloc ()
   from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#8</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c88623 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> calloc () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#9</span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a8594 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#10</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a98d4 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#11</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x00000008038a58fa <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pthread_mutex_lock () from /lib/libthr.so.<span class="hljs-number"><span class="hljs-number">3</span></span>
<span class="hljs-string"><span class="hljs-string">#12</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c87641 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#13</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c87bb3 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () from /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/lib/libdmallocthcxx.so.<span class="hljs-number"><span class="hljs-number">1</span></span>
<span class="hljs-string"><span class="hljs-string">#14</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0000000802c8787a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dmalloc_malloc ()
</code></pre><br>
     <a href="http://dmalloc.com/docs/latest/online/dmalloc_18.html"></a>     :     -  malloc-,    (  ): <blockquote>You know its too low if your program immediately core dumps and too high if the dmalloc library says its gone recursive although with low values, you might get either problem.</blockquote> .   ,   core-dump-         .<br>
<br>
 ,       .    5-6    ,       .   cron :(   ,  ,  ,  . ,         .  ,              .<br>
<br>
,           ,     ,  ¬´   ¬ª (,   ,    ).      8,      .       .<br>
<br>
<h3>dtrace</h3><br>
               D. ,          ‚Äî dtrace,  <b>IDDQD</b>       .    ,      .<br>
<br>
..          libc, , malloc\free,     (probes),    ,    <a href="http://dtrace.org/guide/chp-aggs.html"> </a>,       ! ,  :<br>
<br>
<pre><code class="bash hljs">sudo dtrace -n <span class="hljs-string"><span class="hljs-string">'pid$target::malloc:entry { @ = quantize(arg0); }'</span></span> -p 15034</code></pre><br>
 ‚Äî           (  ‚Äî pid=15034).           :<br>
<br>
<pre><code class="hljs mel">value  ------------- Distribution ------------- count    
               <span class="hljs-number"><span class="hljs-number">2</span></span> |                                         <span class="hljs-number"><span class="hljs-number">0</span></span>        
               <span class="hljs-number"><span class="hljs-number">4</span></span> |                                         <span class="hljs-number"><span class="hljs-number">1407</span></span>     
               <span class="hljs-number"><span class="hljs-number">8</span></span> |                                         <span class="hljs-number"><span class="hljs-number">455</span></span>      
              <span class="hljs-number"><span class="hljs-number">16</span></span> |@@                                       <span class="hljs-number"><span class="hljs-number">35592</span></span>    
              <span class="hljs-number"><span class="hljs-number">32</span></span> |@@@@@@@@@@@@@@@@                         <span class="hljs-number"><span class="hljs-number">239205</span></span>   
              <span class="hljs-number"><span class="hljs-number">64</span></span> |@@@@@@@                                  <span class="hljs-number"><span class="hljs-number">112358</span></span>   
             <span class="hljs-number"><span class="hljs-number">128</span></span> |@@@@                                     <span class="hljs-number"><span class="hljs-number">55813</span></span>    
             <span class="hljs-number"><span class="hljs-number">256</span></span> |@@@@@@                                   <span class="hljs-number"><span class="hljs-number">91368</span></span>    
             <span class="hljs-number"><span class="hljs-number">512</span></span> |@                                        <span class="hljs-number"><span class="hljs-number">17204</span></span>    
            <span class="hljs-number"><span class="hljs-number">1024</span></span> |@                                        <span class="hljs-number"><span class="hljs-number">19751</span></span>    
            <span class="hljs-number"><span class="hljs-number">2048</span></span> |@@                                       <span class="hljs-number"><span class="hljs-number">33310</span></span>    
            <span class="hljs-number"><span class="hljs-number">4096</span></span> |                                         <span class="hljs-number"><span class="hljs-number">2082</span></span>     
            <span class="hljs-number"><span class="hljs-number">8192</span></span> |                                         <span class="hljs-number"><span class="hljs-number">554</span></span>      
           <span class="hljs-number"><span class="hljs-number">16384</span></span> |                                         <span class="hljs-number"><span class="hljs-number">15</span></span>       
           <span class="hljs-number"><span class="hljs-number">32768</span></span> |                                         <span class="hljs-number"><span class="hljs-number">0</span></span>        
           <span class="hljs-number"><span class="hljs-number">65536</span></span> |                                         <span class="hljs-number"><span class="hljs-number">3960</span></span>     
          <span class="hljs-number"><span class="hljs-number">131072</span></span> |                                         <span class="hljs-number"><span class="hljs-number">0</span></span>       
</code></pre><br>
, ?    ,  ! ,  , -      .<br>
<br>
        ,    ! ,    -O1          ,  ¬´¬ª           ¬´¬ª. <br>
<br>
  (Brendan Gregg),  dtrace,         : <blockquote>In some cases, this [dtrace] isn‚Äôt a better tool ‚Äì it‚Äôs the only tool.</blockquote> ‚Äî  .<br>
<br>
 <a href="http://www.brendangregg.com/Solaris/memoryflamegraphs.html"></a>    ,   ,    :<br>
<blockquote>FreeBSD: DTrace can be used as with Solaris. I'll share examples when I get a chance.</blockquote>     ,  ,    .  -     ,    Solaris,   sbrk  mmap\munmap.<br>
<br>
     D.  , ,  ,   ,     .<br>
<br>
       <a href="https://blogs.oracle.com/openomics/investigating-memory-leaks-with-dtrace"></a>:<br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="hljs perl"><span class="hljs-comment"><span class="hljs-comment">#!/usr/sbin/dtrace -s</span></span>
/*<span class="hljs-comment"><span class="hljs-comment">#pragma D option quiet*/</span></span>
/*<span class="hljs-comment"><span class="hljs-comment">#pragma D option cleanrate=5000hz*/</span></span>

pid$1::mmap:entry
{
    self-&gt;addr = arg<span class="hljs-number"><span class="hljs-number">0</span></span>;
    self-&gt;size = arg1;
}

pid$1::mmap:<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>
<span class="hljs-regexp"><span class="hljs-regexp">/self-&gt;size/</span></span>
{
   addresses_mmap[arg1] = <span class="hljs-number"><span class="hljs-number">1</span></span>;
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"&lt;__%i,%Y,mmap(0x%lx,%d)-&gt;0x%lx\n"</span></span>, i++, walltimestamp, self-&gt;addr, self-&gt;size, arg1);
   <span class="hljs-regexp"><span class="hljs-regexp">/*ustack(2);*/</span></span>
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"__&gt;\n\n"</span></span>);
   @mem_mmap[arg1] = sum(<span class="hljs-number"><span class="hljs-number">1</span></span>);
   self-&gt;size=<span class="hljs-number"><span class="hljs-number">0</span></span>;
}

pid$1::munmap:entry
/addresses_mmap[arg<span class="hljs-number"><span class="hljs-number">0</span></span>]/
{
   @mem_mmap[arg<span class="hljs-number"><span class="hljs-number">0</span></span>] = sum(-<span class="hljs-number"><span class="hljs-number">1</span></span>);
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"&lt;__%i,%Y,munmap(0x%lx,%d)__&gt;\n"</span></span>, i++, walltimestamp, arg<span class="hljs-number"><span class="hljs-number">0</span></span>, arg1);
}

pid$1::malloc:entry
{
    self-&gt;size = arg<span class="hljs-number"><span class="hljs-number">0</span></span>;
}

pid$1::malloc:<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>
<span class="hljs-regexp"><span class="hljs-regexp">/self-&gt;size &gt; 0/</span></span>
{
   addresses_malloc[arg1] = <span class="hljs-number"><span class="hljs-number">1</span></span>;
   <span class="hljs-regexp"><span class="hljs-regexp">/*
   printf("&lt;__%i,%Y,malloc(%d)-&gt;0x%lx\n", i++, walltimestamp, self-&gt;size, arg1);
   ustack(2);
   printf("__&gt;\n\n");
   */</span></span>
   @mem_malloc[arg1] = sum(<span class="hljs-number"><span class="hljs-number">1</span></span>);
   self-&gt;size=<span class="hljs-number"><span class="hljs-number">0</span></span>;
}

pid$1::free:entry
/addresses_malloc[arg<span class="hljs-number"><span class="hljs-number">0</span></span>]/
{
   @mem_malloc[arg<span class="hljs-number"><span class="hljs-number">0</span></span>] = sum(-<span class="hljs-number"><span class="hljs-number">1</span></span>);
   <span class="hljs-regexp"><span class="hljs-regexp">/*printf("&lt;__%i,%Y,free(0x%lx)__&gt;\n", i++, walltimestamp, arg0);*/</span></span>
}

END
{
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"== REPORT ==\n\n"</span></span>);
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"== MMAP ==\n\n"</span></span>);
   printa(<span class="hljs-string"><span class="hljs-string">"0x%x =&gt; %@u\n"</span></span>,@mem_mmap);
   <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"== MALLOC ==\n\n"</span></span>);
   printa(<span class="hljs-string"><span class="hljs-string">"0x%x =&gt; %@u\n"</span></span>,@mem_malloc);
}
</code></pre><br>
</div></div><br>
  :    malloc\free,     .  malloc ‚Äî    ,  free ‚Äî .        (   &gt; 0).     ,   ~150 malloc-  ,  ustack() ( , ..  )        (    valgrind-).              ,   -       (     ?),         ‚Ä¶   dtrace    :<br>
<br>
<pre><code class="hljs sql">dtrace: 3507 dynamic variable drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">2133</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">120</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">993</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">176</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">1617</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">539</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">10252</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">3830</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">17048</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">39483</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">1121</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
dtrace: <span class="hljs-number"><span class="hljs-number">35067</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">32592</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops
dtrace: <span class="hljs-number"><span class="hljs-number">10081</span></span> dynamic <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span> drops <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> dirty <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>
</code></pre><br>
        .<br>
<br>
   ,         ,     ‚Ä¶      \.  ,  free   1.5  ,  malloc- (, -,  ?)<br>
<br>
     <a href="http://dtrace.org/blogs/mailing-list/">  dtrace</a>. <br>
<br>
<img src="https://habrastorage.org/webt/09/wj/nv/09wjnv4arq-_sn2iw66qmptg77i.jpeg"><br>
<br>
  ,       .   ,      ,     .    ,  -    : ustack(nframes).   ,  ustack(1)   .    libumem (, ,     Solaris-).<br>
<br>
   ,  :    ,  malloc-,      ,    -    . ,  ,  ustack()     , ,  100   .       ,    -   ,      .   ,  ,    .<br>
<br>
       ‚Äî          ,       .     .     , ,  ,   ¬´¬ª    ,      .<br>
<br>
<div class="spoiler"><b class="spoiler_title"> demangle</b><div class="spoiler_text">      ,   .. demangle . ,   , FreeBSD   <a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi%3Fid%3D223333"></a>. :<br>
<pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> _ZZN7simlib318SIMLIB_create_nameEPKczE1s | /usr/bin/c++filt</code></pre><br>
 .        11.1.   demangle-       11.0.<br>
</div></div><br>
       .<br>
<br>
,  dtrace ,    ,    \  .   ,    ,  .    .<br>
               .<br>
<br>
<h3>jemalloc</h3><br>
,    FreeBSD       ,     7- . ,      ‚Ä¶   <a href="http://jemalloc.net/jemalloc.3.html">  </a>   -    .   ,     :<br>
<br>
<pre><code class="bash hljs">setenv MALLOC_CONF utrace:<span class="hljs-literal"><span class="hljs-literal">true</span></span></code></pre><br>
 ,   <a href="https://keramida.wordpress.com/2008/10/15/extracting-useful-info-from-freebsd-malloc-tracing/"></a>  (ktrace)   (kdump)     .      realloc-,       ,  <a href="http://people.freebsd.org/~keramida/alloctrace-2.py.txt"> </a>    (  realloc-)     (  ¬´Wayback Machine¬ª    ).    realloc-,        , , ,  ,  -   ,      .<br>
<blockquote>By skimming through nearby trace output, we may be able to understand a bit more about the location of the leak in the source too :-)</blockquote> ‚Äî   .<br>
<br>
    jemalloc- (-:   ,    ,        ..),       . ,  CURRENT   (,     man-). ,         jemalloc   ,            (,    ).<br>
<br>
<h3>     </h3><br>
         .        ‚Äî        ,          !<br>
<br>
        .<br>
<br>
<h3> </h3><br>
<ul>
<li>         (  ) ,  ,  ,      ;</li>
<li> ARC ZFS (    HTTP ,      ,   ,  <a href="https://forums.freebsd.org/threads/freebsd-11-1-zfs-using-to-much-wired-memory.64702/"> </a>);</li>
<li>            C++;</li>
<li>     D,   -  ( dtrace);</li>
<li>    malloc\free,    arenas  slabs;</li>
<li>   ,       ,   ;</li>
<li>   ,    Solaris     ;</li>
<li> \     GDB.</li>
</ul><br>
<h3>,          </h3><br>
<ul>
<li>      Linux. ,         FreeBSD,  -   Google Chrome, Skype,  <a href="https://habrahabr.ru/company/odnoklassniki/blog/266005/">   </a>.   ,             ;</li>
<li>  hex-view-     (?          , );</li>
<li>    ,     ;</li>
<li> -,    .</li>
</ul><br>
<h2></h2><br>
<ul>
<li>     .    ,         .     ‚Äî      - .    ,     ,     .   ‚Äî      \   ;</li>
<li>    ‚Äî       ,   high-load ;</li>
<li>    dtrace           .    post-mortem        ..    ,  ,     .</li>
</ul><br>
     . ,        .                   .           ,   -,        ‚Ä¶<br>
<br>
<h2>  </h2><br>
<b>   , -,   ?</b><br>
  ,       .      ,   ¬´¬ª ( top N results).<br>
   std::list,   ‚Äî    -.          : list.resize(max_results).    , list.resize   delete  -.            resize.<br>
<br>
<b>              ?</b><br>
     top N results    .      -          .<br>
<br>
<b>         ?</b><br>
   .   ,         ,      . ,   ,      ,      .<br>
<br>
<b>       ?</b><br>
-      .  -         ,    .   ,   ,      ,    .  .<br>
<br>
     ,   .    ¬´   N ¬ª      ?         Linux  ¬´tcmalloc  co.¬ª    ¬´  ¬ª?<br>
<br>
<b>UPD1</b>:    ,    <a href="https://clang.llvm.org/docs/LeakSanitizer.html">    clang</a>,    ‚Ä¶<br>
<br>
 ,    !</div><p>Source: <a href="https://habr.com/ru/post/354370/">https://habr.com/ru/post/354370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354356/index.html">Marvin Minsky "The Emotion Machine": Chapter 1: Representing the Mind as a Cloud of Resources</a></li>
<li><a href="../354358/index.html">Marvin Minsky "The Emotion Machine": Chapter 1 "Adult Emotions"</a></li>
<li><a href="../354362/index.html">New chips to manage applications in hybrid cloud environments, or what Citrix NetScaler MAS 12.0 can do</a></li>
<li><a href="../354364/index.html">Queue management in Laravel</a></li>
<li><a href="../354366/index.html">TON: Telegram Open Network. Part 1: Intro, Network Layer, ADNL, DHT, Overlay Networks</a></li>
<li><a href="../354374/index.html">Protection against DDoS attacks at the level of web applications</a></li>
<li><a href="../354376/index.html">Who should NOT move to the cloud and why</a></li>
<li><a href="../354378/index.html">Why and how to conduct backlog grooming in grocery teams?</a></li>
<li><a href="../354380/index.html">Books on design systems</a></li>
<li><a href="../354384/index.html">Made an attack on MyEtherWallet, through the interception of Amazon DNS service using BGP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>