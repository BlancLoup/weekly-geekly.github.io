<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>World is not perfect</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The world is not perfect. At any moment something might go wrong. Fortunately, most of us do not launch rockets into space and do not build airplanes....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>World is not perfect</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/637/9b2/9da/6379b29da68f40f69ec5ba364c052ff6.png" alt="image" align="right" width="200"><br>  The world is not perfect.  At any moment something might go wrong.  Fortunately, most of us do not launch rockets into space and do not build airplanes. <br><br>  A modern person depends on the application in his phone and our task is to make it so that at any time, under any circumstances, he could open the application and look at the pictures with cats. <br><a name="habracut"></a><br>  People are not perfect.  We constantly make mistakes.  We make typos, we can forget something or succumb to laziness.  A person can trivially swell or get under the car. <br><br>  Iron is not perfect.  Hard drives are dying.  Datacenters lose channels.  Processors overheat and electrical networks fail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Soft is not perfect.  Memory flows.  Connections are torn.  Replicas break down and the data goes into oblivion. <br><br>  Shit happens - as our overseas friends say.  What can we do with all this?  And the answer is banal to simplicity - nothing.  We can always test, raise a ton of environments, copy production and keep one hundred thousand backup servers, but it still will not save: the world is not perfect. <br><br>  The only right decision here is to accept it.  We need to accept the world as it is and minimize losses.  Every time setting up a new service you need to remember - it will break at the most inopportune moment. <br><br>  It will break.  You will surely make a mistake.  Iron will fail.  The cluster will crumble.  And according to the laws of this imperfect world - this will happen exactly when you least expect it. <br><br>  What do most of us do to deceive everyone (including ourselves)?  - We set up alerts.  We write clever metrics, collect logs and create alerts, thousands, hundreds of thousands of alerts.  Our mailboxes are overflowing.  Our phones are broken by SMS and calls.  We plant entire floors of people looking at charts.  And when once again we lose access to the service, the analysis begins: what have we forgotten to do? <br><br>  All this is only the appearance of reliability.  No alerts, metrics and monitoring will help. <br><br>  Today they called you and you fixed the service - no one noticed that something was broken.  And tomorrow you went to the mountains.  And the day after tomorrow I forgot.  People are not perfect.  Fortunately, we are engineers, we live in a non-ideal world and we learn how to conquer it. <br><br>  So why do you need to wake up at night or in the morning instead of coffee to read the mail.  Why business should depend on one person and on his performance.  Why.  I do not understand. <br><br>  I only understand that it is impossible to live this way, and I do not want to live like this.  And the answer is simple: Automate it (yes, with a capital letter).  We need not just alerts and calls at night.  We need automatic responses to these messages.  We must be sure that the system can repair itself.  The system must be flexible and able to change. <br><br>  Unfortunately, we do not have enough intelligent AI yet.  Fortunately, all our problems are formalized. <br><br>  I don't have a silver bullet, but I have a Proof of Concept for AWS. <br><br><h3>  AWS Lambda </h3><br><blockquote>  Serverless - first of all, something that is not running can not break. <br>  Event based - received the event, processed, turned off. <br>  JVM is able - so, it is possible to use all experience from Java of the world (and means that I can use Clojure). <br>  3d-party - No need to monitor and maintain AWS Lambda. </blockquote><br>  Pipeline looks like this: <br><br><blockquote>  Event -&gt; SNS Topic -&gt; AWS Lambda -&gt; Reaction </blockquote><br>  By the way, SNS topic can have several endpoints.  So, you can add a banal mail and receive the same notification.  And we can extend the lambda function and make notifications much more useful: for example, send alerts immediately along with charts or add sending SMS. <br><br>  A full example of one Lambda function can be found at: <a href="https://github.com/lowl4tency/aws-lambda-example">github.com/lowl4tency/aws-lambda-example</a> <br>  The lambda function nails all nodes in the ELB not in the inService state. <br><br><h3>  Parsing code </h3><br>  In this example, we will kill all nodes that are not in the InService state.  By the way, the entire Lambda function takes ~ 50 lines of code in one file, which means ease of support and ease of entry. <br><br>  Any Clojure project starts with project.clj <br><br>  I used the official Java SDK and the excellent <a href="https://github.com/mcohen01/amazonica">Amazonica</a> library, which is a wrapper for this SDK.  Well, so as not to drag a lot of excess, we exclude those parts of the SDK that we do not need <br><br><pre><code class="lisp hljs">[amazonica <span class="hljs-string"><span class="hljs-string">"0.3.52"</span></span> :exclusions [com.amazonaws/aws-java-sdk]] [com.amazonaws/aws-java-sdk-core <span class="hljs-string"><span class="hljs-string">"1.10.62"</span></span>] [com.amazonaws/aws-lambda-java-core <span class="hljs-string"><span class="hljs-string">"1.1.0"</span></span>] [com.amazonaws/aws-java-sdk-elasticloadbalancing <span class="hljs-string"><span class="hljs-string">"1.11.26"</span></span> :exclusions [joda-time]] [com.amazonaws/aws-java-sdk-ec2 <span class="hljs-string"><span class="hljs-string">"1.10.62"</span></span> :exclusions [joda-time]] [com.amazonaws/aws-lambda-java-events <span class="hljs-string"><span class="hljs-string">"1.1.0"</span></span> :exclusions [com.amazonaws/aws-java-sdk-dynamodb com.amazonaws/aws-java-sdk-kinesis com.amazonaws/aws-java-sdk-cognitoidentity com.amazonaws/aws-java-sdk-sns com.amazonaws/aws-java-sdk-s3]]]</code> </pre> <br>  For the greater flexibility of each Lambda function, I use a configuration file with the most common <a href="https://github.com/edn-format/edn">edn</a> .  In order to be able to handle events, we need to slightly change the function declaration. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">ns</span></span> aws-lambda-example.core (<span class="hljs-symbol"><span class="hljs-symbol">:gen-class</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:implements</span></span> [com.amazonaws.services.lambda.runtime.RequestStreamHandler])</code> </pre><br>  Point of entry.  We read the event at the input, process this event using a handle-event and write to the JSON stream as a result. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> -handleRequest [this is os context] <span class="hljs-string"><span class="hljs-string">"Parser of input and genarator of JSON output"</span></span> (<span class="hljs-name"><span class="hljs-name">let</span></span> [w (<span class="hljs-name"><span class="hljs-name">io/writer</span></span> os)] (<span class="hljs-name"><span class="hljs-name">-&gt;</span></span> (<span class="hljs-name"><span class="hljs-name">io/reader</span></span> is) json/read (<span class="hljs-name"><span class="hljs-name">-&gt;</span></span> (<span class="hljs-name"><span class="hljs-name">io/reader</span></span> is) json/read walk/keywordize-keys handle-event (<span class="hljs-name"><span class="hljs-name">json/write</span></span> w)) (.flush w))))</code> </pre><br>  Workhorse: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> handle-event [event] (<span class="hljs-name"><span class="hljs-name">let</span></span> [instances (<span class="hljs-name"><span class="hljs-name">get-elb-instances-status</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:load-balancer-name</span></span> (<span class="hljs-name"><span class="hljs-name">edn/read-string</span></span> (<span class="hljs-name"><span class="hljs-name">slurp</span></span> (<span class="hljs-name"><span class="hljs-name">io/resource</span></span> <span class="hljs-string"><span class="hljs-string">"config.edn"</span></span>))))) unhealthy (<span class="hljs-name"><span class="hljs-name">unhealthy-elb-instances</span></span> instances)] (<span class="hljs-name"><span class="hljs-name">when</span></span> (<span class="hljs-name"><span class="hljs-name">seq</span></span> unhealthy) (<span class="hljs-name"><span class="hljs-name">pprint</span></span> <span class="hljs-string"><span class="hljs-string">"The next instances are unhealthy: "</span></span>) (<span class="hljs-name"><span class="hljs-name">pprint</span></span> unhealthy) (<span class="hljs-name"><span class="hljs-name">ec2/terminate-instances</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:instance-ids</span></span> unhealthy)) {<span class="hljs-symbol"><span class="hljs-symbol">:message</span></span> (<span class="hljs-name"><span class="hljs-name">get-in</span></span> event [<span class="hljs-symbol"><span class="hljs-symbol">:Records</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:Sns</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:Message</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">:elb-instance-ids</span></span> (<span class="hljs-name"><span class="hljs-name">mapv</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span> instances)}))</code> </pre><br><br>  Get the list of nodes in ELB and filter them by status.  All nodes that are in the InService state are removed from the list.  The rest is terminological. <br><br>  All that we print through the pprint will fall into the logs of CloudWatch.  This can be useful for debugging.  Since we do not have a constantly running lambda and there is no possibility to connect to the REPL, this can be quite useful. <br><br><pre> <code class="lisp hljs"> {:message (<span class="hljs-name"><span class="hljs-name">get-in</span></span> event [<span class="hljs-symbol"><span class="hljs-symbol">:Records</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:Sns</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:Message</span></span>]) :instance-ids (<span class="hljs-name"><span class="hljs-name">mapv</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span> instances)}))</code> </pre> <br>  In this place, the entire structure that we generate and return from this function will be written in JSON and will be seen as a result of the execution of the Lambda interface on the Web. <br><br>  In the <b>unhealthy-elb-instances</b> function <b>, we</b> filter our list and get instance-id only for those nodes that ELB considered inoperative.  We get a list of instances and we filter them by tags. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> unhealthy-elb-instances [instances-status] (<span class="hljs-name"><span class="hljs-name">-&gt;&gt;</span></span> instances-status (<span class="hljs-name"><span class="hljs-name">remove</span></span> #(<span class="hljs-name"><span class="hljs-name">=</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:state</span></span> %) <span class="hljs-string"><span class="hljs-string">"InService"</span></span>)) (<span class="hljs-name"><span class="hljs-name">map</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span>)))</code> </pre><br>  In the <b>get-elb-instances-status</b> function, call the API method and get a list of all nodes with statuses for one specific ELB <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> get-elb-instances-status [elb-name] (<span class="hljs-name"><span class="hljs-name">-&gt;&gt;</span></span> (<span class="hljs-name"><span class="hljs-name">elb/describe-instance-health</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:load-balancer-name</span></span> elb-name) <span class="hljs-symbol"><span class="hljs-symbol">:instance-states</span></span> (<span class="hljs-name"><span class="hljs-name">map</span></span> get-health-status )))</code> </pre><br>  For convenience, we remove the excess and generate a list only with information that is of interest to us.  This is the instance-id and status of each instance. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> get-health-status [instance] {<span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span> instance) <span class="hljs-symbol"><span class="hljs-symbol">:state</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:state</span></span> instance)})</code> </pre><br>  And we filter our list, removing those nodes that are in the InService state. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> unhealthy-elb-instances [instances-status] (<span class="hljs-name"><span class="hljs-name">-&gt;&gt;</span></span> instances-status (<span class="hljs-name"><span class="hljs-name">remove</span></span> #(<span class="hljs-name"><span class="hljs-name">=</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:state</span></span> %) <span class="hljs-string"><span class="hljs-string">"InService"</span></span>)) (<span class="hljs-name"><span class="hljs-name">map</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:instance-id</span></span>)))</code> </pre><br>  And that's all: 50 lines, which will allow you not to wake up at night and quietly go to the mountains. <br><br><h3>  Deployment </h3><br>  For simplicity, I use a simple bash-script. <br><br><pre> <code class="hljs tex">#!/bin/bash # Loader AWS Lambda aws lambda create-function --debug <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--function-name example <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--handler aws-lambda-example.core <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--runtime java8 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--memory 256 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--timeout 59 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--role arn:aws:iam::611066707117:role/lambda_exec_role <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--zip-file fileb://./target/aws-lambda-example-0.1.0-SNAPSHOT-standalone.jar</code> </pre> <br>  Configure the alert and fasten it to the SNS topic.  SNS topic fasten to the lambda as an endpoint.  Calmly we go to mountains or we get under the car. <br><br>  By the way, due to flexibility, you can program any system behavior and not only by system metrics, but also by business metrics. <br><br>  Thank. </div><p>Source: <a href="https://habr.com/ru/post/309040/">https://habr.com/ru/post/309040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309028/index.html">Says statistics: present and future of IaaS</a></li>
<li><a href="../309030/index.html">‚ÄúThe Evolution of Music‚Äù: A couple of words about recommender algorithms for streaming services</a></li>
<li><a href="../309032/index.html">Interview with the designer: Mikhail Ozornin</a></li>
<li><a href="../309036/index.html">Model of the interaction of ships with water in video games: part 2</a></li>
<li><a href="../309038/index.html">Hurricane Electric: why we entrusted our equipment to this company</a></li>
<li><a href="../309042/index.html">CSS Containment</a></li>
<li><a href="../309044/index.html">How to get an internship</a></li>
<li><a href="../309046/index.html">Dash is a blockchain that cannot be stopped.</a></li>
<li><a href="../309048/index.html">We invite you to the second hakaton Neurohack</a></li>
<li><a href="../309052/index.html">Running R functions on multiple machines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>