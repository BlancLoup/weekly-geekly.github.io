<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hibernate Cache. Practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, in the continuation of the previous article I will try to talk about real-world situations about the problems that arose while working in real pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hibernate Cache. Practice</h1><div class="post__text post__text-html js-mediator-article">  So, in the continuation of the <a href="http://habrahabr.ru/blogs/java/135176/">previous article</a> I will try to talk about real-world situations about the problems that arose while working in real projects. <br><br><h5>  Migration scripts </h5><br>  Perhaps one of the most frequent problems when working with a cache in my application is the need to roll in migration scripts on a working server.  After all, if these scripts are not run through the session server of a working server, then the cache of this factory will not know about the changes that are made to the database.  Therefore, we get the problem of data incompatibility.  There are several ways to solve this problem: <br><ol><li>  Server restart is the easiest and usually the most unacceptable way; </li><li>  Clearing the cache through certain mechanisms is perhaps the most optimal method for simplicity and reliability.  This method can be put up, for example in JMX, on a web page or another interface and called when necessary.  The flexibility of the method is that it is written once, and is used as much as you like, anywhere.  In case if your cache provider is EHCache and the provider class is SingletonEhCacheProvider, then your code may look like this: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dumpKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String regions[] = CacheManager.getInstance().getCacheNames(); StringBuilder allkeys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); String newLine = System.getProperty(<span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String region : regions) { Ehcache cache = CacheManager.getInstance().getEhcache(region); allkeys.append(toSomeReadableString(cache.getKeys())); allkeys.append(newLine); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allkeys.toString(); }</code> </pre> <br>  Naturally, this code must be executed in the same process as the Hibernate, whose statistics you want to track.  Read more <a href="http://ehcache.org/documentation/recipes/">here</a> .  The same can be achieved using the session factory. <br></li><li>  Run migration scripts using the session server of the working server.  This is similar to the second method, with the only difference that we do not clear the cache, but skip all the migration scripts through the existing factory.  Thus, all necessary caches are updated themselves.  This method is rational to use if the cache is large and cheaper to update than to create a new one; </li></ol><br><a name="habracut"></a><br><h5>  Query cache </h5><br>  Query cache is probably the most inefficient of all listed in the previous article.  There are several reasons for this: <br><ol><li>  First of all (what I forgot to mention in the first article), the key to the data of this cache is not only the request parameters, but also the request itself.  This is especially important when there are many requests and they are large. </li><li>  Query cache is often reset.  That is, if at least one of the tables that participate in the query has been modified, then the cache will be flushed and the query is executed using a new one. </li></ol><br>  Therefore, it should be used very carefully.  And remember - there is no sense to cache everything.  Cache only those requests that can really speed up your application and those requests for which the cache will be very rarely reset. <br>  A typical example of a bad place for a query cache is a sample of the amount of something on a resource with a high rate of updates / additions of entities.  Let's say you need to display the statistics of the entities created in the application by their statuses and some other parameters, like this: <br><pre> <code class="java hljs"> Criteria criteria = getSession().createCriteria(Plan.class); criteria.setProjection(Projections.projectionList() .add(Projections.groupProperty(<span class="hljs-string"><span class="hljs-string">"status"</span></span>)) .add(Projections.rowCount()) ); criteria.setCacheable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  Each time a new plan is inserted into the table or an existing one is changed, the cache will be reset.  Not only is the cache constantly reset, but there are also fixed costs for monitoring the status of the tables and maintaining the cache itself.  This can significantly hit performance.  Actually, it once happened to my application. <br><br><h5>  Deleting cached objects </h5><br>  I can not remember all the specific circumstances of the problems that happened when working in the cache.  But one of them is particularly well remember - this is the removal of objects that are in the cached collection.  It is known that objects and their dependencies are cached separately.  Therefore, if we have the following class: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"shared_doc"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SharedDoc</span></span></span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;User&gt; users; }</code> </pre><br>  And one of the users has been deleted, then we execute its removal: <br><pre> <code class="java hljs">getSession().delete(user)</code> </pre><br>  In this case, the deleted entry remains in the cache of the users collection.  We receive not consistent data.  The same is true for all sorts of cascade deletions.  When objects deleted in a cascade are left in the cache.  One of the obvious solutions is to delete objects also from the collection cache in which it can be located.  That is, in this example, the removal should look like this: <br><pre> <code class="java hljs">SharedDoc doc = (SharedDoc) session.load(SharedDoc.class, <span class="hljs-number"><span class="hljs-number">1L</span></span>); doc.getUsers().remove(user); session.delete(user);</code> </pre><br>  This works great when the user is only in one collection cache - users.  But the task is very complicated when there are many such collections and they can be scattered in different entities.  This kind of problem can also lead to an ObjectNotFoundException when attempting something with objects that are left in the cache. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Competitive transactions </h5><br>  Sometimes the cache may not behave as you would expect in the case of competitive transactions.  Consider the typical case: <br><pre> <code class="java hljs">Session session1 = getSession(); Session session2 = getSession()); Transaction t = session1.beginTransaction(); Plan plan = (Plan) session1.load(Plan.class, <span class="hljs-number"><span class="hljs-number">1L</span></span>); System.out.println (plan.getName()); plan.setName(newName); t.commit(); t = session2.beginTransaction(); plan = (Plan) session2.load(Plan.class, <span class="hljs-number"><span class="hljs-number">1L</span></span>); System.out.println (plan.getName()); tx2.commit(); session1.close(); session2.close();</code> </pre><br>  It would seem that in the second call to the plan it would have to be obtained from the second level cache - but this is not so.  Because the session2 object was created before changing the plan object.  And while referring to the second-level cache, Hibernate checks the session creation time and the time of the last object change.  This behavior should be taken into account in your applications, as it can create additional load in places where you do not expect it. <br><br>  Here, perhaps, all of what I was able to recall from the problems when working with Hibernate Cache.  Unfortunately, I did not work with the distributed cache and I have nothing to say on this topic.  If you have encountered other problems not described in the article, comment, I will add. </div><p>Source: <a href="https://habr.com/ru/post/136375/">https://habr.com/ru/post/136375/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136363/index.html">Do you own blind printing?</a></li>
<li><a href="../136369/index.html">Another development environment. Combining design and programming in a single process</a></li>
<li><a href="../136370/index.html">Progressive enhancement + mobile first = responsive web design</a></li>
<li><a href="../136371/index.html">DesignPatterns, Interpreter Template</a></li>
<li><a href="../136374/index.html">Kinetic ScrollBar</a></li>
<li><a href="../136376/index.html">A Pakistani girl who became the youngest certified Microsoft specialist at 9 years of age died</a></li>
<li><a href="../136377/index.html">How-to: How to create a beautiful and functional banner rotator with Drupal 7 tools</a></li>
<li><a href="../136380/index.html">Universal bot for the game Flood-It</a></li>
<li><a href="../136382/index.html">Where can I get a team for a startup?</a></li>
<li><a href="../136383/index.html">Visa certified BlackBerry Bold 9900, Curve 9360, Bold 9790 and Curve 9380 smartphones as mobile payment devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>