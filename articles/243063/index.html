<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make our own indication of an incoming call</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the last post about our Android application , some readers of the article had a question, how exactly to show their own information plate during...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make our own indication of an incoming call</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/files/a50/c88/3f5/a50c883f59194770beca1af50874330a.png">  After the last post about <a href="http://habrahabr.ru/company/skbkontur/blog/234241/">our Android application</a> , some readers of the article had a question, how exactly to show their own information plate during a call?  Well, today we will answer this question. <br><a name="habracut"></a><br>  The general plan is quite simple: <br><ul><li>  intercept the "incoming call" event using an <a href="http://developer.android.com/guide/components/intents-filters.html">intent filter</a> ; </li><li>  we draw our window with the necessary information over the telephone dialer window. </li></ul><br>  Let's go through the same for each item. <br><br><h2>  We intercept a call </h2><br>  In order to be able to intercept the ‚Äúcall us‚Äù event, you need to add to the application manifest a request for rights to read the status of the phone. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.READ_PHONE_STATE"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  In the same place to register service for interception of event "call". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".CallReceiver"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.PHONE_STATE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Finally, write some handling code for this event. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallReceiver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BroadcastReceiver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> incomingCall = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intent.getAction().equals(<span class="hljs-string"><span class="hljs-string">"android.intent.action.PHONE_STATE"</span></span>)) { String phoneState = intent.getStringExtra(TelephonyManager.EXTRA_STATE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (phoneState.equals(TelephonyManager.EXTRA_STATE_RINGING)) { <span class="hljs-comment"><span class="hljs-comment">//  ,   String phoneNumber = intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER); incomingCall = true; Log.debug("Show window: " + phoneNumber); } else if (phoneState.equals(TelephonyManager.EXTRA_STATE_OFFHOOK)) { //     (     / ) if (incomingCall) { Log.debug("Close window."); incomingCall = false; } } else if (phoneState.equals(TelephonyManager.EXTRA_STATE_IDLE)) { //     -       //   "     ". if (incomingCall) { Log.debug("Close window."); incomingCall = false; } } } } }</span></span></code> </pre><br>  Please note - in this example, we catch only the "incoming call" event, but the code shows how it can be redone if you need to track the outgoing too.  The variable with information about the call is static, because the <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">BroadcastReceiver</a> lives according to the principle ‚Äúreceived the message - processed it - died‚Äù, and the events of ‚Äúpicked up the phone / ended the conversation‚Äù will be received by a new instance of the object. <br><br><h2>  Call debugging </h2><br>  Of course, you can debug a call on a real phone, but it's easier and faster to test on an emulator.  A call from one native emulator to another is made using the standard dialer application, 4 numbers are used as a phone number - the port of this emulator. <br><br><img src="https://habrastorage.org/files/244/424/05f/24442405f031462a96b95fc7136bf0d1.png"><br><br>  An alternative way is to call from the <a href="http://developer.android.com/tools/debugging/ddms.html">Android Device Monitor</a> utility or from the console using <a href="http://developer.android.com/tools/help/adb.html">ADB</a> .  A noticeable minus of all these methods is that the emulator breaks the connection with the debugger for the duration of the call, but the opportunity to test the behavior of the window on different OS versions and different resolutions is worth it. <br><br><h2>  Show dice </h2><br>  Well, now the most interesting thing is showing our plate.  To do this, first, we need to add a request for rights to the manifest to create windows with the ‚Äúsystem notification‚Äù flag. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.SYSTEM_ALERT_WINDOW"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Secondly, we will edit the OnRecieve method and replace the simple logging with a call or close our window. <br><br><pre> <code class="java hljs">Log.debug(<span class="hljs-string"><span class="hljs-string">"Show window: "</span></span> + phoneNumber); showWindow(context, phoneNumber);<span class="hljs-comment"><span class="hljs-comment">// //[...] Log.debug("Close window."); closeWindow();//</span></span></code> </pre><br>  Well, the most interesting - the opening and closing of our window. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> WindowManager windowManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ViewGroup windowLayout; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showWindow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String phone)</span></span></span><span class="hljs-function"> </span></span>{ windowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); LayoutInflater layoutInflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE); WindowManager.LayoutParams params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WindowManager.LayoutParams( WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.WRAP_CONTENT, WindowManager.LayoutParams.TYPE_SYSTEM_ALERT, WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL, PixelFormat.TRANSLUCENT); params.gravity = Gravity.TOP; windowLayout = (ViewGroup) layoutInflater.inflate(R.layout.info, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); TextView textViewNumber=(TextView) windowLayout.findViewById(R.id.textViewNumber); Button buttonClose=(Button) windowLayout.findViewById(R.id.buttonClose); textViewNumber.setText(phone); buttonClose.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ closeWindow(); } }); windowManager.addView(windowLayout, params); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeWindow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (windowLayout !=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ windowManager.removeView(windowLayout); windowLayout =<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br>  Please note that to display the window, we do not start a separate <b>activity</b> , but with our hands we draw a new window through <b>WindowManager</b> .  Why?  The new <b>activity</b> falls into the general stack of screens, so if your application has at least one screen and at the time of the call it is running, the following will occur: <br><br><ol><li>  native phone dialer is displayed on the screen </li><li>  The screen displays the active screen of your application. </li><li>  your ‚Äúwindow over the top‚Äù dialer is displayed on the screen </li></ol><br>  As a result, the user will not be able to answer or reject the call without switching to the caller himself.  In the case of manual window creation, point 2 is not performed and the user will see exactly what we wanted: a telephone dialer and our window on top of it. <br><br><h2>  Underwater rocks </h2><br>  Unfortunately, everything is not as rosy as it seems.  As often happens in android, 100% compatibility tricky features difficult to achieve. <br><br>  First, you need to understand that users can have phones with different screen sizes, different resolutions and different versions of android, and you have to pretty much try to keep your window from overlapping native controls in all possible configurations. <br><br>  Secondly, on the part of HTC phones with their own program of the call, the block with information simply does not appear!  It seems that their dialer application is also displayed with system priority, so our plate appears to be ‚Äúunder their window‚Äù.  It is unpleasant, but we have not yet found a solution to this problem.  It is possible that the callers of some other phones also conflict with this opportunity, but so far we have a negative experience with only some models from HTC. <br><br>  <a href="https://github.com/Newbilius/android_custom_call_info">Demonstration project on GitHub.</a> </div><p>Source: <a href="https://habr.com/ru/post/243063/">https://habr.com/ru/post/243063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243047/index.html">A 19-year-old vulnerability can capture a computer through Internet Explorer.</a></li>
<li><a href="../243049/index.html">Which GIS to use after the actual death of Google Maps?</a></li>
<li><a href="../243051/index.html">Stack programming with a human face (part two)</a></li>
<li><a href="../243055/index.html">Own tor2web-service using Nginx and Lua</a></li>
<li><a href="../243059/index.html">Another script for generating icons for Android</a></li>
<li><a href="../243065/index.html">.NET Framework is coming to Open Source and on * nix</a></li>
<li><a href="../243067/index.html">.NET Server Core, cross-platform development, Visual Studio 2015 and other announcements of Microsoft Connect ()</a></li>
<li><a href="../243069/index.html">Restarting LitTime or a small story of 2 years of startup slip</a></li>
<li><a href="../243071/index.html">Mikrotik automatically switch to the backup channel for a dynamic ip address (issued by DHCP)</a></li>
<li><a href="../243075/index.html">What could be simpler buttons?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>