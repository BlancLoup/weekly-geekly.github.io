<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inter-AS routing. Can I save on a BGP router?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a preface: yesterday I presented the ideas below at a local meeting of administrators. After the presentation, a representative of a company engage...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inter-AS routing. Can I save on a BGP router?</h1><div class="post__text post__text-html js-mediator-article"> As a preface: yesterday I presented the ideas below at a local meeting of administrators.  After the presentation, a representative of a company engaged in the production of network equipment approached me and asked: ‚ÄúDid you publish this somewhere?  Share the presentation, I will send to colleagues to see. ‚ÄùActually, why not publish it?  As we say in Ukraine, "i mi, Khimko, people."  If someone from the vendors, even remotely, but became interested, then in the community there is a person to whom the ideas also seem interesting.  In addition, I myself plan to use this solution.  I will say right away that there will not be 100% of the finished result, but there will be some intermediate, which is enough for ersatz routing and some information to continue work in this direction.  Go! <br><a name="habracut"></a><br>  I‚Äôll say right away that the title of the article is about the router, the physical device, and not the BGP protocol.  And no, without the BGP protocol, it‚Äôs impossible to live, at least for now, but you yourself know that.  Why do we need a protocol, what is it good for, what can we do and how to set it up - masses of books and articles are written about this both on Habr√© and on third-party resources, therefore I‚Äôll omit this topic.  If you have enough statics or in the neighboring autonomous system there are creatures that you can ask to change the announcement policies, you can safely close the post - you do not need this information. <br><br>  If you're still reading, let me start with the design, since the article is more about designing a solution than about the solution itself.  So, we are the ISP A service provider, having the same address pool and the need to announce these addresses to the Network.  The general scheme of logical connections is shown in the figure. <br><br><img src="https://habrastorage.org/web/ada/96e/819/ada96e819fca4e5295e9aa7b6ded2a10.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the border of our network stands the router RTR A, which is connected by an eBGP session with a peer-neighbor.  Through the protocol session, we receive FullView from the neighbor with the address of the next transition (next-hop) - the IP address of RTR B. In response, we give information about our internal networks with the indication of the next-hop RTR A. Immediately, this is just one of many possible BGP neighborhood organization schemes: there may be several border routers, as well as neighbors, the neighbors themselves may not be connected directly, we can receive more than one FullView, reserve channels and so on.  However, I will allow myself to omit the analysis of various schemes for organizing peering and reserving, and dwell on the simplest case ‚Äî this will not change the essence, but will simplify understanding.  Inside our autonomous system, IGP operates, through which we transmit the reachability of ISPA networks.  Or does not work - this is again only one of the possible options. <br><br>  User traffic passes through the CoreA core, the RTR A router, and goes further to the Network.  In my understanding, this (with all possible variations) is the classic method of organizing the perimeter of the network and the BGP neighborhood.  Now let's see how much this hardware solution costs. <br><br>  I will build on the required bandwidth of 10 Gb / s.  At a minimum, 10GB / s interfaces with the possibility of further upgrade should be present in the solution.  Juniper proposes MX104-40G solution (or alternatively MX80) for 40 thousand dollars.  with two (four for MX80) 10 Gb / s interfaces "on board" and routing performance at 40 Gb / s (80 for MX80).  Cisco responds with a Cisco ASR 1001-X device with a base capacity of 2.5 Gb / s and two 10 Gb / s interfaces "on board" for $ 17,000 + the price of a license to improve performance (up to 20 Gb / s) and activate additional interface slots.  I will say right away that I did not set myself the task of a strict comparison of devices - in the end, the post is not about that, but some figures are needed, since our main task is to reduce the cost of the solution. <br><br>  So, at least 17 thousand dollars.  What useful does our RTRA router do?  Yes, in general, a little bit - it turns the BGP session (or several) with the neighbor and forwards the traffic to the Network.  Is it possible to do without him?  For the answer let's analyze the following topology. <br><br><img src="https://habrastorage.org/web/e1a/00c/277/e1a00c2770b644c1a24234584ea44ab8.jpg" alt="image"><br><br>  We removed the physical router and started BGP peering on the kernel device.  Is it possible?  Yes, the benefit of disarranged L3 switches support the launch of BGP.  However, this solution has at least two weak points.  First, most switches were not designed for full routing, and therefore have a limited routing table size.  For example, Juniper EX4550 has a limit of 14000 IPv4 unicast routes, and Cisco Nexus3k - 16000. Second, in order to run BGP, you will need to purchase a license, which costs 8 (Cisco Nexus3k) or 10 (Juniper EX4550) thousand dollars.  If we need redundancy switches, it will double the figures given.  In addition, you will need to negotiate with a higher provider to sum networks, well, or get the default route.  Nevertheless, such a design still allows you to abandon the purchase of a dedicated router and at the same time use the useful BGP buns.  Another possible variation on this topic is given below. <br><br><img src="http:///habrastorage.org/web/883/a90/c39/883a90c39dde49af881a608747640b3c.jpg" alt="image"><br><br>  We run the BGP process on a physical server or a virtual machine that runs an eBGP session with RTRB and iBGP with a kernel device.  On the virtual install one of the available packages for running BGP, for example Quagga, Vyatta or BIRD. <br><br>  One of the great features of the BGP protocol is the ability to change the next-hop when announcing updates, and we will use it in order to avoid a situation where user traffic needs to be forwarded through BGP speaker.  That is, we somehow divide the devices that have route information (virtual) and devices that are engaged in sending traffic (CoreA) within an autonomous system.  Accordingly, the RTRB receives the address CoreA as the next-hop and vice versa.  Such a control-plane vs forwarding-plane.  The idea itself is not new and is actively used in organizing exchange points, only through eBGP sessions. <br><br>  This is a more interesting scenario, since now we can receive both FullView and several such ones, filter and summarize routes locally, without resorting to calling the provider.  Another interesting feature of the solution is that we don‚Äôt even need to populate the kernel table on a virtual machine with BGP.  Those who are faced with the configuration, for example, Quagga know that you need to first enable the ‚Äúip forwarding‚Äù option and then transfer the routes that the daemon received to the kernel (well, or the host routing table) to correctly forward traffic.  So, this is all superfluous - the virtual machine is engaged only in the announcement of BGP information and does not participate in the traffic promotion, and filling the table inside Quagga takes as much time as is needed to transfer the routing table volume directly - seconds 10. <br><br>  This is more like the desired solution, but the issue with the license remains, because Virtualka and CoreA communicate via BGP.  Are there any other options?  Can I do without a license fee?  And here we come to the main salt of this post.  Take a look at the topology. <br><br><img src="https://habrastorage.org/web/730/0c6/e24/7300c6e244bd403ba15683f591ec4415.jpg" alt="image"><br><br>  The basic idea is the same - to run eBGP on a virtual machine, but inside an autonomous system you can already use some IGP protocol, for example, as shown in the figure, OSPF.  The part with the eBGP session remained unchanged and there are still no problems here.  But with IGP they are - in fact, none of them was intended to transmit a non-directly connected next-hop, sorry for the abundance of English words.  Among other things, Nexus3k requires a license for OSPF, but these are already details - in my Juniper network, and for the Nexus, you can use RIP :).  One way or another, it is necessary to transfer another next-hop, otherwise user traffic will go through the virtual machine, and this solution will not work.  Accordingly, we need a certain crutch that will allow the ‚Äúimpossible‚Äù - to transfer another, not local, next-hop when announcing the route.  When running ideas, I tried the following options: <br><br><ul><li>  Change next-hop when redistributing BGP-&gt; OSPF </li><li>  Change next-hop in outgoing OSPF policy </li><li>  Next-hop change in OSPF driving policy </li><li>  Changing next-hop when exporting to a forwarding table on a Juniper device </li></ul><br>  By the way, on the last point - exporting to the forwarding table - with its help, you can perform per-flow BGP ECMP, at least on Juniper.  If someone is interested, I can throw the config in gratitude for your attention to the post. <br><br>  So, unfortunately, all of the above does not work.  Qugga and Juniper silently ignored my tinkering in politics, and BIRD swore at once while trying to change the ‚Äúnext-hop‚Äù parameter in the announcement.  That's so trite and insulting my idea broke on the rocks of misunderstanding on the part of manufacturers.  In the process, I even googled the problem and it turned out that I‚Äôm not the only one who is so clever. But there was no solution to the fact, except that they indicated that Cisco has the ‚Äúforwarding address‚Äù feature (you can read it <a href="http://www.cisco.com/c/en/us/support/docs/ip/open-shortest-path-first-ospf/13682-10.html">here</a> ), but this is not it. <br><br>  Almost desperate, I turned to colleagues for help.  Andrushko Dmitry, Kovalenko Alexander (@ alk0v) and Simonenko Dmitry, thank you - the country should know its heroes!  So, there are options. <br><br>  First, there is a ready-made solution for software-defined networks called the Atruim project ( <a href="https://www.opennetworking.org/member-login/26-news-and-events/press-releases/2327-open-networking-foundation-releases-atrium-open-sdn-software-distribution">read</a> ).  In addition, if I heard correctly, Mellanox is engaged in manufacturing devices with Quagga / BIRD inside.  Strictly speaking, SDN is a cool thing - do what you want and how you want.  But this is SDN and new equipment, and my task is to solve everything on the existing one. <br><br>  Further, if I understood correctly (‚Äúif‚Äù is the main word, since I am not strong in * NIXs), the demons in Quagga (for example, ospfd) communicate with the kernel through the iproute2 module and, theoretically, you can intercept the packet at the output of ospfd and modify him.  I don‚Äôt know if I think correctly and whether it is possible, but somehow. <br><br>  And finally, the iron version - Scapy, which allows you to generate packages with the specified content.  And in fact - the structure of the OSPF packet is known to us as to what value to change, too.  Things are easy - to realize it.  This is where I stopped at the moment. <br><br>  The way I imagine the solution - it must first of all be dynamic.  Otherwise, why all these dances with protocols?  According to the opinion, you can even raise one virtual machine for each eBGP peer - the price of a virtual machine is negligible, and this simplification will allow you to simply modify all outgoing OSPF packets, changing one next-hop to another. <br><br>  But until I got to the implementation of such a decision, I decided that I would run eBGP on a virtual machine for my task, and use static on the core (CoreA).  Unscrupulously - yes, but this will allow me to do without buying a router, at least at first. <br><br>  I understand that such a solution is not suitable for transit autonomous systems and places where additional services like MPLS are needed.  There may be problems with geofiltration, or more precisely, the prioritization of a specific peer with non-adjacent blocks of addresses, where optimal summation is difficult.  It is also necessary to take into account the relatively slow transfer of routing information via IGP.  However, for dead-end AS and tasks simpler solution is quite suitable. <br><br>  These are the ideas.  I hope someone they seem interesting and will find their use. </div><p>Source: <a href="https://habr.com/ru/post/328850/">https://habr.com/ru/post/328850/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328836/index.html">National Health Data System established in France</a></li>
<li><a href="../328840/index.html">The second time he threw a net. We study the second generation Airmax AC</a></li>
<li><a href="../328842/index.html">Using OpenGL light sources to create color shadows</a></li>
<li><a href="../328844/index.html">What we should build CDN</a></li>
<li><a href="../328846/index.html">We double the capacity of the radio network. Results of implementation of Cambium Elevate on networks of operators</a></li>
<li><a href="../328852/index.html">Sales, marketing and video surveillance: unusual features of scales in modern stores</a></li>
<li><a href="../328854/index.html">Europe is changing copyright and related legislation</a></li>
<li><a href="../328856/index.html">The second group of learning Java and our news</a></li>
<li><a href="../328858/index.html">CRISP-DM: Proven Methodology for Data Scientists</a></li>
<li><a href="../328860/index.html">Test automation: who should do this, who needs it and how this area is changing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>