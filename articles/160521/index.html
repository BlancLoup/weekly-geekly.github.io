<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk server backup implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the main criteria when choosing a new PBX is reliability, resiliency and system redundancy. Small and medium-sized companies usually have a sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk server backup implementation</h1><div class="post__text post__text-html js-mediator-article">  One of the main criteria when choosing a new PBX is reliability, resiliency and system redundancy.  Small and medium-sized companies usually have a simple backup with the ability to recover within 24 hours, while for large companies it is very critical and there can be no talk of a simple telephone connection.  The company usually spends a lot of resources and money.  With the advent of the R800 and R850 from DIGIUM, asterisk becomes a truly reliable system with full PSTN redundancy of E1 / T1 / BRI and FXO lines.  Under the cut the details of the installation and configuration of two servers Asterisk and R850. <br><a name="habracut"></a><br><br>  For this project we need iron: <br><ol><li>  Server, Ubuntu 10.04 - 2 pcs (for the current version of rseries, Digium recommends using exactly ubuntu 10.04 or Centos 5.6) </li><li>  Digium R850 - 1 pc. </li><li>  Digium TE420 boards - 2 pcs. </li><li>  USB flash drive (at least 1 GB) -2 pcs. </li></ol><br>  The scheme of our system will be like this <br><img src="https://habrastorage.org/storage2/5cb/f32/b1a/5cbf32b1a92a4b985f9ab901f82c4b86.jpg"><br><br>  As can be seen in the diagram, the R850 piece of iron will receive streams from the communication provider and give them to 2 Asterisk servers.  Depending on the state of the server, the R850 will switch streams between servers; for this, it is also connected by USB ports. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/e3b/83f/27b/e3b83f27b7e3cde18849c0b5edde6516.png"><br><br>  Connection R850: <br><ol><li>  We connect Primary E1 to Master Server </li><li>  We connect the Secondary E1 to the Slave Server board </li><li>  Primary USB to Master Server port </li><li>  Secondary USB to Slave Server Port </li><li>  USB Console (optional) </li></ol><br>  The R850 is powered by a USB port, and as soon as you connect it to the server, it should turn on.  Checking the system for new USB devices <br><br>  root @ ubuntu: ~ # lsusb <br>  Bus 007 Device 003: ID 10c4: ea60 Cygnal Integrated Products, Inc.  CP210x Composite Device <br><br>  <i>All that is written below must be done on both servers!</i> <br><br><h4>  Preparing servers for working with R850 </h4><br><br>  Installing software for r-series: <br>  Before installing, you must disable the R850 from the USB port. <br><pre><code class="hljs pgsql">cd /usr/src wget http://downloads.digium.com/pub/telephony/rseries/rseries-<span class="hljs-keyword"><span class="hljs-keyword">current</span></span>.tar.gz tar zxvf rseries-<span class="hljs-keyword"><span class="hljs-keyword">current</span></span>.tar.gz cd rseries-XXX make &amp;&amp; make install</code> </pre> <br><br>  Next, reconnect the R850 to the server and check <br><br><pre> <code class="hljs pgsql">./rtest.sh <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> /dev/rseries0</code> </pre> <br><br>  Must get such an answer <br><pre> <code class="hljs pgsql">R-Series hardware <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> detected! Firmware <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-type"><span class="hljs-type">Serial</span></span> number: DM96137330014 Product number: R850 Ports: <span class="hljs-number"><span class="hljs-number">8</span></span> ID Switch: <span class="hljs-number"><span class="hljs-number">0</span></span> Watchdog Timeout (<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>): <span class="hljs-number"><span class="hljs-number">5</span></span> Control mode: <span class="hljs-number"><span class="hljs-number">1</span></span> Port <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1 Port <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>, T1/E1</code> </pre><br>  For full testing of the R850, you can run ./rtest.sh tests / dev / rseries0 The piece of iron will switch threads for a couple of seconds and click. <br><br><h4>  Setting up a clustering system based on Pacemaker, Corosync, and DRBD </h4><br><br>  <b>DRBD</b> is a block device that provides synchronization (RAID1) between the local block device and the remote one.  In our case, I will use 2 flash drives. <br><br>  Cooking flash drives for DRBD <br><br>  1) Delete (carefully I have a flash drive / dev / sdb you may have another disk) <br><pre> <code class="hljs javascript">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span>zero <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span>sdb bs=<span class="hljs-number"><span class="hljs-number">1</span></span>M</code> </pre> <br>  2) Create a partition on 1GB.  (can be more) <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fdisk</span></span> /dev/sdb</code> </pre> <br>  further n, p, 1, 1, + 1024M <br><br>  3) Installing Pacemaker, Corosync, and DRBD <br><pre> <code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> drbd8-utils apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> corosync pacemaker</code> </pre><br><br>  4) Install configs <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/rseries-XXX/ make samples</code> </pre><br>  if you get a message <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> installing /etc/corosync/corosync.conf (already <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>)</code> </pre><br>  then copy it with your hands. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">cp</span></span> configs/corosync/corosync.conf /etc/corosync/corosync.conf</code> </pre><br><br><h5>  Getting Started </h5><br><br>  1) Edit /etc/drbd.d/asterisk.res, change my data, e-mail, IP disk and hostname, I left astnode1 and astnode2 and it turned out like this: <br><pre> <code class="hljs pgsql">resource asterisk { handlers { split-brain "/usr/lib/drbd/notify-split-brain.sh adm@pbxware.ru"; } net { <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-sb<span class="hljs-number"><span class="hljs-number">-0</span></span>pri <span class="hljs-keyword"><span class="hljs-keyword">discard</span></span>-younger-<span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-sb<span class="hljs-number"><span class="hljs-number">-1</span></span>pri <span class="hljs-keyword"><span class="hljs-keyword">discard</span></span>-secondary; <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-sb<span class="hljs-number"><span class="hljs-number">-2</span></span>pri disconnect; } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> astnode1 { device /dev/drbd0; disk /dev/sdb1; address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.253</span></span>:<span class="hljs-number"><span class="hljs-number">7789</span></span>; meta-disk <span class="hljs-type"><span class="hljs-type">internal</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> astnode2 { device /dev/drbd0; disk /dev/sdb1; address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span>:<span class="hljs-number"><span class="hljs-number">7789</span></span>; meta-disk <span class="hljs-type"><span class="hljs-type">internal</span></span>; } }</code> </pre><br><br>  2) Change the host depending on the server (etc / hostname) <br>  hostname astnode1 - on the first machine and <br>  hostname astnode2 - on the second <br><br>  3) Create a new block device <br><pre> <code class="hljs pgsql">drbdadm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-md asterisk</code> </pre> <br>  if everything is set right then you will get <br><pre> <code class="hljs haskell">‚Ä¶. <span class="hljs-type"><span class="hljs-type">New</span></span> drbd meta <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> block successfully created.</span></span></code> </pre><br><br>  Now you can run DRDB <br><pre> <code class="hljs sql">/etc/init.d/drbd <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">Starting</span></span> DRBD resources [ d(asterisk) n(asterisk) ] [ OK ]</code> </pre><br><br>  <i>The following steps need only be done on the main server astnode1</i> <br><br>  Create a partition on DRBD <br><pre> <code class="hljs javascript">drbdadm disconnect asterisk drbdadm -- --clear-bitmap <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-current-uuid asterisk drbdadm -- --overwrite-data-<span class="hljs-keyword"><span class="hljs-keyword">of</span></span>-peer primary asterisk mkfs.ext3 -m0 /dev/drbd0 drbdadm secondary asterisk drbdadm detach asterisk drbdadm up asterisk</code> </pre><br><br>  Check on the first server astnode1 <br><pre> <code class="hljs dos">drbdadm primary asterisk <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /mnt/asterisk mount -t ext3 /dev/drbd0 /mnt/asterisk <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/asterisk touch test ls</code> </pre><br>  If the test file is there, then everything goes according to plan, disable drbd <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> umount /mnt/asterisk drbdadm secondary asterisk</code> </pre><br><br>  Now we check on the second server astnode2 <br><pre> <code class="hljs dos">drbdadm primary asterisk <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /mnt/asterisk mount -t ext3 /dev/drbd0 /mnt/asterisk <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/asterisk ls</code> </pre><br>  Here we should also see the test file, further: <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> umount /mnt/asterisk drbdadm secondary asterisk</code> </pre><br><br>  At this stage, our system is ready to install Asterisk, Dahdi and LibPRI. <br>  On the main server astnode1 we create the necessary files and links: <br><pre> <code class="hljs pgsql">cd /usr/src/rseries<span class="hljs-number"><span class="hljs-number">-1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/ drbdadm <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> asterisk mount -t ext3 /dev/drbd0 /mnt/asterisk ./createlinks.sh</code> </pre><br><br><h4>  Install Asterisk, DAHDI and LibPRI </h4><br><br>  <i>Installation on the first server astnode1</i> <br>  1) Install the necessary packages to build DAHDI and Asterisk <br><pre> <code class="hljs sql">aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mc htop iftop linux-headers-<span class="hljs-string"><span class="hljs-string">`uname -r`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>-essential subversion libncurses5-dev libssl-dev libxml2-dev vim-nox libsqlite3-dev sqlite3 libnewt-dev</code> </pre> <br>  2) Download Asterisk, DAHDI and LibPRI <br><pre> <code class="hljs ruby">wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/dahdi</span></span>-linux-complete/dahdi-linux-complete-<span class="hljs-number"><span class="hljs-number">2.6</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">2.6</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.tar.gz wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/certified</span></span>-asterisk/certified-asterisk-<span class="hljs-number"><span class="hljs-number">1.8</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span>-current.tar.gz wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/libpri</span></span><span class="hljs-regexp"><span class="hljs-regexp">/releases/libpri</span></span>-<span class="hljs-number"><span class="hljs-number">1.4</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>.tar.gz</code> </pre><br>  3) Unpack <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">libpri-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certified-asterisk-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11-current</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dahdi-linux-complete-2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span>+2<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span></code> </pre><br>  4) We collect <br><pre> <code class="hljs go">cd libpri<span class="hljs-number"><span class="hljs-number">-1.4</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install cd ../dahdi-linux-complete<span class="hljs-number"><span class="hljs-number">-2.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>+<span class="hljs-number"><span class="hljs-number">2.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/ <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> config cd ../certified-asterisk<span class="hljs-number"><span class="hljs-number">-1.8</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>-cert8/ ./configure &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> samples</code> </pre><br>  After successful installation <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">umount</span></span> /mnt/asterisk/ drbdadm secondary asterisk</code> </pre><br><br>  <i>Go to the installation on the second server astnode2</i> <br><pre> <code class="hljs pgsql">cd /usr/src/rseries<span class="hljs-number"><span class="hljs-number">-1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/ drbdadm <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> asterisk mount -t ext3 /dev/drbd0 /mnt/asterisk ./createlinks.sh</code> </pre><br><br>  here the script will answer that there are already such folders, as it should be. <br>  The installation on the second server is almost identical to the first one, we do everything except make samples for asterisk. <br><br><div class="spoiler">  <b class="spoiler_title">Installation on the second server astnode2</b> <div class="spoiler_text">  1) Install the necessary packages to build DAHDI and Asterisk <br><pre> <code class="hljs sql">aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mc htop iftop linux-headers-<span class="hljs-string"><span class="hljs-string">`uname -r`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>-essential subversion libncurses5-dev libssl-dev libxml2-dev vim-nox libsqlite3-dev sqlite3 libnewt-dev</code> </pre> <br>  2) Download Asterisk, DAHDI and LibPRI <br><pre> <code class="hljs ruby">wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/dahdi</span></span>-linux-complete/dahdi-linux-complete-<span class="hljs-number"><span class="hljs-number">2.6</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">2.6</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.tar.gz wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/certified</span></span>-asterisk/certified-asterisk-<span class="hljs-number"><span class="hljs-number">1.8</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span>-current.tar.gz wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/libpri</span></span><span class="hljs-regexp"><span class="hljs-regexp">/releases/libpri</span></span>-<span class="hljs-number"><span class="hljs-number">1.4</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>.tar.gz</code> </pre><br>  3) Unpack <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">libpri-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certified-asterisk-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11-current</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-zxvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dahdi-linux-complete-2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span>+2<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span></code> </pre><br>  4) We collect <br><pre> <code class="hljs go">cd libpri<span class="hljs-number"><span class="hljs-number">-1.4</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install cd ../dahdi-linux-complete<span class="hljs-number"><span class="hljs-number">-2.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>+<span class="hljs-number"><span class="hljs-number">2.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/ <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> config cd ../certified-asterisk<span class="hljs-number"><span class="hljs-number">-1.8</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>-cert8/ ./configure &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install</code> </pre><br>  After successful installation <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">umount</span></span> /mnt/asterisk/ drbdadm secondary asterisk</code> </pre><br></div></div><br><br><h4>  Getting down to setting up Corosync on both servers. </h4><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">vim</span></span> /etc/corosync/corosync.conf</code> </pre><br>  We rule memberaddr in accordance with our IP addresses of servers and bindnetaddr <br>  here is my config: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">totem</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">version</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> token: <span class="hljs-number"><span class="hljs-number">3000</span></span> token_retransmits_before_loss_const: <span class="hljs-number"><span class="hljs-number">10</span></span> join: <span class="hljs-number"><span class="hljs-number">60</span></span> consensus: <span class="hljs-number"><span class="hljs-number">5000</span></span> vsftype: none max_messages: <span class="hljs-number"><span class="hljs-number">20</span></span> clear_node_high_bit: yes secauth: off threads: <span class="hljs-number"><span class="hljs-number">0</span></span> rrp_mode: none interface { ringnumber: <span class="hljs-number"><span class="hljs-number">0</span></span> bindnetaddr: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.0</span></span> broadcast: yes mcastport: <span class="hljs-number"><span class="hljs-number">5405</span></span> member { memberaddr: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.253</span></span> } <span class="hljs-selector-tag"><span class="hljs-selector-tag">member</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">memberaddr</span></span>: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.252</span></span> } } } <span class="hljs-selector-tag"><span class="hljs-selector-tag">aisexec</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">user</span></span>: root group: root } <span class="hljs-selector-tag"><span class="hljs-selector-tag">logging</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">fileline</span></span>: off to_stderr: yes to_logfile: no to_syslog: yes syslog_facility: daemon debug: off timestamp: on logger_subsys { subsys: AMF debug: off tags: enter|leave|trace1|trace2|trace3|trace4|trace6 } } <span class="hljs-selector-tag"><span class="hljs-selector-tag">amf</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">mode</span></span>: disabled }</code> </pre><br><br>  Then we change in / etc / default / corosync START = no to START = yes <br><br>  We start <br><pre> <code class="hljs sql">/etc/init.d/corosync <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">Starting</span></span> corosync daemon corosync [ OK ]</code> </pre><br><br><h4>  Pacemaker setup </h4><br>  <i>It is necessary to configure it only on the first server astnode1</i> <br><br>  In rseries-1.0.0 there is an example of setting it up and we‚Äôll edit it. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">vim</span></span> /usr/src/rseries-<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>/configs/pacemaker/pacemaker.cfg</code> </pre><br>  I changed in it only the SP gateway address GatewayStatus and ocf: heartbeat: IPaddr2 SP address of my SIP phone. <br>  Config: <br><pre> <code class="hljs sql">node astnode1 node astnode2 primitive Asterisk ocf:Digium:asterisk \ op monitor interval="5" primitive Asterisk_drbd ocf:linbit:drbd \ params drbd_resource="asterisk" \ op monitor <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-delay=<span class="hljs-string"><span class="hljs-string">"10"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>=<span class="hljs-string"><span class="hljs-string">"5"</span></span> primitive Asterisk_fs ocf:heartbeat:Filesystem \ params device=<span class="hljs-string"><span class="hljs-string">"/dev/drbd/by-res/asterisk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">directory</span></span>=<span class="hljs-string"><span class="hljs-string">"/mnt/asterisk/"</span></span> fstype=<span class="hljs-string"><span class="hljs-string">"ext3"</span></span> primitive ClusterIP ocf:heartbeat:IPaddr2 \ params ip=<span class="hljs-string"><span class="hljs-string">"192.168.1.109"</span></span> cidr_netmask=<span class="hljs-string"><span class="hljs-string">"32"</span></span> \ op monitor <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>=<span class="hljs-string"><span class="hljs-string">"5"</span></span> primitive GatewayStatus ocf:pacemaker:ping \ params host_list=<span class="hljs-string"><span class="hljs-string">"192.168.1.1"</span></span> multiplier=<span class="hljs-string"><span class="hljs-string">"100"</span></span> \ op monitor <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>=<span class="hljs-string"><span class="hljs-string">"5"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-string"><span class="hljs-string">"10"</span></span> primitive rseries0 ocf:Digium:rseries \ params tty=<span class="hljs-string"><span class="hljs-string">"/dev/rseries0"</span></span> \ op monitor <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>=<span class="hljs-string"><span class="hljs-string">"10"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>=<span class="hljs-string"><span class="hljs-string">"Master"</span></span> \ op monitor <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>=<span class="hljs-string"><span class="hljs-string">"60"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>=<span class="hljs-string"><span class="hljs-string">"Slave"</span></span> ms Asterisk_ms Asterisk_drbd \ meta <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>-node-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span>-node-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> notify=<span class="hljs-string"><span class="hljs-string">"true"</span></span> ms rseries0_ms rseries0 \ meta <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>-node-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span>-node-<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span> target-<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>=<span class="hljs-string"><span class="hljs-string">"Master"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> GatewayStatusClone GatewayStatus location Asterisk-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-ping Asterisk \ rule $<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"Asterisk-with-ping-rule"</span></span> -inf: not_defined pingd <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> pingd lte <span class="hljs-number"><span class="hljs-number">0</span></span> colocation Everything-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-Asterisk inf: ( rseries0_ms:<span class="hljs-keyword"><span class="hljs-keyword">Master</span></span> Asterisk_ms:<span class="hljs-keyword"><span class="hljs-keyword">Master</span></span> ) ( ClusterIP Asterisk_fs ) Asterisk <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> Asterisk-<span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-Everything inf: ( rseries0_ms:promote Asterisk_ms:promote ) ( ClusterIP Asterisk_fs ) Asterisk:<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> property $<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"cib-bootstrap-options"</span></span> \ cluster-infrastructure=<span class="hljs-string"><span class="hljs-string">"openais"</span></span> \ expected-quorum-votes=<span class="hljs-string"><span class="hljs-string">"2"</span></span> \ stonith-enabled=<span class="hljs-string"><span class="hljs-string">"false"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-quorum-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>=<span class="hljs-string"><span class="hljs-string">"ignore"</span></span> rsc_defaults $<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"rsc-options"</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">resource</span></span>-stickiness=<span class="hljs-string"><span class="hljs-string">"99"</span></span></code> </pre><br><br>  use config for pacemaker <br><pre> <code class="hljs pgsql">cd /usr/src/rseries<span class="hljs-number"><span class="hljs-number">-1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/ crm configure <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> configs/pacemaker/pacemaker.cfg</code> </pre><br>  <i>On the second server, nothing needs to be done.</i> <br><br><h4>  R850 Setup </h4><br><br>  To configure, use the Console port on the R850 and the cable from slave-astnode2 for example <br><pre> <code class="hljs ruby">minicom -s +-----------------------------------------------------------------------+ <span class="hljs-params"><span class="hljs-params">| A - Serial Device : /dev/ttyUSB0 |</span></span> <span class="hljs-params"><span class="hljs-params">| B - Lockfile Location : /var/lock |</span></span> <span class="hljs-params"><span class="hljs-params">| C - Callin Program : |</span></span> <span class="hljs-params"><span class="hljs-params">| D - Callout Program : |</span></span> <span class="hljs-params"><span class="hljs-params">| E - Bps/Par/Bits : 115200 8N1 |</span></span> <span class="hljs-params"><span class="hljs-params">| F - Hardware Flow Control : No |</span></span> <span class="hljs-params"><span class="hljs-params">| G - Software Flow Control : No |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| Change which setting? |</span></span> +-----------------------------------------------------------------------+</code> </pre><br><br>  A menu for setting should appear here: for E1, I configured it like this: <br><pre> <code class="hljs vbscript">Digium R850 Firmware Version: <span class="hljs-number"><span class="hljs-number">5</span></span> Serial Number: DM96137330014 Port |Mode Passthrough State All | --- --- --- <span class="hljs-number"><span class="hljs-number">1</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">2</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">3</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">4</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">5</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">6</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">7</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary <span class="hljs-number"><span class="hljs-number">8</span></span> | T1/E1 disabled Input <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Primary Arrow keys <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> a (<span class="hljs-built_in"><span class="hljs-built_in">left</span></span>), d (<span class="hljs-built_in"><span class="hljs-built_in">right</span></span>), w (up) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> s (down) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> navigate thru menu r <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> refresh, &lt;enter&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>, c <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> commit changes o <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> toggle operational state, xxx <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> menu.</code> </pre><br><br>  You can also use rctl from the rseries package to control the R850, it will allow you to check and update the firmware and test the device. <br><br><h4>  System testing </h4><br><img src="https://habrastorage.org/storage2/401/d18/d49/401d18d49e0ed1315fa4c7a5bf48aa1a.png"><br><img src="https://habrastorage.org/storage2/8cc/2ab/f95/8cc2abf9526337fc308367c4b5a07497.png"><br><br>  First, check that the R850 is switched to the first astnode astnode1 <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">root</span></span>@astnode1:~# dahdi_scan [<span class="hljs-number"><span class="hljs-number">1</span></span>] active=yes alarms=<span class="hljs-type"><span class="hljs-type">OK</span></span> description=<span class="hljs-type"><span class="hljs-type">T2XXP</span></span> (<span class="hljs-type"><span class="hljs-type">PCI</span></span>) <span class="hljs-type"><span class="hljs-type">Card</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">Span</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> name=<span class="hljs-type"><span class="hljs-type">TE2</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> manufacturer=<span class="hljs-type"><span class="hljs-type">Digium</span></span> devicetype=<span class="hljs-type"><span class="hljs-type">Wildcard</span></span> <span class="hljs-type"><span class="hljs-type">TE220</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>th <span class="hljs-type"><span class="hljs-type">Gen</span></span>) location=<span class="hljs-type"><span class="hljs-type">Board</span></span> <span class="hljs-type"><span class="hljs-type">ID</span></span> <span class="hljs-type"><span class="hljs-type">Switch</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> basechan=<span class="hljs-number"><span class="hljs-number">1</span></span> totchans=<span class="hljs-number"><span class="hljs-number">31</span></span> irq=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">=digital-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">E1</span></span></span><span class="hljs-class"> syncsrc=1 lbo=0 db (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CSU</span></span></span><span class="hljs-class">)/0-133 feet (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DSX</span></span></span><span class="hljs-class">-1) coding_opts=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AMI</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HDB3</span></span></span><span class="hljs-class"> framing_opts=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CCS</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CRC4</span></span></span><span class="hljs-class"> coding=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HDB3</span></span></span><span class="hljs-class"> framing=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CCS</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CRC4</span></span></span><span class="hljs-class"> [2] active=yes alarms=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class"> description=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T2XXP</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PCI</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> 0 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Span</span></span></span><span class="hljs-class"> 2 name=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TE2</span></span></span><span class="hljs-class">/0/2 manufacturer=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Digium</span></span></span><span class="hljs-class"> devicetype=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Wildcard</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TE220</span></span></span><span class="hljs-class"> (5</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gen</span></span></span><span class="hljs-class">) location=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Board</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Switch</span></span></span><span class="hljs-class"> 0 basechan=32 totchans=31 irq=0 </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">=digital-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">E1</span></span></span><span class="hljs-class"> syncsrc=1 lbo=0 db (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CSU</span></span></span><span class="hljs-class">)/0-133 feet (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DSX</span></span></span><span class="hljs-class">-1) coding_opts=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AMI</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HDB3</span></span></span><span class="hljs-class"> framing_opts=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CCS</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CRC4</span></span></span><span class="hljs-class"> coding=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HDB3</span></span></span><span class="hljs-class"> framing=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CCS</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CRC4</span></span></span></span></code> </pre><br><br>  alarms = OK everything works fine; if not, then I advise you just to restart astnode1 and then astnode2. <br><br><h5>  Falling Asterisk on astnode1 </h5><br>  Run killall asterisk <br>  we get a log <br><pre> <code class="hljs pgsql">crmd: [<span class="hljs-number"><span class="hljs-number">810</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: process_lrm_event: LRM operation Asterisk_monitor_5000 (<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>=<span class="hljs-number"><span class="hljs-number">21</span></span>, rc=<span class="hljs-number"><span class="hljs-number">7</span></span>, cib-<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>=<span class="hljs-number"><span class="hljs-number">56</span></span>, confirmed=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> running ‚Ä¶. Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> astnode1 crmd: [<span class="hljs-number"><span class="hljs-number">810</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: te_rsc_command: Initiating action <span class="hljs-number"><span class="hljs-number">25</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> Asterisk_start_0 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> astnode1 (<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>) Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> astnode1 crmd: [<span class="hljs-number"><span class="hljs-number">810</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: do_lrm_rsc_op: Performing key=<span class="hljs-number"><span class="hljs-number">25</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">90</span></span>c9675a<span class="hljs-number"><span class="hljs-number">-3</span></span>c31<span class="hljs-number"><span class="hljs-number">-4e86</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>f90<span class="hljs-number"><span class="hljs-number">-68</span></span>c13142b377 op=Asterisk_start_0 ) Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> astnode1 lrmd: [<span class="hljs-number"><span class="hljs-number">807</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: rsc:Asterisk:<span class="hljs-number"><span class="hljs-number">23</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br><br>  crmd re-launched Asterisk and it works further, but since there are times when the asterisk no longer rises.  Let's try to imitate such a test: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mv</span></span> /usr/sbin/asterisk /usr/sbin/asterisk-back killall asterisk</code> </pre><br>  Look logs: <br><pre> <code class="hljs pgsql">Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> astnode1 pengine: [<span class="hljs-number"><span class="hljs-number">809</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>: get_failcount: Asterisk has failed <span class="hljs-number"><span class="hljs-number">1000000</span></span> times <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> astnode1 Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> astnode1 pengine: [<span class="hljs-number"><span class="hljs-number">809</span></span>]: WARN: common_apply_stickiness: Forcing Asterisk away <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> astnode1 <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-number"><span class="hljs-number">1000000</span></span> failures (max=<span class="hljs-number"><span class="hljs-number">1000000</span></span>) Nov <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> astnode1 pengine: [<span class="hljs-number"><span class="hljs-number">809</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">notice</span></span>: LogActions: <span class="hljs-keyword"><span class="hljs-keyword">Start</span></span> Asterisk#<span class="hljs-number"><span class="hljs-number">011</span></span>(astnode2)</code> </pre><br><br>  Asterisk rises on the second server, the R850 clicks and switches threads. <br><br><h5>  Problems with server power. </h5><br>  Before the test, I returned astnode1 to a working state, but the threads remained on the second server.  Let's check how the system works if the power is turned off on the second server. <br><br>  logs: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 9 13<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">astnode1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">crmd</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[810]</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">info</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ais_status_callback</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">astnode2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">is</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">now</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lost</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">member</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 9 13<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:21</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">astnode1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 937.276823]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wct4xxp</span></span> 0000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:06</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:08.0</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Clearing</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">yellow</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alarm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">span</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nov</span></span> 9 13<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:21</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">astnode1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 937.448860]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wct4xxp</span></span> 0000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:06</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:08.0</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Clearing</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">yellow</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alarm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">span</span></span> 2</code> </pre><br>  I think everything is clear, the astnode2 server crashed and the streams and asterisk rose to astnode.  Also tested disconnecting the USB cable and disconnecting the server from the local network. The R850 always worked. <br><br>  Thanks to DIGIUM and the new product R850, Asterisk has risen to a new level of reliability and application.  Now asteriskers can sleep peacefully. </div><p>Source: <a href="https://habr.com/ru/post/160521/">https://habr.com/ru/post/160521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160497/index.html">Xen Cloud Platform 1.6 released</a></li>
<li><a href="../160503/index.html">Rectal tonsillectomy: working with AD in Powershell without AD cmdlets</a></li>
<li><a href="../160513/index.html">Intel invites habragers to an event for bloggers</a></li>
<li><a href="../160517/index.html">What is an in-memory data grid</a></li>
<li><a href="../160519/index.html">Mobile office from a tablet or a review of Polaris Office</a></li>
<li><a href="../160523/index.html">The first service pack for Visual Studio 2012 has been released</a></li>
<li><a href="../160525/index.html">The following login mechanism (in addition to third-party authentication) I implement through:</a></li>
<li><a href="../160527/index.html">Marking vacancies for people with disabilities</a></li>
<li><a href="../160531/index.html">Software Defined Networks: Present and Future</a></li>
<li><a href="../160533/index.html">Everyday life of the space colonizer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>