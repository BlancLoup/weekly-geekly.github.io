<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Direct routing and balancing with NFT vs Nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing high-load network applications, there is a need for load balancing. 

 A popular L7 balancing tool is Nginx. It allows you to cache re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Direct routing and balancing with NFT vs Nginx</h1><div class="post__text post__text-html js-mediator-article">  When developing high-load network applications, there is a need for load balancing. <br><br>  A popular L7 balancing tool is Nginx.  It allows you to cache responses, choose different strategies, and even script on LUA. <br><br>  Despite all the charms of Nginx, if: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  No need to work with HTTP (s). </li><li>  You need to squeeze the maximum out of the network </li><li>  There is no need to cache anything - behind the balancer, clean API servers with dynamics. </li></ol><br>  The question may arise: why do we need Nginx?  Why spend resources on balancing on L7, isn't it easier to just forward a SYN packet?  (L4 Direct Routing). <br><a name="habracut"></a><br><h3>  Layer 4 balancing or as balanced in antiquity </h3><br>  A popular packet forwarding tool was IPVS.  He performed the tasks of balancing through the tunnel and Direct Routing. <br><br>  In the first case, for each connection, a TCP channel was established and a packet from the user went to the balancer, then to the minion, and then in the reverse order. <br><br><img src="https://habrastorage.org/webt/cy/so/j6/cysoj6mgraildwjgs1sbwvufpt4.png"><br><br>  In this scheme, the main problem is visible: in the opposite direction, the data go first to the balancer, and then to the user (Nginx works in the same way).  Unnecessary work is done, given the fact that more data is usually sent to the user, this behavior leads to some loss of performance. <br><br>  This deficiency is devoid of (but endowed with new) balancing method called Direct Routing.  Schematically, it looks like this: <br><br><img src="https://habrastorage.org/webt/hy/9r/5-/hy9r5-brkhgzmjgmotrnnibfta4.png"><br><br>  In the case of Direct Routing, the reverse packets go directly to the user, bypassing the balancer.  Obviously, both balancer and network resources are saved.  By saving network resources, it means not so much traffic saving, because the usual practice is to connect servers to a separate grid and not account traffic, but the fact that even transferring through a balancer is a loss of milliseconds. <br><br>  This method imposes certain restrictions: <br><br><ol><li>  The datacenter where the infrastructure is located should allow spoofing local addresses.  In the scheme above, each minion must send packets back on behalf of IP 10.10.0.1, which is assigned to the balancer. </li><li>  Balancer knows nothing about the state of the minions.  Therefore, the strategies of Least Conn and Least Time are not realizable out of the box.  In one of the subsequent articles I will try to implement them and show the result. </li></ol><br><h3>  Here Comes NFTables </h3><br>  A few years ago, Linux began to actively promote NFTables as a replacement for IPTables, ArpTables, EBTables and all the rest [az] {1,} Tables.  At the moment when we had to Adram, it became necessary to squeeze every millisecond of the response from the network, I decided to pull out the checker and look for it - or maybe ipTables learned how to do iphash forwarding and can be quickly balancing it.  Then I came across nftables, which can and not only that, but iptables still doesn‚Äôt even know how to do it. <br>  After several days of proceedings, I was finally able to start up Direct Routing and Channel Routing via NFTables in the test lab, as well as test them in comparison with nginx. <br><br>  So, test lab.  We have 5 cars: <br><br><ol><li>  nft-router is a router that performs the task of communicating with the client and the AppServer subnet.  There are 2 network cards on it: 192.168.56.254 - looks at the appserver network, 192.168.97.254 - looks at the clients.  Ip_forward is on and all routes are registered. </li><li>  nft-client: client from which ab will be chased, ip 192.168.97.2 </li><li>  nft-balancer: balancer.  It has two IPs: 192.168.56.4, to which clients and 192.168.13.1 are accessed, from the minion subgrid. </li><li>  nft-minion-a and nft-minion-b: minions of types: 192.168.56.2, 192.168.56.3 and 192.168.13.2 and 192.168.13.3 (I tried to balance it through the same network and through different networks).  In the tests I stopped at the fact that the minions have ‚Äúexternal‚Äù types - on the 192.168.56.0/24 subnet </li></ol><br>  All interfaces have MTU 1500. <br><br><h4>  Direct routing </h4><br>  Settings NFTables on the balancer: <br><br><pre><code class="json hljs">table ip raw { chain input { type filter hook prerouting priority -300; policy accept; tcp dport http ip daddr set jhash tcp sport mod 2 map { 0: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, 1: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> } } }</code> </pre> <br>  A raw chain is created, on the pre-outs hook, with a priority of -300. <br><br>  If a packet arrives with a target address http, then depending on the source port (made for testing from one machine, ip saddr is needed in reality), either 56.2 or 56.3 is selected and set as the target address in the packet, and then sent further along the routes.  Roughly speaking, for even ports 56.2, for odd ports, respectively, 56.3 (in fact, not, for even / odd hashes, but it is easier to understand that way).  After setting the target IP, the packet goes back to the network.  No NAT occurs, the minions packet comes from the source IP of the client, not the balancer, which is important for Direct Routing. <br><br>  NFT settings on minions: <br><br><pre> <code class="json hljs">table ip raw { chain output { type filter hook output priority -300; policy accept; tcp sport http ip saddr set 192.168.56.4 } }</code> </pre><br>  Raw output hook is created with a priority of -300 (priority is very important here, at higher ones, the required mengling will not work for reply packages). <br><br>  All outgoing traffic from the http port is signed 56.4 (ip balancer) and sent straight to the client, bypassing the balancer. <br><br>  To check whether everything will work correctly, I started a client in another network and started it through a router. <br><br>  I also disabled arp_filter, rp_filter (so that spoofing works) and enabled ip_forward both on the balancer and on the router. <br><br>  For benches, in the case of NFT, Nginx + php7.2-FPM is used through the unix socket on each minion.  There was nothing on the balancer. <br><br>  In the case of Nginx used: nginx on the balancer and php7.2-FPM via TCP on the minions.  As a result, I was not balancing the web server behind the balancer, but at once FPM (which will be more honest with respect to nginx, and correspond more to real life). <br><br>  For NFT, only the hash strategy was used (in the table, <b>nft dr</b> ), for nginx: hash ( <b>ngx eq</b> ) and least conn ( <b>ngx lc</b> ) <br><br>  Several tests were done. <br><br><ol><li>  Small quick script <b>(small)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> system(<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>);</code> </pre><br></li><li>  Script with random delay <b>(rand)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> usleep(mt_rand(<span class="hljs-number"><span class="hljs-number">100000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ok"</span></span>;</code> </pre></li><li>  Script with sending a large amount of data <b>(size)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $size=$_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]; $file=<span class="hljs-string"><span class="hljs-string">'/tmp/'</span></span>.$size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($file)) { $dummy=<span class="hljs-string"><span class="hljs-string">""</span></span>; exec (<span class="hljs-string"><span class="hljs-string">"dd if=/dev/urandom of=$file bs=$size count=1 2&gt;&amp;1"</span></span>,$dummy); } fpassthru (fopen($file,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>));</code> </pre><br>  The following dimensions were used: <br>  512,1440,1460,1480,1500,2048,65535,655350 bytes. <br>  Before the tests, I warmed up the files with statics, on each minion. <br></li></ol><br>  Tested ab, three times each test: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash function do_test() { rep=$3 for i in $(seq $rep) do echo "testing $2 # $i" echo "$2 pass $i" &gt;&gt; $2 ab $1 &gt;&gt; $2 echo "--------------------------" &gt;&gt; $2 done } do_test " -n 5000 -c 100 http://192.168.56.4:80/rand.php" "ngx_eq_test_rand" 3 do_test " -n 10000 -c 100 http://192.168.56.4:80/" "ngx_eq_test_small" 3 size=512 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1440 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1460 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1480 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1500 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=2048 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=65535 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=655350 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3</span></span></code> </pre> <br>  Initially, I planned to give the test time, milliseconds and the rest, eventually settled on the RPS - they are representative and correlate with time indicators. <br><br>  Got the following results: <br><br>  Test Size - columns - the size of the data given. <br><br><img src="https://habrastorage.org/webt/hk/yi/ma/hkyimanxhaoa_7ejz-ehvmecp1s.png"><br><br>  As you can see, nft direct routing wins by a wide margin. <br><br>  I was counting on several other results related to the size of the ethernet frame, but no correlation was found.  Perhaps the 512 body doesn‚Äôt fit in 1500 MTU, although I doubt the small test will be revealing. <br><br>  I noticed that on large volumes (650k) nginx reduces the gap.  Perhaps this is somehow related to the buffers and TCP Windows size. <br><br>  The result of the rand test.  Shows how at least conn copes in terms of different speed of scripts execution on different minions. <br><br><img src="https://habrastorage.org/webt/z_/pe/se/z_pesed0h37wmanijte9wjsr7ra.png"><br><br>  Surprisingly, nginx hash worked faster than least conn, and only in the final pass, at least conn took the lead a little, which does not claim to be of statistical significance. <br>  The numbers of passages are very different due to the fact that 100 threads are leaving at once, and FPM-ok loads about 10 from the start. By the third pass, they managed to roll up - which shows the applicability of the strategies for berst. <br><br>  NFT is expected to lose this test.  Nginx well optimizes interaction with FPMs in such situations. <br><br>  small test <br><br><img src="https://habrastorage.org/webt/wo/l-/ua/wol-uar4xattjpfztcpppy53hae.png"><br><br>  nft slightly wins over RPS, at least conn again as an outsider. <br><br>  By the way, in this test it is clear that 400-500RPS is being issued, although on the test with sending 512 bytes it was over 1500 - it seems that the system eats this thousand. <br><br><h2>  findings </h2><br>  NFT performed well in the situation of uniform load optimization: when a lot of data is given, and the application running time is deterministic and the cluster resources are enough to test the incoming stream without spinning. <br><br>  In a situation where the load on each request is chaotic and it is impossible to evenly balance the load on the servers with the primitive remainder of the hash division, the NFT will lose. </div><p>Source: <a href="https://habr.com/ru/post/441348/">https://habr.com/ru/post/441348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441322/index.html">What's in the heart of a drone?</a></li>
<li><a href="../441328/index.html">About quantum computing and free will</a></li>
<li><a href="../441332/index.html">The colony. Chapter 26: Port Demetrion</a></li>
<li><a href="../441334/index.html">"Electric State" - now definitely</a></li>
<li><a href="../441336/index.html">RTOS or not RTOS is the question</a></li>
<li><a href="../441352/index.html">Patterns and anti-patterns CI / CD. Part 2</a></li>
<li><a href="../441356/index.html">How to understand the "foreign" code and join the new team?</a></li>
<li><a href="../441358/index.html">The first commercial lunar landing apparatus Beresheet was launched.</a></li>
<li><a href="../441360/index.html">Openshift - red-hat crafts</a></li>
<li><a href="../441368/index.html">What does the invisible moon of Neptune look like?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>