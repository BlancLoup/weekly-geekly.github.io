<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>sudo rm -rf, or Chronicle of the incident with the database GitLab.com from 2017/01/31</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="He got drunk slowly, but still got drunk, somehow immediately, abruptly; and when, at the moment of enlightenment, I saw before me a hacked oak table ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>sudo rm -rf, or Chronicle of the incident with the database GitLab.com from 2017/01/31</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/df5/e39/3ff/df5e393fff1e4f05874f6705c2b88666.png"><br><blockquote>  He got drunk slowly, but still got drunk, somehow immediately, abruptly;  and when, at the moment of enlightenment, I saw before me a hacked oak table in a completely unfamiliar room, a drawn sword in my hand and shrieking the moneyless don around, I thought it was time to go home.  But it was too late. <br><br>  Arkady and Boris Strugatsky </blockquote><p>  On January 31, 2017, an important event for the world of OpenSource occurred: one of the administrators of GitLab.com, trying to repair the replication, confused the console and deleted the main base of PostgreSQL, as a result of which a large amount of user data was lost and the service itself went offline.  Moreover, all 5 different backup / replication methods were disabled.  Recovered from the LVM image, accidentally taken 6 hours before the base was removed.  It, as they say, happens.  But we must pay tribute to the project team: they found the strength to treat everything with humor, did not lose their heads and showed surprising openness by writing about everything on Twitter and putting in the shared access, in fact, an internal <a href="https://docs.google.com/document/d/1GCK53YDcBWQveod9kfzW-VCxIABGiryG7_z_6jHdVik/pub">document</a> in which the team conducted in real time description of unfolding events. </p><br><p> During his reading, you literally feel yourself in the place of poor YP, who at 11 o'clock in the evening after a hard day of work and unsuccessful struggle with Postgres, squinting tiredly, drives fatal <code>sudo rm -rf</code> into the console of the combat server and presses Enter.  After a second, he realizes that he has done, cancels the deletion, but it's too late - the base is no more ... </p><br><p>  Due to the importance and in many ways the instructiveness of this case, we decided to fully translate into Russian his journal-report made by the staff of GitLab.com in the process of working on the incident.  Result you can find under the cut. </p><a name="habracut"></a><br><p>  So let's find out in all the details how it was. </p><br><h2 id="incident-s-bazoy-dannyh-gitlabcom-ot-31012017">  Incident with the GitLab.com database dated 01/31/2017 </h2><br><p>  Note: this incident has affected the database (including issues (issues) and merge requests);  git repositories and wiki pages are not affected. </p><br><p>  <a href="http://www.youtube.com/c/Gitlab/live">Live broadcast on YouTube</a> - watch how we discuss and solve the problem! </p><br><ol><li>  <a href="https://habr.com/ru/company/southbridge/blog/321074/">Losses incurred</a> </li><li>  <a href="https://habr.com/ru/company/southbridge/blog/321074/">Timeline (time indicated in UTC)</a> </li><li>  <a href="https://habr.com/ru/company/southbridge/blog/321074/">Recovery - 2017/01/31 23:00 (backup from approximately 17:20 UTC)</a> </li><li>  <a href="https://habr.com/ru/company/southbridge/blog/321074/">Problems encountered</a> </li><li>  <a href="https://habr.com/ru/company/southbridge/blog/321074/">Help from</a> <br><ul><li>  HugOps (add here posts from twitter and from somewhere else, in which people kindly responded to what happened) </li><li>  Stephen frost </li><li>  Sam McLeod </li></ul></li></ol><br><h2 id="losses">  Losses incurred </h2><br><ol><li>  Data is lost in about 6 hours. </li><li>  4,613 normal projects were lost, 74 forks and 350 imports (roughly);  only 5037. Since Git repositories are NOT lost, we will be able to recreate those projects whose users / groups existed before data loss, but we will not be able to recover the issues of these projects. </li><li>  About 4979 (about 5000) can be lost. </li><li>  707 users are potentially lost (it is difficult to say more precisely on the Kibana logs). </li><li>  Web hooks created before January 31, 5:20 pm, restored, created after - lost. </li></ol><br><h2 id="chronology">  Timeline (time indicated in UTC) </h2><br><ol><li>  <strong>2017/01/31 16: 00/17: 00 - 21:00</strong> <br><ul><li>  YP is working on setting up pgpool and replication in staging, creating an LVM snapshot to load combat data into staging, and also in the hope that it will be able to use this data to speed up the loading of the base to other replicas.  This happens about 6 hours before data loss. </li><li>  Configuring replication is problematic and very long (an estimated ~ 20 hours only for the initial synchronization pg_basebackup).  LVM snapshot YP could not be used.  The work at this stage was interrupted (because YP needed the help of another colleague who was not working that day, and also because of the spam / high load on GitLab.com). </li></ul></li><li>  <strong>2017/01/31 21:00</strong> - <a href="http://monitor.gitlab.net/dashboard/db/postgres-stats%3Ffrom%253D1485889073596%2526to%253D1485897722398">The surge in site load due to spammers</a> - <a href="https://twitter.com/gitlabstatus/status/826544148949909506">Twitter</a> |  <a href="https://gitlab.slack.com/archives/infrastructure/p1485896980015093">Slack</a> <br><ul><li>  Block users by their IP addresses. </li><li>  Deleting a user for using the repository as a CDN, as a result of which 47,000 aypishnikov logged in under the same account (causing a high load on the database).  Information was transferred to the technical support and infrastructure teams. </li><li>  Deleting users for spam (using snippets) - <a href="https://gitlab.slack.com/archives/support/p1485900555017129">Slack</a> </li><li>  The load on the database returned to normal, a vacuum of several PostgreSQL tables was manually started to clean up the large number of empty lines left. </li></ul></li><li>  <strong>2017/01/31 22:00</strong> - <a href="http://monitor.gitlab.net/dashboard/db/postgres-stats%3Ffrom%253D1485897525856%2526to%253D1485900295390%2526panelId%253D11%2526fullscreen">Replication lag warning received</a> - <a href="https://gitlab.slack.com/archives/infrastructure/p1485899770015360">Slack</a> <br><ul><li>  Attempts to fix db2, the lag at this stage is 4 GB. </li><li>  db2.cluster refuses to replicate, the / var / opt / gitlab / postgresql / data directory is cleaned up to ensure clean replication. </li><li>  db2.cluster refuses to connect to db1, swearing at a max_wal_senders value that is too low.  This setting is used to limit the number of WAL clients (replication). </li><li>  YP increases max_wal_senders to 32 by db1, restarts PostgreSQL. </li><li>  PostgreSQL swears that too many semaphores are open and it does not start. </li><li>  YP reduces max_connections from 8000 to 2000, PostgreSQL starts (despite the fact that it worked fine from 8000 for almost a year). </li><li>  db2.cluster still refuses to replicate, but no longer complains about connections, but instead it just hangs and does nothing. </li><li>  At this time, YP begins to feel hopeless.  Earlier that day, he <a href="https://gitlab.slack.com/archives/infrastructure/p1485900765015428">said</a> that he was going to finish the work, as it was late (around 11:00 pm local time), but remained in place due to unexpected problems with replication. </li></ul></li><li>  <strong>2017/01/31 around 23:00</strong> <br><ul><li>  YP thinks that pg_basebackup may be too pedantic about the cleanliness of the data directory, and decides to delete it.  After a couple of seconds, he notices that he ran the command on <strong>db1.cluster.gitlab.com</strong> instead of <strong>db2.cluster.gitlab.com</strong> . </li><li>  2017/01/31 23:27: YP cancels the deletion, but it's too late.  Of the approximately 310 GB, only 4.5 - <a href="https://gitlab.slack.com/archives/infrastructure/p1485905230015681">Slack</a> remained. </li></ul></li></ol><br><h2 id="recovery">  Recovery - 2017/01/31 23:00 (backup from ~ 17: 20 UTC) </h2><br><ol><li>  <strong>Suggested recovery methods:</strong> <br><ol><li>  Migrate <strong>db1.staging.gitlab.com</strong> to GitLab.com (about 6 hours behind). <br><ul><li>  CW: Problem with web hooks that were deleted during synchronization. </li></ul></li><li>  Restore LVM image (lags by 6 hours). </li><li>  Sid: try to recover files? <br><ul><li>  CW: Impossible!  <strong>rm -Rvf</strong> Sid: OK. </li><li>  JEJ: It‚Äôs probably too late, but can it help if you quickly put the disk into read-only mode?  Is it also impossible to get a file descriptor if it is used by a running process (according to <a href="http://unix.stackexchange.com/a/101247/213510">http://unix.stackexchange.com/a/101247/213510</a> ). </li><li>  YP: PostgreSQL does not keep all of its files open all the time, so it will not work.  It also looks like Azure deletes the data very quickly, but sending it to other replicas is not so fast.  In other words, the data from the disk itself cannot be recovered. </li><li>  SH: It seems that on a db1 staging server, a separate PostgreSQL process pours a stream of production data from db2 into the gitlab_replicator directory.  According to the lag of replication, db2 was redeemed in 2016-01-31 05:53, which led to the gitlab_replicator being stopped.  The good news is that the data up to this point looks intact, so we may be able to restore the web hooks. </li></ul></li></ol></li><li>  <strong>Actions taken:</strong> <br><ol><li>  2017/02/01 23:00 - 00:00: It was decided to restore data from db1.staging.gitlab.com to db1.cluster.gitlab.com (production).  Although they are 6 hours behind and do not contain web hooks, this is the only available snapshot.  YP says that today it is better for him not to run any commands starting with <em>sudo</em> anymore, and passes control to JN. </li><li>  2017/02/01 00:36 - JN: I am backing up data db1.staging.gitlab.com. </li><li>  2017/02/01 00:55 - JN: I mount db1.staging.gitlab.com to db1.cluster.gitlab.com. <br><ul><li>  I copy data from <strong>staging</strong> / var / opt / gitlab / postgresql / data / to <strong>production</strong> / var / opt / gitlab / postgresql / data /. </li></ul></li><li>  2017/02/01 01:05 - JN: nfs-share01 server is allocated as temporary storage in / var / opt / gitlab / db-meltdown. </li><li>  2017/02/01 01:18 - JN: I copy the remaining production data, including the packed pg_xlog: '20170131-db-meltodwn-backup.tar.gz'. </li><li>  2017/02/01 01:58 - JN: I start syncing from stage to production. </li><li>  2017/02/01 02:00 - CW: To explain the situation, the deployment page has been updated (deploy page).  <a href="https://drive.google.com/file/d/0B_4wYK1qcPT1TlJGRXR0Z0poWWc/view">Link</a> . </li><li>  2017/02/01 03:00 - AR: rsync ran by about 50% (by the number of files). </li><li>  017/02/01 04:00 - JN: rsync ran by about 56.4% (in the number of files).  Data transfer is slow for the following reasons: the network bandwidth between us-east and us-east-2, as well as the limitation of disk performance on the staging server (60 Mb / s). </li><li>  2017/02/01 07:00 - JN: Found a copy of the intact data on db1 staging in / var / opt / gitlab_replicator / postgresql.  I started the db-crutch VM virtual machine on us-east to backup this data to another machine.  Unfortunately, it is limited to 120 GB of RAM and does not pull the workload.  This copy will be used to check the status of the database and upload the data of the web hooks. </li><li>  2017/02/01 08:07 - JN: Data transfer is slow: 42% of data transferred. </li><li>  2017/02/02 16:28 - JN: The data transfer is over. </li><li>  2017/02/02 16:45 - Below is the recovery procedure. </li></ol></li><li>  <strong>Recovery procedure</strong> <br><ol><li>  [x] - Take a snapshot of the DB1 server - or 2 or 3 - taken at 16:36 UTC. </li><li>  [x] - Update db1.cluster.gitlab.com to PostgreSQL 9.6.1, it is still 9.6.0, and staging uses 9.6.1 (otherwise PostgreSQL may not start). <br><ul><li>  Install 8.16.3-EE.1. </li><li>  Move chef-noop to chef-client (it was manually disabled). </li><li>  Run the chef-client on the host (done at 16:45). </li></ul></li><li>  [x] - Run DB - 16:53 UTC <br><ul><li>  Monitor the launch and make sure everything went fine. </li><li>  Make a backup. </li></ul></li><li>  [x] - Update Sentry DSN so that errors do not get into staging. </li><li>  [x] - Increase identifiers in all tables by 10k to avoid problems when creating new projects / comments.  Done using <a href="https://gist.github.com/anonymous/23e3c0d41e2beac018c4099d45ec88f5">https://gist.github.com/anonymous/23e3c0d41e2beac018c4099d45ec88f5</a> , which reads a text file containing all the sequences (one per line). </li><li>  [x] - Clear the Rails / Redis cache. </li><li>  [x] - Try to recover web-hooks if possible. <br><ul><li>  [x] Run staging using a snapshot taken before removing the web hooks. </li><li>  [x] Make sure the web hooks are in place. </li><li>  [x] Create a SQL dump (data only) of the ‚Äúweb_hooks‚Äù table (if there is data there). </li><li>  [x] Copy SQL-dump to production-server. </li><li>  [x] Import SQL dump into the working database. </li></ul></li><li>  [x] - Check through Rails Console whether workers can connect (workers). </li><li>  [x] - Run workflows gradually. </li><li>  [x] - Disable the deployment page. </li><li>  [x] - Tweet with @gitlabstatus. </li><li>  [x] - Create crash related tasks describing future plans / actions <div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><ul><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1094">https://gitlab.com/gitlab-com/infrastructure/issues/1094</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1095">https://gitlab.com/gitlab-com/infrastructure/issues/1095</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1096">https://gitlab.com/gitlab-com/infrastructure/issues/1096</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1097">https://gitlab.com/gitlab-com/infrastructure/issues/1097</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1098">https://gitlab.com/gitlab-com/infrastructure/issues/1098</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1099">https://gitlab.com/gitlab-com/infrastructure/issues/1099</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1100">https://gitlab.com/gitlab-com/infrastructure/issues/1100</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1101">https://gitlab.com/gitlab-com/infrastructure/issues/1101</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1102">https://gitlab.com/gitlab-com/infrastructure/issues/1102</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1103">https://gitlab.com/gitlab-com/infrastructure/issues/1103</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1104">https://gitlab.com/gitlab-com/infrastructure/issues/1104</a> </li><li>  <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1105">https://gitlab.com/gitlab-com/infrastructure/issues/1105</a> <br><br></li></ul><br>  [] - Create new Project Git repository entries that do not have Project entries in cases where the namespace matches an existing user / group. <br><ul><li>  PC - <del>  I create a list of these repositories so that we can check in the database whether they exist </del>  . </li></ul><br>  [] - Delete repositories with unknown (lost) namespaces. <br><ul><li>  AR - working on a script based on data from the previous point. </li></ul><br>  [x] - Delete spam users again (so that they do not create problems again). <br><ul><li>  [x] CDN user with 47,000 IP addresses. </li></ul><br></div></div></li><li>  <strong>To do after data recovery:</strong> <br><ol><li>  Create a change task in the PS1-format / color terminals so that it is immediately clear which medium is used: production or staging (production ‚Äî red, staging ‚Äî yellow).  For all users, the default bash prompt is to show the full hostname (for example, ‚Äúdb1.staging.gitlab.com‚Äù instead of ‚Äúdb1‚Äù): <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1094">https://gitlab.com/gitlab-com/infrastructure/issues/1094</a> </li><li>  How can I disable <em>rm -rf</em> for a PostgreSQL data directory?  Not sure if this is doable or necessary (in case there are normal backups). </li><li>  Add alerts for backups: check S3 storage, etc. Add a graph showing changes in backups size, issue a warning when the size is reduced by more than 10%: <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1095">https://gitlab.com/gitlab-com/infrastructure/issues/1095</a> . </li><li><del>  Consider adding the time of the last successful backup to the database so that admins can easily see this information. </del>  (suggested by the client at <a href="https://gitlab.zendesk.com/agent/tickets/58274">https://gitlab.zendesk.com/agent/tickets/58274</a> ). </li><li>  To figure out why PostgreSQL suddenly had problems with max_connections set to 8000, despite the fact that it worked from 2016-05-13.  The unexpected appearance of this problem is largely responsible for the despair and hopelessness that has come down: <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1096">https://gitlab.com/gitlab-com/infrastructure/issues/1096</a> . </li><li>  A look at the increase in replication thresholds via WAL / PITR archiving will also be useful after unsuccessful updates: <a href="https://gitlab.com/gitlab-com/infrastructure/issues/1097">https://gitlab.com/gitlab-com/infrastructure/issues/1097</a> . </li><li>  Create a user guide for solving problems that may arise after starting the service. </li><li>  Experiment with moving data from one data center to another using AzCopy: Microsoft says this should work faster than rsync: <br><ul><li>  It seems that this is a Windows-specific thing, and we do not have experts on Windows (or someone at least remotely, but sufficiently familiar with the question in order to correctly test it). </li></ul></li></ol></li></ol><br><h2 id="problems">  Problems encountered </h2><br><ol><li>  LVM images by default are taken only once every 24 hours.  By luck, YP made one manually 6 hours before the crash. </li><li>  Regular backups also seem to have been done only once a day, although YP has not yet figured out where they are stored.  According to JN, they do not work: files of several bytes are created. <br><ul><li>  SH: It looks like pg_dump does not work properly, because the binaries from PostgreSQL 9.2 are running instead of 9.6.  This is due to the fact that omnibus uses only Pg 9.6 if data / PG_VERSION is set to 9.6, but this file is not on the work nodes.  As a result, 9.2 runs by default and silently finishes without doing anything.  As a result, SQL dumps are not generated.  Fog-hem may have cleaned out old backups. </li></ul></li><li>  Disk snapshots in Azure are included for the NFS server, for database servers it is not. </li><li>  The synchronization process deletes the web hooks after it has synchronized the data on the staging.  If we can‚Äôt get them out of a regular backup made within 24 hours, they will be lost. </li><li>  The replication procedure turned out to be very fragile, prone to errors, dependent on random shell scripts and poorly documented. <br><ul><li>  SH: We later found out that staging database updating works by creating a snapshot of the gitlab_replicator directory, deleting the replication configuration, and running a separate PostgreSQL server. </li></ul></li><li>  Our S3 backups also do not work: the folder is empty. </li><li>  We do not have a reliable alert system about unsuccessful attempts to create backups, we now see the same problems on a dev-host. </li></ol><br><p>  In other words, none of the 5 used backup / replication methods works.  =&gt; now we are restoring a working backup made 6 hours ago. </p><br><img src="https://habrastorage.org/files/116/9aa/1dd/1169aa1ddf5c4dd3a15fd6c7647a56d6.png"><br><p>  <a href="http://monitor.gitlab.net/dashboard/db/postgres-stats%3FpanelId%3D10%26fullscreen%26from%3Dnow-24h%26to%3Dnow">http://monitor.gitlab.net/dashboard/db/postgres-stats?panelId=10&amp;fullscreen&amp;from=now-24h&amp;to=now</a> </p><br><h2 id="help">  Help from </h2><br><div class="spoiler">  <b class="spoiler_title">Hugops (add here posts from twitter or from somewhere else, in which people kindly responded to what happened)</b> <div class="spoiler_text"><ul><li>  A Twitter Moment for all the kind tweets: <a href="https://twitter.com/i/moments/826818668948549632">https://twitter.com/i/moments/826818668948549632</a> </li><li>  Jan Lehnardt <a href="https://twitter.com/janl/status/826717066984116229">https://twitter.com/janl/status/826717066984116229</a> </li><li>  Buddy CI <a href="https://twitter.com/BuddyGit/status/826704250499633152">https://twitter.com/BuddyGit/status/826704250499633152</a> </li><li>  Kent <a href="https://twitter.com/kentchenery/status/826594322870996992">https://twitter.com/kentchenery/status/826594322870996992</a> </li><li>  Lead off <a href="https://twitter.com/LeadOffTeam/status/826599794659450881">https://twitter.com/LeadOffTeam/status/826599794659450881</a> </li><li>  Mozair <a href="https://news.ycombinator.com/item%3Fid%3D13539779">https://news.ycombinator.com/item?id=13539779</a> </li><li>  Applicant <a href="https://news.ycombinator.com/item%3Fid%3D13539729">https://news.ycombinator.com/item?id=13539729</a> </li><li>  Scott Hanselman <a href="https://twitter.com/shanselman/status/826753118868275200">https://twitter.com/shanselman/status/826753118868275200</a> </li><li>  Dave Long <a href="https://twitter.com/davejlong/status/826817435470815233">https://twitter.com/davejlong/status/826817435470815233</a> </li><li>  Simon Slater <a href="https://twitter.com/skslater/status/826812158184980482">https://twitter.com/skslater/status/826812158184980482</a> </li><li>  Zaim M Ramlan <a href="https://twitter.com/zaimramlan/status/826803347764043777">https://twitter.com/zaimramlan/status/826803347764043777</a> </li><li>  Aaron Suggs <a href="https://twitter.com/ktheory/status/826802484467396610">https://twitter.com/ktheory/status/826802484467396610</a> </li><li>  danedevalcourt <a href="https://twitter.com/danedevalcourt/status/826791663943241728">https://twitter.com/danedevalcourt/status/826791663943241728</a> </li><li>  Karl <a href="https://twitter.com/irutsun/status/826786850186608640">https://twitter.com/irutsun/status/826786850186608640</a> </li><li>  Zac Clay <a href="https://twitter.com/mebezac/status/826781796318707712">https://twitter.com/mebezac/status/826781796318707712</a> </li><li>  Tim Roberts <a href="https://twitter.com/cirsca/status/826781142581927936">https://twitter.com/cirsca/status/826781142581927936</a> </li><li>  Frans Bouma <a href="https://twitter.com/FransBouma/status/826766417332727809">https://twitter.com/FransBouma/status/826766417332727809</a> </li><li>  Roshan Chhetri <a href="https://twitter.com/sai_roshan/status/826764344637616128">https://twitter.com/sai_roshan/status/826764344637616128</a> </li><li>  Samuel Boswell <a href="https://twitter.com/sboswell/status/826760159758262273">https://twitter.com/sboswell/status/826760159758262273</a> </li><li>  Matt Brunt <a href="https://twitter.com/Brunty/status/826755797933756416">https://twitter.com/Brunty/status/826755797933756416</a> </li><li>  Isham Mohamed <a href="https://twitter.com/Isham_M_Iqbal/status/826755614013485056">https://twitter.com/Isham_M_Iqbal/status/826755614013485056</a> </li><li>  Adri√• Galin <a href="https://twitter.com/adriagalin/status/826754540955377665">https://twitter.com/adriagalin/status/826754540955377665</a> </li><li>  Jonathan Burke <a href="https://twitter.com/imprecision/status/826749556566134784">https://twitter.com/imprecision/status/826749556566134784</a> </li><li>  Christo <a href="https://twitter.com/xho/status/826748578240544768">https://twitter.com/xho/status/826748578240544768</a> </li><li>  Linux Australia <a href="https://twitter.com/linuxaustralia/status/826741475731976192">https://twitter.com/linuxaustralia/status/826741475731976192</a> </li><li>  Emma Jane <a href="https://twitter.com/emmajanehw/status/826737286725455872">https://twitter.com/emmajanehw/status/826737286725455872</a> </li><li>  Rafael Dohms <a href="https://twitter.com/rdohms/status/826719718539194368">https://twitter.com/rdohms/status/826719718539194368</a> </li><li>  Mike San Rom√•n <a href="https://twitter.com/msanromanv/status/826710492169269248">https://twitter.com/msanromanv/status/826710492169269248</a> </li><li>  Jono Walker <a href="https://twitter.com/WalkerJono/status/826705353265983488">https://twitter.com/WalkerJono/status/826705353265983488</a> </li><li>  Tom Penrose <a href="https://twitter.com/TomPenrose/status/826704616402333697">https://twitter.com/TomPenrose/status/826704616402333697</a> </li><li>  Jon Wincus <a href="https://twitter.com/jonwincus/status/826683164676521985">https://twitter.com/jonwincus/status/826683164676521985</a> </li><li>  Bill Weiss <a href="https://twitter.com/BillWeiss/status/826673719460274176">https://twitter.com/BillWeiss/status/826673719460274176</a> </li><li>  Alberto Grespan <a href="https://twitter.com/albertogg/status/826662465400340481">https://twitter.com/albertogg/status/826662465400340481</a> </li><li>  Wicket <a href="https://twitter.com/matthewtrask/status/826650119042957312">https://twitter.com/matthewtrask/status/826650119042957312</a> </li><li>  Jesse Dearing <a href="https://twitter.com/JesseDearing/status/826647439587188736">https://twitter.com/JesseDearing/status/826647439587188736</a> </li><li>  Franco Gilio <a href="https://twitter.com/fgili0/status/826642668994326528">https://twitter.com/fgili0/status/826642668994326528</a> </li><li>  Adam DeConinck <a href="https://twitter.com/ajdecon/status/826633522735505408">https://twitter.com/ajdecon/status/826633522735505408</a> </li><li>  Luciano Facchinelli <a href="https://twitter.com/sys0wned/status/826628970150035456">https://twitter.com/sys0wned/status/826628970150035456</a> </li><li>  Miguel Di Ciurcio F. <a href="https://twitter.com/mciurcio/status/826628765820321792">https://twitter.com/mciurcio/status/826628765820321792</a> </li><li>  ceej <a href="https://twitter.com/ceejbot/status/826617667884769280">https://twitter.com/ceejbot/status/826617667884769280</a> </li></ul></div></div><br><h3 id="stephen-frost">  Stephen frost </h3><br><ul><li>  <a href="https://twitter.com/net_snow/status/826622954964393984">https://twitter.com/net_snow/status/826622954964393984</a> @gitlabstatus Hi, I'm a PG developer, and I like what you do.  Let me know if I can help with anything, I would be glad to be helpful. </li></ul><br><h3 id="sam-mcleod">  Sam McLeod </h3><br><ul><li>  Hi Sid, I am very sorry that you have problems with the database / LVM, this is pretty darn unpleasant.  We have several PostgreSQL clusters (master / slave), and I noticed a few things in your report: <br><ol><li>  You use Slony, and this is the piece you yourself know what, and this is not an exaggeration at all, here even show it at <a href="http://howfuckedismydatabase.com/">http://howfuckedismydatabase.com</a> , with the built-in PostgreSQL binary, which is responsible for streaming replication, very reliable and fast, I suggest switch to it. </li><li>  The use of connection pools is not mentioned, but it is said about thousands of connections in postgresql.conf - this is very bad and inefficient in terms of performance, I suggest using <a href="https://pgbouncer.github.io/">pg_bouncer</a> and not setting max_connection in PostgreSQL above 512-1024;  in practice, if you have more than 256 active connections, you need to scale horizontally, not vertically. </li><li>  The report says how unreliable your failover and backup processes are, we wrote and documented a simple script for postgresql failover - if you want, I will send it to you.  As for backups, for incremental backups during the day we use pgbarman, and we also do full backups twice a day with barman and pg_dump, it is important in terms of performance and reliability to store your backups and directory with postgresql data on different disks. </li><li>  Are you still in Azure?!?!  I would suggest to move out of there as quickly as possible, since there are a lot of strange problems with internal DNS, NTP, routing and storage, I also heard some frightening stories about how everything is arranged inside. </li></ol></li></ul><br><div class="spoiler">  <b class="spoiler_title">Sid and Sam's long correspondence with a focus on PostgreSQL setup</b> <div class="spoiler_text"><ul><li>  Tell me if you need help setting up PostgreSQL, I have a decent experience on this issue. </li><li>  Capt.  McLeod: another question: how much disk space does your database (s) occupy?  Is it about terabytes or is it still gigabytes? </li><li>  Capt.  McLeod: Laid Your Failover / Replication Script: </li><li>  I also see that you are looking at pgpool - I would suggest pgbouncer instead </li><li>  Capt.  McLeod: pgpool has plenty of problems, we tested it well and threw it out. </li><li>  Capt.  McLeod: Also let me know if I can say something publicly via Twitter or something else in support of GitLab and your transparency in working on this issue, I know how hard it is;  when I started, we had a split-brain at the SAN level in infoxchange, and I literally vomited - I was so nervous! </li><li>  Sid Sijbrandij: Hi Sam, thanks for the help.  Do you mind if I copy this into a public document so that the rest of the team can? </li><li>  Capt.  McLeod: Failover Script? </li><li>  Sid Sijbrandij: Everything you wrote. </li><li>  Of course, in any case, this is a public repository, but it is not perfect, very far from it, but it does its job well, I constantly confuse hosts without any consequences, but everything could be different with you. </li><li>  Yes, of course, you can send me my recommendations. </li><li><p>         VM,    PostgreSQL   PostgreSQL.conf,      . </p><br></li><li><p> Sid:   Slony     9.2  9.6,        . <br> <strong>:</strong> ,  ,  :     PostgreSQL       . </p><br></li><li> Rails     (25  ).  20   20   - 10 000 ,     400  ( Unicorn ‚Äî   ). <br> <strong>:</strong>  PostgreSQL-  ,      ;    pg_bouncer ‚Äî         .     ,    ,   pgpool  .    ,       ,  . Pgpool       ORM/db-. </li></ul><br><p> <strong> :</strong> <a href="https://wiki.postgresql.org/wiki/Number_Of_Database_Connections">https://wiki.postgresql.org/wiki/Number_Of_Database_Connections</a> </p><br><ul><li>   ,   ,     . .    pgpool +      (  ). Pgbouncer,   ,    (  ,  ).   <a href="https://github.com/awslabs/pgbouncer-rr-patch">https://github.com/awslabs/pgbouncer-rr-patch</a>       . </li></ul><br><p> <strong>:</strong>        active/active PostgreSQL-,   ,     ? </p><br><p> <strong>:</strong>     ?       ? </p><br><p> * <em>  ,     ,   GitLab.com                 .        ,      .</em> </p></div></div><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  ,   GitLab         , ,    ,      .    ,     Twitter     Google Docs,        , , ,  . </p><br><p>  ,      :       "Database (removal) specialist" (  []  ), -   1      <a href="http://checkyourbackups.work/">http://checkyourbackups.work/</a> ,       : </p><br><p><img src="https://habrastorage.org/files/012/a57/000/012a5700032745e1a1c4c9e1fb1392a5.jpg"><br>  <a href="https://habrahabr.ru/post/320988/">A source</a> </p><br><p>    ? </p><br><ol><li>   . </li><li>          (  ,  Azure). </li><li> LVM ‚Äî      ,          ,  GitLab.com,     . </li><li>   dev/stage/prod-  . </li><li>   dev/stage/prod-      /. </li><li>         ‚Äî   ,   . </li><li> ,         . </li></ol><br><p>  Related Links: </p><br><ul><li>  : GitLab.com Database Incident ‚Äî 2017/01/31: <a href="https://docs.google.com/document/d/1GCK53YDcBWQveod9kfzW-VCxIABGiryG7_z_6jHdVik/pub">https://docs.google.com/document/d/1GCK53YDcBWQveod9kfzW-VCxIABGiryG7_z_6jHdVik/pub</a> </li><li>    GitLab.com: <a href="https://about.gitlab.com/2017/02/01/gitlab-dot-com-database-incident/">https://about.gitlab.com/2017/02/01/gitlab-dot-com-database-incident/</a> </li><li>    : <a href="https://habrahabr.ru/post/320988/">https://habrahabr.ru/post/320988/</a> </li></ul></li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321074/">https://habr.com/ru/post/321074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321064/index.html">We pump over NES Classic Mini</a></li>
<li><a href="../321066/index.html">Complex neural network based on the Fourier series of a function of many variables</a></li>
<li><a href="../321068/index.html">Roskomnadzor for the Bitcoin ban in Russia</a></li>
<li><a href="../321070/index.html">Perspectives of HR robots / bots in the field of staff recruitment - current realities, opinions and experience of experts</a></li>
<li><a href="../321072/index.html">85% of employees scores on project management systems. How do we do our</a></li>
<li><a href="../321076/index.html">Powershell and Cyrillic in console applications (updated)</a></li>
<li><a href="../321078/index.html">Friday JS: How to be inspired by Smalltalk and go to hell</a></li>
<li><a href="../321082/index.html">Friday format: Is there life after the meeting?</a></li>
<li><a href="../321086/index.html">Physics of trains in Assassin's Creed Syndicate</a></li>
<li><a href="../321088/index.html">Network Controller: software-defined networks in Windows Server 2016. Part 1: features and services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>