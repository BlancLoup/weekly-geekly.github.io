<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a clone game Super Mario Brothers (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Welcome to the second part of the tutorial series on how to write your own platformer like Super Mario Brothers! 
 In the first part, we wrote a simpl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a clone game Super Mario Brothers (part 2)</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="http://kartinok.net/images/2012/12/21/hFHDP.png" alt="image">  Welcome to the second part of the tutorial series on how to write your own platformer like Super Mario Brothers! <br>  In the <a href="http://habrahabr.ru/post/162747/">first part,</a> we wrote a simple physics engine based on Tiled Map. <br>  In the second (and last) part, we will teach Koalio to move and jump - the most fun part of any platformer! <br><br>  We will learn to track collisions with dangers at the level, to handle victory and defeat;  Add great sound effects and music! <br><br>  The second part is an order of magnitude easier (and shorter) than the first - a little rest after hard work last time!  So turn on your kodo kung fu and enjoy! <br><a name="habracut"></a><br><h4>  Move Koalio </h4><br>  Our movements will be very simple: only running forward and jumping - just like in 1-bit Ninja.  If the player touches the left side of the screen, Koalio runs forward.  If the player touches the right side of the screen, Koalio jumps. <br>  You all understood correctly: Koalio can not move back!  Real Koalas do not back away from danger! <br>  Since Koalio will move forward, we need a variable that can be used in the Player class to update Koala's position.  Add the following to the Player class: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In <b>Player.h</b> : <br><br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> forwardMarch; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> mightAsWellJump;</code> </pre> <br>  And we synthesize everything in <b>Player.m</b> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@synthesize</span></span> forwardMarch = _forwardMarch, mightAsWellJump = _mightAsWellJump;</code> </pre><br>  Now add the following touch handling methods to the <b>GameLevelLayer</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ccTouchesBegan:(<span class="hljs-built_in"><span class="hljs-built_in">NSSet</span></span> *)touches withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITouch</span></span> *t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> touches) { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> touchLocation = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> convertTouchToNodeSpace:t]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touchLocation.x &gt; <span class="hljs-number"><span class="hljs-number">240</span></span>) { player.mightAsWellJump = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { player.forwardMarch = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ccTouchesMoved:(<span class="hljs-built_in"><span class="hljs-built_in">NSSet</span></span> *)touches withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITouch</span></span> *t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> touches) { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> touchLocation = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> convertTouchToNodeSpace:t]; <span class="hljs-comment"><span class="hljs-comment">//   CGPoint previousTouchLocation = [t previousLocationInView:[t view]]; CGSize screenSize = [[CCDirector sharedDirector] winSize]; previousTouchLocation = ccp(previousTouchLocation.x, screenSize.height - previousTouchLocation.y); if (touchLocation.x &gt; 240 &amp;&amp; previousTouchLocation.x &lt;= 240) { player.forwardMarch = NO; player.mightAsWellJump = YES; } else if (previousTouchLocation.x &gt; 240 &amp;&amp; touchLocation.x &lt;=240) { player.forwardMarch = YES; player.mightAsWellJump = NO; } } } - (void)ccTouchesEnded:(NSSet *)touches withEvent:(UIEvent *)event { for (UITouch *t in touches) { CGPoint touchLocation = [self convertTouchToNodeSpace:t]; if (touchLocation.x &lt; 240) { player.forwardMarch = NO; } else { player.mightAsWellJump = NO; } } }</span></span></code> </pre></div></div><br>  The code above is quite simple to understand.  If the X-coordinate of the touch screen is less than 240 (half of the screen), then we assign the variable forwardMarch to the value YES.  Otherwise (if the X-coordinate is greater than 240), assign the YES value to the variable mightAsWellJump. <br>  touchesMoved is a slightly more complicated method.  We need to change the value of variables only when the touch crosses the middle of the screen.  So we must also take into account the previous touch - the previousTouch variable.  In other words, we simply check from which side the intersection occurred and change the values ‚Äã‚Äãof the Boolean variables, respectively. <br>  We want, when the player ceases to touch a certain area of ‚Äã‚Äãthe screen, only the necessary Boolean variables are turned off. <br>  However, it is worth changing a few more things to properly handle the touches.  Add the following line to the <b>init</b> method: <br><br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isTouchEnabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>;</code> </pre><br>  We need to enable multitouch in <b>AppDelegate.m</b> (suddenly, our player wants to jump and move forward at the same time).  Add the following before the line <b>[director_ pushScene: [GameLevelLayer scene]];</b>  : <br><br><pre> <code class="objectivec hljs"> [glView setMultipleTouchEnabled:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>];</code> </pre><br>  Now that we have the value of the variables in the object of the Player class, we can add some code to the <b>update</b> method so Koalio can move.  Let's start with moving forward.  Change the <b>update</b> method in <b>Player.m</b> to the following: <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)update:(ccTime)dt { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> gravity = ccp(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">-450.0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> gravityStep = ccpMult(gravity, dt); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> forwardMove = ccp(<span class="hljs-number"><span class="hljs-number">800.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> forwardStep = ccpMult(forwardMove, dt); <span class="hljs-comment"><span class="hljs-comment">//1 self.velocity = ccpAdd(self.velocity, gravityStep); self.velocity = ccp(self.velocity.x * 0.90, self.velocity.y); //2 if (self.forwardMarch) { self.velocity = ccpAdd(self.velocity, forwardStep); } //3 CGPoint minMovement = ccp(0.0, -450.0); CGPoint maxMovement = ccp(120.0, 250.0); self.velocity = ccpClamp(self.velocity, minMovement, maxMovement); //4 CGPoint stepVelocity = ccpMult(self.velocity, dt); self.desiredPosition = ccpAdd(self.position, stepVelocity); }</span></span></code> </pre></div></div><br>  Let's take this code step by step: <br><br><ol><li>  We add a forwardMove force that applies when the player touches the screen.  Let me remind you that we change this force (800 points per second) depending on the frame rate per second in order to get a constant acceleration. </li><li>  Here we add friction.  We use physics as we did with gravity.  Forces will be applied every frame.  When the power runs out, we want the player to stop.  We apply friction force of 0.90.  In other words, we reduce the power of movement by 10% each frame. </li><li>  In the third section, we check if the player is touching the screen and add, if necessary, the force of forwardStep. </li><li>  In section four, we set limits.  We limit the maximum speed of the player.  Both horizontal (running speed) and vertical (jump speed, gravity speed). <br>  The force of friction and limitations allow us to control the speed of the processes in the game.  Having these constraints prevents a problem with too high a speed from the first tutorial. <br>  We want the player to reach maximum speed in a second or less.  So, Koal's movements will still look natural and, at the same time, resist control.  We will set the limit to 120 (a quarter of the screen width per second) for maximum speed. <br>  If we want to increase the acceleration bar of our player, we must increase both values ‚Äã‚Äãrespectively: forwardMove and friction force (0.90).  If we want to increase the maximum speed of the player, we just need to increase the value of 120. We also limit the jump speed to 250 and the fall speed to 450. </li></ol><br>  Run the project.  Koalio should start moving if you tap the left side of the screen.  See how our Koala moves briskly! <br><br><img src="http://kartinok.net/images/2012/12/21/T7j5E.png" alt="image"><br><br>  Next we will make Koala jump! <br><br><h4>  Our poppy will make her ... Jump, jump! </h4><br>  Jumping is an integral part of any platformer that brings quite a lot of fun.  We must make sure that the jump is smooth and well calibrated.  In this tutorial we use the Sonic the Hedgehog jump algorithm described <a href="http://info.sonicretro.org/Sonic_Physics_Guide">here</a> . <br>  Add the following to the <b>update</b> method before the line <b>if (self.forwardMarch) {</b> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> jumpForce = ccp(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">310.0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mightAsWellJump &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.onGround) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity = ccpAdd(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity, jumpForce); }</code> </pre><br>  If we stop right now and run the project, we will get classic Atari style jumps.  All jumps will be the same height.  We apply force to Koala and wait until gravity overcomes it. <br>  In modern platformers, users have much more control over jumps.  We want controlled, totally unrealistic (but damn fun) jumping in the style of Mario Bros or Sonic. <br>  There are several ways to achieve our goal, but we take Sonic as a basis for jumping.  When the player ceases to touch the screen, the force of the jump begins to decrease.  Replace the code above with the following: <br><br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> jumpForce = ccp(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">310.0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> jumpCutoff = <span class="hljs-number"><span class="hljs-number">150.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mightAsWellJump &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.onGround) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity = ccpAdd(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity, jumpForce); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mightAsWellJump &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity.y &gt; jumpCutoff) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity = ccp(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity.x, jumpCutoff); }</code> </pre><br>  This code performs another additional step.  When the player stops touching the screen (the self.mightAsWellJump value becomes NO), the game checks the Koalio's upward velocity.  If this value is greater than our threshold, then the game sets the variable speed threshold value. <br>  Thus, when you instantly touch the screen, the Koala will not jump higher than jumpCutoff, but by long pressing the screen, the Koala will jump higher and higher. <br>  Run the project.  The game starts to sound like something worthwhile!  Now, you most likely need to test the application on a real device (if you have not already done so) to test the operation of both ‚Äúbuttons‚Äù. <br><br><img src="http://kartinok.net/images/2012/12/21/eBbzX.png" alt="image"><br><br>  We made Koalio run and jump, but he rather quickly runs off the edges of the screen.  It's time to fix it! <br>  Add the following snippet from the <a href="http://www.raywenderlich.com/1163/how-to-make-a-tile-based-game-with-cocos2d">tutorial on cell maps</a> in <b>GameLevelLayer.m</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setViewpointCenter:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>) position { <span class="hljs-built_in"><span class="hljs-built_in">CGSize</span></span> winSize = [[CCDirector sharedDirector] winSize]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = MAX(position.x, winSize.width / <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = MAX(position.y, winSize.height / <span class="hljs-number"><span class="hljs-number">2</span></span>); x = MIN(x, (map.mapSize.width * map.tileSize.width) - winSize.width / <span class="hljs-number"><span class="hljs-number">2</span></span>); y = MIN(y, (map.mapSize.height * map.tileSize.height) - winSize.height/<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> actualPosition = ccp(x, y); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> centerOfView = ccp(winSize.width/<span class="hljs-number"><span class="hljs-number">2</span></span>, winSize.height/<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> viewPoint = ccpSub(centerOfView, actualPosition); map.position = viewPoint; }</code> </pre></div></div><br>  This code assigns the screen to the player‚Äôs position.  In case Koalio reaches the end of the level, the screen ceases to be centered on the Koala and fixes the edge of the level beyond the edge of the screen. <br>  It is worth noting that in the last line we move the card, not the player.  This is possible because the player is a descendant of the card.  So, when the player moves to the right, the card moves to the left and the player remains in the center of the screen. <br>  For a more detailed explanation, visit <a href="http://www.raywenderlich.com/1163/how-to-make-a-tile-based-game-with-cocos2d">this tutorial</a> . <br>  We need to add the following call to the <b>update</b> method: <br><br><pre> <code class="objectivec hljs"> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setViewpointCenter:player.position];</code> </pre><br>  Run the project.  Koalio can run through the entire level! <br><br><img src="http://kartinok.net/images/2012/12/21/kPqzx.png" alt="image"><br><br><h4>  The agony of defeat </h4><br>  There are two outcomes of the game: either victory or defeat. <br>  First, let's deal with the scenario of defeat.  At our level there are hazards.  If a player faces danger, the game ends. <br>  Since the dangers are fixed cells, we will work with them as with obstacles from the past tutorial.  However, instead of defining collisions, we will simply end the game.  We are on the road to success - just a little bit left! <br>  Add the following method to <b>GameLevelLayer.m</b> : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)handleHazardCollisions:(Player *)p { <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *tiles = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> getSurroundingTilesAtPosition:p.position forLayer:hazards ]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *dic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tiles) { <span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span> tileRect = <span class="hljs-built_in"><span class="hljs-built_in">CGRectMake</span></span>([[dic objectForKey:<span class="hljs-string"><span class="hljs-string">@"x"</span></span>] floatValue], [[dic objectForKey:<span class="hljs-string"><span class="hljs-string">@"y"</span></span>] floatValue], map.tileSize.width, map.tileSize.height); <span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span> pRect = [p collisionBoundingBox]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[dic objectForKey:<span class="hljs-string"><span class="hljs-string">@"gid"</span></span>] intValue] &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">CGRectIntersectsRect</span></span>(pRect, tileRect)) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> gameOver:<span class="hljs-number"><span class="hljs-number">0</span></span>]; } } }</code> </pre><br>  All the code above should be familiar to you, as it is simply copied from the checkAndResolveCollisions method.  The only innovation is the gameOver method.  We send him 0 if the player lost, and 1 if he won. <br>  We use the hazards layer instead of the walls layer, so we need to declare the variable <b>CCTMXLayer * hazards;</b>  in <code>@ interface</code> at the beginning of the executive file.  Add this to the <b>init</b> method (immediately after declaring a variable for the walls layer): <br><br><pre> <code class="objectivec hljs"> hazards = [map layerNamed:<span class="hljs-string"><span class="hljs-string">@"hazards"</span></span>];</code> </pre><br>  The only thing left to do is add the following code to the <b>update</b> method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)update:(ccTime)dt { [player update:dt]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> handleHazardCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> checkForAndResolveCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setViewpointCenter:player.position]; }</code> </pre><br>  Now, if a player flies into any dangerous cell with a layer of hazards, we will call gameOver.  This method will simply display the ‚ÄúRestart‚Äù button with a message that you lost (or won - this also happens): <br><br><div class="spoiler">  <b class="spoiler_title">Click me</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)gameOver:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)won { gameOver = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *gameText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (won) { gameText = <span class="hljs-string"><span class="hljs-string">@"You Won!"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { gameText = <span class="hljs-string"><span class="hljs-string">@"You have Died!"</span></span>; } CCLabelTTF *diedLabel = [[CCLabelTTF alloc] initWithString:gameText fontName:<span class="hljs-string"><span class="hljs-string">@"Marker Felt"</span></span> fontSize:<span class="hljs-number"><span class="hljs-number">40</span></span>]; diedLabel.position = ccp(<span class="hljs-number"><span class="hljs-number">240</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); CCMoveBy *slideIn = [[CCMoveBy alloc] initWithDuration:<span class="hljs-number"><span class="hljs-number">1.0</span></span> position:ccp(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>)]; CCMenuItemImage *replay = [[CCMenuItemImage alloc] initWithNormalImage:<span class="hljs-string"><span class="hljs-string">@"replay.png"</span></span> selectedImage:<span class="hljs-string"><span class="hljs-string">@"replay.png"</span></span> disabledImage:<span class="hljs-string"><span class="hljs-string">@"replay.png"</span></span> block:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> sender) { [[CCDirector sharedDirector] replaceScene:[GameLevelLayer scene]]; }]; <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *menuItems = [<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> arrayWithObject:replay]; CCMenu *menu = [[CCMenu alloc] initWithArray:menuItems]; menu.position = ccp(<span class="hljs-number"><span class="hljs-number">240</span></span>, <span class="hljs-number"><span class="hljs-number">-100</span></span>); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addChild:menu]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addChild:diedLabel]; [menu runAction:slideIn]; }</code> </pre></div></div><br>  The first line declares the gameOver variable.  We will use this variable in order to force the update method to stop making any changes in Koalio's position.  Literally in a minute we will realize it. <br>  Next, the code creates the text (label) and gives it the value of won or lost.  We also create a ‚ÄúRestart‚Äù button. <br>  These block-based methods of CCMenu objects are quite convenient to use.  In our case, we simply replace our level with a copy of it in order to start the level again.  We use CCAction and CCMove just to beautifully animate the buttons. <br>  Another thing to do is add the gameOver boolean variable to the GameLevelLayer class.  This will be a local variable, since we will not use it outside the class.  Add the following to the <code>@ interface</code> at the beginning of the <b>GameLevelLayer.m</b> file: <br><br><pre> <code class="objectivec hljs">CCTMXLayer *hazards; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> gameOver;</code> </pre><br>  Modify the <b>update</b> method as follows: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)update:(ccTime)dt { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameOver) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } [player update:dt]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> checkForAndResolveCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> handleHazardCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setViewpointCenter:player.position]; }</code> </pre><br>  Start the game, find the studded floor and jump on it!  You should see something like this: <br><br><img src="http://kartinok.net/images/2012/12/21/zvoeQ.png" alt="image"><br><br>  Just do not repeat it too often, but there may be problems with animal advocates!  :] <br><br><h4>  Death pit </h4><br>  Now add the script to drop into the hole between the cells.  In this case, we just complete the game. <br>  Right now, when falling, the code will be brightened up with the error "TMXLayer: invalid position".  (Horror!) This is where we need to intervene. <br>  Add the following code in <b>GameLevelLayer.m</b> , to the <b>getSurroundingTilesAtPosition:</b> method, in front of the <b>tileGIDat</b> line <b>:</b> <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tilePos.y &gt; (map.mapSize.height - <span class="hljs-number"><span class="hljs-number">1</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//fallen in a hole [self gameOver:0]; return nil; }</span></span></code> </pre><br>  This code will trigger the gameOver action and prevent the process of creating an array of cells.  We also need to prevent the process of looping through all cells in <b>checkForAndResolveCollisions</b> .  Add a block of code after the line <b>NSArray * tiles = [self getSurroundingTilesAtPosition: p.position forLayer: walls];</b>  : <br><br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameOver) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  This will prevent the cycle call and unnecessary crash of the game. <br>  Launch the game right now.  Find the abyss into which you can jump, and ... no departures!  The game works as intended. <br><br><img src="http://kartinok.net/images/2012/12/21/aYCjZ.png" alt="image"><br><br><h4>  Victory! </h4><br>  Now, let's work on the occasion when our Koalio wins the game! <br><br><img src="http://kartinok.net/images/2012/12/23/fEmwg.png" alt="image"><br><br>  All that we do is monitor the x-position of our Koala and show the screen with the winning message if it crosses a certain label.  The length of this level is 3400 pixels.  We put a winning mark at a distance of 3130 pixels. <br>  Add a new method to <b>GameLevelLayer.m</b> and update the update method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)checkForWin { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (player.position.x &gt; <span class="hljs-number"><span class="hljs-number">3130.0</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> gameOver:<span class="hljs-number"><span class="hljs-number">1</span></span>]; } }</code> </pre><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)update:(ccTime)dt { [player update:dt]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> handleHazardCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> checkForWin]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> checkForAndResolveCollisions:player]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setViewpointCenter:player.position]; }</code> </pre><br>  Run, try to win.  If it works, you should see the following: <br><br><img src="http://kartinok.net/images/2012/12/21/UCoO4.png" alt="image"><br><br><h4>  Great music and sound effects </h4><br>  It's time for great music and sound effects! <br>  Let's start.  Add the following to the top of <b>GameLevelLayer.m</b> and <b>Player.m</b> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SimpleAudioEngine.h"</span></span></span></span></code> </pre><br>  Now add the following line to the init method of the <b>GameLevelLayer</b> file. <br><br><pre> <code class="objectivec hljs"> [[SimpleAudioEngine sharedEngine] playBackgroundMusic:<span class="hljs-string"><span class="hljs-string">@"level1.mp3"</span></span>];</code> </pre><br>  We just hooked up nice gaming music.  Thanks to Kevin from Incompetech.com for writing music ( <a href="http://incompetech.com/m/c/royalty-free/index.html%3Fkeywords%3DUSUAN1200047">Brittle Reel</a> ).  He has a whole cloud of CC licensed music there! <br>  Now add a jump sound.  Go to <b>Player.m</b> and add the following to the <b>update</b> method jump code: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mightAsWellJump &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.onGround) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity = ccpAdd(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity, jumpForce); [[SimpleAudioEngine sharedEngine] playEffect:<span class="hljs-string"><span class="hljs-string">@"jump.wav"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mightAsWellJump &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity.y &gt; jumpCutoff) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity = ccp(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.velocity.x, jumpCutoff); }</code> </pre><br>  Finally, we lose the sound of defeat, when Koalio touches a dangerous cell or falls into a pit.  Add the following to the <b>gameOver</b> method of the <b>GameLevelLayer.m</b> file: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)gameOver { gameOver = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; [[SimpleAudioEngine sharedEngine] playEffect:<span class="hljs-string"><span class="hljs-string">@"hurt.wav"</span></span>]; CCLabelTTF *diedLabel = [[CCLabelTTF alloc] initWithString:<span class="hljs-string"><span class="hljs-string">@"You have Died!"</span></span> fontName:<span class="hljs-string"><span class="hljs-string">@"Marker Felt"</span></span> fontSize:<span class="hljs-number"><span class="hljs-number">40</span></span>]; diedLabel.position = ccp(<span class="hljs-number"><span class="hljs-number">240</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>);</code> </pre><br>  Launch and enjoy the new pleasant melodies. <br>  That's all!  You wrote a platformer!  You are wonderful! <br><br>  And here is the <a href="">source code of</a> our finished project. <br><hr><br><h5>  Translator's Note </h5><br>  I decided from time to time to translate tutorials from the site <a href="http://www.raywenderlich.com/">raywenderlich.com</a> . <br>  My next goal is to translate a <a href="http://www.raywenderlich.com/14302/how-to-make-a-game-like-fruit-ninja-with-box2d-and-cocos2d-part-1">series of tutorials</a> on how to create your own game like Fruit Ninja based on Box2D and Cocos2D. <br>  Write in the comments, is it worth it.  If the translation will be in demand, I will translate. <br>  About all inaccuracies and typographical errors found, please write in habraposhta or here in the comments. <br>  We are happy to answer all questions on the tutorial! </div><p>Source: <a href="https://habr.com/ru/post/163435/">https://habr.com/ru/post/163435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163425/index.html">Most popular on Github in 2012</a></li>
<li><a href="../163427/index.html">Brazilian company launches its own "iPhone" on the Android OS</a></li>
<li><a href="../163429/index.html">All, all, all: time to update your CSS3</a></li>
<li><a href="../163431/index.html">Printer Wars: Epson vs. Epson, or the difference of mentalities</a></li>
<li><a href="../163433/index.html">Earth through the eyes of an asteroid</a></li>
<li><a href="../163437/index.html">Unity Web API, or how to integrate your site in Ubuntu</a></li>
<li><a href="../163439/index.html">Working with Perl encodings</a></li>
<li><a href="../163443/index.html">Introduction to the development of WinRT applications in HTML / JavaScript. From template to data application</a></li>
<li><a href="../163445/index.html">Jetbrains gives 75% discount on all products. 4 more hours!</a></li>
<li><a href="../163451/index.html">What to do if a RAID controller fails?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>