<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Real-time object recognition on iOS using YOLOv3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 In this article, we will write a small program to solve the problem of object detection and recognition (object detection) in real time. The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Real-time object recognition on iOS using YOLOv3</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gr/ah/g9/grahg9mh7movhc2fcbn7m-yfoxu.png"></div><br>  Hello! <br><br>  In this article, we will write a small program to solve the problem of object detection and recognition (object detection) in real time.  The program will be written in the Swift programming language for the iOS platform.  To detect objects, we will use a convolutional neural network with an architecture called YOLOv3.  In this article, we will learn how to work in iOS with neural networks using the CoreML framework, a little understanding of what the YOLOv3 network is and how to use and process the outputs of this network.  We‚Äôll also check the operation of the program and compare several variations of YOLOv3: YOLOv3-tiny and YOLOv3-416. <br><br>  Sources will be available at the end of the article, so everyone will be able to test the operation of the neural network on their device. <br><a name="habracut"></a><br><h2>  Object detection </h2><br>  To begin with, we will briefly understand what the task of detecting objects (object detection) in the image is and what tools are used for this today.  I understand that many are quite familiar with this topic, but I still allow myself to tell a little about it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now a lot of tasks in the field of computer vision are solved with the help of convolutional neural networks (Convolutional Neural Networks), hereinafter CNN.  Due to their structure, they well extract features from the image.  CNNs are used in classification, recognition, segmentation, and many others. <br><br>  Popular CNN architectures for object recognition: <br><br><ul><li>  <b>R-CNN.</b>  We can say the first model to solve this problem.  Works like a regular image classifier.  Different regions of the image are fed to the network input and predictions are made for them.  Very slow since it runs a single image several thousand times. </li><li>  <b>Fast R-CNN.</b>  An improved and faster version of R-CNN, works on a similar principle, but first the entire image is fed to CNN input, then regions are generated from the received internal representation.  But still pretty slow for real-time tasks. </li><li>  <b>Faster R-CNN.</b>  The main difference from the previous ones is that instead of the selective search algorithm, it uses a neural network to select regions to ‚Äúmemorize‚Äù them. </li><li>  <b>YOLO.</b>  A completely different principle of operation compared to the previous ones does not use regions at all.  The fastest.  More details about it will be discussed in the article. </li><li>  <b>SSD</b>  It is similar in principle to YOLO, but uses VGG16 as a network to extract features.  Also quite fast and suitable for real-time work. </li><li>  <b>Feature Pyramid Networks (FPN).</b>  Another type of network such as Single Shot Detector, due to the features of feature extraction, is better than small objects recognized by SSD. </li><li>  <b>RetinaNet.</b>  Uses a combination of FPN + ResNet and thanks to a special function of error (focal loss) gives higher accuracy (accuracy). </li></ul><br>  In this article, we will use the YOLO architecture, namely its latest modification, YOLOv3. <br><br><h2>  Why YOLO? </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i4/fy/lq/i4fylqlbpgsp-mu3w6k96zd5e1u.jpeg"></div><br><br>  YOLO or You Only Look Once is CNN's very popular architecture at the moment, which is used to recognize multiple objects in an image.  More complete information about it can be obtained on the <a href="https://pjreddie.com/darknet/yolo/">official website</a> , where you can also find publications that describe in detail the theory and mathematical component of this network, as well as the process of its training. <br><br>  The main feature of this architecture compared to others is that most systems apply CNN several times to different regions of the image; in YOLO, CNN is applied once to the entire image at once.  The network divides the image into a kind of grid and predicts bounding boxes and the likelihood that there is a desired object for each section. <br><br>  The advantages of this approach is that the network looks at the entire image at once and takes into account the context when detecting and recognizing an object.  YOLO is also 1000 times faster than R-CNN and about 100x faster than Fast R-CNN.  In this article, we will launch a network on a mobile device for online processing, so this is the most important quality for us. <br><br>  More detailed information on comparing architectures can be found <a href="https://pjreddie.com/media/files/papers/YOLOv3.pdf">here</a> . <br><br><h4>  YOLOv3 </h4><br>  YOLOv3 is an improved version of the YOLO architecture.  It consists of 106 convolutional layers and better detects small objects compared to its predecessor YOLOv2.  The main feature of YOLOv3 is that there are three layers at the output, each of which is designed to detect objects of different sizes. <br>  The picture below shows its schematic structure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/rf/_j/clrf_jqzkt1qfszivfchhxkujv4.png"></div><br><br>  <b>YOLOv3-tiny</b> - A cropped version of the YOLOv3 architecture, consists of fewer layers (there are only 2 output layers).  It predicts smaller objects worse and is designed for small datasets.  But, due to the truncated structure, the network weights occupy a small amount of memory (~ 35 MB) and it produces a higher FPS.  Therefore, such an architecture is preferable for use on a mobile device. <br><br><h2>  We are writing a program for object recognition </h2><br>  The fun part begins! <br><br>  Let's create an application that will recognize various objects in the image in real time using the phone‚Äôs camera.  All code will be written in the Swift 4.2 programming language and run on an iOS device. <br><br>  In this tutorial we will take a ready-made network with scales pre-trained on a <a href="https://cocodataset.org/">COCO</a> dataset.  It presents 80 different classes.  Therefore, our neuron will be able to recognize 80 different objects. <br><br><h4>  From Darknet to CoreML </h4><br>  The original YOLOv3 architecture is implemented using the <a href="https://github.com/pjreddie/darknet">Darknet</a> framework. <br><br>  On iOS, starting with version 11.0, there is a wonderful <a href="https://developer.apple.com/documentation/coreml">CoreML</a> library that allows you to run machine learning models directly on the device.  But there is one limitation: the <b>program can only be run on a device running iOS 11 and above.</b> <br><br>  The problem is that CoreML only understands the specific format of the <i>.coreml</i> model.  For most popular libraries, such as Tensorflow, Keras or XGBoost, it is possible to directly convert to CoreML format.  But for Darknet there is no such possibility.  In order to convert the saved and trained model from Darknet to CoreML, you can use various options, for example, save Darknet to <a href="https://onnx.ai/">ONNX</a> , and then convert it from ONNX to CoreML. <br><br>  We will use a simpler way and we will use Keras implementation of YOLOv3.  The algorithm of action is this: load the Darknet weights into the Keras model, save it in the Keras format and directly convert it to CoreML from this. <br><br><ol><li>  <b>Download Darknet.</b>  Download the files of the trained Darknet-YOLOv3 model <a href="https://pjreddie.com/darknet/yolo/">from here</a> .  In this article, I will use two architectures: YOLOv3-416 and YOLOv3-tiny.  We will need both cfg and weights files. </li><li>  <b>From Darknet to Keras.</b>  First we clone the <a href="https://github.com/qqwweee/keras-yolo3">repository</a> , go to the repo folder and run the command: <br><br><pre><code class="bash hljs">python convert.py yolov3.cfg yolov3.weights yolo.h5</code> </pre> <br>  where yolov3.cfg and yolov3.weights downloaded Darknet files.  As a result, we should have a file with the extension <i>.h5</i> - this is the saved YOLOv3 model in Keras format. </li><li>  <b>From Keras to CoreML.</b>  The last step remained.  In order to convert the model to CoreML, you need to run the python script (first you need to install the coremltools library for python): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> coremltools coreml_model = coremltools.converters.keras.convert( <span class="hljs-string"><span class="hljs-string">'yolo.h5'</span></span>, input_names=<span class="hljs-string"><span class="hljs-string">'image'</span></span>, image_input_names=<span class="hljs-string"><span class="hljs-string">'image'</span></span>, input_name_shape_dict={<span class="hljs-string"><span class="hljs-string">'image'</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">416</span></span>, <span class="hljs-number"><span class="hljs-number">416</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]}, <span class="hljs-comment"><span class="hljs-comment">#      image_scale=1/255.) coreml_model.input_description['image'] = 'Input image' coreml_model.save('yolo.mlmodel')</span></span></code> </pre> </li></ol><br>  The steps described above must be done for the two models YOLOv3-416 and YOLOv3-tiny. <br>  When we did all this, we have two files: yolo.mlmodel and yolo-tiny.mlmodel.  Now you can start writing the code of the application itself. <br><br><h4>  Creating an iOS app </h4><br>  I won‚Äôt describe all the application code, you can see it in the repository link to which will be given at the end of the article.  Let me just say that we have three UIViewController-a: OnlineViewController, PhotoViewController and SettingsViewController.  The first is the output of the camera and online detection of objects for each frame.  In the second, you can take a photo or select a picture from the gallery and test the network on these images.  The third one contains the settings, you can choose the YOLOv3-416 or YOLOv3-tiny model, as well as choose the thresholds IoU (intersection over union) and object confidence (the probability that there is an object in the current image section). <br><br>  <b>Loading Models in CoreML</b> <br><br>  After we converted the trained model from Darknet format to CoreML, we have a file with the extension <i>.mlmodel</i> .  In my case, I created two files: <i>yolo.mlmodel</i> and <i>yolo-tiny.mlmodel</i> , for the models YOLOv3-416 and YOLOv3-tiny, respectively.  Now you can load these files into a project in Xcode. <br><br>  We create the ModelProvider class; it will store the current model and methods for asynchronously invoking the neural network for execution.  Model loading is carried out in this way: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type: YOLOType)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.model = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-type"><span class="hljs-type">YOLO</span></span>(type: type) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">assertionFailure</span></span>(<span class="hljs-string"><span class="hljs-string">"error creating model"</span></span>) } }</code> </pre><br>  The YOLO class is directly responsible for loading <i>.mlmodel</i> files and handling model outputs.  Download model files: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url: <span class="hljs-type"><span class="hljs-type">URL?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.type = type <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> type { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .v3_Tiny: url = <span class="hljs-type"><span class="hljs-type">Bundle</span></span>.main.url(forResource: <span class="hljs-string"><span class="hljs-string">"yolo-tiny"</span></span>, withExtension:<span class="hljs-string"><span class="hljs-string">"mlmodelc"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.anchors = tiny_anchors <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .v3_416: url = <span class="hljs-type"><span class="hljs-type">Bundle</span></span>.main.url(forResource: <span class="hljs-string"><span class="hljs-string">"yolo"</span></span>, withExtension:<span class="hljs-string"><span class="hljs-string">"mlmodelc"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.anchors = anchors_416 } <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> modelURL = url <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-type"><span class="hljs-type">YOLOError</span></span>.modelFileNotFound } <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { model = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-type"><span class="hljs-type">MLModel</span></span>(contentsOf: modelURL) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-type"><span class="hljs-type">YOLOError</span></span>.modelCreationError }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Full ModelProvider Code.</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CoreML protocol ModelProviderDelegate: class { func show(predictions: [YOLO.Prediction]?, stat: ModelProvider.Statistics, error: YOLOError?) } @available(macOS 10.13, iOS 11.0, tvOS 11.0, watchOS 4.0, *) class ModelProvider { struct Statistics { var timeForFrame: Float var fps: Float } static let shared = ModelProvider(modelType: Settings.shared.modelType) var model: YOLO! weak var delegate: ModelProviderDelegate? var predicted = 0 var timeOfFirstFrameInSecond = CACurrentMediaTime() init(modelType type: YOLOType) { loadModel(type: type) } func reloadModel(type: YOLOType) { loadModel(type: type) } private func loadModel(type: YOLOType) { do { self.model = try YOLO(type: type) } catch { assertionFailure("error creating model") } } func predict(frame: UIImage) { DispatchQueue.global().async { do { let startTime = CACurrentMediaTime() let predictions = try self.model.predict(frame: frame) let elapsed = CACurrentMediaTime() - startTime self.showResultOnMain(predictions: predictions, elapsed: Float(elapsed), error: nil) } catch let error as YOLOError { self.showResultOnMain(predictions: nil, elapsed: -1, error: error) } catch { self.showResultOnMain(predictions: nil, elapsed: -1, error: YOLOError.unknownError) } } } private func showResultOnMain(predictions: [YOLO.Prediction]?, elapsed: Float, error: YOLOError?) { if let delegate = self.delegate { DispatchQueue.main.async { let fps = self.measureFPS() delegate.show(predictions: predictions, stat: ModelProvider.Statistics(timeForFrame: elapsed, fps: fps), error: error) } } } private func measureFPS() -&gt; Float { predicted += 1 let elapsed = CACurrentMediaTime() - timeOfFirstFrameInSecond let currentFPSDelivered = Double(predicted) / elapsed if elapsed &gt; 1 { predicted = 0 timeOfFirstFrameInSecond = CACurrentMediaTime() } return Float(currentFPSDelivered) } }</code> </pre><br></div></div><br>  <b>Processing neural network outputs</b> <br><br>  Now let's figure out how to process the outputs of the neural network and get the corresponding bounding boxes.  In Xcode, if you select a model file, you can see what they are and see the output layers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/3b/vz/m_3bvzkroynfyfkpv1fal-ydf_k.png"></div><br>  <i>Entry and exit YOLOv3-tiny.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0l/nl/hy/0lnlhydblax7trhpzdte8bojc0y.png"></div><br>  <i>Entrance and exit YOLOv3-416.</i> <br><br>  As you can see in the image above, we have three for YOLOv3-416 and two for YOLOv3-tiny output layers in each of which bounding boxes for various objects are predicted. <br>  In this case, this is an ordinary array of numbers, let's figure out how to parse it. <br><br>  The YOLOv3 model uses three layers as the output for splitting the image into a different grid, the cell sizes of these grids have the following values: 8, 16 and 32. Suppose we have an image of 416x416 pixels in size at the input, then the output matrices (grids) will have a size of 52x52 , 26x26 and 13x13 (416/8 = 52, 416/16 = 26 and 416/32 = 13).  In the case of YOLOv3-tiny, everything is the same, but instead of three grids, we have two: 16 and 32, that is, matrices of 26x26 and 13x13 dimensions. <br><br>  After starting the loaded CoreML model, we get two (or three) objects of the MLMultiArray class on the output.  And if you look at the shape property of these objects, we will see the following picture (for YOLOv3-tiny): <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mo stretchy=&quot;false&quot;>[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>26</mn><mo>,</mo><mn>26</mn><mo stretchy=&quot;false&quot;>]</mo><mspace linebreak=&quot;newline&quot; /><mo stretchy=&quot;false&quot;>[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>13</mn><mo>,</mo><mn>13</mn><mo stretchy=&quot;false&quot;>]</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="76.867ex" height="6.033ex" viewBox="0 -832 33095.6 2597.7" role="img" focusable="false" style="vertical-align: -4.101ex; max-width: 638px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(13126,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31" x="1224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="1724" y="0"></use><g transform="translate(2169,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-35" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="3671" y="0"></use><g transform="translate(4116,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-36" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="5117" y="0"></use><g transform="translate(5562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-36" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-5D" x="6563" y="0"></use></g><g transform="translate(13126,-1433)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31" x="1224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="1724" y="0"></use><g transform="translate(2169,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-35" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="3671" y="0"></use><g transform="translate(4116,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-33" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="5117" y="0"></use><g transform="translate(5562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-33" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-5D" x="6563" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mo stretchy="false">[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>26</mn><mo>,</mo><mn>26</mn><mo stretchy="false">]</mo><mspace linebreak="newline"></mspace><mo stretchy="false">[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>13</mn><mo>,</mo><mn>13</mn><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> [1, 1, 255, 26, 26] \\ [1, 1, 255, 13, 13] </script></p><br>  As expected, the dimension of the matrices will be 26x26 and 13x13. But what will the number 255 mean?  As mentioned earlier, the output layers are 52x52, 26x26 and 13x13 matrices.  The fact is that each element of this matrix is ‚Äã‚Äãnot a number, it is a vector.  That is, the output layer is a three-dimensional matrix.  This vector has dimension B x (5 + C), where B is the number of bounding box in the cell, C is the number of classes.  Where does the number 5 come from?  The reason is this: for each box-a, the probability that there is an object (object confidence) is predicted is one number, and the remaining four are x, y, width and height for the predicted box-a.  The figure below shows a schematic representation of this vector: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3d/j3/rl/3dj3rlk_te-4x-pthae9mreq7k0.png"></div><br>  <i>Schematic representation of the output layer (feature map).</i> <br><br>  For our network trained in 80 classes, 3 bounding box-a is predicted for each cell of the partition grid, for each of them - 80 class probabilities + object confidence + 4 numbers responsible for the position and size of this box-a.  Total: 3 x (5 + 80) = 255. <br><br>  To get these values ‚Äã‚Äãfrom the MLMultiArray class, it is better to use a raw pointer to a data array and address arithmetic: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> pointer = <span class="hljs-type"><span class="hljs-type">UnsafeMutablePointer</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Double</span></span>&gt;(<span class="hljs-type"><span class="hljs-type">OpaquePointer</span></span>(out.dataPointer)) <span class="hljs-comment"><span class="hljs-comment">//    if out.strides.count &lt; 3 { throw YOLOError.strideOutOfBounds } let channelStride = out.strides[out.strides.count-3].intValue let yStride = out.strides[out.strides.count-2].intValue let xStride = out.strides[out.strides.count-1].intValue func offset(ch: Int, x: Int, y: Int) -&gt; Int { //     return ch * channelStride + y * yStride + x * xStride }</span></span></code> </pre><br>  Now you need to process a vector of 255 elements.  For each box, you need to get a probability distribution for 80 classes, you can do this using the softmax function. <br><br><div class="spoiler">  <b class="spoiler_title">What is softmax</b> <div class="spoiler_text">  Function converts a vector <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><mi>x</mi></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.354ex" height="2.074ex" viewBox="0 -772.3 4027.5 892.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.28ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="1128" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1658" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="2019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="2596" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="3025" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="3455" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> \ mathbb x </script>  dimension K into a vector of the same dimension where each coordinate <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msub><mi>x</mi><mi>i</mi></msub></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.154ex" height="2.349ex" viewBox="0 -772.3 4371.8 1011.3" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.555ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="1128" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1658" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="2019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="2596" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="3025" y="0"></use><g transform="translate(3455,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="809" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><msub><mi>x</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ mathbb x_i </script>  the resulting vector is represented by a real number in the interval [0,1] and the sum of the coordinates is 1. <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi></mrow><msub><mo stretchy=&quot;false&quot;>)</mo><mi>i</mi></msub><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mi>i</mi></msub></mrow></msup></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><msubsup><mi>m</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></msubsup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mi>k</mi></msub></mrow></msup></mrow></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="41.144ex" height="3.037ex" viewBox="0 -890.8 17714.6 1307.5" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.968ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="719" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-67" x="1065" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="1545" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="2424" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-28" x="2953" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="3593" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="4471" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="5001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="5362" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="5939" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-62" x="6368" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="6798" y="0"></use><g transform="translate(7370,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="550" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="8382" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-66" x="9688" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-72" x="10238" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="10690" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="11219" y="0"></use><g transform="translate(11653,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="809" y="-213"></use></g></g><g transform="translate(12868,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-75" x="719" y="0"></use><g transform="translate(1292,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-4B" x="1242" y="488"></use><g transform="translate(878,-327)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="521" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-31" x="1300" y="0"></use></g></g><g transform="translate(3543,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6B" x="809" y="-213"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>&nbsp;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>b</mi><mrow class="MJX-TeXAtom-ORD"><mi>x</mi></mrow><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mi>i</mi></msub></mrow></msup></mrow><mrow class="MJX-TeXAtom-ORD"><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><msubsup><mi>m</mi><mrow class="MJX-TeXAtom-ORD"><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>K</mi></mrow></msubsup><mrow class="MJX-TeXAtom-ORD"><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mi>k</mi></msub></mrow></msup></mrow></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-4"> \ sigma (\ mathbb {x}) _ i = \ frac {e ^ {x_i}} {\ sum_ {k = 1} ^ {K} {e ^ {x_k}}} </script></p>  where K is the dimension of the vector. <br></div></div><br>  Softmax function on Swift: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">softmax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> [Float])</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> len = vDSP_Length(x.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = <span class="hljs-type"><span class="hljs-type">Int32</span></span>(x.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>) vvexpf(&amp;x, x, &amp;<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sum: <span class="hljs-type"><span class="hljs-type">Float</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> vDSP_sve(x, <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;sum, len) vDSP_vsdiv(x, <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;sum, &amp;x, <span class="hljs-number"><span class="hljs-number">1</span></span>, len) }</code> </pre><br>  To get the coordinates and sizes of bounding box-a you need to use the formulas: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>x</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub><mspace linebreak=&quot;newline&quot; /><mi>y</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy=&quot;false&quot;>(</mo><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>y</mi><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub><mspace linebreak=&quot;newline&quot; /><mi>w</mi><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>w</mi></mrow></msup><mspace linebreak=&quot;newline&quot; /><mi>h</mi><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>h</mi></mrow></msup></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="76.867ex" height="13.262ex" viewBox="0 -832 33095.6 5710.1" role="img" focusable="false" style="vertical-align: -11.33ex; max-width: 638px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(11502,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="2156" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="2626" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-67" x="2971" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="3452" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="4330" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-28" x="4860" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="5499" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="6076" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="6605" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="6967" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-29" x="7539" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2B" x="8151" y="0"></use><g transform="translate(9152,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="613" y="-213"></use></g></g><g transform="translate(11604,-1433)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-79" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="775" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="2081" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="2551" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-67" x="2896" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="3377" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="4255" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-28" x="4785" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="5424" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="6001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="6530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-79" x="6892" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-29" x="7389" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2B" x="8001" y="0"></use><g transform="translate(9002,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-79" x="613" y="-213"></use></g></g><g transform="translate(13787,-3064)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-77" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="994" y="0"></use><g transform="translate(2050,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-77" x="712" y="-213"></use></g><g transform="translate(3160,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="353" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="930" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1459" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-77" x="1821" y="0"></use></g></g></g><g transform="translate(13956,-4593)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="854" y="0"></use><g transform="translate(1910,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="712" y="-213"></use></g><g transform="translate(2921,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="353" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="930" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1459" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="1821" y="0"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>x</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub><mspace linebreak="newline"></mspace><mi>y</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy="false">(</mo><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>y</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub><mspace linebreak="newline"></mspace><mi>w</mi><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>w</mi></mrow></msup><mspace linebreak="newline"></mspace><mi>h</mi><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>h</mi></mrow></msup></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-5"> x = \ sigma (\ hat x) + c_x \\ y = \ sigma (\ hat y) + c_y \\ w = p_we ^ {\ hat w} \\ h = p_he ^ {\ hat h} </script></p><br>  Where <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>x</mi><mo>,</mo><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>y</mi><mo>,</mo><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>w</mi><mo>,</mo><mtext>&amp;#xA0;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>h</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.546ex" height="2.419ex" viewBox="0 -780.1 10568.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="826" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1356" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="1717" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="2290" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="2985" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="3561" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="4091" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-79" x="4452" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="4950" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="5645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="6221" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="6751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-77" x="7112" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="7829" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="8524" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="9101" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="9630" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="9992" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>x</mi><mo>,</mo><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>y</mi><mo>,</mo><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>w</mi><mo>,</mo><mtext>&nbsp;</mtext><mi>h</mi><mi>a</mi><mi>t</mi><mi>h</mi></math></span></span><script type="math/tex" id="MathJax-Element-6"> \ hat x, \ hat y, \ hat w, \ hat h </script>  - predicted x, y coordinates, width and height, respectively, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.999ex" height="2.66ex" viewBox="0 -832 4305 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="719" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-67" x="1065" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6D" x="1545" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="2424" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-28" x="2953" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="3343" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-29" x="3915" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-7"> \ sigma (x) </script>  Is the sigmoid function, and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>w</mi></msub><mo>,</mo><msub><mi>p</mi><mi>h</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.05ex" height="1.817ex" viewBox="-38.5 -520.7 2605 782.1" role="img" focusable="false" style="vertical-align: -0.607ex; margin-left: -0.089ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-77" x="712" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-2C" x="1110" y="0"></use><g transform="translate(1555,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-68" x="712" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>p</mi><mi>w</mi></msub><mo>,</mo><msub><mi>p</mi><mi>h</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-8"> p_w, p_h </script>  - values ‚Äã‚Äãof anchors for three boxes.  These values ‚Äã‚Äãare determined during training and are set in the Helpers.swift file: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> anchors1: [<span class="hljs-type"><span class="hljs-type">Float</span></span>] = [<span class="hljs-number"><span class="hljs-number">116</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">156</span></span>,<span class="hljs-number"><span class="hljs-number">198</span></span>, <span class="hljs-number"><span class="hljs-number">373</span></span>,<span class="hljs-number"><span class="hljs-number">326</span></span>] <span class="hljs-comment"><span class="hljs-comment">//     let anchors2: [Float] = [30,61, 62,45, 59,119] //     let anchors3: [Float] = [10,13, 16,30, 33,23] //    </span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ng/zf/pv/ngzfpvvch8bhnkdapz6url5ok-w.png"></div><br>  <i>Schematic illustration of the calculation of the position of a bounding box.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Full code for processing output layers.</b> <div class="spoiler_text"><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(output out: MLMultiArray, name: String)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">Prediction</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> predictions = [<span class="hljs-type"><span class="hljs-type">Prediction</span></span>]() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> grid = out.shape[out.shape.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>].intValue <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gridSize = <span class="hljs-type"><span class="hljs-type">YOLO</span></span>.inputSize / <span class="hljs-type"><span class="hljs-type">Float</span></span>(grid) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> classesCount = labels.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(out.shape) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> pointer = <span class="hljs-type"><span class="hljs-type">UnsafeMutablePointer</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Double</span></span>&gt;(<span class="hljs-type"><span class="hljs-type">OpaquePointer</span></span>(out.dataPointer)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> out.strides.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-type"><span class="hljs-type">YOLOError</span></span>.strideOutOfBounds } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> channelStride = out.strides[out.strides.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>-<span class="hljs-number"><span class="hljs-number">3</span></span>].intValue <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> yStride = out.strides[out.strides.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>-<span class="hljs-number"><span class="hljs-number">2</span></span>].intValue <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> xStride = out.strides[out.strides.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>].intValue <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ch: Int, x: Int, y: Int)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ch * channelStride + y * yStride + x * xStride } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ..&lt; grid { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ..&lt; grid { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> box_i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ..&lt; <span class="hljs-type"><span class="hljs-type">YOLO</span></span>.boxesPerCell { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> boxOffset = box_i * (classesCount + <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bbx = <span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset, x: x, y: y)]) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bby = <span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset + <span class="hljs-number"><span class="hljs-number">1</span></span>, x: x, y: y)]) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bbw = <span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset + <span class="hljs-number"><span class="hljs-number">2</span></span>, x: x, y: y)]) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bbh = <span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset + <span class="hljs-number"><span class="hljs-number">3</span></span>, x: x, y: y)]) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> confidence = sigmoid(<span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset + <span class="hljs-number"><span class="hljs-number">4</span></span>, x: x, y: y)])) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> confidence &lt; confidenceThreshold { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> x_pos = (sigmoid(bbx) + <span class="hljs-type"><span class="hljs-type">Float</span></span>(x)) * gridSize <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> y_pos = (sigmoid(bby) + <span class="hljs-type"><span class="hljs-type">Float</span></span>(y)) * gridSize <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> width = exp(bbw) * <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.anchors[name]![<span class="hljs-number"><span class="hljs-number">2</span></span> * box_i] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> height = exp(bbh) * <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.anchors[name]![<span class="hljs-number"><span class="hljs-number">2</span></span> * box_i + <span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ..&lt; <span class="hljs-number"><span class="hljs-number">80</span></span> { classes[<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>] = <span class="hljs-type"><span class="hljs-type">Float</span></span>(pointer[offset(ch: boxOffset + <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>, x: x, y: y)]) } softmax(&amp;classes) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (detectedClass, bestClassScore) = argmax(classes) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> confidenceInClass = bestClassScore * confidence <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> confidenceInClass &lt; confidenceThreshold { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } predictions.append(<span class="hljs-type"><span class="hljs-type">Prediction</span></span>(classIndex: detectedClass, score: confidenceInClass, rect: <span class="hljs-type"><span class="hljs-type">CGRect</span></span>(x: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(x_pos - width / <span class="hljs-number"><span class="hljs-number">2</span></span>), y: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(y_pos - height / <span class="hljs-number"><span class="hljs-number">2</span></span>), width: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(width), height: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(height)))) } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> predictions }</code> </pre><br></div></div><br>  <b>Non max suppression</b> <br><br>  Once you have received the coordinates and sizes of the bounding boxes and the corresponding probabilities for all the objects found in the image, you can begin to draw them on top of the image.  But there is one problem!  Such a situation may arise when for one object several boxes are predicted with fairly high probabilities.  What to do in this case?  Here a fairly simple algorithm called Non maximum suppression comes to our aid. <br><br>  The algorithm is as follows: <br><br><ol><li>  We are looking for a bounding box with the highest probability of belonging to the object. </li><li>  We run through all bounding boxes that also belong to this object. </li><li>  We delete them if Intersection over Union (IoU) with the first bounding box is greater than the specified threshold. </li></ol><br>  IoU is calculated using a simple formula: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>I</mi><mi>o</mi><mi>U</mi></mrow><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>A</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>c</mi><mi>i</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="61.693ex" height="2.419ex" viewBox="0 -780.1 26562.1 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="611" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="1078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1650" y="0"></use><g transform="translate(2012,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-49" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6F" x="504" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-55" x="990" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMAIN-3D" x="4047" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-66" x="5353" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-72" x="5904" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="6355" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="6885" y="0"></use><g transform="translate(7318,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="611" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="1078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1650" y="0"></use><g transform="translate(2012,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-49" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6E" x="504" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1105" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="1466" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-72" x="1933" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="2384" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="2854" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="3320" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="3754" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="4115" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6F" x="4461" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6E" x="4946" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-41" x="5547" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-72" x="6297" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="6749" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="7215" y="0"></use></g></g><g transform="translate(17075,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="611" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-78" x="1078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="1650" y="0"></use><g transform="translate(2012,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="750" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-73" x="1220" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6F" x="1689" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-63" x="2175" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="2608" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="2954" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-74" x="3483" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-69" x="3845" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6F" x="4190" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-6E" x="4676" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-41" x="5276" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-72" x="6027" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-65" x="6478" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/460869/&amp;xid=17259,1500004,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhhFPotntcaQuabn3EhELdNj5Zu1Lg#MJMATHI-61" x="6945" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>&nbsp;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mi>I</mi><mi>o</mi><mi>U</mi></mrow><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mtext>&nbsp;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mrow><mrow class="MJX-TeXAtom-ORD"><mtext>&nbsp;</mtext><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mi>A</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>c</mi><mi>i</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-9"> \ text {IoU} = \ frac {\ text {Intersection Area}} {\ text {Association Area}} </script></p><div class="spoiler">  <b class="spoiler_title">Calculation of IoU.</b> <div class="spoiler_text"><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IOU</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a: CGRect, b: CGRect)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Float</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> areaA = a.width * a.height <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> areaA &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> areaB = b.width * b.height <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> areaB &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> intersection = a.intersection(b) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> intersectionArea = intersection.width * intersection.height <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Float</span></span>(intersectionArea / (areaA + areaB - intersectionArea)) }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Non max suppression.</b> <div class="spoiler_text"><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonMaxSuppression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(boxes: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> [Prediction], threshold: Float)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> i &lt; boxes.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> j &lt; boxes.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iou = <span class="hljs-type"><span class="hljs-type">YOLO</span></span>.<span class="hljs-type"><span class="hljs-type">IOU</span></span>(a: boxes[i].rect, b: boxes[j].rect) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> iou &gt; threshold { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> boxes[i].score &gt; boxes[j].score { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> boxes[i].classIndex == boxes[j].classIndex { boxes.remove(at: j) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { j += <span class="hljs-number"><span class="hljs-number">1</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> boxes[i].classIndex == boxes[j].classIndex { boxes.remove(at: i) j = i + <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { j += <span class="hljs-number"><span class="hljs-number">1</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { j += <span class="hljs-number"><span class="hljs-number">1</span></span> } } i += <span class="hljs-number"><span class="hljs-number">1</span></span> } }</code> </pre><br></div></div><br>  After that, work directly with the results of neural network prediction can be considered complete.  Next, you need to write functions and classes to get the footage from the camera, display the image on the screen and render the predicted bounding boxes.  I will not describe all this code in this article, but it can be viewed in the repository. <br><br>  It is also worth mentioning that I added a little smoothing of the bounding boxes when processing online images, in this case it is the usual averaging of the position and size of the predicted square over the last 30 frames. <br><br><h4>  Testing the program </h4><br>  Now we test the application. <br><br>  Let me remind you once again: There are three ViewControllers in the application, one for processing photos or snapshots, one for processing an online video stream, and a third for setting up the network. <br><br>  Let's start with the third.  In it you can choose one of two models YOLOv3-tiny or YOLOv3-416, choose confidence threshold and IoU threshold, you can also enable or disable online anti-aliasing. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/zq/tz/sbzqtzy6hai51objkormfzvtbuq.jpeg"></div><br>  Now let's see how the trained neuron works with real images, for this we take a photo from the gallery and pass it through the network.  The picture below shows the results of YOLOv3-tiny with different settings. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nr/j3/fj/nrj3fjpw0yvxgl2cigujbcb-1p4.png"></div><br>  <i>Different operating modes of YOLOv3-tiny.</i>  <i>The left picture shows the usual mode of operation.</i>  <i>On the middle - the threshold IoU = 1 i.e.</i>  <i>as if Non-max suppression is missing.</i>  <i>On the right is a low threshold of object confidence, i.e.</i>  <i>all possible bounding boxes are displayed.</i> <br><br>  The following is the result of YOLOv3-416.  You can notice that, compared to YOLOv3-tiny, the resulting frames are more correct, as well as smaller objects in the image are recognized, which corresponds to the work of the third output layer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wc/nj/xq/wcnjxqeygnuriffqpatmtvevyfo.png"></div><br>  <i>Image processed using YOLOv3-416.</i> <br><br>  When the online operating mode was turned on, each frame was processed and a prediction was made for it, <b>tests were carried out on the iPhone XS,</b> so the result was quite acceptable for both network options.  <b>YOLOv3-tiny produces an average of 30 - 32 fps, YOLOv3-416 - from 23 to 25 fps.</b>  The device on which it was tested is quite productive, so on earlier models the results may differ, in which case of course it is preferable to use YOLOv3-tiny.  Another important point: yolo-tiny.mlmodel (YOLOv3-tiny) takes about 35 MB, while yolo.mlmodel (YOLOv3 -16) weighs about 250 MB, which is a very significant difference. <br><br><h2>  Conclusion </h2><br>  As a result, an iOS application was written that with the help of a neural network can recognize objects in the image.  We saw how to work with the CoreML library and how to use it to execute various pre-trained models (by the way, you can also train with it).  The object recognition problem was solved using the YOLOv3 network.  On the iPhone XS, this network (YOLOv3-tiny) is capable of processing images at a frequency of ~ 30 frames per second, which is enough to work in real time. <br><br>  The full application code can be viewed on <a href="https://github.com/moonl1ght/iOS-ObjectDetection">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/460869/">https://habr.com/ru/post/460869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460859/index.html">IThink # 3 Conference in Kharkov - based on WWDC 2019</a></li>
<li><a href="../46086/index.html">Non-working Enterprise 2.0 and Five Million for one comment</a></li>
<li><a href="../460861/index.html">JavaScript lexical scope and closure</a></li>
<li><a href="../460865/index.html">People on the moon. Sources</a></li>
<li><a href="../460867/index.html">Sourcery to automatically convert to Realm object structures</a></li>
<li><a href="../46087/index.html">Russian application names in Django</a></li>
<li><a href="../460873/index.html">Why Turok: Dinosaur Hunter for N64 is years ahead of its time</a></li>
<li><a href="../460875/index.html">How we at QIWI came to a common style of interaction between View and ViewModel within MVVM</a></li>
<li><a href="../460877/index.html">Kubernetes Dailymotion Adventure: Building Infrastructure in the Clouds + on-premises</a></li>
<li><a href="../460879/index.html">DUMP Kazan 2019 - Tatarstan Developers Conference. We accept applications for reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>