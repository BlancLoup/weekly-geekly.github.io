<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>US Visa: My first iPhone app</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why, exactly? 
 Having a Mac and iPhone, don't try to write a mobile application? Somehow wrong. The benefit here turned up the problem, which is perf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>US Visa: My first iPhone app</h1><div class="post__text post__text-html js-mediator-article"><h1>  Why, exactly? </h1><br>  Having a Mac and iPhone, don't try to write a mobile application?  Somehow wrong.  The benefit here turned up the problem, which is perfectly laid down in the subject, as very useful and at the same time not very difficult to implement.  So, I plunged into Objective-C and Cocoa. <br><a name="habracut"></a><br><h1>  Disclaimer </h1><br>  Please remember that not only my first iOS application, but also the first Objective-C application in principle.  I never pretend to either the quality of implementation or efficiency, but I want to say that it turned out to be a very holistic, simple example that gives an idea about Objective-C and development for iOS as a whole.  Especially for those who do not know this language at all. <br><br><h1>  Disclaimer 2 </h1><br>  This post was originally published as an article in The Pragmatic Bookshelf Magazine in English - <a href="http://pragprog.com/magazines/2012-09/us-visa-my-first-iphone-app/">US Visa: My First iPhone App</a> .  The Russian version published here is not an exact translation of the journal version, since it was written as a separate text a little later. <br><br><h1>  "Houston!  We have a problem!" </h1><br>  Over the past year I have been forced to apply for a US visa at the embassy in London several times.  Every time I was told that specifically in my case ‚Äúadministrative processing‚Äù is required.  Documents are accepted from you, but then they give a number (batch number) instead of a visa and say periodically to look at their website, where there is a PDF, in which you should look for this number for instructions on what to do next (send more documents, send a passport and etc.).  Click on the <a href="http://photos.state.gov/libraries/unitedkingdom/164203/cons-visa/admin_processing_dates.pdf">link with the official PDF</a> , open the file, press CTRL-F, enter the number (batch number) and go ahead. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea of ‚Äã‚Äãautomation arose - to make an application for an iPhone, into which it can drive the application number once, and then with one click on the button to receive the visa processing status.  The application must be able to download a PDF file, parse it and extract the data on the application. <br><br><h1>  What if I have windows? </h1><br>  All is not lost.  Objective-C can be run on Windows through Cygwin or MinGW.  Moreover, the <a href="http://www.gnustep.org/">GNUstep</a> project makes it possible to use the AppKit and Foundation libraries for writing graphical programs in Windows in Objective-C.  Alas, I will not dive so deep in this article.  We will make only the application running on the command line.  It will be able to download PDF and parse it.  You can build the application on both Windows and Mac.  After that, we will use virtually no changes to the modules of this application to create a full-fledged program for iOS.  But, alas, this is only for Mac owners.  You can, of course, put Hackintosh on a virtual machine and drive an application on an iPhone simulator in Xcode, but it‚Äôs unlikely to load it into a real iPhone without a real Mac. <br><br><h1>  Installing GNUstep under Windows </h1><br>  I found two great posts: <br><ul><li>  " <a href="http://solarianprogrammer.com/2011/09/14/learn-objective-c-on-windows/">Learn Objective-C on Windows</a> " - How to install GNUstep and try a minimal application. </li><li>  <a href="http://solarianprogrammer.com/2012/03/21/clang-objective-c-windows/">Clang and Objective-C on Windows</a> - How to build a fresh Clang compiler for Windows.  Unfortunately, GCC, currently running with GNUstep, does not support the level of Objective-C required by Apple.  In addition, Apple has completely switched to Clang since some time.  So, it is necessary to build Clang, since it doesn‚Äôt yet have a Windows installer.  I just followed one to one of the instructions from the post, and everything fell without problems. </li></ul><br><h1>  It would be nice to get acquainted with Objective-C and iOS API </h1><br>  I didn't know anything about Objective-C, except rumors about his unusual approach to memory management, so I had to scroll through the following books. <br><br>  <b>Warning</b> : The <i>links below contain my personal affiliate program number with Amazon.</i>  <i>From possible purchases made after clicking on these links, I can get a small percentage.</i>  <i>If this does not suit you, please do not click on the links, or manually ‚Äúclean‚Äù the URL through cut-paste.</i>  <i>Thank you for understanding.</i> <br><br>  1. <a href="http://www.amazon.co.uk/gp/product/B007OWBAB0/ref%3Das_li_qf_sp_asin_tl%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3DB007OWBAB0">iOS Programming: The Big Nerd Ranch Guide, 3 / e (Big Nerd Ranch Guides)</a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br> <a href="http://www.amazon.co.uk/gp/product/B007OWBAB0/ref%3Das_li_qf_sp_asin_il%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3DB007OWBAB0"><img src="http://ws.assoc-amazon.co.uk/widgets/q?_encoding=UTF8&amp;Format=_SL160_&amp;ASIN=B007OWBAB0&amp;MarketPlace=GB&amp;ID=AsinImage&amp;WS=1&amp;tag=prodiy-21&amp;ServiceVersion=20070822"></a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br>  2. <a href="http://www.amazon.co.uk/gp/product/0321706285/ref%3Das_li_qf_sp_asin_tl%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3D0321706285">Objective-C Programming: The Big Nerd Ranch Guide (Big Nerd Ranch Guides)</a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br> <a href="http://www.amazon.co.uk/gp/product/0321706285/ref%3Das_li_qf_sp_asin_il%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3D0321706285"><img src="https://habrastorage.org/getpro/habr/post_images/fe0/1c8/de0/fe01c8de0868e113ad9e86ec46b50696.jpg"></a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br>  3. <a href="http://www.amazon.co.uk/gp/product/B006GFZ288/ref%3Das_li_qf_sp_asin_tl%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3DB006GFZ288">Programming in Objective-C (4th Edition) (Developer's Library)</a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br> <a href="http://www.amazon.co.uk/gp/product/B006GFZ288/ref%3Das_li_qf_sp_asin_il%3Fie%3DUTF8%26tag%3Dprodiy-21%26linkCode%3Das2%26camp%3D1634%26creative%3D6738%26creativeASIN%3DB006GFZ288"><img src="https://habrastorage.org/getpro/habr/post_images/09b/525/071/09b525071dca43e7d118a141e856c59b.jpg"></a> <img src="https://habrastorage.org/getpro/habr/post_images/7cd/aab/1c0/7cdaab1c0c170613f70b43a5c5bec1bf.gif" width="1" height="1"><br><br>  And there is one magical free document - ‚Äú <a href="http://pierre.chachatelier.fr/programmation/fichiers/cpp-objc-en.pdf">From C ++ to Objective-C</a> ‚Äù. <br><br>  So, the task is divided into three main parts: <br><ul><li>  PDF parser </li><li>  PDF download (it is desirable to do it without reference to the interface) </li><li>  IOS interface </li></ul><br>  After getting acquainted with Objective-C, I can say that for a less experienced developer in C or C ++, especially if I have experience in developing UI (I used to tinker a lot with Delphi / C ++ Builder), ‚Äúmove in‚Äù in Objective- C and Cocoa is easy.  It is enough to focus on a very unusual semi-manual memory management model (especially after RAII in C ++ and garbage collection in Java).  Objective-C itself manages memory, but control over the counting of references to objects for their proper release lies with you.  It is necessary to understand the principle, otherwise memory leaks are inevitable.  I was exactly like that at the beginning.  The benefit of the excellent profiling tools in Xcode allow you to identify major problems almost immediately. <br><br>  Below I will give a few personal subjective impressions, as a newcomer to Objective-C and Cocoa.  It is unlikely that it will be interesting if you already have experience in them, but if not, I think it will be interesting. <br><br>  For a start, it's interesting to see how the names of member functions of a class are formed in Objective-C.  It is almost like a human language.  If I say in English in the Objective-C: <br><br><pre><code class="hljs objectivec">+ (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)findInPortion:(<span class="hljs-built_in"><span class="hljs-built_in">NSMutableData</span></span> *)someData needle:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)aNeedle andAddTo:(<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>*)aList { ... }</code> </pre> <br>  If you read this code from left to right from top to bottom, you get an almost complete sentence.  Formally, the full name of this method is <code>findInPortion:needle:andAddTo:</code>  The arguments are named, and their names are part of the full name of the method.  If it is correct to give variable argument names ( <code>someData</code> , <code>aNeedle</code> and <code>aList</code> ), then you can actually write in English.  Of course, this is all a rather ‚Äúverbose‚Äù approach, but the fantastic prediction system in Xcode when typing in the code allows you to quickly and easily fill in all these momentum.  Note also that the traditional alignment when splitting long strings occurs by a colon, separating the formal name of the parameter from the variable representing it. <br><br>  In Objective-C, unconventional syntax for calling methods.  For example, instead of: <br><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>* list = <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>.alloc.init;</code> </pre><br>  is written: <br><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>* list = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> alloc] init];</code> </pre><br>  It looks weird, but it's a matter of habit.  Again, the code prediction system as you type allows you to enter square brackets even almost physically without stuffing them. <br><br>  Objective-C and Cocoa are actively using several programming patterns that you simply need to master.  For example, delegates.  They are everywhere in Cocoa.  A delegate is a class that contains callbacks.  Together, the transmission of a bundle of individual functions or methods is simply transferred to a single object that implements all the required callbacks.  For example, I used the standard <a href="https://developer.apple.com/library/mac/">NSURLConnection</a> class to download a PDF.  This class requires the delegate <a href="https://developer.apple.com/library/mac/">NSURLConnectionDelegate to</a> be given to it, whose methods are called on various events during the download process. <br><br>  So, a couple of weeks of evening vigils for the books, and I sketched the skeleton of my first application.  But it was only the first part of Marlezonsky ballet.  Next, it was necessary to deal with the format of PDF. <br><br><h1>  PDF parser </h1><br>  As already mentioned, the file containing information from the embassy, ‚Äã‚Äãin PDF format.  A description of this format is available on <a href="http://www.adobe.com/devnet/pdf/pdf_reference_archive.html">the Adobe website</a> .  I used the document " <a href="http://wwwimages.adobe.com/www.adobe.com/content/dam/Adobe/en/devnet/pdf/pdfs/pdf_reference_archives/PDFReference.pdf">PDF Reference third edition, Version 1.4</a> ". <br><br>  Parsing PDF I have implemented very Kondovo.  Since the data comes in chunks, we will analyze the document in parts, sequentially.  Each new piece of data is added to the buffer and we try to parse the PDF format in it.  First we look for fragments framed in <code>stream</code> and <code>endstream</code> .  The content of each such block is ‚Äúexpanded‚Äù through <code>zlib/inflate</code> .  After this is a clean text, and we are looking for our batch number in it, of course, taking into account the PDF markup language.  If the number is found, then print it and go to the next block. <br><br>  The main steps of the parser: <br><ol><li>  If there is a block in data currently received, limited by <code>stream\r\n</code> and <code>endstream\r\n</code> tags, then we cut it out of the buffer and <code>zlib/inflate</code> via <code>zlib/inflate</code> . </li><li>  Decompressed in the first step is a text block.  We need to find in it fragments framed with the tags <code>BT\r\n</code> (Begin Text) and <code>ET\r\n</code> (End Text).  Find all such blocks and combine them into a list of strings. </li><li>  Inside each line found in step 2, we delete the substrings that are not surrounded by parentheses.  Everything around the parentheses is service information, and we do not need it. </li><li>  So, we have isolated the pure text from PDF'ki.  Logically, the information in this file is organized in a table with three columns: application number (batch number), status and date.  Alas, among this there are also page headers.  To deselect them, we will see that if the current line looks like a batch number (11 digits), then the status line and the date string always follow it.  We take them and wait for the new batch number again. </li></ol><br><br>  As I said, the parsing is sharpened for a specific file, and if it is changed at the embassy, ‚Äã‚Äãthen everything will break.  If you at least use regular expressions, it will be much more flexible, but I will leave this to readers for self-study. <br><br>  <b>SUPPLEMENT</b> .  In the process of working on the article, an idea appeared to make a special web service, referring to which, using simple URLs, you can receive data about the application, and the entire ‚Äúkitchen‚Äù for parsing PDFs occurs ‚Äúon the cloud‚Äù.  Dr.Dobb's recently published my article, <a href="http://www.drdobbs.com/cloud/restful-web-service-in-go-powered-by-the/240006401">RESTful Web Service in Go Powered by the Google App Engine</a> , describing this approach.  Those interested can ‚Äúfinish‚Äù the application to work through this web service.  You can generally do it cleverly: first turn to the web service, and if there is an answer from him, then finish at that, and if not, start the process of self-downloading and parsing the PDF. <br><br><h1>  Command line application </h1><br>  So, we know almost everything to write an application that will download a PDF and extract information from it on our application.  The application will work from the command line.  It can be collected from on a Mac, and on Windows via GNUstep and Clang.  Further, the source files of this application will be used unchanged for the iOS version. <br><br>  Files: <br><ul><li>  <code>BatchPDFParser.m</code> (and <code>.h</code> ) - PDF parser. </li><li>  <code>NSURLConnectionDirectDownload.m</code> (and <code>.h</code> ) - Downloader.  There is a ‚Äúhangover‚Äù for <code>NSURLConnection</code> (initialization, delegates, event loop). </li><li>  <code>DirectDownloadDelegate.m</code> (and <code>.h</code> ) - Delegate for <code>NSURLConnection</code> , accepting calls at various points in the download. </li><li>  <code>ViewController.m</code> - <code>ViewController.m</code> prototype.  This is the ‚Äúlayer‚Äù between download and future graphical user interface.  OSX and iOS use the concept of MVC (Model-View-Controller).  The ‚Äúcontroller‚Äù provides the connection between the interface elements and the business logic of the application.  The current controller mainly contains stubs, which will be implemented in the full graphical version. </li><li>  <code>main-cli.m</code> - Entry point. </li></ul><br><h2>  BatchPDFParser.h </h2><br>  This file contains the declaration of the <code>Batch</code> class, which contains information about updating the status of the application, and the <code>BatchPDFParser</code> class, which implements the <code>findInPortion:needle:andAddTo:</code> method (by the way, this is a static class method, see <code>+</code> beginning of the line?). <br><br><pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Batch</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *batchNumber, *status, *date; } <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (atomic, <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* batchNumber, *status, *date; <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BatchPDFParser</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bool</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">findInPortion</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableData</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">needle</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">needle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">andAddTo</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableArray</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><h2>  BatchPDFParser.m </h2><br>  In this file, the implementation of the PDF parser. <br><br><pre> <code class="hljs scala">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Foundation</span></span>/<span class="hljs-type"><span class="hljs-type">Foundation</span></span>.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"BatchPDFParser.h"</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"zlib.h"</span></span> <span class="hljs-meta"><span class="hljs-meta">@implementation</span></span> <span class="hljs-type"><span class="hljs-type">Batch</span></span> <span class="hljs-meta"><span class="hljs-meta">@synthesize</span></span> batchNumber, status, date; - (void) dealloc { [batchNumber release]; [status release]; [date release]; [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> dealloc]; } <span class="hljs-meta"><span class="hljs-meta">@end</span></span> <span class="hljs-meta"><span class="hljs-meta">@implementation</span></span> <span class="hljs-type"><span class="hljs-type">BatchPDFParser</span></span></code> </pre><br>  The <code>findInData:fromOffset:needle:</code> method searches for a substring in this data block (of type <code>strstr()</code> ).  The search is primitive, and it can be accelerated, for example, by implementing the KMP algorithm. <br><br><pre> <code class="hljs cpp">+ (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) findInData:(NSMutableData *)data fromOffset:(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)offset needle:(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>)needle { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> needleSize = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(needle); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bytes = [data mutableBytes]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bytesLength = [data length] - needleSize; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bytesLength;) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> current = <span class="hljs-built_in"><span class="hljs-built_in">memchr</span></span>(bytes + i, needle[<span class="hljs-number"><span class="hljs-number">0</span></span>], bytesLength - i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(current, needle, needleSize) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current - bytes; i = current - bytes + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br>  The <code>isBatchNumber:number:</code> method <code>isBatchNumber:number:</code> checks if the string is a request number (batch number): <br><br><pre> <code class="hljs cs">+ (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) isBatchNumber:(NSString*)number { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [number longLongValue]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">20000000000L</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; <span class="hljs-number"><span class="hljs-number">29000000000L</span></span>; }</code> </pre><br>  The <code>findBatchNumberInChunk:needle:andAddTo:</code> searches for fragments framed with <code>BT</code> and <code>ET</code> tags.  In them highlights the text in parentheses, and already among the found out specifically identifies the application number, status line and date string. <br><br><pre> <code class="hljs objectivec">+ (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) findBatchNumberInChunk:(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*)chunk needle:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)needle andAddTo:(<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>*)list { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { waitBT, waitText, insideText } state = waitBT; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { waitBatchNumber, waitStatus, waitDate } batchParserState = waitBatchNumber; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span>* line = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span> alloc] init]; Batch* batch = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*chunk) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == waitBT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chunk[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'B'</span></span> &amp;&amp; chunk[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-string"><span class="hljs-string">'T'</span></span>) { state = waitText; [line deleteCharactersInRange:<span class="hljs-built_in"><span class="hljs-built_in">NSMakeRange</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, [line length])]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == waitText) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chunk[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'('</span></span>) { state = insideText; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chunk[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'E'</span></span> &amp;&amp; chunk[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-string"><span class="hljs-string">'T'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (batchParserState == waitBatchNumber) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> isBatchNumber:line]) { [batch autorelease]; batch = [[Batch alloc] init]; batch.batchNumber = line; batchParserState = waitStatus; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (batchParserState == waitStatus) { batch.status = line; batchParserState = waitDate; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (batchParserState == waitDate) { batch.date = line; batchParserState = waitBatchNumber; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([batch.batchNumber isEqualToString:needle]) { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* pair = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%@\n%@"</span></span>, batch.status, batch.date]; [list addObject:pair]; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Found match: '%@' '%@' '%@'"</span></span>, batch.batchNumber, batch.status, batch.date); found = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } } [line autorelease]; line = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span> alloc] init]; state = waitBT; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == insideText) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chunk[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">')'</span></span>) { state = waitText; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> c[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { chunk[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> }; [line appendString:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String:&amp;c[<span class="hljs-number"><span class="hljs-number">0</span></span>]]]; } } chunk += <span class="hljs-number"><span class="hljs-number">1</span></span>; } [line release]; [batch release]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> found; }</code> </pre><br>  Now the main method <code>findInPortion:needle:andAddTo:</code>  Here, pieces are framed, framed with <code>stream\r\n</code> and <code>endstream\r\n</code> tags, the content is expanded using <code>zlib/inflate</code> and passed to <code>findBatchNumberInChunk:needle:andAddTo:</code> for analysis. <br><br><pre> <code class="hljs cpp">+ (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)findInPortion:(NSMutableData *)portion needle:(NSString*)needle andAddTo:(NSMutableArray*)<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> streamStartMarker = <span class="hljs-string"><span class="hljs-string">"stream\x0d\x0a"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> streamStopMarker = <span class="hljs-string"><span class="hljs-string">"endstream\x0d\x0a"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> beginPosition = [self findInData:portion fromOffset:<span class="hljs-number"><span class="hljs-number">0</span></span> needle:streamStartMarker]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (beginPosition == <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> endPosition = [self findInData:portion fromOffset:beginPosition needle:streamStopMarker]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endPosition == <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> blockLength = endPosition + <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(streamStopMarker) - beginPosition; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zipped = [portion mutableBytes] + beginPosition + <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(streamStartMarker); z_stream zstream; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;zstream, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zstream)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zippedLength = blockLength - <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(streamStartMarker) - <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(streamStopMarker); zstream.avail_in = zippedLength; zstream.avail_out = zstream.avail_in * <span class="hljs-number"><span class="hljs-number">10</span></span>; zstream.next_in = (Bytef*)zipped; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> unzipped = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(zstream.avail_out); zstream.next_out = (Bytef*)unzipped; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zstatus = inflateInit(&amp;zstream); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zstatus == Z_OK) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> inflateStatus = inflate(&amp;zstream, Z_FINISH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inflateStatus &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { found = found || [BatchPDFParser findBatchNumberInChunk:unzipped needle:needle andAddTo:<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { NSLog(@<span class="hljs-string"><span class="hljs-string">"inflate() failed, error %d"</span></span>, inflateStatus); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { NSLog(@<span class="hljs-string"><span class="hljs-string">"Unable to initialize zlib, error %d"</span></span>, zstatus); } <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(unzipped); inflateEnd(&amp;zstream); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cutLength = endPosition + <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(streamStopMarker); [portion replaceBytesInRange:NSMakeRange(<span class="hljs-number"><span class="hljs-number">0</span></span>, cutLength) withBytes:<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> length:<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> found; } @end</code> </pre><br><h2>  DirectDownloadViewDelegate.h </h2><br>  <code>NSURLConnectionDelegate</code> delegate <code>NSURLConnectionDelegate</code> : <br><br><pre> <code class="hljs pgsql">@protocol DirectDownloadViewDelegate&lt;NSObject&gt; - (<span class="hljs-type"><span class="hljs-type">void</span></span>)setProgress: (<span class="hljs-type"><span class="hljs-type">float</span></span>)progress; - (<span class="hljs-type"><span class="hljs-type">void</span></span>)appendStatus: (NSString*)status; - (<span class="hljs-type"><span class="hljs-type">void</span></span>)setCompleteDate: (NSString*)<span class="hljs-type"><span class="hljs-type">date</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h2>  DirectDownloadDelegate.h </h2><br>  Actually, the delegate of <code>NSURLConnectionDelegate</code> . <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#import</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">DirectDownloadViewDelegate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>" @<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> DirectDownloadDelegate : NSObject { <span class="hljs-selector-tag"><span class="hljs-selector-tag">NSError</span></span> *<span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">BOOL</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">done</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">BOOL</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">found</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">NSMutableData</span></span> *<span class="hljs-selector-tag"><span class="hljs-selector-tag">receivedData</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">expectedBytes</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">receivedBytes</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">id</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">DirectDownloadViewDelegate</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">viewDelegate</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">NSString</span></span>* <span class="hljs-selector-tag"><span class="hljs-selector-tag">needle</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">id</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">initWithNeedle</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:(NSString</span></span>*)<span class="hljs-selector-tag"><span class="hljs-selector-tag">aNeedle</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">andViewDelegate</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:(id</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">DirectDownloadViewDelegate</span></span>&gt;)<span class="hljs-selector-tag"><span class="hljs-selector-tag">aViewDelegate</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">property</span></span> (atomic, readonly, getter=isDone) BOOL done; @<span class="hljs-keyword"><span class="hljs-keyword">property</span></span> (atomic, readonly, getter=isFound) BOOL found; @<span class="hljs-keyword"><span class="hljs-keyword">property</span></span> (atomic, readonly) NSError *error; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h2>  DirectDownloadDelegate.m </h2><br>  And its implementation: <br><br><pre> <code class="hljs scala">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Foundation</span></span>/<span class="hljs-type"><span class="hljs-type">Foundation</span></span>.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"DirectDownloadDelegate.h"</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"BatchPDFParser.h"</span></span> <span class="hljs-meta"><span class="hljs-meta">@implementation</span></span> <span class="hljs-type"><span class="hljs-type">DirectDownloadDelegate</span></span> <span class="hljs-meta"><span class="hljs-meta">@synthesize</span></span> error, done, found;</code> </pre><br>  The <code>initWithNeedle:andViewDelegate:</code> constructor creates a delegate and parameterizes it with another delegate, <code>DirectDownloadViewDelegate</code> , which will be used for the screen update task.  Here, by the way, the first time we see the destructor, <code>(void) dealloc:</code> . <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) initWithNeedle:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)aNeedle andViewDelegate:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;DirectDownloadViewDelegate&gt;)aViewDelegate { viewDelegate = aViewDelegate; [viewDelegate <span class="hljs-keyword"><span class="hljs-keyword">retain</span></span>]; needle = [[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> alloc] initWithString:aNeedle]; receivedData = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableData</span></span> alloc] init]; expectedBytes = receivedBytes = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; found = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) dealloc { [error release]; [receivedData release]; [needle release]; [viewDelegate release]; [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> dealloc]; }</code> </pre><br>  <code>connectionDidFinishLoading:</code> called when the connection is complete. <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) connectionDidFinishLoading:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection { done = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Connection finished"</span></span>); }</code> </pre><br>  <code>connection:didFailWithError:</code> method <code>connection:didFailWithError:</code> Causes an error when downloading a file. <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection didFailWithError:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *)anError { error = [anError <span class="hljs-keyword"><span class="hljs-keyword">retain</span></span>]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> connectionDidFinishLoading:connection]; }</code> </pre><br>  The <code>connection:didReceiveData:</code> called when a new portion of data from the channel has been received.  We add each such batch to the buffer, update the download progress indicator (via another delegate, <code>viewDelegate</code> ), then try to isolate data fragments using PDF format, and finally print what was found. <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection didReceiveData:(<span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *)someData { receivedBytes += [someData length]; [viewDelegate setProgress:(receivedBytes / expectedBytes)]; [receivedData appendData:someData]; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>* list = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> alloc] init]; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> foundInCurrentPortion = [BatchPDFParser findInPortion:receivedData needle:needle andAddTo:list]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> batch <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"[%@]"</span></span>, [batch stringByReplacingOccurrencesOfString:<span class="hljs-string"><span class="hljs-string">@"\n"</span></span> withString:<span class="hljs-string"><span class="hljs-string">@"\\n"</span></span>]); [viewDelegate appendStatus:batch]; } [list release]; found = found || foundInCurrentPortion; }</code> </pre><br>  The last callback of the <code>NSURLConnectionDelegate</code> delegate that we use is called <code>connection:didReceiveResponse:</code>  It is called when an HTTP HTTP response is received, containing headers.  We take the length of the future file from the Content-Length header in order to update the download indicator later. <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection didReceiveResponse:(<span class="hljs-built_in"><span class="hljs-built_in">NSHTTPURLResponse</span></span> *)someResponse { <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *headers = [someResponse allHeaderFields]; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"[didReceiveResponse] response headers: %@"</span></span>, headers); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (headers) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([headers objectForKey: <span class="hljs-string"><span class="hljs-string">@"Content-Length"</span></span>]) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Content-Length: %@"</span></span>, [headers objectForKey: <span class="hljs-string"><span class="hljs-string">@"Content-Length"</span></span>]); expectedBytes = [[headers objectForKey: <span class="hljs-string"><span class="hljs-string">@"Content-Length"</span></span>] floatValue]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"No Content-Length header found"</span></span>); } } }</code> </pre><br><h2>  NSURLConnectionDirectDownload.h </h2><br>  This file contains the <code>donwloadAtURL:searching:viewingOn:</code> , which we add to the <code>NSURLConnection</code> class.  The interesting thing is that through the concept of categories in Objective-C, you can ‚Äúadd‚Äù new methods to existing classes.  Here we add the category <code>DirectDownload</code> to the <code>NSURLConnection</code> class. <br><br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> NSURLConnection (DirectDownload) + (BOOL) downloadAtURL:(NSURL *)url searching:(NSString*)batchNumber viewingOn:(id)viewDelegate; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h2>  NSURLConnectionDirectDownload.m </h2><br>  Well, the final part of the download PDF.  The <code>donwloadAtURL:searching:viewingOn:</code> creates a connection and starts downloading.  Then there is a wait in the <code>NSRunLoop</code> cycle until the download is complete.  This cycle allows the application to respond to events during the download.  Please note that this download is still not tied to the graphical interface.  It uses the <code>viewDelegate</code> delegate to communicate with the application ‚Äúface‚Äù. <br><br><pre> <code class="hljs vbscript">#import &lt;Foundation/Foundation.h&gt; #import <span class="hljs-string"><span class="hljs-string">"DirectDownloadDelegate.h"</span></span> @implementation NSURLConnection (DirectDownload) + (BOOL) downloadAtURL:(NSURL *)url searching:(NSString*)batchNumber viewingOn:(id)viewDelegate { NSMutableURLRequest *<span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = [[NSMutableURLRequest alloc] initWithURL:url]; DirectDownloadDelegate *delegate = [[[DirectDownloadDelegate alloc] initWithNeedle:batchNumber andViewDelegate:viewDelegate] autorelease]; NSURLConnection *connection = [[NSURLConnection alloc] initWithRequest:<span class="hljs-built_in"><span class="hljs-built_in">request</span></span> delegate:delegate]; [<span class="hljs-built_in"><span class="hljs-built_in">request</span></span> release]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ([delegate isDone] == NO) { [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:<span class="hljs-number"><span class="hljs-number">1.0</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([delegate isFound] != YES) { [viewDelegate appendStatus:@<span class="hljs-string"><span class="hljs-string">"This batch number is not found."</span></span>]; NSLog(@<span class="hljs-string"><span class="hljs-string">"This batch number is not found."</span></span>); } NSLog(@<span class="hljs-string"><span class="hljs-string">"PDF is processed"</span></span>); [connection release]; NSDateFormatter* dateFormatter = [[NSDateFormatter alloc] init]; dateFormatter.dateFormat = @<span class="hljs-string"><span class="hljs-string">"yyyy/MM/dd HH:mm:ss"</span></span>; NSString* lastUpdateDate = [dateFormatter stringFromDate:[NSDate <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>]]; NSLog(@<span class="hljs-string"><span class="hljs-string">"Last update at: %@"</span></span>, lastUpdateDate); [viewDelegate setCompleteDate:lastUpdateDate]; [dateFormatter release]; NSError *<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> = [delegate <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> != nil) { NSLog(@<span class="hljs-string"><span class="hljs-string">"Download error: %@"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>); return NO; } return YES; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h2>  ViewController.m </h2><br>  As already mentioned, in the command line application the controller will contain only stubs, which we will implement later in the full version of the program. <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Foundation</span></span>/<span class="hljs-type"><span class="hljs-type">Foundation</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"DirectDownloadViewDelegate.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">IBAction</span></span> void</code> </pre><br>  Empty stub class <code>ViewController</code> . <br><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@interface</span></span> <span class="hljs-type"><span class="hljs-type">ViewController</span></span> : <span class="hljs-type"><span class="hljs-type">NSObject</span></span> &lt;<span class="hljs-type"><span class="hljs-type">DirectDownloadViewDelegate</span></span>&gt; <span class="hljs-meta"><span class="hljs-meta">@end</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"NSURLConnectionDirectDownload.h"</span></span></code> </pre><br>  Address where to download the file. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pdf = <span class="hljs-string"><span class="hljs-string">"http://photos.state.gov/libraries/unitedkingdom/164203/cons-visa/admin_processing_dates.pdf"</span></span>;</code> </pre><br>  And the mock-implementation of the controller class. <br><br><pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewController</span></span></span></span></code> </pre><br>  The test callback <code>appendStatus:</code> is called when the next request update is detected.  Here we just log in, and in the full application we will update the screen form. <br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>) appendStatus:(NSString*)status { NSLog(@"appendStatus(): '%@'", [status stringByReplacingOccurrencesOfString:@"\n" withString:@"\\n"]); // <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> skipped here because <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> required <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the command <span class="hljs-type"><span class="hljs-type">line</span></span> mode. }</code> </pre><br>  Test callback <code>setProgress:</code> called when, after accepting the next piece of data, you need to update the download indicator. <br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>) setProgress:(<span class="hljs-type"><span class="hljs-type">float</span></span>)progress { // <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> skipped here because <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> required <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the command <span class="hljs-type"><span class="hljs-type">line</span></span> mode. }</code> </pre><br>  <code>setCompleteDate:</code> test callback <code>setCompleteDate:</code> called when the PDF parsing is complete.  Here, again, we just log. <br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>) setCompleteDate:(NSString*)<span class="hljs-type"><span class="hljs-type">date</span></span> { NSLog(@"setCompleteDate(): '%@'", <span class="hljs-type"><span class="hljs-type">date</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Some</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> skipped here because <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> required <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the command <span class="hljs-type"><span class="hljs-type">line</span></span> mode. }</code> </pre><br>  Well, the final method that runs everything, <code>updateBatchStatus:</code>  In the full program it will be called when you click on the form.  Here it is called from <code>main()</code> . <br><br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) updateBatchStatus:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)batchNumber { <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *url = [[[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> alloc] initWithString:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithCString:pdf encoding:<span class="hljs-built_in"><span class="hljs-built_in">NSASCIIStringEncoding</span></span>]] autorelease]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> downloadAtURL:url searching:batchNumber viewingOn:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br><h2>  main-cli.m </h2><br>  Run from the command line. <br><br><pre> <code class="hljs kotlin">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> &lt;Foundation/Foundation.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"DirectDownloadDelegate.h"</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ViewController : NSObject &lt;DirectDownloadViewDelegate&gt; - (bool) updateBatchStatus:(NSString*)batchNumber; <span class="hljs-meta"><span class="hljs-meta">@end</span></span> int main(int argc, char *argv[]) { <span class="hljs-meta"><span class="hljs-meta">@autoreleasepool</span></span> { ViewController* viewController = [ViewController alloc]; [viewController updateBatchStatus:[NSString stringWithCString:argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] encoding:NSASCIIStringEncoding]]; [viewController release]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><h2>  Let's try to collect all this and run it? </h2><br>  <code>Makefile</code> for Mac: <br><br><pre> <code class="hljs tex">files = <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>ViewController.m <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>BatchPDFParser.m <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>NSURLConnectionDirectDownload.m <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>DirectDownloadDelegate.m main-cli.m all: build run build: clang -o USVisaTest -DTESTING -framework Foundation -lz <span class="hljs-formula"><span class="hljs-formula">$(files) run: ./USVisaTest 20121456171</span></span></code> </pre><br>  <code>GNUmakefile</code> GNUstep Makefile: <br><br><pre> <code class="hljs tex">include <span class="hljs-formula"><span class="hljs-formula">$(GNUSTEP_MAKEFILES)/common.make TOOL_NAME = USVisa USVisa_OBJC_FILES = </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">../ViewController.m </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">../BatchPDFParser.m </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">../NSURLConnectionDirectDownload.m </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">../DirectDownloadDelegate.m </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">../main-cli.m USVisa_TOOL_LIBS = -lz ADDITIONAL_OBJCFLAGS = -DTESTING CC = clang include $</span></span>(GNUSTEP_MAKEFILES)/tool.make run: ./obj/USVisa 20121456171</code> </pre><br>  Type <code>make</code> .  Windows: <br><br><pre> <code class="hljs vhdl">This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> gnustep-make <span class="hljs-number"><span class="hljs-number">2.6</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'mmake</span></span> print-gnustep-make-help' <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> help. Making <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tool USVisa... Creating obj/USVisa.obj/../... Compiling <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> ViewController.m ... Compiling <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> BatchPDFParser.m ... Compiling <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> NSURLConnectionDirectDownload.m ... Compiling <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> DirectDownloadDelegate.m ... Compiling <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> main-cli.m ... Linking tool USVisa ...</code> </pre><br>  You can run to check the real application: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> run</code> </pre><br>  I got the following: <br><br><pre> <code class="hljs pgsql">This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> gnustep-make <span class="hljs-number"><span class="hljs-number">2.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'mmake print-gnustep-make-help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> help. ./obj/USVisa <span class="hljs-number"><span class="hljs-number">20121456171</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">11.472</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] [didReceiveResponse] response headers: {"Accept-Ranges" = bytes; "Cache-Control" = "max-age=600"; <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> = "keep-alive"; "Content-Length" = <span class="hljs-number"><span class="hljs-number">2237242</span></span>; "Content-Type" = "application/pdf"; <span class="hljs-type"><span class="hljs-type">Date</span></span> = "Tue, 19 Jun 2012 16:27:11 GMT"; ETag = "\"<span class="hljs-number"><span class="hljs-number">4</span></span>b2ca3e41de5ba4ae45670e776edfc3b:<span class="hljs-number"><span class="hljs-number">1339778351</span></span>\""; "Last-Modified" = "Fri, 15 Jun 2012 16:06:15 GMT"; <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> = Apache; } <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">11.604</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] Content-Length: <span class="hljs-number"><span class="hljs-number">2237242</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">12.093</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> match: <span class="hljs-string"><span class="hljs-string">'20121456171'</span></span> <span class="hljs-string"><span class="hljs-string">'send passport &amp; new travel itinerary'</span></span> <span class="hljs-string"><span class="hljs-string">'14-Jun-12'</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">12.104</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] [send passport &amp; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> travel itinerary\n14-Jun<span class="hljs-number"><span class="hljs-number">-12</span></span>] <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">12.111</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] appendStatus(): <span class="hljs-string"><span class="hljs-string">'send passport &amp; new travel itinerary\n14-Jun-12'</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">13.769</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> finished <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">13.774</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] PDF <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> processed <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">13.961</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] Last <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> at: <span class="hljs-number"><span class="hljs-number">2012</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">13.972</span></span> USVisa[<span class="hljs-number"><span class="hljs-number">3420</span></span>] setCompleteDate(): <span class="hljs-string"><span class="hljs-string">'2012/06/19 16:27:13'</span></span></code> </pre><br>  So, everything works: download and parser PDF.  Now let's do a version for iOS.  Alas, only for Mac users. <br><br><h1>  Screen Layout </h1><br>  I made the application extremely simple: one form with an input field, a button and a place to display updates. <br><br><img src="http://demin.ws/images/blog/usvisa/app/usvisa-application-screenshot.png"><br><br>  The download indicator and spinner appear temporarily. <br><br><h2>  ViewController.h </h2><br>  Now it is a complete controller implementation.  Through the <code>TESTING</code> macro, I made a separation between the simplified and full versions. <br><br><pre> <code class="hljs kotlin">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> &lt;Foundation/Foundation.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"DirectDownloadViewDelegate.h"</span></span> #ifdef TESTING #define IBAction void <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ViewController : NSObject &lt;DirectDownloadViewDelegate&gt; <span class="hljs-meta"><span class="hljs-meta">@end</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"ViewController.h"</span></span> #endif #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"NSURLConnectionDirectDownload.h"</span></span> static char <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pdf = <span class="hljs-string"><span class="hljs-string">"http://photos.state.gov/libraries/unitedkingdom/164203/cons-visa/admin_processing_dates.pdf"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@implementation</span></span> ViewController #ifndef TESTING <span class="hljs-meta"><span class="hljs-meta">@synthesize</span></span> updateProgressView, batchNumberTextField, statusTextView, lastUpdatedLabel, updateButton; #endif NSString* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PropertiesFilename = @<span class="hljs-string"><span class="hljs-string">"Properties"</span></span>; NSString *pathInDocumentDirectory(NSString *fileName) { NSArray *documentDirectories = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES); NSString *documentDirectory = [documentDirectories objectAtIndex:<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [documentDirectory stringByAppendingPathComponent:fileName]; }</code> </pre><br>  Now the callback <code>appendStatus:</code> not only logs, but also updates the screen form. <br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>) appendStatus:(NSString*)status { NSLog(@"appendStatus(): '%@'", [status stringByReplacingOccurrencesOfString:@"\n" withString:@"\\n"]); #ifndef TESTING <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[statusTextView <span class="hljs-type"><span class="hljs-type">text</span></span>] length] == <span class="hljs-number"><span class="hljs-number">0</span></span>) [statusTextView setText:@"Status:\n"]; [statusTextView setText:[[statusTextView <span class="hljs-type"><span class="hljs-type">text</span></span>] stringByAppendingString:status]]; [statusTextView setText:[[statusTextView <span class="hljs-type"><span class="hljs-type">text</span></span>] stringByAppendingString:@"\n"]]; #endif }</code> </pre><br>  <code>setProcess:</code> updates the download indicator. <br><br><pre> <code class="hljs cpp">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) setProgress:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)progress { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> TESTING updateProgressView.progress = progress; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br>  <code>setCompleteDate:</code> displays the date of the update in a text field on the screen. <br><br><pre> <code class="hljs lua">- (void) setCompleteDate:(NSString*)<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> { NSLog(@<span class="hljs-string"><span class="hljs-string">"setCompleteDate(): '%@'"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>); #ifndef TESTING [lastUpdatedLabel setText:<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>]; #endif } - (bool) updateBatchStatus:(NSString*)batchNumber { NSURL *url = <span class="hljs-string"><span class="hljs-string">[[[NSURL alloc] initWithString:[NSString stringWithCString:pdf encoding:NSASCIIStringEncoding]]</span></span> autorelease]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [NSURLConnection downloadAtURL:url searching:batchNumber viewingOn:self]; }</code> </pre><br>  Now a few calls specific to iOS.  The <code>viewDidLoad:</code> method <code>viewDidLoad:</code> called by the system when the screen form is loaded and ready to use.  Here we manually create a spinning slider and correct the heights of the two elements, buttons and input fields, as for some reason Xcode Interface Builder does not allow changing them when designing a form. <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">TESTING</span></span> - (void)viewDidLoad { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewDidLoad]; // <span class="hljs-type"><span class="hljs-type">Do</span></span> any additional setup after loading the view, typically from a nib. spinnerActivityIndicatorView = [[<span class="hljs-type"><span class="hljs-type">UIActivityIndicatorView</span></span> alloc] initWithActivityIndicatorStyle:<span class="hljs-type"><span class="hljs-type">UIActivityIndicatorViewStyleWhiteLarge</span></span>]; [spinnerActivityIndicatorView setColor:[<span class="hljs-type"><span class="hljs-type">UIColor</span></span> blueColor]]; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> size = [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> view] frame].size; [spinnerActivityIndicatorView setCenter:<span class="hljs-type"><span class="hljs-type">CGPointMake</span></span>(size.width / <span class="hljs-number"><span class="hljs-number">2</span></span>, size.height / <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">60</span></span>)]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view addSubview:spinnerActivityIndicatorView]; <span class="hljs-type"><span class="hljs-type">CGRect</span></span> rect = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.updateButton bounds]; rect.size.height += <span class="hljs-number"><span class="hljs-number">10</span></span>; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.updateButton setBounds:rect]; rect = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.batchNumberTextField bounds]; rect.size.height += <span class="hljs-number"><span class="hljs-number">20</span></span>; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.batchNumberTextField setBounds:rect]; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG</span></span> <span class="hljs-type"><span class="hljs-type">NSLog</span></span>(@<span class="hljs-comment"><span class="hljs-comment">"DEBUG mode"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> }</code> </pre><br> <code>viewDidUnload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> called when the form becomes inactive. </font></font><br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidUnload { [super viewDidUnload]; // <span class="hljs-keyword"><span class="hljs-keyword">Release</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> retained subviews <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the main <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>. }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code>shouldAutorotateToInterfaceOrientation:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to control the behavior to change the orientation of the device. </font><font style="vertical-align: inherit;">Here we only allow portrait position, not upside down.</font></font><br><br><pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)shouldAutorotateToInterfaceOrientation:(<span class="hljs-built_in"><span class="hljs-built_in">UIInterfaceOrientation</span></span>)interfaceOrientation { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (interfaceOrientation == <span class="hljs-built_in"><span class="hljs-built_in">UIInterfaceOrientationPortrait</span></span>); } <span class="hljs-meta"><span class="hljs-meta">#endif</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code>launchUpdate:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calls when you click on the button </font></font><code>Update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the form. </font><font style="vertical-align: inherit;">We block the button from pressing again, displaying the download indicator and spinning slider.</font></font><br><br><pre> <code class="hljs pgsql">- (IBAction)launchUpdate:(id)sender { [self setProgress:<span class="hljs-number"><span class="hljs-number">0.0</span></span>]; #ifndef TESTING [updateButton setEnabled: <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>]; [updateProgressView setHidden:<span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>]; NSString* previousStatus = [statusTextView <span class="hljs-type"><span class="hljs-type">text</span></span>]; [statusTextView setText:@""]; NSString* batchNumber = [batchNumberTextField <span class="hljs-type"><span class="hljs-type">text</span></span>]; [spinnerActivityIndicatorView startAnimating]; <span class="hljs-type"><span class="hljs-type">BOOL</span></span> const ok = [self updateBatchStatus:batchNumber]; [spinnerActivityIndicatorView stopAnimating]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ok) { UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Error" message:@"Internet connectivity problem" delegate:self cancelButtonTitle:nil otherButtonTitles:@"OK", nil]; [alert <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>]; [alert <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>]; [statusTextView setText:previousStatus]; } [updateProgressView setHidden:YES]; [updateButton setEnabled: YES]; #endif }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methods </font></font><code>saveProperties:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>loadProperties:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save and restore the contents of the form when you start and stop the application. </font><font style="vertical-align: inherit;">Please note that in order to save the data in a file, you need to ask the system for the position of the intended for this directory.</font></font><br><br><pre> <code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>) saveProperties { NSDictionary *props = [[NSDictionary alloc] initWithObjectsAndKeys: #ifndef TESTING batchNumberTextField.text, @"batchNumberTextField", statusTextView.text, @"statusTextView", lastUpdatedLabel.text, @"lastUpdatedLabel", #endif nil]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (NSString* key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> props) { NSLog(@"%@ - %@", key, [props objectForKey:key]); } NSString* filename = pathInDocumentDirectory(PropertiesFilename); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([props writeToFile:filename atomically:YES] == <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>) NSLog(@"Unable to save properties into file [%@]", filename); [props <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>]; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) loadProperties { NSDictionary *props = [[NSDictionary alloc] initWithContentsOfFile:pathInDocumentDirectory(PropertiesFilename)]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (NSString* key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> props) { NSLog(@"%@ - %@", key, [props objectForKey:key]); } #ifndef TESTING [batchNumberTextField setText:[props objectForKey:@"batchNumberTextField"]]; [statusTextView setText:[props objectForKey:@"statusTextView"]]; [lastUpdatedLabel setText:[props objectForKey:@"lastUpdatedLabel"]]; #endif [props <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>]; } - (IBAction)textFieldReturn:(id)sender { #ifndef TESTING [sender resignFirstResponder]; #endif } -(IBAction)backgroundTouched:(id)sender { #ifndef TESTING [batchNumberTextField resignFirstResponder]; #endif } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Everything!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We reviewed all the main files. </font><font style="vertical-align: inherit;">The application is completely ready. </font><font style="vertical-align: inherit;">You can collect and fill in the device (do not forget to buy a developer license from Apple). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I posted the full project on GitHub - </font></font><a href="https://github.com/begoon/usvisa-app/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usvisa-app</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Comments and thoughts are accepted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can check out the video:</font></font><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/fxKlXDsDANU%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhj-bVfSPVu5ntSOL9C4PyBibBUv6w" frameborder="0" allowfullscreen=""></iframe><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And further! </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are thinking about selling your application for a million copies, you should start with a beautiful icon. </font><font style="vertical-align: inherit;">For applications, you usually need several: 57x57 and 114x114 for the application itself, and 512x512 and 1024x1024 for publishing in the AppStore. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will proceed easier and take the icon from open sources - </font></font><a href="http://en.wikipedia.org/wiki/Great_Seal_of_the_United_States"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Great Seal of the United States</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><img src="http://demin.ws/images/blog/usvisa/app/USVisa-icon-114x114.png"><br><br><h1>  PS </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I decided to write a post about this application after the AppStore censors ‚Äúwrapped‚Äù it, referring to the clause in the rules, which states that applications with minimal functional load that can be implemented via HTML5 will not be allowed. </font><font style="vertical-align: inherit;">Apparently, they no longer want to see applications that fart or simply display a static image of applications. </font><font style="vertical-align: inherit;">One could argue with the censors on the minimum functional load or implementation through HTML5, but I scored. </font><font style="vertical-align: inherit;">Firstly, I personally like the fact that Apple is trying not to miss useless and low-quality applications, and secondly, I already got a lot of pleasure from learning Objective-C, and at the moment I am working on two more applications.</font></font><br><br><h1>  Pps </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soon there will be another article about the development of applications for iOS for beginners, so </font></font><a href="http://demin.ws/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stay tuned</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/150959/">https://habr.com/ru/post/150959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150951/index.html">How to get your web screenshots service - version 1.1</a></li>
<li><a href="../150954/index.html">Combing "Similar posts"</a></li>
<li><a href="../150955/index.html">Kinect for Windows SDK. Part 1. Sensor</a></li>
<li><a href="../150957/index.html">There was a native ŒºTorrent client for Android</a></li>
<li><a href="../150958/index.html">Nostalgia: how ‚Äúsaving on paper‚Äù works</a></li>
<li><a href="../150960/index.html">Changes in the new version of the Twitter API will affect all</a></li>
<li><a href="../150964/index.html">ASUS Announces Discontinuing Eee-PC Netbooks</a></li>
<li><a href="../150965/index.html">LilacServer - a box for creating websites in Java</a></li>
<li><a href="../150966/index.html">Generating Design Ideas with a Genetic Algorithm</a></li>
<li><a href="../150967/index.html">"All day phone" - Motorola has updated the line of RAZR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>