<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are testing the Linux version of PVS-Studio on the Linux Kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since the release of the public Linux version of PVS-Studio, the article about re-checking the Linux kernel has remained only a matter of time. The pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are testing the Linux version of PVS-Studio on the Linux Kernel</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/fec/53e/cf2/fec53ecf27f5499dbf1bb8068af5761a.png"></p><br><br>  Since the release of the public Linux version of PVS-Studio, the article about re-checking the Linux kernel has remained only a matter of time.  The project, which is written by professionals from around the world, which is used by a large number of people in various fields, which is regularly checked and tested with various tools - checking such a project will be a serious test for any static analyzer.  What errors did PVS-Studio manage to find in such conditions? <br><a name="habracut"></a><br><h2>  How to check </h2><br>  We <a href="http://www.viva64.com/ru/b/0299/">have already tested</a> the Linux kernel.  Since then, much has changed - now OS testing is as simple and convenient as checking any other project: <br><br><pre><code class="cpp hljs">pvs-studio-analyzer trace - make pvs-studio-analyzer analyze -o /path/to/report.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -j8</code> </pre> <br>  It took just a few months to adapt and test the analyzer in Linux, which until recently was available only for Windows.  This time it was much easier to check the kernel. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Version 4.9-rc4 (commit bc33b0ca11e3df467777a4fa7639ba488c9d4911) was taken for verification. <br><br>  For writing an article, only general-purpose diagnostics of 1-2 levels were viewed.  It is worth noting the high quality of the code - the density of warnings indicating real flaws is extremely low. <br><br>  For the article, I chose those warnings that are most likely to indicate real errors / typos.  It should be understood that in addition to useful warnings, the analyzer also produces false positives or detects a badly designed or ‚Äúfoul-smelling‚Äù code, which, nevertheless, is not truly erroneous. <br><br>  Unfortunately, the number of false positives under Linux is more than we would like.  I think this is connected with the youth version of the analyzer designed for Linux systems.  We have done and continue to do a great job of minimizing the number of false positives.  The Linux code helped us to become better and make many useful changes to the analyzer, and now I would like to reciprocate. <br><br><h2>  Typos </h2><br>  The most common category of errors associated with the usual typos and <a href="http://www.viva64.com/ru/t/0068/">Copy-Paste</a> .  If you have read our articles before, I think you have already seen this.  They appear in any projects on any operating systems in any languages.  Such errors reveal the potential of a static analyzer: it is much more difficult to find them with other tools.  Let's see how things are with them in the Linux kernel: <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V581/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V581/">V581</a> The conditional expressions of the 'if' are agreed alongside each other are identical.  Check lines: 2384, 2390. debug.c 2390 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbg_check_nondata_nodes_order</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sa = container_of(cur, struct ubifs_scan_node, <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>); sb = container_of(cur-&gt;next, struct ubifs_scan_node, <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sa-&gt;type != UBIFS_INO_NODE &amp;&amp; sa-&gt;type != UBIFS_DENT_NODE &amp;&amp; sa-&gt;type != UBIFS_XENT_NODE) { ubifs_err(c, <span class="hljs-string"><span class="hljs-string">"bad node type %d"</span></span>, sa-&gt;type); ubifs_dump_node(c, sa-&gt;node); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sa-&gt;type != UBIFS_INO_NODE &amp;&amp; sa-&gt;type != UBIFS_DENT_NODE &amp;&amp; sa-&gt;type != UBIFS_XENT_NODE) { ubifs_err(c, <span class="hljs-string"><span class="hljs-string">"bad node type %d"</span></span>, sb-&gt;type); ubifs_dump_node(c, sb-&gt;node); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } .... }</code> </pre> <br>  The analyzer complains about two identical conditions in a row: apparently, in the second they forgot to change <i>sa</i> to <i>sb</i> .  Well, who then will say that they are not copying in the coolest projects? <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V666/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V666/">V666</a> Consider the third argument of the function 'strncmp'.  It is possible that it‚Äôs not passed on.  spectral.c 341 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_file_spec_scan_ctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct file *file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user *user_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loff_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ppos)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ath10k</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ar</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private_data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res; len = min(count, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (copy_from_user(buf, user_buf, len)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EFAULT; buf[len] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; mutex_lock(&amp;ar-&gt;conf_mutex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"trigger"</span></span>, buf, <span class="hljs-number"><span class="hljs-number">7</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"background"</span></span>, buf, <span class="hljs-number"><span class="hljs-number">9</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { res = ath10k_spectral_scan_config(ar, SPECTRAL_BACKGROUND); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"manual"</span></span>, buf, <span class="hljs-number"><span class="hljs-number">6</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { res = ath10k_spectral_scan_config(ar, SPECTRAL_MANUAL); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"disable"</span></span>, buf, <span class="hljs-number"><span class="hljs-number">7</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { res = ath10k_spectral_scan_config(ar, SPECTRAL_DISABLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res = -EINVAL; } mutex_unlock(&amp;ar-&gt;conf_mutex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count; }</code> </pre> <br>  The classic type of error: two arguments must be passed to the function: a pointer to a string and its length.  Often, when the argument is a literal, the length of the count is lazy and write just a number.  The human factor enters into the business: they are <a href="http://www.viva64.com/ru/examples/v666/">often</a> mistaken. <br><br>  See, the code has several <i>strncmp</i> in a row.  A literal is passed to each of them.  And in <i>strncmp (‚Äúbackground‚Äù, buf, 9) the</i> length was calculated incorrectly: the word ‚Äúbackground‚Äù consists of 10, not 9 characters. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V666/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V666/">V666</a> Consider the third argument of the function 'memcpy'.  This is not the case.  dpt_i2o.c 403 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adpt_inquiry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(adpt_hba* pHba)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(pHba-&gt;detail, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(pHba-&gt;detail)); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;(pHba-&gt;detail), <span class="hljs-string"><span class="hljs-string">"Vendor: Adaptec "</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;(pHba-&gt;detail[<span class="hljs-number"><span class="hljs-number">16</span></span>]), <span class="hljs-string"><span class="hljs-string">" Model: "</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;(pHba-&gt;detail[<span class="hljs-number"><span class="hljs-number">24</span></span>]), (u8*) &amp;buf[<span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;(pHba-&gt;detail[<span class="hljs-number"><span class="hljs-number">40</span></span>]), <span class="hljs-string"><span class="hljs-string">" FW: "</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= memcpy(&amp;(pHba-&gt;detail[44]), (u8*) &amp;buf[32], 4); pHba-&gt;detail[48] = '\0'; /* precautionary */ .... }</span></span></code> </pre> <br>  One more example.  The length of the string "FW:" is 5, and not at all 4 characters. <br><br>  How to get rid of such an error?  In C, you can use macros like: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> str_len(S) (sizeof(S) / sizeof((S)[0]))</span></span></code> </pre> <br>  But using such macros is dangerous in itself: it is better to add compiler-specific checks, of course, that the argument passed is really an array. <br><br>  For readers writing in C ++, I can recommend std :: string_view, which finally appeared in C ++ 17.  It is better not to pass a pointer-length pair to a function.  But if you need to manually calculate the size of the array (for example, to pass it to the memcpy function), then you can use std :: size (array) or its equivalent: for literals, the size will be calculated in compile-time. <br><br>  Avoid repeating the code and do not be lazy to use language tools (be it macros or templates) for compile time calculations! <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V653/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V653/">V653</a>  It is possible that a comma is missing.  Consider inspecting this literal: "30min" "No timeout".  lp8788-charger.c 657 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lp8788_show_eoc_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct device *dev, struct device_attribute *attr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lp8788_charger</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pchg</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_get_drvdata</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *stime[] = { <span class="hljs-string"><span class="hljs-string">"400ms"</span></span>, <span class="hljs-string"><span class="hljs-string">"5min"</span></span>, <span class="hljs-string"><span class="hljs-string">"10min"</span></span>, <span class="hljs-string"><span class="hljs-string">"15min"</span></span>, <span class="hljs-string"><span class="hljs-string">"20min"</span></span>, <span class="hljs-string"><span class="hljs-string">"25min"</span></span>, <span class="hljs-string"><span class="hljs-string">"30min"</span></span> <span class="hljs-string"><span class="hljs-string">"No timeout"</span></span> }; .... }</code> </pre> <br>  As is known, two consecutive literals are concatenated.  This makes it convenient to use them, for example, in macros.  The danger arises when we write an array of such literals: you can skip a comma and get an unexpected result. <br><br>  In this case, the last two literals ‚Äústick together‚Äù and you get ‚Äú30minNo timeout‚Äù.  This is a double mistake.  Firstly, the text is incorrect, and secondly, one element will be missed in the array, which can lead to an exit beyond the array boundary. <br><br>  I advise you to use a different formatting method, such an error will become noticeable in it: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *stime[] = { <span class="hljs-string"><span class="hljs-string">"400ms"</span></span> , <span class="hljs-string"><span class="hljs-string">"5min"</span></span> , <span class="hljs-string"><span class="hljs-string">"10min"</span></span> , <span class="hljs-string"><span class="hljs-string">"15min"</span></span> , <span class="hljs-string"><span class="hljs-string">"20min"</span></span> , <span class="hljs-string"><span class="hljs-string">"25min"</span></span> , <span class="hljs-string"><span class="hljs-string">"30min"</span></span> <span class="hljs-string"><span class="hljs-string">"No timeout"</span></span> };</code> </pre> <br>  My colleague Andrey Karpov wrote in more detail about this method of tabular code design.  I suggest to get acquainted with chapter N13 from his small <a href="http://www.viva64.com/ru/b/0391/">book</a> . <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V764/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V764/">V764</a> Possible incorrect order of arguments passed to 'ahc_9005_subdevinfo_valid' function: 'device' and 'vendor'.  aic7xxx_pci.c 695 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> struct ahc_pci_identity * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ahc_find_pci_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ahc_dev_softc_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pci)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ahc_get_pci_function(pci) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; ahc_9005_subdevinfo_valid(device, vendor, <span class="hljs-comment"><span class="hljs-comment">// &lt;= subdevice, subvendor) &amp;&amp; SUBID_9005_MFUNCENB(subdevice) == 0) return (NULL); .... }</span></span></code> </pre> <br>  Sometimes it is difficult to understand what the analyzer scolds for.  By the way, this often happens: the person did not understand what the analyzer wrote to him, sent us a report with a ‚Äúfalse positive‚Äù, and there really is a mistake.  So it seemed to me here that this is a false positive: the function is defined a little higher in the code and there all the parameters are in place.  Here's what she looks like: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ahc_9005_subdevinfo_valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> device, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vendor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subdevice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subvendor)</span></span></span><span class="hljs-function"> </span></span>{ .... }</code> </pre> <br>  What's the matter?  It turns out that even higher is the declaration of this function, and that is where these arguments are confused.  In fact, there is nothing wrong with the logic of the program, but it is better to fix it, so as not to embarrass anyone and not confuse. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ahc_9005_subdevinfo_valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vendor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> device, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subvendor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subdevice)</span></span></span></span>;</code> </pre> <br><p><img src="https://habrastorage.org/files/93a/4d7/27b/93a4d727b79846b8a7d99224806c02ea.png"></p><br><br>  But the funny thing is, the error was <a href="https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux-stable/%2B/6f8f8e4d313a47e3f8aa7eeb5201d1b02ffa0951%255E!/">already</a> here: the parameters were really confused, just forgot to correct the ad.  It's good that the analyzer also found this place. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V549/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V549/">V549</a> The first argument of the memcpy function is equal to the second argument.  wilc_wfi_cfgoperations.c 1345 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">del_pmksa</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct wiphy *wiphy, struct net_device *netdev, struct cfg80211_pmksa *pmksa)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; i &lt; (priv-&gt;pmkid_list.numpmkid - <span class="hljs-number"><span class="hljs-number">1</span></span>); i++) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(priv-&gt;pmkid_list.pmkidlist[i].bssid, priv-&gt;pmkid_list.pmkidlist[i + <span class="hljs-number"><span class="hljs-number">1</span></span>].bssid, ETH_ALEN); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(priv-&gt;pmkid_list.pmkidlist[i].pmkid, priv-&gt;pmkid_list.pmkidlist[i].pmkid, PMKID_LEN); } .... }</code> </pre> <br>  In the last <i>memcpy, the</i> pointers match.  Perhaps they wanted to write by analogy with the previous expression: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(priv-&gt;pmkid_list.pmkidlist[i].pmkid, priv-&gt;pmkid_list.pmkidlist[i + <span class="hljs-number"><span class="hljs-number">1</span></span>].pmkid, PMKID_LEN);</code> </pre> <br><h2>  Unused variables </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V575/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V575/">V575</a> The 'strncasecmp' function processes '0' elements.  Inspect the third argument.  linux_wlan.c 1121 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mac_ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct net_device *ndev, struct ifreq *req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd)</span></span></span><span class="hljs-function"> </span></span>{ u8 *buff = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; s8 rssi; u32 size = <span class="hljs-number"><span class="hljs-number">0</span></span>, length = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wilc_vif</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vif</span></span></span><span class="hljs-class">;</span></span> s32 ret = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wilc</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wilc</span></span></span><span class="hljs-class">;</span></span> vif = netdev_priv(ndev); wilc = vif-&gt;wilc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!wilc-&gt;initialized) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SIOCSIWPRIV: { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iwreq</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrq</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iwreq</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">;</span></span> size = wrq-&gt;u.data.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (size &amp;&amp; wrq-&gt;u.data.pointer) { buff = memdup_user(wrq-&gt;u.data.pointer, wrq-&gt;u.data.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(buff)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(buff); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strncasecmp(buff, <span class="hljs-string"><span class="hljs-string">"RSSI"</span></span>, length) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... } } } .... } done: kfree(buff); return ret; }</span></span></code> </pre> <br>  <i>0 was</i> passed to the <i>strncasecmp</i> function as a length argument.  There is no place in the code where the <i>length</i> variable would change, so its value will remain zero.  Probably, it was necessary to use <i>size</i> . <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V751/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V751/">V751</a> Parameter 'LCDheight' is not used inside function body.  init.c 339 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">short</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SiS_GetModeID</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VGAEngine, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VBFlags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HDisplay, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VDisplay, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Depth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FSTN, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LCDwidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LCDheight)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> ModeIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(HDisplay) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">320</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(VDisplay == <span class="hljs-number"><span class="hljs-number">200</span></span>) ModeIndex = ModeIndex_320x200[Depth]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(VDisplay == <span class="hljs-number"><span class="hljs-number">240</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((VBFlags &amp; CRT2_LCD) &amp;&amp; (FSTN)) ModeIndex = ModeIndex_320x240_FSTN[Depth]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ModeIndex = ModeIndex_320x240[Depth]; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">400</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((!(VBFlags &amp; CRT1_LCDA)) || ((LCDwidth &gt;= <span class="hljs-number"><span class="hljs-number">800</span></span>) &amp;&amp; (LCDwidth &gt;= <span class="hljs-number"><span class="hljs-number">600</span></span>))) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= if(VDisplay == 300) ModeIndex = ModeIndex_400x300[Depth]; } break; case 512: if((!(VBFlags &amp; CRT1_LCDA)) || ((LCDwidth &gt;= 1024) &amp;&amp; (LCDwidth &gt;= 768))) { // &lt;= if(VDisplay == 384) ModeIndex = ModeIndex_512x384[Depth]; } break; .... } return ModeIndex; }</span></span></code> </pre> <br>  Parameters that are not always used in a function are an error.  In fairly old APIs, situations arise when the parameter is no longer needed and is overwritten or simply not used.  But take a closer look at this fragment: here they forgot to compare the height.  Instead, comparisons of the form <i>'(A&gt; 5) &amp;&amp; (A&gt; 3)' appeared</i> , which are redundant in themselves. <br><br><h2>  Prioritization of operations confusion </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V502/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V502/">V502</a> Perhaps the '?:' Operator works in a different way.  The '?:' Operator has a lower than the '|'  operator.  core.c 1046 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvme_pr_preempt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct block_device *bdev, u64 old, u64 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pr_type type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">abort</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ u32 cdw10 = nvme_pr_type(type) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">abort</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nvme_pr_command(bdev, cdw10, old, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>, nvme_cmd_resv_acquire); }</code> </pre> <br>  A ternary operator in C is a very dangerous operator.  Not just one of the first general-purpose diagnostics in PVS-Studio is dedicated to it.  The fact is that it has a low priority, and in complex expressions it is easy to get confused and get a completely different order of calculations.  Therefore it is better, when in doubt, to use brackets. <br><br><h2>  Suspicious checks </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V517/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V517/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 375, 377. trx.c 375 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rtl92ee_rx_query_desc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct ieee80211_hw *hw, struct rtl_stats *status, struct ieee80211_rx_status *rx_status, u8 *pdesc, struct sk_buff *skb)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rtl_priv</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rtlpriv</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rtl_priv</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hw</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rx_fwinfo</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p_drvinfo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ieee80211_hdr</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hdr</span></span></span><span class="hljs-class">;</span></span> u32 phystatus = GET_RX_DESC_PHYST(pdesc); .... status-&gt;macid = GET_RX_DESC_MACID(pdesc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GET_RX_STATUS_DESC_MAGIC_MATCH(pdesc)) status-&gt;wake_match = BIT(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GET_RX_STATUS_DESC_MAGIC_MATCH(pdesc)) status-&gt;wake_match = BIT(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GET_RX_STATUS_DESC_UNICAST_MATCH(pdesc)) status-&gt;wake_match = BIT(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> status-&gt;wake_match = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... }</code> </pre> <br>  From the side it is difficult to understand what is wrong here.  The same test with the <i>GET_RX_STATUS_DESC_MAGIC_MATCH</i> macro <i>takes place twice</i> .  If we look at its announcement, we will see two other macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_RX_STATUS_DESC_PATTERN_MATCH(__pdesc) LE_BITS_TO_4BYTE(__pdesc+12, 29, 1) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_RX_STATUS_DESC_UNICAST_MATCH(__pdesc) LE_BITS_TO_4BYTE(__pdesc+12, 30, 1) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_RX_STATUS_DESC_MAGIC_MATCH(__pdesc) LE_BITS_TO_4BYTE(__pdesc+12, 31, 1)</span></span></code> </pre> <br>  Perhaps they wanted to use the <i>GET_RX_STATUS_DESC_PATTERN_MATCH</i> missing in the source fragment.  Otherwise, this test is simply meaningless. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V547/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression '(ptr [3] &amp; 0x1E)! = 0x03' is always true.  sd.c 4115 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ext_sd_send_cmd_get_rsp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct rtsx_chip *chip, u8 cmd_idx, u32 arg, u8 rsp_type, u8 *rsp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rsp_len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> special_check)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retval; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout = <span class="hljs-number"><span class="hljs-number">100</span></span>; u16 reg_addr; u8 *ptr; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmd_idx == SELECT_CARD) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rsp_type == SD_RSP_TYPE_R2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ptr[<span class="hljs-number"><span class="hljs-number">3</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0x1E</span></span>) != <span class="hljs-number"><span class="hljs-number">0x04</span></span>) { rtsx_trace(chip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STATUS_FAIL; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rsp_type == SD_RSP_TYPE_R0) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ptr[<span class="hljs-number"><span class="hljs-number">3</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0x1E</span></span>) != <span class="hljs-number"><span class="hljs-number">0x03</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= rtsx_trace(chip); return STATUS_FAIL; } } } .... }</span></span></code> </pre> <br>  The error is related to bit operations.  The result of a bitwise conjunction with <i>0x1E</i> due to one bit will never be equal to the value <i>0x03</i> : <br><br><p><img src="https://habrastorage.org/files/6fc/0c2/b6f/6fc0c2b6fdd745e6a8e3d883fe5ddff2.png"></p><br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V517/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V517/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1277, 1282. ks_wlan_net.c 1277 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ks_wlan_set_power</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct net_device *dev, struct iw_request_info *info, struct iw_param *vwrq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *extra)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ks_wlan_private</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">priv</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ks_wlan_private</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">netdev_priv</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> enabled; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (priv-&gt;sleep_mode == SLP_SLEEP) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EPERM; } <span class="hljs-comment"><span class="hljs-comment">/* for SLEEP MODE */</span></span> enabled = vwrq-&gt;disabled ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* 0 */</span></span> priv-&gt;reg.powermgt = POWMGT_ACTIVE_MODE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled) { <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (priv-&gt;reg.operation_mode == MODE_INFRASTRUCTURE) priv-&gt;reg.powermgt = POWMGT_SAVE1_MODE; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled) { <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (priv-&gt;reg.operation_mode == MODE_INFRASTRUCTURE) priv-&gt;reg.powermgt = POWMGT_SAVE2_MODE; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; hostif_sme_enqueue(priv, SME_POW_MNGMT_REQUEST); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Reduce the example to: <br><br><pre> <code class="cpp hljs">enabled = vwrq-&gt;disabled ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* 0 */</span></span> .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled) { <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabled) { <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ....</code> </pre> <br>  This code looks very strange.  It seems that the range of values ‚Äã‚Äãis clearly discussed by the expression above: <i>enabled</i> is <i>0</i> or <i>1</i> .  But checked as many as <i>4</i> values.  At the same time, comments only interfere: if the digits should have indicated the possible value of the variable, now they do not correspond to reality: the checks for <i>1</i> and <i>2</i> are written in the same way. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V517/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V517/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 422, 424. Hal8188ERateAdaptive.c 422 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">odm_ARFBRefresh_8188E</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( struct odm_dm_struct *dm_odm, struct odm_ra_info *pRaInfo)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Wilson 2011/10/26 */</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pRaInfo-&gt;HighestRate &gt; <span class="hljs-number"><span class="hljs-number">0x13</span></span>) pRaInfo-&gt;PTModeSS = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pRaInfo-&gt;HighestRate &gt; <span class="hljs-number"><span class="hljs-number">0x0b</span></span>) pRaInfo-&gt;PTModeSS = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pRaInfo-&gt;HighestRate &gt; <span class="hljs-number"><span class="hljs-number">0x0b</span></span>) pRaInfo-&gt;PTModeSS = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pRaInfo-&gt;PTModeSS = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Another place where two conditions go in a row.  Note that the bodies are different.  It is difficult to say if there is a real mistake here, or is it just unused code: this is the task of the project developers.  The task of the analyzer to pay attention to a suspicious place. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V734/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V734/">V734</a> An excessive check.  ‚ÄúInterleaver‚Äù and ‚Äúdeinterleaver‚Äù.  sst-atom-controls.c 1449 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sst_fill_widget_module_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( struct snd_soc_dapm_widget *w, struct snd_soc_platform *platform)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">snd_kcontrol</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kctl</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index, ret = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">snd_card</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">component</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">snd_card</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *idx; down_read(&amp;card-&gt;controls_rwsem); list_for_each_entry(kctl, &amp;card-&gt;controls, <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(kctl-&gt;id.name, <span class="hljs-string"><span class="hljs-string">"interleaver"</span></span>)) { struct sst_enum *e = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)kctl-&gt;private_value; e-&gt;w = w; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(kctl-&gt;id.name, <span class="hljs-string"><span class="hljs-string">"deinterleaver"</span></span>)) { struct sst_enum *e = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)kctl-&gt;private_value; e-&gt;w = w; } .... } up_read(&amp;card-&gt;controls_rwsem); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  In this fragment, the presence of several substrings in one string is sequentially checked.  For clarity, I left only the substrings of interest to us.  Suppose that we did not find an <i>interleaver</i> - then there is no point in looking for <i>deinterleaver</i> , because the substring <i>interleaver</i> is definitely not.  Therefore, this piece of code will never work, but since the bodies of if and else are the same, this is not a problem.  This is just a redundant code. <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V547/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'block' is always true.  svclock.c 873 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nlmsvc_grant_reply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct nlm_cookie *cookie, __be32 status)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nlm_block</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">;</span></span> dprintk(<span class="hljs-string"><span class="hljs-string">"grant_reply: looking for cookie %x, s=%d \n"</span></span>, *(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *)(cookie-&gt;data), status); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(block = nlmsvc_find_block(cookie))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (block) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == nlm_lck_denied_grace_period) { <span class="hljs-comment"><span class="hljs-comment">/* Try again in a couple of seconds */</span></span> nlmsvc_insert_block(block, <span class="hljs-number"><span class="hljs-number">10</span></span> * HZ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Lock is now held by client, or has been rejected. * In both cases, the block should be removed. */</span></span> nlmsvc_unlink_block(block); } } nlmsvc_release_block(block); }</code> </pre> <br>  This example demonstrates why it is not enough for the static analyzer to perform a Pattern-based analysis, bypassing the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> .  It is important to be able to perform Control flow analysis and Data flow analysis.  At the moment when <i>block == NULL</i> occurs <i>return</i> , respectively, further down the code, we can definitely say that the pointer is nonzero.  And when we meet the check on <i>NULL</i> , we understand for certain that something is wrong here. <br><br>  It seems that the second pointer check here is just superfluous.  However, suddenly they wanted to check another variable here?  Who knows ... This code is obviously left to the developer for verification. <br><br>  Similar situation: <br><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V547/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'sym' is always true.  menu.c 498 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">menu_is_visible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct menu *menu)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">menu</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">symbol</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sym</span></span></span><span class="hljs-class">;</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sym || sym_get_tristate_value(menu-&gt;sym) == no) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return false; for (child = menu-&gt;list; child; child = child-&gt;next) { if (menu_is_visible(child)) { if (sym) // &lt;= sym-&gt;flags |= SYMBOL_DEF_USER; return true; } } return false; }</span></span></code> </pre> <br><h2>  Macro error </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V733/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V733/">V733</a>  Check expression: request-&gt; rq_timeout + 5 * 1000. niobuf.c 637 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFS_FAIL_TIMEOUT(id, secs) \ cfs_fail_timeout_set(id, 0, secs * 1000, CFS_FAIL_LOC_NOSET) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OBD_FAIL_TIMEOUT(id, secs) \ CFS_FAIL_TIMEOUT(id, secs) int ptl_send_rpc(struct ptlrpc_request *request, int noreply) { .... OBD_FAIL_TIMEOUT(OBD_FAIL_PTLRPC_DELAY_SEND, request-&gt;rq_timeout + 5); .... }</span></span></code> </pre> <br>  But such errors are very rare.  Before that, I saw only one triggering of this diagnostic in a real project: noteworthy that it was <a href="http://www.viva64.com/ru/b/0377/">FreeBSD</a> .  An error was made in the definition of a macro: it is best to surround all its parameters with parentheses.  If you do not do this, then the following case is possible: if you substitute 'x + 5' into 'secs * 1000', you get 'x + 5 * 1000', and this is clearly not what the author expected. <br><br><h2>  Mindless memset </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V597/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V597/">V597</a> The compiler could delete the memset function call, which is used to flush the 'ps' buffer.  The memset_s () function should be used to erase the private data.  atom.c 1383 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amdgpu_atom_asic_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct atom_context *ctx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hwi = CU16(ctx-&gt;data_table + ATOM_DATA_FWI_PTR); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ps[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(ps, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); ps[<span class="hljs-number"><span class="hljs-number">0</span></span>] = cpu_to_le32(CU32(hwi + ATOM_FWI_DEFSCLK_PTR)); ps[<span class="hljs-number"><span class="hljs-number">1</span></span>] = cpu_to_le32(CU32(hwi + ATOM_FWI_DEFMCLK_PTR)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ps[<span class="hljs-number"><span class="hljs-number">0</span></span>] || !ps[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CU16(ctx-&gt;cmd_table + <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> * ATOM_CMD_INIT)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; ret = amdgpu_atom_execute_table(ctx, ATOM_CMD_INIT, ps); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(ps, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= return ret; }</span></span></code> </pre> <br>  It makes no sense to add a <i>memset</i> before <i>return</i> : the compiler, seeing that this operation does not change the visible state of the program (the array goes out of scope anyway) removes it.  If you need to erase some important data, then you should use <i>memset_s</i> or write your own analogue. <br><br>  This error by the way is actually a vulnerability.  Data that should be erased is not overwritten.  Details can be found in the description of diagnostics <a href="http://www.viva64.com/ru/w/V597/">V597</a> .  By the way, this is a very common vulnerability: <a href="http://www.viva64.com/ru/examples/V597/">proof</a> . <br><br><h2>  Dangerous use of memcmp </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V642/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V642/">V642</a> Saving the 'memcmp' function result inside the 'unsigned char' type variable is inappropriate.  Breaking the program's logic.  host.c 1789 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">power_control_timeout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data)</span></span></span><span class="hljs-function"> </span></span>{ .... u8 other = <span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(requester-&gt;frame_rcvd.iaf.sas_addr, iphy-&gt;frame_rcvd.iaf.sas_addr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(requester-&gt;frame_rcvd.iaf.sas_addr)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other == <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } .... }</code> </pre> <br>  If you carefully read what the documentation says about the return value of <i>memcmp</i> , then we will see that there is no guarantee about any particular range: the function can return any number within its type.  And this is not always <i>-1</i> , <i>0</i> and <i>1</i> .  Therefore, it is impossible to save its value in a variable of a smaller type: with the loss of the higher digits, the younger ones can be zero.  A similar error led to a vulnerability in <a href="http://seclists.org/oss-sec/2012/q2/493">MySQL / MariaDB</a> . <br><br><h2>  Conclusion </h2><br><p><img src="https://habrastorage.org/files/db7/f44/06b/db7f4406b3e045918e9a9a49cc570dff.png"></p><br><br>  As already mentioned, Linux is a very high-quality, well-tested project.  Finding a mistake in it, even the most insignificant, is a cause for pride.  This is also a reason to think about how many errors could be found before debugging and testing: it is in this line of work that static analysis is valuable.  You can verify this by trying PVS-Studio.  For Linux, you can get a trial version of the analyzer by emailing us.  And for your non-commercial projects, you can use PVS-Studio for free: it‚Äôs enough to get acquainted with <a href="http://www.viva64.com/ru/b/0457/">this article</a> and use the open and free utility <a href="https://github.com/viva64/how-to-use-pvs-studio-free">how-to-use-pvs-studio-free</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0460/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Pavel Belikov.  <a href="http://www.viva64.com/en/b/0460/">Linux Kernel, tested by the Linux-version of PVS-Studio</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/317374/">https://habr.com/ru/post/317374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317364/index.html">Linux kernel 4.9 introduced</a></li>
<li><a href="../317366/index.html">PHP Digest number 98 - interesting news, materials and tools (November 28 - December 11, 2016)</a></li>
<li><a href="../317368/index.html">Firsthand about software lifecycle management products</a></li>
<li><a href="../317370/index.html">Comparison of 2048 game strategies</a></li>
<li><a href="../317372/index.html">Optimize NFV performance for customers' local hardware with virtualization</a></li>
<li><a href="../317376/index.html">Myths and Misconceptions about Design in Scrum</a></li>
<li><a href="../317378/index.html">How IT professionals work. Igor Myzgin, Servers.ru</a></li>
<li><a href="../317382/index.html">What is MMTS-9 and how does the Internet turn out in Russia</a></li>
<li><a href="../317384/index.html">PDUG Meetup: disassembling WAFs on cogs, climbing into binaries with bare hands, assembling the development environment infrastructure</a></li>
<li><a href="../317386/index.html">C ++ Russia 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>