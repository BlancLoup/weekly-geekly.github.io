<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Travel notes, or the taste of coffee for elephants</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you already guessed what the article will be about? 

 For the third year I have been developing a large system in Java using the PostgreSQL DBMS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Travel notes, or the taste of coffee for elephants</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/838/b45/151/838b45151ae195394c84e35d2959a30d.png"><br><br><h4>  Have you already guessed what the article will be about? </h4><br><br>  For the third year I have been developing a large system in Java using the PostgreSQL DBMS.  The system is desktop, client-server.  We don't have an experienced Senior-Java-Developer, so we have to think for ourselves.  To think, to build, to break, to build again, to break again ... <br>  During my work, I have gained some experience both in organizing work directly from the database, and in interconnecting these platforms, which I want to talk about in this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will selectively describe some of the issues that we encountered in the development and which were solved. <br><a name="habracut"></a><br><br><h6>  1. Using ORM </h6><br>  The principles used in Hibernate, as well as the fact that almost every job of a Java developer requires knowledge of Hibernate, caused an obsession with me to introduce this technology into our system. <br><br>  However, we work with vector graphics, and it turned out to be extremely inconvenient to make vector objects as Persistence objects, with appropriate setters and getters.  Vector objects are complex, with many logical properties (ie, not only graphics, but also logic).  I never thought up how to map them to Hibernate. <br>  But he invented his own structure for describing the logical properties of objects in XML, where for each property there is a table and a database column, and algorithms that form dynamic SQL queries on this basis. <br>  So - we do not use ORM.  We work through JDBC and use our own XML-mapping. <br>  And dependence on the DBMS is still there, because  without stored procedures can not do (!!!). <br><br><h6>  2. Organization of connections to the database </h6><br>  PostgreSQL JDBC driver, java.sql.Connection, and forward - in each class, opening and closing connections. <br><br>  So it was the first couple of months. <br>  Today we have one class - connection manager, very simple.  It stores the object itself - the connection (one for the whole project!) And ensures that this connection to the database is not used at the same time, especially in several threads, because it is not safe. <br><br><h6>  3. Organization of SQL queries in the project. </h6><br>  At the beginning of development, in every second class, SQL queries could be encountered.  They worked great. <br><br>  But the database was changing in parallel, and at some point it took to take and rename the table.  Rename something simple, but what about the project?  Refactoring?  But no, you can rename all references to the table in the source code only with the help of contextual replacement by project.  But the medium does not know where you have the name of the table, and where the variable of the same name ... <br>  After it took 2 days to rename a table in the database, we decided to make a separate class containing <b>all</b> SQL queries to the database, either in the form of constants or in the form of methods.  All constants are named according to the same principle "&lt;query_type&gt; _ &lt;class name&gt; _ &lt;query meaning&gt;".  For example, the constant on the selection of graphic lines, called in the class Graph, called <i>SELECT_GRAPH_LINES</i> .  If it were a method, it would be called <i>selectGraphLines ()</i> .  Now we have easily replaceable and beautiful code with constants instead of sql-text. <br><br><h6>  4. Optimization of execution of SQL queries. </h6><br>  I'll tell you not how to configure PostgreSQL.  And about the well-known JDBC method - PreparedStatement - executeBatch (); <br><br>  If we talk about queries for insertion, the question arises: how to quickly insert into the table immediately many rows? <br>  PostgreSQL supports multiinsert, i.e.  you can write something like <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (a, b, c) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ( (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>), (...) )</code> </pre> <br>  So, it is not good to form multincertes dynamically.  It‚Äôs enough to write once <br><pre> <code class="java hljs">PreparedStatement stmt = db.prepareStatement(<span class="hljs-string"><span class="hljs-string">"insert into table (a, b, c) values (?, ?, ?)"</span></span>).</code> </pre><br>  and then in the loop do <br><pre> <code class="java hljs">stmt.setString(<span class="hljs-number"><span class="hljs-number">1</span></span>,a); stmt.setString(<span class="hljs-number"><span class="hljs-number">2</span></span>,b); stmt.setString(<span class="hljs-number"><span class="hljs-number">3</span></span>,c); stmt.addBatch();</code> </pre><br>  and then do <br><pre> <code class="java hljs">stmt.executeBatch()</code> </pre><br>  and all the data will be inserted for you in an extremely short time. <br>  For example, inserting data from 1600 xml files of ~ 10 kB using simple <i>INSERT</i> took more than 10 minutes.  Paste using <i>executeBatch</i> is about 2 seconds.  Therefore, it is desirable to apply such a scheme wherever many insert queries of the same type are used. <br><br><h6>  5. Working with XPath in PostgreSQL </h6><br>  Faced a problem, the answer to which in google is hard to find, and from the PostgreSQL documentation it is not clear. <br>  It is given: the table in a DB with a field of type xml. <br>  Required: make a selection of all records from the table, where some XML element has such and such value. <br><br>  It's clear that the simplest thing is to do it through XPath.  We write: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xpath(<span class="hljs-string"><span class="hljs-string">'//child/child/text()'</span></span>, &lt; <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span>-&gt;) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> </code> </pre><br>  We see that all our records are empty.  After searching, we understand that the XML data is recorded with a so-called.  default namespace, i.e.  all XML tags are written simply: <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xmltag</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xmltag</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  but not <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:xmltag</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ns:xmltag</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  It took a lot of time to understand that you need to register the namespace by default, and do it like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xpath(<span class="hljs-string"><span class="hljs-string">'//my:root/my:child/text()'</span></span>, &lt; <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span>-&gt;, <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-string"><span class="hljs-string">'my'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://example.com'</span></span>]]);</code> </pre><br>  where <i>my</i> is any word to your taste - namespace name <i>http: / /example.com</i> is the value of <i>xmlns</i> : <br><pre> <code class="xml hljs">xmlns="http://example.com"/</code> </pre><br>  And you definitely need the word <i>my to</i> precede all the elements in the xpath request, but the attributes are not necessary. <br><br><h6>  6. PostgreSQL text editors and stored procedures </h6><br>  In the Netbeans SQL editor, this is the code <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> AAA (a <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, b <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql;</code> </pre><br>  will cause an error.  The same will happen in SQL Workbench and in Eclipse.  And in many applications where the JDBC driver is used to execute SQL queries. <br><br>  And the problem in <i>$ body $</i> is the so-called dollar-quoting, which is used in postgres to denote the body of functions.  <i>$ body $</i> opens the function body and closes it. <br>  There are no problems in pgAdmin.  In SQL Workbench, this case is specially processed, but crutches are used: it is required to mark the end of the body of the stored procedure in the editor with a special symbol - alternate delimiter, the default is /. <br><br>  And in Netbeans - does not work.  And in Eclipse too. <br><br>  PS <br>  Of course, there were many more problems and questions in three years.  This is what I remembered and what I wanted to share. <br>  This article is not an authoritative statement ‚Äúdo it this way.‚Äù  It will be interesting to see the criticism of how we solved the problems described in the article. </div><p>Source: <a href="https://habr.com/ru/post/147914/">https://habr.com/ru/post/147914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147906/index.html">Probability theory under your arm</a></li>
<li><a href="../147907/index.html">Simulator for keyboard shortcuts</a></li>
<li><a href="../147908/index.html">Roskomnadzor demanded that Livejournal and YouTube delete personal data of Russians</a></li>
<li><a href="../147911/index.html">Mobile Internet in Finland. 3G by Saunalahti</a></li>
<li><a href="../147912/index.html">jQuery CoreUISelect - plugin for styling select</a></li>
<li><a href="../147915/index.html">Skype confused message recipients</a></li>
<li><a href="../147916/index.html">The program learns to play on videos</a></li>
<li><a href="../147917/index.html">Fresh - Pilot Edition</a></li>
<li><a href="../147918/index.html">Google Vice President Marissa Mayer has become the new Yahoo CEO</a></li>
<li><a href="../147919/index.html">Manage GIT via PHP Web Console</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>