<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tedious optimization of PHP-applications (I consider PHP5, but the majority is true for the 4th branch)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When in a dream you are dreaming ‚Äúoh and if the server is not enough ...‚Äù 
 For a start, good night. I am writing something useful for the first time ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tedious optimization of PHP-applications (I consider PHP5, but the majority is true for the 4th branch)</h1><div class="post__text post__text-html js-mediator-article"><h1>  When in a dream you are dreaming ‚Äúoh and if the server is not enough ...‚Äù </h1><br>  For a start, good night.  I am writing something useful for the first time (except for various semi-tests in my blog).  Man, I am inquisitive to the horror, it suddenly occurred to me that I can help save someone a lot of time;). <br><br><br><a name="habracut"></a><br><br>  In general, when PHP creates quite large projects (&gt; 100,000 lines of code), the desire to do ‚Äúrightly‚Äù what was done long ago threatens to plunge everything into chaos.  At least for new programmers who can come to the company in a week, a month, a year ... The solution is a clear systematization from the very beginning and the establishment of strict architectural rules.  For myself, I decided - without using frameworks, I will write only ‚ÄúHello World‚Äù sites.  Without further ado, when I thought about frameworks, I leafed through, read, but decided to surrender to Zendu with his <a href="http://framework.zend.com/">ZendFramework</a> .  Mighty he, although I made a huge amount of changes in him. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br>  In this decision, along with all the possible advantages and convenience, the question-wall suddenly arises: now my business logic takes, probably, somewhere at all, 1-2% of the execution time of the entire program.  The fee for convenience and OOP (or ‚Äúconvenience of OOP‚Äù? Probably even just ‚Äúconvenience‚Äù or just ‚ÄúOOP‚Äù is almost the same thing;)) - a huge amount of accompanying and control code. <br><br><br>  In general, when I was doing a new project - there was a goal - at least 50 requests per second on the seedy Celeron 2.6GHz.  Those.  about 0.02 seconds per request, including mysql and so on and so forth.  During the creation of the project, I managed to overclock it several times with some improvements.  What kind  Pour a cup of coffee - and welcome to the world of wise development :) I have to say right away - it worked out. <br><br><br><h1>  Optimization from A to Z. MockSoul soup recipe :) </h1><br><br><h2>  Stage 0. Preparing </h2><br><br>  Environment?  My favorite scheme: <br><br><br><ol><li>  LigHTTPd.  Under Linux.  With sys-epoll enabled; <br><br></li><li> PHP5.  Via FastCGI.  PHP should be compiled with CGI support, sharedmem (or threads, better sharedmem - and both will not compile at once;)).  Wild example with what I collect pkhp: <br><br><br> <code>./configure' '--prefix=/usr/lib/php5' '--host=i686-pc-linux-gnu' '--mandir=/usr/lib/php5/man' '--infodir=/usr/lib/php5/info' '--sysconfdir=/etc' '--cache-file=./config.cache' '--disable-cli' '--enable-cgi' '--enable-fastcgi' '--disable-discard-path' '--disable-force-cgi-redirect' '--with-config-file-path=/etc/php/cgi-php5' '--with-config-file-scan-dir=/etc/php/cgi-php5/ext-active' '--without-pear' '--disable-bcmath' '--with-bz2' '--disable-calendar' '--disable-ctype' '--without-curl' '--without-curlwrappers' '--disable-dbase' '--disable-exif' '--without-fbsql' '--without-fdftk' '--disable-filter' '--disable-ftp' '--with-gettext' '--without-gmp' '--disable-hash' '--disable-ipv6' '--disable-json' '--without-kerberos' '--enable-mbstring' '--with-mcrypt' '--without-mhash' '--without-msql' '--without-mssql' '--with-ncurses' '--with-openssl' '--with-openssl-dir=/usr' '--disable-pcntl' '--without-pgsql' '--without-pspell' '--without-recode' '--disable-simplexml' '--enable-shmop' '--with-snmp' '--disable-soap' '--enable-sockets' '--without-sybase' '--without-sybase-ct' '--disable-sysvmsg' '--disable-sysvsem' '--disable-sysvshm' '--with-tidy' '--disable-tokenizer' '--disable-wddx' '--disable-xmlreader' '--disable-xmlwriter' '--without-xmlrpc' '--without-xsl' '--disable-zip' '--with-zlib' '--disable-debug' '--enable-dba' '--without-cdb' '--without-db4' '--without-flatfile' '--with-gdbm' '--without-inifile' '--without-qdbm' '--with-freetype-dir=/usr' '--with-t1lib=/usr' '--disable-gd-jis-conv' '--with-jpeg-dir=/usr' '--with-png-dir=/usr' '--without-xpm-dir' '--with-gd' '--with-ldap' '--without-ldap-sasl' '--with-mysql=/usr' '--with-mysql-sock=/var/run/mysqld/mysqld.sock' '--without-mysqli' '--without-pdo-dblib' '--with-pdo-mysql=/usr' '--without-pdo-odbc' '--without-pdo-pgsql' '--without-pdo-sqlite' '--with-readline' '--without-libedit' '--with-mm' '--without-sqlite'</code> <br> <br><br>  We competently fasten to lighttpd, and not anyhow: <br><br><br><pre>  fastcgi.server = (
     ".php" =&gt; (
         "localhost" =&gt; (
             &lt;b&gt; "socket" =&gt; "/tmp/php5-gmru-sandbox-mocksoul-lighttpd.sock" [# 1] &lt;/ b&gt;,
             &lt;b&gt; "bin-path" =&gt; "/ usr / lib / php5 / bin / php-cgi -c" + "/ path / to / application / config / php_config_dir" [# 2] &lt;/ b&gt;,
             &lt;b&gt; "min-procs" =&gt; 1 [# 3] &lt;/ b&gt;,
             &lt;b&gt; "max-procs" =&gt; 1 [# 3] &lt;/ b&gt;,
             "bin-environment" =&gt; (
                 &lt;b&gt; "PHP_FCGI_CHILDREN" =&gt; "32" [# 4] &lt;/ b&gt;,
                 &lt;b&gt; "PHP_FCGI_MAX_REQUESTS" =&gt; "3200" [# 5] &lt;/ b&gt;
             )
         )
     )
 ) </pre><br><br><br>  <font color="gray">([# 1], [# 2], ... - so I will refer to the comments on the code. If you want to take the code, you will have to erase such notes. I will follow the same scheme in the code)</font> <br><br><br><ul><li>  <b>[# 1]</b> - unix sockets are much faster than tcp sockets.  So use them only if TCP doesn‚Äôt have a serious need (or, haha, under Windows :)) </li><li>  <b>[# 2]</b> - here I just showed an example of how you can fasten the config php to a different host (via -c we point to the folder with php.ini) </li><li>  <b>[# 3]</b> - min-procs and max-procs MUST BE = 1 !!!  Why?  Because then I will say about bytecode caching.  Kesh will be illogical if the number of processes Pkhp more than 1 </li><li>  <b>[# 4]</b> is a magical dance.  We ask php to run 32 threads in one process to process requests from lighttpd.  <font color="red">Important: if you put, for example, 10 and all 10 will be occupied by some wild 10-second-running script - lighttpd will give 500 error!</font>  <font color="red">Those.</font>  <font color="red">the number of threads does not increase in real-time - put 32, 64 or even 128 (it works like threadpool)</font> </li><li>  <b>[# 5]</b> - please kill the stream and create a new number of requests.  Just in case, php is not perfect :). </li></ul><br></li><li>  Opcode Cacher.  Or kesher baytkod.  Or "what kind of dibilism - to parse the same files with each request ?!".  Very (VERY!) Recommend APC (Alternative PHP Cache) which lies in <a href="http://pecl.php.net/APC">PECL</a> .  You can also eAccelerator or even ZendOptimizer.  Tastes are different ... But when choosing between eAccelerator and APC - I recommend APC.  Why?  Yes, at least for the opportunity to put anything in the shmem segment :).  Below I will tell. <br><br></li></ol><br><br><h2>  Stage 1. We write </h2><br><br>  First we write.  We write and twist in my head thoughts about how to do something more reasonable and fast right away.  So as not to be distracted (in general, this is probably a completely natural desire of any self-respecting programmer%)) <br><br><br>  Moments that immediately need to pay attention: <br><br><br><ol><li>  You probably won't need to use require and include.  Basically - require_once and include_once. </li><li>  For iterating over arrays, changing and filtering them, we learn how to use the array_ * functions in php.  Especially lambda functions: <br><pre>  &lt;? php<font></font>
        <font></font>
 $ arr = array ('that', 'is', 'this');
 array_walk ($ arr, create_function ('&amp; $ v, $ k', '$ v = $ v. "yeah";');
 print_r ($ arr);<font></font>
<font></font>
 // outputs:
 // Array
 // (
 // [0] =&gt; that yeah
 // [1] =&gt; is yeah
 // [2] =&gt; this yeah
 //)<font></font>
<font></font>
 // Would you make it a loop?  Ah ah ah...<font></font>
<font></font>
 ?&gt; </pre><br></li><li>  Passing a variable by reference (for example, $ a = 1; call_func (&amp; $ a)) - does not affect performance.  Passing arrays by reference - affects a little bit.  Passing classes is very influential.  I mean this - do not pass anything on the link hoping to speed up the program.  Pass on the links only when you need it </li><li>  Make classes static if possible.  Those.  if for the work of the class a closed instance is not needed in general. </li><li>  You can comment as much as you want - the bytecode chester ignores comments anyway.  It affects the performance ... hmm ... by 0.000001% :) </li><li>  Avoid deep recursions.  The standard task - to take a list of files including subdirectories can be done without recursion at all =) </li><li>  Read literate docks.  The documentation of the same ZendFramework - there are a lot of things useful even for those who do not use the framework and are not going to use </li><li>  Try to divide the code into logical blocks.  So that you can take 10-20 lines in a row and say - here I am doing ONLY THIS.  Take another 10-20 - and say, and here I am doing ONLY ANOTHER.  The number of lines that must be taken, of course, depends on you.  But it is better that the blocks be no more than 30-40 lines.  Break the program and any blog into initialization, configuration, operation, saving the result (into a variable, say).  What does the speed?  In six months you will understand;). </li><li>  About that ‚ÄúCan make me $ a =‚Äû some $ v inline ‚Äúor $ a =‚Äû some ‚Äú.  $ v.  ‚ÄúVar‚Äù is not even worth thinking about.  Personally, I (IMHO) find absolutely dibilistic insertion of variables directly into strings.  Best readability: <br><ul><li>  $ var = 'some'.  $ in.  'li'.  $ ne.  'variable'; </li><li>  $ var = sprintf ('some% sli% s variable', $ in, $ li); </li></ul><br></li><li>  Use constants to never change.  They paryshatsya at the very beginning and lie in general in another piece of memory than ordinary variables.  Constructs of the form $ str = 'some'.  STR_CONSTANT also looks better.  Especially competently - line break.  Called it differently, I love NL (NewLine) or CRLF (CarretReturnLineFeed) </li><li>  Do not forget that foreach may not make a copy of the array :) <br><pre>  foreach ($ arr as $ key =&gt; &lt;b&gt; &amp; $ val &lt;/ b&gt;) {...} </pre><br></li><li>  Paradoxically, but such a moment in Pkhp completely kills me: is_null () is invented by an idiot.  if (null === $ var) or if ($ var === null) faster than if (is_null ($ var)) ... dibilism.  Do not use is_null () :) </li><li>  Regular expressions, working with strings using str_ * functions, etc. are left on your conscience as going beyond this already bloated article :) </li></ol><br><h2>  Stage 2. We reflect on possible waste of time. </h2><br><br>  So ... you wrote something.  And now let's see what usually takes enough dofig time without your business logic: <br><br><ol><li>  Connect to DB </li><li>  Handling tons of require_once and include_once </li><li>  DB queries themselves </li><li>  Somewhere we store the config and parsim it every time?  Use database models and initialize them every time?  In general, see how much the same we do every request !! </li><li>  Do something with the file system?  What for?  Personally, I think that almost any project can be written with no IO at all (of course, except that it will use a database and etc.).  No need to store anything in the file system.  Small.  Large (some indexed gig file) - need </li></ol><br><br>  This I sorted everything by importance.  And now in order for each insatiable moment: <br><br><h3>  Connect to DB </h3><br>  It's simple - if you own a server - use persistent connections!  PDO_MYSQL, MYSQL - everyone can do it) <br><br><h3>  Handling tons of require_once and include_once </h3><br>  Here the fun begins =).  For starters, I took a look at how many files I have included with ANY request in ZendFramework.  It turned out - a little less than 300 (!!!!).  If you do not use bytecode kesher - it will be generally abnormally long procedure. <br><br>  The solution ‚Äúvlob‚Äù was found by itself - to push it all into one file.  The question arose - how to find out what is always included in us - and what sometimes?  In general, there was no particular time to think at that moment, and therefore this aspect I decided to ‚Äúvlob‚Äù) <br><br>  Wild result - <a href="">http://www.mocksoul.ru/pub/dev/mkzend.phps</a> <br><br>  There: <br><ul><li>  How often a file is accessed - we look through the APC cache according to statistics </li><li>  Draw a sign </li><li>  Change the zend machine :).  Type cut all the require_once, comments, opening and closing php tags, extra spaces ... mocking shorter :) See the source </li><li>  Save the resulting giant script in the file ...) </li></ul><br><br>  The script is absolutely unstable and sharpened for one project.  It is necessary to run through the browser to APC worked.  Just as an example.  You will not work with 100% probability =). <br><br>  As it turned out, 300 files were parsed for 2 seconds, pulled out of the byteskeeper in 0.3 seconds, and the generated superfile is large in parse 0.7 seconds and pulled out of the cache in 0.003 seconds.  The project immediately accelerated by almost 3 times :).  Maniac optimization, however.  The method is suitable for a production server, since  Developing libraries that are loaded from another file is impossible. <br><br><h3>  Queries to the database </h3><br>  Take a look at the DBA and finally start using MYSQL_QUERY_CACHE.  In my.cnf, we write <code>query_cache_size = 100M</code> .  We follow the cache by <code>show status like 'qcache%'</code> .  We also read the MySQL docks very closely regarding Query Cache <br><br><br><h3>  Stop doing the same thing - cache! </h3><br><br>  Read the config?  Raspars?  Got a ready-made array?  So why parse it again?  ) You also have - shared memory at hand in the form of APC!  :) Incredibly fast speed of work ... Store in it everything that you can - configuration, collected objects, results of a ‚Äúdescribe table‚Äù a la (this is the prerogative of Zend_Db_Table_ *).  From the cache data is taken at an unimaginable speed - 0.000001s somewhere.  In memory, if you do not duplicate anything, you can save just dofig data.  Remember that 1 gig is a huge pile of possible information.  Do not use IO in the file system for this - better memory.  Depending on your qualification - from 10 to 100% increase in speed.  See below about APD;) <br><br><h3>  Why do you need FS? </h3><br><br>  Use the FS as a keeper of anything, only if it does not fit into the memory.  Even if you write a log or statistics of requests - put it in APC!  And save, say, every 5 minutes on a screw. <br><h2>  Stage 3. Tired of thinking about wasting time.  We want a schedule before your eyes! </h2><br><br>  It turned out to be a very valuable discovery for me.  In general, step by step guide: <br><br><ol><li>  We need <a href="http://pecl.php.net/apd">PECL APD</a> (Advanced PHP Debugger) </li><li>  Configure dumpdir for apd in the config.  Sort of: <br><pre>  zend_extension = / usr / lib / php5 / lib / php / extensions / no-debug-non-zts-20060613 / apd.so
 apd.dumpdir = "/ tmp / php-apd-dump" </pre></li><li>  In the most important file we write in the top of the top <code>apd_set_pprof_trace();</code>  , thereby including the profiler dump </li><li>  We make 1-100 requests to the server.  Each time a new file will be saved in our / tmp / php-apd-dump </li><li>  Now we can watch the profiler results either directly in the console - along with apd comes the pprofp scripter </li><li>  And we can also make a super thing - convert to a more unified format :).  With APD, in addition to pprofp, there is also pprof2calltree.  It converts profiler dumps into a format understood by cachegrind and KCacheGrind in particular.  The resulting file is opened in kcachegrind - and an applause with pleasure. <br></li></ol><br><br>  In general, the usual such profiler is obtained.  That's just for PHP, I have not done this before;) <br><br><h2>  Stage 4. Check </h2><br><br>  <code>ab2</code> is foolish to check the speed with simple requests for 1 URL using <code>ab</code> or <code>ab2</code> . <br><br>  A more logical option is to make a list of all (or not all;)) URLs, put in a text file, take <a href="http://www.joedog.org/JoeDog/Siege">Siege</a> and test.  During the test, monitor TPS (TransactionsPerSecond) on screws (for example, using iostat from the sysstat package), monitor processor utilization, and make sure that at the end there are no server responses other than 2xx. <br><br><h1>  Why is it all </h1><br>  So much to try to accelerate everything you need when the project grows.  Increase in speed by 10% on 1 server gives an increase in speed equal to 10%.  And if you already have 10 servers, then a 10% increase in speed will be equal to adding another 11th server.  Those.  + 100% in terms of 1 server.  It's a lot.  This is money.  And this is a higher entry threshold for competitors;). <br><br><h1>  Eeee </h1><br>  2 days ago broke the collarbone.  And he wrote all this with one hand.  Monument to me !!!  :)) <br><br>  Kind Regards, Vadim Burmakin aka MockSoul ¬© 2007 </div><p>Source: <a href="https://habr.com/ru/post/11553/">https://habr.com/ru/post/11553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115522/index.html">Anyone, even the smallest online store, can accept cards</a></li>
<li><a href="../115525/index.html">Prostopleer became paid</a></li>
<li><a href="../115527/index.html">How to get and measure high-speed TCP connection</a></li>
<li><a href="../115528/index.html">HTML5 Canvas browser performance test</a></li>
<li><a href="../115529/index.html">Free access to the course on ReSharper from PluralSight</a></li>
<li><a href="../115531/index.html">Server from image: DHCP + TFTP + Initrd + OpenVZ</a></li>
<li><a href="../115533/index.html">Donetsk coffee-and-code with a taste of Ruby on Rails</a></li>
<li><a href="../115536/index.html">The simplest RSS reader</a></li>
<li><a href="../115538/index.html">Features Firewall in Windows 7</a></li>
<li><a href="../115539/index.html">Communication billing and Cisco Catalyst 2960 via SNMP. Change port speed, traffic count</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>