<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering of the device firmware on the example of a flashing "rhino". Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 26, 2018, INFORION held a conference for students of MSTU. Bauman SMARTRHINO-2018 . A small device based on the STM32F042 microcontroller was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering of the device firmware on the example of a flashing "rhino". Part 1</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/if/ye/va/ifyevak_t8a0c9hyrz7vhjhz0sa.png"></div><br>  On April 26, 2018, INFORION held a conference for students of MSTU.  Bauman <a href="https://www.smartrhino.ru/">SMARTRHINO-2018</a> .  A small device based on the STM32F042 microcontroller was prepared especially for the conference. <br><br>  This rhino was the <s>experimental</s> main character of the master class on reverse firmware.  Unfortunately, during the time allotted for the master class, it was not possible to conduct a full study of the firmware, so we decided to fill it with a detailed analysis in the format of the article.  We hope that the information will be useful not only to the participants of the conference, but also to all novice codgers. <br><br>  The first part of the article is based on the conducted master class and is designed for beginners - attention is paid to basic approaches to the reversal of firmware and the features of working with the IDA disassembler. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://habr.com/company/inforion/blog/412561/">The second part is a</a> bit more complicated, it focuses on the features of the operation of devices based on real-time operating systems. <br><br>  Carefully, under the cat a flashing rhinoceros and its firmware! <br><a name="habracut"></a><br><h2>  Legend </h2><br>  The seminar participants were offered the following legend. <br><br>  <i>You got the device and a small instruction to it.</i> <br><blockquote><h4>  Lighting device "Rhino" </h4><br>  <b>User's manual</b> <br><br>  The lighting device "Rhino" is designed to illuminate the premises of a small area.  The device combines a stylish compact design, bright LEDs with low current consumption and a USB interface for connecting power. <br><br>  The device is equipped with a Bluetooth-module for remote control.  There are ample opportunities to control the light, allowing you to set the hue and saturation for each LED separately. <br><br>  The device is controlled through special software "Sinezubik". <br><br>  Enjoy using! </blockquote><br>  <i>You do not have the mentioned software for device management and <b>you need to write it from scratch</b> .</i>  <i>In addition, you must <b>ensure</b> that the device is <b>safe to</b> use.</i> <br><br>  That is all the researcher has is a device that can be turned on.  If there is a device, then you can try to get its firmware by subtracting it from the flash drive of the microcontroller.  This stage was skipped to simplify and speed up the master class - participants received a ready firmware image in the form of a binary <b>rhino_fw42k6.bin</b> file (as if they received the firmware, for example, from updates). <br><br>  An interested reader can also <a href="https://goo.gl/8YRWyW">download the firmware</a> for independent research. <br><br>  The master class was held online - with the opportunity to ask, to offer their own solutions.  For participants was available 4 workers "Rhino". <br><br><h2>  Visual inspection </h2><br>  <i>Briefly: at this stage, an external inspection of the device is carried out in order to search for markings, available connectors.</i> <br><br>  At the beginning of the seminar, emphasis was placed on first examining the device externally, then starting to reverse the firmware. <br><img src="https://habrastorage.org/webt/5d/oo/l7/5dool7fgc_zcb7jl9x69bgib3lq.png"><br>  First of all, the microcontroller is interested, then the peripheral devices and connectors. <br><br>  External inspection of the device allowed to establish the following: <br><br><ul><li>  Microcontroller STM32F042 - here you should immediately refer to the documentation for the microcontroller (if there is one), where you can find out the architecture, microcontroller capacity and many other things (for our case - 32 bit microcontroller on ARM architecture); <br><br><img src="https://habrastorage.org/webt/fr/7k/xp/fr7kxp-tlwtqse11zvonnvatvbq.png"></li><li>  On the back there is a connector without symbols - those who worked with microcontrollers can make a correct assumption that this is a connector for flashing the device (firstly, it is not labeled; secondly, it has 5 contacts, which corresponds to the required number of contacts for microcontroller remaking); <br><br><img src="https://habrastorage.org/webt/1o/7w/3d/1o7w3dtsl1ghaddiaghxftnv7ow.png"></li><li>  Contact GND, TX; </li><li>  USB-connector to power the device (this is stated in the "Instructions"); </li><li>  Unknown XP2 connector on the front of the device; <br><br><img src="https://habrastorage.org/webt/ah/r_/tm/ahr_tmtvpgmeuxeehbpfuuegj4o.png"></li><li>  An incomprehensible yellow blob on the leg of a rhino is probably a touch button. <br><br><img src="https://habrastorage.org/webt/5w/gw/k9/5wgwk9eta1esx4fltebqnammtiw.png"></li></ul><br>  The smartest participants immediately turned on the power to the devices and saw the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/ou/lc/yboulcrrldy_kfklz6ajoand1kg.gif"></div><br>  It was also discovered that there were available Bluetooth devices with the names <i>RHINOCEROS-220x</i> , when connected to which a virtual COM port is created in the system.  It turned out to be convenient to connect to the device via Bluetooth from a smartphone and interact via the mobile application "Serial Bluetooth Terminal" or similar. <br><br>  It was found that when sending arbitrary text to the COM port, the device returns the response <code>Unknown command</code> . <br><br><h2>  Initial firmware research </h2><br>  <i>Briefly: at this stage a preliminary analysis of the firmware is performed.</i>  <i>View rows.</i>  <i>Download firmware in IDA Pro.</i> <br><br>  Before analyzing the firmware code, it makes sense to check if the code is not packed.  There may be different approaches, in the simple case it is enough to use the <b>strings</b> utility to get the strings of a binary file (given in the abbreviation): <br><br><pre> <code class="hljs perl">../Drivers/STM32F0xx_HAL_Driver/Src/stm32f0xx_hal_cortex.c ../Drivers/STM32F0xx_HAL_Driver/Src/stm32f0xx_hal_dma.c ‚Ä¶ Hardware init done... Starting FreeRTOS sendMsg error %s TSC %d SET AUTH %d cmd[%d] %s UART task Bluetooth task AT+AB ShowConnection ‚Ä¶ AT-AB -BypassMode- <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> bypass ERROR: Wrong header <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> cmd: %s led idx %d hue %d sat %d val %d msg %s addr=%x, size=%x User auth pass %s Congrats amigo! Wrong won<span class="hljs-string"><span class="hljs-string">'t give up! ERROR: Unk cmd I'</span></span>ve got a super power <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> now I<span class="hljs-string"><span class="hljs-string">'m seeing invisible tactical combatant nano-ants everywhere ‚Ä¶ uartRxTask watchdogTask sensorTask bluetoothTask ledsTask</span></span></code> </pre><br>  There were a lot of lines - you can make the assumption that the firmware is not compressed and not encrypted.  Already at this stage, you can pay attention to some remarkable lines, for example, formatted lines, lines with a description of errors and an indication of the operating system ( <i>did you see them?</i> ).  The presence of meaningful lines, by and large, can be considered half of the successful reverse. <br><br>  Well, let's try to load the firmware into the most popular disassembler.  We will use IDA version 6.9 for 32-bit code (since the microcontroller is 32-bit). <br><br>  When opening the firmware file, IDA cannot automatically determine the architecture and entry point - you need to help it. <br><br>  At this stage, you must again refer to the documentation for the <a href="http://www.st.com/content/ccc/resource/technical/document/datasheet/52/ad/d0/80/e6/be/40/ad/DM00105814.pdf/files/DM00105814.pdf/jcr:content/translations/en.DM00105814.pdf">STM32F042x4 STM32F042x6</a> microcontroller and see section 5 ‚ÄúMemory mapping‚Äù: <br><br><img src="https://habrastorage.org/webt/jm/po/-o/jmpo-o0ygee71numxf7woq15-n4.png"><br><br>  As the <i>Processor Type,</i> select <b>ARM Little endian</b> , set the <b>Manual load checkbox</b> , click OK: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/bm/qd/htbmqdzac0q3bnmxa3502toyz7c.png"></div><br>  In the ‚Äú <i>Do you want to change the processor type</i> ‚Äù window, click Yes, then IDA prompts us to create RAM (RAM) and ROM (ROM) segments, set the ROM checkbox. <br><br>  Now we have to specify the start address of the ROM.  On the diagram you need to look at the Flash section - these are addresses <b>0x08000000 - 0x08008000</b> .  We also indicate that it is in the same address that we want to download the firmware file: <b>Loading address = 0x08000000</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ot/az/bs/otazbsbgyqx5kj-b40wcfmb6p50.png"></div><br>  In the window " <i>ARM and Thumb mode switching instructions</i> " click OK. <br><br>  Further, IDA says that it knows nothing about arbitrary binary files and you have to determine the entry point ‚Äî the main function ‚Äî yourself.  Click OK. <br><br>  Download done.  You can study the firmware. <br><br>  Open the <b>rows window</b> (Shift + F12).  You can pay attention to the fact that not all strings match the results from the strings utility - IDA did not recognize everything, unfortunately.  After a while we will help her ... <br><br><h4>  Beginner's Note </h4><br><ul><li>  Any program / firmware is a set of binary data.  IDA Pro can <b>interpret</b> this source file data in different ways (present data as commands or data in one format or another).  At the same time there is <b>no ‚ÄúBack‚Äù button</b> (Ctrl + Z) to cancel the selected display - you need to know how to switch between different display modes.  ( <a href="https://www.hex-rays.com/products/ida/support/freefiles/IDA_Pro_Shortcuts.pdf">Cheat sheet with IDA Pro hotkeys</a> ) </li><li>  Reverse engineer from apparent chaos of binary data restores logic, structure and readability. </li><li>  <b>Strings</b> - important information when reversing!  Since, in fact, among the entire set of binary data are the most simply and quickly perceived by man.  Lines allow to draw conclusions about the purpose of functions, variables, and code blocks. </li><li>  <b>Name the functions you have viewed</b> !  By default, IDA gives names to functions by their starting addresses.  When analyzing, it is very difficult to keep these addresses in your head; it is much easier to use meaningful names.  In order to name a function, at least a quick analysis of it is enough - this will already be an important help for further analysis. </li><li>  <b>Name the recognized variables!</b>  In order to more effectively analyze the blocks of code and functions, it makes sense to name the variables that IDA recognized, in accordance with their purpose (all, as in the best programming practices). </li><li>  <b>Leave a comment</b> , so as not to forget the important.  By analogy with programming, comments when reversed allow you to further explain the logic of the program or its individual sections. </li><li>  <b>Create structures as much as</b> possible!  IDA in its arsenal has a means of working with structures, it makes sense to master this tool and use it if necessary.  If there are structures, the code under study will be even easier to read. </li></ul><br><h2>  String analysis </h2><br>  <i>Briefly: String analysis can help make a rough plan for examining a binary file.</i> <br><br>  So the lines. <br><br><pre> <code class="hljs mel">Hardware init done... Starting FreeRTOS sendMsg <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> %s ‚Ä¶ cmd[%d] %s rsp[%d] %s UART task Bluetooth task ‚Ä¶ AT+AB SPPDisconnect AT+AB DefaultLocalName RHINOCEROS<span class="hljs-number"><span class="hljs-number">-2205</span></span> ‚Ä¶</code> </pre><br>  Only on the basis of the lines you can already get a lot of information: <br><br><ul><li>  Operating system - FreeRTOS; </li><li>  Presence of formatted strings - most likely printf-like functions are used, it will be possible to set the purpose of registers / variables </li><li>  Names of tasks (tasks) - we can assume the purpose of these tasks and related functions; </li><li>  Using AT commands - presumably the interaction between the microcontroller and the Bluetooth module is built in this way. </li></ul><br>  <i>Not always everything is so rosy when analyzing firmware - lines and debug-information may not be at all or they are uninformative, but when creating the firmware we intentionally did not complicate the process of reverse engineering.</i> <br><br><h2>  Identification of standard functions </h2><br>  <i>Briefly: at this stage it is necessary to make sure that the strings are really recognized, after which some standard C functions are to be identified.</i> <br><br>  After downloading the firmware and automatic analysis, IDA recognized the function bodies (not all, by the way), but among the function names there is not a single ‚Äúnormal‚Äù (only automatic names from IDA), which can be a little complicated compared to the reverse ELF or PE file . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v2/h_/q5/v2h_q58oxt9fhpp1dhwxdp4hrzg.png"></div><br>  Thus, in the course of the study, it is necessary to determine the purpose of not only the specific functions of a specific firmware, but also to identify standard C-functions.  A reasonable question may arise - <i>where is the guarantee that such functions are in the firmware and that they are standard?</i>  Here it is worth saying that usually when creating software (including firmware), in 9 cases out of 10, they do not bother with creating their own unique libc library, but using what has already been written and tested by time.  That is why in 90% of cases it is possible to make an assumption about the presence of standard C functions. <br><br>  Since Hex-Rays Decompiler can turn an ARM assembler into a C-code, let's use this pleasant opportunity.  It is worth noting that the <b>presence of a decompiled listing does not eliminate the need to understand the assembler</b> , especially since the decompile does not exist for all platforms. <br><br>  Open the rows window in IDA (Shift + F12). <br><br><img src="https://habrastorage.org/webt/h3/uj/mu/h3ujmup4vurtnauaxqdyokwrdum.png"><br><br>  Select the line <b>sendMsg error% s</b> , open links to this line (X key - Xrefs - Cross References) - IDA recognized the links to the line, this is good: <br><br><img src="https://habrastorage.org/webt/xi/p1/az/xip1azdfsw0qmxf7aymk6sltofo.png"><br><br>  However, among the lines highlighted in green in the disassembler, there are simply bytes marked in red.  However, some <b>lines are clearly not fully recognized</b> .  So, for example, if you set the cursor to the address <code>0x080074E6</code> and press the A key (then agree with the sentence ‚ÄúDirectly convert to string?‚Äù), You get the string ‚ÄúNo device connected‚Äù.  In the same way, you can go through all the line-like data and turn them into strings (or, for example, write a Python script that runs through the specified address range and creates strings). <br><br>  The next obstacle that may arise is <b>unrecognized references</b> to strings (even if the string was recognized).  Try to walk through the lines by pressing the X key. For example, in my case, the link to the string ‚ÄúrecvMsg error‚Äù was not found.  An object reference may not be found for two obvious reasons: <br><br><ul><li>  there is no code that refers to the current object; </li><li>  IDA did not recognize the link. </li></ul><br>  We will try to exclude the first of them by performing a binary search on the firmware.  Open the binary search window (Alt + B), enter the address of the string, do not forget to put a tick "Find all occurrences": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/06/rk/0t/06rk0tfqh7uccgc6t0tt-du6yau.png"></div><br>  Received one entry: <br><br><img src="https://habrastorage.org/webt/bn/qu/sp/bnquspp4gsc4lb7ls31poqviuqq.png"><br><br>  Let's <code>0x0800506</code> to it (address <code>0x0800506</code> ): <br><br><img src="https://habrastorage.org/webt/h1/ib/ue/h1ibueh6wul2xvtuhmlr_rw2eqg.png"><br><br>  Turn the DWORD number into offset by pressing the O key. A link to the line appeared: <br><br><img src="https://habrastorage.org/webt/vm/pd/yv/vmpdyvsv871vtucrcbvpyqnjquq.png"><br><br><div class="spoiler">  <b class="spoiler_title">Why are duplicate strings created?</b> <div class="spoiler_text">  This is due to the ARM architecture feature - the command length is fixed and is 32 bits, therefore, there is no possibility in the command to transfer the full address of the object (also 32-bit).  Therefore, the code uses a short offset to the address located next to the function where the full 32-bit address of the object is already stored. <br></div></div><br>  Place the cursor a little higher - inside the function sub_8005070 (range <code>0x08005070-0x08005092</code> ).  Switch to <b>decompiled listing</b> by pressing Tab: <br><br><img src="https://habrastorage.org/webt/li/qt/le/liqtlecd07v4uqm62zuwjgd_x0e.png"><br><br>  Pay attention to the <b>sub_8006690</b> function.  If you go back to the ‚ÄúsendMsg error% s‚Äù line, you can see that it is also passed to the sub_8006690 function.  Lines with formatting characters can lead to the assumption that the sub_8006690 function is a standard <b>printf</b> .  Let it be printf now <i>at the level of speculation</i> (even if our assumption turns out to be wrong, it will still allow us to advance in the study). <br><br>  Put the cursor on the name sub_8006690, press the N key, enter the new name <b>x_printf</b> .  For convenience, we add the ‚Äúx_‚Äù prefix (from the word ‚ÄúeXecutable‚Äù) - this is how we can distinguish the functions we renamed from the functions that IDA gave names to automatically. <br><br>  We can assume that the preparatory part has been completed; now we turn to the analysis of the task responsible for handling the Bluetooth connection.  You can reach it again through the lines.  In many IDA windows, you can search by Ctrl + F.  So, you can immediately select the line with the word "bluetooth": <br><br><img src="https://habrastorage.org/webt/7o/gs/zi/7ogszik580ylfw6na4rard20wco.png"><br><br><div class="spoiler">  <b class="spoiler_title">What is task?</b> <div class="spoiler_text">  Task (task, task) - a concept from the world of real-time operating systems (RTOS).  If simply, then the task can be represented as a separate process.  You can read more in the <a href="https://habr.com/post/129105/">series of articles about FreeRTOS.</a> <br></div></div><br><h2>  Bluetooth </h2><br>  <i>Briefly: identify and analyze the function of processing commands transmitted via Bluetooth.</i>  <i>You will need to create an additional memory segment in IDA.</i> <br><br>  The string ‚ÄúBluetooth task \ r \ n‚Äù does not have cross-references - we use again the binary search, we get the address where it is used - <code>0x080058A0</code> , go there and see a list of partially recognized links: <br><br><img src="https://habrastorage.org/webt/gf/rc/ja/gfrcjabrxmz9spvjdeyzwjg0syw.png"><br><br>  Create full-fledged links from them (by proclaiming the O key, or by writing a Python script for IDA). <br><br>  Perhaps not all links are created (addresses highlighted in green): <br><br><img src="https://habrastorage.org/webt/1u/gy/aq/1ugyaqgs-4ojoeftjp8hofz8qgo.png"><br><br>  Following the links highlighted in green, we see that there are no lines created.  We correct - we help Ida. <br><br>  Let's return to the line ‚ÄúBluetooth task \ r \ n‚Äù.  Now in the code at <code>0x08005556</code> there is a link to this line: <br><br><img src="https://habrastorage.org/webt/fd/00/hz/fd00hzwzyykg5juzl5ilbr-xcga.png"><br><br>  Here we see that this string is passed as an argument to the function x_printf we‚Äôve already seen.  Do not forget to give the speaker the name of the current function "sub_8005554", for example, "x_bluetooth_task". <br><br>  Switch to the decompile and view the function completely.  Pay attention to line 132, where a certain number is passed to the function x_printf.  If we change the display of a number from decimal to hexadecimal (H key), we see the number <code>0x8007651</code> , which is very similar to the address. <br><br><img src="https://habrastorage.org/webt/gs/lu/qv/gsluqv2nzc3ea2htrjvg5arki5s.png"><br><br>  Already familiar situation - IDA did not recognize the link.  Helping her, however, for this you need to switch from decompile to disassembler (Tab key): do offset, go through it, create a string.  Go back to the decompile, press F5 (update). <br><br>  We are happy to improve the code: <br><br><img src="https://habrastorage.org/webt/-0/e_/d2/-0e_d2ryfskf78fppbattpz7_dw.png"><br><br>  Let's pay attention to line 132. Again, besides the format string, x_printf must also pass a variable-length argument list (va_list), IDA did not recognize this ... Well, you understand, yes?  Let's help her. <br><br>  Set the cursor on the name of the function x_printf, press Y - the window for changing the prototype of the object will open.  Let's enter the correct <b>prototype of the</b> printf <b>function</b> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x_printf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ... )</span></span></span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Um, sorry, you have an error in the printf prototype ...</b> <div class="spoiler_text">  I agree, it will be right <pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x_printf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ... )</span></span></span></span></code> </pre>  .  And later we will fix it. <br></div></div><br>  IDA will display the arguments for the format string: <br><br><img src="https://habrastorage.org/webt/bd/kw/0d/bdkw0d7cqiuifpucpj3sbimlifw.png"><br><br><img src="https://habrastorage.org/webt/cg/vt/rl/cgvtrlkbnym4x4frb-cbniausfu.png"><br><br>  It's time to set the destination (names) of variables (again, the lines help us): <br><br><ul><li> <code>x_printf("recv %s state %d\r\n", v0, v25);</code>  - <code>x_printf("recv %s state %d\r\n", <b>recv_data</b> , <b>state</b> );</code> </li><li> <code>x_printf("cmd: %s\r\n", v24);</code>  - <code>x_printf("cmd: %s\r\n", <b>cmd</b> );</code> </li><li> <code>x_printf("addr=%x, size=%x\r\n", v14, v15);</code>  - <code>x_printf("addr=%x, size=%x\r\n", <b>addr</b> , <b>size</b> );</code> </li></ul><br>  Other names are not so obvious, but not super-difficult to understand. <br><br>  For example, pay attention to the code section: <br><br><img src="https://habrastorage.org/webt/s1/g-/yw/s1g-ywajd6xnn-a4n3f0raf3fb4.png"><br><br>  The variable v3 is compared with the number 3, then the message about the wrong header length appears.  It is logical to rename: <br><br><ul><li>  v3 variable in <b>header_len</b> ; </li><li>  sub_80006C8 function in <b>x_strlen</b> (you can enter this function and check our assumption). </li></ul><br>  Next, pay attention to the following code block: <br><br><img src="https://habrastorage.org/webt/ka/oa/tk/kaoatki5_tvtckslkgsvegrl4ts.png"><br><br>  The <b>sub_80006B4</b> function <b>is</b> used several times.  Inside, it looks like this: <br><br><img src="https://habrastorage.org/webt/wv/9s/g-/wv9sg-0_pfo_nsz3lp5qltnfb3e.png"><br><br><div class="spoiler">  <b class="spoiler_title">Did you recognize her?</b> <div class="spoiler_text">  <b>strcmp</b> .  Rename.  We create the harmonious readable code from chaos and fragmentation. <br></div></div><br>  Now pay attention to the variables <code>v20000624, v20000344, v20000348</code> .  IDA highlighted them in red.  This is because they refer to addresses that are not in the current disassembler database.  If you again refer to the documentation for the microcontroller, you can see that the address range <code>0x20000000-0x20001800</code> refers to RAM. <br><br><div class="spoiler">  <b class="spoiler_title">Why 0x20001800?</b> <div class="spoiler_text">  0x1800 is 6Kb RAM, and this is indicated in the documentation. <br></div></div><br>  If a variable refers to a non-existent area of ‚Äã‚Äãmemory, xrefs will not be available for it - the study will cause discomfort ... For convenience and performance, it makes sense <b>to create an additional memory segment</b> .  Open the segments window (Shift + F7), add the RAM segment: <br><br><img src="https://habrastorage.org/webt/tu/zk/4q/tuzk4qhvmkcisfyokqvutiwetqa.png"><br><br>  Update decompil.  Pay attention to the variable unk_20000344: <br><br><img src="https://habrastorage.org/webt/sw/el/f9/swelf9cwtembuspoetmgkm6rjoa.png"><br><br>  It seems that this is a kind of <b>auth_flag</b> (authorization flag).  So we write, that is, we call this variable.  In my case, no cross-references were found - use a binary search and create links. <br><br><h2>  Check on device </h2><br>  <i>Briefly: check individual assumptions on a running device.</i> <br><br>  <i>Static analysis</i> is a cool thing, but even better if you have the opportunity to examine the code over time.  There is also room for creativity, but if you don‚Äôt complicate things, the simplest thing is to connect to the device via Bluetooth, send a command and look at the result. <br><br>  So, for example, when sending the string ‚ÄúZZZ‚Äù the device will respond with the line <code>ERROR: Wrong header length\r\n</code> , when sending ‚ÄúMEOW‚Äù (this line is in the code under study, passed to the strcmp function) we will see <code>mur-mur (&gt;._.&lt;)\r\n</code> , and when sending ‚ÄúZZZZ‚Äù - <code>ERROR: Unk cmd</code> .  Thus, the <b>sub_8005234</b> function can be renamed to <b>x_bluetooth_send</b> . <br><br>  Make a list of commands that may be supported by the device, and immediately check them out.  Here's what happened: <br><br><ul><li>  <code>‚ÄúECH1‚Äù</code> - returns ‚ÄúOK‚Äù, turns on the echo mode - the command is duplicated to the sender; </li><li>  <code>‚ÄúECH0‚Äù</code> - turns off the echo mode; </li><li>  <code>‚ÄúMEOW‚Äù</code> - returns ‚Äúmur-mur (&gt; ._. &lt;) \ R \ n‚Äù - either paschalka, or debugging command; </li><li>  <code>‚ÄúLED ‚Äú</code> - turns off one of the bright LEDs; </li><li>  <code>‚ÄúUART‚Äù</code> - returns ‚ÄúOK‚Äù; </li><li>  <code>‚ÄúBLE ‚Äú</code> - flashes once with a red LED; </li><li>  <code>‚ÄúREAD‚Äù</code> - returns ‚ÄúERROR: Not auth!‚Äù </li><li>  <code>‚ÄúWRIT‚Äù</code> - returns ‚ÄúERROR: Not auth!‚Äù </li><li>  <code>‚ÄúAUTP‚Äù</code> - returns ‚ÄúERROR: auth error!‚Äù </li><li>  <code>‚ÄúSETP‚Äù</code> - returns ‚ÄúERROR: Not auth!‚Äù </li><li>  <code>‚ÄúVIP ‚Äú</code> - returns ‚ÄúWrong won't give up!‚Äù </li></ul><br>  Intermediate conclusions regarding the protocol: <br><br><ul><li>  the command consists of at least 4 characters; </li><li>  There are some rather strange commands that are somehow related to authorization (why is authorization on a lighting device?). </li></ul><br><h2>  Improved code.  Structure creation </h2><br>  <i>In short: if possible, it makes sense to create data structures - a great help for analysis.</i> <br><br>  Go ahead.  The task at least for us is to learn how to control the LEDs. <br><br>  The experiment showed that the LED command is associated with large LEDs - at least it allowed turning off one of the four large LEDs.  Let's see what is in this thread: <br><br><img src="https://habrastorage.org/webt/bi/id/_p/biid_pisxo57il441gfg5lcop9i.png"><br><br>  Here it would be possible to rename variables, confusing only constructions like <br><br><pre> <code class="cpp hljs">*(_WORD *)(v6 + <span class="hljs-number"><span class="hljs-number">4</span></span>) = sub_8005338(v4);</code> </pre> <br>  In most cases, the variable v6 is a pointer to a structure.  For convenience, <b>we will</b> also <b>create this structure</b> .  Context menu for v6 variable - select the item ‚ÄúCreate new struct type‚Äù. <br><br>  IDA proposes the following definition for structure: <br><br><img src="https://habrastorage.org/webt/zg/id/yw/zgidywzhbkr--_loz86zhol-axo.png"><br><br>  Here we trust the automatics regarding the structure field types, but set up readable names based on the data from the format string: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct_LED</span></span></span><span class="hljs-class"> {</span></span> _DWORD idx; _WORD hue; _BYTE sat; _BYTE val; };</code> </pre> <br>  After creating the structure, the code became even nicer: <br><br><img src="https://habrastorage.org/webt/b8/b1/do/b8b1dotykdfaakp6kwcf116d9dm.png"><br><br>  The variable v6 was renamed <b>led</b> in the process.  Additional variables v7 and v8 have also been renamed for convenience.  Do not be confused by the appearance of additional variables - the compiler knows better. <br><br>  According to the information from the format bar, it can be concluded that the color is set in HSV format (Hue, Saturation, Value).  To translate colors from RGB, you can use the <a href="https://www.rapidtables.com/convert/color/rgb-to-hsv.html">table</a> . <br><br>  It‚Äôs still hard to say something about the v4 variable for sure, except that it is a structure and is created in the sub_8005298 function: <br><br><img src="https://habrastorage.org/webt/x1/8u/nx/x18unxppkm11ok2b010donsppcc.png"><br><br><img src="https://habrastorage.org/webt/mg/sr/4z/mgsr4z6hi02ribz5f_uzjkdj6qi.png"><br><br>  It can be assumed that the variable v4 is a command argument, sent via Bluetooth.  Let's just call it: <br><br><ul><li>  v4 - <b>bt_args</b> </li><li>  sub_8005298 - <b>x_get_bt_args</b> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Decompile may lose previously recognized information.</b> <div class="spoiler_text">  When manipulating the names and data types in the decompile, function arguments may disappear or appear.  In this case, it is necessary for such functions to explicitly indicate their prototype (the Y key on the function header).  Due to the fact that in ARM, the first 4 arguments are passed through registers, IDA can ‚Äúlose‚Äù these arguments when decompiling, in this case ... we rush to the aid of IDE.  If it is not clear on the decompile which arguments are passed to the function, go to the disassembly listing and look at the registers R0-R3 - are there any values ‚Äã‚Äãentered in them before referring to the function of interest?  If they are entered, then in 90% of cases these are the arguments of the function, and you need to prescribe these arguments in the prototype. <br><br><img src="https://habrastorage.org/webt/9h/ls/iq/9hlsiq63umg0znlucud-jexyrma.png"><br></div></div><br><h2>  Team ‚ÄúLED‚Äù </h2><br>  <i>Briefly: the study of the LED-team, we continue to rename functions and variables.</i> <br><br>  Let's make some more renaming for easy perception: <br><br><ul><li>  sub_8003B6E - <b>x_create_struct</b> </li><li>  sub_800532C - <b>x_get_value_1</b> </li><li>  sub_8005338 - <b>x_get_value_2</b> </li></ul><br>    x_get_value_1: <br><br><img src="https://habrastorage.org/webt/6s/wo/se/6swosemfml9vynuy-fqytgwkzwe.png"><br><br>  sub_800530C  <b>x_get_value_3</b> .     x_get_value_1  x_get_value_2: <br><br><img src="https://habrastorage.org/webt/de/h5/xe/deh5xetoryzq_gu-tsvifksxuak.png"><br><img src="https://habrastorage.org/webt/el/1w/n_/el1wn_6_ocjgnl62sswpq9e2wxy.png"><br><br>         x_get_value_3,      (2  4).   x_get_value_1  1- ,  x_get_value_2 ‚Äì 2-. <br><br>    x_get_value_3: <br><br><ul><li>     bt_args ( ,  ); </li><li>      2,   ‚Äì   1 ; </li><li>      4,   ‚Äì   2 . </li></ul><br>   ,   ,   x_get_value_3    hex-  . <br><br>  : <br><br><ul><li> x_get_value_1 ‚Äî <b>x_get_byte</b> ; </li><li> x_get_value_2 ‚Äî <b>x_get_word</b> ; </li><li> x_get_value_3 ‚Äî <b>x_unhexlify</b> . </li></ul><br> ,    x_unhexlify - . <br><br> .  <b>sub_8005344</b>  : <br><br><img src="https://habrastorage.org/webt/7_/xe/fj/7_xefjio2ke7maniibzud6lrvk0.png"><br><br>     <b>x_get_dword</b> . <br><br>         x_unhexlify   bt_args ‚Äî    . <br><br>          : <br><br><img src="https://habrastorage.org/webt/f0/wk/un/f0wkunrqfawnhv-ozwxwaro1mle.png"><br><br>   ‚Äì      ? <br><br>    ,   2 : <br><br><ul><li>    ; </li><li>  . </li></ul><br>        (  )    : <br><br><ul><li>   (idx) = 0x00; </li><li>  (hue) = 0x00; </li><li>  (saturation) = 0xFF; </li><li>  (value) = 0xFF. </li></ul><br>   : <code>"LED 00 0000 FF FF"</code> ‚Äî    - . <br><br>   : <code>"LED 000000FFFF"</code> (   ¬´LED¬ª    ) ‚Äì    . <br><br>  ,   ,       .       (    ,       x_unhexlify),   x_unhexlify            . <br><br><ul><li>    : <code>"LED 010078FF80"</code> </li><li>    : <code>"LED 0200F0FFFF"</code> </li><li>    : <code>"LED 03012FF80"</code> </li></ul><br>  LED-    <b>sub_8003B7C</b> .       <b>dword_20000624</b> . ,     ‚Äì        (Alt + B): <br><br><img src="https://habrastorage.org/webt/x-/7_/cx/x-7_cxncpwke9gn0zgsqlvdzb5a.png"><br><br>     <code>0x08004FF0, 0x08005D40</code> .  !   ‚Äì  . <br><br>  ,    <code>off_8004FF0</code>  <code>off_8005D40</code> : <br><br><ul><li>  <b>sub_8004D84</b> ‚Äì    ,      ¬´\r\nHardware init done‚Ä¶ Starting FreeRTOS\r\n¬ª ‚Äî     <b>x_main</b> ; </li><li>  <b>sub_8005A08</b> ‚Äì      ¬´LED task\r\n¬ª ‚Äî     <b>x_leds_task</b> . </li></ul><br>  ,  dword_20000624 : <br><br><ul><li>     main; </li><li>     Bluetooth  x_bluetooth_task; </li><li>     x_leds_task. </li></ul><br> ,            RTOS,             ‚Äì   .    : <br><br><ul><li> dword_20000624 ‚Äî <b>leds_queue</b> ; </li><li> sub_8003BD0 ‚Äî <b>x_queue_recv</b> ; </li><li> sub_8003B7C ‚Äî <b>x_queue_send</b> . </li></ul><br>      ,   ,    : <br><br><img src="https://habrastorage.org/webt/qt/nn/w0/qtnnw0daj05gahnzydystjlqave.png"><br><br><img src="https://habrastorage.org/webt/gf/ar/qh/gfarqhp74okx5dzykglofhsn17e.png"><br><br> : <br><br><ul><li> sub_800501C ‚Äî <b>x_sendMsg</b> ; </li><li> sub_8005044 ‚Äî <b>x_recvMsg</b> . </li></ul><br> ,  ,      ,   <b>x_leds_task</b> . <br><br>     ,          . <br><br><h2>    </h2><br><ul><li>    . </li><li>    . </li><li>     . </li><li>  ,  ¬´¬ª   Bluetooth    . </li><li>         Bluetooth. </li></ul><br>           .       . </div><p>Source: <a href="https://habr.com/ru/post/359116/">https://habr.com/ru/post/359116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359104/index.html">How to deploy the infrastructure for Pivotal CF, or Puff Pie Recipe in pictures</a></li>
<li><a href="../359106/index.html">Work with EventSystem in Unity. Basic things in working with UI</a></li>
<li><a href="../359108/index.html">How do we hire using the bootcamp. Experience of the department of search interfaces</a></li>
<li><a href="../359110/index.html">New attack technique based on Meltdown. Using speculative instructions for detecting virtualization</a></li>
<li><a href="../359114/index.html">What is business: a conversation on concepts</a></li>
<li><a href="../359118/index.html">It's time to grow up for IT communities: why do we gather activists at RHS?</a></li>
<li><a href="../359120/index.html">Experiments with kube-proxy and node unavailability in Kubernetes</a></li>
<li><a href="../359122/index.html">A bunch of different ways to read bits</a></li>
<li><a href="../359124/index.html">TOTAL 3 months: Alternative to paid shutdown of advertising in the free Android application</a></li>
<li><a href="../359130/index.html">How we made a highload ++ game with voxel graphics and VR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>