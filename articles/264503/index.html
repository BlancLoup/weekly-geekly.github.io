<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of the DNS resolver in Windows 10 and DNS Leak</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: The DNS resolver in Windows 10 sends requests to all DNS server addresses known to the system in parallel, linking the request to the interfac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of the DNS resolver in Windows 10 and DNS Leak</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/522/09d/82a/52209d82a34a5f0d81c3b17874dc0596.png" alt="image"><br><br>  <b>TL; DR: The</b> DNS resolver in Windows 10 sends requests to all DNS server addresses known to the system in parallel, linking the request to the interface, and uses the response that came faster.  In case you use a DNS server from a local segment, this behavior allows your provider or an attacker with a Wi-Fi point to replace the DNS records, even if you use VPN. <br><br>  Modern versions of Windows add headaches to active VPN users.  A DNS resolver to Windows 7 inclusively had predictable behavior, making requests to DNS servers in turn and priority of DNS servers, in general, like all other operating systems.  This created the so-called DNS Leak (DNS request leak through the external interface with a VPN connected) only if the DNS server inside the VPN tunnel did not respond on time, or responded with an error, and, in general, was not such a glaring problem. . <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Windows 8 </h3> With the release of Windows 8, Microsoft added a very interesting feature to the DNS resolver, which, as I can tell from Google, went completely unnoticed: Smart Multi-Homed Name Resolution.  If this feature is enabled (and it is enabled by default), the OS sends requests to all known DNS servers on all network interfaces in parallel, tying the request to the interface.  This was done, probably, in order to reduce the waiting time for a response from the preferred DNS server in case it is unable for some reason to respond to the timeout allotted to it (1 second by default), and immediately after the timeout expires, give the answer from the next priority server.  Thus, in Windows 8 and 8.1, all your DNS queries ‚Äúflow away‚Äù through the Internet interface, allowing your provider or the owner of a Wi-Fi point to view which sites you visit, provided that your routing table allows DNS requests -server through the Internet interface.  Most often, this situation arises if you use a DNS server inside the local segment, such DNS raise 99% of home routers. <br><br>  This functionality can be disabled by adding to the registry branch: <br> <code>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\DNSClient</code> <br>  The DWORD parameter with the name: <br> <code>DisableSmartNameResolution</code> <br>  and any value other than zero, which returns the old resolver behavior. <br><br><h3>  Windows 10 </h3>  Although Windows 8 and 8.1 sent all your requests without your knowledge through the public interface, it was difficult for an attacker to spoof a DNS response in such a way as to redirect you to a fake website.  The OS would use a spoofed response only if it was not possible to get the correct answer from the preferred DNS server, which is the server inside the encrypted tunnel. <br>  Everything changed with the arrival of Windows 10. Now the OS not only sends a request through all interfaces, but also uses the answer that came faster, which almost always allows your provider to redirect you to a stub about a banned site or an attacker to a fake site.  Moreover, the way to disable Smart Multi-Homed Name Resolution, which worked in Windows 8.1, does not work on the new version. <br>  The only acceptable (though not the most reliable) way to solve the problem is to set DNS on the Internet interface outside the local segment, for example, the well-known 8.8.8.8, however, it will not help in the case of OpenVPN.  For OpenVPN, the only (and ugly) solution is to <a href="https://www.dnsleaktest.com/how-to-fix-a-dns-leak.html">temporarily disable DNS on the Internet interface with scripts</a> . <br><br>  <b>UPD:</b> Earlier in the article it was recommended to use the <code>redirect-gateway</code> parameter without <code>def1</code> for OpenVPN.  It turns out that Windows returns the default route from the DHCP server each time the IP address is updated, and after a while all of your traffic would start to bypass the VPN.  At the moment, there is no beautiful solution. <br><br>  <b>UPD2:</b> <a href="https://github.com/ValdikSS/openvpn-fix-dns-leak-plugin">I wrote a plugin</a> . <br><br>  <b>UPD3:</b> Windows 10, starting with Creators Update, now sends DNS requests to all known DNS server addresses in order, rather than in parallel, starting with a random interface.  To increase the priority of a specific DNS, you need to reduce the interface metric.  I made a patch for OpenVPN, I hope it will be included in 2.4.2: <a href="https://sourceforge.net/p/openvpn/mailman/message/35822231/">https://sourceforge.net/p/openvpn/mailman/message/35822231/</a> <br><br>  <b>UPD4:</b> Update is included in OpenVPN 2.4.2. </div><p>Source: <a href="https://habr.com/ru/post/264503/">https://habr.com/ru/post/264503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264493/index.html">Android numeric entry field</a></li>
<li><a href="../264495/index.html">How to make a fuel plugin (for example, NFS). Part 1</a></li>
<li><a href="../264497/index.html">Video from LoveQA mitap</a></li>
<li><a href="../264499/index.html">Online Programming Programming Basics</a></li>
<li><a href="../264501/index.html">Zabbix - welcome to listen</a></li>
<li><a href="../264505/index.html">Managing dependency versions in the Maven project</a></li>
<li><a href="../264511/index.html">Optimize the Android game mTricks Looting Crown for the Intel Atom platform</a></li>
<li><a href="../264513/index.html">Writing a program to steal data from a USB-drive in Windows</a></li>
<li><a href="../264515/index.html">Updating Linux on a device based on the Altera SoC FPGA chip and gaining access to shared Windows server resources</a></li>
<li><a href="../264517/index.html">The notorious programmer: life hacking firsthand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>