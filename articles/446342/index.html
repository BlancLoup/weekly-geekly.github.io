<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Impact of Transparent Huge Pages on System Performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is published on behalf of Akhaltsev John, Jiga 
 
 Tinkoff.ru today is not just a bank, it is an IT company. It provides not only banking ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Impact of Transparent Huge Pages on System Performance</h1><div class="post__text post__text-html js-mediator-article"><p>  <i>The article is published on behalf of Akhaltsev John, <a href="https://habr.com/ru/users/jiga/" class="user_link">Jiga</a></i> <i><br></i> <br>  Tinkoff.ru today is not just a bank, it is an IT company.  It provides not only banking services, but also builds an ecosystem around them. </p><br><p>  At Tinkoff.ru we are partnering with various services to improve the quality of customer service, and we help them to become better.  For example, we conducted load testing and performance analysis of one of these services that helped find bottlenecks in the system ‚Äî included Transparent Huge Pages in the OS configs. </p><br><p>  If you want to know how to analyze the performance of the system and what came out of it, then welcome under cat. </p><a name="habracut"></a><br><h3 id="opisanie-problemy">  Description of the problem </h3><br><p>  Currently, the service architecture is: </p><br><ul><li>  Nginx web server to handle http connections </li><li>  Php-fpm to manage php processes </li><li>  Redis for caching </li><li>  PostgreSQL storage </li><li>  Monolithic shopping solution </li></ul><br><p>  The main problem that we found during the next sale under high load was the high utilization of cpu, while the processor time in the kernel mode (system time) grew and was longer than the user mode time. </p><br><ul><li>  User Time is the time that the processor spends on the user's tasks.  This is the main thing you pay for when buying a processor. </li><li>  System time (system time) - the amount of time that the system spends on paging, changing context, launching tasks on a schedule and other system tasks. </li></ul><br><h3 id="opredelenie-pervichnyh-harakteristik-sistemy">  Determination of the primary characteristics of the system </h3><br><p>  To begin with, we collected a load circuit with resources close to productive, and made up the load profile corresponding to the normal load on a typical day. </p><br><p>  Gatling version 3 was chosen as a tool for shelling, and the shelling itself was carried out on the local network via gitlab-runner.  The location of agents and targets in the same local network is due to the reduction of network costs, so we focus on checking the execution of the code itself, and not on the speed of the infrastructure where the system is deployed. </p><br><p>  When determining the primary characteristics of the system, a scenario with a linearly increasing load with the http configuration is suitable: </p><br><pre><code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> httpConfig: <span class="hljs-type"><span class="hljs-type">HttpProtocolBuilder</span></span> = http .baseUrl(<span class="hljs-string"><span class="hljs-string">"https://test.host.ru"</span></span>) .inferHtmlResources() <span class="hljs-comment"><span class="hljs-comment">//      .disableCaching //  ,      "" . .disableFollowRedirect //   /// MULTIPLIER   JAVA_OPTS setUp( Scenario.inject( rampUsers(100 * MULTIPLIER) during (200 * MULTIPLIER seconds)) ).protocols(httpConfig) .maxDuration(1 hour)</span></span></code> </pre> <br><p>  At this stage, implemented the script to open the main page and download all the resources </p><br><p><img src="https://habrastorage.org/webt/6y/7s/dn/6y7sdnc1rymvwh6i9tbm1jnnmqk.png"></p><br><p>  The results of this test showed a maximum performance of 1500 rps, a further increase in the intensity of the load led to the degradation of the system associated with increasing softirq time. </p><br><p><img src="https://habrastorage.org/webt/pb/rn/st/pbrnstk2hbvjxehzazn6eklcbqs.png"></p><br><p><img src="https://habrastorage.org/webt/i4/kl/_o/i4kl_opztz6cszphnk8z7iti320.png"></p><br><p>  Softirq is a pending interrupt mechanism and is described in the kernel / softirq.c file.  At the same time, they clog up the queue of instructions to the processor, not allowing to make useful calculations in user mode.  Interrupt handlers can also delay additional work with network packets in OS threads (system time).  Briefly about the work of the network stack and optimizations can be found <a href="https://strizhechenko.github.io/2017/04/13/linux-network-stack-remarks.html">in a separate article</a> . </p><br><p>  The suspicion of the main problem was not confirmed, because there was a much longer system time on the sale with less network activity. </p><br><h3 id="polzovatelskie-scenarii">  Custom Scripts </h3><br><p>  The next step was to develop custom scripts and add something more than just opening the picture page.  The profile includes heavy operations, which fully utilized the site code and database, and not a web server giving static resources. </p><br><p>  The test with a stable load was launched at a lower intensity from the maximum one, a transition to redirects was added to the configuration: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> httpConfig: <span class="hljs-type"><span class="hljs-type">HttpProtocolBuilder</span></span> = http .baseUrl(<span class="hljs-string"><span class="hljs-string">"https://test.host.ru"</span></span>) .inferHtmlResources() <span class="hljs-comment"><span class="hljs-comment">//      .disableCaching //  ,      "" . /// MULTIPLIER   JAVA_OPTS setUp( MainScenario .inject(rampUsers(50 * MULTIPLIER) during (200 * MULTIPLIER seconds)), SideScenario .inject(rampUsers(100 * MULTIPLIER) during (200 * MULTIPLIER seconds)) ).protocols(httpConfig) .maxDuration(2 hours)</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/hz/re/ja/hzrejalbqq3ungtuzcxhxfmjypk.png"><br><img src="https://habrastorage.org/webt/28/vo/om/28voomhlbebmlu7p6tcyppt_boe.png"></p><br><p>  The most complete use of the systems showed an increase in the system time metric, as well as its growth during the stability test.  The problem with the production environment has been replicated </p><br><h3 id="setevoe-vzaimodeystvie-s-redis">  Networking with Redis </h3><br><p>  When analyzing problems, it is very important to have monitoring of all system components in order to understand how it works and what effect it has on the applied load. </p><br><p>  When the monitoring of Redis appeared, it became possible to look not at the general metrics of the system, but at its specific components.  The scenario for stress testing was also changed, which, together with additional monitoring, helped to get closer to the localization of the problem. </p><br><p><img src="https://habrastorage.org/webt/8a/4n/c0/8a4nc0gvymij8dh0r0ihpxhrsjg.png"></p><br><p>  In monitoring, Redis saw a similar picture with the utilization of cpu, or rather system time, significantly more than the user time, while the main utilization of cpu fell on the SET operation, that is, the allocation of RAM to store values. </p><br><p><img src="https://habrastorage.org/webt/iy/ey/wn/iyeywnci02gnc2xrv71el7qtllu.png"></p><br><p>  To eliminate the influence of network interaction with Redis, it was decided to test the hypothesis and switch Redis to a UNIX socket instead of a tcp socket.  This was done right in the framework through which php-fpm connects to the database.  In the /yioftoft / yii/framework/caching/CRedisCache.php file, we replaced the line with host: port with a hardcode redis.sock.  More information about the performance of sockets can be found <a href="https://stackoverflow.com/questions/14973942/tcp-loopback-connection-vs-unix-domain-socket-performance">in the article</a> . </p><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Establishes a connection to the redis server. * It does nothing if the connection has already been established. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CException if connecting fails */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_socket=@stream_socket_client( <span class="hljs-comment"><span class="hljs-comment">// $this-&gt;hostname.':'.$this-&gt;port, "unix:///var/run/redis/redis.sock", $errorNumber, $errorDescription, $this-&gt;timeout ? $this-&gt;timeout : ini_get("default_socket_timeout"), $this-&gt;options ); if ($this-&gt;_socket) { if($this-&gt;password!==null) $this-&gt;executeCommand('AUTH',array($this-&gt;password)); $this-&gt;executeCommand('SELECT',array($this-&gt;database)); } else { $this-&gt;_socket = null; throw new CException('Failed to connect to redis: '.$errorDescription,(int)$errorNumber); } }</span></span></code> </pre> <br><p>  Unfortunately, this did not have much effect.  Utilization of the CPU has stabilized a bit, but it didn‚Äôt solve our problem - most of the utilization of the CPU came from computing in kernel mode. </p><br><p><img src="https://habrastorage.org/webt/w7/8y/5r/w78y5rvvebeefe7r0t34w5lfi-u.png"></p><br><p><img src="https://habrastorage.org/webt/97/mv/y6/97mvy6jkpi8loxuw-dwq_7spfis.png"></p><br><h3 id="benchmark-s-pomoschyu-stress-i-vyyavlenie-problemy-thp">  Benchmark using stress and troubleshooting THP </h3><br><p>  The stress utility, a simple workload generator for POSIX systems that can load individual components of the system, for example, CPU, Memory, IO, helped locate the problem. <br>  Testing is supposed on the hardware and OS version: </p><br><blockquote>  Ubuntu 04.04.1 LTS <br>  12 Intel¬Æ Xeon¬Æ CPUs </blockquote><p>  Installation of the utility is performed using the command: </p><br><pre> <code class="bash hljs">sudo apt-get install stress</code> </pre> <br><p>  We look at how the CPU is utilized under load, run a test that creates workers for calculating square roots with a duration of 300 seconds: </p><br><pre> <code class="bash hljs">-c, --cpu N spawn N workers spinning on sqrt() &gt; stress --cpu 12 --timeout 300s stress: info: [39881] dispatching hogs: 12 cpu, 0 io, 0 vm, 0 hdd</code> </pre> <br><p><img src="https://habrastorage.org/webt/q2/fv/lz/q2fvlzxwmzo-qxvctkrizjjwykw.png"></p><br><p>  The graph shows the full utilization in user mode - this means that all the processor cores are loaded and useful calculations are performed, and not system servicing calls. </p><br><p>  The next step is to consider the use of resources during intensive work with io.  We run the test for 300 seconds with the creation of 12 workers who perform sync ().  The sync command writes data buffered in memory to disk.  The kernel stores data in memory to avoid frequent (usually slow) disk read and write operations.  The sync () command ensures that everything that is stored in memory will be written to disk. </p><br><pre> <code class="bash hljs">-i, --io N spawn N workers spinning on sync() &gt; stress --io 12 --timeout 300s stress: info: [39907] dispatching hogs: 0 cpu, 0 io, 0 vm, 12 hdd</code> </pre> <br><p><img src="https://habrastorage.org/webt/zj/rq/f9/zjrqf9zvn9ejwhwgzogs-iwocyy.png"></p><br><p><img src="https://habrastorage.org/webt/zu/g4/1r/zug41ror5fyqgcduomicj0dpwcw.png"></p><br><p>  We see that the processor is mainly engaged in processing calls in the kernel mode and a bit in iowait, you can also see&gt; 35k ops disk writes.  This behavior is similar to the problem with high system time, the reasons for which we are analyzing.  But here there are several differences: it is iowait and iops larger than on the productive contour, respectively, this does not fit our case. </p><br><p>  It is time to check the memory.  We launch 20 workers who will allocate and free memory for 300 seconds with the help of the command: </p><br><pre> <code class="bash hljs"> -m, --vm N spawn N workers spinning on malloc()/free() &gt; stress -m 20 --timeout 300s stress: info: [39954] dispatching hogs: 0 cpu, 0 io, 20 vm, 0 hdd</code> </pre> <br><p><img src="https://habrastorage.org/webt/fj/pt/q5/fjptq53tbw5s_s6ksdcr2on6eow.png"></p><br><p>  We immediately see the high utilization of the CPU in the system mode and a bit in the user mode, as well as the use of RAM more than 2 GB. </p><br><p>  This case is very similar to the problem with the prod, which is confirmed by the large memory usage on the load tests.  Therefore, the problem must be sought in the work of memory.  The allocation and release of memory occurs through calls to malloc and free, respectively, which will eventually be processed by the system calls of the kernel, which means it will be displayed in the CPU utilization as system time. </p><br><p>  In most modern operating systems, virtual memory is organized using page addressing, with this approach, the entire memory area is divided into pages of fixed length, for example 4096 bytes (default for many platforms), and when allocating, for example, 2 GB of memory, the memory manager will have to operate more than 500,000 pages.  In this approach, there are large management overheads and to reduce them, Huge pages and Transparent Huge Pages technologies were invented, they can be used to increase the page size, for example, to 2MB, which will significantly reduce the number of pages in the heap of memory.  The difference in technology lies only in the fact that for Huge pages we must explicitly set up the environment and teach the program to work with them, while Transparent Huge Pages works ‚Äútransparently‚Äù for programs. </p><br><h3 id="thp-i-reshenie-problemy">  THP and problem solving </h3><br><p>  If you google information about Transparent Huge Pages, you can see in the search results many pages with questions "How to turn off THP." </p><br><p>  As it turned out, this ‚Äúcool‚Äù feature was introduced into the Linux kernel by the Red Hat corporation, the essence of the features, in that applications can work transparently with memory, as if they work with real Huge Page.  According to the benchmarks, THP speeds up the abstract application by 10%, you can see more in the presentation, but in reality everything is different.  In some cases, THP causes an unwarranted increase in CPU consumption in systems.  More details can be found with the recommendations from Oracle. </p><br><p>  Go and check our parameter.  As it turned out, THP is enabled by default - turn off using the command: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</code> </pre> <br><p>  We confirm using the test before turning off the THP and after, on the load profile: </p><br><pre> <code class="scala hljs">setUp( <span class="hljs-type"><span class="hljs-type">MainScenario</span></span>.inject( rampUsers(<span class="hljs-number"><span class="hljs-number">150</span></span>) during (<span class="hljs-number"><span class="hljs-number">200</span></span> seconds)), <span class="hljs-type"><span class="hljs-type">Peak</span></span>.inject( nothingFor(<span class="hljs-number"><span class="hljs-number">20</span></span> minutes), rampUsers(<span class="hljs-number"><span class="hljs-number">5000</span></span>) during (<span class="hljs-number"><span class="hljs-number">30</span></span> minutes)) ).protocols(httpConfig)</code> </pre> <br><p><img src="https://habrastorage.org/webt/bx/zu/wj/bxzuwjbchq4rj4ckyog4e-9liis.png"></p><br><p>  Such a picture we observed before turning off the THP </p><br><p><img src="https://habrastorage.org/webt/pi/jo/si/pijosicrbyv3xukk3uv2babyyie.png"></p><br><p>  After turning off the THP, we can observe already reduced utilization of resources. </p><br><p>  The main problem was localized.  The reason was enabled by default in the OS. <br>  transparent large pages mechanism.  After turning off the THP option, the cpu utilization in the system mode decreased by at least 2 times, which freed up resources for the user mode.  During the analysis of the main problem, ‚Äúbottlenecks‚Äù of interaction with the network stack of the OS and Redis were also found, which is the reason for a deeper study.  But that's another story. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  In conclusion, I would like to give some tips for successfully finding performance problems: </p><br><ul><li>  Before researching the performance of a system, thoroughly understand its architecture and interaction components. </li><li>  Configure monitoring for all system components and track if there is a shortage of standard metrics, go deep and expand. </li><li>  Read the manuals for the systems used. </li><li>  Check the default settings in the OS configuration files and system components. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/446342/">https://habr.com/ru/post/446342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446332/index.html">IBM System i (aka AS / 400) - How we did auto tests for green screen applications</a></li>
<li><a href="../446334/index.html">Thinking about IT careers and tips for beginners</a></li>
<li><a href="../446336/index.html">How to disable standard passwords and make everyone hate you</a></li>
<li><a href="../446338/index.html">SVG 3D: create, rotate and animate</a></li>
<li><a href="../446340/index.html">Operating Systems: Three Easy Pieces. Part 1: Intro (translation)</a></li>
<li><a href="../446344/index.html">Building blocks distributed applications. Second approximation</a></li>
<li><a href="../446346/index.html">Develop applications for Android - as if to be (demonetized) by YouTube</a></li>
<li><a href="../446348/index.html">Simple JSON-RPC-like API for PHP</a></li>
<li><a href="../446350/index.html">What eventually killed AirPower</a></li>
<li><a href="../446352/index.html">Protection without protection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>